{
  "url": "https://api.github.com/repos/matter-labs/zksync/issues/384",
  "repository_url": "https://api.github.com/repos/matter-labs/zksync",
  "labels_url": "https://api.github.com/repos/matter-labs/zksync/issues/384/labels{/name}",
  "comments_url": "https://api.github.com/repos/matter-labs/zksync/issues/384/comments",
  "events_url": "https://api.github.com/repos/matter-labs/zksync/issues/384/events",
  "html_url": "https://github.com/matter-labs/zksync/issues/384",
  "id": 1220124777,
  "node_id": "I_kwDOC0aUls5IuaBp",
  "number": 384,
  "title": "NoticePeriod may be mistaken",
  "user": {
    "login": "LBruyne",
    "id": 46318701,
    "node_id": "MDQ6VXNlcjQ2MzE4NzAx",
    "avatar_url": "https://avatars.githubusercontent.com/u/46318701?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/LBruyne",
    "html_url": "https://github.com/LBruyne",
    "followers_url": "https://api.github.com/users/LBruyne/followers",
    "following_url": "https://api.github.com/users/LBruyne/following{/other_user}",
    "gists_url": "https://api.github.com/users/LBruyne/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/LBruyne/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/LBruyne/subscriptions",
    "organizations_url": "https://api.github.com/users/LBruyne/orgs",
    "repos_url": "https://api.github.com/users/LBruyne/repos",
    "events_url": "https://api.github.com/users/LBruyne/events{/privacy}",
    "received_events_url": "https://api.github.com/users/LBruyne/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 7,
  "created_at": "2022-04-29T07:40:48Z",
  "updated_at": "2022-05-19T17:43:52Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "The getNoticePeriod method in zkSync.sol may have mistake. It returns 0 directly.\r\nI believe it should return a config constant UPGRADE_NOTICE_PERIOD or the state variable approvedUpgradeNoticePeriod which may be shorter than UPGRADE_NOTICE_PERIOD with the cut of secure council.\r\n\r\n<img width=\"700\" alt=\"image\" src=\"https://user-images.githubusercontent.com/46318701/165903309-83f2bb39-493b-41e6-904e-d5083b2f6c2c.png\">\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/matter-labs/zksync/issues/384/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/matter-labs/zksync/issues/384/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/matter-labs/zksync/issues/comments/1115515819",
    "html_url": "https://github.com/matter-labs/zksync/issues/384#issuecomment-1115515819",
    "issue_url": "https://api.github.com/repos/matter-labs/zksync/issues/384",
    "id": 1115515819,
    "node_id": "IC_kwDOC0aUls5CfWur",
    "user": {
      "login": "bxpana",
      "id": 42230936,
      "node_id": "MDQ6VXNlcjQyMjMwOTM2",
      "avatar_url": "https://avatars.githubusercontent.com/u/42230936?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bxpana",
      "html_url": "https://github.com/bxpana",
      "followers_url": "https://api.github.com/users/bxpana/followers",
      "following_url": "https://api.github.com/users/bxpana/following{/other_user}",
      "gists_url": "https://api.github.com/users/bxpana/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bxpana/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bxpana/subscriptions",
      "organizations_url": "https://api.github.com/users/bxpana/orgs",
      "repos_url": "https://api.github.com/users/bxpana/repos",
      "events_url": "https://api.github.com/users/bxpana/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bxpana/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-03T01:06:02Z",
    "updated_at": "2022-05-03T01:06:02Z",
    "author_association": "NONE",
    "body": "@LBruyne this is for zkSync 1.0 correct?",
    "reactions": {
      "url": "https://api.github.com/repos/matter-labs/zksync/issues/comments/1115515819/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/matter-labs/zksync/issues/comments/1118195251",
    "html_url": "https://github.com/matter-labs/zksync/issues/384#issuecomment-1118195251",
    "issue_url": "https://api.github.com/repos/matter-labs/zksync/issues/384",
    "id": 1118195251,
    "node_id": "IC_kwDOC0aUls5Cpk4z",
    "user": {
      "login": "LBruyne",
      "id": 46318701,
      "node_id": "MDQ6VXNlcjQ2MzE4NzAx",
      "avatar_url": "https://avatars.githubusercontent.com/u/46318701?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/LBruyne",
      "html_url": "https://github.com/LBruyne",
      "followers_url": "https://api.github.com/users/LBruyne/followers",
      "following_url": "https://api.github.com/users/LBruyne/following{/other_user}",
      "gists_url": "https://api.github.com/users/LBruyne/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/LBruyne/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/LBruyne/subscriptions",
      "organizations_url": "https://api.github.com/users/LBruyne/orgs",
      "repos_url": "https://api.github.com/users/LBruyne/repos",
      "events_url": "https://api.github.com/users/LBruyne/events{/privacy}",
      "received_events_url": "https://api.github.com/users/LBruyne/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-05T05:55:53Z",
    "updated_at": "2022-05-05T05:55:53Z",
    "author_association": "NONE",
    "body": "> @LBruyne this is for zkSync 1.0 correct?\r\n\r\nI'm not sure yet. But the master branch contains this mistake now. I remember this master branch is for v2.0 now.",
    "reactions": {
      "url": "https://api.github.com/repos/matter-labs/zksync/issues/comments/1118195251/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/matter-labs/zksync/issues/comments/1118972515",
    "html_url": "https://github.com/matter-labs/zksync/issues/384#issuecomment-1118972515",
    "issue_url": "https://api.github.com/repos/matter-labs/zksync/issues/384",
    "id": 1118972515,
    "node_id": "IC_kwDOC0aUls5Csipj",
    "user": {
      "login": "bxpana",
      "id": 42230936,
      "node_id": "MDQ6VXNlcjQyMjMwOTM2",
      "avatar_url": "https://avatars.githubusercontent.com/u/42230936?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bxpana",
      "html_url": "https://github.com/bxpana",
      "followers_url": "https://api.github.com/users/bxpana/followers",
      "following_url": "https://api.github.com/users/bxpana/following{/other_user}",
      "gists_url": "https://api.github.com/users/bxpana/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bxpana/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bxpana/subscriptions",
      "organizations_url": "https://api.github.com/users/bxpana/orgs",
      "repos_url": "https://api.github.com/users/bxpana/repos",
      "events_url": "https://api.github.com/users/bxpana/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bxpana/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-05T19:31:56Z",
    "updated_at": "2022-05-05T19:31:56Z",
    "author_association": "NONE",
    "body": "Ok, let me see if I can get more information for you",
    "reactions": {
      "url": "https://api.github.com/repos/matter-labs/zksync/issues/comments/1118972515/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/matter-labs/zksync/issues/comments/1119416762",
    "html_url": "https://github.com/matter-labs/zksync/issues/384#issuecomment-1119416762",
    "issue_url": "https://api.github.com/repos/matter-labs/zksync/issues/384",
    "id": 1119416762,
    "node_id": "IC_kwDOC0aUls5CuPG6",
    "user": {
      "login": "LBruyne",
      "id": 46318701,
      "node_id": "MDQ6VXNlcjQ2MzE4NzAx",
      "avatar_url": "https://avatars.githubusercontent.com/u/46318701?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/LBruyne",
      "html_url": "https://github.com/LBruyne",
      "followers_url": "https://api.github.com/users/LBruyne/followers",
      "following_url": "https://api.github.com/users/LBruyne/following{/other_user}",
      "gists_url": "https://api.github.com/users/LBruyne/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/LBruyne/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/LBruyne/subscriptions",
      "organizations_url": "https://api.github.com/users/LBruyne/orgs",
      "repos_url": "https://api.github.com/users/LBruyne/repos",
      "events_url": "https://api.github.com/users/LBruyne/events{/privacy}",
      "received_events_url": "https://api.github.com/users/LBruyne/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-06T09:16:06Z",
    "updated_at": "2022-05-06T09:16:06Z",
    "author_association": "NONE",
    "body": "This is my opinion:\r\n``` Solidity\r\nfunction startUpgrade(address[] calldata newTargets) external {\r\n        requireMaster(msg.sender);\r\n        require(upgradeStatus == UpgradeStatus.Idle, \"spu11\"); // spu11 - unable to activate active upgrade mode\r\n        require(newTargets.length == managedContracts.length, \"spu12\"); // spu12 - number of new targets must be equal to the number of managed contracts\r\n\r\n        uint256 noticePeriod = mainContract.getNoticePeriod();\r\n        mainContract.upgradeNoticePeriodStarted();\r\n        upgradeStatus = UpgradeStatus.NoticePeriod;\r\n        noticePeriodFinishTimestamp = block.timestamp.add(noticePeriod);\r\n        nextTargets = newTargets;\r\n        emit NoticePeriodStart(versionId, newTargets, noticePeriod);\r\n}\r\n\r\nfunction startPreparation() external returns (bool) {\r\n        requireMaster(msg.sender);\r\n        require(upgradeStatus == UpgradeStatus.NoticePeriod, \"ugp11\"); // ugp11 - unable to activate preparation status in case of not active notice period status\r\n\r\n        if (block.timestamp >= noticePeriodFinishTimestamp) {\r\n            upgradeStatus = UpgradeStatus.Preparation;\r\n            mainContract.upgradePreparationStarted();\r\n            emit PreparationStart(versionId);\r\n            return true;\r\n        } else {\r\n            return false;\r\n        }\r\n}\r\n```\r\n\r\nIn this startUpgrade function in UpgradeGatekeeper.sol, noticePeriod is got from mainContract(ZkSync.sol) and used in startPreparation function to check whether to start the preparation work or not. However, this value is always 0 now. So the 'if'result in startPreparation function will always be true.\r\n\r\nAlso I notice that noticePeriod is configured by approvedNoticePeriod variable and can be shorten by a secure council. \r\nBut the logic mentioned above still has some problem to fix.",
    "reactions": {
      "url": "https://api.github.com/repos/matter-labs/zksync/issues/comments/1119416762/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/matter-labs/zksync/issues/comments/1130291533",
    "html_url": "https://github.com/matter-labs/zksync/issues/384#issuecomment-1130291533",
    "issue_url": "https://api.github.com/repos/matter-labs/zksync/issues/384",
    "id": 1130291533,
    "node_id": "IC_kwDOC0aUls5DXuFN",
    "user": {
      "login": "bxpana",
      "id": 42230936,
      "node_id": "MDQ6VXNlcjQyMjMwOTM2",
      "avatar_url": "https://avatars.githubusercontent.com/u/42230936?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bxpana",
      "html_url": "https://github.com/bxpana",
      "followers_url": "https://api.github.com/users/bxpana/followers",
      "following_url": "https://api.github.com/users/bxpana/following{/other_user}",
      "gists_url": "https://api.github.com/users/bxpana/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bxpana/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bxpana/subscriptions",
      "organizations_url": "https://api.github.com/users/bxpana/orgs",
      "repos_url": "https://api.github.com/users/bxpana/repos",
      "events_url": "https://api.github.com/users/bxpana/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bxpana/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-18T17:29:16Z",
    "updated_at": "2022-05-18T17:29:16Z",
    "author_association": "NONE",
    "body": "@LBruyne \r\nThere are no errors in the upgrade logic, there is only legacy code that makes understanding the code difficult. `ZkSync.sol:getNoticePeriod` always return 0, and it is true that condition inside if statement on `UpgradeGatekeeper.sol:startPreparation` will be always true. However, `ZkSync.upgradePreparationStarted` will be called inside the execution of `the the UpgradeGatekeeper.sol:startPrepagation`. Here is actually checking the notice period.\r\n```\r\n /// @notice Notification that upgrade preparation status is activated\r\n    /// @dev Can be external because Proxy contract intercepts illegal calls of this function\r\n    function upgradePreparationStarted() external override {\r\n        require(block.timestamp >= upgradeStartTimestamp.add(approvedUpgradeNoticePeriod));\r\n\r\n        upgradePreparationActive = true;\r\n        upgradePreparationActivationTime = block.timestamp;\r\n    }\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/matter-labs/zksync/issues/comments/1130291533/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/matter-labs/zksync/issues/comments/1131071501",
    "html_url": "https://github.com/matter-labs/zksync/issues/384#issuecomment-1131071501",
    "issue_url": "https://api.github.com/repos/matter-labs/zksync/issues/384",
    "id": 1131071501,
    "node_id": "IC_kwDOC0aUls5DasgN",
    "user": {
      "login": "LBruyne",
      "id": 46318701,
      "node_id": "MDQ6VXNlcjQ2MzE4NzAx",
      "avatar_url": "https://avatars.githubusercontent.com/u/46318701?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/LBruyne",
      "html_url": "https://github.com/LBruyne",
      "followers_url": "https://api.github.com/users/LBruyne/followers",
      "following_url": "https://api.github.com/users/LBruyne/following{/other_user}",
      "gists_url": "https://api.github.com/users/LBruyne/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/LBruyne/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/LBruyne/subscriptions",
      "organizations_url": "https://api.github.com/users/LBruyne/orgs",
      "repos_url": "https://api.github.com/users/LBruyne/repos",
      "events_url": "https://api.github.com/users/LBruyne/events{/privacy}",
      "received_events_url": "https://api.github.com/users/LBruyne/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-19T02:54:32Z",
    "updated_at": "2022-05-19T02:54:32Z",
    "author_association": "NONE",
    "body": "I believe our opinions are the same. So why not modify this logic?",
    "reactions": {
      "url": "https://api.github.com/repos/matter-labs/zksync/issues/comments/1131071501/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/matter-labs/zksync/issues/comments/1132005510",
    "html_url": "https://github.com/matter-labs/zksync/issues/384#issuecomment-1132005510",
    "issue_url": "https://api.github.com/repos/matter-labs/zksync/issues/384",
    "id": 1132005510,
    "node_id": "IC_kwDOC0aUls5DeQiG",
    "user": {
      "login": "bxpana",
      "id": 42230936,
      "node_id": "MDQ6VXNlcjQyMjMwOTM2",
      "avatar_url": "https://avatars.githubusercontent.com/u/42230936?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bxpana",
      "html_url": "https://github.com/bxpana",
      "followers_url": "https://api.github.com/users/bxpana/followers",
      "following_url": "https://api.github.com/users/bxpana/following{/other_user}",
      "gists_url": "https://api.github.com/users/bxpana/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bxpana/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bxpana/subscriptions",
      "organizations_url": "https://api.github.com/users/bxpana/orgs",
      "repos_url": "https://api.github.com/users/bxpana/repos",
      "events_url": "https://api.github.com/users/bxpana/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bxpana/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-19T17:43:51Z",
    "updated_at": "2022-05-19T17:43:51Z",
    "author_association": "NONE",
    "body": "@LBruyne If the opinions are the same I'm not sure why we would modify the logic. We wouldn't need to modify the logic because there is nothing wrong with its current state.",
    "reactions": {
      "url": "https://api.github.com/repos/matter-labs/zksync/issues/comments/1132005510/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
