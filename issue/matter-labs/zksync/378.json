{
  "url": "https://api.github.com/repos/matter-labs/zksync/issues/378",
  "repository_url": "https://api.github.com/repos/matter-labs/zksync",
  "labels_url": "https://api.github.com/repos/matter-labs/zksync/issues/378/labels{/name}",
  "comments_url": "https://api.github.com/repos/matter-labs/zksync/issues/378/comments",
  "events_url": "https://api.github.com/repos/matter-labs/zksync/issues/378/events",
  "html_url": "https://github.com/matter-labs/zksync/issues/378",
  "id": 1202924454,
  "node_id": "I_kwDOC0aUls5Hsyum",
  "number": 378,
  "title": "attempt to subtract with overflow bug for WitnessGenerator",
  "user": {
    "login": "berryjam",
    "id": 2264019,
    "node_id": "MDQ6VXNlcjIyNjQwMTk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2264019?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/berryjam",
    "html_url": "https://github.com/berryjam",
    "followers_url": "https://api.github.com/users/berryjam/followers",
    "following_url": "https://api.github.com/users/berryjam/following{/other_user}",
    "gists_url": "https://api.github.com/users/berryjam/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/berryjam/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/berryjam/subscriptions",
    "organizations_url": "https://api.github.com/users/berryjam/orgs",
    "repos_url": "https://api.github.com/users/berryjam/repos",
    "events_url": "https://api.github.com/users/berryjam/events{/privacy}",
    "received_events_url": "https://api.github.com/users/berryjam/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2022-04-13T08:15:50Z",
  "updated_at": "2022-04-19T08:16:22Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "**Problem:**\r\nWhen start the witness generator the first time,it will cause an overflow bug.Because the verified block is **0** and **NUMBER_OF_STORED_ACCOUNT_TREE_CACHE** is 300 while BlockNumber is unsigned type, block - NUMBER_OF_STORED_ACCOUNT_TREE_CACHE will get an negative num.The code is located on function **store_account_tree_cache** in file **database.rs**.\r\n```\r\nconnection\r\n            .chain()\r\n            .block_schema()\r\n            .remove_old_account_tree_cache(block - NUMBER_OF_STORED_ACCOUNT_TREE_CACHE)\r\n            .await?;\r\n```\r\n\r\n**CodeBase:**\r\nbranch: master\r\ncommit: f958bd54000c5203ed54b55dee073d5b03f192be\r\n\r\n**Call Stack:**\r\nthread 'prover_server_pool' panicked at 'attempt to subtract with overflow', core/lib/basic_types/src/lib.rs:27:1\r\nstack backtrace:\r\n   0: rust_begin_unwind\r\n             at /rustc/9d1b2106e23b1abd32fce1f17267604a5102f57a/library/std/src/panicking.rs:498:5\r\n   1: core::panicking::panic_fmt\r\n             at /rustc/9d1b2106e23b1abd32fce1f17267604a5102f57a/library/core/src/panicking.rs:116:14\r\n   2: core::panicking::panic\r\n             at /rustc/9d1b2106e23b1abd32fce1f17267604a5102f57a/library/core/src/panicking.rs:48:5\r\n   3: <zksync_basic_types::BlockNumber as core::ops::arith::Sub<u32>>::sub\r\n             at ./core/lib/basic_types/src/macros.rs:56:22\r\n   4: <zksync_witness_generator::database::Database as zksync_witness_generator::database_interface::DatabaseInterface>::store_account_tree_cache::{{closure}}\r\n             at ./core/bin/zksync_witness_generator/src/database.rs:268:44\r\n   5: <core::future::from_generator::GenFuture<T> as core::future::future::Future>::poll\r\n             at /rustc/9d1b2106e23b1abd32fce1f17267604a5102f57a/library/core/src/future/mod.rs:84:19\r\n   6: <core::pin::Pin<P> as core::future::future::Future>::poll\r\n             at /rustc/9d1b2106e23b1abd32fce1f17267604a5102f57a/library/core/src/future/future.rs:123:9\r\n   7: zksync_witness_generator::witness_generator::WitnessGenerator<DB>::load_account_tree::{{closure}}\r\n             at ./core/bin/zksync_witness_generator/src/witness_generator.rs:162:22\r\n   8: <core::future::from_generator::GenFuture<T> as core::future::future::Future>::poll\r\n             at /rustc/9d1b2106e23b1abd32fce1f17267604a5102f57a/library/core/src/future/mod.rs:84:19\r\n   9: zksync_witness_generator::witness_generator::WitnessGenerator<DB>::prepare_witness_and_save_it::{{closure}}\r\n             at ./core/bin/zksync_witness_generator/src/witness_generator.rs:217:86\r\n  10: <core::future::from_generator::GenFuture<T> as core::future::future::Future>::poll\r\n             at /rustc/9d1b2106e23b1abd32fce1f17267604a5102f57a/library/core/src/future/mod.rs:84:19\r\n  11: zksync_witness_generator::witness_generator::WitnessGenerator<DB>::maintain::{{closure}}\r\n             at ./core/bin/zksync_witness_generator/src/witness_generator.rs:274:74\r\n  12: <core::future::from_generator::GenFuture<T> as core::future::future::Future>::poll\r\n             at /rustc/9d1b2106e23b1abd32fce1f17267604a5102f57a/library/core/src/future/mod.rs:84:19\r\n  13: zksync_witness_generator::witness_generator::WitnessGenerator<DB>::start::{{closure}}::{{closure}}\r\n             at ./core/bin/zksync_witness_generator/src/witness_generator.rs:67:36\r\n  14: <core::future::from_generator::GenFuture<T> as core::future::future::Future>::poll\r\n             at /rustc/9d1b2106e23b1abd32fce1f17267604a5102f57a/library/core/src/future/mod.rs:84:19\r\n  15: tokio::park::thread::CachedParkThread::block_on::{{closure}}\r\n             at /Users/bj89200ml/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.13.0/src/park/thread.rs:263:54\r\n  16: tokio::coop::with_budget::{{closure}}\r\n             at /Users/bj89200ml/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.13.0/src/coop.rs:106:9\r\n  17: std::thread::local::LocalKey<T>::try_with\r\n             at /rustc/9d1b2106e23b1abd32fce1f17267604a5102f57a/library/std/src/thread/local.rs:412:16\r\n  18: std::thread::local::LocalKey<T>::with\r\n             at /rustc/9d1b2106e23b1abd32fce1f17267604a5102f57a/library/std/src/thread/local.rs:388:9\r\n  19: tokio::coop::with_budget\r\n             at /Users/bj89200ml/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.13.0/src/coop.rs:99:5\r\n  20: tokio::coop::budget\r\n             at /Users/bj89200ml/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.13.0/src/coop.rs:76:5\r\n  21: tokio::park::thread::CachedParkThread::block_on\r\n             at /Users/bj89200ml/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.13.0/src/park/thread.rs:263:31\r\n  22: tokio::runtime::enter::Enter::block_on\r\n             at /Users/bj89200ml/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.13.0/src/runtime/enter.rs:151:13\r\n  23: tokio::runtime::thread_pool::ThreadPool::block_on\r\n             at /Users/bj89200ml/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.13.0/src/runtime/thread_pool/mod.rs:77:9\r\n  24: tokio::runtime::Runtime::block_on\r\n             at /Users/bj89200ml/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.13.0/src/runtime/mod.rs:463:43\r\n  25: zksync_witness_generator::witness_generator::WitnessGenerator<DB>::start::{{closure}}\r\n             at ./core/bin/zksync_witness_generator/src/witness_generator.rs:66:17\r\nnote: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.\r\n\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/matter-labs/zksync/issues/378/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/matter-labs/zksync/issues/378/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/matter-labs/zksync/issues/comments/1097696948",
    "html_url": "https://github.com/matter-labs/zksync/issues/378#issuecomment-1097696948",
    "issue_url": "https://api.github.com/repos/matter-labs/zksync/issues/378",
    "id": 1097696948,
    "node_id": "IC_kwDOC0aUls5BbYa0",
    "user": {
      "login": "berryjam",
      "id": 2264019,
      "node_id": "MDQ6VXNlcjIyNjQwMTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2264019?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/berryjam",
      "html_url": "https://github.com/berryjam",
      "followers_url": "https://api.github.com/users/berryjam/followers",
      "following_url": "https://api.github.com/users/berryjam/following{/other_user}",
      "gists_url": "https://api.github.com/users/berryjam/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/berryjam/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/berryjam/subscriptions",
      "organizations_url": "https://api.github.com/users/berryjam/orgs",
      "repos_url": "https://api.github.com/users/berryjam/repos",
      "events_url": "https://api.github.com/users/berryjam/events{/privacy}",
      "received_events_url": "https://api.github.com/users/berryjam/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-04-13T08:18:52Z",
    "updated_at": "2022-04-13T08:18:52Z",
    "author_association": "NONE",
    "body": "It should check current block and NUMBER_OF_STORED_ACCOUNT_TREE_CACHE before remove old account tree cache.",
    "reactions": {
      "url": "https://api.github.com/repos/matter-labs/zksync/issues/comments/1097696948/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/matter-labs/zksync/issues/comments/1101849428",
    "html_url": "https://github.com/matter-labs/zksync/issues/378#issuecomment-1101849428",
    "issue_url": "https://api.github.com/repos/matter-labs/zksync/issues/378",
    "id": 1101849428,
    "node_id": "IC_kwDOC0aUls5BrONU",
    "user": {
      "login": "bxpana",
      "id": 42230936,
      "node_id": "MDQ6VXNlcjQyMjMwOTM2",
      "avatar_url": "https://avatars.githubusercontent.com/u/42230936?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bxpana",
      "html_url": "https://github.com/bxpana",
      "followers_url": "https://api.github.com/users/bxpana/followers",
      "following_url": "https://api.github.com/users/bxpana/following{/other_user}",
      "gists_url": "https://api.github.com/users/bxpana/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bxpana/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bxpana/subscriptions",
      "organizations_url": "https://api.github.com/users/bxpana/orgs",
      "repos_url": "https://api.github.com/users/bxpana/repos",
      "events_url": "https://api.github.com/users/bxpana/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bxpana/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-04-18T23:23:27Z",
    "updated_at": "2022-04-18T23:23:27Z",
    "author_association": "NONE",
    "body": "Let me see if I can find out more for you.",
    "reactions": {
      "url": "https://api.github.com/repos/matter-labs/zksync/issues/comments/1101849428/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/matter-labs/zksync/issues/comments/1102266079",
    "html_url": "https://github.com/matter-labs/zksync/issues/378#issuecomment-1102266079",
    "issue_url": "https://api.github.com/repos/matter-labs/zksync/issues/378",
    "id": 1102266079,
    "node_id": "IC_kwDOC0aUls5Bsz7f",
    "user": {
      "login": "berryjam",
      "id": 2264019,
      "node_id": "MDQ6VXNlcjIyNjQwMTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2264019?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/berryjam",
      "html_url": "https://github.com/berryjam",
      "followers_url": "https://api.github.com/users/berryjam/followers",
      "following_url": "https://api.github.com/users/berryjam/following{/other_user}",
      "gists_url": "https://api.github.com/users/berryjam/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/berryjam/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/berryjam/subscriptions",
      "organizations_url": "https://api.github.com/users/berryjam/orgs",
      "repos_url": "https://api.github.com/users/berryjam/repos",
      "events_url": "https://api.github.com/users/berryjam/events{/privacy}",
      "received_events_url": "https://api.github.com/users/berryjam/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-04-19T08:16:22Z",
    "updated_at": "2022-04-19T08:16:22Z",
    "author_association": "NONE",
    "body": "> Let me see if I can find out more for you.\r\n\r\nThanks and wait for your help.",
    "reactions": {
      "url": "https://api.github.com/repos/matter-labs/zksync/issues/comments/1102266079/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
