{
  "url": "https://api.github.com/repos/trufflesuite/truffle/issues/1612",
  "repository_url": "https://api.github.com/repos/trufflesuite/truffle",
  "labels_url": "https://api.github.com/repos/trufflesuite/truffle/issues/1612/labels{/name}",
  "comments_url": "https://api.github.com/repos/trufflesuite/truffle/issues/1612/comments",
  "events_url": "https://api.github.com/repos/trufflesuite/truffle/issues/1612/events",
  "html_url": "https://github.com/trufflesuite/truffle/issues/1612",
  "id": 395906086,
  "node_id": "MDU6SXNzdWUzOTU5MDYwODY=",
  "number": 1612,
  "title": "Migration, dry run and hd-wallet-provider do not work together.",
  "user": {
    "login": "levino",
    "id": 1150767,
    "node_id": "MDQ6VXNlcjExNTA3Njc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1150767?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/levino",
    "html_url": "https://github.com/levino",
    "followers_url": "https://api.github.com/users/levino/followers",
    "following_url": "https://api.github.com/users/levino/following{/other_user}",
    "gists_url": "https://api.github.com/users/levino/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/levino/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/levino/subscriptions",
    "organizations_url": "https://api.github.com/users/levino/orgs",
    "repos_url": "https://api.github.com/users/levino/repos",
    "events_url": "https://api.github.com/users/levino/events{/privacy}",
    "received_events_url": "https://api.github.com/users/levino/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1103191633,
      "node_id": "MDU6TGFiZWwxMTAzMTkxNjMz",
      "url": "https://api.github.com/repos/trufflesuite/truffle/labels/needs%20labels",
      "name": "needs labels",
      "color": "62e5ac",
      "default": false,
      "description": "gettin' meta"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 6,
  "created_at": "2019-01-04T12:14:52Z",
  "updated_at": "2022-04-20T13:23:03Z",
  "closed_at": "2022-04-20T13:23:03Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "I have a migration that deploys a token contract, a crowdsale contract and (**very important part**) changes ownership, adds whitelisted users, etc.\r\n\r\nWhen I run this migration on a local test rpc all is fine. When I run it on kovan the migration will fail during the dry run. I [switched the dry run off ](https://github.com/trufflesuite/truffle/issues/1609) now all is fine.\r\n\r\nLesson learned: Skip the buggy dry run.\r\n\r\nI created this issue for others to save their lifetime. Took me a couple of hours.",
  "closed_by": {
    "login": "levino",
    "id": 1150767,
    "node_id": "MDQ6VXNlcjExNTA3Njc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1150767?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/levino",
    "html_url": "https://github.com/levino",
    "followers_url": "https://api.github.com/users/levino/followers",
    "following_url": "https://api.github.com/users/levino/following{/other_user}",
    "gists_url": "https://api.github.com/users/levino/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/levino/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/levino/subscriptions",
    "organizations_url": "https://api.github.com/users/levino/orgs",
    "repos_url": "https://api.github.com/users/levino/repos",
    "events_url": "https://api.github.com/users/levino/events{/privacy}",
    "received_events_url": "https://api.github.com/users/levino/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/1612/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/trufflesuite/truffle/issues/1612/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/457716236",
    "html_url": "https://github.com/trufflesuite/truffle/issues/1612#issuecomment-457716236",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/1612",
    "id": 457716236,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ1NzcxNjIzNg==",
    "user": {
      "login": "mrwillis",
      "id": 2652683,
      "node_id": "MDQ6VXNlcjI2NTI2ODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2652683?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mrwillis",
      "html_url": "https://github.com/mrwillis",
      "followers_url": "https://api.github.com/users/mrwillis/followers",
      "following_url": "https://api.github.com/users/mrwillis/following{/other_user}",
      "gists_url": "https://api.github.com/users/mrwillis/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mrwillis/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mrwillis/subscriptions",
      "organizations_url": "https://api.github.com/users/mrwillis/orgs",
      "repos_url": "https://api.github.com/users/mrwillis/repos",
      "events_url": "https://api.github.com/users/mrwillis/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mrwillis/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-01-25T20:28:48Z",
    "updated_at": "2019-01-25T20:28:48Z",
    "author_association": "CONTRIBUTOR",
    "body": "The issue is the dry run does not save state it seems. I have similar permission-esque stuff and call initialize type functions in the migrations and they do not seem to persist. I would keep the issue open.",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/457716236/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/458727265",
    "html_url": "https://github.com/trufflesuite/truffle/issues/1612#issuecomment-458727265",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/1612",
    "id": 458727265,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ1ODcyNzI2NQ==",
    "user": {
      "login": "eggplantzzz",
      "id": 14827965,
      "node_id": "MDQ6VXNlcjE0ODI3OTY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/14827965?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/eggplantzzz",
      "html_url": "https://github.com/eggplantzzz",
      "followers_url": "https://api.github.com/users/eggplantzzz/followers",
      "following_url": "https://api.github.com/users/eggplantzzz/following{/other_user}",
      "gists_url": "https://api.github.com/users/eggplantzzz/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/eggplantzzz/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/eggplantzzz/subscriptions",
      "organizations_url": "https://api.github.com/users/eggplantzzz/orgs",
      "repos_url": "https://api.github.com/users/eggplantzzz/repos",
      "events_url": "https://api.github.com/users/eggplantzzz/events{/privacy}",
      "received_events_url": "https://api.github.com/users/eggplantzzz/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-01-29T22:09:35Z",
    "updated_at": "2019-01-29T22:09:35Z",
    "author_association": "CONTRIBUTOR",
    "body": "@Levino @mrwillis Are either of you able to provide examples of this? I would like to run it and try and see what is going on.",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/458727265/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/458845078",
    "html_url": "https://github.com/trufflesuite/truffle/issues/1612#issuecomment-458845078",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/1612",
    "id": 458845078,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ1ODg0NTA3OA==",
    "user": {
      "login": "levino",
      "id": 1150767,
      "node_id": "MDQ6VXNlcjExNTA3Njc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1150767?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/levino",
      "html_url": "https://github.com/levino",
      "followers_url": "https://api.github.com/users/levino/followers",
      "following_url": "https://api.github.com/users/levino/following{/other_user}",
      "gists_url": "https://api.github.com/users/levino/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/levino/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/levino/subscriptions",
      "organizations_url": "https://api.github.com/users/levino/orgs",
      "repos_url": "https://api.github.com/users/levino/repos",
      "events_url": "https://api.github.com/users/levino/events{/privacy}",
      "received_events_url": "https://api.github.com/users/levino/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-01-30T07:49:31Z",
    "updated_at": "2019-01-30T07:49:31Z",
    "author_association": "NONE",
    "body": "I started to make an example repo. Look at this file: https://github.com/Levino/truffle-dry-run-failure/blob/master/migrations/2_mummy_migration.js\r\n\r\nI think the dry run would fail but I am not able to test atm because https://github.com/trufflesuite/truffle/issues/1667\r\n\r\nWaiting for this to get fixed.",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/458845078/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/459273927",
    "html_url": "https://github.com/trufflesuite/truffle/issues/1612#issuecomment-459273927",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/1612",
    "id": 459273927,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ1OTI3MzkyNw==",
    "user": {
      "login": "levino",
      "id": 1150767,
      "node_id": "MDQ6VXNlcjExNTA3Njc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1150767?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/levino",
      "html_url": "https://github.com/levino",
      "followers_url": "https://api.github.com/users/levino/followers",
      "following_url": "https://api.github.com/users/levino/following{/other_user}",
      "gists_url": "https://api.github.com/users/levino/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/levino/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/levino/subscriptions",
      "organizations_url": "https://api.github.com/users/levino/orgs",
      "repos_url": "https://api.github.com/users/levino/repos",
      "events_url": "https://api.github.com/users/levino/events{/privacy}",
      "received_events_url": "https://api.github.com/users/levino/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-01-31T09:21:41Z",
    "updated_at": "2019-01-31T09:21:41Z",
    "author_association": "NONE",
    "body": "Truffle is working again with web3. I pushed some changes to the repo with a working example now. I was not able to reproduce the bug though and do not want to spend more time atm on this. Might revisit later. I am happy for a PR by @mrwillis to reproduce the error. I think my basic example is a very good starting point. https://github.com/Levino/truffle-dry-run-failure",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/459273927/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/599953839",
    "html_url": "https://github.com/trufflesuite/truffle/issues/1612#issuecomment-599953839",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/1612",
    "id": 599953839,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU5OTk1MzgzOQ==",
    "user": {
      "login": "DefiCake",
      "id": 46090742,
      "node_id": "MDQ6VXNlcjQ2MDkwNzQy",
      "avatar_url": "https://avatars.githubusercontent.com/u/46090742?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/DefiCake",
      "html_url": "https://github.com/DefiCake",
      "followers_url": "https://api.github.com/users/DefiCake/followers",
      "following_url": "https://api.github.com/users/DefiCake/following{/other_user}",
      "gists_url": "https://api.github.com/users/DefiCake/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/DefiCake/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/DefiCake/subscriptions",
      "organizations_url": "https://api.github.com/users/DefiCake/orgs",
      "repos_url": "https://api.github.com/users/DefiCake/repos",
      "events_url": "https://api.github.com/users/DefiCake/events{/privacy}",
      "received_events_url": "https://api.github.com/users/DefiCake/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-03-17T08:56:37Z",
    "updated_at": "2020-03-17T08:59:29Z",
    "author_association": "NONE",
    "body": "Browsing for another issue I stepped on this.\r\n\r\nFor anyone struggling, I managed to pull this workaround. It seems like web3 is somehow internally aware of the injected hdwallet provider even in dry-runs, it is just that the accounts in the hdwallet provider do not exist in the `accounts` variable that is passed in the migrations exports:\r\n\r\n`module.exports = function(deployer, network, accounts) { ... }`\r\n\r\nBut as I said, web3 internally knows about the hdwallet accounts, you can get access to those accounts through `web3.currentProvider.options.unlocked_accounts`. \r\n\r\nI am leaving a code snippet as example.\r\n\r\n```\r\nconst config = async accounts => {\r\n  const [deployerAccount, master, minter1, minter2, minter3] = accounts;\r\n\r\n  let token = await Token.deployed();\r\n  let emitter = await Emitter.deployed();\r\n\r\n  var { tx } = await token.transferOwnership(emitter.address, {\r\n    from: deployerAccount\r\n  });\r\n  console.log(\r\n    `   > Token ownership transferred to emitter ${emitter.address} in tx ${tx}`\r\n  );\r\n  tx = undefined;\r\n\r\n  var { tx } = await emitter.transferOwnership(master, {\r\n    from: deployerAccount\r\n  });\r\n  console.log(\r\n    `   > Emitter ownership transferred to address ${master} in tx ${tx}`\r\n  );\r\n  tx = undefined;\r\n\r\n  var { tx } = await emitter.addMinter(minter1, { from: master });\r\n  console.log(`   > Added minter ${minter1} in tx ${tx}`);\r\n  var { tx } = await emitter.addMinter(minter2, { from: master });\r\n  console.log(`   > Added minter ${minter2} in tx ${tx}`);\r\n  var { tx } = await emitter.addMinter(minter3, { from: master });\r\n  console.log(`   > Added minter ${minter3} in tx ${tx}`);\r\n\r\n  return '    > Succesfully configured contract';\r\n};\r\n\r\nmodule.exports = function(deployer, network, accounts) {\r\n  if (network.includes('test') || network.includes('development'))\r\n    // do not deploy, each test should deploy by itself\r\n    return;\r\n\r\n  console.log('   Transferring ownership and adding minters');\r\n\r\n  // Workaround for selecting the configured HDWalletProvider instead of the\r\n  // automatic generated from ganache during dry-runs\r\n  let _accounts = network.includes('fork')\r\n    ? web3.currentProvider.options.unlocked_accounts\r\n    : accounts;\r\n\r\n  return config(_accounts)\r\n    .then(console.log)\r\n    .catch(console.error);\r\n};\r\n```\r\n\r\nThis way, the `accounts` variable that I am passing to the `config` function are actually the ones in `hdwallet`, instead of the ones generated by `TestRPC` during the dry run.",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/599953839/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/1102752297",
    "html_url": "https://github.com/trufflesuite/truffle/issues/1612#issuecomment-1102752297",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/1612",
    "id": 1102752297,
    "node_id": "IC_kwDOAkfq-c5Buqop",
    "user": {
      "login": "eggplantzzz",
      "id": 14827965,
      "node_id": "MDQ6VXNlcjE0ODI3OTY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/14827965?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/eggplantzzz",
      "html_url": "https://github.com/eggplantzzz",
      "followers_url": "https://api.github.com/users/eggplantzzz/followers",
      "following_url": "https://api.github.com/users/eggplantzzz/following{/other_user}",
      "gists_url": "https://api.github.com/users/eggplantzzz/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/eggplantzzz/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/eggplantzzz/subscriptions",
      "organizations_url": "https://api.github.com/users/eggplantzzz/orgs",
      "repos_url": "https://api.github.com/users/eggplantzzz/repos",
      "events_url": "https://api.github.com/users/eggplantzzz/events{/privacy}",
      "received_events_url": "https://api.github.com/users/eggplantzzz/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-04-19T14:52:17Z",
    "updated_at": "2022-04-19T14:52:17Z",
    "author_association": "CONTRIBUTOR",
    "body": "Just doing some maintenance and wanted to see if this issue is still relevant/valid. It looks like it is possible it was resolved at some point? If someone could let me know I would appreciate it!",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/1102752297/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
