{
  "url": "https://api.github.com/repos/trufflesuite/truffle/issues/5690",
  "repository_url": "https://api.github.com/repos/trufflesuite/truffle",
  "labels_url": "https://api.github.com/repos/trufflesuite/truffle/issues/5690/labels{/name}",
  "comments_url": "https://api.github.com/repos/trufflesuite/truffle/issues/5690/comments",
  "events_url": "https://api.github.com/repos/trufflesuite/truffle/issues/5690/events",
  "html_url": "https://github.com/trufflesuite/truffle/issues/5690",
  "id": 1442984165,
  "node_id": "I_kwDOAkfq-c5WAjDl",
  "number": 5690,
  "title": "Dashboard server sometimes only listens on IPv6 loopback address by default instead of both IPv4 and IPv6",
  "user": {
    "login": "benjamincburns",
    "id": 803016,
    "node_id": "MDQ6VXNlcjgwMzAxNg==",
    "avatar_url": "https://avatars.githubusercontent.com/u/803016?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/benjamincburns",
    "html_url": "https://github.com/benjamincburns",
    "followers_url": "https://api.github.com/users/benjamincburns/followers",
    "following_url": "https://api.github.com/users/benjamincburns/following{/other_user}",
    "gists_url": "https://api.github.com/users/benjamincburns/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/benjamincburns/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/benjamincburns/subscriptions",
    "organizations_url": "https://api.github.com/users/benjamincburns/orgs",
    "repos_url": "https://api.github.com/users/benjamincburns/repos",
    "events_url": "https://api.github.com/users/benjamincburns/events{/privacy}",
    "received_events_url": "https://api.github.com/users/benjamincburns/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 230393326,
      "node_id": "MDU6TGFiZWwyMzAzOTMzMjY=",
      "url": "https://api.github.com/repos/trufflesuite/truffle/labels/bug",
      "name": "bug",
      "color": "fc2929",
      "default": true,
      "description": null
    },
    {
      "id": 644098328,
      "node_id": "MDU6TGFiZWw2NDQwOTgzMjg=",
      "url": "https://api.github.com/repos/trufflesuite/truffle/labels/needs%20reproduced",
      "name": "needs reproduced",
      "color": "fbca04",
      "default": false,
      "description": null
    },
    {
      "id": 3816950911,
      "node_id": "LA_kwDOAkfq-c7jggx_",
      "url": "https://api.github.com/repos/trufflesuite/truffle/labels/dashboard",
      "name": "dashboard",
      "color": "4667D5",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2022-11-10T00:19:31Z",
  "updated_at": "2022-11-10T19:02:42Z",
  "closed_at": null,
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "## Issue\r\n\r\nWhile helping @OnlyOneJMJQ troubleshoot an issue with the truffle dashboard, we encountered a problem where the dashboard's HTTP server was listening only on the IPv6 loopback interface, while his `truffle migrate` command was attempting to connect to the IPv4 interface. This resulted in a mix of `ECONNREFUSED` and `ECONNTIMEOUT` errors from the `truffle migrate` process as it was attempting to connect to the dashboard server process.\r\n\r\n## Steps to Reproduce\r\n\r\n1. Ensure that you don't have `dashboard.host` specified in your `truffle-config.js`\r\n2. In one terminal instance run `truffle dashboard` to spin up the dashboard process\r\n3. In another terminal run `truffle migrate --network dashboard`\r\n\r\nNote: this very likely only reproduces with Node v17+ (see last paragraph of \"underlying cause\" discussion below).\r\n\r\n## Expected Behavior\r\n\r\nThe `truffle migrate` command should succeed as expected.\r\n\r\n## Actual Results\r\n\r\nA mix of `ECONNREFUSED` and `ECONNTIMEOUT` errors are reported by the `truffle migrate` process, and that process exits with a failure code.\r\n\r\n## Short-term workaround\r\n\r\nThis issue can be worked around by explicitly setting `dashboard.host` to \"127.0.0.1\" or \"::1\" in `truffle-config.js`, and ensuring that the value of the dashboard network config (the string, function, or object assigned to `networks.dashboard`) matches.\r\n\r\n## Underlying cause\r\n\r\nMost modern operating systems have two entries for `localhost` in their `/etc/hosts` (or in the case of Windows, `C:\\Windows\\system32\\drivers\\etc\\hosts`) files. The first entry usually resolves to the IPv4 loopback address (`127.0.0.1`), and the second usually resolves to the IPv6 loopback address (`::1`).\r\n\r\nFor some reason when we initialize the dashboard's instance of `http.Server` via express with a hostname value of `localhost`, it's electing to listen _only_ on the IPv6 loopback interface. To address this, back in node v11.4.0 they added [an `ipv6Only` field to the `options` object that's passed into the `net.Server.listen` method](https://nodejs.org/docs/latest-v11.x/api/net.html#net_server_listen_options_callback).\r\n\r\nWhat's confusing here is that `ipv6Only` defaults to `false`, which should trigger \"dual stack\" support for `net.Server.listen`, and by extension, `http.Server.listen`, as `http.Server.listen` is identical to `net.Server.listen`.\r\n\r\nHowever in the dashboard code we don't appear to call `httpServer.listen` directly. Rather, [we appear to call the `listen` method of the ExpressJS `app` object](https://github.com/trufflesuite/truffle/blob/275115e1ce358aad3050a7583c034e5d19d885a1/packages/dashboard/lib/DashboardServer.ts#L108).\r\n\r\nIn Node v17.0.0 they switched `dns.lookup` to default to `verbatim=true`, which per nodejs/node#39987 (the PR that introduced the change) has the effect of defaulting to IPv6 addresses on name resolution over IPv4 addresses. My strong suspicion is that rather than just passing the unmodified `host` string off to the built-in `listen` method, Express is attempting to resolve the hostname and instead providing the resolved IP address. **As a result, I strongly suspect that this issue doesn't reproduce prior to node v17.**\r\n\r\n## Proposed fix\r\n\r\nEither we need to change up the code to avoid calling `expressApp.listen` and instead call `httpServer.listen` ourselves (this can be done by creating the `http.Server` instance ourselves by calling `http.createServer({ ... }, this.expressApp!)`), or we need to take extra steps to resolve the IP addresses for the given host and be sure to listen on both protocols.\r\n\r\n## Environment\r\n\r\n* Operating System: macOS 12.6\r\n* Truffle version (`truffle version`): v5.6.3 (core: 5.6.3)\r\n* node version (`node --version`): v18.12.0",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/5690/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/trufflesuite/truffle/issues/5690/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/1309607030",
    "html_url": "https://github.com/trufflesuite/truffle/issues/5690#issuecomment-1309607030",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/5690",
    "id": 1309607030,
    "node_id": "IC_kwDOAkfq-c5ODwR2",
    "user": {
      "login": "benjamincburns",
      "id": 803016,
      "node_id": "MDQ6VXNlcjgwMzAxNg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/803016?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/benjamincburns",
      "html_url": "https://github.com/benjamincburns",
      "followers_url": "https://api.github.com/users/benjamincburns/followers",
      "following_url": "https://api.github.com/users/benjamincburns/following{/other_user}",
      "gists_url": "https://api.github.com/users/benjamincburns/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/benjamincburns/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/benjamincburns/subscriptions",
      "organizations_url": "https://api.github.com/users/benjamincburns/orgs",
      "repos_url": "https://api.github.com/users/benjamincburns/repos",
      "events_url": "https://api.github.com/users/benjamincburns/events{/privacy}",
      "received_events_url": "https://api.github.com/users/benjamincburns/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-11-10T00:47:34Z",
    "updated_at": "2022-11-10T00:47:34Z",
    "author_association": "CONTRIBUTOR",
    "body": "Hmm, it doesn't seem that ExpressJS is the culprit. When we call `expressApp.listen`, [express is just proxying that call over to `httpServer.listen`](https://github.com/expressjs/express/blob/ea537d907d61dc693587fd41aab024e9df2e14b1/lib/application.js#L616-L619) (permalink points to current, at time of writing, HEAD of `4.x` branch). ðŸ¤”ðŸ¤”ðŸ¤”",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/1309607030/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/1309634026",
    "html_url": "https://github.com/trufflesuite/truffle/issues/5690#issuecomment-1309634026",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/5690",
    "id": 1309634026,
    "node_id": "IC_kwDOAkfq-c5OD23q",
    "user": {
      "login": "benjamincburns",
      "id": 803016,
      "node_id": "MDQ6VXNlcjgwMzAxNg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/803016?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/benjamincburns",
      "html_url": "https://github.com/benjamincburns",
      "followers_url": "https://api.github.com/users/benjamincburns/followers",
      "following_url": "https://api.github.com/users/benjamincburns/following{/other_user}",
      "gists_url": "https://api.github.com/users/benjamincburns/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/benjamincburns/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/benjamincburns/subscriptions",
      "organizations_url": "https://api.github.com/users/benjamincburns/orgs",
      "repos_url": "https://api.github.com/users/benjamincburns/repos",
      "events_url": "https://api.github.com/users/benjamincburns/events{/privacy}",
      "received_events_url": "https://api.github.com/users/benjamincburns/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-11-10T01:16:19Z",
    "updated_at": "2022-11-10T01:16:19Z",
    "author_association": "CONTRIBUTOR",
    "body": "On further inspection, I don't think the `net` package makes any effort to bind to both IPv4 and IPv6 addresses on a call to `listen`.\r\n\r\nI traced the code through to where it opens up the file descriptor to listen on the port, and [the logic](https://github.com/nodejs/node/blob/09ae62b9a869ff19d634b0fd1f5a17f198cd1ae7/lib/net.js#L1396-L1411) is clearly mutually exclusive.\r\n\r\nI have however confirmed the behaviour of the `listen` function with respect to hostname resolution. That is, `listen` calls an internal function named `lookupAndListen`, which uses [the signature of `dns.lookup`](https://github.com/nodejs/node/blob/09ae62b9a869ff19d634b0fd1f5a17f198cd1ae7/lib/net.js#L1660) that only [returns the first-resolved address for the given hostname](https://nodejs.org/api/dns.html#dnslookuphostname-options-callback).\r\n\r\nPersonally I regard this as a NodeJS bug. Ideally `lookupAndListen` would pass `{ all: true }` to `dns.lookup`, and listen on each distinct IP address that's resolved for a given hostname.\r\n\r\nIn the meantime my suggestion is that we implement exactly that functionality in our code as a workaround to this problem. Doing this will have the effect of fixing the issue not only for the `localhost` hostname, but also for all other hostnames that resolve dual addresses.",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/1309634026/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/1309643873",
    "html_url": "https://github.com/trufflesuite/truffle/issues/5690#issuecomment-1309643873",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/5690",
    "id": 1309643873,
    "node_id": "IC_kwDOAkfq-c5OD5Rh",
    "user": {
      "login": "benjamincburns",
      "id": 803016,
      "node_id": "MDQ6VXNlcjgwMzAxNg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/803016?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/benjamincburns",
      "html_url": "https://github.com/benjamincburns",
      "followers_url": "https://api.github.com/users/benjamincburns/followers",
      "following_url": "https://api.github.com/users/benjamincburns/following{/other_user}",
      "gists_url": "https://api.github.com/users/benjamincburns/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/benjamincburns/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/benjamincburns/subscriptions",
      "organizations_url": "https://api.github.com/users/benjamincburns/orgs",
      "repos_url": "https://api.github.com/users/benjamincburns/repos",
      "events_url": "https://api.github.com/users/benjamincburns/events{/privacy}",
      "received_events_url": "https://api.github.com/users/benjamincburns/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-11-10T01:28:13Z",
    "updated_at": "2022-11-10T01:32:17Z",
    "author_association": "CONTRIBUTOR",
    "body": "Also related:\r\n\r\n- nodejs/node#40702\r\n- nodejs/node#41625\r\n  - See this Wikipedia article on [the Happy Eyeballs algorithm](https://en.wikipedia.org/wiki/Happy_Eyeballs)\r\n  - this likely will fix this issue when implemented, but said fix won't apply to current versions of node\r\n\r\nThe first issue above suggests alternative workaround that is arguably simpler to implement than the one I proposed in my previous comment: simply setting [dns.setDefaultResultOrder(\"ipv4first\")](https://nodejs.org/api/dns.html#dnssetdefaultresultorderorder) at process start.\r\n\r\nHowever to work properly this workaround will need to be set on the calling clients as well. Non-node clients like browsers and `curl` implement the Happy Eyeballs algorithm, and therefor would still work with this workaround in place.\r\n\r\nThat said, I think the more complex workaround that I mentioned above comes with fewer caveats, likely isn't all _that_ complex to implement, and will be more robust overall.",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/1309643873/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/1309719561",
    "html_url": "https://github.com/trufflesuite/truffle/issues/5690#issuecomment-1309719561",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/5690",
    "id": 1309719561,
    "node_id": "IC_kwDOAkfq-c5OELwJ",
    "user": {
      "login": "benjamincburns",
      "id": 803016,
      "node_id": "MDQ6VXNlcjgwMzAxNg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/803016?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/benjamincburns",
      "html_url": "https://github.com/benjamincburns",
      "followers_url": "https://api.github.com/users/benjamincburns/followers",
      "following_url": "https://api.github.com/users/benjamincburns/following{/other_user}",
      "gists_url": "https://api.github.com/users/benjamincburns/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/benjamincburns/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/benjamincburns/subscriptions",
      "organizations_url": "https://api.github.com/users/benjamincburns/orgs",
      "repos_url": "https://api.github.com/users/benjamincburns/repos",
      "events_url": "https://api.github.com/users/benjamincburns/events{/privacy}",
      "received_events_url": "https://api.github.com/users/benjamincburns/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-11-10T03:28:13Z",
    "updated_at": "2022-11-10T03:28:37Z",
    "author_association": "CONTRIBUTOR",
    "body": "Looks like changing it to explicitly listen on both protocols will work.\r\n\r\nNote that I haven't changed the message bus yet (will need to do that as part of this), but for only the dashboard server's `http.Server` instance here's the before/after view as shown by `lsof -i -P | grep LISTEN`:\r\n\r\nBefore:\r\n```\r\nnode      43379 bburns   23u  IPv4 0x8449cb6c5435c875      0t0  TCP localhost:63144 (LISTEN)\r\nnode      43379 bburns   24u  IPv4 0x8449cb6c54345c35      0t0  TCP localhost:63145 (LISTEN)\r\nnode      43379 bburns   27u  IPv4 0x8449cb6c4fd76745      0t0  TCP localhost:24012 (LISTEN)\r\n```\r\n\r\nAfter:\r\n```\r\nnode      44080 bburns   25u  IPv6 0x8449cb75e5f647bd      0t0  TCP localhost:63164 (LISTEN)\r\nnode      44080 bburns   26u  IPv6 0x8449cb75e5f64f3d      0t0  TCP localhost:63165 (LISTEN)\r\nnode      44080 bburns   29u  IPv6 0x8449cb75e5f665bd      0t0  TCP localhost:24012 (LISTEN)\r\nnode      44080 bburns   30u  IPv4 0x8449cb6c4fd87d65      0t0  TCP localhost:24012 (LISTEN)\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/1309719561/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
