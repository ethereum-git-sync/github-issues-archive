{
  "url": "https://api.github.com/repos/trufflesuite/truffle/issues/2040",
  "repository_url": "https://api.github.com/repos/trufflesuite/truffle",
  "labels_url": "https://api.github.com/repos/trufflesuite/truffle/issues/2040/labels{/name}",
  "comments_url": "https://api.github.com/repos/trufflesuite/truffle/issues/2040/comments",
  "events_url": "https://api.github.com/repos/trufflesuite/truffle/issues/2040/events",
  "html_url": "https://github.com/trufflesuite/truffle/issues/2040",
  "id": 446735771,
  "node_id": "MDU6SXNzdWU0NDY3MzU3NzE=",
  "number": 2040,
  "title": "Truffle Wallet Provider should support Websockets",
  "user": {
    "login": "barlock",
    "id": 5770007,
    "node_id": "MDQ6VXNlcjU3NzAwMDc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5770007?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/barlock",
    "html_url": "https://github.com/barlock",
    "followers_url": "https://api.github.com/users/barlock/followers",
    "following_url": "https://api.github.com/users/barlock/following{/other_user}",
    "gists_url": "https://api.github.com/users/barlock/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/barlock/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/barlock/subscriptions",
    "organizations_url": "https://api.github.com/users/barlock/orgs",
    "repos_url": "https://api.github.com/users/barlock/repos",
    "events_url": "https://api.github.com/users/barlock/events{/privacy}",
    "received_events_url": "https://api.github.com/users/barlock/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 230393328,
      "node_id": "MDU6TGFiZWwyMzAzOTMzMjg=",
      "url": "https://api.github.com/repos/trufflesuite/truffle/labels/enhancement",
      "name": "enhancement",
      "color": "84b6eb",
      "default": true,
      "description": null
    },
    {
      "id": 1289161117,
      "node_id": "MDU6TGFiZWwxMjg5MTYxMTE3",
      "url": "https://api.github.com/repos/trufflesuite/truffle/labels/web3",
      "name": "web3",
      "color": "477aef",
      "default": false,
      "description": ""
    },
    {
      "id": 1675041996,
      "node_id": "MDU6TGFiZWwxNjc1MDQxOTk2",
      "url": "https://api.github.com/repos/trufflesuite/truffle/labels/priority4%20%F0%9F%93%8B",
      "name": "priority4 ðŸ“‹",
      "color": "006b75",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2019-05-21T17:22:17Z",
  "updated_at": "2020-04-15T18:13:03Z",
  "closed_at": "2020-04-15T18:13:03Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "## Issue\r\n\r\nThe truffle-hdwallet-provider currently only supports http connections. \r\n\r\nI'm using drizzle connected to Pantheon. For my test environment, I've spun it up so that none of my accounts need any eth to interact with the dapp. I like how your hooked wallet implementation can create ephemeral keys from a set mnemonic. It would be nice to be able to use that without forking.\r\n\r\n## Steps to Reproduce\r\n\r\nPass any WebSocket provider into `truffle-hdwallet-provider` and attach it to drizzle and it will tell you that subscriptions aren't supported. This is because the SubproviderProvider used in the engine doesn't support subscriptions. Any sub-provider that does, will be ignored. \r\n\r\n## Expected Behavior\r\n\r\nPassing in a provider will yield the full feature set of the provider, not just being able to send a request.\r\n\r\n## Workaround\r\n\r\nRight now, by editing the code to add a subprovider instead of creating a SubproviderProvider (phew) everything works as expected.\r\n\r\nThis could likely either be fixed by addressing what a `SubProviderProvider` can do, or by tweaking the initialization of your provider engine. The latter seemed better to me. I'd be happy to make a pr if you'll accept.\r\n\r\n\r\n<details>\r\n<summary>Example</summary>\r\n    ```js\r\n\r\n    const bip39 = require('bip39');\r\n    const ethJSWallet = require('ethereumjs-wallet');\r\n    const hdkey = require('ethereumjs-wallet/hdkey');\r\n    const ProviderEngine = require('web3-provider-engine');\r\n    const FiltersProvider = require('web3-provider-engine/subproviders/filters.js');\r\n    const WebsocketProvider = require('web3-provider-engine/subproviders/websocket.js');\r\n    const NonceProvider = require('web3-provider-engine/subproviders/nonce-tracker');\r\n    const HookedProvider = require('web3-provider-engine/subproviders/hooked-wallet.js');\r\n    const Transaction = require('ethereumjs-tx');\r\n    const ethUtil = require('ethereumjs-util');\r\n    \r\n    export default (mnemonic, address_index = 0, num_addresses = 10) => {\r\n      let hdwallet;\r\n      const wallet_hdpath = \"m/44'/60'/0'/0/\";\r\n      const wallets = {};\r\n      const addresses = [];\r\n      const engine = new ProviderEngine();\r\n    \r\n      // private helper to normalize given mnemonic\r\n      const normalizePrivateKeys = mnemonic => {\r\n        if (Array.isArray(mnemonic)) return mnemonic;\r\n        else if (mnemonic && !mnemonic.includes(' ')) return [mnemonic];\r\n        // if truthy, but no spaces in mnemonic\r\n        else return false; // neither an array nor valid value passed;\r\n      };\r\n    \r\n      // private helper to check if given mnemonic uses BIP39 passphrase protection\r\n      const checkBIP39Mnemonic = mnemonic => {\r\n        hdwallet = hdkey.fromMasterSeed(bip39.mnemonicToSeed(mnemonic));\r\n    \r\n        if (!bip39.validateMnemonic(mnemonic)) {\r\n          throw new Error('Mnemonic invalid or undefined');\r\n        }\r\n    \r\n        // crank the addresses out\r\n        for (let i = address_index; i < address_index + num_addresses; i++) {\r\n          const wallet = hdwallet.derivePath(wallet_hdpath + i).getWallet();\r\n          const addr = `0x${wallet.getAddress().toString('hex')}`;\r\n          addresses.push(addr);\r\n          wallets[addr] = wallet;\r\n        }\r\n      };\r\n    \r\n      // private helper leveraging ethUtils to populate wallets/addresses\r\n      const ethUtilValidation = privateKeys => {\r\n        // crank the addresses out\r\n        for (let i = address_index; i < address_index + num_addresses; i++) {\r\n          const privateKey = Buffer.from(privateKeys[i].replace('0x', ''), 'hex');\r\n          if (ethUtil.isValidPrivate(privateKey)) {\r\n            const wallet = ethJSWallet.fromPrivateKey(privateKey);\r\n            const address = wallet.getAddressString();\r\n            addresses.push(address);\r\n            wallets[address] = wallet;\r\n          }\r\n        }\r\n      };\r\n    \r\n      const privateKeys = normalizePrivateKeys(mnemonic);\r\n    \r\n      if (!privateKeys) checkBIP39Mnemonic(mnemonic);\r\n      else ethUtilValidation(privateKeys);\r\n    \r\n      const tmp_accounts = addresses;\r\n      const tmp_wallets = wallets;\r\n    \r\n      engine.addProvider(\r\n        new HookedProvider({\r\n          getAccounts(cb) {\r\n            cb(null, tmp_accounts);\r\n          },\r\n          getPrivateKey(address, cb) {\r\n            if (!tmp_wallets[address]) {\r\n              return cb('Account not found');\r\n            } else {\r\n              cb(null, tmp_wallets[address].getPrivateKey().toString('hex'));\r\n            }\r\n          },\r\n          signTransaction(txParams, cb) {\r\n            let pkey;\r\n            const from = txParams.from.toLowerCase();\r\n            if (tmp_wallets[from]) {\r\n              pkey = tmp_wallets[from].getPrivateKey();\r\n            } else {\r\n              cb('Account not found');\r\n            }\r\n            const tx = new Transaction(txParams);\r\n            tx.sign(pkey);\r\n            const rawTx = `0x${tx.serialize().toString('hex')}`;\r\n            cb(null, rawTx);\r\n          },\r\n          signMessage({ data, from }, cb) {\r\n            const dataIfExists = data;\r\n            if (!dataIfExists) {\r\n              cb('No data to sign');\r\n            }\r\n            if (!tmp_wallets[from]) {\r\n              cb('Account not found');\r\n            }\r\n            const pkey = tmp_wallets[from].getPrivateKey();\r\n            const dataBuff = ethUtil.toBuffer(dataIfExists);\r\n            const msgHashBuff = ethUtil.hashPersonalMessage(dataBuff);\r\n            const sig = ethUtil.ecsign(msgHashBuff, pkey);\r\n            const rpcSig = ethUtil.toRpcSig(sig.v, sig.r, sig.s);\r\n            cb(null, rpcSig);\r\n          },\r\n          signPersonalMessage(...args) {\r\n            this.signMessage(...args);\r\n          }\r\n        })\r\n      );\r\n    \r\n      engine.addProvider(new NonceProvider());\r\n      engine.addProvider(new FiltersProvider());\r\n      // Interesting bit is here\r\n      engine.addProvider(new WebsocketProvider({ rpcUrl: 'ws://127.0.0.1:8546' }));\r\n      engine.start(); // Required by the provider engine.\r\n    \r\n      return engine;\r\n    };\r\n  ```\r\n</details>\r\n\r\n## Environment\r\n\r\n* Operating System: osx\r\n* Ethereum client: pantheon/Drizzle\r\n* Truffle version (`truffle version`): 5.0.18\r\n* node version (`node --version`): 10.15\r\n* npm version (`npm --version`): 6.9.0\r\n",
  "closed_by": {
    "login": "gnidan",
    "id": 151065,
    "node_id": "MDQ6VXNlcjE1MTA2NQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/151065?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/gnidan",
    "html_url": "https://github.com/gnidan",
    "followers_url": "https://api.github.com/users/gnidan/followers",
    "following_url": "https://api.github.com/users/gnidan/following{/other_user}",
    "gists_url": "https://api.github.com/users/gnidan/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/gnidan/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/gnidan/subscriptions",
    "organizations_url": "https://api.github.com/users/gnidan/orgs",
    "repos_url": "https://api.github.com/users/gnidan/repos",
    "events_url": "https://api.github.com/users/gnidan/events{/privacy}",
    "received_events_url": "https://api.github.com/users/gnidan/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/2040/reactions",
    "total_count": 3,
    "+1": 3,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/trufflesuite/truffle/issues/2040/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/494484249",
    "html_url": "https://github.com/trufflesuite/truffle/issues/2040#issuecomment-494484249",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/2040",
    "id": 494484249,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ5NDQ4NDI0OQ==",
    "user": {
      "login": "gnidan",
      "id": 151065,
      "node_id": "MDQ6VXNlcjE1MTA2NQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/151065?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gnidan",
      "html_url": "https://github.com/gnidan",
      "followers_url": "https://api.github.com/users/gnidan/followers",
      "following_url": "https://api.github.com/users/gnidan/following{/other_user}",
      "gists_url": "https://api.github.com/users/gnidan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gnidan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gnidan/subscriptions",
      "organizations_url": "https://api.github.com/users/gnidan/orgs",
      "repos_url": "https://api.github.com/users/gnidan/repos",
      "events_url": "https://api.github.com/users/gnidan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gnidan/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-05-21T17:28:15Z",
    "updated_at": "2019-05-21T17:28:15Z",
    "author_association": "MEMBER",
    "body": "I don't suppose you've tried adding `websockets: true` to your network config? See the [networks configuration](https://truffleframework.com/docs/truffle/reference/configuration#networks) docs.\r\n\r\nThanks for raising this issue!",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/494484249/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/494499909",
    "html_url": "https://github.com/trufflesuite/truffle/issues/2040#issuecomment-494499909",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/2040",
    "id": 494499909,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ5NDQ5OTkwOQ==",
    "user": {
      "login": "barlock",
      "id": 5770007,
      "node_id": "MDQ6VXNlcjU3NzAwMDc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5770007?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/barlock",
      "html_url": "https://github.com/barlock",
      "followers_url": "https://api.github.com/users/barlock/followers",
      "following_url": "https://api.github.com/users/barlock/following{/other_user}",
      "gists_url": "https://api.github.com/users/barlock/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/barlock/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/barlock/subscriptions",
      "organizations_url": "https://api.github.com/users/barlock/orgs",
      "repos_url": "https://api.github.com/users/barlock/repos",
      "events_url": "https://api.github.com/users/barlock/events{/privacy}",
      "received_events_url": "https://api.github.com/users/barlock/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-05-21T18:13:03Z",
    "updated_at": "2019-05-21T18:13:03Z",
    "author_association": "NONE",
    "body": "I haven't. I'm using the wallet provider in the browser with Drizzle. It doesn't ever see that config. I've wired Pantheon instead of ganache to use websockets. \r\n\r\nI'll have a branch with a working example soon.",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/494499909/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/494510468",
    "html_url": "https://github.com/trufflesuite/truffle/issues/2040#issuecomment-494510468",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/2040",
    "id": 494510468,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ5NDUxMDQ2OA==",
    "user": {
      "login": "barlock",
      "id": 5770007,
      "node_id": "MDQ6VXNlcjU3NzAwMDc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5770007?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/barlock",
      "html_url": "https://github.com/barlock",
      "followers_url": "https://api.github.com/users/barlock/followers",
      "following_url": "https://api.github.com/users/barlock/following{/other_user}",
      "gists_url": "https://api.github.com/users/barlock/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/barlock/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/barlock/subscriptions",
      "organizations_url": "https://api.github.com/users/barlock/orgs",
      "repos_url": "https://api.github.com/users/barlock/repos",
      "events_url": "https://api.github.com/users/barlock/events{/privacy}",
      "received_events_url": "https://api.github.com/users/barlock/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-05-21T18:43:15Z",
    "updated_at": "2019-05-21T18:43:15Z",
    "author_association": "NONE",
    "body": "Here's the important line change https://github.com/ConsenSys/web3studio-sidejam/pull/15/files#diff-1166b1bc9915bf05db55080cfd04dcb1R121\r\n\r\nDrizzle config: https://github.com/ConsenSys/web3studio-sidejam/pull/15/files#diff-f39bad30e90991680938d0737fb93d8dR10\r\n\r\nPantheon configuration: https://github.com/ConsenSys/web3studio-sidejam/pull/15/files#diff-4b6b1c9d03e80b998a3dc95e52f19aa6R4",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/494510468/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/597788499",
    "html_url": "https://github.com/trufflesuite/truffle/issues/2040#issuecomment-597788499",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/2040",
    "id": 597788499,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU5Nzc4ODQ5OQ==",
    "user": {
      "login": "eggplantzzz",
      "id": 14827965,
      "node_id": "MDQ6VXNlcjE0ODI3OTY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/14827965?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/eggplantzzz",
      "html_url": "https://github.com/eggplantzzz",
      "followers_url": "https://api.github.com/users/eggplantzzz/followers",
      "following_url": "https://api.github.com/users/eggplantzzz/following{/other_user}",
      "gists_url": "https://api.github.com/users/eggplantzzz/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/eggplantzzz/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/eggplantzzz/subscriptions",
      "organizations_url": "https://api.github.com/users/eggplantzzz/orgs",
      "repos_url": "https://api.github.com/users/eggplantzzz/repos",
      "events_url": "https://api.github.com/users/eggplantzzz/events{/privacy}",
      "received_events_url": "https://api.github.com/users/eggplantzzz/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-03-11T18:13:53Z",
    "updated_at": "2020-03-11T18:13:53Z",
    "author_association": "CONTRIBUTOR",
    "body": "Is this still an issue with the latest version of `@truffle/hdwallet-provider`?",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/597788499/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 1
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/614196773",
    "html_url": "https://github.com/trufflesuite/truffle/issues/2040#issuecomment-614196773",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/2040",
    "id": 614196773,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYxNDE5Njc3Mw==",
    "user": {
      "login": "gnidan",
      "id": 151065,
      "node_id": "MDQ6VXNlcjE1MTA2NQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/151065?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gnidan",
      "html_url": "https://github.com/gnidan",
      "followers_url": "https://api.github.com/users/gnidan/followers",
      "following_url": "https://api.github.com/users/gnidan/following{/other_user}",
      "gists_url": "https://api.github.com/users/gnidan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gnidan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gnidan/subscriptions",
      "organizations_url": "https://api.github.com/users/gnidan/orgs",
      "repos_url": "https://api.github.com/users/gnidan/repos",
      "events_url": "https://api.github.com/users/gnidan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gnidan/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-04-15T18:13:03Z",
    "updated_at": "2020-04-15T18:13:03Z",
    "author_association": "MEMBER",
    "body": "Closing this for issue maintenance since it [appears](https://github.com/trufflesuite/truffle/blob/develop/packages/hdwallet-provider/src/index.ts#L170) that @truffle/hdwallet-provider **does** support websockets.\r\n\r\nIf there's still an issue, well, let us know, and we'll be happy to re-open! Thanks y'all ðŸ™‡ ",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/614196773/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
