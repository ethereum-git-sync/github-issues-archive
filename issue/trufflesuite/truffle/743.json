{
  "url": "https://api.github.com/repos/trufflesuite/truffle/issues/743",
  "repository_url": "https://api.github.com/repos/trufflesuite/truffle",
  "labels_url": "https://api.github.com/repos/trufflesuite/truffle/issues/743/labels{/name}",
  "comments_url": "https://api.github.com/repos/trufflesuite/truffle/issues/743/comments",
  "events_url": "https://api.github.com/repos/trufflesuite/truffle/issues/743/events",
  "html_url": "https://github.com/trufflesuite/truffle/issues/743",
  "id": 287246564,
  "node_id": "MDU6SXNzdWUyODcyNDY1NjQ=",
  "number": 743,
  "title": "Truffle test fails with payable fallback function",
  "user": {
    "login": "jasontwong",
    "id": 1128472,
    "node_id": "MDQ6VXNlcjExMjg0NzI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1128472?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jasontwong",
    "html_url": "https://github.com/jasontwong",
    "followers_url": "https://api.github.com/users/jasontwong/followers",
    "following_url": "https://api.github.com/users/jasontwong/following{/other_user}",
    "gists_url": "https://api.github.com/users/jasontwong/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jasontwong/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jasontwong/subscriptions",
    "organizations_url": "https://api.github.com/users/jasontwong/orgs",
    "repos_url": "https://api.github.com/users/jasontwong/repos",
    "events_url": "https://api.github.com/users/jasontwong/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jasontwong/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2018-01-09T22:04:55Z",
  "updated_at": "2018-01-12T02:18:27Z",
  "closed_at": "2018-01-12T02:18:27Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "- [x] I've asked for help in the [Truffle Gitter](http://gitter.im/Consensys/truffle) before filing this issue.\r\n\r\n---------------------------\r\n\r\n## Issue\r\n\r\nPayable fallback functions will crash with a `VM Exception` during `truffle test` if it modifies the state.\r\n\r\n## Steps to Reproduce\r\n\r\n- Create any contract with a payable fallback function that modifies state. Example:\r\n```\r\npragma solidity ^0.4.18;\r\n\r\ncontract MyContract {\r\n  uint256 public money;\r\n\r\n  function () external payable {\r\n    money = 5;\r\n  }\r\n}\r\n```\r\n- Write a test that sends ether to the contract. Example:\r\n```\r\npragma solidity ^0.4.18;\r\n\r\nimport \"truffle/Assert.sol\";\r\nimport \"truffle/DeployedAddresses.sol\";\r\nimport \"../contracts/MyContract.sol\";\r\n\r\ncontract TestMyContract {\r\n  uint public initialBalance = 1 ether;\r\n\r\n  function testSend() public {\r\n    MyContract token = MyContract(DeployedAddresses.MyContract());\r\n\r\n    Assert.equal(token.money(), 0, \"money should be 0.\");\r\n\r\n    token.transfer(1000);\r\n\r\n    Assert.equal(token.money(), 5, \"money should be 5.\");\r\n    Assert.notEqual(this.balance, initialBalance, \"Balance should have changed.\");\r\n  }\r\n}\r\n```\r\n- Run `truffle test`.\r\n\r\n## Expected Behavior\r\n\r\n- I expect the state of the contract to change. In this case, money should change to `5`.\r\n\r\n## Actual Results\r\n\r\n- I receive a `VM Exception`.\r\n```\r\n     Error: VM Exception while processing transaction: revert\r\n      at Object.InvalidResponse (/Users/jwong/.config/yarn/global/node_modules/truffle/build/cli.bundled.js:41484:16)\r\n      at /Users/jwong/.config/yarn/global/node_modules/truffle/build/cli.bundled.js:329530:36\r\n      at /Users/jwong/.config/yarn/global/node_modules/truffle/build/cli.bundled.js:325200:9\r\n      at XMLHttpRequest.request.onreadystatechange (/Users/jwong/.config/yarn/global/node_modules/truffle/build/cli.bundled.js:328229:7)\r\n      at XMLHttpRequestEventTarget.dispatchEvent (/Users/jwong/.config/yarn/global/node_modules/truffle/build/cli.bundled.js:176415:18)\r\n      at XMLHttpRequest._setReadyState (/Users/jwong/.config/yarn/global/node_modules/truffle/build/cli.bundled.js:176705:12)\r\n      at XMLHttpRequest._onHttpResponseEnd (/Users/jwong/.config/yarn/global/node_modules/truffle/build/cli.bundled.js:176860:12)\r\n      at IncomingMessage.<anonymous> (/Users/jwong/.config/yarn/global/node_modules/truffle/build/cli.bundled.js:176820:24)\r\n```\r\n\r\n## Environment\r\n\r\n* Operating System: macOS High Sierra 10.13.2 (17C88)\r\n* Truffle version: Truffle v4.0.4 (core: 4.0.4)\r\n* Ethereum client: Truffle Test\r\n* node version: v8.2.1\r\n* npm version: 5.3.0\r\n",
  "closed_by": {
    "login": "cgewecke",
    "id": 7332026,
    "node_id": "MDQ6VXNlcjczMzIwMjY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/7332026?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/cgewecke",
    "html_url": "https://github.com/cgewecke",
    "followers_url": "https://api.github.com/users/cgewecke/followers",
    "following_url": "https://api.github.com/users/cgewecke/following{/other_user}",
    "gists_url": "https://api.github.com/users/cgewecke/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/cgewecke/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/cgewecke/subscriptions",
    "organizations_url": "https://api.github.com/users/cgewecke/orgs",
    "repos_url": "https://api.github.com/users/cgewecke/repos",
    "events_url": "https://api.github.com/users/cgewecke/events{/privacy}",
    "received_events_url": "https://api.github.com/users/cgewecke/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/743/reactions",
    "total_count": 4,
    "+1": 4,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/trufflesuite/truffle/issues/743/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/357116853",
    "html_url": "https://github.com/trufflesuite/truffle/issues/743#issuecomment-357116853",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/743",
    "id": 357116853,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM1NzExNjg1Mw==",
    "user": {
      "login": "Tmeister",
      "id": 210349,
      "node_id": "MDQ6VXNlcjIxMDM0OQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/210349?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Tmeister",
      "html_url": "https://github.com/Tmeister",
      "followers_url": "https://api.github.com/users/Tmeister/followers",
      "following_url": "https://api.github.com/users/Tmeister/following{/other_user}",
      "gists_url": "https://api.github.com/users/Tmeister/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Tmeister/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Tmeister/subscriptions",
      "organizations_url": "https://api.github.com/users/Tmeister/orgs",
      "repos_url": "https://api.github.com/users/Tmeister/repos",
      "events_url": "https://api.github.com/users/Tmeister/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Tmeister/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-01-12T01:32:22Z",
    "updated_at": "2018-01-12T01:32:22Z",
    "author_association": "NONE",
    "body": "Same issue here.\r\n\r\nI'm using the StandardToken contract as follows:\r\n\r\n```\r\npragma solidity ^0.4.18;\r\n\r\nimport 'zeppelin-solidity/contracts/token/StandardToken.sol';\r\n\r\n\r\ncontract MyTestToken is StandardToken {\r\n    string public name = 'TEST';\r\n    string public symbol = 'TST99';\r\n    uint8 decimals = 18;\r\n    uint public INITIAL_SUPPLY = 30000000e18;\r\n\r\n    function TestToken () public {\r\n        totalSupply = INITIAL_SUPPLY;\r\n        balances[msg.sender] = INITIAL_SUPPLY;\r\n    }\r\n}\r\n\r\n```\r\n\r\nThe test function:\r\n\r\n```\r\nfunction test_transfer_with_invalid_amount() public {\r\n        bool transferSuccessful = _fundaryTestToken.transfer(_owner, 31000000000000000000000000);\r\n        Assert.isFalse(transferSuccessful, 'Addresses should not be able to transfer more tokens than allocated');\r\n    }\r\n```\r\n\r\nRun `truffle test`\r\n\r\n```\r\n➜  mastercoin git:(master) ✗ truffle test\r\nUsing network 'development'.\r\n\r\nCompiling ./contracts/TestToken.sol...\r\nCompiling ./test/MyTestToken.sol...\r\nCompiling truffle/Assert.sol...\r\nCompiling zeppelin-solidity/contracts/math/SafeMath.sol...\r\nCompiling zeppelin-solidity/contracts/token/BasicToken.sol...\r\nCompiling zeppelin-solidity/contracts/token/ERC20.sol...\r\nCompiling zeppelin-solidity/contracts/token/ERC20Basic.sol...\r\nCompiling zeppelin-solidity/contracts/token/StandardToken.sol...\r\n\r\n\r\n  MyTestToken\r\n    ✓ test_constructor (88ms)\r\n    ✓ test_transfer_with_valid_amount (148ms)\r\n    1) test_transfer_with_invalid_amount\r\n    > No events were emitted\r\n    ✓ test_totalSupply (84ms)\r\n    ✓ test_approve_whit_valid_amount (100ms)\r\n    ✓ test_allowance_with_no_allocated_balance (121ms)\r\n    ✓ test_allowance_with_allocated_balance (149ms)\r\n\r\n  Contract: MyTestToken\r\n    ✓ Should contain 30000000000000000000000000 MyTestToken in circulation\r\n\r\n\r\n  7 passing (3s)\r\n  1 failing\r\n\r\n  1) MyTestToken test_transfer_with_invalid_amount:\r\n     Error: VM Exception while processing transaction: revert\r\n      at Object.InvalidResponse (/Users/tmeister/.nvm/versions/node/v6.11.1/lib/node_modules/truffle/build/cli.bundled.js:41484:16)\r\n      at /Users/tmeister/.nvm/versions/node/v6.11.1/lib/node_modules/truffle/build/cli.bundled.js:329530:36\r\n      at /Users/tmeister/.nvm/versions/node/v6.11.1/lib/node_modules/truffle/build/cli.bundled.js:325200:9\r\n      at XMLHttpRequest.request.onreadystatechange (/Users/tmeister/.nvm/versions/node/v6.11.1/lib/node_modules/truffle/build/cli.bundled.js:328229:7)\r\n      at XMLHttpRequestEventTarget.dispatchEvent (/Users/tmeister/.nvm/versions/node/v6.11.1/lib/node_modules/truffle/build/cli.bundled.js:176415:18)\r\n      at XMLHttpRequest._setReadyState (/Users/tmeister/.nvm/versions/node/v6.11.1/lib/node_modules/truffle/build/cli.bundled.js:176705:12)\r\n      at XMLHttpRequest._onHttpResponseEnd (/Users/tmeister/.nvm/versions/node/v6.11.1/lib/node_modules/truffle/build/cli.bundled.js:176860:12)\r\n      at IncomingMessage.<anonymous> (/Users/tmeister/.nvm/versions/node/v6.11.1/lib/node_modules/truffle/build/cli.bundled.js:176820:24)\r\n```\r\n\r\nLogs\r\n\r\n```\r\n[7:26:15 PM] eth_sendTransaction\r\n[7:26:15 PM]   Transaction: 0x4e99c36525a65e9451f68a5f373bec2c9d99858107d750da0e5bd552a5ebee09\r\n[7:26:15 PM]   Gas usage: 24281\r\n[7:26:15 PM]   Block Number: 84\r\n[7:26:15 PM]   Block Time: Thu Jan 11 2018 19:26:15 GMT-0600 (CST)\r\n[7:26:15 PM]   Runtime Error: revert\r\n```\r\n\r\nEnvironment\r\n\r\nOperating System: macOS High Sierra 10.13.2 (17C88)\r\nTruffle version: Truffle v4.0.4 (core: 4.0.4)\r\nEthereum client: Truffle Test\r\nGanache 1.0.1",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/357116853/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/357123885",
    "html_url": "https://github.com/trufflesuite/truffle/issues/743#issuecomment-357123885",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/743",
    "id": 357123885,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM1NzEyMzg4NQ==",
    "user": {
      "login": "cgewecke",
      "id": 7332026,
      "node_id": "MDQ6VXNlcjczMzIwMjY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7332026?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cgewecke",
      "html_url": "https://github.com/cgewecke",
      "followers_url": "https://api.github.com/users/cgewecke/followers",
      "following_url": "https://api.github.com/users/cgewecke/following{/other_user}",
      "gists_url": "https://api.github.com/users/cgewecke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cgewecke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cgewecke/subscriptions",
      "organizations_url": "https://api.github.com/users/cgewecke/orgs",
      "repos_url": "https://api.github.com/users/cgewecke/repos",
      "events_url": "https://api.github.com/users/cgewecke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cgewecke/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-01-12T02:18:27Z",
    "updated_at": "2018-01-12T02:18:27Z",
    "author_association": "CONTRIBUTOR",
    "body": "Hi @jasontwong, @Tmeister. It looks like you're facing separate but similar issues.\r\n\r\n@jasontwong: To transfer eth from one contract to another you'll first need to fund the contract from an account that has a balance. There's a nice example of how to do that in the Truffle docs [here](http://truffleframework.com/docs/getting_started/contracts#sending-ether-to-a-contract). Additionally, you should know that using Solidity's `transfer` and `send` methods limits the amount of gas allocated for the execution of the fallback function - typically just enough to fire an event. Setting a variable might be too expensive. There's more about this at the solidity docs [here](http://solidity.readthedocs.io/en/develop/contracts.html#fallback-function).\r\n\r\n@Tmeister: It looks like your test is throwing, which is what you want. The issue is that this error should be triggered in a try-catch block, and assertions made for each section. It's a common pattern in Solidity testing and there are nice examples at `zeppelin`'s own test suite [here](https://github.com/OpenZeppelin/zeppelin-solidity/blob/master/test/Claimable.test.js#L35). They've also written some helpful JS utilities for cases like this - [here](https://github.com/OpenZeppelin/zeppelin-solidity/tree/master/test/helpers).\r\n\r\nClosing for house-keeping since these don't seem like problems with Truffle as such, but please re-open if you discover otherwise. Or open a new issue. Thanks! ",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/357123885/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
