{
  "url": "https://api.github.com/repos/trufflesuite/truffle/issues/1645",
  "repository_url": "https://api.github.com/repos/trufflesuite/truffle",
  "labels_url": "https://api.github.com/repos/trufflesuite/truffle/issues/1645/labels{/name}",
  "comments_url": "https://api.github.com/repos/trufflesuite/truffle/issues/1645/comments",
  "events_url": "https://api.github.com/repos/trufflesuite/truffle/issues/1645/events",
  "html_url": "https://github.com/trufflesuite/truffle/issues/1645",
  "id": 401112229,
  "node_id": "MDU6SXNzdWU0MDExMTIyMjk=",
  "number": 1645,
  "title": "sourcemap \"source index\" unspecified in build/contracts",
  "user": {
    "login": "rocky",
    "id": 8851,
    "node_id": "MDQ6VXNlcjg4NTE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/8851?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/rocky",
    "html_url": "https://github.com/rocky",
    "followers_url": "https://api.github.com/users/rocky/followers",
    "following_url": "https://api.github.com/users/rocky/following{/other_user}",
    "gists_url": "https://api.github.com/users/rocky/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/rocky/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rocky/subscriptions",
    "organizations_url": "https://api.github.com/users/rocky/orgs",
    "repos_url": "https://api.github.com/users/rocky/repos",
    "events_url": "https://api.github.com/users/rocky/events{/privacy}",
    "received_events_url": "https://api.github.com/users/rocky/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 7,
  "created_at": "2019-01-20T16:08:49Z",
  "updated_at": "2019-03-13T17:49:24Z",
  "closed_at": "2019-03-13T17:49:23Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "## Issue\r\n\r\nThe \"source index\" number (3rd field in _s:l:f_ of https://solidity.readthedocs.io/en/v0.5.2/miscellaneous.html#source-mappings ) is unspecified in `build/contracts/*.json`\r\n\r\n\r\n## Steps to Reproduce\r\n\r\nConsider this simple contract as the only contract in a truffle project: \r\n\r\n```solidity\r\npragma solidity ^0.5.0;\r\n\r\ncontract PublicStorageArray {\r\n    bytes32[] public states = [bytes32(0)];\r\n}\r\n```\r\n\r\nWhen compiled, here is an excerpt of the `build/contracts/PublicStorageArray.json`:\r\n\r\n```json\r\n{\r\n    \"contractName\": \"PublicStorageArray\",\r\n    ...\r\n    \"sourceMap\": \"25:75:1:-;...\",\r\n    \"deployedSourceMap\": \"25:75:1:-;...\",\r\n    ...\r\n    \"ast\": {\r\n      \"nodes\": [\r\n        {\r\n        \"nodeType\": \"PragmaDirective\",\r\n        \"src\": \"0:23:1\"\r\n        } ...\r\n      ]\r\n    }\r\n}\r\n```\r\nNote that the 1 isn't really reconstructable from the rest of the file.\r\n\r\n## Expected Behavior\r\n\r\nBest in my opinion would be to add a \"sources\" which refers to all of the contracts that were in the collection compiled, where the 1 position is in fact the file that contans the contract. In other words:\r\n\r\n```json\r\n{\r\n    \"contractName\": \"PublicStorageArray\",\r\n    \"sources\": [\"/tmp/foo/contracts/Migrations.sol\", \"/tmp/foo/contracts/PublicStorageArray.sol\"],\r\n   ...\r\n}\r\n```\r\n\r\nAnother less good possibility is change all of the 1's to 0's and assume 0 refers to the \"sourcePath\" field. A potential problem here is that this assumes that it assmes that code from a contract can come from only one file. (I am not sure that is true and will always be true; e.g. do \"imports\" change this?) \r\n\r\nFinally, I should note, nothing might be done and would-be consumers of this information would have to adjust ast \"src\" and source and \"sourceMap\" reading to ingore the source index field.\r\n\r\n\r\n## Environment\r\n\r\n* Operating System: Ubuntu\r\n* Ethereum client:\r\n* Truffle version: \r\n```\r\nTruffle v5.0.0-next.24 (core: 5.0.0-beta.2)\r\nSolidity v0.5.0 (solc-js)\r\nNode v10.13.0\r\n```\r\n* npm version (`npm --version`): 6.6.0\r\n\r\n## Possible Fix concept. \r\n\r\nIn `truffle-workflow-compile` `writeContracts()` add before the call to `saveAll()`: \r\n\r\n```javascript\r\n    const contractNames = Object.keys(contracts).sort();\r\n    const sources = contractNames.map(c => contracts[c].sourcePath);\r\n    for (let c of contractNames) {\r\n\tcontracts[c].sources = sources;\r\n    }\r\n```\r\nwhich creates a `sources` field. And in `truffle-contract-schema/index.js` add before \"userdoc\":\r\n```javascript\r\n  \"sources\": {},\r\n```",
  "closed_by": {
    "login": "gnidan",
    "id": 151065,
    "node_id": "MDQ6VXNlcjE1MTA2NQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/151065?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/gnidan",
    "html_url": "https://github.com/gnidan",
    "followers_url": "https://api.github.com/users/gnidan/followers",
    "following_url": "https://api.github.com/users/gnidan/following{/other_user}",
    "gists_url": "https://api.github.com/users/gnidan/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/gnidan/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/gnidan/subscriptions",
    "organizations_url": "https://api.github.com/users/gnidan/orgs",
    "repos_url": "https://api.github.com/users/gnidan/repos",
    "events_url": "https://api.github.com/users/gnidan/events{/privacy}",
    "received_events_url": "https://api.github.com/users/gnidan/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/1645/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/trufflesuite/truffle/issues/1645/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/456228730",
    "html_url": "https://github.com/trufflesuite/truffle/issues/1645#issuecomment-456228730",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/1645",
    "id": 456228730,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ1NjIyODczMA==",
    "user": {
      "login": "gnidan",
      "id": 151065,
      "node_id": "MDQ6VXNlcjE1MTA2NQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/151065?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gnidan",
      "html_url": "https://github.com/gnidan",
      "followers_url": "https://api.github.com/users/gnidan/followers",
      "following_url": "https://api.github.com/users/gnidan/following{/other_user}",
      "gists_url": "https://api.github.com/users/gnidan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gnidan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gnidan/subscriptions",
      "organizations_url": "https://api.github.com/users/gnidan/orgs",
      "repos_url": "https://api.github.com/users/gnidan/repos",
      "events_url": "https://api.github.com/users/gnidan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gnidan/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-01-22T00:04:43Z",
    "updated_at": "2019-01-22T00:04:43Z",
    "author_association": "MEMBER",
    "body": "Hey @rocky,\r\n\r\nThanks for opening this. Wanted to say first that this is a problem we're extremely aware of and currently looking at solutions for.\r\n\r\nBesides that, however, simply including `sources` does not work because Truffle does partial compilations: not all sources are compiled every time, and so there is the risk of mismatch between file index and the current revision of a particular sourcePath.\r\n\r\nFeel free to reach out if you'd like me to go into more detail. This particular issue has been an enormous pain-point internally and so I can tell you that you are not alone in this frustration.",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/456228730/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/456229908",
    "html_url": "https://github.com/trufflesuite/truffle/issues/1645#issuecomment-456229908",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/1645",
    "id": 456229908,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ1NjIyOTkwOA==",
    "user": {
      "login": "rocky",
      "id": 8851,
      "node_id": "MDQ6VXNlcjg4NTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8851?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rocky",
      "html_url": "https://github.com/rocky",
      "followers_url": "https://api.github.com/users/rocky/followers",
      "following_url": "https://api.github.com/users/rocky/following{/other_user}",
      "gists_url": "https://api.github.com/users/rocky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rocky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rocky/subscriptions",
      "organizations_url": "https://api.github.com/users/rocky/orgs",
      "repos_url": "https://api.github.com/users/rocky/repos",
      "events_url": "https://api.github.com/users/rocky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rocky/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-01-22T00:13:43Z",
    "updated_at": "2019-01-22T01:15:05Z",
    "author_association": "NONE",
    "body": "Hmm. Given the complexity of what can be compiled when, the dynamic nature of files getting renamed, added, and removed, the only sane (simple) solution would be to make sure that each artifacts JSON file written is self contained and self consistent. \r\n\r\nWhen a compilation is passed off to `solc-js`, it has a consistent, fixed view of what files it is dealing with. So it seems to me that this list of files needs to be recorded somewhere in the output JSON.  In other words, means adding something like `sources` in each written JSON file, right? \r\n\r\nIf I am missing something, have faulty logic, or things are more complex, please do educate me.",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/456229908/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/456239538",
    "html_url": "https://github.com/trufflesuite/truffle/issues/1645#issuecomment-456239538",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/1645",
    "id": 456239538,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ1NjIzOTUzOA==",
    "user": {
      "login": "gnidan",
      "id": 151065,
      "node_id": "MDQ6VXNlcjE1MTA2NQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/151065?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gnidan",
      "html_url": "https://github.com/gnidan",
      "followers_url": "https://api.github.com/users/gnidan/followers",
      "following_url": "https://api.github.com/users/gnidan/following{/other_user}",
      "gists_url": "https://api.github.com/users/gnidan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gnidan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gnidan/subscriptions",
      "organizations_url": "https://api.github.com/users/gnidan/orgs",
      "repos_url": "https://api.github.com/users/gnidan/repos",
      "events_url": "https://api.github.com/users/gnidan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gnidan/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-01-22T01:24:02Z",
    "updated_at": "2019-01-22T01:24:02Z",
    "author_association": "MEMBER",
    "body": "Yep @rocky, those JSON files really do need to be self-contained. But they're already too large (#1269), so we can't just go adding all the information we need.\r\n\r\nI've been spending some time recently looking into this, and I believe I am on the trail of a working solution.",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/456239538/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/456247802",
    "html_url": "https://github.com/trufflesuite/truffle/issues/1645#issuecomment-456247802",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/1645",
    "id": 456247802,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ1NjI0NzgwMg==",
    "user": {
      "login": "rocky",
      "id": 8851,
      "node_id": "MDQ6VXNlcjg4NTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8851?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rocky",
      "html_url": "https://github.com/rocky",
      "followers_url": "https://api.github.com/users/rocky/followers",
      "following_url": "https://api.github.com/users/rocky/following{/other_user}",
      "gists_url": "https://api.github.com/users/rocky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rocky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rocky/subscriptions",
      "organizations_url": "https://api.github.com/users/rocky/orgs",
      "repos_url": "https://api.github.com/users/rocky/repos",
      "events_url": "https://api.github.com/users/rocky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rocky/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-01-22T02:16:36Z",
    "updated_at": "2019-01-22T02:16:56Z",
    "author_association": "NONE",
    "body": "Ok @gnidan will wait patiently and I am eager to see what you all come up with. I hope allowing what's in there to be user/tool configurable is possible. \r\n\r\nOtherwise developers like the MythX folks who use truffle packages as a library will need a separate artifacts folder or files. ",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/456247802/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/456248246",
    "html_url": "https://github.com/trufflesuite/truffle/issues/1645#issuecomment-456248246",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/1645",
    "id": 456248246,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ1NjI0ODI0Ng==",
    "user": {
      "login": "rocky",
      "id": 8851,
      "node_id": "MDQ6VXNlcjg4NTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8851?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rocky",
      "html_url": "https://github.com/rocky",
      "followers_url": "https://api.github.com/users/rocky/followers",
      "following_url": "https://api.github.com/users/rocky/following{/other_user}",
      "gists_url": "https://api.github.com/users/rocky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rocky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rocky/subscriptions",
      "organizations_url": "https://api.github.com/users/rocky/orgs",
      "repos_url": "https://api.github.com/users/rocky/repos",
      "events_url": "https://api.github.com/users/rocky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rocky/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-01-22T02:19:39Z",
    "updated_at": "2019-01-22T02:58:17Z",
    "author_association": "NONE",
    "body": "@gnidan I wrote that comment before I looked at the issue you cited - my bad.  I see you may be considering this, at least from the query side. Great! ",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/456248246/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/456299965",
    "html_url": "https://github.com/trufflesuite/truffle/issues/1645#issuecomment-456299965",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/1645",
    "id": 456299965,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ1NjI5OTk2NQ==",
    "user": {
      "login": "gnidan",
      "id": 151065,
      "node_id": "MDQ6VXNlcjE1MTA2NQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/151065?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gnidan",
      "html_url": "https://github.com/gnidan",
      "followers_url": "https://api.github.com/users/gnidan/followers",
      "following_url": "https://api.github.com/users/gnidan/following{/other_user}",
      "gists_url": "https://api.github.com/users/gnidan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gnidan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gnidan/subscriptions",
      "organizations_url": "https://api.github.com/users/gnidan/orgs",
      "repos_url": "https://api.github.com/users/gnidan/repos",
      "events_url": "https://api.github.com/users/gnidan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gnidan/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-01-22T07:40:34Z",
    "updated_at": "2019-01-22T07:40:34Z",
    "author_association": "MEMBER",
    "body": "@rocky more than only the query side! goal is a viable upgrade path for an improved system of record-keeping. See some wip docs [here](https://trufflesuite.github.io/artifact-updates) if you're curious about the current requirements/design.",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/456299965/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/472533856",
    "html_url": "https://github.com/trufflesuite/truffle/issues/1645#issuecomment-472533856",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/1645",
    "id": 472533856,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ3MjUzMzg1Ng==",
    "user": {
      "login": "gnidan",
      "id": 151065,
      "node_id": "MDQ6VXNlcjE1MTA2NQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/151065?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gnidan",
      "html_url": "https://github.com/gnidan",
      "followers_url": "https://api.github.com/users/gnidan/followers",
      "following_url": "https://api.github.com/users/gnidan/following{/other_user}",
      "gists_url": "https://api.github.com/users/gnidan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gnidan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gnidan/subscriptions",
      "organizations_url": "https://api.github.com/users/gnidan/orgs",
      "repos_url": "https://api.github.com/users/gnidan/repos",
      "events_url": "https://api.github.com/users/gnidan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gnidan/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-03-13T17:49:23Z",
    "updated_at": "2019-03-13T17:49:23Z",
    "author_association": "MEMBER",
    "body": "Closing this as duplicate of #1236. Thanks for raising this @rocky!",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/472533856/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
