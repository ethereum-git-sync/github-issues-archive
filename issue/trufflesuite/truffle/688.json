{
  "url": "https://api.github.com/repos/trufflesuite/truffle/issues/688",
  "repository_url": "https://api.github.com/repos/trufflesuite/truffle",
  "labels_url": "https://api.github.com/repos/trufflesuite/truffle/issues/688/labels{/name}",
  "comments_url": "https://api.github.com/repos/trufflesuite/truffle/issues/688/comments",
  "events_url": "https://api.github.com/repos/trufflesuite/truffle/issues/688/events",
  "html_url": "https://github.com/trufflesuite/truffle/issues/688",
  "id": 275727634,
  "node_id": "MDU6SXNzdWUyNzU3Mjc2MzQ=",
  "number": 688,
  "title": "Contract Address / Network Information not written into artifacts when using web3 function in migration script",
  "user": {
    "login": "nikita-fuchs",
    "id": 11761828,
    "node_id": "MDQ6VXNlcjExNzYxODI4",
    "avatar_url": "https://avatars.githubusercontent.com/u/11761828?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/nikita-fuchs",
    "html_url": "https://github.com/nikita-fuchs",
    "followers_url": "https://api.github.com/users/nikita-fuchs/followers",
    "following_url": "https://api.github.com/users/nikita-fuchs/following{/other_user}",
    "gists_url": "https://api.github.com/users/nikita-fuchs/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/nikita-fuchs/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/nikita-fuchs/subscriptions",
    "organizations_url": "https://api.github.com/users/nikita-fuchs/orgs",
    "repos_url": "https://api.github.com/users/nikita-fuchs/repos",
    "events_url": "https://api.github.com/users/nikita-fuchs/events{/privacy}",
    "received_events_url": "https://api.github.com/users/nikita-fuchs/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2017-11-21T14:17:32Z",
  "updated_at": "2017-11-28T18:01:27Z",
  "closed_at": "2017-11-28T18:01:27Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "- [ ] I've asked for help in the [Truffle Gitter](http://gitter.im/Consensys/truffle) before filing this issue.\r\n\r\n---------------------------\r\n\r\n## Issue\r\n\r\nIn Truffle 4, the whole \"networks\": {} field stays empty, in Truffle 3, the address of the contract is not saved in the artifacts. Both resulting in the error \"contract not deployed to this network\" when calling it from the truffle console.\r\n\r\n## Steps to Reproduce\r\n\r\n**truffle.js**\r\n\r\n```\r\nmodule.exports = {\r\n  networks: {\r\n    development: {\r\n      host: 'localhost',\r\n      port: 8545,\r\n      network_id: '*', // Match any network id\r\n      gas: 6500000\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n**2_deploy_contracts.js**\r\n```\r\nvar blocknumber;\r\n\r\nmodule.exports = function(deployer, network, accounts) {\r\n  web3.eth.getBlock(\"latest\", function(error, result){ \r\n    if (result) {\r\n      blocknumber = result.number;\r\n      var someValue = blocknumber + 20 ;\r\n      deployer.deploy(MyContract, someValue);\r\n    }})\r\n};\r\n\r\n```\r\n## Expected Behavior\r\n\r\nContract artifacts are correctly created with all information neccessary to interact with the contract.\r\n\r\n## Actual Results\r\n\r\nAs described above, in 3 the address is missing, in 4 the whole \"networks\" field. All works fine when added manually btw. \r\n\r\n## Environment\r\n\r\n* Operating System: Ubuntu 16\r\n* Truffle version: @3 / 4 latest\r\n* Ethereum client: testrpc v6\r\n* node version: Tested with 6.4 and 8.x\r\n* npm version: 5.5.1\r\n",
  "closed_by": {
    "login": "tcoulter",
    "id": 92629,
    "node_id": "MDQ6VXNlcjkyNjI5",
    "avatar_url": "https://avatars.githubusercontent.com/u/92629?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tcoulter",
    "html_url": "https://github.com/tcoulter",
    "followers_url": "https://api.github.com/users/tcoulter/followers",
    "following_url": "https://api.github.com/users/tcoulter/following{/other_user}",
    "gists_url": "https://api.github.com/users/tcoulter/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tcoulter/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tcoulter/subscriptions",
    "organizations_url": "https://api.github.com/users/tcoulter/orgs",
    "repos_url": "https://api.github.com/users/tcoulter/repos",
    "events_url": "https://api.github.com/users/tcoulter/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tcoulter/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/688/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/trufflesuite/truffle/issues/688/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/347609862",
    "html_url": "https://github.com/trufflesuite/truffle/issues/688#issuecomment-347609862",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/688",
    "id": 347609862,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM0NzYwOTg2Mg==",
    "user": {
      "login": "tcoulter",
      "id": 92629,
      "node_id": "MDQ6VXNlcjkyNjI5",
      "avatar_url": "https://avatars.githubusercontent.com/u/92629?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tcoulter",
      "html_url": "https://github.com/tcoulter",
      "followers_url": "https://api.github.com/users/tcoulter/followers",
      "following_url": "https://api.github.com/users/tcoulter/following{/other_user}",
      "gists_url": "https://api.github.com/users/tcoulter/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tcoulter/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tcoulter/subscriptions",
      "organizations_url": "https://api.github.com/users/tcoulter/orgs",
      "repos_url": "https://api.github.com/users/tcoulter/repos",
      "events_url": "https://api.github.com/users/tcoulter/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tcoulter/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-11-28T18:00:45Z",
    "updated_at": "2017-11-28T18:00:45Z",
    "author_association": "CONTRIBUTOR",
    "body": "Hi @nikita-fuchs. Unfortunately there's no way the code above could work. Calling out to web3 makes the migration function asynchronous, and in your code you have no way of telling the migration system that your migration is finished. Side note here: Migrations only *stage* deployments at run time; they don't actually run the transactions immediately.\n\nTo tell the migration system that you'd like to do something asynchronous, you need to add a promise to the deployment chain. You can do this by using `.then()`: \n\n```\ndeployer.then(function() {\n  return new Promise(function(accept, reject) {\n    web3.eth.getBlock(\"latest\", function(err, result) {\n      if (err) return reject(err);\n      accept(result);\n    });\n  })\n}).then(function(block) {\n  if (block) {\n    // do your thing\n    return deployer.deploy(...); // make sure to return here as that's a promise\n  }\n})\n```\n\n",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/347609862/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/347610064",
    "html_url": "https://github.com/trufflesuite/truffle/issues/688#issuecomment-347610064",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/688",
    "id": 347610064,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM0NzYxMDA2NA==",
    "user": {
      "login": "tcoulter",
      "id": 92629,
      "node_id": "MDQ6VXNlcjkyNjI5",
      "avatar_url": "https://avatars.githubusercontent.com/u/92629?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tcoulter",
      "html_url": "https://github.com/tcoulter",
      "followers_url": "https://api.github.com/users/tcoulter/followers",
      "following_url": "https://api.github.com/users/tcoulter/following{/other_user}",
      "gists_url": "https://api.github.com/users/tcoulter/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tcoulter/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tcoulter/subscriptions",
      "organizations_url": "https://api.github.com/users/tcoulter/orgs",
      "repos_url": "https://api.github.com/users/tcoulter/repos",
      "events_url": "https://api.github.com/users/tcoulter/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tcoulter/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-11-28T18:01:23Z",
    "updated_at": "2017-11-28T18:01:23Z",
    "author_association": "CONTRIBUTOR",
    "body": "I'm going to close this issue. Let us know if you run into anything else!",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/347610064/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
