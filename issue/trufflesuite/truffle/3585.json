{
  "url": "https://api.github.com/repos/trufflesuite/truffle/issues/3585",
  "repository_url": "https://api.github.com/repos/trufflesuite/truffle",
  "labels_url": "https://api.github.com/repos/trufflesuite/truffle/issues/3585/labels{/name}",
  "comments_url": "https://api.github.com/repos/trufflesuite/truffle/issues/3585/comments",
  "events_url": "https://api.github.com/repos/trufflesuite/truffle/issues/3585/events",
  "html_url": "https://github.com/trufflesuite/truffle/issues/3585",
  "id": 758490976,
  "node_id": "MDU6SXNzdWU3NTg0OTA5NzY=",
  "number": 3585,
  "title": "Add support for `signTypedData` in @truffle/hdwallet-provider",
  "user": {
    "login": "dmihal",
    "id": 1661138,
    "node_id": "MDQ6VXNlcjE2NjExMzg=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1661138?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/dmihal",
    "html_url": "https://github.com/dmihal",
    "followers_url": "https://api.github.com/users/dmihal/followers",
    "following_url": "https://api.github.com/users/dmihal/following{/other_user}",
    "gists_url": "https://api.github.com/users/dmihal/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/dmihal/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/dmihal/subscriptions",
    "organizations_url": "https://api.github.com/users/dmihal/orgs",
    "repos_url": "https://api.github.com/users/dmihal/repos",
    "events_url": "https://api.github.com/users/dmihal/events{/privacy}",
    "received_events_url": "https://api.github.com/users/dmihal/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 230393328,
      "node_id": "MDU6TGFiZWwyMzAzOTMzMjg=",
      "url": "https://api.github.com/repos/trufflesuite/truffle/labels/enhancement",
      "name": "enhancement",
      "color": "84b6eb",
      "default": true,
      "description": null
    },
    {
      "id": 230393329,
      "node_id": "MDU6TGFiZWwyMzAzOTMzMjk=",
      "url": "https://api.github.com/repos/trufflesuite/truffle/labels/help%20wanted",
      "name": "help wanted",
      "color": "159818",
      "default": true,
      "description": null
    },
    {
      "id": 1675041996,
      "node_id": "MDU6TGFiZWwxNjc1MDQxOTk2",
      "url": "https://api.github.com/repos/trufflesuite/truffle/labels/priority4%20%F0%9F%93%8B",
      "name": "priority4 ðŸ“‹",
      "color": "006b75",
      "default": false,
      "description": ""
    },
    {
      "id": 2570701911,
      "node_id": "MDU6TGFiZWwyNTcwNzAxOTEx",
      "url": "https://api.github.com/repos/trufflesuite/truffle/labels/hdwallet-provider",
      "name": "hdwallet-provider",
      "color": "5e50c4",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 7,
  "created_at": "2020-12-07T13:05:10Z",
  "updated_at": "2021-08-22T00:51:58Z",
  "closed_at": "2021-08-22T00:51:57Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "## Issue\r\n\r\nWhen sending an `eth_signTypedData` call, the provider throws the following error:\r\n\r\n```\r\n     TypeError: self.signTypedMessage is not a function\r\n      at waterfall (node_modules/@trufflesuite/web3-provider-engine/subproviders/hooked-wallet.js:390:18)\r\n```\r\n\r\n## Steps to Reproduce\r\n\r\nI've added a simple test to the `eth-permit` repo.\r\n\r\n```\r\ngit clone https://github.com/dmihal/eth-permit.git\r\ngit checkout hdprovider\r\nyarn install\r\nyarn test\r\n\r\n```\r\n\r\n## Fix\r\n\r\nI believe this issue is fixed by adding signTypedMessage to the HookedSubprovider.",
  "closed_by": {
    "login": "gnidan",
    "id": 151065,
    "node_id": "MDQ6VXNlcjE1MTA2NQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/151065?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/gnidan",
    "html_url": "https://github.com/gnidan",
    "followers_url": "https://api.github.com/users/gnidan/followers",
    "following_url": "https://api.github.com/users/gnidan/following{/other_user}",
    "gists_url": "https://api.github.com/users/gnidan/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/gnidan/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/gnidan/subscriptions",
    "organizations_url": "https://api.github.com/users/gnidan/orgs",
    "repos_url": "https://api.github.com/users/gnidan/repos",
    "events_url": "https://api.github.com/users/gnidan/events{/privacy}",
    "received_events_url": "https://api.github.com/users/gnidan/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/3585/reactions",
    "total_count": 2,
    "+1": 2,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/trufflesuite/truffle/issues/3585/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/741983379",
    "html_url": "https://github.com/trufflesuite/truffle/issues/3585#issuecomment-741983379",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/3585",
    "id": 741983379,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc0MTk4MzM3OQ==",
    "user": {
      "login": "gnidan",
      "id": 151065,
      "node_id": "MDQ6VXNlcjE1MTA2NQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/151065?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gnidan",
      "html_url": "https://github.com/gnidan",
      "followers_url": "https://api.github.com/users/gnidan/followers",
      "following_url": "https://api.github.com/users/gnidan/following{/other_user}",
      "gists_url": "https://api.github.com/users/gnidan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gnidan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gnidan/subscriptions",
      "organizations_url": "https://api.github.com/users/gnidan/orgs",
      "repos_url": "https://api.github.com/users/gnidan/repos",
      "events_url": "https://api.github.com/users/gnidan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gnidan/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-12-09T19:04:05Z",
    "updated_at": "2020-12-09T19:04:05Z",
    "author_association": "MEMBER",
    "body": "Thanks for opening this @dmihal. To the best of our knowledge, this just needs to be added as an enhancement. Putting this on our backlog so that we can get to doing this (also labeling it help wanted in case anyone wants to open the PR themselves ;)",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/741983379/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/832953671",
    "html_url": "https://github.com/trufflesuite/truffle/issues/3585#issuecomment-832953671",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/3585",
    "id": 832953671,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgzMjk1MzY3MQ==",
    "user": {
      "login": "danfinlay",
      "id": 542863,
      "node_id": "MDQ6VXNlcjU0Mjg2Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/542863?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/danfinlay",
      "html_url": "https://github.com/danfinlay",
      "followers_url": "https://api.github.com/users/danfinlay/followers",
      "following_url": "https://api.github.com/users/danfinlay/following{/other_user}",
      "gists_url": "https://api.github.com/users/danfinlay/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/danfinlay/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/danfinlay/subscriptions",
      "organizations_url": "https://api.github.com/users/danfinlay/orgs",
      "repos_url": "https://api.github.com/users/danfinlay/repos",
      "events_url": "https://api.github.com/users/danfinlay/events{/privacy}",
      "received_events_url": "https://api.github.com/users/danfinlay/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-05-05T19:33:15Z",
    "updated_at": "2021-05-05T19:33:15Z",
    "author_association": "NONE",
    "body": "These methods as provided by MetaMask are available on [eth-sig-util](https://github.com/MetaMask/eth-sig-util), so that would be a useful library for implementing this support.",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/832953671/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/850635012",
    "html_url": "https://github.com/trufflesuite/truffle/issues/3585#issuecomment-850635012",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/3585",
    "id": 850635012,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg1MDYzNTAxMg==",
    "user": {
      "login": "gabmontes",
      "id": 2621975,
      "node_id": "MDQ6VXNlcjI2MjE5NzU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2621975?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gabmontes",
      "html_url": "https://github.com/gabmontes",
      "followers_url": "https://api.github.com/users/gabmontes/followers",
      "following_url": "https://api.github.com/users/gabmontes/following{/other_user}",
      "gists_url": "https://api.github.com/users/gabmontes/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gabmontes/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gabmontes/subscriptions",
      "organizations_url": "https://api.github.com/users/gabmontes/orgs",
      "repos_url": "https://api.github.com/users/gabmontes/repos",
      "events_url": "https://api.github.com/users/gabmontes/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gabmontes/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-05-28T19:44:25Z",
    "updated_at": "2021-05-28T19:44:25Z",
    "author_association": "NONE",
    "body": "It looks like `signTypedMessage` must be provided to the constructor of `@trufflesuite/web3-provider-engine`'s `HookedWalletSubprovider`:\r\n\r\nhttps://github.com/trufflesuite/provider-engine/blob/master/subproviders/hooked-wallet.js#L82\r\n\r\nThe subprovider is instantiated by `@truffle/hdwallet-provider` here:\r\n\r\nhttps://github.com/trufflesuite/truffle/blob/%40truffle/hdwallet-provider%401.2.3/packages/hdwallet-provider/src/index.ts#L133\r\n\r\nBut it looks there is no [clean] way to add an additional `signTypedMessage` there...",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/850635012/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/859963370",
    "html_url": "https://github.com/trufflesuite/truffle/issues/3585#issuecomment-859963370",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/3585",
    "id": 859963370,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg1OTk2MzM3MA==",
    "user": {
      "login": "selimerunkut",
      "id": 31136147,
      "node_id": "MDQ6VXNlcjMxMTM2MTQ3",
      "avatar_url": "https://avatars.githubusercontent.com/u/31136147?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/selimerunkut",
      "html_url": "https://github.com/selimerunkut",
      "followers_url": "https://api.github.com/users/selimerunkut/followers",
      "following_url": "https://api.github.com/users/selimerunkut/following{/other_user}",
      "gists_url": "https://api.github.com/users/selimerunkut/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/selimerunkut/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/selimerunkut/subscriptions",
      "organizations_url": "https://api.github.com/users/selimerunkut/orgs",
      "repos_url": "https://api.github.com/users/selimerunkut/repos",
      "events_url": "https://api.github.com/users/selimerunkut/events{/privacy}",
      "received_events_url": "https://api.github.com/users/selimerunkut/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-06-12T00:02:54Z",
    "updated_at": "2021-06-12T13:19:50Z",
    "author_association": "NONE",
    "body": "is there a quick fix for this, stuck and can't deploy the contracts\r\n\r\ntried to add function to node_modules/@truffle/hdwallet-provider/dist/index.js\r\nafter the signPersonalMessage function\r\n\r\n```\r\nsignTypedMessage(...args){\r\n                const sigUtil = require('eth-sig-util');\r\n                return sigUtil.signTypedMessage(...args)\r\n            }\r\n```\r\n\r\nGetting the error:\r\n\r\n\r\n```\r\nTypeError: Cannot read property 'types' of undefined\r\n      at Object.sanitizeData (node_modules/eth-sig-util/index.js:216:21)\r\n      at Object.sign (node_modules/eth-sig-util/index.js:233:34)\r\n      at signTypedData_v4 (node_modules/eth-sig-util/index.js:449:34)\r\n      at Object.signTypedMessage (node_modules/eth-sig-util/index.js:425:20)\r\n      at HookedWalletSubprovider.signTypedMessage (node_modules/@truffle/hdwallet-provider/src/index.ts:191:21)\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/859963370/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/860054158",
    "html_url": "https://github.com/trufflesuite/truffle/issues/3585#issuecomment-860054158",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/3585",
    "id": 860054158,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg2MDA1NDE1OA==",
    "user": {
      "login": "selimerunkut",
      "id": 31136147,
      "node_id": "MDQ6VXNlcjMxMTM2MTQ3",
      "avatar_url": "https://avatars.githubusercontent.com/u/31136147?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/selimerunkut",
      "html_url": "https://github.com/selimerunkut",
      "followers_url": "https://api.github.com/users/selimerunkut/followers",
      "following_url": "https://api.github.com/users/selimerunkut/following{/other_user}",
      "gists_url": "https://api.github.com/users/selimerunkut/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/selimerunkut/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/selimerunkut/subscriptions",
      "organizations_url": "https://api.github.com/users/selimerunkut/orgs",
      "repos_url": "https://api.github.com/users/selimerunkut/repos",
      "events_url": "https://api.github.com/users/selimerunkut/events{/privacy}",
      "received_events_url": "https://api.github.com/users/selimerunkut/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-06-12T13:33:33Z",
    "updated_at": "2021-06-16T17:15:47Z",
    "author_association": "NONE",
    "body": "With local truffle tests, this function is used and the tests are passing (local ganache node does not use hdwallet):\r\n\r\n```\r\nsignTypedData: function (web3, from, data) {\r\n    return new Promise(async (resolve, reject) => {\r\n      function cb(err, result) {\r\n        if (err) {\r\n          return reject(err);\r\n        }\r\n        if (result.error) {\r\n          return reject(result.error);\r\n        }\r\n\r\n        const sig = result.result;\r\n        const sig0 = sig.substring(2);\r\n        const r = \"0x\" + sig0.substring(0, 64);\r\n        const s = \"0x\" + sig0.substring(64, 128);\r\n        const v = parseInt(sig0.substring(128, 130), 16);\r\n\r\n        resolve({\r\n          data,\r\n          sig,\r\n          v, r, s\r\n        });\r\n      }\r\n      if (web3.currentProvider.isMetaMask) {\r\n        web3.currentProvider.sendAsync({\r\n          jsonrpc: \"2.0\",\r\n          method: \"eth_signTypedData_v3\",\r\n          params: [from, JSON.stringify(data)],\r\n          id: new Date().getTime()\r\n        }, cb);\r\n      } else {\r\n        let send = web3.currentProvider.sendAsync;\r\n        if (!send) send = web3.currentProvider.send;\r\n        send.bind(web3.currentProvider)({\r\n          jsonrpc: \"2.0\",\r\n          method: \"eth_signTypedData\",\r\n          params: [from, data],\r\n          id: new Date().getTime()\r\n        }, cb);\r\n      }\r\n    }); \r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/860054158/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/893440982",
    "html_url": "https://github.com/trufflesuite/truffle/issues/3585#issuecomment-893440982",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/3585",
    "id": 893440982,
    "node_id": "IC_kwDOAkfq-c41QNPW",
    "user": {
      "login": "eggplantzzz",
      "id": 14827965,
      "node_id": "MDQ6VXNlcjE0ODI3OTY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/14827965?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/eggplantzzz",
      "html_url": "https://github.com/eggplantzzz",
      "followers_url": "https://api.github.com/users/eggplantzzz/followers",
      "following_url": "https://api.github.com/users/eggplantzzz/following{/other_user}",
      "gists_url": "https://api.github.com/users/eggplantzzz/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/eggplantzzz/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/eggplantzzz/subscriptions",
      "organizations_url": "https://api.github.com/users/eggplantzzz/orgs",
      "repos_url": "https://api.github.com/users/eggplantzzz/repos",
      "events_url": "https://api.github.com/users/eggplantzzz/events{/privacy}",
      "received_events_url": "https://api.github.com/users/eggplantzzz/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-08-05T13:03:09Z",
    "updated_at": "2021-08-05T13:03:09Z",
    "author_association": "CONTRIBUTOR",
    "body": "Thanks @dmihal for the test project. There is currently a PR to implement support for this [here](https://github.com/trufflesuite/truffle/pull/4124) but I'm having trouble validating the fix with your project. This is because in the implementation of `signTypedMessage` in hdwallet-provider it expects the \"data\" param to be an object while you send the \"data\" param as stringified JSON. On searching around, I see examples of it being sent to the provider both ways, which one is correct? Can you provide me with any resources about this?",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/893440982/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/903195150",
    "html_url": "https://github.com/trufflesuite/truffle/issues/3585#issuecomment-903195150",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/3585",
    "id": 903195150,
    "node_id": "IC_kwDOAkfq-c411aoO",
    "user": {
      "login": "gnidan",
      "id": 151065,
      "node_id": "MDQ6VXNlcjE1MTA2NQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/151065?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gnidan",
      "html_url": "https://github.com/gnidan",
      "followers_url": "https://api.github.com/users/gnidan/followers",
      "following_url": "https://api.github.com/users/gnidan/following{/other_user}",
      "gists_url": "https://api.github.com/users/gnidan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gnidan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gnidan/subscriptions",
      "organizations_url": "https://api.github.com/users/gnidan/orgs",
      "repos_url": "https://api.github.com/users/gnidan/repos",
      "events_url": "https://api.github.com/users/gnidan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gnidan/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-08-22T00:51:57Z",
    "updated_at": "2021-08-22T00:51:57Z",
    "author_association": "MEMBER",
    "body": "This functionality is released in [Truffle v5.4.7](https://github.com/trufflesuite/truffle/releases/tag/v5.4.7). Thanks all!",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/903195150/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 1,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
