{
  "url": "https://api.github.com/repos/trufflesuite/truffle/issues/1147",
  "repository_url": "https://api.github.com/repos/trufflesuite/truffle",
  "labels_url": "https://api.github.com/repos/trufflesuite/truffle/issues/1147/labels{/name}",
  "comments_url": "https://api.github.com/repos/trufflesuite/truffle/issues/1147/comments",
  "events_url": "https://api.github.com/repos/trufflesuite/truffle/issues/1147/events",
  "html_url": "https://github.com/trufflesuite/truffle/issues/1147",
  "id": 344230150,
  "node_id": "MDU6SXNzdWUzNDQyMzAxNTA=",
  "number": 1147,
  "title": "Truffle test fails when defining Array.prototype function",
  "user": {
    "login": "ldub",
    "id": 3114081,
    "node_id": "MDQ6VXNlcjMxMTQwODE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3114081?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ldub",
    "html_url": "https://github.com/ldub",
    "followers_url": "https://api.github.com/users/ldub/followers",
    "following_url": "https://api.github.com/users/ldub/following{/other_user}",
    "gists_url": "https://api.github.com/users/ldub/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ldub/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ldub/subscriptions",
    "organizations_url": "https://api.github.com/users/ldub/orgs",
    "repos_url": "https://api.github.com/users/ldub/repos",
    "events_url": "https://api.github.com/users/ldub/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ldub/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 230393326,
      "node_id": "MDU6TGFiZWwyMzAzOTMzMjY=",
      "url": "https://api.github.com/repos/trufflesuite/truffle/labels/bug",
      "name": "bug",
      "color": "fc2929",
      "default": true,
      "description": null
    },
    {
      "id": 644098328,
      "node_id": "MDU6TGFiZWw2NDQwOTgzMjg=",
      "url": "https://api.github.com/repos/trufflesuite/truffle/labels/needs%20reproduced",
      "name": "needs reproduced",
      "color": "fbca04",
      "default": false,
      "description": null
    },
    {
      "id": 1041903922,
      "node_id": "MDU6TGFiZWwxMDQxOTAzOTIy",
      "url": "https://api.github.com/repos/trufflesuite/truffle/labels/truffle%20test",
      "name": "truffle test",
      "color": "bfdadc",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 6,
  "created_at": "2018-07-24T22:45:26Z",
  "updated_at": "2019-12-12T04:55:04Z",
  "closed_at": "2019-12-12T04:55:04Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "- [x] I've asked for help in the [Truffle Gitter](http://gitter.im/Consensys/truffle) before filing this issue.\r\n\r\n---------------------------\r\n\r\n## Issue\r\n\r\n`node_modules/.bin/truffle test` fails when defining an `Array.prototype.someFunction`\r\n\r\n## Steps to Reproduce\r\n\r\nFull repro repo here: https://github.com/ldub/truffle-bug-repro/\r\n\r\n1. Use node 10 and npm 6\r\n2. Add the following code to a javascript test file\r\n```\r\nArray.prototype.zip = function (otherArray) {\r\n    return this.map((e,i) => [this[i], i < otherArray.length ? otherArray[i] : null]);\r\n};\r\n```\r\n3. `node_modules/.bin/truffle test`\r\n\r\n## Expected Behavior\r\n\r\nTests should pass.\r\n\r\n## Actual Results\r\n\r\nTest fails with exception:\r\n```\r\n/Users/lev/dev/truffle-bug-repro/test/simplestorage.js:4\r\n    return this.map((e,i) => [this[i], i < otherArray.length ? otherArray[i] : null]);\r\n                ^\r\nTypeError: this.map is not a function\r\n    at Client.Array.zip (/Users/lev/dev/truffle-bug-repro/test/simplestorage.js:4:17)\r\n    at Client.emit (/Users/lev/dev/truffle-bug-repro/node_modules/truffle/build/webpack:/~/event-pubsub/es5.js:74:1)\r\n    at Socket.connectionClosed (/Users/lev/dev/truffle-bug-repro/node_modules/truffle/build/webpack:/~/node-ipc/dao/client.js:187:1)\r\n    at Socket.emit (events.js:182:13)\r\n    at Pipe._handle.close [as _onclose] (net.js:596:12)\r\n```\r\n\r\n## Notes\r\n* tests pass if I use `truffle test` instead of `node_modules/.bin/truffle test`\r\n* something in the toolchain (likely webpack) is running or transpiling code that my repro does not even use\r\n\r\n## Environment\r\n\r\n* Operating System: macOS\r\n* Ethereum client: N/A (truffle's built-in testrpc)\r\n* Truffle version (`truffle version`): \r\n```\r\nTruffle v4.1.13 (core: 4.1.13)\r\nSolidity v0.4.24 (solc-js)\r\n```\r\n* node version (`node --version`): v10.3.0\r\n* npm version (`npm --version`): 6.1.0\r\n",
  "closed_by": {
    "login": "ldub",
    "id": 3114081,
    "node_id": "MDQ6VXNlcjMxMTQwODE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3114081?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ldub",
    "html_url": "https://github.com/ldub",
    "followers_url": "https://api.github.com/users/ldub/followers",
    "following_url": "https://api.github.com/users/ldub/following{/other_user}",
    "gists_url": "https://api.github.com/users/ldub/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ldub/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ldub/subscriptions",
    "organizations_url": "https://api.github.com/users/ldub/orgs",
    "repos_url": "https://api.github.com/users/ldub/repos",
    "events_url": "https://api.github.com/users/ldub/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ldub/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/1147/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/trufflesuite/truffle/issues/1147/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/407810766",
    "html_url": "https://github.com/trufflesuite/truffle/issues/1147#issuecomment-407810766",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/1147",
    "id": 407810766,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQwNzgxMDc2Ng==",
    "user": {
      "login": "cgewecke",
      "id": 7332026,
      "node_id": "MDQ6VXNlcjczMzIwMjY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7332026?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cgewecke",
      "html_url": "https://github.com/cgewecke",
      "followers_url": "https://api.github.com/users/cgewecke/followers",
      "following_url": "https://api.github.com/users/cgewecke/following{/other_user}",
      "gists_url": "https://api.github.com/users/cgewecke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cgewecke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cgewecke/subscriptions",
      "organizations_url": "https://api.github.com/users/cgewecke/orgs",
      "repos_url": "https://api.github.com/users/cgewecke/repos",
      "events_url": "https://api.github.com/users/cgewecke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cgewecke/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-07-25T16:13:45Z",
    "updated_at": "2018-07-25T16:13:45Z",
    "author_association": "CONTRIBUTOR",
    "body": "Hi @ldub ðŸ‘‹ \r\n\r\nWow weird! Will investigate although this is quite strange. Out of curiosity if you use lodash or another utility that has an array `zip` method does everything work? This is something about overloading the `Array` prototype?\r\n\r\nAlso do you have an insight about how webpack might be the culprit here? The tests are passed to Mocha - that seems like another candidate. ",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/407810766/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/407858442",
    "html_url": "https://github.com/trufflesuite/truffle/issues/1147#issuecomment-407858442",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/1147",
    "id": 407858442,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQwNzg1ODQ0Mg==",
    "user": {
      "login": "ldub",
      "id": 3114081,
      "node_id": "MDQ6VXNlcjMxMTQwODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3114081?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ldub",
      "html_url": "https://github.com/ldub",
      "followers_url": "https://api.github.com/users/ldub/followers",
      "following_url": "https://api.github.com/users/ldub/following{/other_user}",
      "gists_url": "https://api.github.com/users/ldub/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ldub/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ldub/subscriptions",
      "organizations_url": "https://api.github.com/users/ldub/orgs",
      "repos_url": "https://api.github.com/users/ldub/repos",
      "events_url": "https://api.github.com/users/ldub/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ldub/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-07-25T18:52:37Z",
    "updated_at": "2018-07-25T18:52:37Z",
    "author_association": "NONE",
    "body": "Definitely not using lodash and the bug can be reproduced with any identifier, not just zip:\r\n\r\n```\r\nArray.prototype.ldubFunc = function(abc) {\r\n    this.map();\r\n}\r\n```\r\n\r\nAs for why I suspect webpack\r\n* `ldubFunc` does not overload anything\r\n* `ldubFunc` is never called\r\n* webpack supports transpiling and stack trace contains webpack in  `truffle/build/webpack:/~/event-pubsub/es5.js:74:1`\r\n* actual error is at `at Client.Array.ldubFunc (/Users/lev/dev/truffle-bug-repro/test/simplestorage.js:4:10)`\r\n  * it seems like my prototype function is being put onto something called `Client.Array` instead of `Array`, which to me smells of a possible transpilation issue\r\n  * still not sure how `ldubFunc` can even be called anywhere\r\n\r\nBut the reality is that I have a fairly poor understanding of modern web technologies like webpack and babel and the above list is mostly guesswork. I don't really know where to start digging to figure out the true cause of the bug, if you have any pointers I'd be happy to do some exploration.\r\n\r\nI suspect that the fact that `truffle test` works but not when you run `node_modules/.bin/truffle test` is an important point... what is the difference between the truffle I can install with `npm install -g` and the truffle thats installed in the node_modules folder?",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/407858442/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/424822751",
    "html_url": "https://github.com/trufflesuite/truffle/issues/1147#issuecomment-424822751",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/1147",
    "id": 424822751,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQyNDgyMjc1MQ==",
    "user": {
      "login": "gnidan",
      "id": 151065,
      "node_id": "MDQ6VXNlcjE1MTA2NQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/151065?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gnidan",
      "html_url": "https://github.com/gnidan",
      "followers_url": "https://api.github.com/users/gnidan/followers",
      "following_url": "https://api.github.com/users/gnidan/following{/other_user}",
      "gists_url": "https://api.github.com/users/gnidan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gnidan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gnidan/subscriptions",
      "organizations_url": "https://api.github.com/users/gnidan/orgs",
      "repos_url": "https://api.github.com/users/gnidan/repos",
      "events_url": "https://api.github.com/users/gnidan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gnidan/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-09-26T18:30:52Z",
    "updated_at": "2018-09-26T18:30:52Z",
    "author_association": "MEMBER",
    "body": "@ldub Could you please paste the output of `./node_modules/.bin/truffle version`? Just in case it's different?\r\n\r\nThanks!",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/424822751/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/424859782",
    "html_url": "https://github.com/trufflesuite/truffle/issues/1147#issuecomment-424859782",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/1147",
    "id": 424859782,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQyNDg1OTc4Mg==",
    "user": {
      "login": "ldub",
      "id": 3114081,
      "node_id": "MDQ6VXNlcjMxMTQwODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3114081?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ldub",
      "html_url": "https://github.com/ldub",
      "followers_url": "https://api.github.com/users/ldub/followers",
      "following_url": "https://api.github.com/users/ldub/following{/other_user}",
      "gists_url": "https://api.github.com/users/ldub/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ldub/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ldub/subscriptions",
      "organizations_url": "https://api.github.com/users/ldub/orgs",
      "repos_url": "https://api.github.com/users/ldub/repos",
      "events_url": "https://api.github.com/users/ldub/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ldub/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-09-26T20:32:50Z",
    "updated_at": "2018-09-26T20:32:50Z",
    "author_association": "NONE",
    "body": "@gnidan\r\n\r\n```\r\n[nix-shell:~/dev/eth/eth/truffle-bug-repro]$ ./node_modules/.bin/truffle version\r\nTruffle v4.1.13 (core: 4.1.13)\r\nSolidity v0.4.24 (solc-js)\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/424859782/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/561793873",
    "html_url": "https://github.com/trufflesuite/truffle/issues/1147#issuecomment-561793873",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/1147",
    "id": 561793873,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU2MTc5Mzg3Mw==",
    "user": {
      "login": "gnidan",
      "id": 151065,
      "node_id": "MDQ6VXNlcjE1MTA2NQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/151065?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gnidan",
      "html_url": "https://github.com/gnidan",
      "followers_url": "https://api.github.com/users/gnidan/followers",
      "following_url": "https://api.github.com/users/gnidan/following{/other_user}",
      "gists_url": "https://api.github.com/users/gnidan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gnidan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gnidan/subscriptions",
      "organizations_url": "https://api.github.com/users/gnidan/orgs",
      "repos_url": "https://api.github.com/users/gnidan/repos",
      "events_url": "https://api.github.com/users/gnidan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gnidan/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-12-04T19:08:18Z",
    "updated_at": "2019-12-04T19:08:18Z",
    "author_association": "MEMBER",
    "body": "Is this still a problem? Doing issue maintenance and wondering what the status here is. Thanks!",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/561793873/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/564849419",
    "html_url": "https://github.com/trufflesuite/truffle/issues/1147#issuecomment-564849419",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/1147",
    "id": 564849419,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU2NDg0OTQxOQ==",
    "user": {
      "login": "ldub",
      "id": 3114081,
      "node_id": "MDQ6VXNlcjMxMTQwODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3114081?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ldub",
      "html_url": "https://github.com/ldub",
      "followers_url": "https://api.github.com/users/ldub/followers",
      "following_url": "https://api.github.com/users/ldub/following{/other_user}",
      "gists_url": "https://api.github.com/users/ldub/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ldub/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ldub/subscriptions",
      "organizations_url": "https://api.github.com/users/ldub/orgs",
      "repos_url": "https://api.github.com/users/ldub/repos",
      "events_url": "https://api.github.com/users/ldub/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ldub/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-12-12T04:55:04Z",
    "updated_at": "2019-12-12T04:55:04Z",
    "author_association": "NONE",
    "body": "Just tried this with the following versions and the exception no longer happens.\r\n\r\n```\r\nTruffle v5.1.3 (core: 5.1.3)\r\nSolidity - 0.4.24 (solc-js)\r\nNode v10.17.0\r\nWeb3.js v1.2.2\r\n```\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/564849419/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
