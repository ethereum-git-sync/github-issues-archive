{
  "url": "https://api.github.com/repos/trufflesuite/truffle/issues/3023",
  "repository_url": "https://api.github.com/repos/trufflesuite/truffle",
  "labels_url": "https://api.github.com/repos/trufflesuite/truffle/issues/3023/labels{/name}",
  "comments_url": "https://api.github.com/repos/trufflesuite/truffle/issues/3023/comments",
  "events_url": "https://api.github.com/repos/trufflesuite/truffle/issues/3023/events",
  "html_url": "https://github.com/trufflesuite/truffle/issues/3023",
  "id": 611525002,
  "node_id": "MDU6SXNzdWU2MTE1MjUwMDI=",
  "number": 3023,
  "title": "Test fails to use new contract addresses if evm_revert isn't supported.",
  "user": {
    "login": "no2chem",
    "id": 6496984,
    "node_id": "MDQ6VXNlcjY0OTY5ODQ=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6496984?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/no2chem",
    "html_url": "https://github.com/no2chem",
    "followers_url": "https://api.github.com/users/no2chem/followers",
    "following_url": "https://api.github.com/users/no2chem/following{/other_user}",
    "gists_url": "https://api.github.com/users/no2chem/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/no2chem/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/no2chem/subscriptions",
    "organizations_url": "https://api.github.com/users/no2chem/orgs",
    "repos_url": "https://api.github.com/users/no2chem/repos",
    "events_url": "https://api.github.com/users/no2chem/events{/privacy}",
    "received_events_url": "https://api.github.com/users/no2chem/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1675041996,
      "node_id": "MDU6TGFiZWwxNjc1MDQxOTk2",
      "url": "https://api.github.com/repos/trufflesuite/truffle/labels/priority4%20%F0%9F%93%8B",
      "name": "priority4 ðŸ“‹",
      "color": "006b75",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 6,
  "created_at": "2020-05-03T22:41:23Z",
  "updated_at": "2020-05-14T22:49:10Z",
  "closed_at": "2020-05-14T22:49:10Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "## Issue\r\n\r\nWhen running `truffle test` against a client that doesn't support `evm_revert`, Truffle will try to reset by redeploying the contracts between test suites.\r\n\r\nhttps://github.com/trufflesuite/truffle/blob/0effb767df26dca7aab0b1247de30fdf5b127be9/packages/core/lib/testing/testrunner.js#L81 \r\n\r\nHowever, contracts referred to by the new test suite (via `artifact.require`) point to the previously deployed contracts instead of the new ones. This causes issues for tests which expect the state of the contracts to be reset in the new test suite.\r\n\r\nAs far as I can tell by debugging through this, even though the contracts are redeployed in testrunner::deploy:\r\n\r\nhttps://github.com/trufflesuite/truffle/blob/0effb767df26dca7aab0b1247de30fdf5b127be9/packages/core/lib/testing/testrunner.js#L72\r\n\r\nThe artifacts are loaded when mocha *first* loads the test files, right after the inital deploy. testrunner::deploy doesn't reload the artifacts, leading to the problem. The new redeployed contract addresses need to be reinjected to the already loaded contracts somehow.\r\n\r\n## Steps to Reproduce\r\n\r\nOn a client the doesn't support `evm_revert` run a minimal test suite:\r\n\r\ncontracts/Increment.sol\r\n```sol\r\npragma solidity >=0.5.0;\r\n\r\ncontract Increment {\r\n    uint256 count;\r\n    \r\n    function increment() public {\r\n        count++;\r\n    }\r\n    \r\n    function getCount() view public returns (uint256) {\r\n        return count;\r\n    }\r\n```\r\n\r\ntests/test1.js\r\n```js\r\nconst Increment = artifacts.require(\"Increment\");\r\n\r\ncontract(\"First test\", async accounts => {\r\n     it(\"should increment to one\", async() => {\r\n            let deployed = await Increment.deployed();\r\n            await deployed.increment.sendTransaction();\r\n            console.log(`Address: ${deployed.address}`);\r\n            expect(await deployed.getCount()).to.equal(1);\r\n     });\r\n});\r\n```\r\ntests/test2.js\r\n```js\r\nconst Increment = artifacts.require(\"Increment\");\r\n\r\ncontract(\"Second test\", async accounts => {\r\n     it(\"should increment to one\", async() => {\r\n            let deployed = await Increment.deployed();\r\n            await deployed.increment.sendTransaction();\r\n            // ISSUE 1: Address is the same as previous suite!\r\n            console.log(`Address: ${deployed.address}`);\r\n            // ISSUE 2: TEST FAILURE - returns 2 instead of 1 due to previous state\r\n            expect(await deployed.getCount()).to.equal(1);\r\n     });\r\n});\r\n```\r\n\r\n## Expected Behavior\r\n\r\nThe second test suite results in the issues described above.\r\n\r\n## Actual Results\r\n\r\nThe second test suite runs with the previously deployed contracts as the first test suite, causing the issues described above.\r\n\r\n## Environment\r\n\r\n* Operating System: macOS catalina\r\n* Ethereum client: test client which doesn't support eth_revert ethrpc call.\r\n* Truffle version (`truffle version`): 5.1.24\r\n* node version (`node --version`): 13.3.0\r\n* npm version (`npm --version`): 6.13.4\r\n",
  "closed_by": {
    "login": "haltman-at",
    "id": 35589221,
    "node_id": "MDQ6VXNlcjM1NTg5MjIx",
    "avatar_url": "https://avatars.githubusercontent.com/u/35589221?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/haltman-at",
    "html_url": "https://github.com/haltman-at",
    "followers_url": "https://api.github.com/users/haltman-at/followers",
    "following_url": "https://api.github.com/users/haltman-at/following{/other_user}",
    "gists_url": "https://api.github.com/users/haltman-at/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/haltman-at/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/haltman-at/subscriptions",
    "organizations_url": "https://api.github.com/users/haltman-at/orgs",
    "repos_url": "https://api.github.com/users/haltman-at/repos",
    "events_url": "https://api.github.com/users/haltman-at/events{/privacy}",
    "received_events_url": "https://api.github.com/users/haltman-at/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/3023/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/trufflesuite/truffle/issues/3023/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/623664587",
    "html_url": "https://github.com/trufflesuite/truffle/issues/3023#issuecomment-623664587",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/3023",
    "id": 623664587,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyMzY2NDU4Nw==",
    "user": {
      "login": "haltman-at",
      "id": 35589221,
      "node_id": "MDQ6VXNlcjM1NTg5MjIx",
      "avatar_url": "https://avatars.githubusercontent.com/u/35589221?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/haltman-at",
      "html_url": "https://github.com/haltman-at",
      "followers_url": "https://api.github.com/users/haltman-at/followers",
      "following_url": "https://api.github.com/users/haltman-at/following{/other_user}",
      "gists_url": "https://api.github.com/users/haltman-at/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/haltman-at/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/haltman-at/subscriptions",
      "organizations_url": "https://api.github.com/users/haltman-at/orgs",
      "repos_url": "https://api.github.com/users/haltman-at/repos",
      "events_url": "https://api.github.com/users/haltman-at/events{/privacy}",
      "received_events_url": "https://api.github.com/users/haltman-at/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-04T19:39:52Z",
    "updated_at": "2020-05-04T19:39:52Z",
    "author_association": "CONTRIBUTOR",
    "body": "This is a duplicate of #2735, but maybe we should leave it up for the extra detail. :)",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/623664587/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/623675778",
    "html_url": "https://github.com/trufflesuite/truffle/issues/3023#issuecomment-623675778",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/3023",
    "id": 623675778,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyMzY3NTc3OA==",
    "user": {
      "login": "no2chem",
      "id": 6496984,
      "node_id": "MDQ6VXNlcjY0OTY5ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6496984?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/no2chem",
      "html_url": "https://github.com/no2chem",
      "followers_url": "https://api.github.com/users/no2chem/followers",
      "following_url": "https://api.github.com/users/no2chem/following{/other_user}",
      "gists_url": "https://api.github.com/users/no2chem/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/no2chem/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/no2chem/subscriptions",
      "organizations_url": "https://api.github.com/users/no2chem/orgs",
      "repos_url": "https://api.github.com/users/no2chem/repos",
      "events_url": "https://api.github.com/users/no2chem/events{/privacy}",
      "received_events_url": "https://api.github.com/users/no2chem/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-04T20:02:06Z",
    "updated_at": "2020-05-04T20:02:06Z",
    "author_association": "NONE",
    "body": "Thanks for pointing to the duplicate issue, @haltman-at !\r\n\r\nI'm happy to take a stab at this. It looks like the easiest way to resolve this is just to create a new Mocha instance for each test file. This might slightly affect test behavior though...",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/623675778/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/626005454",
    "html_url": "https://github.com/trufflesuite/truffle/issues/3023#issuecomment-626005454",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/3023",
    "id": 626005454,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyNjAwNTQ1NA==",
    "user": {
      "login": "haltman-at",
      "id": 35589221,
      "node_id": "MDQ6VXNlcjM1NTg5MjIx",
      "avatar_url": "https://avatars.githubusercontent.com/u/35589221?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/haltman-at",
      "html_url": "https://github.com/haltman-at",
      "followers_url": "https://api.github.com/users/haltman-at/followers",
      "following_url": "https://api.github.com/users/haltman-at/following{/other_user}",
      "gists_url": "https://api.github.com/users/haltman-at/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/haltman-at/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/haltman-at/subscriptions",
      "organizations_url": "https://api.github.com/users/haltman-at/orgs",
      "repos_url": "https://api.github.com/users/haltman-at/repos",
      "events_url": "https://api.github.com/users/haltman-at/events{/privacy}",
      "received_events_url": "https://api.github.com/users/haltman-at/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-08T20:26:40Z",
    "updated_at": "2020-05-08T20:26:40Z",
    "author_association": "CONTRIBUTOR",
    "body": "Hm, I would hope there would be a better way than that.  Note that things are supposed to reset between each `contract()`, rather than between each file.  But, yeah... any solution would be nice.  If you can come up with something maybe we can figure out a way to do it better!  None of us have yet had time to take a serious stab at this...\r\n\r\nThe most relevant files here, by the way, are [these](https://github.com/trufflesuite/truffle/blob/develop/packages/core/lib/test.js) [two](https://github.com/trufflesuite/truffle/blob/develop/packages/core/lib/testing/testrunner.js).\r\n\r\nI wonder if the real problem here is that `global.artifacts` isn't getting reset when we do a reset?  But the `testResolver` has its cache turned off, so that shouldn't matter, seems to me?  Yeah, I remain pretty confused as to why this is happening.  But I'm not too familiar with these systems, unfortunately.",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/626005454/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/626007443",
    "html_url": "https://github.com/trufflesuite/truffle/issues/3023#issuecomment-626007443",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/3023",
    "id": 626007443,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyNjAwNzQ0Mw==",
    "user": {
      "login": "no2chem",
      "id": 6496984,
      "node_id": "MDQ6VXNlcjY0OTY5ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6496984?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/no2chem",
      "html_url": "https://github.com/no2chem",
      "followers_url": "https://api.github.com/users/no2chem/followers",
      "following_url": "https://api.github.com/users/no2chem/following{/other_user}",
      "gists_url": "https://api.github.com/users/no2chem/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/no2chem/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/no2chem/subscriptions",
      "organizations_url": "https://api.github.com/users/no2chem/orgs",
      "repos_url": "https://api.github.com/users/no2chem/repos",
      "events_url": "https://api.github.com/users/no2chem/events{/privacy}",
      "received_events_url": "https://api.github.com/users/no2chem/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-08T20:31:35Z",
    "updated_at": "2020-05-08T20:31:50Z",
    "author_association": "NONE",
    "body": "I think the problem is that each .js file is loaded only once, when mocha is initialized. So the top-level `const Contract = artifacts.require('contract')` is called only right after the first deployment.\r\n\r\nResetting `global.artifacts` doesn't help, as the top level contract requires in each suite aren't called again. I'll take a look and open a PR when I get to it.",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/626007443/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/626056944",
    "html_url": "https://github.com/trufflesuite/truffle/issues/3023#issuecomment-626056944",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/3023",
    "id": 626056944,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyNjA1Njk0NA==",
    "user": {
      "login": "haltman-at",
      "id": 35589221,
      "node_id": "MDQ6VXNlcjM1NTg5MjIx",
      "avatar_url": "https://avatars.githubusercontent.com/u/35589221?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/haltman-at",
      "html_url": "https://github.com/haltman-at",
      "followers_url": "https://api.github.com/users/haltman-at/followers",
      "following_url": "https://api.github.com/users/haltman-at/following{/other_user}",
      "gists_url": "https://api.github.com/users/haltman-at/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/haltman-at/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/haltman-at/subscriptions",
      "organizations_url": "https://api.github.com/users/haltman-at/orgs",
      "repos_url": "https://api.github.com/users/haltman-at/repos",
      "events_url": "https://api.github.com/users/haltman-at/events{/privacy}",
      "received_events_url": "https://api.github.com/users/haltman-at/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-08T23:07:02Z",
    "updated_at": "2020-05-08T23:07:02Z",
    "author_association": "CONTRIBUTOR",
    "body": "Oh, duh, good point.  Yeah, the fact that such things typically go at top-level makes things trickier.  I guess I don't know what to do about that offhand.  Thanks for looking at this!",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/626056944/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/628881203",
    "html_url": "https://github.com/trufflesuite/truffle/issues/3023#issuecomment-628881203",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/3023",
    "id": 628881203,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyODg4MTIwMw==",
    "user": {
      "login": "haltman-at",
      "id": 35589221,
      "node_id": "MDQ6VXNlcjM1NTg5MjIx",
      "avatar_url": "https://avatars.githubusercontent.com/u/35589221?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/haltman-at",
      "html_url": "https://github.com/haltman-at",
      "followers_url": "https://api.github.com/users/haltman-at/followers",
      "following_url": "https://api.github.com/users/haltman-at/following{/other_user}",
      "gists_url": "https://api.github.com/users/haltman-at/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/haltman-at/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/haltman-at/subscriptions",
      "organizations_url": "https://api.github.com/users/haltman-at/orgs",
      "repos_url": "https://api.github.com/users/haltman-at/repos",
      "events_url": "https://api.github.com/users/haltman-at/events{/privacy}",
      "received_events_url": "https://api.github.com/users/haltman-at/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-14T20:53:55Z",
    "updated_at": "2020-05-14T20:53:55Z",
    "author_association": "CONTRIBUTOR",
    "body": "OK, I think @gnidan and I have come up with a way to handle this other than resetting Mocha.  It's fairly hacky, but it should work.  I'm going to give it a try and hopefully I should have a PR up in a bit.",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/628881203/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
