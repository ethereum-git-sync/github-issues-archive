{
  "url": "https://api.github.com/repos/trufflesuite/truffle/issues/957",
  "repository_url": "https://api.github.com/repos/trufflesuite/truffle",
  "labels_url": "https://api.github.com/repos/trufflesuite/truffle/issues/957/labels{/name}",
  "comments_url": "https://api.github.com/repos/trufflesuite/truffle/issues/957/comments",
  "events_url": "https://api.github.com/repos/trufflesuite/truffle/issues/957/events",
  "html_url": "https://github.com/trufflesuite/truffle/issues/957",
  "id": 325221403,
  "node_id": "MDU6SXNzdWUzMjUyMjE0MDM=",
  "number": 957,
  "title": "JavaScript heap out of memory",
  "user": {
    "login": "a186r",
    "id": 10323190,
    "node_id": "MDQ6VXNlcjEwMzIzMTkw",
    "avatar_url": "https://avatars.githubusercontent.com/u/10323190?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/a186r",
    "html_url": "https://github.com/a186r",
    "followers_url": "https://api.github.com/users/a186r/followers",
    "following_url": "https://api.github.com/users/a186r/following{/other_user}",
    "gists_url": "https://api.github.com/users/a186r/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/a186r/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/a186r/subscriptions",
    "organizations_url": "https://api.github.com/users/a186r/orgs",
    "repos_url": "https://api.github.com/users/a186r/repos",
    "events_url": "https://api.github.com/users/a186r/events{/privacy}",
    "received_events_url": "https://api.github.com/users/a186r/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2018-05-22T09:55:41Z",
  "updated_at": "2018-08-28T09:38:12Z",
  "closed_at": "2018-05-23T17:16:23Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "- [x] I've asked for help in the [Truffle Gitter](http://gitter.im/Consensys/truffle) before filing this issue.\r\n\r\n---------------------------\r\n\r\n## Issue\r\n\r\nwhen i run `truffle complie` , i got an error `FATAL ERROR: MarkCompactCollector: semi-space copy, fallback in old gen Allocation failed - JavaScript heap out of memory`\r\ni know i should change v8 `--max-old-space-size` ,but i don't know i should change which file,please help me.\r\n\r\n## Steps to Reproduce\r\n\r\n`truffle complie`\r\n\r\n## Actual Results\r\n\r\nCompiling ./contracts/math.sol...\r\nCompiling ./contracts/token.sol...\r\n\r\n<--- Last few GCs --->\r\n\r\n[6509:0x39e1a30]   123533 ms: Mark-sweep 1395.5 (1440.7) -> 1395.5 (1448.7) MB, 1289.2 / 0.0 ms  allocation failure scavenge might not succeed\r\n[6509:0x39e1a30]   124861 ms: Mark-sweep 1403.6 (1448.7) -> 1403.6 (1456.7) MB, 1306.5 / 0.0 ms  allocation failure scavenge might not succeed\r\n[6509:0x39e1a30]   126493 ms: Mark-sweep 1411.2 (1456.7) -> 1411.3 (1461.2) MB, 1625.3 / 0.0 ms  allocation failure scavenge might not succeed\r\n\r\n\r\n<--- JS stacktrace --->\r\nCannot get stack trace in GC.\r\nFATAL ERROR: MarkCompactCollector: semi-space copy, fallback in old gen Allocation failed - JavaScript heap out of memory\r\n 1: node::Abort() [node]\r\n 2: 0x121a7ac [node]\r\n 3: v8::Utils::ReportOOMFailure(char const*, bool) [node]\r\n 4: v8::internal::V8::FatalProcessOutOfMemory(char const*, bool) [node]\r\n 5: v8::internal::EvacuateNewSpaceVisitor::Visit(v8::internal::HeapObject*, int) [node]\r\n 6: v8::internal::FullEvacuator::RawEvacuatePage(v8::internal::Page*, long*) [node]\r\n 7: v8::internal::Evacuator::EvacuatePage(v8::internal::Page*) [node]\r\n 8: v8::internal::PageEvacuationTask::RunInParallel() [node]\r\n 9: v8::internal::ItemParallelJob::Task::RunInternal() [node]\r\n10: v8::internal::ItemParallelJob::Run() [node]\r\n11: void v8::internal::MarkCompactCollectorBase::CreateAndExecuteEvacuationTasks<v8::internal::FullEvacuator, v8::internal::MarkCompactCollector>(v8::internal::MarkCompactCollector*, v8::internal::ItemParallelJob*, v8::internal::RecordMigratedSlotVisitor*, v8::internal::MigrationObserver*, long) [node]\r\n12: v8::internal::MarkCompactCollector::EvacuatePagesInParallel() [node]\r\n13: v8::internal::MarkCompactCollector::Evacuate() [node]\r\n14: v8::internal::MarkCompactCollector::CollectGarbage() [node]\r\n15: v8::internal::Heap::MarkCompact() [node]\r\n16: v8::internal::Heap::PerformGarbageCollection(v8::internal::GarbageCollector, v8::GCCallbackFlags) [node]\r\n17: v8::internal::Heap::CollectGarbage(v8::internal::AllocationSpace, v8::internal::GarbageCollectionReas`\r\n`\r\n\r\n## Environment\r\n\r\n* Operating System: ubuntu 16.04\r\n* Truffle version (`truffle version`):v4.1.8\r\n* node version (`node --version`):v8.10.0\r\n* npm version (`npm --version`): 3.5.2\r\n",
  "closed_by": {
    "login": "cgewecke",
    "id": 7332026,
    "node_id": "MDQ6VXNlcjczMzIwMjY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/7332026?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/cgewecke",
    "html_url": "https://github.com/cgewecke",
    "followers_url": "https://api.github.com/users/cgewecke/followers",
    "following_url": "https://api.github.com/users/cgewecke/following{/other_user}",
    "gists_url": "https://api.github.com/users/cgewecke/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/cgewecke/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/cgewecke/subscriptions",
    "organizations_url": "https://api.github.com/users/cgewecke/orgs",
    "repos_url": "https://api.github.com/users/cgewecke/repos",
    "events_url": "https://api.github.com/users/cgewecke/events{/privacy}",
    "received_events_url": "https://api.github.com/users/cgewecke/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/957/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/trufflesuite/truffle/issues/957/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/391211564",
    "html_url": "https://github.com/trufflesuite/truffle/issues/957#issuecomment-391211564",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/957",
    "id": 391211564,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM5MTIxMTU2NA==",
    "user": {
      "login": "cgewecke",
      "id": 7332026,
      "node_id": "MDQ6VXNlcjczMzIwMjY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7332026?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cgewecke",
      "html_url": "https://github.com/cgewecke",
      "followers_url": "https://api.github.com/users/cgewecke/followers",
      "following_url": "https://api.github.com/users/cgewecke/following{/other_user}",
      "gists_url": "https://api.github.com/users/cgewecke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cgewecke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cgewecke/subscriptions",
      "organizations_url": "https://api.github.com/users/cgewecke/orgs",
      "repos_url": "https://api.github.com/users/cgewecke/repos",
      "events_url": "https://api.github.com/users/cgewecke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cgewecke/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-05-23T03:49:21Z",
    "updated_at": "2018-05-23T03:49:21Z",
    "author_association": "CONTRIBUTOR",
    "body": "Hi @a186r. Does something like this work?\r\n```shell\r\n# Example for `truffle test` where truffle is installed globally\r\n$ which truffle\r\n> /usr/local/bin/truffle\r\n$ node --max-old-space-size=4096 /usr/local/bin/truffle test\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/391211564/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/391230473",
    "html_url": "https://github.com/trufflesuite/truffle/issues/957#issuecomment-391230473",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/957",
    "id": 391230473,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM5MTIzMDQ3Mw==",
    "user": {
      "login": "a186r",
      "id": 10323190,
      "node_id": "MDQ6VXNlcjEwMzIzMTkw",
      "avatar_url": "https://avatars.githubusercontent.com/u/10323190?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/a186r",
      "html_url": "https://github.com/a186r",
      "followers_url": "https://api.github.com/users/a186r/followers",
      "following_url": "https://api.github.com/users/a186r/following{/other_user}",
      "gists_url": "https://api.github.com/users/a186r/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/a186r/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/a186r/subscriptions",
      "organizations_url": "https://api.github.com/users/a186r/orgs",
      "repos_url": "https://api.github.com/users/a186r/repos",
      "events_url": "https://api.github.com/users/a186r/events{/privacy}",
      "received_events_url": "https://api.github.com/users/a186r/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-05-23T06:04:02Z",
    "updated_at": "2018-05-23T06:04:13Z",
    "author_association": "NONE",
    "body": "@cgewecke  thank you ,it's working for me ",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/391230473/reactions",
      "total_count": 2,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 2,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/391428625",
    "html_url": "https://github.com/trufflesuite/truffle/issues/957#issuecomment-391428625",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/957",
    "id": 391428625,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM5MTQyODYyNQ==",
    "user": {
      "login": "cgewecke",
      "id": 7332026,
      "node_id": "MDQ6VXNlcjczMzIwMjY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7332026?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cgewecke",
      "html_url": "https://github.com/cgewecke",
      "followers_url": "https://api.github.com/users/cgewecke/followers",
      "following_url": "https://api.github.com/users/cgewecke/following{/other_user}",
      "gists_url": "https://api.github.com/users/cgewecke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cgewecke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cgewecke/subscriptions",
      "organizations_url": "https://api.github.com/users/cgewecke/orgs",
      "repos_url": "https://api.github.com/users/cgewecke/repos",
      "events_url": "https://api.github.com/users/cgewecke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cgewecke/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-05-23T17:16:23Z",
    "updated_at": "2018-05-23T17:16:23Z",
    "author_association": "CONTRIBUTOR",
    "body": "Sweet!",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/391428625/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/416517996",
    "html_url": "https://github.com/trufflesuite/truffle/issues/957#issuecomment-416517996",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/957",
    "id": 416517996,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQxNjUxNzk5Ng==",
    "user": {
      "login": "hobofan",
      "id": 601283,
      "node_id": "MDQ6VXNlcjYwMTI4Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/601283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hobofan",
      "html_url": "https://github.com/hobofan",
      "followers_url": "https://api.github.com/users/hobofan/followers",
      "following_url": "https://api.github.com/users/hobofan/following{/other_user}",
      "gists_url": "https://api.github.com/users/hobofan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hobofan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hobofan/subscriptions",
      "organizations_url": "https://api.github.com/users/hobofan/orgs",
      "repos_url": "https://api.github.com/users/hobofan/repos",
      "events_url": "https://api.github.com/users/hobofan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hobofan/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-08-28T09:37:48Z",
    "updated_at": "2018-08-28T09:38:12Z",
    "author_association": "NONE",
    "body": "Something that might help people stumbling upon this issue:\r\n\r\nI ran into the same problem with a `truffle migrate` because I had ~80 files in `build/contracts` that were each ~25Mb big, so the process ran out of memory when deploying. Using the `--max-old-space-size=4096` workaround worked but deploying took a few minutes every time (which quickly got annoying).\r\n\r\nWhat I did was alter the `1_initial_migration.js` file so it deletes the `ast` and `legacyAST` keys from the contract files which accounted for 95% of the file size and are not necessary for deployment, and deployment times were blazingly fast again (my version requires [jq](https://github.com/stedolan/jq) to be installed):\r\n\r\n```js\r\nconst fs = require(\"fs\");\r\nconst child_process = require(\"child_process\");\r\n\r\nvar Migrations = artifacts.require(\"./Migrations.sol\");\r\n\r\nmodule.exports = function(deployer) {\r\n  deployer.deploy(Migrations);\r\n\r\n  const contractFiles = fs.readdirSync(\"./build/contracts\");\r\n  contractFiles.forEach(contractFile => {\r\n    const fullPath = `./build/contracts/${contractFile}`;\r\n    const stdout = child_process.execSync(\r\n      `jq '. | del(.ast, .legacyAST)' ${fullPath}`\r\n    );\r\n    fs.writeFileSync(fullPath, stdout);\r\n  });\r\n  console.log(\"--- Deleted ASTs\");\r\n};\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/416517996/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
