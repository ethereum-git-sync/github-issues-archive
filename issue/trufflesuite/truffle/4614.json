{
  "url": "https://api.github.com/repos/trufflesuite/truffle/issues/4614",
  "repository_url": "https://api.github.com/repos/trufflesuite/truffle",
  "labels_url": "https://api.github.com/repos/trufflesuite/truffle/issues/4614/labels{/name}",
  "comments_url": "https://api.github.com/repos/trufflesuite/truffle/issues/4614/comments",
  "events_url": "https://api.github.com/repos/trufflesuite/truffle/issues/4614/events",
  "html_url": "https://github.com/trufflesuite/truffle/issues/4614",
  "id": 1099648600,
  "node_id": "I_kwDOAkfq-c5Bi05Y",
  "number": 4614,
  "title": "Unhandled exception occurs when enabling Truffle DB with existing artifacts",
  "user": {
    "login": "gnidan",
    "id": 151065,
    "node_id": "MDQ6VXNlcjE1MTA2NQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/151065?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/gnidan",
    "html_url": "https://github.com/gnidan",
    "followers_url": "https://api.github.com/users/gnidan/followers",
    "following_url": "https://api.github.com/users/gnidan/following{/other_user}",
    "gists_url": "https://api.github.com/users/gnidan/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/gnidan/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/gnidan/subscriptions",
    "organizations_url": "https://api.github.com/users/gnidan/orgs",
    "repos_url": "https://api.github.com/users/gnidan/repos",
    "events_url": "https://api.github.com/users/gnidan/events{/privacy}",
    "received_events_url": "https://api.github.com/users/gnidan/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1403343142,
      "node_id": "MDU6TGFiZWwxNDAzMzQzMTQy",
      "url": "https://api.github.com/repos/trufflesuite/truffle/labels/needs%20investigated",
      "name": "needs investigated",
      "color": "b7410e",
      "default": false,
      "description": ""
    },
    {
      "id": 1442301962,
      "node_id": "MDU6TGFiZWwxNDQyMzAxOTYy",
      "url": "https://api.github.com/repos/trufflesuite/truffle/labels/db",
      "name": "db",
      "color": "0e7882",
      "default": false,
      "description": ""
    },
    {
      "id": 1675041796,
      "node_id": "MDU6TGFiZWwxNjc1MDQxNzk2",
      "url": "https://api.github.com/repos/trufflesuite/truffle/labels/priority3%20%F0%9F%94%A7",
      "name": "priority3 ðŸ”§",
      "color": "006b75",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2022-01-11T21:50:06Z",
  "updated_at": "2022-11-10T19:18:23Z",
  "closed_at": null,
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "## Issue\r\n\r\nIf you turn on Truffle DB in a project that has existing artifacts, an exception occurs when you run `truffle migrate`\r\n\r\n## Steps to Reproduce\r\n\r\n1. `truffle init`\r\n2. `truffle develop` and `migrate` inside that session\r\n3. Quit `truffle develop`\r\n4. Enable Truffle DB\r\n5. `truffle develop` then `migrate` again\r\n6. Observe exception\r\n\r\n## Expected Behavior\r\n\r\nData should save to Truffle DB and no error should appear\r\n\r\n## Actual Results\r\n\r\nAn error appears. I haven't checked if the data gets saved or not, but I'm guessing it's incomplete.\r\n\r\n## Environment\r\n\r\n* Operating System: \r\n* Ethereum client:\r\n* Truffle version (`truffle version`): v5.4.28\r\n* node version (`node --version`):\r\n* npm version (`npm --version`): \r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/4614/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/trufflesuite/truffle/issues/4614/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/1018956835",
    "html_url": "https://github.com/trufflesuite/truffle/issues/4614#issuecomment-1018956835",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/4614",
    "id": 1018956835,
    "node_id": "IC_kwDOAkfq-c48vAwj",
    "user": {
      "login": "tenthirtyone",
      "id": 6285466,
      "node_id": "MDQ6VXNlcjYyODU0NjY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6285466?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tenthirtyone",
      "html_url": "https://github.com/tenthirtyone",
      "followers_url": "https://api.github.com/users/tenthirtyone/followers",
      "following_url": "https://api.github.com/users/tenthirtyone/following{/other_user}",
      "gists_url": "https://api.github.com/users/tenthirtyone/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tenthirtyone/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tenthirtyone/subscriptions",
      "organizations_url": "https://api.github.com/users/tenthirtyone/orgs",
      "repos_url": "https://api.github.com/users/tenthirtyone/repos",
      "events_url": "https://api.github.com/users/tenthirtyone/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tenthirtyone/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-01-21T23:36:53Z",
    "updated_at": "2022-01-21T23:36:53Z",
    "author_association": "CONTRIBUTOR",
    "body": "This occurs because `project.loadMigrate` assumes `project.loadCompile` has already been run [at line 51](https://github.com/trufflesuite/truffle/blob/develop/packages/db/src/project/loadMigrate/index.ts#L51). \r\n\r\n`loadCompile` runs as part of the `workflow-compile` [workflow ](https://github.com/trufflesuite/truffle/blob/develop/packages/workflow-compile/index.js#L126).\r\n\r\nWhen `loadMigrate` is called [in `Migration.js`](https://github.com/trufflesuite/truffle/blob/develop/packages/migrate/Migration.js#L125) to attach the network information to the project in the db, the contract data from `loadMigrate`/`workflow-compile` is not present so it fails [at extracting & attaching that information to the data](https://github.com/trufflesuite/truffle/blob/develop/packages/db/src/project/loadMigrate/contracts.ts#L42).\r\n\r\nBut wait, there's more...\r\n\r\n`workflow-compile` still runs, however, the contracts array is empty, so [length is zero.](https://github.com/trufflesuite/truffle/blob/develop/packages/workflow-compile/index.js#L112). This is because in the `compile-solidity` package the [`necessary` function ](https://github.com/trufflesuite/truffle/blob/develop/packages/compile-solidity/src/index.js#L104) from Profile returns `[]` back from the [`updated`](https://github.com/trufflesuite/truffle/blob/develop/packages/profiler/src/index.ts#L25) function. I.e. no code change detected, the compiler does not run.\r\n\r\n\r\nTrace:\r\n1. [`Migrate` calls `WorkflowCompile.compileAndSave`](https://github.com/trufflesuite/truffle/blob/develop/packages/core/lib/commands/migrate/run.js#L20)\r\n2. [`compileAndSave` calls `compile`.](https://github.com/trufflesuite/truffle/blob/develop/packages/workflow-compile/index.js#L99)\r\n3.[ `compile` tries each compiler](https://github.com/trufflesuite/truffle/blob/develop/packages/workflow-compile/index.js#L35),\r\n4. `compileAll` = `false`. compileMethod is `require(\"@truffle/compile-solidity\").Compile`\r\n5. `compileMethod` calls [`necessary`](https://github.com/trufflesuite/truffle/blob/develop/packages/workflow-compile/index.js#L33)\r\n6. [`necessary` requests paths from the `Profiler.updated` method](https://github.com/trufflesuite/truffle/blob/develop/packages/compile-solidity/src/index.js#L104)\r\n7. [`Profiler.updated` determines that no files have been updated.](https://github.com/trufflesuite/truffle/blob/develop/packages/profiler/src/index.ts#L40)\r\n8. `compileMethod.necessary` calls [`Compile.sourcesWithDependencies`](https://github.com/trufflesuite/truffle/blob/develop/packages/compile-solidity/src/index.js#L106) with the `paths` parameter = `[]`\r\n9. `WorkflowCompile` calls[ `save` ](https://github.com/trufflesuite/truffle/blob/develop/packages/workflow-compile/index.js#L101)and passes empty values for `{ contracts, sources, compilations}`\r\n10. Although the db is configured, there is no contract data [(`contracts.length === 0`)](https://github.com/trufflesuite/truffle/blob/develop/packages/workflow-compile/index.js#L112) to save\r\n\r\nSuggestions:\r\n\r\nThis is a very deep trace and obviously touches on code that is working as intended for truffle's existing developer workflow. In it's current state, truffleDb is implemented as a 'co-witness' to the data. I see two solutions:\r\n\r\n1. Easiest, try/catch the `loadMigrate` function. If the user flips on TruffleDB in the capacity described in this issue we know the exact reason why the error is thrown. Provide an error message to run `compile` with `db:enabled` - NOTE: Handling this error will still allow the migration to complete, as it has already run and TruffleDB is only adding the network data to the contracts it assumed were saved in `load-compile`. If we went ahead and saved the migration data without the `loadCompile` data we hit a possible referential integrity issue where the contract may not be saved, but the migration information exist in the db. \r\n\r\n2. More thorough, but possible side effects. The `Profile.updated` function is unaware of TruffleDB, or that the user could switch TruffleDB on in between the `compile` and `migrate` commands. Thus, although the files exist on disk, it is unaware the data does not exist in the database. At this time, I do not support this path based on the previous feedback that was already covered and think it would become unnecessary tech debt/maintenance and that there may be easier ways to achieve integration into the existing truffle workflow. \r\n\r\n\r\nI am happy to hop on a call and share the trace and discuss options. This is not a 'bug' as much as it is an integration issue. The existing truffle workflow is working as intended. Personally, I would prefer to address the way truffledb is implemented as well as how it integrates into the truffle workflow before making changes in working parts of truffle that will need to maintain their backwards compatibility. \r\n\r\nTagging some folks to get extra eyes on the issue as a general sanity check and for feedback as my experience with the codebase is still limited and there are likely other, better ways to solve the issue. @fainashalts  @cds-amal @eggplantzzz \r\n\r\n\r\n\r\n\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/1018956835/reactions",
      "total_count": 2,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 1
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/1020464431",
    "html_url": "https://github.com/trufflesuite/truffle/issues/4614#issuecomment-1020464431",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/4614",
    "id": 1020464431,
    "node_id": "IC_kwDOAkfq-c480w0v",
    "user": {
      "login": "eggplantzzz",
      "id": 14827965,
      "node_id": "MDQ6VXNlcjE0ODI3OTY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/14827965?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/eggplantzzz",
      "html_url": "https://github.com/eggplantzzz",
      "followers_url": "https://api.github.com/users/eggplantzzz/followers",
      "following_url": "https://api.github.com/users/eggplantzzz/following{/other_user}",
      "gists_url": "https://api.github.com/users/eggplantzzz/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/eggplantzzz/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/eggplantzzz/subscriptions",
      "organizations_url": "https://api.github.com/users/eggplantzzz/orgs",
      "repos_url": "https://api.github.com/users/eggplantzzz/repos",
      "events_url": "https://api.github.com/users/eggplantzzz/events{/privacy}",
      "received_events_url": "https://api.github.com/users/eggplantzzz/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-01-24T19:29:03Z",
    "updated_at": "2022-01-24T19:29:03Z",
    "author_association": "CONTRIBUTOR",
    "body": "Yeah this will happen because `Profiler.updated` compares the last edits of both the source files and the built artifacts to determine whether there have been updates since the last compilation. It feels like the proper solution is to update that method to check with the saved db data to see if it is up-to-date when db is enabled. Offhand I'm not certain what that would entail, it might make it necessary for that method to take some sort of parameter to let it know how to check for updated source material. Also happy to chat about this if you want to!",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/1020464431/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
