{
  "url": "https://api.github.com/repos/trufflesuite/truffle/issues/5231",
  "repository_url": "https://api.github.com/repos/trufflesuite/truffle",
  "labels_url": "https://api.github.com/repos/trufflesuite/truffle/issues/5231/labels{/name}",
  "comments_url": "https://api.github.com/repos/trufflesuite/truffle/issues/5231/comments",
  "events_url": "https://api.github.com/repos/trufflesuite/truffle/issues/5231/events",
  "html_url": "https://github.com/trufflesuite/truffle/issues/5231",
  "id": 1284000069,
  "node_id": "I_kwDOAkfq-c5MiElF",
  "number": 5231,
  "title": "Modules imported by migration and test scripts don't share a global context with the migration or test script that imported them",
  "user": {
    "login": "benjamincburns",
    "id": 803016,
    "node_id": "MDQ6VXNlcjgwMzAxNg==",
    "avatar_url": "https://avatars.githubusercontent.com/u/803016?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/benjamincburns",
    "html_url": "https://github.com/benjamincburns",
    "followers_url": "https://api.github.com/users/benjamincburns/followers",
    "following_url": "https://api.github.com/users/benjamincburns/following{/other_user}",
    "gists_url": "https://api.github.com/users/benjamincburns/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/benjamincburns/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/benjamincburns/subscriptions",
    "organizations_url": "https://api.github.com/users/benjamincburns/orgs",
    "repos_url": "https://api.github.com/users/benjamincburns/repos",
    "events_url": "https://api.github.com/users/benjamincburns/events{/privacy}",
    "received_events_url": "https://api.github.com/users/benjamincburns/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 230393326,
      "node_id": "MDU6TGFiZWwyMzAzOTMzMjY=",
      "url": "https://api.github.com/repos/trufflesuite/truffle/labels/bug",
      "name": "bug",
      "color": "fc2929",
      "default": true,
      "description": null
    },
    {
      "id": 1675042241,
      "node_id": "MDU6TGFiZWwxNjc1MDQyMjQx",
      "url": "https://api.github.com/repos/trufflesuite/truffle/labels/priority5%20%F0%9F%8C%80",
      "name": "priority5 ðŸŒ€",
      "color": "006b75",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2022-06-24T17:25:54Z",
  "updated_at": "2022-07-07T18:06:36Z",
  "closed_at": null,
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "## Issue\r\n\r\nIf in a migration file I `require` some other module, that module's global context matches the global context for truffle CLI, not the global context that we set up for the migration file. Since tests are loaded/executed via the same code path (`require.file`), I believe this also applies to tests.\r\n\r\nFor example, in the case of migrations we wrap the resolver object (set in the migration script's global context as `artifacts`) with a object that caches any contracts that are touched during the migration. If you have a helper module that is imported in your migration however, the value of `artifacts` that the helper module gets is not the same object that the top-level migration script gets. Instead, it's the unwrapped resolver, as that's what's set on the global context for the CLI.\r\n\r\n## Steps to Reproduce\r\n\r\n1. Write a migration that requires a helper module\r\n2. In the top-level scope of the migration script, do `console.log(\"migration script has contracts method?\", !!artifacts.contracts)` \r\n3. From the top-level scope of the helper module, try running `console.log(\"helper has contracts method?\", !!artifacts.contracts)`\r\n\r\n## Expected Behavior\r\n\r\nBoth the helper module and the migration script should have the same value for their `artifacts` global, meaning you should observe the following output from the above repro (note that both values are now `true`):\r\n\r\n```\r\nmigration script has contracts method? true\r\nhelper has contracts method? true\r\n```\r\n\r\n## Actual Results\r\n\r\nThe actual output that you'll see will be something like:\r\n\r\n```\r\nmigration script has contracts method? true\r\nhelper has contracts method? false\r\n```\r\n\r\n## Environment\r\n\r\n* Operating System: All\r\n* Truffle version (`truffle version`): v5.5.19 (likely affects all previous versions)\r\n* node version (`node --version`): all current versions (through node 18)\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/5231/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/trufflesuite/truffle/issues/5231/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/1165784742",
    "html_url": "https://github.com/trufflesuite/truffle/issues/5231#issuecomment-1165784742",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/5231",
    "id": 1165784742,
    "node_id": "IC_kwDOAkfq-c5FfHam",
    "user": {
      "login": "benjamincburns",
      "id": 803016,
      "node_id": "MDQ6VXNlcjgwMzAxNg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/803016?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/benjamincburns",
      "html_url": "https://github.com/benjamincburns",
      "followers_url": "https://api.github.com/users/benjamincburns/followers",
      "following_url": "https://api.github.com/users/benjamincburns/following{/other_user}",
      "gists_url": "https://api.github.com/users/benjamincburns/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/benjamincburns/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/benjamincburns/subscriptions",
      "organizations_url": "https://api.github.com/users/benjamincburns/orgs",
      "repos_url": "https://api.github.com/users/benjamincburns/repos",
      "events_url": "https://api.github.com/users/benjamincburns/events{/privacy}",
      "received_events_url": "https://api.github.com/users/benjamincburns/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-06-24T17:28:53Z",
    "updated_at": "2022-06-24T17:28:53Z",
    "author_association": "CONTRIBUTOR",
    "body": "For context, this is due to the way that we \"sandbox\" migration and test files in `require.js`. Specifically we use the `vm` module, which doesn't include a `require` function in its global context. The current recommendation is to pass in your own (which is what we do), but this causes the global context of any modules imported by your script to be the parent context, not the one for your script.\r\n\r\nThere appears to be [experimental support for better module loading in VMs](https://nodejs.org/docs/latest-v14.x/api/vm.html#vm_class_vm_module) (see the linker stuff in that example), but given that it's experimental and the API is unstable, I don't think that we can rely on it.\r\n\r\nThere are also third party VM modules like [`vm2`](https://github.com/patriksimek/vm2), but I haven't investigated any of these deeply yet to determine if they're a viable alternative.",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/1165784742/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/1175138459",
    "html_url": "https://github.com/trufflesuite/truffle/issues/5231#issuecomment-1175138459",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/5231",
    "id": 1175138459,
    "node_id": "IC_kwDOAkfq-c5GCzCb",
    "user": {
      "login": "benjamincburns",
      "id": 803016,
      "node_id": "MDQ6VXNlcjgwMzAxNg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/803016?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/benjamincburns",
      "html_url": "https://github.com/benjamincburns",
      "followers_url": "https://api.github.com/users/benjamincburns/followers",
      "following_url": "https://api.github.com/users/benjamincburns/following{/other_user}",
      "gists_url": "https://api.github.com/users/benjamincburns/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/benjamincburns/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/benjamincburns/subscriptions",
      "organizations_url": "https://api.github.com/users/benjamincburns/orgs",
      "repos_url": "https://api.github.com/users/benjamincburns/repos",
      "events_url": "https://api.github.com/users/benjamincburns/events{/privacy}",
      "received_events_url": "https://api.github.com/users/benjamincburns/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-05T14:37:39Z",
    "updated_at": "2022-07-05T14:37:39Z",
    "author_association": "CONTRIBUTOR",
    "body": "@cds-amal suggested that this is possibly related to #4454. Will investigate that when I check this one out.",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/1175138459/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
