{
  "url": "https://api.github.com/repos/trufflesuite/truffle/issues/3937",
  "repository_url": "https://api.github.com/repos/trufflesuite/truffle",
  "labels_url": "https://api.github.com/repos/trufflesuite/truffle/issues/3937/labels{/name}",
  "comments_url": "https://api.github.com/repos/trufflesuite/truffle/issues/3937/comments",
  "events_url": "https://api.github.com/repos/trufflesuite/truffle/issues/3937/events",
  "html_url": "https://github.com/trufflesuite/truffle/issues/3937",
  "id": 836998851,
  "node_id": "MDU6SXNzdWU4MzY5OTg4NTE=",
  "number": 3937,
  "title": "Contract deployed to mainnet, but not locally",
  "user": {
    "login": "collect-code",
    "id": 80222677,
    "node_id": "MDQ6VXNlcjgwMjIyNjc3",
    "avatar_url": "https://avatars.githubusercontent.com/u/80222677?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/collect-code",
    "html_url": "https://github.com/collect-code",
    "followers_url": "https://api.github.com/users/collect-code/followers",
    "following_url": "https://api.github.com/users/collect-code/following{/other_user}",
    "gists_url": "https://api.github.com/users/collect-code/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/collect-code/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/collect-code/subscriptions",
    "organizations_url": "https://api.github.com/users/collect-code/orgs",
    "repos_url": "https://api.github.com/users/collect-code/repos",
    "events_url": "https://api.github.com/users/collect-code/events{/privacy}",
    "received_events_url": "https://api.github.com/users/collect-code/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2021-03-21T06:34:28Z",
  "updated_at": "2021-05-29T22:20:43Z",
  "closed_at": "2021-05-05T18:45:30Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "- [no] I've asked for help in the [Truffle Gitter](http://gitter.im/Consensys/truffle) before filing this issue.\r\n\r\n---------------------------\r\n\r\n## Issue\r\n\r\nContract was deployed to mainnet, but at the end I got an error that  **insufficient funds for gas * price + value**, and  deployment stopped. But the contracts were successfully created on the mainnet (the Migration, one Lib and one ERC721)\r\n\r\nI was charged for the contract creations, and now migrate wants to redeploy them, what will charge me again. I did several dry runs to reach a comfortable gas price and amount, but in the end I was surprised by this. And I still had balance for the final complete call.\r\n\r\n## Steps to Reproduce\r\n\r\nThere should be a combination of gas and balance that will pass on the dry-runs but still require some more in the end and cause this. I did this exact same deployment on Rinkeby twice and never had any problems. I noticed that my balance on the dry-runs were a little lower than my my actual balance, but still was enough for deployment, according to the dry-run.\r\n\r\nSince I was able to see the contracts on the mainnet, I manually added the contract addresses to the local json build (copy networks structure from Rinkeby), and executed **setComplete(2)** with **MyCrypto**. After that, migrate does not try to re-deploy but also does not update the local json files. I was able to **verify** all the contracts, and **I can access** them from the truffle console.\r\n\r\nEverything seems normal in truffle, but when I connect **Drizzle and MetaMask**, it does not connect to the mainnet. I'm posting this here instead of on drizzle, because it's clear that there's something missing on the truffle deployment. My drizzle store is working perfectly with Ganache and Rinkeby.\r\n\r\nThis is my network config...\r\n```\r\n    mainnet: {\r\n      provider: function() {\r\n        return new HDWalletProvider(\r\n          `${process.env.INFURA_MNEMONIC}`, \r\n          `https://mainnet.infura.io/v3/${process.env.INFURA_ID}`,\r\n          // `wss://mainnet.infura.io/ws/v3/${process.env.INFURA_ID}`,\r\n          1 // Metamask 2nd connected account\r\n        ) },\r\n      gas: 100000, // for working on the console, was defaulted during deployment\r\n      gasPrice: 110000000000, // 110 gwei\r\n      networkCheckTimeout: 10000000,\r\n      network_id: 1\r\n    }\r\n```\r\n\r\nDrizzle fails to initialize with this..\r\n```\r\nTypeError: Cannot read property 'address' of undefined\r\n    at getOrCreateWeb3Contract (drizzle-store.js?9126:13391)\r\n    at Drizzle.addContract (drizzle-store.js?9126:13428)\r\n    at runCallEffect (proc.js?0d31:513)\r\n    at runEffect (proc.js?0d31:435)\r\n\r\n```\r\n..which leads here...\r\n```\r\nvar getOrCreateWeb3Contract = function getOrCreateWeb3Contract(store, contractConfig, web3) {\r\n  if (contractConfig.web3Contract) {\r\n    return contractConfig.web3Contract;\r\n  }\r\n  var state = store.getState();\r\n  var networkId = state.web3 && state.web3.networkId;\r\n  var selectedAccount = state.accounts[0];\r\n  var abi = contractConfig.abi,\r\n      networks = contractConfig.networks,\r\n      deployedBytecode = contractConfig.deployedBytecode;\r\n  return new web3.eth.Contract(abi, networks[networkId].address, { // <<<<<< network is missing\r\n    from: selectedAccount,\r\n    data: deployedBytecode\r\n  });\r\n};\r\n\r\n```\r\nLooks like there is just a little thing missing to link the contracts to the network for drizzle....\r\n\r\n## Expected Behavior\r\n\r\nI expected that migrate could still use the deployed contracts and just rebuild the local json files. I don't want to lose the deployed contracts and all the gas that was used, and have multiple identical contracts deployed. \r\n\r\nMigrate should be able understand that the contracts were deployed successfully, and continue where it stopped on the nedt try.\r\n\r\nOr a way to import an existing contract?\r\n\r\nOr just update the local deployment? The source files and build have not changed after the failed deployment, all the necessary data should be right here. I was even able to verify!\r\n\r\nI think this can happen also if the process stops with the 750 seconds timeout. It even says the transaction can be mined and completed. If it is, what then?\r\n\r\n## Actual Results\r\n\r\nMigrate wants me to deploy again a **perfectly working contract** it deployed.\r\n\r\n## Environment\r\n\r\n* Operating System: macOS 10.15.7\r\n* Ethereum client: Infura\r\n* Truffle v5.1.67 (core: 5.1.67)\r\n* truffle/hdwallet-provider 1.2.3\r\n* drizzle/store 1.5.3\r\n* Solidity - 0.7.6 (solc-js)\r\n* Node v15.10.0\r\n* Web3.js v1.2.9\r\n* npm version (7.5.6): \r\n",
  "closed_by": {
    "login": "gnidan",
    "id": 151065,
    "node_id": "MDQ6VXNlcjE1MTA2NQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/151065?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/gnidan",
    "html_url": "https://github.com/gnidan",
    "followers_url": "https://api.github.com/users/gnidan/followers",
    "following_url": "https://api.github.com/users/gnidan/following{/other_user}",
    "gists_url": "https://api.github.com/users/gnidan/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/gnidan/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/gnidan/subscriptions",
    "organizations_url": "https://api.github.com/users/gnidan/orgs",
    "repos_url": "https://api.github.com/users/gnidan/repos",
    "events_url": "https://api.github.com/users/gnidan/events{/privacy}",
    "received_events_url": "https://api.github.com/users/gnidan/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/3937/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/trufflesuite/truffle/issues/3937/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/803643184",
    "html_url": "https://github.com/trufflesuite/truffle/issues/3937#issuecomment-803643184",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/3937",
    "id": 803643184,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwMzY0MzE4NA==",
    "user": {
      "login": "collect-code",
      "id": 80222677,
      "node_id": "MDQ6VXNlcjgwMjIyNjc3",
      "avatar_url": "https://avatars.githubusercontent.com/u/80222677?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/collect-code",
      "html_url": "https://github.com/collect-code",
      "followers_url": "https://api.github.com/users/collect-code/followers",
      "following_url": "https://api.github.com/users/collect-code/following{/other_user}",
      "gists_url": "https://api.github.com/users/collect-code/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/collect-code/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/collect-code/subscriptions",
      "organizations_url": "https://api.github.com/users/collect-code/orgs",
      "repos_url": "https://api.github.com/users/collect-code/repos",
      "events_url": "https://api.github.com/users/collect-code/events{/privacy}",
      "received_events_url": "https://api.github.com/users/collect-code/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-21T19:09:02Z",
    "updated_at": "2021-03-22T18:11:02Z",
    "author_association": "NONE",
    "body": "I have solved my drizzle problem, it was not related to this contract's deployment. There are some other undeployed contracts that it was trying to read and halting drizzle to properly initialize.\r\n\r\nMy fix editing the json files seems to be working so far. But anyway, the dry-run/migrate gave me some good headache.\r\nAll the problems I had with this deployment could be avoided if migrate could remember the contract addresses that were deployed successfully to the network.\r\n\r\nWhat could help a lot in this situation to understand what's going on the dry-run, is to display in the summary the total amount **gas used**, total amount of **gas left**, and user's **ETH balance before and after** the migration. Some times I see differences between my actual balance and the balance migration thinks I have, but my balance is displayed only when simulating low gas. That difference is probably what caused my issue, because I had funds, but migrate (or Infura?) was seeing a smaller amount. Having a clear view of all the data dry-run is using is crucial.",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/803643184/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/808818710",
    "html_url": "https://github.com/trufflesuite/truffle/issues/3937#issuecomment-808818710",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/3937",
    "id": 808818710,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwODgxODcxMA==",
    "user": {
      "login": "collect-code",
      "id": 80222677,
      "node_id": "MDQ6VXNlcjgwMjIyNjc3",
      "avatar_url": "https://avatars.githubusercontent.com/u/80222677?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/collect-code",
      "html_url": "https://github.com/collect-code",
      "followers_url": "https://api.github.com/users/collect-code/followers",
      "following_url": "https://api.github.com/users/collect-code/following{/other_user}",
      "gists_url": "https://api.github.com/users/collect-code/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/collect-code/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/collect-code/subscriptions",
      "organizations_url": "https://api.github.com/users/collect-code/orgs",
      "repos_url": "https://api.github.com/users/collect-code/repos",
      "events_url": "https://api.github.com/users/collect-code/events{/privacy}",
      "received_events_url": "https://api.github.com/users/collect-code/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-27T23:46:51Z",
    "updated_at": "2021-03-27T23:46:51Z",
    "author_association": "NONE",
    "body": "And it happened again!\r\n`insufficient funds for gas * price + value`\r\nSent 7000000 gas * 100 gwei, that's 0.7 ETH\r\nSpent Ëœ6200000 gas, my balance of 0,97 ETH should be enough, but it isn't.\r\nI do have funds, where is this math coming from?",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/808818710/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/812721021",
    "html_url": "https://github.com/trufflesuite/truffle/issues/3937#issuecomment-812721021",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/3937",
    "id": 812721021,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgxMjcyMTAyMQ==",
    "user": {
      "login": "eggplantzzz",
      "id": 14827965,
      "node_id": "MDQ6VXNlcjE0ODI3OTY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/14827965?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/eggplantzzz",
      "html_url": "https://github.com/eggplantzzz",
      "followers_url": "https://api.github.com/users/eggplantzzz/followers",
      "following_url": "https://api.github.com/users/eggplantzzz/following{/other_user}",
      "gists_url": "https://api.github.com/users/eggplantzzz/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/eggplantzzz/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/eggplantzzz/subscriptions",
      "organizations_url": "https://api.github.com/users/eggplantzzz/orgs",
      "repos_url": "https://api.github.com/users/eggplantzzz/repos",
      "events_url": "https://api.github.com/users/eggplantzzz/events{/privacy}",
      "received_events_url": "https://api.github.com/users/eggplantzzz/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-04-02T21:20:11Z",
    "updated_at": "2021-04-02T21:21:53Z",
    "author_association": "CONTRIBUTOR",
    "body": "Hey @collect-coder sorry for the delayed response. Sorry about the trouble, I'm not sure why that happened during the migration. If you want to get around running migrations you can load a contract from its address as follows:\r\n```javascript\r\nconst MyContract = artifacts.require(\"MyContract\");\r\nconst instance = MyContract.at(\"<addressOfDeployedContract>\");\r\n//... do stuff with instance\r\n```\r\n\r\nI don't know if this helps...sorry I can't give you more insight on the gas issues. During migrations it should give you some sort of report on gas usage etc.\r\n\r\nAnd at first glance your config looks correct. You could perhaps try omitting the gas values? Truffle will calculate some sensible defaults according to conditions.",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/812721021/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/832924318",
    "html_url": "https://github.com/trufflesuite/truffle/issues/3937#issuecomment-832924318",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/3937",
    "id": 832924318,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgzMjkyNDMxOA==",
    "user": {
      "login": "gnidan",
      "id": 151065,
      "node_id": "MDQ6VXNlcjE1MTA2NQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/151065?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gnidan",
      "html_url": "https://github.com/gnidan",
      "followers_url": "https://api.github.com/users/gnidan/followers",
      "following_url": "https://api.github.com/users/gnidan/following{/other_user}",
      "gists_url": "https://api.github.com/users/gnidan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gnidan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gnidan/subscriptions",
      "organizations_url": "https://api.github.com/users/gnidan/orgs",
      "repos_url": "https://api.github.com/users/gnidan/repos",
      "events_url": "https://api.github.com/users/gnidan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gnidan/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-05-05T18:45:30Z",
    "updated_at": "2021-05-05T18:45:30Z",
    "author_association": "MEMBER",
    "body": "Closing this for issue maintenance. Happy to re-open if you get the chance to get back to us. Sorry that you ran into this problem!",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/832924318/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/850907247",
    "html_url": "https://github.com/trufflesuite/truffle/issues/3937#issuecomment-850907247",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/3937",
    "id": 850907247,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg1MDkwNzI0Nw==",
    "user": {
      "login": "collect-code",
      "id": 80222677,
      "node_id": "MDQ6VXNlcjgwMjIyNjc3",
      "avatar_url": "https://avatars.githubusercontent.com/u/80222677?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/collect-code",
      "html_url": "https://github.com/collect-code",
      "followers_url": "https://api.github.com/users/collect-code/followers",
      "following_url": "https://api.github.com/users/collect-code/following{/other_user}",
      "gists_url": "https://api.github.com/users/collect-code/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/collect-code/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/collect-code/subscriptions",
      "organizations_url": "https://api.github.com/users/collect-code/orgs",
      "repos_url": "https://api.github.com/users/collect-code/repos",
      "events_url": "https://api.github.com/users/collect-code/events{/privacy}",
      "received_events_url": "https://api.github.com/users/collect-code/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-05-29T22:20:43Z",
    "updated_at": "2021-05-29T22:20:43Z",
    "author_association": "NONE",
    "body": "Already happening back in #3888 ",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/850907247/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
