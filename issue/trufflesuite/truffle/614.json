{
  "url": "https://api.github.com/repos/trufflesuite/truffle/issues/614",
  "repository_url": "https://api.github.com/repos/trufflesuite/truffle",
  "labels_url": "https://api.github.com/repos/trufflesuite/truffle/issues/614/labels{/name}",
  "comments_url": "https://api.github.com/repos/trufflesuite/truffle/issues/614/comments",
  "events_url": "https://api.github.com/repos/trufflesuite/truffle/issues/614/events",
  "html_url": "https://github.com/trufflesuite/truffle/issues/614",
  "id": 264448747,
  "node_id": "MDU6SXNzdWUyNjQ0NDg3NDc=",
  "number": 614,
  "title": "Intermittent \"Invalid opcode\" exceptions when running tests",
  "user": {
    "login": "jaddison",
    "id": 101148,
    "node_id": "MDQ6VXNlcjEwMTE0OA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/101148?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jaddison",
    "html_url": "https://github.com/jaddison",
    "followers_url": "https://api.github.com/users/jaddison/followers",
    "following_url": "https://api.github.com/users/jaddison/following{/other_user}",
    "gists_url": "https://api.github.com/users/jaddison/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jaddison/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jaddison/subscriptions",
    "organizations_url": "https://api.github.com/users/jaddison/orgs",
    "repos_url": "https://api.github.com/users/jaddison/repos",
    "events_url": "https://api.github.com/users/jaddison/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jaddison/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2017-10-11T03:47:59Z",
  "updated_at": "2017-11-20T17:05:10Z",
  "closed_at": "2017-10-13T21:53:41Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "- [x] I've asked for help in the [Truffle Gitter](http://gitter.im/Consensys/truffle) before filing this issue.\r\n\r\n---------------------------\r\n\r\n## Issue\r\n\r\nWhen running tests, they 'sometimes' (ie intermittently, seemingly randomly) fail with an \"invalid opcode\" exception, using `node_modules/.bin/testrpc`.\r\n\r\n## Steps to Reproduce\r\n\r\nIt's intermittent, so there aren't any consistent steps for reproduction.\r\n\r\nI simply run:\r\n```\r\nnode_modules/.bin/truffle test\r\n```\r\n\r\n## Expected Behavior\r\n\r\nTests would always execute cleanly and consistently.\r\n\r\n## Actual Results\r\n\r\n```\r\n~/projects/proj/token-sale (master)$ node_modules/.bin/truffle test\r\nCompiling ./contracts/IRefundHandler.sol...\r\nCompiling ./contracts/Migrations.sol...\r\nCompiling ./contracts/MySale.sol...\r\nCompiling ./contracts/MyToken.sol...\r\nCompiling ./test/helpers/MockSale.sol...\r\nCompiling ./test/helpers/MockToken.sol...\r\nCompiling zeppelin-solidity/contracts/lifecycle/Pausable.sol...\r\nCompiling zeppelin-solidity/contracts/math/SafeMath.sol...\r\nCompiling zeppelin-solidity/contracts/ownership/Ownable.sol...\r\nCompiling zeppelin-solidity/contracts/token/BasicToken.sol...\r\nCompiling zeppelin-solidity/contracts/token/ERC20.sol...\r\nCompiling zeppelin-solidity/contracts/token/ERC20Basic.sol...\r\nCompiling zeppelin-solidity/contracts/token/StandardToken.sol...\r\n\r\n\r\n  Contract: MySale\r\n    1) \"before all\" hook\r\n\r\n\r\n  0 passing (210ms)\r\n  1 failing\r\n\r\n  1) Contract: MySale \"before all\" hook:\r\n     Error: VM Exception while processing transaction: invalid opcode\r\n      at Object.InvalidResponse (node_modules/truffle/build/cli.bundled.js:37312:16)\r\n      at node_modules/truffle/build/cli.bundled.js:220420:36\r\n      at node_modules/truffle/build/cli.bundled.js:204149:9\r\n      at XMLHttpRequest.request.onreadystatechange (node_modules/truffle/build/cli.bundled.js:205574:13)\r\n      at XMLHttpRequestEventTarget.dispatchEvent (node_modules/truffle/build/cli.bundled.js:73069:18)\r\n      at XMLHttpRequest._setReadyState (node_modules/truffle/build/cli.bundled.js:73359:12)\r\n      at XMLHttpRequest._onHttpResponseEnd (node_modules/truffle/build/cli.bundled.js:73514:12)\r\n      at IncomingMessage.<anonymous> (node_modules/truffle/build/cli.bundled.js:73474:24)\r\n```\r\nIf I restart `testrpc`, I don't *usually* see the issue - but it certainly can and has happened immediately after the restart. The problem is exacerbated if I have multiple .js test files; sometimes the first will work, while other times the first one fails but the 2nd one works. Sometimes they all fail.\r\n\r\nAnd yes, the failures happen without any code changes. I know the test cases are all green and working.\r\n\r\n## Environment\r\n\r\n* Operating System: macOS 10.13 (happens on 10.12 too); also happens on Ubuntu 16.04\r\n* Truffle version: Truffle v3.4.11 (core: 3.4.11); Solidity v0.4.15 (solc-js)\r\n* Ethereum client: EthereumJS TestRPC v4.1.3 (ganache-core: 1.1.3)\r\n* node version: v8.4.0\r\n* npm version: 5.4.2\r\n",
  "closed_by": {
    "login": "jaddison",
    "id": 101148,
    "node_id": "MDQ6VXNlcjEwMTE0OA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/101148?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jaddison",
    "html_url": "https://github.com/jaddison",
    "followers_url": "https://api.github.com/users/jaddison/followers",
    "following_url": "https://api.github.com/users/jaddison/following{/other_user}",
    "gists_url": "https://api.github.com/users/jaddison/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jaddison/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jaddison/subscriptions",
    "organizations_url": "https://api.github.com/users/jaddison/orgs",
    "repos_url": "https://api.github.com/users/jaddison/repos",
    "events_url": "https://api.github.com/users/jaddison/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jaddison/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/614/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/trufflesuite/truffle/issues/614/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/336576641",
    "html_url": "https://github.com/trufflesuite/truffle/issues/614#issuecomment-336576641",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/614",
    "id": 336576641,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMzNjU3NjY0MQ==",
    "user": {
      "login": "jaddison",
      "id": 101148,
      "node_id": "MDQ6VXNlcjEwMTE0OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/101148?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jaddison",
      "html_url": "https://github.com/jaddison",
      "followers_url": "https://api.github.com/users/jaddison/followers",
      "following_url": "https://api.github.com/users/jaddison/following{/other_user}",
      "gists_url": "https://api.github.com/users/jaddison/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jaddison/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jaddison/subscriptions",
      "organizations_url": "https://api.github.com/users/jaddison/orgs",
      "repos_url": "https://api.github.com/users/jaddison/repos",
      "events_url": "https://api.github.com/users/jaddison/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jaddison/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-10-13T21:53:41Z",
    "updated_at": "2017-10-13T21:53:41Z",
    "author_association": "NONE",
    "body": "Closing. Found a race-condition type of issue. Apologies for the noise.",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/336576641/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/345677842",
    "html_url": "https://github.com/trufflesuite/truffle/issues/614#issuecomment-345677842",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/614",
    "id": 345677842,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM0NTY3Nzg0Mg==",
    "user": {
      "login": "7sedam7",
      "id": 1090254,
      "node_id": "MDQ6VXNlcjEwOTAyNTQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1090254?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/7sedam7",
      "html_url": "https://github.com/7sedam7",
      "followers_url": "https://api.github.com/users/7sedam7/followers",
      "following_url": "https://api.github.com/users/7sedam7/following{/other_user}",
      "gists_url": "https://api.github.com/users/7sedam7/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/7sedam7/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/7sedam7/subscriptions",
      "organizations_url": "https://api.github.com/users/7sedam7/orgs",
      "repos_url": "https://api.github.com/users/7sedam7/repos",
      "events_url": "https://api.github.com/users/7sedam7/events{/privacy}",
      "received_events_url": "https://api.github.com/users/7sedam7/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-11-20T12:09:48Z",
    "updated_at": "2017-11-20T12:22:35Z",
    "author_association": "NONE",
    "body": "@jaddison can you provide the solution that solved your problem, please?\r\n\r\nI use:\r\n * OS: OSX 10.13.1\r\n * Truffle: 4.0.1\r\n * Solidity: 0.4.18\r\n * node: 8.9.0\r\n * npm: 5.5.1\r\n\r\nFor me tests sometimes fail, sometimes they pass, contract is erc20 token, taken from `minime` and `zeppelin-solidity`",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/345677842/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/345760673",
    "html_url": "https://github.com/trufflesuite/truffle/issues/614#issuecomment-345760673",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/614",
    "id": 345760673,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM0NTc2MDY3Mw==",
    "user": {
      "login": "jaddison",
      "id": 101148,
      "node_id": "MDQ6VXNlcjEwMTE0OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/101148?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jaddison",
      "html_url": "https://github.com/jaddison",
      "followers_url": "https://api.github.com/users/jaddison/followers",
      "following_url": "https://api.github.com/users/jaddison/following{/other_user}",
      "gists_url": "https://api.github.com/users/jaddison/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jaddison/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jaddison/subscriptions",
      "organizations_url": "https://api.github.com/users/jaddison/orgs",
      "repos_url": "https://api.github.com/users/jaddison/repos",
      "events_url": "https://api.github.com/users/jaddison/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jaddison/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-11-20T17:03:41Z",
    "updated_at": "2017-11-20T17:05:10Z",
    "author_association": "NONE",
    "body": "I don't recall specifically - but it wasn't `truffle` or `testrpc` related. It was definitely my contract/deployment logic. I think it was likely with how I was deploying to `testrpc` in my migrations - maybe it wasn't waiting for contracts to deploy before calling contract functions? Something along those lines.\r\n\r\nEdit: the [working code is here](https://github.com/onewed/unitycoin). Feel free to peruse.",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/345760673/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
