{
  "url": "https://api.github.com/repos/trufflesuite/truffle/issues/2710",
  "repository_url": "https://api.github.com/repos/trufflesuite/truffle",
  "labels_url": "https://api.github.com/repos/trufflesuite/truffle/issues/2710/labels{/name}",
  "comments_url": "https://api.github.com/repos/trufflesuite/truffle/issues/2710/comments",
  "events_url": "https://api.github.com/repos/trufflesuite/truffle/issues/2710/events",
  "html_url": "https://github.com/trufflesuite/truffle/issues/2710",
  "id": 542992121,
  "node_id": "MDU6SXNzdWU1NDI5OTIxMjE=",
  "number": 2710,
  "title": "Test Isolation in Truffle 5.1.5",
  "user": {
    "login": "mrice32",
    "id": 11791551,
    "node_id": "MDQ6VXNlcjExNzkxNTUx",
    "avatar_url": "https://avatars.githubusercontent.com/u/11791551?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mrice32",
    "html_url": "https://github.com/mrice32",
    "followers_url": "https://api.github.com/users/mrice32/followers",
    "following_url": "https://api.github.com/users/mrice32/following{/other_user}",
    "gists_url": "https://api.github.com/users/mrice32/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mrice32/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mrice32/subscriptions",
    "organizations_url": "https://api.github.com/users/mrice32/orgs",
    "repos_url": "https://api.github.com/users/mrice32/repos",
    "events_url": "https://api.github.com/users/mrice32/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mrice32/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2019-12-27T21:14:59Z",
  "updated_at": "2020-01-08T23:05:44Z",
  "closed_at": "2020-01-08T23:05:44Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "- [x] I've asked for help in the [Truffle Gitter](http://gitter.im/Consensys/truffle) before filing this issue.\r\n\r\n---------------------------\r\n\r\n## Issue\r\n\r\nI think truffle 5.1.5 broke test file isolation.\r\n\r\nThe same contract addresses seem to be used across multiple test files when running `$(npm bin)/truffle test`. From a deeper investigation, it looks like a fresh migration is occurring, but the addresses that are injected into the environment aren't being updated from test to test.\r\n\r\n## Steps to Reproduce\r\n\r\nSee https://github.com/mrice32/truffle_example for a simple example (varies only slightly from `truffle init`) of the test isolation issue.\r\n\r\n```\r\ngit clone https://github.com/mrice32/truffle_example\r\ncd truffle_example\r\nnpm install\r\n$(npm bin)/truffle test\r\n```\r\n\r\n## Expected Behavior\r\n\r\nTests should pass and print different addresses.\r\n\r\n## Actual Results\r\n\r\nOutput for `$(npm bin)/truffle test` in the above repository.\r\n```\r\n\r\nCompiling your contracts...\r\n===========================\r\n> Compiling ./contracts/Migrations.sol\r\n\r\n\r\n\r\n  Contract: 1\r\n0x8CdaF0CD259887258Bc13a92C0a6dA92698644C0\r\n    âœ“ Check and Set value (69ms)\r\n\r\n  Contract: 2\r\n0x8CdaF0CD259887258Bc13a92C0a6dA92698644C0\r\n    1) Check and Set value\r\n    > No events were emitted\r\n\r\n\r\n  1 passing (271ms)\r\n  1 failing\r\n\r\n  1) Contract: 2\r\n       Check and Set value:\r\n\r\n      AssertionError: expected '1' to equal '0'\r\n      + expected - actual\r\n\r\n      -1\r\n      +0\r\n      \r\n      at Context.<anonymous> (test/2.js:7:12)\r\n      at processTicksAndRejections (internal/process/task_queues.js:86:5)\r\n```\r\n\r\n## Environment\r\n\r\n* Operating System: Mac OS X 10.15\r\n* Ethereum client: Default truffle test client\r\n* Truffle version (`truffle version`): Truffle v5.1.5\r\n* node version (`node --version`): v11.15.0\r\n* npm version (`npm --version`): 6.13.4\r\n",
  "closed_by": {
    "login": "haltman-at",
    "id": 35589221,
    "node_id": "MDQ6VXNlcjM1NTg5MjIx",
    "avatar_url": "https://avatars.githubusercontent.com/u/35589221?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/haltman-at",
    "html_url": "https://github.com/haltman-at",
    "followers_url": "https://api.github.com/users/haltman-at/followers",
    "following_url": "https://api.github.com/users/haltman-at/following{/other_user}",
    "gists_url": "https://api.github.com/users/haltman-at/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/haltman-at/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/haltman-at/subscriptions",
    "organizations_url": "https://api.github.com/users/haltman-at/orgs",
    "repos_url": "https://api.github.com/users/haltman-at/repos",
    "events_url": "https://api.github.com/users/haltman-at/events{/privacy}",
    "received_events_url": "https://api.github.com/users/haltman-at/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/2710/reactions",
    "total_count": 1,
    "+1": 1,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/trufflesuite/truffle/issues/2710/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/571774574",
    "html_url": "https://github.com/trufflesuite/truffle/issues/2710#issuecomment-571774574",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/2710",
    "id": 571774574,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU3MTc3NDU3NA==",
    "user": {
      "login": "haltman-at",
      "id": 35589221,
      "node_id": "MDQ6VXNlcjM1NTg5MjIx",
      "avatar_url": "https://avatars.githubusercontent.com/u/35589221?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/haltman-at",
      "html_url": "https://github.com/haltman-at",
      "followers_url": "https://api.github.com/users/haltman-at/followers",
      "following_url": "https://api.github.com/users/haltman-at/following{/other_user}",
      "gists_url": "https://api.github.com/users/haltman-at/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/haltman-at/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/haltman-at/subscriptions",
      "organizations_url": "https://api.github.com/users/haltman-at/orgs",
      "repos_url": "https://api.github.com/users/haltman-at/repos",
      "events_url": "https://api.github.com/users/haltman-at/events{/privacy}",
      "received_events_url": "https://api.github.com/users/haltman-at/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-01-07T21:10:34Z",
    "updated_at": "2020-01-07T21:10:34Z",
    "author_association": "CONTRIBUTOR",
    "body": "OK, it looks like what happened here is that I accidentally broke the logic used to detect if we can use snapshots to revert the state.  So, instead of reverting via snapshot like would've happened prior to 5.1.5, instead a redeploy is happening (the fallback used if snapshots aren't available).  I think I exposed an underlying bug in that.\r\n\r\nAnyway, I'm just going to try to fix the snapshot logic so it goes back to using snapshots.  I don't know what to do about the underlying redeploy bug; I'll probably just open an issue for that after fixing this so that we're aware of it for the future.",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/571774574/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/571790670",
    "html_url": "https://github.com/trufflesuite/truffle/issues/2710#issuecomment-571790670",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/2710",
    "id": 571790670,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU3MTc5MDY3MA==",
    "user": {
      "login": "haltman-at",
      "id": 35589221,
      "node_id": "MDQ6VXNlcjM1NTg5MjIx",
      "avatar_url": "https://avatars.githubusercontent.com/u/35589221?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/haltman-at",
      "html_url": "https://github.com/haltman-at",
      "followers_url": "https://api.github.com/users/haltman-at/followers",
      "following_url": "https://api.github.com/users/haltman-at/following{/other_user}",
      "gists_url": "https://api.github.com/users/haltman-at/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/haltman-at/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/haltman-at/subscriptions",
      "organizations_url": "https://api.github.com/users/haltman-at/orgs",
      "repos_url": "https://api.github.com/users/haltman-at/repos",
      "events_url": "https://api.github.com/users/haltman-at/events{/privacy}",
      "received_events_url": "https://api.github.com/users/haltman-at/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-01-07T21:54:25Z",
    "updated_at": "2020-01-07T21:54:41Z",
    "author_association": "CONTRIBUTOR",
    "body": "OK, I've put up PR #2727 to fix this.  Or at least to fix the immediate problem that I accidentally introduced; I have no idea what to do about the underlying bug that got exposed, but things will at least be back to working how they were before.",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/571790670/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
