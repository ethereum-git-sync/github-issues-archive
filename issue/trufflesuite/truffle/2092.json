{
  "url": "https://api.github.com/repos/trufflesuite/truffle/issues/2092",
  "repository_url": "https://api.github.com/repos/trufflesuite/truffle",
  "labels_url": "https://api.github.com/repos/trufflesuite/truffle/issues/2092/labels{/name}",
  "comments_url": "https://api.github.com/repos/trufflesuite/truffle/issues/2092/comments",
  "events_url": "https://api.github.com/repos/trufflesuite/truffle/issues/2092/events",
  "html_url": "https://github.com/trufflesuite/truffle/issues/2092",
  "id": 454188000,
  "node_id": "MDU6SXNzdWU0NTQxODgwMDA=",
  "number": 2092,
  "title": "Weird behaviour: arbitrary and random REVERT while running test with same code without any changes",
  "user": {
    "login": "itinance",
    "id": 1758597,
    "node_id": "MDQ6VXNlcjE3NTg1OTc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1758597?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/itinance",
    "html_url": "https://github.com/itinance",
    "followers_url": "https://api.github.com/users/itinance/followers",
    "following_url": "https://api.github.com/users/itinance/following{/other_user}",
    "gists_url": "https://api.github.com/users/itinance/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/itinance/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/itinance/subscriptions",
    "organizations_url": "https://api.github.com/users/itinance/orgs",
    "repos_url": "https://api.github.com/users/itinance/repos",
    "events_url": "https://api.github.com/users/itinance/events{/privacy}",
    "received_events_url": "https://api.github.com/users/itinance/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 6,
  "created_at": "2019-06-10T14:05:11Z",
  "updated_at": "2019-06-10T18:58:49Z",
  "closed_at": "2019-06-10T18:58:24Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "- [x] I've asked for help in the [Truffle Gitter](http://gitter.im/Consensys/truffle) before filing this issue.\r\n\r\n---------------------------\r\n\r\n## Issue\r\n\r\nI get random and unpredictable reverts while running tests on the very same code basis. Sometimes they run through, sometimes a revert is happening running on local network powered by ganache.\r\n\r\nWhen it reverts, in my case it always revert at the line where “addMinter” is executed on the CrowdSale-Contract out of “[beforeEach](https://github.com/itinance/ncd-token/blob/master/test/NCDTokenSaleTests.1.js#L39)” in the test (which can be seen with the output of `console.log(5).` After “`5`” was printed to stdout, it reverts. When I would debug this with `“truffle debug $transactionID”`, everything would go through successfully.\r\n\r\nWhen I run my tests 5 times, then there is a big chance that at least for one time it reverts with the very first test, sometimes at the second or third test, sometimes everything is going through without any revert.\r\n\r\nWhen I run these tests 10 times, in some cases everything works fine, and mostly it breaks within a particular test like described above.\r\n\r\nSometimes 5 times running tests in a row works sucessfully, sometimes it breaks constantely.\r\n\r\n## Steps to Reproduce\r\n\r\nMy tests looks as follows (and can be found here: https://github.com/itinance/ncd-token):\r\n\r\n```\r\ncontract(\"CrowdSale tests\", async ([_, owner, pauser1, pauser2,  ...otherAccounts]) => {\r\n    let token, tokenSale,\r\n        openingTime, closingTime, afterClosingTime;\r\n\r\n    const buyer = otherAccounts[1];\r\n  \r\n    beforeEach(async function () {\r\n        token = await XXXToken.new({from: owner});\r\n        token.initialize( owner, [pauser1, pauser2]);\r\n\r\n        openingTime = await time.latest();\r\n        closingTime = openingTime.add(time.duration.years(1));\r\n        afterClosingTime = closingTime.add(time.duration.seconds(1));\r\n\r\n        console.log(4, token.address);\r\n\r\n        tokenSale = await XXXTokenSale.new({from: owner});\r\n        tokenSale.initialize(openingTime, closingTime, token.address);\r\n\r\n        console.log(5)\r\n\r\n        await token.addMinter(tokenSale.address, {from: owner});\r\n        console.log(6)\r\n        await token.renounceMinter({ from: owner });\r\n\r\n        console.log(7)\r\n\r\n    });\r\n\r\n        it('crowdsale should be minter', async function () {\r\n          (await token.isMinter(tokenSale.address)).should.equal(true);\r\n        });\r\n\r\n        it('owner should not be minter anymore', async function () {\r\n          (await token.isMinter(owner)).should.equal(false);\r\n        });\r\n\r\n        it('Timelock can be added', async function() {\r\n          await tokenSale.addTimelock(afterClosingTime);\r\n        })\r\n\r\n});\r\n```\r\n\r\nI run on MacbookPro with MacOS Mojave and the following toolset:\r\n\r\n    $ truffle version\r\n    Truffle v5.0.21 (core: 5.0.21)\r\n    Solidity v0.5.0 (solc-js)\r\n    Node v10.16.0\r\n    Web3.js v1.0.0-beta.37\r\n    Ganache CLI v6.4.3 (ganache-core: 2.5.5)\r\n\r\nGanache was launched this way:\r\n\r\n`ganache-cli --mnemonic “your twelve word mnemonic here”`\r\n\r\n**truffle-config.js:**\r\n\r\n```\r\nmodule.exports = {\r\n  networks: {\r\n    development: {\r\n      host: \"127.0.0.1\",\r\n      port: 8545,\r\n      gas: 6000000,\r\n      gasPrice: 5e9,\r\n      network_id: \"*\",\r\n    },\r\n\r\n```\r\n\r\n\r\n## Expected Behavior\r\n\r\nConstant predictable behaviour across running tests on the very same code base.\r\n\r\n## Actual Results\r\n\r\nSome times tests are running through, sometimes not\r\n\r\n## Environment\r\n\r\nI run on MacbookPro with MacOS Mojave and the following toolset:\r\n\r\n```\r\n    $ truffle version\r\n    Truffle v5.0.20 (core: 5.0.20)\r\n    Solidity v0.5.0 (solc-js)\r\n    Node v10.16.0\r\n    Web3.js v1.0.0-beta.37\r\n    Ganache CLI v6.3.0 (ganache-core: 2.4.0)\r\n\r\n```\r\nGanache was launched this way:\r\n\r\n`ganache-cli --mnemonic “your twelve word mnemonic here”`\r\n\r\n**truffle-config.js:**\r\n\r\n```\r\nmodule.exports = {\r\n  networks: {\r\n    development: {\r\n      host: \"127.0.0.1\",\r\n      port: 8545,\r\n      gas: 6000000,\r\n      gasPrice: 5e9,\r\n\r\n      network_id: \"*\",\r\n    },\r\n\r\n\r\n```",
  "closed_by": {
    "login": "itinance",
    "id": 1758597,
    "node_id": "MDQ6VXNlcjE3NTg1OTc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1758597?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/itinance",
    "html_url": "https://github.com/itinance",
    "followers_url": "https://api.github.com/users/itinance/followers",
    "following_url": "https://api.github.com/users/itinance/following{/other_user}",
    "gists_url": "https://api.github.com/users/itinance/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/itinance/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/itinance/subscriptions",
    "organizations_url": "https://api.github.com/users/itinance/orgs",
    "repos_url": "https://api.github.com/users/itinance/repos",
    "events_url": "https://api.github.com/users/itinance/events{/privacy}",
    "received_events_url": "https://api.github.com/users/itinance/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/2092/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/trufflesuite/truffle/issues/2092/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/500462933",
    "html_url": "https://github.com/trufflesuite/truffle/issues/2092#issuecomment-500462933",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/2092",
    "id": 500462933,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUwMDQ2MjkzMw==",
    "user": {
      "login": "CruzMolina",
      "id": 7537712,
      "node_id": "MDQ6VXNlcjc1Mzc3MTI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7537712?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/CruzMolina",
      "html_url": "https://github.com/CruzMolina",
      "followers_url": "https://api.github.com/users/CruzMolina/followers",
      "following_url": "https://api.github.com/users/CruzMolina/following{/other_user}",
      "gists_url": "https://api.github.com/users/CruzMolina/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/CruzMolina/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/CruzMolina/subscriptions",
      "organizations_url": "https://api.github.com/users/CruzMolina/orgs",
      "repos_url": "https://api.github.com/users/CruzMolina/repos",
      "events_url": "https://api.github.com/users/CruzMolina/events{/privacy}",
      "received_events_url": "https://api.github.com/users/CruzMolina/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-06-10T15:37:11Z",
    "updated_at": "2019-06-10T15:37:11Z",
    "author_association": "CONTRIBUTOR",
    "body": "Hey @itinance, based on your repo's activity, looks like you're already on it, but I would def make sure that for **all** contract instance method calls you make sure to `await` them appropriately.",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/500462933/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/500497860",
    "html_url": "https://github.com/trufflesuite/truffle/issues/2092#issuecomment-500497860",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/2092",
    "id": 500497860,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUwMDQ5Nzg2MA==",
    "user": {
      "login": "itinance",
      "id": 1758597,
      "node_id": "MDQ6VXNlcjE3NTg1OTc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1758597?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/itinance",
      "html_url": "https://github.com/itinance",
      "followers_url": "https://api.github.com/users/itinance/followers",
      "following_url": "https://api.github.com/users/itinance/following{/other_user}",
      "gists_url": "https://api.github.com/users/itinance/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/itinance/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/itinance/subscriptions",
      "organizations_url": "https://api.github.com/users/itinance/orgs",
      "repos_url": "https://api.github.com/users/itinance/repos",
      "events_url": "https://api.github.com/users/itinance/events{/privacy}",
      "received_events_url": "https://api.github.com/users/itinance/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-06-10T17:07:46Z",
    "updated_at": "2019-06-10T17:07:46Z",
    "author_association": "CONTRIBUTOR",
    "body": "Thx for reaching out @CruzMolina. I've already found missing `await`-statements and added them to every instance method call. Nevertheless, it keeps breaking, I wrote a script where I can run `truffle test` multiple times and grep for \"Error:\":\r\n\r\n`alias tt=\"truffle test\"`\r\n\r\n5 times \"truffle test\" in a row, grepped for \"Error:\", 4 failed:\r\n\r\n```\r\n$ run 5 tt|grep Error\\:\r\n     Error: Returned error: VM Exception while processing transaction: revert\r\n     Error: Returned error: VM Exception while processing transaction: revert\r\n     Error: Returned error: VM Exception while processing transaction: revert\r\n     Error: Returned error: VM Exception while processing transaction: revert\r\n```\r\n\r\n15 tests in a row, 5 failed:\r\n\r\n```\r\n$ time run 15 tt|grep Error\\:\r\n     Error: Returned error: VM Exception while processing transaction: revert\r\n     Error: Returned error: VM Exception while processing transaction: revert\r\n     Error: Returned error: VM Exception while processing transaction: revert\r\n     Error: Returned error: VM Exception while processing transaction: revert\r\n     Error: Returned error: VM Exception while processing transaction: revert\r\n```\r\n\r\n5 fails in 15 runs. But the count is arbitrary and may differ in subsequent tests.\r\n\r\nIt is remarkable that only the CrowdSale-Test with minting token makes this trouble. Indeed, when I don't call `initialize` on the CrowdSale contract (and therefor comment out the tests regarding this particular contract), no `revert`s will occur. Any ideas what is wrong with that?\r\n\r\nNothing special happens there:\r\n\r\n```\r\n    function initialize(uint256 openingTime, uint256 closingTime, NCDToken token) public initializer {\r\n        require(address(token) != address(0));\r\n\r\n        _token = token;\r\n\r\n        // solhint-disable-next-line not-rely-on-time\r\n        require(openingTime >= block.timestamp);\r\n        require(closingTime > openingTime);\r\n\r\n        _openingTime = openingTime;\r\n        _closingTime = closingTime;\r\n    }\r\n\r\n```\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/500497860/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/500501823",
    "html_url": "https://github.com/trufflesuite/truffle/issues/2092#issuecomment-500501823",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/2092",
    "id": 500501823,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUwMDUwMTgyMw==",
    "user": {
      "login": "CruzMolina",
      "id": 7537712,
      "node_id": "MDQ6VXNlcjc1Mzc3MTI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7537712?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/CruzMolina",
      "html_url": "https://github.com/CruzMolina",
      "followers_url": "https://api.github.com/users/CruzMolina/followers",
      "following_url": "https://api.github.com/users/CruzMolina/following{/other_user}",
      "gists_url": "https://api.github.com/users/CruzMolina/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/CruzMolina/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/CruzMolina/subscriptions",
      "organizations_url": "https://api.github.com/users/CruzMolina/orgs",
      "repos_url": "https://api.github.com/users/CruzMolina/repos",
      "events_url": "https://api.github.com/users/CruzMolina/events{/privacy}",
      "received_events_url": "https://api.github.com/users/CruzMolina/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-06-10T17:18:35Z",
    "updated_at": "2019-06-10T17:18:35Z",
    "author_association": "CONTRIBUTOR",
    "body": "Are your tests still failing on the `beforeEach`?",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/500501823/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/500508051",
    "html_url": "https://github.com/trufflesuite/truffle/issues/2092#issuecomment-500508051",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/2092",
    "id": 500508051,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUwMDUwODA1MQ==",
    "user": {
      "login": "itinance",
      "id": 1758597,
      "node_id": "MDQ6VXNlcjE3NTg1OTc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1758597?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/itinance",
      "html_url": "https://github.com/itinance",
      "followers_url": "https://api.github.com/users/itinance/followers",
      "following_url": "https://api.github.com/users/itinance/following{/other_user}",
      "gists_url": "https://api.github.com/users/itinance/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/itinance/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/itinance/subscriptions",
      "organizations_url": "https://api.github.com/users/itinance/orgs",
      "repos_url": "https://api.github.com/users/itinance/repos",
      "events_url": "https://api.github.com/users/itinance/events{/privacy}",
      "received_events_url": "https://api.github.com/users/itinance/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-06-10T17:36:17Z",
    "updated_at": "2019-06-10T17:36:17Z",
    "author_association": "CONTRIBUTOR",
    "body": "@CruzMolina yes\r\n\r\nI switched completely into MintableCrowdsale of OpenZeppelin-eth from my own implementation and the same issues occur from time to time",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/500508051/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/500531663",
    "html_url": "https://github.com/trufflesuite/truffle/issues/2092#issuecomment-500531663",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/2092",
    "id": 500531663,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUwMDUzMTY2Mw==",
    "user": {
      "login": "CruzMolina",
      "id": 7537712,
      "node_id": "MDQ6VXNlcjc1Mzc3MTI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7537712?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/CruzMolina",
      "html_url": "https://github.com/CruzMolina",
      "followers_url": "https://api.github.com/users/CruzMolina/followers",
      "following_url": "https://api.github.com/users/CruzMolina/following{/other_user}",
      "gists_url": "https://api.github.com/users/CruzMolina/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/CruzMolina/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/CruzMolina/subscriptions",
      "organizations_url": "https://api.github.com/users/CruzMolina/orgs",
      "repos_url": "https://api.github.com/users/CruzMolina/repos",
      "events_url": "https://api.github.com/users/CruzMolina/events{/privacy}",
      "received_events_url": "https://api.github.com/users/CruzMolina/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-06-10T18:22:29Z",
    "updated_at": "2019-06-10T18:22:29Z",
    "author_association": "CONTRIBUTOR",
    "body": "Ah, so sometimes the `time.latest()` is a second behind the `block.timestamp` mined in the `initialize` transaction in the `beforeEach`.\r\n\r\nPerhaps it wouldn't hurt to subtract one second from `openingTime`?",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/500531663/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/500547231",
    "html_url": "https://github.com/trufflesuite/truffle/issues/2092#issuecomment-500547231",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/2092",
    "id": 500547231,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUwMDU0NzIzMQ==",
    "user": {
      "login": "itinance",
      "id": 1758597,
      "node_id": "MDQ6VXNlcjE3NTg1OTc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1758597?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/itinance",
      "html_url": "https://github.com/itinance",
      "followers_url": "https://api.github.com/users/itinance/followers",
      "following_url": "https://api.github.com/users/itinance/following{/other_user}",
      "gists_url": "https://api.github.com/users/itinance/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/itinance/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/itinance/subscriptions",
      "organizations_url": "https://api.github.com/users/itinance/orgs",
      "repos_url": "https://api.github.com/users/itinance/repos",
      "events_url": "https://api.github.com/users/itinance/events{/privacy}",
      "received_events_url": "https://api.github.com/users/itinance/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-06-10T18:58:24Z",
    "updated_at": "2019-06-10T18:58:49Z",
    "author_association": "CONTRIBUTOR",
    "body": "Hey @CruzMolina , you are right! It is the time function. \r\n\r\nWhen I change `[this line](https://github.com/itinance/ncd-token/blob/master/contracts/NCDTokenSale.sol#L39)` from\r\n\r\n`require(openingTime >= block.timestamp);`\r\n\r\nto\r\n\r\n`require(openingTime >= block.timestamp - 1);`\r\n\r\neverything works as expected!\r\n\r\nI have borrowed this line from OpenZeppelin and will open a PullRequest.\r\n\r\n**THANK YOU VERY MUCH!!!!!!!**",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/500547231/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 1,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
