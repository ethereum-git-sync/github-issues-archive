{
  "url": "https://api.github.com/repos/trufflesuite/truffle/issues/5366",
  "repository_url": "https://api.github.com/repos/trufflesuite/truffle",
  "labels_url": "https://api.github.com/repos/trufflesuite/truffle/issues/5366/labels{/name}",
  "comments_url": "https://api.github.com/repos/trufflesuite/truffle/issues/5366/comments",
  "events_url": "https://api.github.com/repos/trufflesuite/truffle/issues/5366/events",
  "html_url": "https://github.com/trufflesuite/truffle/issues/5366",
  "id": 1320335585,
  "node_id": "I_kwDOAkfq-c5Osrjh",
  "number": 5366,
  "title": "Google analytics error reporting in cli.js appears broken",
  "user": {
    "login": "benjamincburns",
    "id": 803016,
    "node_id": "MDQ6VXNlcjgwMzAxNg==",
    "avatar_url": "https://avatars.githubusercontent.com/u/803016?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/benjamincburns",
    "html_url": "https://github.com/benjamincburns",
    "followers_url": "https://api.github.com/users/benjamincburns/followers",
    "following_url": "https://api.github.com/users/benjamincburns/following{/other_user}",
    "gists_url": "https://api.github.com/users/benjamincburns/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/benjamincburns/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/benjamincburns/subscriptions",
    "organizations_url": "https://api.github.com/users/benjamincburns/orgs",
    "repos_url": "https://api.github.com/users/benjamincburns/repos",
    "events_url": "https://api.github.com/users/benjamincburns/events{/privacy}",
    "received_events_url": "https://api.github.com/users/benjamincburns/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1675041796,
      "node_id": "MDU6TGFiZWwxNjc1MDQxNzk2",
      "url": "https://api.github.com/repos/trufflesuite/truffle/labels/priority3%20%F0%9F%94%A7",
      "name": "priority3 ðŸ”§",
      "color": "006b75",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2022-07-28T03:15:32Z",
  "updated_at": "2022-10-27T21:22:19Z",
  "closed_at": null,
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "## Issue\r\n\r\nWhile working on #5335, I noticed [a chunk of code in `cli.js`](https://github.com/trufflesuite/truffle/blob/ad74c8e47ed19303be050dc18e74bcc9137c1283/packages/core/cli.js#L90-L115) that looks to be reporting error statistics back to our opt-in analytics suite. Unfortunately, I think that code is rather broken.\r\n\r\n- Nothing actually throws `TaskError`\r\n- There are no child classes of `TaskError` to be thrown, either\r\n- `TruffleError` is thrown and/or extended and thrown for all sorts of reasons, not only missing config files\r\n- Other types of errors aren't reported at all\r\n\r\nRegarding the `TruffleError` case, in the best case scenario this code is leveraging an assumption about what code paths can actually throw `TruffleError`. Even if that assumption is true today, there is nothing enforcing it, meaning that future maintenance work is likely to break it and cause us to overreport missing config errors (assuming it hasn't already).\r\n\r\n## Recommended fix\r\n\r\n- [ ] Refactor our code to stop throwing `Error` and `TruffleError` directly, and instead always throw a domain-specific subtype of `TruffleError`\r\n- [ ] Include enough metadata in the child classes of `TruffleError` so that errors can be adequately grouped by their likely underlying causes\r\n- [ ] Replace the reporting logic linked above with logic that leverages the metadata on `TruffleError` subclasses to categorize critical errors\r\n\r\nThe work from #5335 will likely be helpful with the second item, though I'd advise grouping errors by their type first (e.g. `TsNodeDependencyError` vs `ProviderError`), and in cases where the error type isn't indicative as to the cause (as is likely the case with `ProviderError`, attempt to replace those error types with more cause-specific ones.",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/5366/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/trufflesuite/truffle/issues/5366/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/1198631095",
    "html_url": "https://github.com/trufflesuite/truffle/issues/5366#issuecomment-1198631095",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/5366",
    "id": 1198631095,
    "node_id": "IC_kwDOAkfq-c5Hcai3",
    "user": {
      "login": "fainashalts",
      "id": 8952139,
      "node_id": "MDQ6VXNlcjg5NTIxMzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8952139?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fainashalts",
      "html_url": "https://github.com/fainashalts",
      "followers_url": "https://api.github.com/users/fainashalts/followers",
      "following_url": "https://api.github.com/users/fainashalts/following{/other_user}",
      "gists_url": "https://api.github.com/users/fainashalts/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fainashalts/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fainashalts/subscriptions",
      "organizations_url": "https://api.github.com/users/fainashalts/orgs",
      "repos_url": "https://api.github.com/users/fainashalts/repos",
      "events_url": "https://api.github.com/users/fainashalts/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fainashalts/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-28T21:06:09Z",
    "updated_at": "2022-07-28T21:06:09Z",
    "author_association": "MEMBER",
    "body": "I wrote the analytics code nearly 4 years ago (!), and it definitely worked when implemented, in that errors were reported to analytics for users that opted in. @benjamincburns I'm not clear from your description whether Google Analytics isn't getting the error reports, or the error handling is wrong altogether in `cli.js`. Can you clarify which you mean?\r\n\r\nIf I recall correctly, I didn't change anything about the error handling in `cli.js`, but only added an `analytics.send(...)` wherever an error happened. So I think we should be clear on what the actual problem is here. I suggest renaming this Issue to \"Error reporting in cli.js looks to be woefully broken\" if that is actually the problem.\r\n\r\nI initially moved this to backlog but then decided it probably should stay in \"Needs Followup\" until we can clarify the issue. ",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/1198631095/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/1198734656",
    "html_url": "https://github.com/trufflesuite/truffle/issues/5366#issuecomment-1198734656",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/5366",
    "id": 1198734656,
    "node_id": "IC_kwDOAkfq-c5Hcz1A",
    "user": {
      "login": "benjamincburns",
      "id": 803016,
      "node_id": "MDQ6VXNlcjgwMzAxNg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/803016?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/benjamincburns",
      "html_url": "https://github.com/benjamincburns",
      "followers_url": "https://api.github.com/users/benjamincburns/followers",
      "following_url": "https://api.github.com/users/benjamincburns/following{/other_user}",
      "gists_url": "https://api.github.com/users/benjamincburns/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/benjamincburns/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/benjamincburns/subscriptions",
      "organizations_url": "https://api.github.com/users/benjamincburns/orgs",
      "repos_url": "https://api.github.com/users/benjamincburns/repos",
      "events_url": "https://api.github.com/users/benjamincburns/events{/privacy}",
      "received_events_url": "https://api.github.com/users/benjamincburns/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-28T23:57:22Z",
    "updated_at": "2022-07-28T23:57:22Z",
    "author_association": "CONTRIBUTOR",
    "body": "No worries, @fainashalts - this is definitely an issue of code rot.\n\nJust to be clear, I think the reporting transport probably still works just fine, it's just that the statistics will be skewed at the moment due to the meaning of the error types having changed.",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/1198734656/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/1293889100",
    "html_url": "https://github.com/trufflesuite/truffle/issues/5366#issuecomment-1293889100",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/5366",
    "id": 1293889100,
    "node_id": "IC_kwDOAkfq-c5NHy5M",
    "user": {
      "login": "davidmurdoch",
      "id": 187813,
      "node_id": "MDQ6VXNlcjE4NzgxMw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/187813?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/davidmurdoch",
      "html_url": "https://github.com/davidmurdoch",
      "followers_url": "https://api.github.com/users/davidmurdoch/followers",
      "following_url": "https://api.github.com/users/davidmurdoch/following{/other_user}",
      "gists_url": "https://api.github.com/users/davidmurdoch/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/davidmurdoch/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/davidmurdoch/subscriptions",
      "organizations_url": "https://api.github.com/users/davidmurdoch/orgs",
      "repos_url": "https://api.github.com/users/davidmurdoch/repos",
      "events_url": "https://api.github.com/users/davidmurdoch/events{/privacy}",
      "received_events_url": "https://api.github.com/users/davidmurdoch/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-10-27T18:08:18Z",
    "updated_at": "2022-10-27T18:08:18Z",
    "author_association": "MEMBER",
    "body": "@benjamincburns We're triaging this in ticket processing and it isn't clear what you think we should do about this? Should we move it to Backlog or should we keep it in Needs Followup in order to encourage more discussion?",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/1293889100/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/1294068317",
    "html_url": "https://github.com/trufflesuite/truffle/issues/5366#issuecomment-1294068317",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/5366",
    "id": 1294068317,
    "node_id": "IC_kwDOAkfq-c5NIepd",
    "user": {
      "login": "benjamincburns",
      "id": 803016,
      "node_id": "MDQ6VXNlcjgwMzAxNg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/803016?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/benjamincburns",
      "html_url": "https://github.com/benjamincburns",
      "followers_url": "https://api.github.com/users/benjamincburns/followers",
      "following_url": "https://api.github.com/users/benjamincburns/following{/other_user}",
      "gists_url": "https://api.github.com/users/benjamincburns/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/benjamincburns/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/benjamincburns/subscriptions",
      "organizations_url": "https://api.github.com/users/benjamincburns/orgs",
      "repos_url": "https://api.github.com/users/benjamincburns/repos",
      "events_url": "https://api.github.com/users/benjamincburns/events{/privacy}",
      "received_events_url": "https://api.github.com/users/benjamincburns/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-10-27T21:14:20Z",
    "updated_at": "2022-10-27T21:22:19Z",
    "author_association": "CONTRIBUTOR",
    "body": "Sorry, I think I discussed this one offline with Faina but never circled back to update the ticket.\r\n\r\nThe issue as I see it isn't that the GA client code is broken. Rather the issue is that the top-level logic within `cli.js` that's required to actually trigger an error to be reported via that client seems to be broken for the reasons that I documented in the original description.\r\n\r\nThe code that I linked in the original description seems to be only reporting occurrences of `TaskError`, `TruffleError`, and number errors (edit: we do also handle the base `Error` type - sorry that I missed that on my first read through).\r\n\r\nTo repeat my original description with a bit more detail:\r\n\r\n- The reporting for `TruffleError` assumes that it only ever occurs due to an issue with `@truffle/config`, however we throw `TruffleError` for all sorts of reasons in our codebase.\r\n- The reporting for `TaskError` is dead code, as `TaskError` is never thrown from the `try` block\r\n- I wasn't able to find any cases where we throw an instance of `number`, so that code block is likely also dead\r\n- ~~We aren't diligent about always throwing instances of specific error types, so any instances of the base `Error` type that get caught by this `catch` block will go unreported.~~\r\n\r\nAs for what I think should be done as a result of this issue, I think I already covered that in the \"Recommended fix\" section of the original issue description.",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/1294068317/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/1294076223",
    "html_url": "https://github.com/trufflesuite/truffle/issues/5366#issuecomment-1294076223",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/5366",
    "id": 1294076223,
    "node_id": "IC_kwDOAkfq-c5NIgk_",
    "user": {
      "login": "benjamincburns",
      "id": 803016,
      "node_id": "MDQ6VXNlcjgwMzAxNg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/803016?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/benjamincburns",
      "html_url": "https://github.com/benjamincburns",
      "followers_url": "https://api.github.com/users/benjamincburns/followers",
      "following_url": "https://api.github.com/users/benjamincburns/following{/other_user}",
      "gists_url": "https://api.github.com/users/benjamincburns/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/benjamincburns/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/benjamincburns/subscriptions",
      "organizations_url": "https://api.github.com/users/benjamincburns/orgs",
      "repos_url": "https://api.github.com/users/benjamincburns/repos",
      "events_url": "https://api.github.com/users/benjamincburns/events{/privacy}",
      "received_events_url": "https://api.github.com/users/benjamincburns/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-10-27T21:20:29Z",
    "updated_at": "2022-10-27T21:20:29Z",
    "author_association": "CONTRIBUTOR",
    "body": "Ah sorry, I just noticed the final `else` condition that does handle the base `Error` case, however I think the other concerns (especially the one about `TruffleError` as it relates to config issues) are still valid.",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/1294076223/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
