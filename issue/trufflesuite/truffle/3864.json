{
  "url": "https://api.github.com/repos/trufflesuite/truffle/issues/3864",
  "repository_url": "https://api.github.com/repos/trufflesuite/truffle",
  "labels_url": "https://api.github.com/repos/trufflesuite/truffle/issues/3864/labels{/name}",
  "comments_url": "https://api.github.com/repos/trufflesuite/truffle/issues/3864/comments",
  "events_url": "https://api.github.com/repos/trufflesuite/truffle/issues/3864/events",
  "html_url": "https://github.com/trufflesuite/truffle/issues/3864",
  "id": 813125089,
  "node_id": "MDU6SXNzdWU4MTMxMjUwODk=",
  "number": 3864,
  "title": "Debugger: msg.value not updating ",
  "user": {
    "login": "zach-is-my-name",
    "id": 16063092,
    "node_id": "MDQ6VXNlcjE2MDYzMDky",
    "avatar_url": "https://avatars.githubusercontent.com/u/16063092?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/zach-is-my-name",
    "html_url": "https://github.com/zach-is-my-name",
    "followers_url": "https://api.github.com/users/zach-is-my-name/followers",
    "following_url": "https://api.github.com/users/zach-is-my-name/following{/other_user}",
    "gists_url": "https://api.github.com/users/zach-is-my-name/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/zach-is-my-name/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/zach-is-my-name/subscriptions",
    "organizations_url": "https://api.github.com/users/zach-is-my-name/orgs",
    "repos_url": "https://api.github.com/users/zach-is-my-name/repos",
    "events_url": "https://api.github.com/users/zach-is-my-name/events{/privacy}",
    "received_events_url": "https://api.github.com/users/zach-is-my-name/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2021-02-22T05:14:50Z",
  "updated_at": "2021-02-23T03:41:07Z",
  "closed_at": "2021-02-23T03:33:24Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "Below you'll see that ```web3CallWithTruffleContract()``` produces transaction ```txHash```\r\n\r\nWhen I running Truffle debugger on ```txHash``` The msg property value === 1 **before each** require, despite that msg.value changing after the first external sub-call.  Initially, I didn't know why the transaction was failing because the debugger reverted before entering the second ```sendValue``` call, and I thought msg.value was fixed for the duration of the transaction (although now I know it isn't, and it's clear why).  Despite all this msg.value display doesn't (or at least didn't) change to reflect the actual msg.value for that message call.\r\n\r\n```\r\ncontract KnownContract {\r\n  function sendValue(uint gaslimit, uint gasprice) external payable {\r\n     require(msg.value == gaslimit *gasprice, \"msg.value must == gaslimit * gasprice);\r\n     address someAddress = 0x55... ;\r\n     someAddress.transfer(gaslimit * gasprice);     \r\n  }\r\n}\r\n\r\ncontract Contract {\r\n\r\nKnownContract knownContract\r\n\r\n  function() payable external {}\r\n  function callKnownContract(uint gaslimit, uint gasprice) public payable {  \r\n    knownContract = KnownContract(0x10...);\r\n    knownContract.sendValue(gaslimit * gasprice)(gaslimit, gasprice);\r\n    knownContract.sendValue(gaslimit * gasprice)(gaslimit, gasprice);\r\n\r\n  }\r\n  \r\n\r\n}\r\n\r\n\r\nfunction web3CallWithTruffleContract(gaslimit, gasprice) {\r\n   Contract.callKnownContract(gaslimit, gasprice, {value: 100})\r\n}  \r\n\r\n   web3CallWithTruffleContract(10, 10)\r\n\r\n```\r\n\r\n\r\n* Operating System: ubuntu 20.04\r\nTruffle v5.1.66 (core: 5.1.66)\r\nSolidity - 0.5.1 (solc-js)\r\nNode v12.6.0\r\nWeb3.js v1.2.9\r\n",
  "closed_by": {
    "login": "zach-is-my-name",
    "id": 16063092,
    "node_id": "MDQ6VXNlcjE2MDYzMDky",
    "avatar_url": "https://avatars.githubusercontent.com/u/16063092?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/zach-is-my-name",
    "html_url": "https://github.com/zach-is-my-name",
    "followers_url": "https://api.github.com/users/zach-is-my-name/followers",
    "following_url": "https://api.github.com/users/zach-is-my-name/following{/other_user}",
    "gists_url": "https://api.github.com/users/zach-is-my-name/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/zach-is-my-name/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/zach-is-my-name/subscriptions",
    "organizations_url": "https://api.github.com/users/zach-is-my-name/orgs",
    "repos_url": "https://api.github.com/users/zach-is-my-name/repos",
    "events_url": "https://api.github.com/users/zach-is-my-name/events{/privacy}",
    "received_events_url": "https://api.github.com/users/zach-is-my-name/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/3864/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/trufflesuite/truffle/issues/3864/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/783642980",
    "html_url": "https://github.com/trufflesuite/truffle/issues/3864#issuecomment-783642980",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/3864",
    "id": 783642980,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc4MzY0Mjk4MA==",
    "user": {
      "login": "haltman-at",
      "id": 35589221,
      "node_id": "MDQ6VXNlcjM1NTg5MjIx",
      "avatar_url": "https://avatars.githubusercontent.com/u/35589221?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/haltman-at",
      "html_url": "https://github.com/haltman-at",
      "followers_url": "https://api.github.com/users/haltman-at/followers",
      "following_url": "https://api.github.com/users/haltman-at/following{/other_user}",
      "gists_url": "https://api.github.com/users/haltman-at/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/haltman-at/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/haltman-at/subscriptions",
      "organizations_url": "https://api.github.com/users/haltman-at/orgs",
      "repos_url": "https://api.github.com/users/haltman-at/repos",
      "events_url": "https://api.github.com/users/haltman-at/events{/privacy}",
      "received_events_url": "https://api.github.com/users/haltman-at/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-02-22T20:10:59Z",
    "updated_at": "2021-02-22T20:21:10Z",
    "author_association": "CONTRIBUTOR",
    "body": "Oh, huh.  But, I'm a bit confused as to what exactly the issue is here.  You say that `msg.value` is showing the wrong value -- where is it showing the wrong value?  In the `sendValue` call?  What should it be, and what is it showing instead?  I'm a little confused here.\r\n\r\nI can try to reproduce this, but I'd like to have a clearer explanation of just what the error is supposed to be here.\r\n\r\n(Also, your code is also a bit confusing because you seem to have Solidity and JS mixed together, it took me a moment to piece that together; you might want to make it clearer what is what -- what's a Solidity contract you wrote vs what's a JS script you executed; it would make the issue easier to understand.)",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/783642980/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/783662207",
    "html_url": "https://github.com/trufflesuite/truffle/issues/3864#issuecomment-783662207",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/3864",
    "id": 783662207,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc4MzY2MjIwNw==",
    "user": {
      "login": "haltman-at",
      "id": 35589221,
      "node_id": "MDQ6VXNlcjM1NTg5MjIx",
      "avatar_url": "https://avatars.githubusercontent.com/u/35589221?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/haltman-at",
      "html_url": "https://github.com/haltman-at",
      "followers_url": "https://api.github.com/users/haltman-at/followers",
      "following_url": "https://api.github.com/users/haltman-at/following{/other_user}",
      "gists_url": "https://api.github.com/users/haltman-at/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/haltman-at/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/haltman-at/subscriptions",
      "organizations_url": "https://api.github.com/users/haltman-at/orgs",
      "repos_url": "https://api.github.com/users/haltman-at/repos",
      "events_url": "https://api.github.com/users/haltman-at/events{/privacy}",
      "received_events_url": "https://api.github.com/users/haltman-at/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-02-22T20:43:37Z",
    "updated_at": "2021-02-22T20:43:37Z",
    "author_association": "CONTRIBUTOR",
    "body": "OK, on trying this out myself, I'm not seeing any problem here.  `msg.value` remains at 100 throughout, as it should.  From your original issue report, you seem to be implying that `msg.value` should decrease after sending ether?  That's incorrect; `msg.value` refers to the amount of wei sent to the current call; it remains constant throughout each EVM stackframe.  It can change during a transaction if you make an external call, as you do here, but it will return to its previous value once that external call exits.  In this case, all your external calls are sent with 100 wei, so `msg.value` remains at 100 throughout, and the debugger correctly reflects this.\r\n\r\nI think the confusion here is coming from the fact that the transaction reverts.  The transaction isn't reverting here because of the second `require`; it's reverting because you don't have enough ether to make the second call.  Note that the revert happens before it ever reaches that second require.  Indeed, you note this yourself.\r\n\r\nSo, as best I can tell, there's no issue here.  Am I mistaken?  Apologies, I've had to rely a bit on inference as your issue is a bit unclear, but I'm pretty sure all that's going on here is that `msg.value` doesn't work how you thought it worked.  Let me know if I'm wrong and there is an actual problem here.\r\n\r\nNote that Solidity globally-available variables basically all just correspond to some EVM opcode; in this case, it's the `CALLVALUE` opcode.  The EVM doesn't provide the functionality to track the current call value minus any ether sent, nor does Solidity provide that functionality on top of it.",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/783662207/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/783854151",
    "html_url": "https://github.com/trufflesuite/truffle/issues/3864#issuecomment-783854151",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/3864",
    "id": 783854151,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc4Mzg1NDE1MQ==",
    "user": {
      "login": "zach-is-my-name",
      "id": 16063092,
      "node_id": "MDQ6VXNlcjE2MDYzMDky",
      "avatar_url": "https://avatars.githubusercontent.com/u/16063092?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/zach-is-my-name",
      "html_url": "https://github.com/zach-is-my-name",
      "followers_url": "https://api.github.com/users/zach-is-my-name/followers",
      "following_url": "https://api.github.com/users/zach-is-my-name/following{/other_user}",
      "gists_url": "https://api.github.com/users/zach-is-my-name/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/zach-is-my-name/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/zach-is-my-name/subscriptions",
      "organizations_url": "https://api.github.com/users/zach-is-my-name/orgs",
      "repos_url": "https://api.github.com/users/zach-is-my-name/repos",
      "events_url": "https://api.github.com/users/zach-is-my-name/events{/privacy}",
      "received_events_url": "https://api.github.com/users/zach-is-my-name/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-02-23T03:39:55Z",
    "updated_at": "2021-02-23T03:41:07Z",
    "author_association": "NONE",
    "body": "Yes, that's all clear, thank you.  I didn't really expect there to be an issue with the debugger's msg.value, but on the other hand I was profoundly confused why for instance, sending _enough_ ether would make it appear that the debugger's displayed msg.value directly contradict the require's, yet the tx succeeds. And conversely matching msg.value from the debugger to require condition would cause it revert",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/783854151/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
