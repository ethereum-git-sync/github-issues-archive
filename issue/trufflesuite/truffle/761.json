{
  "url": "https://api.github.com/repos/trufflesuite/truffle/issues/761",
  "repository_url": "https://api.github.com/repos/trufflesuite/truffle",
  "labels_url": "https://api.github.com/repos/trufflesuite/truffle/issues/761/labels{/name}",
  "comments_url": "https://api.github.com/repos/trufflesuite/truffle/issues/761/comments",
  "events_url": "https://api.github.com/repos/trufflesuite/truffle/issues/761/events",
  "html_url": "https://github.com/trufflesuite/truffle/issues/761",
  "id": 290935545,
  "node_id": "MDU6SXNzdWUyOTA5MzU1NDU=",
  "number": 761,
  "title": "JS promises not always rejected when require()/assert() conditions not met.",
  "user": {
    "login": "rickbatka",
    "id": 6570118,
    "node_id": "MDQ6VXNlcjY1NzAxMTg=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6570118?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/rickbatka",
    "html_url": "https://github.com/rickbatka",
    "followers_url": "https://api.github.com/users/rickbatka/followers",
    "following_url": "https://api.github.com/users/rickbatka/following{/other_user}",
    "gists_url": "https://api.github.com/users/rickbatka/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/rickbatka/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rickbatka/subscriptions",
    "organizations_url": "https://api.github.com/users/rickbatka/orgs",
    "repos_url": "https://api.github.com/users/rickbatka/repos",
    "events_url": "https://api.github.com/users/rickbatka/events{/privacy}",
    "received_events_url": "https://api.github.com/users/rickbatka/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2018-01-23T17:55:22Z",
  "updated_at": "2018-01-24T15:26:13Z",
  "closed_at": "2018-01-24T15:26:13Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "- [x ] I've asked for help in the [Truffle Gitter](http://gitter.im/Consensys/truffle) before filing this issue.\r\n\r\n---------------------------\r\n\r\n## Issue\r\n\r\nI have a reproducible example of a contract with 2 functions with require() clauses as their first line of code. I call the 2 functions one after another from my js tests. If the conditions are not met for the first require(), the promise is rejected (as expected) and I can access the rejected promise to see what went wrong. However, if I pass the first function's require() test, and subsequently fail the second one, I can see that the second method is not executed - **but the promise is not rejected.** It seems dependent on there being multiple calls to functions with require() or assert(), because in my tests if I comment out one or the other, the behavior works as expected and then one that remains will cause a promise rejection.\r\n\r\nSee my attached example project. Relevant code snippets below.\r\n\r\nAs I understand it, truffle js tests should reject promises if the web3 call results in a thrown exception. Am I wrong? Is there some place where this behavior is thoroughly documented?\r\n\r\n## Steps to Reproduce\r\n\r\nRelevant snippets from attached project:\r\n\r\n**Contract definition**:\r\n```\r\n...\r\nfunction TruffleBug() public payable {\r\n        require(msg.value > 0);\r\n        owner = msg.sender;\r\n    }\r\n\r\n    function doSomethingForMoney() public payable returns (bool) {\r\n        require(msg.value > 0);\r\n        return true;\r\n    }\r\n\r\n    function ownerDoSomething() public payable returns (bool) {\r\n        require(msg.sender == owner);\r\n        return true;\r\n    }\r\n...\r\n```\r\n\r\n**One of the failing test cases**:\r\n```\r\n ...\r\nit('FAILURE CASE 2: illustrates another example where \"require\" is ignored', async function(){\r\n        let tb1 = await (TruffleBug.new({value: 1, from: accounts[0]}));\r\n        assert.equal(1, web3.eth.getBalance(tb1.address));\r\n\r\n        let workHappened = false;\r\n        let thrown = false;\r\n        try{\r\n            // SHOULD throw, because we are not the owner\r\n            workHappened = await tb1.ownerDoSomething({value: 1, from: accounts[1]});\r\n        } catch (e) {\r\n            thrown = true;\r\n        }\r\n        // balance is still 1, because the call to tb1.ownerDoSomething() failed and the funds were refunded...\r\n        assert.equal(1, web3.eth.getBalance(tb1.address));\r\n\r\n        // Incorrect behavior, test fails - ... the promise was not rejected, despite the rollback.\r\n        assert.isTrue(thrown);\r\n    });\r\n...\r\n```\r\n\r\n## Expected Behavior\r\n\r\nIf a require() or assert() condition is not met and a rollback occurs, I expect the JS promise to be rejected.\r\n\r\n## Actual Results\r\n\r\nIf multiple require() or assert() calls happen one after another, _and the first one passes_, the subsequent ones won't trigger a promise rejection even when the function calls are rolled back / refunded.\r\n\r\nPlease see attached project. First test case illustrates expected behavior working correctly, second and third cases illustrate what happens when multiple functions with require() are called back to back and the first passes, but the second fails.\r\n\r\n## Environment\r\n\r\n* Operating System: Windows 10\r\n* Truffle version: 4.0.5\r\n* Ethereum client: Ganache\r\n* node version: 8.9.1\r\n* npm version: 5.5.1\r\n[truffle-bug.zip](https://github.com/trufflesuite/truffle/files/1657040/truffle-bug.zip)\r\n\r\n",
  "closed_by": {
    "login": "rickbatka",
    "id": 6570118,
    "node_id": "MDQ6VXNlcjY1NzAxMTg=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6570118?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/rickbatka",
    "html_url": "https://github.com/rickbatka",
    "followers_url": "https://api.github.com/users/rickbatka/followers",
    "following_url": "https://api.github.com/users/rickbatka/following{/other_user}",
    "gists_url": "https://api.github.com/users/rickbatka/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/rickbatka/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rickbatka/subscriptions",
    "organizations_url": "https://api.github.com/users/rickbatka/orgs",
    "repos_url": "https://api.github.com/users/rickbatka/repos",
    "events_url": "https://api.github.com/users/rickbatka/events{/privacy}",
    "received_events_url": "https://api.github.com/users/rickbatka/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/761/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/trufflesuite/truffle/issues/761/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/360012479",
    "html_url": "https://github.com/trufflesuite/truffle/issues/761#issuecomment-360012479",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/761",
    "id": 360012479,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM2MDAxMjQ3OQ==",
    "user": {
      "login": "cgewecke",
      "id": 7332026,
      "node_id": "MDQ6VXNlcjczMzIwMjY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7332026?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cgewecke",
      "html_url": "https://github.com/cgewecke",
      "followers_url": "https://api.github.com/users/cgewecke/followers",
      "following_url": "https://api.github.com/users/cgewecke/following{/other_user}",
      "gists_url": "https://api.github.com/users/cgewecke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cgewecke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cgewecke/subscriptions",
      "organizations_url": "https://api.github.com/users/cgewecke/orgs",
      "repos_url": "https://api.github.com/users/cgewecke/repos",
      "events_url": "https://api.github.com/users/cgewecke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cgewecke/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-01-24T03:48:24Z",
    "updated_at": "2018-01-24T03:48:24Z",
    "author_association": "CONTRIBUTOR",
    "body": "@rickbatka Hi, thank you for providing such an easy way to reproduce this issue. Unfortunately, when I run your code on Truffle `4.0.5` using the `truffle test` command, it behaves as expected - e.g `thrown` is set to true in the example above. All the tests in the zip file pass. \r\n\r\nHow are you executing the tests? \r\n",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/360012479/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/360022260",
    "html_url": "https://github.com/trufflesuite/truffle/issues/761#issuecomment-360022260",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/761",
    "id": 360022260,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM2MDAyMjI2MA==",
    "user": {
      "login": "rickbatka",
      "id": 6570118,
      "node_id": "MDQ6VXNlcjY1NzAxMTg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6570118?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rickbatka",
      "html_url": "https://github.com/rickbatka",
      "followers_url": "https://api.github.com/users/rickbatka/followers",
      "following_url": "https://api.github.com/users/rickbatka/following{/other_user}",
      "gists_url": "https://api.github.com/users/rickbatka/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rickbatka/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rickbatka/subscriptions",
      "organizations_url": "https://api.github.com/users/rickbatka/orgs",
      "repos_url": "https://api.github.com/users/rickbatka/repos",
      "events_url": "https://api.github.com/users/rickbatka/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rickbatka/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-01-24T05:07:00Z",
    "updated_at": "2018-01-24T05:07:00Z",
    "author_association": "NONE",
    "body": "Hmm, I’m just running “truffle test” (on windows, using ganache). Is there\nanything else that might factor into it, besides truffle version? What\nabout solidity compiler version? I noticed there is a newer minor version\nthan what I was using, maybe tomorrow I will try updating that and see if I\nget the same results.\nOn Tue, Jan 23, 2018 at 10:48 PM c-g-e-w-e-k-e-> <notifications@github.com>\nwrote:\n\n> @rickbatka <https://github.com/rickbatka> Hi, thank you for providing\n> such an easy way to reproduce this issue. Unfortunately, when I run your\n> code on Truffle 4.0.5 using the truffle test command, it behaves as\n> expected - e.g thrown is set to true in the example above. All the tests\n> in the zip file pass.\n>\n> How are you executing the tests?\n>\n> —\n> You are receiving this because you were mentioned.\n> Reply to this email directly, view it on GitHub\n> <https://github.com/trufflesuite/truffle/issues/761#issuecomment-360012479>,\n> or mute the thread\n> <https://github.com/notifications/unsubscribe-auth/AGRAhl1JZsBmncBoZ5wFJXePYfl7hyTbks5tNqgMgaJpZM4RqDwO>\n> .\n>\n",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/360022260/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/360035459",
    "html_url": "https://github.com/trufflesuite/truffle/issues/761#issuecomment-360035459",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/761",
    "id": 360035459,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM2MDAzNTQ1OQ==",
    "user": {
      "login": "cgewecke",
      "id": 7332026,
      "node_id": "MDQ6VXNlcjczMzIwMjY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7332026?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cgewecke",
      "html_url": "https://github.com/cgewecke",
      "followers_url": "https://api.github.com/users/cgewecke/followers",
      "following_url": "https://api.github.com/users/cgewecke/following{/other_user}",
      "gists_url": "https://api.github.com/users/cgewecke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cgewecke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cgewecke/subscriptions",
      "organizations_url": "https://api.github.com/users/cgewecke/orgs",
      "repos_url": "https://api.github.com/users/cgewecke/repos",
      "events_url": "https://api.github.com/users/cgewecke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cgewecke/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-01-24T06:39:21Z",
    "updated_at": "2018-01-24T06:42:50Z",
    "author_association": "CONTRIBUTOR",
    "body": "@rickbatka if you've been running the ganache beta recently it's possible you would see this behavior, although I believe the latest version would pass your tests. Ganache has added a mode that replicates the way the geth and parity report errors and there's been a little uncertainty about how to manage that at Truffle / set the defaults at ganache. The release note at ganache contains a more detailed explanation.",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/360035459/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/360170246",
    "html_url": "https://github.com/trufflesuite/truffle/issues/761#issuecomment-360170246",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/761",
    "id": 360170246,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM2MDE3MDI0Ng==",
    "user": {
      "login": "rickbatka",
      "id": 6570118,
      "node_id": "MDQ6VXNlcjY1NzAxMTg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6570118?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rickbatka",
      "html_url": "https://github.com/rickbatka",
      "followers_url": "https://api.github.com/users/rickbatka/followers",
      "following_url": "https://api.github.com/users/rickbatka/following{/other_user}",
      "gists_url": "https://api.github.com/users/rickbatka/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rickbatka/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rickbatka/subscriptions",
      "organizations_url": "https://api.github.com/users/rickbatka/orgs",
      "repos_url": "https://api.github.com/users/rickbatka/repos",
      "events_url": "https://api.github.com/users/rickbatka/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rickbatka/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-01-24T15:26:12Z",
    "updated_at": "2018-01-24T15:26:12Z",
    "author_association": "NONE",
    "body": "Thanks @cgewecke for taking the time to look into this! Sure enough, changing Ganache versions fixed it.\r\n\r\nHopefully this helps any Googlers out there running into the same problem:\r\n\r\n**Problem:** Promises intermittently not being rejected (exceptions not being thrown) when require() or assert() conditions are not met. \r\n\r\n**Symptom:** Execution is rolled back, but no exception is raised / promise is not rejected (no way to tell if the code executed successfully without checking for known side effects or looking at transaction log).\r\n\r\n**Solution:** As of today, the latest release of Ganache (1.1.0-beta.0) (also labelled 1.2.0-beta.0 Candy Apple) exhibits this bug. Uninstalling it and installing v1.0.2 \"Heart Surgery\" fixed it for me.\r\n\r\nI will see about reporting this over at Ganache when I get some more time to work on this.",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/360170246/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
