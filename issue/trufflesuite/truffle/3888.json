{
  "url": "https://api.github.com/repos/trufflesuite/truffle/issues/3888",
  "repository_url": "https://api.github.com/repos/trufflesuite/truffle",
  "labels_url": "https://api.github.com/repos/trufflesuite/truffle/issues/3888/labels{/name}",
  "comments_url": "https://api.github.com/repos/trufflesuite/truffle/issues/3888/comments",
  "events_url": "https://api.github.com/repos/trufflesuite/truffle/issues/3888/events",
  "html_url": "https://github.com/trufflesuite/truffle/issues/3888",
  "id": 817739210,
  "node_id": "MDU6SXNzdWU4MTc3MzkyMTA=",
  "number": 3888,
  "title": "Why does truffle deployment to mainnet fail?",
  "user": {
    "login": "stoplion",
    "id": 231343,
    "node_id": "MDQ6VXNlcjIzMTM0Mw==",
    "avatar_url": "https://avatars.githubusercontent.com/u/231343?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/stoplion",
    "html_url": "https://github.com/stoplion",
    "followers_url": "https://api.github.com/users/stoplion/followers",
    "following_url": "https://api.github.com/users/stoplion/following{/other_user}",
    "gists_url": "https://api.github.com/users/stoplion/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/stoplion/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/stoplion/subscriptions",
    "organizations_url": "https://api.github.com/users/stoplion/orgs",
    "repos_url": "https://api.github.com/users/stoplion/repos",
    "events_url": "https://api.github.com/users/stoplion/events{/privacy}",
    "received_events_url": "https://api.github.com/users/stoplion/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2021-02-26T23:05:13Z",
  "updated_at": "2021-05-26T18:05:31Z",
  "closed_at": "2021-05-26T18:05:31Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "- [x] I've asked for help in the [Truffle Gitter](http://gitter.im/Consensys/truffle) before filing this issue.\r\n\r\n---------------------------\r\n[Also asked this question on SO.](https://stackoverflow.com/questions/66394390/why-is-it-impossible-to-deploy-a-smart-contract-to-mainnet-using-truffle). And [this one](https://stackoverflow.com/questions/66415529/truffle-deploy-insufficient-funds-despite-using-truffles-total-price-estimates)\r\n\r\nWhen I deploy with Truffle it asks for almost 1 ETH in upfront cost to deploy\r\n\r\nIt fails with `\"Migrations\" could not deploy due to insufficient funds`, but according to the `dry-run` I have enough Eth to deploy.\r\n\r\nI've deployed the same contract with Remix and it costs $135 in Eth. \r\n\r\n**Estimate the cost of deploying to Mainnet**\r\n`NODE_ENV=production truffle migrate --network mainnet --reset --dry-run`\r\n\r\n```\r\nSummary\r\n=======\r\n> Total deployments:   2\r\n> Final cost:          0.0701912 ETH\r\n```\r\n\r\n(That about $100. I have that in my wallet)\r\n\r\nTry without `--dry-run`\r\n`NODE_ENV=production truffle migrate --network mainnet --reset`\r\n\r\n`\"Migrations\" could not deploy due to insufficient funds`\r\n\r\nWhy does this happen? \r\n\r\nTruffle-config\r\n```\r\nconst path = require(\"path\");\r\nconst dotenv = require(\"dotenv-flow\");\r\nconst dotenvExpand = require(\"dotenv-expand\");\r\nconst HDWalletProvider = require(\"@truffle/hdwallet-provider\");\r\n\r\nconst pathToConfig = path.resolve(\"./env\");\r\n\r\nconst env = dotenv.config({\r\n  path: pathToConfig,\r\n});\r\n\r\ndotenvExpand(env);\r\n\r\nmodule.exports = {\r\n  networks: {\r\n    contracts_build_directory: \"./client/src/contracts\",\r\n\r\n    teams: {\r\n      url:\r\n        \"https://sandbox.truffleteams.com/df027e94-8bfc-4af8-82de-0205db77e32c\",\r\n      network_id: 1,\r\n    },\r\n\r\n    development: {\r\n      host: \"127.0.0.1\", // Localhost (default: none)\r\n      port: 7545, // Standard Ethereum port (default: none)\r\n      network_id: \"*\", // Any network (default: none)\r\n      gas: 10000000,\r\n      gasLimit: 26000000000,\r\n    },\r\n\r\n    kovan: {\r\n      provider: () =>\r\n        new HDWalletProvider({\r\n          mnemonic: { phrase: process.env.MNEMONIC },\r\n          providerOrUrl: process.env.RPC_URL_42,\r\n        }),\r\n      network_id: 42, // Kovan's id\r\n      from: process.env.DEPLOYERS_ADDRESS,\r\n    },\r\n\r\n    mainnet: {\r\n      provider: () =>\r\n        new HDWalletProvider({\r\n          mnemonic: { phrase: process.env.MNEMONIC },\r\n          providerOrUrl: process.env.RPC_URL_1_WSS,\r\n        }),\r\n      network_id: 1, // Main's id\r\n      from: process.env.DEPLOYERS_ADDRESS,\r\n      gas: 3000000, // Gas limit used for deploys. Default is 4712388.\r\n      gasPrice: 165000000000, //Gas price in Wei\r\n      confirmations: 2, // # of confs to wait between deployments. (default: 0)\r\n      timeoutBlocks: 200, // # of blocks before a deployment times out  (minimum/default: 50)\r\n      skipDryRun: false, // Skip dry run before migrations? (default: false for public nets )\r\n    },\r\n  },\r\n\r\n  // Set default mocha options here, use special reporters etc.\r\n  mocha: {\r\n    timeout: 100000,\r\n  },\r\n\r\n  // Configure your compilers\r\n  contracts_build_directory: path.join(__dirname, \"client/src/contracts\"),\r\n  compilers: {\r\n    solc: {\r\n      version: \"0.7.4\", // Fetch exact version from solc-bin (default: truffle's version)\r\n      settings: {          // See the solidity docs for advice about optimization and evmVersion\r\n        optimizer: {\r\n          enabled: true,\r\n          // Optimize for how many times you intend to run the code.\r\n          // Lower values will optimize more for initial deployment cost, higher\r\n          // values will optimize more for high-frequency usage.\r\n          runs: 200\r\n        },\r\n      },\r\n    },\r\n  },\r\n};\r\n```\r\n\r\n\r\n**Contract**\r\n```\r\n// SPDX-License-Identifier: MIT\r\npragma solidity ^0.7.4;\r\n\r\nimport \"@chainlink/contracts/src/v0.6/interfaces/AggregatorV3Interface.sol\";\r\nimport \"@openzeppelin/contracts/math/SafeMath.sol\";\r\n\r\n\r\ncontract EthText {\r\n  address payable public owner;\r\n  uint public messagesSentCount = 0;\r\n\r\n  uint decimals = 8;\r\n  uint scale = 10**decimals;\r\n\r\n  uint public txtPriceUSD = 1.70 * 10**8;\r\n  uint public txtPriceEth;\r\n\r\n  using SafeMath for uint;\r\n\r\n  AggregatorV3Interface internal priceFeed;\r\n\r\n  event Spend(\r\n    string textMsg,\r\n    string recipient\r\n  );\r\n  event TextMsgError(\r\n    string reason\r\n  );\r\n\r\n  constructor(address oracleAddress) {\r\n    owner = msg.sender;\r\n    priceFeed = AggregatorV3Interface(oracleAddress);\r\n  }\r\n\r\n  function sendTextMessage(\r\n    string calldata textMsg,\r\n    string calldata recipient\r\n  ) external payable returns(bool) {\r\n\r\n    (uint newTxtPriceEth,,) = this.pollTxtPrices();\r\n\r\n    require(\r\n      msg.value > newTxtPriceEth,\r\n      'Please send the correct amount of ETH to make send a message'\r\n    );\r\n\r\n    emit Spend(textMsg, recipient);\r\n    messagesSentCount += 1;\r\n    return true;\r\n  }\r\n\r\n  function setTxtPrices(uint _txtPriceUSD) external ownerOnly() {\r\n    (int price,) = getLatestPrice();\r\n    uint ethPriceUSD = uint(price);\r\n\r\n    txtPriceEth = scale.mul(_txtPriceUSD).div(ethPriceUSD);\r\n    txtPriceUSD = _txtPriceUSD;\r\n  }\r\n\r\n  function pollTxtPrices() external view returns(uint, uint, uint) {\r\n    (int price,) = getLatestPrice();\r\n\r\n    uint newTxtPriceEth = scale.mul(txtPriceUSD).div(uint(price));\r\n\r\n    return (newTxtPriceEth, txtPriceUSD, decimals);\r\n  }\r\n\r\n  function totalBalance() external view returns(uint) {\r\n    return payable(address(this)).balance;\r\n  }\r\n\r\n  function withdrawFunds() external ownerOnly() {\r\n    msg.sender.transfer(this.totalBalance());\r\n  }\r\n\r\n  function destroy() external ownerOnly() {\r\n    selfdestruct(owner);\r\n  }\r\n\r\n  function getLatestPrice() public view returns (int, uint) {\r\n    (\r\n      ,int price,,,\r\n    ) = priceFeed.latestRoundData();\r\n\r\n    return (price, decimals);\r\n  }\r\n\r\n  modifier ownerOnly() {\r\n    require(msg.sender == owner, 'only owner can call this');\r\n    _;\r\n  }\r\n}\r\n```\r\n\r\n\r\n\r\n**Why is deploying to Mainnet using Truffle so difficult?**\r\n\r\nHere is a rundown of trying to deploy to Mainnet...\r\n\r\n1. Current Gasprice is 110 Wei. Therefore `110000000000 wei`\r\n\r\nLet's plug that in..\r\n\r\n```\r\nmainnet: {\r\n      provider: () =>\r\n        new HDWalletProvider({\r\n          mnemonic: { phrase: process.env.MNEMONIC },\r\n          providerOrUrl: process.env.RPC_URL_1_WSS,\r\n        }),\r\n      network_id: 1, \r\n      from: process.env.DEPLOYERS_ADDRESS,\r\n      gasPrice: 110000000000, /*  GAS PRICE!! */\r\n      confirmations: 2,\r\n      timeoutBlocks: 200,\r\n      skipDryRun: false, public nets )\r\n    },\r\n  },\r\n```\r\n\r\n2. Let's get the gas cost estimate of deploying. This will be set in `gas` parameter of `truffle-config`.\r\n\r\n`NODE_ENV=production truffle migrate --network mainnet --dry-run`\r\n\r\n```\r\nSummary\r\n=======\r\n> Total deployments:   2\r\n> Final cost:          0.001403824 ETH\r\n```\r\n\r\n0.001403824 ETH is $2.04.      \r\nSo that's probably wrong.      \r\n \r\n**‼️FAIL‼️**\r\n\r\n---------------\r\n\r\n3. Second try. Ok the dry run wasn't useful for getting gas estimates. I'll leave `gas` blank and try to deploy with just `gasPrice`.\r\n\r\nResults in..\r\n`Message:  insufficient funds for gas * price + value`\r\n**‼️FAIL‼️**\r\n\r\n4. Ok, I'm since the `dry-run` didn't give a useful estimate for what the contract costs to deploy, I'll just guess based on other contracts. Going to add the `gas` parameter here.\r\n\r\n```\r\nmainnet: {\r\n      provider: () =>\r\n        new HDWalletProvider({\r\n          mnemonic: { phrase: process.env.MNEMONIC },\r\n          providerOrUrl: process.env.RPC_URL_1_WSS,\r\n        }),\r\n      network_id: 1, \r\n      from: process.env.DEPLOYERS_ADDRESS,\r\n      gasPrice: 110000000000, /*  GAS PRICE!! */\r\n      gas: 140000000000000000, / That's about $200 in Wei/\r\n      confirmations: 2,\r\n      timeoutBlocks: 200,\r\n      skipDryRun: false, public nets )\r\n    },\r\n  },\r\n```\r\n\r\n`RuntimeError: abort(Error: Assertion failed). Build with -s ASSERTIONS=1 for more info.`.    \r\n\r\n**‼️FAIL AGAIN‼️**\r\n\r\n---------------\r\n\r\n\r\n4. Third attempt. Ok, going to try to just leave `gas` and `gasPrice` blank..\r\n\r\n`Block timesout in 750 seconds`.    \r\n\r\n**‼️FAIL‼️**\r\n\r\n---------\r\n\r\nTrying on Remix..\r\n1. Set provider to Injected Web3\r\n2. Set network to Mainnet\r\n3. Deploy\r\n4. Cost $135\r\n\r\nThis is great, but now I'm not using Truffle's migrations, and it isn't as easy to use Remix ABI with Truffle. \r\n\r\nI'm really really prefer Truffle to just work.\r\n\r\nWhy is Truffle sooooo difficult to use when deploying to Mainnet? It is impossible to deploy to Mainnet.\r\n\r\n",
  "closed_by": {
    "login": "fainashalts",
    "id": 8952139,
    "node_id": "MDQ6VXNlcjg5NTIxMzk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/8952139?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/fainashalts",
    "html_url": "https://github.com/fainashalts",
    "followers_url": "https://api.github.com/users/fainashalts/followers",
    "following_url": "https://api.github.com/users/fainashalts/following{/other_user}",
    "gists_url": "https://api.github.com/users/fainashalts/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/fainashalts/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/fainashalts/subscriptions",
    "organizations_url": "https://api.github.com/users/fainashalts/orgs",
    "repos_url": "https://api.github.com/users/fainashalts/repos",
    "events_url": "https://api.github.com/users/fainashalts/events{/privacy}",
    "received_events_url": "https://api.github.com/users/fainashalts/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/3888/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/trufflesuite/truffle/issues/3888/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/801307784",
    "html_url": "https://github.com/trufflesuite/truffle/issues/3888#issuecomment-801307784",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/3888",
    "id": 801307784,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwMTMwNzc4NA==",
    "user": {
      "login": "eggplantzzz",
      "id": 14827965,
      "node_id": "MDQ6VXNlcjE0ODI3OTY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/14827965?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/eggplantzzz",
      "html_url": "https://github.com/eggplantzzz",
      "followers_url": "https://api.github.com/users/eggplantzzz/followers",
      "following_url": "https://api.github.com/users/eggplantzzz/following{/other_user}",
      "gists_url": "https://api.github.com/users/eggplantzzz/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/eggplantzzz/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/eggplantzzz/subscriptions",
      "organizations_url": "https://api.github.com/users/eggplantzzz/orgs",
      "repos_url": "https://api.github.com/users/eggplantzzz/repos",
      "events_url": "https://api.github.com/users/eggplantzzz/events{/privacy}",
      "received_events_url": "https://api.github.com/users/eggplantzzz/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-17T18:21:45Z",
    "updated_at": "2021-03-17T18:21:45Z",
    "author_association": "CONTRIBUTOR",
    "body": "This is strange, seems like it might be related to gas values if it works on the test nets. We'll see if we can think of ways to test this out and troubleshoot!",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/801307784/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/801313436",
    "html_url": "https://github.com/trufflesuite/truffle/issues/3888#issuecomment-801313436",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/3888",
    "id": 801313436,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwMTMxMzQzNg==",
    "user": {
      "login": "roo-shy",
      "id": 13618162,
      "node_id": "MDQ6VXNlcjEzNjE4MTYy",
      "avatar_url": "https://avatars.githubusercontent.com/u/13618162?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/roo-shy",
      "html_url": "https://github.com/roo-shy",
      "followers_url": "https://api.github.com/users/roo-shy/followers",
      "following_url": "https://api.github.com/users/roo-shy/following{/other_user}",
      "gists_url": "https://api.github.com/users/roo-shy/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/roo-shy/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/roo-shy/subscriptions",
      "organizations_url": "https://api.github.com/users/roo-shy/orgs",
      "repos_url": "https://api.github.com/users/roo-shy/repos",
      "events_url": "https://api.github.com/users/roo-shy/events{/privacy}",
      "received_events_url": "https://api.github.com/users/roo-shy/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-17T18:27:49Z",
    "updated_at": "2021-03-17T18:27:49Z",
    "author_association": "NONE",
    "body": "@eggplantzzz referencing: 94975 in Zendesk if you need details",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/801313436/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/824272713",
    "html_url": "https://github.com/trufflesuite/truffle/issues/3888#issuecomment-824272713",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/3888",
    "id": 824272713,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgyNDI3MjcxMw==",
    "user": {
      "login": "gnidan",
      "id": 151065,
      "node_id": "MDQ6VXNlcjE1MTA2NQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/151065?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gnidan",
      "html_url": "https://github.com/gnidan",
      "followers_url": "https://api.github.com/users/gnidan/followers",
      "following_url": "https://api.github.com/users/gnidan/following{/other_user}",
      "gists_url": "https://api.github.com/users/gnidan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gnidan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gnidan/subscriptions",
      "organizations_url": "https://api.github.com/users/gnidan/orgs",
      "repos_url": "https://api.github.com/users/gnidan/repos",
      "events_url": "https://api.github.com/users/gnidan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gnidan/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-04-21T18:34:46Z",
    "updated_at": "2021-04-21T18:34:46Z",
    "author_association": "MEMBER",
    "body": "My hunch is that the specific issue you faced here @stoplion is just due to congested network conditions at the time you were seeking to deploy your project.\r\n\r\nI'm not sure if you feel like gambling mainnet ETH to see if it's better now, but maybe it is?\r\n\r\nRegardless, I've opened a follow-up issue to address a root cause here, which is that Truffle just doesn't know how much to offer for the transactions it submits to the network.\r\n\r\nLet us know if there's more we can help with!",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/824272713/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/849003222",
    "html_url": "https://github.com/trufflesuite/truffle/issues/3888#issuecomment-849003222",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/3888",
    "id": 849003222,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg0OTAwMzIyMg==",
    "user": {
      "login": "fainashalts",
      "id": 8952139,
      "node_id": "MDQ6VXNlcjg5NTIxMzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8952139?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fainashalts",
      "html_url": "https://github.com/fainashalts",
      "followers_url": "https://api.github.com/users/fainashalts/followers",
      "following_url": "https://api.github.com/users/fainashalts/following{/other_user}",
      "gists_url": "https://api.github.com/users/fainashalts/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fainashalts/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fainashalts/subscriptions",
      "organizations_url": "https://api.github.com/users/fainashalts/orgs",
      "repos_url": "https://api.github.com/users/fainashalts/repos",
      "events_url": "https://api.github.com/users/fainashalts/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fainashalts/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-05-26T18:05:29Z",
    "updated_at": "2021-05-26T18:05:29Z",
    "author_association": "MEMBER",
    "body": "Closing for issue maintenance. Please let us know if this problem persists!",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/849003222/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
