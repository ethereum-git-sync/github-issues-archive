{
  "url": "https://api.github.com/repos/trufflesuite/truffle/issues/5812",
  "repository_url": "https://api.github.com/repos/trufflesuite/truffle",
  "labels_url": "https://api.github.com/repos/trufflesuite/truffle/issues/5812/labels{/name}",
  "comments_url": "https://api.github.com/repos/trufflesuite/truffle/issues/5812/comments",
  "events_url": "https://api.github.com/repos/trufflesuite/truffle/issues/5812/events",
  "html_url": "https://github.com/trufflesuite/truffle/issues/5812",
  "id": 1515088208,
  "node_id": "I_kwDOAkfq-c5aTmlQ",
  "number": 5812,
  "title": "Truffle console command throws error trying to read json files built from Vyper source files.",
  "user": {
    "login": "dPreininger",
    "id": 61542192,
    "node_id": "MDQ6VXNlcjYxNTQyMTky",
    "avatar_url": "https://avatars.githubusercontent.com/u/61542192?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/dPreininger",
    "html_url": "https://github.com/dPreininger",
    "followers_url": "https://api.github.com/users/dPreininger/followers",
    "following_url": "https://api.github.com/users/dPreininger/following{/other_user}",
    "gists_url": "https://api.github.com/users/dPreininger/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/dPreininger/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/dPreininger/subscriptions",
    "organizations_url": "https://api.github.com/users/dPreininger/orgs",
    "repos_url": "https://api.github.com/users/dPreininger/repos",
    "events_url": "https://api.github.com/users/dPreininger/events{/privacy}",
    "received_events_url": "https://api.github.com/users/dPreininger/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 230393326,
      "node_id": "MDU6TGFiZWwyMzAzOTMzMjY=",
      "url": "https://api.github.com/repos/trufflesuite/truffle/labels/bug",
      "name": "bug",
      "color": "fc2929",
      "default": true,
      "description": null
    },
    {
      "id": 971680115,
      "node_id": "MDU6TGFiZWw5NzE2ODAxMTU=",
      "url": "https://api.github.com/repos/trufflesuite/truffle/labels/Console",
      "name": "Console",
      "color": "fbca04",
      "default": false,
      "description": ""
    },
    {
      "id": 1675041356,
      "node_id": "MDU6TGFiZWwxNjc1MDQxMzU2",
      "url": "https://api.github.com/repos/trufflesuite/truffle/labels/priority2%20%E2%9A%A0%EF%B8%8F",
      "name": "priority2 ⚠️",
      "color": "006b75",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2022-12-31T10:29:39Z",
  "updated_at": "2023-01-06T17:09:21Z",
  "closed_at": "2023-01-06T17:09:21Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "- [ x] I've [opened a support ticket](https://trufflesuite.zendesk.com/hc/en-us/requests/new) before filing this issue.\r\n\r\n---------------------------\r\n\r\n## Issue\r\n\r\nTruffle  console command crashes on .json files generated from Vyper source files. Not all versions of Truffle/Vyper compiler seem to be affected.\r\n\r\n## Steps to Reproduce\r\n\r\nBe sure you are using Ubuntu based OS with Bash terminal.\r\nClone this repository: https://github.com/dPreininger/vyper-truffle-report\r\nRun `bash run.sh`. This will run included build files and return an error (read README for more details).\r\n\r\n## Expected Behavior\r\n\r\nTruffle console command should not exit.\r\n\r\n## Actual Results\r\n\r\nTruffle console exits with this error message:\r\n```console\r\nUnexpected error setting up the environment or provisioning contracts while instantiating the console.\r\nError: Error parsing or reading VyperStorage.json: Unexpected token u in JSON at position 0\r\n    at {{ MY_HOME_DIR }}/.nvm/versions/node/v18.12.1/lib/node_modules/truffle/build/webpack:/packages/core/lib/console.js:283:1\r\n    at Array.forEach (<anonymous>)\r\n    at Console.provision ({{ MY_HOME_DIR }}/.nvm/versions/node/v18.12.1/lib/node_modules/truffle/build/webpack:/packages/core/lib/console.js:256:1)\r\n    at Console.start ({{ MY_HOME_DIR }}/.nvm/versions/node/v18.12.1/lib/node_modules/truffle/build/webpack:/packages/core/lib/console.js:130:1)\r\n    at processTicksAndRejections (node:internal/process/task_queues:95:5)\r\n    at Object.module.exports [as run] ({{ MY_HOME_DIR }}/.nvm/versions/node/v18.12.1/lib/node_modules/truffle/build/webpack:/packages/core/lib/commands/console/run.js:32:1)\r\n    at runCommand ({{ MY_HOME_DIR }}/.nvm/versions/node/v18.12.1/lib/node_modules/truffle/build/webpack:/packages/core/lib/command-utils.js:201:1)\r\n```\r\nThe error is caused by console.js file (https://github.com/trufflesuite/truffle/blob/develop/packages/core/lib/console.js), line 266.\r\nThe code expects the VyperStorage.json file to include metadata key. However, Vyper/Truffle does not generate this data, hence we are calling JSON.parse(undefined), which throws an error.\r\n\r\nI am willing to contribute to this repository to fix this issue, however I am unsure what exactly is the correct behavior here. It seems to me there are two possibilities:\r\n\r\n1. Metadata field is optional, there is a bug because the field is treated as required in the code.\r\n2. Metadata field is required, there is a bug because the field is only generated from Solidity source files and from Vyper files.\r\n\r\nClearing this up would enable me to fix the bug, if the maintainers agree.\r\n\r\n## Environment\r\n\r\n* Operating System: Ubuntu 22.04 LTS\r\n* Ethereum client: Ganache v7.6.0\r\n* Truffle version: Truffle v5.7.1 (core: 5.7.1)\r\n* node version: Tested with 16.15.1 and 18.12.1\r\n* npm version: 8.19.2\r\n* vyper compiler: 0.3.7+commit.6020b8b",
  "closed_by": {
    "login": "lsqproduction",
    "id": 12772017,
    "node_id": "MDQ6VXNlcjEyNzcyMDE3",
    "avatar_url": "https://avatars.githubusercontent.com/u/12772017?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/lsqproduction",
    "html_url": "https://github.com/lsqproduction",
    "followers_url": "https://api.github.com/users/lsqproduction/followers",
    "following_url": "https://api.github.com/users/lsqproduction/following{/other_user}",
    "gists_url": "https://api.github.com/users/lsqproduction/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/lsqproduction/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/lsqproduction/subscriptions",
    "organizations_url": "https://api.github.com/users/lsqproduction/orgs",
    "repos_url": "https://api.github.com/users/lsqproduction/repos",
    "events_url": "https://api.github.com/users/lsqproduction/events{/privacy}",
    "received_events_url": "https://api.github.com/users/lsqproduction/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/5812/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/trufflesuite/truffle/issues/5812/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/1370467410",
    "html_url": "https://github.com/trufflesuite/truffle/issues/5812#issuecomment-1370467410",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/5812",
    "id": 1370467410,
    "node_id": "IC_kwDOAkfq-c5Rr6xS",
    "user": {
      "login": "cds-amal",
      "id": 2529600,
      "node_id": "MDQ6VXNlcjI1Mjk2MDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2529600?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cds-amal",
      "html_url": "https://github.com/cds-amal",
      "followers_url": "https://api.github.com/users/cds-amal/followers",
      "following_url": "https://api.github.com/users/cds-amal/following{/other_user}",
      "gists_url": "https://api.github.com/users/cds-amal/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cds-amal/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cds-amal/subscriptions",
      "organizations_url": "https://api.github.com/users/cds-amal/orgs",
      "repos_url": "https://api.github.com/users/cds-amal/repos",
      "events_url": "https://api.github.com/users/cds-amal/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cds-amal/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-01-04T04:10:46Z",
    "updated_at": "2023-01-04T04:19:43Z",
    "author_association": "MEMBER",
    "body": "Thanks for raising this issue/bug @dPreininger! Apologies for the delayed response. We're only now returning from holiday. \r\n\r\nTruffle should not crash if metadata is undefined; that filter logic should be guarded with something like:\r\n\r\n```javascript\r\nif (json.metadata !== undefined) {\r\n  const metadata = JSON.parse(json.metadata);\r\n  // filter logic\r\n}\r\n```\r\nIf you have the time to make the PR, please let us know, otherwise, one of us will grab this one. I'd like to see it get into the next release.\r\n\r\n## Reproduction note\r\n\r\nIf you [comment out the `development` network in `truffle-config.js`](https://github.com/dPreininger/vyper-truffle-report/blob/master/truffle-config.js#L4-L8), you can use `truffle develop` to enter the REPL. This command uses a managed Ganache instance.\r\n\r\nEdit: add reproduction note",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/1370467410/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/1370588937",
    "html_url": "https://github.com/trufflesuite/truffle/issues/5812#issuecomment-1370588937",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/5812",
    "id": 1370588937,
    "node_id": "IC_kwDOAkfq-c5RsYcJ",
    "user": {
      "login": "dPreininger",
      "id": 61542192,
      "node_id": "MDQ6VXNlcjYxNTQyMTky",
      "avatar_url": "https://avatars.githubusercontent.com/u/61542192?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dPreininger",
      "html_url": "https://github.com/dPreininger",
      "followers_url": "https://api.github.com/users/dPreininger/followers",
      "following_url": "https://api.github.com/users/dPreininger/following{/other_user}",
      "gists_url": "https://api.github.com/users/dPreininger/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dPreininger/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dPreininger/subscriptions",
      "organizations_url": "https://api.github.com/users/dPreininger/orgs",
      "repos_url": "https://api.github.com/users/dPreininger/repos",
      "events_url": "https://api.github.com/users/dPreininger/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dPreininger/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-01-04T07:59:41Z",
    "updated_at": "2023-01-04T07:59:41Z",
    "author_association": "CONTRIBUTOR",
    "body": "I've opened the PR [#5819](https://github.com/trufflesuite/truffle/pull/5819)",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/1370588937/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 1,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/1371664510",
    "html_url": "https://github.com/trufflesuite/truffle/issues/5812#issuecomment-1371664510",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/5812",
    "id": 1371664510,
    "node_id": "IC_kwDOAkfq-c5RwfB-",
    "user": {
      "login": "cds-amal",
      "id": 2529600,
      "node_id": "MDQ6VXNlcjI1Mjk2MDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2529600?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cds-amal",
      "html_url": "https://github.com/cds-amal",
      "followers_url": "https://api.github.com/users/cds-amal/followers",
      "following_url": "https://api.github.com/users/cds-amal/following{/other_user}",
      "gists_url": "https://api.github.com/users/cds-amal/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cds-amal/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cds-amal/subscriptions",
      "organizations_url": "https://api.github.com/users/cds-amal/orgs",
      "repos_url": "https://api.github.com/users/cds-amal/repos",
      "events_url": "https://api.github.com/users/cds-amal/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cds-amal/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-01-05T02:09:59Z",
    "updated_at": "2023-01-05T02:10:33Z",
    "author_association": "MEMBER",
    "body": "Hi @dPreininger, this bug still exists in the current Truffle version. In this case, since there's a PR to address this bug, our policy is to close it when the next Truffle version is released. This fix should make this week's release. Thanks so much for contributing :bow: \r\n",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/1371664510/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/1373905105",
    "html_url": "https://github.com/trufflesuite/truffle/issues/5812#issuecomment-1373905105",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/5812",
    "id": 1373905105,
    "node_id": "IC_kwDOAkfq-c5R5CDR",
    "user": {
      "login": "lsqproduction",
      "id": 12772017,
      "node_id": "MDQ6VXNlcjEyNzcyMDE3",
      "avatar_url": "https://avatars.githubusercontent.com/u/12772017?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/lsqproduction",
      "html_url": "https://github.com/lsqproduction",
      "followers_url": "https://api.github.com/users/lsqproduction/followers",
      "following_url": "https://api.github.com/users/lsqproduction/following{/other_user}",
      "gists_url": "https://api.github.com/users/lsqproduction/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/lsqproduction/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/lsqproduction/subscriptions",
      "organizations_url": "https://api.github.com/users/lsqproduction/orgs",
      "repos_url": "https://api.github.com/users/lsqproduction/repos",
      "events_url": "https://api.github.com/users/lsqproduction/events{/privacy}",
      "received_events_url": "https://api.github.com/users/lsqproduction/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-01-06T17:09:21Z",
    "updated_at": "2023-01-06T17:09:21Z",
    "author_association": "CONTRIBUTOR",
    "body": "Yay. Fix and releases in [Truffle v5.7.2](https://github.com/trufflesuite/truffle/releases/tag/v5.7.2) ",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/1373905105/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
