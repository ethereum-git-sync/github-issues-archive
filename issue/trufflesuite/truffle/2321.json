{
  "url": "https://api.github.com/repos/trufflesuite/truffle/issues/2321",
  "repository_url": "https://api.github.com/repos/trufflesuite/truffle",
  "labels_url": "https://api.github.com/repos/trufflesuite/truffle/issues/2321/labels{/name}",
  "comments_url": "https://api.github.com/repos/trufflesuite/truffle/issues/2321/comments",
  "events_url": "https://api.github.com/repos/trufflesuite/truffle/issues/2321/events",
  "html_url": "https://github.com/trufflesuite/truffle/issues/2321",
  "id": 483631241,
  "node_id": "MDU6SXNzdWU0ODM2MzEyNDE=",
  "number": 2321,
  "title": "err.reason undefined when require() fails with reason in a view",
  "user": {
    "login": "theoretical2019",
    "id": 54324810,
    "node_id": "MDQ6VXNlcjU0MzI0ODEw",
    "avatar_url": "https://avatars.githubusercontent.com/u/54324810?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/theoretical2019",
    "html_url": "https://github.com/theoretical2019",
    "followers_url": "https://api.github.com/users/theoretical2019/followers",
    "following_url": "https://api.github.com/users/theoretical2019/following{/other_user}",
    "gists_url": "https://api.github.com/users/theoretical2019/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/theoretical2019/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/theoretical2019/subscriptions",
    "organizations_url": "https://api.github.com/users/theoretical2019/orgs",
    "repos_url": "https://api.github.com/users/theoretical2019/repos",
    "events_url": "https://api.github.com/users/theoretical2019/events{/privacy}",
    "received_events_url": "https://api.github.com/users/theoretical2019/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 230393326,
      "node_id": "MDU6TGFiZWwyMzAzOTMzMjY=",
      "url": "https://api.github.com/repos/trufflesuite/truffle/labels/bug",
      "name": "bug",
      "color": "fc2929",
      "default": true,
      "description": null
    },
    {
      "id": 990823235,
      "node_id": "MDU6TGFiZWw5OTA4MjMyMzU=",
      "url": "https://api.github.com/repos/trufflesuite/truffle/labels/Contract",
      "name": "Contract",
      "color": "a1ea8f",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2019-08-21T20:18:47Z",
  "updated_at": "2019-08-30T14:19:57Z",
  "closed_at": "2019-08-30T14:19:57Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "- [x] I've asked for help in the [Truffle Gitter](http://gitter.im/Consensys/truffle) before filing this issue.\r\n\r\n---------------------------\r\n\r\n## Issue\r\n\r\nIf a view fails `require()` with a reason, the reason isn't available in the error.  In other words, in a `catch(err)` block, `err.reason` is always `undefined` if a view failed.  If the Solidity code passed a reason in the `require()` that failed, then `err.reason` should be the reason from Solidity.\r\n\r\n## Steps to Reproduce\r\n\r\n- Create a Solidity smart contract with a view.\r\n- Have a statement of the form `require(cond, \"ThisShouldFail\")` in the view.\r\n- In JS, call the view inside a `try` / `catch` block.  Use view arguments such that `cond` evaluates to `false`.\r\n- In the `catch(err)` block, `err.reason` is `undefined`.\r\n\r\nHere's an example:\r\n\r\n```\r\n$ truffle test\r\n\r\nCompiling your contracts...\r\n===========================\r\n> Compiling ./contracts/Migrations.sol\r\n> Compiling ./contracts/ReasonTest.sol\r\n\r\n\r\n\r\n  Contract: ReasonTest\r\ncurrent_value(): <BN: 5>\r\nFail require() in a transaction:\r\nerr.reason: TooSmall\r\nFail require() in a view:\r\nerr.reason: undefined\r\n    âœ“ Demonstrate the bug (89ms)\r\n\r\n\r\n  1 passing (106ms)\r\n\r\n$ cat contracts/ReasonTest.sol\r\npragma solidity >=0.4.21 <0.6.0;\r\n\r\n/**\r\n * A simple smart contract that holds a value which decreases by 10.\r\n */\r\ncontract ReasonTest\r\n{\r\n   uint public value;\r\n\r\n   constructor(uint initial_value) public\r\n   {\r\n      value = initial_value;\r\n   }\r\n\r\n   function current_value() public view\r\n      returns (uint)\r\n   {\r\n      return value;\r\n   }\r\n\r\n   function next_value() public view\r\n      returns (uint)\r\n   {\r\n      require( value >= 10, \"TooSmall\" );\r\n      return value-10;\r\n   }\r\n\r\n   function update_value() public\r\n      returns (uint)\r\n   {\r\n      require( value >= 10, \"TooSmall\" );\r\n      value -= 10;\r\n      return value;\r\n   }\r\n}\r\n$ cat test/reason.js\r\n\r\nconst ReasonTest = artifacts.require(\"ReasonTest\");\r\n\r\ncontract(\"ReasonTest\", function(accounts)\r\n{\r\n   it( \"Demonstrate the bug\",\r\n      async function()\r\n      {\r\n         let instance = await ReasonTest.deployed();\r\n\r\n         // Print out current_value(), we see it's smaller than 10, so require(value <= 10) should fail\r\n         console.log(\"current_value():\", await instance.current_value());\r\n\r\n         // When require() fails in a transaction, we get err.reason as expected (in Truffle 5)\r\n         console.log(\"Fail require() in a transaction:\");\r\n         try\r\n         {\r\n            await instance.update_value();\r\n         }\r\n         catch(err)\r\n         {\r\n            console.log(\"err.reason:\", err.reason);\r\n         }\r\n\r\n         // When require() fails in a view, err.reason is not available\r\n         console.log(\"Fail require() in a view:\");\r\n         try\r\n         {\r\n            await instance.next_value();\r\n         }\r\n         catch(err)\r\n         {\r\n            console.log(\"err.reason:\", err.reason);\r\n         }\r\n      });\r\n});\r\n```\r\n\r\n## Expected Behavior\r\n\r\nOutput of above-given files should be:\r\n\r\n```\r\nFail require() in a transaction:\r\nerr.reason: TooSmall\r\nFail require() in a view:\r\nerr.reason: TooSmall\r\n```\r\n\r\n## Actual Results\r\n\r\nOutput actually is:\r\n\r\n```\r\nFail require() in a transaction:\r\nerr.reason: TooSmall\r\nFail require() in a view:\r\nerr.reason: undefined\r\n```\r\n\r\n## Environment\r\n\r\nI think only Truffle version is relevant to this situation.  It is:\r\n\r\n```\r\n$ truffle version\r\nTruffle v5.0.32 (core: 5.0.32)\r\nSolidity - 0.5.10 (solc-js)\r\nNode v10.16.0\r\nWeb3.js v1.2.1\r\n```\r\n\r\nI'm using Truffle's built-in Ethereum environment (no external Geth / Parity / Ganache / etc.)\r\n\r\nHere's details of the external environment just in case it matters:\r\n\r\n```\r\n$ cat /etc/issue\r\nUbuntu 18.04.2 LTS \\n \\l\r\n$ node --version\r\nv10.16.0\r\n$ npm --version\r\n6.9.0\r\n```\r\n",
  "closed_by": {
    "login": "eggplantzzz",
    "id": 14827965,
    "node_id": "MDQ6VXNlcjE0ODI3OTY1",
    "avatar_url": "https://avatars.githubusercontent.com/u/14827965?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/eggplantzzz",
    "html_url": "https://github.com/eggplantzzz",
    "followers_url": "https://api.github.com/users/eggplantzzz/followers",
    "following_url": "https://api.github.com/users/eggplantzzz/following{/other_user}",
    "gists_url": "https://api.github.com/users/eggplantzzz/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/eggplantzzz/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/eggplantzzz/subscriptions",
    "organizations_url": "https://api.github.com/users/eggplantzzz/orgs",
    "repos_url": "https://api.github.com/users/eggplantzzz/repos",
    "events_url": "https://api.github.com/users/eggplantzzz/events{/privacy}",
    "received_events_url": "https://api.github.com/users/eggplantzzz/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/2321/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/trufflesuite/truffle/issues/2321/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/523693522",
    "html_url": "https://github.com/trufflesuite/truffle/issues/2321#issuecomment-523693522",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/2321",
    "id": 523693522,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUyMzY5MzUyMg==",
    "user": {
      "login": "gnidan",
      "id": 151065,
      "node_id": "MDQ6VXNlcjE1MTA2NQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/151065?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gnidan",
      "html_url": "https://github.com/gnidan",
      "followers_url": "https://api.github.com/users/gnidan/followers",
      "following_url": "https://api.github.com/users/gnidan/following{/other_user}",
      "gists_url": "https://api.github.com/users/gnidan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gnidan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gnidan/subscriptions",
      "organizations_url": "https://api.github.com/users/gnidan/orgs",
      "repos_url": "https://api.github.com/users/gnidan/repos",
      "events_url": "https://api.github.com/users/gnidan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gnidan/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-08-21T23:59:37Z",
    "updated_at": "2019-08-21T23:59:37Z",
    "author_association": "MEMBER",
    "body": "Awesome write-up! Thank you! We'll get this triaged.",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/523693522/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/525472745",
    "html_url": "https://github.com/trufflesuite/truffle/issues/2321#issuecomment-525472745",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/2321",
    "id": 525472745,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUyNTQ3Mjc0NQ==",
    "user": {
      "login": "eggplantzzz",
      "id": 14827965,
      "node_id": "MDQ6VXNlcjE0ODI3OTY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/14827965?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/eggplantzzz",
      "html_url": "https://github.com/eggplantzzz",
      "followers_url": "https://api.github.com/users/eggplantzzz/followers",
      "following_url": "https://api.github.com/users/eggplantzzz/following{/other_user}",
      "gists_url": "https://api.github.com/users/eggplantzzz/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/eggplantzzz/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/eggplantzzz/subscriptions",
      "organizations_url": "https://api.github.com/users/eggplantzzz/orgs",
      "repos_url": "https://api.github.com/users/eggplantzzz/repos",
      "events_url": "https://api.github.com/users/eggplantzzz/events{/privacy}",
      "received_events_url": "https://api.github.com/users/eggplantzzz/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-08-27T20:37:30Z",
    "updated_at": "2019-08-27T20:37:30Z",
    "author_association": "CONTRIBUTOR",
    "body": "@theoretical2019 Yes thanks again for such a good report! I found the bug, for calls Truffle was not getting the reason. I'll open up a PR for this and hopefully we'll get it released next week!",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/525472745/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/526619774",
    "html_url": "https://github.com/trufflesuite/truffle/issues/2321#issuecomment-526619774",
    "issue_url": "https://api.github.com/repos/trufflesuite/truffle/issues/2321",
    "id": 526619774,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUyNjYxOTc3NA==",
    "user": {
      "login": "eggplantzzz",
      "id": 14827965,
      "node_id": "MDQ6VXNlcjE0ODI3OTY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/14827965?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/eggplantzzz",
      "html_url": "https://github.com/eggplantzzz",
      "followers_url": "https://api.github.com/users/eggplantzzz/followers",
      "following_url": "https://api.github.com/users/eggplantzzz/following{/other_user}",
      "gists_url": "https://api.github.com/users/eggplantzzz/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/eggplantzzz/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/eggplantzzz/subscriptions",
      "organizations_url": "https://api.github.com/users/eggplantzzz/orgs",
      "repos_url": "https://api.github.com/users/eggplantzzz/repos",
      "events_url": "https://api.github.com/users/eggplantzzz/events{/privacy}",
      "received_events_url": "https://api.github.com/users/eggplantzzz/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-08-30T14:19:57Z",
    "updated_at": "2019-08-30T14:19:57Z",
    "author_association": "CONTRIBUTOR",
    "body": "@theoretical2019 So we figured out what was going on with this issue. So it turns out that for `send`s, Truffle receives the status of the transaction through the receipt data I believe. This is how Truffle can tell whether it was successful or reverted. With `calls` (which would occur in the situation where a function declared `view`) there is no status information and thus Truffle won't be able to tell if it \"fails\" a `require`s conditions. We decided it might be dangerous to not replicate this behavior and so decided to leave it as it is for now. \r\n\r\nCheck out the conversation in the closed PR above (PR #2340) if you would like to see what was discussed. Thanks again for opening this though! ",
    "reactions": {
      "url": "https://api.github.com/repos/trufflesuite/truffle/issues/comments/526619774/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
