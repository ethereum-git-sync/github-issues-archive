{
  "url": "https://api.github.com/repos/MyCryptoHQ/MyCrypto/issues/1030",
  "repository_url": "https://api.github.com/repos/MyCryptoHQ/MyCrypto",
  "labels_url": "https://api.github.com/repos/MyCryptoHQ/MyCrypto/issues/1030/labels{/name}",
  "comments_url": "https://api.github.com/repos/MyCryptoHQ/MyCrypto/issues/1030/comments",
  "events_url": "https://api.github.com/repos/MyCryptoHQ/MyCrypto/issues/1030/events",
  "html_url": "https://github.com/MyCryptoHQ/MyCrypto/issues/1030",
  "id": 295639581,
  "node_id": "MDU6SXNzdWUyOTU2Mzk1ODE=",
  "number": 1030,
  "title": "Automated Balance and Nonce Updates",
  "user": {
    "login": "aitrean",
    "id": 2967924,
    "node_id": "MDQ6VXNlcjI5Njc5MjQ=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2967924?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/aitrean",
    "html_url": "https://github.com/aitrean",
    "followers_url": "https://api.github.com/users/aitrean/followers",
    "following_url": "https://api.github.com/users/aitrean/following{/other_user}",
    "gists_url": "https://api.github.com/users/aitrean/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/aitrean/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/aitrean/subscriptions",
    "organizations_url": "https://api.github.com/users/aitrean/orgs",
    "repos_url": "https://api.github.com/users/aitrean/repos",
    "events_url": "https://api.github.com/users/aitrean/events{/privacy}",
    "received_events_url": "https://api.github.com/users/aitrean/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 6,
  "created_at": "2018-02-08T19:38:19Z",
  "updated_at": "2018-08-28T22:08:53Z",
  "closed_at": "2018-08-28T22:08:53Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "At the moment, we don't automatically refresh the user's balance or nonce after broadcasting a tx, since we need to wait for block confirmation. Given the variable nature of Ethereum block times, and the fact that we don't *presently* have any websockets that are trustful, I propose a solution as follows:\r\n\r\n1. Create a utility saga that will kick off a fork once called. Ideally, we would call it immediately following a successful broadcast.\r\n\r\n2. In the forked saga, poll the node for the present block number every x number of seconds until the block number updates. On a successful update, check if we can get a transaction receipt. If the transaction doesn't go through in the first block after the update, we repeat this process until we can get a proper txReceipt. \r\n\r\n3. Parse the txReceipt. \r\n\r\n##### If successful:\r\n1. dispatch currently-existing actions to update:\r\n    1. balance \r\n    2. nonce\r\n2. Show a green notification indicating the user had a successful transaction. \r\n\r\n##### If unsuccessful:\r\n1. dispatch action to update balance. Show a red footer notification the user's transaction failed. \r\n\r\nThe main variable in this is how frequently we poll the blockchain. Poll by average expected blocktime (~15s)? Use an API for blocktimes? I'd prefer to poll as frequently as possible so that we don't have to wait 15s after sending a transaction to see an update.\r\n\r\nWhat are the suggestions on this? I'm assuming that previous transactions aren't really states we need to keep, so I haven't suggested any reducers we don't already have. ",
  "closed_by": {
    "login": "ConnorBryan",
    "id": 10479826,
    "node_id": "MDQ6VXNlcjEwNDc5ODI2",
    "avatar_url": "https://avatars.githubusercontent.com/u/10479826?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ConnorBryan",
    "html_url": "https://github.com/ConnorBryan",
    "followers_url": "https://api.github.com/users/ConnorBryan/followers",
    "following_url": "https://api.github.com/users/ConnorBryan/following{/other_user}",
    "gists_url": "https://api.github.com/users/ConnorBryan/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ConnorBryan/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ConnorBryan/subscriptions",
    "organizations_url": "https://api.github.com/users/ConnorBryan/orgs",
    "repos_url": "https://api.github.com/users/ConnorBryan/repos",
    "events_url": "https://api.github.com/users/ConnorBryan/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ConnorBryan/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/MyCryptoHQ/MyCrypto/issues/1030/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/MyCryptoHQ/MyCrypto/issues/1030/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/MyCryptoHQ/MyCrypto/issues/comments/364228601",
    "html_url": "https://github.com/MyCryptoHQ/MyCrypto/issues/1030#issuecomment-364228601",
    "issue_url": "https://api.github.com/repos/MyCryptoHQ/MyCrypto/issues/1030",
    "id": 364228601,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM2NDIyODYwMQ==",
    "user": {
      "login": "dternyak",
      "id": 7861465,
      "node_id": "MDQ6VXNlcjc4NjE0NjU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7861465?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dternyak",
      "html_url": "https://github.com/dternyak",
      "followers_url": "https://api.github.com/users/dternyak/followers",
      "following_url": "https://api.github.com/users/dternyak/following{/other_user}",
      "gists_url": "https://api.github.com/users/dternyak/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dternyak/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dternyak/subscriptions",
      "organizations_url": "https://api.github.com/users/dternyak/orgs",
      "repos_url": "https://api.github.com/users/dternyak/repos",
      "events_url": "https://api.github.com/users/dternyak/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dternyak/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-02-08T19:53:08Z",
    "updated_at": "2018-02-08T19:56:46Z",
    "author_association": "CONTRIBUTOR",
    "body": "I would like to see an exponential back-off(ish) for polling, and a hard-cap to limit retries (for backend overhead).\r\n\r\nThe polling cycle can look something like this:\r\n\r\n`tx broadcast |15s| poll |15s| poll |15s| poll |30s| poll |60s| stop polling`",
    "reactions": {
      "url": "https://api.github.com/repos/MyCryptoHQ/MyCrypto/issues/comments/364228601/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/MyCryptoHQ/MyCrypto/issues/comments/364235213",
    "html_url": "https://github.com/MyCryptoHQ/MyCrypto/issues/1030#issuecomment-364235213",
    "issue_url": "https://api.github.com/repos/MyCryptoHQ/MyCrypto/issues/1030",
    "id": 364235213,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM2NDIzNTIxMw==",
    "user": {
      "login": "kvhnuke",
      "id": 10602065,
      "node_id": "MDQ6VXNlcjEwNjAyMDY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/10602065?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/kvhnuke",
      "html_url": "https://github.com/kvhnuke",
      "followers_url": "https://api.github.com/users/kvhnuke/followers",
      "following_url": "https://api.github.com/users/kvhnuke/following{/other_user}",
      "gists_url": "https://api.github.com/users/kvhnuke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/kvhnuke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/kvhnuke/subscriptions",
      "organizations_url": "https://api.github.com/users/kvhnuke/orgs",
      "repos_url": "https://api.github.com/users/kvhnuke/repos",
      "events_url": "https://api.github.com/users/kvhnuke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/kvhnuke/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-02-08T20:16:41Z",
    "updated_at": "2018-02-08T20:16:41Z",
    "author_association": "NONE",
    "body": "I highly recommend not to do polling you guys will end up hitting high number of network requests as your number of visitors grow. Instead I would use something similar to below\r\n1. If it is a value transfer (no code) simply verify basic verifications such as it is above gasprice, and  valid nonce and user's balance is sufficient. Then simply decrease (value + tx fee) from user's balance and increase the nonce by one.\r\n\r\n2. However if the tx has data, then do an actual eth_call and verify whether the tx will go through, (however, I recommend using the ethereumjs-vm with a backend cache)  then increase the nonce and decrease the balance.\r\n\r\n$30k mistake made me realize how inefficient is polling",
    "reactions": {
      "url": "https://api.github.com/repos/MyCryptoHQ/MyCrypto/issues/comments/364235213/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/MyCryptoHQ/MyCrypto/issues/comments/364238325",
    "html_url": "https://github.com/MyCryptoHQ/MyCrypto/issues/1030#issuecomment-364238325",
    "issue_url": "https://api.github.com/repos/MyCryptoHQ/MyCrypto/issues/1030",
    "id": 364238325,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM2NDIzODMyNQ==",
    "user": {
      "login": "dternyak",
      "id": 7861465,
      "node_id": "MDQ6VXNlcjc4NjE0NjU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7861465?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dternyak",
      "html_url": "https://github.com/dternyak",
      "followers_url": "https://api.github.com/users/dternyak/followers",
      "following_url": "https://api.github.com/users/dternyak/following{/other_user}",
      "gists_url": "https://api.github.com/users/dternyak/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dternyak/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dternyak/subscriptions",
      "organizations_url": "https://api.github.com/users/dternyak/orgs",
      "repos_url": "https://api.github.com/users/dternyak/repos",
      "events_url": "https://api.github.com/users/dternyak/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dternyak/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-02-08T20:28:21Z",
    "updated_at": "2018-02-08T20:32:51Z",
    "author_association": "CONTRIBUTOR",
    "body": "Thanks for the input.\r\n\r\n> 1. If it is a value transfer (no code) simply verify basic verifications such as it is above gasprice, and valid nonce and user's balance is sufficient. Then simply decrease (value + tx fee) from user's balance and increase the nonce by one. \r\n\r\nA tx could be mined at any time that would change this state, so we shouldn't optimistically decrease balance / update nonce in this way. We have no guarantee the tx will ever be mined, and no guarantee that a different tx won't be generated / mined that will cause a difference in expected balance / nonce state. \r\n\r\n>2. However if the tx has data, then do an actual eth_call and verify whether the tx will go through, (however, I recommend using the ethereumjs-vm with a backend cache) then increase the nonce and decrease the balance.\r\n\r\nUsing `eth_call` to determine if a transaction with data is valid has some value, but it's more validation related (e.g. we shouldn't even allow the user to generate the tx is invalid). It still doesn't allow us to make guarantees about if we can update the balance / nonce.\r\n\r\nBy capping the number of retries we will make and employing an exponential back-off, **this functionality will not significantly increase the number of JSON-RPC calls the traditional user makes during a session**. Long-term, we're planning to move towards websockets to avoid polling altogether.\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/MyCryptoHQ/MyCrypto/issues/comments/364238325/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/MyCryptoHQ/MyCrypto/issues/comments/364269920",
    "html_url": "https://github.com/MyCryptoHQ/MyCrypto/issues/1030#issuecomment-364269920",
    "issue_url": "https://api.github.com/repos/MyCryptoHQ/MyCrypto/issues/1030",
    "id": 364269920,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM2NDI2OTkyMA==",
    "user": {
      "login": "kvhnuke",
      "id": 10602065,
      "node_id": "MDQ6VXNlcjEwNjAyMDY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/10602065?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/kvhnuke",
      "html_url": "https://github.com/kvhnuke",
      "followers_url": "https://api.github.com/users/kvhnuke/followers",
      "following_url": "https://api.github.com/users/kvhnuke/following{/other_user}",
      "gists_url": "https://api.github.com/users/kvhnuke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/kvhnuke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/kvhnuke/subscriptions",
      "organizations_url": "https://api.github.com/users/kvhnuke/orgs",
      "repos_url": "https://api.github.com/users/kvhnuke/repos",
      "events_url": "https://api.github.com/users/kvhnuke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/kvhnuke/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-02-08T22:26:57Z",
    "updated_at": "2018-02-08T22:28:23Z",
    "author_association": "NONE",
    "body": "@dternyak good thoughts\r\nAlso, think about the following conditions and how you can solve them. Web-sockets definitely way to go\r\n1. Clients sending back to back txs (if the nonce only update after the tx is included this might be a problem) as the nonce might not update at all if the tx takes more than 120 secs\r\n2. Balance wont immediately reflect the balance after sending the transaction, instead it might not reflect at all if it takes more than 120 secs to that tx to be included\r\n\r\nyou can guarantee with a fair certainty (Higher than it will be included within 2 mins ) that the tx will be included if the following conditions are met\r\n1. Gasprice is >= avg price\r\n2. nonce is valid\r\n3. enough balance\r\n4. valid state for contract execution \r\n5.  txSize < 32*1024\r\n6. gasLimit < maxLimit\r\n7. gasLimit > intrinsicGas \r\n\r\nyou can verify all those without polling\r\nonly exception to this is a user actually replacing the tx with higherGas price, you can handle this case to if they use MyCrypto to replace the tx as you can keep a table of sentTxs with their corresponding nonces and if a user replace it,  you can adjust balance accordingly\r\n\r\nand if you really need polling you can do it once every min or so to update to sync the local state with the blockchain\r\n\r\njust a quick thought!",
    "reactions": {
      "url": "https://api.github.com/repos/MyCryptoHQ/MyCrypto/issues/comments/364269920/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/MyCryptoHQ/MyCrypto/issues/comments/412988052",
    "html_url": "https://github.com/MyCryptoHQ/MyCrypto/issues/1030#issuecomment-412988052",
    "issue_url": "https://api.github.com/repos/MyCryptoHQ/MyCrypto/issues/1030",
    "id": 412988052,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQxMjk4ODA1Mg==",
    "user": {
      "login": "SharonManrique",
      "id": 25834495,
      "node_id": "MDQ6VXNlcjI1ODM0NDk1",
      "avatar_url": "https://avatars.githubusercontent.com/u/25834495?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/SharonManrique",
      "html_url": "https://github.com/SharonManrique",
      "followers_url": "https://api.github.com/users/SharonManrique/followers",
      "following_url": "https://api.github.com/users/SharonManrique/following{/other_user}",
      "gists_url": "https://api.github.com/users/SharonManrique/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/SharonManrique/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/SharonManrique/subscriptions",
      "organizations_url": "https://api.github.com/users/SharonManrique/orgs",
      "repos_url": "https://api.github.com/users/SharonManrique/repos",
      "events_url": "https://api.github.com/users/SharonManrique/events{/privacy}",
      "received_events_url": "https://api.github.com/users/SharonManrique/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-08-14T19:28:20Z",
    "updated_at": "2018-08-14T19:28:20Z",
    "author_association": "CONTRIBUTOR",
    "body": "[Added to Asana](https://app.asana.com/0/763966770926912/779983315837129)",
    "reactions": {
      "url": "https://api.github.com/repos/MyCryptoHQ/MyCrypto/issues/comments/412988052/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/MyCryptoHQ/MyCrypto/issues/comments/414996679",
    "html_url": "https://github.com/MyCryptoHQ/MyCrypto/issues/1030#issuecomment-414996679",
    "issue_url": "https://api.github.com/repos/MyCryptoHQ/MyCrypto/issues/1030",
    "id": 414996679,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQxNDk5NjY3OQ==",
    "user": {
      "login": "abara-kedavra",
      "id": 14240337,
      "node_id": "MDQ6VXNlcjE0MjQwMzM3",
      "avatar_url": "https://avatars.githubusercontent.com/u/14240337?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/abara-kedavra",
      "html_url": "https://github.com/abara-kedavra",
      "followers_url": "https://api.github.com/users/abara-kedavra/followers",
      "following_url": "https://api.github.com/users/abara-kedavra/following{/other_user}",
      "gists_url": "https://api.github.com/users/abara-kedavra/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/abara-kedavra/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/abara-kedavra/subscriptions",
      "organizations_url": "https://api.github.com/users/abara-kedavra/orgs",
      "repos_url": "https://api.github.com/users/abara-kedavra/repos",
      "events_url": "https://api.github.com/users/abara-kedavra/events{/privacy}",
      "received_events_url": "https://api.github.com/users/abara-kedavra/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-08-22T11:10:17Z",
    "updated_at": "2018-08-22T11:10:36Z",
    "author_association": "NONE",
    "body": "Hi, Connor! My topic wasn't about nonce updating. I completely change the wallet! It should have new parameters. ",
    "reactions": {
      "url": "https://api.github.com/repos/MyCryptoHQ/MyCrypto/issues/comments/414996679/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
