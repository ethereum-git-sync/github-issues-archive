{
  "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/4619",
  "repository_url": "https://api.github.com/repos/prysmaticlabs/prysm",
  "labels_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/4619/labels{/name}",
  "comments_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/4619/comments",
  "events_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/4619/events",
  "html_url": "https://github.com/prysmaticlabs/prysm/issues/4619",
  "id": 553640083,
  "node_id": "MDU6SXNzdWU1NTM2NDAwODM=",
  "number": 4619,
  "title": "Explanation for High CPU / Mem Usage",
  "user": {
    "login": "rauljordan",
    "id": 5572669,
    "node_id": "MDQ6VXNlcjU1NzI2Njk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5572669?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/rauljordan",
    "html_url": "https://github.com/rauljordan",
    "followers_url": "https://api.github.com/users/rauljordan/followers",
    "following_url": "https://api.github.com/users/rauljordan/following{/other_user}",
    "gists_url": "https://api.github.com/users/rauljordan/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/rauljordan/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rauljordan/subscriptions",
    "organizations_url": "https://api.github.com/users/rauljordan/orgs",
    "repos_url": "https://api.github.com/users/rauljordan/repos",
    "events_url": "https://api.github.com/users/rauljordan/events{/privacy}",
    "received_events_url": "https://api.github.com/users/rauljordan/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2020-01-22T16:06:26Z",
  "updated_at": "2020-02-05T21:01:57Z",
  "closed_at": "2020-02-05T21:01:57Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "Hi all,\r\n\r\nSome users have been asking why their Prysm nodes take up so much memory and cpu. In short, there are many **extremely** expensive data copying operations we perform on the beacon chain state over 56 times per slot (a period of 12 seconds), which eats up memory at an alarming rate. Additionally, the memory footprint of keeping around eth1 deposits from the deposit contract take up a big portion of the heap profile. Thanks to @prestonvanloon for pointing this out in #4604.\r\n\r\nIn terms of CPU specifically, the biggest culprit is the function `processSlots` found in https://github.com/prysmaticlabs/prysm/blob/b030771174750c3dfad30548800f755a3bfd9ad7/beacon-chain/core/state/transition.go#L237. This function calls `stateutil.HashTreeRootState` which eats up the vast majority of CPU cycles. Not only is it slow, but it also calls `proto.Clone()` on the beacon state, often times grinding sync to a halt. Aside from this, fork choice is also a big culprit on current CPU usage.\r\n\r\nThe issues with memory usage will be fully mitigated by #4614 and fork choice will be eliminated from our bottlenecks with #4615 and other fixes @terencechain is working on. We recommend users to just hang on for a bit while we work hard on resolving these problems.\r\n\r\n<img width=\"1236\" alt=\"Screen Shot 2020-01-22 at 9 44 24 AM\" src=\"https://user-images.githubusercontent.com/5572669/72910922-d8825000-3cfe-11ea-8766-b5538655c961.png\">\r\n",
  "closed_by": {
    "login": "prestonvanloon",
    "id": 7246818,
    "node_id": "MDQ6VXNlcjcyNDY4MTg=",
    "avatar_url": "https://avatars.githubusercontent.com/u/7246818?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/prestonvanloon",
    "html_url": "https://github.com/prestonvanloon",
    "followers_url": "https://api.github.com/users/prestonvanloon/followers",
    "following_url": "https://api.github.com/users/prestonvanloon/following{/other_user}",
    "gists_url": "https://api.github.com/users/prestonvanloon/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/prestonvanloon/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/prestonvanloon/subscriptions",
    "organizations_url": "https://api.github.com/users/prestonvanloon/orgs",
    "repos_url": "https://api.github.com/users/prestonvanloon/repos",
    "events_url": "https://api.github.com/users/prestonvanloon/events{/privacy}",
    "received_events_url": "https://api.github.com/users/prestonvanloon/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/4619/reactions",
    "total_count": 4,
    "+1": 4,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/4619/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/577264889",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/4619#issuecomment-577264889",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/4619",
    "id": 577264889,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU3NzI2NDg4OQ==",
    "user": {
      "login": "torfbolt",
      "id": 233423,
      "node_id": "MDQ6VXNlcjIzMzQyMw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/233423?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/torfbolt",
      "html_url": "https://github.com/torfbolt",
      "followers_url": "https://api.github.com/users/torfbolt/followers",
      "following_url": "https://api.github.com/users/torfbolt/following{/other_user}",
      "gists_url": "https://api.github.com/users/torfbolt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/torfbolt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/torfbolt/subscriptions",
      "organizations_url": "https://api.github.com/users/torfbolt/orgs",
      "repos_url": "https://api.github.com/users/torfbolt/repos",
      "events_url": "https://api.github.com/users/torfbolt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/torfbolt/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-01-22T16:19:04Z",
    "updated_at": "2020-01-22T16:19:04Z",
    "author_association": "NONE",
    "body": "This probably explains and should fix #4578 and #4582",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/577264889/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/578072441",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/4619#issuecomment-578072441",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/4619",
    "id": 578072441,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU3ODA3MjQ0MQ==",
    "user": {
      "login": "mondsen",
      "id": 53463563,
      "node_id": "MDQ6VXNlcjUzNDYzNTYz",
      "avatar_url": "https://avatars.githubusercontent.com/u/53463563?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mondsen",
      "html_url": "https://github.com/mondsen",
      "followers_url": "https://api.github.com/users/mondsen/followers",
      "following_url": "https://api.github.com/users/mondsen/following{/other_user}",
      "gists_url": "https://api.github.com/users/mondsen/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mondsen/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mondsen/subscriptions",
      "organizations_url": "https://api.github.com/users/mondsen/orgs",
      "repos_url": "https://api.github.com/users/mondsen/repos",
      "events_url": "https://api.github.com/users/mondsen/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mondsen/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-01-24T10:22:53Z",
    "updated_at": "2020-01-24T10:22:53Z",
    "author_association": "NONE",
    "body": "Thanks a lot for this issue. Have you target hardware spec (minimum) that shall be capable of running the beacon chain?",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/578072441/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
