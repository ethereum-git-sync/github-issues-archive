{
  "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/6107",
  "repository_url": "https://api.github.com/repos/prysmaticlabs/prysm",
  "labels_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/6107/labels{/name}",
  "comments_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/6107/comments",
  "events_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/6107/events",
  "html_url": "https://github.com/prysmaticlabs/prysm/issues/6107",
  "id": 630206652,
  "node_id": "MDU6SXNzdWU2MzAyMDY2NTI=",
  "number": 6107,
  "title": "ComputeCommittee effeciency depends on separated cache fill",
  "user": {
    "login": "protolambda",
    "id": 19571989,
    "node_id": "MDQ6VXNlcjE5NTcxOTg5",
    "avatar_url": "https://avatars.githubusercontent.com/u/19571989?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/protolambda",
    "html_url": "https://github.com/protolambda",
    "followers_url": "https://api.github.com/users/protolambda/followers",
    "following_url": "https://api.github.com/users/protolambda/following{/other_user}",
    "gists_url": "https://api.github.com/users/protolambda/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/protolambda/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/protolambda/subscriptions",
    "organizations_url": "https://api.github.com/users/protolambda/orgs",
    "repos_url": "https://api.github.com/users/protolambda/repos",
    "events_url": "https://api.github.com/users/protolambda/events{/privacy}",
    "received_events_url": "https://api.github.com/users/protolambda/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 802129907,
      "node_id": "MDU6TGFiZWw4MDIxMjk5MDc=",
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/labels/Help%20Wanted",
      "name": "Help Wanted",
      "color": "33aa3f",
      "default": false,
      "description": "Extra attention is needed"
    },
    {
      "id": 1085357783,
      "node_id": "MDU6TGFiZWwxMDg1MzU3Nzgz",
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/labels/Priority:%20Low",
      "name": "Priority: Low",
      "color": "26f7bd",
      "default": false,
      "description": "Low priority item"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 7,
  "created_at": "2020-06-03T18:01:36Z",
  "updated_at": "2020-06-29T18:43:13Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Description\r\n\r\n`ComputeCommittee` in the beacon core helpers package uses a cached array of active validator indices, but the actual shuffling is not cached.\r\nWhen all active indices are shuffled, you get all the committees for that epoch. No need to re-shuffle only to get the next slice out of the shuffling result.\r\n\r\n### Has this worked before in a previous version?\r\n\r\nIt's not a bug, just an optimization that is not utilized correctly. Causing slowness, with potential side effects.\r\n\r\nSorry for using the bug template, the templates/labels are limited, what do I use for issues that are good enough for potential DOS or performance penalty, but not strictly a bug?\r\n\r\n## üî¨ Minimal Reproduction\r\n\r\n1. `BeaconCommitteeFromState` calls `ActiveValidatorIndices` which caches active indices.\r\n2. `BeaconCommitteeFromState` calls `BeaconCommittee` which seems to do a second unnecessary cache lookup (minor issue)\r\n3. `BeaconCommittee` calls `ComputeCommittee` to get the committee\r\n4. `ComputeCommittee` shuffles all active validators, but then only slices out a single committee, and forgets about the other results.\r\n\r\n~~Caching all resulting committees would improve the committee computation a lot. Every other client is already doing this, afaik. Small step to cache the shuffling, alike to caching the active indices.~~\r\n\r\n## üî• Error\r\n\r\nx\r\n\r\n## üåç  Your Environment\r\n\r\nx\r\n\r\nEdit: so there is a way of caching the full shuffling, but it's a different code path to fill that cache. It would be nice to just fill it when you have the chance to do so anyway, and get rid of the complexities to fill the cache elsewhere.\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/6107/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/6107/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/638371771",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/6107#issuecomment-638371771",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/6107",
    "id": 638371771,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYzODM3MTc3MQ==",
    "user": {
      "login": "terencechain",
      "id": 21316537,
      "node_id": "MDQ6VXNlcjIxMzE2NTM3",
      "avatar_url": "https://avatars.githubusercontent.com/u/21316537?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/terencechain",
      "html_url": "https://github.com/terencechain",
      "followers_url": "https://api.github.com/users/terencechain/followers",
      "following_url": "https://api.github.com/users/terencechain/following{/other_user}",
      "gists_url": "https://api.github.com/users/terencechain/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/terencechain/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/terencechain/subscriptions",
      "organizations_url": "https://api.github.com/users/terencechain/orgs",
      "repos_url": "https://api.github.com/users/terencechain/repos",
      "events_url": "https://api.github.com/users/terencechain/events{/privacy}",
      "received_events_url": "https://api.github.com/users/terencechain/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-06-03T18:13:31Z",
    "updated_at": "2020-06-03T18:13:31Z",
    "author_association": "MEMBER",
    "body": "I dont think we re-run shuffling for every committee. At least I haven't seen that in a flame in a while. The shuffled version of committee is cached here:\r\n\r\nhttps://github.com/prysmaticlabs/prysm/blob/master/beacon-chain/cache/committee.go#L40",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/638371771/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/638374657",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/6107#issuecomment-638374657",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/6107",
    "id": 638374657,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYzODM3NDY1Nw==",
    "user": {
      "login": "protolambda",
      "id": 19571989,
      "node_id": "MDQ6VXNlcjE5NTcxOTg5",
      "avatar_url": "https://avatars.githubusercontent.com/u/19571989?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/protolambda",
      "html_url": "https://github.com/protolambda",
      "followers_url": "https://api.github.com/users/protolambda/followers",
      "following_url": "https://api.github.com/users/protolambda/following{/other_user}",
      "gists_url": "https://api.github.com/users/protolambda/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/protolambda/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/protolambda/subscriptions",
      "organizations_url": "https://api.github.com/users/protolambda/orgs",
      "repos_url": "https://api.github.com/users/protolambda/repos",
      "events_url": "https://api.github.com/users/protolambda/events{/privacy}",
      "received_events_url": "https://api.github.com/users/protolambda/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-06-03T18:18:40Z",
    "updated_at": "2020-06-03T18:19:30Z",
    "author_association": "NONE",
    "body": "This is where I think it happens: https://github.com/prysmaticlabs/prysm/blob/80539d9028db7a94db0da64b9ed47fb9393d6773/beacon-chain/core/helpers/committee.go#L140\r\n\r\nMy estimate is that it costs you about a second per epoch at 30k vals. Likely spread across the usage of the committees. But it scales linearly, so it may become problematic with higher counts. And API users may hit it, if they quickly query more committees in the same epoch.\r\n\r\nAnd I'm confused by your link, it seems like a duplicate code path. It looks much better there, but having both options doesn't really help.",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/638374657/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/638377837",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/6107#issuecomment-638377837",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/6107",
    "id": 638377837,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYzODM3NzgzNw==",
    "user": {
      "login": "terencechain",
      "id": 21316537,
      "node_id": "MDQ6VXNlcjIxMzE2NTM3",
      "avatar_url": "https://avatars.githubusercontent.com/u/21316537?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/terencechain",
      "html_url": "https://github.com/terencechain",
      "followers_url": "https://api.github.com/users/terencechain/followers",
      "following_url": "https://api.github.com/users/terencechain/following{/other_user}",
      "gists_url": "https://api.github.com/users/terencechain/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/terencechain/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/terencechain/subscriptions",
      "organizations_url": "https://api.github.com/users/terencechain/orgs",
      "repos_url": "https://api.github.com/users/terencechain/repos",
      "events_url": "https://api.github.com/users/terencechain/events{/privacy}",
      "received_events_url": "https://api.github.com/users/terencechain/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-06-03T18:23:57Z",
    "updated_at": "2020-06-03T18:23:57Z",
    "author_association": "MEMBER",
    "body": "We won't reach that line if there's already a committee cached via `seed`, `slot` and `committee_id`:\r\n\r\nhttps://github.com/prysmaticlabs/prysm/blob/master/beacon-chain/core/helpers/committee.go#L102",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/638377837/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/638379669",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/6107#issuecomment-638379669",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/6107",
    "id": 638379669,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYzODM3OTY2OQ==",
    "user": {
      "login": "protolambda",
      "id": 19571989,
      "node_id": "MDQ6VXNlcjE5NTcxOTg5",
      "avatar_url": "https://avatars.githubusercontent.com/u/19571989?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/protolambda",
      "html_url": "https://github.com/protolambda",
      "followers_url": "https://api.github.com/users/protolambda/followers",
      "following_url": "https://api.github.com/users/protolambda/following{/other_user}",
      "gists_url": "https://api.github.com/users/protolambda/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/protolambda/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/protolambda/subscriptions",
      "organizations_url": "https://api.github.com/users/protolambda/orgs",
      "repos_url": "https://api.github.com/users/protolambda/repos",
      "events_url": "https://api.github.com/users/protolambda/events{/privacy}",
      "received_events_url": "https://api.github.com/users/protolambda/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-06-03T18:27:04Z",
    "updated_at": "2020-06-03T18:27:04Z",
    "author_association": "NONE",
    "body": "Great :), but why is it even there then? Just filling the cache when you can, and not having to manage it so closely, is less error prone.",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/638379669/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/638380890",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/6107#issuecomment-638380890",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/6107",
    "id": 638380890,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYzODM4MDg5MA==",
    "user": {
      "login": "terencechain",
      "id": 21316537,
      "node_id": "MDQ6VXNlcjIxMzE2NTM3",
      "avatar_url": "https://avatars.githubusercontent.com/u/21316537?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/terencechain",
      "html_url": "https://github.com/terencechain",
      "followers_url": "https://api.github.com/users/terencechain/followers",
      "following_url": "https://api.github.com/users/terencechain/following{/other_user}",
      "gists_url": "https://api.github.com/users/terencechain/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/terencechain/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/terencechain/subscriptions",
      "organizations_url": "https://api.github.com/users/terencechain/orgs",
      "repos_url": "https://api.github.com/users/terencechain/repos",
      "events_url": "https://api.github.com/users/terencechain/events{/privacy}",
      "received_events_url": "https://api.github.com/users/terencechain/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-06-03T18:29:11Z",
    "updated_at": "2020-06-03T18:29:11Z",
    "author_association": "MEMBER",
    "body": "I agree on separating the caching layer and the core consensus helper layer! Will use this issue to track that.",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/638380890/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/646174822",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/6107#issuecomment-646174822",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/6107",
    "id": 646174822,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY0NjE3NDgyMg==",
    "user": {
      "login": "protolambda",
      "id": 19571989,
      "node_id": "MDQ6VXNlcjE5NTcxOTg5",
      "avatar_url": "https://avatars.githubusercontent.com/u/19571989?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/protolambda",
      "html_url": "https://github.com/protolambda",
      "followers_url": "https://api.github.com/users/protolambda/followers",
      "following_url": "https://api.github.com/users/protolambda/following{/other_user}",
      "gists_url": "https://api.github.com/users/protolambda/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/protolambda/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/protolambda/subscriptions",
      "organizations_url": "https://api.github.com/users/protolambda/orgs",
      "repos_url": "https://api.github.com/users/protolambda/repos",
      "events_url": "https://api.github.com/users/protolambda/events{/privacy}",
      "received_events_url": "https://api.github.com/users/protolambda/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-06-18T17:00:31Z",
    "updated_at": "2020-06-18T17:00:31Z",
    "author_association": "NONE",
    "body": "Is anyone looking at this issue still? I think it might still affect the lookup times of API calls.",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/646174822/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/646176960",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/6107#issuecomment-646176960",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/6107",
    "id": 646176960,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY0NjE3Njk2MA==",
    "user": {
      "login": "terencechain",
      "id": 21316537,
      "node_id": "MDQ6VXNlcjIxMzE2NTM3",
      "avatar_url": "https://avatars.githubusercontent.com/u/21316537?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/terencechain",
      "html_url": "https://github.com/terencechain",
      "followers_url": "https://api.github.com/users/terencechain/followers",
      "following_url": "https://api.github.com/users/terencechain/following{/other_user}",
      "gists_url": "https://api.github.com/users/terencechain/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/terencechain/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/terencechain/subscriptions",
      "organizations_url": "https://api.github.com/users/terencechain/orgs",
      "repos_url": "https://api.github.com/users/terencechain/repos",
      "events_url": "https://api.github.com/users/terencechain/events{/privacy}",
      "received_events_url": "https://api.github.com/users/terencechain/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-06-18T17:02:46Z",
    "updated_at": "2020-06-18T17:02:46Z",
    "author_association": "MEMBER",
    "body": "Not that I'm aware of. I think we are still working on urgent bug fixes and validator account revamp. Anyone is more than welcome to pick this up if they are interested! ",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/646176960/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
