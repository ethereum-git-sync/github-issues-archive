{
  "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/10536",
  "repository_url": "https://api.github.com/repos/prysmaticlabs/prysm",
  "labels_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/10536/labels{/name}",
  "comments_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/10536/comments",
  "events_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/10536/events",
  "html_url": "https://github.com/prysmaticlabs/prysm/issues/10536",
  "id": 1206296029,
  "node_id": "I_kwDOBvuov85H5p3d",
  "number": 10536,
  "title": "Parallelize BLS signature verification",
  "user": {
    "login": "Giulio2002",
    "id": 29233688,
    "node_id": "MDQ6VXNlcjI5MjMzNjg4",
    "avatar_url": "https://avatars.githubusercontent.com/u/29233688?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Giulio2002",
    "html_url": "https://github.com/Giulio2002",
    "followers_url": "https://api.github.com/users/Giulio2002/followers",
    "following_url": "https://api.github.com/users/Giulio2002/following{/other_user}",
    "gists_url": "https://api.github.com/users/Giulio2002/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Giulio2002/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Giulio2002/subscriptions",
    "organizations_url": "https://api.github.com/users/Giulio2002/orgs",
    "repos_url": "https://api.github.com/users/Giulio2002/repos",
    "events_url": "https://api.github.com/users/Giulio2002/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Giulio2002/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 6,
  "created_at": "2022-04-17T06:42:34Z",
  "updated_at": "2022-08-15T22:23:56Z",
  "closed_at": "2022-08-15T22:23:56Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "# ðŸ’Ž Issue\r\n\r\nAs of now, Prysm is processing BLS signatures without any parallelization, this makes it slow on initial-sync and BLS signatures are the main bottlenecks for Consensus Layer clients.\r\n\r\n### Background\r\n\r\nI understand that optimizing initial sync is not a priority because of weak subjectivity, but still i think it would not be an ugly addition to the mix, as i believe it would strongly diminish initial sync time by a non-significant degree.\r\n\r\n### Description\r\n\r\nWhat i would do, is the following:\r\n* Accumulating bigger block batches (500-2000 blocks vs 64), with multiple p2p requests\r\n* When accumulating the set, instead of slap it in a linear function, slap it into multiple goroutines/jobs with a worker function.\r\n* Send each block over the workers with a channel and process the signature accordingly, to then send them back through a subsequent goroutine",
  "closed_by": {
    "login": "rauljordan",
    "id": 5572669,
    "node_id": "MDQ6VXNlcjU1NzI2Njk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5572669?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/rauljordan",
    "html_url": "https://github.com/rauljordan",
    "followers_url": "https://api.github.com/users/rauljordan/followers",
    "following_url": "https://api.github.com/users/rauljordan/following{/other_user}",
    "gists_url": "https://api.github.com/users/rauljordan/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/rauljordan/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rauljordan/subscriptions",
    "organizations_url": "https://api.github.com/users/rauljordan/orgs",
    "repos_url": "https://api.github.com/users/rauljordan/repos",
    "events_url": "https://api.github.com/users/rauljordan/events{/privacy}",
    "received_events_url": "https://api.github.com/users/rauljordan/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/10536/reactions",
    "total_count": 1,
    "+1": 1,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/10536/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1100981503",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/10536#issuecomment-1100981503",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/10536",
    "id": 1100981503,
    "node_id": "IC_kwDOBvuov85Bn6T_",
    "user": {
      "login": "nisdas",
      "id": 33201827,
      "node_id": "MDQ6VXNlcjMzMjAxODI3",
      "avatar_url": "https://avatars.githubusercontent.com/u/33201827?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nisdas",
      "html_url": "https://github.com/nisdas",
      "followers_url": "https://api.github.com/users/nisdas/followers",
      "following_url": "https://api.github.com/users/nisdas/following{/other_user}",
      "gists_url": "https://api.github.com/users/nisdas/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nisdas/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nisdas/subscriptions",
      "organizations_url": "https://api.github.com/users/nisdas/orgs",
      "repos_url": "https://api.github.com/users/nisdas/repos",
      "events_url": "https://api.github.com/users/nisdas/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nisdas/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-04-18T00:31:25Z",
    "updated_at": "2022-04-18T00:31:25Z",
    "author_association": "MEMBER",
    "body": "This is already done here:\r\nhttps://github.com/prysmaticlabs/prysm/blob/develop/crypto/bls/blst/signature.go#L254\r\nhttps://github.com/supranational/blst/blob/master/bindings/go/blst.go#L512\r\n\r\nSignature verification is multi-threaded right now. If you desire to have a larger batch limit then you can specify `--block-batch-limit` . The reason we do not specify too high a batch size is because it breaks rate limits among other peers. ",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1100981503/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1102307661",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/10536#issuecomment-1102307661",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/10536",
    "id": 1102307661,
    "node_id": "IC_kwDOBvuov85Bs-FN",
    "user": {
      "login": "Giulio2002",
      "id": 29233688,
      "node_id": "MDQ6VXNlcjI5MjMzNjg4",
      "avatar_url": "https://avatars.githubusercontent.com/u/29233688?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Giulio2002",
      "html_url": "https://github.com/Giulio2002",
      "followers_url": "https://api.github.com/users/Giulio2002/followers",
      "following_url": "https://api.github.com/users/Giulio2002/following{/other_user}",
      "gists_url": "https://api.github.com/users/Giulio2002/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Giulio2002/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Giulio2002/subscriptions",
      "organizations_url": "https://api.github.com/users/Giulio2002/orgs",
      "repos_url": "https://api.github.com/users/Giulio2002/repos",
      "events_url": "https://api.github.com/users/Giulio2002/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Giulio2002/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-04-19T08:42:37Z",
    "updated_at": "2022-04-19T08:42:37Z",
    "author_association": "CONTRIBUTOR",
    "body": "is BLS Signature Aggregate verification multi-threaded under the hood? I thought aggregation verification ()is not based on multi-threading but rather on some BLS properties (not a mathematician myself lol). anyway 64 blocks is not enough for any significant improvement with multi-threading, what i meant was not increase the raw amount of blocks we request but rather, accumulate these batches in one big batch we keep internally and once we surpass a certain threshold, aggregate them and verify them at once.",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1102307661/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1102322858",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/10536#issuecomment-1102322858",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/10536",
    "id": 1102322858,
    "node_id": "IC_kwDOBvuov85BtByq",
    "user": {
      "login": "prestonvanloon",
      "id": 7246818,
      "node_id": "MDQ6VXNlcjcyNDY4MTg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7246818?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/prestonvanloon",
      "html_url": "https://github.com/prestonvanloon",
      "followers_url": "https://api.github.com/users/prestonvanloon/followers",
      "following_url": "https://api.github.com/users/prestonvanloon/following{/other_user}",
      "gists_url": "https://api.github.com/users/prestonvanloon/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/prestonvanloon/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/prestonvanloon/subscriptions",
      "organizations_url": "https://api.github.com/users/prestonvanloon/orgs",
      "repos_url": "https://api.github.com/users/prestonvanloon/repos",
      "events_url": "https://api.github.com/users/prestonvanloon/events{/privacy}",
      "received_events_url": "https://api.github.com/users/prestonvanloon/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-04-19T08:50:37Z",
    "updated_at": "2022-04-19T08:50:37Z",
    "author_association": "MEMBER",
    "body": "> anyway 64 blocks is not enough for any significant improvement with multi-threading\r\n\r\nCould you provide a benchmark to suggest a better number?",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1102322858/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1102419707",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/10536#issuecomment-1102419707",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/10536",
    "id": 1102419707,
    "node_id": "IC_kwDOBvuov85BtZb7",
    "user": {
      "login": "Giulio2002",
      "id": 29233688,
      "node_id": "MDQ6VXNlcjI5MjMzNjg4",
      "avatar_url": "https://avatars.githubusercontent.com/u/29233688?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Giulio2002",
      "html_url": "https://github.com/Giulio2002",
      "followers_url": "https://api.github.com/users/Giulio2002/followers",
      "following_url": "https://api.github.com/users/Giulio2002/following{/other_user}",
      "gists_url": "https://api.github.com/users/Giulio2002/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Giulio2002/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Giulio2002/subscriptions",
      "organizations_url": "https://api.github.com/users/Giulio2002/orgs",
      "repos_url": "https://api.github.com/users/Giulio2002/repos",
      "events_url": "https://api.github.com/users/Giulio2002/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Giulio2002/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-04-19T09:53:15Z",
    "updated_at": "2022-04-19T09:53:15Z",
    "author_association": "CONTRIBUTOR",
    "body": "can try doing this",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1102419707/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1102429787",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/10536#issuecomment-1102429787",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/10536",
    "id": 1102429787,
    "node_id": "IC_kwDOBvuov85Btb5b",
    "user": {
      "login": "nisdas",
      "id": 33201827,
      "node_id": "MDQ6VXNlcjMzMjAxODI3",
      "avatar_url": "https://avatars.githubusercontent.com/u/33201827?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nisdas",
      "html_url": "https://github.com/nisdas",
      "followers_url": "https://api.github.com/users/nisdas/followers",
      "following_url": "https://api.github.com/users/nisdas/following{/other_user}",
      "gists_url": "https://api.github.com/users/nisdas/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nisdas/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nisdas/subscriptions",
      "organizations_url": "https://api.github.com/users/nisdas/orgs",
      "repos_url": "https://api.github.com/users/nisdas/repos",
      "events_url": "https://api.github.com/users/nisdas/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nisdas/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-04-19T09:58:34Z",
    "updated_at": "2022-04-19T09:58:34Z",
    "author_association": "MEMBER",
    "body": "> anyway 64 blocks is not enough for any significant improvement with multi-threading, what i meant was not increase the raw amount of blocks we request but rather, accumulate these batches in one big batch we keep internally and once we surpass a certain threshold, aggregate them and verify them at once.\r\n\r\nIf you that look at the method under the hood that is exactly what it does. 64 blocks != 64 signatures , there are diminishing returns to having bigger batches simply for the fact that aggregates are heavier in mainnet currently. A block contains many different signature sets to verify : \r\n-> Proposer Signature\r\n-> Randao Signature\r\n-> Sync Contribution Signature\r\n-> Aggregate Signatures\r\n\r\nThe last set of signatures take by far the longest to verify. There are a maximum of 128 aggregates in a block, so you would have to verify a total of 131 signatures per block. With 64 blocks this comes out to 8384 signatures per batch. Having a larger batch will have a limited improvement as the only gain would be in final exponentiation. We would still have to aggregate all public keys for each aggregate before we can verify a single aggregate signature. Now, you can repeat this step for all the other 127 aggregate signatures, and the time to aggregate the pubkeys would be non-trivial.  A larger batch wouldn't improve the time taken for these other steps. ",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1102429787/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1215925858",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/10536#issuecomment-1215925858",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/10536",
    "id": 1215925858,
    "node_id": "IC_kwDOBvuov85IeY5i",
    "user": {
      "login": "rauljordan",
      "id": 5572669,
      "node_id": "MDQ6VXNlcjU1NzI2Njk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5572669?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rauljordan",
      "html_url": "https://github.com/rauljordan",
      "followers_url": "https://api.github.com/users/rauljordan/followers",
      "following_url": "https://api.github.com/users/rauljordan/following{/other_user}",
      "gists_url": "https://api.github.com/users/rauljordan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rauljordan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rauljordan/subscriptions",
      "organizations_url": "https://api.github.com/users/rauljordan/orgs",
      "repos_url": "https://api.github.com/users/rauljordan/repos",
      "events_url": "https://api.github.com/users/rauljordan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rauljordan/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-15T22:23:56Z",
    "updated_at": "2022-08-15T22:23:56Z",
    "author_association": "CONTRIBUTOR",
    "body": "hi @Giulio2002 does this answer your questions? Let us know if we can still help with anything. If so, we can re-open",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1215925858/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
