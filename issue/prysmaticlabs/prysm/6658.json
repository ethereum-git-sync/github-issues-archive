{
  "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/6658",
  "repository_url": "https://api.github.com/repos/prysmaticlabs/prysm",
  "labels_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/6658/labels{/name}",
  "comments_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/6658/comments",
  "events_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/6658/events",
  "html_url": "https://github.com/prysmaticlabs/prysm/issues/6658",
  "id": 662326289,
  "node_id": "MDU6SXNzdWU2NjIzMjYyODk=",
  "number": 6658,
  "title": "Beacon state append validator bottleneck",
  "user": {
    "login": "terencechain",
    "id": 21316537,
    "node_id": "MDQ6VXNlcjIxMzE2NTM3",
    "avatar_url": "https://avatars.githubusercontent.com/u/21316537?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/terencechain",
    "html_url": "https://github.com/terencechain",
    "followers_url": "https://api.github.com/users/terencechain/followers",
    "following_url": "https://api.github.com/users/terencechain/following{/other_user}",
    "gists_url": "https://api.github.com/users/terencechain/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/terencechain/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/terencechain/subscriptions",
    "organizations_url": "https://api.github.com/users/terencechain/orgs",
    "repos_url": "https://api.github.com/users/terencechain/repos",
    "events_url": "https://api.github.com/users/terencechain/events{/privacy}",
    "received_events_url": "https://api.github.com/users/terencechain/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 802129906,
      "node_id": "MDU6TGFiZWw4MDIxMjk5MDY=",
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/labels/Enhancement",
      "name": "Enhancement",
      "color": "84b6eb",
      "default": false,
      "description": "New feature or request"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 0,
  "created_at": "2020-07-20T22:23:40Z",
  "updated_at": "2020-08-07T01:42:51Z",
  "closed_at": "2020-08-07T01:42:51Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "To append a validator in the beacon state, there's one very inefficient part and that is to update validator pubkey to index mapping.  We update from scratch for every validator\r\n```go\r\nfunc (b *BeaconState) AppendValidator(val *ethpb.Validator) error {\r\n        ...\r\n\tvalMap := coreutils.ValidatorIndexMap(b.state.Validators)\r\n\tb.valIdxMap = valMap\r\n\treturn nil\r\n}\r\n```\r\n\r\nLet's look at what `ValidatorIndexMap` does:\r\n```go\r\nfunc ValidatorIndexMap(validators []*ethpb.Validator) map[[48]byte]uint64 {\r\n\tm := make(map[[48]byte]uint64, len(validators))\r\n\tif validators == nil {\r\n\t\treturn m\r\n\t}\r\n\tfor idx, record := range validators {\r\n\t\tif record == nil {\r\n\t\t\tcontinue\r\n\t\t}\r\n\t\tkey := bytesutil.ToBytes48(record.PublicKey)\r\n\t\tm[key] = uint64(idx)\r\n\t}\r\n\treturn m\r\n}\r\n```\r\n`ValidatorIndexMap` loops through the input validators list and construct a mapping of validator public key to id.\r\n\r\nNow imagine doing the above for every validator that gets appended to the state. It's really an inefficient process and it shows up during initial syncing phase. As seen from the below flame graph, when blocks are full of deposits, 10% of the run time is filled with `ValidatorIndexMap`\r\n\r\n![Screen Shot 2020-07-20 at 2 23 05 PM](https://user-images.githubusercontent.com/21316537/87991916-ec372500-ca9b-11ea-9f04-26f43e134ad8.png)\r\n",
  "closed_by": {
    "login": "prylabs-bulldozer[bot]",
    "id": 58059840,
    "node_id": "MDM6Qm90NTgwNTk4NDA=",
    "avatar_url": "https://avatars.githubusercontent.com/in/47372?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/prylabs-bulldozer%5Bbot%5D",
    "html_url": "https://github.com/apps/prylabs-bulldozer",
    "followers_url": "https://api.github.com/users/prylabs-bulldozer%5Bbot%5D/followers",
    "following_url": "https://api.github.com/users/prylabs-bulldozer%5Bbot%5D/following{/other_user}",
    "gists_url": "https://api.github.com/users/prylabs-bulldozer%5Bbot%5D/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/prylabs-bulldozer%5Bbot%5D/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/prylabs-bulldozer%5Bbot%5D/subscriptions",
    "organizations_url": "https://api.github.com/users/prylabs-bulldozer%5Bbot%5D/orgs",
    "repos_url": "https://api.github.com/users/prylabs-bulldozer%5Bbot%5D/repos",
    "events_url": "https://api.github.com/users/prylabs-bulldozer%5Bbot%5D/events{/privacy}",
    "received_events_url": "https://api.github.com/users/prylabs-bulldozer%5Bbot%5D/received_events",
    "type": "Bot",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/6658/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/6658/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[

]
