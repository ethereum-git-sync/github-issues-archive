{
  "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/12457",
  "repository_url": "https://api.github.com/repos/prysmaticlabs/prysm",
  "labels_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/12457/labels{/name}",
  "comments_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/12457/comments",
  "events_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/12457/events",
  "html_url": "https://github.com/prysmaticlabs/prysm/issues/12457",
  "id": 1723193858,
  "node_id": "I_kwDOBvuov85mtdoC",
  "number": 12457,
  "title": "Slow performance on grpc `/ethereum.eth.v1alpha1.BeaconNodeValidator/MultipleValidatorStatus`",
  "user": {
    "login": "ihooni",
    "id": 37792049,
    "node_id": "MDQ6VXNlcjM3NzkyMDQ5",
    "avatar_url": "https://avatars.githubusercontent.com/u/37792049?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ihooni",
    "html_url": "https://github.com/ihooni",
    "followers_url": "https://api.github.com/users/ihooni/followers",
    "following_url": "https://api.github.com/users/ihooni/following{/other_user}",
    "gists_url": "https://api.github.com/users/ihooni/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ihooni/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ihooni/subscriptions",
    "organizations_url": "https://api.github.com/users/ihooni/orgs",
    "repos_url": "https://api.github.com/users/ihooni/repos",
    "events_url": "https://api.github.com/users/ihooni/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ihooni/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "james-prysm",
    "id": 90280386,
    "node_id": "MDQ6VXNlcjkwMjgwMzg2",
    "avatar_url": "https://avatars.githubusercontent.com/u/90280386?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/james-prysm",
    "html_url": "https://github.com/james-prysm",
    "followers_url": "https://api.github.com/users/james-prysm/followers",
    "following_url": "https://api.github.com/users/james-prysm/following{/other_user}",
    "gists_url": "https://api.github.com/users/james-prysm/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/james-prysm/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/james-prysm/subscriptions",
    "organizations_url": "https://api.github.com/users/james-prysm/orgs",
    "repos_url": "https://api.github.com/users/james-prysm/repos",
    "events_url": "https://api.github.com/users/james-prysm/events{/privacy}",
    "received_events_url": "https://api.github.com/users/james-prysm/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "james-prysm",
      "id": 90280386,
      "node_id": "MDQ6VXNlcjkwMjgwMzg2",
      "avatar_url": "https://avatars.githubusercontent.com/u/90280386?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/james-prysm",
      "html_url": "https://github.com/james-prysm",
      "followers_url": "https://api.github.com/users/james-prysm/followers",
      "following_url": "https://api.github.com/users/james-prysm/following{/other_user}",
      "gists_url": "https://api.github.com/users/james-prysm/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/james-prysm/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/james-prysm/subscriptions",
      "organizations_url": "https://api.github.com/users/james-prysm/orgs",
      "repos_url": "https://api.github.com/users/james-prysm/repos",
      "events_url": "https://api.github.com/users/james-prysm/events{/privacy}",
      "received_events_url": "https://api.github.com/users/james-prysm/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2023-05-24T05:22:24Z",
  "updated_at": "2023-06-15T22:20:02Z",
  "closed_at": "2023-06-15T22:20:02Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "<!--ðŸ’ŽðŸ’ŽðŸ’ŽðŸ’ŽðŸ’ŽðŸ’ŽðŸ’ŽðŸ’ŽðŸ’ŽðŸ’ŽðŸ’ŽðŸ’ŽðŸ’ŽðŸ’ŽðŸ’ŽðŸ’ŽðŸ’ŽðŸ’ŽðŸ’ŽðŸ’ŽðŸ’ŽðŸ’ŽðŸ’ŽðŸ’ŽðŸ’ŽðŸ’ŽðŸ’ŽðŸ’Ž\r\n\r\nHellooo! ðŸ˜„ \r\n\r\nTo help us tend to your issue faster, please search our currently open issues before submitting a new one.\r\nExisting issues often contain information about workarounds, resolution, or progress updates.\r\n\r\nðŸ’ŽðŸ’ŽðŸ’ŽðŸ’ŽðŸ’ŽðŸ’ŽðŸ’ŽðŸ’ŽðŸ’ŽðŸ’ŽðŸ’ŽðŸ’ŽðŸ’ŽðŸ’ŽðŸ’ŽðŸ’ŽðŸ’ŽðŸ’ŽðŸ’ŽðŸ’ŽðŸ’ŽðŸ’ŽðŸ’ŽðŸ’ŽðŸ’ŽðŸ’ŽðŸ’ŽðŸ’ŽðŸ’ŽðŸ’ŽðŸ’Ž-->\r\n\r\n# ðŸ’Ž Issue\r\n\r\n### Background\r\n\r\n\r\nWhen calling grpc `MultipleValidatorStatus`, the for loop below is executed for getting the last activated validator index if there are PENDING/DEPOSITIED/PARTIALLY_DEPOISTED validators.\r\n\r\nhttps://github.com/prysmaticlabs/prysm/blob/666188dfea8c5d6ba0d9650b1f4d24c3122906d1/beacon-chain/rpc/prysm/v1alpha1/validator/status.go#L345-L354\r\n\r\nThe problem is that this for loop is executed for each pending validators in `MultipleValidatorStatus` request.\r\n\r\nCurrently, there are more than 70,000 pending validators on the eth network.\r\n<img width=\"251\" alt=\"Screenshot 2023-05-24 at 2 11 06 PM\" src=\"https://github.com/prysmaticlabs/prysm/assets/37792049/a77f7c2a-8bd5-40d3-8d1e-3f209cf71104\">\r\n\r\nSo, if `MultipleValidatorStatus` is requested for 100 pending validators, the code inside the for loop will be executed 70,000 * 100 = 7,000,000 times.\r\n\r\n### Description\r\n\r\nBelow is a flame graph when `MultipleValidatorStatus` is requested for 100 pending validators. Most of the time is spent in the for loop.\r\n<img width=\"1565\" alt=\"Screenshot 2023-05-24 at 2 14 25 PM\" src=\"https://github.com/prysmaticlabs/prysm/assets/37792049/159211df-5cd2-4a42-9737-e5f5f5a7dd70\">\r\n\r\nIt seems that a significant performance improvement can be achieved by replacing the simple for loop with binary search or calculating `lastActivatedvalidatorIndex` only once and reusing it.\r\n\r\nI think this improvement is necessary because the grpc `MultipleValidatorStatus` is called in `AllValidatorsAreExited`, which is executed before performing the roles in the validator-client.\r\n\r\nhttps://github.com/prysmaticlabs/prysm/blob/666188dfea8c5d6ba0d9650b1f4d24c3122906d1/validator/client/runner.go#L94-L103\r\n",
  "closed_by": {
    "login": "james-prysm",
    "id": 90280386,
    "node_id": "MDQ6VXNlcjkwMjgwMzg2",
    "avatar_url": "https://avatars.githubusercontent.com/u/90280386?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/james-prysm",
    "html_url": "https://github.com/james-prysm",
    "followers_url": "https://api.github.com/users/james-prysm/followers",
    "following_url": "https://api.github.com/users/james-prysm/following{/other_user}",
    "gists_url": "https://api.github.com/users/james-prysm/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/james-prysm/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/james-prysm/subscriptions",
    "organizations_url": "https://api.github.com/users/james-prysm/orgs",
    "repos_url": "https://api.github.com/users/james-prysm/repos",
    "events_url": "https://api.github.com/users/james-prysm/events{/privacy}",
    "received_events_url": "https://api.github.com/users/james-prysm/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/12457/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/12457/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1560689722",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/12457#issuecomment-1560689722",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/12457",
    "id": 1560689722,
    "node_id": "IC_kwDOBvuov85dBjw6",
    "user": {
      "login": "nisdas",
      "id": 33201827,
      "node_id": "MDQ6VXNlcjMzMjAxODI3",
      "avatar_url": "https://avatars.githubusercontent.com/u/33201827?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nisdas",
      "html_url": "https://github.com/nisdas",
      "followers_url": "https://api.github.com/users/nisdas/followers",
      "following_url": "https://api.github.com/users/nisdas/following{/other_user}",
      "gists_url": "https://api.github.com/users/nisdas/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nisdas/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nisdas/subscriptions",
      "organizations_url": "https://api.github.com/users/nisdas/orgs",
      "repos_url": "https://api.github.com/users/nisdas/repos",
      "events_url": "https://api.github.com/users/nisdas/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nisdas/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-24T08:37:53Z",
    "updated_at": "2023-05-24T08:37:53Z",
    "author_association": "MEMBER",
    "body": "> It seems that a significant performance improvement can be achieved by replacing the simple for loop with binary search or calculating lastActivatedvalidatorIndex only once and reusing it.\r\n\r\nThe last one is preferable and simpler to implement, also `AllValidatorsAreExited` needs to be done only once an epoch. (epoch start). This can be easily added in too. \r\n\r\ncc @james-prysm ",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1560689722/reactions",
      "total_count": 2,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 2,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1562164288",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/12457#issuecomment-1562164288",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/12457",
    "id": 1562164288,
    "node_id": "IC_kwDOBvuov85dHLxA",
    "user": {
      "login": "james-prysm",
      "id": 90280386,
      "node_id": "MDQ6VXNlcjkwMjgwMzg2",
      "avatar_url": "https://avatars.githubusercontent.com/u/90280386?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/james-prysm",
      "html_url": "https://github.com/james-prysm",
      "followers_url": "https://api.github.com/users/james-prysm/followers",
      "following_url": "https://api.github.com/users/james-prysm/following{/other_user}",
      "gists_url": "https://api.github.com/users/james-prysm/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/james-prysm/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/james-prysm/subscriptions",
      "organizations_url": "https://api.github.com/users/james-prysm/orgs",
      "repos_url": "https://api.github.com/users/james-prysm/repos",
      "events_url": "https://api.github.com/users/james-prysm/events{/privacy}",
      "received_events_url": "https://api.github.com/users/james-prysm/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-25T02:18:32Z",
    "updated_at": "2023-05-25T02:18:32Z",
    "author_association": "CONTRIBUTOR",
    "body": "Thanks for the feedback I'll try to get something in soon.",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1562164288/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 1,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
