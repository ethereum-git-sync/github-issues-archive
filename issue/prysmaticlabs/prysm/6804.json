{
  "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/6804",
  "repository_url": "https://api.github.com/repos/prysmaticlabs/prysm",
  "labels_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/6804/labels{/name}",
  "comments_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/6804/comments",
  "events_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/6804/events",
  "html_url": "https://github.com/prysmaticlabs/prysm/issues/6804",
  "id": 669581391,
  "node_id": "MDU6SXNzdWU2Njk1ODEzOTE=",
  "number": 6804,
  "title": "Huge memory amount used by validator",
  "user": {
    "login": "Belkaar",
    "id": 2395990,
    "node_id": "MDQ6VXNlcjIzOTU5OTA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2395990?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Belkaar",
    "html_url": "https://github.com/Belkaar",
    "followers_url": "https://api.github.com/users/Belkaar/followers",
    "following_url": "https://api.github.com/users/Belkaar/following{/other_user}",
    "gists_url": "https://api.github.com/users/Belkaar/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Belkaar/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Belkaar/subscriptions",
    "organizations_url": "https://api.github.com/users/Belkaar/orgs",
    "repos_url": "https://api.github.com/users/Belkaar/repos",
    "events_url": "https://api.github.com/users/Belkaar/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Belkaar/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 802129904,
      "node_id": "MDU6TGFiZWw4MDIxMjk5MDQ=",
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/labels/Bug",
      "name": "Bug",
      "color": "ee0701",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 1085357069,
      "node_id": "MDU6TGFiZWwxMDg1MzU3MDY5",
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/labels/Priority:%20High",
      "name": "Priority: High",
      "color": "f7ea26",
      "default": false,
      "description": "High priority item"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "rauljordan",
    "id": 5572669,
    "node_id": "MDQ6VXNlcjU1NzI2Njk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5572669?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/rauljordan",
    "html_url": "https://github.com/rauljordan",
    "followers_url": "https://api.github.com/users/rauljordan/followers",
    "following_url": "https://api.github.com/users/rauljordan/following{/other_user}",
    "gists_url": "https://api.github.com/users/rauljordan/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/rauljordan/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rauljordan/subscriptions",
    "organizations_url": "https://api.github.com/users/rauljordan/orgs",
    "repos_url": "https://api.github.com/users/rauljordan/repos",
    "events_url": "https://api.github.com/users/rauljordan/events{/privacy}",
    "received_events_url": "https://api.github.com/users/rauljordan/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "rauljordan",
      "id": 5572669,
      "node_id": "MDQ6VXNlcjU1NzI2Njk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5572669?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rauljordan",
      "html_url": "https://github.com/rauljordan",
      "followers_url": "https://api.github.com/users/rauljordan/followers",
      "following_url": "https://api.github.com/users/rauljordan/following{/other_user}",
      "gists_url": "https://api.github.com/users/rauljordan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rauljordan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rauljordan/subscriptions",
      "organizations_url": "https://api.github.com/users/rauljordan/orgs",
      "repos_url": "https://api.github.com/users/rauljordan/repos",
      "events_url": "https://api.github.com/users/rauljordan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rauljordan/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2020-07-31T08:53:01Z",
  "updated_at": "2020-08-02T20:02:05Z",
  "closed_at": "2020-08-02T20:02:05Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "# üêû Bug Report\r\n\r\n### Description\r\n\r\nValidator uses lots of ram, about 2-3GB for me.\r\nMemory usage is gradually reduced if system memory gets full as used by other processes (eth1 node for example).\r\nAfter a while memory usage is normal.\r\n\r\n### Has this worked before in a previous version?\r\n\r\nDon't know. Did not use accounts-v2 until now.\r\n\r\n## üî¨ Minimal Reproduction\r\n\r\nSystem memory: 4gb\r\n* Start beacon\r\n* Start a validator with accounts-v2 \"direct\" wallet with 14 keys in it.\r\n* Observe memory usage\r\n* Start eth1 node\r\n* Observer memory usage\r\n\r\n## üî• Error\r\n\r\nNo error messages\r\n\r\n## üåç  Your Environment\r\n\r\n**Operating System:**\r\n\r\n<pre>\r\n  <code>\r\nDebian 10\r\n  </code>\r\n</pre>\r\n\r\n**What version of Prysm are you running? (Which release)**\r\n\r\n<pre>\r\n  <code>\r\n1.0.0-alpha.17\r\n  </code>\r\n</pre>\r\n\r\n**Anything else relevant (validator index / public key)?**\r\n\r\n",
  "closed_by": {
    "login": "terencechain",
    "id": 21316537,
    "node_id": "MDQ6VXNlcjIxMzE2NTM3",
    "avatar_url": "https://avatars.githubusercontent.com/u/21316537?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/terencechain",
    "html_url": "https://github.com/terencechain",
    "followers_url": "https://api.github.com/users/terencechain/followers",
    "following_url": "https://api.github.com/users/terencechain/following{/other_user}",
    "gists_url": "https://api.github.com/users/terencechain/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/terencechain/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/terencechain/subscriptions",
    "organizations_url": "https://api.github.com/users/terencechain/orgs",
    "repos_url": "https://api.github.com/users/terencechain/repos",
    "events_url": "https://api.github.com/users/terencechain/events{/privacy}",
    "received_events_url": "https://api.github.com/users/terencechain/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/6804/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/6804/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/667015097",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/6804#issuecomment-667015097",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/6804",
    "id": 667015097,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY2NzAxNTA5Nw==",
    "user": {
      "login": "Belkaar",
      "id": 2395990,
      "node_id": "MDQ6VXNlcjIzOTU5OTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2395990?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Belkaar",
      "html_url": "https://github.com/Belkaar",
      "followers_url": "https://api.github.com/users/Belkaar/followers",
      "following_url": "https://api.github.com/users/Belkaar/following{/other_user}",
      "gists_url": "https://api.github.com/users/Belkaar/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Belkaar/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Belkaar/subscriptions",
      "organizations_url": "https://api.github.com/users/Belkaar/orgs",
      "repos_url": "https://api.github.com/users/Belkaar/repos",
      "events_url": "https://api.github.com/users/Belkaar/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Belkaar/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-07-31T08:57:17Z",
    "updated_at": "2020-07-31T08:57:17Z",
    "author_association": "NONE",
    "body": "![image](https://user-images.githubusercontent.com/2395990/89018431-2b773880-d31c-11ea-92d9-d4f6da0a1e31.png)\r\n\r\n![image](https://user-images.githubusercontent.com/2395990/89018537-53ff3280-d31c-11ea-85d0-eb09084ecf63.png)\r\n\r\n![image](https://user-images.githubusercontent.com/2395990/89018642-75601e80-d31c-11ea-9ce7-b292f483464b.png)\r\n\r\n![image](https://user-images.githubusercontent.com/2395990/89018715-8d37a280-d31c-11ea-843c-e07ad1981cba.png)\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/667015097/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/667435129",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/6804#issuecomment-667435129",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/6804",
    "id": 667435129,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY2NzQzNTEyOQ==",
    "user": {
      "login": "prestonvanloon",
      "id": 7246818,
      "node_id": "MDQ6VXNlcjcyNDY4MTg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7246818?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/prestonvanloon",
      "html_url": "https://github.com/prestonvanloon",
      "followers_url": "https://api.github.com/users/prestonvanloon/followers",
      "following_url": "https://api.github.com/users/prestonvanloon/following{/other_user}",
      "gists_url": "https://api.github.com/users/prestonvanloon/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/prestonvanloon/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/prestonvanloon/subscriptions",
      "organizations_url": "https://api.github.com/users/prestonvanloon/orgs",
      "repos_url": "https://api.github.com/users/prestonvanloon/repos",
      "events_url": "https://api.github.com/users/prestonvanloon/events{/privacy}",
      "received_events_url": "https://api.github.com/users/prestonvanloon/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-08-01T00:17:05Z",
    "updated_at": "2020-08-01T00:19:25Z",
    "author_association": "MEMBER",
    "body": "We've done some investigation and this is due to the scrypt parameters in [EIP-2335](https://eips.ethereum.org/EIPS/eip-2335).\r\nWe looked at the [scrypt code](https://github.com/golang/crypto/blob/123391ffb6de907695e1066dc40c1ff09322aeb6/scrypt/scrypt.go#L205) and how it allocates memory. In this investigation we found that each key allocates about 268Mb (`262144*32*8*4 + 64*8*4 = 268437504 bytes`). \r\n\r\nGive the quarks of Golang's garbage collector, you will notice that this allocated memory is not cleaned up right away, but it is cleaned shortly after. \r\n\r\nWe have considered the following two options:\r\n- Modify the scrypt library to reuse the same allocated slices with sync.Pool or similar, then decrypt the keystores sequentially.\r\n- Store Prysm keys in a slightly modified version of EIP-2335 where `n` keys live in the same json file and only need to be decrypted once instead of doing `n` rounds of decryption.\r\n\r\nThe first option seems dangerous, but feasible. Modifying crypto libraries is not something we take lightly so we avoid it whenever possible. So the second options seems like a reasonable approach. It doesn't compromise on user security as keys are still encrypted at rest. \r\n\r\nEdit: I was of by a factor of 4. It's actually 268Mb per decryption round. Yikes!",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/667435129/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/667441221",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/6804#issuecomment-667441221",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/6804",
    "id": 667441221,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY2NzQ0MTIyMQ==",
    "user": {
      "login": "rauljordan",
      "id": 5572669,
      "node_id": "MDQ6VXNlcjU1NzI2Njk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5572669?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rauljordan",
      "html_url": "https://github.com/rauljordan",
      "followers_url": "https://api.github.com/users/rauljordan/followers",
      "following_url": "https://api.github.com/users/rauljordan/following{/other_user}",
      "gists_url": "https://api.github.com/users/rauljordan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rauljordan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rauljordan/subscriptions",
      "organizations_url": "https://api.github.com/users/rauljordan/orgs",
      "repos_url": "https://api.github.com/users/rauljordan/repos",
      "events_url": "https://api.github.com/users/rauljordan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rauljordan/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-08-01T00:51:17Z",
    "updated_at": "2020-08-01T00:51:17Z",
    "author_association": "CONTRIBUTOR",
    "body": "We are proceeding with option 2 with an automigrate feature for users that have already imported their accounts",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/667441221/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/667528814",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/6804#issuecomment-667528814",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/6804",
    "id": 667528814,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY2NzUyODgxNA==",
    "user": {
      "login": "Belkaar",
      "id": 2395990,
      "node_id": "MDQ6VXNlcjIzOTU5OTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2395990?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Belkaar",
      "html_url": "https://github.com/Belkaar",
      "followers_url": "https://api.github.com/users/Belkaar/followers",
      "following_url": "https://api.github.com/users/Belkaar/following{/other_user}",
      "gists_url": "https://api.github.com/users/Belkaar/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Belkaar/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Belkaar/subscriptions",
      "organizations_url": "https://api.github.com/users/Belkaar/orgs",
      "repos_url": "https://api.github.com/users/Belkaar/repos",
      "events_url": "https://api.github.com/users/Belkaar/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Belkaar/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-08-01T13:02:57Z",
    "updated_at": "2020-08-01T13:02:57Z",
    "author_association": "NONE",
    "body": "Without looking at the code, cant garbage collection be forced after every key import?",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/667528814/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/667542553",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/6804#issuecomment-667542553",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/6804",
    "id": 667542553,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY2NzU0MjU1Mw==",
    "user": {
      "login": "prestonvanloon",
      "id": 7246818,
      "node_id": "MDQ6VXNlcjcyNDY4MTg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7246818?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/prestonvanloon",
      "html_url": "https://github.com/prestonvanloon",
      "followers_url": "https://api.github.com/users/prestonvanloon/followers",
      "following_url": "https://api.github.com/users/prestonvanloon/following{/other_user}",
      "gists_url": "https://api.github.com/users/prestonvanloon/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/prestonvanloon/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/prestonvanloon/subscriptions",
      "organizations_url": "https://api.github.com/users/prestonvanloon/orgs",
      "repos_url": "https://api.github.com/users/prestonvanloon/repos",
      "events_url": "https://api.github.com/users/prestonvanloon/events{/privacy}",
      "received_events_url": "https://api.github.com/users/prestonvanloon/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-08-01T14:44:59Z",
    "updated_at": "2020-08-01T14:44:59Z",
    "author_association": "MEMBER",
    "body": "It could be done but this would make the start up process even slower with multiple keystore decryptions. Some users are reporting there keys taking several minutes to open when they have 64 to 100 keys!\r\n\r\nOption 2 seems like the best approach since it would only use 268Mb and reduce start up time significantly when running more than one keystore. ",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/667542553/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
