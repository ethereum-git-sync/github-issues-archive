{
  "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/10491",
  "repository_url": "https://api.github.com/repos/prysmaticlabs/prysm",
  "labels_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/10491/labels{/name}",
  "comments_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/10491/comments",
  "events_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/10491/events",
  "html_url": "https://github.com/prysmaticlabs/prysm/issues/10491",
  "id": 1195361998,
  "node_id": "I_kwDOBvuov85HP8bO",
  "number": 10491,
  "title": "Orphaned blocks served in BlocksByRange responses",
  "user": {
    "login": "michaelsproul",
    "id": 4452260,
    "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/michaelsproul",
    "html_url": "https://github.com/michaelsproul",
    "followers_url": "https://api.github.com/users/michaelsproul/followers",
    "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
    "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
    "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
    "repos_url": "https://api.github.com/users/michaelsproul/repos",
    "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
    "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 802129904,
      "node_id": "MDU6TGFiZWw4MDIxMjk5MDQ=",
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/labels/Bug",
      "name": "Bug",
      "color": "ee0701",
      "default": false,
      "description": "Something isn't working"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "potuz",
    "id": 16044918,
    "node_id": "MDQ6VXNlcjE2MDQ0OTE4",
    "avatar_url": "https://avatars.githubusercontent.com/u/16044918?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/potuz",
    "html_url": "https://github.com/potuz",
    "followers_url": "https://api.github.com/users/potuz/followers",
    "following_url": "https://api.github.com/users/potuz/following{/other_user}",
    "gists_url": "https://api.github.com/users/potuz/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/potuz/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/potuz/subscriptions",
    "organizations_url": "https://api.github.com/users/potuz/orgs",
    "repos_url": "https://api.github.com/users/potuz/repos",
    "events_url": "https://api.github.com/users/potuz/events{/privacy}",
    "received_events_url": "https://api.github.com/users/potuz/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "potuz",
      "id": 16044918,
      "node_id": "MDQ6VXNlcjE2MDQ0OTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/16044918?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/potuz",
      "html_url": "https://github.com/potuz",
      "followers_url": "https://api.github.com/users/potuz/followers",
      "following_url": "https://api.github.com/users/potuz/following{/other_user}",
      "gists_url": "https://api.github.com/users/potuz/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/potuz/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/potuz/subscriptions",
      "organizations_url": "https://api.github.com/users/potuz/orgs",
      "repos_url": "https://api.github.com/users/potuz/repos",
      "events_url": "https://api.github.com/users/potuz/events{/privacy}",
      "received_events_url": "https://api.github.com/users/potuz/received_events",
      "type": "User",
      "site_admin": false
    },
    {
      "login": "nisdas",
      "id": 33201827,
      "node_id": "MDQ6VXNlcjMzMjAxODI3",
      "avatar_url": "https://avatars.githubusercontent.com/u/33201827?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nisdas",
      "html_url": "https://github.com/nisdas",
      "followers_url": "https://api.github.com/users/nisdas/followers",
      "following_url": "https://api.github.com/users/nisdas/following{/other_user}",
      "gists_url": "https://api.github.com/users/nisdas/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nisdas/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nisdas/subscriptions",
      "organizations_url": "https://api.github.com/users/nisdas/orgs",
      "repos_url": "https://api.github.com/users/nisdas/repos",
      "events_url": "https://api.github.com/users/nisdas/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nisdas/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2022-04-07T01:17:37Z",
  "updated_at": "2022-08-25T15:04:33Z",
  "closed_at": "2022-08-25T15:04:32Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "# üêû Bug Report\r\n\r\n### Description\r\n\r\nI think Prysm is serving orphaned blocks in response to `BlocksByRange` requests, contrary to this condition from the spec:\r\n\r\n> Clients MUST respond with blocks from their view of the current fork choice -- that is, blocks from the single chain defined by the current head. Of note, blocks from slots before the finalization MUST lead to the finalized block reported in the Status handshake.\r\n\r\nhttps://github.com/ethereum/consensus-specs/blob/dev/specs/phase0/p2p-interface.md#beaconblocksbyrange\r\n\r\nI noticed this because Lighthouse logs a warning whenever it re-orgs, and we frequently see re-orgs during sync where Lighthouse has received orphaned blocks from before finalization:\r\n\r\n> Apr 04 02:36:39.505 WARN Beacon chain re-org, reorg_distance: 1, new_slot: 3505952, new_head: 0xc222af38aad7bf5688dacab3bee3e641f7643cd8b6609cde511b5ca4aa5f4d59, new_head_parent: 0x959073f80a2037b63e183c96fc2e5b94ecb88128000d85ed9ae20b758390c604, previous_slot: 3505909, previous_head: 0x5fc2e763069065502974ef077ad26caf5756c0f993be940bd2f12a0914be6d77, service: beacon, module: beacon_chain::beacon_chain:3423\r\n\r\nThese blocks seem to come from Prysm peers. In the example above block 3505909 is an orphaned block that was received in a batch from `16Uiu2HAmT7bYXYzjcWQZXxrYLSUsjKg3RCfCocxn1gm8KuYFnAd4` running Prysm (logs are in reverse chronological order here):\r\n\r\n> Apr 04 02:36:04.890 DEBG Batch processed, service: sync, processed_blocks: 52, last_block_slot: **3505909**, chain: 17417785903489362713, first_block_slot: 3505857, batch_epoch: **109558**, module: network::beacon_processor::worker::sync_methods:109\r\n\r\n> Apr 04 02:35:42.856 DEBG Requesting batch, start_slot: 3505857, end_slot: 3505920, downloaded: 0, processed: 0, state: Downloading(**16Uiu2HAmT7bYXYzjcWQZXxrYLSUsjKg3RCfCocxn1gm8KuYFnAd4**, 0 blocks, 167), epoch: **109558**, chain: 17417785903489362713, service: sync, module: network::sync::range_sync::chain:886\r\n\r\n> Apr 04 02:31:47.927 DEBG Identified Peer, protocols: [\"/ipfs/id/1.0.0\", \"/ipfs/id/push/1.0.0\", \"/meshsub/1.1.0\", \"/meshsub/1.0.0\", \"/floodsub/1.0.0\", \"/eth2/beacon_chain/req/status/1/ssz_snappy\", \"/eth2/beacon_chain/req/goodbye/1/ssz_snappy\", \"/eth2/beacon_chain/req/ping/1/ssz_snappy\", \"/eth2/beacon_chain/req/beacon_blocks_by_range/2/ssz_snappy\", \"/eth2/beacon_chain/req/beacon_blocks_by_root/2/ssz_snappy\", \"/eth2/beacon_chain/req/metadata/2/ssz_snappy\"], observed_address: \"/ip4/122.148.186.92/tcp/39746\", listening_ addresses: [\"/ip4/144.91.111.23/tcp/13000\"], agent_version: **Prysm/v2.0.6/e26cde5e091befe0c777992734c37e7a1e6c53c2**, protocol_version: ipfs/0.1.0, peer: **16Uiu2HAmT7bYXYzjcWQZXxrYLSUsjKg3RCfCocxn1gm8KuYFnAd4**, service: libp2p, module: lighthouse_network::peer_manager:399\r\n\r\nThe `Status` message for this peer shows that it had already finalized past slot 3505909 (epoch 109559):\r\n\r\n> Apr 04 02:31:48.283 DEBG Received Status Response, fork_digest: [175, 202, 171, 160], finalized_epoch: **109934**, finalized_root: 0xcd62‚Ä¶31f1, head_slot: 3517956, head_root: 0x0458‚Ä¶f093, peer_id: 16Uiu2HAmT7bYXYzjcWQZXxrYLSUsjKg3RCfCocxn1gm8KuYFnAd4, service: router, module: network::router::processor:147\r\n\r\nI've observed these re-orgs multiple times while syncing Lighthouse, but have only just got around to digging into it in detail. Notably, they occur on Gnosis chain quite often, where all peers are either Lighthouse or Prysm.\r\n\r\n## üî¨ Minimal Reproduction\r\n\r\nRun Lighthouse on the same network as Prysm and observe re-orgs from before finalization from Prysm peers.\r\n\r\n## Impact\r\n\r\nThe impact of this bug is quite minor:\r\n\r\n- It slows down sync for all clients by forcing them to work around unnecessary re-orgs.\r\n- It creates peering issues, as some clients may penalise Prysm peers for this behaviour (e.g. Lighthouse penalises and bans Prysm when this happens).\r\n\r\n## üåç  Your Environment\r\n\r\n**What version of Prysm are you running? (Which release)**\r\n\r\nObserved with Prysm v2.0.6 on mainnet and Gnosis chain.\r\n\r\n",
  "closed_by": {
    "login": "nisdas",
    "id": 33201827,
    "node_id": "MDQ6VXNlcjMzMjAxODI3",
    "avatar_url": "https://avatars.githubusercontent.com/u/33201827?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/nisdas",
    "html_url": "https://github.com/nisdas",
    "followers_url": "https://api.github.com/users/nisdas/followers",
    "following_url": "https://api.github.com/users/nisdas/following{/other_user}",
    "gists_url": "https://api.github.com/users/nisdas/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/nisdas/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/nisdas/subscriptions",
    "organizations_url": "https://api.github.com/users/nisdas/orgs",
    "repos_url": "https://api.github.com/users/nisdas/repos",
    "events_url": "https://api.github.com/users/nisdas/events{/privacy}",
    "received_events_url": "https://api.github.com/users/nisdas/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/10491/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/10491/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1092530385",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/10491#issuecomment-1092530385",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/10491",
    "id": 1092530385,
    "node_id": "IC_kwDOBvuov85BHrDR",
    "user": {
      "login": "nisdas",
      "id": 33201827,
      "node_id": "MDQ6VXNlcjMzMjAxODI3",
      "avatar_url": "https://avatars.githubusercontent.com/u/33201827?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nisdas",
      "html_url": "https://github.com/nisdas",
      "followers_url": "https://api.github.com/users/nisdas/followers",
      "following_url": "https://api.github.com/users/nisdas/following{/other_user}",
      "gists_url": "https://api.github.com/users/nisdas/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nisdas/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nisdas/subscriptions",
      "organizations_url": "https://api.github.com/users/nisdas/orgs",
      "repos_url": "https://api.github.com/users/nisdas/repos",
      "events_url": "https://api.github.com/users/nisdas/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nisdas/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-04-08T07:18:24Z",
    "updated_at": "2022-04-08T07:18:24Z",
    "author_association": "MEMBER",
    "body": "Appreciate the report @michaelsproul , we are aware of the issue and are working on a solution for it. This will most likely not be fixed in the next release but the release after that. Will keep you updated on the status of the fixes in this issue. ",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1092530385/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 1,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1092551703",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/10491#issuecomment-1092551703",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/10491",
    "id": 1092551703,
    "node_id": "IC_kwDOBvuov85BHwQX",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-04-08T07:42:18Z",
    "updated_at": "2022-04-08T07:42:18Z",
    "author_association": "NONE",
    "body": "Awesome, thanks!",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1092551703/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1227280379",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/10491#issuecomment-1227280379",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/10491",
    "id": 1227280379,
    "node_id": "IC_kwDOBvuov85JJs_7",
    "user": {
      "login": "rauljordan",
      "id": 5572669,
      "node_id": "MDQ6VXNlcjU1NzI2Njk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5572669?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rauljordan",
      "html_url": "https://github.com/rauljordan",
      "followers_url": "https://api.github.com/users/rauljordan/followers",
      "following_url": "https://api.github.com/users/rauljordan/following{/other_user}",
      "gists_url": "https://api.github.com/users/rauljordan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rauljordan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rauljordan/subscriptions",
      "organizations_url": "https://api.github.com/users/rauljordan/orgs",
      "repos_url": "https://api.github.com/users/rauljordan/repos",
      "events_url": "https://api.github.com/users/rauljordan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rauljordan/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-25T13:42:50Z",
    "updated_at": "2022-08-25T13:42:50Z",
    "author_association": "CONTRIBUTOR",
    "body": "hi @nisdas is this one fixed?",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1227280379/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1227384591",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/10491#issuecomment-1227384591",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/10491",
    "id": 1227384591,
    "node_id": "IC_kwDOBvuov85JKGcP",
    "user": {
      "login": "nisdas",
      "id": 33201827,
      "node_id": "MDQ6VXNlcjMzMjAxODI3",
      "avatar_url": "https://avatars.githubusercontent.com/u/33201827?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nisdas",
      "html_url": "https://github.com/nisdas",
      "followers_url": "https://api.github.com/users/nisdas/followers",
      "following_url": "https://api.github.com/users/nisdas/following{/other_user}",
      "gists_url": "https://api.github.com/users/nisdas/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nisdas/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nisdas/subscriptions",
      "organizations_url": "https://api.github.com/users/nisdas/orgs",
      "repos_url": "https://api.github.com/users/nisdas/repos",
      "events_url": "https://api.github.com/users/nisdas/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nisdas/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-25T15:04:32Z",
    "updated_at": "2022-08-25T15:04:32Z",
    "author_association": "MEMBER",
    "body": "It is fixed, we can close it. ",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1227384591/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
