{
  "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/10545",
  "repository_url": "https://api.github.com/repos/prysmaticlabs/prysm",
  "labels_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/10545/labels{/name}",
  "comments_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/10545/comments",
  "events_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/10545/events",
  "html_url": "https://github.com/prysmaticlabs/prysm/issues/10545",
  "id": 1207626504,
  "node_id": "I_kwDOBvuov85H-usI",
  "number": 10545,
  "title": "panic: runtime error: invalid memory address or nil pointer deference (kiln-prysm-besu)",
  "user": {
    "login": "SeaMonkey82",
    "id": 20866869,
    "node_id": "MDQ6VXNlcjIwODY2ODY5",
    "avatar_url": "https://avatars.githubusercontent.com/u/20866869?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/SeaMonkey82",
    "html_url": "https://github.com/SeaMonkey82",
    "followers_url": "https://api.github.com/users/SeaMonkey82/followers",
    "following_url": "https://api.github.com/users/SeaMonkey82/following{/other_user}",
    "gists_url": "https://api.github.com/users/SeaMonkey82/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/SeaMonkey82/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/SeaMonkey82/subscriptions",
    "organizations_url": "https://api.github.com/users/SeaMonkey82/orgs",
    "repos_url": "https://api.github.com/users/SeaMonkey82/repos",
    "events_url": "https://api.github.com/users/SeaMonkey82/events{/privacy}",
    "received_events_url": "https://api.github.com/users/SeaMonkey82/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "terencechain",
    "id": 21316537,
    "node_id": "MDQ6VXNlcjIxMzE2NTM3",
    "avatar_url": "https://avatars.githubusercontent.com/u/21316537?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/terencechain",
    "html_url": "https://github.com/terencechain",
    "followers_url": "https://api.github.com/users/terencechain/followers",
    "following_url": "https://api.github.com/users/terencechain/following{/other_user}",
    "gists_url": "https://api.github.com/users/terencechain/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/terencechain/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/terencechain/subscriptions",
    "organizations_url": "https://api.github.com/users/terencechain/orgs",
    "repos_url": "https://api.github.com/users/terencechain/repos",
    "events_url": "https://api.github.com/users/terencechain/events{/privacy}",
    "received_events_url": "https://api.github.com/users/terencechain/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "terencechain",
      "id": 21316537,
      "node_id": "MDQ6VXNlcjIxMzE2NTM3",
      "avatar_url": "https://avatars.githubusercontent.com/u/21316537?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/terencechain",
      "html_url": "https://github.com/terencechain",
      "followers_url": "https://api.github.com/users/terencechain/followers",
      "following_url": "https://api.github.com/users/terencechain/following{/other_user}",
      "gists_url": "https://api.github.com/users/terencechain/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/terencechain/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/terencechain/subscriptions",
      "organizations_url": "https://api.github.com/users/terencechain/orgs",
      "repos_url": "https://api.github.com/users/terencechain/repos",
      "events_url": "https://api.github.com/users/terencechain/events{/privacy}",
      "received_events_url": "https://api.github.com/users/terencechain/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2022-04-19T02:04:34Z",
  "updated_at": "2022-05-03T14:31:31Z",
  "closed_at": "2022-05-03T14:31:31Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "# üêû Bug Report\r\n\r\n### Description\r\n\r\nprysm-besu panics and exits on startup.  This has happened twice that I've noticed now, and restarting prysm beacon allows it to resume syncing.\r\n\r\n### Has this worked before in a previous version?\r\n\r\nThis only started happening recently.\r\n\r\n## üî¨ Minimal Reproduction\r\n\r\n`bazelisk run //beacon-chain -- --genesis-state $PWD/../genesis.ssz --datadir $HOME/eth/kiln-prysm-besu --http-web3provider=http://localhost:8578 --min-sync-peers=1 --chain-config-file $PWD/../config.yaml --bootstrap-node \"enr:-Iq4QMCTfIMXnow27baRUb35Q8iiFHSIDBJh6hQM5Axohhf4b6Kr_cOCu0htQ5WvVqKvFgY28893DHAg8gnBAXsAVqmGAX53x8JggmlkgnY0gmlwhLKAlv6Jc2VjcDI1NmsxoQK6S-Cii_KmfFdUJL2TANL3ksaKUnNXvTCv1tLwXs0QgIN1ZHCCIyk\" --p2p-tcp-port 13468 --p2p-udp-port 13468 --p2p-host-ip \"1.2.3.4\" --rpc-port 4002 --grpc-gateway-port 3502 --monitoring-port 8084 --suggested-fee-recipient \"0xA721da3d06813E764E94A23E377cC3E1729fCFD5\" --jwt-secret=/tmp/jwtsecret --dev`\r\n\r\n`bazelisk run //validator -- --chain-config-file ~/Downloads/merge-testnets/kiln/config.yaml --wallet-password-file ~/eth/kiln-prysm-besu/smashword --wallet-dir ~/eth/kiln-prysm-besu/prysm-wallet-v2 --graffiti \"prysm-besu seamonkey.tech\" --beacon-rpc-gateway-provider 127.0.0.1:3502 --beacon-rpc-provider 127.0.0.1:4002 --monitoring-port 8083 --suggested-fee-recipient \"0xA721da3d06813E764E94A23E377cC3E1729fCFD5\"`\r\n\r\n\r\n## üî• Error\r\n\r\n<pre><code>[2022-04-18 21:24:02]  INFO initial-sync: Processing block batch of size 30 starting from  0xd23e6cd9... 276929/276995 - estimated time remaining 44s blocksPerSecond=1.5 peers=5\r\n[2022-04-18 21:24:12]  WARN initial-sync: Batch is not processed error=payload status is INVALID\r\ngithub.com/prysmaticlabs/prysm/beacon-chain/powchain.init\r\n        beacon-chain/powchain/errors.go:30\r\nruntime.doInit\r\n        GOROOT/src/runtime/proc.go:6498\r\nruntime.doInit\r\n        GOROOT/src/runtime/proc.go:6475\r\nruntime.doInit\r\n        GOROOT/src/runtime/proc.go:6475\r\nruntime.doInit\r\n        GOROOT/src/runtime/proc.go:6475\r\nruntime.main\r\n        GOROOT/src/runtime/proc.go:238\r\nruntime.goexit\r\n        GOROOT/src/runtime/asm_amd64.s:1581\r\ncould not notify forkchoice update from execution engine\r\ngithub.com/prysmaticlabs/prysm/beacon-chain/blockchain.(*Service).notifyForkchoiceUpdate\r\n        beacon-chain/blockchain/execution_engine.go:94\r\ngithub.com/prysmaticlabs/prysm/beacon-chain/blockchain.(*Service).onBlockBatch\r\n        beacon-chain/blockchain/process_block.go:438\r\ngithub.com/prysmaticlabs/prysm/beacon-chain/blockchain.(*Service).ReceiveBlockBatch\r\n        beacon-chain/blockchain/receive_block.go:82\r\ngithub.com/prysmaticlabs/prysm/beacon-chain/sync/initial-sync.(*Service).processBatchedBlocks\r\n        beacon-chain/sync/initial-sync/round_robin.go:283\r\ngithub.com/prysmaticlabs/prysm/beacon-chain/sync/initial-sync.(*Service).processFetchedData\r\n        beacon-chain/sync/initial-sync/round_robin.go:133\r\ngithub.com/prysmaticlabs/prysm/beacon-chain/sync/initial-sync.(*Service).syncToFinalizedEpoch\r\n        beacon-chain/sync/initial-sync/round_robin.go:86\r\ngithub.com/prysmaticlabs/prysm/beacon-chain/sync/initial-sync.(*Service).roundRobinSync\r\n        beacon-chain/sync/initial-sync/round_robin.go:49\r\ngithub.com/prysmaticlabs/prysm/beacon-chain/sync/initial-sync.(*Service).Start\r\n        beacon-chain/sync/initial-sync/service.go:104\r\nruntime.goexit\r\n        GOROOT/src/runtime/asm_amd64.s:1581\r\ncould not process block in batch\r\ngithub.com/prysmaticlabs/prysm/beacon-chain/blockchain.(*Service).ReceiveBlockBatch\r\n        beacon-chain/blockchain/receive_block.go:84\r\ngithub.com/prysmaticlabs/prysm/beacon-chain/sync/initial-sync.(*Service).processBatchedBlocks\r\n        beacon-chain/sync/initial-sync/round_robin.go:283\r\ngithub.com/prysmaticlabs/prysm/beacon-chain/sync/initial-sync.(*Service).processFetchedData\r\n        beacon-chain/sync/initial-sync/round_robin.go:133\r\ngithub.com/prysmaticlabs/prysm/beacon-chain/sync/initial-sync.(*Service).syncToFinalizedEpoch\r\n        beacon-chain/sync/initial-sync/round_robin.go:86\r\ngithub.com/prysmaticlabs/prysm/beacon-chain/sync/initial-sync.(*Service).roundRobinSync\r\n        beacon-chain/sync/initial-sync/round_robin.go:49\r\ngithub.com/prysmaticlabs/prysm/beacon-chain/sync/initial-sync.(*Service).Start\r\n        beacon-chain/sync/initial-sync/service.go:104\r\nruntime.goexit\r\n        GOROOT/src/runtime/asm_amd64.s:1581\r\n[2022-04-18 21:24:12]  INFO initial-sync: Processing block batch of size 33 starting from  0xfd742d0d... 276960/276996 - estimated time remaining 11s blocksPerSecond=3.1 peers=6\r\n[2022-04-18 21:24:13]  WARN initial-sync: Batch is not processed error=payload status is INVALID\r\ngithub.com/prysmaticlabs/prysm/beacon-chain/powchain.init\r\n        beacon-chain/powchain/errors.go:30\r\nruntime.doInit\r\n        GOROOT/src/runtime/proc.go:6498\r\nruntime.doInit\r\n        GOROOT/src/runtime/proc.go:6475\r\nruntime.doInit\r\n        GOROOT/src/runtime/proc.go:6475\r\nruntime.doInit\r\n        GOROOT/src/runtime/proc.go:6475\r\nruntime.main\r\n        GOROOT/src/runtime/proc.go:238\r\nruntime.goexit\r\n        GOROOT/src/runtime/asm_amd64.s:1581\r\ncould not notify forkchoice update from execution engine\r\ngithub.com/prysmaticlabs/prysm/beacon-chain/blockchain.(*Service).notifyForkchoiceUpdate\r\n        beacon-chain/blockchain/execution_engine.go:94\r\ngithub.com/prysmaticlabs/prysm/beacon-chain/blockchain.(*Service).onBlockBatch\r\n        beacon-chain/blockchain/process_block.go:438\r\ngithub.com/prysmaticlabs/prysm/beacon-chain/blockchain.(*Service).ReceiveBlockBatch\r\n        beacon-chain/blockchain/receive_block.go:82\r\ngithub.com/prysmaticlabs/prysm/beacon-chain/sync/initial-sync.(*Service).processBatchedBlocks\r\n        beacon-chain/sync/initial-sync/round_robin.go:283\r\ngithub.com/prysmaticlabs/prysm/beacon-chain/sync/initial-sync.(*Service).processFetchedData\r\n        beacon-chain/sync/initial-sync/round_robin.go:133\r\ngithub.com/prysmaticlabs/prysm/beacon-chain/sync/initial-sync.(*Service).syncToFinalizedEpoch\r\n        beacon-chain/sync/initial-sync/round_robin.go:86\r\ngithub.com/prysmaticlabs/prysm/beacon-chain/sync/initial-sync.(*Service).roundRobinSync\r\n        beacon-chain/sync/initial-sync/round_robin.go:49\r\ngithub.com/prysmaticlabs/prysm/beacon-chain/sync/initial-sync.(*Service).Start\r\n        beacon-chain/sync/initial-sync/service.go:104\r\nruntime.goexit\r\n        GOROOT/src/runtime/asm_amd64.s:1581\r\ncould not process block in batch\r\ngithub.com/prysmaticlabs/prysm/beacon-chain/blockchain.(*Service).ReceiveBlockBatch\r\n        beacon-chain/blockchain/receive_block.go:84\r\ngithub.com/prysmaticlabs/prysm/beacon-chain/sync/initial-sync.(*Service).processBatchedBlocks\r\n        beacon-chain/sync/initial-sync/round_robin.go:283\r\ngithub.com/prysmaticlabs/prysm/beacon-chain/sync/initial-sync.(*Service).processFetchedData\r\n        beacon-chain/sync/initial-sync/round_robin.go:133\r\ngithub.com/prysmaticlabs/prysm/beacon-chain/sync/initial-sync.(*Service).syncToFinalizedEpoch\r\n        beacon-chain/sync/initial-sync/round_robin.go:86\r\ngithub.com/prysmaticlabs/prysm/beacon-chain/sync/initial-sync.(*Service).roundRobinSync\r\n        beacon-chain/sync/initial-sync/round_robin.go:49\r\ngithub.com/prysmaticlabs/prysm/beacon-chain/sync/initial-sync.(*Service).Start\r\n        beacon-chain/sync/initial-sync/service.go:104\r\nruntime.goexit\r\n        GOROOT/src/runtime/asm_amd64.s:1581\r\n[2022-04-18 21:24:13]  INFO initial-sync: Synced to finalized epoch - now syncing blocks up to current head currentSlot=276996 syncedSlot=276928\r\n[2022-04-18 21:24:15]  WARN blockchain: Could not update head error=head at slot 276960 with weight 0 is not eligible, finalizedEpoch 8653 != 8654, justifiedEpoch 8654 != 8655\r\npanic: runtime error: invalid memory address or nil pointer dereference\r\n[signal SIGSEGV: segmentation violation code=0x1 addr=0x18 pc=0x136bc81]\r\n\r\ngoroutine 313 [running]:\r\ngithub.com/prysmaticlabs/prysm/beacon-chain/blockchain.(*Service).onBlock(0xc000542460, {0x1edae38, 0xc005334120}, {0x1f0f3d0, 0xc004f61f40}, {0xd2, 0x3e, 0x6c, 0xd9, 0x7b, ...})\r\n        beacon-chain/blockchain/process_block.go:222 +0xb41\r\ngithub.com/prysmaticlabs/prysm/beacon-chain/blockchain.(*Service).ReceiveBlock(0xc000542460, {0x1edad90, 0xc004f5fec0}, {0x1f0f3d0, 0xc004e240a0}, {0xd2, 0x3e, 0x6c, 0xd9, 0x7b, ...})\r\n        beacon-chain/blockchain/receive_block.go:39 +0x15f\r\ngithub.com/prysmaticlabs/prysm/beacon-chain/sync/initial-sync.(*Service).processBlock(0xc00befefc0, {0x1edad90, 0xc004f5fec0}, {0x5, 0x73, 0x3031ec0}, {0x1f0f3d0, 0xc004e240a0}, 0xc00ea20f68)\r\n        beacon-chain/sync/initial-sync/round_robin.go:239 +0x39d\r\ngithub.com/prysmaticlabs/prysm/beacon-chain/sync/initial-sync.(*Service).processFetchedDataRegSync(0xc00befefc0, {0x1edad90, 0xc004f5fec0}, {0x0, 0x0, 0x3031ec0}, 0x439e0, 0xc0053219b0)\r\n        beacon-chain/sync/initial-sync/round_robin.go:146 +0x325\r\ngithub.com/prysmaticlabs/prysm/beacon-chain/sync/initial-sync.(*Service).syncToNonFinalizedEpoch(0xc00befefc0, {0x1edad90, 0xc004f5fec0}, {0x16d99a0, 0x2e0e940, 0x3031ec0})\r\n        beacon-chain/sync/initial-sync/round_robin.go:114 +0x1d9\r\ngithub.com/prysmaticlabs/prysm/beacon-chain/sync/initial-sync.(*Service).roundRobinSync(0xc00befefc0, {0xe00000004, 0xc003e61a48, 0x3031ec0})\r\n        beacon-chain/sync/initial-sync/round_robin.go:60 +0x239\r\ngithub.com/prysmaticlabs/prysm/beacon-chain/sync/initial-sync.(*Service).Start(0xc00befefc0)\r\n        beacon-chain/sync/initial-sync/service.go:104 +0x8f5\r\ncreated by github.com/prysmaticlabs/prysm/runtime.(*ServiceRegistry).StartAll\r\n        runtime/service_registry.go:46 +0x225\r\n</code></pre>\r\n\r\n\r\n## üåç  Your Environment\r\n\r\n**Operating System:**\r\n\r\n<pre>\r\n  <code>\r\nLinux Mint 20.3\r\n  </code>\r\n</pre>\r\n\r\n**What version of Prysm are you running? (Which release)**\r\n\r\n<pre>\r\n  <code>\r\nd2f4a8cc7c53a684ab2f420f5ed6dc527143a477\r\n  </code>\r\n</pre>\r\n\r\n",
  "closed_by": {
    "login": "prylabs-bulldozer[bot]",
    "id": 58059840,
    "node_id": "MDM6Qm90NTgwNTk4NDA=",
    "avatar_url": "https://avatars.githubusercontent.com/in/47372?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/prylabs-bulldozer%5Bbot%5D",
    "html_url": "https://github.com/apps/prylabs-bulldozer",
    "followers_url": "https://api.github.com/users/prylabs-bulldozer%5Bbot%5D/followers",
    "following_url": "https://api.github.com/users/prylabs-bulldozer%5Bbot%5D/following{/other_user}",
    "gists_url": "https://api.github.com/users/prylabs-bulldozer%5Bbot%5D/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/prylabs-bulldozer%5Bbot%5D/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/prylabs-bulldozer%5Bbot%5D/subscriptions",
    "organizations_url": "https://api.github.com/users/prylabs-bulldozer%5Bbot%5D/orgs",
    "repos_url": "https://api.github.com/users/prylabs-bulldozer%5Bbot%5D/repos",
    "events_url": "https://api.github.com/users/prylabs-bulldozer%5Bbot%5D/events{/privacy}",
    "received_events_url": "https://api.github.com/users/prylabs-bulldozer%5Bbot%5D/received_events",
    "type": "Bot",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/10545/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/10545/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1114460116",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/10545#issuecomment-1114460116",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/10545",
    "id": 1114460116,
    "node_id": "IC_kwDOBvuov85CbU_U",
    "user": {
      "login": "rauljordan",
      "id": 5572669,
      "node_id": "MDQ6VXNlcjU1NzI2Njk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5572669?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rauljordan",
      "html_url": "https://github.com/rauljordan",
      "followers_url": "https://api.github.com/users/rauljordan/followers",
      "following_url": "https://api.github.com/users/rauljordan/following{/other_user}",
      "gists_url": "https://api.github.com/users/rauljordan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rauljordan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rauljordan/subscriptions",
      "organizations_url": "https://api.github.com/users/rauljordan/orgs",
      "repos_url": "https://api.github.com/users/rauljordan/repos",
      "events_url": "https://api.github.com/users/rauljordan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rauljordan/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-02T03:24:28Z",
    "updated_at": "2022-05-02T03:24:54Z",
    "author_association": "CONTRIBUTOR",
    "body": "Thanks for reporting @SeaMonkey82 looks like this is the same issue we have identified internally that we might not have a block for a certain root in the database. Commit `d2f4a8cc7c53a684ab2f420f5ed6dc527143a477` and your logs confirm that we panic at the lines below:\r\n```go\r\n\theadBlock, err := s.cfg.BeaconDB.Block(ctx, headRoot)\r\n\tif err != nil {\r\n\t\treturn err\r\n\t}\r\n\theadState, err := s.cfg.StateGen.StateByRoot(ctx, headRoot)\r\n\tif err != nil {\r\n\t\treturn err\r\n\t}\r\n\tif _, err := s.notifyForkchoiceUpdate(ctx, headState, headBlock.Block(), headRoot, bytesutil.ToBytes32(finalized.Root)); err != nil {\r\n\t\treturn err\r\n\t}\r\n```\r\nif headBlock is nil, then headBlock.Block() will panic. I believe @terencechain has been working on this, and if there is another associated tracking issue or a PR, I'll leave it to him when to close this issue",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1114460116/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
