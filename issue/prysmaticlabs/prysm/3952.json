{
  "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/3952",
  "repository_url": "https://api.github.com/repos/prysmaticlabs/prysm",
  "labels_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/3952/labels{/name}",
  "comments_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/3952/comments",
  "events_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/3952/events",
  "html_url": "https://github.com/prysmaticlabs/prysm/issues/3952",
  "id": 519409932,
  "node_id": "MDU6SXNzdWU1MTk0MDk5MzI=",
  "number": 3952,
  "title": "Block validator response until sync to head",
  "user": {
    "login": "terencechain",
    "id": 21316537,
    "node_id": "MDQ6VXNlcjIxMzE2NTM3",
    "avatar_url": "https://avatars.githubusercontent.com/u/21316537?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/terencechain",
    "html_url": "https://github.com/terencechain",
    "followers_url": "https://api.github.com/users/terencechain/followers",
    "following_url": "https://api.github.com/users/terencechain/following{/other_user}",
    "gists_url": "https://api.github.com/users/terencechain/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/terencechain/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/terencechain/subscriptions",
    "organizations_url": "https://api.github.com/users/terencechain/orgs",
    "repos_url": "https://api.github.com/users/terencechain/repos",
    "events_url": "https://api.github.com/users/terencechain/events{/privacy}",
    "received_events_url": "https://api.github.com/users/terencechain/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1085358164,
      "node_id": "MDU6TGFiZWwxMDg1MzU4MTY0",
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/labels/Priority:%20Critical",
      "name": "Priority: Critical",
      "color": "f7262f",
      "default": false,
      "description": "Highest, immediate priority item"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2019-11-07T17:31:11Z",
  "updated_at": "2019-11-13T16:33:38Z",
  "closed_at": "2019-11-13T16:33:38Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "The problem is when a beacon node is syncing to head and we start validator the same time before the beacon node is fully sync'ed. Beacon node will pass validators old assignments and old attestation to sign then broadcast those attestations to the rest of the network. Here's an example:\r\n\r\n1.) Node A at head\r\n2.) Node B starts at genesis slot\r\n3.) Start validator clients and attach to node B\r\n4.) While node B is still syncing, it's already responding to validator on assignment but got these errors due to request happened half way\r\n```\r\n[2019-11-07 09:18:16] ERROR validator: Failed to update assignments error=rpc error: code = DeadlineExceeded desc = context deadline exceeded\r\n[2019-11-07 09:18:25] ERROR validator: Could not request attestation to sign at slot 125: rpc error: code = DeadlineExceeded desc = context deadline exceeded pubKey=0xa8e3c2d3ac4e\r\n```\r\n5.) Next slot, node B responded to validators on attestations request while it's `Processing block 107/126`\r\n6.) Validators signed those old attestations and node B broadcasted to rest of the network\r\n7.) Rest of the network could not process these old/outdated attestations. Node A's error:\r\n```\r\n[2019-11-07 09:15:07] ERROR sync: Failed to handle p2p pubsub error=signature did not verify\r\ncould not verify block signature\r\ngithub.com/prysmaticlabs/prysm/beacon-chain/core/blocks.ProcessBlockHeader\r\n```\r\n```\r\n[2019-11-07 09:15:07]  WARN forkchoice: Removing attestation from queue. AggregatedBitfield=[00011001 01000100 11110011 01010100 00000001] Root=0x1b72787b66304adbb7149bc74cd399e16f62ea7f548513035080d0884f286a0e error=attestation aggregation signature did not verify\r\ncould not verify indexed attestation\r\n```\r\n8.) Node B's error\r\n```\r\n[2019-11-07 09:18:31]  WARN forkchoice: Removing attestation from queue. AggregatedBitfield=[00010000 01110011 11101110 11001001 00000001] Root=0x4b71114a866cfb2c42be7c63727e7783381e58455a9eccebbd3378c9048f2a94 error=attestation aggregation signature did not verify\r\ncould not verify indexed attestation\r\n```\r\n9.) Eventually node B sync's up and everything becomes normal again. But this is detrimental when we get deeper into the chain. More and more invalid attestations will get propagated alone the way",
  "closed_by": {
    "login": "rauljordan",
    "id": 5572669,
    "node_id": "MDQ6VXNlcjU1NzI2Njk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5572669?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/rauljordan",
    "html_url": "https://github.com/rauljordan",
    "followers_url": "https://api.github.com/users/rauljordan/followers",
    "following_url": "https://api.github.com/users/rauljordan/following{/other_user}",
    "gists_url": "https://api.github.com/users/rauljordan/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/rauljordan/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rauljordan/subscriptions",
    "organizations_url": "https://api.github.com/users/rauljordan/orgs",
    "repos_url": "https://api.github.com/users/rauljordan/repos",
    "events_url": "https://api.github.com/users/rauljordan/events{/privacy}",
    "received_events_url": "https://api.github.com/users/rauljordan/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/3952/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/3952/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/551204829",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/3952#issuecomment-551204829",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/3952",
    "id": 551204829,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU1MTIwNDgyOQ==",
    "user": {
      "login": "prestonvanloon",
      "id": 7246818,
      "node_id": "MDQ6VXNlcjcyNDY4MTg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7246818?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/prestonvanloon",
      "html_url": "https://github.com/prestonvanloon",
      "followers_url": "https://api.github.com/users/prestonvanloon/followers",
      "following_url": "https://api.github.com/users/prestonvanloon/following{/other_user}",
      "gists_url": "https://api.github.com/users/prestonvanloon/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/prestonvanloon/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/prestonvanloon/subscriptions",
      "organizations_url": "https://api.github.com/users/prestonvanloon/orgs",
      "repos_url": "https://api.github.com/users/prestonvanloon/repos",
      "events_url": "https://api.github.com/users/prestonvanloon/events{/privacy}",
      "received_events_url": "https://api.github.com/users/prestonvanloon/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-11-07T18:28:28Z",
    "updated_at": "2019-11-07T18:28:28Z",
    "author_association": "MEMBER",
    "body": "Discussed offline a two part solution:\r\n- Beacon node should return an error for gRPC requests that require the node to be in sync. This includes CommitteeAssignments, RequestBlock, RequestAttestation, etc.\r\n- The validator should ensure that the beacon node is in sync before connecting and requesting work. This could be a simple 3 to 5 second poll to [Node.GetSyncStatus](https://github.com/prysmaticlabs/ethereumapis/blob/1205871db17ccc2fb824fc6dfa40d01c48fb6a7e/eth/v1alpha1/node.proto#L35) ",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/551204829/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
