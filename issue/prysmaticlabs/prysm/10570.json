{
  "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/10570",
  "repository_url": "https://api.github.com/repos/prysmaticlabs/prysm",
  "labels_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/10570/labels{/name}",
  "comments_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/10570/comments",
  "events_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/10570/events",
  "html_url": "https://github.com/prysmaticlabs/prysm/issues/10570",
  "id": 1217633547,
  "node_id": "I_kwDOBvuov85Ik50L",
  "number": 10570,
  "title": "No block in DB when update head",
  "user": {
    "login": "terencechain",
    "id": 21316537,
    "node_id": "MDQ6VXNlcjIxMzE2NTM3",
    "avatar_url": "https://avatars.githubusercontent.com/u/21316537?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/terencechain",
    "html_url": "https://github.com/terencechain",
    "followers_url": "https://api.github.com/users/terencechain/followers",
    "following_url": "https://api.github.com/users/terencechain/following{/other_user}",
    "gists_url": "https://api.github.com/users/terencechain/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/terencechain/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/terencechain/subscriptions",
    "organizations_url": "https://api.github.com/users/terencechain/orgs",
    "repos_url": "https://api.github.com/users/terencechain/repos",
    "events_url": "https://api.github.com/users/terencechain/events{/privacy}",
    "received_events_url": "https://api.github.com/users/terencechain/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 802129904,
      "node_id": "MDU6TGFiZWw4MDIxMjk5MDQ=",
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/labels/Bug",
      "name": "Bug",
      "color": "ee0701",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 1085357069,
      "node_id": "MDU6TGFiZWwxMDg1MzU3MDY5",
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/labels/Priority:%20High",
      "name": "Priority: High",
      "color": "f7ea26",
      "default": false,
      "description": "High priority item"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2022-04-27T16:59:03Z",
  "updated_at": "2022-04-29T07:56:31Z",
  "closed_at": "2022-04-29T07:56:31Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "After the transition from the initial(req-resp) syncing to regular(gossip) syncing, we encountered an edge case when the head updates from A -> B.  Prsym node encounters block B is not in the DB. The following two things can happen:\r\n- Update head routine errors out when rebuilding the state\r\n- Update head routine panics if the state exists in cache\r\n\r\nThe above edge case did not happen in v2.0.6 because prsym node would just no-op when updating the head if the block is not in the DB. v2.1.0 added a new assumption where the head must exist in DB.\r\n\r\nTo fix the edge case, there are two options:\r\n1. Add back the no-op\r\n2. Make sure we save initial sync cached blocks in DB before updating head\r\n\r\n\r\nI currently favor 2.  Another thing we should do is to change DB behavior not to return nil and return an error instead of nil.",
  "closed_by": {
    "login": "prylabs-bulldozer[bot]",
    "id": 58059840,
    "node_id": "MDM6Qm90NTgwNTk4NDA=",
    "avatar_url": "https://avatars.githubusercontent.com/in/47372?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/prylabs-bulldozer%5Bbot%5D",
    "html_url": "https://github.com/apps/prylabs-bulldozer",
    "followers_url": "https://api.github.com/users/prylabs-bulldozer%5Bbot%5D/followers",
    "following_url": "https://api.github.com/users/prylabs-bulldozer%5Bbot%5D/following{/other_user}",
    "gists_url": "https://api.github.com/users/prylabs-bulldozer%5Bbot%5D/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/prylabs-bulldozer%5Bbot%5D/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/prylabs-bulldozer%5Bbot%5D/subscriptions",
    "organizations_url": "https://api.github.com/users/prylabs-bulldozer%5Bbot%5D/orgs",
    "repos_url": "https://api.github.com/users/prylabs-bulldozer%5Bbot%5D/repos",
    "events_url": "https://api.github.com/users/prylabs-bulldozer%5Bbot%5D/events{/privacy}",
    "received_events_url": "https://api.github.com/users/prylabs-bulldozer%5Bbot%5D/received_events",
    "type": "Bot",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/10570/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/10570/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1112206995",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/10570#issuecomment-1112206995",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/10570",
    "id": 1112206995,
    "node_id": "IC_kwDOBvuov85CSu6T",
    "user": {
      "login": "prestonvanloon",
      "id": 7246818,
      "node_id": "MDQ6VXNlcjcyNDY4MTg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7246818?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/prestonvanloon",
      "html_url": "https://github.com/prestonvanloon",
      "followers_url": "https://api.github.com/users/prestonvanloon/followers",
      "following_url": "https://api.github.com/users/prestonvanloon/following{/other_user}",
      "gists_url": "https://api.github.com/users/prestonvanloon/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/prestonvanloon/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/prestonvanloon/subscriptions",
      "organizations_url": "https://api.github.com/users/prestonvanloon/orgs",
      "repos_url": "https://api.github.com/users/prestonvanloon/repos",
      "events_url": "https://api.github.com/users/prestonvanloon/events{/privacy}",
      "received_events_url": "https://api.github.com/users/prestonvanloon/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-04-28T13:30:27Z",
    "updated_at": "2022-04-28T13:30:27Z",
    "author_association": "MEMBER",
    "body": "This is a high priority issue in v2.1.0. This can lead to occasional crashes of the beacon chain.\r\n\r\n```\r\npanic: runtime error: invalid memory address or nil pointer dereference\r\n[signal SIGSEGV: segmentation violation code=0x1 addr=0x18 pc=0x2961883]\r\n\r\ngoroutine 322 [running]:\r\ngithub.com/prysmaticlabs/prysm/beacon-chain/blockchain.(*Service).notifyEngineIfChangedHead(0xc00049c380, {0xb27370, 0xc002cdacc0}, {0xa, 0x3, 0x48, 0xd7, 0x63, 0x4b, 0x9f, ...})\r\n        beacon-chain/blockchain/receive_attestation.go:197 +0x643\r\ngithub.com/prysmaticlabs/prysm/beacon-chain/blockchain.(*Service).spawnProcessAttestationsRoutine.func1()\r\n        beacon-chain/blockchain/receive_attestation.go:169 +0x6b4\r\ncreated by github.com/prysmaticlabs/prysm/beacon-chain/blockchain.(*Service).spawnProcessAttestationsRoutine\r\n        beacon-chain/blockchain/receive_attestation.go:115 +0xdd\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1112206995/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
