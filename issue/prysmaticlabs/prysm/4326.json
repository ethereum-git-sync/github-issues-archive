{
  "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/4326",
  "repository_url": "https://api.github.com/repos/prysmaticlabs/prysm",
  "labels_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/4326/labels{/name}",
  "comments_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/4326/comments",
  "events_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/4326/events",
  "html_url": "https://github.com/prysmaticlabs/prysm/issues/4326",
  "id": 540275097,
  "node_id": "MDU6SXNzdWU1NDAyNzUwOTc=",
  "number": 4326,
  "title": "Metrics on localhost:8080 from Docker image are incomplete",
  "user": {
    "login": "handelaar2",
    "id": 28559038,
    "node_id": "MDQ6VXNlcjI4NTU5MDM4",
    "avatar_url": "https://avatars.githubusercontent.com/u/28559038?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/handelaar2",
    "html_url": "https://github.com/handelaar2",
    "followers_url": "https://api.github.com/users/handelaar2/followers",
    "following_url": "https://api.github.com/users/handelaar2/following{/other_user}",
    "gists_url": "https://api.github.com/users/handelaar2/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/handelaar2/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/handelaar2/subscriptions",
    "organizations_url": "https://api.github.com/users/handelaar2/orgs",
    "repos_url": "https://api.github.com/users/handelaar2/repos",
    "events_url": "https://api.github.com/users/handelaar2/events{/privacy}",
    "received_events_url": "https://api.github.com/users/handelaar2/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2019-12-19T12:10:08Z",
  "updated_at": "2019-12-23T07:40:23Z",
  "closed_at": "2019-12-19T17:34:45Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "I try to scrape localhost:8080 for metrics to feed into Prometheus/Grafana.\r\nThe list of metrics generated from a docker image (latest on Dec19=HEAD-8c28d1) is incomplete.\r\n\r\nWhen running the following command I get **77** metrics.\r\ncurl -s localhost:8080/metrics|egrep -v '^(#|bolt)' | sed -e 's/ .*//'|wc -l\r\n(thanks @mcdee)\r\nDoing the same for a Bazel build (cloned less than a week ago) it gives: **314**\r\n\r\nAttached are 2 files with the individual metrics that is generated for each(bolt metrics are excluded).\r\n[Docker_localhost-8080:metrics.txt](https://github.com/prysmaticlabs/prysm/files/3983468/Docker_localhost-8080.metrics.txt)\r\n[Bazel_localhost-8080:metrics.txt](https://github.com/prysmaticlabs/prysm/files/3983469/Bazel_localhost-8080.metrics.txt)\r\n\r\nThe few metrics that are available (I think) come from:\r\ncache/attestation_data.go\r\ncache/checkpoint_state.go\r\ncache/committee.go\r\nstate/skip_slot_cache.go\r\n\r\ngo_collector.go\r\ngo-grpc-prometheus/client_metrics.go\r\nlogrus_collector.go; process_collector.go\r\npromhttp/http.go\r\n\r\nSo basically some Prysm cache data and the generic collectors (go;process;http;logrus;grpc)\r\n\r\nWhy does the docker image only gives a subset of metrics compared to the bazel build?",
  "closed_by": {
    "login": "prestonvanloon",
    "id": 7246818,
    "node_id": "MDQ6VXNlcjcyNDY4MTg=",
    "avatar_url": "https://avatars.githubusercontent.com/u/7246818?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/prestonvanloon",
    "html_url": "https://github.com/prestonvanloon",
    "followers_url": "https://api.github.com/users/prestonvanloon/followers",
    "following_url": "https://api.github.com/users/prestonvanloon/following{/other_user}",
    "gists_url": "https://api.github.com/users/prestonvanloon/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/prestonvanloon/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/prestonvanloon/subscriptions",
    "organizations_url": "https://api.github.com/users/prestonvanloon/orgs",
    "repos_url": "https://api.github.com/users/prestonvanloon/repos",
    "events_url": "https://api.github.com/users/prestonvanloon/events{/privacy}",
    "received_events_url": "https://api.github.com/users/prestonvanloon/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/4326/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/4326/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/567538934",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/4326#issuecomment-567538934",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/4326",
    "id": 567538934,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU2NzUzODkzNA==",
    "user": {
      "login": "prestonvanloon",
      "id": 7246818,
      "node_id": "MDQ6VXNlcjcyNDY4MTg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7246818?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/prestonvanloon",
      "html_url": "https://github.com/prestonvanloon",
      "followers_url": "https://api.github.com/users/prestonvanloon/followers",
      "following_url": "https://api.github.com/users/prestonvanloon/following{/other_user}",
      "gists_url": "https://api.github.com/users/prestonvanloon/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/prestonvanloon/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/prestonvanloon/subscriptions",
      "organizations_url": "https://api.github.com/users/prestonvanloon/orgs",
      "repos_url": "https://api.github.com/users/prestonvanloon/repos",
      "events_url": "https://api.github.com/users/prestonvanloon/events{/privacy}",
      "received_events_url": "https://api.github.com/users/prestonvanloon/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-12-19T15:33:58Z",
    "updated_at": "2019-12-19T15:34:05Z",
    "author_association": "MEMBER",
    "body": "How can we reproduce this? \r\n\r\nWe run the docker images in production and see all of the expected metrics.",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/567538934/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/567542062",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/4326#issuecomment-567542062",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/4326",
    "id": 567542062,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU2NzU0MjA2Mg==",
    "user": {
      "login": "handelaar2",
      "id": 28559038,
      "node_id": "MDQ6VXNlcjI4NTU5MDM4",
      "avatar_url": "https://avatars.githubusercontent.com/u/28559038?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/handelaar2",
      "html_url": "https://github.com/handelaar2",
      "followers_url": "https://api.github.com/users/handelaar2/followers",
      "following_url": "https://api.github.com/users/handelaar2/following{/other_user}",
      "gists_url": "https://api.github.com/users/handelaar2/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/handelaar2/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/handelaar2/subscriptions",
      "organizations_url": "https://api.github.com/users/handelaar2/orgs",
      "repos_url": "https://api.github.com/users/handelaar2/repos",
      "events_url": "https://api.github.com/users/handelaar2/events{/privacy}",
      "received_events_url": "https://api.github.com/users/handelaar2/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-12-19T15:41:03Z",
    "updated_at": "2019-12-19T15:41:03Z",
    "author_association": "NONE",
    "body": "yes, Nishant has seen the same issue. \r\n\r\nI run:\r\ndocker pull gcr.io/prysmaticlabs/prysm/beacon-chain:latest\r\n\r\ndocker run -it -v $HOME/prysm-data:/data -p 4000:4000 -p 4001:4001 -p 13000:13000 gcr.io/prysmaticlabs/prysm/beacon-chain:latest   --datadir=/data    --initial-sync-verify-all-signatures --grpc-gateway-port 4001 --verbosity info --archive --enable-upnp --p2p-max-peers 20\r\n\r\nThen look at the results on http://localhost:8080/metrics",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/567542062/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/567546740",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/4326#issuecomment-567546740",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/4326",
    "id": 567546740,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU2NzU0Njc0MA==",
    "user": {
      "login": "prestonvanloon",
      "id": 7246818,
      "node_id": "MDQ6VXNlcjcyNDY4MTg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7246818?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/prestonvanloon",
      "html_url": "https://github.com/prestonvanloon",
      "followers_url": "https://api.github.com/users/prestonvanloon/followers",
      "following_url": "https://api.github.com/users/prestonvanloon/following{/other_user}",
      "gists_url": "https://api.github.com/users/prestonvanloon/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/prestonvanloon/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/prestonvanloon/subscriptions",
      "organizations_url": "https://api.github.com/users/prestonvanloon/orgs",
      "repos_url": "https://api.github.com/users/prestonvanloon/repos",
      "events_url": "https://api.github.com/users/prestonvanloon/events{/privacy}",
      "received_events_url": "https://api.github.com/users/prestonvanloon/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-12-19T15:51:51Z",
    "updated_at": "2019-12-19T15:51:51Z",
    "author_association": "MEMBER",
    "body": "This is normal behavior. Metrics may not appear until they have been used, especially metrics with labels. ",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/567546740/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/567557035",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/4326#issuecomment-567557035",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/4326",
    "id": 567557035,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU2NzU1NzAzNQ==",
    "user": {
      "login": "handelaar2",
      "id": 28559038,
      "node_id": "MDQ6VXNlcjI4NTU5MDM4",
      "avatar_url": "https://avatars.githubusercontent.com/u/28559038?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/handelaar2",
      "html_url": "https://github.com/handelaar2",
      "followers_url": "https://api.github.com/users/handelaar2/followers",
      "following_url": "https://api.github.com/users/handelaar2/following{/other_user}",
      "gists_url": "https://api.github.com/users/handelaar2/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/handelaar2/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/handelaar2/subscriptions",
      "organizations_url": "https://api.github.com/users/handelaar2/orgs",
      "repos_url": "https://api.github.com/users/handelaar2/repos",
      "events_url": "https://api.github.com/users/handelaar2/events{/privacy}",
      "received_events_url": "https://api.github.com/users/handelaar2/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-12-19T16:16:40Z",
    "updated_at": "2019-12-23T07:40:23Z",
    "author_association": "NONE",
    "body": "It was not normal behaviour. The reason was/is that port 8080 is not forwarded in docker. As a result, it does only work partially and only some metrics are shown. Port forwarding needs to be added to docker for the metrics to work fully: **-p 8080:8080**\r\nThanks.\r\n\r\nedit: comment from Preston: it couldn't be a difference in build, bazel takes the same binary (for linux) and copies it into the container\r\n\r\nedit: when  I add -p 8081:8080 instead, I get metrics on 'both ports':\r\ncurl -s localhost:8080/metrics|egrep -v '^(#|bolt)' | sed -e 's/ .*//'|wc -l\r\n=>98\r\ncurl -s localhost:8081/metrics|egrep -v '^(#|bolt)' | sed -e 's/ .*//'|wc -l\r\n=>314\r\n Not sure what would happen if I also set: --monitoring-port\r\n\r\nedit: also when I do http://localhost:8080/healthz , I 'only' get:\r\n*prometheus.Service: OK\r\n*client.ValidatorService: OK\r\n\r\nfor the other port I get a full list:\r\n*blockchain.Service: OK\r\n*powchain.Service: OK\r\n*operations.Service: OK\r\n*initialsync.Service: OK\r\n*sync.Service: OK\r\n*rpc.Service: OK\r\n*gateway.Gateway: OK\r\n*prometheus.Service: OK\r\n*p2p.Service: OK\r\n\r\nIt looks to me that the validator is sending prometheus metrics. But how is this possible when the docker port for the validator is not open (the docker command for validator does not have -p)\r\nSomething remains fishy here.\r\n\r\nIt remains strange to me but I have my metrics, so issue can be closed.",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/567557035/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
