{
  "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/6133",
  "repository_url": "https://api.github.com/repos/prysmaticlabs/prysm",
  "labels_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/6133/labels{/name}",
  "comments_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/6133/comments",
  "events_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/6133/events",
  "html_url": "https://github.com/prysmaticlabs/prysm/issues/6133",
  "id": 631102437,
  "node_id": "MDU6SXNzdWU2MzExMDI0Mzc=",
  "number": 6133,
  "title": "beacon-chain panic on stopping when deployed in docker swarm mode",
  "user": {
    "login": "raphpa",
    "id": 18283997,
    "node_id": "MDQ6VXNlcjE4MjgzOTk3",
    "avatar_url": "https://avatars.githubusercontent.com/u/18283997?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/raphpa",
    "html_url": "https://github.com/raphpa",
    "followers_url": "https://api.github.com/users/raphpa/followers",
    "following_url": "https://api.github.com/users/raphpa/following{/other_user}",
    "gists_url": "https://api.github.com/users/raphpa/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/raphpa/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/raphpa/subscriptions",
    "organizations_url": "https://api.github.com/users/raphpa/orgs",
    "repos_url": "https://api.github.com/users/raphpa/repos",
    "events_url": "https://api.github.com/users/raphpa/events{/privacy}",
    "received_events_url": "https://api.github.com/users/raphpa/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2020-06-04T19:50:12Z",
  "updated_at": "2020-06-16T05:49:20Z",
  "closed_at": "2020-06-16T05:49:19Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "# üêû Bug Report\r\n\r\n### Description\r\n\r\nWhen scaling down (stopping) a dockerized beacon-chain in docker swarm mode docker-chain does not exit gracefully and crashes. When scaling up (starting) again, beacon-chain starts to resync from a point where it exited gracefully the last time.\r\n\r\n### Has this worked before in a previous version?\r\n\r\nI did not notice it happening before. However I assume it worked before as beacon-chain starts resynching the chain from the point where the container was updated to alpha 9.\r\n\r\nI would also expect the database to not completely roll back for days. Not sure if that has worked before or is expected to work that way.\r\n\r\n## üî¨ Minimal Reproduction\r\n\r\nStack deploy beacon-chain alpha 9 in swarm mode. Scale up the service.\r\n`docker service scale prysm_beacon-chain=1`\r\n\r\nScale down the service to 0 again\r\n`docker service scale prysm_beacon-chain=0`\r\n\r\n## üî• Error\r\n\r\nBeacon-chain starts shutting down and panics as prometheus.Service does not exit\r\n\r\n<pre>\r\ntime=\"2020-06-04 18:49:20\" level=info msg=\"Got interrupt, shutting down...\" prefix=node\r\ntime=\"2020-06-04 18:49:20\" level=info msg=\"Stopping beacon node\" prefix=node\r\ntime=\"2020-06-04 18:49:21\" level=info msg=\"Saved full state on epoch boundary\" blockRoot=aa9944720c4d prefix=state-gen slot=321792\r\ntime=\"2020-06-04 18:49:21\" level=info msg=\"Processing block 0xcfae0791... 321793/344046 - estimated time remaining 1h52m23s\" blocksPerSecond=3.3 peers=3 prefix=initial-sync\r\ntime=\"2020-06-04 18:49:22\" level=panic msg=\"Could not stop the following service: *prometheus.Service, context deadline exceeded\" prefix=registry\r\npanic: (*logrus.Entry) (0x17537e0,0xc00a4ae7e0)\r\n\r\ngoroutine 13407 [running]:\r\ngithub.com/sirupsen/logrus.Entry.log(0xc000140690, 0xc00079e900, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, ...)\r\n        external/com_github_sirupsen_logrus/entry.go:239 +0x2da\r\ngithub.com/sirupsen/logrus.(*Entry).Log(0xc000777e30, 0x0, 0xc00d10eea0, 0x1, 0x1)\r\n        external/com_github_sirupsen_logrus/entry.go:268 +0xeb\r\ngithub.com/sirupsen/logrus.(*Entry).Logf(0xc000777e30, 0x0, 0x17a9f15, 0x2c, 0xc00d10ef20, 0x2, 0x2)\r\n        external/com_github_sirupsen_logrus/entry.go:314 +0xe2\r\ngithub.com/sirupsen/logrus.(*Entry).Panicf(...)\r\n        external/com_github_sirupsen_logrus/entry.go:352\r\ngithub.com/prysmaticlabs/prysm/shared.(*ServiceRegistry).StopAll(0xc000652160)\r\n        shared/service_registry.go:57 +0x165\r\ngithub.com/prysmaticlabs/prysm/beacon-chain/node.(*BeaconNode).Close(0xc0001600c0)\r\n        beacon-chain/node/node.go:239 +0xdf\r\ncreated by github.com/prysmaticlabs/prysm/beacon-chain/node.(*BeaconNode).Start.func1\r\n        beacon-chain/node/node.go:218 +0x17d\r\n</pre>\r\n\r\n\r\n## üåç  Your Environment\r\n\r\n**Operating System:**\r\n\r\nUbuntu 20.04 LTS\r\nDocker 19.03.8\r\n\r\n**What version of Prysm are you running? (Which release)**\r\n\r\nAlpha 9 \r\ngcr.io/prysmaticlabs/prysm/beacon-chain:HEAD-3fe47c\r\n\r\n",
  "closed_by": {
    "login": "raphpa",
    "id": 18283997,
    "node_id": "MDQ6VXNlcjE4MjgzOTk3",
    "avatar_url": "https://avatars.githubusercontent.com/u/18283997?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/raphpa",
    "html_url": "https://github.com/raphpa",
    "followers_url": "https://api.github.com/users/raphpa/followers",
    "following_url": "https://api.github.com/users/raphpa/following{/other_user}",
    "gists_url": "https://api.github.com/users/raphpa/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/raphpa/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/raphpa/subscriptions",
    "organizations_url": "https://api.github.com/users/raphpa/orgs",
    "repos_url": "https://api.github.com/users/raphpa/repos",
    "events_url": "https://api.github.com/users/raphpa/events{/privacy}",
    "received_events_url": "https://api.github.com/users/raphpa/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/6133/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/6133/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/640214918",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/6133#issuecomment-640214918",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/6133",
    "id": 640214918,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY0MDIxNDkxOA==",
    "user": {
      "login": "nisdas",
      "id": 33201827,
      "node_id": "MDQ6VXNlcjMzMjAxODI3",
      "avatar_url": "https://avatars.githubusercontent.com/u/33201827?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nisdas",
      "html_url": "https://github.com/nisdas",
      "followers_url": "https://api.github.com/users/nisdas/followers",
      "following_url": "https://api.github.com/users/nisdas/following{/other_user}",
      "gists_url": "https://api.github.com/users/nisdas/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nisdas/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nisdas/subscriptions",
      "organizations_url": "https://api.github.com/users/nisdas/orgs",
      "repos_url": "https://api.github.com/users/nisdas/repos",
      "events_url": "https://api.github.com/users/nisdas/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nisdas/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-06-07T12:56:40Z",
    "updated_at": "2020-06-07T12:56:40Z",
    "author_association": "MEMBER",
    "body": "Seems like an issue with prometheus here. Were you by any chance fetching data from the prometheus server at that moment ?",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/640214918/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/640218149",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/6133#issuecomment-640218149",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/6133",
    "id": 640218149,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY0MDIxODE0OQ==",
    "user": {
      "login": "raphpa",
      "id": 18283997,
      "node_id": "MDQ6VXNlcjE4MjgzOTk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/18283997?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/raphpa",
      "html_url": "https://github.com/raphpa",
      "followers_url": "https://api.github.com/users/raphpa/followers",
      "following_url": "https://api.github.com/users/raphpa/following{/other_user}",
      "gists_url": "https://api.github.com/users/raphpa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/raphpa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/raphpa/subscriptions",
      "organizations_url": "https://api.github.com/users/raphpa/orgs",
      "repos_url": "https://api.github.com/users/raphpa/repos",
      "events_url": "https://api.github.com/users/raphpa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/raphpa/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-06-07T13:21:50Z",
    "updated_at": "2020-06-07T13:21:50Z",
    "author_association": "NONE",
    "body": "Prometheus was running as well, so it is pretty likely that it was fetching data at that moment.",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/640218149/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/644545373",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/6133#issuecomment-644545373",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/6133",
    "id": 644545373,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY0NDU0NTM3Mw==",
    "user": {
      "login": "raphpa",
      "id": 18283997,
      "node_id": "MDQ6VXNlcjE4MjgzOTk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/18283997?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/raphpa",
      "html_url": "https://github.com/raphpa",
      "followers_url": "https://api.github.com/users/raphpa/followers",
      "following_url": "https://api.github.com/users/raphpa/following{/other_user}",
      "gists_url": "https://api.github.com/users/raphpa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/raphpa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/raphpa/subscriptions",
      "organizations_url": "https://api.github.com/users/raphpa/orgs",
      "repos_url": "https://api.github.com/users/raphpa/repos",
      "events_url": "https://api.github.com/users/raphpa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/raphpa/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-06-16T05:49:19Z",
    "updated_at": "2020-06-16T05:49:19Z",
    "author_association": "NONE",
    "body": "Cannot reproduce this anymore, so it might have been also related to #6156 somehow.",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/644545373/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
