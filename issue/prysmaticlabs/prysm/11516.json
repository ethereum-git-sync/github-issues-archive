{
  "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/11516",
  "repository_url": "https://api.github.com/repos/prysmaticlabs/prysm",
  "labels_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/11516/labels{/name}",
  "comments_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/11516/comments",
  "events_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/11516/events",
  "html_url": "https://github.com/prysmaticlabs/prysm/issues/11516",
  "id": 1391960201,
  "node_id": "I_kwDOBvuov85S96CJ",
  "number": 11516,
  "title": "Empty Block. Txs on EC but not seen anything on Prysm ",
  "user": {
    "login": "PacoBits",
    "id": 38920606,
    "node_id": "MDQ6VXNlcjM4OTIwNjA2",
    "avatar_url": "https://avatars.githubusercontent.com/u/38920606?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/PacoBits",
    "html_url": "https://github.com/PacoBits",
    "followers_url": "https://api.github.com/users/PacoBits/followers",
    "following_url": "https://api.github.com/users/PacoBits/following{/other_user}",
    "gists_url": "https://api.github.com/users/PacoBits/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/PacoBits/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/PacoBits/subscriptions",
    "organizations_url": "https://api.github.com/users/PacoBits/orgs",
    "repos_url": "https://api.github.com/users/PacoBits/repos",
    "events_url": "https://api.github.com/users/PacoBits/events{/privacy}",
    "received_events_url": "https://api.github.com/users/PacoBits/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2022-09-30T07:16:24Z",
  "updated_at": "2022-09-30T17:19:41Z",
  "closed_at": "2022-09-30T17:19:41Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "We produced a empty block: https://etherscan.io/block/15637620 \r\n\r\nThis issue is reproducible on mainnet and prater using this setup:\r\n\r\nWe have a 3-layer configuration with the validator client, the Beacon node  and the execution client running separately.\r\n\r\nThese are our current versions and configs:\r\n\r\n```\r\nValidator set up - version: Lighthouse/v3.1.2-01e84b7\r\n         lighthouse vc\r\n         --beacon-nodes http://prsym,http://lh_fallback\r\n         --network mainnet\r\n         --metrics\r\n         --metrics-allow-origin *\r\n         --graffiti \"Block by Stakely Lido04\"\r\n         --suggested-fee-recipient 0x388C818CA8B9251b393131C08a736A67ccB19297\r\n         --init-slashing-protection\r\n         --metrics-port 4067\r\n\r\n```\r\n\r\n```\r\nPRYSM Beacon  set up - Prysm/v3.1.1/653ea3b030c3bb99aa3f3d95a8de9f4d6e147930. Built at: 2022-09-09 21:18:25+00:00\r\n...\r\n    network_mode: host\r\n    volumes:\r\n      - /xx/xxx/prysm-data/:/data\r\n      - /xx/xxx/merge_besu_prysm.hex:/merge_jwt\r\n    command: >-\r\n      --datadir=/data\r\n      --rpc-host=0.0.0.0\r\n      --monitoring-host=127.0.0.1\r\n      --execution-endpoint=http://x.x.x.x:8551\r\n      --jwt-secret /merge_jwt\r\n      --subscribe-all-subnets=true\r\n      --mainnet\r\n      --accept-terms-of-use\r\n      --grpc-gateway-host 0.0.0.0\r\n      --checkpoint-sync-url=http://x.x.x.x:xx\r\n      --genesis-beacon-api-url=http://x.x.x.x:xx\r\n      --suggested-fee-recipient  xxxx\r\n```\r\n\r\n\r\n```\r\nExecution Client - besu/v22.7.4/linux-x86_64/openjdk-java-11\r\n...\r\n    network_mode: host\r\n    volumes:\r\n      - /xx/xxx/besu-data/:/var/lib/besu\r\n      - /xx/xxx/merge_besu_prysm.hex:/var/lib/merge_jwt\r\n    command: >-\r\n      --rpc-http-enabled\r\n      --data-path=/var/lib/besu\r\n      --network=mainnet\r\n      --engine-rpc-http-port=8551\r\n      --engine-jwt-secret=/var/lib/merge_jwt\r\n      --engine-jwt-enabled=true\r\n      --engine-host-allowlist=\"*\"\r\n      --engine-rpc-enabled\r\n      --rpc-http-api=ADMIN,TXPOOL,DEBUG,ETH,NET\r\n      --host-allowlist=\"*\"\r\n```\r\n\r\n\r\nThe attached logs shows block was generated by besu with 276 transactions, but prysm doesnt shows any info and finally block is published with 0 tx:\r\nValidator client log (no more info related to block on Validator Client):\r\n`Successfully published block\\cf0             slot: 4801150, graffiti: Some(\"Block by Stakely Lido04\"), attestations: 128, deposits: 0, block_type: Full, service: block`\r\n\r\nWe are stuck on this problem since merge on prater. Its reproducible at anytime on prater and mainnet. \r\n[besu29092022.log](https://github.com/prysmaticlabs/prysm/files/9681660/besu29092022.log)\r\n[prysm29092022.log](https://github.com/prysmaticlabs/prysm/files/9681661/prysm29092022.log)\r\n",
  "closed_by": {
    "login": "rkapka",
    "id": 28876818,
    "node_id": "MDQ6VXNlcjI4ODc2ODE4",
    "avatar_url": "https://avatars.githubusercontent.com/u/28876818?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/rkapka",
    "html_url": "https://github.com/rkapka",
    "followers_url": "https://api.github.com/users/rkapka/followers",
    "following_url": "https://api.github.com/users/rkapka/following{/other_user}",
    "gists_url": "https://api.github.com/users/rkapka/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/rkapka/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rkapka/subscriptions",
    "organizations_url": "https://api.github.com/users/rkapka/orgs",
    "repos_url": "https://api.github.com/users/rkapka/repos",
    "events_url": "https://api.github.com/users/rkapka/events{/privacy}",
    "received_events_url": "https://api.github.com/users/rkapka/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/11516/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/11516/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1263501369",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/11516#issuecomment-1263501369",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/11516",
    "id": 1263501369,
    "node_id": "IC_kwDOBvuov85LT4A5",
    "user": {
      "login": "potuz",
      "id": 16044918,
      "node_id": "MDQ6VXNlcjE2MDQ0OTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/16044918?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/potuz",
      "html_url": "https://github.com/potuz",
      "followers_url": "https://api.github.com/users/potuz/followers",
      "following_url": "https://api.github.com/users/potuz/following{/other_user}",
      "gists_url": "https://api.github.com/users/potuz/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/potuz/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/potuz/subscriptions",
      "organizations_url": "https://api.github.com/users/potuz/orgs",
      "repos_url": "https://api.github.com/users/potuz/repos",
      "events_url": "https://api.github.com/users/potuz/events{/privacy}",
      "received_events_url": "https://api.github.com/users/potuz/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-30T12:19:48Z",
    "updated_at": "2022-09-30T12:19:48Z",
    "author_association": "CONTRIBUTOR",
    "body": "Besu's log shows \r\n```\r\nbesu_latest | 2022-09-29 07:50:23.120+00:00 | vert.x-worker-thread-0 | INFO  | EngineGetPayload | Fetch block proposal by identifier: 0x00000000678e1db4, hash: 0x38dd24b7c70d00e5e5731ac6fa43bd50e7ad1e595dd07aca64d14c524f4d0f5b, number: 15637620, coinbase: 0x388c818ca8b9251b393               131c08a736a67ccb19297, transaction count: 0\r\n```\r\nWhich is the block that was published with zero transactions, and then later shows\r\n```\r\nbesu_latest | 2022-09-29 07:50:26.629+00:00 | EthScheduler-Computation-0 | INFO  | MergeCoordinator | Successfully built block 15637620 (0x2ebb788240d29463fda65eea54568dc0d9df44d41e27608cf1bdea16b3770dc7) for proposal identified by 0x00000000678e1db4, with 276 transactions, in                3523ms\r\n```\r\nthat it built the block with the same identifier in 3.5 seconds. I am guessing that there is a timeout going on here, hinting to a Besu bug. \r\n\r\nOn the other hand, Besu's logs also show something strange: there are many different `newPayloads` in sequence, and only few  FCU. It would be nice to know if they do not log every FCU received.  The last FCU received by Besu before the block fetch is \r\n```\r\nbesu_latest | 2022-09-29 07:49:38.632+00:00 | vert.x-worker-thread-0 | INFO  | EngineForkchoiceUpdated | VALID for fork-choice-update: head: 0xfd652371a6e32022aa881fe1acf6231b90bac2335deeab1d6282c3abfeb2d32d, finalized: 0x1628b1e4a5e31942f77f30bbc57bcd8d8e3df63cd8a2b2f2ef52509               1e2a25797, safeBlockHash: 0xdd6cc218bacffc30bea8c1b12d5e4b59f0a8019a6b16db30cdae463834b9a046\r\n```\r\nWhich corresponds to the block in slot `4801146`, that's 4 blocks before the proposal. If those logs are accurate, then probably what happened is that prysm didn't give any time to Besu to produce the block. This is backed up by the logs:\r\n\r\nThe logs show that Besu started producing the block 3.5 seconds before `07:50:26.629`, that is `07:50:23.106`. This is only 14ms before the fetch message. So it seems that Besu started producing the block at the same time that it was requested one. \r\n\r\nSo the question here is whether there is a bug in Besu not caring/logging for the FCUs that prysm sent, or there is a bug in Prysm not sending FCUs. From prysms logs there is nothing wrong, it acted as it was supposed to, but it's hard to tell without debug logs. ",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1263501369/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1263702230",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/11516#issuecomment-1263702230",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/11516",
    "id": 1263702230,
    "node_id": "IC_kwDOBvuov85LUpDW",
    "user": {
      "login": "potuz",
      "id": 16044918,
      "node_id": "MDQ6VXNlcjE2MDQ0OTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/16044918?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/potuz",
      "html_url": "https://github.com/potuz",
      "followers_url": "https://api.github.com/users/potuz/followers",
      "following_url": "https://api.github.com/users/potuz/following{/other_user}",
      "gists_url": "https://api.github.com/users/potuz/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/potuz/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/potuz/subscriptions",
      "organizations_url": "https://api.github.com/users/potuz/orgs",
      "repos_url": "https://api.github.com/users/potuz/repos",
      "events_url": "https://api.github.com/users/potuz/events{/privacy}",
      "received_events_url": "https://api.github.com/users/potuz/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-30T15:13:15Z",
    "updated_at": "2022-09-30T15:13:15Z",
    "author_association": "CONTRIBUTOR",
    "body": "Confirmed with Besu that they don't log all FCUs so fixing #11520 should close this issue. Can we probably mark it as duplicate?",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1263702230/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1263708274",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/11516#issuecomment-1263708274",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/11516",
    "id": 1263708274,
    "node_id": "IC_kwDOBvuov85LUqhy",
    "user": {
      "login": "fab-10",
      "id": 91944855,
      "node_id": "U_kgDOBXr3lw",
      "avatar_url": "https://avatars.githubusercontent.com/u/91944855?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fab-10",
      "html_url": "https://github.com/fab-10",
      "followers_url": "https://api.github.com/users/fab-10/followers",
      "following_url": "https://api.github.com/users/fab-10/following{/other_user}",
      "gists_url": "https://api.github.com/users/fab-10/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fab-10/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fab-10/subscriptions",
      "organizations_url": "https://api.github.com/users/fab-10/orgs",
      "repos_url": "https://api.github.com/users/fab-10/repos",
      "events_url": "https://api.github.com/users/fab-10/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fab-10/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-30T15:18:41Z",
    "updated_at": "2022-09-30T15:18:41Z",
    "author_association": "NONE",
    "body": "Looking at the Besu logs, the GetPayload was called shortly after the FcU call with the payload parameters, and so only the empty block was ready at that time, and it was returned, concurrently the better one was still building but if was ready too late. We are evaluating strategies to mitigate this kind of scenario and avoid returning an empty block.",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1263708274/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
