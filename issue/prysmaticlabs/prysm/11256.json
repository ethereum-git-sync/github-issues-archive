{
  "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/11256",
  "repository_url": "https://api.github.com/repos/prysmaticlabs/prysm",
  "labels_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/11256/labels{/name}",
  "comments_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/11256/comments",
  "events_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/11256/events",
  "html_url": "https://github.com/prysmaticlabs/prysm/issues/11256",
  "id": 1342798042,
  "node_id": "I_kwDOBvuov85QCXja",
  "number": 11256,
  "title": "EIP-4881 Deposit Trie Optimization",
  "user": {
    "login": "saolyn",
    "id": 15244892,
    "node_id": "MDQ6VXNlcjE1MjQ0ODky",
    "avatar_url": "https://avatars.githubusercontent.com/u/15244892?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/saolyn",
    "html_url": "https://github.com/saolyn",
    "followers_url": "https://api.github.com/users/saolyn/followers",
    "following_url": "https://api.github.com/users/saolyn/following{/other_user}",
    "gists_url": "https://api.github.com/users/saolyn/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/saolyn/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/saolyn/subscriptions",
    "organizations_url": "https://api.github.com/users/saolyn/orgs",
    "repos_url": "https://api.github.com/users/saolyn/repos",
    "events_url": "https://api.github.com/users/saolyn/events{/privacy}",
    "received_events_url": "https://api.github.com/users/saolyn/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1241586918,
      "node_id": "MDU6TGFiZWwxMjQxNTg2OTE4",
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/labels/Tracking",
      "name": "Tracking",
      "color": "d0ff7f",
      "default": false,
      "description": "Gotta Catch 'Em All"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": {
    "login": "saolyn",
    "id": 15244892,
    "node_id": "MDQ6VXNlcjE1MjQ0ODky",
    "avatar_url": "https://avatars.githubusercontent.com/u/15244892?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/saolyn",
    "html_url": "https://github.com/saolyn",
    "followers_url": "https://api.github.com/users/saolyn/followers",
    "following_url": "https://api.github.com/users/saolyn/following{/other_user}",
    "gists_url": "https://api.github.com/users/saolyn/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/saolyn/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/saolyn/subscriptions",
    "organizations_url": "https://api.github.com/users/saolyn/orgs",
    "repos_url": "https://api.github.com/users/saolyn/repos",
    "events_url": "https://api.github.com/users/saolyn/events{/privacy}",
    "received_events_url": "https://api.github.com/users/saolyn/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "saolyn",
      "id": 15244892,
      "node_id": "MDQ6VXNlcjE1MjQ0ODky",
      "avatar_url": "https://avatars.githubusercontent.com/u/15244892?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/saolyn",
      "html_url": "https://github.com/saolyn",
      "followers_url": "https://api.github.com/users/saolyn/followers",
      "following_url": "https://api.github.com/users/saolyn/following{/other_user}",
      "gists_url": "https://api.github.com/users/saolyn/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/saolyn/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/saolyn/subscriptions",
      "organizations_url": "https://api.github.com/users/saolyn/orgs",
      "repos_url": "https://api.github.com/users/saolyn/repos",
      "events_url": "https://api.github.com/users/saolyn/events{/privacy}",
      "received_events_url": "https://api.github.com/users/saolyn/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2022-08-18T09:06:30Z",
  "updated_at": "2023-06-02T12:31:21Z",
  "closed_at": null,
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "<!--üíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíé\r\n\r\nHellooo! üòÑ \r\n\r\nThanks for taking the time to file a tracking issue for your new feature. These issues really help\r\nus track progress of features as they work their way through development. Be sure to review \r\nshared/featureconfig/README.md for the latest documentation around feature flags.\r\n\r\nüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíé-->\r\n\r\n# ü¶Ñ Feature Tracking\r\n\r\nThis feature stems from an idea of @nisdas on representing the deposit trie in a more space-efficient manner: #10179.\r\n\r\nMore details can be found in the [design doc](https://www.notion.so/prysmaticlabs/EIP-4881-Deposit-Trie-Optimizations-962179eb5bd348ec9411b80c281fa13c).\r\n\r\n### Feature Description\r\n\r\nCurrently, Prysm stores a deposits Merkle trie in memory, which is a massive cost on RAM given we keep the data of all the related deposits in the beacon node. On mainnet, this includes over 400,000 deposits, and beacon nodes also have the hidden costs of having to retrieve these 400k deposit logs from an associated execution client. However, this is not necessary for consensus. A few ideas have emerged on how to reduce the impact of handling deposits in beacon nodes.\r\n\r\n### Goals\r\n- Minimize the memory footprint of our deposits trie and prune deposits older than the finalized ones from the perspective of the finalized execution client block hash\r\n- To support finalized deposit trie snapshots via checkpoint sync, √† la [EIP-4881](https://eips.ethereum.org/EIPS/eip-4881)\r\n\r\n### Approach\r\n\r\nWe are to adapt the reference design of [EIP-4881](https://eips.ethereum.org/EIPS/eip-4881) to our current implementation of a sparse merkle trie and without recursion.\r\n\r\n### Tasks\r\n\r\n- [x] Raw implementation of the EIP\r\n- [x] Create a new package under `beacon-chain/cache/depositsnapshot` containing a sparse Merkle tree that supports ‚Äúfinalizing‚Äù and pruning branches that are not needed\r\n- [x] Implement the reference design of EIP-4881, but without recursion\r\n- [x] Implement `MerkleTree` with and without recursion\r\n- [x] Implement `DepositTree`\r\n- [x] Implement `get_proof` for both `MerkleTree` and `DepositTree`\r\n- [x] Implement  `DepositTreeSnapshot`\r\n- [x] Implement the spec test\r\n- [x] Test that the resulting trees are as expected\r\n- [ ] Add fuzz tests\r\n- [x] Define a common interface that both `beacon-chain/cache/depositsnapshot` and `beacon-chain/cache/depositscache` implement, so they can be swappable at runtime\r\n- [x] Benchmark both deposit tree implementations for some of their important methods\r\n- [ ] Benchmark the pruning and finalization of the new trie design\r\n- [x] Figure out what changes need to happen at the DB layer for this new design\r\n- [x] Create a feature flag for swapping between implementations at runtime\r\n- [ ] Finally, implement the RPC endpoints required by EIP-4881\r\n\r\nThis issue should be closed after all of the above tasks are complete.\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/11256/reactions",
    "total_count": 2,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 2,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/11256/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1219235832",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/11256#issuecomment-1219235832",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/11256",
    "id": 1219235832,
    "node_id": "IC_kwDOBvuov85IrA_4",
    "user": {
      "login": "saolyn",
      "id": 15244892,
      "node_id": "MDQ6VXNlcjE1MjQ0ODky",
      "avatar_url": "https://avatars.githubusercontent.com/u/15244892?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/saolyn",
      "html_url": "https://github.com/saolyn",
      "followers_url": "https://api.github.com/users/saolyn/followers",
      "following_url": "https://api.github.com/users/saolyn/following{/other_user}",
      "gists_url": "https://api.github.com/users/saolyn/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/saolyn/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/saolyn/subscriptions",
      "organizations_url": "https://api.github.com/users/saolyn/orgs",
      "repos_url": "https://api.github.com/users/saolyn/repos",
      "events_url": "https://api.github.com/users/saolyn/events{/privacy}",
      "received_events_url": "https://api.github.com/users/saolyn/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-18T09:14:59Z",
    "updated_at": "2022-08-18T09:23:54Z",
    "author_association": "CONTRIBUTOR",
    "body": "Here is a [branch](https://github.com/prysmaticlabs/prysm/compare/optimized-deposit-tree) containing the bare minimum raw Go implementation of the EIP-4881 algorithm. ",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1219235832/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
