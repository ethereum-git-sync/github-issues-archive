{
  "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/8154",
  "repository_url": "https://api.github.com/repos/prysmaticlabs/prysm",
  "labels_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/8154/labels{/name}",
  "comments_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/8154/comments",
  "events_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/8154/events",
  "html_url": "https://github.com/prysmaticlabs/prysm/issues/8154",
  "id": 770831232,
  "node_id": "MDU6SXNzdWU3NzA4MzEyMzI=",
  "number": 8154,
  "title": "Prysm API returns slashing rewards and  block rewards in different epochs",
  "user": {
    "login": "Buttaa",
    "id": 26490734,
    "node_id": "MDQ6VXNlcjI2NDkwNzM0",
    "avatar_url": "https://avatars.githubusercontent.com/u/26490734?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Buttaa",
    "html_url": "https://github.com/Buttaa",
    "followers_url": "https://api.github.com/users/Buttaa/followers",
    "following_url": "https://api.github.com/users/Buttaa/following{/other_user}",
    "gists_url": "https://api.github.com/users/Buttaa/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Buttaa/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Buttaa/subscriptions",
    "organizations_url": "https://api.github.com/users/Buttaa/orgs",
    "repos_url": "https://api.github.com/users/Buttaa/repos",
    "events_url": "https://api.github.com/users/Buttaa/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Buttaa/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 802129904,
      "node_id": "MDU6TGFiZWw4MDIxMjk5MDQ=",
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/labels/Bug",
      "name": "Bug",
      "color": "ee0701",
      "default": false,
      "description": "Something isn't working"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2020-12-18T11:59:53Z",
  "updated_at": "2021-01-12T16:22:42Z",
  "closed_at": "2021-01-12T16:22:42Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "# üêû Bug Report\r\n\r\n### Description\r\n\r\n\r\nThe issue seems to be that even though slashings are included in a block, that the Prysm api returns the rewards for slashings in the next epoch and for block rewards after two. \r\nWhich is why the rewards in 3690 are +0.06256 ETH (slashing) and 3691 +0.00214 ETH (block proposal). It should however be +0,06470 ETH in Epoch 3690 (block+slashing)\r\n\r\nhttps://mainnet.beaconcha.in/validator/15703#balanceChart\r\n\r\n![image](https://user-images.githubusercontent.com/26490734/102612306-c8ead180-4130-11eb-86c9-76ec8d7e4686.png)\r\n\r\n",
  "closed_by": {
    "login": "rauljordan",
    "id": 5572669,
    "node_id": "MDQ6VXNlcjU1NzI2Njk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5572669?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/rauljordan",
    "html_url": "https://github.com/rauljordan",
    "followers_url": "https://api.github.com/users/rauljordan/followers",
    "following_url": "https://api.github.com/users/rauljordan/following{/other_user}",
    "gists_url": "https://api.github.com/users/rauljordan/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/rauljordan/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rauljordan/subscriptions",
    "organizations_url": "https://api.github.com/users/rauljordan/orgs",
    "repos_url": "https://api.github.com/users/rauljordan/repos",
    "events_url": "https://api.github.com/users/rauljordan/events{/privacy}",
    "received_events_url": "https://api.github.com/users/rauljordan/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/8154/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/8154/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/749506825",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/8154#issuecomment-749506825",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/8154",
    "id": 749506825,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc0OTUwNjgyNQ==",
    "user": {
      "login": "Buttaa",
      "id": 26490734,
      "node_id": "MDQ6VXNlcjI2NDkwNzM0",
      "avatar_url": "https://avatars.githubusercontent.com/u/26490734?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Buttaa",
      "html_url": "https://github.com/Buttaa",
      "followers_url": "https://api.github.com/users/Buttaa/followers",
      "following_url": "https://api.github.com/users/Buttaa/following{/other_user}",
      "gists_url": "https://api.github.com/users/Buttaa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Buttaa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Buttaa/subscriptions",
      "organizations_url": "https://api.github.com/users/Buttaa/orgs",
      "repos_url": "https://api.github.com/users/Buttaa/repos",
      "events_url": "https://api.github.com/users/Buttaa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Buttaa/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-12-22T12:02:28Z",
    "updated_at": "2020-12-22T15:35:57Z",
    "author_association": "NONE",
    "body": "Attestations seem to +2 epoch\r\n\r\nAttestations +2 epoch\r\nSlashings +1 epoch\r\nBlock rewards +2 epochs",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/749506825/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/755677443",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/8154#issuecomment-755677443",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/8154",
    "id": 755677443,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc1NTY3NzQ0Mw==",
    "user": {
      "login": "potuz",
      "id": 16044918,
      "node_id": "MDQ6VXNlcjE2MDQ0OTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/16044918?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/potuz",
      "html_url": "https://github.com/potuz",
      "followers_url": "https://api.github.com/users/potuz/followers",
      "following_url": "https://api.github.com/users/potuz/following{/other_user}",
      "gists_url": "https://api.github.com/users/potuz/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/potuz/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/potuz/subscriptions",
      "organizations_url": "https://api.github.com/users/potuz/orgs",
      "repos_url": "https://api.github.com/users/potuz/repos",
      "events_url": "https://api.github.com/users/potuz/events{/privacy}",
      "received_events_url": "https://api.github.com/users/potuz/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-01-06T20:52:25Z",
    "updated_at": "2021-01-06T20:52:25Z",
    "author_association": "CONTRIBUTOR",
    "body": "After reviewing it carefully and given the information provided in \r\n\r\nhttps://discord.com/channels/476244492043812875/603588441741066241/796008807088128031\r\n\r\nI believe nothing can be done by prysm here. The API call beaconcha.in is using requests the validator balances at the beginning of each epoch. The relevant rewards are awarded as follows (notation is from the spec) and the epoch/slot number are as in the example in the description: the validator proposed a block in epoch 3691 including a slashing\r\n\r\n1. The whistleblower reward, which is currently awarded to the block proposer, is awarded immediately on this callpath\r\n`slash_validator` <--- `process_proposer/attester_slashing` <---- `process_operations` <---- `process_block` \r\n\r\nSo this reward is given immediately and will be picked by the balance call in epoch 3692. \r\n\r\n2. The proposer rewards are computed inside `get_inclusion_delay_deltas` on epoch processing. The way epoch processing works is by taking all attestations from the previous epoch. This previous epoch is explicit in this line:\r\n```\r\nmatching_source_attestations = get_matching_source_attestations(state, get_previous_epoch(state))\r\n```\r\n\r\nAfter that for each such attestation we give a reward to the validator with index `attestation.proposer_index`. This means, that in the epoch transition 3691 --> 3692, the attestations from epoch 3690 were picked up and to each block proposer from that epoch some rewards were given. Our validator that proposed in 3691 will not see these rewards until the transition 3692 --> 3693. \r\n\r\nI believe at the time of the picture taken, beaconcha.in was subtracting 2 epochs from each call, making it consistent to here. There is nothing that can be done on prysm side regarding this API call. However, it seems to me that beaconcha.in could assume the slashing reward is in epoch N-1 since this is immediately awarded. And block proposals and attestations are in epoch N-2.  Having said so, there is this screenshot posted in Discord\r\n\r\nhttps://discord.com/channels/694822223575384095/768206298734788618/790992876968345610\r\n\r\nThat gives a counterexample to that, I am not sure how can that happen. ",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/755677443/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/756043025",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/8154#issuecomment-756043025",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/8154",
    "id": 756043025,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc1NjA0MzAyNQ==",
    "user": {
      "login": "potuz",
      "id": 16044918,
      "node_id": "MDQ6VXNlcjE2MDQ0OTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/16044918?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/potuz",
      "html_url": "https://github.com/potuz",
      "followers_url": "https://api.github.com/users/potuz/followers",
      "following_url": "https://api.github.com/users/potuz/following{/other_user}",
      "gists_url": "https://api.github.com/users/potuz/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/potuz/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/potuz/subscriptions",
      "organizations_url": "https://api.github.com/users/potuz/orgs",
      "repos_url": "https://api.github.com/users/potuz/repos",
      "events_url": "https://api.github.com/users/potuz/events{/privacy}",
      "received_events_url": "https://api.github.com/users/potuz/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-01-07T10:54:30Z",
    "updated_at": "2021-01-07T10:54:30Z",
    "author_association": "CONTRIBUTOR",
    "body": "Thinking about this issue, I think what beaconcha.in should be doing is the following: \r\n\r\n1. When a validator attests in epoch N and no block with a slashing was proposed in epoch N+1, assign the balance change reported at epoch N+2 to epoch N. \r\n2. In the other situation:  When a  validator attests in epoch N and proposes with a slashing in epoch N+1 then compute the slashing rewards, these have very simple formulas\r\n```\r\n    whistleblower_reward = Gwei(validator.effective_balance // WHISTLEBLOWER_REWARD_QUOTIENT)\r\n    proposer_reward = Gwei(whistleblower_reward // PROPOSER_REWARD_QUOTIENT)\r\n```\r\nThe constants are in the specs and the effective balances are kept by beaconcha.in anyway. \r\n\r\nAfter computing this reward then report the balance change of epoch N+2 minus this reward in epoch N. Report the balance change of epoch N+3 plus this reward in epoch N+1\r\n\r\nCare must be taken in the case a validator proposes in two consecutive epochs. ",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/756043025/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/756064261",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/8154#issuecomment-756064261",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/8154",
    "id": 756064261,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc1NjA2NDI2MQ==",
    "user": {
      "login": "pinglamb",
      "id": 287503,
      "node_id": "MDQ6VXNlcjI4NzUwMw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/287503?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pinglamb",
      "html_url": "https://github.com/pinglamb",
      "followers_url": "https://api.github.com/users/pinglamb/followers",
      "following_url": "https://api.github.com/users/pinglamb/following{/other_user}",
      "gists_url": "https://api.github.com/users/pinglamb/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pinglamb/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pinglamb/subscriptions",
      "organizations_url": "https://api.github.com/users/pinglamb/orgs",
      "repos_url": "https://api.github.com/users/pinglamb/repos",
      "events_url": "https://api.github.com/users/pinglamb/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pinglamb/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-01-07T11:38:17Z",
    "updated_at": "2021-01-07T11:38:17Z",
    "author_association": "CONTRIBUTOR",
    "body": "@rkapka To conclude, I think it is not a `prysm` bug. The `proposer rewards` from `attestations inclusion` and `slashing` reflected in different epochs is an expected behaviour according to `eth2-specs`. `slashing reward` will be reflected in same epoch as block proposal and `attestations inclusion reward` will be reflected in next epoch. So I think this issue can be closed.\r\n\r\nHow to have `Balance Change`/`Reward` reported in beaconcha.in is a separate topic.",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/756064261/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
