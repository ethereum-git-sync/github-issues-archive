{
  "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/12527",
  "repository_url": "https://api.github.com/repos/prysmaticlabs/prysm",
  "labels_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/12527/labels{/name}",
  "comments_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/12527/comments",
  "events_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/12527/events",
  "html_url": "https://github.com/prysmaticlabs/prysm/issues/12527",
  "id": 1757237540,
  "node_id": "I_kwDOBvuov85ovVEk",
  "number": 12527,
  "title": "Validator client fails to update proposer settings because of bn latency with high amount of keys",
  "user": {
    "login": "0xalex88",
    "id": 113263502,
    "node_id": "U_kgDOBsBDjg",
    "avatar_url": "https://avatars.githubusercontent.com/u/113263502?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/0xalex88",
    "html_url": "https://github.com/0xalex88",
    "followers_url": "https://api.github.com/users/0xalex88/followers",
    "following_url": "https://api.github.com/users/0xalex88/following{/other_user}",
    "gists_url": "https://api.github.com/users/0xalex88/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/0xalex88/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/0xalex88/subscriptions",
    "organizations_url": "https://api.github.com/users/0xalex88/orgs",
    "repos_url": "https://api.github.com/users/0xalex88/repos",
    "events_url": "https://api.github.com/users/0xalex88/events{/privacy}",
    "received_events_url": "https://api.github.com/users/0xalex88/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 802129904,
      "node_id": "MDU6TGFiZWw4MDIxMjk5MDQ=",
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/labels/Bug",
      "name": "Bug",
      "color": "ee0701",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 4218204170,
      "node_id": "LA_kwDOBvuov877bLAK",
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/labels/optimization",
      "name": "optimization",
      "color": "D83FF8",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": {
    "login": "james-prysm",
    "id": 90280386,
    "node_id": "MDQ6VXNlcjkwMjgwMzg2",
    "avatar_url": "https://avatars.githubusercontent.com/u/90280386?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/james-prysm",
    "html_url": "https://github.com/james-prysm",
    "followers_url": "https://api.github.com/users/james-prysm/followers",
    "following_url": "https://api.github.com/users/james-prysm/following{/other_user}",
    "gists_url": "https://api.github.com/users/james-prysm/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/james-prysm/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/james-prysm/subscriptions",
    "organizations_url": "https://api.github.com/users/james-prysm/orgs",
    "repos_url": "https://api.github.com/users/james-prysm/repos",
    "events_url": "https://api.github.com/users/james-prysm/events{/privacy}",
    "received_events_url": "https://api.github.com/users/james-prysm/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "james-prysm",
      "id": 90280386,
      "node_id": "MDQ6VXNlcjkwMjgwMzg2",
      "avatar_url": "https://avatars.githubusercontent.com/u/90280386?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/james-prysm",
      "html_url": "https://github.com/james-prysm",
      "followers_url": "https://api.github.com/users/james-prysm/followers",
      "following_url": "https://api.github.com/users/james-prysm/following{/other_user}",
      "gists_url": "https://api.github.com/users/james-prysm/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/james-prysm/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/james-prysm/subscriptions",
      "organizations_url": "https://api.github.com/users/james-prysm/orgs",
      "repos_url": "https://api.github.com/users/james-prysm/repos",
      "events_url": "https://api.github.com/users/james-prysm/events{/privacy}",
      "received_events_url": "https://api.github.com/users/james-prysm/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2023-06-14T16:08:21Z",
  "updated_at": "2023-06-15T03:25:08Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "# ðŸ’Ž Issue\r\n\r\n### Background\r\n\r\nStarting the validator client fails when there are enough keys and enough latency to the beacon node to reach the 12 seconds timeout while updating proposer settings\r\n\r\n### Description\r\n\r\nWe have a vc with failover beacon nodes, one of them is in another datacenter and there are 1k (mostly pending) keys configured. When the validator client tries to start with the failover node that has 10ms latency (vs 0.5ms of the primary) it fails after 12 seconds with:\r\n\r\n```json\r\n{\"time\":\"2023-06-13T22:50:58Z\",\"level\":\"info\",\"msg\":\"Validator client started with provided proposer settings that sets options such as fee recipient and will periodically update the beacon node and custom builder (if --enable-builder)\",\"prefix\":\"validator\"}\r\n// more validatorIndex requests\r\n{\"time\":\"2023-06-13T22:51:10Z\",\"backend\":null,\"duration\":10916936,\"level\":\"debug\",\"method\":\"/ethereum.eth.v1alpha1.BeaconNodeValidator/ValidatorIndex\",\"msg\":\"gRPC request finished.\"}\r\n{\"time\":\"2023-06-13T22:51:10Z\",\"error\":\"rpc error: code = DeadlineExceeded desc = context deadline exceeded\",\"level\":\"fatal\",\"msg\":\"Failed to update proposer settings\",\"prefix\":\"validator\"}\r\n```\r\n\r\nwhile with the primary one it starts fine after 3-4 seconds:\r\n\r\n```json\r\n{\"time\":\"2023-06-13T22:51:35Z\",\"level\":\"debug\",\"msg\":\"Prepare proposer request did not success with all pubkeys\",\"prefix\":\"validator\",\"pubkeysCount\":1000,\"reqCount\":31}\r\n```\r\n\r\nIt seems that the [loop](https://github.com/prysmaticlabs/prysm/blob/develop/validator/client/validator.go#L1018-L1034) that gets the validator indexes calls the beacon node sequentially. so if there's a 10ms delay and 1k keys that's already 10 seconds (without counting for the actual time taken to process the request).\r\n\r\nWhat could be a possible solution? Doing the index requests in parallel? Making the 12 seconds deadline adjustable? Or is 10ms/1k keys too much?",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/12527/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/12527/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1591817094",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/12527#issuecomment-1591817094",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/12527",
    "id": 1591817094,
    "node_id": "IC_kwDOBvuov85e4TOG",
    "user": {
      "login": "james-prysm",
      "id": 90280386,
      "node_id": "MDQ6VXNlcjkwMjgwMzg2",
      "avatar_url": "https://avatars.githubusercontent.com/u/90280386?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/james-prysm",
      "html_url": "https://github.com/james-prysm",
      "followers_url": "https://api.github.com/users/james-prysm/followers",
      "following_url": "https://api.github.com/users/james-prysm/following{/other_user}",
      "gists_url": "https://api.github.com/users/james-prysm/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/james-prysm/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/james-prysm/subscriptions",
      "organizations_url": "https://api.github.com/users/james-prysm/orgs",
      "repos_url": "https://api.github.com/users/james-prysm/repos",
      "events_url": "https://api.github.com/users/james-prysm/events{/privacy}",
      "received_events_url": "https://api.github.com/users/james-prysm/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-06-14T18:56:12Z",
    "updated_at": "2023-06-14T18:56:12Z",
    "author_association": "CONTRIBUTOR",
    "body": " > flag to skip the first call (downside would be that the validator won't be registered to the builder if it's the first start or fee recipient won't be updated until next epoch, probably not a big deal since it's opt-in)\r\nnot set a deadline on start (can result in slower startup like you said but with many keys also pruning the slashing database takes longer so I suppose that who has a high number of keys is already used to that)\r\nconfigurable deadline (like --api-timeout for api requests, could also be a hidden flag)\r\n\r\n> remove it + skip if db matches is probably the best, provides slow starts when required and fast restarts (opt-in)\r\n\r\nadding discord discussion items",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1591817094/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1592025694",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/12527#issuecomment-1592025694",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/12527",
    "id": 1592025694,
    "node_id": "IC_kwDOBvuov85e5GJe",
    "user": {
      "login": "0xalex88",
      "id": 113263502,
      "node_id": "U_kgDOBsBDjg",
      "avatar_url": "https://avatars.githubusercontent.com/u/113263502?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/0xalex88",
      "html_url": "https://github.com/0xalex88",
      "followers_url": "https://api.github.com/users/0xalex88/followers",
      "following_url": "https://api.github.com/users/0xalex88/following{/other_user}",
      "gists_url": "https://api.github.com/users/0xalex88/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/0xalex88/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/0xalex88/subscriptions",
      "organizations_url": "https://api.github.com/users/0xalex88/orgs",
      "repos_url": "https://api.github.com/users/0xalex88/repos",
      "events_url": "https://api.github.com/users/0xalex88/events{/privacy}",
      "received_events_url": "https://api.github.com/users/0xalex88/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-06-14T21:40:42Z",
    "updated_at": "2023-06-14T21:40:42Z",
    "author_association": "NONE",
    "body": "I've removed the deadline on startup https://github.com/0xalex88/prysm/commit/8a2d8eee2fed692d4f2379b04b684adf7c14a7ea \r\n\r\nI might be wrong but I think the test `TestUpdateProposerSettingsAt_EpochEndExceeded` was testing something different than the EpochEnd deadline, I think it was passing because of the 12 seconds deadline of the startup push, but it wasn't reaching the periodical push because the slot passed to the channel wasn't the start of the epoch (which is later checked in `if slots.IsEpochStart(slot) && v.ProposerSettings() != nil {`\r\nI'll look into adding the \"skip if db matches\" flag tomorrow",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1592025694/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1592292161",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/12527#issuecomment-1592292161",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/12527",
    "id": 1592292161,
    "node_id": "IC_kwDOBvuov85e6HNB",
    "user": {
      "login": "nisdas",
      "id": 33201827,
      "node_id": "MDQ6VXNlcjMzMjAxODI3",
      "avatar_url": "https://avatars.githubusercontent.com/u/33201827?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nisdas",
      "html_url": "https://github.com/nisdas",
      "followers_url": "https://api.github.com/users/nisdas/followers",
      "following_url": "https://api.github.com/users/nisdas/following{/other_user}",
      "gists_url": "https://api.github.com/users/nisdas/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nisdas/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nisdas/subscriptions",
      "organizations_url": "https://api.github.com/users/nisdas/orgs",
      "repos_url": "https://api.github.com/users/nisdas/repos",
      "events_url": "https://api.github.com/users/nisdas/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nisdas/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-06-15T03:25:08Z",
    "updated_at": "2023-06-15T03:25:08Z",
    "author_association": "MEMBER",
    "body": "@0xalex88 I think we can extend the deadline to a larger number (2 minutes, etc) for the first call to update proposer settings. It doesn't need to be 1 slot. This should fix your issue",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1592292161/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
