{
  "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/13051",
  "repository_url": "https://api.github.com/repos/prysmaticlabs/prysm",
  "labels_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/13051/labels{/name}",
  "comments_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/13051/comments",
  "events_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/13051/events",
  "html_url": "https://github.com/prysmaticlabs/prysm/issues/13051",
  "id": 1943159378,
  "node_id": "I_kwDOBvuov85z0kJS",
  "number": 13051,
  "title": "panic: runtime error: integer divide by zero - then database corrupted - hangs at \"Checking DB\" forever taking 200+ GB Memory",
  "user": {
    "login": "mbwmbw1337",
    "id": 6092663,
    "node_id": "MDQ6VXNlcjYwOTI2NjM=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6092663?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mbwmbw1337",
    "html_url": "https://github.com/mbwmbw1337",
    "followers_url": "https://api.github.com/users/mbwmbw1337/followers",
    "following_url": "https://api.github.com/users/mbwmbw1337/following{/other_user}",
    "gists_url": "https://api.github.com/users/mbwmbw1337/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mbwmbw1337/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mbwmbw1337/subscriptions",
    "organizations_url": "https://api.github.com/users/mbwmbw1337/orgs",
    "repos_url": "https://api.github.com/users/mbwmbw1337/repos",
    "events_url": "https://api.github.com/users/mbwmbw1337/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mbwmbw1337/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 802129904,
      "node_id": "MDU6TGFiZWw4MDIxMjk5MDQ=",
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/labels/Bug",
      "name": "Bug",
      "color": "ee0701",
      "default": false,
      "description": "Something isn't working"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2023-10-14T10:06:53Z",
  "updated_at": "2023-10-25T16:19:22Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Describe the bug\n\n[I got this error then the database is corrupted and never recovers. ](panic: runtime error: integer divide by zero - then database corrupted - hangs at \"Checking DB\" forever taking 200+ GB Memory)\r\n```\r\nOct 13 16:12:22 hostname bash[406365]: panic: runtime error: integer divide by zero\r\nOct 13 16:12:22 hostname bash[406365]: goroutine 859 [running]:\r\nOct 13 16:12:22 hostname bash[406365]: github.com/prysmaticlabs/prysm/v4/consensus-types/primitives.ValidatorIndex.Mod(...)\r\nOct 13 16:12:22 hostname bash[406365]:         /home/prysm/prysm/consensus-types/primitives/validator.go:39\r\nOct 13 16:12:22 hostname bash[406365]: github.com/prysmaticlabs/prysm/v4/beacon-chain/core/altair.NextSyncCommitteeIndices({0x25fdd38, 0xc020eeb740}, {0x2628f28?, 0xc0d1632fc0})\r\nOct 13 16:12:22 hostname bash[406365]:         /home/prysm/prysm/beacon-chain/core/altair/sync_committee.go:129 +0x4d8\r\nOct 13 16:12:22 hostname bash[406365]: github.com/prysmaticlabs/prysm/v4/beacon-chain/core/altair.NextSyncCommittee({0x25fdd38?, 0xc020eeb740?}, {0x2628f28?, 0xc0d1632fc0})\r\nOct 13 16:12:22 hostname bash[406365]:         /home/prysm/prysm/beacon-chain/core/altair/sync_committee.go:64 +0x50\r\nOct 13 16:12:22 hostname bash[406365]: github.com/prysmaticlabs/prysm/v4/beacon-chain/core/altair.ProcessSyncCommitteeUpdates({0x25fdd38, 0xc020eeb740}, {0x2628f28?, 0xc0d1632fc0})\r\nOct 13 16:12:22 hostname bash[406365]:         /home/prysm/prysm/beacon-chain/core/altair/epoch_spec.go:33 +0xcd\r\nOct 13 16:12:22 hostname bash[406365]: github.com/prysmaticlabs/prysm/v4/beacon-chain/core/altair.ProcessEpoch({0x25fdd38?, 0xc066752ea0?}, {0x2628f28, 0xc0d1632fc0})\r\nOct 13 16:12:22 hostname bash[406365]:         /home/prysm/prysm/beacon-chain/core/altair/transition.go:108 +0x3a9\r\nOct 13 16:12:22 hostname bash[406365]: github.com/prysmaticlabs/prysm/v4/beacon-chain/core/transition.ProcessSlots({0x25fdd38?, 0xc066752e70?}, {0x2628f28, 0xc06728cfc0}, 0x72e986)\r\nOct 13 16:12:22 hostname bash[406365]:         /home/prysm/prysm/beacon-chain/core/transition/transition.go:258 +0xa93\r\nOct 13 16:12:22 hostname bash[406365]: github.com/prysmaticlabs/prysm/v4/beacon-chain/core/transition.ProcessSlotsUsingNextSlotCache({0x25fdd38?, 0xc066752cf0?}, {0x2628f28, 0xc06728cfc0}, {0xc0f21c88a0, 0x20, 0x20}, 0x72e986)\r\nOct 13 16:12:22 hostname bash[406365]:         /home/prysm/prysm/beacon-chain/core/transition/transition.go:159 +0x185\r\nOct 13 16:12:22 hostname bash[406365]: github.com/prysmaticlabs/prysm/v4/beacon-chain/blockchain.(*Service).getPayloadAttribute(0xc00024f770, {0x25fdd38, 0xc066752cf0}, {0x2628f28, 0xc0c2566d80}, 0x72e986, {0xc0f21c88a0, 0x20, 0x20})\r\nOct 13 16:12:22 hostname bash[406365]:         /home/prysm/prysm/beacon-chain/blockchain/execution_engine.go:271 +0x17a\r\nOct 13 16:12:22 hostname bash[406365]: github.com/prysmaticlabs/prysm/v4/beacon-chain/blockchain.(*Service).notifyForkchoiceUpdate(0xc00024f770, {0x25fdd38?, 0xc0400fe4b0?}, 0xc12da2a890)\r\nOct 13 16:12:22 hostname bash[406365]:         /home/prysm/prysm/beacon-chain/blockchain/execution_engine.go:73 +0x725\r\nOct 13 16:12:22 hostname bash[406365]: github.com/prysmaticlabs/prysm/v4/beacon-chain/blockchain.(*Service).onBlockBatch(0xc00024f770, {0x25fdd38?, 0xc0400fe480?}, {0xc00345b800, 0x40, 0x0?}, {0xc0c1d9d800, 0x40, 0x0?})\r\nOct 13 16:12:22 hostname bash[406365]:         /home/prysm/prysm/beacon-chain/blockchain/process_block.go:329 +0x1b52\r\nOct 13 16:12:22 hostname bash[406365]: github.com/prysmaticlabs/prysm/v4/beacon-chain/blockchain.(*Service).ReceiveBlockBatch(0xc00024f770, {0x25fdc90?, 0xc005f4dbd0?}, {0xc00345b800?, 0x40, 0x40}, {0xc0c1d9d800, 0x40, 0x40})\r\nOct 13 16:12:22 hostname bash[406365]:         /home/prysm/prysm/beacon-chain/blockchain/receive_block.go:182 +0x1db\r\nOct 13 16:12:22 hostname bash[406365]: github.com/prysmaticlabs/prysm/v4/beacon-chain/sync/initial-sync.(*Service).processBatchedBlocks(0xc0000f3590, {0x25fdc90, 0xc005f4dbd0}, {0x0?, 0x0?, 0x3a800e0?}, {0xc00345b800, 0x40, 0x40}, 0xc0f6163328)\r\nOct 13 16:12:22 hostname bash[406365]:         /home/prysm/prysm/beacon-chain/sync/initial-sync/round_robin.go:288 +0x8c4\r\nOct 13 16:12:22 hostname bash[406365]: github.com/prysmaticlabs/prysm/v4/beacon-chain/sync/initial-sync.(*Service).processFetchedData(0xc00024f770?, {0x25fdc90?, 0xc005f4dbd0?}, {0x0?, 0xed7582757?, 0x3a800e0?}, 0x427e3d?, 0xc093a26030?)\r\nOct 13 16:12:22 hostname bash[406365]:         /home/prysm/prysm/beacon-chain/sync/initial-sync/round_robin.go:131 +0x11e\r\nOct 13 16:12:22 hostname bash[406365]: github.com/prysmaticlabs/prysm/v4/beacon-chain/sync/initial-sync.(*Service).syncToFinalizedEpoch(0xc0000f3590, {0x25fdc90, 0xc005f4dbd0}, {0x1ca35c0?, 0x37fcb20?, 0x3a800e0?})\r\nOct 13 16:12:22 hostname bash[406365]:         /home/prysm/prysm/beacon-chain/sync/initial-sync/round_robin.go:84 +0x285\r\nOct 13 16:12:22 hostname bash[406365]: github.com/prysmaticlabs/prysm/v4/beacon-chain/sync/initial-sync.(*Service).roundRobinSync(0xc0000f3590, {0xe00000004?, 0xc00681ba20?, 0x3a800e0?})\r\nOct 13 16:12:22 hostname bash[406365]:         /home/prysm/prysm/beacon-chain/sync/initial-sync/round_robin.go:47 +0x19b\r\nOct 13 16:12:22 hostname bash[406365]: github.com/prysmaticlabs/prysm/v4/beacon-chain/sync/initial-sync.(*Service).Start(0xc0000f3590)\r\nOct 13 16:12:22 hostname bash[406365]:         /home/prysm/prysm/beacon-chain/sync/initial-sync/service.go:118 +0x8ff\r\nOct 13 16:12:22 hostname bash[406365]: created by github.com/prysmaticlabs/prysm/v4/runtime.(*ServiceRegistry).StartAll\r\nOct 13 16:12:22 hostname bash[406365]:         /home/prysm/prysm/runtime/service_registry.go:46 +0xec\r\nOct 13 16:12:23 hostname bash[405995]: exit status 2\r\nOct 13 16:12:23 hostname systemd[1]: prysm-mainnet-beacon.service: Main process exited, code=exited, status=1/FAILURE\r\nOct 13 16:12:23 hostname systemd[1]: prysm-mainnet-beacon.service: Failed with result 'exit-code'.\r\nOct 13 16:12:23 hostname systemd[1]: prysm-mainnet-beacon.service: Consumed 2w 1d 13h 36min 56.756s CPU time.\r\nOct 13 16:12:28 hostname systemd[1]: prysm-mainnet-beacon.service: Scheduled restart job, restart counter is at 31.\r\nOct 13 16:12:28 hostname systemd[1]: Stopped prysm-mainnet-beacon.\r\nOct 13 16:12:28 hostname systemd[1]: prysm-mainnet-beacon.service: Consumed 2w 1d 13h 36min 56.756s CPU time.\r\nOct 13 16:12:28 hostname systemd[1]: Started prysm-mainnet-beacon.\r\nOct 13 16:12:50 hostname bash[2507892]: time=\"2023-10-13 16:12:50\" level=info msg=\"Finished reading JWT secret from /home/prysm/prysm-mainnet-beacon/jwt.hex\"\r\nOct 13 16:12:50 hostname bash[2507892]: time=\"2023-10-13 16:12:50\" level=warning msg=\"Running on Ethereum Mainnet\" prefix=flags\r\nOct 13 16:12:50 hostname bash[2507892]: time=\"2023-10-13 16:12:50\" level=warning msg=\"Enabled feature flag\" prefix=flags slasher=\"Enables a slasher in the beacon node for detecting slashable offenses\"\r\nOct 13 16:12:50 hostname bash[2507892]: time=\"2023-10-13 16:12:50\" level=warning msg=\"Enabled feature flag\" enable-historical-state-representation=\"Enables the beacon chain to save historical states in a space efficient manner. (Warning): Once enabled, this feature migrates your database in to a new schema and there is no going back. At worst, your entire database might get corrupted.\" prefix=flags\r\nOct 13 16:12:50 hostname bash[2507892]: time=\"2023-10-13 16:12:50\" level=warning msg=\"Enabled feature flag\" prefix=flags save-full-execution-payloads=\"Saves beacon blocks with full execution payloads instead of execution payload headers in the database\"\r\nOct 13 16:12:50 hostname bash[2507892]: time=\"2023-10-13 16:12:50\" level=warning msg=\"Enabled feature flag\" enable-verbose-sig-verification=\"Enables identifying invalid signatures if batch verification fails when processing block\" prefix=flags\r\nOct 13 16:12:50 hostname bash[2507892]: time=\"2023-10-13 16:12:50\" level=warning msg=\"Enabled feature flag\" enable-optional-engine-methods=\"Enables the optional engine methods\" prefix=flags\r\nOct 13 16:12:50 hostname bash[2507892]: time=\"2023-10-13 16:12:50\" level=warning msg=\"Enabled feature flag\" prefix=flags prepare-all-payloads=\"Informs the engine to prepare all local payloads. Useful for relayers and builders\"\r\nOct 13 16:12:50 hostname bash[2507892]: time=\"2023-10-13 16:12:50\" level=warning msg=\"Subscribing to All Attestation Subnets\" prefix=flags\r\nOct 13 16:12:50 hostname bash[2507892]: time=\"2023-10-13 16:12:50\" level=warning msg=\"Setting 128 slots per archive point and 4096 max RPC page size for historical slasher usage. This requires additional storage\" prefix=node\r\nOct 13 16:12:50 hostname bash[2507892]: time=\"2023-10-13 16:12:50\" level=info msg=\"Default fee recipient is set to 0xa8fF27bcF3b0d54325c8DC658071626A6f1E9090, recipient may be overwritten from validator client and persist in db. Default fee recipient will be used as a fall back\" prefix=node\r\nOct 13 16:12:50 hostname bash[2507892]: time=\"2023-10-13 16:12:50\" level=info msg=\"Checking DB\" database-path=\"/home/prysm/prysm-mainnet-beacon/beaconchaindata\" prefix=node\r\nOct 13 16:12:50 hostname bash[2507892]: time=\"2023-10-13 16:12:50\" level=info msg=\"Opening Bolt DB at /home/prysm/prysm-mainnet-beacon/beaconchaindata/beaconchain.db\" prefix=db\r\nOct 13 16:12:52 hostname bash[2507892]: time=\"2023-10-13 16:12:52\" level=warning msg=\"Saving full beacon blocks to the database. For greater disk space savings, we recommend resyncing from an empty database with checkpoint sync to save only blinded beacon blocks by default\" prefix=db\r\nOct 13 16:12:53 hostname bash[2507892]: time=\"2023-10-13 16:12:53\" level=info msg=\"Deposit contract: 0x00000000219ab540356cbb839cbe05303d7705fa\" prefix=node\r\nOct 13 16:12:53 hostname bash[2507892]: time=\"2023-10-13 16:12:53\" level=info msg=\"Checking DB\" database-path=\"/home/prysm/prysm-mainnet-beacon/beaconchaindata\" prefix=node\r\n```\n\n### Has this worked before in a previous version?\n\n_No response_\n\n### ðŸ”¬ Minimal Reproduction\n\nCommand:\r\n```\r\nCGO_CFLAGS=\"-O -D__BLST_PORTABLE__\" CGO_CFLAGS_ALLOW=\"-O -D__BLST_PORTABLE__\"\\\r\n    go run ./cmd/beacon-chain\\\r\n  --slots-per-archive-point=1  \\\r\n  --enable-historical-state-representation \\\r\n  --enable-optional-engine-methods \\\r\n  --subscribe-all-subnets \\\r\n  --slasher-datadir=$(eval echo ~$USER)/beacon-node \\\r\n  --accept-terms-of-use \\\r\n  --save-full-execution-payloads \\\r\n  --prepare-all-payloads \\\r\n  --historical-slasher-node \\\r\n  --slasher \\\r\n  --enable-verbose-sig-verification \\\r\n  --datadir=$(eval echo ~$USER)/beacon-node \\\r\n  --rpc-host=0.0.0.0 \\\r\n  --grpc-gateway-host=0.0.0.0 \\\r\n  --monitoring-host=0.0.0.0 \\\r\n  --jwt-secret=$(eval echo ~$USER)/jwt.hex \\\r\n  --suggested-fee-recipient=0xa8fF27bcF3b0d54325c8DC658071626A6f1E9090 \\\r\n  --execution-endpoint=http://localhost:9101\r\n```\n\n### Error\n\n_No response_\n\n### Platform(s)\n\nLinux (x86)\n\n### What version of Prysm are you running? (Which release)\n\n_No response_\n\n### Anything else relevant (validator index / public key)?\n\n_No response_",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/13051/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/13051/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1779525163",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/13051#issuecomment-1779525163",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/13051",
    "id": 1779525163,
    "node_id": "IC_kwDOBvuov85qEWYr",
    "user": {
      "login": "potuz",
      "id": 16044918,
      "node_id": "MDQ6VXNlcjE2MDQ0OTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/16044918?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/potuz",
      "html_url": "https://github.com/potuz",
      "followers_url": "https://api.github.com/users/potuz/followers",
      "following_url": "https://api.github.com/users/potuz/following{/other_user}",
      "gists_url": "https://api.github.com/users/potuz/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/potuz/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/potuz/subscriptions",
      "organizations_url": "https://api.github.com/users/potuz/orgs",
      "repos_url": "https://api.github.com/users/potuz/repos",
      "events_url": "https://api.github.com/users/potuz/events{/privacy}",
      "received_events_url": "https://api.github.com/users/potuz/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-10-25T15:22:25Z",
    "updated_at": "2023-10-25T15:22:25Z",
    "author_association": "CONTRIBUTOR",
    "body": "Can you confirm that the node fails the same way with an older version of Prysm?\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1779525163/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1779629496",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/13051#issuecomment-1779629496",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/13051",
    "id": 1779629496,
    "node_id": "IC_kwDOBvuov85qEv24",
    "user": {
      "login": "prestonvanloon",
      "id": 7246818,
      "node_id": "MDQ6VXNlcjcyNDY4MTg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7246818?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/prestonvanloon",
      "html_url": "https://github.com/prestonvanloon",
      "followers_url": "https://api.github.com/users/prestonvanloon/followers",
      "following_url": "https://api.github.com/users/prestonvanloon/following{/other_user}",
      "gists_url": "https://api.github.com/users/prestonvanloon/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/prestonvanloon/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/prestonvanloon/subscriptions",
      "organizations_url": "https://api.github.com/users/prestonvanloon/orgs",
      "repos_url": "https://api.github.com/users/prestonvanloon/repos",
      "events_url": "https://api.github.com/users/prestonvanloon/events{/privacy}",
      "received_events_url": "https://api.github.com/users/prestonvanloon/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-10-25T16:19:22Z",
    "updated_at": "2023-10-25T16:19:22Z",
    "author_association": "MEMBER",
    "body": "I have put together PR #13117 which should prevent this panic in the future",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1779629496/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
