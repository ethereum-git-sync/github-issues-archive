{
  "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/3157",
  "repository_url": "https://api.github.com/repos/prysmaticlabs/prysm",
  "labels_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/3157/labels{/name}",
  "comments_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/3157/comments",
  "events_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/3157/events",
  "html_url": "https://github.com/prysmaticlabs/prysm/issues/3157",
  "id": 478170069,
  "node_id": "MDU6SXNzdWU0NzgxNzAwNjk=",
  "number": 3157,
  "title": "Separate out attestation DB store",
  "user": {
    "login": "terencechain",
    "id": 21316537,
    "node_id": "MDQ6VXNlcjIxMzE2NTM3",
    "avatar_url": "https://avatars.githubusercontent.com/u/21316537?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/terencechain",
    "html_url": "https://github.com/terencechain",
    "followers_url": "https://api.github.com/users/terencechain/followers",
    "following_url": "https://api.github.com/users/terencechain/following{/other_user}",
    "gists_url": "https://api.github.com/users/terencechain/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/terencechain/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/terencechain/subscriptions",
    "organizations_url": "https://api.github.com/users/terencechain/orgs",
    "repos_url": "https://api.github.com/users/terencechain/repos",
    "events_url": "https://api.github.com/users/terencechain/events{/privacy}",
    "received_events_url": "https://api.github.com/users/terencechain/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2019-08-07T22:40:23Z",
  "updated_at": "2019-09-23T16:17:58Z",
  "closed_at": "2019-09-23T16:17:58Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "As soon as an attestation gets packaged to a block, the attestation gets [deleted in the DB](https://github.com/prysmaticlabs/prysm/blob/1bac9ad9112b5fe0661a866f1f32654ea9dd69dd/beacon-chain/operations/service.go#L264). This is troublesome given any could still request for such attestation within the window of current epoch and next epoch. I suspect this has contributed to the original fork choice faultiness. The attestations need to be properly tracked for req/res and slashing. \r\n\r\nOne way to address this is to have separate storages for \r\n1. attestation pool (attestations not yet included in the block) \r\n2. normal attestations (attestations that have contributed to fork choice and finality since last finalized epoch)",
  "closed_by": {
    "login": "rauljordan",
    "id": 5572669,
    "node_id": "MDQ6VXNlcjU1NzI2Njk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5572669?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/rauljordan",
    "html_url": "https://github.com/rauljordan",
    "followers_url": "https://api.github.com/users/rauljordan/followers",
    "following_url": "https://api.github.com/users/rauljordan/following{/other_user}",
    "gists_url": "https://api.github.com/users/rauljordan/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/rauljordan/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rauljordan/subscriptions",
    "organizations_url": "https://api.github.com/users/rauljordan/orgs",
    "repos_url": "https://api.github.com/users/rauljordan/repos",
    "events_url": "https://api.github.com/users/rauljordan/events{/privacy}",
    "received_events_url": "https://api.github.com/users/rauljordan/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/3157/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/3157/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/523808519",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/3157#issuecomment-523808519",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/3157",
    "id": 523808519,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUyMzgwODUxOQ==",
    "user": {
      "login": "nisdas",
      "id": 33201827,
      "node_id": "MDQ6VXNlcjMzMjAxODI3",
      "avatar_url": "https://avatars.githubusercontent.com/u/33201827?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nisdas",
      "html_url": "https://github.com/nisdas",
      "followers_url": "https://api.github.com/users/nisdas/followers",
      "following_url": "https://api.github.com/users/nisdas/following{/other_user}",
      "gists_url": "https://api.github.com/users/nisdas/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nisdas/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nisdas/subscriptions",
      "organizations_url": "https://api.github.com/users/nisdas/orgs",
      "repos_url": "https://api.github.com/users/nisdas/repos",
      "events_url": "https://api.github.com/users/nisdas/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nisdas/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-08-22T08:37:43Z",
    "updated_at": "2019-08-22T08:37:43Z",
    "author_association": "MEMBER",
    "body": "Following on from #3258,\r\n\r\nCurrently we aggregate attestations on the fly, combining the bitfields and signatures to aggregate multiple attestations into a single one. However once an attestation with the same data root has been processed by the beacon node, we delete the attestation from our db.\r\n\r\nWe directly remove attestations by their data root from the db, we don't account for differing aggregation bitfields in the attestations that were processed and the ones that were deleted from the db. In networks with a small number of nodes, this wouldn't be an issue as attestations are easily gossiped to all nodes, so most attestations would be 'full' , however once networks become larger then a significant portion of attestations will not be successfully gossiped to all nodes. This will lead to the majority of attestations being 'partial' instead of 'full'. In this scenario the beacon node will have to track attestations by their data root, which validators have attested to them so far, and which validator's attestations have been processed and accounted for.\r\n\r\nAs mentioned above, separating storage out would be between the attestation pool and attestations included in a block above would be a potential solution. In addition to that we would also need a registry of attestations mapping their data root to the validators that have voted for them. This further should be demarcated into 2 categories:\r\n1) Attestations from validators which have not been included yet\r\n2) Attestations from validators which have been included in a block.\r\n\r\nUsing this we can verify each attestation and decide whether or not we should continue aggregating them or throw them away if they have already been included in a block or they are currently in our attestation pool.",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/523808519/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/534173222",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/3157#issuecomment-534173222",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/3157",
    "id": 534173222,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUzNDE3MzIyMg==",
    "user": {
      "login": "rauljordan",
      "id": 5572669,
      "node_id": "MDQ6VXNlcjU1NzI2Njk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5572669?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rauljordan",
      "html_url": "https://github.com/rauljordan",
      "followers_url": "https://api.github.com/users/rauljordan/followers",
      "following_url": "https://api.github.com/users/rauljordan/following{/other_user}",
      "gists_url": "https://api.github.com/users/rauljordan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rauljordan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rauljordan/subscriptions",
      "organizations_url": "https://api.github.com/users/rauljordan/orgs",
      "repos_url": "https://api.github.com/users/rauljordan/repos",
      "events_url": "https://api.github.com/users/rauljordan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rauljordan/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-09-23T16:17:58Z",
    "updated_at": "2019-09-23T16:17:58Z",
    "author_association": "CONTRIBUTOR",
    "body": "Resolved by #3542 ",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/534173222/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
