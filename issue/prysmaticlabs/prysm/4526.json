{
  "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/4526",
  "repository_url": "https://api.github.com/repos/prysmaticlabs/prysm",
  "labels_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/4526/labels{/name}",
  "comments_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/4526/comments",
  "events_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/4526/events",
  "html_url": "https://github.com/prysmaticlabs/prysm/issues/4526",
  "id": 548970025,
  "node_id": "MDU6SXNzdWU1NDg5NzAwMjU=",
  "number": 4526,
  "title": "HashTreeRoot Does Not Lead To The Same Result",
  "user": {
    "login": "nisdas",
    "id": 33201827,
    "node_id": "MDQ6VXNlcjMzMjAxODI3",
    "avatar_url": "https://avatars.githubusercontent.com/u/33201827?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/nisdas",
    "html_url": "https://github.com/nisdas",
    "followers_url": "https://api.github.com/users/nisdas/followers",
    "following_url": "https://api.github.com/users/nisdas/following{/other_user}",
    "gists_url": "https://api.github.com/users/nisdas/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/nisdas/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/nisdas/subscriptions",
    "organizations_url": "https://api.github.com/users/nisdas/orgs",
    "repos_url": "https://api.github.com/users/nisdas/repos",
    "events_url": "https://api.github.com/users/nisdas/events{/privacy}",
    "received_events_url": "https://api.github.com/users/nisdas/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 802129904,
      "node_id": "MDU6TGFiZWw4MDIxMjk5MDQ=",
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/labels/Bug",
      "name": "Bug",
      "color": "ee0701",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 1085358164,
      "node_id": "MDU6TGFiZWwxMDg1MzU4MTY0",
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/labels/Priority:%20Critical",
      "name": "Priority: Critical",
      "color": "f7262f",
      "default": false,
      "description": "Highest, immediate priority item"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "rauljordan",
    "id": 5572669,
    "node_id": "MDQ6VXNlcjU1NzI2Njk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5572669?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/rauljordan",
    "html_url": "https://github.com/rauljordan",
    "followers_url": "https://api.github.com/users/rauljordan/followers",
    "following_url": "https://api.github.com/users/rauljordan/following{/other_user}",
    "gists_url": "https://api.github.com/users/rauljordan/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/rauljordan/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rauljordan/subscriptions",
    "organizations_url": "https://api.github.com/users/rauljordan/orgs",
    "repos_url": "https://api.github.com/users/rauljordan/repos",
    "events_url": "https://api.github.com/users/rauljordan/events{/privacy}",
    "received_events_url": "https://api.github.com/users/rauljordan/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "rauljordan",
      "id": 5572669,
      "node_id": "MDQ6VXNlcjU1NzI2Njk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5572669?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rauljordan",
      "html_url": "https://github.com/rauljordan",
      "followers_url": "https://api.github.com/users/rauljordan/followers",
      "following_url": "https://api.github.com/users/rauljordan/following{/other_user}",
      "gists_url": "https://api.github.com/users/rauljordan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rauljordan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rauljordan/subscriptions",
      "organizations_url": "https://api.github.com/users/rauljordan/orgs",
      "repos_url": "https://api.github.com/users/rauljordan/repos",
      "events_url": "https://api.github.com/users/rauljordan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rauljordan/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2020-01-13T14:33:35Z",
  "updated_at": "2020-01-16T22:15:05Z",
  "closed_at": "2020-01-16T22:15:04Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "We currently have two methods to determine the hash tree root of the state. They are \r\n```\r\nssz.HashTreeRoot\r\n```\r\nand\r\n```\r\nstateutil.HashTreeRootState\r\n```\r\nhowever they lead to different roots for the below provided state.\r\n\r\n[beacon_state.zip](https://github.com/prysmaticlabs/prysm/files/4054033/beacon_state.zip)\r\n\r\nThis was the root cause of our initial genesis failure in our testnet restart\r\n",
  "closed_by": {
    "login": "rauljordan",
    "id": 5572669,
    "node_id": "MDQ6VXNlcjU1NzI2Njk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5572669?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/rauljordan",
    "html_url": "https://github.com/rauljordan",
    "followers_url": "https://api.github.com/users/rauljordan/followers",
    "following_url": "https://api.github.com/users/rauljordan/following{/other_user}",
    "gists_url": "https://api.github.com/users/rauljordan/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/rauljordan/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rauljordan/subscriptions",
    "organizations_url": "https://api.github.com/users/rauljordan/orgs",
    "repos_url": "https://api.github.com/users/rauljordan/repos",
    "events_url": "https://api.github.com/users/rauljordan/events{/privacy}",
    "received_events_url": "https://api.github.com/users/rauljordan/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/4526/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/4526/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/573828747",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/4526#issuecomment-573828747",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/4526",
    "id": 573828747,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU3MzgyODc0Nw==",
    "user": {
      "login": "rauljordan",
      "id": 5572669,
      "node_id": "MDQ6VXNlcjU1NzI2Njk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5572669?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rauljordan",
      "html_url": "https://github.com/rauljordan",
      "followers_url": "https://api.github.com/users/rauljordan/followers",
      "following_url": "https://api.github.com/users/rauljordan/following{/other_user}",
      "gists_url": "https://api.github.com/users/rauljordan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rauljordan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rauljordan/subscriptions",
      "organizations_url": "https://api.github.com/users/rauljordan/orgs",
      "repos_url": "https://api.github.com/users/rauljordan/repos",
      "events_url": "https://api.github.com/users/rauljordan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rauljordan/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-01-13T19:26:04Z",
    "updated_at": "2020-01-13T19:26:04Z",
    "author_association": "CONTRIBUTOR",
    "body": "Hey everyone, here is an analysis and discovery of the root cause explaining why it happened in the first place:\r\n\r\n## TL;DR\r\n\r\n`Go-SSZ.HTR` and Prysm's specific `stateutil.HTR` differ greatly in how they determine the sizes of certain fields for hashing. Go-SSZ looks directly at the protobuf field tags to determine sizes of fields while `stateutil.HTR` uses our `params.BeaconConfig()` to compute certain field sizes. Our genesis code in Prysm used `go-ssz.HTR(state)` while the entire rest of the repo uses `stateutil.HTR(state)` at runtime. Due to differences in config at compile time (such as not using the `--define ssz` flag), the `go-ssz.HTR` function resulted in a different root of the genesis state than what was expected by beacon proposers.\r\n\r\n## Explanation \r\n\r\nOfficially, the field `state.Eth1DataVotes` has `ssz-max:1024` as its size. When using `go-ssz.HTR`, the ssz code will directly read the protobuf tags to determine how it should hash the field. \r\n\r\n In contrast, our `stateutil.HTR` uses a more specific approach of using `params.BeaconConfig().SlotsPerEth1VotingPeriod` as the max-size of `state.Eth1DataVotes`. This means if our config says 16 while the protobuf template has 1024, `go-ssz.HTR(state) != stateutil.HTR(state)`. If instead, we run the code above with `--define ssz=minimal`, both will match and pass any tests or required conditions. \r\n\r\n## Why This Broke the Testnet\r\n\r\nFor the testnet, we do not use minimal or mainnet config, but rather a customized `demo` config. Go-SSZ likely was not able to pick up on this change, but `stateutil.HTR` was, leading to discrepancies at runtime when attempting to use both in the same environment.\r\n\r\n### Root Cause Discovery\r\n\r\nThis problem was reproducible in our e2e tests, after further investigation logging the results of `ssz.HashTreeRoot(genesis)` side by side with `stateutil.HashTreeRootState(genesis)` shows a few roots are different between their fields. Namely, `Eth1DataVotes`, `CurrentEpochAttestations`, and `PreviousEpochAttestations`. These fields are **fully** dependent on certain configuration parameters such as `SlotsPerEth1VotingPeriod`, so I had the suspicion it had to do with the config when building/running the beacon node.\r\n\r\nIf instead, we run `bazel test //endtoend:go_default_test --define ssz=minimal`, tests do pass, confirming the suspicion above. If this is not specified, we obtain the same error we saw in post-mortem number 7:\r\n\r\n```\r\nCould not compute state root: could not calculate state root at slot 0: could not process block: could not process block header: parent root 0x0e6c95db700881611523e282ec3fcaeeace681786aa47928c5903650165c6165 does not match the latest block header signing root in state 0x8b25301bdeba020d4226e949eae0ecefb8863e060b7844566d51e0a42ed6490e\"\r\n```\r\nnamely, the signing root of the block header does not match because the blocks had different state roots than what proposers expected. Proposers were running `stateutil.HTR(genesis)` while the original block's state root was determined with `go-ssz.HTR(genesis)`.\r\n\r\n## Immediate, Simple Fix\r\n\r\nDo not use `go-ssz.HTR(state)` anywhere in Prysm. This will fix this issue and eliminate it completely from our repo.\r\n\r\n## Possible Long-Term Fix\r\n\r\nWe could revise our stateutil SSZ to parse template parameters of the state data structure instead of relying on parameter configurations. This would ensure consistent behavior when we use the `--define=minimal` or `mainnet` flags when running the system. If we want to be more flexible, however, relying on `params.BeaconConfig()` can be better. We would have to choose one over the other.",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/573828747/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/575372107",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/4526#issuecomment-575372107",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/4526",
    "id": 575372107,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU3NTM3MjEwNw==",
    "user": {
      "login": "rauljordan",
      "id": 5572669,
      "node_id": "MDQ6VXNlcjU1NzI2Njk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5572669?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rauljordan",
      "html_url": "https://github.com/rauljordan",
      "followers_url": "https://api.github.com/users/rauljordan/followers",
      "following_url": "https://api.github.com/users/rauljordan/following{/other_user}",
      "gists_url": "https://api.github.com/users/rauljordan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rauljordan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rauljordan/subscriptions",
      "organizations_url": "https://api.github.com/users/rauljordan/orgs",
      "repos_url": "https://api.github.com/users/rauljordan/repos",
      "events_url": "https://api.github.com/users/rauljordan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rauljordan/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-01-16T22:15:04Z",
    "updated_at": "2020-01-16T22:15:04Z",
    "author_association": "CONTRIBUTOR",
    "body": "We can close this - we are no longer mixing go-ssz and stateutil HTR in Prysm",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/575372107/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
