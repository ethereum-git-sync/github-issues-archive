{
  "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/2268",
  "repository_url": "https://api.github.com/repos/prysmaticlabs/prysm",
  "labels_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/2268/labels{/name}",
  "comments_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/2268/comments",
  "events_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/2268/events",
  "html_url": "https://github.com/prysmaticlabs/prysm/issues/2268",
  "id": 433577158,
  "node_id": "MDU6SXNzdWU0MzM1NzcxNTg=",
  "number": 2268,
  "title": "Do not allow building on bad block",
  "user": {
    "login": "terencechain",
    "id": 21316537,
    "node_id": "MDQ6VXNlcjIxMzE2NTM3",
    "avatar_url": "https://avatars.githubusercontent.com/u/21316537?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/terencechain",
    "html_url": "https://github.com/terencechain",
    "followers_url": "https://api.github.com/users/terencechain/followers",
    "following_url": "https://api.github.com/users/terencechain/following{/other_user}",
    "gists_url": "https://api.github.com/users/terencechain/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/terencechain/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/terencechain/subscriptions",
    "organizations_url": "https://api.github.com/users/terencechain/orgs",
    "repos_url": "https://api.github.com/users/terencechain/repos",
    "events_url": "https://api.github.com/users/terencechain/events{/privacy}",
    "received_events_url": "https://api.github.com/users/terencechain/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 802129904,
      "node_id": "MDU6TGFiZWw4MDIxMjk5MDQ=",
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/labels/Bug",
      "name": "Bug",
      "color": "ee0701",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 1085358164,
      "node_id": "MDU6TGFiZWwxMDg1MzU4MTY0",
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/labels/Priority:%20Critical",
      "name": "Priority: Critical",
      "color": "f7262f",
      "default": false,
      "description": "Highest, immediate priority item"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2019-04-16T04:20:36Z",
  "updated_at": "2019-04-19T00:51:27Z",
  "closed_at": "2019-04-19T00:51:27Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "We currently process block if block's parent exists in DB, this does not consider the scenario when reorg happened but the new incoming block's parent is not in the canonical chain but it is in DB. Processing such invalid block (invalid meaning parent block not in the current chain) triggers errors such as:\r\n\r\n```\r\nERRO[0048] Could not apply state transition: could not execute state transition with block could not execute state transition could not process block: could not process block attestations: could not verify attestation at index 0 in block: expected attestation.JustifiedEpoch == state.JustifiedEpoch, received 229 == 224  prefix=state-replay\r\n```\r\n\r\nExample diagram: \r\n(`block j` can only point to `f and g`, not `h and e`. We currently allow pointing to `h` and `e` happen):\r\n<img width=\"524\" alt=\"Screen Shot 2019-04-15 at 9 19 30 PM\" src=\"https://user-images.githubusercontent.com/21316537/56181851-2d50a780-5fc4-11e9-8b74-7cb846be9d04.png\">\r\n\r\n\r\n**Edit:**\r\nDescriptions above is not as critical as I thought, when it happens we could just log an error and continue. Bigger issues are outlined in https://github.com/prysmaticlabs/prysm/issues/2268#issuecomment-483511329",
  "closed_by": {
    "login": "terencechain",
    "id": 21316537,
    "node_id": "MDQ6VXNlcjIxMzE2NTM3",
    "avatar_url": "https://avatars.githubusercontent.com/u/21316537?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/terencechain",
    "html_url": "https://github.com/terencechain",
    "followers_url": "https://api.github.com/users/terencechain/followers",
    "following_url": "https://api.github.com/users/terencechain/following{/other_user}",
    "gists_url": "https://api.github.com/users/terencechain/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/terencechain/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/terencechain/subscriptions",
    "organizations_url": "https://api.github.com/users/terencechain/orgs",
    "repos_url": "https://api.github.com/users/terencechain/repos",
    "events_url": "https://api.github.com/users/terencechain/events{/privacy}",
    "received_events_url": "https://api.github.com/users/terencechain/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/2268/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/2268/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/483509099",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/2268#issuecomment-483509099",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/2268",
    "id": 483509099,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ4MzUwOTA5OQ==",
    "user": {
      "login": "prestonvanloon",
      "id": 7246818,
      "node_id": "MDQ6VXNlcjcyNDY4MTg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7246818?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/prestonvanloon",
      "html_url": "https://github.com/prestonvanloon",
      "followers_url": "https://api.github.com/users/prestonvanloon/followers",
      "following_url": "https://api.github.com/users/prestonvanloon/following{/other_user}",
      "gists_url": "https://api.github.com/users/prestonvanloon/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/prestonvanloon/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/prestonvanloon/subscriptions",
      "organizations_url": "https://api.github.com/users/prestonvanloon/orgs",
      "repos_url": "https://api.github.com/users/prestonvanloon/repos",
      "events_url": "https://api.github.com/users/prestonvanloon/events{/privacy}",
      "received_events_url": "https://api.github.com/users/prestonvanloon/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-04-16T04:44:46Z",
    "updated_at": "2019-04-16T04:44:46Z",
    "author_association": "MEMBER",
    "body": "Why is it a problem if `J` points to `H`? Imagine if some node is not aware of the lower chain in the diagram. It is valid to produce `J` which has a parent `H`.\r\n\r\nThe error in the issue seems to be that we are including attestations from the lower chain in the upper chain. ",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/483509099/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/483511329",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/2268#issuecomment-483511329",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/2268",
    "id": 483511329,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ4MzUxMTMyOQ==",
    "user": {
      "login": "prestonvanloon",
      "id": 7246818,
      "node_id": "MDQ6VXNlcjcyNDY4MTg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7246818?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/prestonvanloon",
      "html_url": "https://github.com/prestonvanloon",
      "followers_url": "https://api.github.com/users/prestonvanloon/followers",
      "following_url": "https://api.github.com/users/prestonvanloon/following{/other_user}",
      "gists_url": "https://api.github.com/users/prestonvanloon/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/prestonvanloon/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/prestonvanloon/subscriptions",
      "organizations_url": "https://api.github.com/users/prestonvanloon/orgs",
      "repos_url": "https://api.github.com/users/prestonvanloon/repos",
      "events_url": "https://api.github.com/users/prestonvanloon/events{/privacy}",
      "received_events_url": "https://api.github.com/users/prestonvanloon/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-04-16T04:58:26Z",
    "updated_at": "2019-04-16T04:58:26Z",
    "author_association": "MEMBER",
    "body": "Based on offline (discord) discussion, we have concluded that we have the following issues:\r\n\r\n1. Bad blocks are not deleted from DB and therefore we accept peers building upon them\r\n2. Attestations RPC may serve invalid attestations from another chain\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/483511329/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/483511707",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/2268#issuecomment-483511707",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/2268",
    "id": 483511707,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ4MzUxMTcwNw==",
    "user": {
      "login": "rauljordan",
      "id": 5572669,
      "node_id": "MDQ6VXNlcjU1NzI2Njk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5572669?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rauljordan",
      "html_url": "https://github.com/rauljordan",
      "followers_url": "https://api.github.com/users/rauljordan/followers",
      "following_url": "https://api.github.com/users/rauljordan/following{/other_user}",
      "gists_url": "https://api.github.com/users/rauljordan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rauljordan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rauljordan/subscriptions",
      "organizations_url": "https://api.github.com/users/rauljordan/orgs",
      "repos_url": "https://api.github.com/users/rauljordan/repos",
      "events_url": "https://api.github.com/users/rauljordan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rauljordan/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-04-16T05:00:41Z",
    "updated_at": "2019-04-16T05:00:41Z",
    "author_association": "CONTRIBUTOR",
    "body": "If a block failed processing in our node due to our node having different attestations, once we receive a new block from another node building on that failed block, the base case of our recursive block ancestor fetching in regular sync **will be the failed block**. Even though a block fails processing, we still save it to the DB. Instead, we should delete and clear it out.",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/483511707/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/483513606",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/2268#issuecomment-483513606",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/2268",
    "id": 483513606,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ4MzUxMzYwNg==",
    "user": {
      "login": "nisdas",
      "id": 33201827,
      "node_id": "MDQ6VXNlcjMzMjAxODI3",
      "avatar_url": "https://avatars.githubusercontent.com/u/33201827?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nisdas",
      "html_url": "https://github.com/nisdas",
      "followers_url": "https://api.github.com/users/nisdas/followers",
      "following_url": "https://api.github.com/users/nisdas/following{/other_user}",
      "gists_url": "https://api.github.com/users/nisdas/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nisdas/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nisdas/subscriptions",
      "organizations_url": "https://api.github.com/users/nisdas/orgs",
      "repos_url": "https://api.github.com/users/nisdas/repos",
      "events_url": "https://api.github.com/users/nisdas/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nisdas/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-04-16T05:12:00Z",
    "updated_at": "2019-04-16T05:12:00Z",
    "author_association": "MEMBER",
    "body": "One way to make sure that we do not allow building on a bad block, is to check whether the parent block is in the canonical chain. How we do it is very simplistic : \r\n- Receive Block\r\n- Check if Parent is saved in db \r\n- The Process it \r\n\r\nwhat we should be doing instead is \r\n- keep track of all block roots in the canonical chain\r\n- receive block\r\n- If a block's parent isnt in the canonical chain, we reject processing the block as it is on a forked chain. ",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/483513606/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/483604752",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/2268#issuecomment-483604752",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/2268",
    "id": 483604752,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ4MzYwNDc1Mg==",
    "user": {
      "login": "nisdas",
      "id": 33201827,
      "node_id": "MDQ6VXNlcjMzMjAxODI3",
      "avatar_url": "https://avatars.githubusercontent.com/u/33201827?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nisdas",
      "html_url": "https://github.com/nisdas",
      "followers_url": "https://api.github.com/users/nisdas/followers",
      "following_url": "https://api.github.com/users/nisdas/following{/other_user}",
      "gists_url": "https://api.github.com/users/nisdas/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nisdas/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nisdas/subscriptions",
      "organizations_url": "https://api.github.com/users/nisdas/orgs",
      "repos_url": "https://api.github.com/users/nisdas/repos",
      "events_url": "https://api.github.com/users/nisdas/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nisdas/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-04-16T10:31:05Z",
    "updated_at": "2019-04-16T10:31:05Z",
    "author_association": "MEMBER",
    "body": "Design for this over here: https://docs.google.com/document/d/1W6rgetZqdYAbxSCZys-KapqUlZgkDv0rxSkXhGhasFs/edit?usp=sharing",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/483604752/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
