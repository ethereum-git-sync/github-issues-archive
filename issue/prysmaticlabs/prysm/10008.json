{
  "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/10008",
  "repository_url": "https://api.github.com/repos/prysmaticlabs/prysm",
  "labels_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/10008/labels{/name}",
  "comments_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/10008/comments",
  "events_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/10008/events",
  "html_url": "https://github.com/prysmaticlabs/prysm/issues/10008",
  "id": 1077138317,
  "node_id": "I_kwDOBvuov85AM9ON",
  "number": 10008,
  "title": "Beacon chain OOM after db/backup",
  "user": {
    "login": "lukaszsamson",
    "id": 1078186,
    "node_id": "MDQ6VXNlcjEwNzgxODY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1078186?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/lukaszsamson",
    "html_url": "https://github.com/lukaszsamson",
    "followers_url": "https://api.github.com/users/lukaszsamson/followers",
    "following_url": "https://api.github.com/users/lukaszsamson/following{/other_user}",
    "gists_url": "https://api.github.com/users/lukaszsamson/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/lukaszsamson/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/lukaszsamson/subscriptions",
    "organizations_url": "https://api.github.com/users/lukaszsamson/orgs",
    "repos_url": "https://api.github.com/users/lukaszsamson/repos",
    "events_url": "https://api.github.com/users/lukaszsamson/events{/privacy}",
    "received_events_url": "https://api.github.com/users/lukaszsamson/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2021-12-10T18:54:48Z",
  "updated_at": "2021-12-23T17:45:51Z",
  "closed_at": "2021-12-23T17:45:50Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "<!--üíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíé\r\n\r\nHellooo! üòÑ \r\n\r\nTo help us tend to your issue faster, please search our currently open issues before submitting a new one.\r\nExisting issues often contain information about workarounds, resolution, or progress updates.\r\n\r\nüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíé-->\r\n\r\n# üêû Bug Report\r\n\r\n### Description\r\n\r\n<!-- ‚úçÔ∏è--> After requesting db backup on beacon chain the program slowed down, used up all of the memory and later crashed\r\n\r\n### Has this worked before in a previous version?\r\n\r\n<!-- Did this behavior use to work in the previous version? -->\r\n<!-- ‚úçÔ∏è--> Yes, worked 2 months ago\r\n\r\n## üî• Error\r\nAfter hitting db/backup HTTP endpoint (on mainnet) the system slowed down due to high memory usage\r\nlogs were full of errors (only some show here)\r\n<pre><code>\r\nDec 10 12:04:21 eth2-prod-1b prysm.sh[5780]: time=\"2021-12-10 12:04:21\" level=error msg=\"Could not handle p2p pubsub\" error=\"could not process block: could not execute state transition: could not process block: could not retrieve attestation signature set: could not interface with committee cache: context deadline exceeded\" prefix=sync topic=\"/eth2/afcaaba0/beacon_block/ssz_snappy\"\r\nDec 10 12:32:45 eth2-prod-1b prysm.sh[5780]: time=\"2021-12-10 12:32:45\" level=warning msg=\"Batch is not processed\" error=\"no good blocks in batch\" prefix=initial-sync\r\nDec 10 12:40:40 eth2-prod-1b prysm.sh[5780]: time=\"2021-12-10 12:40:40\" level=warning msg=\"Range is not processed\" error=\"Range had no valid blocks to process\" prefix=initial-sync\r\nDec 10 13:34:37 eth2-prod-1b prysm.sh[5780]: time=\"2021-12-10 13:34:37\" level=warning msg=\"Could not update head\" error=\"signed beacon block can't be nil\" prefix=blockchain\r\nDec 10 13:34:50 eth2-prod-1b prysm.sh[5780]: time=\"2021-12-10 13:34:50\" level=warning msg=\"Could not update head\" error=\"head at slot 2693184 with weight 425858 is not eligible, finalizedEpoch 84160 != 84160, justifiedEpoch 84161 != 84162\" prefix=blockchain\r\nDec 10 14:25:07 eth2-prod-1b prysm.sh[5780]: time=\"2021-12-10 14:25:04\" level=warning msg=\"Coul\r\nd not process attestation for fork choice\" aggregationCount=1 beaconBlockRoot=0xc746b3f06bdf committeeIndex=4 error=\"could not process attestation: target epoch 84169 does not match current epoch 84172 or prev epoch 84171\" prefix=blockchain slot=2693422 targetRoot=0xc746b3f06bdf\r\nDec 10 14:09:56 eth2-prod-1b prysm.sh[5780]: time=\"2021-12-10 14:09:56\" level=warning msg=\"Attestation is too old to broadcast, discarding it. Current Slot: 2693447 , Attestation Slot: 2693202\" prefix=p2p\r\n</code></pre>\r\nand eventually beacon chain was killed by linux OOM killer\r\n<pre><code>\r\nDec 10 14:28:56 eth2-prod-1b kernel: Out of memory: Kill process 5780 (beacon-chain-v2) score 934 or sacrifice child\r\nDec 10 14:28:56 eth2-prod-1b kernel: Killed process 5780 (beacon-chain-v2) total-vm:104747652kB, anon-rss:7140072kB, file-rss:0kB, shmem-rss:0kB\r\nDec 10 14:28:56 eth2-prod-1b kernel: oom_reaper: reaped process 5780 (beacon-chain-v2), now anon-rss:0kB, file-rss:0kB, shmem-rss:0kB\r\n</code></pre>\r\nThe machine has 8GB RAM and 2GB swap and usually beacon chain uses ~3GB. Here it allocated ~100GB\r\n\r\n\r\n## üåç  Your Environment\r\n\r\n**Operating System:**\r\n\r\n<pre>\r\n  <code>\r\nAWS linux 2\r\n  </code>\r\n</pre>\r\n\r\n**What version of Prysm are you running? (Which release)**\r\n\r\n<pre>\r\n  <code>\r\n2.0.4\r\n  </code>\r\n</pre>\r\n\r\n**Anything else relevant (validator index / public key)?**\r\n\r\n",
  "closed_by": {
    "login": "terencechain",
    "id": 21316537,
    "node_id": "MDQ6VXNlcjIxMzE2NTM3",
    "avatar_url": "https://avatars.githubusercontent.com/u/21316537?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/terencechain",
    "html_url": "https://github.com/terencechain",
    "followers_url": "https://api.github.com/users/terencechain/followers",
    "following_url": "https://api.github.com/users/terencechain/following{/other_user}",
    "gists_url": "https://api.github.com/users/terencechain/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/terencechain/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/terencechain/subscriptions",
    "organizations_url": "https://api.github.com/users/terencechain/orgs",
    "repos_url": "https://api.github.com/users/terencechain/repos",
    "events_url": "https://api.github.com/users/terencechain/events{/privacy}",
    "received_events_url": "https://api.github.com/users/terencechain/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/10008/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/10008/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/995552310",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/10008#issuecomment-995552310",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/10008",
    "id": 995552310,
    "node_id": "IC_kwDOBvuov847Vuw2",
    "user": {
      "login": "nisdas",
      "id": 33201827,
      "node_id": "MDQ6VXNlcjMzMjAxODI3",
      "avatar_url": "https://avatars.githubusercontent.com/u/33201827?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nisdas",
      "html_url": "https://github.com/nisdas",
      "followers_url": "https://api.github.com/users/nisdas/followers",
      "following_url": "https://api.github.com/users/nisdas/following{/other_user}",
      "gists_url": "https://api.github.com/users/nisdas/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nisdas/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nisdas/subscriptions",
      "organizations_url": "https://api.github.com/users/nisdas/orgs",
      "repos_url": "https://api.github.com/users/nisdas/repos",
      "events_url": "https://api.github.com/users/nisdas/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nisdas/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-12-16T08:33:57Z",
    "updated_at": "2021-12-16T08:33:57Z",
    "author_association": "MEMBER",
    "body": "Hey @lukaszsamson , \r\n\r\nWith the beacon database being about 40gb now, doing in-memory backups isn't feasible anymore. To back up the database you need to copy all the data in-memory which is the reason for the large amount of memory allocated. Also due to the time it takes to backup the db, backups are non-atomic so there is the possibility of getting the db in an inconsistent state. I would recommend manually backing up the db (shutdown the node and the manually copy the file via the filesystem). ",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/995552310/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/995615409",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/10008#issuecomment-995615409",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/10008",
    "id": 995615409,
    "node_id": "IC_kwDOBvuov847V-Kx",
    "user": {
      "login": "lukaszsamson",
      "id": 1078186,
      "node_id": "MDQ6VXNlcjEwNzgxODY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1078186?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/lukaszsamson",
      "html_url": "https://github.com/lukaszsamson",
      "followers_url": "https://api.github.com/users/lukaszsamson/followers",
      "following_url": "https://api.github.com/users/lukaszsamson/following{/other_user}",
      "gists_url": "https://api.github.com/users/lukaszsamson/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/lukaszsamson/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/lukaszsamson/subscriptions",
      "organizations_url": "https://api.github.com/users/lukaszsamson/orgs",
      "repos_url": "https://api.github.com/users/lukaszsamson/repos",
      "events_url": "https://api.github.com/users/lukaszsamson/events{/privacy}",
      "received_events_url": "https://api.github.com/users/lukaszsamson/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-12-16T09:58:00Z",
    "updated_at": "2021-12-16T09:58:00Z",
    "author_association": "NONE",
    "body": "The docs still recomend doing it via db/backup API call though. If that‚Äôs no longer supported then deprecate it and update docs.",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/995615409/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/996585797",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/10008#issuecomment-996585797",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/10008",
    "id": 996585797,
    "node_id": "IC_kwDOBvuov847ZrFF",
    "user": {
      "login": "nisdas",
      "id": 33201827,
      "node_id": "MDQ6VXNlcjMzMjAxODI3",
      "avatar_url": "https://avatars.githubusercontent.com/u/33201827?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nisdas",
      "html_url": "https://github.com/nisdas",
      "followers_url": "https://api.github.com/users/nisdas/followers",
      "following_url": "https://api.github.com/users/nisdas/following{/other_user}",
      "gists_url": "https://api.github.com/users/nisdas/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nisdas/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nisdas/subscriptions",
      "organizations_url": "https://api.github.com/users/nisdas/orgs",
      "repos_url": "https://api.github.com/users/nisdas/repos",
      "events_url": "https://api.github.com/users/nisdas/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nisdas/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-12-17T09:57:40Z",
    "updated_at": "2021-12-17T09:57:40Z",
    "author_association": "MEMBER",
    "body": "@lukaszsamson \r\n\r\nI added a warning on the risks of performing a backup for the beacon node at its current size:\r\nhttps://github.com/prysmaticlabs/documentation/pull/392",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/996585797/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1000446901",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/10008#issuecomment-1000446901",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/10008",
    "id": 1000446901,
    "node_id": "IC_kwDOBvuov847oZu1",
    "user": {
      "login": "terencechain",
      "id": 21316537,
      "node_id": "MDQ6VXNlcjIxMzE2NTM3",
      "avatar_url": "https://avatars.githubusercontent.com/u/21316537?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/terencechain",
      "html_url": "https://github.com/terencechain",
      "followers_url": "https://api.github.com/users/terencechain/followers",
      "following_url": "https://api.github.com/users/terencechain/following{/other_user}",
      "gists_url": "https://api.github.com/users/terencechain/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/terencechain/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/terencechain/subscriptions",
      "organizations_url": "https://api.github.com/users/terencechain/orgs",
      "repos_url": "https://api.github.com/users/terencechain/repos",
      "events_url": "https://api.github.com/users/terencechain/events{/privacy}",
      "received_events_url": "https://api.github.com/users/terencechain/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-12-23T17:45:50Z",
    "updated_at": "2021-12-23T17:45:50Z",
    "author_association": "MEMBER",
    "body": "Closing after updating the doc",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1000446901/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
