{
  "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/10641",
  "repository_url": "https://api.github.com/repos/prysmaticlabs/prysm",
  "labels_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/10641/labels{/name}",
  "comments_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/10641/comments",
  "events_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/10641/events",
  "html_url": "https://github.com/prysmaticlabs/prysm/issues/10641",
  "id": 1226911019,
  "node_id": "I_kwDOBvuov85JIS0r",
  "number": 10641,
  "title": "Data race when running JWT tests",
  "user": {
    "login": "0xpanoramix",
    "id": 61348595,
    "node_id": "MDQ6VXNlcjYxMzQ4NTk1",
    "avatar_url": "https://avatars.githubusercontent.com/u/61348595?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/0xpanoramix",
    "html_url": "https://github.com/0xpanoramix",
    "followers_url": "https://api.github.com/users/0xpanoramix/followers",
    "following_url": "https://api.github.com/users/0xpanoramix/following{/other_user}",
    "gists_url": "https://api.github.com/users/0xpanoramix/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/0xpanoramix/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/0xpanoramix/subscriptions",
    "organizations_url": "https://api.github.com/users/0xpanoramix/orgs",
    "repos_url": "https://api.github.com/users/0xpanoramix/repos",
    "events_url": "https://api.github.com/users/0xpanoramix/events{/privacy}",
    "received_events_url": "https://api.github.com/users/0xpanoramix/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 802129904,
      "node_id": "MDU6TGFiZWw4MDIxMjk5MDQ=",
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/labels/Bug",
      "name": "Bug",
      "color": "ee0701",
      "default": false,
      "description": "Something isn't working"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2022-05-05T16:21:13Z",
  "updated_at": "2022-07-01T10:52:23Z",
  "closed_at": "2022-07-01T10:52:23Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "<!--üíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíé\r\n\r\nHellooo! üòÑ \r\n\r\nTo help us tend to your issue faster, please search our currently open issues before submitting a new one.\r\nExisting issues often contain information about workarounds, resolution, or progress updates.\r\n\r\nüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíéüíé-->\r\n\r\n# üêû Bug Report\r\n\r\n### Description\r\n\r\nI was looking at the code so that I can familiarize with the codebase when I decided to run the tests with the `-race` option.\r\nI waited until the end of the testing process and one data race was reported, in the `TestServer_RefreshJWTSecretOnFileChange` test.\r\n\r\n### Has this worked before in a previous version?\r\n\r\nIt also reported the data race in the v2.1.1 and v2.1.0 versions.\r\n\r\n## üî¨ Minimal Reproduction\r\n\r\nI ran the tests using :\r\n```shell\r\ngo test ./... -v -race\r\n```\r\n\r\nAnd then in the specific package using :\r\n```shell\r\ncd validator/rpc/ && go test -run TestServer_RefreshJWTSecretOnFileChange -race\r\n```\r\n\r\n## üî• Error\r\n\r\nThe data race is caused by the concurrent read and write on server's `jwtSecret` when running the tests.\r\n\r\nLogs :\r\n```shell\r\nINFO[0000] Generating auth token and saving it to /var/folders/_z/0194db6s6bs_5lt2rjhnmz3w0000gn/T/TestServer_RefreshJWTSecretOnFileChange2099941836/001/wallet/auth-token  prefix=rpc\r\nINFO[0000] Once your validator process is runinng, navigate to the link below to authenticate with the Prysm web interface  prefix=rpc\r\nINFO[0000] http://localhost:7500/initialize?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.e30.cQfafDqjkpCegdnLayYJzqSTnnmHDHCFyHjdaZ69vxY  prefix=rpc\r\nINFO[0000] Once your validator process is runinng, navigate to the link below to authenticate with the Prysm web interface  prefix=rpc\r\nINFO[0000] http://:0/initialize?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.e30.4Kw4tna2wZ6-mC5ItlrO-17MwP0b0BIcvhIkTR82R0w  prefix=rpc\r\nINFO[0000] Once your validator process is runinng, navigate to the link below to authenticate with the Prysm web interface  prefix=rpc\r\nINFO[0000] http://:0/initialize?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.e30.4Kw4tna2wZ6-mC5ItlrO-17MwP0b0BIcvhIkTR82R0w  prefix=rpc\r\n==================\r\nWARNING: DATA RACE\r\nRead at 0x00c00057c6d8 by goroutine 85:\r\n  github.com/prysmaticlabs/prysm/validator/rpc.TestServer_RefreshJWTSecretOnFileChange()\r\n      /Users/ptitluca/GolandProjects/prysm/validator/rpc/auth_token_test.go:79 +0x37c\r\n  testing.tRunner()\r\n      /opt/homebrew/Cellar/go/1.18.1/libexec/src/testing/testing.go:1439 +0x18c\r\n  testing.(*T).Run.func1()\r\n      /opt/homebrew/Cellar/go/1.18.1/libexec/src/testing/testing.go:1486 +0x44\r\n\r\nPrevious write at 0x00c00057c6d8 by goroutine 86:\r\n  github.com/prysmaticlabs/prysm/validator/rpc.(*Server).initializeAuthToken()\r\n      /Users/ptitluca/GolandProjects/prysm/validator/rpc/auth_token.go:87 +0x110\r\n  github.com/prysmaticlabs/prysm/validator/rpc.(*Server).refreshAuthTokenFromFileChanges()\r\n      /Users/ptitluca/GolandProjects/prysm/validator/rpc/auth_token.go:125 +0x454\r\n  github.com/prysmaticlabs/prysm/validator/rpc.TestServer_RefreshJWTSecretOnFileChange.func1()\r\n      /Users/ptitluca/GolandProjects/prysm/validator/rpc/auth_token_test.go:69 +0x68\r\n\r\nGoroutine 85 (running) created at:\r\n  testing.(*T).Run()\r\n      /opt/homebrew/Cellar/go/1.18.1/libexec/src/testing/testing.go:1486 +0x560\r\n  testing.runTests.func1()\r\n      /opt/homebrew/Cellar/go/1.18.1/libexec/src/testing/testing.go:1839 +0x94\r\n  testing.tRunner()\r\n      /opt/homebrew/Cellar/go/1.18.1/libexec/src/testing/testing.go:1439 +0x18c\r\n  testing.runTests()\r\n      /opt/homebrew/Cellar/go/1.18.1/libexec/src/testing/testing.go:1837 +0x6c8\r\n  testing.(*M).Run()\r\n      /opt/homebrew/Cellar/go/1.18.1/libexec/src/testing/testing.go:1719 +0x878\r\n  main.main()\r\n      _testmain.go:121 +0x2fc\r\n\r\nGoroutine 86 (running) created at:\r\n  github.com/prysmaticlabs/prysm/validator/rpc.TestServer_RefreshJWTSecretOnFileChange()\r\n      /Users/ptitluca/GolandProjects/prysm/validator/rpc/auth_token_test.go:69 +0x2f8\r\n  testing.tRunner()\r\n      /opt/homebrew/Cellar/go/1.18.1/libexec/src/testing/testing.go:1439 +0x18c\r\n  testing.(*T).Run.func1()\r\n      /opt/homebrew/Cellar/go/1.18.1/libexec/src/testing/testing.go:1486 +0x44\r\n==================\r\n==================\r\nWARNING: DATA RACE\r\nRead at 0x00c00026d300 by goroutine 85:\r\n  runtime.slicebytetostringtmp()\r\n      /opt/homebrew/Cellar/go/1.18.1/libexec/src/runtime/string.go:154 +0x0\r\n  bytes.Equal()\r\n      /opt/homebrew/Cellar/go/1.18.1/libexec/src/bytes/bytes.go:20 +0x424\r\n  github.com/prysmaticlabs/prysm/validator/rpc.TestServer_RefreshJWTSecretOnFileChange()\r\n      /Users/ptitluca/GolandProjects/prysm/validator/rpc/auth_token_test.go:81 +0x448\r\n  testing.tRunner()\r\n      /opt/homebrew/Cellar/go/1.18.1/libexec/src/testing/testing.go:1439 +0x18c\r\n  testing.(*T).Run.func1()\r\n      /opt/homebrew/Cellar/go/1.18.1/libexec/src/testing/testing.go:1486 +0x44\r\n\r\nPrevious write at 0x00c00026d307 by goroutine 86:\r\n  encoding/hex.Decode()\r\n      /opt/homebrew/Cellar/go/1.18.1/libexec/src/encoding/hex/hex.go:69 +0x58\r\n  encoding/hex.DecodeString()\r\n      /opt/homebrew/Cellar/go/1.18.1/libexec/src/encoding/hex/hex.go:114 +0x150\r\n  github.com/prysmaticlabs/prysm/validator/rpc.readAuthTokenFile()\r\n      /Users/ptitluca/GolandProjects/prysm/validator/rpc/auth_token.go:179 +0x128\r\n  github.com/prysmaticlabs/prysm/validator/rpc.(*Server).initializeAuthToken()\r\n      /Users/ptitluca/GolandProjects/prysm/validator/rpc/auth_token.go:83 +0xe4\r\n  github.com/prysmaticlabs/prysm/validator/rpc.(*Server).refreshAuthTokenFromFileChanges()\r\n      /Users/ptitluca/GolandProjects/prysm/validator/rpc/auth_token.go:125 +0x454\r\n  github.com/prysmaticlabs/prysm/validator/rpc.TestServer_RefreshJWTSecretOnFileChange.func1()\r\n      /Users/ptitluca/GolandProjects/prysm/validator/rpc/auth_token_test.go:69 +0x68\r\n\r\nGoroutine 85 (running) created at:\r\n  testing.(*T).Run()\r\n      /opt/homebrew/Cellar/go/1.18.1/libexec/src/testing/testing.go:1486 +0x560\r\n  testing.runTests.func1()\r\n      /opt/homebrew/Cellar/go/1.18.1/libexec/src/testing/testing.go:1839 +0x94\r\n  testing.tRunner()\r\n      /opt/homebrew/Cellar/go/1.18.1/libexec/src/testing/testing.go:1439 +0x18c\r\n  testing.runTests()\r\n      /opt/homebrew/Cellar/go/1.18.1/libexec/src/testing/testing.go:1837 +0x6c8\r\n  testing.(*M).Run()\r\n      /opt/homebrew/Cellar/go/1.18.1/libexec/src/testing/testing.go:1719 +0x878\r\n  main.main()\r\n      _testmain.go:121 +0x2fc\r\n\r\nGoroutine 86 (running) created at:\r\n  github.com/prysmaticlabs/prysm/validator/rpc.TestServer_RefreshJWTSecretOnFileChange()\r\n      /Users/ptitluca/GolandProjects/prysm/validator/rpc/auth_token_test.go:69 +0x2f8\r\n  testing.tRunner()\r\n      /opt/homebrew/Cellar/go/1.18.1/libexec/src/testing/testing.go:1439 +0x18c\r\n  testing.(*T).Run.func1()\r\n      /opt/homebrew/Cellar/go/1.18.1/libexec/src/testing/testing.go:1486 +0x44\r\n==================\r\n--- FAIL: TestServer_RefreshJWTSecretOnFileChange (0.76s)\r\n    testing.go:1312: race detected during execution of test\r\nFAIL\r\nexit status 1\r\nFAIL    github.com/prysmaticlabs/prysm/validator/rpc    1.110s\r\n```\r\n\r\n\r\n## üåç  Your Environment\r\n\r\n**Operating System:**\r\n\r\n<pre>\r\n  <code>\r\nmacOS Monterey v12.3.1\r\n  </code>\r\n</pre>\r\n\r\n**What version of Prysm are you running? (Which release)**\r\n\r\nI ran the tests on the develop, master, v2.1.1 and v2.1.0 releases locally.\r\n\r\n**Anything else relevant ?**\r\n\r\nI can see two options here : either the server can have a mutex to protect concurrent read and writes, but it requires a lot of changes, or the test can wait for the goroutine to finish instead of waiting for a specific duration (currently 500ms).\r\nI've increased this duration to 1s and it still does not prevent the data race for happening.\r\n\r\nI'd really like to have your opinion here, and if that's okay for you I can create a PR right after we've decided what to change !",
  "closed_by": {
    "login": "rkapka",
    "id": 28876818,
    "node_id": "MDQ6VXNlcjI4ODc2ODE4",
    "avatar_url": "https://avatars.githubusercontent.com/u/28876818?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/rkapka",
    "html_url": "https://github.com/rkapka",
    "followers_url": "https://api.github.com/users/rkapka/followers",
    "following_url": "https://api.github.com/users/rkapka/following{/other_user}",
    "gists_url": "https://api.github.com/users/rkapka/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/rkapka/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rkapka/subscriptions",
    "organizations_url": "https://api.github.com/users/rkapka/orgs",
    "repos_url": "https://api.github.com/users/rkapka/repos",
    "events_url": "https://api.github.com/users/rkapka/events{/privacy}",
    "received_events_url": "https://api.github.com/users/rkapka/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/10641/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/10641/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1128537725",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/10641#issuecomment-1128537725",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/10641",
    "id": 1128537725,
    "node_id": "IC_kwDOBvuov85DRB59",
    "user": {
      "login": "nisdas",
      "id": 33201827,
      "node_id": "MDQ6VXNlcjMzMjAxODI3",
      "avatar_url": "https://avatars.githubusercontent.com/u/33201827?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nisdas",
      "html_url": "https://github.com/nisdas",
      "followers_url": "https://api.github.com/users/nisdas/followers",
      "following_url": "https://api.github.com/users/nisdas/following{/other_user}",
      "gists_url": "https://api.github.com/users/nisdas/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nisdas/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nisdas/subscriptions",
      "organizations_url": "https://api.github.com/users/nisdas/orgs",
      "repos_url": "https://api.github.com/users/nisdas/repos",
      "events_url": "https://api.github.com/users/nisdas/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nisdas/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-17T07:55:06Z",
    "updated_at": "2022-05-17T07:55:06Z",
    "author_association": "MEMBER",
    "body": "Thanks for the bug report @0xpanoramix , @james-prysm is more familiar with this section of the code base so tagging him on this for his opinion.  ",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1128537725/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1172215359",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/10641#issuecomment-1172215359",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/10641",
    "id": 1172215359,
    "node_id": "IC_kwDOBvuov85F3pY_",
    "user": {
      "login": "rkapka",
      "id": 28876818,
      "node_id": "MDQ6VXNlcjI4ODc2ODE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/28876818?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rkapka",
      "html_url": "https://github.com/rkapka",
      "followers_url": "https://api.github.com/users/rkapka/followers",
      "following_url": "https://api.github.com/users/rkapka/following{/other_user}",
      "gists_url": "https://api.github.com/users/rkapka/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rkapka/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rkapka/subscriptions",
      "organizations_url": "https://api.github.com/users/rkapka/orgs",
      "repos_url": "https://api.github.com/users/rkapka/repos",
      "events_url": "https://api.github.com/users/rkapka/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rkapka/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-01T10:52:23Z",
    "updated_at": "2022-07-01T10:52:23Z",
    "author_association": "CONTRIBUTOR",
    "body": "This test relies on `time.Sleep` to pick up file changes. Although it *potentially* causes a race condition, the timeout is big enough to have confidence that it will pass.",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1172215359/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
