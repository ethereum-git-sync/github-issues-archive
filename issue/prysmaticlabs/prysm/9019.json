{
  "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/9019",
  "repository_url": "https://api.github.com/repos/prysmaticlabs/prysm",
  "labels_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/9019/labels{/name}",
  "comments_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/9019/comments",
  "events_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/9019/events",
  "html_url": "https://github.com/prysmaticlabs/prysm/issues/9019",
  "id": 918011973,
  "node_id": "MDU6SXNzdWU5MTgwMTE5NzM=",
  "number": 9019,
  "title": "Can't get validator balances for certain epochs",
  "user": {
    "login": "aely-aronoff",
    "id": 50847754,
    "node_id": "MDQ6VXNlcjUwODQ3NzU0",
    "avatar_url": "https://avatars.githubusercontent.com/u/50847754?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/aely-aronoff",
    "html_url": "https://github.com/aely-aronoff",
    "followers_url": "https://api.github.com/users/aely-aronoff/followers",
    "following_url": "https://api.github.com/users/aely-aronoff/following{/other_user}",
    "gists_url": "https://api.github.com/users/aely-aronoff/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/aely-aronoff/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/aely-aronoff/subscriptions",
    "organizations_url": "https://api.github.com/users/aely-aronoff/orgs",
    "repos_url": "https://api.github.com/users/aely-aronoff/repos",
    "events_url": "https://api.github.com/users/aely-aronoff/events{/privacy}",
    "received_events_url": "https://api.github.com/users/aely-aronoff/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2021-06-10T22:39:51Z",
  "updated_at": "2021-06-29T02:25:05Z",
  "closed_at": "2021-06-29T02:25:05Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "# üêû Bug Report\r\n\r\n### Description\r\n\r\nDuring API call to `GET /eth/v1alpha1/validators/balances?epoch=XXXXX`, I get `{\"code\":13, \"message\":\"Could not get state\", \"details\":[]}`. Happens on both Pyrmont and mainnet. Other endpoints referencing that same epoch work fine (both `GET /eth/v1alpha1/validators/assignments?epoch=XXXXX` and `GET /eth/v1alpha1/validators/participation?epoch=XXXXX` seem to work correctly). \r\n\r\nMy hunch is that the error is being thrown here:\r\nhttps://github.com/prysmaticlabs/prysm/blob/master/beacon-chain/rpc/beacon/validators.go#L71\r\nThat seems to be the only place where the exact string \"Could not get state\" appears. Other places either have a lower-case 'c' or have a colon with another message afterwards.\r\n\r\nThe error came up while I was polling forward through epochs. For instance, starting at epoch 40,000, get a validator's balance in every epoch until the present. \r\n\r\nThe weirdest part: The error seems to happen only for epochs a random stretch before a DB archive point. For example, I have an archive point at epoch 45,312. I get that error for all epochs from 45,286 until epoch 45,311. It's fine for a few epochs until epoch 45,345, then all epochs until 45,439 are broken. Epoch 45,440 is an archive point. Note that epoch 45,376 *is* an archive point, but I still get the error for that epoch. Usually, it only lasts until the next archive point, but 45,376 stood out because it's an archive point that didn't fix things. I couldn't find any pattern in when the errors first occur, but they're consistently broken until an archive point, though not necessarily the first archive point encountered. (I put all the specific broken epoch ranges that I noticed at the very bottom)\r\n\r\n### Has this worked before in a previous version?\r\n\r\nDon't know but it didn't work in either version 1.3.9 or 1.3.10.\r\n\r\n## üî¨ Minimal Reproduction\r\n\r\nI'm running it with the Prysm install script using systemd. Service file (`/etc/systemd/system/goerli-prysm-beacon.service`):\r\n<pre><code>[Unit]\r\nDescription = Prysm beacon chain Goerli\r\nWants = network-online.target\r\nAfter = network-online.target\r\n\r\n[Service]\r\nType = simple\r\nUser = goerli-prysm\r\nExecStart = /home/MY_USER_NAME/prysm/prysm.sh beacon-chain --pyrmont --p2p-max-peers=45 --monitoring-host=\"0.0.0.0\" --http-web3provider=http://127.0.0.1:8546 --accept-terms-of-use --datadir=/home/MY_USER_NAME/prysm\r\n# Restart = on-failure\r\n\r\n[Install]\r\nWantedBy = multi-user.target</code></pre>\r\n\r\nI'm running a geth instance locally as well as a Prysm validator locally, similarly with systemd.\r\nThe above service file is essentially the same as the one that's running mainnet except without the `--pyrmont` flag.\r\n\r\n## üî• Error\r\n\r\nI don't see anything in the logs (which I access with `journalctl -u goerli-prysm-beacon`). The log keeps saying it's applying state transitions, finding peers, etc. In general, the node is working correctly and if the error is thrown where I think it's thrown there isn't any logging of the Golang error that takes place.\r\n\r\n\r\n## üåç  Your Environment\r\n\r\n**Operating System:**\r\n\r\n<pre>\r\n  <code>\r\n Operating System: Ubuntu 20.04.2 LTS\r\n  Kernel: Linux 5.8.0-53-generic\r\n  Architecture: x86-64\r\n  </code>\r\n</pre>\r\n\r\n**What version of Prysm are you running? (Which release)**\r\n\r\n<pre>\r\n  <code>\r\ncurl -X GET http://127.0.0.1:3500/eth/v1alpha1/node/version\r\n{\"version\":\"Prysm/v1.3.10/5ae6e83c7f6238593c6dfa3a8e05fc7c3778783f. Built at: 2021-06-02 14:47:33+00:00\", \"metadata\":\"\"}\r\n  </code>\r\n</pre>\r\n\r\n**Anything else relevant (validator index / public key)?**\r\n\r\nPyrmont, I get that error for epochs in these ranges:\r\n44984-44991\r\n45025-45055\r\n45222-45247\r\n45286-45311\r\n45345-45439\r\n45474-45503\r\n45537-45567\r\n45604-45631\r\n\r\nMainnet, I get that error for epochs in these ranges:\r\n42846-42879\r\n42910-42943\r\n42973-43007\r\n\r\nThere are probably other holes, but those are the ones I wrote down so far.\r\n\r\nI'm happy to run stuff if it'll help for debugging!\r\n\r\nCheers!\r\nAely\r\n\r\n",
  "closed_by": {
    "login": "aely-aronoff",
    "id": 50847754,
    "node_id": "MDQ6VXNlcjUwODQ3NzU0",
    "avatar_url": "https://avatars.githubusercontent.com/u/50847754?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/aely-aronoff",
    "html_url": "https://github.com/aely-aronoff",
    "followers_url": "https://api.github.com/users/aely-aronoff/followers",
    "following_url": "https://api.github.com/users/aely-aronoff/following{/other_user}",
    "gists_url": "https://api.github.com/users/aely-aronoff/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/aely-aronoff/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/aely-aronoff/subscriptions",
    "organizations_url": "https://api.github.com/users/aely-aronoff/orgs",
    "repos_url": "https://api.github.com/users/aely-aronoff/repos",
    "events_url": "https://api.github.com/users/aely-aronoff/events{/privacy}",
    "received_events_url": "https://api.github.com/users/aely-aronoff/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/9019/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/9019/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/859581076",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/9019#issuecomment-859581076",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/9019",
    "id": 859581076,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg1OTU4MTA3Ng==",
    "user": {
      "login": "prestonvanloon",
      "id": 7246818,
      "node_id": "MDQ6VXNlcjcyNDY4MTg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7246818?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/prestonvanloon",
      "html_url": "https://github.com/prestonvanloon",
      "followers_url": "https://api.github.com/users/prestonvanloon/followers",
      "following_url": "https://api.github.com/users/prestonvanloon/following{/other_user}",
      "gists_url": "https://api.github.com/users/prestonvanloon/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/prestonvanloon/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/prestonvanloon/subscriptions",
      "organizations_url": "https://api.github.com/users/prestonvanloon/orgs",
      "repos_url": "https://api.github.com/users/prestonvanloon/repos",
      "events_url": "https://api.github.com/users/prestonvanloon/events{/privacy}",
      "received_events_url": "https://api.github.com/users/prestonvanloon/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-06-11T13:26:41Z",
    "updated_at": "2021-06-11T13:26:41Z",
    "author_association": "MEMBER",
    "body": "We think that these requests might be timing out after 30 seconds. Unfortunately, the underlying error is not surfaced. I'll submit a PR to surface the underlying error. \r\n\r\nhttps://github.com/prysmaticlabs/prysm/blob/7a6ce27497268f840b9cd9f11c9c892388970db9/beacon-chain/rpc/beacon/validators.go#L69-L72\r\n\r\nIn the meantime, could you try a smaller value for `--slots-per-archive-point=2048` in the beacon chain node? I believe that smaller checkpoints may help alleviate the request latency. ",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/859581076/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/859687815",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/9019#issuecomment-859687815",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/9019",
    "id": 859687815,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg1OTY4NzgxNQ==",
    "user": {
      "login": "aely-aronoff",
      "id": 50847754,
      "node_id": "MDQ6VXNlcjUwODQ3NzU0",
      "avatar_url": "https://avatars.githubusercontent.com/u/50847754?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/aely-aronoff",
      "html_url": "https://github.com/aely-aronoff",
      "followers_url": "https://api.github.com/users/aely-aronoff/followers",
      "following_url": "https://api.github.com/users/aely-aronoff/following{/other_user}",
      "gists_url": "https://api.github.com/users/aely-aronoff/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/aely-aronoff/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/aely-aronoff/subscriptions",
      "organizations_url": "https://api.github.com/users/aely-aronoff/orgs",
      "repos_url": "https://api.github.com/users/aely-aronoff/repos",
      "events_url": "https://api.github.com/users/aely-aronoff/events{/privacy}",
      "received_events_url": "https://api.github.com/users/aely-aronoff/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-06-11T16:10:43Z",
    "updated_at": "2021-06-11T16:10:43Z",
    "author_association": "NONE",
    "body": "Ah that makes sense. Would you like me to try deploying the new version with your new PR to see what the underlying error is?",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/859687815/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/859708032",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/9019#issuecomment-859708032",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/9019",
    "id": 859708032,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg1OTcwODAzMg==",
    "user": {
      "login": "prestonvanloon",
      "id": 7246818,
      "node_id": "MDQ6VXNlcjcyNDY4MTg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7246818?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/prestonvanloon",
      "html_url": "https://github.com/prestonvanloon",
      "followers_url": "https://api.github.com/users/prestonvanloon/followers",
      "following_url": "https://api.github.com/users/prestonvanloon/following{/other_user}",
      "gists_url": "https://api.github.com/users/prestonvanloon/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/prestonvanloon/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/prestonvanloon/subscriptions",
      "organizations_url": "https://api.github.com/users/prestonvanloon/orgs",
      "repos_url": "https://api.github.com/users/prestonvanloon/repos",
      "events_url": "https://api.github.com/users/prestonvanloon/events{/privacy}",
      "received_events_url": "https://api.github.com/users/prestonvanloon/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-06-11T16:42:32Z",
    "updated_at": "2021-06-11T16:42:32Z",
    "author_association": "MEMBER",
    "body": "That could be helpful. gcr.io/prysmaticlabs/prysm/beacon-chain:HEAD-6981b1 is the latest in develop branch, if you run docker.",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/859708032/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/870177244",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/9019#issuecomment-870177244",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/9019",
    "id": 870177244,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg3MDE3NzI0NA==",
    "user": {
      "login": "aely-aronoff",
      "id": 50847754,
      "node_id": "MDQ6VXNlcjUwODQ3NzU0",
      "avatar_url": "https://avatars.githubusercontent.com/u/50847754?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/aely-aronoff",
      "html_url": "https://github.com/aely-aronoff",
      "followers_url": "https://api.github.com/users/aely-aronoff/followers",
      "following_url": "https://api.github.com/users/aely-aronoff/following{/other_user}",
      "gists_url": "https://api.github.com/users/aely-aronoff/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/aely-aronoff/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/aely-aronoff/subscriptions",
      "organizations_url": "https://api.github.com/users/aely-aronoff/orgs",
      "repos_url": "https://api.github.com/users/aely-aronoff/repos",
      "events_url": "https://api.github.com/users/aely-aronoff/events{/privacy}",
      "received_events_url": "https://api.github.com/users/aely-aronoff/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-06-29T02:25:05Z",
    "updated_at": "2021-06-29T02:25:05Z",
    "author_association": "NONE",
    "body": "Can confirm the problem was timing out. Shortening the slots per archive point solved it for me. Thank you!",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/870177244/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
