{
  "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/7699",
  "repository_url": "https://api.github.com/repos/prysmaticlabs/prysm",
  "labels_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/7699/labels{/name}",
  "comments_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/7699/comments",
  "events_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/7699/events",
  "html_url": "https://github.com/prysmaticlabs/prysm/issues/7699",
  "id": 734549254,
  "node_id": "MDU6SXNzdWU3MzQ1NDkyNTQ=",
  "number": 7699,
  "title": "performance aggregates are wrong",
  "user": {
    "login": "potuz",
    "id": 16044918,
    "node_id": "MDQ6VXNlcjE2MDQ0OTE4",
    "avatar_url": "https://avatars.githubusercontent.com/u/16044918?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/potuz",
    "html_url": "https://github.com/potuz",
    "followers_url": "https://api.github.com/users/potuz/followers",
    "following_url": "https://api.github.com/users/potuz/following{/other_user}",
    "gists_url": "https://api.github.com/users/potuz/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/potuz/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/potuz/subscriptions",
    "organizations_url": "https://api.github.com/users/potuz/orgs",
    "repos_url": "https://api.github.com/users/potuz/repos",
    "events_url": "https://api.github.com/users/potuz/events{/privacy}",
    "received_events_url": "https://api.github.com/users/potuz/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2020-11-02T14:26:35Z",
  "updated_at": "2020-11-03T23:47:13Z",
  "closed_at": "2020-11-03T23:47:13Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "# üêû Bug Report\r\n\r\n### Description\r\nThe validator performance aggregates logged in `LogValidatorGainsAndLosses` may miss attestations that are included later\r\n\r\n### Has this worked before in a previous version?\r\n\r\nNo\r\n\r\n### The problem:\r\n\r\nThe performance stats including averages to `InclusionDistance`, `InclusionSlot`, `CorrectlyVotedHead`, `CorrectlyVotedTarget` and `CorrectlyVotedSource` are updated on each call to `LogValidatorGainsAndLosses`. This function is called at the beginning of each epoch. \r\n\r\nThis function in turn calls `GetValidatorPerformance` which precomputes the validator performances for the previous epoch. The problem with this latter function is that it treats as missing any attestation that hasn't been included up to this point. Therefore many attestations are counted as missing in the performance summary when they are in fact included later. \r\n\r\n### Possible solutions:\r\n\r\n- Call `LogValidatorGainsAndLosses` at the end of the epoch instead of at the beginning to ensure that all attestations that are reported as missing are indeed missing. This is the minimal solution to the above problem. \r\n- Allow `GetValidatorPerformance` to be given an epoch to compute, so that if it is called with a past epoch it gets the status of the last slot of the previous epoch.  This will allow someone to fetch the performance of a previous epoch knowing returning the right inclusion distance/missing status. Currently, if one calls before 32 slots have passed between the previous attestation, one has no way of knowing for certain if a missing attestation would be missing or if may be included later. In practical terms this means that a user needs to poll this precisely at epoch end to be certain of obtaining the right asnwer. \r\n- Make `GetValidatorPerformance` return the performance of epoch `CurrentEpoch - 2` so as to avoid the previous problem\r\n\r\n### Related issue: \r\n\r\nThe api call `/eth/v1alpha1/validators/performance` calls directly `GetValidatorPerformance`, therefore an API user needs to call precisely at epoch ends to avoid the problem mentioned above. \r\n\r\n### Extra Info: \r\n\r\nrelated discussion in Discord: \r\nhttps://discord.com/channels/476244492043812875/730447046930071672/772172731046952989",
  "closed_by": {
    "login": "prylabs-bulldozer[bot]",
    "id": 58059840,
    "node_id": "MDM6Qm90NTgwNTk4NDA=",
    "avatar_url": "https://avatars.githubusercontent.com/in/47372?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/prylabs-bulldozer%5Bbot%5D",
    "html_url": "https://github.com/apps/prylabs-bulldozer",
    "followers_url": "https://api.github.com/users/prylabs-bulldozer%5Bbot%5D/followers",
    "following_url": "https://api.github.com/users/prylabs-bulldozer%5Bbot%5D/following{/other_user}",
    "gists_url": "https://api.github.com/users/prylabs-bulldozer%5Bbot%5D/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/prylabs-bulldozer%5Bbot%5D/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/prylabs-bulldozer%5Bbot%5D/subscriptions",
    "organizations_url": "https://api.github.com/users/prylabs-bulldozer%5Bbot%5D/orgs",
    "repos_url": "https://api.github.com/users/prylabs-bulldozer%5Bbot%5D/repos",
    "events_url": "https://api.github.com/users/prylabs-bulldozer%5Bbot%5D/events{/privacy}",
    "received_events_url": "https://api.github.com/users/prylabs-bulldozer%5Bbot%5D/received_events",
    "type": "Bot",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/7699/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/7699/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/720542536",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/7699#issuecomment-720542536",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/7699",
    "id": 720542536,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcyMDU0MjUzNg==",
    "user": {
      "login": "potuz",
      "id": 16044918,
      "node_id": "MDQ6VXNlcjE2MDQ0OTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/16044918?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/potuz",
      "html_url": "https://github.com/potuz",
      "followers_url": "https://api.github.com/users/potuz/followers",
      "following_url": "https://api.github.com/users/potuz/following{/other_user}",
      "gists_url": "https://api.github.com/users/potuz/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/potuz/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/potuz/subscriptions",
      "organizations_url": "https://api.github.com/users/potuz/orgs",
      "repos_url": "https://api.github.com/users/potuz/repos",
      "events_url": "https://api.github.com/users/potuz/events{/privacy}",
      "received_events_url": "https://api.github.com/users/potuz/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-11-02T15:29:15Z",
    "updated_at": "2020-11-02T15:29:15Z",
    "author_association": "CONTRIBUTOR",
    "body": "An implementation of the first (simplest) solution above is in https://github.com/potuz/prysm/tree/report-last-boundary-performance",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/720542536/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
