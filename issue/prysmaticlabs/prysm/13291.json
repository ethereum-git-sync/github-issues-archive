{
  "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/13291",
  "repository_url": "https://api.github.com/repos/prysmaticlabs/prysm",
  "labels_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/13291/labels{/name}",
  "comments_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/13291/comments",
  "events_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/13291/events",
  "html_url": "https://github.com/prysmaticlabs/prysm/issues/13291",
  "id": 2030734680,
  "node_id": "I_kwDOBvuov855Co1Y",
  "number": 13291,
  "title": "Beacon node high CPU usage",
  "user": {
    "login": "montekki",
    "id": 56672,
    "node_id": "MDQ6VXNlcjU2Njcy",
    "avatar_url": "https://avatars.githubusercontent.com/u/56672?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/montekki",
    "html_url": "https://github.com/montekki",
    "followers_url": "https://api.github.com/users/montekki/followers",
    "following_url": "https://api.github.com/users/montekki/following{/other_user}",
    "gists_url": "https://api.github.com/users/montekki/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/montekki/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/montekki/subscriptions",
    "organizations_url": "https://api.github.com/users/montekki/orgs",
    "repos_url": "https://api.github.com/users/montekki/repos",
    "events_url": "https://api.github.com/users/montekki/events{/privacy}",
    "received_events_url": "https://api.github.com/users/montekki/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 802129904,
      "node_id": "MDU6TGFiZWw4MDIxMjk5MDQ=",
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/labels/Bug",
      "name": "Bug",
      "color": "ee0701",
      "default": false,
      "description": "Something isn't working"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2023-12-07T13:10:26Z",
  "updated_at": "2023-12-17T09:49:13Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Describe the bug\r\n\r\nWhile running a local testnet with a beacon and validator nodes I've noticed really high CPU usages (this is beacon):\r\n\r\n<img width=\"728\" alt=\"Screenshot 2023-12-07 at 14 07 13\" src=\"https://github.com/prysmaticlabs/prysm/assets/56672/d051a1e1-93de-496f-8a76-da9022be3284\">\r\n\r\nValidator node at the same time:\r\n\r\n![image](https://github.com/prysmaticlabs/prysm/assets/56672/b29ab74a-71c6-4a19-8f03-4d3c4e8dab9c)\r\n\r\nand this puts the network into the 120% cpu mode which is sort of excessive isn't it? \r\n\r\nWhich is kind of frustrating to see when at the same time geth (which is an execution node and AFAIU is supposed to be heavier than the consensus ones) is working under 1% CPU. Is there any reason for such high resource consumption?\r\n\r\n### Has this worked before in a previous version?\r\n\r\n_No response_\r\n\r\n### ðŸ”¬ Minimal Reproduction\r\n\r\n_No response_\r\n\r\n### Error\r\n\r\n_No response_\r\n\r\n### Platform(s)\r\n\r\nMac (Apple Silicon)\r\n\r\n### What version of Prysm are you running? (Which release)\r\n\r\nPrysm/v4.1.1/bc9151d647e70cf5e0b6dbcee01998c430a96cb5\r\n\r\n### Anything else relevant (validator index / public key)?\r\n\r\n_No response_",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/13291/reactions",
    "total_count": 1,
    "+1": 1,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/13291/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1856273243",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/13291#issuecomment-1856273243",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/13291",
    "id": 1856273243,
    "node_id": "IC_kwDOBvuov85upHtb",
    "user": {
      "login": "prestonvanloon",
      "id": 7246818,
      "node_id": "MDQ6VXNlcjcyNDY4MTg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7246818?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/prestonvanloon",
      "html_url": "https://github.com/prestonvanloon",
      "followers_url": "https://api.github.com/users/prestonvanloon/followers",
      "following_url": "https://api.github.com/users/prestonvanloon/following{/other_user}",
      "gists_url": "https://api.github.com/users/prestonvanloon/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/prestonvanloon/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/prestonvanloon/subscriptions",
      "organizations_url": "https://api.github.com/users/prestonvanloon/orgs",
      "repos_url": "https://api.github.com/users/prestonvanloon/repos",
      "events_url": "https://api.github.com/users/prestonvanloon/events{/privacy}",
      "received_events_url": "https://api.github.com/users/prestonvanloon/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-12-14T17:29:18Z",
    "updated_at": "2023-12-14T17:29:18Z",
    "author_association": "MEMBER",
    "body": "@montekki thanks so much for the report. Could you explain a bit more about the setup and how to reproduce it?\r\n\r\nHow many validators are running? What flags are you using?\r\n\r\nRegarding your comment about geth using low resources: if there are few execution transactions, then geth would be mostly producing empty blocks which requires little resources. However, the beacon node produces blocks with attestations and these are never empty (unless something is horribly wrong).\r\n\r\nIn any case, if you could share some reproduction steps, we could profile the beacon-chain to help understand where the CPU resources are spent. \r\n\r\nYou could try yourself by running the beacon node with `--pprof` flag and then taking a sample from that running beacon-node like `go tool pprof -http localhost:7070 http://localhost:6060/debug/pprof/profile\\?seconds\\=30`. You may safely share the resulting pprof.pb.gz here if you like too.",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1856273243/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1859089826",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/13291#issuecomment-1859089826",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/13291",
    "id": 1859089826,
    "node_id": "IC_kwDOBvuov85uz3Wi",
    "user": {
      "login": "montekki",
      "id": 56672,
      "node_id": "MDQ6VXNlcjU2Njcy",
      "avatar_url": "https://avatars.githubusercontent.com/u/56672?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/montekki",
      "html_url": "https://github.com/montekki",
      "followers_url": "https://api.github.com/users/montekki/followers",
      "following_url": "https://api.github.com/users/montekki/following{/other_user}",
      "gists_url": "https://api.github.com/users/montekki/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/montekki/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/montekki/subscriptions",
      "organizations_url": "https://api.github.com/users/montekki/orgs",
      "repos_url": "https://api.github.com/users/montekki/repos",
      "events_url": "https://api.github.com/users/montekki/events{/privacy}",
      "received_events_url": "https://api.github.com/users/montekki/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-12-17T09:49:12Z",
    "updated_at": "2023-12-17T09:49:12Z",
    "author_association": "NONE",
    "body": "Yep sure that is from https://github.com/matter-labs/zksync-era/blob/main/docker-compose.yml which is for the most part https://github.com/OffchainLabs/eth-pos-devnet tuned for our usecase. To run it I would suggest a modified version of `./bin/ci_localnet_up` from the root of the repo:\r\n\r\n```bash\r\n#!/usr/bin/env bash\r\n\r\nset -e\r\n\r\nmkdir -p ./volumes/postgres ./volumes/geth/keystore ./volumes/prysm/beacon ./volumes/prysm/validator\r\ncp ./docker/prysm/config.yml ./volumes/prysm/config.yml\r\ncp ./docker/geth/jwtsecret ./volumes/geth/jwtsecret\r\ncp ./docker/geth/password.sec ./volumes/geth/password.sec\r\ncp ./docker/geth/keystore/UTC--2019-04-06T21-13-27.692266000Z--8a91dc2d28b689474298d91899f0c1baf62cb85b ./volumes/geth/keystore/\r\ndocker-compose up -d --wait\r\n```\r\nWhich basically just doesn't run ci-specific `runner` profile.",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1859089826/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
