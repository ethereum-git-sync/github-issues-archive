{
  "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/8486",
  "repository_url": "https://api.github.com/repos/prysmaticlabs/prysm",
  "labels_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/8486/labels{/name}",
  "comments_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/8486/comments",
  "events_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/8486/events",
  "html_url": "https://github.com/prysmaticlabs/prysm/issues/8486",
  "id": 812754092,
  "node_id": "MDU6SXNzdWU4MTI3NTQwOTI=",
  "number": 8486,
  "title": "Database Backups Leads To High Memory Usage",
  "user": {
    "login": "nisdas",
    "id": 33201827,
    "node_id": "MDQ6VXNlcjMzMjAxODI3",
    "avatar_url": "https://avatars.githubusercontent.com/u/33201827?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/nisdas",
    "html_url": "https://github.com/nisdas",
    "followers_url": "https://api.github.com/users/nisdas/followers",
    "following_url": "https://api.github.com/users/nisdas/following{/other_user}",
    "gists_url": "https://api.github.com/users/nisdas/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/nisdas/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/nisdas/subscriptions",
    "organizations_url": "https://api.github.com/users/nisdas/orgs",
    "repos_url": "https://api.github.com/users/nisdas/repos",
    "events_url": "https://api.github.com/users/nisdas/events{/privacy}",
    "received_events_url": "https://api.github.com/users/nisdas/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 802129904,
      "node_id": "MDU6TGFiZWw4MDIxMjk5MDQ=",
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/labels/Bug",
      "name": "Bug",
      "color": "ee0701",
      "default": false,
      "description": "Something isn't working"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2021-02-21T02:19:56Z",
  "updated_at": "2021-03-03T15:37:14Z",
  "closed_at": "2021-03-03T15:37:14Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "# üêû Bug Report\r\n\r\n### Description\r\n\r\nDatabase backups in the beacon node, lead to a very large increase in memory usage. This eventually kills the node\r\nand host machine due to Bolt iterating through all the buckets and keys and trying to copy them.\r\n\r\n### Has this worked before in a previous version?\r\n\r\nYes\r\n\r\n## üî¨ Minimal Reproduction\r\n\r\nBackup a live beacon node in mainnet.\r\n",
  "closed_by": {
    "login": "prylabs-bulldozer[bot]",
    "id": 58059840,
    "node_id": "MDM6Qm90NTgwNTk4NDA=",
    "avatar_url": "https://avatars.githubusercontent.com/in/47372?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/prylabs-bulldozer%5Bbot%5D",
    "html_url": "https://github.com/apps/prylabs-bulldozer",
    "followers_url": "https://api.github.com/users/prylabs-bulldozer%5Bbot%5D/followers",
    "following_url": "https://api.github.com/users/prylabs-bulldozer%5Bbot%5D/following{/other_user}",
    "gists_url": "https://api.github.com/users/prylabs-bulldozer%5Bbot%5D/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/prylabs-bulldozer%5Bbot%5D/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/prylabs-bulldozer%5Bbot%5D/subscriptions",
    "organizations_url": "https://api.github.com/users/prylabs-bulldozer%5Bbot%5D/orgs",
    "repos_url": "https://api.github.com/users/prylabs-bulldozer%5Bbot%5D/repos",
    "events_url": "https://api.github.com/users/prylabs-bulldozer%5Bbot%5D/events{/privacy}",
    "received_events_url": "https://api.github.com/users/prylabs-bulldozer%5Bbot%5D/received_events",
    "type": "Bot",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/8486/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/8486/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/782795895",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/8486#issuecomment-782795895",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/8486",
    "id": 782795895,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc4Mjc5NTg5NQ==",
    "user": {
      "login": "Dimasin",
      "id": 18557008,
      "node_id": "MDQ6VXNlcjE4NTU3MDA4",
      "avatar_url": "https://avatars.githubusercontent.com/u/18557008?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Dimasin",
      "html_url": "https://github.com/Dimasin",
      "followers_url": "https://api.github.com/users/Dimasin/followers",
      "following_url": "https://api.github.com/users/Dimasin/following{/other_user}",
      "gists_url": "https://api.github.com/users/Dimasin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Dimasin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Dimasin/subscriptions",
      "organizations_url": "https://api.github.com/users/Dimasin/orgs",
      "repos_url": "https://api.github.com/users/Dimasin/repos",
      "events_url": "https://api.github.com/users/Dimasin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Dimasin/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-02-21T04:38:16Z",
    "updated_at": "2021-02-21T04:38:16Z",
    "author_association": "NONE",
    "body": "After initiate back up: `wget -T 600 http://127.0.0.1:8080/db/backup`, the file `prysm_beacondb_at_slot_0582037`.backup is created in the `db-backup-output-dir directory`. For some time the length of this file increased, then stopped at 175300Kb.\r\nIn the beacon-chain event log, when initiating the creation of a backup copy, a message appears:\r\n`time=\"2021-02-20 13:07:57\" level=info msg=\"Writing backup database.\" backup=\"db-backup-output-dir directory\"`\r\nAfter 2-3 minutes, the systemd reports an abnormal crash of the beacon-chain service and its restart:\r\n```\r\n13:10:09 systemd[1]: beacon-chain.service: Main process exited, code=killed, status=9/KILL\r\n13:10:09 systemd[1]: beacon-chain.service: Failed with result 'signal'.\r\n13:10:14 systemd[1]: beacon-chain.service: Scheduled restart job, restart counter is at 1.\r\n13:10:14 systemd[1]: Stopped Prysm Beaconchain.\r\n13:10:14 systemd[1]: Started Prysm Beaconchain.\r\n```\r\nThis happens every time try to back up the beacon site database.\r\nThe validator database is backing up without any problems.\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/782795895/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/786149178",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/8486#issuecomment-786149178",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/8486",
    "id": 786149178,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc4NjE0OTE3OA==",
    "user": {
      "login": "prestonvanloon",
      "id": 7246818,
      "node_id": "MDQ6VXNlcjcyNDY4MTg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7246818?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/prestonvanloon",
      "html_url": "https://github.com/prestonvanloon",
      "followers_url": "https://api.github.com/users/prestonvanloon/followers",
      "following_url": "https://api.github.com/users/prestonvanloon/following{/other_user}",
      "gists_url": "https://api.github.com/users/prestonvanloon/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/prestonvanloon/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/prestonvanloon/subscriptions",
      "organizations_url": "https://api.github.com/users/prestonvanloon/orgs",
      "repos_url": "https://api.github.com/users/prestonvanloon/repos",
      "events_url": "https://api.github.com/users/prestonvanloon/events{/privacy}",
      "received_events_url": "https://api.github.com/users/prestonvanloon/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-02-25T19:33:45Z",
    "updated_at": "2021-02-25T19:33:45Z",
    "author_association": "MEMBER",
    "body": "Seems like boltdb might be reading the entire contents of some buckets into memory, then writing it to disk. This would be problematic for large buckets in the beacon chain, while the validator db still has relatively small buckets.",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/786149178/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
