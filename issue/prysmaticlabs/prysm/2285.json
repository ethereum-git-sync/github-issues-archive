{
  "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/2285",
  "repository_url": "https://api.github.com/repos/prysmaticlabs/prysm",
  "labels_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/2285/labels{/name}",
  "comments_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/2285/comments",
  "events_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/2285/events",
  "html_url": "https://github.com/prysmaticlabs/prysm/issues/2285",
  "id": 434765821,
  "node_id": "MDU6SXNzdWU0MzQ3NjU4MjE=",
  "number": 2285,
  "title": "Rate limit peers issuing block requests",
  "user": {
    "login": "rauljordan",
    "id": 5572669,
    "node_id": "MDQ6VXNlcjU1NzI2Njk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5572669?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/rauljordan",
    "html_url": "https://github.com/rauljordan",
    "followers_url": "https://api.github.com/users/rauljordan/followers",
    "following_url": "https://api.github.com/users/rauljordan/following{/other_user}",
    "gists_url": "https://api.github.com/users/rauljordan/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/rauljordan/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rauljordan/subscriptions",
    "organizations_url": "https://api.github.com/users/rauljordan/orgs",
    "repos_url": "https://api.github.com/users/rauljordan/repos",
    "events_url": "https://api.github.com/users/rauljordan/events{/privacy}",
    "received_events_url": "https://api.github.com/users/rauljordan/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 802129906,
      "node_id": "MDU6TGFiZWw4MDIxMjk5MDY=",
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/labels/Enhancement",
      "name": "Enhancement",
      "color": "84b6eb",
      "default": false,
      "description": "New feature or request"
    },
    {
      "id": 802129907,
      "node_id": "MDU6TGFiZWw4MDIxMjk5MDc=",
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/labels/Help%20Wanted",
      "name": "Help Wanted",
      "color": "33aa3f",
      "default": false,
      "description": "Extra attention is needed"
    },
    {
      "id": 802129908,
      "node_id": "MDU6TGFiZWw4MDIxMjk5MDg=",
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/labels/Good%20First%20Issue",
      "name": "Good First Issue",
      "color": "7057ff",
      "default": false,
      "description": "Good for newcomers"
    },
    {
      "id": 1085357069,
      "node_id": "MDU6TGFiZWwxMDg1MzU3MDY5",
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/labels/Priority:%20High",
      "name": "Priority: High",
      "color": "f7ea26",
      "default": false,
      "description": "High priority item"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/milestones/2",
    "html_url": "https://github.com/prysmaticlabs/prysm/milestone/2",
    "labels_url": "https://api.github.com/repos/prysmaticlabs/prysm/milestones/2/labels",
    "id": 3141842,
    "node_id": "MDk6TWlsZXN0b25lMzE0MTg0Mg==",
    "number": 2,
    "title": "Sapphire",
    "description": "The Sapphire Release: Goerli Testnet",
    "creator": {
      "login": "prestonvanloon",
      "id": 7246818,
      "node_id": "MDQ6VXNlcjcyNDY4MTg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7246818?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/prestonvanloon",
      "html_url": "https://github.com/prestonvanloon",
      "followers_url": "https://api.github.com/users/prestonvanloon/followers",
      "following_url": "https://api.github.com/users/prestonvanloon/following{/other_user}",
      "gists_url": "https://api.github.com/users/prestonvanloon/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/prestonvanloon/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/prestonvanloon/subscriptions",
      "organizations_url": "https://api.github.com/users/prestonvanloon/orgs",
      "repos_url": "https://api.github.com/users/prestonvanloon/repos",
      "events_url": "https://api.github.com/users/prestonvanloon/events{/privacy}",
      "received_events_url": "https://api.github.com/users/prestonvanloon/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 0,
    "closed_issues": 171,
    "state": "closed",
    "created_at": "2018-02-25T21:23:32Z",
    "updated_at": "2020-02-04T15:38:04Z",
    "due_on": "2019-03-30T07:00:00Z",
    "closed_at": "2019-05-24T22:12:25Z"
  },
  "comments": 2,
  "created_at": "2019-04-18T13:17:40Z",
  "updated_at": "2020-02-04T15:38:04Z",
  "closed_at": "2020-02-04T15:38:04Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "Currently, bad peers might spam our nodes with thousands of block requests per second - we must prevent that by either dropping the peer or rate limiting the response.",
  "closed_by": {
    "login": "rauljordan",
    "id": 5572669,
    "node_id": "MDQ6VXNlcjU1NzI2Njk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5572669?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/rauljordan",
    "html_url": "https://github.com/rauljordan",
    "followers_url": "https://api.github.com/users/rauljordan/followers",
    "following_url": "https://api.github.com/users/rauljordan/following{/other_user}",
    "gists_url": "https://api.github.com/users/rauljordan/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/rauljordan/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rauljordan/subscriptions",
    "organizations_url": "https://api.github.com/users/rauljordan/orgs",
    "repos_url": "https://api.github.com/users/rauljordan/repos",
    "events_url": "https://api.github.com/users/rauljordan/events{/privacy}",
    "received_events_url": "https://api.github.com/users/rauljordan/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/2285/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/2285/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/484924048",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/2285#issuecomment-484924048",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/2285",
    "id": 484924048,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ4NDkyNDA0OA==",
    "user": {
      "login": "prestonvanloon",
      "id": 7246818,
      "node_id": "MDQ6VXNlcjcyNDY4MTg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7246818?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/prestonvanloon",
      "html_url": "https://github.com/prestonvanloon",
      "followers_url": "https://api.github.com/users/prestonvanloon/followers",
      "following_url": "https://api.github.com/users/prestonvanloon/following{/other_user}",
      "gists_url": "https://api.github.com/users/prestonvanloon/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/prestonvanloon/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/prestonvanloon/subscriptions",
      "organizations_url": "https://api.github.com/users/prestonvanloon/orgs",
      "repos_url": "https://api.github.com/users/prestonvanloon/repos",
      "events_url": "https://api.github.com/users/prestonvanloon/events{/privacy}",
      "received_events_url": "https://api.github.com/users/prestonvanloon/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-04-19T15:05:46Z",
    "updated_at": "2019-04-19T15:05:46Z",
    "author_association": "MEMBER",
    "body": "Rate limiting in the p2p layer is a concept that needs careful design. We more likely need to build a reputation system where healthy peers can send virtually unlimited messages to indicate new information with occasional requests for information in bulk. The reputation would lower if a given peer suddenly started requesting loads of data. Once a reputation is low enough then the peer is disconnected or throttled.\r\n\r\nI see two parts to this system:\r\n- Reputation based throttling on incoming messages/requests.\r\n- Reasonable limits on outgoing requests (we shouldn't knowingly spam peers, if we can avoid it) \r\n\r\nThe reputation system is more complex and requires a careful design so let's consider the outbound limiting for resolution of this specific issue for now. \r\n\r\nUsing the [golang rate package](https://godoc.org/golang.org/x/time/rate), we can set rate limits on a per peer basis stored in some in-memory map which is occasionally cleared if entries are not accessed in some TTL. i.e. we have an algorithm as such:\r\n\r\n- call p2p.Send(msg, specificPeer)\r\n- lmt = limitCache.get(specificPeer) // resets cache TTL\r\n- lmt.LimitReached() // log WARN if limit reached\r\n- lmt.Wait() // Wait for limit to allow the request to continue\r\n- continue request to peer\r\n\r\nNote: the cache must be eagerly pruned of TTL entries as the scenario where a peer disconnects and never returns is the likely cause for a TTL to expire. In this scenario, lazy deletion will not work as we may never `Get` for that same peer ID again. \r\n\r\nOne thing to consider is a circuit breaker if there are `n` goroutines waiting for the limit, we may start dropping send requests all together with an error. For example, if there is some accidental infinite loop that spams requests as fast as the CPU will allow.\r\n\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/484924048/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/581968446",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/2285#issuecomment-581968446",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/2285",
    "id": 581968446,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU4MTk2ODQ0Ng==",
    "user": {
      "login": "rauljordan",
      "id": 5572669,
      "node_id": "MDQ6VXNlcjU1NzI2Njk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5572669?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rauljordan",
      "html_url": "https://github.com/rauljordan",
      "followers_url": "https://api.github.com/users/rauljordan/followers",
      "following_url": "https://api.github.com/users/rauljordan/following{/other_user}",
      "gists_url": "https://api.github.com/users/rauljordan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rauljordan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rauljordan/subscriptions",
      "organizations_url": "https://api.github.com/users/rauljordan/orgs",
      "repos_url": "https://api.github.com/users/rauljordan/repos",
      "events_url": "https://api.github.com/users/rauljordan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rauljordan/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-02-04T15:38:04Z",
    "updated_at": "2020-02-04T15:38:04Z",
    "author_association": "CONTRIBUTOR",
    "body": "This functionality already exists in Prysm, closing",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/581968446/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
