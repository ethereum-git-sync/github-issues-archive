{
  "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/13003",
  "repository_url": "https://api.github.com/repos/prysmaticlabs/prysm",
  "labels_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/13003/labels{/name}",
  "comments_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/13003/comments",
  "events_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/13003/events",
  "html_url": "https://github.com/prysmaticlabs/prysm/issues/13003",
  "id": 1926748868,
  "node_id": "I_kwDOBvuov85y19rE",
  "number": 13003,
  "title": "Enable users to initialize a new checkpoint sync atop an existing DB",
  "user": {
    "login": "kasey",
    "id": 489222,
    "node_id": "MDQ6VXNlcjQ4OTIyMg==",
    "avatar_url": "https://avatars.githubusercontent.com/u/489222?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/kasey",
    "html_url": "https://github.com/kasey",
    "followers_url": "https://api.github.com/users/kasey/followers",
    "following_url": "https://api.github.com/users/kasey/following{/other_user}",
    "gists_url": "https://api.github.com/users/kasey/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/kasey/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/kasey/subscriptions",
    "organizations_url": "https://api.github.com/users/kasey/orgs",
    "repos_url": "https://api.github.com/users/kasey/repos",
    "events_url": "https://api.github.com/users/kasey/events{/privacy}",
    "received_events_url": "https://api.github.com/users/kasey/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 934596141,
      "node_id": "MDU6TGFiZWw5MzQ1OTYxNDE=",
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/labels/Discussion",
      "name": "Discussion",
      "color": "f9d0c4",
      "default": false,
      "description": "Simply a thread for talking about stuff"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": {
    "login": "kasey",
    "id": 489222,
    "node_id": "MDQ6VXNlcjQ4OTIyMg==",
    "avatar_url": "https://avatars.githubusercontent.com/u/489222?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/kasey",
    "html_url": "https://github.com/kasey",
    "followers_url": "https://api.github.com/users/kasey/followers",
    "following_url": "https://api.github.com/users/kasey/following{/other_user}",
    "gists_url": "https://api.github.com/users/kasey/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/kasey/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/kasey/subscriptions",
    "organizations_url": "https://api.github.com/users/kasey/orgs",
    "repos_url": "https://api.github.com/users/kasey/repos",
    "events_url": "https://api.github.com/users/kasey/events{/privacy}",
    "received_events_url": "https://api.github.com/users/kasey/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "kasey",
      "id": 489222,
      "node_id": "MDQ6VXNlcjQ4OTIyMg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/489222?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/kasey",
      "html_url": "https://github.com/kasey",
      "followers_url": "https://api.github.com/users/kasey/followers",
      "following_url": "https://api.github.com/users/kasey/following{/other_user}",
      "gists_url": "https://api.github.com/users/kasey/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/kasey/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/kasey/subscriptions",
      "organizations_url": "https://api.github.com/users/kasey/orgs",
      "repos_url": "https://api.github.com/users/kasey/repos",
      "events_url": "https://api.github.com/users/kasey/events{/privacy}",
      "received_events_url": "https://api.github.com/users/kasey/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 6,
  "created_at": "2023-10-04T18:20:42Z",
  "updated_at": "2023-10-06T10:37:02Z",
  "closed_at": null,
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "# ðŸš€ Feature Request\r\n\r\n### Description\r\n\r\nCurrently the beacon node will ignore the checkpoint sync flags if there is an existing db value that indicates checkpoint sync has previously written an origin state+block to the db. @potuz  has asked for a way to re-sync a checkpoint synced node and backfill to a given previous epoch in order to \"import\" the existing state.\r\n\r\nThere is a ux problem here, which is that people often keep static sets of flags on their nodes, which persist across restarts. For instance, in a config file used by systemd or the flags for a k8s pod. We don't want a restarting process to always initialize a fresh checkpoint sync, unless we're sure the user wants it.\r\n\r\nFor file-based checkpoint sync this is easy. If the roots of the given state/block don't match those found in the db, initialize checkpoint sync using the given flags.\r\n\r\nFor url-based checkpoint sync it's more tricky, because the node will fetch the newest finalized block from the given beacon api, which will almost always be a different root.\r\n\r\n### Describe the solution you'd like\r\n\r\nFor file-based syncing, check the given files to see if they match the existing origin. If they don't match, initialize a new checkpoint sync.\r\n\r\nFor URLs, we can let the user tweak the url to \"bust the cache\". This requires that we start storing the URL used for the last successful checkpoint sync in the DB. If a URL is specified and doesn't match, that means that the user wants to resync. URL fragments give us a nice tool for busting the cache without messing up the actual request - the user can specify something like `https://my-cp-sync-url/#resync-epoch-xyz` to replace the previous run of `https://my-cp-sync-url`. The flag initialization code will see the full string including the `#resync-epoch-xyz` fragment, allowing the user to force a mismatch and resync. But the fragment will be discarded by the request url builder, allowing the user to trigger the \"cache bust\" without breaking the rules of URL semantics.\r\n\r\n### Describe alternatives you've considered\r\n\r\nWe could allow the user to specify specific slots or roots to start from rather than grabbing the most recently finalized block. At startup we would check if those match the origin data in the database. An advantage of this alternative is that it could be a useful power user / dev feature. 2 disadvantages: it would create more flag bloat, and it would require more expertise in the simple case where a user wants to re-sync, but is fine with the most recently finalized block.",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/13003/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/13003/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1747444008",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/13003#issuecomment-1747444008",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/13003",
    "id": 1747444008,
    "node_id": "IC_kwDOBvuov85oJ-Eo",
    "user": {
      "login": "potuz",
      "id": 16044918,
      "node_id": "MDQ6VXNlcjE2MDQ0OTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/16044918?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/potuz",
      "html_url": "https://github.com/potuz",
      "followers_url": "https://api.github.com/users/potuz/followers",
      "following_url": "https://api.github.com/users/potuz/following{/other_user}",
      "gists_url": "https://api.github.com/users/potuz/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/potuz/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/potuz/subscriptions",
      "organizations_url": "https://api.github.com/users/potuz/orgs",
      "repos_url": "https://api.github.com/users/potuz/repos",
      "events_url": "https://api.github.com/users/potuz/events{/privacy}",
      "received_events_url": "https://api.github.com/users/potuz/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-10-04T18:41:53Z",
    "updated_at": "2023-10-04T18:41:53Z",
    "author_association": "CONTRIBUTOR",
    "body": "A first impression reply here, and probably not a popular take: let the user do a fresh checkpoint sync if they forget to remove the flags on restarts. ",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1747444008/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1748832558",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/13003#issuecomment-1748832558",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/13003",
    "id": 1748832558,
    "node_id": "IC_kwDOBvuov85oPREu",
    "user": {
      "login": "rkapka",
      "id": 28876818,
      "node_id": "MDQ6VXNlcjI4ODc2ODE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/28876818?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rkapka",
      "html_url": "https://github.com/rkapka",
      "followers_url": "https://api.github.com/users/rkapka/followers",
      "following_url": "https://api.github.com/users/rkapka/following{/other_user}",
      "gists_url": "https://api.github.com/users/rkapka/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rkapka/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rkapka/subscriptions",
      "organizations_url": "https://api.github.com/users/rkapka/orgs",
      "repos_url": "https://api.github.com/users/rkapka/repos",
      "events_url": "https://api.github.com/users/rkapka/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rkapka/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-10-05T12:48:10Z",
    "updated_at": "2023-10-05T12:49:53Z",
    "author_association": "CONTRIBUTOR",
    "body": "If I understand this properly, the scenario is as follows:\r\n- I run a new node with checkpoint sync flags\r\n- I am offline for a while\r\n- I restart the node with checkpoint sync flags\r\n\r\nAs a user, what do I care about the most? Clearly about syncing to head as soon as possible, which can be achieved best by a new checkpoint sync. What I propose is to fetch the new finalized state, start syncing blocks on top of it, and bridge the gap between the last block prior to going offline and the checkpoint-synced finalized state's block in parallel (either backwards from the checkpoint-synced block or forward from the last block, whichever makes more sense; backwards sounds better to me because it deals with more recent blocks).",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1748832558/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1749189938",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/13003#issuecomment-1749189938",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/13003",
    "id": 1749189938,
    "node_id": "IC_kwDOBvuov85oQoUy",
    "user": {
      "login": "kasey",
      "id": 489222,
      "node_id": "MDQ6VXNlcjQ4OTIyMg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/489222?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/kasey",
      "html_url": "https://github.com/kasey",
      "followers_url": "https://api.github.com/users/kasey/followers",
      "following_url": "https://api.github.com/users/kasey/following{/other_user}",
      "gists_url": "https://api.github.com/users/kasey/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/kasey/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/kasey/subscriptions",
      "organizations_url": "https://api.github.com/users/kasey/orgs",
      "repos_url": "https://api.github.com/users/kasey/repos",
      "events_url": "https://api.github.com/users/kasey/events{/privacy}",
      "received_events_url": "https://api.github.com/users/kasey/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-10-05T15:57:36Z",
    "updated_at": "2023-10-05T15:57:36Z",
    "author_association": "CONTRIBUTOR",
    "body": "> If I understand this properly, the scenario is as follows:\r\n> \r\n>     * I run a new node with checkpoint sync flags\r\n> \r\n>     * I am offline for a while\r\n> \r\n>     * I restart the node with checkpoint sync flags\r\n\r\nA far more common case is that the node restarts for any number of reasons - power failure, OOM, k8s rescheduling, upgrade to a new container image - and can easily catch up using the normal initial sync mechanism. In fact this is what happens today, and I'm sure it happens all the time. In this scenario, I don't think we typically want to request a new checkpoints state and block from the given url before allowing the node to start as usual.\r\n\r\nIn general I am coming from the perspective of \"principle of least surprise\" - what does the user expect to happen? I think initiating a checkpoint sync on every restart is more surprising than only initiating one on the first run.\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1749189938/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1749256191",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/13003#issuecomment-1749256191",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/13003",
    "id": 1749256191,
    "node_id": "IC_kwDOBvuov85oQ4f_",
    "user": {
      "login": "kasey",
      "id": 489222,
      "node_id": "MDQ6VXNlcjQ4OTIyMg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/489222?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/kasey",
      "html_url": "https://github.com/kasey",
      "followers_url": "https://api.github.com/users/kasey/followers",
      "following_url": "https://api.github.com/users/kasey/following{/other_user}",
      "gists_url": "https://api.github.com/users/kasey/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/kasey/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/kasey/subscriptions",
      "organizations_url": "https://api.github.com/users/kasey/orgs",
      "repos_url": "https://api.github.com/users/kasey/repos",
      "events_url": "https://api.github.com/users/kasey/events{/privacy}",
      "received_events_url": "https://api.github.com/users/kasey/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-10-05T16:21:39Z",
    "updated_at": "2023-10-05T16:21:39Z",
    "author_association": "CONTRIBUTOR",
    "body": "> let the user do a fresh checkpoint sync if they forget to remove the flags on restarts.\r\n\r\nI think your suggestion makes sense for people running a single node with systemd - they can edit an arg env file, start their node, then edit again without restarting. But I want to point out that for people using k8s, \"removing the flag\" essentially amounts to restarting the pod. I don't think we should require people to babysit their nodes to check if they've started syncing from a checkpoint state so they can know that it's time to overwrite the podspec to make sure it doesn't restart with the flag. It would also significantly complicate using any kind of configuration management tools.",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1749256191/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1749286078",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/13003#issuecomment-1749286078",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/13003",
    "id": 1749286078,
    "node_id": "IC_kwDOBvuov85oQ_y-",
    "user": {
      "login": "potuz",
      "id": 16044918,
      "node_id": "MDQ6VXNlcjE2MDQ0OTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/16044918?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/potuz",
      "html_url": "https://github.com/potuz",
      "followers_url": "https://api.github.com/users/potuz/followers",
      "following_url": "https://api.github.com/users/potuz/following{/other_user}",
      "gists_url": "https://api.github.com/users/potuz/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/potuz/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/potuz/subscriptions",
      "organizations_url": "https://api.github.com/users/potuz/orgs",
      "repos_url": "https://api.github.com/users/potuz/repos",
      "events_url": "https://api.github.com/users/potuz/events{/privacy}",
      "received_events_url": "https://api.github.com/users/potuz/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-10-05T16:40:05Z",
    "updated_at": "2023-10-05T16:40:05Z",
    "author_association": "CONTRIBUTOR",
    "body": "> But I want to point out that for people using k8s, \"removing the flag\" essentially amounts to restarting the pod.\r\n\r\nI am on the camp that we can require people that use these advanced setups like k8s and similar, are proficient enough to read the man pages and know that they can't keep a checkpoint sync flag in any permanent medium. ",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1749286078/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1750383071",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/13003#issuecomment-1750383071",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/13003",
    "id": 1750383071,
    "node_id": "IC_kwDOBvuov85oVLnf",
    "user": {
      "login": "rkapka",
      "id": 28876818,
      "node_id": "MDQ6VXNlcjI4ODc2ODE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/28876818?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rkapka",
      "html_url": "https://github.com/rkapka",
      "followers_url": "https://api.github.com/users/rkapka/followers",
      "following_url": "https://api.github.com/users/rkapka/following{/other_user}",
      "gists_url": "https://api.github.com/users/rkapka/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rkapka/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rkapka/subscriptions",
      "organizations_url": "https://api.github.com/users/rkapka/orgs",
      "repos_url": "https://api.github.com/users/rkapka/repos",
      "events_url": "https://api.github.com/users/rkapka/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rkapka/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-10-06T10:37:02Z",
    "updated_at": "2023-10-06T10:37:02Z",
    "author_association": "CONTRIBUTOR",
    "body": "A new `--checkpoint-sync-only-empty-db` flag maybe? If this flag is present, then checkpoint sync will not be invoked if there is a database already.",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/1750383071/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
