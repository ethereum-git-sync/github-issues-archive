{
  "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/5796",
  "repository_url": "https://api.github.com/repos/prysmaticlabs/prysm",
  "labels_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/5796/labels{/name}",
  "comments_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/5796/comments",
  "events_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/5796/events",
  "html_url": "https://github.com/prysmaticlabs/prysm/issues/5796",
  "id": 615267239,
  "node_id": "MDU6SXNzdWU2MTUyNjcyMzk=",
  "number": 5796,
  "title": "High rate of Goodbye logs / messages",
  "user": {
    "login": "prestonvanloon",
    "id": 7246818,
    "node_id": "MDQ6VXNlcjcyNDY4MTg=",
    "avatar_url": "https://avatars.githubusercontent.com/u/7246818?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/prestonvanloon",
    "html_url": "https://github.com/prestonvanloon",
    "followers_url": "https://api.github.com/users/prestonvanloon/followers",
    "following_url": "https://api.github.com/users/prestonvanloon/following{/other_user}",
    "gists_url": "https://api.github.com/users/prestonvanloon/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/prestonvanloon/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/prestonvanloon/subscriptions",
    "organizations_url": "https://api.github.com/users/prestonvanloon/orgs",
    "repos_url": "https://api.github.com/users/prestonvanloon/repos",
    "events_url": "https://api.github.com/users/prestonvanloon/events{/privacy}",
    "received_events_url": "https://api.github.com/users/prestonvanloon/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 802129904,
      "node_id": "MDU6TGFiZWw4MDIxMjk5MDQ=",
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/labels/Bug",
      "name": "Bug",
      "color": "ee0701",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 1500585773,
      "node_id": "MDU6TGFiZWwxNTAwNTg1Nzcz",
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/labels/Networking",
      "name": "Networking",
      "color": "c7a5f7",
      "default": false,
      "description": "P2P related items"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "nisdas",
    "id": 33201827,
    "node_id": "MDQ6VXNlcjMzMjAxODI3",
    "avatar_url": "https://avatars.githubusercontent.com/u/33201827?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/nisdas",
    "html_url": "https://github.com/nisdas",
    "followers_url": "https://api.github.com/users/nisdas/followers",
    "following_url": "https://api.github.com/users/nisdas/following{/other_user}",
    "gists_url": "https://api.github.com/users/nisdas/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/nisdas/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/nisdas/subscriptions",
    "organizations_url": "https://api.github.com/users/nisdas/orgs",
    "repos_url": "https://api.github.com/users/nisdas/repos",
    "events_url": "https://api.github.com/users/nisdas/events{/privacy}",
    "received_events_url": "https://api.github.com/users/nisdas/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "nisdas",
      "id": 33201827,
      "node_id": "MDQ6VXNlcjMzMjAxODI3",
      "avatar_url": "https://avatars.githubusercontent.com/u/33201827?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nisdas",
      "html_url": "https://github.com/nisdas",
      "followers_url": "https://api.github.com/users/nisdas/followers",
      "following_url": "https://api.github.com/users/nisdas/following{/other_user}",
      "gists_url": "https://api.github.com/users/nisdas/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nisdas/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nisdas/subscriptions",
      "organizations_url": "https://api.github.com/users/nisdas/orgs",
      "repos_url": "https://api.github.com/users/nisdas/repos",
      "events_url": "https://api.github.com/users/nisdas/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nisdas/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/milestones/9",
    "html_url": "https://github.com/prysmaticlabs/prysm/milestone/9",
    "labels_url": "https://api.github.com/repos/prysmaticlabs/prysm/milestones/9/labels",
    "id": 5304199,
    "node_id": "MDk6TWlsZXN0b25lNTMwNDE5OQ==",
    "number": 9,
    "title": "Multiclient Readiness",
    "description": "All tracking issues to be fully aligned for multiclient interoperability",
    "creator": {
      "login": "rauljordan",
      "id": 5572669,
      "node_id": "MDQ6VXNlcjU1NzI2Njk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5572669?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rauljordan",
      "html_url": "https://github.com/rauljordan",
      "followers_url": "https://api.github.com/users/rauljordan/followers",
      "following_url": "https://api.github.com/users/rauljordan/following{/other_user}",
      "gists_url": "https://api.github.com/users/rauljordan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rauljordan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rauljordan/subscriptions",
      "organizations_url": "https://api.github.com/users/rauljordan/orgs",
      "repos_url": "https://api.github.com/users/rauljordan/repos",
      "events_url": "https://api.github.com/users/rauljordan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rauljordan/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 0,
    "closed_issues": 8,
    "state": "closed",
    "created_at": "2020-04-13T18:01:14Z",
    "updated_at": "2020-10-06T17:15:25Z",
    "due_on": null,
    "closed_at": "2020-10-06T17:15:25Z"
  },
  "comments": 3,
  "created_at": "2020-05-09T21:54:16Z",
  "updated_at": "2020-05-11T20:34:39Z",
  "closed_at": "2020-05-11T20:34:39Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "# üêû Bug Report\r\n\r\n### Description\r\n\r\n@protolambda observed a high rate of Goodbye message logs at debug level https://github.com/prysmaticlabs/prysm/pull/5589#issuecomment-626233150\r\n\r\nBased on my observations, it looks like we might be sending multiple goodbye messages per peer. \r\n\r\n![Screenshot from 2020-05-09 14-42-36](https://user-images.githubusercontent.com/7246818/81485789-b1e01a80-9204-11ea-9176-3aa4137567f4.png)\r\n\r\n[Prylabs internal logs](https://kibana.prylabs.network/goto/873081efd6a6753438a9e8f253e6fd1a)\r\n\r\n### Has this worked before in a previous version?\r\n\r\nThe bug was introduced in #5589.\r\n\r\n## üî¨ Minimal Reproduction\r\n\r\nRun a beacon node with debug logging on.\r\n\r\n## üî• Error\r\n\r\nN/A\r\n\r\n## üåç  Your Environment\r\n\r\n**Operating System:**\r\n\r\nN/A\r\n\r\n**What version of Prysm are you running? (Which release)**\r\n\r\nAny after #5589 \r\n\r\n**Anything else relevant (validator index / public key)?**\r\n\r\n",
  "closed_by": {
    "login": "prestonvanloon",
    "id": 7246818,
    "node_id": "MDQ6VXNlcjcyNDY4MTg=",
    "avatar_url": "https://avatars.githubusercontent.com/u/7246818?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/prestonvanloon",
    "html_url": "https://github.com/prestonvanloon",
    "followers_url": "https://api.github.com/users/prestonvanloon/followers",
    "following_url": "https://api.github.com/users/prestonvanloon/following{/other_user}",
    "gists_url": "https://api.github.com/users/prestonvanloon/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/prestonvanloon/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/prestonvanloon/subscriptions",
    "organizations_url": "https://api.github.com/users/prestonvanloon/orgs",
    "repos_url": "https://api.github.com/users/prestonvanloon/repos",
    "events_url": "https://api.github.com/users/prestonvanloon/events{/privacy}",
    "received_events_url": "https://api.github.com/users/prestonvanloon/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/5796/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/5796/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/626240647",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/5796#issuecomment-626240647",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/5796",
    "id": 626240647,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyNjI0MDY0Nw==",
    "user": {
      "login": "protolambda",
      "id": 19571989,
      "node_id": "MDQ6VXNlcjE5NTcxOTg5",
      "avatar_url": "https://avatars.githubusercontent.com/u/19571989?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/protolambda",
      "html_url": "https://github.com/protolambda",
      "followers_url": "https://api.github.com/users/protolambda/followers",
      "following_url": "https://api.github.com/users/protolambda/following{/other_user}",
      "gists_url": "https://api.github.com/users/protolambda/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/protolambda/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/protolambda/subscriptions",
      "organizations_url": "https://api.github.com/users/protolambda/orgs",
      "repos_url": "https://api.github.com/users/protolambda/repos",
      "events_url": "https://api.github.com/users/protolambda/events{/privacy}",
      "received_events_url": "https://api.github.com/users/protolambda/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-09T21:56:39Z",
    "updated_at": "2020-05-09T21:56:39Z",
    "author_association": "NONE",
    "body": "Copying relevant Discord conversation:\r\n```\r\nDebug level logs, got me this:\r\n\r\nsudo docker logs 8cb989bbd69b 2>&1 | cut -c34- | grep -o -E \"peer=.{53}\" | sort | uniq | wc -l\r\n891\r\n\r\n891 unique peer ids seen on topaz for the last 4 days\r\n4 days of running in debug mode:\r\n\r\n$ sudo docker logs 8cb989bbd69b 2>&1 | cut -c34- | grep \"Goodbye\" | wc -l\r\n780398\r\n$ sudo docker logs 8cb989bbd69b 2>&1 | cut -c34- | grep \"Sending Goodbye message to peer\\\" Reason=\\\"fault/error\" | wc -l\r\n780509\r\n$ sudo docker logs 8cb989bbd69b 2>&1 | cut -c34- | grep \"Goodbye\" | wc -l\r\n780599\r\n$ sudo docker logs 8cb989bbd69b 2>&1 | cut -c34- | wc -l\r\n1889091\r\n\r\n\r\nThat's a lot of log messages...\r\nAnd yes, between running those commands, Goodbye RPC error lines increased by a few hundred\r\nprotoToday at 11:35 PM\r\ndocker image 9a7fbadca570, commit 2eac24cb79b0c847a74e3f8395ab5808c4059dce\r\n@prestonvanloon was the connection-attempt/goodbye-rpc spam here as well, if you prefer discord over github for chat\r\nprestonvanloonToday at 11:44 PM\r\nhi\r\ni am not 100% sure, what i am sseing in the logs is that we are logging multiple \"Sending Goodbye message to peer\" per peer ID per node\r\nsometimes as much as 50+ in a short time interval\r\ni am leaning more on the side of \"i am spamming someone\" rather than \"someone is spamming me\"\r\n@proto i think we need to use sync.Once or something, it really feels like the callback to send Goodbye is being sent multiple times\r\nI'll compile a new issue for Nishant to look at when he's available\r\nprotoToday at 11:48 PM\r\n\r\nExample line:\r\ntime=\"2020-05-09 21:37:24\" level=debug msg=\"Sending Goodbye message to peer\" Reason=\"fault/error\" peer=16Uiu2HAkvobXD4XYCpuzfXb2z7bEAB4GvXXeTbaEf5NXQR6YXq9w prefix=sync\r\n\r\n$ sudo docker logs 8cb989bbd69b 2>&1 | cut -c34- | grep \"Sending Goodbye message to peer\\\" Reason=\\\"fault/error\" | wc -l\r\n784068\r\n$ sudo docker logs 8cb989bbd69b 2>&1 | cut -c34- | grep \"Sending Goodbye message to peer\\\" Reason=\\\"fault/error\" | uniq | wc -l\r\n637455\r\n$ sudo docker logs 8cb989bbd69b 2>&1 | cut -c34- | grep \"Sending Goodbye message to peer\\\" Reason=\\\"fault/error\" | sort | uniq | wc -l\r\n838\r\n\r\nprestonvanloonToday at 11:49 PM\r\nonly 836 unique?\r\nprotoToday at 11:49 PM\r\nThere are definitely consecutive bursts of equal log messages.\r\nBut yes, only 836 unique (timestamp stripped off)\r\nprestonvanloonToday at 11:49 PM\r\ngotcha\r\nyeah we have seen this before where Prysm would send like 50 status messages on connection\r\nprotoToday at 11:50 PM\r\nAnd then when not sorted, uniq gets only consecutive duplicates\r\nprestonvanloonToday at 11:50 PM\r\nhopefully won't be too hard to fix, thanks for reporting, i don't think anyone had noticed since it's buried in debug log\r\nprotoToday at 11:51 PM\r\nyes, had to check my node since testnode stopped reporting to eth2stats, and other two topaz nodes are not syncing anymore. Still need to check those, but loaded with work\r\n\r\nsudo docker logs 8cb989bbd69b 2>&1 | cut -c34- | uniq | grep \"Sending Goodbye message to peer\\\" Reason=\\\"fault/error\" | wc -l\r\n740167\r\n\r\n40k less lines when removing pure (the very next line) duplicates\r\nSo yes, fully confirm it's either sending duplicates a lot, or connection problems follow after eachother very shortly\r\nprestonvanloonToday at 11:54 PM\r\nok great, yeah my pi died in the last few days too\r\nand users have been reporting higher resource usage in alpha.6\r\ncould be related\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/626240647/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/626942578",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/5796#issuecomment-626942578",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/5796",
    "id": 626942578,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyNjk0MjU3OA==",
    "user": {
      "login": "0xKiwi",
      "id": 6251510,
      "node_id": "MDQ6VXNlcjYyNTE1MTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6251510?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/0xKiwi",
      "html_url": "https://github.com/0xKiwi",
      "followers_url": "https://api.github.com/users/0xKiwi/followers",
      "following_url": "https://api.github.com/users/0xKiwi/following{/other_user}",
      "gists_url": "https://api.github.com/users/0xKiwi/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/0xKiwi/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/0xKiwi/subscriptions",
      "organizations_url": "https://api.github.com/users/0xKiwi/orgs",
      "repos_url": "https://api.github.com/users/0xKiwi/repos",
      "events_url": "https://api.github.com/users/0xKiwi/events{/privacy}",
      "received_events_url": "https://api.github.com/users/0xKiwi/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-11T20:28:10Z",
    "updated_at": "2020-05-11T20:28:10Z",
    "author_association": "CONTRIBUTOR",
    "body": "Update on this @nisdas ? Has the issue been solved with #5799?",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/626942578/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/626946611",
    "html_url": "https://github.com/prysmaticlabs/prysm/issues/5796#issuecomment-626946611",
    "issue_url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/5796",
    "id": 626946611,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyNjk0NjYxMQ==",
    "user": {
      "login": "prestonvanloon",
      "id": 7246818,
      "node_id": "MDQ6VXNlcjcyNDY4MTg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7246818?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/prestonvanloon",
      "html_url": "https://github.com/prestonvanloon",
      "followers_url": "https://api.github.com/users/prestonvanloon/followers",
      "following_url": "https://api.github.com/users/prestonvanloon/following{/other_user}",
      "gists_url": "https://api.github.com/users/prestonvanloon/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/prestonvanloon/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/prestonvanloon/subscriptions",
      "organizations_url": "https://api.github.com/users/prestonvanloon/orgs",
      "repos_url": "https://api.github.com/users/prestonvanloon/repos",
      "events_url": "https://api.github.com/users/prestonvanloon/events{/privacy}",
      "received_events_url": "https://api.github.com/users/prestonvanloon/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-11T20:34:39Z",
    "updated_at": "2020-05-11T20:34:39Z",
    "author_association": "MEMBER",
    "body": "I think this was fixed with #5799, github just didn't pick up on the \"fixes\" keyword with two issues listed.",
    "reactions": {
      "url": "https://api.github.com/repos/prysmaticlabs/prysm/issues/comments/626946611/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
