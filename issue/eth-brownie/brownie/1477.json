{
  "url": "https://api.github.com/repos/eth-brownie/brownie/issues/1477",
  "repository_url": "https://api.github.com/repos/eth-brownie/brownie",
  "labels_url": "https://api.github.com/repos/eth-brownie/brownie/issues/1477/labels{/name}",
  "comments_url": "https://api.github.com/repos/eth-brownie/brownie/issues/1477/comments",
  "events_url": "https://api.github.com/repos/eth-brownie/brownie/issues/1477/events",
  "html_url": "https://github.com/eth-brownie/brownie/issues/1477",
  "id": 1174161373,
  "node_id": "I_kwDOCUsNcc5F_Efd",
  "number": 1477,
  "title": "Support \"viaIR\" solc option",
  "user": {
    "login": "WyseNynja",
    "id": 624221,
    "node_id": "MDQ6VXNlcjYyNDIyMQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/624221?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/WyseNynja",
    "html_url": "https://github.com/WyseNynja",
    "followers_url": "https://api.github.com/users/WyseNynja/followers",
    "following_url": "https://api.github.com/users/WyseNynja/following{/other_user}",
    "gists_url": "https://api.github.com/users/WyseNynja/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/WyseNynja/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/WyseNynja/subscriptions",
    "organizations_url": "https://api.github.com/users/WyseNynja/orgs",
    "repos_url": "https://api.github.com/users/WyseNynja/repos",
    "events_url": "https://api.github.com/users/WyseNynja/events{/privacy}",
    "received_events_url": "https://api.github.com/users/WyseNynja/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2022-03-19T03:43:54Z",
  "updated_at": "2023-04-24T20:17:47Z",
  "closed_at": null,
  "author_association": "COLLABORATOR",
  "active_lock_reason": null,
  "body": "### Overview\r\n\r\nwith solidity 0.8.13, building with IR is no longer experimental. This can lead to smaller and more gas efficient contracts.\r\n\r\n### Specification\r\n\r\nA quick (incomplete) change:\r\n\r\n```\r\nmy-project $ git diff\r\ndiff --git a/brownie-config.yaml b/brownie-config.yaml\r\nindex ed34301..eae60df 100644\r\n--- a/brownie-config.yaml\r\n+++ b/brownie-config.yaml\r\n@@ -12,6 +12,7 @@ compiler:\r\n     remappings:\r\n       - \"@OpenZeppelin=OpenZeppelin/openzeppelin-contracts@4.5.0/contracts\"\r\n+    viaIR: False\r\n \r\n dependencies:\r\n   - OpenZeppelin/openzeppelin-contracts@4.5.0\r\ndiff --git a/tests/taxes/test_taxes_eth.py b/tests/taxes/test_taxes_eth.py\r\nindex 0ce8a6e..b1cc1f8 100644\r\n```\r\n```\r\nbrownie $ git diff\r\ndiff --git a/brownie/project/compiler/__init__.py b/brownie/project/compiler/__init__.py\r\nindex b19f6b34..d05af226 100644\r\n--- a/brownie/project/compiler/__init__.py\r\n+++ b/brownie/project/compiler/__init__.py\r\n@@ -58,6 +58,7 @@ def compile_and_format(\r\n     interface_sources: Optional[Dict[str, str]] = None,\r\n     remappings: Optional[list] = None,\r\n     optimizer: Optional[Dict] = None,\r\n+    viaIR: Optional[bool] = None,\r\n ) -> Dict:\r\n     \"\"\"Compiles contracts and returns build data.\r\n \r\n@@ -136,6 +137,7 @@ def compile_and_format(\r\n             interface_sources=interfaces,\r\n             remappings=remappings,\r\n             optimizer=optimizer,\r\n+            viaIR=viaIR,\r\n         )\r\n \r\n         output_json = compile_from_input_json(input_json, silent, allow_paths)\r\n@@ -153,6 +155,7 @@ def generate_input_json(\r\n     interface_sources: Optional[Dict[str, str]] = None,\r\n     remappings: Optional[list] = None,\r\n     optimizer: Optional[Dict] = None,\r\n+    viaIR: Optional[bool] = None,\r\n ) -> Dict:\r\n \r\n     \"\"\"Formats contracts to the standard solc input json.\r\n@@ -166,6 +169,7 @@ def generate_input_json(\r\n         interface_sources: dictionary of interfaces as {'path': \"source code\"}\r\n         remappings: list of solidity path remappings\r\n         optimizer: dictionary of solidity optimizer settings\r\n+        viaIR: Change compilation pipeline to go through the Yul intermediate representation.\r\n \r\n     Returns: dict\r\n     \"\"\"\r\n@@ -188,6 +192,8 @@ def generate_input_json(\r\n     if language == \"Solidity\":\r\n         input_json[\"settings\"][\"optimizer\"] = optimizer\r\n         input_json[\"settings\"][\"remappings\"] = _get_solc_remappings(remappings)\r\n+        if viaIR is not None:\r\n+            input_json[\"settings\"][\"viaIR\"] = viaIR\r\n     input_json[\"sources\"] = _sources_dict(contract_sources, language)\r\n \r\n     if interface_sources:\r\ndiff --git a/brownie/project/main.py b/brownie/project/main.py\r\nindex 7ab1f68b..6f459afc 100644\r\n--- a/brownie/project/main.py\r\n+++ b/brownie/project/main.py\r\n@@ -108,6 +108,7 @@ class _ProjectBase:\r\n                 allow_paths=allow_paths,\r\n                 remappings=compiler_config[\"solc\"].get(\"remappings\", []),\r\n                 optimizer=compiler_config[\"solc\"].get(\"optimizer\", None),\r\n+                viaIR=compiler_config[\"solc\"].get(\"viaIR\", None),\r\n             )\r\n         finally:\r\n             os.chdir(cwd)\r\n```\r\n\r\nHowever, that fails with this error:\r\n```\r\nmy-project $ brownie compile\r\nBrownie v1.18.1 - Python development framework for Ethereum\r\n\r\nCompiling contracts...\r\n  Solc version: 0.8.13\r\n  Optimizer: Enabled  Runs: 2000\r\n  EVM Version: London\r\nGenerating build data...\r\n - OpenZeppelin/openzeppelin-contracts@4.5.0/Clones\r\n - CloneFactory\r\n  File \"/home/ski/code/brownie/brownie/_cli/__main__.py\", line 64, in main\r\n    importlib.import_module(f\"brownie._cli.{cmd}\").main()\r\n  File \"/home/ski/code/brownie/brownie/_cli/compile.py\", line 50, in main\r\n    proj = project.load()\r\n  File \"/home/ski/code/brownie/brownie/project/main.py\", line 769, in load\r\n    return Project(name, project_path)\r\n  File \"/home/ski/code/brownie/brownie/project/main.py\", line 189, in __init__\r\n    self.load()\r\n  File \"/home/ski/code/brownie/brownie/project/main.py\", line 246, in load\r\n    self._compile(changed, self._compiler_config, False)\r\n  File \"/home/ski/code/brownie/brownie/project/main.py\", line 100, in _compile\r\n    build_json = compiler.compile_and_format(\r\n  File \"/home/ski/code/brownie/brownie/project/compiler/__init__.py\", line 144, in compile_and_format\r\n    build_json.update(generate_build_json(input_json, output_json, compiler_data, silent))\r\n  File \"/home/ski/code/brownie/brownie/project/compiler/__init__.py\", line 323, in generate_build_json\r\n    build_json[contract_alias] = solidity._get_unique_build_json(\r\n  File \"/home/ski/code/brownie/brownie/project/compiler/solidity.py\", line 260, in _get_unique_build_json\r\n    pc_map, statement_map, branch_map = _generate_coverage_data(\r\n  File \"/home/ski/code/brownie/brownie/project/compiler/solidity.py\", line 478, in _generate_coverage_data\r\n    fn_node = source_nodes[contract_id].children(\r\nIndexError: list index out of range\r\n```\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/eth-brownie/brownie/issues/1477/reactions",
    "total_count": 2,
    "+1": 1,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 1
  },
  "timeline_url": "https://api.github.com/repos/eth-brownie/brownie/issues/1477/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/eth-brownie/brownie/issues/comments/1171343889",
    "html_url": "https://github.com/eth-brownie/brownie/issues/1477#issuecomment-1171343889",
    "issue_url": "https://api.github.com/repos/eth-brownie/brownie/issues/1477",
    "id": 1171343889,
    "node_id": "IC_kwDOCUsNcc5F0UoR",
    "user": {
      "login": "Magicking",
      "id": 284088,
      "node_id": "MDQ6VXNlcjI4NDA4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/284088?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Magicking",
      "html_url": "https://github.com/Magicking",
      "followers_url": "https://api.github.com/users/Magicking/followers",
      "following_url": "https://api.github.com/users/Magicking/following{/other_user}",
      "gists_url": "https://api.github.com/users/Magicking/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Magicking/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Magicking/subscriptions",
      "organizations_url": "https://api.github.com/users/Magicking/orgs",
      "repos_url": "https://api.github.com/users/Magicking/repos",
      "events_url": "https://api.github.com/users/Magicking/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Magicking/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-06-30T15:12:11Z",
    "updated_at": "2022-06-30T15:12:11Z",
    "author_association": "CONTRIBUTOR",
    "body": "I opened up a pull request addressing this issue, it seems that the « list index out of range » happens when brownie is building up coverage data with the viaIR setting activated in solc-c.\r\n\r\nMy best guest is that as mentioned in https://github.com/ethereum/solidity/blob/develop/docs/ir-breaking-changes.rst#internal-function-pointers the dispatch function pointer is causing trouble for brownie to match with function call in the specified source code offset range as the code as been completely rewritten by the optimizer in such way that correlation is not easy to manage.\r\n\r\nThe fix is about ignoring those jump where code could not be matched within the specified source code offset, the alternative would have been to match the whole contract instead.",
    "reactions": {
      "url": "https://api.github.com/repos/eth-brownie/brownie/issues/comments/1171343889/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/eth-brownie/brownie/issues/comments/1272400687",
    "html_url": "https://github.com/eth-brownie/brownie/issues/1477#issuecomment-1272400687",
    "issue_url": "https://api.github.com/repos/eth-brownie/brownie/issues/1477",
    "id": 1272400687,
    "node_id": "IC_kwDOCUsNcc5L10sv",
    "user": {
      "login": "iskandr",
      "id": 48441,
      "node_id": "MDQ6VXNlcjQ4NDQx",
      "avatar_url": "https://avatars.githubusercontent.com/u/48441?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/iskandr",
      "html_url": "https://github.com/iskandr",
      "followers_url": "https://api.github.com/users/iskandr/followers",
      "following_url": "https://api.github.com/users/iskandr/following{/other_user}",
      "gists_url": "https://api.github.com/users/iskandr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/iskandr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/iskandr/subscriptions",
      "organizations_url": "https://api.github.com/users/iskandr/orgs",
      "repos_url": "https://api.github.com/users/iskandr/repos",
      "events_url": "https://api.github.com/users/iskandr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/iskandr/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-10-08T21:32:32Z",
    "updated_at": "2022-10-08T21:32:32Z",
    "author_association": "NONE",
    "body": "Curious if this ever got fixed",
    "reactions": {
      "url": "https://api.github.com/repos/eth-brownie/brownie/issues/comments/1272400687/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/eth-brownie/brownie/issues/comments/1342568736",
    "html_url": "https://github.com/eth-brownie/brownie/issues/1477#issuecomment-1342568736",
    "issue_url": "https://api.github.com/repos/eth-brownie/brownie/issues/1477",
    "id": 1342568736,
    "node_id": "IC_kwDOCUsNcc5QBfkg",
    "user": {
      "login": "Magicking",
      "id": 284088,
      "node_id": "MDQ6VXNlcjI4NDA4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/284088?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Magicking",
      "html_url": "https://github.com/Magicking",
      "followers_url": "https://api.github.com/users/Magicking/followers",
      "following_url": "https://api.github.com/users/Magicking/following{/other_user}",
      "gists_url": "https://api.github.com/users/Magicking/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Magicking/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Magicking/subscriptions",
      "organizations_url": "https://api.github.com/users/Magicking/orgs",
      "repos_url": "https://api.github.com/users/Magicking/repos",
      "events_url": "https://api.github.com/users/Magicking/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Magicking/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-08T11:25:06Z",
    "updated_at": "2022-12-08T11:25:06Z",
    "author_association": "CONTRIBUTOR",
    "body": "Nop PR is still opened, no comments so far on this, I wonder how many are blocked by this issue.",
    "reactions": {
      "url": "https://api.github.com/repos/eth-brownie/brownie/issues/comments/1342568736/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/eth-brownie/brownie/issues/comments/1520773308",
    "html_url": "https://github.com/eth-brownie/brownie/issues/1477#issuecomment-1520773308",
    "issue_url": "https://api.github.com/repos/eth-brownie/brownie/issues/1477",
    "id": 1520773308,
    "node_id": "IC_kwDOCUsNcc5apSi8",
    "user": {
      "login": "Magicking",
      "id": 284088,
      "node_id": "MDQ6VXNlcjI4NDA4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/284088?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Magicking",
      "html_url": "https://github.com/Magicking",
      "followers_url": "https://api.github.com/users/Magicking/followers",
      "following_url": "https://api.github.com/users/Magicking/following{/other_user}",
      "gists_url": "https://api.github.com/users/Magicking/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Magicking/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Magicking/subscriptions",
      "organizations_url": "https://api.github.com/users/Magicking/orgs",
      "repos_url": "https://api.github.com/users/Magicking/repos",
      "events_url": "https://api.github.com/users/Magicking/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Magicking/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-24T20:17:30Z",
    "updated_at": "2023-04-24T20:17:47Z",
    "author_association": "CONTRIBUTOR",
    "body": "PR got merged. You can test the code using the latest HEAD from the master branch of the eth-brownie repository and add `viaIR: True` to your solc compiler option as below\r\n\r\n```\r\n$> cat brownie-config.yaml\r\n[...]\r\ncompiler:\r\n  solc:\r\n    # viaIR option has been added in 0.8.13, you can adjust the version your need\r\n    version: 0.8.13\r\n    viaIR: True\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/eth-brownie/brownie/issues/comments/1520773308/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
