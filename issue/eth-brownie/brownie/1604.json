{
  "url": "https://api.github.com/repos/eth-brownie/brownie/issues/1604",
  "repository_url": "https://api.github.com/repos/eth-brownie/brownie",
  "labels_url": "https://api.github.com/repos/eth-brownie/brownie/issues/1604/labels{/name}",
  "comments_url": "https://api.github.com/repos/eth-brownie/brownie/issues/1604/comments",
  "events_url": "https://api.github.com/repos/eth-brownie/brownie/issues/1604/events",
  "html_url": "https://github.com/eth-brownie/brownie/issues/1604",
  "id": 1357105390,
  "node_id": "I_kwDOCUsNcc5Q48ju",
  "number": 1604,
  "title": "Contract verification fails with standard-json-input having linked libraries",
  "user": {
    "login": "Jeevan-J",
    "id": 25552262,
    "node_id": "MDQ6VXNlcjI1NTUyMjYy",
    "avatar_url": "https://avatars.githubusercontent.com/u/25552262?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Jeevan-J",
    "html_url": "https://github.com/Jeevan-J",
    "followers_url": "https://api.github.com/users/Jeevan-J/followers",
    "following_url": "https://api.github.com/users/Jeevan-J/following{/other_user}",
    "gists_url": "https://api.github.com/users/Jeevan-J/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Jeevan-J/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Jeevan-J/subscriptions",
    "organizations_url": "https://api.github.com/users/Jeevan-J/orgs",
    "repos_url": "https://api.github.com/users/Jeevan-J/repos",
    "events_url": "https://api.github.com/users/Jeevan-J/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Jeevan-J/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2022-08-31T10:03:28Z",
  "updated_at": "2022-10-09T20:24:38Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Environment information\r\n\r\n* `brownie` Version: 1.19.1\r\n* `solc` Version: 0.8.10\r\n* Python Version: 3.8.10\r\n* OS: win\r\n\r\n### What was wrong?\r\n\r\nI have two simple solidity files one of which is a library and other is a simple contract that uses the library. When I try to deploy with `publish_source=True`, verification of the contract fails in `polygonscan`, and `etherscan`. Source files and deployment code is given below:\r\n\r\nCNTestLib.sol\r\n```solidity\r\n// SPDX-License-Identifier: MIT\r\npragma solidity 0.8.10;\r\n\r\nlibrary CNTestLib {\r\n    function doStuff() public {\r\n    }\r\n}\r\n```\r\n\r\nSampleContract.sol\r\n```solidity\r\n// SPDX-License-Identifier: MIT\r\npragma solidity 0.8.10;\r\n\r\nimport {CNTestLib} from '../libraries/CNTestLib.sol';\r\n\r\ncontract SampleContract {\r\n    function get () public {\r\n        CNTestLib.doStuff();\r\n    }\r\n}\r\n```\r\n\r\nDeployment\r\n```python\r\nfrom brownie import accounts, web3, network\r\nimport brownie.project as project\r\n\r\nnetwork.connect('goerli')\r\np = project.load('.')\r\n\r\ndeployer = accounts[0]\r\n\r\ndeployerNonce = web3.eth.getTransactionCount(deployer.address)\r\np.CNTestLib.deploy(\r\n    {'from': deployer, 'nonce': deployerNonce},        \r\n    publish_source=True,\r\n)\r\ndeployerNonce = web3.eth.getTransactionCount(deployer.address)\r\np.SampleContract.deploy(\r\n    {'from': deployer, 'nonce': deployerNonce},        \r\n    publish_source=True,\r\n)\r\n```\r\n\r\noutput\r\n```\r\nTransaction sent: 0x79c411685454bc37b1c4511cdb5d7920c6ed9c27b087f53a9f6f62a5218d24d5\r\n  Gas price: 0.196101347 gwei   Gas limit: 88438   Nonce: 0\r\n  CNTestLib.constructor confirmed   Block: 7501903   Gas used: 80399 (90.91%)\r\n  CNTestLib deployed at: 0x184668E359E065a24505E8b60a2ACb89DAC9A968\r\n\r\nWaiting for https://api-goerli.etherscan.io/api to process contract...\r\nVerification submitted successfully. Waiting for result...\r\nVerification pending...\r\nVerification pending...\r\nVerification complete. Result: Success - Verified!\r\n\r\nTransaction sent: 0x17a37e9c882646b8cd98102a8a2ffa77d765c644294455b1beadcd7d13bbd571\r\n  Gas price: ansaction in the mempool... -0.210378886 gwei   Gas limit: 106032   Nonce: 1\r\n  SampleContract.constructor confirmed   Block: 7501914   Gas used: 96393 (90.91%)\r\n  SampleContract deployed at: 0x5F976555b9b0F8a9F8a600020333dD07c75D05B4\r\n\r\nWaiting for https://api-goerli.etherscan.io/api to process contract...\r\nVerification submitted successfully. Waiting for result...\r\nVerification pending...\r\nVerification pending...\r\nVerification complete. Result: Fail - Unable to verify\r\n```\r\n\r\n### How can it be fixed?\r\n\r\nAfter debugging and manual testing, I found the cause for the issue. Using `get_verification_info` function, I am able to generate the standard-json-input of the contract which looks like following:\r\n```json\r\n{\r\n    \"standard_json_input\": {\r\n        \"language\": \"Solidity\",\r\n        \"sources\": {\r\n            \"SampleContract.sol\": {\r\n                \"content\": \"// SPDX-License-Identifier: MIT\\npragma solidity 0.8.10;\\n\\nimport {CNTestLib} from \\\"CNTestLib.sol\\\";\\n\\ncontract SampleContract {\\n    function get () public {\\n        CNTestLib.doStuff();\\n    }\\n}\"\r\n            },\r\n            \"CNTestLib.sol\": {\r\n                \"content\": \"// SPDX-License-Identifier: MIT\\npragma solidity 0.8.10;\\n\\nlibrary CNTestLib {\\n    function doStuff() public {\\n    }\\n}\"\r\n            }\r\n        },\r\n        \"settings\": {\r\n            \"evmVersion\": \"istanbul\",\r\n            \"optimizer\": {\r\n                \"enabled\": true,\r\n                \"runs\": 200\r\n            },\r\n            \"libraries\": {\r\n                \"SampleContract.sol\": {\r\n                    \"CNTestLib\": \"0x184668E359E065a24505E8b60a2ACb89DAC9A968\"\r\n                }\r\n            }\r\n        }\r\n    },\r\n    \"contract_name\": \"SampleContract\",\r\n    \"compiler_version\": \"0.8.10+commit.fc410830\",\r\n    \"optimizer_enabled\": true,\r\n    \"optimizer_runs\": 200,\r\n    \"license_identifier\": \"MIT\",\r\n    \"bytecode_len\": 460\r\n}\r\n```\r\n\r\nWhen I try to verify the contract manually in [Goerli Testnet Explorer](https://goerli.etherscan.io/verifycontract) using the `standard_json_input`, I am getting the bytecode mismatch. After careful observation, etherscan is not able to identify the library address, and compiled bytecode is having `__$*****$__` which is a placeholder of library address. \r\n\r\nBut when I change the JSON content as follows, the verification is successful in polygonscan and etherscan\r\n```json\r\n            \"libraries\": {\r\n                \"SampleContract.sol\": {\r\n                    \"CNTestLib\": \"0x184668E359E065a24505E8b60a2ACb89DAC9A968\"\r\n                }\r\n            }\r\n```\r\nto\r\n```json\r\n            \"libraries\": {\r\n                \"CNTestLib.sol\": {\r\n                    \"CNTestLib\": \"0x184668E359E065a24505E8b60a2ACb89DAC9A968\"\r\n                }\r\n            }\r\n``` \r\n\r\nI think we need to fix the bug by updating the code in `https://github.com/eth-brownie/brownie/blob/4ae5f527ea86eb95766fe225a0f67620ffd36022/brownie/network/contract.py` at `line 313` to update the `key` to library source name instead of contract source name.",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/eth-brownie/brownie/issues/1604/reactions",
    "total_count": 1,
    "+1": 1,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/eth-brownie/brownie/issues/1604/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/eth-brownie/brownie/issues/comments/1233274343",
    "html_url": "https://github.com/eth-brownie/brownie/issues/1604#issuecomment-1233274343",
    "issue_url": "https://api.github.com/repos/eth-brownie/brownie/issues/1604",
    "id": 1233274343,
    "node_id": "IC_kwDOCUsNcc5JgkXn",
    "user": {
      "login": "Jeevan-J",
      "id": 25552262,
      "node_id": "MDQ6VXNlcjI1NTUyMjYy",
      "avatar_url": "https://avatars.githubusercontent.com/u/25552262?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Jeevan-J",
      "html_url": "https://github.com/Jeevan-J",
      "followers_url": "https://api.github.com/users/Jeevan-J/followers",
      "following_url": "https://api.github.com/users/Jeevan-J/following{/other_user}",
      "gists_url": "https://api.github.com/users/Jeevan-J/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Jeevan-J/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Jeevan-J/subscriptions",
      "organizations_url": "https://api.github.com/users/Jeevan-J/orgs",
      "repos_url": "https://api.github.com/users/Jeevan-J/repos",
      "events_url": "https://api.github.com/users/Jeevan-J/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Jeevan-J/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-31T18:27:13Z",
    "updated_at": "2022-08-31T18:27:13Z",
    "author_association": "NONE",
    "body": "## Possible fix\r\n\r\nUpdate the lines 308-315 in `https://github.com/eth-brownie/brownie/blob/4ae5f527ea86eb95766fe225a0f67620ffd36022/brownie/network/contract.py` as follows:\r\n\r\n```python\r\n                libs = {lib.strip(\"_\") for lib in re.findall(\"_{1,}[^_]*_{1,}\", self.bytecode)}\r\n                compiler_settings = {\r\n                    \"evmVersion\": self._build[\"compiler\"][\"evm_version\"],\r\n                    \"optimizer\": config[\"solc\"][\"optimizer\"],\r\n                    \"libraries\": {\r\n                        Path(source_fp).name: {lib: self._project[lib][-1].address for lib in libs}\r\n                    },\r\n                }\r\n```\r\nto\r\n```python\r\n                libs = {lib.strip(\"_\") for lib in re.findall(\"_{1,}[^_]*_{1,}\", self.bytecode)}\r\n                libraries = {}\r\n                for lib in libs:\r\n                    lib_source_fp = Path(self._sources.get_source_path(lib)).name\r\n                    if lib_source_fp in libraries:\r\n                        libraries[lib_source_fp][lib] = self._project[lib][-1].address\r\n                    else:\r\n                        libraries[lib_source_fp] = {lib: self._project[lib][-1].address}\r\n                compiler_settings = {\r\n                    \"evmVersion\": self._build[\"compiler\"][\"evm_version\"],\r\n                    \"optimizer\": config[\"solc\"][\"optimizer\"],\r\n                    \"libraries\": libraries,\r\n                }\r\n```\r\n\r\nHope this makes sense! ",
    "reactions": {
      "url": "https://api.github.com/repos/eth-brownie/brownie/issues/comments/1233274343/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/eth-brownie/brownie/issues/comments/1272621245",
    "html_url": "https://github.com/eth-brownie/brownie/issues/1604#issuecomment-1272621245",
    "issue_url": "https://api.github.com/repos/eth-brownie/brownie/issues/1604",
    "id": 1272621245,
    "node_id": "IC_kwDOCUsNcc5L2qi9",
    "user": {
      "login": "RiccardoBiffi",
      "id": 29223576,
      "node_id": "MDQ6VXNlcjI5MjIzNTc2",
      "avatar_url": "https://avatars.githubusercontent.com/u/29223576?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/RiccardoBiffi",
      "html_url": "https://github.com/RiccardoBiffi",
      "followers_url": "https://api.github.com/users/RiccardoBiffi/followers",
      "following_url": "https://api.github.com/users/RiccardoBiffi/following{/other_user}",
      "gists_url": "https://api.github.com/users/RiccardoBiffi/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/RiccardoBiffi/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/RiccardoBiffi/subscriptions",
      "organizations_url": "https://api.github.com/users/RiccardoBiffi/orgs",
      "repos_url": "https://api.github.com/users/RiccardoBiffi/repos",
      "events_url": "https://api.github.com/users/RiccardoBiffi/events{/privacy}",
      "received_events_url": "https://api.github.com/users/RiccardoBiffi/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-10-09T20:24:38Z",
    "updated_at": "2022-10-09T20:24:38Z",
    "author_association": "NONE",
    "body": "Please somebody fix this! Can't verify anything on goerli anymore",
    "reactions": {
      "url": "https://api.github.com/repos/eth-brownie/brownie/issues/comments/1272621245/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
