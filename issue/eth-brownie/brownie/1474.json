{
  "url": "https://api.github.com/repos/eth-brownie/brownie/issues/1474",
  "repository_url": "https://api.github.com/repos/eth-brownie/brownie",
  "labels_url": "https://api.github.com/repos/eth-brownie/brownie/issues/1474/labels{/name}",
  "comments_url": "https://api.github.com/repos/eth-brownie/brownie/issues/1474/comments",
  "events_url": "https://api.github.com/repos/eth-brownie/brownie/issues/1474/events",
  "html_url": "https://github.com/eth-brownie/brownie/issues/1474",
  "id": 1171533051,
  "node_id": "I_kwDOCUsNcc5F1Cz7",
  "number": 1474,
  "title": "Flattener remapping relative to source file instead of project root",
  "user": {
    "login": "mliudev",
    "id": 11674155,
    "node_id": "MDQ6VXNlcjExNjc0MTU1",
    "avatar_url": "https://avatars.githubusercontent.com/u/11674155?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mliudev",
    "html_url": "https://github.com/mliudev",
    "followers_url": "https://api.github.com/users/mliudev/followers",
    "following_url": "https://api.github.com/users/mliudev/following{/other_user}",
    "gists_url": "https://api.github.com/users/mliudev/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mliudev/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mliudev/subscriptions",
    "organizations_url": "https://api.github.com/users/mliudev/orgs",
    "repos_url": "https://api.github.com/users/mliudev/repos",
    "events_url": "https://api.github.com/users/mliudev/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mliudev/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2022-03-16T20:43:11Z",
  "updated_at": "2022-03-17T15:35:39Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Environment information\r\n\r\n* `brownie` Version: 1.18.1\r\n* `ganache` Version: ganache v7.0.3 (@ganache/cli: 0.1.4, @ganache/core: 0.1.4)\r\n* `solc` Version:  Solc version: 0.8.11\r\n* Python Version: Python 3.9.10\r\n* OS: osx\r\n\r\n### What was wrong?\r\n\r\nIn order to debug why I couldn't publish the source of my contracts to Etherscan I ran:\r\n\r\n`brownie console --network rinkeby`\r\n```python\r\n>>> MyContract.get_verification_info()\r\n  File \"<console>\", line 1, in <module>\r\n  File \"/Users/foo/git/brownie-fork/brownie/network/contract.py\", line 299, in get_verification_info\r\n    self._flattener = Flattener(source_fp, self._name, remaps, compiler_settings)\r\n  File \"/Users/foo/git/brownie-fork/brownie/project/flattener.py\", line 30, in __init__\r\n    self.traverse(primary_source_fp)\r\n  File \"/Users/foo/git/brownie-fork/brownie/project/flattener.py\", line 71, in traverse\r\n    self.traverse(import_path)\r\n  File \"/Users/foo/git/brownie-fork/brownie/project/flattener.py\", line 50, in traverse\r\n    source = fp_obj.read_text()\r\n  File \"/opt/homebrew/Cellar/python@3.9/3.9.10/Frameworks/Python.framework/Versions/3.9/lib/python3.9/pathlib.py\", line 1266, in read_text\r\n    with self.open(mode='r', encoding=encoding, errors=errors) as f:\r\n  File \"/opt/homebrew/Cellar/python@3.9/3.9.10/Frameworks/Python.framework/Versions/3.9/lib/python3.9/pathlib.py\", line 1252, in open\r\n    return io.open(self, mode, buffering, encoding, errors, newline,\r\n  File \"/opt/homebrew/Cellar/python@3.9/3.9.10/Frameworks/Python.framework/Versions/3.9/lib/python3.9/pathlib.py\", line 1120, in _opener\r\n    return self._accessor.open(self, flags, mode)\r\nFileNotFoundError: [Errno 2] No such file or directory: '/<redacted>/backend/contracts/manifold-extensions/lib/manifoldxyz/libraries-solidity/contracts/access/AdminControlUpgradeable.sol'\r\n```\r\n\r\nI have the following remappings:\r\n\r\n`brownie-config.yaml`\r\n```yaml\r\ncompiler:\r\n    evm_version: london\r\n    solc:\r\n        remappings:\r\n            - \"@openzeppelin/=lib/openzeppelin-contracts@4.5.0/\"\r\n            - \"@manifoldxyz/=lib/manifoldxyz/\"\r\n            - \"@openzeppelin/contracts-upgradeable/=lib/openzeppelin-contracts-upgradeable@4.5.2/contracts/\"\r\n```\r\n\r\nMy folder structure is:\r\n\r\n```bash\r\n.\r\n├── build\r\n│   ├── contracts\r\n│   ├── deployments\r\n│   │   └── 4\r\n│   └── interfaces\r\n├── contracts\r\n│   ├── BS.sol\r\n│   ├── ERC721Creator.sol\r\n│   └── manifold-extensions\r\n│       └── LazyMint.sol\r\n├── git-ignore\r\n├── interfaces\r\n├── lib\r\n│   ├── manifoldxyz\r\n│   │   ├── creator-core-extensions-solidity\r\n│   │   ├── creator-core-solidity\r\n│   │   └── libraries-solidity\r\n│   ├── openzeppelin-contracts-upgradeable@4.5.2\r\n│   │   └── contracts\r\n│   └── openzeppelin-contracts@4.5.0\r\n│       ├── contracts\r\n│       └── contracts-upgradeable\r\n```\r\n\r\nBrownie successfully compiles the contracts given the same remappings so it seems to me that the Flattener remaps imports relative to the source file instead of the project root like the compiler does. In my case the Flattener tries to traverse an import that's supposed to be remapped to `./lib/manifoldxyz` instead of `./contracts/manifold-extensions/lib/manifoldxyz`.\r\n\r\nRelevant code appears to be\r\n\r\nhttps://github.com/eth-brownie/brownie/blob/master/brownie/project/flattener.py#L127.\r\n\r\n### How can it be fixed?\r\n\r\nPresumably by fixing the flattener to flatten the same way the compiler does. While looking through the [tests](https://github.com/eth-brownie/brownie/blob/master/tests/network/contract/test_verification.py), it seems that the verification test passes with imports that aren't remapped elsewhere in the project structure.\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/eth-brownie/brownie/issues/1474/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/eth-brownie/brownie/issues/1474/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/eth-brownie/brownie/issues/comments/1069614442",
    "html_url": "https://github.com/eth-brownie/brownie/issues/1474#issuecomment-1069614442",
    "issue_url": "https://api.github.com/repos/eth-brownie/brownie/issues/1474",
    "id": 1069614442,
    "node_id": "IC_kwDOCUsNcc4_wQVq",
    "user": {
      "login": "mliudev",
      "id": 11674155,
      "node_id": "MDQ6VXNlcjExNjc0MTU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/11674155?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mliudev",
      "html_url": "https://github.com/mliudev",
      "followers_url": "https://api.github.com/users/mliudev/followers",
      "following_url": "https://api.github.com/users/mliudev/following{/other_user}",
      "gists_url": "https://api.github.com/users/mliudev/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mliudev/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mliudev/subscriptions",
      "organizations_url": "https://api.github.com/users/mliudev/orgs",
      "repos_url": "https://api.github.com/users/mliudev/repos",
      "events_url": "https://api.github.com/users/mliudev/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mliudev/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-03-16T20:45:05Z",
    "updated_at": "2022-03-17T15:35:39Z",
    "author_association": "NONE",
    "body": "Possibly related: \r\n* https://github.com/eth-brownie/brownie/issues/1456\r\n\r\nFound similar issue and fix:\r\n* https://github.com/eth-brownie/brownie/issues/1330\r\n* https://github.com/eth-brownie/brownie/pull/1331",
    "reactions": {
      "url": "https://api.github.com/repos/eth-brownie/brownie/issues/comments/1069614442/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
