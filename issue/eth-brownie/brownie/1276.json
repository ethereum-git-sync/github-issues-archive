{
  "url": "https://api.github.com/repos/eth-brownie/brownie/issues/1276",
  "repository_url": "https://api.github.com/repos/eth-brownie/brownie",
  "labels_url": "https://api.github.com/repos/eth-brownie/brownie/issues/1276/labels{/name}",
  "comments_url": "https://api.github.com/repos/eth-brownie/brownie/issues/1276/comments",
  "events_url": "https://api.github.com/repos/eth-brownie/brownie/issues/1276/events",
  "html_url": "https://github.com/eth-brownie/brownie/issues/1276",
  "id": 1017013109,
  "node_id": "I_kwDOCUsNcc48nmN1",
  "number": 1276,
  "title": "internal transfers not matching etherscan's output",
  "user": {
    "login": "WyseNynja",
    "id": 624221,
    "node_id": "MDQ6VXNlcjYyNDIyMQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/624221?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/WyseNynja",
    "html_url": "https://github.com/WyseNynja",
    "followers_url": "https://api.github.com/users/WyseNynja/followers",
    "following_url": "https://api.github.com/users/WyseNynja/following{/other_user}",
    "gists_url": "https://api.github.com/users/WyseNynja/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/WyseNynja/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/WyseNynja/subscriptions",
    "organizations_url": "https://api.github.com/users/WyseNynja/orgs",
    "repos_url": "https://api.github.com/users/WyseNynja/repos",
    "events_url": "https://api.github.com/users/WyseNynja/events{/privacy}",
    "received_events_url": "https://api.github.com/users/WyseNynja/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2021-10-05T23:02:24Z",
  "updated_at": "2022-04-06T02:12:54Z",
  "closed_at": null,
  "author_association": "COLLABORATOR",
  "active_lock_reason": null,
  "body": "### Environment information\r\n\r\n* `brownie` Version: 1.16.3\r\n\r\n### What was wrong?\r\n\r\nhttps://etherscan.io/tx/0xb7d7f1d5ce7743e821d3026647df486f517946ef1342a1ae93c96e4a8016eab7\r\n\r\n```\r\nTRANSFER  322.64783493805211761 Ether From 0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2 To  0xf14f0648435cf34f8bc800d4e71ff0ba15bc52dd\r\nTRANSFER  322.64783493805211761 Ether From 0xf14f0648435cf34f8bc800d4e71ff0ba15bc52dd To  0x4031064525292eaeb0dae34bbf5759e85cde09ad\r\nTRANSFER  322.64783493805211761 Ether From 0x4031064525292eaeb0dae34bbf5759e85cde09ad To  0xf14f0648435cf34f8bc800d4e71ff0ba15bc52dd\r\nTRANSFER  322.64783493805211761 Ether From 0xf14f0648435cf34f8bc800d4e71ff0ba15bc52dd To  0x4ddc2d193948926d02f9b1fe9e1daa0718270ed5\r\n```\r\n\r\nHowever, when I look at it in brownie: \r\n```\r\n>>> tx.internal_transfers\r\n[\r\n  {'from': '0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2', 'to': '0xF14f0648435CF34f8bC800d4E71FF0Ba15bC52dD', 'value': 322647834938052117610},\r\n  {'from': '0x00c47B2Ac6C298d33DCd53Adb48F3d678BD0E561', 'to': '0x4031064525292eaeb0dAE34Bbf5759E85CdE09Ad', 'value': 322647834938052117610},\r\n  {'from': '0x4031064525292eaeb0dAE34Bbf5759E85CdE09Ad', 'to': '0xF14f0648435CF34f8bC800d4E71FF0Ba15bC52dD', 'value': 322647834938052117610},\r\n  {'from': '0x1c27Be6D7146eb9273DB1d22Eb860b9E85854EEa', 'to': '0x4Ddc2D193948926D02f9B1fE9e1daa0718270ED5', 'value': 322647834938052117610}]\r\n```\r\n\r\nNotice that the second and fourth \"from\" are 0x00c47B2Ac6C298d33DCd53Adb48F3d678BD0E561 or 0x1c27Be6D7146eb9273DB1d22Eb860b9E85854EEa.\r\n\r\nI expect them to be 0xf14f0648435cf34f8bc800d4e71ff0ba15bc52dd.\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/eth-brownie/brownie/issues/1276/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/eth-brownie/brownie/issues/1276/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/eth-brownie/brownie/issues/comments/936972908",
    "html_url": "https://github.com/eth-brownie/brownie/issues/1276#issuecomment-936972908",
    "issue_url": "https://api.github.com/repos/eth-brownie/brownie/issues/1276",
    "id": 936972908,
    "node_id": "IC_kwDOCUsNcc432RJs",
    "user": {
      "login": "WyseNynja",
      "id": 624221,
      "node_id": "MDQ6VXNlcjYyNDIyMQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/624221?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/WyseNynja",
      "html_url": "https://github.com/WyseNynja",
      "followers_url": "https://api.github.com/users/WyseNynja/followers",
      "following_url": "https://api.github.com/users/WyseNynja/following{/other_user}",
      "gists_url": "https://api.github.com/users/WyseNynja/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/WyseNynja/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/WyseNynja/subscriptions",
      "organizations_url": "https://api.github.com/users/WyseNynja/orgs",
      "repos_url": "https://api.github.com/users/WyseNynja/repos",
      "events_url": "https://api.github.com/users/WyseNynja/events{/privacy}",
      "received_events_url": "https://api.github.com/users/WyseNynja/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-10-06T19:31:47Z",
    "updated_at": "2021-10-06T19:31:47Z",
    "author_association": "COLLABORATOR",
    "body": "Here's another one that is different. I'm not sure which is correct.\r\n\r\n```\r\n>>> chain.get_transaction(\"0x0537316f37627655b7fe5e50e23f71cd835b377d1cde4226443c94723d036e32\").internal_transfers\r\n[\r\n    {\r\n        'from': \"0x533c8844bA1922b88d892aCA090df0cC0c292F1b\",\r\n        'to': \"0x61935CbDd02287B511119DDb11Aeb42F1593b7Ef\",\r\n        'value': 20160000000000000\r\n    },\r\n    {\r\n        'from': \"0x61935CbDd02287B511119DDb11Aeb42F1593b7Ef\",\r\n        'to': \"0xa26e80e7Dea86279c6d778D702Cc413E6CFfA777\",\r\n        'value': 6650000000000000\r\n    },\r\n    {\r\n        'from': \"0x61935CbDd02287B511119DDb11Aeb42F1593b7Ef\",\r\n        'to': \"0xF14f0648435CF34f8bC800d4E71FF0Ba15bC52dD\",\r\n        'value': 13510000000000000\r\n    },\r\n    {\r\n        'from': \"0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2\",\r\n        'to': \"0xF14f0648435CF34f8bC800d4E71FF0Ba15bC52dD\",\r\n        'value': 44431261990481152968\r\n    },\r\n    {\r\n        'from': \"0x533c8844bA1922b88d892aCA090df0cC0c292F1b\",\r\n        'to': \"0x4Ddc2D193948926D02f9B1fE9e1daa0718270ED5\",\r\n        'value': 44424611990481152968\r\n    },\r\n    {\r\n        'from': \"0x533c8844bA1922b88d892aCA090df0cC0c292F1b\",\r\n        'to': \"0x5668EAd1eDB8E2a4d724C8fb9cB5fFEabEB422dc\",\r\n        'value': 20160000000000000\r\n    }\r\n]\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/eth-brownie/brownie/issues/comments/936972908/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/eth-brownie/brownie/issues/comments/1089603852",
    "html_url": "https://github.com/eth-brownie/brownie/issues/1276#issuecomment-1089603852",
    "issue_url": "https://api.github.com/repos/eth-brownie/brownie/issues/1276",
    "id": 1089603852,
    "node_id": "IC_kwDOCUsNcc5A8gkM",
    "user": {
      "login": "WyseNynja",
      "id": 624221,
      "node_id": "MDQ6VXNlcjYyNDIyMQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/624221?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/WyseNynja",
      "html_url": "https://github.com/WyseNynja",
      "followers_url": "https://api.github.com/users/WyseNynja/followers",
      "following_url": "https://api.github.com/users/WyseNynja/following{/other_user}",
      "gists_url": "https://api.github.com/users/WyseNynja/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/WyseNynja/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/WyseNynja/subscriptions",
      "organizations_url": "https://api.github.com/users/WyseNynja/orgs",
      "repos_url": "https://api.github.com/users/WyseNynja/repos",
      "events_url": "https://api.github.com/users/WyseNynja/events{/privacy}",
      "received_events_url": "https://api.github.com/users/WyseNynja/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-04-06T01:04:07Z",
    "updated_at": "2022-04-06T01:04:07Z",
    "author_association": "COLLABORATOR",
    "body": "I think I see why this is broken. It is looking at the last address, but the last call was a delegate call, so in this case it needs to look back two addresses. not sure how to do that yet",
    "reactions": {
      "url": "https://api.github.com/repos/eth-brownie/brownie/issues/comments/1089603852/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/eth-brownie/brownie/issues/comments/1089617383",
    "html_url": "https://github.com/eth-brownie/brownie/issues/1276#issuecomment-1089617383",
    "issue_url": "https://api.github.com/repos/eth-brownie/brownie/issues/1276",
    "id": 1089617383,
    "node_id": "IC_kwDOCUsNcc5A8j3n",
    "user": {
      "login": "WyseNynja",
      "id": 624221,
      "node_id": "MDQ6VXNlcjYyNDIyMQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/624221?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/WyseNynja",
      "html_url": "https://github.com/WyseNynja",
      "followers_url": "https://api.github.com/users/WyseNynja/followers",
      "following_url": "https://api.github.com/users/WyseNynja/following{/other_user}",
      "gists_url": "https://api.github.com/users/WyseNynja/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/WyseNynja/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/WyseNynja/subscriptions",
      "organizations_url": "https://api.github.com/users/WyseNynja/orgs",
      "repos_url": "https://api.github.com/users/WyseNynja/repos",
      "events_url": "https://api.github.com/users/WyseNynja/events{/privacy}",
      "received_events_url": "https://api.github.com/users/WyseNynja/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-04-06T01:19:13Z",
    "updated_at": "2022-04-06T01:19:32Z",
    "author_association": "COLLABORATOR",
    "body": "Something in this needs to change to check if last[\"address\"] was delegate called. I'm not sure how we should do that. \r\n\r\nhttps://github.com/eth-brownie/brownie/blob/master/brownie/network/transaction.py#L912-L915",
    "reactions": {
      "url": "https://api.github.com/repos/eth-brownie/brownie/issues/comments/1089617383/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/eth-brownie/brownie/issues/comments/1089637758",
    "html_url": "https://github.com/eth-brownie/brownie/issues/1276#issuecomment-1089637758",
    "issue_url": "https://api.github.com/repos/eth-brownie/brownie/issues/1276",
    "id": 1089637758,
    "node_id": "IC_kwDOCUsNcc5A8o1-",
    "user": {
      "login": "WyseNynja",
      "id": 624221,
      "node_id": "MDQ6VXNlcjYyNDIyMQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/624221?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/WyseNynja",
      "html_url": "https://github.com/WyseNynja",
      "followers_url": "https://api.github.com/users/WyseNynja/followers",
      "following_url": "https://api.github.com/users/WyseNynja/following{/other_user}",
      "gists_url": "https://api.github.com/users/WyseNynja/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/WyseNynja/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/WyseNynja/subscriptions",
      "organizations_url": "https://api.github.com/users/WyseNynja/orgs",
      "repos_url": "https://api.github.com/users/WyseNynja/repos",
      "events_url": "https://api.github.com/users/WyseNynja/events{/privacy}",
      "received_events_url": "https://api.github.com/users/WyseNynja/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-04-06T01:40:58Z",
    "updated_at": "2022-04-06T01:40:58Z",
    "author_association": "COLLABORATOR",
    "body": "This might fix it:\r\n\r\n```\r\ndiff --git a/brownie/network/transaction.py b/brownie/network/transaction.py\r\nindex b1c98813..2f72b730 100644\r\n--- a/brownie/network/transaction.py\r\n+++ b/brownie/network/transaction.py\r\n@@ -845,7 +845,7 @@ class TransactionReceipt:\r\n                 self._call_cost = self.gas_used - trace[0][\"gas\"] + trace[-1][\"gas\"]\r\n \r\n         # last_map gives a quick reference of previous values at each depth\r\n-        last_map = {0: _get_last_map(self.receiver, self.input[:10])}  # type: ignore\r\n+        last_map = {0: _get_last_map(self.receiver, self.input[:10], False)}  # type: ignore\r\n         coverage_eval: Dict = {last_map[0][\"name\"]: {}}\r\n         precompile_contract = re.compile(r\"0x0{38}(?:0[1-9]|1[0-8])\")\r\n         call_opcodes = (\"CALL\", \"STATICCALL\", \"DELEGATECALL\")\r\n@@ -874,7 +874,7 @@ class TransactionReceipt:\r\n                     address = step[\"stack\"][-2][-40:]\r\n \r\n                 if is_depth_increase:\r\n-                    last_map[trace[i][\"depth\"]] = _get_last_map(address, sig)\r\n+                    last_map[trace[i][\"depth\"]] = _get_last_map(address, sig, step[\"op\"] == \"DELEGATECALL\")\r\n                     coverage_eval.setdefault(last_map[trace[i][\"depth\"]][\"name\"], {})\r\n \r\n                 self._subcalls.append(\r\n@@ -910,8 +910,14 @@ class TransactionReceipt:\r\n \r\n             opcode = trace[i][\"op\"]\r\n             if opcode == \"CALL\" and int(trace[i][\"stack\"][-3], 16):\r\n+                # if last[\"address\"] was delegatecalled, `last[\"address\"]` is not the from. we need to keep going up\r\n+                from_data = last\r\n+                from_depth = trace[i][\"depth\"]\r\n+                while from_data[\"delegated\"]:\r\n+                    from_depth -= 1\r\n+                    from_data = last_map[from_depth]\r\n                 self._add_internal_xfer(\r\n-                    last[\"address\"], trace[i][\"stack\"][-2][-40:], trace[i][\"stack\"][-3]\r\n+                    from_data[\"address\"], trace[i][\"stack\"][-2][-40:], trace[i][\"stack\"][-3]\r\n                 )\r\n \r\n             try:\r\n@@ -1405,9 +1411,9 @@ def _get_memory(step: Dict, idx: int) -> HexBytes:\r\n     return data\r\n \r\n \r\n-def _get_last_map(address: EthAddress, sig: str) -> Dict:\r\n+def _get_last_map(address: EthAddress, sig: str, delegated: bool) -> Dict:\r\n     contract = state._find_contract(address)\r\n-    last_map = {\"address\": EthAddress(address), \"jumpDepth\": 0, \"name\": None, \"coverage\": False}\r\n+    last_map = {\"address\": EthAddress(address), \"jumpDepth\": 0, \"name\": None, \"coverage\": False, \"delegated\": delegated}\r\n \r\n     if contract:\r\n         if contract.get_method(sig):\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/eth-brownie/brownie/issues/comments/1089637758/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/eth-brownie/brownie/issues/comments/1089671392",
    "html_url": "https://github.com/eth-brownie/brownie/issues/1276#issuecomment-1089671392",
    "issue_url": "https://api.github.com/repos/eth-brownie/brownie/issues/1276",
    "id": 1089671392,
    "node_id": "IC_kwDOCUsNcc5A8xDg",
    "user": {
      "login": "WyseNynja",
      "id": 624221,
      "node_id": "MDQ6VXNlcjYyNDIyMQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/624221?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/WyseNynja",
      "html_url": "https://github.com/WyseNynja",
      "followers_url": "https://api.github.com/users/WyseNynja/followers",
      "following_url": "https://api.github.com/users/WyseNynja/following{/other_user}",
      "gists_url": "https://api.github.com/users/WyseNynja/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/WyseNynja/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/WyseNynja/subscriptions",
      "organizations_url": "https://api.github.com/users/WyseNynja/orgs",
      "repos_url": "https://api.github.com/users/WyseNynja/repos",
      "events_url": "https://api.github.com/users/WyseNynja/events{/privacy}",
      "received_events_url": "https://api.github.com/users/WyseNynja/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-04-06T02:12:54Z",
    "updated_at": "2022-04-06T02:12:54Z",
    "author_association": "COLLABORATOR",
    "body": "Did some tests locally. I think that diff fixes it as cleanly as possible.\r\n\r\nWe probably need the same check inside the contract creation code.",
    "reactions": {
      "url": "https://api.github.com/repos/eth-brownie/brownie/issues/comments/1089671392/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
