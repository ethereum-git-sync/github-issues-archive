{
  "url": "https://api.github.com/repos/eth-brownie/brownie/issues/1191",
  "repository_url": "https://api.github.com/repos/eth-brownie/brownie",
  "labels_url": "https://api.github.com/repos/eth-brownie/brownie/issues/1191/labels{/name}",
  "comments_url": "https://api.github.com/repos/eth-brownie/brownie/issues/1191/comments",
  "events_url": "https://api.github.com/repos/eth-brownie/brownie/issues/1191/events",
  "html_url": "https://github.com/eth-brownie/brownie/issues/1191",
  "id": 964347248,
  "node_id": "MDU6SXNzdWU5NjQzNDcyNDg=",
  "number": 1191,
  "title": "Logic to determine gas limit for reverting transactions conflicts with EIP-1559 logic",
  "user": {
    "login": "christianb93",
    "id": 37038420,
    "node_id": "MDQ6VXNlcjM3MDM4NDIw",
    "avatar_url": "https://avatars.githubusercontent.com/u/37038420?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/christianb93",
    "html_url": "https://github.com/christianb93",
    "followers_url": "https://api.github.com/users/christianb93/followers",
    "following_url": "https://api.github.com/users/christianb93/following{/other_user}",
    "gists_url": "https://api.github.com/users/christianb93/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/christianb93/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/christianb93/subscriptions",
    "organizations_url": "https://api.github.com/users/christianb93/orgs",
    "repos_url": "https://api.github.com/users/christianb93/repos",
    "events_url": "https://api.github.com/users/christianb93/events{/privacy}",
    "received_events_url": "https://api.github.com/users/christianb93/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2021-08-09T20:30:11Z",
  "updated_at": "2021-08-10T06:44:42Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Environment information\r\n\r\n* `brownie` Version: v1.14.6\r\n* `solc` Version: 0.8.6\r\n* Python Version: 3.8\r\n* OS: Ubuntu 20.04\r\n\r\n### What was wrong?\r\n\r\nI am using Brownie together with Go-Ethereum (geth) 1.10.6, i.e. post-EIP-1559. I am testing a contract that has a function that always reverts. When I submit a transaction to this method using Brownie, geth will not mine the transaction as the gas limit exceeds the block gas limit.\r\n\r\nTo reproduce:\r\n* run `geth --dev --http --verbosity=5`\r\n* Start brownie console, set network.gas_limit and network.gas_price to auto, deploy contract and run a transaction\r\n\r\n```\r\nme = accounts[0]\r\nnetwork.gas_limit(\"auto\")\r\nnetwork.gas_price(\"auto\")\r\nreverts = Reverts.deploy({\"from\": me})\r\nreverts.fail({\"from\": me})\r\n```\r\n\r\nThe transaction gets stuck and is never mined. Looking at the output of geth, the gas limit of the transaction exceeds the block gas limit.\r\n\r\n### How can it be fixed?\r\n\r\nAfter looking a bit at the source code, I think the following happens.\r\n\r\n* We eventually end up in _make_transaction in accounts.py\r\n* as the transaction does not contain a gas limit, we proceed to _gas_limit and eventually to estimate_gas\r\n* during the gas estimation, the transaction reverts (as expected)\r\n* we check the network configuration and find that reverting_tx_gas_limit is set, as we are on the development network\r\n* so we take the block gas limit from the current (!) block\r\n\r\nThe problem is that Go-Ethereum will, when starting to work on a new block, initialize a new gas pool with a gas limit which, by the rules of EIP-1559, is **below** the gas limit of the current tip of the chain, because the first block (containing only the deployment) was almost empty. So our transaction exceeds this limit and is never mined.\r\n\r\nIf I add an explicit gas limit to the transaction, the gas estimation is avoided and everything works like a charm - the transaction is mined, and I get a receipt with status zero.\r\n\r\nNo idea what an easy fix could be, unless you want to duplicate the EIP-1559 gas limit adjustment logic - but at least this issue might serve as documentation of others run into the same problem ",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/eth-brownie/brownie/issues/1191/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/eth-brownie/brownie/issues/1191/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/eth-brownie/brownie/issues/comments/895771515",
    "html_url": "https://github.com/eth-brownie/brownie/issues/1191#issuecomment-895771515",
    "issue_url": "https://api.github.com/repos/eth-brownie/brownie/issues/1191",
    "id": 895771515,
    "node_id": "IC_kwDOCUsNcc41ZGN7",
    "user": {
      "login": "christianb93",
      "id": 37038420,
      "node_id": "MDQ6VXNlcjM3MDM4NDIw",
      "avatar_url": "https://avatars.githubusercontent.com/u/37038420?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/christianb93",
      "html_url": "https://github.com/christianb93",
      "followers_url": "https://api.github.com/users/christianb93/followers",
      "following_url": "https://api.github.com/users/christianb93/following{/other_user}",
      "gists_url": "https://api.github.com/users/christianb93/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/christianb93/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/christianb93/subscriptions",
      "organizations_url": "https://api.github.com/users/christianb93/orgs",
      "repos_url": "https://api.github.com/users/christianb93/repos",
      "events_url": "https://api.github.com/users/christianb93/events{/privacy}",
      "received_events_url": "https://api.github.com/users/christianb93/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-08-10T06:44:42Z",
    "updated_at": "2021-08-10T06:44:42Z",
    "author_association": "NONE",
    "body": "Correction: I realized that geth will now always try to move the block gas limit towards the target determined via the parameter miner.gastarget, which is 8000000 by default, so it will adjust it downwards in our setup (has nothing to do with how utilized the previous block is)\r\n\r\nMaybe this could work as a quick fix: even with EIP-1559, the block gas limit can only be adjusted by a fraction of 1/1024 per block. So we should be on the safe side when we just do:\r\n\r\n```\r\nif revert_gas_limit == \"max\":\r\n    revert_gas_limit = web3.eth.get_block(\"latest\")[\"gasLimit\"]*BLOCK_GAS_LIMIT_ADJUSTMENT\r\n```\r\n\r\nwith a constant `BLOCK_GAS_LIMIT_ADJUSTMENT` which is a bit smaller than 1 - 1/1024.  This would then always be slightly smaller than the actual gas limit of the block just being mined",
    "reactions": {
      "url": "https://api.github.com/repos/eth-brownie/brownie/issues/comments/895771515/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
