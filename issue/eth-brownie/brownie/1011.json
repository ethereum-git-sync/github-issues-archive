{
  "url": "https://api.github.com/repos/eth-brownie/brownie/issues/1011",
  "repository_url": "https://api.github.com/repos/eth-brownie/brownie",
  "labels_url": "https://api.github.com/repos/eth-brownie/brownie/issues/1011/labels{/name}",
  "comments_url": "https://api.github.com/repos/eth-brownie/brownie/issues/1011/comments",
  "events_url": "https://api.github.com/repos/eth-brownie/brownie/issues/1011/events",
  "html_url": "https://github.com/eth-brownie/brownie/issues/1011",
  "id": 837030753,
  "node_id": "MDU6SXNzdWU4MzcwMzA3NTM=",
  "number": 1011,
  "title": "Multicall context manager",
  "user": {
    "login": "iamdefinitelyahuman",
    "id": 35276322,
    "node_id": "MDQ6VXNlcjM1Mjc2MzIy",
    "avatar_url": "https://avatars.githubusercontent.com/u/35276322?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/iamdefinitelyahuman",
    "html_url": "https://github.com/iamdefinitelyahuman",
    "followers_url": "https://api.github.com/users/iamdefinitelyahuman/followers",
    "following_url": "https://api.github.com/users/iamdefinitelyahuman/following{/other_user}",
    "gists_url": "https://api.github.com/users/iamdefinitelyahuman/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/iamdefinitelyahuman/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/iamdefinitelyahuman/subscriptions",
    "organizations_url": "https://api.github.com/users/iamdefinitelyahuman/orgs",
    "repos_url": "https://api.github.com/users/iamdefinitelyahuman/repos",
    "events_url": "https://api.github.com/users/iamdefinitelyahuman/events{/privacy}",
    "received_events_url": "https://api.github.com/users/iamdefinitelyahuman/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1114236590,
      "node_id": "MDU6TGFiZWwxMTE0MjM2NTkw",
      "url": "https://api.github.com/repos/eth-brownie/brownie/labels/enhancement",
      "name": "enhancement",
      "color": "a2eeef",
      "default": true,
      "description": "New feature or request"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": {
    "url": "https://api.github.com/repos/eth-brownie/brownie/milestones/13",
    "html_url": "https://github.com/eth-brownie/brownie/milestone/13",
    "labels_url": "https://api.github.com/repos/eth-brownie/brownie/milestones/13/labels",
    "id": 6870201,
    "node_id": "MDk6TWlsZXN0b25lNjg3MDIwMQ==",
    "number": 13,
    "title": "Brownie 1.15.0",
    "description": "Issues to complete for the next minor release.",
    "creator": {
      "login": "iamdefinitelyahuman",
      "id": 35276322,
      "node_id": "MDQ6VXNlcjM1Mjc2MzIy",
      "avatar_url": "https://avatars.githubusercontent.com/u/35276322?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/iamdefinitelyahuman",
      "html_url": "https://github.com/iamdefinitelyahuman",
      "followers_url": "https://api.github.com/users/iamdefinitelyahuman/followers",
      "following_url": "https://api.github.com/users/iamdefinitelyahuman/following{/other_user}",
      "gists_url": "https://api.github.com/users/iamdefinitelyahuman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/iamdefinitelyahuman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/iamdefinitelyahuman/subscriptions",
      "organizations_url": "https://api.github.com/users/iamdefinitelyahuman/orgs",
      "repos_url": "https://api.github.com/users/iamdefinitelyahuman/repos",
      "events_url": "https://api.github.com/users/iamdefinitelyahuman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/iamdefinitelyahuman/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 4,
    "closed_issues": 8,
    "state": "open",
    "created_at": "2021-06-19T10:37:20Z",
    "updated_at": "2021-08-09T06:32:04Z",
    "due_on": null,
    "closed_at": null
  },
  "comments": 6,
  "created_at": "2021-03-21T09:47:18Z",
  "updated_at": "2021-07-19T01:38:21Z",
  "closed_at": "2021-07-19T01:38:21Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "### Overview\r\nBrownie should offer first-class support for [multicall](https://github.com/makerdao/multicall) via a context manager:\r\n\r\n```\r\nwith multicall:\r\n    a = foo.bar()\r\n    b = foo.barfoo()\r\n    c = bar.foobar(a)\r\n    d = bar.otherbar()\r\n```\r\n\r\n### Specification\r\nWhile the context manager is open, a middleware intercepts all `eth_call` requests and returns objects which represent the result of the call once it completes.  When the context manager closes, or there is an attempt to use one of the pending call objects, a single multicall is made to get the actual values.\r\n\r\nIn the above example `a` and `b` would end up joined as a single multicall that executes when `a` is needed for `c`.  Then `c` and `d` would happen as a multicall when the context manager exits.\r\n\r\nWe can bundle the [`MultiCall2`](https://github.com/yearn/yearn-exporter/blob/c59a8207cb8721cb4264cbae741a9438b3486cba/contracts/Multicall2.sol) implementation as used by yearn, which uses try/catch to prevent calls from failing.  Attempting to interact with object for the specific result that failed in the multicall should raise a `ValueError`. (Or possibly the object simply returns `None`? Maybe this behavior is determined via a kwarg in the context manager?)\r\n\r\nIt is important to consider thread safety during the implementation.  The context manager must introspect to be aware of which thread it is running on, and not also batch `eth_call` operations coming from unrelated threads.\r\n\r\nTo ensure consistent behaviour across network, we can use Geth's [state override](https://geth.ethereum.org/docs/rpc/ns-eth#override-example) feature to simulate the existence of a multicall contract for the purposes of the call.  This is badass in so many ways I'm not even sure where to begin :smiling_imp: For dev networks where this isn't possible, deploy multicall silently the first time it's required.",
  "closed_by": {
    "login": "iamdefinitelyahuman",
    "id": 35276322,
    "node_id": "MDQ6VXNlcjM1Mjc2MzIy",
    "avatar_url": "https://avatars.githubusercontent.com/u/35276322?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/iamdefinitelyahuman",
    "html_url": "https://github.com/iamdefinitelyahuman",
    "followers_url": "https://api.github.com/users/iamdefinitelyahuman/followers",
    "following_url": "https://api.github.com/users/iamdefinitelyahuman/following{/other_user}",
    "gists_url": "https://api.github.com/users/iamdefinitelyahuman/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/iamdefinitelyahuman/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/iamdefinitelyahuman/subscriptions",
    "organizations_url": "https://api.github.com/users/iamdefinitelyahuman/orgs",
    "repos_url": "https://api.github.com/users/iamdefinitelyahuman/repos",
    "events_url": "https://api.github.com/users/iamdefinitelyahuman/events{/privacy}",
    "received_events_url": "https://api.github.com/users/iamdefinitelyahuman/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/eth-brownie/brownie/issues/1011/reactions",
    "total_count": 3,
    "+1": 3,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/eth-brownie/brownie/issues/1011/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/eth-brownie/brownie/issues/comments/803546501",
    "html_url": "https://github.com/eth-brownie/brownie/issues/1011#issuecomment-803546501",
    "issue_url": "https://api.github.com/repos/eth-brownie/brownie/issues/1011",
    "id": 803546501,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwMzU0NjUwMQ==",
    "user": {
      "login": "banteg",
      "id": 4562643,
      "node_id": "MDQ6VXNlcjQ1NjI2NDM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4562643?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/banteg",
      "html_url": "https://github.com/banteg",
      "followers_url": "https://api.github.com/users/banteg/followers",
      "following_url": "https://api.github.com/users/banteg/following{/other_user}",
      "gists_url": "https://api.github.com/users/banteg/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/banteg/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/banteg/subscriptions",
      "organizations_url": "https://api.github.com/users/banteg/orgs",
      "repos_url": "https://api.github.com/users/banteg/repos",
      "events_url": "https://api.github.com/users/banteg/events{/privacy}",
      "received_events_url": "https://api.github.com/users/banteg/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-21T10:02:42Z",
    "updated_at": "2021-03-21T10:02:42Z",
    "author_association": "COLLABORATOR",
    "body": "This is an amazing idea! A few caveats:\n- ganache-cli doesn't expect a third argument \n- as does web3py https://github.com/ethereum/web3.py/issues/1921",
    "reactions": {
      "url": "https://api.github.com/repos/eth-brownie/brownie/issues/comments/803546501/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/eth-brownie/brownie/issues/comments/804516701",
    "html_url": "https://github.com/eth-brownie/brownie/issues/1011#issuecomment-804516701",
    "issue_url": "https://api.github.com/repos/eth-brownie/brownie/issues/1011",
    "id": 804516701,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwNDUxNjcwMQ==",
    "user": {
      "login": "omarish",
      "id": 104550,
      "node_id": "MDQ6VXNlcjEwNDU1MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/104550?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/omarish",
      "html_url": "https://github.com/omarish",
      "followers_url": "https://api.github.com/users/omarish/followers",
      "following_url": "https://api.github.com/users/omarish/following{/other_user}",
      "gists_url": "https://api.github.com/users/omarish/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/omarish/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/omarish/subscriptions",
      "organizations_url": "https://api.github.com/users/omarish/orgs",
      "repos_url": "https://api.github.com/users/omarish/repos",
      "events_url": "https://api.github.com/users/omarish/events{/privacy}",
      "received_events_url": "https://api.github.com/users/omarish/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-23T01:32:23Z",
    "updated_at": "2021-03-23T01:32:23Z",
    "author_association": "CONTRIBUTOR",
    "body": "I've been thinking about this over the past couple days and wanted to float an idea. Would we definitely want it to automatically resolve calls (i.e know to evaluate `a` and `b` before getting `c`)?\r\n\r\nOne possible design alternative, just to be exhaustive:\r\n\r\n```python\r\n# (A) This works\r\nwith multicall:\r\n    a = foo.bar()\r\n    b = foo.barfoo()\r\n\r\n# (B) This raises an error\r\nwith multicall:\r\n    a = foo.bar()\r\n    b = foo.barfoo()\r\n    c = bar.foobar(a)\r\n\r\n# (C) This is how we'd want to write (B)\r\nwith multicall:\r\n    a = foo.bar()\r\n    b = foo.barfoo()\r\nwith multicall:\r\n    c = bar.foobar(a)\r\n    d = bar.otherbar()\r\n```\r\n\r\n(C) Has the advantage of being more explicit, but I agree, is sort of annoying to have to think about re-opening the context manager.",
    "reactions": {
      "url": "https://api.github.com/repos/eth-brownie/brownie/issues/comments/804516701/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/eth-brownie/brownie/issues/comments/807165639",
    "html_url": "https://github.com/eth-brownie/brownie/issues/1011#issuecomment-807165639",
    "issue_url": "https://api.github.com/repos/eth-brownie/brownie/issues/1011",
    "id": 807165639,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwNzE2NTYzOQ==",
    "user": {
      "login": "iamdefinitelyahuman",
      "id": 35276322,
      "node_id": "MDQ6VXNlcjM1Mjc2MzIy",
      "avatar_url": "https://avatars.githubusercontent.com/u/35276322?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/iamdefinitelyahuman",
      "html_url": "https://github.com/iamdefinitelyahuman",
      "followers_url": "https://api.github.com/users/iamdefinitelyahuman/followers",
      "following_url": "https://api.github.com/users/iamdefinitelyahuman/following{/other_user}",
      "gists_url": "https://api.github.com/users/iamdefinitelyahuman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/iamdefinitelyahuman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/iamdefinitelyahuman/subscriptions",
      "organizations_url": "https://api.github.com/users/iamdefinitelyahuman/orgs",
      "repos_url": "https://api.github.com/users/iamdefinitelyahuman/repos",
      "events_url": "https://api.github.com/users/iamdefinitelyahuman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/iamdefinitelyahuman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-25T17:42:41Z",
    "updated_at": "2021-03-25T17:42:41Z",
    "author_association": "MEMBER",
    "body": "I agree that the automatic execution mid-context manager is a bit magical, but when I think about how I personally would feel writing this code, it'd drive me mad having to endlessly close and reopen it.\r\n\r\nA middleground here might be a kwarg to enable or disable this behavior?",
    "reactions": {
      "url": "https://api.github.com/repos/eth-brownie/brownie/issues/comments/807165639/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/eth-brownie/brownie/issues/comments/807174205",
    "html_url": "https://github.com/eth-brownie/brownie/issues/1011#issuecomment-807174205",
    "issue_url": "https://api.github.com/repos/eth-brownie/brownie/issues/1011",
    "id": 807174205,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwNzE3NDIwNQ==",
    "user": {
      "login": "omarish",
      "id": 104550,
      "node_id": "MDQ6VXNlcjEwNDU1MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/104550?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/omarish",
      "html_url": "https://github.com/omarish",
      "followers_url": "https://api.github.com/users/omarish/followers",
      "following_url": "https://api.github.com/users/omarish/following{/other_user}",
      "gists_url": "https://api.github.com/users/omarish/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/omarish/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/omarish/subscriptions",
      "organizations_url": "https://api.github.com/users/omarish/orgs",
      "repos_url": "https://api.github.com/users/omarish/repos",
      "events_url": "https://api.github.com/users/omarish/events{/privacy}",
      "received_events_url": "https://api.github.com/users/omarish/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-25T17:47:44Z",
    "updated_at": "2021-03-25T17:49:50Z",
    "author_association": "CONTRIBUTOR",
    "body": "For sure. \r\n\r\nI think a clean implementation would have at least two pieces: a private function to commit a single transaction block (like scenario A above), and then something higher level (probably public) that calls that function every time (1) the multicall needs to be executed, and (2) when the context manager `__exit__`s. \r\n\r\nPerhaps something like this:\r\n\r\n```python\r\ndef _exec_multicall(*args, **kwargs):\r\n   # used to run a series of calls and will error out \r\n\r\n@contextmanager\r\ndef multicall(*args, **kwargs):\r\n   # this is the actual context manager that's exposed, it has some logic and uses `_exec_multicall` for batches.\r\n```\r\n\r\nWe could start with the simplest thing, which would be the context manager as initially proposed, then we could see how it feels and go from there. How does that sound?",
    "reactions": {
      "url": "https://api.github.com/repos/eth-brownie/brownie/issues/comments/807174205/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/eth-brownie/brownie/issues/comments/868948285",
    "html_url": "https://github.com/eth-brownie/brownie/issues/1011#issuecomment-868948285",
    "issue_url": "https://api.github.com/repos/eth-brownie/brownie/issues/1011",
    "id": 868948285,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg2ODk0ODI4NQ==",
    "user": {
      "login": "skellet0r",
      "id": 23556333,
      "node_id": "MDQ6VXNlcjIzNTU2MzMz",
      "avatar_url": "https://avatars.githubusercontent.com/u/23556333?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/skellet0r",
      "html_url": "https://github.com/skellet0r",
      "followers_url": "https://api.github.com/users/skellet0r/followers",
      "following_url": "https://api.github.com/users/skellet0r/following{/other_user}",
      "gists_url": "https://api.github.com/users/skellet0r/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/skellet0r/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/skellet0r/subscriptions",
      "organizations_url": "https://api.github.com/users/skellet0r/orgs",
      "repos_url": "https://api.github.com/users/skellet0r/repos",
      "events_url": "https://api.github.com/users/skellet0r/events{/privacy}",
      "received_events_url": "https://api.github.com/users/skellet0r/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-06-26T04:58:43Z",
    "updated_at": "2021-06-26T04:58:43Z",
    "author_association": "COLLABORATOR",
    "body": "Battle of the Mulitcalls !!!",
    "reactions": {
      "url": "https://api.github.com/repos/eth-brownie/brownie/issues/comments/868948285/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/eth-brownie/brownie/issues/comments/882163393",
    "html_url": "https://github.com/eth-brownie/brownie/issues/1011#issuecomment-882163393",
    "issue_url": "https://api.github.com/repos/eth-brownie/brownie/issues/1011",
    "id": 882163393,
    "node_id": "IC_kwDOCUsNcc40lL7B",
    "user": {
      "login": "iamdefinitelyahuman",
      "id": 35276322,
      "node_id": "MDQ6VXNlcjM1Mjc2MzIy",
      "avatar_url": "https://avatars.githubusercontent.com/u/35276322?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/iamdefinitelyahuman",
      "html_url": "https://github.com/iamdefinitelyahuman",
      "followers_url": "https://api.github.com/users/iamdefinitelyahuman/followers",
      "following_url": "https://api.github.com/users/iamdefinitelyahuman/following{/other_user}",
      "gists_url": "https://api.github.com/users/iamdefinitelyahuman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/iamdefinitelyahuman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/iamdefinitelyahuman/subscriptions",
      "organizations_url": "https://api.github.com/users/iamdefinitelyahuman/orgs",
      "repos_url": "https://api.github.com/users/iamdefinitelyahuman/repos",
      "events_url": "https://api.github.com/users/iamdefinitelyahuman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/iamdefinitelyahuman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-07-19T01:38:21Z",
    "updated_at": "2021-07-19T01:38:21Z",
    "author_association": "MEMBER",
    "body": "Implemented in #1125",
    "reactions": {
      "url": "https://api.github.com/repos/eth-brownie/brownie/issues/comments/882163393/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
