{
  "url": "https://api.github.com/repos/eth-brownie/brownie/issues/1496",
  "repository_url": "https://api.github.com/repos/eth-brownie/brownie",
  "labels_url": "https://api.github.com/repos/eth-brownie/brownie/issues/1496/labels{/name}",
  "comments_url": "https://api.github.com/repos/eth-brownie/brownie/issues/1496/comments",
  "events_url": "https://api.github.com/repos/eth-brownie/brownie/issues/1496/events",
  "html_url": "https://github.com/eth-brownie/brownie/issues/1496",
  "id": 1187697787,
  "node_id": "I_kwDOCUsNcc5GytR7",
  "number": 1496,
  "title": "Code Coverage Broken for Vyper",
  "user": {
    "login": "scherrey",
    "id": 878591,
    "node_id": "MDQ6VXNlcjg3ODU5MQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/878591?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/scherrey",
    "html_url": "https://github.com/scherrey",
    "followers_url": "https://api.github.com/users/scherrey/followers",
    "following_url": "https://api.github.com/users/scherrey/following{/other_user}",
    "gists_url": "https://api.github.com/users/scherrey/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/scherrey/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/scherrey/subscriptions",
    "organizations_url": "https://api.github.com/users/scherrey/orgs",
    "repos_url": "https://api.github.com/users/scherrey/repos",
    "events_url": "https://api.github.com/users/scherrey/events{/privacy}",
    "received_events_url": "https://api.github.com/users/scherrey/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2022-03-31T08:24:30Z",
  "updated_at": "2022-10-07T00:57:00Z",
  "closed_at": "2022-10-07T00:56:59Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Environment information\r\n\r\n* `brownie` Version: 1.17.2\r\n* `ganache-cli` Version: 16.12.1\r\n* `vyper` Version: 3.0.1+\r\n* Python Version: 3.9.2\r\n* OS: `Linux squire 5.14.0-4mx-amd64 #1 SMP Debian 5.14.16-1~mx21+1 (2021-11-05) x86_64 GNU/Linux`\r\n\r\n### What was wrong?\r\n\r\nCode Coverage is missing for some contracts and then brownie pretends another contract doesn't even exist in the coverage report even though it successfully discovers & executes its unit tests.\r\n\r\n### Reproduction Steps\r\n\r\n1. Make a Python virtual environment with Python 3.9.x\r\n2. Check out this repo. `git@github.com:ActorForth/VyperDemoContracts.git` from [Vyper Demo Contracts](https://github.com/ActorForth/VyperDemoContracts)\r\n3. make init (Note that it is installing a Vyper 3.0.2beta branch with some fixes for immutable bugs.)\r\n4. make test\r\n\r\n\r\nNote that although the ERC20 and SurpriseBox721 tests all execute and pass, the test runner claims there was zero code coverage for the ERC20 contract and pretends the SurpriseBox721 doesn't even exist.\r\nReally need code coverage to work on the SurpriseBox721 contract if we're ever going to feel safe using it on Main Net.\r\n(It is a work in progress still but is sufficiently functional for these test cases.)\r\n\r\n``(VyperDemoContracts) scherrey@pixies:~/projects/VyperDemoContracts\r\n$ make test\r\nbrownie test --coverage -v\r\nBrownie v1.17.2 - Python development framework for Ethereum\r\n\r\nCompiling contracts...\r\nVyper version: 0.3.1+commit.0f9ff286\r\nGenerating build data...\r\n\r\nERC1155\r\nERC20\r\nERC721\r\nSurpriseBox721\r\n==================================================== test session starts ====================================================\r\nplatform linux -- Python 3.9.2, pytest-6.2.5, py-1.11.0, pluggy-1.0.0 -- /home/scherrey/.virtualenvs/VyperDemoContracts/bin/python\r\ncachedir: .pytest_cache\r\nhypothesis profile 'brownie-verbose' -> verbosity=2, deadline=None, max_examples=50, stateful_step_count=10, report_multiple_bugs=False, database=DirectoryBasedExampleDatabase(PosixPath('/home/scherrey/.brownie/hypothesis'))\r\nrootdir: /home/scherrey/projects/VyperDemoContracts\r\nplugins: eth-brownie-1.17.2, hypothesis-6.27.3, forked-1.3.0, bdd-5.0.0, asyncio-0.18.1, xdist-1.34.0, web3-5.25.0\r\nasyncio: mode=legacy\r\ncollected 45 items\r\n\r\nLaunching 'ganache-cli --accounts 10 --hardfork istanbul --gasLimit 12000000 --mnemonic brownie --port 8545'...\r\n\r\ntests/test_ERC1155.py::test_run PASSED [ 2%]\r\ntests/test_ERC1155.py::test_mintNft PASSED [ 4%]\r\ntests/test_ERC1155.py::test_mintTokens PASSED [ 6%]\r\ntests/test_ERC1155.py::test_safeTransferFrom PASSED [ 8%]\r\ntests/test_ERC1155.py::test_safeTransferFromReverts PASSED [ 11%]\r\ntests/test_ERC1155.py::test_balanceOf PASSED [ 13%]\r\ntests/test_ERC1155.py::test_balanceOfReverts PASSED [ 15%]\r\ntests/test_ERC1155.py::test_AddContract_event PASSED [ 17%]\r\ntests/test_ERC1155.py::test_setApproveAmount_event PASSED [ 20%]\r\ntests/test_ERC1155.py::test_setBaseURI PASSED [ 22%]\r\ntests/test_ERC1155.py::test_name PASSED [ 24%]\r\ntests/test_ERC1155.py::test_symbol PASSED [ 26%]\r\ntests/test_ERC1155.py::test_totalSupply PASSED [ 28%]\r\ntests/test_ERC1155.py::test_destruct PASSED [ 31%]\r\ntests/test_ERC20.py::test_simple_transfer PASSED [ 33%]\r\ntests/test_ERC20.py::test_destruct PASSED [ 35%]\r\ntests/test_ERC20.py::test_mint_and_burn PASSED [ 37%]\r\ntests/test_ERC20.py::test_totalSupply PASSED [ 40%]\r\ntests/test_ERC20.py::test_transfer PASSED [ 42%]\r\ntests/test_ERC20.py::test_transferFrom_and_Allowance PASSED [ 44%]\r\ntests/test_ERC20.py::test_burnFrom_and_Allowance PASSED [ 46%]\r\ntests/test_ERC721.py::test_supportsInterface PASSED [ 48%]\r\ntests/test_ERC721.py::test_balanceOf PASSED [ 51%]\r\ntests/test_ERC721.py::test_ownerOf PASSED [ 53%]\r\ntests/test_ERC721.py::test_getApproved PASSED [ 55%]\r\ntests/test_ERC721.py::test_isApprovedForAll PASSED [ 57%]\r\ntests/test_ERC721.py::test_transferFrom_by_owner PASSED [ 60%]\r\ntests/test_ERC721.py::test_transferFrom_by_approved PASSED [ 62%]\r\ntests/test_ERC721.py::test_transferFrom_by_operator PASSED [ 64%]\r\ntests/test_ERC721.py::test_safeTransferFrom_by_owner PASSED [ 66%]\r\ntests/test_ERC721.py::test_safeTransferFrom_by_approved PASSED [ 68%]\r\ntests/test_ERC721.py::test_safeTransferFrom_by_operator PASSED [ 71%]\r\ntests/test_ERC721.py::test_destruct PASSED [ 73%]\r\ntests/test_SurpriseBox721.py::test_supportsInterface PASSED [ 75%]\r\ntests/test_SurpriseBox721.py::test_balanceOf PASSED [ 77%]\r\ntests/test_SurpriseBox721.py::test_ownerOf PASSED [ 80%]\r\ntests/test_SurpriseBox721.py::test_getApproved PASSED [ 82%]\r\ntests/test_SurpriseBox721.py::test_isApprovedForAll PASSED [ 84%]\r\ntests/test_SurpriseBox721.py::test_transferFrom_by_owner PASSED [ 86%]\r\ntests/test_SurpriseBox721.py::test_transferFrom_by_approved PASSED [ 88%]\r\ntests/test_SurpriseBox721.py::test_transferFrom_by_operator PASSED [ 91%]\r\ntests/test_SurpriseBox721.py::test_safeTransferFrom_by_owner PASSED [ 93%]\r\ntests/test_SurpriseBox721.py::test_safeTransferFrom_by_approved PASSED [ 95%]\r\ntests/test_SurpriseBox721.py::test_safeTransferFrom_by_operator PASSED [ 97%]\r\ntests/test_SurpriseBox721.py::test_destruct PASSED [100%]\r\n\r\n===================================================== warnings summary ======================================================\r\n../../.virtualenvs/VyperDemoContracts/lib/python3.9/site-packages/pytest_asyncio/plugin.py:191\r\n/home/scherrey/.virtualenvs/VyperDemoContracts/lib/python3.9/site-packages/pytest_asyncio/plugin.py:191: DeprecationWarning: The 'asyncio_mode' default value will change to 'strict' in future, please explicitly use 'asyncio_mode=strict' or 'asyncio_mode=auto' in pytest configuration file.\r\nconfig.issue_config_time_warning(LEGACY_MODE, stacklevel=2)\r\n\r\ntests/test_ERC1155.py:1\r\n/home/scherrey/projects/VyperDemoContracts/tests/test_ERC1155.py:1: PendingDeprecationWarning: lib2to3 package is deprecated and may not be able to parse Python 3.10+\r\nfrom lib2to3.pgen2 import token\r\n\r\n-- Docs: https://docs.pytest.org/en/stable/warnings.html\r\n========================================================= Coverage ==========================================================\r\n\r\ncontract: ERC1155 - 66.2%\r\nERC1155.balanceOf - 87.5%\r\nERC1155.name - 87.5%\r\nERC1155.symbol - 87.5%\r\nERC1155.totalSupply - 87.5%\r\nERC1155.addERC20Contract - 75.0%\r\nERC1155.addERC721Contract - 75.0%\r\nERC1155.mintNFT - 75.0%\r\nERC1155.mintToken - 75.0%\r\nERC1155.self_destruct - 75.0%\r\nERC1155.setApproveAmount - 75.0%\r\nERC1155.setBaseURI - 75.0%\r\nERC1155.uri - 75.0%\r\nERC1155.safeTransferFrom - 68.8%\r\nERC1155.default - 0.0%\r\nERC1155._doSafeBatchTransferAcceptanceCheck - 0.0%\r\nERC1155._doSafeTransferAcceptanceCheck - 0.0%\r\n\r\ncontract: ERC20 - 0.0%\r\n\r\ncontract: ERC721 - 80.4%\r\nERC721._clearApproval - 100.0%\r\nERC721._uint_to_string - 85.4%\r\nERC721.approve - 75.0%\r\nERC721.safeTransferFrom - 41.7%\r\n\r\nCoverage report saved at /home/scherrey/projects/VyperDemoContracts/reports/coverage.json\r\nView the report using the Brownie GUI\r\n======================================== 45 passed, 2 warnings in 140.13s (0:02:20) =========================================\r\nTerminating local RPC client...\r\n(VyperDemoContracts) scherrey@pixies:~/projects/VyperDemoContracts\r\n$ ``\r\n",
  "closed_by": {
    "login": "charles-cooper",
    "id": 3867501,
    "node_id": "MDQ6VXNlcjM4Njc1MDE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3867501?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/charles-cooper",
    "html_url": "https://github.com/charles-cooper",
    "followers_url": "https://api.github.com/users/charles-cooper/followers",
    "following_url": "https://api.github.com/users/charles-cooper/following{/other_user}",
    "gists_url": "https://api.github.com/users/charles-cooper/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/charles-cooper/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/charles-cooper/subscriptions",
    "organizations_url": "https://api.github.com/users/charles-cooper/orgs",
    "repos_url": "https://api.github.com/users/charles-cooper/repos",
    "events_url": "https://api.github.com/users/charles-cooper/events{/privacy}",
    "received_events_url": "https://api.github.com/users/charles-cooper/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/eth-brownie/brownie/issues/1496/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/eth-brownie/brownie/issues/1496/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/eth-brownie/brownie/issues/comments/1093375127",
    "html_url": "https://github.com/eth-brownie/brownie/issues/1496#issuecomment-1093375127",
    "issue_url": "https://api.github.com/repos/eth-brownie/brownie/issues/1496",
    "id": 1093375127,
    "node_id": "IC_kwDOCUsNcc5BK5SX",
    "user": {
      "login": "charles-cooper",
      "id": 3867501,
      "node_id": "MDQ6VXNlcjM4Njc1MDE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3867501?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/charles-cooper",
      "html_url": "https://github.com/charles-cooper",
      "followers_url": "https://api.github.com/users/charles-cooper/followers",
      "following_url": "https://api.github.com/users/charles-cooper/following{/other_user}",
      "gists_url": "https://api.github.com/users/charles-cooper/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/charles-cooper/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/charles-cooper/subscriptions",
      "organizations_url": "https://api.github.com/users/charles-cooper/orgs",
      "repos_url": "https://api.github.com/users/charles-cooper/repos",
      "events_url": "https://api.github.com/users/charles-cooper/events{/privacy}",
      "received_events_url": "https://api.github.com/users/charles-cooper/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-04-08T21:29:28Z",
    "updated_at": "2022-04-08T22:15:52Z",
    "author_association": "COLLABORATOR",
    "body": "i did a bit of investigation, and it looks like there are two issues here. the ERC20.vy contract has assertions with no reason string, e.g.\r\n```vyper\r\nassert msg.sender == owner\r\n```\r\nthis can probably be fixed by adding appropriate AST cases here: https://github.com/eth-brownie/brownie/blob/ef0d5af3bb48edcd11abf985626fc99dbc577c7d/brownie/project/compiler/vyper.py#L369-L386\r\n\r\nthe other issue is that SurpriseBox721.vy uses immutables (which exist in vyper as of v0.3.1). i narrowed down the repro, here is a minimal one:\r\n```vyper\r\n# abc.vy\r\n# @version 0.3.1\r\n\r\nIMM: immutable(uint256)\r\n\r\n@external\r\ndef __init__():\r\n    IMM = 1\r\n\r\n@external\r\n@pure\r\ndef foo() -> uint256:\r\n    return IMM\r\n```\r\n```python\r\n# test_abc.py\r\n@pytest.fixture\r\ndef abc_contract(abc, accounts):\r\n    return accounts[0].deploy(abc)\r\n \r\ndef test_foo(abc_contract):\r\n    assert abc_contract.foo() == 1\r\n```\r\n\r\nI'm not too familiar with brownie internals but I'm guessing resolution of this is more involved, since vyper stores immutables \"past the end\" of the runtime bytecode rather than inlining them.",
    "reactions": {
      "url": "https://api.github.com/repos/eth-brownie/brownie/issues/comments/1093375127/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/eth-brownie/brownie/issues/comments/1093419232",
    "html_url": "https://github.com/eth-brownie/brownie/issues/1496#issuecomment-1093419232",
    "issue_url": "https://api.github.com/repos/eth-brownie/brownie/issues/1496",
    "id": 1093419232,
    "node_id": "IC_kwDOCUsNcc5BLEDg",
    "user": {
      "login": "charles-cooper",
      "id": 3867501,
      "node_id": "MDQ6VXNlcjM4Njc1MDE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3867501?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/charles-cooper",
      "html_url": "https://github.com/charles-cooper",
      "followers_url": "https://api.github.com/users/charles-cooper/followers",
      "following_url": "https://api.github.com/users/charles-cooper/following{/other_user}",
      "gists_url": "https://api.github.com/users/charles-cooper/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/charles-cooper/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/charles-cooper/subscriptions",
      "organizations_url": "https://api.github.com/users/charles-cooper/orgs",
      "repos_url": "https://api.github.com/users/charles-cooper/repos",
      "events_url": "https://api.github.com/users/charles-cooper/events{/privacy}",
      "received_events_url": "https://api.github.com/users/charles-cooper/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-04-08T22:27:38Z",
    "updated_at": "2022-04-08T22:27:38Z",
    "author_association": "COLLABORATOR",
    "body": "solidity has metadata in the bytecode, but it gets stripped here:\r\nhttps://github.com/eth-brownie/brownie/blob/ef0d5af3bb48edcd11abf985626fc99dbc577c7d/brownie/project/compiler/solidity.py#L257-L268\r\n\r\nso i guess maybe the most kosher way to fix this is for vyper to publish the layout of its \"data section\", and then brownie will be able to strip the immutables from deployed bytecode.",
    "reactions": {
      "url": "https://api.github.com/repos/eth-brownie/brownie/issues/comments/1093419232/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/eth-brownie/brownie/issues/comments/1093447408",
    "html_url": "https://github.com/eth-brownie/brownie/issues/1496#issuecomment-1093447408",
    "issue_url": "https://api.github.com/repos/eth-brownie/brownie/issues/1496",
    "id": 1093447408,
    "node_id": "IC_kwDOCUsNcc5BLK7w",
    "user": {
      "login": "charles-cooper",
      "id": 3867501,
      "node_id": "MDQ6VXNlcjM4Njc1MDE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3867501?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/charles-cooper",
      "html_url": "https://github.com/charles-cooper",
      "followers_url": "https://api.github.com/users/charles-cooper/followers",
      "following_url": "https://api.github.com/users/charles-cooper/following{/other_user}",
      "gists_url": "https://api.github.com/users/charles-cooper/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/charles-cooper/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/charles-cooper/subscriptions",
      "organizations_url": "https://api.github.com/users/charles-cooper/orgs",
      "repos_url": "https://api.github.com/users/charles-cooper/repos",
      "events_url": "https://api.github.com/users/charles-cooper/events{/privacy}",
      "received_events_url": "https://api.github.com/users/charles-cooper/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-04-08T22:58:38Z",
    "updated_at": "2022-04-08T22:58:38Z",
    "author_association": "COLLABORATOR",
    "body": "i opened https://github.com/vyperlang/vyper/pull/2768 in the vyperlang repository to publish the immutables layout file. but i realized a simpler way for brownie to do this is to request both `bytecode` and `bytecode_runtime` from vyper, and then trim trailing bytes from the deployed bytecode to match the length of `bytecode_runtime` (since the `bytecode_runtime` does not have any data section).",
    "reactions": {
      "url": "https://api.github.com/repos/eth-brownie/brownie/issues/comments/1093447408/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/eth-brownie/brownie/issues/comments/1270945524",
    "html_url": "https://github.com/eth-brownie/brownie/issues/1496#issuecomment-1270945524",
    "issue_url": "https://api.github.com/repos/eth-brownie/brownie/issues/1496",
    "id": 1270945524,
    "node_id": "IC_kwDOCUsNcc5LwRb0",
    "user": {
      "login": "charles-cooper",
      "id": 3867501,
      "node_id": "MDQ6VXNlcjM4Njc1MDE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3867501?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/charles-cooper",
      "html_url": "https://github.com/charles-cooper",
      "followers_url": "https://api.github.com/users/charles-cooper/followers",
      "following_url": "https://api.github.com/users/charles-cooper/following{/other_user}",
      "gists_url": "https://api.github.com/users/charles-cooper/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/charles-cooper/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/charles-cooper/subscriptions",
      "organizations_url": "https://api.github.com/users/charles-cooper/orgs",
      "repos_url": "https://api.github.com/users/charles-cooper/repos",
      "events_url": "https://api.github.com/users/charles-cooper/events{/privacy}",
      "received_events_url": "https://api.github.com/users/charles-cooper/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-10-07T00:56:59Z",
    "updated_at": "2022-10-07T00:56:59Z",
    "author_association": "COLLABORATOR",
    "body": "should be fixed as of https://github.com/eth-brownie/brownie/pull/1623. @scherrey please reopen if still an issue",
    "reactions": {
      "url": "https://api.github.com/repos/eth-brownie/brownie/issues/comments/1270945524/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
