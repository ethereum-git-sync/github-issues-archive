{
  "url": "https://api.github.com/repos/vyperlang/vyper/issues/1216",
  "repository_url": "https://api.github.com/repos/vyperlang/vyper",
  "labels_url": "https://api.github.com/repos/vyperlang/vyper/issues/1216/labels{/name}",
  "comments_url": "https://api.github.com/repos/vyperlang/vyper/issues/1216/comments",
  "events_url": "https://api.github.com/repos/vyperlang/vyper/issues/1216/events",
  "html_url": "https://github.com/vyperlang/vyper/issues/1216",
  "id": 402536794,
  "node_id": "MDU6SXNzdWU0MDI1MzY3OTQ=",
  "number": 1216,
  "title": "Gas consumption of logging bytes array",
  "user": {
    "login": "NIC619",
    "id": 17670147,
    "node_id": "MDQ6VXNlcjE3NjcwMTQ3",
    "avatar_url": "https://avatars.githubusercontent.com/u/17670147?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/NIC619",
    "html_url": "https://github.com/NIC619",
    "followers_url": "https://api.github.com/users/NIC619/followers",
    "following_url": "https://api.github.com/users/NIC619/following{/other_user}",
    "gists_url": "https://api.github.com/users/NIC619/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/NIC619/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/NIC619/subscriptions",
    "organizations_url": "https://api.github.com/users/NIC619/orgs",
    "repos_url": "https://api.github.com/users/NIC619/repos",
    "events_url": "https://api.github.com/users/NIC619/events{/privacy}",
    "received_events_url": "https://api.github.com/users/NIC619/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 6,
  "created_at": "2019-01-24T04:23:27Z",
  "updated_at": "2019-01-28T09:59:59Z",
  "closed_at": "2019-01-28T09:55:05Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "### Version Information\r\n\r\n* vyper Version: 0.1.0b7\r\n* OS: osx\r\n* Python Version (python --version): 3.6.0\r\n\r\n### What's your issue about?\r\n\r\nI was documenting the gas consumption of [eth2.0 deposit contract](https://github.com/ethereum/deposit_contract/blob/master/deposit_contract/contracts/validator_registration.v.py) and after a little experiments some unintuitive results came up.\r\n**Summary**: with an event that logs a byte array, the larger the byte array data are logged, the **less** gas it cost(and transaction also runs faster in local testing environment).\r\n\r\n* Vyper contract code(extracted and modified from the deposit contract) used for testing:\r\n```\r\nDeposit: event({data: bytes[2064]})\r\n\r\n@public\r\ndef deposit2(deposit_input: bytes[2064]):\r\n    log.Deposit(deposit_input)\r\n```\r\n\r\n* Results\r\n    * [tx on rinkeby](https://rinkeby.etherscan.io/tx/0x6238be1f1d27bb53e9226420b7c5f94e2c48c15b0464be7b232abbedb4de7e97) with `deposit_input` being `b'\\x01' * 2048`\r\n            * estimated cost for logging: 2048 * 68 + 2064 * 8 + 21000 = 176776\r\n            * actual gas cost = 183846\r\n    * [tx on rinkeby](https://rinkeby.etherscan.io/tx/0xf73b476ddb0662fe7ec3d2254e6b3ff996dfcfcd91ae0f44ed6b4afd5e9ef6a6) with `deposit_input` being `b'\\x01' * 1024`\r\n            * estimated cost for logging: 1024 * 68 + 1040 * 8 + 21000 = 98952\r\n            * actual gas cost = 209350\r\n    * [tx on rinkeby](https://rinkeby.etherscan.io/tx/0x6143f0812476ccb05f0c8bee0d4e8f8c671bb1ddca75c94b75b14eb65509cf93) with `deposit_input` being `b'\\x01'`\r\n            * estimated cost for logging: 1 * 68 + 17 * 8 + 21000 = 21204\r\n            * actual gas cost = 235204\r\n___\r\n\r\n* Try Solidity\r\n```\r\npragma solidity ^0.4.24;\r\n\r\ncontract testlogbytes {\r\n    event LogBytes(bytes log);\r\n    \r\n    function logbytes(bytes _log) public {\r\n        emit LogBytes(_log);\r\n    }\r\n}\r\n```\r\n\r\n* Results\r\n    * [tx on rinkeby](https://rinkeby.etherscan.io/tx/0x6238be1f1d27bb53e9226420b7c5f94e2c48c15b0464be7b232abbedb4de7e97) with `_log` being `b'\\x01' * 2048`\r\n            * estimated cost for logging: 2048 * 68 + 2064 * 8 + 21000 = 176776\r\n            * actual gas cost = 183997\r\n    * [tx on rinkeby](https://rinkeby.etherscan.io/tx/0x7b0b1464f835b67a290778bb0ab072bde86c6e7e2626c6212d97893510afe314) with `_log` being `b'\\x01' * 1024`\r\n            * estimated cost for logging: 1024 * 68 + 1040 * 8 + 21000 = 98952\r\n            * actual gas cost = 103715\r\n    * [tx on rinkeby](https://rinkeby.etherscan.io/tx/0x6143f0812476ccb05f0c8bee0d4e8f8c671bb1ddca75c94b75b14eb65509cf93) with `_log` being `b'\\x01'`\r\n            * estimated cost for logging: 1 * 68 + 17 * 8 + 21000 = 21204\r\n            * actual gas cost = 24090\r\n\r\n### How can it be fixed?\r\n\r\nFill this in if you know how to fix it.\r\n\r\n#### Cute Animal Picture\r\n\r\n> put a cute animal picture here.\r\n\r\n![](https://cdn.pixabay.com/photo/2017/12/21/22/52/dog-3032728_1280.jpg)\r\n",
  "closed_by": {
    "login": "jacqueswww",
    "id": 6917456,
    "node_id": "MDQ6VXNlcjY5MTc0NTY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6917456?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jacqueswww",
    "html_url": "https://github.com/jacqueswww",
    "followers_url": "https://api.github.com/users/jacqueswww/followers",
    "following_url": "https://api.github.com/users/jacqueswww/following{/other_user}",
    "gists_url": "https://api.github.com/users/jacqueswww/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jacqueswww/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jacqueswww/subscriptions",
    "organizations_url": "https://api.github.com/users/jacqueswww/orgs",
    "repos_url": "https://api.github.com/users/jacqueswww/repos",
    "events_url": "https://api.github.com/users/jacqueswww/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jacqueswww/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/1216/reactions",
    "total_count": 1,
    "+1": 0,
    "-1": 0,
    "laugh": 1,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/vyperlang/vyper/issues/1216/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/457549210",
    "html_url": "https://github.com/vyperlang/vyper/issues/1216#issuecomment-457549210",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/1216",
    "id": 457549210,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ1NzU0OTIxMA==",
    "user": {
      "login": "jacqueswww",
      "id": 6917456,
      "node_id": "MDQ6VXNlcjY5MTc0NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6917456?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jacqueswww",
      "html_url": "https://github.com/jacqueswww",
      "followers_url": "https://api.github.com/users/jacqueswww/followers",
      "following_url": "https://api.github.com/users/jacqueswww/following{/other_user}",
      "gists_url": "https://api.github.com/users/jacqueswww/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jacqueswww/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jacqueswww/subscriptions",
      "organizations_url": "https://api.github.com/users/jacqueswww/orgs",
      "repos_url": "https://api.github.com/users/jacqueswww/repos",
      "events_url": "https://api.github.com/users/jacqueswww/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jacqueswww/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-01-25T11:49:49Z",
    "updated_at": "2019-01-25T11:52:21Z",
    "author_association": "CONTRIBUTOR",
    "body": "Very interesting, my initial reaction would be that vypers' performance has to be linear to being reverse of the stated results - because vyper will copy calldata to memory after applying clamps.\r\n\r\nCould you run the same tests on https://github.com/ethereum/vyper/pull/1213 ?",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/457549210/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/457550016",
    "html_url": "https://github.com/vyperlang/vyper/issues/1216#issuecomment-457550016",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/1216",
    "id": 457550016,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ1NzU1MDAxNg==",
    "user": {
      "login": "jacqueswww",
      "id": 6917456,
      "node_id": "MDQ6VXNlcjY5MTc0NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6917456?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jacqueswww",
      "html_url": "https://github.com/jacqueswww",
      "followers_url": "https://api.github.com/users/jacqueswww/followers",
      "following_url": "https://api.github.com/users/jacqueswww/following{/other_user}",
      "gists_url": "https://api.github.com/users/jacqueswww/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jacqueswww/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jacqueswww/subscriptions",
      "organizations_url": "https://api.github.com/users/jacqueswww/orgs",
      "repos_url": "https://api.github.com/users/jacqueswww/repos",
      "events_url": "https://api.github.com/users/jacqueswww/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jacqueswww/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-01-25T11:53:11Z",
    "updated_at": "2019-01-25T11:58:07Z",
    "author_association": "CONTRIBUTOR",
    "body": "@NIC619  I think I figured it out - currently vyper pads the bytearray with empty bytes - this would describe the above behaviour.\r\n```\r\n [with,\r\n              _bytearray_loc,\r\n              /* pack_args_by_32:dest_placeholder */ \r\n              [add,\r\n                2592,\r\n                [mload, 2528]],\r\n              [seq,\r\n                [repeat,\r\n                  2496,\r\n                  [mload, _bytearray_loc],\r\n                  2080,\r\n                  [seq,\r\n                    [if, [ge, [mload, 2496], 2080], break],\r\n                    [mstore8,\r\n                      [add, [add, _bytearray_loc, 32], [mload, 2496]],\r\n                      0]]]]]\r\n```\r\n\r\nThe reason this is done because `eth-abi` doesn't allow dirty bytes (non zero bytes to occur after allocated bytes).\r\nhttps://github.com/ethereum/eth-abi/blob/082819a1879068810e50b487d6b5aa1a9f1d7551/eth_abi/decoding.py#L328\r\n\r\nI think to fix this - one would just have to zero pad up until `ceil32(len_val)`, instead of the whole array.\r\nThe other option is the figure out if this is even a constraint (or should even be a constraint on the abi).",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/457550016/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/457556581",
    "html_url": "https://github.com/vyperlang/vyper/issues/1216#issuecomment-457556581",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/1216",
    "id": 457556581,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ1NzU1NjU4MQ==",
    "user": {
      "login": "jacqueswww",
      "id": 6917456,
      "node_id": "MDQ6VXNlcjY5MTc0NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6917456?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jacqueswww",
      "html_url": "https://github.com/jacqueswww",
      "followers_url": "https://api.github.com/users/jacqueswww/followers",
      "following_url": "https://api.github.com/users/jacqueswww/following{/other_user}",
      "gists_url": "https://api.github.com/users/jacqueswww/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jacqueswww/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jacqueswww/subscriptions",
      "organizations_url": "https://api.github.com/users/jacqueswww/orgs",
      "repos_url": "https://api.github.com/users/jacqueswww/repos",
      "events_url": "https://api.github.com/users/jacqueswww/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jacqueswww/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-01-25T12:22:01Z",
    "updated_at": "2019-01-25T14:30:05Z",
    "author_association": "CONTRIBUTOR",
    "body": "This is also very interesting because this could indicate where py-evm needs to be optimised, my guess it has to with the `JUMP` opcode (not big surprise, because that is what makes the EVM slow in general haha).",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/457556581/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/457569640",
    "html_url": "https://github.com/vyperlang/vyper/issues/1216#issuecomment-457569640",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/1216",
    "id": 457569640,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ1NzU2OTY0MA==",
    "user": {
      "login": "jacqueswww",
      "id": 6917456,
      "node_id": "MDQ6VXNlcjY5MTc0NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6917456?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jacqueswww",
      "html_url": "https://github.com/jacqueswww",
      "followers_url": "https://api.github.com/users/jacqueswww/followers",
      "following_url": "https://api.github.com/users/jacqueswww/following{/other_user}",
      "gists_url": "https://api.github.com/users/jacqueswww/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jacqueswww/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jacqueswww/subscriptions",
      "organizations_url": "https://api.github.com/users/jacqueswww/orgs",
      "repos_url": "https://api.github.com/users/jacqueswww/repos",
      "events_url": "https://api.github.com/users/jacqueswww/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jacqueswww/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-01-25T13:17:08Z",
    "updated_at": "2019-01-25T13:17:08Z",
    "author_association": "CONTRIBUTOR",
    "body": "@NIC619 please try above with https://github.com/ethereum/vyper/pull/1217.",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/457569640/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/457999469",
    "html_url": "https://github.com/vyperlang/vyper/issues/1216#issuecomment-457999469",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/1216",
    "id": 457999469,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ1Nzk5OTQ2OQ==",
    "user": {
      "login": "NIC619",
      "id": 17670147,
      "node_id": "MDQ6VXNlcjE3NjcwMTQ3",
      "avatar_url": "https://avatars.githubusercontent.com/u/17670147?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/NIC619",
      "html_url": "https://github.com/NIC619",
      "followers_url": "https://api.github.com/users/NIC619/followers",
      "following_url": "https://api.github.com/users/NIC619/following{/other_user}",
      "gists_url": "https://api.github.com/users/NIC619/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/NIC619/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/NIC619/subscriptions",
      "organizations_url": "https://api.github.com/users/NIC619/orgs",
      "repos_url": "https://api.github.com/users/NIC619/repos",
      "events_url": "https://api.github.com/users/NIC619/events{/privacy}",
      "received_events_url": "https://api.github.com/users/NIC619/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-01-28T04:59:56Z",
    "updated_at": "2019-01-28T04:59:56Z",
    "author_association": "CONTRIBUTOR",
    "body": "@jacqueswww Great work! The fix works!\r\nActual gas cost with 2048 bytes input: 180662\r\nActual gas cost with 1024 bytes input: 102629\r\nActual gas cost with 1 bytes input: 28186\r\n\r\n\r\n> This is also very interesting because this could indicate where py-evm needs to be optimised, my guess it has to with the `JUMP` opcode\r\n\r\nCan you elaborate more on this? Would like to learn more about it.",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/457999469/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 1,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/458064745",
    "html_url": "https://github.com/vyperlang/vyper/issues/1216#issuecomment-458064745",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/1216",
    "id": 458064745,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ1ODA2NDc0NQ==",
    "user": {
      "login": "jacqueswww",
      "id": 6917456,
      "node_id": "MDQ6VXNlcjY5MTc0NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6917456?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jacqueswww",
      "html_url": "https://github.com/jacqueswww",
      "followers_url": "https://api.github.com/users/jacqueswww/followers",
      "following_url": "https://api.github.com/users/jacqueswww/following{/other_user}",
      "gists_url": "https://api.github.com/users/jacqueswww/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jacqueswww/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jacqueswww/subscriptions",
      "organizations_url": "https://api.github.com/users/jacqueswww/orgs",
      "repos_url": "https://api.github.com/users/jacqueswww/repos",
      "events_url": "https://api.github.com/users/jacqueswww/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jacqueswww/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-01-28T09:58:27Z",
    "updated_at": "2019-01-28T09:59:59Z",
    "author_association": "CONTRIBUTOR",
    "body": "@NIC619 so basically the biggest performance hindrance on EVM currently is the fact that it doesn't use static jumps - which can be used to do branch prediction or caching when executing a program.\r\nThe LLL code I pasted above is basically a loop that zeroes bytes for the full length of an allocated string - so a very long loop using JUMPI & JUMP.\r\n\r\nI had a 400 second (from 900s to 500s) decrease in test suite time on my local machine which would indicate that the way JUMP/JUMPI is handled in py-evm could be optimised. The reduction just seems very large, for a change only related to tests with ByteArray. Hope that makes sense? :)",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/458064745/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
