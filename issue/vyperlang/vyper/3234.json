{
  "url": "https://api.github.com/repos/vyperlang/vyper/issues/3234",
  "repository_url": "https://api.github.com/repos/vyperlang/vyper",
  "labels_url": "https://api.github.com/repos/vyperlang/vyper/issues/3234/labels{/name}",
  "comments_url": "https://api.github.com/repos/vyperlang/vyper/issues/3234/comments",
  "events_url": "https://api.github.com/repos/vyperlang/vyper/issues/3234/events",
  "html_url": "https://github.com/vyperlang/vyper/issues/3234",
  "id": 1538431094,
  "node_id": "I_kwDOBGDvrM5bsph2",
  "number": 3234,
  "title": "EVM error OutOfGas with DynArray for loop",
  "user": {
    "login": "milkyklim",
    "id": 10698619,
    "node_id": "MDQ6VXNlcjEwNjk4NjE5",
    "avatar_url": "https://avatars.githubusercontent.com/u/10698619?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/milkyklim",
    "html_url": "https://github.com/milkyklim",
    "followers_url": "https://api.github.com/users/milkyklim/followers",
    "following_url": "https://api.github.com/users/milkyklim/following{/other_user}",
    "gists_url": "https://api.github.com/users/milkyklim/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/milkyklim/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/milkyklim/subscriptions",
    "organizations_url": "https://api.github.com/users/milkyklim/orgs",
    "repos_url": "https://api.github.com/users/milkyklim/repos",
    "events_url": "https://api.github.com/users/milkyklim/events{/privacy}",
    "received_events_url": "https://api.github.com/users/milkyklim/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 7,
  "created_at": "2023-01-18T18:01:41Z",
  "updated_at": "2023-01-19T15:45:25Z",
  "closed_at": "2023-01-19T15:45:24Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Version Information\r\n\r\n* vyper Version (output of `vyper --version`): 0.3.7+commit.6020b8b\r\n* OS: osx\r\n* Python Version (output of `python --version`): Python 3.8.6\r\n\r\n### What's your issue about?\r\n\r\nVyper sample I use:\r\n\r\n```vyper\r\n# @version 0.3.7\r\nMAX_NUM: public(constant(uint256)) = 10 ** 12\r\n\r\nstruct MyStruct:\r\n    one: uint256\r\n    two: uint256\r\n    there: uint256\r\n\r\n@view\r\n@external\r\ndef get_values(n: uint256) -> DynArray[uint256, MAX_NUM]:\r\n    _ids: DynArray[uint256, MAX_NUM] = []\r\n\r\n    for i in range(0, MAX_NUM):\r\n        if i >= n:\r\n            break\r\n        _ids.append(i)\r\n\r\n    return _ids\r\n```\r\n\r\nCode compiles but when I try to call `.get_values(3)` in ape I get an error `ape.exceptions.VirtualMachineError: EVM error OutOfGas`. This can be ape error all along, will reopen there once confirmed. \r\n\r\n### How can it be fixed?\r\n\r\n--\r\n",
  "closed_by": {
    "login": "charles-cooper",
    "id": 3867501,
    "node_id": "MDQ6VXNlcjM4Njc1MDE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3867501?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/charles-cooper",
    "html_url": "https://github.com/charles-cooper",
    "followers_url": "https://api.github.com/users/charles-cooper/followers",
    "following_url": "https://api.github.com/users/charles-cooper/following{/other_user}",
    "gists_url": "https://api.github.com/users/charles-cooper/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/charles-cooper/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/charles-cooper/subscriptions",
    "organizations_url": "https://api.github.com/users/charles-cooper/orgs",
    "repos_url": "https://api.github.com/users/charles-cooper/repos",
    "events_url": "https://api.github.com/users/charles-cooper/events{/privacy}",
    "received_events_url": "https://api.github.com/users/charles-cooper/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/3234/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/vyperlang/vyper/issues/3234/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1387737685",
    "html_url": "https://github.com/vyperlang/vyper/issues/3234#issuecomment-1387737685",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/3234",
    "id": 1387737685,
    "node_id": "IC_kwDOBGDvrM5StzJV",
    "user": {
      "login": "trocher",
      "id": 43437004,
      "node_id": "MDQ6VXNlcjQzNDM3MDA0",
      "avatar_url": "https://avatars.githubusercontent.com/u/43437004?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/trocher",
      "html_url": "https://github.com/trocher",
      "followers_url": "https://api.github.com/users/trocher/followers",
      "following_url": "https://api.github.com/users/trocher/following{/other_user}",
      "gists_url": "https://api.github.com/users/trocher/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/trocher/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/trocher/subscriptions",
      "organizations_url": "https://api.github.com/users/trocher/orgs",
      "repos_url": "https://api.github.com/users/trocher/repos",
      "events_url": "https://api.github.com/users/trocher/events{/privacy}",
      "received_events_url": "https://api.github.com/users/trocher/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-01-18T20:27:05Z",
    "updated_at": "2023-01-18T20:27:05Z",
    "author_association": "CONTRIBUTOR",
    "body": "I believe this is happening because `i` is stored in memory after `_ids`. As `_ids` has reserved one word for its length as well as `10**12` words for its content, `i` must be stored at a very large index in the memory and hence a call to `get_values` cost excessive amount of gas.\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1387737685/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 1,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1396174760",
    "html_url": "https://github.com/vyperlang/vyper/issues/3234#issuecomment-1396174760",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/3234",
    "id": 1396174760,
    "node_id": "IC_kwDOBGDvrM5TN--o",
    "user": {
      "login": "jaglinux",
      "id": 1555686,
      "node_id": "MDQ6VXNlcjE1NTU2ODY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1555686?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jaglinux",
      "html_url": "https://github.com/jaglinux",
      "followers_url": "https://api.github.com/users/jaglinux/followers",
      "following_url": "https://api.github.com/users/jaglinux/following{/other_user}",
      "gists_url": "https://api.github.com/users/jaglinux/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jaglinux/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jaglinux/subscriptions",
      "organizations_url": "https://api.github.com/users/jaglinux/orgs",
      "repos_url": "https://api.github.com/users/jaglinux/repos",
      "events_url": "https://api.github.com/users/jaglinux/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jaglinux/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-01-18T22:25:40Z",
    "updated_at": "2023-01-18T22:25:40Z",
    "author_association": "CONTRIBUTOR",
    "body": "10 ** 12 is too high. I tried with \r\n`MAX_NUM: public(constant(uint256)) = 100`\r\nand it works.\r\nMaybe range function creates the sequence of number on the fly and hence out of gas exception for bigger range values ?",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1396174760/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1396283590",
    "html_url": "https://github.com/vyperlang/vyper/issues/3234#issuecomment-1396283590",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/3234",
    "id": 1396283590,
    "node_id": "IC_kwDOBGDvrM5TOZjG",
    "user": {
      "login": "charles-cooper",
      "id": 3867501,
      "node_id": "MDQ6VXNlcjM4Njc1MDE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3867501?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/charles-cooper",
      "html_url": "https://github.com/charles-cooper",
      "followers_url": "https://api.github.com/users/charles-cooper/followers",
      "following_url": "https://api.github.com/users/charles-cooper/following{/other_user}",
      "gists_url": "https://api.github.com/users/charles-cooper/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/charles-cooper/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/charles-cooper/subscriptions",
      "organizations_url": "https://api.github.com/users/charles-cooper/orgs",
      "repos_url": "https://api.github.com/users/charles-cooper/repos",
      "events_url": "https://api.github.com/users/charles-cooper/events{/privacy}",
      "received_events_url": "https://api.github.com/users/charles-cooper/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-01-19T00:31:15Z",
    "updated_at": "2023-01-19T00:31:15Z",
    "author_association": "COLLABORATOR",
    "body": "right, the issue has to do with the fact that the memory is statically allocated. do you really want to return such a large array (in the worst case)?",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1396283590/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1396315329",
    "html_url": "https://github.com/vyperlang/vyper/issues/3234#issuecomment-1396315329",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/3234",
    "id": 1396315329,
    "node_id": "IC_kwDOBGDvrM5TOhTB",
    "user": {
      "login": "jaglinux",
      "id": 1555686,
      "node_id": "MDQ6VXNlcjE1NTU2ODY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1555686?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jaglinux",
      "html_url": "https://github.com/jaglinux",
      "followers_url": "https://api.github.com/users/jaglinux/followers",
      "following_url": "https://api.github.com/users/jaglinux/following{/other_user}",
      "gists_url": "https://api.github.com/users/jaglinux/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jaglinux/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jaglinux/subscriptions",
      "organizations_url": "https://api.github.com/users/jaglinux/orgs",
      "repos_url": "https://api.github.com/users/jaglinux/repos",
      "events_url": "https://api.github.com/users/jaglinux/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jaglinux/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-01-19T01:13:16Z",
    "updated_at": "2023-01-19T01:13:16Z",
    "author_association": "CONTRIBUTOR",
    "body": "Right! OP is @milkyklim and can explain about return of large array.",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1396315329/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1396420252",
    "html_url": "https://github.com/vyperlang/vyper/issues/3234#issuecomment-1396420252",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/3234",
    "id": 1396420252,
    "node_id": "IC_kwDOBGDvrM5TO66c",
    "user": {
      "login": "fubuloubu",
      "id": 3859395,
      "node_id": "MDQ6VXNlcjM4NTkzOTU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3859395?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fubuloubu",
      "html_url": "https://github.com/fubuloubu",
      "followers_url": "https://api.github.com/users/fubuloubu/followers",
      "following_url": "https://api.github.com/users/fubuloubu/following{/other_user}",
      "gists_url": "https://api.github.com/users/fubuloubu/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fubuloubu/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fubuloubu/subscriptions",
      "organizations_url": "https://api.github.com/users/fubuloubu/orgs",
      "repos_url": "https://api.github.com/users/fubuloubu/repos",
      "events_url": "https://api.github.com/users/fubuloubu/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fubuloubu/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-01-19T04:19:15Z",
    "updated_at": "2023-01-19T04:20:07Z",
    "author_association": "MEMBER",
    "body": "Ahhh, okay @milkyklim this is the problem! when you try to create such a large memory array, gas usage for memory is quadratic with the number of elements! and vyper creates space for that large of an array to exist to ensure no memory corruption.\r\n\r\nit becomes a problem when you have a memory variable defined _after_ the array (in this case, `i` in the `range` function), because that variable gets created at position `MAX_NUM + 1` (more or less), which costs... well, over `10 ** 24` gas",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1396420252/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1396950912",
    "html_url": "https://github.com/vyperlang/vyper/issues/3234#issuecomment-1396950912",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/3234",
    "id": 1396950912,
    "node_id": "IC_kwDOBGDvrM5TQ8eA",
    "user": {
      "login": "fubuloubu",
      "id": 3859395,
      "node_id": "MDQ6VXNlcjM4NTkzOTU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3859395?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fubuloubu",
      "html_url": "https://github.com/fubuloubu",
      "followers_url": "https://api.github.com/users/fubuloubu/followers",
      "following_url": "https://api.github.com/users/fubuloubu/following{/other_user}",
      "gists_url": "https://api.github.com/users/fubuloubu/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fubuloubu/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fubuloubu/subscriptions",
      "organizations_url": "https://api.github.com/users/fubuloubu/orgs",
      "repos_url": "https://api.github.com/users/fubuloubu/repos",
      "events_url": "https://api.github.com/users/fubuloubu/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fubuloubu/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-01-19T13:08:53Z",
    "updated_at": "2023-01-19T13:08:53Z",
    "author_association": "MEMBER",
    "body": "Talked more offline, a good solution here might be to create a warning when a dynarray would create memory expansion that costs more than a specific amount, say 1m gas units, and suggest that the user reduce the size of the array, or make it the last item in memory so that the expansion doesn't take affect (unless you use it) ",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1396950912/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1397188595",
    "html_url": "https://github.com/vyperlang/vyper/issues/3234#issuecomment-1397188595",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/3234",
    "id": 1397188595,
    "node_id": "IC_kwDOBGDvrM5TR2fz",
    "user": {
      "login": "charles-cooper",
      "id": 3867501,
      "node_id": "MDQ6VXNlcjM4Njc1MDE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3867501?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/charles-cooper",
      "html_url": "https://github.com/charles-cooper",
      "followers_url": "https://api.github.com/users/charles-cooper/followers",
      "following_url": "https://api.github.com/users/charles-cooper/following{/other_user}",
      "gists_url": "https://api.github.com/users/charles-cooper/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/charles-cooper/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/charles-cooper/subscriptions",
      "organizations_url": "https://api.github.com/users/charles-cooper/orgs",
      "repos_url": "https://api.github.com/users/charles-cooper/repos",
      "events_url": "https://api.github.com/users/charles-cooper/events{/privacy}",
      "received_events_url": "https://api.github.com/users/charles-cooper/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-01-19T15:45:24Z",
    "updated_at": "2023-01-19T15:45:24Z",
    "author_association": "COLLABORATOR",
    "body": "> Talked more offline, a good solution here might be to create a warning when a dynarray would create memory expansion that costs more than a specific amount, say 1m gas units, and suggest that the user reduce the size of the array, or make it the last item in memory so that the expansion doesn't take affect (unless you use it)\r\n\r\nyea i was going to mention this -- going to close this issue and create a new issue to track the warning",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1397188595/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
