{
  "url": "https://api.github.com/repos/vyperlang/vyper/issues/3699",
  "repository_url": "https://api.github.com/repos/vyperlang/vyper",
  "labels_url": "https://api.github.com/repos/vyperlang/vyper/issues/3699/labels{/name}",
  "comments_url": "https://api.github.com/repos/vyperlang/vyper/issues/3699/comments",
  "events_url": "https://api.github.com/repos/vyperlang/vyper/issues/3699/events",
  "html_url": "https://github.com/vyperlang/vyper/issues/3699",
  "id": 2045304331,
  "node_id": "I_kwDOBGDvrM556N4L",
  "number": 3699,
  "title": "VIP [DRAFT]: Safely expose `DELEGATECALL`",
  "user": {
    "login": "makemake-kbo",
    "id": 55022497,
    "node_id": "MDQ6VXNlcjU1MDIyNDk3",
    "avatar_url": "https://avatars.githubusercontent.com/u/55022497?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/makemake-kbo",
    "html_url": "https://github.com/makemake-kbo",
    "followers_url": "https://api.github.com/users/makemake-kbo/followers",
    "following_url": "https://api.github.com/users/makemake-kbo/following{/other_user}",
    "gists_url": "https://api.github.com/users/makemake-kbo/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/makemake-kbo/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/makemake-kbo/subscriptions",
    "organizations_url": "https://api.github.com/users/makemake-kbo/orgs",
    "repos_url": "https://api.github.com/users/makemake-kbo/repos",
    "events_url": "https://api.github.com/users/makemake-kbo/events{/privacy}",
    "received_events_url": "https://api.github.com/users/makemake-kbo/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2023-12-17T17:33:52Z",
  "updated_at": "2023-12-20T19:57:33Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "## Simple Summary\r\nAllow Vyper contracts to safely `DELEGATECALL` into other Vyper contracts by enforcing strict storage slot layouts between contracts.\r\n\r\n## Motivation\r\n`DELEGATECALL` allows a contract to delegate its execution context to another contract. This is a very powerful tool, enabling patterns like minimal proxies, upgradeable contracts, and more. As it delegates execution, `DELEGATECALL`ing into a malicious or buggy contract can be fatal.  \r\n\r\nWe assume that storage and execution are always linear and predictable. With `DELEGATECALL` this is no longer the case. While working with `DELEGATECALL`, we have to keep a mental model of storage slots between multiple contracts in mind.\r\n\r\nTo mitigate this, Vyper should enforce compiler level storage slot layouts. Forcing proxies to implement the same storage layout the contract they're calling has. \r\n\r\n## Specification\r\nAdd a new keyword `storage`. Every single contract that uses storage slots needs to define it's storage layout:\r\n```py\r\n# Parent\r\n\r\nstorage number:\r\n    thing: uint256\r\n\r\n@external\r\ndef add(_value: uint256):\r\n    self.thing += _value\r\n\r\n# Proxy\r\n\r\nfrom parent import number\r\n\r\nproxies: number\r\n\r\ntarget: address\r\n\r\n@external\r\ndef __init__(_target: address):\r\n    self.target = _target\r\n\r\n@external\r\ndef add (_value: uint256):\r\n    # hypothetical delegatecall function that takes in:\r\n    # address of the contract we're delegatecalling into,\r\n    # its storage layout,\r\n    # the function we're calling,\r\n    # and data,\r\n    # as arguments.\r\n    delegatecall(target, number, \"add\", _value)\r\n\r\n```\r\n\r\nContracts that do not implement the same layout with the same types are invalid and fail to compile:\r\n```py\r\n# Invalid proxy\r\n\r\nstorage not_valid:\r\n    not_a_number: address\r\n[...]\r\n   # Error because we're not implementing `number`\r\n   delegatecall(target, number, \"add\", _value)\r\n[...]\r\n```\r\nThis proposal would also be compatible with the https://github.com/vyperlang/vyper/issues/3556 syntax:\r\n```py\r\n[...]\r\nstorage overriden:\r\n   implementation: public(address) @ 0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc\r\n   admin: public(address) @ 0xb53127684a568b3173ae13b9f8a6016e243e63b6e8ee1178d6a717850b5d6103\r\n[...]\r\n```\r\n\r\n## Backwards Compatibility\r\nThe proposed specification is not backwards compatible with any Vyper version.\r\n\r\n## Dependencies\r\nProbably libraries?\r\n\r\n## References\r\n\r\nStorage slot override syntax: https://github.com/vyperlang/vyper/issues/3556\r\nInitial `DELEGATECALL` discussion: https://github.com/vyperlang/vyper/issues/1015\r\n\r\n## Copyright\r\nCopyright and related rights waived via [CC0](https://creativecommons.org/publicdomain/zero/1.0/)\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/3699/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/vyperlang/vyper/issues/3699/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1861052522",
    "html_url": "https://github.com/vyperlang/vyper/issues/3699#issuecomment-1861052522",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/3699",
    "id": 1861052522,
    "node_id": "IC_kwDOBGDvrM5u7Whq",
    "user": {
      "login": "charles-cooper",
      "id": 3867501,
      "node_id": "MDQ6VXNlcjM4Njc1MDE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3867501?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/charles-cooper",
      "html_url": "https://github.com/charles-cooper",
      "followers_url": "https://api.github.com/users/charles-cooper/followers",
      "following_url": "https://api.github.com/users/charles-cooper/following{/other_user}",
      "gists_url": "https://api.github.com/users/charles-cooper/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/charles-cooper/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/charles-cooper/subscriptions",
      "organizations_url": "https://api.github.com/users/charles-cooper/orgs",
      "repos_url": "https://api.github.com/users/charles-cooper/repos",
      "events_url": "https://api.github.com/users/charles-cooper/events{/privacy}",
      "received_events_url": "https://api.github.com/users/charles-cooper/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-12-18T16:56:15Z",
    "updated_at": "2023-12-18T16:56:15Z",
    "author_association": "COLLABORATOR",
    "body": "maybe the name `proxies:` makes sense instead of `implements storage:`",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1861052522/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1865054180",
    "html_url": "https://github.com/vyperlang/vyper/issues/3699#issuecomment-1865054180",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/3699",
    "id": 1865054180,
    "node_id": "IC_kwDOBGDvrM5vKnfk",
    "user": {
      "login": "charles-cooper",
      "id": 3867501,
      "node_id": "MDQ6VXNlcjM4Njc1MDE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3867501?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/charles-cooper",
      "html_url": "https://github.com/charles-cooper",
      "followers_url": "https://api.github.com/users/charles-cooper/followers",
      "following_url": "https://api.github.com/users/charles-cooper/following{/other_user}",
      "gists_url": "https://api.github.com/users/charles-cooper/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/charles-cooper/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/charles-cooper/subscriptions",
      "organizations_url": "https://api.github.com/users/charles-cooper/orgs",
      "repos_url": "https://api.github.com/users/charles-cooper/repos",
      "events_url": "https://api.github.com/users/charles-cooper/events{/privacy}",
      "received_events_url": "https://api.github.com/users/charles-cooper/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-12-20T19:57:32Z",
    "updated_at": "2023-12-20T19:57:32Z",
    "author_association": "COLLABORATOR",
    "body": "> Every single contract that uses storage slots needs to define it's storage layout:\r\n\r\nall contracts implicitly define a storage layout just by declaring variables. so we could even skip the `storage` keyword and instead of having the storage layout be a named member on the module, just have:\r\n```\r\nproxies: parent\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1865054180/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
