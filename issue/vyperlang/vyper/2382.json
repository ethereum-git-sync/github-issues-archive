{
  "url": "https://api.github.com/repos/vyperlang/vyper/issues/2382",
  "repository_url": "https://api.github.com/repos/vyperlang/vyper",
  "labels_url": "https://api.github.com/repos/vyperlang/vyper/issues/2382/labels{/name}",
  "comments_url": "https://api.github.com/repos/vyperlang/vyper/issues/2382/comments",
  "events_url": "https://api.github.com/repos/vyperlang/vyper/issues/2382/events",
  "html_url": "https://github.com/vyperlang/vyper/issues/2382",
  "id": 940413331,
  "node_id": "MDU6SXNzdWU5NDA0MTMzMzE=",
  "number": 2382,
  "title": "new technique for ternary operation",
  "user": {
    "login": "charles-cooper",
    "id": 3867501,
    "node_id": "MDQ6VXNlcjM4Njc1MDE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3867501?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/charles-cooper",
    "html_url": "https://github.com/charles-cooper",
    "followers_url": "https://api.github.com/users/charles-cooper/followers",
    "following_url": "https://api.github.com/users/charles-cooper/following{/other_user}",
    "gists_url": "https://api.github.com/users/charles-cooper/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/charles-cooper/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/charles-cooper/subscriptions",
    "organizations_url": "https://api.github.com/users/charles-cooper/orgs",
    "repos_url": "https://api.github.com/users/charles-cooper/repos",
    "events_url": "https://api.github.com/users/charles-cooper/events{/privacy}",
    "received_events_url": "https://api.github.com/users/charles-cooper/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2021-07-09T04:49:06Z",
  "updated_at": "2022-03-04T16:35:11Z",
  "closed_at": "2022-03-04T16:35:11Z",
  "author_association": "COLLABORATOR",
  "active_lock_reason": null,
  "body": "## Simple Summary\r\nStop using JUMPI, start using MUL.\r\n\r\n## Motivation\r\nThis is just an idea at this point (and I'm not sure if it's used in other EVM tooling yet...) but basically the following Vyper produces a JUMPI:\r\n```python\r\nx:uint256 = 0\r\nif x == 0:\r\n  x = 1\r\nelse:\r\n  x = 2\r\n```\r\n\r\nThe relevant asm looks like this:\r\n```\r\n# x = 0\r\nPUSH1 0 \r\nPUSH2 1 96 \r\nMSTORE \r\nPUSH2 1 96 \r\n# x == 0\r\nMLOAD \r\nISZERO \r\nISZERO \r\n_sym_4 \r\n# if...\r\nJUMPI \r\n# x = 1\r\nPUSH1 1 \r\nPUSH2 1 96 \r\nMSTORE \r\n_sym_5 \r\nJUMP # exit block\r\n_sym_4 \r\n# else...\r\nJUMPDEST \r\n# x = 2\r\nPUSH1 2 \r\nPUSH2 1 96 \r\nMSTORE \r\n_sym_5 \r\nJUMPDEST # let's bounce\r\n```\r\nSo you can see that this is wasteful both in code bloat and gas because it has to use JUMPI (gas 10), and create all these JUMPDESTs (gas 1) and JUMP (gas 8). JUMPI is so expensive in this case we could actually calculate both branches for less. The idea is to calculate both sides of the branch and then use a selector (kind of like a true jump table) to return the correct value. Here's a prototype in hand-rolled vyper:\r\n```python\r\n  x:uint256 = 0\r\n  ofst:uint256 = convert(x == 0, uint256)\r\n  selector:uint256[2] = [1,2]\r\n  x = selector[ofst]\r\n```\r\nThis doesn't currently produce great asm but it COULD produce something like the following\r\n```\r\nmstore 160 0 # x = 0\r\nmstore 192 1\r\nmstore 224 2\r\nmload(192 + 32 * iszero (mload 160))\r\n```\r\n\r\nYou get the idea, maybe. No JUMP* instructions, just a little MUL and ADD. I haven't figured out how to save the selector on the stack, but that might be impossible (since stack manipulation instructions all refer to static locations in the stack, i.e. there is no dynamic SWAP(iszero(x)) instruction).\r\n\r\n## Copyright\r\nCopyright and related rights waived via [CC0](https://creativecommons.org/publicdomain/zero/1.0/)\r\n",
  "closed_by": {
    "login": "charles-cooper",
    "id": 3867501,
    "node_id": "MDQ6VXNlcjM4Njc1MDE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3867501?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/charles-cooper",
    "html_url": "https://github.com/charles-cooper",
    "followers_url": "https://api.github.com/users/charles-cooper/followers",
    "following_url": "https://api.github.com/users/charles-cooper/following{/other_user}",
    "gists_url": "https://api.github.com/users/charles-cooper/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/charles-cooper/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/charles-cooper/subscriptions",
    "organizations_url": "https://api.github.com/users/charles-cooper/orgs",
    "repos_url": "https://api.github.com/users/charles-cooper/repos",
    "events_url": "https://api.github.com/users/charles-cooper/events{/privacy}",
    "received_events_url": "https://api.github.com/users/charles-cooper/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/2382/reactions",
    "total_count": 1,
    "+1": 1,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/vyperlang/vyper/issues/2382/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/883027355",
    "html_url": "https://github.com/vyperlang/vyper/issues/2382#issuecomment-883027355",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/2382",
    "id": 883027355,
    "node_id": "IC_kwDOBGDvrM40oe2b",
    "user": {
      "login": "charles-cooper",
      "id": 3867501,
      "node_id": "MDQ6VXNlcjM4Njc1MDE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3867501?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/charles-cooper",
      "html_url": "https://github.com/charles-cooper",
      "followers_url": "https://api.github.com/users/charles-cooper/followers",
      "following_url": "https://api.github.com/users/charles-cooper/following{/other_user}",
      "gists_url": "https://api.github.com/users/charles-cooper/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/charles-cooper/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/charles-cooper/subscriptions",
      "organizations_url": "https://api.github.com/users/charles-cooper/orgs",
      "repos_url": "https://api.github.com/users/charles-cooper/repos",
      "events_url": "https://api.github.com/users/charles-cooper/events{/privacy}",
      "received_events_url": "https://api.github.com/users/charles-cooper/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-07-20T03:42:31Z",
    "updated_at": "2021-07-20T03:42:46Z",
    "author_association": "COLLABORATOR",
    "body": "Notes to self, here is hand-rolled ternary operator for stack items implemented a couple different ways\r\n\r\n```asm\r\nx = 3 if x == 13 else 2\r\n\r\n# suppose x starts at 17\r\npush1 17     # stack: 17\r\n# check x == 13\r\npush1 13     # stack: 17, 13\r\neq           # stack: false (aka 0)\r\n# select by mul'ing\r\npush1 2      # stack: false, true, 2\r\nmul          # stack: false, 2\r\n# now try the other one\r\nswap1        # stack: 2, false\r\npush1 1      # stack: 2, false, 1\r\nmul          # stack: 2, 0\r\n# add them together to get the final answer\r\nadd          # stack: 2\r\n# we did it!\r\n\r\n# same thing but using bits\r\npush1 17 push1 13 eq # 0\r\npush1 0 sub          # 0\r\ndup1                 # 0, 0\r\npush1 2 and          # 0, 0\r\nswap1 not            # 0, -1\r\npush1 3 and          # 0, 3\r\nor                   # 3\r\n\r\n  \r\n# for comparison, the JUMPI way\r\npush1 17\r\npush1 13\r\neq\r\npush2 _iftrue\r\njumpi\r\n# evaluated to false\r\npush1 3\r\n_iftrue\r\njumpdest\r\npush1 2\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/883027355/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
