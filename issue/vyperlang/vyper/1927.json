{
  "url": "https://api.github.com/repos/vyperlang/vyper/issues/1927",
  "repository_url": "https://api.github.com/repos/vyperlang/vyper",
  "labels_url": "https://api.github.com/repos/vyperlang/vyper/issues/1927/labels{/name}",
  "comments_url": "https://api.github.com/repos/vyperlang/vyper/issues/1927/comments",
  "events_url": "https://api.github.com/repos/vyperlang/vyper/issues/1927/events",
  "html_url": "https://github.com/vyperlang/vyper/issues/1927",
  "id": 600206609,
  "node_id": "MDU6SXNzdWU2MDAyMDY2MDk=",
  "number": 1927,
  "title": "Vyper runtime source map is broken for mapping `MSTORE` to memory variables",
  "user": {
    "login": "Pet3ris",
    "id": 224585,
    "node_id": "MDQ6VXNlcjIyNDU4NQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/224585?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Pet3ris",
    "html_url": "https://github.com/Pet3ris",
    "followers_url": "https://api.github.com/users/Pet3ris/followers",
    "following_url": "https://api.github.com/users/Pet3ris/following{/other_user}",
    "gists_url": "https://api.github.com/users/Pet3ris/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Pet3ris/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Pet3ris/subscriptions",
    "organizations_url": "https://api.github.com/users/Pet3ris/orgs",
    "repos_url": "https://api.github.com/users/Pet3ris/repos",
    "events_url": "https://api.github.com/users/Pet3ris/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Pet3ris/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 479554962,
      "node_id": "MDU6TGFiZWw0Nzk1NTQ5NjI=",
      "url": "https://api.github.com/repos/vyperlang/vyper/labels/bug",
      "name": "bug",
      "color": "ee0701",
      "default": true,
      "description": "Bug that shouldn't change language semantics when fixed."
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2020-04-15T10:52:08Z",
  "updated_at": "2022-04-08T16:26:34Z",
  "closed_at": "2022-04-07T03:51:03Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Version Information\r\n\r\n* vyper Version (output of `vyper --version`): `0.1.0b17+commit.0671b7b`\r\n* OS: OS X\r\n* Python Version (output of `python --version`): Python 3.7.5\r\n* Environment (output of `pip freeze`):\r\n\r\n```\r\naniso8601==7.0.0\r\nappdirs==1.4.3\r\nasttokens==2.0.3\r\nattrdict==2.0.1\r\nattrs==19.3.0\r\nbase58==1.0.3\r\nblack==19.10b0\r\nblake2b-py==0.1.3\r\ncached-property==1.5.1\r\ncertifi==2019.11.28\r\nchardet==3.0.4\r\nClick==7.0\r\ncytoolz==0.10.1\r\neth-abi==2.1.0\r\neth-account==0.4.0\r\neth-bloom==1.0.3\r\neth-hash==0.2.0\r\neth-keyfile==0.5.1\r\neth-keys==0.2.4\r\neth-rlp==0.1.2\r\neth-tester==0.2.0b2\r\neth-typing==2.2.1\r\neth-utils==1.8.4\r\nFlask==1.1.1\r\nFlask-Cors==3.0.8\r\nFlask-GraphQL==2.0.1\r\ngraphene==2.1.8\r\ngraphql-core==2.2.1\r\ngraphql-relay==2.0.1\r\ngraphql-server-core==1.1.3\r\nhexbytes==0.2.0\r\nidna==2.8\r\nimportlib-metadata==1.3.0\r\nipfshttpclient==0.4.12\r\nitsdangerous==1.1.0\r\nJinja2==2.10.3\r\njsonschema==3.2.0\r\nlru-dict==1.1.6\r\nMarkupSafe==1.1.1\r\nmore-itertools==8.0.2\r\nmultiaddr==0.0.8\r\nmypy==0.761\r\nmypy-extensions==0.4.3\r\nnetaddr==0.7.19\r\npackaging==20.1\r\nparsimonious==0.8.1\r\npathspec==0.7.0\r\npluggy==0.13.1\r\npromise==2.3\r\nprotobuf==3.11.1\r\npy==1.8.1\r\npy-ecc==1.7.1\r\npy-evm==0.3.0a1\r\npy-geth==2.2.0\r\npycryptodome==3.9.4\r\npyethash==0.1.27\r\npyparsing==2.4.6\r\npyrsistent==0.15.6\r\npytest==5.3.5\r\nregex==2020.1.8\r\nrequests==2.22.0\r\nrlp==1.2.0\r\nRx==1.6.1\r\nsemantic-version==2.8.4\r\nsix==1.13.0\r\ntoml==0.10.0\r\ntoolz==0.10.0\r\ntrie==1.4.0\r\ntyped-ast==1.4.1\r\ntyping-extensions==3.7.4.1\r\nurllib3==1.25.7\r\nvarint==1.0.2\r\nvyper==0.1.0b17\r\nwcwidth==0.1.8\r\nweb3==5.6.0\r\nwebsockets==8.1\r\nWerkzeug==0.16.0\r\nzipp==0.6.0\r\n```\r\n\r\n### What's your issue about?\r\n\r\nWe're using the Vyper source maps for debugging and they don't seem to map correctly for memory variables.\r\n\r\nIn particular for the following contract:\r\n\r\n```python\r\ns: uint256\r\n\r\n@public\r\ndef action(a: uint256) -> uint256:\r\n    x: uint256 = 0\r\n    self.s = 1\r\n\r\n    return 0\r\n```\r\n\r\nwe get the following source map:\r\n\r\n`-1:-1:0:-;;;;;:::-;;:::-;:::-;;;;;;;;;;;;;;;;;;;;12:90;;;;;;:::-;;;;:::-;;;;:::-;-1:-1;59:14;12:90;-1:-1;78:6;:10;101:1;94:8;;;;;12:90;;:::-;-1:-1::-;;;;`\r\n\r\nThe line `x: uint256 = 0` should be the mapping for the 46th instruction, `MSTORE`, but in the source map this is not the case (the 46-th semicolon follows `12:90`, which maps to the whole function and only the previous semicolon (`PUSH`) touches `59:14`, the correct value.\r\n\r\nFull source mapping for your info, you can see the line PC=192 is incorrectly mapped.\r\n\r\n```\r\nOPCODE: 0x60 (PUSH1) | pc: 0\r\nOPCODE: 0x36 (CALLDATASIZE) | pc: 2\r\nOPCODE: 0x10 (LT) | pc: 3\r\nOPCODE: 0x15 (ISZERO) | pc: 4\r\nOPCODE: 0x61 (PUSH2) | pc: 5\r\nOPCODE: 0x57 (JUMPI) | pc: 8\r\nOPCODE: 0x5b (JUMPDEST) | pc: 13\r\nOPCODE: 0x60 (PUSH1) | pc: 14\r\nOPCODE: 0x35 (CALLDATALOAD) | pc: 16\r\nOPCODE: 0x60 (PUSH1) | pc: 17\r\nOPCODE: 0x52 (MSTORE) | pc: 19\r\nOPCODE: 0x74 (PUSH21) | pc: 20\r\nOPCODE: 0x60 (PUSH1) | pc: 42\r\nOPCODE: 0x52 (MSTORE) | pc: 44\r\nOPCODE: 0x6f (PUSH16) | pc: 45\r\nOPCODE: 0x60 (PUSH1) | pc: 62\r\nOPCODE: 0x52 (MSTORE) | pc: 64\r\nOPCODE: 0x7f (PUSH32) | pc: 65\r\nOPCODE: 0x60 (PUSH1) | pc: 98\r\nOPCODE: 0x52 (MSTORE) | pc: 100\r\nOPCODE: 0x74 (PUSH21) | pc: 101\r\nOPCODE: 0x60 (PUSH1) | pc: 123\r\nOPCODE: 0x52 (MSTORE) | pc: 125\r\nOPCODE: 0x7f (PUSH32) | pc: 126\r\nOPCODE: 0x60 (PUSH1) | pc: 159\r\nOPCODE: 0x52 (MSTORE) | pc: 161\r\nOPCODE: 0x63 (PUSH4) | pc: 162\r\n@public\r\ndef action(a: uint256) -> uint256:\r\n    x: uint256 = 0\r\n    self.s = 1\r\n\r\n    return 0\r\nOPCODE: 0x60 (PUSH1) | pc: 167\r\n@public\r\ndef action(a: uint256) -> uint256:\r\n    x: uint256 = 0\r\n    self.s = 1\r\n\r\n    return 0\r\nOPCODE: 0x51 (MLOAD) | pc: 169\r\n@public\r\ndef action(a: uint256) -> uint256:\r\n    x: uint256 = 0\r\n    self.s = 1\r\n\r\n    return 0\r\nOPCODE: 0x14 (EQ) | pc: 170\r\n@public\r\ndef action(a: uint256) -> uint256:\r\n    x: uint256 = 0\r\n    self.s = 1\r\n\r\n    return 0\r\nOPCODE: 0x15 (ISZERO) | pc: 171\r\n@public\r\ndef action(a: uint256) -> uint256:\r\n    x: uint256 = 0\r\n    self.s = 1\r\n\r\n    return 0\r\nOPCODE: 0x61 (PUSH2) | pc: 172\r\n@public\r\ndef action(a: uint256) -> uint256:\r\n    x: uint256 = 0\r\n    self.s = 1\r\n\r\n    return 0\r\nOPCODE: 0x57 (JUMPI) | pc: 175\r\n@public\r\ndef action(a: uint256) -> uint256:\r\n    x: uint256 = 0\r\n    self.s = 1\r\n\r\n    return 0\r\nOPCODE: 0x34 (CALLVALUE) | pc: 176\r\n@public\r\ndef action(a: uint256) -> uint256:\r\n    x: uint256 = 0\r\n    self.s = 1\r\n\r\n    return 0\r\nOPCODE: 0x15 (ISZERO) | pc: 177\r\n@public\r\ndef action(a: uint256) -> uint256:\r\n    x: uint256 = 0\r\n    self.s = 1\r\n\r\n    return 0\r\nOPCODE: 0x61 (PUSH2) | pc: 178\r\n@public\r\ndef action(a: uint256) -> uint256:\r\n    x: uint256 = 0\r\n    self.s = 1\r\n\r\n    return 0\r\nOPCODE: 0x57 (JUMPI) | pc: 181\r\n@public\r\ndef action(a: uint256) -> uint256:\r\n    x: uint256 = 0\r\n    self.s = 1\r\n\r\n    return 0\r\nOPCODE: 0x5b (JUMPDEST) | pc: 186\r\n@public\r\ndef action(a: uint256) -> uint256:\r\n    x: uint256 = 0\r\n    self.s = 1\r\n\r\n    return 0\r\nOPCODE: 0x60 (PUSH1) | pc: 187\r\nOPCODE: 0x61 (PUSH2) | pc: 189\r\nx: uint256 = 0\r\nOPCODE: 0x52 (MSTORE) | pc: 192\r\n@public\r\ndef action(a: uint256) -> uint256:\r\n    x: uint256 = 0\r\n    self.s = 1\r\n\r\n    return 0\r\nOPCODE: 0x60 (PUSH1) | pc: 193\r\nOPCODE: 0x60 (PUSH1) | pc: 195\r\nself.s\r\nOPCODE: 0x55 (SSTORE) | pc: 197\r\nself.s = 1\r\nOPCODE: 0x60 (PUSH1) | pc: 198\r\n0\r\nOPCODE: 0x60 (PUSH1) | pc: 200\r\nreturn 0\r\nOPCODE: 0x52 (MSTORE) | pc: 202\r\nreturn 0\r\nOPCODE: 0x60 (PUSH1) | pc: 203\r\nreturn 0\r\nOPCODE: 0x60 (PUSH1) | pc: 205\r\nreturn 0\r\nOPCODE: 0xf3 (RETURN) | pc: 207\r\nreturn 0\r\n```\r\n\r\n### How can it be fixed?\r\n\r\nSource map should map to the correct line. Is there a reason MSTORE goes back to map to the whole function?\r\n",
  "closed_by": {
    "login": "charles-cooper",
    "id": 3867501,
    "node_id": "MDQ6VXNlcjM4Njc1MDE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3867501?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/charles-cooper",
    "html_url": "https://github.com/charles-cooper",
    "followers_url": "https://api.github.com/users/charles-cooper/followers",
    "following_url": "https://api.github.com/users/charles-cooper/following{/other_user}",
    "gists_url": "https://api.github.com/users/charles-cooper/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/charles-cooper/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/charles-cooper/subscriptions",
    "organizations_url": "https://api.github.com/users/charles-cooper/orgs",
    "repos_url": "https://api.github.com/users/charles-cooper/repos",
    "events_url": "https://api.github.com/users/charles-cooper/events{/privacy}",
    "received_events_url": "https://api.github.com/users/charles-cooper/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/1927/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/vyperlang/vyper/issues/1927/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1091050439",
    "html_url": "https://github.com/vyperlang/vyper/issues/1927#issuecomment-1091050439",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/1927",
    "id": 1091050439,
    "node_id": "IC_kwDOBGDvrM5BCBvH",
    "user": {
      "login": "charles-cooper",
      "id": 3867501,
      "node_id": "MDQ6VXNlcjM4Njc1MDE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3867501?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/charles-cooper",
      "html_url": "https://github.com/charles-cooper",
      "followers_url": "https://api.github.com/users/charles-cooper/followers",
      "following_url": "https://api.github.com/users/charles-cooper/following{/other_user}",
      "gists_url": "https://api.github.com/users/charles-cooper/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/charles-cooper/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/charles-cooper/subscriptions",
      "organizations_url": "https://api.github.com/users/charles-cooper/orgs",
      "repos_url": "https://api.github.com/users/charles-cooper/repos",
      "events_url": "https://api.github.com/users/charles-cooper/events{/privacy}",
      "received_events_url": "https://api.github.com/users/charles-cooper/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-04-07T03:51:03Z",
    "updated_at": "2022-04-07T03:51:03Z",
    "author_association": "COLLABORATOR",
    "body": "this problem no longer exists in the version of vyper (7e0cf2ad8c6bbbbca4b1f6dd77c69b20d81393ca). i'm not sure when it was fixed, but i checked the following code\r\n```vyper\r\n\r\ns: uint256\r\n\r\n@external\r\ndef action(a: uint256) -> uint256:\r\n    x: uint256 = 0  # line 6\r\n    self.s = 1\r\n\r\n    return 0\r\n```\r\nthe generated source map is\r\n```json\r\n{\"breakpoints\": [], \"pc_breakpoints\": [], \"pc_jump_map\": {\"0\": \"-\", \"8\": \"-\", \"12\": \"-\", \"13\": \"-\", \"24\": \"-\", \"35\": \"-\", \"56\": \"-\", \"58\": \"-\", \"64\": \"-\"}, \"pc_pos_map\": {\"32\": [5, 0, 9, 12], \"35\": [5, 0, 9, 12], \"36\": [6, 17, 6, 18], \"38\": [6, 4, 6, 18], \"40\": [6, 4, 6, 18], \"41\": [7, 13, 7, 14], \"43\": [7, 4, 7, 10], \"45\": [7, 4, 7, 14], \"46\": [9, 11, 9, 12], \"53\": [9, 4, 9, 12], \"56\": [5, 0, 9, 12]}, \"pc_pos_map_compressed\": \"-1:-1:0:-;;;;;:::-;;:::-;:::-;;;;;;;:::-;;;;23:82;:::-;75:1;62:14;;90:1;81:6;:10;104:1;-1:-1;;;97:8;-1:-1;23:82::-;-1:-1;:::-;;;;:::-;;;;\"}\r\n```\r\nyou can see that line 6 maps to opcode 36 (0x24). inspecting the opcodes of the runtime bytecode, we see that 0x24 corresponds to the sequence of instructions `PUSH1 0x00 PUSH1 0x40 MSTORE`, which is the instructions to set `x` to 0.\r\n```\r\n00000: PUSH1 0x04\r\n00002: CALLDATASIZE\r\n00003: LT\r\n00004: ISZERO\r\n00005: PUSH2 0x000d\r\n00008: JUMPI\r\n00009: PUSH2 0x003a\r\n0000c: JUMP\r\n0000d: JUMPDEST\r\n0000e: PUSH1 0x00\r\n00010: CALLDATALOAD\r\n00011: PUSH1 0xe0\r\n00013: SHR\r\n00014: CALLVALUE\r\n00015: PUSH2 0x0040\r\n00018: JUMPI\r\n00019: PUSH4 0xaf130628\r\n0001e: DUP2\r\n0001f: XOR\r\n00020: PUSH2 0x0038\r\n00023: JUMPI\r\n00024: PUSH1 0x00\r\n00026: PUSH1 0x40\r\n00028: MSTORE\r\n00029: PUSH1 0x01\r\n0002b: PUSH1 0x00\r\n0002d: SSTORE\r\n0002e: PUSH1 0x00\r\n00030: PUSH1 0x60\r\n00032: MSTORE\r\n00033: PUSH1 0x20\r\n00035: PUSH1 0x60\r\n00037: RETURN\r\n00038: JUMPDEST\r\n00039: POP\r\n0003a: JUMPDEST\r\n0003b: PUSH1 0x00\r\n0003d: PUSH1 0x00\r\n0003f: REVERT\r\n00040: JUMPDEST\r\n00041: PUSH1 0x00\r\n00043: DUP1\r\n00044: REVERT\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1091050439/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1092390329",
    "html_url": "https://github.com/vyperlang/vyper/issues/1927#issuecomment-1092390329",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/1927",
    "id": 1092390329,
    "node_id": "IC_kwDOBGDvrM5BHI25",
    "user": {
      "login": "charles-cooper",
      "id": 3867501,
      "node_id": "MDQ6VXNlcjM4Njc1MDE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3867501?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/charles-cooper",
      "html_url": "https://github.com/charles-cooper",
      "followers_url": "https://api.github.com/users/charles-cooper/followers",
      "following_url": "https://api.github.com/users/charles-cooper/following{/other_user}",
      "gists_url": "https://api.github.com/users/charles-cooper/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/charles-cooper/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/charles-cooper/subscriptions",
      "organizations_url": "https://api.github.com/users/charles-cooper/orgs",
      "repos_url": "https://api.github.com/users/charles-cooper/repos",
      "events_url": "https://api.github.com/users/charles-cooper/events{/privacy}",
      "received_events_url": "https://api.github.com/users/charles-cooper/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-04-08T02:50:07Z",
    "updated_at": "2022-04-08T02:50:07Z",
    "author_association": "COLLABORATOR",
    "body": "by the way, just want to point out that between the vyper that this issue was originally reported under, and the one i referenced above (7e0cf2ad8c6bb), the code size went from 217 to 69 bytes :)",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1092390329/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 1,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1093064265",
    "html_url": "https://github.com/vyperlang/vyper/issues/1927#issuecomment-1093064265",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/1927",
    "id": 1093064265,
    "node_id": "IC_kwDOBGDvrM5BJtZJ",
    "user": {
      "login": "Pet3ris",
      "id": 224585,
      "node_id": "MDQ6VXNlcjIyNDU4NQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/224585?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Pet3ris",
      "html_url": "https://github.com/Pet3ris",
      "followers_url": "https://api.github.com/users/Pet3ris/followers",
      "following_url": "https://api.github.com/users/Pet3ris/following{/other_user}",
      "gists_url": "https://api.github.com/users/Pet3ris/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Pet3ris/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Pet3ris/subscriptions",
      "organizations_url": "https://api.github.com/users/Pet3ris/orgs",
      "repos_url": "https://api.github.com/users/Pet3ris/repos",
      "events_url": "https://api.github.com/users/Pet3ris/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Pet3ris/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-04-08T16:26:34Z",
    "updated_at": "2022-04-08T16:26:34Z",
    "author_association": "NONE",
    "body": "awesome to see the vyper progress @charles-cooper ",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1093064265/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
