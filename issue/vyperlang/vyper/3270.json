{
  "url": "https://api.github.com/repos/vyperlang/vyper/issues/3270",
  "repository_url": "https://api.github.com/repos/vyperlang/vyper",
  "labels_url": "https://api.github.com/repos/vyperlang/vyper/issues/3270/labels{/name}",
  "comments_url": "https://api.github.com/repos/vyperlang/vyper/issues/3270/comments",
  "events_url": "https://api.github.com/repos/vyperlang/vyper/issues/3270/events",
  "html_url": "https://github.com/vyperlang/vyper/issues/3270",
  "id": 1571283144,
  "node_id": "I_kwDOBGDvrM5dp-DI",
  "number": 3270,
  "title": "__init__ re-initializes DynArray after being populated by subroutine call.",
  "user": {
    "login": "scherrey",
    "id": 878591,
    "node_id": "MDQ6VXNlcjg3ODU5MQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/878591?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/scherrey",
    "html_url": "https://github.com/scherrey",
    "followers_url": "https://api.github.com/users/scherrey/followers",
    "following_url": "https://api.github.com/users/scherrey/following{/other_user}",
    "gists_url": "https://api.github.com/users/scherrey/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/scherrey/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/scherrey/subscriptions",
    "organizations_url": "https://api.github.com/users/scherrey/orgs",
    "repos_url": "https://api.github.com/users/scherrey/repos",
    "events_url": "https://api.github.com/users/scherrey/events{/privacy}",
    "received_events_url": "https://api.github.com/users/scherrey/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 4038640292,
      "node_id": "LA_kwDOBGDvrM7wuMKk",
      "url": "https://api.github.com/repos/vyperlang/vyper/labels/bug%20-%20codegen",
      "name": "bug - codegen",
      "color": "B60205",
      "default": false,
      "description": ""
    },
    {
      "id": 4038663662,
      "node_id": "LA_kwDOBGDvrM7wuR3u",
      "url": "https://api.github.com/repos/vyperlang/vyper/labels/bug%20-%20type%201",
      "name": "bug - type 1",
      "color": "f41348",
      "default": false,
      "description": "bug which results in incorrect codegen"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2023-02-05T06:26:18Z",
  "updated_at": "2023-02-12T15:02:13Z",
  "closed_at": "2023-02-12T15:02:12Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Version Information\r\n\r\n* vyper Version (output of `vyper --version`): 0.3.7\r\n* OS: `linux (5.14.0-4mx-amd64 #1 SMP Debian 5.14.16-1~mx21+1 (2021-11-05) x86_64 GNU/Linux)`\r\n* Python Version (output of `python --version`): 3.9.2\r\n\r\nNot sure if this is intentional or a bug but it sure seems counter intuitive and problematic to debug. My contract has a DynArray member which will get populated by iterating over an array passed into `__init__` by calling an internal method. However, if I don't explicitly initialize the DynArray *before* calling this internal method, the` __init__` seems to perform its own initialization of the DynArray after the internal method is called and empty the DynArray that was previously populated.\r\n\r\nSee the VYPER NOTE in the `__init__` function below. Comment out the initialization line under that note and the efforts performed by the add_pool() calls get erased and  self.dlending_pools is empty even though the add_pool() calls succeeded.\r\n\r\nHere's my ctor:\r\n\r\n```\r\n@external\r\ndef __init__(_name: String[64], _symbol: String[32], _decimals: uint8, _erc20asset : address, _pools: DynArray[address, MAX_POOLS]):\r\n\r\n    assert MAX_BALTX_DEPOSIT <= MAX_POOLS, \"Invalid contract pre-conditions.\"\r\n\r\n    dname = _name\r\n    dsymbol = _symbol\r\n    ddecimals = _decimals\r\n    derc20asset = _erc20asset\r\n\r\n    # VYPER NOTE - if we don't explicitly initialize dlending_pools here\r\n    #              the ctor will initialize it to empty AFTER the\r\n    #              _add_pool() loop completes and erase the passed in pools!\r\n    self.dlending_pools = empty(DynArray[address, MAX_POOLS])\r\n\r\n    self.owner = msg.sender\r\n    self.totalSupply = 0\r\n\r\n    for pool in _pools:\r\n        self._add_pool(pool)\r\n\r\n\r\n# Can't simply have a public lending_pools variable due to this Vyper issue:\r\n# https://github.com/vyperlang/vyper/issues/2897\r\n@view\r\n@external\r\ndef lending_pools() -> DynArray[address, MAX_POOLS]: return self.dlending_pools\r\n\r\n\r\n@internal \r\ndef _add_pool(_pool: address) -> bool:    \r\n    # Do we already support this pool?\r\n    assert (_pool in self.dlending_pools) == False, \"pool already supported.\"\r\n\r\n    # Is this likely to be an actual LPAdapter contract?\r\n    response: Bytes[32] = empty(Bytes[32])\r\n    result_ok: bool = empty(bool)\r\n\r\n    result_ok, response = raw_call(_pool, method_id(\"maxDepositable()\"), max_outsize=32, is_static_call=True, revert_on_failure=False)\r\n    assert (response != empty(Bytes[32])), \"Doesn't appear to be an LPAdapter.\"\r\n\r\n    self.dlending_pools.append(_pool)\r\n\r\n    log PoolAdded(msg.sender, _pool)\r\n\r\n    return True\r\n```\r\n\r\n### How can it be fixed?\r\n\r\nWORKAROUND: Explicit initialization of the DynArray before the subroutine call prevents this problem from manifesting itself.\r\n",
  "closed_by": {
    "login": "scherrey",
    "id": 878591,
    "node_id": "MDQ6VXNlcjg3ODU5MQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/878591?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/scherrey",
    "html_url": "https://github.com/scherrey",
    "followers_url": "https://api.github.com/users/scherrey/followers",
    "following_url": "https://api.github.com/users/scherrey/following{/other_user}",
    "gists_url": "https://api.github.com/users/scherrey/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/scherrey/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/scherrey/subscriptions",
    "organizations_url": "https://api.github.com/users/scherrey/orgs",
    "repos_url": "https://api.github.com/users/scherrey/repos",
    "events_url": "https://api.github.com/users/scherrey/events{/privacy}",
    "received_events_url": "https://api.github.com/users/scherrey/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/3270/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/vyperlang/vyper/issues/3270/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1418118298",
    "html_url": "https://github.com/vyperlang/vyper/issues/3270#issuecomment-1418118298",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/3270",
    "id": 1418118298,
    "node_id": "IC_kwDOBGDvrM5UhsSa",
    "user": {
      "login": "fubuloubu",
      "id": 3859395,
      "node_id": "MDQ6VXNlcjM4NTkzOTU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3859395?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fubuloubu",
      "html_url": "https://github.com/fubuloubu",
      "followers_url": "https://api.github.com/users/fubuloubu/followers",
      "following_url": "https://api.github.com/users/fubuloubu/following{/other_user}",
      "gists_url": "https://api.github.com/users/fubuloubu/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fubuloubu/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fubuloubu/subscriptions",
      "organizations_url": "https://api.github.com/users/fubuloubu/orgs",
      "repos_url": "https://api.github.com/users/fubuloubu/repos",
      "events_url": "https://api.github.com/users/fubuloubu/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fubuloubu/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-02-05T16:28:38Z",
    "updated_at": "2023-02-05T16:28:38Z",
    "author_association": "MEMBER",
    "body": "Hmm, yeah why is it initializing the array at all in the constructor? ",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1418118298/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1420126687",
    "html_url": "https://github.com/vyperlang/vyper/issues/3270#issuecomment-1420126687",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/3270",
    "id": 1420126687,
    "node_id": "IC_kwDOBGDvrM5UpWnf",
    "user": {
      "login": "tserg",
      "id": 8017125,
      "node_id": "MDQ6VXNlcjgwMTcxMjU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8017125?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tserg",
      "html_url": "https://github.com/tserg",
      "followers_url": "https://api.github.com/users/tserg/followers",
      "following_url": "https://api.github.com/users/tserg/following{/other_user}",
      "gists_url": "https://api.github.com/users/tserg/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tserg/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tserg/subscriptions",
      "organizations_url": "https://api.github.com/users/tserg/orgs",
      "repos_url": "https://api.github.com/users/tserg/repos",
      "events_url": "https://api.github.com/users/tserg/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tserg/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-02-07T03:01:26Z",
    "updated_at": "2023-02-07T03:01:43Z",
    "author_association": "CONTRIBUTOR",
    "body": "Hi @scherrey, can you share the full code (if possible) as well as the framework that you are using? I am trying to reproduce the bug on my end.",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1420126687/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1421009486",
    "html_url": "https://github.com/vyperlang/vyper/issues/3270#issuecomment-1421009486",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/3270",
    "id": 1421009486,
    "node_id": "IC_kwDOBGDvrM5UsuJO",
    "user": {
      "login": "scherrey",
      "id": 878591,
      "node_id": "MDQ6VXNlcjg3ODU5MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/878591?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/scherrey",
      "html_url": "https://github.com/scherrey",
      "followers_url": "https://api.github.com/users/scherrey/followers",
      "following_url": "https://api.github.com/users/scherrey/following{/other_user}",
      "gists_url": "https://api.github.com/users/scherrey/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/scherrey/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/scherrey/subscriptions",
      "organizations_url": "https://api.github.com/users/scherrey/orgs",
      "repos_url": "https://api.github.com/users/scherrey/repos",
      "events_url": "https://api.github.com/users/scherrey/events{/privacy}",
      "received_events_url": "https://api.github.com/users/scherrey/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-02-07T15:57:39Z",
    "updated_at": "2023-02-07T15:57:39Z",
    "author_association": "NONE",
    "body": "> \r\n\r\nI sent you an invite to our repo. You can repro the defect at commit 87111fae2b077cd1005bdf1ff47a5828f5b234d0 .\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1421009486/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1427055008",
    "html_url": "https://github.com/vyperlang/vyper/issues/3270#issuecomment-1427055008",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/3270",
    "id": 1427055008,
    "node_id": "IC_kwDOBGDvrM5VDyGg",
    "user": {
      "login": "scherrey",
      "id": 878591,
      "node_id": "MDQ6VXNlcjg3ODU5MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/878591?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/scherrey",
      "html_url": "https://github.com/scherrey",
      "followers_url": "https://api.github.com/users/scherrey/followers",
      "following_url": "https://api.github.com/users/scherrey/following{/other_user}",
      "gists_url": "https://api.github.com/users/scherrey/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/scherrey/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/scherrey/subscriptions",
      "organizations_url": "https://api.github.com/users/scherrey/orgs",
      "repos_url": "https://api.github.com/users/scherrey/repos",
      "events_url": "https://api.github.com/users/scherrey/events{/privacy}",
      "received_events_url": "https://api.github.com/users/scherrey/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-02-12T15:02:12Z",
    "updated_at": "2023-02-12T15:02:12Z",
    "author_association": "NONE",
    "body": "Hrm... now I can't recreate the defect with a fresh checkout. What's crazy is I repo'd it on two different computers before I reported it as a defect. :-( I think this one is not legit. Apologies for the wild good chase.",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1427055008/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
