{
  "url": "https://api.github.com/repos/vyperlang/vyper/issues/3362",
  "repository_url": "https://api.github.com/repos/vyperlang/vyper",
  "labels_url": "https://api.github.com/repos/vyperlang/vyper/issues/3362/labels{/name}",
  "comments_url": "https://api.github.com/repos/vyperlang/vyper/issues/3362/comments",
  "events_url": "https://api.github.com/repos/vyperlang/vyper/issues/3362/events",
  "html_url": "https://github.com/vyperlang/vyper/issues/3362",
  "id": 1675124792,
  "node_id": "I_kwDOBGDvrM5j2GA4",
  "number": 3362,
  "title": "VIP: `CODECOPY` support (`self.code`)",
  "user": {
    "login": "JorgeAtPaladin",
    "id": 87263486,
    "node_id": "MDQ6VXNlcjg3MjYzNDg2",
    "avatar_url": "https://avatars.githubusercontent.com/u/87263486?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/JorgeAtPaladin",
    "html_url": "https://github.com/JorgeAtPaladin",
    "followers_url": "https://api.github.com/users/JorgeAtPaladin/followers",
    "following_url": "https://api.github.com/users/JorgeAtPaladin/following{/other_user}",
    "gists_url": "https://api.github.com/users/JorgeAtPaladin/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/JorgeAtPaladin/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/JorgeAtPaladin/subscriptions",
    "organizations_url": "https://api.github.com/users/JorgeAtPaladin/orgs",
    "repos_url": "https://api.github.com/users/JorgeAtPaladin/repos",
    "events_url": "https://api.github.com/users/JorgeAtPaladin/events{/privacy}",
    "received_events_url": "https://api.github.com/users/JorgeAtPaladin/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2023-04-19T15:12:52Z",
  "updated_at": "2023-04-20T08:58:34Z",
  "closed_at": "2023-04-20T08:58:09Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "## Simple Summary\r\nSupport the low level `CODECOPY` opcode to copy contract code into a memory array.\r\n\r\n## Motivation\r\n`CODECOPY` is a low level opcode which allows for copying a contracts own bytecode into a slice. This can be very powerful for more unique contracts. Eg. a famous practical example is a minimal proxy contract which encodes immutable variables at the end of the proxy code. Our own use case is to use HyVM to encode calldata (parameters) at the end of the contract code.\r\n\r\nRegardless of use case, we strongly believe it makes sense to support simple features like this, which don't have any downside to support, as it makes the language more mature and complete.\r\n\r\n## Specification\r\nWe recommend a feature similar to `msg.data` which returns the Bytes type. The most obvious syntax for this feature would be `self.code`, returning sliceable bytes as well. Of course, the Bytes should only lazy load the data which is actually used, as is how the Bytes is designed to be used.\r\n\r\n## Backwards Compatibility\r\nNo incompatibilities.\r\n\r\n## Dependencies\r\nNo dependencies\r\n\r\n## References\r\n[Solidity docs](https://docs.soliditylang.org/en/v0.8.19/cheatsheet.html): `<address>.code` (bytes memory): code at the [Address](https://docs.soliditylang.org/en/v0.8.19/types.html#address) (can be empty). Also present within solidity (though solidity also supports EXTCODECOPY).\r\n\r\n## Copyright\r\nCopyright and related rights waived via [CC0](https://creativecommons.org/publicdomain/zero/1.0/)\r\n",
  "closed_by": {
    "login": "JorgeAtPaladin",
    "id": 87263486,
    "node_id": "MDQ6VXNlcjg3MjYzNDg2",
    "avatar_url": "https://avatars.githubusercontent.com/u/87263486?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/JorgeAtPaladin",
    "html_url": "https://github.com/JorgeAtPaladin",
    "followers_url": "https://api.github.com/users/JorgeAtPaladin/followers",
    "following_url": "https://api.github.com/users/JorgeAtPaladin/following{/other_user}",
    "gists_url": "https://api.github.com/users/JorgeAtPaladin/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/JorgeAtPaladin/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/JorgeAtPaladin/subscriptions",
    "organizations_url": "https://api.github.com/users/JorgeAtPaladin/orgs",
    "repos_url": "https://api.github.com/users/JorgeAtPaladin/repos",
    "events_url": "https://api.github.com/users/JorgeAtPaladin/events{/privacy}",
    "received_events_url": "https://api.github.com/users/JorgeAtPaladin/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/3362/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/vyperlang/vyper/issues/3362/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1514921324",
    "html_url": "https://github.com/vyperlang/vyper/issues/3362#issuecomment-1514921324",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/3362",
    "id": 1514921324,
    "node_id": "IC_kwDOBGDvrM5aS91s",
    "user": {
      "login": "JorgeAtPaladin",
      "id": 87263486,
      "node_id": "MDQ6VXNlcjg3MjYzNDg2",
      "avatar_url": "https://avatars.githubusercontent.com/u/87263486?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/JorgeAtPaladin",
      "html_url": "https://github.com/JorgeAtPaladin",
      "followers_url": "https://api.github.com/users/JorgeAtPaladin/followers",
      "following_url": "https://api.github.com/users/JorgeAtPaladin/following{/other_user}",
      "gists_url": "https://api.github.com/users/JorgeAtPaladin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/JorgeAtPaladin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/JorgeAtPaladin/subscriptions",
      "organizations_url": "https://api.github.com/users/JorgeAtPaladin/orgs",
      "repos_url": "https://api.github.com/users/JorgeAtPaladin/repos",
      "events_url": "https://api.github.com/users/JorgeAtPaladin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/JorgeAtPaladin/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-19T15:17:19Z",
    "updated_at": "2023-04-19T15:17:30Z",
    "author_association": "NONE",
    "body": "It may make sense to immediately also support `EXTCODECOPY`, similar to solidity. This is outside of our own use-case hence it wasn't raised in the VIP, but arguably the implementation can support both opcodes using `<address>.code`, just like solidity does.",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1514921324/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1514927879",
    "html_url": "https://github.com/vyperlang/vyper/issues/3362#issuecomment-1514927879",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/3362",
    "id": 1514927879,
    "node_id": "IC_kwDOBGDvrM5aS_cH",
    "user": {
      "login": "JorgeAtPaladin",
      "id": 87263486,
      "node_id": "MDQ6VXNlcjg3MjYzNDg2",
      "avatar_url": "https://avatars.githubusercontent.com/u/87263486?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/JorgeAtPaladin",
      "html_url": "https://github.com/JorgeAtPaladin",
      "followers_url": "https://api.github.com/users/JorgeAtPaladin/followers",
      "following_url": "https://api.github.com/users/JorgeAtPaladin/following{/other_user}",
      "gists_url": "https://api.github.com/users/JorgeAtPaladin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/JorgeAtPaladin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/JorgeAtPaladin/subscriptions",
      "organizations_url": "https://api.github.com/users/JorgeAtPaladin/orgs",
      "repos_url": "https://api.github.com/users/JorgeAtPaladin/repos",
      "events_url": "https://api.github.com/users/JorgeAtPaladin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/JorgeAtPaladin/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-19T15:21:33Z",
    "updated_at": "2023-04-19T15:21:33Z",
    "author_association": "NONE",
    "body": "Looks like we are noobs that only look at the docs and didn't realize this was already done in #2583.\r\n\r\nIf confirmed that this already works, we'll be doing our OS duty and providing a PR to document this behavior üëç \r\n\r\nVery nice if this is already implemented!",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1514927879/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1515284841",
    "html_url": "https://github.com/vyperlang/vyper/issues/3362#issuecomment-1515284841",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/3362",
    "id": 1515284841,
    "node_id": "IC_kwDOBGDvrM5aUWlp",
    "user": {
      "login": "charles-cooper",
      "id": 3867501,
      "node_id": "MDQ6VXNlcjM4Njc1MDE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3867501?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/charles-cooper",
      "html_url": "https://github.com/charles-cooper",
      "followers_url": "https://api.github.com/users/charles-cooper/followers",
      "following_url": "https://api.github.com/users/charles-cooper/following{/other_user}",
      "gists_url": "https://api.github.com/users/charles-cooper/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/charles-cooper/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/charles-cooper/subscriptions",
      "organizations_url": "https://api.github.com/users/charles-cooper/orgs",
      "repos_url": "https://api.github.com/users/charles-cooper/repos",
      "events_url": "https://api.github.com/users/charles-cooper/events{/privacy}",
      "received_events_url": "https://api.github.com/users/charles-cooper/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-19T19:45:11Z",
    "updated_at": "2023-04-19T19:45:11Z",
    "author_association": "COLLABORATOR",
    "body": "@JorgeAtPaladin yep, done in #2583, apparently just undocumented that it dispatches into CODECOPY. Here's an example you can use to verify the behavior:\r\n```vyper\r\n@external\r\ndef foo() -> Bytes[32]:\r\n    return slice(self.code, 0, 32)\r\n```\r\nand the resultant assembly:\r\n```\r\n(vyper) ~/vyper $ vyc -f opcodes_runtime tmp/codecopy.vy  | grep CODECOPY\r\nPUSH1 0x0 CALLDATALOAD PUSH1 0xE0 SHR CALLVALUE PUSH2 0x084 JUMPI PUSH4 0xC2985578 DUP2 XOR PUSH2 0x07D JUMPI PUSH1 0x4 CALLDATASIZE LT PUSH2 0x084 JUMPI PUSH1 0x20 DUP1 PUSH1 0x80 MSTORE CODESIZE PUSH1 0x20 GT PUSH2 0x084 JUMPI PUSH1 0x20 PUSH1 0x40 MSTORE PUSH1 0x20 PUSH1 0x0 PUSH1 0x60 CODECOPY PUSH1 0x40 DUP2 PUSH1 0x80 ADD DUP2 MLOAD DUP1 DUP3 MSTORE PUSH1 0x20 DUP4 ADD PUSH1 0x20 DUP4 ADD DUP2 MLOAD DUP2 MSTORE POP POP POP DUP1 MLOAD DUP1 PUSH1 0x20 DUP4 ADD ADD PUSH1 0x1F DUP3 PUSH1 0x0 SUB AND CALLDATASIZE DUP3 CALLDATACOPY POP POP PUSH1 0x1F NOT PUSH1 0x1F DUP3 MLOAD PUSH1 0x20 ADD ADD AND SWAP1 POP SWAP1 POP DUP2 ADD SWAP1 POP PUSH1 0x80 RETURN JUMPDEST POP PUSH1 0x0 PUSH1 0x0 REVERT JUMPDEST PUSH1 0x0 DUP1 REVERT LOG1 PUSH6 0x767970657283 STOP SUB ADDMOD STOP SIGNEXTEND\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1515284841/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1515964851",
    "html_url": "https://github.com/vyperlang/vyper/issues/3362#issuecomment-1515964851",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/3362",
    "id": 1515964851,
    "node_id": "IC_kwDOBGDvrM5aW8mz",
    "user": {
      "login": "JorgeAtPaladin",
      "id": 87263486,
      "node_id": "MDQ6VXNlcjg3MjYzNDg2",
      "avatar_url": "https://avatars.githubusercontent.com/u/87263486?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/JorgeAtPaladin",
      "html_url": "https://github.com/JorgeAtPaladin",
      "followers_url": "https://api.github.com/users/JorgeAtPaladin/followers",
      "following_url": "https://api.github.com/users/JorgeAtPaladin/following{/other_user}",
      "gists_url": "https://api.github.com/users/JorgeAtPaladin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/JorgeAtPaladin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/JorgeAtPaladin/subscriptions",
      "organizations_url": "https://api.github.com/users/JorgeAtPaladin/orgs",
      "repos_url": "https://api.github.com/users/JorgeAtPaladin/repos",
      "events_url": "https://api.github.com/users/JorgeAtPaladin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/JorgeAtPaladin/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-20T08:54:11Z",
    "updated_at": "2023-04-20T08:58:34Z",
    "author_association": "NONE",
    "body": "@charles-cooper thanks, closing this and adding a todo for me to PR some doc updates for your team.\r\n\r\ncheers, Marco from Paladin.\r\n\r\nP.S: Appreciate the opcode view, seems like it does `PUSH1 0x20 PUSH1 0x0 PUSH1 0x60 CODECOPY`. or `codecopy(destOffset=0x60,offset=0x0,size=0x20)`. Correctly copies 32 bytes.",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1515964851/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
