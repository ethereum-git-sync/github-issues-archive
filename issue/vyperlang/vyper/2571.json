{
  "url": "https://api.github.com/repos/vyperlang/vyper/issues/2571",
  "repository_url": "https://api.github.com/repos/vyperlang/vyper",
  "labels_url": "https://api.github.com/repos/vyperlang/vyper/issues/2571/labels{/name}",
  "comments_url": "https://api.github.com/repos/vyperlang/vyper/issues/2571/comments",
  "events_url": "https://api.github.com/repos/vyperlang/vyper/issues/2571/events",
  "html_url": "https://github.com/vyperlang/vyper/issues/2571",
  "id": 1086429392,
  "node_id": "I_kwDOBGDvrM5AwZjQ",
  "number": 2571,
  "title": "Nonreentrant modifier breaks backward compatibility in storage allocation between versions 0.2 / 0.3",
  "user": {
    "login": "pavlovdog",
    "id": 5871170,
    "node_id": "MDQ6VXNlcjU4NzExNzA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5871170?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/pavlovdog",
    "html_url": "https://github.com/pavlovdog",
    "followers_url": "https://api.github.com/users/pavlovdog/followers",
    "following_url": "https://api.github.com/users/pavlovdog/following{/other_user}",
    "gists_url": "https://api.github.com/users/pavlovdog/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/pavlovdog/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/pavlovdog/subscriptions",
    "organizations_url": "https://api.github.com/users/pavlovdog/orgs",
    "repos_url": "https://api.github.com/users/pavlovdog/repos",
    "events_url": "https://api.github.com/users/pavlovdog/events{/privacy}",
    "received_events_url": "https://api.github.com/users/pavlovdog/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 7,
  "created_at": "2021-12-22T04:07:40Z",
  "updated_at": "2022-02-03T03:03:13Z",
  "closed_at": "2022-02-03T03:03:12Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Version Information\r\n\r\n* vyper Version: 0.3.0\r\n* OS: osx\r\n* Python Version: Using docker image as a plugin for Hardhat\r\n\r\n### What's your issue about?\r\n\r\nAfter switching to the `0.3.1` compiler, I've found that the storage layout has been changed. Now, the first variable is not stored in the first slot, but in the second; the second variable is stored in the third slot, and so on.\r\n\r\nIn my project, we're using Vyper contracts ([link](https://github.com/broxus/ton-eth-bridge-contracts/blob/master/ethereum/contracts/vault/Vault.vy)) with a Transparent Upgradeable Proxy pattern ([link](https://github.com/broxus/ton-eth-bridge-contracts/blob/master/ethereum/contracts/vault/Registry.sol#L154)). The current implementation is built with `0.2.12` compiler, so it's impossible to upgrade the compiler version without breaking everything.\r\n\r\nWhat is also important, is that I've reached the contract size limit, so to deploy a newer implementation I need better optimization, which can be achieved only by upgrading to the `0.3` compiler.\r\n\r\n### Repro\r\n\r\nI've built a simple repro contract and tested it against two compiler versions. Test code is the same, and contracts differ only in the `@version` line. It's pretty clear, that the slots allocation is different.\r\n\r\n#### FooBar.vy\r\n\r\nChange the `@version` line to see the difference.\r\n\r\n```\r\n# @version 0.3.1\r\n\r\nfoo: public(uint256)\r\nbar: public(uint256)\r\n\r\n@external\r\ndef __init__():\r\n    self.foo = 1\r\n    self.bar = 2\r\n\r\n@external\r\n@nonreentrant(\"incrementBar\")\r\ndef incrementFoo():\r\n    self.foo += 1\r\n\r\n@external\r\ndef incrementBar():\r\n    self.bar += 1\r\n```\r\n\r\n#### Test code\r\n\r\n```javascript\r\ndescribe('Test slots allocation', async () => {\r\n    it('Deploy dummy contract, check public functions and storage slots', async () => {\r\n        const FooBar = await ethers.getContractFactory(\"FooBar\");\r\n        const fooBar = await FooBar.deploy();\r\n\r\n        console.log(await fooBar.foo());\r\n        console.log(await fooBar.bar());\r\n\r\n        console.log(await ethers.provider.getStorageAt(fooBar.address, 0));\r\n        console.log(await ethers.provider.getStorageAt(fooBar.address, 1));\r\n        console.log(await ethers.provider.getStorageAt(fooBar.address, 2));\r\n    });\r\n});\r\n```\r\n#### Test output\r\n\r\n##### `0.2.12`\r\n\r\n```\r\n  Test slots allocation\r\nBigNumber { _hex: '0x01', _isBigNumber: true }\r\nBigNumber { _hex: '0x02', _isBigNumber: true }\r\n0x0000000000000000000000000000000000000000000000000000000000000001\r\n0x0000000000000000000000000000000000000000000000000000000000000002\r\n0x0000000000000000000000000000000000000000000000000000000000000000\r\n    ‚úì Deploy dummy contract, check public functions and storage slots (6866ms)\r\n```\r\n\r\n\r\n##### `0.3.0`\r\n\r\n```\r\n  Test slots allocation\r\nBigNumber { _hex: '0x01', _isBigNumber: true }\r\nBigNumber { _hex: '0x02', _isBigNumber: true }\r\n0x0000000000000000000000000000000000000000000000000000000000000000\r\n0x0000000000000000000000000000000000000000000000000000000000000001\r\n0x0000000000000000000000000000000000000000000000000000000000000002\r\n    ‚úì Deploy dummy contract, check public functions and storage slots (5695ms)\r\n```\r\n\r\n### How can it be fixed?\r\n\r\nFor me, it seems like unexpected behavior and breaks backward compatibility between compiler minor releases.\r\n\r\nI've done the test without the `nonreentrant` modifier against both compiler versions and it fixed the problem. So my guess is that the problem is caused by slot allocation for the reentrancy flag.\r\n\r\n\r\nHappy X mas ‚úåÔ∏è üéÖ",
  "closed_by": {
    "login": "charles-cooper",
    "id": 3867501,
    "node_id": "MDQ6VXNlcjM4Njc1MDE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3867501?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/charles-cooper",
    "html_url": "https://github.com/charles-cooper",
    "followers_url": "https://api.github.com/users/charles-cooper/followers",
    "following_url": "https://api.github.com/users/charles-cooper/following{/other_user}",
    "gists_url": "https://api.github.com/users/charles-cooper/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/charles-cooper/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/charles-cooper/subscriptions",
    "organizations_url": "https://api.github.com/users/charles-cooper/orgs",
    "repos_url": "https://api.github.com/users/charles-cooper/repos",
    "events_url": "https://api.github.com/users/charles-cooper/events{/privacy}",
    "received_events_url": "https://api.github.com/users/charles-cooper/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/2571/reactions",
    "total_count": 1,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 1
  },
  "timeline_url": "https://api.github.com/repos/vyperlang/vyper/issues/2571/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/999275135",
    "html_url": "https://github.com/vyperlang/vyper/issues/2571#issuecomment-999275135",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/2571",
    "id": 999275135,
    "node_id": "IC_kwDOBGDvrM47j7p_",
    "user": {
      "login": "fubuloubu",
      "id": 3859395,
      "node_id": "MDQ6VXNlcjM4NTkzOTU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3859395?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fubuloubu",
      "html_url": "https://github.com/fubuloubu",
      "followers_url": "https://api.github.com/users/fubuloubu/followers",
      "following_url": "https://api.github.com/users/fubuloubu/following{/other_user}",
      "gists_url": "https://api.github.com/users/fubuloubu/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fubuloubu/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fubuloubu/subscriptions",
      "organizations_url": "https://api.github.com/users/fubuloubu/orgs",
      "repos_url": "https://api.github.com/users/fubuloubu/repos",
      "events_url": "https://api.github.com/users/fubuloubu/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fubuloubu/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-12-22T04:21:08Z",
    "updated_at": "2021-12-22T04:21:08Z",
    "author_association": "MEMBER",
    "body": "Hello @pavlovdog, first I would say that this is indeed the case that a breaking change was introduced. as per our versioning guideline, minor versions may contain breaking changes (we do not conform to semver):\r\nhttps://vyper.readthedocs.io/en/stable/versioning.html#minor-release-x-y-0\r\n\r\nHowever, you may be in luck. @charles-cooper was looking to create a VIP describing a compiler input file for the storage slots that would override the compiler-chosen values for the user-chosen ones. He is in the process of writing that proposal, and when it is created we will link it here so you can monitor it's progress.\r\n\r\nIf you are looking for a short term remedy, I would say that your options are limited to looking for ways to migrate your deployed project to the 0.3.x series if possible.",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/999275135/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/999276533",
    "html_url": "https://github.com/vyperlang/vyper/issues/2571#issuecomment-999276533",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/2571",
    "id": 999276533,
    "node_id": "IC_kwDOBGDvrM47j7_1",
    "user": {
      "login": "charles-cooper",
      "id": 3867501,
      "node_id": "MDQ6VXNlcjM4Njc1MDE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3867501?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/charles-cooper",
      "html_url": "https://github.com/charles-cooper",
      "followers_url": "https://api.github.com/users/charles-cooper/followers",
      "following_url": "https://api.github.com/users/charles-cooper/following{/other_user}",
      "gists_url": "https://api.github.com/users/charles-cooper/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/charles-cooper/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/charles-cooper/subscriptions",
      "organizations_url": "https://api.github.com/users/charles-cooper/orgs",
      "repos_url": "https://api.github.com/users/charles-cooper/repos",
      "events_url": "https://api.github.com/users/charles-cooper/events{/privacy}",
      "received_events_url": "https://api.github.com/users/charles-cooper/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-12-22T04:24:50Z",
    "updated_at": "2021-12-22T04:30:07Z",
    "author_association": "COLLABORATOR",
    "body": "@pavlovdog I was actually thinking about being able to manually override compiler generated storage slots, you gave me the impetus to write it up here https://github.com/vyperlang/vyper/issues/2572. It's not a terribly difficult feature to add actually, a motivated new contributor could probably do it with not too much time. In any case I could get around to it in a few weeks but if you need it sooner we would welcome your contribution!",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/999276533/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/999350473",
    "html_url": "https://github.com/vyperlang/vyper/issues/2571#issuecomment-999350473",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/2571",
    "id": 999350473,
    "node_id": "IC_kwDOBGDvrM47kODJ",
    "user": {
      "login": "pavlovdog",
      "id": 5871170,
      "node_id": "MDQ6VXNlcjU4NzExNzA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5871170?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pavlovdog",
      "html_url": "https://github.com/pavlovdog",
      "followers_url": "https://api.github.com/users/pavlovdog/followers",
      "following_url": "https://api.github.com/users/pavlovdog/following{/other_user}",
      "gists_url": "https://api.github.com/users/pavlovdog/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pavlovdog/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pavlovdog/subscriptions",
      "organizations_url": "https://api.github.com/users/pavlovdog/orgs",
      "repos_url": "https://api.github.com/users/pavlovdog/repos",
      "events_url": "https://api.github.com/users/pavlovdog/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pavlovdog/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-12-22T07:35:31Z",
    "updated_at": "2021-12-22T09:47:15Z",
    "author_association": "NONE",
    "body": "@charles-cooper @fubuloubu I would like to contribute, but for me, your solution seems too tricky.\r\n\r\n1. Overriding compiler-chosen slots is a complex task. It requires deep knowledge for a developer, is prone to mistake and I think it won't be used often.\r\n2. Storage layout is not obvious right now. You know, the first variable is not on the first slot and so on. Vyper is great because it puts simplicity and clarity first and this thing does not comply with this principle.\r\n\r\nFor me, compiler-inserted variables like the reentrancy flag should be located at some standard slot, something similar to the EIP 1967.\r\n\r\nWhat do you think?",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/999350473/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/999747089",
    "html_url": "https://github.com/vyperlang/vyper/issues/2571#issuecomment-999747089",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/2571",
    "id": 999747089,
    "node_id": "IC_kwDOBGDvrM47lu4R",
    "user": {
      "login": "charles-cooper",
      "id": 3867501,
      "node_id": "MDQ6VXNlcjM4Njc1MDE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3867501?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/charles-cooper",
      "html_url": "https://github.com/charles-cooper",
      "followers_url": "https://api.github.com/users/charles-cooper/followers",
      "following_url": "https://api.github.com/users/charles-cooper/following{/other_user}",
      "gists_url": "https://api.github.com/users/charles-cooper/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/charles-cooper/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/charles-cooper/subscriptions",
      "organizations_url": "https://api.github.com/users/charles-cooper/orgs",
      "repos_url": "https://api.github.com/users/charles-cooper/repos",
      "events_url": "https://api.github.com/users/charles-cooper/events{/privacy}",
      "received_events_url": "https://api.github.com/users/charles-cooper/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-12-22T17:29:07Z",
    "updated_at": "2021-12-22T17:29:07Z",
    "author_association": "COLLABORATOR",
    "body": "@pavlovdog alright, well in the past we have held that the storage layout is subject to change (this could be for many reasons, but the main reasons would be optimization or bugfixes, for instance, see https://github.com/vyperlang/vyper/issues/1556, https://github.com/vyperlang/vyper/pull/2308). We can revisit this policy, but given that the storage layout could change sometimes, what do you think could be a good resolution for your issue?",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/999747089/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/999747784",
    "html_url": "https://github.com/vyperlang/vyper/issues/2571#issuecomment-999747784",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/2571",
    "id": 999747784,
    "node_id": "IC_kwDOBGDvrM47lvDI",
    "user": {
      "login": "charles-cooper",
      "id": 3867501,
      "node_id": "MDQ6VXNlcjM4Njc1MDE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3867501?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/charles-cooper",
      "html_url": "https://github.com/charles-cooper",
      "followers_url": "https://api.github.com/users/charles-cooper/followers",
      "following_url": "https://api.github.com/users/charles-cooper/following{/other_user}",
      "gists_url": "https://api.github.com/users/charles-cooper/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/charles-cooper/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/charles-cooper/subscriptions",
      "organizations_url": "https://api.github.com/users/charles-cooper/orgs",
      "repos_url": "https://api.github.com/users/charles-cooper/repos",
      "events_url": "https://api.github.com/users/charles-cooper/events{/privacy}",
      "received_events_url": "https://api.github.com/users/charles-cooper/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-12-22T17:30:15Z",
    "updated_at": "2021-12-22T17:31:18Z",
    "author_association": "COLLABORATOR",
    "body": "It might not be a huge deal to go back to nonreentrant variables starting after all other variables. But even so, the allocated storage size of a lot of things have changed as of v0.3.1. @fubuloubu thoughts?",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/999747784/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/999775893",
    "html_url": "https://github.com/vyperlang/vyper/issues/2571#issuecomment-999775893",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/2571",
    "id": 999775893,
    "node_id": "IC_kwDOBGDvrM47l16V",
    "user": {
      "login": "fubuloubu",
      "id": 3859395,
      "node_id": "MDQ6VXNlcjM4NTkzOTU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3859395?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fubuloubu",
      "html_url": "https://github.com/fubuloubu",
      "followers_url": "https://api.github.com/users/fubuloubu/followers",
      "following_url": "https://api.github.com/users/fubuloubu/following{/other_user}",
      "gists_url": "https://api.github.com/users/fubuloubu/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fubuloubu/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fubuloubu/subscriptions",
      "organizations_url": "https://api.github.com/users/fubuloubu/orgs",
      "repos_url": "https://api.github.com/users/fubuloubu/repos",
      "events_url": "https://api.github.com/users/fubuloubu/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fubuloubu/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-12-22T18:19:41Z",
    "updated_at": "2021-12-22T18:19:41Z",
    "author_association": "MEMBER",
    "body": "I think pain is already created, there's no sense in going back now when other changes have been made, and other changes will happen in the future as well.\r\n\r\nmaking storage slot locations a part of the guarantees of the compiler would require a VIP to define exactly what that means",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/999775893/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1028557556",
    "html_url": "https://github.com/vyperlang/vyper/issues/2571#issuecomment-1028557556",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/2571",
    "id": 1028557556,
    "node_id": "IC_kwDOBGDvrM49Tor0",
    "user": {
      "login": "charles-cooper",
      "id": 3867501,
      "node_id": "MDQ6VXNlcjM4Njc1MDE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3867501?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/charles-cooper",
      "html_url": "https://github.com/charles-cooper",
      "followers_url": "https://api.github.com/users/charles-cooper/followers",
      "following_url": "https://api.github.com/users/charles-cooper/following{/other_user}",
      "gists_url": "https://api.github.com/users/charles-cooper/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/charles-cooper/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/charles-cooper/subscriptions",
      "organizations_url": "https://api.github.com/users/charles-cooper/orgs",
      "repos_url": "https://api.github.com/users/charles-cooper/repos",
      "events_url": "https://api.github.com/users/charles-cooper/events{/privacy}",
      "received_events_url": "https://api.github.com/users/charles-cooper/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-02-03T03:03:12Z",
    "updated_at": "2022-02-03T03:03:12Z",
    "author_association": "COLLABORATOR",
    "body": "I'm going to say we are not going to guarantee that different versions of vyper have the same storage layout - closing since we now provide https://github.com/vyperlang/vyper/pull/2593 if you need to manually provide storage compatibility between different vyper versions. @fubuloubu @pavlovdog please reopen for discussion if you have conflicting ideas about this.",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1028557556/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
