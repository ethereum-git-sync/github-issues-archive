{
  "url": "https://api.github.com/repos/vyperlang/vyper/issues/2878",
  "repository_url": "https://api.github.com/repos/vyperlang/vyper",
  "labels_url": "https://api.github.com/repos/vyperlang/vyper/issues/2878/labels{/name}",
  "comments_url": "https://api.github.com/repos/vyperlang/vyper/issues/2878/comments",
  "events_url": "https://api.github.com/repos/vyperlang/vyper/issues/2878/events",
  "html_url": "https://github.com/vyperlang/vyper/issues/2878",
  "id": 1250506730,
  "node_id": "I_kwDOBGDvrM5KiTfq",
  "number": 2878,
  "title": "Exception \"Label with name {label_name} already exists!\" when compiling contract",
  "user": {
    "login": "benber86",
    "id": 25791237,
    "node_id": "MDQ6VXNlcjI1NzkxMjM3",
    "avatar_url": "https://avatars.githubusercontent.com/u/25791237?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/benber86",
    "html_url": "https://github.com/benber86",
    "followers_url": "https://api.github.com/users/benber86/followers",
    "following_url": "https://api.github.com/users/benber86/following{/other_user}",
    "gists_url": "https://api.github.com/users/benber86/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/benber86/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/benber86/subscriptions",
    "organizations_url": "https://api.github.com/users/benber86/orgs",
    "repos_url": "https://api.github.com/users/benber86/repos",
    "events_url": "https://api.github.com/users/benber86/events{/privacy}",
    "received_events_url": "https://api.github.com/users/benber86/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2022-05-27T08:46:12Z",
  "updated_at": "2022-06-07T23:04:21Z",
  "closed_at": "2022-06-07T23:04:20Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "### Version Information\r\n\r\n* vyper Version (output of `vyper --version`): 0.3.3\r\n* OS: Linux\r\n* Python Version (output of `python --version`): 3.10\r\n\r\n### What's your issue about?\r\n\r\nPlease include information like:\r\n\r\nWhen trying to compile a contract I get the following error:\r\n\r\n```\r\nCompiling contracts...\r\n  Vyper version: 0.3.3\r\nUnhandled exception in 'contracts/MetaRegistry.vy':\r\n  File \"brownie/test/plugin.py\", line 87, in pytest_load_initial_conftests\r\n    active_project = project.load(project_path)\r\n  File \"brownie/project/main.py\", line 768, in load\r\n    return Project(name, project_path)\r\n  File \"brownie/project/main.py\", line 188, in __init__\r\n    self.load()\r\n  File \"brownie/project/main.py\", line 245, in load\r\n    self._compile(changed, self._compiler_config, False)\r\n  File \"brownie/project/main.py\", line 100, in _compile\r\n    build_json = compiler.compile_and_format(\r\n  File \"brownie/project/compiler/__init__.py\", line 141, in compile_and_format\r\n    output_json = compile_from_input_json(input_json, silent, allow_paths)\r\n  File \"brownie/project/compiler/__init__.py\", line 252, in compile_from_input_json\r\n    return vyper.compile_from_input_json(input_json, silent, allow_paths)\r\n  File \"brownie/project/compiler/vyper.py\", line 235, in compile_from_input_json\r\n    return vyper_json.compile_json(input_json, root_path=allow_paths)\r\n  File \"vyper/cli/vyper_json.py\", line 455, in compile_json\r\n    compiler_data, warn_data = compile_from_input_dict(input_dict, exc_handler, root_path)\r\n  File \"vyper/cli/vyper_json.py\", line 384, in compile_from_input_dict\r\n    return exc_handler(contract_path, exc, \"compiler\"), {}\r\n  File \"vyper/cli/vyper_json.py\", line 104, in exc_handler_raises\r\n    raise exception\r\n  File \"vyper/cli/vyper_json.py\", line 375, in compile_from_input_dict\r\n    data = vyper.compile_codes(\r\n  File \"vyper/evm/opcodes.py\", line 223, in _wrapper\r\n    return fn(*args, **kwargs)\r\n  File \"vyper/compiler/__init__.py\", line 134, in compile_codes\r\n    raise exc\r\n  File \"vyper/compiler/__init__.py\", line 129, in compile_codes\r\n    out[contract_name][output_format] = OUTPUT_FORMATS[output_format](compiler_data)\r\n  File \"vyper/compiler/output.py\", line 232, in build_bytecode_output\r\n    return f\"0x{compiler_data.bytecode.hex()}\"\r\n  File \"vyper/compiler/phases.py\", line 156, in bytecode\r\n    self._bytecode = generate_bytecode(self.assembly)\r\n  File \"vyper/compiler/phases.py\", line 144, in assembly\r\n    self._assembly = generate_assembly(self.ir_nodes, self.no_optimize)\r\n  File \"vyper/compiler/phases.py\", line 283, in generate_assembly\r\n    assembly = compile_ir.compile_to_assembly(ir_nodes, no_optimize=no_optimize)\r\n  File \"vyper/ir/compile_ir.py\", line 187, in apply_line_no_wrapper\r\n    ret = func(*args, **kwargs)\r\n  File \"vyper/ir/compile_ir.py\", line 205, in compile_to_assembly\r\n    res = _compile_to_assembly(code)\r\n  File \"vyper/ir/compile_ir.py\", line 187, in apply_line_no_wrapper\r\n    ret = func(*args, **kwargs)\r\n  File \"vyper/ir/compile_ir.py\", line 546, in _compile_to_assembly\r\n    o.extend(_compile_to_assembly(arg, withargs, existing_labels, break_dest, height))\r\n  File \"vyper/ir/compile_ir.py\", line 187, in apply_line_no_wrapper\r\n    ret = func(*args, **kwargs)\r\n  File \"vyper/ir/compile_ir.py\", line 513, in _compile_to_assembly\r\n    subcode = _compile_to_assembly(ir, {}, existing_labels, None, 0)\r\n  File \"vyper/ir/compile_ir.py\", line 187, in apply_line_no_wrapper\r\n    ret = func(*args, **kwargs)\r\n  File \"vyper/ir/compile_ir.py\", line 546, in _compile_to_assembly\r\n    o.extend(_compile_to_assembly(arg, withargs, existing_labels, break_dest, height))\r\n  File \"vyper/ir/compile_ir.py\", line 187, in apply_line_no_wrapper\r\n    ret = func(*args, **kwargs)\r\n  File \"vyper/ir/compile_ir.py\", line 486, in _compile_to_assembly\r\n    _compile_to_assembly(\r\n  File \"vyper/ir/compile_ir.py\", line 187, in apply_line_no_wrapper\r\n    ret = func(*args, **kwargs)\r\n  File \"vyper/ir/compile_ir.py\", line 546, in _compile_to_assembly\r\n    o.extend(_compile_to_assembly(arg, withargs, existing_labels, break_dest, height))\r\n  File \"vyper/ir/compile_ir.py\", line 187, in apply_line_no_wrapper\r\n    ret = func(*args, **kwargs)\r\n  File \"vyper/ir/compile_ir.py\", line 546, in _compile_to_assembly\r\n    o.extend(_compile_to_assembly(arg, withargs, existing_labels, break_dest, height))\r\n  File \"vyper/ir/compile_ir.py\", line 187, in apply_line_no_wrapper\r\n    ret = func(*args, **kwargs)\r\n  File \"vyper/ir/compile_ir.py\", line 336, in _compile_to_assembly\r\n    o.extend(_compile_to_assembly(code.args[1], withargs, existing_labels, break_dest, height))\r\n  File \"vyper/ir/compile_ir.py\", line 187, in apply_line_no_wrapper\r\n    ret = func(*args, **kwargs)\r\n  File \"vyper/ir/compile_ir.py\", line 546, in _compile_to_assembly\r\n    o.extend(_compile_to_assembly(arg, withargs, existing_labels, break_dest, height))\r\n  File \"vyper/ir/compile_ir.py\", line 187, in apply_line_no_wrapper\r\n    ret = func(*args, **kwargs)\r\n  File \"vyper/ir/compile_ir.py\", line 546, in _compile_to_assembly\r\n    o.extend(_compile_to_assembly(arg, withargs, existing_labels, break_dest, height))\r\n  File \"vyper/ir/compile_ir.py\", line 187, in apply_line_no_wrapper\r\n    ret = func(*args, **kwargs)\r\n  File \"vyper/ir/compile_ir.py\", line 807, in _compile_to_assembly\r\n    body_asm = _compile_to_assembly(\r\n  File \"vyper/ir/compile_ir.py\", line 187, in apply_line_no_wrapper\r\n    ret = func(*args, **kwargs)\r\n  File \"vyper/ir/compile_ir.py\", line 546, in _compile_to_assembly\r\n    o.extend(_compile_to_assembly(arg, withargs, existing_labels, break_dest, height))\r\n  File \"vyper/ir/compile_ir.py\", line 187, in apply_line_no_wrapper\r\n    ret = func(*args, **kwargs)\r\n  File \"vyper/ir/compile_ir.py\", line 546, in _compile_to_assembly\r\n    o.extend(_compile_to_assembly(arg, withargs, existing_labels, break_dest, height))\r\n  File \"vyper/ir/compile_ir.py\", line 187, in apply_line_no_wrapper\r\n    ret = func(*args, **kwargs)\r\n  File \"vyper/ir/compile_ir.py\", line 546, in _compile_to_assembly\r\n    o.extend(_compile_to_assembly(arg, withargs, existing_labels, break_dest, height))\r\n  File \"vyper/ir/compile_ir.py\", line 187, in apply_line_no_wrapper\r\n    ret = func(*args, **kwargs)\r\n  File \"vyper/ir/compile_ir.py\", line 333, in _compile_to_assembly\r\n    o.extend(_compile_to_assembly(code.args[0], withargs, existing_labels, break_dest, height))\r\n  File \"vyper/ir/compile_ir.py\", line 187, in apply_line_no_wrapper\r\n    ret = func(*args, **kwargs)\r\n  File \"vyper/ir/compile_ir.py\", line 247, in _compile_to_assembly\r\n    o.extend(_compile_to_assembly(c, withargs, existing_labels, break_dest, height + i))\r\n  File \"vyper/ir/compile_ir.py\", line 187, in apply_line_no_wrapper\r\n    ret = func(*args, **kwargs)\r\n  File \"vyper/ir/compile_ir.py\", line 247, in _compile_to_assembly\r\n    o.extend(_compile_to_assembly(c, withargs, existing_labels, break_dest, height + i))\r\n  File \"vyper/ir/compile_ir.py\", line 187, in apply_line_no_wrapper\r\n    ret = func(*args, **kwargs)\r\n  File \"vyper/ir/compile_ir.py\", line 247, in _compile_to_assembly\r\n    o.extend(_compile_to_assembly(c, withargs, existing_labels, break_dest, height + i))\r\n  File \"vyper/ir/compile_ir.py\", line 187, in apply_line_no_wrapper\r\n    ret = func(*args, **kwargs)\r\n  File \"vyper/ir/compile_ir.py\", line 546, in _compile_to_assembly\r\n    o.extend(_compile_to_assembly(arg, withargs, existing_labels, break_dest, height))\r\n  File \"vyper/ir/compile_ir.py\", line 187, in apply_line_no_wrapper\r\n    ret = func(*args, **kwargs)\r\n  File \"vyper/ir/compile_ir.py\", line 786, in _compile_to_assembly\r\n    raise Exception(f\"Label with name {label_name} already exists!\")\r\nException: Label with name label60 already exists!\r\n\r\n```\r\n\r\nI think the error comes from this line `RegistryHandler(self._get_registry_handler_from_pool(_pool)).remove_pool(_pool)` in the following code snippet:\r\n\r\n```\r\n\r\ninterface RegistryHandler:\r\n    def remove_pool(_pool: address): nonpayable\r\n\r\nget_registry: public(HashMap[uint256, Registry]) # get registry by index, index starts at 0\r\n\r\npool_count: public(uint256)\r\npool_list: public(address[65536])\r\npool_to_registry: public(HashMap[address, PoolInfo])\r\n\r\n@internal\r\n@view\r\ndef _get_registry_handler_from_pool(_pool: address) -> address:\r\n    registry_index: uint256 = self.pool_to_registry[_pool].registry\r\n    assert registry_index > 0, \"no registry\"\r\n    return self.get_registry[registry_index - 1].registry_handler\r\n\r\n@external\r\ndef remove_pool(_pool: address):\r\n    \"\"\"\r\n    @notice Remove a pool from its registry handler\r\n    @param _pool The address of the pool to remove\r\n    \"\"\"\r\n    assert msg.sender == self.owner  # dev: only owner\r\n    RegistryHandler(self._get_registry_handler_from_pool(_pool)).remove_pool(_pool)\r\n```\r\n\r\n### How can it be fixed?\r\n\r\nIf I rewrite `RegistryHandler(self._get_registry_handler_from_pool(_pool)).remove_pool(_pool)` as\r\n```\r\n    registry: address = self._get_registry_handler_from_pool(_pool)\r\n    RegistryHandler(registry).remove_pool(_pool)\r\n```\r\n\r\nThe contract compiles with no issues.\r\n",
  "closed_by": {
    "login": "charles-cooper",
    "id": 3867501,
    "node_id": "MDQ6VXNlcjM4Njc1MDE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3867501?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/charles-cooper",
    "html_url": "https://github.com/charles-cooper",
    "followers_url": "https://api.github.com/users/charles-cooper/followers",
    "following_url": "https://api.github.com/users/charles-cooper/following{/other_user}",
    "gists_url": "https://api.github.com/users/charles-cooper/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/charles-cooper/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/charles-cooper/subscriptions",
    "organizations_url": "https://api.github.com/users/charles-cooper/orgs",
    "repos_url": "https://api.github.com/users/charles-cooper/repos",
    "events_url": "https://api.github.com/users/charles-cooper/events{/privacy}",
    "received_events_url": "https://api.github.com/users/charles-cooper/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/2878/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/vyperlang/vyper/issues/2878/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1149254990",
    "html_url": "https://github.com/vyperlang/vyper/issues/2878#issuecomment-1149254990",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/2878",
    "id": 1149254990,
    "node_id": "IC_kwDOBGDvrM5EgD1O",
    "user": {
      "login": "charles-cooper",
      "id": 3867501,
      "node_id": "MDQ6VXNlcjM4Njc1MDE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3867501?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/charles-cooper",
      "html_url": "https://github.com/charles-cooper",
      "followers_url": "https://api.github.com/users/charles-cooper/followers",
      "following_url": "https://api.github.com/users/charles-cooper/following{/other_user}",
      "gists_url": "https://api.github.com/users/charles-cooper/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/charles-cooper/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/charles-cooper/subscriptions",
      "organizations_url": "https://api.github.com/users/charles-cooper/orgs",
      "repos_url": "https://api.github.com/users/charles-cooper/repos",
      "events_url": "https://api.github.com/users/charles-cooper/events{/privacy}",
      "received_events_url": "https://api.github.com/users/charles-cooper/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-06-07T23:04:20Z",
    "updated_at": "2022-06-07T23:04:20Z",
    "author_association": "COLLABORATOR",
    "body": "should be fixed as of https://github.com/vyperlang/vyper/commit/6b4d8ff185de071252feaa1c319712b2d6577f8d, please reopen if still an issue",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1149254990/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
