{
  "url": "https://api.github.com/repos/vyperlang/vyper/issues/1563",
  "repository_url": "https://api.github.com/repos/vyperlang/vyper",
  "labels_url": "https://api.github.com/repos/vyperlang/vyper/issues/1563/labels{/name}",
  "comments_url": "https://api.github.com/repos/vyperlang/vyper/issues/1563/comments",
  "events_url": "https://api.github.com/repos/vyperlang/vyper/issues/1563/events",
  "html_url": "https://github.com/vyperlang/vyper/issues/1563",
  "id": 477564462,
  "node_id": "MDU6SXNzdWU0Nzc1NjQ0NjI=",
  "number": 1563,
  "title": "Insufficient zero-padding bug for functions returning byte arrays of size < 16",
  "user": {
    "login": "daejunpark",
    "id": 5491770,
    "node_id": "MDQ6VXNlcjU0OTE3NzA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5491770?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/daejunpark",
    "html_url": "https://github.com/daejunpark",
    "followers_url": "https://api.github.com/users/daejunpark/followers",
    "following_url": "https://api.github.com/users/daejunpark/following{/other_user}",
    "gists_url": "https://api.github.com/users/daejunpark/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/daejunpark/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/daejunpark/subscriptions",
    "organizations_url": "https://api.github.com/users/daejunpark/orgs",
    "repos_url": "https://api.github.com/users/daejunpark/repos",
    "events_url": "https://api.github.com/users/daejunpark/events{/privacy}",
    "received_events_url": "https://api.github.com/users/daejunpark/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 479554962,
      "node_id": "MDU6TGFiZWw0Nzk1NTQ5NjI=",
      "url": "https://api.github.com/repos/vyperlang/vyper/labels/bug",
      "name": "bug",
      "color": "ee0701",
      "default": true,
      "description": "Bug that shouldn't change language semantics when fixed."
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2019-08-06T19:52:43Z",
  "updated_at": "2019-08-25T16:11:11Z",
  "closed_at": "2019-08-25T16:11:11Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "### Version Information\r\n\r\n* vyper Version (output of `vyper --version`): 0.1.0b11+commit.c775cda (the latest master)\r\n  * The buggy behavior happens for both recent releases, [v0.1.0-beta.10](https://github.com/ethereum/vyper/releases/tag/v0.1.0-beta.10) and [v0.1.0-beta.11](https://github.com/ethereum/vyper/releases/tag/v0.1.0-beta.11), as well.\r\n\r\n### What's your issue about?\r\n\r\n#### Summary:\r\n\r\nA function whose return type is `bytes[n]` where `n < 16`, returns a value that does *not* conform to [the ABI encoding](https://solidity.readthedocs.io/en/v0.5.10/abi-spec.html), having incorrect zero-padding.\r\n\r\n#### Details:\r\n\r\nFor example, [the `get_deposit_count` function of the deposit contract](https://github.com/ethereum/eth2.0-specs/blob/v0.8.0/deposit_contract/contracts/validator_registration.v.py#L60), whose return type is `bytes[8]`, returns the following 96 bytes (in hexadecimal notation):\r\n```\r\n0x0000000000000000000000000000000000000000000000000000000000000020\r\n  0000000000000000000000000000000000000000000000000000000000000008\r\n  deadbeefdeadbeef000000000000000000000000000000000000000000000020\r\n                                                                ^^  <-- problem!\r\n```\r\nwhere the first 32 bytes (the first line) denotes the header (the offset 32 = 0x20), the second 32 bytes (the second line) denotes the length of the byte array (8), and the \"`deadbeefdeadbeef`\" denotes the content of the byte array (`bytes[8]`). *Here, the problem is that the last byte is 32 (= 0x20) while it should be 0 (= 0x00) according to the ABI specification.* This means that any contract (written in either Solidity or Vyper) that calls to this type of functions expecting the correct zero-padding may misbehave.\r\n\r\nWhat happens is that the compiled bytecode of `get_deposit_count` fails to sufficiently pad zeros when it prepares for the return value. In the following return statement,\r\n```\r\nreturn self.to_little_endian_64(self.deposit_count)\r\n```\r\nit first copies the returned value (of 8 bytes) to some specific region of the memory, and puts only 8 bytes of zero-padding after that, instead of 24 bytes of zeros, which results in including some garbage values in the last 16 bytes. Indeed, in this particular case, the last 16 bytes (`000000000000000000000000020`) came from the side-effect of the sub-function call to `self.to_little_endian_64()`.\r\n\r\nTo be more specific, in the following zero-padding LLL code of `get_deposit_count` (generated by [the `zero_pad` function of `vyper/parser/stmt.py`](https://github.com/ethereum/vyper/blob/c775cda6a34b62612b4160d9017ad701f4f52db8/vyper/parser/stmt.py#L780-L799)):\r\n```\r\n            /* Zero pad */\r\n            [with,\r\n              _ceil32_end,\r\n              [ceil32, [mload, 640]],\r\n              [repeat,\r\n                736,\r\n                [mload, 640],\r\n    ??? -->     8,\r\n                [seq,\r\n                  [if, [gt, [mload, 736], _ceil32_end], break],\r\n                  [mstore8, [add, 672, [mload, 736]], 0]]]],\r\n            [mstore, 608, 32],\r\n            [return, 608, [ceil32, [add, [mload, 640], 64]]],\r\n            # Line 58\r\n            stop]],\r\n```\r\nthe third argument of the `repeat` loop is 8, where it should be at least 24.  In a quick examination of the Vyper compiler code, it seems that the number `8` comes from the `maxlen` of the type `bytes[8]`, but I couldn't have a chance to further investigate the root cause and a quick fix.\r\n\r\n\r\nIndeed, the same problem happens in [the `to_little_endian_64` function](https://github.com/ethereum/eth2.0-specs/blob/v0.8.0/deposit_contract/contracts/validator_registration.v.py#L30) as well,  which has less effect because it is a private function, though.\r\n\r\n\r\n_[This bug was privately reported on July 22, 2019, confirmed as not a security vulnerability, and made public here for the transparency.]_",
  "closed_by": {
    "login": "charles-cooper",
    "id": 3867501,
    "node_id": "MDQ6VXNlcjM4Njc1MDE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3867501?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/charles-cooper",
    "html_url": "https://github.com/charles-cooper",
    "followers_url": "https://api.github.com/users/charles-cooper/followers",
    "following_url": "https://api.github.com/users/charles-cooper/following{/other_user}",
    "gists_url": "https://api.github.com/users/charles-cooper/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/charles-cooper/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/charles-cooper/subscriptions",
    "organizations_url": "https://api.github.com/users/charles-cooper/orgs",
    "repos_url": "https://api.github.com/users/charles-cooper/repos",
    "events_url": "https://api.github.com/users/charles-cooper/events{/privacy}",
    "received_events_url": "https://api.github.com/users/charles-cooper/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/1563/reactions",
    "total_count": 3,
    "+1": 3,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/vyperlang/vyper/issues/1563/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/518835276",
    "html_url": "https://github.com/vyperlang/vyper/issues/1563#issuecomment-518835276",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/1563",
    "id": 518835276,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUxODgzNTI3Ng==",
    "user": {
      "login": "daejunpark",
      "id": 5491770,
      "node_id": "MDQ6VXNlcjU0OTE3NzA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5491770?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/daejunpark",
      "html_url": "https://github.com/daejunpark",
      "followers_url": "https://api.github.com/users/daejunpark/followers",
      "following_url": "https://api.github.com/users/daejunpark/following{/other_user}",
      "gists_url": "https://api.github.com/users/daejunpark/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/daejunpark/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/daejunpark/subscriptions",
      "organizations_url": "https://api.github.com/users/daejunpark/orgs",
      "repos_url": "https://api.github.com/users/daejunpark/repos",
      "events_url": "https://api.github.com/users/daejunpark/events{/privacy}",
      "received_events_url": "https://api.github.com/users/daejunpark/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-08-06T20:40:39Z",
    "updated_at": "2019-08-07T18:26:14Z",
    "author_association": "CONTRIBUTOR",
    "body": "To quickly reproduce the buggy behavior:\r\n```\r\n$ git clone https://github.com/ethereum/eth2.0-specs.git\r\n$ cd eth2.0-specs\r\n[change tests as described in https://github.com/ethereum/eth2.0-specs/issues/1341]\r\n$ make install_deposit_contract_test\r\n$ ( . deposit_contract/venv/bin/activate\r\n    && pip3 uninstall vyper\r\n    && cd /path/to/vyper\r\n    && make )\r\n$ make compile_deposit_contract\r\n$ make test_deposit_contract\r\n```\r\n\r\nAlso see: https://github.com/ethereum/eth2.0-specs/issues/1341",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/518835276/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/518857486",
    "html_url": "https://github.com/vyperlang/vyper/issues/1563#issuecomment-518857486",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/1563",
    "id": 518857486,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUxODg1NzQ4Ng==",
    "user": {
      "login": "davesque",
      "id": 791437,
      "node_id": "MDQ6VXNlcjc5MTQzNw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/791437?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/davesque",
      "html_url": "https://github.com/davesque",
      "followers_url": "https://api.github.com/users/davesque/followers",
      "following_url": "https://api.github.com/users/davesque/following{/other_user}",
      "gists_url": "https://api.github.com/users/davesque/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/davesque/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/davesque/subscriptions",
      "organizations_url": "https://api.github.com/users/davesque/orgs",
      "repos_url": "https://api.github.com/users/davesque/repos",
      "events_url": "https://api.github.com/users/davesque/events{/privacy}",
      "received_events_url": "https://api.github.com/users/davesque/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-08-06T21:51:03Z",
    "updated_at": "2019-08-06T21:51:03Z",
    "author_association": "CONTRIBUTOR",
    "body": "Thanks for the heads up.  I'll try and figure this out.",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/518857486/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
