{
  "url": "https://api.github.com/repos/vyperlang/vyper/issues/1511",
  "repository_url": "https://api.github.com/repos/vyperlang/vyper",
  "labels_url": "https://api.github.com/repos/vyperlang/vyper/issues/1511/labels{/name}",
  "comments_url": "https://api.github.com/repos/vyperlang/vyper/issues/1511/comments",
  "events_url": "https://api.github.com/repos/vyperlang/vyper/issues/1511/events",
  "html_url": "https://github.com/vyperlang/vyper/issues/1511",
  "id": 463118915,
  "node_id": "MDU6SXNzdWU0NjMxMTg5MTU=",
  "number": 1511,
  "title": "Stack underflow in unreachable ERC20.transfer",
  "user": {
    "login": "dHonerkamp",
    "id": 31133390,
    "node_id": "MDQ6VXNlcjMxMTMzMzkw",
    "avatar_url": "https://avatars.githubusercontent.com/u/31133390?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/dHonerkamp",
    "html_url": "https://github.com/dHonerkamp",
    "followers_url": "https://api.github.com/users/dHonerkamp/followers",
    "following_url": "https://api.github.com/users/dHonerkamp/following{/other_user}",
    "gists_url": "https://api.github.com/users/dHonerkamp/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/dHonerkamp/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/dHonerkamp/subscriptions",
    "organizations_url": "https://api.github.com/users/dHonerkamp/orgs",
    "repos_url": "https://api.github.com/users/dHonerkamp/repos",
    "events_url": "https://api.github.com/users/dHonerkamp/events{/privacy}",
    "received_events_url": "https://api.github.com/users/dHonerkamp/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 479554962,
      "node_id": "MDU6TGFiZWw0Nzk1NTQ5NjI=",
      "url": "https://api.github.com/repos/vyperlang/vyper/labels/bug",
      "name": "bug",
      "color": "ee0701",
      "default": true,
      "description": "Bug that shouldn't change language semantics when fixed."
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 13,
  "created_at": "2019-07-02T09:23:27Z",
  "updated_at": "2019-11-07T17:55:32Z",
  "closed_at": "2019-11-07T17:55:32Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Version Information\r\n\r\n* vyper Version (output of `vyper --version`): 0.1.0b10\r\n* OS: osx mojave 10.14.5\r\n* Python Version (output of `python --version`): 3.7.3\r\n* Environment (output of `pip freeze`):\r\n```\r\nappnope==0.1.0\r\nasteval==0.9.14\r\nattrs==19.1.0\r\nbackcall==0.1.0\r\nbeautifulsoup4==4.7.1\r\nbleach==3.1.0\r\nbs4==0.0.1\r\ncachetools==3.1.1\r\ncertifi==2019.3.9\r\nchardet==3.0.4\r\ncycler==0.10.0\r\ndecorator==4.4.0\r\ndefusedxml==0.6.0\r\nentrypoints==0.3\r\ngoogle-api-core==1.11.1\r\ngoogle-auth==1.6.3\r\ngoogle-cloud-bigquery==1.13.0\r\ngoogle-cloud-core==1.0.1\r\ngoogle-cloud-storage==1.16.1\r\ngoogle-resumable-media==0.3.2\r\ngoogleapis-common-protos==1.6.0\r\nidna==2.8\r\nipykernel==5.1.1\r\nipython==7.5.0\r\nipython-genutils==0.2.0\r\nipywidgets==7.4.2\r\njedi==0.13.3\r\nJinja2==2.10.1\r\njoblib==0.13.2\r\njsonschema==3.0.1\r\njupyter==1.0.0\r\njupyter-client==5.2.4\r\njupyter-console==6.0.0\r\njupyter-core==4.4.0\r\nkiwisolver==1.1.0\r\nlmfit==0.9.13\r\nMarkupSafe==1.1.1\r\nmatplotlib==3.1.0\r\nmistune==0.8.4\r\nnbconvert==5.5.0\r\nnbformat==4.4.0\r\nnoisyopt==0.2.2\r\nnotebook==5.7.8\r\nnumpy==1.16.4\r\npandas==0.24.2\r\npandocfilters==1.4.2\r\nparso==0.4.0\r\npexpect==4.7.0\r\npickleshare==0.7.5\r\nprometheus-client==0.6.0\r\nprompt-toolkit==2.0.9\r\nprotobuf==3.8.0\r\nptyprocess==0.6.0\r\npyasn1==0.4.5\r\npyasn1-modules==0.2.5\r\npycryptodome==3.8.2\r\nPygments==2.4.2\r\npyparsing==2.4.0\r\nPyPortfolioOpt==0.3.1\r\npyrsistent==0.15.2\r\npython-dateutil==2.8.0\r\npytz==2019.1\r\npyzmq==18.0.1\r\nqtconsole==4.5.1\r\nrequests==2.22.0\r\nrsa==4.0\r\nscikit-learn==0.21.2\r\nscipy==1.3.0\r\nseaborn==0.9.0\r\nselenium==4.0.0a1\r\nSend2Trash==1.5.0\r\nsix==1.12.0\r\nsklearn==0.0\r\nsortedcontainers==2.1.0\r\nsoupsieve==1.9.1\r\nterminado==0.8.2\r\ntestpath==0.4.2\r\ntornado==6.0.2\r\ntraitlets==4.3.2\r\nuncertainties==3.1.1\r\nurllib3==1.25.3\r\nvyper==0.1.0b10\r\nwcwidth==0.1.7\r\nwebencodings==0.5.1\r\nwidgetsnbextension==3.4.2\r\n```\r\n\r\n### What's your issue about?\r\n\r\nTransfer to an ERC20 token returns stack underflow if it is in an if clause that never gets executed, but works without the if clause.\r\n\r\nContract ERC20DummyToken.sol:\r\n\r\n```\r\npragma solidity ^0.5.0;\r\n\r\nimport \"openzeppelin-solidity/contracts/token/ERC20/ERC20.sol\";\r\nimport \"openzeppelin-solidity/contracts/token/ERC20/ERC20Detailed.sol\";\r\n\r\ncontract ERC20DumyToken is ERC20, ERC20Detailed {\r\n    constructor(uint256 initialSupply) ERC20Detailed(\"Dummy\", \"DUM\", 18) public {\r\n        _mint(msg.sender, initialSupply);\r\n    }\r\n}\r\n```\r\n\r\nContract vyperIssue.vy:\r\n\r\n```\r\nfrom vyper.interfaces import ERC20\r\n\r\ndeposits: public(map(address, uint256))\r\ntoken: ERC20\r\n\r\n@public\r\ndef __init__(_ERC20Address: address):\r\n    self.token = ERC20(_ERC20Address)\r\n\r\n@public\r\ndef bid(_amount: uint256):\r\n    if False:\r\n        self.token.transfer(msg.sender, _amount)\r\n```\r\n\r\ntest.js:\r\n```\r\nconst ERC20DummyToken = artifacts.require(\"ERC20DummyToken\");\r\nconst auction = artifacts.require(\"vyperIssue\");\r\n\r\ncontract(\"auction\", async accounts => {\r\n    it(\"do stuff\", async () => {\r\n        let _initialSupply = 100000\r\n        let token = await ERC20DummyToken.new(_initialSupply)\r\n        let instance = await auction.new(token.address);\r\n\r\n        await token.transfer(instance.address, 10000)\r\n        await instance.bid(500, {from: accounts[1]})\r\n    });\r\n});\r\n```\r\nReturns:\r\n```\r\n     Error: Returned error: VM Exception while processing transaction: stack underflow\r\n      at Object.ErrorResponse (/Users/danielhonerkamp/.npm-packages/lib/node_modules/truffle/build/webpack:/~/web3-core-requestmanager/~/web3-core-helpers/src/errors.js:29:1)\r\n      at /Users/danielhonerkamp/.npm-packages/lib/node_modules/truffle/build/webpack:/~/web3-core-requestmanager/src/index.js:140:1\r\n      at /Users/danielhonerkamp/.npm-packages/lib/node_modules/truffle/build/webpack:/packages/truffle-provider/wrapper.js:112:1\r\n      at XMLHttpRequest.request.onreadystatechange (/Users/danielhonerkamp/.npm-packages/lib/node_modules/truffle/build/webpack:/~/web3-providers-http/src/index.js:96:1)\r\n      at XMLHttpRequestEventTarget.dispatchEvent (/Users/danielhonerkamp/.npm-packages/lib/node_modules/truffle/build/webpack:/~/xhr2-cookies/dist/xml-http-request-event-target.js:34:1)\r\n      at XMLHttpRequest._setReadyState (/Users/danielhonerkamp/.npm-packages/lib/node_modules/truffle/build/webpack:/~/xhr2-cookies/dist/xml-http-request.js:208:1)\r\n      at XMLHttpRequest._onHttpResponseEnd (/Users/danielhonerkamp/.npm-packages/lib/node_modules/truffle/build/webpack:/~/xhr2-cookies/dist/xml-http-request.js:318:1)\r\n      at IncomingMessage.<anonymous> (/Users/danielhonerkamp/.npm-packages/lib/node_modules/truffle/build/webpack:/~/xhr2-cookies/dist/xml-http-request.js:289:47)\r\n      at endReadableNT (_stream_readable.js:1129:12)\r\n      at process._tickCallback (internal/process/next_tick.js:63:19)\r\n```\r\n\r\nThe test succeeds if I remove the if clause:\r\n```\r\n@public\r\ndef bid(_amount: uint256):\r\n    self.token.transfer(msg.sender, _amount)\r\n```\r\n",
  "closed_by": {
    "login": "charles-cooper",
    "id": 3867501,
    "node_id": "MDQ6VXNlcjM4Njc1MDE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3867501?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/charles-cooper",
    "html_url": "https://github.com/charles-cooper",
    "followers_url": "https://api.github.com/users/charles-cooper/followers",
    "following_url": "https://api.github.com/users/charles-cooper/following{/other_user}",
    "gists_url": "https://api.github.com/users/charles-cooper/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/charles-cooper/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/charles-cooper/subscriptions",
    "organizations_url": "https://api.github.com/users/charles-cooper/orgs",
    "repos_url": "https://api.github.com/users/charles-cooper/repos",
    "events_url": "https://api.github.com/users/charles-cooper/events{/privacy}",
    "received_events_url": "https://api.github.com/users/charles-cooper/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/1511/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/vyperlang/vyper/issues/1511/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/512758573",
    "html_url": "https://github.com/vyperlang/vyper/issues/1511#issuecomment-512758573",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/1511",
    "id": 512758573,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUxMjc1ODU3Mw==",
    "user": {
      "login": "dHonerkamp",
      "id": 31133390,
      "node_id": "MDQ6VXNlcjMxMTMzMzkw",
      "avatar_url": "https://avatars.githubusercontent.com/u/31133390?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dHonerkamp",
      "html_url": "https://github.com/dHonerkamp",
      "followers_url": "https://api.github.com/users/dHonerkamp/followers",
      "following_url": "https://api.github.com/users/dHonerkamp/following{/other_user}",
      "gists_url": "https://api.github.com/users/dHonerkamp/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dHonerkamp/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dHonerkamp/subscriptions",
      "organizations_url": "https://api.github.com/users/dHonerkamp/orgs",
      "repos_url": "https://api.github.com/users/dHonerkamp/repos",
      "events_url": "https://api.github.com/users/dHonerkamp/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dHonerkamp/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-07-18T10:24:29Z",
    "updated_at": "2019-07-18T10:24:29Z",
    "author_association": "NONE",
    "body": "More generally, this seems to be an issue whenever I have something in the form of\r\n```\r\nif condition:\r\n        self.token.transfer(msg.sender, _amount)\r\n```\r\nAnd the condition evaluates to `False`.",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/512758573/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/512851343",
    "html_url": "https://github.com/vyperlang/vyper/issues/1511#issuecomment-512851343",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/1511",
    "id": 512851343,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUxMjg1MTM0Mw==",
    "user": {
      "login": "fubuloubu",
      "id": 3859395,
      "node_id": "MDQ6VXNlcjM4NTkzOTU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3859395?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fubuloubu",
      "html_url": "https://github.com/fubuloubu",
      "followers_url": "https://api.github.com/users/fubuloubu/followers",
      "following_url": "https://api.github.com/users/fubuloubu/following{/other_user}",
      "gists_url": "https://api.github.com/users/fubuloubu/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fubuloubu/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fubuloubu/subscriptions",
      "organizations_url": "https://api.github.com/users/fubuloubu/orgs",
      "repos_url": "https://api.github.com/users/fubuloubu/repos",
      "events_url": "https://api.github.com/users/fubuloubu/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fubuloubu/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-07-18T14:55:41Z",
    "updated_at": "2019-07-18T14:55:58Z",
    "author_association": "MEMBER",
    "body": "More simply, it looks like it might be:\r\n\r\n```python\r\nif condition:\r\n    external_call()\r\n# else:\r\n    # nothing (stack underflow in this case)\r\n```\r\n\r\nCan anyone confirm this with a MWE that's not a token?",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/512851343/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/513743867",
    "html_url": "https://github.com/vyperlang/vyper/issues/1511#issuecomment-513743867",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/1511",
    "id": 513743867,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUxMzc0Mzg2Nw==",
    "user": {
      "login": "dHonerkamp",
      "id": 31133390,
      "node_id": "MDQ6VXNlcjMxMTMzMzkw",
      "avatar_url": "https://avatars.githubusercontent.com/u/31133390?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dHonerkamp",
      "html_url": "https://github.com/dHonerkamp",
      "followers_url": "https://api.github.com/users/dHonerkamp/followers",
      "following_url": "https://api.github.com/users/dHonerkamp/following{/other_user}",
      "gists_url": "https://api.github.com/users/dHonerkamp/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dHonerkamp/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dHonerkamp/subscriptions",
      "organizations_url": "https://api.github.com/users/dHonerkamp/orgs",
      "repos_url": "https://api.github.com/users/dHonerkamp/repos",
      "events_url": "https://api.github.com/users/dHonerkamp/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dHonerkamp/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-07-22T10:56:28Z",
    "updated_at": "2019-07-22T10:56:28Z",
    "author_association": "NONE",
    "body": "That seems to be correct. I've run the following example\r\n\r\n```\r\nfrom vyper.interfaces import ERC20\r\n\r\ncontract Example:\r\n    def doStuff() -> bool: modifying\r\n\r\ndeposits: public(map(address, uint256))\r\ntoken: ERC20\r\nexample: Example\r\n\r\n@public\r\ndef __init__(_ERC20Address: address, _exampleAddress: address):\r\n    self.token = ERC20(_ERC20Address)\r\n    self.example = Example(_exampleAddress)\r\n\r\n@public\r\ndef tokenTest(condition: bool, _amount: uint256):\r\n    if condition:\r\n        self.token.transfer(msg.sender, _amount)\r\n\r\n@public\r\ndef exampleTest(condition: bool):\r\n    if condition:\r\n        self.example.doStuff()\r\n```\r\nwith this Example.vy:\r\n```\r\nowner: address\r\n\r\n@public\r\ndef __init__():\r\n    self.owner = msg.sender\r\n\r\n@public\r\ndef doStuff() -> bool:\r\n    return True\r\n```\r\n\r\nAnd as expected, calls to `tokenTest()` and `exampleTest()` fail whenever I pass `condition` as false",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/513743867/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/514241796",
    "html_url": "https://github.com/vyperlang/vyper/issues/1511#issuecomment-514241796",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/1511",
    "id": 514241796,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUxNDI0MTc5Ng==",
    "user": {
      "login": "brockelmore",
      "id": 31553173,
      "node_id": "MDQ6VXNlcjMxNTUzMTcz",
      "avatar_url": "https://avatars.githubusercontent.com/u/31553173?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/brockelmore",
      "html_url": "https://github.com/brockelmore",
      "followers_url": "https://api.github.com/users/brockelmore/followers",
      "following_url": "https://api.github.com/users/brockelmore/following{/other_user}",
      "gists_url": "https://api.github.com/users/brockelmore/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/brockelmore/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/brockelmore/subscriptions",
      "organizations_url": "https://api.github.com/users/brockelmore/orgs",
      "repos_url": "https://api.github.com/users/brockelmore/repos",
      "events_url": "https://api.github.com/users/brockelmore/events{/privacy}",
      "received_events_url": "https://api.github.com/users/brockelmore/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-07-23T14:44:51Z",
    "updated_at": "2019-07-23T14:44:51Z",
    "author_association": "CONTRIBUTOR",
    "body": "Note on this - if the external call only transfers ETH, i.e.:\r\n\r\n```\r\nif condition:\r\n    interface(addr).func1(value=msg.value)\r\n```\r\nI get no error. But, if using erc20:\r\n```\r\nif condition:\r\n    interface(addr).func1(value=msg.value)\r\nelse:\r\n    interface(addr).func1(SomeUint256)\r\n```\r\nand the else clause fires, I get stack underflow",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/514241796/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/530687021",
    "html_url": "https://github.com/vyperlang/vyper/issues/1511#issuecomment-530687021",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/1511",
    "id": 530687021,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUzMDY4NzAyMQ==",
    "user": {
      "login": "smarx",
      "id": 35551,
      "node_id": "MDQ6VXNlcjM1NTUx",
      "avatar_url": "https://avatars.githubusercontent.com/u/35551?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/smarx",
      "html_url": "https://github.com/smarx",
      "followers_url": "https://api.github.com/users/smarx/followers",
      "following_url": "https://api.github.com/users/smarx/following{/other_user}",
      "gists_url": "https://api.github.com/users/smarx/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/smarx/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/smarx/subscriptions",
      "organizations_url": "https://api.github.com/users/smarx/orgs",
      "repos_url": "https://api.github.com/users/smarx/repos",
      "events_url": "https://api.github.com/users/smarx/events{/privacy}",
      "received_events_url": "https://api.github.com/users/smarx/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-09-12T06:35:09Z",
    "updated_at": "2019-09-12T06:35:09Z",
    "author_association": "CONTRIBUTOR",
    "body": "Perhaps a simpler repro:\r\n\r\n```python\r\n@public\r\n@payable\r\ndef doit():\r\n    if False:\r\n        raw_call(msg.sender, b\"\", outsize=0, value=0, gas=msg.gas)\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/530687021/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/530688751",
    "html_url": "https://github.com/vyperlang/vyper/issues/1511#issuecomment-530688751",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/1511",
    "id": 530688751,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUzMDY4ODc1MQ==",
    "user": {
      "login": "charles-cooper",
      "id": 3867501,
      "node_id": "MDQ6VXNlcjM4Njc1MDE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3867501?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/charles-cooper",
      "html_url": "https://github.com/charles-cooper",
      "followers_url": "https://api.github.com/users/charles-cooper/followers",
      "following_url": "https://api.github.com/users/charles-cooper/following{/other_user}",
      "gists_url": "https://api.github.com/users/charles-cooper/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/charles-cooper/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/charles-cooper/subscriptions",
      "organizations_url": "https://api.github.com/users/charles-cooper/orgs",
      "repos_url": "https://api.github.com/users/charles-cooper/repos",
      "events_url": "https://api.github.com/users/charles-cooper/events{/privacy}",
      "received_events_url": "https://api.github.com/users/charles-cooper/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-09-12T06:41:21Z",
    "updated_at": "2019-09-12T06:41:21Z",
    "author_association": "COLLABORATOR",
    "body": "the if statement translates to\r\n\r\n```python\r\nJUMPI \r\nPUSH1 0 \r\nISZERO \r\n_sym_4\r\nand _sym_4 is\r\n\r\n_sym_4 \r\nJUMPDEST \r\nPOP  # <--  this doesn't seem right ..\r\nSTOP\r\n```\r\n\r\nthis seems to be the source of that POP:\r\nhttps://github.com/ethereum/vyper/blob/faacf1503e02b7af935a6dcf8eda4ec697ed2101/vyper/parser/function_definitions/utils.py#L47",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/530688751/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/531509011",
    "html_url": "https://github.com/vyperlang/vyper/issues/1511#issuecomment-531509011",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/1511",
    "id": 531509011,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUzMTUwOTAxMQ==",
    "user": {
      "login": "smarx",
      "id": 35551,
      "node_id": "MDQ6VXNlcjM1NTUx",
      "avatar_url": "https://avatars.githubusercontent.com/u/35551?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/smarx",
      "html_url": "https://github.com/smarx",
      "followers_url": "https://api.github.com/users/smarx/followers",
      "following_url": "https://api.github.com/users/smarx/following{/other_user}",
      "gists_url": "https://api.github.com/users/smarx/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/smarx/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/smarx/subscriptions",
      "organizations_url": "https://api.github.com/users/smarx/orgs",
      "repos_url": "https://api.github.com/users/smarx/repos",
      "events_url": "https://api.github.com/users/smarx/events{/privacy}",
      "received_events_url": "https://api.github.com/users/smarx/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-09-14T20:00:07Z",
    "updated_at": "2019-09-14T20:00:07Z",
    "author_association": "CONTRIBUTOR",
    "body": "@charles-cooper Why do you think the issue relates to `nonreentrant_post`? That doesn't seem to have any effect.\r\n\r\nI think the issue has to do with valency. The external call has a valency of 1 because it pushes the memory location of the output to the stack.\r\n\r\nSo:\r\n\r\n```python\r\nif False:\r\n    # here we leave something on the stack\r\nelse:  # implicit\r\n    # here we don't\r\n```\r\n\r\nThis line means we treat the entire `if` as having valency 1:\r\n\r\nhttps://github.com/ethereum/vyper/blob/4ab9ec18216d52df4a0d16b84ee767cc58cbde6b/vyper/parser/lll_node.py#L145\r\n\r\nI don't have much experience with the Vyper compiler, so it's hard for me to suggest or implement a fix. Intuitively, I think `if` statements should always have valency 0, and each branch must do its own cleanup (e.g. each branch should `POP` _n_ times at the end to get its valency down to 0).",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/531509011/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/531509250",
    "html_url": "https://github.com/vyperlang/vyper/issues/1511#issuecomment-531509250",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/1511",
    "id": 531509250,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUzMTUwOTI1MA==",
    "user": {
      "login": "charles-cooper",
      "id": 3867501,
      "node_id": "MDQ6VXNlcjM4Njc1MDE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3867501?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/charles-cooper",
      "html_url": "https://github.com/charles-cooper",
      "followers_url": "https://api.github.com/users/charles-cooper/followers",
      "following_url": "https://api.github.com/users/charles-cooper/following{/other_user}",
      "gists_url": "https://api.github.com/users/charles-cooper/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/charles-cooper/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/charles-cooper/subscriptions",
      "organizations_url": "https://api.github.com/users/charles-cooper/orgs",
      "repos_url": "https://api.github.com/users/charles-cooper/repos",
      "events_url": "https://api.github.com/users/charles-cooper/events{/privacy}",
      "received_events_url": "https://api.github.com/users/charles-cooper/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-09-14T20:03:34Z",
    "updated_at": "2019-09-14T20:03:34Z",
    "author_association": "COLLABORATOR",
    "body": "@smarx nice digging, that looks like you are on the right track. I don't have much time to look into this today but you could also take a look at `vyper/compile_lll.py`, there is a section which compiles if statements.",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/531509250/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/531509667",
    "html_url": "https://github.com/vyperlang/vyper/issues/1511#issuecomment-531509667",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/1511",
    "id": 531509667,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUzMTUwOTY2Nw==",
    "user": {
      "login": "smarx",
      "id": 35551,
      "node_id": "MDQ6VXNlcjM1NTUx",
      "avatar_url": "https://avatars.githubusercontent.com/u/35551?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/smarx",
      "html_url": "https://github.com/smarx",
      "followers_url": "https://api.github.com/users/smarx/followers",
      "following_url": "https://api.github.com/users/smarx/following{/other_user}",
      "gists_url": "https://api.github.com/users/smarx/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/smarx/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/smarx/subscriptions",
      "organizations_url": "https://api.github.com/users/smarx/orgs",
      "repos_url": "https://api.github.com/users/smarx/repos",
      "events_url": "https://api.github.com/users/smarx/events{/privacy}",
      "received_events_url": "https://api.github.com/users/smarx/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-09-14T20:10:05Z",
    "updated_at": "2019-09-14T20:10:05Z",
    "author_association": "CONTRIBUTOR",
    "body": "I left out some of the debugging, sorry.\r\n\r\nThis appears to be where the extra `POP` comes from:\r\n\r\nhttps://github.com/ethereum/vyper/blob/4ab9ec18216d52df4a0d16b84ee767cc58cbde6b/vyper/compile_lll.py#L245\r\n\r\nIt's there because the valency of the sequence is 1 because the valency of the `if` statement is 1 as explained above.\r\n\r\nI was testing this Vyper:\r\n\r\n```python\r\n@public\r\n@payable\r\ndef doit():\r\n    if False:\r\n        raw_call(msg.sender, b\"\", outsize=0, value=0, gas=msg.gas)\r\n```\r\n\r\nwhich compiles to this IR:\r\n\r\n```text\r\n[seq,\r\n  [return,\r\n    0,\r\n    [lll,\r\n      [seq,\r\n        [mstore, 28, [calldataload, 0]],\r\n        [mstore, 32, 1461501637330902918203684832716283019655932542976],\r\n        [mstore, 64, 170141183460469231731687303715884105727],\r\n        [mstore, 96, -170141183460469231731687303715884105728],\r\n        [mstore, 128, 1701411834604692317316873037158841057270000000000],\r\n        [mstore, 160, -1701411834604692317316873037158841057280000000000],\r\n        # Line 1\r\n        [if,\r\n          [eq, [mload, 0], '1297313763' <doit()>],\r\n          [seq,\r\n            # Line 4\r\n            [if,\r\n              0,\r\n              [seq,\r\n                # Line 5\r\n                /* Memory copy */\r\n                [with,\r\n                  _source,\r\n                  /* Create bytes[0]: b'' */ [seq, [mstore, 320, 0], 320],\r\n                  [with,\r\n                    _sz,\r\n                    [add, 32, [mload, _source]],\r\n                    [assert, [call, [add, 18, [div, _sz, 10]], 4, 0, _source, _sz, 384, _sz]]]],\r\n                [assert, [call, gas, caller, 0, 416, [mload, 384], 480, 0]],\r\n                [mstore, 448, 0],\r\n                448]],\r\n            # Line 1\r\n            stop]],\r\n        /* Default function */ [revert, 0, 0]],\r\n      0]]]\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/531509667/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/531515997",
    "html_url": "https://github.com/vyperlang/vyper/issues/1511#issuecomment-531515997",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/1511",
    "id": 531515997,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUzMTUxNTk5Nw==",
    "user": {
      "login": "charles-cooper",
      "id": 3867501,
      "node_id": "MDQ6VXNlcjM4Njc1MDE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3867501?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/charles-cooper",
      "html_url": "https://github.com/charles-cooper",
      "followers_url": "https://api.github.com/users/charles-cooper/followers",
      "following_url": "https://api.github.com/users/charles-cooper/following{/other_user}",
      "gists_url": "https://api.github.com/users/charles-cooper/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/charles-cooper/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/charles-cooper/subscriptions",
      "organizations_url": "https://api.github.com/users/charles-cooper/orgs",
      "repos_url": "https://api.github.com/users/charles-cooper/repos",
      "events_url": "https://api.github.com/users/charles-cooper/events{/privacy}",
      "received_events_url": "https://api.github.com/users/charles-cooper/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-09-14T21:40:25Z",
    "updated_at": "2019-09-14T21:40:25Z",
    "author_association": "COLLABORATOR",
    "body": "@smarx I think your approach is good. If you wanted, I think (not at a keyboard so this is off the top of my head) you could change the valency of LLL `if` to 0, and then where user if statements are compiled in `stmt.pt`, wrap both branches in a `seq` to ensure they are zerovalent.",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/531515997/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/531516134",
    "html_url": "https://github.com/vyperlang/vyper/issues/1511#issuecomment-531516134",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/1511",
    "id": 531516134,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUzMTUxNjEzNA==",
    "user": {
      "login": "charles-cooper",
      "id": 3867501,
      "node_id": "MDQ6VXNlcjM4Njc1MDE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3867501?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/charles-cooper",
      "html_url": "https://github.com/charles-cooper",
      "followers_url": "https://api.github.com/users/charles-cooper/followers",
      "following_url": "https://api.github.com/users/charles-cooper/following{/other_user}",
      "gists_url": "https://api.github.com/users/charles-cooper/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/charles-cooper/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/charles-cooper/subscriptions",
      "organizations_url": "https://api.github.com/users/charles-cooper/orgs",
      "repos_url": "https://api.github.com/users/charles-cooper/repos",
      "events_url": "https://api.github.com/users/charles-cooper/events{/privacy}",
      "received_events_url": "https://api.github.com/users/charles-cooper/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-09-14T21:42:46Z",
    "updated_at": "2019-09-14T21:42:46Z",
    "author_association": "COLLABORATOR",
    "body": "(related: https://github.com/ethereum/vyper/issues/1468#issuecomment-502217610)",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/531516134/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/531521366",
    "html_url": "https://github.com/vyperlang/vyper/issues/1511#issuecomment-531521366",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/1511",
    "id": 531521366,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUzMTUyMTM2Ng==",
    "user": {
      "login": "smarx",
      "id": 35551,
      "node_id": "MDQ6VXNlcjM1NTUx",
      "avatar_url": "https://avatars.githubusercontent.com/u/35551?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/smarx",
      "html_url": "https://github.com/smarx",
      "followers_url": "https://api.github.com/users/smarx/followers",
      "following_url": "https://api.github.com/users/smarx/following{/other_user}",
      "gists_url": "https://api.github.com/users/smarx/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/smarx/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/smarx/subscriptions",
      "organizations_url": "https://api.github.com/users/smarx/orgs",
      "repos_url": "https://api.github.com/users/smarx/repos",
      "events_url": "https://api.github.com/users/smarx/events{/privacy}",
      "received_events_url": "https://api.github.com/users/smarx/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-09-14T23:26:36Z",
    "updated_at": "2019-09-14T23:26:36Z",
    "author_association": "CONTRIBUTOR",
    "body": "I believe both branches are already wrapped in a `seq`, but the valency of a `seq` is not always 0.",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/531521366/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/531829149",
    "html_url": "https://github.com/vyperlang/vyper/issues/1511#issuecomment-531829149",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/1511",
    "id": 531829149,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUzMTgyOTE0OQ==",
    "user": {
      "login": "charles-cooper",
      "id": 3867501,
      "node_id": "MDQ6VXNlcjM4Njc1MDE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3867501?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/charles-cooper",
      "html_url": "https://github.com/charles-cooper",
      "followers_url": "https://api.github.com/users/charles-cooper/followers",
      "following_url": "https://api.github.com/users/charles-cooper/following{/other_user}",
      "gists_url": "https://api.github.com/users/charles-cooper/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/charles-cooper/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/charles-cooper/subscriptions",
      "organizations_url": "https://api.github.com/users/charles-cooper/orgs",
      "repos_url": "https://api.github.com/users/charles-cooper/repos",
      "events_url": "https://api.github.com/users/charles-cooper/events{/privacy}",
      "received_events_url": "https://api.github.com/users/charles-cooper/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-09-16T15:28:41Z",
    "updated_at": "2019-09-16T15:28:41Z",
    "author_association": "COLLABORATOR",
    "body": "also related: https://github.com/ethereum/vyper/pull/1154",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/531829149/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
