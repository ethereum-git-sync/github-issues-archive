{
  "url": "https://api.github.com/repos/vyperlang/vyper/issues/921",
  "repository_url": "https://api.github.com/repos/vyperlang/vyper",
  "labels_url": "https://api.github.com/repos/vyperlang/vyper/issues/921/labels{/name}",
  "comments_url": "https://api.github.com/repos/vyperlang/vyper/issues/921/comments",
  "events_url": "https://api.github.com/repos/vyperlang/vyper/issues/921/events",
  "html_url": "https://github.com/vyperlang/vyper/issues/921",
  "id": 334279036,
  "node_id": "MDU6SXNzdWUzMzQyNzkwMzY=",
  "number": 921,
  "title": "Gas estimates for functions involving writing to storage are too large",
  "user": {
    "login": "JustinWayland",
    "id": 20479646,
    "node_id": "MDQ6VXNlcjIwNDc5NjQ2",
    "avatar_url": "https://avatars.githubusercontent.com/u/20479646?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/JustinWayland",
    "html_url": "https://github.com/JustinWayland",
    "followers_url": "https://api.github.com/users/JustinWayland/followers",
    "following_url": "https://api.github.com/users/JustinWayland/following{/other_user}",
    "gists_url": "https://api.github.com/users/JustinWayland/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/JustinWayland/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/JustinWayland/subscriptions",
    "organizations_url": "https://api.github.com/users/JustinWayland/orgs",
    "repos_url": "https://api.github.com/users/JustinWayland/repos",
    "events_url": "https://api.github.com/users/JustinWayland/events{/privacy}",
    "received_events_url": "https://api.github.com/users/JustinWayland/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 479554962,
      "node_id": "MDU6TGFiZWw0Nzk1NTQ5NjI=",
      "url": "https://api.github.com/repos/vyperlang/vyper/labels/bug",
      "name": "bug",
      "color": "ee0701",
      "default": true,
      "description": "Bug that shouldn't change language semantics when fixed."
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2018-06-20T23:01:57Z",
  "updated_at": "2019-01-02T16:03:14Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Version Information\r\n\r\nFound on online compiler [here.](https://vyper.online)\r\n\r\n### What's your issue about?\r\n\r\nWhen a function writes to any variable in storage, the gas estimator will output an estimate that is far too big for the amount of gas that is actually consumed, even in the worst case.\r\n\r\nFor an example of this bug in action, compile this contract:\r\n\r\n```python\r\nflag: public(bool)\r\n\r\n@public\r\ndef __init__():\r\n    self.flag = False\r\n    \r\n@public\r\ndef set_flag():\r\n    self.flag = True\r\n    \r\n@public\r\ndef reset_flag():\r\n    self.flag = False\r\n```\r\n\r\nThe gas estimates provided by vyper for set_flag and reset_flag will be 15000 more than what they will actually consume in the worst case.\r\n\r\n### How can it be fixed?\r\n\r\nSet the entry for SSTORE in vyper/opcodes.py to the following:\r\n```python\r\n'SSTORE': [0x55, 2, 0, 5000]\r\n```\r\n\r\nEDIT: As an alternative fix, either eliminate the following statement on lines 84-85 of vyper/parser_utils.py\r\n```python\r\nelif self.value.upper() == 'SSTORE' and self.args[1].value != 0:\r\n    self.gas += 15000\r\n```\r\nor change it to the following:\r\n```python\r\nelif self.value.upper() == 'SSTORE' and self.args[1].value == 0:\r\n    self.gas -= 15000\r\n```",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/921/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/vyperlang/vyper/issues/921/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/404566541",
    "html_url": "https://github.com/vyperlang/vyper/issues/921#issuecomment-404566541",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/921",
    "id": 404566541,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQwNDU2NjU0MQ==",
    "user": {
      "login": "jacqueswww",
      "id": 6917456,
      "node_id": "MDQ6VXNlcjY5MTc0NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6917456?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jacqueswww",
      "html_url": "https://github.com/jacqueswww",
      "followers_url": "https://api.github.com/users/jacqueswww/followers",
      "following_url": "https://api.github.com/users/jacqueswww/following{/other_user}",
      "gists_url": "https://api.github.com/users/jacqueswww/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jacqueswww/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jacqueswww/subscriptions",
      "organizations_url": "https://api.github.com/users/jacqueswww/orgs",
      "repos_url": "https://api.github.com/users/jacqueswww/repos",
      "events_url": "https://api.github.com/users/jacqueswww/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jacqueswww/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-07-12T16:11:56Z",
    "updated_at": "2018-07-12T16:14:32Z",
    "author_association": "CONTRIBUTOR",
    "body": "@JustinWayland \r\n![image](https://user-images.githubusercontent.com/6917456/42645619-c8976972-85fe-11e8-84a4-0f2f7ae21b04.png)\r\n\r\nConsidering the above, we can't really tell if the storage was zero'd before (passing in a variable for example), or is just being updated. \r\nTherefore we have to always take the upper bound for SSTORE.\r\n\r\nEven if we have literal 0, we don't know if the state has been set previously or not (all depends on the specific call / history).\r\nThe gas estimator must always rather estimate more gas, rather than less. ",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/404566541/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/405046711",
    "html_url": "https://github.com/vyperlang/vyper/issues/921#issuecomment-405046711",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/921",
    "id": 405046711,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQwNTA0NjcxMQ==",
    "user": {
      "login": "JustinWayland",
      "id": 20479646,
      "node_id": "MDQ6VXNlcjIwNDc5NjQ2",
      "avatar_url": "https://avatars.githubusercontent.com/u/20479646?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/JustinWayland",
      "html_url": "https://github.com/JustinWayland",
      "followers_url": "https://api.github.com/users/JustinWayland/followers",
      "following_url": "https://api.github.com/users/JustinWayland/following{/other_user}",
      "gists_url": "https://api.github.com/users/JustinWayland/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/JustinWayland/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/JustinWayland/subscriptions",
      "organizations_url": "https://api.github.com/users/JustinWayland/orgs",
      "repos_url": "https://api.github.com/users/JustinWayland/repos",
      "events_url": "https://api.github.com/users/JustinWayland/events{/privacy}",
      "received_events_url": "https://api.github.com/users/JustinWayland/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-07-14T20:06:10Z",
    "updated_at": "2018-07-14T20:06:43Z",
    "author_association": "NONE",
    "body": "I know that the vyper compiler is being pessimistic.  The bug in this case is that it is being *too* pessimistic.\r\n\r\nWhat is going on is that there are two places that are accounting for the increased gas cost.  The first is the SSTORE definition in opcode.py, which is not accounting for the literal 0.  The second is the following statement in vyper/parser_utils.py on lines 84-85, which is:\r\n```python\r\nelif self.value.upper() == \"SSTORE\" and self.args[2].value != 0:\r\n    self.gas += 15000\r\n```\r\nIt is what lead me to file this bug in the first place, since it does not seem to take into account the already inflated cost of SSTORE.\r\n\r\nOne possible fix would be to change that statement to the following:\r\n```python\r\nelif self.value.upper() == \"SSTORE\" and self.args[2].value == 0:\r\n    self.gas -= 15000\r\n```\r\nEliminating the statement entirely would also fix the bug.\r\n\r\nI'll edit the original report to include this second possible fix.",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/405046711/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/443185968",
    "html_url": "https://github.com/vyperlang/vyper/issues/921#issuecomment-443185968",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/921",
    "id": 443185968,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ0MzE4NTk2OA==",
    "user": {
      "login": "jacqueswww",
      "id": 6917456,
      "node_id": "MDQ6VXNlcjY5MTc0NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6917456?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jacqueswww",
      "html_url": "https://github.com/jacqueswww",
      "followers_url": "https://api.github.com/users/jacqueswww/followers",
      "following_url": "https://api.github.com/users/jacqueswww/following{/other_user}",
      "gists_url": "https://api.github.com/users/jacqueswww/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jacqueswww/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jacqueswww/subscriptions",
      "organizations_url": "https://api.github.com/users/jacqueswww/orgs",
      "repos_url": "https://api.github.com/users/jacqueswww/repos",
      "events_url": "https://api.github.com/users/jacqueswww/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jacqueswww/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-11-30T12:12:18Z",
    "updated_at": "2018-11-30T12:12:18Z",
    "author_association": "CONTRIBUTOR",
    "body": "Working on this.",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/443185968/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/450687901",
    "html_url": "https://github.com/vyperlang/vyper/issues/921#issuecomment-450687901",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/921",
    "id": 450687901,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ1MDY4NzkwMQ==",
    "user": {
      "login": "Ryan-Gordon",
      "id": 11082710,
      "node_id": "MDQ6VXNlcjExMDgyNzEw",
      "avatar_url": "https://avatars.githubusercontent.com/u/11082710?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Ryan-Gordon",
      "html_url": "https://github.com/Ryan-Gordon",
      "followers_url": "https://api.github.com/users/Ryan-Gordon/followers",
      "following_url": "https://api.github.com/users/Ryan-Gordon/following{/other_user}",
      "gists_url": "https://api.github.com/users/Ryan-Gordon/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Ryan-Gordon/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Ryan-Gordon/subscriptions",
      "organizations_url": "https://api.github.com/users/Ryan-Gordon/orgs",
      "repos_url": "https://api.github.com/users/Ryan-Gordon/repos",
      "events_url": "https://api.github.com/users/Ryan-Gordon/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Ryan-Gordon/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-12-31T20:29:17Z",
    "updated_at": "2018-12-31T20:29:17Z",
    "author_association": "NONE",
    "body": "Still being worked on, or could I take a crack at it ? ",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/450687901/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/450815096",
    "html_url": "https://github.com/vyperlang/vyper/issues/921#issuecomment-450815096",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/921",
    "id": 450815096,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ1MDgxNTA5Ng==",
    "user": {
      "login": "jacqueswww",
      "id": 6917456,
      "node_id": "MDQ6VXNlcjY5MTc0NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6917456?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jacqueswww",
      "html_url": "https://github.com/jacqueswww",
      "followers_url": "https://api.github.com/users/jacqueswww/followers",
      "following_url": "https://api.github.com/users/jacqueswww/following{/other_user}",
      "gists_url": "https://api.github.com/users/jacqueswww/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jacqueswww/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jacqueswww/subscriptions",
      "organizations_url": "https://api.github.com/users/jacqueswww/orgs",
      "repos_url": "https://api.github.com/users/jacqueswww/repos",
      "events_url": "https://api.github.com/users/jacqueswww/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jacqueswww/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-01-02T09:13:38Z",
    "updated_at": "2019-01-02T09:36:45Z",
    "author_association": "CONTRIBUTOR",
    "body": "@Ryan-Gordon I have started on this, Unfortunately this opened up a larger problem with the estimation  under estimating in some cases that seems to be difficult to track down - that's why a PR hasn't been created yet. I will push the PR shortly.",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/450815096/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
