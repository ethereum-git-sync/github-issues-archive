{
  "url": "https://api.github.com/repos/vyperlang/vyper/issues/1669",
  "repository_url": "https://api.github.com/repos/vyperlang/vyper",
  "labels_url": "https://api.github.com/repos/vyperlang/vyper/issues/1669/labels{/name}",
  "comments_url": "https://api.github.com/repos/vyperlang/vyper/issues/1669/comments",
  "events_url": "https://api.github.com/repos/vyperlang/vyper/issues/1669/events",
  "html_url": "https://github.com/vyperlang/vyper/issues/1669",
  "id": 515378324,
  "node_id": "MDU6SXNzdWU1MTUzNzgzMjQ=",
  "number": 1669,
  "title": "Perform reachability/liveness analysis on LLL variables",
  "user": {
    "login": "charles-cooper",
    "id": 3867501,
    "node_id": "MDQ6VXNlcjM4Njc1MDE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3867501?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/charles-cooper",
    "html_url": "https://github.com/charles-cooper",
    "followers_url": "https://api.github.com/users/charles-cooper/followers",
    "following_url": "https://api.github.com/users/charles-cooper/following{/other_user}",
    "gists_url": "https://api.github.com/users/charles-cooper/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/charles-cooper/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/charles-cooper/subscriptions",
    "organizations_url": "https://api.github.com/users/charles-cooper/orgs",
    "repos_url": "https://api.github.com/users/charles-cooper/repos",
    "events_url": "https://api.github.com/users/charles-cooper/events{/privacy}",
    "received_events_url": "https://api.github.com/users/charles-cooper/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 479554964,
      "node_id": "MDU6TGFiZWw0Nzk1NTQ5NjQ=",
      "url": "https://api.github.com/repos/vyperlang/vyper/labels/enhancement",
      "name": "enhancement",
      "color": "84b6eb",
      "default": true,
      "description": null
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": {
    "login": "charles-cooper",
    "id": 3867501,
    "node_id": "MDQ6VXNlcjM4Njc1MDE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3867501?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/charles-cooper",
    "html_url": "https://github.com/charles-cooper",
    "followers_url": "https://api.github.com/users/charles-cooper/followers",
    "following_url": "https://api.github.com/users/charles-cooper/following{/other_user}",
    "gists_url": "https://api.github.com/users/charles-cooper/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/charles-cooper/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/charles-cooper/subscriptions",
    "organizations_url": "https://api.github.com/users/charles-cooper/orgs",
    "repos_url": "https://api.github.com/users/charles-cooper/repos",
    "events_url": "https://api.github.com/users/charles-cooper/events{/privacy}",
    "received_events_url": "https://api.github.com/users/charles-cooper/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "charles-cooper",
      "id": 3867501,
      "node_id": "MDQ6VXNlcjM4Njc1MDE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3867501?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/charles-cooper",
      "html_url": "https://github.com/charles-cooper",
      "followers_url": "https://api.github.com/users/charles-cooper/followers",
      "following_url": "https://api.github.com/users/charles-cooper/following{/other_user}",
      "gists_url": "https://api.github.com/users/charles-cooper/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/charles-cooper/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/charles-cooper/subscriptions",
      "organizations_url": "https://api.github.com/users/charles-cooper/orgs",
      "repos_url": "https://api.github.com/users/charles-cooper/repos",
      "events_url": "https://api.github.com/users/charles-cooper/events{/privacy}",
      "received_events_url": "https://api.github.com/users/charles-cooper/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2019-10-31T12:06:27Z",
  "updated_at": "2021-12-20T22:19:49Z",
  "closed_at": null,
  "author_association": "COLLABORATOR",
  "active_lock_reason": null,
  "body": "### Version Information\r\nv0.1.0b13\r\n\r\n### What's your issue about?\r\nwhen exiting multiple with statements, the asm generator creates extra unnecessary swaps. for example,\r\n```python\r\n(with x 1 (with y 2 (add x y)))\r\n```\r\ngenerates this asm\r\n```python\r\nPUSH1 1\r\nPUSH1 2\r\nDUP1\r\nDUP3\r\nADD\r\nSWAP1\r\nPOP\r\nSWAP1\r\nPOP\r\n```\r\nobviously the most efficient version would be\r\n```python\r\nPUSH1 1\r\nPUSH1 2\r\nADD\r\n```\r\n\r\nAnother example:\r\n```python\r\n(with x 1 (add x x))\r\n```\r\ngenerates:\r\n```python\r\nPUSH1 1\r\nDUP1\r\nDUP2 # unnecessary\r\nADD\r\nSWAP1 # unnecessary\r\nPOP # unnecessary\r\n```\r\n\r\n### How can it be fixed?\r\n\r\nUnclear. Perhaps we could use the optimization in https://github.com/ethereum/vyper/issues/1306. The condition in #1306 is too broad but a narrower condition for when to apply that optimization could work. But I think the best thing to do is to reduce the number of stack items generated by 1. So if `x` is referenced 1 time, no dups needed. If `x` is referenced `N` times, only `N - 1` dups needed.",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/1669/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/vyperlang/vyper/issues/1669/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/548381239",
    "html_url": "https://github.com/vyperlang/vyper/issues/1669#issuecomment-548381239",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/1669",
    "id": 548381239,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU0ODM4MTIzOQ==",
    "user": {
      "login": "fubuloubu",
      "id": 3859395,
      "node_id": "MDQ6VXNlcjM4NTkzOTU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3859395?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fubuloubu",
      "html_url": "https://github.com/fubuloubu",
      "followers_url": "https://api.github.com/users/fubuloubu/followers",
      "following_url": "https://api.github.com/users/fubuloubu/following{/other_user}",
      "gists_url": "https://api.github.com/users/fubuloubu/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fubuloubu/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fubuloubu/subscriptions",
      "organizations_url": "https://api.github.com/users/fubuloubu/orgs",
      "repos_url": "https://api.github.com/users/fubuloubu/repos",
      "events_url": "https://api.github.com/users/fubuloubu/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fubuloubu/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-10-31T13:43:09Z",
    "updated_at": "2019-10-31T13:43:09Z",
    "author_association": "MEMBER",
    "body": "Seems like it's some sort of safety against overwrite mechanism, which I agree seems unnecessary. Probably in general LLL could be more stack-aware",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/548381239/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/548407425",
    "html_url": "https://github.com/vyperlang/vyper/issues/1669#issuecomment-548407425",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/1669",
    "id": 548407425,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU0ODQwNzQyNQ==",
    "user": {
      "login": "charles-cooper",
      "id": 3867501,
      "node_id": "MDQ6VXNlcjM4Njc1MDE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3867501?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/charles-cooper",
      "html_url": "https://github.com/charles-cooper",
      "followers_url": "https://api.github.com/users/charles-cooper/followers",
      "following_url": "https://api.github.com/users/charles-cooper/following{/other_user}",
      "gists_url": "https://api.github.com/users/charles-cooper/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/charles-cooper/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/charles-cooper/subscriptions",
      "organizations_url": "https://api.github.com/users/charles-cooper/orgs",
      "repos_url": "https://api.github.com/users/charles-cooper/repos",
      "events_url": "https://api.github.com/users/charles-cooper/events{/privacy}",
      "received_events_url": "https://api.github.com/users/charles-cooper/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-10-31T14:39:49Z",
    "updated_at": "2019-10-31T14:39:49Z",
    "author_association": "COLLABORATOR",
    "body": "@fubuloubu it's more that reachability analysis is harder. For example in the presence of a branch it's hard to know which is the last usage of a variable in a block.\r\n```python\r\n(with x 1 (seq (add 1 x) (if <cond> (mstore 0 x) (pass))))\r\n```\r\nAt the point of (add 1 x) it doesn't know whether the first branch will be hit or not. But I think the solution is just to say if x is reached in *any* branch then the whole if statement has x in it (for reachability purposes). In the branch that has x, proceed as usual, in the other branch, \"consume\" x by issuing a pop.\r\n\r\nThe other edge case I think is loops, which I haven't worked out yet.",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/548407425/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/548466348",
    "html_url": "https://github.com/vyperlang/vyper/issues/1669#issuecomment-548466348",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/1669",
    "id": 548466348,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU0ODQ2NjM0OA==",
    "user": {
      "login": "charles-cooper",
      "id": 3867501,
      "node_id": "MDQ6VXNlcjM4Njc1MDE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3867501?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/charles-cooper",
      "html_url": "https://github.com/charles-cooper",
      "followers_url": "https://api.github.com/users/charles-cooper/followers",
      "following_url": "https://api.github.com/users/charles-cooper/following{/other_user}",
      "gists_url": "https://api.github.com/users/charles-cooper/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/charles-cooper/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/charles-cooper/subscriptions",
      "organizations_url": "https://api.github.com/users/charles-cooper/orgs",
      "repos_url": "https://api.github.com/users/charles-cooper/repos",
      "events_url": "https://api.github.com/users/charles-cooper/events{/privacy}",
      "received_events_url": "https://api.github.com/users/charles-cooper/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-10-31T16:47:13Z",
    "updated_at": "2019-10-31T16:47:13Z",
    "author_association": "COLLABORATOR",
    "body": "For loops, if the loop is the last statement in the `with` block which references `x`, just always pop `x` after the loop (so a 'phantom' reference to `x` needs to be inserted after the loop).",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/548466348/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/927206404",
    "html_url": "https://github.com/vyperlang/vyper/issues/1669#issuecomment-927206404",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/1669",
    "id": 927206404,
    "node_id": "IC_kwDOBGDvrM43RAwE",
    "user": {
      "login": "charles-cooper",
      "id": 3867501,
      "node_id": "MDQ6VXNlcjM4Njc1MDE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3867501?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/charles-cooper",
      "html_url": "https://github.com/charles-cooper",
      "followers_url": "https://api.github.com/users/charles-cooper/followers",
      "following_url": "https://api.github.com/users/charles-cooper/following{/other_user}",
      "gists_url": "https://api.github.com/users/charles-cooper/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/charles-cooper/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/charles-cooper/subscriptions",
      "organizations_url": "https://api.github.com/users/charles-cooper/orgs",
      "repos_url": "https://api.github.com/users/charles-cooper/repos",
      "events_url": "https://api.github.com/users/charles-cooper/events{/privacy}",
      "received_events_url": "https://api.github.com/users/charles-cooper/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-09-26T01:03:29Z",
    "updated_at": "2021-09-26T01:03:29Z",
    "author_association": "COLLABORATOR",
    "body": "The branching problem becomes more tractable if each branch is responsible for copying any stack items it needs (instead of the outer block trying to analyze the branching).\r\n\r\nWe can annotate this with a kind of function call syntax. Instead of\r\n```\r\n(with x 1 (seq (add 1 x) (if <cond> (mstore 0 x) (pass))))\r\n```\r\nuse\r\n```\r\n(with x 1 (seq (add 1 x) (if <cond> <x,args...> (mstore 0 x) (pass))))\r\n```\r\nThe difference is that, in my previous suggestion, x is DUPed unconditionally, and in the branch without x, it gets POPped again. Now, x is DUPed conditionally as the branch is entered.",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/927206404/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
