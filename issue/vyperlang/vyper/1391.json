{
  "url": "https://api.github.com/repos/vyperlang/vyper/issues/1391",
  "repository_url": "https://api.github.com/repos/vyperlang/vyper",
  "labels_url": "https://api.github.com/repos/vyperlang/vyper/issues/1391/labels{/name}",
  "comments_url": "https://api.github.com/repos/vyperlang/vyper/issues/1391/comments",
  "events_url": "https://api.github.com/repos/vyperlang/vyper/issues/1391/events",
  "html_url": "https://github.com/vyperlang/vyper/issues/1391",
  "id": 430628009,
  "node_id": "MDU6SXNzdWU0MzA2MjgwMDk=",
  "number": 1391,
  "title": "VIP: Merkle Proof Function",
  "user": {
    "login": "fubuloubu",
    "id": 3859395,
    "node_id": "MDQ6VXNlcjM4NTkzOTU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3859395?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/fubuloubu",
    "html_url": "https://github.com/fubuloubu",
    "followers_url": "https://api.github.com/users/fubuloubu/followers",
    "following_url": "https://api.github.com/users/fubuloubu/following{/other_user}",
    "gists_url": "https://api.github.com/users/fubuloubu/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/fubuloubu/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/fubuloubu/subscriptions",
    "organizations_url": "https://api.github.com/users/fubuloubu/orgs",
    "repos_url": "https://api.github.com/users/fubuloubu/repos",
    "events_url": "https://api.github.com/users/fubuloubu/events{/privacy}",
    "received_events_url": "https://api.github.com/users/fubuloubu/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 757250644,
      "node_id": "MDU6TGFiZWw3NTcyNTA2NDQ=",
      "url": "https://api.github.com/repos/vyperlang/vyper/labels/VIP:%20Approved",
      "name": "VIP: Approved",
      "color": "98f765",
      "default": false,
      "description": "VIP Approved"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 6,
  "created_at": "2019-04-08T19:50:52Z",
  "updated_at": "2019-04-22T16:27:10Z",
  "closed_at": null,
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "## Simple Summary\r\nBuilt in function to generate and validate merkle proofs for vanilla Sparse Merkle Tree implementations.\r\n\r\n## Abstract\r\nImplement a built-in function for computing merkle roots from uncompressed merkle proofs for the sparse merkle tree (SMT) data structure, such as those commonly employed for Plasma and Plasma Cash constructions.\r\n\r\n## Motivation\r\nMerkle proofs are useful and awesome, and can be difficult to implement due to many considerations and different possible optimizations. Having a built in function similar to `ecrecover` would greatly simplify in generating these proofs in a gas-efficient way.\r\n\r\n## Specification\r\n```python\r\ndef calc_smt_root(key: uint256,            # key determines order of siblings at each height\r\n                  leaf_hash: bytes32,      # hash_function(abi.encode(leaf))\r\n                  proof: bytes32[N],       # proof array where 'N' is the SMT depth (static)\r\n                  function=hash_function,  # configures the function used\r\n             ) -> bytes32                  # Returns calculated root for above\r\n```\r\nwhere\r\n\r\n`N`:\r\n1. A `constant` corresponding to the size of the trie.\r\n2. The maximum number is 256. The minimum is 1 (although this would not make much sense in practice).\r\n3. The choice of depth determines the number of members that the trie can track.\r\n\r\n`key`:\r\n1. An integer where each bit corresponds to the decision to traverse the tree left (`bitand(key, 2**k) == 0`) or right (`bitand(key, 2**k) > 0`) at the `k`-th node in the tree.\r\n2. Must be at least `N` bits in size (`uint256` works by default, but future datatypes may be added, e.g. `uint32` for 32-depth trie)\r\n3. The LSB (least significant bit) corresponds to the leaf node decision (whether it's sibling is left or right in the tree hierarchy recursing up). This is bit 0 of `key`.\r\n4. The MSB (most significant bit) corresponds to the root node decision (whether it's sibling is left or right in the final recursion that produces the root node). This is bit `N` of `key` (the depth of the trie).\r\n\r\n`leaf_hash`:\r\n1. A `bytes32` hash corresponding to the hash of the leaf node, typically with the same hashing function that the proof generation process uses.\r\n2. `leaf` can be any arbitrary data structure. By convention, the data structure would be hashed according to it's ABI encoding, although that is not strictly required.\r\n\r\n`proof[N]`:\r\n1. A static array (of size `N`) where each array element corresponds to the sibling of the node at depth `k` in the trie.\r\n2. `proof` is in root to leaf order. Element 0 corresponds to the root level sibling (`root_hash := hash(left_node, right_node)`), and Element `N` corresponds to the leaf level sibling.\r\n3. The algorithm would thus require traversing the provided proof in reverse order.\r\n\r\nAdditional considerations:\r\n1. The function only calculates the root hash from the provided key, proof, and leaf hash. Verification is left to the end user (Typically `self.root = calc_smt_root(...)` or `assert self.root == calc_smt_root(...), \"Proof does not validate\"`)\r\n2. The user specifies which hash function to use (e.g. `calc_smt_root(..., function=hash_function)` where `hash_function` is one of `keccak256`, `sha256`, or any other built-in hash function that produces at 32-byte output)\r\n3. There is a built-in helper function for generating empty proofs (e.g. `EMPTY_BRANCH: bytes32[N] = generate_empty_proof(empty_leaf_hash, N, function=hash_function)` where)\r\n4. This specific implementation structure is already implemented in [`py-trie`](https://github.com/ethereum/py-trie/blob/master/trie/smt.py) (by the author)\r\n\r\n---\r\n\r\nAn example of using this would be\r\n```python\r\nroot_hash: bytes32\r\nN: constant(uint256) = 32\r\n\r\ndef validate_root(root_hash: bytes32, key: uint256, leaf: int128, proof: bytes32[N]):\r\n    leaf_hash: bytes32 = keccak256(leaf)\r\n    assert self.root_hash == calc_smt_root(key, leaf_hash, proof, function=keccak256)\r\n    # ... do actions!\r\n```\r\n## Backwards Compatibility\r\nNew feature\r\n\r\n## Copyright\r\nCopyright and related rights waived via [CC0](https://creativecommons.org/publicdomain/zero/1.0/)\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/1391/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/vyperlang/vyper/issues/1391/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/480982030",
    "html_url": "https://github.com/vyperlang/vyper/issues/1391#issuecomment-480982030",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/1391",
    "id": 480982030,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ4MDk4MjAzMA==",
    "user": {
      "login": "fubuloubu",
      "id": 3859395,
      "node_id": "MDQ6VXNlcjM4NTkzOTU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3859395?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fubuloubu",
      "html_url": "https://github.com/fubuloubu",
      "followers_url": "https://api.github.com/users/fubuloubu/followers",
      "following_url": "https://api.github.com/users/fubuloubu/following{/other_user}",
      "gists_url": "https://api.github.com/users/fubuloubu/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fubuloubu/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fubuloubu/subscriptions",
      "organizations_url": "https://api.github.com/users/fubuloubu/orgs",
      "repos_url": "https://api.github.com/users/fubuloubu/repos",
      "events_url": "https://api.github.com/users/fubuloubu/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fubuloubu/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-04-08T19:53:47Z",
    "updated_at": "2019-04-08T19:53:47Z",
    "author_association": "MEMBER",
    "body": "@jacqueswww @pipermerriam @davesque If you all agree with this proposed Specification, we can move this VIP to Approved and start implementation, since previous (#806) was already approved (but was under-specified)",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/480982030/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/480984907",
    "html_url": "https://github.com/vyperlang/vyper/issues/1391#issuecomment-480984907",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/1391",
    "id": 480984907,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ4MDk4NDkwNw==",
    "user": {
      "login": "jacqueswww",
      "id": 6917456,
      "node_id": "MDQ6VXNlcjY5MTc0NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6917456?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jacqueswww",
      "html_url": "https://github.com/jacqueswww",
      "followers_url": "https://api.github.com/users/jacqueswww/followers",
      "following_url": "https://api.github.com/users/jacqueswww/following{/other_user}",
      "gists_url": "https://api.github.com/users/jacqueswww/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jacqueswww/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jacqueswww/subscriptions",
      "organizations_url": "https://api.github.com/users/jacqueswww/orgs",
      "repos_url": "https://api.github.com/users/jacqueswww/repos",
      "events_url": "https://api.github.com/users/jacqueswww/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jacqueswww/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-04-08T20:01:33Z",
    "updated_at": "2019-04-08T20:01:33Z",
    "author_association": "CONTRIBUTOR",
    "body": ":+1: from me.",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/480984907/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/480996494",
    "html_url": "https://github.com/vyperlang/vyper/issues/1391#issuecomment-480996494",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/1391",
    "id": 480996494,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ4MDk5NjQ5NA==",
    "user": {
      "login": "pipermerriam",
      "id": 824194,
      "node_id": "MDQ6VXNlcjgyNDE5NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/824194?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pipermerriam",
      "html_url": "https://github.com/pipermerriam",
      "followers_url": "https://api.github.com/users/pipermerriam/followers",
      "following_url": "https://api.github.com/users/pipermerriam/following{/other_user}",
      "gists_url": "https://api.github.com/users/pipermerriam/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pipermerriam/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pipermerriam/subscriptions",
      "organizations_url": "https://api.github.com/users/pipermerriam/orgs",
      "repos_url": "https://api.github.com/users/pipermerriam/repos",
      "events_url": "https://api.github.com/users/pipermerriam/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pipermerriam/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-04-08T20:32:50Z",
    "updated_at": "2019-04-08T20:32:50Z",
    "author_association": "CONTRIBUTOR",
    "body": "I abstain,  haven't spent time understanding this and am focused elsewhere at the moment.",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/480996494/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/481003905",
    "html_url": "https://github.com/vyperlang/vyper/issues/1391#issuecomment-481003905",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/1391",
    "id": 481003905,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ4MTAwMzkwNQ==",
    "user": {
      "login": "davesque",
      "id": 791437,
      "node_id": "MDQ6VXNlcjc5MTQzNw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/791437?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/davesque",
      "html_url": "https://github.com/davesque",
      "followers_url": "https://api.github.com/users/davesque/followers",
      "following_url": "https://api.github.com/users/davesque/following{/other_user}",
      "gists_url": "https://api.github.com/users/davesque/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/davesque/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/davesque/subscriptions",
      "organizations_url": "https://api.github.com/users/davesque/orgs",
      "repos_url": "https://api.github.com/users/davesque/repos",
      "events_url": "https://api.github.com/users/davesque/events{/privacy}",
      "received_events_url": "https://api.github.com/users/davesque/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-04-08T20:53:50Z",
    "updated_at": "2019-04-08T20:53:50Z",
    "author_association": "CONTRIBUTOR",
    "body": "I'll also abstain from this for the same reasons as @pipermerriam .",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/481003905/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/485451628",
    "html_url": "https://github.com/vyperlang/vyper/issues/1391#issuecomment-485451628",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/1391",
    "id": 485451628,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ4NTQ1MTYyOA==",
    "user": {
      "login": "fubuloubu",
      "id": 3859395,
      "node_id": "MDQ6VXNlcjM4NTkzOTU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3859395?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fubuloubu",
      "html_url": "https://github.com/fubuloubu",
      "followers_url": "https://api.github.com/users/fubuloubu/followers",
      "following_url": "https://api.github.com/users/fubuloubu/following{/other_user}",
      "gists_url": "https://api.github.com/users/fubuloubu/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fubuloubu/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fubuloubu/subscriptions",
      "organizations_url": "https://api.github.com/users/fubuloubu/orgs",
      "repos_url": "https://api.github.com/users/fubuloubu/repos",
      "events_url": "https://api.github.com/users/fubuloubu/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fubuloubu/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-04-22T15:34:21Z",
    "updated_at": "2019-04-22T16:26:03Z",
    "author_association": "MEMBER",
    "body": "Notes:\r\n- [x] Analyze relevance of [2nd pre-image attack](https://en.wikipedia.org/wiki/Preimage_attack) (walkthrough [here](https://flawed.net.nz/2018/02/21/attacking-merkle-trees-with-a-second-preimage-attack/)), and add to documentation around `leaf_hash` if necessary\r\n- [x] Add mention that `key` must be at least `2**N` (not strictly `uint256`)",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/485451628/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/485466619",
    "html_url": "https://github.com/vyperlang/vyper/issues/1391#issuecomment-485466619",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/1391",
    "id": 485466619,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ4NTQ2NjYxOQ==",
    "user": {
      "login": "fubuloubu",
      "id": 3859395,
      "node_id": "MDQ6VXNlcjM4NTkzOTU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3859395?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fubuloubu",
      "html_url": "https://github.com/fubuloubu",
      "followers_url": "https://api.github.com/users/fubuloubu/followers",
      "following_url": "https://api.github.com/users/fubuloubu/following{/other_user}",
      "gists_url": "https://api.github.com/users/fubuloubu/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fubuloubu/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fubuloubu/subscriptions",
      "organizations_url": "https://api.github.com/users/fubuloubu/orgs",
      "repos_url": "https://api.github.com/users/fubuloubu/repos",
      "events_url": "https://api.github.com/users/fubuloubu/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fubuloubu/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-04-22T16:27:10Z",
    "updated_at": "2019-04-22T16:27:10Z",
    "author_association": "MEMBER",
    "body": "Not necessary to add documentation since this algorithm does not allow one to control `N` (the depth of the tree), which is a necessary condition to perpetuate this attack (since we control how many iterations are done).",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/485466619/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
