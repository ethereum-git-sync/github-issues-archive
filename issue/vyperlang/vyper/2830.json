{
  "url": "https://api.github.com/repos/vyperlang/vyper/issues/2830",
  "repository_url": "https://api.github.com/repos/vyperlang/vyper",
  "labels_url": "https://api.github.com/repos/vyperlang/vyper/issues/2830/labels{/name}",
  "comments_url": "https://api.github.com/repos/vyperlang/vyper/issues/2830/comments",
  "events_url": "https://api.github.com/repos/vyperlang/vyper/issues/2830/events",
  "html_url": "https://github.com/vyperlang/vyper/issues/2830",
  "id": 1221844329,
  "node_id": "I_kwDOBGDvrM5I091p",
  "number": 2830,
  "title": "Type of integer constant is ignored during folding of literal ops",
  "user": {
    "login": "tserg",
    "id": 8017125,
    "node_id": "MDQ6VXNlcjgwMTcxMjU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/8017125?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tserg",
    "html_url": "https://github.com/tserg",
    "followers_url": "https://api.github.com/users/tserg/followers",
    "following_url": "https://api.github.com/users/tserg/following{/other_user}",
    "gists_url": "https://api.github.com/users/tserg/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tserg/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tserg/subscriptions",
    "organizations_url": "https://api.github.com/users/tserg/orgs",
    "repos_url": "https://api.github.com/users/tserg/repos",
    "events_url": "https://api.github.com/users/tserg/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tserg/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 8,
  "created_at": "2022-04-30T14:29:18Z",
  "updated_at": "2024-01-14T17:43:04Z",
  "closed_at": "2024-01-14T17:43:04Z",
  "author_association": "COLLABORATOR",
  "active_lock_reason": null,
  "body": "### Version Information\r\n\r\n* vyper Version (output of `vyper --version`): 0.3.3\r\n* OS: Linux\r\n* Python Version (output of `python --version`): 3.8.5\r\n\r\n### What's your issue about?\r\n\r\nPlease include information like:\r\n\r\nThis contract compiles when it should throw a typechecking error.\r\n```\r\na: constant(uint16) = 200\r\n\r\n@external\r\ndef foo() -> int16:\r\n\treturn a - 201\r\n```\r\n\r\n### How can it be fixed?\r\n\r\nAnnotate the folded nodes with the original type information.\r\n",
  "closed_by": {
    "login": "charles-cooper",
    "id": 3867501,
    "node_id": "MDQ6VXNlcjM4Njc1MDE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3867501?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/charles-cooper",
    "html_url": "https://github.com/charles-cooper",
    "followers_url": "https://api.github.com/users/charles-cooper/followers",
    "following_url": "https://api.github.com/users/charles-cooper/following{/other_user}",
    "gists_url": "https://api.github.com/users/charles-cooper/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/charles-cooper/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/charles-cooper/subscriptions",
    "organizations_url": "https://api.github.com/users/charles-cooper/orgs",
    "repos_url": "https://api.github.com/users/charles-cooper/repos",
    "events_url": "https://api.github.com/users/charles-cooper/events{/privacy}",
    "received_events_url": "https://api.github.com/users/charles-cooper/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/2830/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/vyperlang/vyper/issues/2830/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1114005794",
    "html_url": "https://github.com/vyperlang/vyper/issues/2830#issuecomment-1114005794",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/2830",
    "id": 1114005794,
    "node_id": "IC_kwDOBGDvrM5CZmEi",
    "user": {
      "login": "tserg",
      "id": 8017125,
      "node_id": "MDQ6VXNlcjgwMTcxMjU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8017125?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tserg",
      "html_url": "https://github.com/tserg",
      "followers_url": "https://api.github.com/users/tserg/followers",
      "following_url": "https://api.github.com/users/tserg/following{/other_user}",
      "gists_url": "https://api.github.com/users/tserg/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tserg/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tserg/subscriptions",
      "organizations_url": "https://api.github.com/users/tserg/orgs",
      "repos_url": "https://api.github.com/users/tserg/repos",
      "events_url": "https://api.github.com/users/tserg/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tserg/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-04-30T15:22:27Z",
    "updated_at": "2022-04-30T15:22:27Z",
    "author_association": "COLLABORATOR",
    "body": "This also compiles, when it should not:\r\n```\r\na: constant(uint16) = 200\r\nb: constant(int248) = 100\r\n\r\n@external\r\ndef foo() -> int16:\r\n    return a - b\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1114005794/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1114011675",
    "html_url": "https://github.com/vyperlang/vyper/issues/2830#issuecomment-1114011675",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/2830",
    "id": 1114011675,
    "node_id": "IC_kwDOBGDvrM5CZngb",
    "user": {
      "login": "tserg",
      "id": 8017125,
      "node_id": "MDQ6VXNlcjgwMTcxMjU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8017125?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tserg",
      "html_url": "https://github.com/tserg",
      "followers_url": "https://api.github.com/users/tserg/followers",
      "following_url": "https://api.github.com/users/tserg/following{/other_user}",
      "gists_url": "https://api.github.com/users/tserg/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tserg/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tserg/subscriptions",
      "organizations_url": "https://api.github.com/users/tserg/orgs",
      "repos_url": "https://api.github.com/users/tserg/repos",
      "events_url": "https://api.github.com/users/tserg/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tserg/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-04-30T16:03:06Z",
    "updated_at": "2022-12-17T16:49:13Z",
    "author_association": "COLLABORATOR",
    "body": "This also compiles, when it should not:\r\n```\r\na: constant(uint8) = 255\r\nb: constant(uint8) = 1\r\n\r\n@external\r\ndef foo() -> uint8:\r\n\treturn a + b\r\n```\r\n\r\n[UPDATE - this now throws an `InvalidType` as of 0.3.7]",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1114011675/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1114157128",
    "html_url": "https://github.com/vyperlang/vyper/issues/2830#issuecomment-1114157128",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/2830",
    "id": 1114157128,
    "node_id": "IC_kwDOBGDvrM5CaLBI",
    "user": {
      "login": "tserg",
      "id": 8017125,
      "node_id": "MDQ6VXNlcjgwMTcxMjU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8017125?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tserg",
      "html_url": "https://github.com/tserg",
      "followers_url": "https://api.github.com/users/tserg/followers",
      "following_url": "https://api.github.com/users/tserg/following{/other_user}",
      "gists_url": "https://api.github.com/users/tserg/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tserg/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tserg/subscriptions",
      "organizations_url": "https://api.github.com/users/tserg/orgs",
      "repos_url": "https://api.github.com/users/tserg/repos",
      "events_url": "https://api.github.com/users/tserg/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tserg/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-01T07:23:02Z",
    "updated_at": "2022-05-01T07:23:02Z",
    "author_association": "COLLABORATOR",
    "body": "Another example:\r\n```\r\na: constant(int8) = 25\r\nb: constant(uint8) = 38\r\n\r\n@external\r\ndef foo() -> bool:\r\n\treturn a < b\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1114157128/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1431584479",
    "html_url": "https://github.com/vyperlang/vyper/issues/2830#issuecomment-1431584479",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/2830",
    "id": 1431584479,
    "node_id": "IC_kwDOBGDvrM5VVD7f",
    "user": {
      "login": "trocher",
      "id": 43437004,
      "node_id": "MDQ6VXNlcjQzNDM3MDA0",
      "avatar_url": "https://avatars.githubusercontent.com/u/43437004?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/trocher",
      "html_url": "https://github.com/trocher",
      "followers_url": "https://api.github.com/users/trocher/followers",
      "following_url": "https://api.github.com/users/trocher/following{/other_user}",
      "gists_url": "https://api.github.com/users/trocher/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/trocher/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/trocher/subscriptions",
      "organizations_url": "https://api.github.com/users/trocher/orgs",
      "repos_url": "https://api.github.com/users/trocher/repos",
      "events_url": "https://api.github.com/users/trocher/events{/privacy}",
      "received_events_url": "https://api.github.com/users/trocher/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-02-15T15:50:38Z",
    "updated_at": "2023-02-15T15:51:19Z",
    "author_association": "CONTRIBUTOR",
    "body": "Might be redundant with your examples, but I got this one which is compiling:\r\n```Vyper\r\na:constant(uint256)=1\r\nb:constant(uint16)=a+0\r\n``` \r\nWhere this one does not:\r\n```Vyper\r\na:constant(uint256)=1\r\nb:constant(uint16)=a\r\n``` ",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1431584479/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 1,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1432814729",
    "html_url": "https://github.com/vyperlang/vyper/issues/2830#issuecomment-1432814729",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/2830",
    "id": 1432814729,
    "node_id": "IC_kwDOBGDvrM5VZwSJ",
    "user": {
      "login": "tserg",
      "id": 8017125,
      "node_id": "MDQ6VXNlcjgwMTcxMjU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8017125?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tserg",
      "html_url": "https://github.com/tserg",
      "followers_url": "https://api.github.com/users/tserg/followers",
      "following_url": "https://api.github.com/users/tserg/following{/other_user}",
      "gists_url": "https://api.github.com/users/tserg/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tserg/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tserg/subscriptions",
      "organizations_url": "https://api.github.com/users/tserg/orgs",
      "repos_url": "https://api.github.com/users/tserg/repos",
      "events_url": "https://api.github.com/users/tserg/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tserg/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-02-16T09:54:34Z",
    "updated_at": "2023-02-16T09:54:34Z",
    "author_association": "COLLABORATOR",
    "body": "> Might be redundant with your examples, but I got this one which is compiling:\r\n> \r\n> ```vyper\r\n> a:constant(uint256)=1\r\n> b:constant(uint16)=a+0\r\n> ```\r\n> \r\n> Where this one does not:\r\n> \r\n> ```vyper\r\n> a:constant(uint256)=1\r\n> b:constant(uint16)=a\r\n> ```\r\n\r\nCool! I will add both examples as test cases to #3201.",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1432814729/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1435697797",
    "html_url": "https://github.com/vyperlang/vyper/issues/2830#issuecomment-1435697797",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/2830",
    "id": 1435697797,
    "node_id": "IC_kwDOBGDvrM5VkwKF",
    "user": {
      "login": "ToonVanHove",
      "id": 9501896,
      "node_id": "MDQ6VXNlcjk1MDE4OTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9501896?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ToonVanHove",
      "html_url": "https://github.com/ToonVanHove",
      "followers_url": "https://api.github.com/users/ToonVanHove/followers",
      "following_url": "https://api.github.com/users/ToonVanHove/following{/other_user}",
      "gists_url": "https://api.github.com/users/ToonVanHove/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ToonVanHove/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ToonVanHove/subscriptions",
      "organizations_url": "https://api.github.com/users/ToonVanHove/orgs",
      "repos_url": "https://api.github.com/users/ToonVanHove/repos",
      "events_url": "https://api.github.com/users/ToonVanHove/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ToonVanHove/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-02-18T15:15:39Z",
    "updated_at": "2023-02-18T15:15:39Z",
    "author_association": "CONTRIBUTOR",
    "body": "As a side note, this also causes some funky stuff when used as array index:\r\n\r\n```vyper\r\nCONST: constant(int128) = 1\r\n\r\n@external\r\ndef foo():\r\n    array: uint256[10] = empty(uint256[10])\r\n    a: int128 = 1\r\n\r\n    array[a + CONST] = 20\r\n```\r\n\r\nWhen compiled this results in an AssertionError that is supposed to be unreachable.",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1435697797/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1435704258",
    "html_url": "https://github.com/vyperlang/vyper/issues/2830#issuecomment-1435704258",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/2830",
    "id": 1435704258,
    "node_id": "IC_kwDOBGDvrM5VkxvC",
    "user": {
      "login": "trocher",
      "id": 43437004,
      "node_id": "MDQ6VXNlcjQzNDM3MDA0",
      "avatar_url": "https://avatars.githubusercontent.com/u/43437004?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/trocher",
      "html_url": "https://github.com/trocher",
      "followers_url": "https://api.github.com/users/trocher/followers",
      "following_url": "https://api.github.com/users/trocher/following{/other_user}",
      "gists_url": "https://api.github.com/users/trocher/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/trocher/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/trocher/subscriptions",
      "organizations_url": "https://api.github.com/users/trocher/orgs",
      "repos_url": "https://api.github.com/users/trocher/repos",
      "events_url": "https://api.github.com/users/trocher/events{/privacy}",
      "received_events_url": "https://api.github.com/users/trocher/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-02-18T15:51:09Z",
    "updated_at": "2023-02-18T15:51:09Z",
    "author_association": "CONTRIBUTOR",
    "body": "> As a side note, this also causes some funky stuff when used as array index:\r\n> \r\n> ```vyper\r\n> CONST: constant(int128) = 1\r\n> \r\n> @external\r\n> def foo():\r\n>     array: uint256[10] = empty(uint256[10])\r\n>     a: int128 = 1\r\n> \r\n>     array[a + CONST] = 20\r\n> ```\r\n> \r\n> When compiled this results in an AssertionError that is supposed to be unreachable.\r\n\r\nInteresting, for this one it seems that the typechecker allows `a + CONST` to be any integer types but when annotating `a + CONST` is given type `uint256`, it annotate `a` with its `int128` type but `visit_Constant` annotates `CONST` with the `uint256` obtained from the `subscript`'s value type and does not care about its annotation obtained from folding..",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1435704258/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1891015583",
    "html_url": "https://github.com/vyperlang/vyper/issues/2830#issuecomment-1891015583",
    "issue_url": "https://api.github.com/repos/vyperlang/vyper/issues/2830",
    "id": 1891015583,
    "node_id": "IC_kwDOBGDvrM5wtpuf",
    "user": {
      "login": "charles-cooper",
      "id": 3867501,
      "node_id": "MDQ6VXNlcjM4Njc1MDE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3867501?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/charles-cooper",
      "html_url": "https://github.com/charles-cooper",
      "followers_url": "https://api.github.com/users/charles-cooper/followers",
      "following_url": "https://api.github.com/users/charles-cooper/following{/other_user}",
      "gists_url": "https://api.github.com/users/charles-cooper/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/charles-cooper/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/charles-cooper/subscriptions",
      "organizations_url": "https://api.github.com/users/charles-cooper/orgs",
      "repos_url": "https://api.github.com/users/charles-cooper/repos",
      "events_url": "https://api.github.com/users/charles-cooper/events{/privacy}",
      "received_events_url": "https://api.github.com/users/charles-cooper/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2024-01-14T17:43:04Z",
    "updated_at": "2024-01-14T17:43:04Z",
    "author_association": "MEMBER",
    "body": "i think this was solved during recent refactoring of constant folding (see https://github.com/vyperlang/vyper/pull/3669 and https://github.com/vyperlang/vyper/pull/3719). @ToonVanHove @trocher please reopen if there are still any issues.",
    "reactions": {
      "url": "https://api.github.com/repos/vyperlang/vyper/issues/comments/1891015583/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
