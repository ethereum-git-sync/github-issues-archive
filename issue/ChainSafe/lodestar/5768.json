{
  "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5768",
  "repository_url": "https://api.github.com/repos/ChainSafe/lodestar",
  "labels_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5768/labels{/name}",
  "comments_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5768/comments",
  "events_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5768/events",
  "html_url": "https://github.com/ChainSafe/lodestar/issues/5768",
  "id": 1808127811,
  "node_id": "I_kwDOCD5_Gc5rxddD",
  "number": 5768,
  "title": "Metrics server is listening on IPv6 interface and not shutting down",
  "user": {
    "login": "nflaig",
    "id": 38436224,
    "node_id": "MDQ6VXNlcjM4NDM2MjI0",
    "avatar_url": "https://avatars.githubusercontent.com/u/38436224?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/nflaig",
    "html_url": "https://github.com/nflaig",
    "followers_url": "https://api.github.com/users/nflaig/followers",
    "following_url": "https://api.github.com/users/nflaig/following{/other_user}",
    "gists_url": "https://api.github.com/users/nflaig/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/nflaig/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/nflaig/subscriptions",
    "organizations_url": "https://api.github.com/users/nflaig/orgs",
    "repos_url": "https://api.github.com/users/nflaig/repos",
    "events_url": "https://api.github.com/users/nflaig/events{/privacy}",
    "received_events_url": "https://api.github.com/users/nflaig/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 5670219610,
      "node_id": "LA_kwDOCD5_Gc8AAAABUfivWg",
      "url": "https://api.github.com/repos/ChainSafe/lodestar/labels/meta-bug",
      "name": "meta-bug",
      "color": "E79553",
      "default": false,
      "description": "Issues that identify a bug and require a fix."
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2023-07-17T16:25:55Z",
  "updated_at": "2023-07-18T19:23:42Z",
  "closed_at": "2023-07-18T18:42:14Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "### Describe the bug\r\n\r\nIt looks like Lodestar beacon node metrics server starts listening on IPv6 interface.\r\n\r\n```sh\r\ndevops@Ubuntu-2204-jammy-amd64-base:~/goerli/lodestar$ lsof -i :8008\r\nCOMMAND     PID   USER   FD   TYPE    DEVICE SIZE/OFF NODE NAME\r\nnode    2301537 devops  102u  IPv6 973623086      0t0  TCP localhost.localdomain:8008->localhost.localdomain:56578 (ESTABLISHED)\r\nnode    2301537 devops  128u  IPv6 973428666      0t0  TCP *:8008 (LISTEN)\r\n```\r\n\r\n```sh\r\ndevops@Ubuntu-2204-jammy-amd64-base:~/goerli/lodestar$ sudo netstat -ltnp | grep -w ':8008'\r\ntcp6       0      0 :::8008                 :::*                    LISTEN      2301537/node\r\n```\r\n\r\nIt is also no longer possible to shut down the process, even force closing does not help. Had to use `kill -9` to close process as just `kill` didn't do anything.\r\n\r\n```\r\nJul-17 17:08:54.000[]                 info: Synced - slot: 6092144 - head: 0xe00e…5e94 - exec-block: valid(9361504 0x8772…) - finalized: 0x7710…765c:190377 - peers: 51\r\n^CJul-17 17:09:01.307[]                 info: Stopping gracefully, use Ctrl+C again to force process exit\r\nJul-17 17:09:06.176[]                 info: Synced - slot: 6092145 - head: (slot -1) 0xe00e…5e94 - exec-block: valid(9361504 0x8772…) - finalized: 0x7710…765c:190377 - peers: 50\r\n^CJul-17 17:09:10.028[]                 info: Forcing process exit\r\n^C^C^C^C^C./lodestar: line 7: 2357120 Killed                  node --trace-deprecation --max-old-space-size=4096 ./packages/cli/bin/lodestar.js \"$@\r\n```\r\n\r\n### Expected behavior\r\n\r\nMetrics server should not be listening on IPv6 and beacon node should cleanly shut down when receiving SIGTERM / SIGINT.\r\n\r\n### Steps to reproduce\r\n\r\nRunning with default network and listen options, metrics are enabled\r\n\r\n```sh\r\n./lodestar beacon \\\r\n    --dataDir /home/devops/goerli/data/beacon \\\r\n    --metrics \\\r\n    --execution.urls http://localhost:8551 \\\r\n    --jwt-secret /home/devops/goerli/data/jwtsecret \\\r\n    --logLevel info \\\r\n    --network goerli \\\r\n    --checkpointSyncUrl \"https://beaconstate-goerli.chainsafe.io/\"\r\n```\r\n\r\nThe metrics server listen on IPv6 happens consistently but I am not able to reproduce the process not shutting down all the time.\r\n\r\n### Additional context\r\n\r\nRelated PR that likely introduced problem\r\n- https://github.com/ChainSafe/lodestar/pull/5758\r\n\r\n\r\n### Operating system\r\n\r\nLinux\r\n\r\n### Lodestar version or commit hash\r\n\r\nec8153153c83d082cb89fca682d502e709e3f415",
  "closed_by": {
    "login": "nflaig",
    "id": 38436224,
    "node_id": "MDQ6VXNlcjM4NDM2MjI0",
    "avatar_url": "https://avatars.githubusercontent.com/u/38436224?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/nflaig",
    "html_url": "https://github.com/nflaig",
    "followers_url": "https://api.github.com/users/nflaig/followers",
    "following_url": "https://api.github.com/users/nflaig/following{/other_user}",
    "gists_url": "https://api.github.com/users/nflaig/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/nflaig/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/nflaig/subscriptions",
    "organizations_url": "https://api.github.com/users/nflaig/orgs",
    "repos_url": "https://api.github.com/users/nflaig/repos",
    "events_url": "https://api.github.com/users/nflaig/events{/privacy}",
    "received_events_url": "https://api.github.com/users/nflaig/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5768/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5768/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1640530231",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/5768#issuecomment-1640530231",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5768",
    "id": 1640530231,
    "node_id": "IC_kwDOCD5_Gc5hyIE3",
    "user": {
      "login": "nflaig",
      "id": 38436224,
      "node_id": "MDQ6VXNlcjM4NDM2MjI0",
      "avatar_url": "https://avatars.githubusercontent.com/u/38436224?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nflaig",
      "html_url": "https://github.com/nflaig",
      "followers_url": "https://api.github.com/users/nflaig/followers",
      "following_url": "https://api.github.com/users/nflaig/following{/other_user}",
      "gists_url": "https://api.github.com/users/nflaig/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nflaig/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nflaig/subscriptions",
      "organizations_url": "https://api.github.com/users/nflaig/orgs",
      "repos_url": "https://api.github.com/users/nflaig/repos",
      "events_url": "https://api.github.com/users/nflaig/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nflaig/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-18T16:12:02Z",
    "updated_at": "2023-07-18T16:12:02Z",
    "author_association": "MEMBER",
    "body": "@wemeetagain Looks like the metrics server listening on ipv6 is unrelated, also happens when checking out previous commit e3eb0557ee9c70d08e50c4d4d2c3265ab5b96815.\r\n\r\nStill trying to find out what was going on with the process hanging, I've never seen this before that not even force closing helps.\r\n\r\nMaybe it was just an issue on my server, although it happened multiple times. I will try to figure out if this really just started to happen after merging IPv6 changes.\r\n\r\nPossibly a worker thread which is not shut down correctly? That could keep the main process alive but not receive any process signals which could explain why `process.exit` and `kill` did nothing.",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1640530231/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1640756461",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/5768#issuecomment-1640756461",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5768",
    "id": 1640756461,
    "node_id": "IC_kwDOCD5_Gc5hy_Tt",
    "user": {
      "login": "nflaig",
      "id": 38436224,
      "node_id": "MDQ6VXNlcjM4NDM2MjI0",
      "avatar_url": "https://avatars.githubusercontent.com/u/38436224?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nflaig",
      "html_url": "https://github.com/nflaig",
      "followers_url": "https://api.github.com/users/nflaig/followers",
      "following_url": "https://api.github.com/users/nflaig/following{/other_user}",
      "gists_url": "https://api.github.com/users/nflaig/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nflaig/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nflaig/subscriptions",
      "organizations_url": "https://api.github.com/users/nflaig/orgs",
      "repos_url": "https://api.github.com/users/nflaig/repos",
      "events_url": "https://api.github.com/users/nflaig/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nflaig/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-18T18:42:14Z",
    "updated_at": "2023-07-18T18:42:14Z",
    "author_association": "MEMBER",
    "body": "@wemeetagain as you suspected in standup this is unrelated to IPv6 changes, which makes sense, would be hard to explain this based on the IPv6 changes done.\r\n\r\nThat the metrics server is still running was just a coincidence because the shutdown sequence was not fully executed due to https://github.com/ChainSafe/lodestar/issues/5775 and I did some more testing with `--network.useWorker true` over the weekend.\r\n\r\n- Closing for https://github.com/ChainSafe/lodestar/issues/5775",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1640756461/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1640866352",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/5768#issuecomment-1640866352",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5768",
    "id": 1640866352,
    "node_id": "IC_kwDOCD5_Gc5hzaIw",
    "user": {
      "login": "nflaig",
      "id": 38436224,
      "node_id": "MDQ6VXNlcjM4NDM2MjI0",
      "avatar_url": "https://avatars.githubusercontent.com/u/38436224?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nflaig",
      "html_url": "https://github.com/nflaig",
      "followers_url": "https://api.github.com/users/nflaig/followers",
      "following_url": "https://api.github.com/users/nflaig/following{/other_user}",
      "gists_url": "https://api.github.com/users/nflaig/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nflaig/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nflaig/subscriptions",
      "organizations_url": "https://api.github.com/users/nflaig/orgs",
      "repos_url": "https://api.github.com/users/nflaig/repos",
      "events_url": "https://api.github.com/users/nflaig/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nflaig/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-18T19:23:42Z",
    "updated_at": "2023-07-18T19:23:42Z",
    "author_association": "MEMBER",
    "body": "Just leaving some more context here:\r\n\r\nIt looks like by default if no address is provided the metrics server is listening on IPv6 interface (at least on my server)\r\n\r\n```\r\ndevops@Ubuntu-2204-jammy-amd64-base:~/goerli$ lsof -i :8008\r\nCOMMAND     PID   USER   FD   TYPE    DEVICE SIZE/OFF NODE NAME\r\nnode    3980719 devops  112u  IPv6 987155205      0t0  TCP localhost.localdomain:8008->localhost.localdomain:39660 (CLOSE_WAIT)\r\nnode    3980719 devops  128u  IPv6 987130593      0t0  TCP *:8008 (LISTEN)\r\n```\r\n\r\nWhereas for the REST API server where I set `--rest.address \"0.0.0.0\"` is listening on IPv4 as expected\r\n\r\n```\r\ndevops@Ubuntu-2204-jammy-amd64-base:~/goerli$ lsof -i :9596\r\nCOMMAND     PID   USER   FD   TYPE    DEVICE SIZE/OFF NODE NAME\r\nnode    2388951 devops   26u  IPv4 987129616      0t0  TCP localhost.localdomain:47462->localhost.localdomain:9596 (ESTABLISHED)\r\nnode    3980719 devops  113u  IPv4 987155117      0t0  TCP Ubuntu-2204-jammy-amd64-base:9596->172.26.0.4:39304 (CLOSE_WAIT)\r\nnode    3980719 devops  118u  IPv4 987139371      0t0  TCP Ubuntu-2204-jammy-amd64-base:9596->172.27.0.2:53520 (CLOSE_WAIT)\r\nnode    3980719 devops  129u  IPv4 987137350      0t0  TCP *:9596 (LISTEN)\r\n```\r\n\r\nThis is a bit surprising to me as the default host/address should be `127.0.0.1`. The metrics server is also listening on a network interface which is externally reachable.\r\n\r\nWe should only expose server externally if listen address is explicitly set to something like `0.0.0.0`.",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1640866352/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
