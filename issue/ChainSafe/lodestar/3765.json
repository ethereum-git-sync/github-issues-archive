{
  "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3765",
  "repository_url": "https://api.github.com/repos/ChainSafe/lodestar",
  "labels_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3765/labels{/name}",
  "comments_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3765/comments",
  "events_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3765/events",
  "html_url": "https://github.com/ChainSafe/lodestar/issues/3765",
  "id": 1139656893,
  "node_id": "I_kwDOCD5_Gc5D7ci9",
  "number": 3765,
  "title": "Investigate BackfillSync hetzner-test0 issue of \"Re-doing\" the previous backfill from DB instead from backfilledRanges",
  "user": {
    "login": "g11tech",
    "id": 76567250,
    "node_id": "MDQ6VXNlcjc2NTY3MjUw",
    "avatar_url": "https://avatars.githubusercontent.com/u/76567250?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/g11tech",
    "html_url": "https://github.com/g11tech",
    "followers_url": "https://api.github.com/users/g11tech/followers",
    "following_url": "https://api.github.com/users/g11tech/following{/other_user}",
    "gists_url": "https://api.github.com/users/g11tech/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/g11tech/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/g11tech/subscriptions",
    "organizations_url": "https://api.github.com/users/g11tech/orgs",
    "repos_url": "https://api.github.com/users/g11tech/repos",
    "events_url": "https://api.github.com/users/g11tech/events{/privacy}",
    "received_events_url": "https://api.github.com/users/g11tech/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "g11tech",
    "id": 76567250,
    "node_id": "MDQ6VXNlcjc2NTY3MjUw",
    "avatar_url": "https://avatars.githubusercontent.com/u/76567250?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/g11tech",
    "html_url": "https://github.com/g11tech",
    "followers_url": "https://api.github.com/users/g11tech/followers",
    "following_url": "https://api.github.com/users/g11tech/following{/other_user}",
    "gists_url": "https://api.github.com/users/g11tech/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/g11tech/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/g11tech/subscriptions",
    "organizations_url": "https://api.github.com/users/g11tech/orgs",
    "repos_url": "https://api.github.com/users/g11tech/repos",
    "events_url": "https://api.github.com/users/g11tech/events{/privacy}",
    "received_events_url": "https://api.github.com/users/g11tech/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "g11tech",
      "id": 76567250,
      "node_id": "MDQ6VXNlcjc2NTY3MjUw",
      "avatar_url": "https://avatars.githubusercontent.com/u/76567250?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/g11tech",
      "html_url": "https://github.com/g11tech",
      "followers_url": "https://api.github.com/users/g11tech/followers",
      "following_url": "https://api.github.com/users/g11tech/following{/other_user}",
      "gists_url": "https://api.github.com/users/g11tech/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/g11tech/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/g11tech/subscriptions",
      "organizations_url": "https://api.github.com/users/g11tech/orgs",
      "repos_url": "https://api.github.com/users/g11tech/repos",
      "events_url": "https://api.github.com/users/g11tech/events{/privacy}",
      "received_events_url": "https://api.github.com/users/g11tech/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2022-02-16T07:54:24Z",
  "updated_at": "2022-02-28T05:58:15Z",
  "closed_at": "2022-02-28T05:58:14Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "@dapplion pointed out an issue that hetzner nodes were facing, on restart the backfill sync started backfilling all previous backfilled blocks from db instead of it using a backfilled Range to skip back. \r\nThis caused a huge disk resource consumption paired with hashTreeRoot severly degrading the performance of the node. A temp fix was send to disable backfill on default.\r\n\r\nThis issue is to investigate why the backfill range was not found by analyzing the logs from the affected machines.",
  "closed_by": {
    "login": "g11tech",
    "id": 76567250,
    "node_id": "MDQ6VXNlcjc2NTY3MjUw",
    "avatar_url": "https://avatars.githubusercontent.com/u/76567250?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/g11tech",
    "html_url": "https://github.com/g11tech",
    "followers_url": "https://api.github.com/users/g11tech/followers",
    "following_url": "https://api.github.com/users/g11tech/following{/other_user}",
    "gists_url": "https://api.github.com/users/g11tech/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/g11tech/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/g11tech/subscriptions",
    "organizations_url": "https://api.github.com/users/g11tech/orgs",
    "repos_url": "https://api.github.com/users/g11tech/repos",
    "events_url": "https://api.github.com/users/g11tech/events{/privacy}",
    "received_events_url": "https://api.github.com/users/g11tech/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3765/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3765/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1041217055",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/3765#issuecomment-1041217055",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3765",
    "id": 1041217055,
    "node_id": "IC_kwDOCD5_Gc4-D7Yf",
    "user": {
      "login": "g11tech",
      "id": 76567250,
      "node_id": "MDQ6VXNlcjc2NTY3MjUw",
      "avatar_url": "https://avatars.githubusercontent.com/u/76567250?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/g11tech",
      "html_url": "https://github.com/g11tech",
      "followers_url": "https://api.github.com/users/g11tech/followers",
      "following_url": "https://api.github.com/users/g11tech/following{/other_user}",
      "gists_url": "https://api.github.com/users/g11tech/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/g11tech/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/g11tech/subscriptions",
      "organizations_url": "https://api.github.com/users/g11tech/orgs",
      "repos_url": "https://api.github.com/users/g11tech/repos",
      "events_url": "https://api.github.com/users/g11tech/events{/privacy}",
      "received_events_url": "https://api.github.com/users/g11tech/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-02-16T08:03:55Z",
    "updated_at": "2022-02-16T08:04:11Z",
    "author_association": "CONTRIBUTOR",
    "body": "## Feb 13 Restart\r\n```\r\ndevops@hetzner-test0:~/beacon$ cat beacon-2022-02-13.log | grep \"SYNC\" | grep -vE \"NETWORK\" | grep -vE \"Sync peer\" | grep -vE \"Batch\" | grep -vE \"SyncCha\" | grep -vE \"syncCha\" | grep -vE Extrac\r\nFeb-13 02:05:23.831 [SYNC]             info: BackfillSync - initializing from Checkpoint root=0x0693d9e482349e2db07cdbd16e0c4de9558612e50cc586deb129ea2ca530bcaf, epoch=73461, slot=2350750\r\nFeb-13 02:05:24.892 [SYNC]          verbose: BackfillSync - read 64 blocks from DB till  slot=2350672\r\nFeb-13 02:05:24.892 [SYNC]          verbose: Validated current prevFinalizedCheckpointBlock root=0x4692d80d8e0cde342d45795d2e2c2f42fffefb7a1668c7b0a02ce72d29450f8f, slot=2350672\r\nFeb-13 02:05:24.933 [SYNC]             info: BackfillSync - wsCheckpoint validated! root=0x0693d9e482349e2db07cdbd16e0c4de9558612e50cc586deb129ea2ca530bcaf, epoch=73461\r\nFeb-13 02:05:24.935 [SYNC]            debug: updated the backfill range from=2350752 till=2350672\r\nFeb-13 02:05:24.945 [SYNC]            debug: found a sequence going back to 2308000 before the previous finalized or wsCheckpoint slot=2350671\r\nFeb-13 02:05:24.955 [SYNC]          verbose: Validated current prevFinalizedCheckpointBlock root=0x08cabeb33012e3e96c65661eb480b0ced44f01e960479d6ed10ce83ae64f229d, slot=2350671\r\nFeb-13 02:05:24.956 [SYNC]          verbose: backfillSync - found previous backfilled sequence in db, jumping back to slot=2308000\r\nFeb-13 02:05:24.991 [SYNC]            debug: found a sequence going back to 0 before the previous finalized or wsCheckpoint slot=2307998\r\nFeb-13 02:05:24.997 [SYNC]          verbose: Validated current prevFinalizedCheckpointBlock root=0x2d40947d6ed4bc7c93eae7b1819141b32152c71bd356498fdfa1a53611828b9b, slot=2307998\r\nFeb-13 02:05:24.999 [SYNC]          verbose: backfillSync - found previous backfilled sequence in db, jumping back to slot=0\r\nFeb-13 02:05:25.001 [SYNC]          verbose: BackfillSync - successfully synced to genesis.\r\nFeb-13 02:05:25.002 [SYNC]             info: BackfillSync completed oldestSlotSynced=0\r\nFeb-13 02:11:12.653 [SYNC]             info: Subscribed gossip core topics\r\n\r\n```\r\n### Observations\r\nThis seems like a normal backfill run, syncing few blocks in db to find a backfill range (backfilled ranges in forward sync are updated only when finalized state is also dumped, so can be a bit behind last finalized state in db), and jumping back to find another backfill range all the way to 0, will backfill finishing",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1041217055/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1041218705",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/3765#issuecomment-1041218705",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3765",
    "id": 1041218705,
    "node_id": "IC_kwDOCD5_Gc4-D7yR",
    "user": {
      "login": "g11tech",
      "id": 76567250,
      "node_id": "MDQ6VXNlcjc2NTY3MjUw",
      "avatar_url": "https://avatars.githubusercontent.com/u/76567250?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/g11tech",
      "html_url": "https://github.com/g11tech",
      "followers_url": "https://api.github.com/users/g11tech/followers",
      "following_url": "https://api.github.com/users/g11tech/following{/other_user}",
      "gists_url": "https://api.github.com/users/g11tech/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/g11tech/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/g11tech/subscriptions",
      "organizations_url": "https://api.github.com/users/g11tech/orgs",
      "repos_url": "https://api.github.com/users/g11tech/repos",
      "events_url": "https://api.github.com/users/g11tech/events{/privacy}",
      "received_events_url": "https://api.github.com/users/g11tech/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-02-16T08:06:01Z",
    "updated_at": "2022-02-16T08:06:01Z",
    "author_association": "CONTRIBUTOR",
    "body": "## Feb 14 logs\r\n```\r\ndevops@hetzner-test0:~/beacon$ cat beacon-2022-02-14.log | grep \"SYNC\" | grep -vE \"NETWORK\" | grep -vE \"Sync peer\" | grep -vE \"Batch\" | grep -vE \"SyncCha\" | grep -vE \"syncCha\" | grep -vE Extrac\r\ndevops@hetzner-test0:~/beacon$ \r\n```\r\n\r\n### Observations:\r\nNo backfill run on feb 14",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1041218705/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1041282289",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/3765#issuecomment-1041282289",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3765",
    "id": 1041282289,
    "node_id": "IC_kwDOCD5_Gc4-ELTx",
    "user": {
      "login": "g11tech",
      "id": 76567250,
      "node_id": "MDQ6VXNlcjc2NTY3MjUw",
      "avatar_url": "https://avatars.githubusercontent.com/u/76567250?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/g11tech",
      "html_url": "https://github.com/g11tech",
      "followers_url": "https://api.github.com/users/g11tech/followers",
      "following_url": "https://api.github.com/users/g11tech/following{/other_user}",
      "gists_url": "https://api.github.com/users/g11tech/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/g11tech/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/g11tech/subscriptions",
      "organizations_url": "https://api.github.com/users/g11tech/orgs",
      "repos_url": "https://api.github.com/users/g11tech/repos",
      "events_url": "https://api.github.com/users/g11tech/events{/privacy}",
      "received_events_url": "https://api.github.com/users/g11tech/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-02-16T09:23:48Z",
    "updated_at": "2022-02-16T09:23:48Z",
    "author_association": "CONTRIBUTOR",
    "body": "## Feb 15 logs\r\nRunning a similar grep command to filter backfill logs showed some write failure:\r\n```\r\ndevops@hetzner-test0:~/beacon$ cat beacon-2022-02-15.log | grep \"SYNC\" | grep -vE \"NETWORK|Sync peer|Batch|SyncCha|syncCha|Extrac|unknown|publish|SYNC_COMMI|Unknown\" \r\nFeb-15 01:52:08.387 [SYNC]            error: uncaughtException: write ENOBUFS\r\nFeb-15 01:52:08.389 [SYNC]            error: uncaughtException: write ENOBUFS\r\n```\r\n\r\ngrepping the logs around the point in time `Feb-15 01:52:08` resulted into the almost all modules reporting the log: \r\n```\r\ndevops@hetzner-test0:~$ cat beacon/beacon-2022-02-15.log | grep \"Feb-15 01:52:08\" | grep -vE \"gossip|ssz_snappy\"\r\nFeb-15 01:52:08.370 []                error: uncaughtException: write ENOBUFS\r\nFeb-15 01:52:08.383 [CHAIN]           error: uncaughtException: write ENOBUFS\r\nFeb-15 01:52:08.384 [ETH1]            error: uncaughtException: write ENOBUFS\r\nFeb-15 01:52:08.386 [NETWORK]         error: uncaughtException: write ENOBUFS\r\nFeb-15 01:52:08.387 [SYNC]            error: uncaughtException: write ENOBUFS\r\nFeb-15 01:52:08.390 [API]             error: uncaughtException: write ENOBUFS\r\nFeb-15 01:52:08.394 [API]             error: uncaughtException: write ENOBUFS\r\nFeb-15 01:52:08.424 [NETWORK]       verbose: peer connected peer=16...KEHYy6, direction=outbound, status=open\r\nFeb-15 01:52:08.427 [NETWORK]         debug: Dialed discovered peer peer=16...KEHYy6\r\nFeb-15 01:52:08.372 [DB]              error: uncaughtException: write ENOBUFS\r\nFeb-15 01:52:08.389 [SYNC]            error: uncaughtException: write ENOBUFS\r\nFeb-15 01:52:08.392 [METRICS]         error: uncaughtException: write ENOBUFS\r\n```\r\nWidening the grep log to that minute `Feb-15 01:52` resulted into lots of `CIRCULAR_REFERENCE` dump, log too big to dump here.\r\n\r\n\r\nObservations\r\nThere seems to be some write issue, mostly probably caused by dumping of huge CIRCULAR_REFERENCE logs, that might have corrupted the DB.\r\n\r\n*PS: Further analysis ongoing as the grep on the log file is taking too long.*",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1041282289/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1041500809",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/3765#issuecomment-1041500809",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3765",
    "id": 1041500809,
    "node_id": "IC_kwDOCD5_Gc4-FAqJ",
    "user": {
      "login": "g11tech",
      "id": 76567250,
      "node_id": "MDQ6VXNlcjc2NTY3MjUw",
      "avatar_url": "https://avatars.githubusercontent.com/u/76567250?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/g11tech",
      "html_url": "https://github.com/g11tech",
      "followers_url": "https://api.github.com/users/g11tech/followers",
      "following_url": "https://api.github.com/users/g11tech/following{/other_user}",
      "gists_url": "https://api.github.com/users/g11tech/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/g11tech/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/g11tech/subscriptions",
      "organizations_url": "https://api.github.com/users/g11tech/orgs",
      "repos_url": "https://api.github.com/users/g11tech/repos",
      "events_url": "https://api.github.com/users/g11tech/events{/privacy}",
      "received_events_url": "https://api.github.com/users/g11tech/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-02-16T13:38:06Z",
    "updated_at": "2022-02-18T13:30:40Z",
    "author_association": "CONTRIBUTOR",
    "body": "### DISCOVERED ISSUE:\r\nOn hetzner-test1\r\n#### Successful backfill on 12 Feb\r\n```\r\ndevops@hetzner-test1:~/beacon$ cat beacon-2022-02-12.log | grep \"SYNC\" | grep -vE \"NETWORK|peer|Batch|SyncCha|syncCha|Extrac|unknown|publish|SYNC_COMMI|Unknown|Validated|from DB|updated the backf\" ;cat beacon-2022-02-12.log | grep \"till=0\"\r\nFeb-12 08:35:44.865 [SYNC]          verbose: BackfillSync - successfully synced to genesis.\r\nFeb-12 08:35:44.865 [SYNC]             info: BackfillSync completed oldestSlotSynced=0\r\nFeb-12 08:35:44.865 [SYNC]            debug: updated the backfill range from=2342432 till=0\r\n``` \r\n#### on Feb 13 couldn't pick the previous backfill range from=2342432 till=0, because it seemed to have jumped 1 slot earlier\r\n```\r\ndevops@hetzner-test1:~/beacon$ cat beacon-2022-02-13.log | grep \"SYNC\" | grep -vE \"NETWORK|peer|Batch|SyncCha|syncCha|Extrac|unknown|publish|SYNC_COMMI|Unknown|Validated|from DB|updated the backf\" ;cat beacon-2022-02-13.log | grep \"till=0\"\r\nFeb-13 04:07:19.304 [SYNC]             info: BackfillSync - initializing from Checkpoint root=0x37fcd60e33337b35e29646d66edc952ef3e357b84752c5f07da864c2aa0dc29b, epoch=73470, slot=2351040\r\nFeb-13 04:07:20.219 [SYNC]             info: BackfillSync - wsCheckpoint validated! root=0x37fcd60e33337b35e29646d66edc952ef3e357b84752c5f07da864c2aa0dc29b, epoch=73470\r\nFeb-13 04:07:20.224 [SYNC]            debug: found a sequence going back to 2342431 before the previous finalized or wsCheckpoint slot=2350956\r\nFeb-13 04:07:20.229 [SYNC]          verbose: backfillSync - found previous backfilled sequence in db, jumping back to slot=2342431\r\nFeb-13 04:08:13.681 [SYNC]             info: Subscribed gossip core topics\r\nFeb-13 13:58:45.864 [SYNC]          verbose: BackfillSync - successfully synced to genesis.\r\nFeb-13 13:58:45.864 [SYNC]             info: BackfillSync completed oldestSlotSynced=0\r\nFeb-13 13:58:45.864 [SYNC]            debug: updated the backfill range from=2351040 till=0\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1041500809/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
