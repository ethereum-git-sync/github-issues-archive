{
  "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/1424",
  "repository_url": "https://api.github.com/repos/ChainSafe/lodestar",
  "labels_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/1424/labels{/name}",
  "comments_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/1424/comments",
  "events_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/1424/events",
  "html_url": "https://github.com/ChainSafe/lodestar/issues/1424",
  "id": 682427088,
  "node_id": "MDU6SXNzdWU2ODI0MjcwODg=",
  "number": 1424,
  "title": "Medalla Initial Sync: Heap out of memory",
  "user": {
    "login": "tuyennhv",
    "id": 10568965,
    "node_id": "MDQ6VXNlcjEwNTY4OTY1",
    "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tuyennhv",
    "html_url": "https://github.com/tuyennhv",
    "followers_url": "https://api.github.com/users/tuyennhv/followers",
    "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
    "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
    "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
    "repos_url": "https://api.github.com/users/tuyennhv/repos",
    "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2020-08-20T05:30:49Z",
  "updated_at": "2020-08-28T16:03:24Z",
  "closed_at": "2020-08-28T16:03:24Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "**Describe the bug**\r\nInitial sync stopped with the following error\r\n```\r\n2020-08-20 12:26:39  [SYNC]             info: Sync progress - currentEpoch=3185, targetEpoch=3424, speed=30.3 slots/s, estimateTillComplete=0.1 hours\r\n\r\n<--- Last few GCs --->\r\n\r\n[59090:0x10280c000]  7029556 ms: Mark-sweep 8085.4 (8224.8) -> 8070.4 (8225.3) MB, 11350.9 / 2.0 ms  (average mu = 0.070, current mu = 0.006) allocation failure scavenge might not succeed\r\n[59090:0x10280c000]  7036114 ms: Mark-sweep 8086.0 (8225.3) -> 8071.1 (8225.8) MB, 6503.3 / 1.8 ms  (average mu = 0.044, current mu = 0.008) allocation failure scavenge might not succeed\r\n\r\n\r\n<--- JS stacktrace --->\r\n\r\n==== JS stack trace =========================================\r\n\r\n    0: ExitFrame [pc: 0x1009288f9]\r\nSecurity context: 0x04e4189c0919 <JSObject>\r\n    1: entries [0x4e4189c1631](this=0x04e4189c09b1 <JSFunction Object (sfi = 0x4e4d6887b49)>,0x04e42bf96f01 <Object map = 0x4e4e8cd69d9>)\r\n    2: readOnlyEntries [0x4e459315399] [/Users/tuyennguyen/Projects/workshop/lodestar/node_modules/@chainsafe/ssz/lib/backings/tree/container.js:~208] [pc=0x1268653a9e8e](this=0x04e42bf96e91 <TreeHandler map = 0x4e4926e6609>,...\r\n\r\nFATAL ERROR: Ineffective mark-compacts near heap limit Allocation failed - JavaScript heap out of memory\r\n\r\nWriting Node.js report to file: report.20200820.122735.59090.0.001.json\r\nNode.js report completed\r\n 1: 0x100078c35 node::Abort() [/Users/tuyennguyen/.nvm/versions/node/v12.10.0/bin/node]\r\n 2: 0x100078db9 node::OnFatalError(char const*, char const*) [/Users/tuyennguyen/.nvm/versions/node/v12.10.0/bin/node]\r\n 3: 0x10016e8d7 v8::Utils::ReportOOMFailure(v8::internal::Isolate*, char const*, bool) [/Users/tuyennguyen/.nvm/versions/node/v12.10.0/bin/node]\r\n 4: 0x10016e873 v8::internal::V8::FatalProcessOutOfMemory(v8::internal::Isolate*, char const*, bool) [/Users/tuyennguyen/.nvm/versions/node/v12.10.0/bin/node]\r\n 5: 0x1002f2605 v8::internal::Heap::FatalProcessOutOfMemory(char const*) [/Users/tuyennguyen/.nvm/versions/node/v12.10.0/bin/node]\r\n 6: 0x1002f3d2d v8::internal::Heap::RecomputeLimits(v8::internal::GarbageCollector) [/Users/tuyennguyen/.nvm/versions/node/v12.10.0/bin/node]\r\n 7: 0x1002f0ae6 v8::internal::Heap::PerformGarbageCollection(v8::internal::GarbageCollector, v8::GCCallbackFlags) [/Users/tuyennguyen/.nvm/versions/node/v12.10.0/bin/node]\r\n 8: 0x1002eea3c v8::internal::Heap::CollectGarbage(v8::internal::AllocationSpace, v8::internal::GarbageCollectionReason, v8::GCCallbackFlags) [/Users/tuyennguyen/.nvm/versions/node/v12.10.0/bin/node]\r\n 9: 0x1002fa114 v8::internal::Heap::AllocateRawWithLightRetry(int, v8::internal::AllocationType, v8::internal::AllocationAlignment) [/Users/tuyennguyen/.nvm/versions/node/v12.10.0/bin/node]\r\n10: 0x1002fa18f v8::internal::Heap::AllocateRawWithRetryOrFail(int, v8::internal::AllocationType, v8::internal::AllocationAlignment) [/Users/tuyennguyen/.nvm/versions/node/v12.10.0/bin/node]\r\n11: 0x1002c8737 v8::internal::Factory::NewFillerObject(int, bool, v8::internal::AllocationType) [/Users/tuyennguyen/.nvm/versions/node/v12.10.0/bin/node]\r\n12: 0x1005e8f67 v8::internal::Runtime_AllocateInYoungGeneration(int, unsigned long*, v8::internal::Isolate*) [/Users/tuyennguyen/.nvm/versions/node/v12.10.0/bin/node]\r\n13: 0x1009288f9 Builtins_CEntry_Return1_DontSaveFPRegs_ArgvOnStack_NoBuiltinExit [/Users/tuyennguyen/.nvm/versions/node/v12.10.0/bin/node]\r\n14: 0x1008f0984 Builtins_ObjectEntries [/Users/tuyennguyen/.nvm/versions/node/v12.10.0/bin/node]\r\nAbort trap: 6\r\nTuyens-MacBook-Pro-16519:lodestar-cli tuyennguyen$\r\n```\r\n\r\n**Expected behavior**\r\nThe error does not happen, initial sync can continue",
  "closed_by": {
    "login": "wemeetagain",
    "id": 1348242,
    "node_id": "MDQ6VXNlcjEzNDgyNDI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1348242?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/wemeetagain",
    "html_url": "https://github.com/wemeetagain",
    "followers_url": "https://api.github.com/users/wemeetagain/followers",
    "following_url": "https://api.github.com/users/wemeetagain/following{/other_user}",
    "gists_url": "https://api.github.com/users/wemeetagain/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/wemeetagain/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/wemeetagain/subscriptions",
    "organizations_url": "https://api.github.com/users/wemeetagain/orgs",
    "repos_url": "https://api.github.com/users/wemeetagain/repos",
    "events_url": "https://api.github.com/users/wemeetagain/events{/privacy}",
    "received_events_url": "https://api.github.com/users/wemeetagain/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/1424/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/1424/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/677512602",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/1424#issuecomment-677512602",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/1424",
    "id": 677512602,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY3NzUxMjYwMg==",
    "user": {
      "login": "Yoldark34",
      "id": 3829890,
      "node_id": "MDQ6VXNlcjM4Mjk4OTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3829890?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Yoldark34",
      "html_url": "https://github.com/Yoldark34",
      "followers_url": "https://api.github.com/users/Yoldark34/followers",
      "following_url": "https://api.github.com/users/Yoldark34/following{/other_user}",
      "gists_url": "https://api.github.com/users/Yoldark34/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Yoldark34/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Yoldark34/subscriptions",
      "organizations_url": "https://api.github.com/users/Yoldark34/orgs",
      "repos_url": "https://api.github.com/users/Yoldark34/repos",
      "events_url": "https://api.github.com/users/Yoldark34/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Yoldark34/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-08-20T10:23:09Z",
    "updated_at": "2020-08-20T10:23:09Z",
    "author_association": "NONE",
    "body": "Same.\r\n\r\n```2020-08-20 12:09:34  [CHAIN]            info: Processed new chain head newChainHeadRoot=0x5ddd3af105737e609d8c97f5c64c7e23897dbcd8e555746159cb78adf27ef682, slot=77025, epoch=2407\r\n2020-08-20 12:09:34  [CHAIN]            info: Processed new chain head newChainHeadRoot=0x55bfdbd995755f76fa001b43e3b4db1307806300ecf409e3c5c34e3aead9eaa9, slot=77037, epoch=2407\r\n2020-08-20 12:09:34  [CHAIN]            info: Processed new chain head newChainHeadRoot=0x29f00ac26be7f2442468f3dad460341de32b3290c79620cc5db5227862095572, slot=77038, epoch=2407\r\n2020-08-20 12:09:35  [CHAIN]            info: Processed new chain head newChainHeadRoot=0x4b461e6d20a1932c8d031bdf3f10f0db95b81c59fdbc8d4d64aae8724b1e0f1a, slot=77040, epoch=2407\r\n2020-08-20 12:09:36  [CHAIN]            info: Processed new chain head newChainHeadRoot=0x6aaeacf55c5f46f00723ccb6047713058cd91057eba09f778f59d9688619a4cf, slot=77041, epoch=2407\r\n2020-08-20 12:09:36  [CHAIN]            info: Processed new chain head newChainHeadRoot=0xbe4b9bb292dc1c594be843fe9b025507a785013c6d2538a02fd32f1ebfafde00, slot=77047, epoch=2407\r\n2020-08-20 12:09:36  [CHAIN]            info: Processed new chain head newChainHeadRoot=0xd844aea86422a6a1ac14748518b8b6e67611149e1da4c0eaeefe10078a424420, slot=77049, epoch=2407\r\n2020-08-20 12:09:36  [CHAIN]            info: Processed new chain head newChainHeadRoot=0x4dc766956698bf7991d25803c1d2c28b794264f4b15e6563415d44f017c3900a, slot=77050, epoch=2407\r\n2020-08-20 12:09:36  [CHAIN]            info: Processed new chain head newChainHeadRoot=0x2f1879fd93d070fdc2b15359c65a4ae381724c973621dd75d0f006d24f194c37, slot=77054, epoch=2407\r\n<--- Last few GCs --->\r\n[67391:0x3df2970]   288635 ms: Mark-sweep 2026.0 (2068.0) -> 2010.9 (2068.5) MB, 865.1 / 0.0 ms  (average mu = 0.138, current mu = 0.030) allocation failure scavenge might not succeed\r\n[67391:0x3df2970]   289511 ms: Mark-sweep 2026.6 (2068.8) -> 2011.5 (2069.3) MB, 718.9 / 0.0 ms  (average mu = 0.158, current mu = 0.179) allocation failure scavenge might not succeed\r\n<--- JS stacktrace --->\r\n==== JS stack trace =========================================\r\n    0: ExitFrame [pc: 0x13cf019]\r\nSecurity context: 0x2d7a675408d1 <JSObject>\r\n    1: iterateNodesAtDepth [0x1539e90452e9] [/home/beacon/bin/lodestar/node_modules/@chainsafe/persistent-merkle-tree/lib/tree.js:~117] [pc=0x25d0a47e58a8](this=0x09c130c828f9 <Tree map = 0xccd4a73a909>,3,0,8)\r\n    2: next [0x2d7a67563139](this=0x09c130c82ca9 <JSGenerator>)\r\n    3: readOnlyEntries [0x15cb560577e1] [/home/beacon/bin/lodestar/node_modules/@chainsafe/...\r\nFATAL ERROR: Ineffective mark-compacts near heap limit Allocation failed - JavaScript heap out of memory\r\n 1: 0xa093f0 node::Abort() [node]\r\n 2: 0xa097fc node::OnFatalError(char const*, char const*) [node]\r\n 3: 0xb842ae v8::Utils::ReportOOMFailure(v8::internal::Isolate*, char const*, bool) [node]\r\n 4: 0xb84629 v8::internal::V8::FatalProcessOutOfMemory(v8::internal::Isolate*, char const*, bool) [node]\r\n 5: 0xd30fe5  [node]\r\n 6: 0xd31676 v8::internal::Heap::RecomputeLimits(v8::internal::GarbageCollector) [node]\r\n 7: 0xd3def5 v8::internal::Heap::PerformGarbageCollection(v8::internal::GarbageCollector, v8::GCCallbackFlags) [node]\r\n 8: 0xd3eda5 v8::internal::Heap::CollectGarbage(v8::internal::AllocationSpace, v8::internal::GarbageCollectionReason, v8::GCCallbackFlags) [node]\r\n 9: 0xd4185c v8::internal::Heap::AllocateRawWithRetryOrFail(int, v8::internal::AllocationType, v8::internal::AllocationOrigin, v8::internal::AllocationAlignment) [node]\r\n10: 0xd0830b v8::internal::Factory::NewFillerObject(int, bool, v8::internal::AllocationType, v8::internal::AllocationOrigin) [node]\r\n11: 0x1049f4e v8::internal::Runtime_AllocateInYoungGeneration(int, unsigned long*, v8::internal::Isolate*) [node]\r\n12: 0x13cf019  [node]\r\nlodestar-beacon-chain.service: Main process exited, code=dumped, status=6/ABRT\r\nlodestar-beacon-chain.service: Failed with result 'core-dump'.\r\nlodestar-beacon-chain.service: Scheduled restart job, restart counter is at 73.\r\nStopped Ethereum 2 Lodestar Beacon Chain.\r\nStarted Ethereum 2 Lodestar Beacon Chain.\r\n2020-08-20 12:09:51  [CHAIN]            info: Found finalized state at slot 73248, starting chain from there\r\n2020-08-20 12:09:51  [NODE]             info: Starting eth2 beacon node - LODESTAR!\r\n2020-08-20 12:09:51  [METRICS]          info: Starting metrics HTTP server on port 8018```",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/677512602/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/677518485",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/1424#issuecomment-677518485",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/1424",
    "id": 677518485,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY3NzUxODQ4NQ==",
    "user": {
      "login": "Yoldark34",
      "id": 3829890,
      "node_id": "MDQ6VXNlcjM4Mjk4OTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3829890?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Yoldark34",
      "html_url": "https://github.com/Yoldark34",
      "followers_url": "https://api.github.com/users/Yoldark34/followers",
      "following_url": "https://api.github.com/users/Yoldark34/following{/other_user}",
      "gists_url": "https://api.github.com/users/Yoldark34/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Yoldark34/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Yoldark34/subscriptions",
      "organizations_url": "https://api.github.com/users/Yoldark34/orgs",
      "repos_url": "https://api.github.com/users/Yoldark34/repos",
      "events_url": "https://api.github.com/users/Yoldark34/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Yoldark34/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-08-20T10:37:30Z",
    "updated_at": "2020-08-20T10:37:30Z",
    "author_association": "NONE",
    "body": "It reached the same slot `slot=77054` and crashed again.",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/677518485/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/678713933",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/1424#issuecomment-678713933",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/1424",
    "id": 678713933,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY3ODcxMzkzMw==",
    "user": {
      "login": "strawdar",
      "id": 69126132,
      "node_id": "MDQ6VXNlcjY5MTI2MTMy",
      "avatar_url": "https://avatars.githubusercontent.com/u/69126132?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/strawdar",
      "html_url": "https://github.com/strawdar",
      "followers_url": "https://api.github.com/users/strawdar/followers",
      "following_url": "https://api.github.com/users/strawdar/following{/other_user}",
      "gists_url": "https://api.github.com/users/strawdar/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/strawdar/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/strawdar/subscriptions",
      "organizations_url": "https://api.github.com/users/strawdar/orgs",
      "repos_url": "https://api.github.com/users/strawdar/repos",
      "events_url": "https://api.github.com/users/strawdar/events{/privacy}",
      "received_events_url": "https://api.github.com/users/strawdar/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-08-23T00:38:23Z",
    "updated_at": "2020-08-23T00:38:50Z",
    "author_association": "CONTRIBUTOR",
    "body": "This is more of a workaround than a real fix, but it seems I've been able to brute force my way past this slot by specifying a large `max-old-space-size` in package.json for the cli script:\r\n\r\n```\r\n    \"cli\": \"node --max-old-space-size=24576 --trace-deprecation ./packages/lodestar-cli/bin/lodestar\"\r\n```\r\n\r\n24GB is probably overkill, but the node process is currently still syncing and using 10~11GB as I type this.",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/678713933/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/682786550",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/1424#issuecomment-682786550",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/1424",
    "id": 682786550,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY4Mjc4NjU1MA==",
    "user": {
      "login": "wemeetagain",
      "id": 1348242,
      "node_id": "MDQ6VXNlcjEzNDgyNDI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1348242?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/wemeetagain",
      "html_url": "https://github.com/wemeetagain",
      "followers_url": "https://api.github.com/users/wemeetagain/followers",
      "following_url": "https://api.github.com/users/wemeetagain/following{/other_user}",
      "gists_url": "https://api.github.com/users/wemeetagain/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/wemeetagain/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/wemeetagain/subscriptions",
      "organizations_url": "https://api.github.com/users/wemeetagain/orgs",
      "repos_url": "https://api.github.com/users/wemeetagain/repos",
      "events_url": "https://api.github.com/users/wemeetagain/events{/privacy}",
      "received_events_url": "https://api.github.com/users/wemeetagain/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-08-28T16:03:23Z",
    "updated_at": "2020-08-28T16:03:23Z",
    "author_association": "MEMBER",
    "body": "closing in favor of #1456 ",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/682786550/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
