{
  "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/6154",
  "repository_url": "https://api.github.com/repos/ChainSafe/lodestar",
  "labels_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/6154/labels{/name}",
  "comments_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/6154/comments",
  "events_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/6154/events",
  "html_url": "https://github.com/ChainSafe/lodestar/issues/6154",
  "id": 2024354939,
  "node_id": "I_kwDOCD5_Gc54qTR7",
  "number": 6154,
  "title": "Auth header is url-encoded",
  "user": {
    "login": "jshufro",
    "id": 116244,
    "node_id": "MDQ6VXNlcjExNjI0NA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/116244?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jshufro",
    "html_url": "https://github.com/jshufro",
    "followers_url": "https://api.github.com/users/jshufro/followers",
    "following_url": "https://api.github.com/users/jshufro/following{/other_user}",
    "gists_url": "https://api.github.com/users/jshufro/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jshufro/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jshufro/subscriptions",
    "organizations_url": "https://api.github.com/users/jshufro/orgs",
    "repos_url": "https://api.github.com/users/jshufro/repos",
    "events_url": "https://api.github.com/users/jshufro/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jshufro/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 5670219610,
      "node_id": "LA_kwDOCD5_Gc8AAAABUfivWg",
      "url": "https://api.github.com/repos/ChainSafe/lodestar/labels/meta-bug",
      "name": "meta-bug",
      "color": "E79553",
      "default": false,
      "description": "Issues that identify a bug and require a fix."
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/milestones/36",
    "html_url": "https://github.com/ChainSafe/lodestar/milestone/36",
    "labels_url": "https://api.github.com/repos/ChainSafe/lodestar/milestones/36/labels",
    "id": 10258578,
    "node_id": "MI_kwDOCD5_Gc4AnIiS",
    "number": 36,
    "title": "v1.12.1",
    "description": "",
    "creator": {
      "login": "philknows",
      "id": 58080811,
      "node_id": "MDQ6VXNlcjU4MDgwODEx",
      "avatar_url": "https://avatars.githubusercontent.com/u/58080811?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/philknows",
      "html_url": "https://github.com/philknows",
      "followers_url": "https://api.github.com/users/philknows/followers",
      "following_url": "https://api.github.com/users/philknows/following{/other_user}",
      "gists_url": "https://api.github.com/users/philknows/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/philknows/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/philknows/subscriptions",
      "organizations_url": "https://api.github.com/users/philknows/orgs",
      "repos_url": "https://api.github.com/users/philknows/repos",
      "events_url": "https://api.github.com/users/philknows/events{/privacy}",
      "received_events_url": "https://api.github.com/users/philknows/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 1,
    "closed_issues": 4,
    "state": "open",
    "created_at": "2023-12-02T14:01:29Z",
    "updated_at": "2023-12-07T15:36:30Z",
    "due_on": null,
    "closed_at": null
  },
  "comments": 5,
  "created_at": "2023-12-04T17:21:17Z",
  "updated_at": "2023-12-07T15:36:30Z",
  "closed_at": "2023-12-07T15:36:29Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "### Describe the bug\n\nLodestar seems to be URL-encoding the `username:password` pair for basic auth before base64 encoding and setting the Authorization header.\r\n\r\n(I will see about PRing a fix)\n\n### Expected behavior\n\nAuth headers aren't part of the URL and need not be encoded\n\n### Steps to reproduce\n\nSet a username with an `=` in it\r\nObserve that the validator queries with a `Authorization` header with a value that decodes to `%3D`\n\n### Additional context\n\nThis has broken the rescue node's work flow again ;)\n\n### Operating system\n\nLinux\n\n### Lodestar version or commit hash\n\nv1.11.3",
  "closed_by": {
    "login": "wemeetagain",
    "id": 1348242,
    "node_id": "MDQ6VXNlcjEzNDgyNDI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1348242?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/wemeetagain",
    "html_url": "https://github.com/wemeetagain",
    "followers_url": "https://api.github.com/users/wemeetagain/followers",
    "following_url": "https://api.github.com/users/wemeetagain/following{/other_user}",
    "gists_url": "https://api.github.com/users/wemeetagain/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/wemeetagain/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/wemeetagain/subscriptions",
    "organizations_url": "https://api.github.com/users/wemeetagain/orgs",
    "repos_url": "https://api.github.com/users/wemeetagain/repos",
    "events_url": "https://api.github.com/users/wemeetagain/events{/privacy}",
    "received_events_url": "https://api.github.com/users/wemeetagain/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/6154/reactions",
    "total_count": 1,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 1
  },
  "timeline_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/6154/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1839176594",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/6154#issuecomment-1839176594",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/6154",
    "id": 1839176594,
    "node_id": "IC_kwDOCD5_Gc5tn5uS",
    "user": {
      "login": "nflaig",
      "id": 38436224,
      "node_id": "MDQ6VXNlcjM4NDM2MjI0",
      "avatar_url": "https://avatars.githubusercontent.com/u/38436224?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nflaig",
      "html_url": "https://github.com/nflaig",
      "followers_url": "https://api.github.com/users/nflaig/followers",
      "following_url": "https://api.github.com/users/nflaig/following{/other_user}",
      "gists_url": "https://api.github.com/users/nflaig/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nflaig/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nflaig/subscriptions",
      "organizations_url": "https://api.github.com/users/nflaig/orgs",
      "repos_url": "https://api.github.com/users/nflaig/repos",
      "events_url": "https://api.github.com/users/nflaig/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nflaig/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-12-04T17:56:08Z",
    "updated_at": "2023-12-04T17:56:08Z",
    "author_association": "MEMBER",
    "body": "> Auth headers aren't part of the URL and need not be encoded\r\n\r\nThe problem is we are not setting these explicitly but as part of the URL. I wonder how other clients handle this but if you use a basic auth credentials (`username:password`) via browser it would certainly be URL encoded.\r\n\r\nBut I would agree we don't need to do that and align behavior with other clients. Also noticed it not URL encoding every character. e.g. `=` is encoded while `&` is not and `#` just throws an error..\r\n\r\n```node\r\n> new URL(\"http://user:passw=rd@localhost\")\r\nURL {\r\n  password: 'passw%3Drd',\r\n}\r\n\r\n> new URL(\"http://user:passw&rd@localhost\")\r\nURL {\r\n  password: 'passw&rd',\r\n}\r\n\r\n> new URL(\"http://user:passw#rd@localhost\")\r\nUncaught TypeError [ERR_INVALID_URL]: Invalid URL\r\n```\r\n\r\nI remember in the past that I had configured my password manager to only use URL safe characters for generation because various services had similar behavor (including browser)... this is bad should definitely not have any character restriction in passwords.",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1839176594/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1839305982",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/6154#issuecomment-1839305982",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/6154",
    "id": 1839305982,
    "node_id": "IC_kwDOCD5_Gc5toZT-",
    "user": {
      "login": "nflaig",
      "id": 38436224,
      "node_id": "MDQ6VXNlcjM4NDM2MjI0",
      "avatar_url": "https://avatars.githubusercontent.com/u/38436224?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nflaig",
      "html_url": "https://github.com/nflaig",
      "followers_url": "https://api.github.com/users/nflaig/followers",
      "following_url": "https://api.github.com/users/nflaig/following{/other_user}",
      "gists_url": "https://api.github.com/users/nflaig/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nflaig/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nflaig/subscriptions",
      "organizations_url": "https://api.github.com/users/nflaig/orgs",
      "repos_url": "https://api.github.com/users/nflaig/repos",
      "events_url": "https://api.github.com/users/nflaig/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nflaig/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-12-04T19:16:42Z",
    "updated_at": "2023-12-04T19:16:42Z",
    "author_association": "MEMBER",
    "body": "@jshufro Let me know if you are working on this, else I can take a look at it as well.\r\n\r\nJust a few notes from my side\r\n- if we want to support any character e.g. `#` or `?` then have to extract basic auth credentials before validating URL else this will throw an error\r\nhttps://github.com/ChainSafe/lodestar/blob/9dae25f817648635d39761b57cf2474e4abe7787/packages/api/src/utils/client/httpClient.ts#L132-L134\r\n- test case needs to be updated to cover all cases as outlined in my previous comment\r\nhttps://github.com/ChainSafe/lodestar/blob/5201ac40cc4eb5cfa5235e5cb718047572c9441d/packages/api/test/unit/client/httpClient.test.ts#L138\r\n- could build the auth header in constructor of HttpClient class, this would also avoid recreating the header on every request\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1839305982/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1839331532",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/6154#issuecomment-1839331532",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/6154",
    "id": 1839331532,
    "node_id": "IC_kwDOCD5_Gc5tofjM",
    "user": {
      "login": "jshufro",
      "id": 116244,
      "node_id": "MDQ6VXNlcjExNjI0NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/116244?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jshufro",
      "html_url": "https://github.com/jshufro",
      "followers_url": "https://api.github.com/users/jshufro/followers",
      "following_url": "https://api.github.com/users/jshufro/following{/other_user}",
      "gists_url": "https://api.github.com/users/jshufro/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jshufro/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jshufro/subscriptions",
      "organizations_url": "https://api.github.com/users/jshufro/orgs",
      "repos_url": "https://api.github.com/users/jshufro/repos",
      "events_url": "https://api.github.com/users/jshufro/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jshufro/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-12-04T19:28:03Z",
    "updated_at": "2023-12-04T19:28:03Z",
    "author_association": "CONTRIBUTOR",
    "body": "I'll take a stab. I agree pulling it out before passing into the client is probably best:\r\n1. It lets us fix the immediate issue\r\n2. You probably shouldn't log the fully qualified uri- the username/password as somewhat sensitive.",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1839331532/reactions",
      "total_count": 2,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 1,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1839348082",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/6154#issuecomment-1839348082",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/6154",
    "id": 1839348082,
    "node_id": "IC_kwDOCD5_Gc5tojly",
    "user": {
      "login": "jshufro",
      "id": 116244,
      "node_id": "MDQ6VXNlcjExNjI0NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/116244?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jshufro",
      "html_url": "https://github.com/jshufro",
      "followers_url": "https://api.github.com/users/jshufro/followers",
      "following_url": "https://api.github.com/users/jshufro/following{/other_user}",
      "gists_url": "https://api.github.com/users/jshufro/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jshufro/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jshufro/subscriptions",
      "organizations_url": "https://api.github.com/users/jshufro/orgs",
      "repos_url": "https://api.github.com/users/jshufro/repos",
      "events_url": "https://api.github.com/users/jshufro/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jshufro/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-12-04T19:37:59Z",
    "updated_at": "2023-12-04T19:37:59Z",
    "author_association": "CONTRIBUTOR",
    "body": "Also- since we use a URL-safe base64 library, it should be a nop for us to decode the Auth header, urldecode the username:password pair (which are base64 for us), and then re-encode the header in a header rewrite, so i'm going to attempt that before i start this",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1839348082/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1839410322",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/6154#issuecomment-1839410322",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/6154",
    "id": 1839410322,
    "node_id": "IC_kwDOCD5_Gc5toyyS",
    "user": {
      "login": "jshufro",
      "id": 116244,
      "node_id": "MDQ6VXNlcjExNjI0NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/116244?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jshufro",
      "html_url": "https://github.com/jshufro",
      "followers_url": "https://api.github.com/users/jshufro/followers",
      "following_url": "https://api.github.com/users/jshufro/following{/other_user}",
      "gists_url": "https://api.github.com/users/jshufro/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jshufro/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jshufro/subscriptions",
      "organizations_url": "https://api.github.com/users/jshufro/orgs",
      "repos_url": "https://api.github.com/users/jshufro/repos",
      "events_url": "https://api.github.com/users/jshufro/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jshufro/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-12-04T20:19:45Z",
    "updated_at": "2023-12-04T20:19:45Z",
    "author_association": "CONTRIBUTOR",
    "body": "haproxy made it too complicated so i adjusted the upstream service. I'll have a PR up for lodestar in a bit :)",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1839410322/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
