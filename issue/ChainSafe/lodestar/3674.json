{
  "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3674",
  "repository_url": "https://api.github.com/repos/ChainSafe/lodestar",
  "labels_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3674/labels{/name}",
  "comments_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3674/comments",
  "events_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3674/events",
  "html_url": "https://github.com/ChainSafe/lodestar/issues/3674",
  "id": 1116715227,
  "node_id": "I_kwDOCD5_Gc5Cj7jb",
  "number": 3674,
  "title": "Handle recurring ETH1_ERROR_DUPLICATE_DISTINCT_LOG",
  "user": {
    "login": "g11tech",
    "id": 76567250,
    "node_id": "MDQ6VXNlcjc2NTY3MjUw",
    "avatar_url": "https://avatars.githubusercontent.com/u/76567250?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/g11tech",
    "html_url": "https://github.com/g11tech",
    "followers_url": "https://api.github.com/users/g11tech/followers",
    "following_url": "https://api.github.com/users/g11tech/following{/other_user}",
    "gists_url": "https://api.github.com/users/g11tech/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/g11tech/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/g11tech/subscriptions",
    "organizations_url": "https://api.github.com/users/g11tech/orgs",
    "repos_url": "https://api.github.com/users/g11tech/repos",
    "events_url": "https://api.github.com/users/g11tech/events{/privacy}",
    "received_events_url": "https://api.github.com/users/g11tech/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "g11tech",
    "id": 76567250,
    "node_id": "MDQ6VXNlcjc2NTY3MjUw",
    "avatar_url": "https://avatars.githubusercontent.com/u/76567250?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/g11tech",
    "html_url": "https://github.com/g11tech",
    "followers_url": "https://api.github.com/users/g11tech/followers",
    "following_url": "https://api.github.com/users/g11tech/following{/other_user}",
    "gists_url": "https://api.github.com/users/g11tech/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/g11tech/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/g11tech/subscriptions",
    "organizations_url": "https://api.github.com/users/g11tech/orgs",
    "repos_url": "https://api.github.com/users/g11tech/repos",
    "events_url": "https://api.github.com/users/g11tech/events{/privacy}",
    "received_events_url": "https://api.github.com/users/g11tech/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "g11tech",
      "id": 76567250,
      "node_id": "MDQ6VXNlcjc2NTY3MjUw",
      "avatar_url": "https://avatars.githubusercontent.com/u/76567250?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/g11tech",
      "html_url": "https://github.com/g11tech",
      "followers_url": "https://api.github.com/users/g11tech/followers",
      "following_url": "https://api.github.com/users/g11tech/following{/other_user}",
      "gists_url": "https://api.github.com/users/g11tech/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/g11tech/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/g11tech/subscriptions",
      "organizations_url": "https://api.github.com/users/g11tech/orgs",
      "repos_url": "https://api.github.com/users/g11tech/repos",
      "events_url": "https://api.github.com/users/g11tech/events{/privacy}",
      "received_events_url": "https://api.github.com/users/g11tech/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2022-01-27T20:38:18Z",
  "updated_at": "2022-02-07T17:01:06Z",
  "closed_at": "2022-02-07T17:01:06Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "On doing test runs of kintsugi with nethermind with deposit tracker enabled, following deposit cache error log dump was observed:\r\n\r\n```\r\n{\r\n  depositEvents: [\r\n    { blockNumber: 7521, index: 9, depositData: [Object] },\r\n    { blockNumber: 8167, index: 10, depositData: [Object] }\r\n  ]\r\n}\r\nJan-27 20:10:02.474 [ETH1]            error: Error updating eth1 chain cache code=ETH1_ERROR_DUPLICATE_DISTINCT_LOG, newIndex=9, prevIndex=11\r\nError: ETH1_ERROR_DUPLICATE_DISTINCT_LOG\r\n    at Eth1DepositsCache.add (/root/lodestar/packages/lodestar/src/eth1/eth1DepositsCache.ts:45:15)\r\n    at Eth1DepositDataTracker.updateDepositCache (/root/lodestar/packages/lodestar/src/eth1/eth1DepositDataTracker.ts:164:5)\r\n    at Eth1DepositDataTracker.update (/root/lodestar/packages/lodestar/src/eth1/eth1DepositDataTracker.ts:144:33)\r\n    at Eth1DepositDataTracker.runAutoUpdate (/root/lodestar/packages/lodestar/src/eth1/eth1DepositDataTracker.ts:118:29)\r\nparseDepositLog {\r\n  log: {\r\n```\r\n\r\nThis error shows that the tracker supposedly got a duplicate entry.  However once this happens, this error repeats ad infinitum\r\n\r\nExpected: Investigate the error , if genuine the error should be handled and tracker should move ahead, else find/fix the bug causing the error.\r\n",
  "closed_by": {
    "login": "wemeetagain",
    "id": 1348242,
    "node_id": "MDQ6VXNlcjEzNDgyNDI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1348242?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/wemeetagain",
    "html_url": "https://github.com/wemeetagain",
    "followers_url": "https://api.github.com/users/wemeetagain/followers",
    "following_url": "https://api.github.com/users/wemeetagain/following{/other_user}",
    "gists_url": "https://api.github.com/users/wemeetagain/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/wemeetagain/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/wemeetagain/subscriptions",
    "organizations_url": "https://api.github.com/users/wemeetagain/orgs",
    "repos_url": "https://api.github.com/users/wemeetagain/repos",
    "events_url": "https://api.github.com/users/wemeetagain/events{/privacy}",
    "received_events_url": "https://api.github.com/users/wemeetagain/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3674/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3674/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1023889484",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/3674#issuecomment-1023889484",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3674",
    "id": 1023889484,
    "node_id": "IC_kwDOCD5_Gc49B1BM",
    "user": {
      "login": "dapplion",
      "id": 35266934,
      "node_id": "MDQ6VXNlcjM1MjY2OTM0",
      "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dapplion",
      "html_url": "https://github.com/dapplion",
      "followers_url": "https://api.github.com/users/dapplion/followers",
      "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
      "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
      "organizations_url": "https://api.github.com/users/dapplion/orgs",
      "repos_url": "https://api.github.com/users/dapplion/repos",
      "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dapplion/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-01-28T05:03:18Z",
    "updated_at": "2022-01-28T05:03:18Z",
    "author_association": "MEMBER",
    "body": "This error is so annoying! Thanks for looking into it",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1023889484/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1029981668",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/3674#issuecomment-1029981668",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3674",
    "id": 1029981668,
    "node_id": "IC_kwDOCD5_Gc49ZEXk",
    "user": {
      "login": "g11tech",
      "id": 76567250,
      "node_id": "MDQ6VXNlcjc2NTY3MjUw",
      "avatar_url": "https://avatars.githubusercontent.com/u/76567250?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/g11tech",
      "html_url": "https://github.com/g11tech",
      "followers_url": "https://api.github.com/users/g11tech/followers",
      "following_url": "https://api.github.com/users/g11tech/following{/other_user}",
      "gists_url": "https://api.github.com/users/g11tech/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/g11tech/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/g11tech/subscriptions",
      "organizations_url": "https://api.github.com/users/g11tech/orgs",
      "repos_url": "https://api.github.com/users/g11tech/repos",
      "events_url": "https://api.github.com/users/g11tech/events{/privacy}",
      "received_events_url": "https://api.github.com/users/g11tech/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-02-04T13:22:55Z",
    "updated_at": "2022-02-04T13:22:55Z",
    "author_association": "CONTRIBUTOR",
    "body": "UPDATE:\r\nThe error occurs in these two **post merge** scenarios\r\n- Both EL is in a post merge scenario and is ahead of lodestar: for e.g.\r\n  - When lodestar is started, its deposit tracker correctly identifies that EL is ahead : `{ remoteHighestBlock: 8885, remoteFollowBlock: 8869 }` and hence it starts fetching the deposit events till `8869` for example in this case till index 10, 8167\r\n     ```\r\n     {\r\n        blockNumber: 8167,\r\n        index: 10,\r\n        depositData: {\r\n          pubkey: [Uint8Array],\r\n          withdrawalCredentials: [Uint8Array],\r\n          amount: 32000000000,\r\n          signature: [Uint8Array]\r\n        }\r\n    ```\r\n   - As lodestar goes past the merge block, it \"reorgs\" the EL with its fcU calls, also causing the tracker to update its remoteHighestBlock and hence remoteFollowBlock as well: `{ remoteHighestBlock: 7235, remoteFollowBlock: 7219 }` \r\n   - now trackers start fetching deposit log again from `fromBlock: 7220,toBlock: 7933}` causing re-import of the deposits leading to reimporting this deposit event:\r\n     ```{\r\n      blockNumber: 7521,\r\n      index: 9,\r\n      depositData: {\r\n        pubkey: [Uint8Array],\r\n        withdrawalCredentials: [Uint8Array],\r\n        amount: 32000000000,\r\n        signature: [Uint8Array]\r\n      }\r\n     ```\r\n  - which throws this error because index 9 event has already been importted:\r\n    ```\r\n    Feb-04 08:57:55.720 [ETH1]            error: Error updating eth1 chain cache code=ETH1_ERROR_DUPLICATE_DISTINCT_LOG, newIndex=9, prevIndex=10\r\n    Error: ETH1_ERROR_DUPLICATE_DISTINCT_LOG\r\n        at Eth1DepositsCache.add (/usr/app/packages/lodestar/src/eth1/eth1DepositsCache.ts:46:15)\r\n        at Eth1DepositDataTracker.updateDepositCache (/u\r\n    ```\r\n- Whenever lodestar restarts it starts from the previous archived finalized state, which could be a few epochs behind the blocks lodestar already fetched last time. This might again lead to \"re-org\" of the EL as lodestar will start sending fcU calls for previously send slots, again causing above scenario to repeat.\r\n\r\nSuggested resolution if such scenario happens \r\n- delete all the logs which are head of the deposit's , as well as unset them from the `depositRootTree` of `DepositDataRootRepository`,and then let it proceed from there \r\n- Or  ignore these duplicate events and move the underlying tracker along\r\n\r\n@dapplion what resolution from above do you think would be suitable.",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1029981668/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
