{
  "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/1637",
  "repository_url": "https://api.github.com/repos/ChainSafe/lodestar",
  "labels_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/1637/labels{/name}",
  "comments_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/1637/comments",
  "events_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/1637/events",
  "html_url": "https://github.com/ChainSafe/lodestar/issues/1637",
  "id": 715423705,
  "node_id": "MDU6SXNzdWU3MTU0MjM3MDU=",
  "number": 1637,
  "title": "Validating gossip aggregate and proof takes too long",
  "user": {
    "login": "tuyennhv",
    "id": 10568965,
    "node_id": "MDQ6VXNlcjEwNTY4OTY1",
    "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tuyennhv",
    "html_url": "https://github.com/tuyennhv",
    "followers_url": "https://api.github.com/users/tuyennhv/followers",
    "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
    "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
    "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
    "repos_url": "https://api.github.com/users/tuyennhv/repos",
    "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "tuyennhv",
    "id": 10568965,
    "node_id": "MDQ6VXNlcjEwNTY4OTY1",
    "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tuyennhv",
    "html_url": "https://github.com/tuyennhv",
    "followers_url": "https://api.github.com/users/tuyennhv/followers",
    "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
    "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
    "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
    "repos_url": "https://api.github.com/users/tuyennhv/repos",
    "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "tuyennhv",
      "id": 10568965,
      "node_id": "MDQ6VXNlcjEwNTY4OTY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tuyennhv",
      "html_url": "https://github.com/tuyennhv",
      "followers_url": "https://api.github.com/users/tuyennhv/followers",
      "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
      "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
      "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
      "repos_url": "https://api.github.com/users/tuyennhv/repos",
      "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2020-10-06T07:35:38Z",
  "updated_at": "2020-10-08T19:06:34Z",
  "closed_at": "2020-10-08T19:06:34Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "**Describe the bug**\r\n```\r\n2020-10-06 13:33:50 [NETWORK]       ^[[36mverbose^[[39m: Sent response for request 671f5150f305c8d5\r\n2020-10-06 13:33:50 [NETWORK]          ^[[32minfo^[[39m: gossipAggregateAndProofValidation  - duration=501ms\r\n2020-10-06 13:33:50 [NETWORK]       ^[[36mverbose^[[39m: Started gossip aggregate and proof validation attestationSlot=451654, aggregatorIndex=13594, root=0x8762fdd3aff2b7152ed679de704b27f70929dfcba5f200eb2f8574ad231e47aa, attestationRoot=0x11d7affc369d7cd4e22247812bfeac9bc9e1a2188e42cb1f91fb598fbe0321c4\r\n2020-10-06 13:33:50 [NETWORK]       ^[[36mverbose^[[39m: receive ping request from 16Uiu2HAmTWd5hbmsiozXPPTvBYWxc3aDnRKxRxDWWvc2GC1Wgw1n requestId=70c95749b2b67dcf, encoding=ssz_snappy\r\n2020-10-06 13:33:50 [NETWORK]       ^[[36mverbose^[[39m: Sent response for request 70c95749b2b67dcf\r\n2020-10-06 13:33:50 [NETWORK]       ^[[36mverbose^[[39m: sending metadata request to 16Uiu2HAmTWd5hbmsiozXPPTvBYWxc3aDnRKxRxDWWvc2GC1Wgw1n requestId=bff64dd27f245a6f, encoding=ssz_snappy\r\n2020-10-06 13:33:50 [NETWORK]       ^[[36mverbose^[[39m: receive ping request from 16Uiu2HAmSYgs2RRXGEYgTC16caaqan3sjzaM8xsQCekMwi4Jfj42 requestId=d290fd4b0341b672, encoding=ssz_snappy\r\n2020-10-06 13:33:50 [NETWORK]       ^[[36mverbose^[[39m: Sent response for request d290fd4b0341b672\r\n2020-10-06 13:33:50 [NETWORK]       ^[[36mverbose^[[39m: sending metadata request to 16Uiu2HAmSYgs2RRXGEYgTC16caaqan3sjzaM8xsQCekMwi4Jfj42 requestId=c5d53b8c33d89310, encoding=ssz_snappy\r\n2020-10-06 13:34:35 [NETWORK]          ^[[32minfo^[[39m: Received gossip aggregate and proof passed validation attestationSlot=451654, aggregatorIndex=13594, root=0x8762fdd3aff2b7152ed679de704b27f70929dfcba5f200eb2f8574ad231e47aa, attestationRoot=0x11d7affc369d7cd4e22247812bfeac9bc9e1a2188e42cb1f91fb598fbe0321c4\r\n2020-10-06 13:34:35 [GOSSIP]        ^[[36mverbose^[[39m: Received AggregateAndProof from validator #13594 for target 0xa42aec95473ebd7a211b631b8cb415641ad9bb5105006ca048bc7c347c63b496\r\n2020-10-06 13:34:35 [CHAIN]            ^[[32minfo^[[39m: Attestation received to process pool attestationHash=0x11d7affc369d7cd4e22247812bfeac9bc9e1a2188e42cb1f91fb598fbe0321c4, target=14114\r\n2020-10-06 13:34:35 [NETWORK]       ^[[36mverbose^[[39m: receive ping request from 16Uiu2HAm9ZbWN7hWTAEmj3A243c2KkAN2hBVyEDjYd1xtuZyTfna requestId=44a2e320055ce25e, encoding=ssz_snappy\r\n2020-10-06 13:34:35 [NETWORK]       ^[[36mverbose^[[39m: Sent response for request 44a2e320055ce25e\r\n2020-10-06 13:34:35 [NETWORK]       ^[[36mverbose^[[39m: sending metadata request to 16Uiu2HAm9ZbWN7hWTAEmj3A243c2KkAN2hBVyEDjYd1xtuZyTfna requestId=ce63d16589f45db4, encoding=ssz_snappy\r\n2020-10-06 13:34:35 [NETWORK]       ^[[36mverbose^[[39m: Started gossip block validation blockSlot=451669, blockRoot=0x999faf0bba92fb820c3264bb6dfc1eb7bdacbe46f08e36b906c8ffa7ffa59d5b\r\n```\r\nIt took almost 45s to validate gossip aggregate and proof `0x8762fdd3aff2b7152ed679de704b27f70929dfcba5f200eb2f8574ad231e47aa` and the node can't do anything. Need to investigate which api caused this.\r\nThat's why at some time I see the synced peers reduced to 0 and we receive no more gossip blocks and we never finish regular sync.\r\n\r\n",
  "closed_by": {
    "login": "wemeetagain",
    "id": 1348242,
    "node_id": "MDQ6VXNlcjEzNDgyNDI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1348242?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/wemeetagain",
    "html_url": "https://github.com/wemeetagain",
    "followers_url": "https://api.github.com/users/wemeetagain/followers",
    "following_url": "https://api.github.com/users/wemeetagain/following{/other_user}",
    "gists_url": "https://api.github.com/users/wemeetagain/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/wemeetagain/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/wemeetagain/subscriptions",
    "organizations_url": "https://api.github.com/users/wemeetagain/orgs",
    "repos_url": "https://api.github.com/users/wemeetagain/repos",
    "events_url": "https://api.github.com/users/wemeetagain/events{/privacy}",
    "received_events_url": "https://api.github.com/users/wemeetagain/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/1637/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/1637/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/704167515",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/1637#issuecomment-704167515",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/1637",
    "id": 704167515,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcwNDE2NzUxNQ==",
    "user": {
      "login": "tuyennhv",
      "id": 10568965,
      "node_id": "MDQ6VXNlcjEwNTY4OTY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tuyennhv",
      "html_url": "https://github.com/tuyennhv",
      "followers_url": "https://api.github.com/users/tuyennhv/followers",
      "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
      "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
      "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
      "repos_url": "https://api.github.com/users/tuyennhv/repos",
      "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-10-06T10:05:54Z",
    "updated_at": "2020-10-06T10:05:54Z",
    "author_association": "CONTRIBUTOR",
    "body": "the concerning aggregateAndProof is\r\n```\r\n@@@ aggregated attestation details {\r\n  aggregatorIndex: '13594',\r\n  aggregate: {\r\n    aggregationBits: '0x3dfbf5fdfeedbd6b13f5b669f8da57acdf01',\r\n    data: {\r\n      slot: '451654',\r\n      index: '13',\r\n      beaconBlockRoot: '0x1b4a2d800aa8115092255e9d031484d7ec0178fd695ce9c0d158ca4f875b6b09',\r\n      source: [Object],\r\n      target: [Object]\r\n    },\r\n    signature: '0x81d07e34c9f016b8bb551f3c8aea5e9a41418e0dc5b7dbc10eda589237ece465d95e874f861ef31f1d9fde52e9ce915a077f2c90446a8756d19521dba33d0fc9b31082bb2033db029daf978edad9e6bd6f845a99ef98268c7b344e5d9ae9817e'\r\n  },\r\n  selectionProof: '0x83669b86af4df58fec6f1e1267dad7a0a64d178520fa5f1d2e2e9a473e8392f646104c7f21be83694d2a17aac1d6046c0ce23e1db52891142e5d5694b202d3d604f0e6e594e098f139fd211982a9955d62617969dfe5a396f96e8c827559e3e7'\r\n}\r\n@@@ targetCheckpoint {\r\n  epoch: '14114',\r\n  root: '0xa42aec95473ebd7a211b631b8cb415641ad9bb5105006ca048bc7c347c63b496'\r\n}\r\n@@@ sourceCheckpoint {\r\n  epoch: '14113',\r\n  root: '0x9d81e96346a09a065b580b5ef2df8d9277ef6491a2612cb1a3ff5103e3d045d0'\r\n}\r\n```\r\nso we regen state from slot 451648 to slot 451654 which is not a lot, not sure why it takes time (or maybe another api?)\r\n\r\nI also notice that we did receive the block before the AggregatedAttestation:\r\n```\r\n2020-10-06 13:30:58 [NETWORK]       verbose: Started gossip block validation blockSlot=451654, blockRoot=0x1b4a2d800aa8115092255e9d031484d7ec0178fd695ce9c0d158ca4f875b6b09\r\n2020-10-06 13:31:04 [NETWORK]          warn: Ignoring gossip block reason=missing parent, blockSlot=451654, blockRoot=0x1b4a2d800aa8115092255e9d031484d7ec0178fd695ce9c0d158ca4f875b6b09, parent=0x64a512548ec81c0b0cbd4dfa59fe6ded38653a5aec465203b051dde0df0fba87\r\n2020-10-06 13:32:25 [CHAIN]            ^[[32minfo^[[39m: @@@ runStateTransition451654  - duration=1189ms\r\n```\r\n\r\nin most of the cases, we should be able to get preState right from the state cache using attestation data `beaconBlockRoot` + forkchoice instead of always starting from targetCheckpoint and process until block slot using regen module",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/704167515/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/704185802",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/1637#issuecomment-704185802",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/1637",
    "id": 704185802,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcwNDE4NTgwMg==",
    "user": {
      "login": "mpetrunic",
      "id": 8836210,
      "node_id": "MDQ6VXNlcjg4MzYyMTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8836210?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mpetrunic",
      "html_url": "https://github.com/mpetrunic",
      "followers_url": "https://api.github.com/users/mpetrunic/followers",
      "following_url": "https://api.github.com/users/mpetrunic/following{/other_user}",
      "gists_url": "https://api.github.com/users/mpetrunic/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mpetrunic/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mpetrunic/subscriptions",
      "organizations_url": "https://api.github.com/users/mpetrunic/orgs",
      "repos_url": "https://api.github.com/users/mpetrunic/repos",
      "events_url": "https://api.github.com/users/mpetrunic/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mpetrunic/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-10-06T10:44:22Z",
    "updated_at": "2020-10-06T10:44:22Z",
    "author_association": "MEMBER",
    "body": "Why isn't there profile log for 45s? Also I see there are logs \r\n\r\nHard to debug those stuff, I would say we have some bug so we are stuck in a loop somewhere since we didn't process epoch transition here I doubt we hit some performance issue. Maybe keep chrome profiller attached and start it once you encounter stuff like that so we know in what loop we are stuck.",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/704185802/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/704210229",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/1637#issuecomment-704210229",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/1637",
    "id": 704210229,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcwNDIxMDIyOQ==",
    "user": {
      "login": "tuyennhv",
      "id": 10568965,
      "node_id": "MDQ6VXNlcjEwNTY4OTY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tuyennhv",
      "html_url": "https://github.com/tuyennhv",
      "followers_url": "https://api.github.com/users/tuyennhv/followers",
      "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
      "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
      "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
      "repos_url": "https://api.github.com/users/tuyennhv/repos",
      "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-10-06T11:37:51Z",
    "updated_at": "2020-10-06T11:38:35Z",
    "author_association": "CONTRIBUTOR",
    "body": "> Why isn't there profile log for 45s? Also I see there are logs\r\n\r\nI guess the `logger.profile` string is not unique and we call these function  multiple times at the same time, maybe we have to attach a hex root to it and monitor again\r\n\r\n\r\n> Maybe keep chrome profiller attached and start it once you encounter stuff like that so we know in what loop we are stuck.\r\n\r\nyeah will do that",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/704210229/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/705321738",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/1637#issuecomment-705321738",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/1637",
    "id": 705321738,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcwNTMyMTczOA==",
    "user": {
      "login": "tuyennhv",
      "id": 10568965,
      "node_id": "MDQ6VXNlcjEwNTY4OTY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tuyennhv",
      "html_url": "https://github.com/tuyennhv",
      "followers_url": "https://api.github.com/users/tuyennhv/followers",
      "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
      "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
      "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
      "repos_url": "https://api.github.com/users/tuyennhv/repos",
      "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-10-08T04:29:53Z",
    "updated_at": "2020-10-08T04:29:53Z",
    "author_association": "CONTRIBUTOR",
    "body": "So the AggregateAndProof repository `removeIncluded()` api caused the issue.\r\n\r\n<img width=\"389\" alt=\"Screen Shot 2020-10-08 at 11 22 40\" src=\"https://user-images.githubusercontent.com/10568965/95414755-c4e44b80-0958-11eb-87ef-1679403993bc.png\">\r\n\r\nOne example of it in my db is we have 300 items in db, then we try to remove 128 of them then it'll loop `300*128=38400` times calling `config.types.Attestation.equal()` and it logs out 46s for everything (maybe there are some operations in the middle as this is 2 await calls but most of them is due to this code).\r\n\r\nAlso the `removeIncluded` itself was not implemented correctly, it based on `findIndex` resulting a number instead of boolean so most of the time it'll remove all items it had per block processing. If we correct that, the situation is worse.\r\n\r\nWe need to:\r\n+ Improve `removeIncluded`\r\n+ Call `removeOld` per finalized epoch",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/705321738/reactions",
      "total_count": 4,
      "+1": 2,
      "-1": 0,
      "laugh": 1,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 1
    },
    "performed_via_github_app": null
  }
]
