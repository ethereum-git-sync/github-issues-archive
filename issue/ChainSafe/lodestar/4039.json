{
  "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4039",
  "repository_url": "https://api.github.com/repos/ChainSafe/lodestar",
  "labels_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4039/labels{/name}",
  "comments_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4039/comments",
  "events_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4039/events",
  "html_url": "https://github.com/ChainSafe/lodestar/issues/4039",
  "id": 1241818053,
  "node_id": "I_kwDOCD5_Gc5KBKPF",
  "number": 4039,
  "title": "Computing proposers is not cached",
  "user": {
    "login": "wemeetagain",
    "id": 1348242,
    "node_id": "MDQ6VXNlcjEzNDgyNDI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1348242?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/wemeetagain",
    "html_url": "https://github.com/wemeetagain",
    "followers_url": "https://api.github.com/users/wemeetagain/followers",
    "following_url": "https://api.github.com/users/wemeetagain/following{/other_user}",
    "gists_url": "https://api.github.com/users/wemeetagain/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/wemeetagain/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/wemeetagain/subscriptions",
    "organizations_url": "https://api.github.com/users/wemeetagain/orgs",
    "repos_url": "https://api.github.com/users/wemeetagain/repos",
    "events_url": "https://api.github.com/users/wemeetagain/events{/privacy}",
    "received_events_url": "https://api.github.com/users/wemeetagain/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1200090447,
      "node_id": "MDU6TGFiZWwxMjAwMDkwNDQ3",
      "url": "https://api.github.com/repos/ChainSafe/lodestar/labels/prio-high",
      "name": "prio-high",
      "color": "fd9579",
      "default": false,
      "description": "Resolve issues as soon as possible."
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2022-05-19T13:50:19Z",
  "updated_at": "2022-12-24T06:10:00Z",
  "closed_at": "2022-12-24T06:09:30Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "@dapplion this won't cache though, and on every request to get next proposers, the `this.proposersNextEpoch.computed` check [here](https://github.com/ChainSafe/lodestar/pull/3782/files/ab35439d7109101dc162cb997c42c7f7be454843#diff-3e6d2b0cf933b99848484935101c7016da5a077e85ca7e16fa132d86a202ab91R556) will always return false, and the `if` branch check always run.\r\n\r\nYou can confirm this by running the application, and trigger the end point multiple times, the if branch will always run.\r\n\r\nI noticed this while working on the implementation and I think the reason why this is the case is how the `chain.getHeadStateAtCurrentEpoch` [here](https://github.com/ChainSafe/lodestar/pull/3782/files/ab35439d7109101dc162cb997c42c7f7be454843#diff-b909bf67569ad6ffedfbd4ebe6c611c60e828d24b1e5d04fbafb058abc4eba50R279) works, but I did not go ahead with caching when I realised that the request to the endpoint itself was actually pretty fast and no need to even cache.\r\n\r\n_Originally posted by @dadepo in https://github.com/ChainSafe/lodestar/pull/3782#discussion_r874667682_",
  "closed_by": {
    "login": "dapplion",
    "id": 35266934,
    "node_id": "MDQ6VXNlcjM1MjY2OTM0",
    "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/dapplion",
    "html_url": "https://github.com/dapplion",
    "followers_url": "https://api.github.com/users/dapplion/followers",
    "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
    "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
    "organizations_url": "https://api.github.com/users/dapplion/orgs",
    "repos_url": "https://api.github.com/users/dapplion/repos",
    "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
    "received_events_url": "https://api.github.com/users/dapplion/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4039/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4039/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1131792408",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/4039#issuecomment-1131792408",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4039",
    "id": 1131792408,
    "node_id": "IC_kwDOCD5_Gc5DdcgY",
    "user": {
      "login": "dadepo",
      "id": 272535,
      "node_id": "MDQ6VXNlcjI3MjUzNQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/272535?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dadepo",
      "html_url": "https://github.com/dadepo",
      "followers_url": "https://api.github.com/users/dadepo/followers",
      "following_url": "https://api.github.com/users/dadepo/following{/other_user}",
      "gists_url": "https://api.github.com/users/dadepo/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dadepo/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dadepo/subscriptions",
      "organizations_url": "https://api.github.com/users/dadepo/orgs",
      "repos_url": "https://api.github.com/users/dadepo/repos",
      "events_url": "https://api.github.com/users/dadepo/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dadepo/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-19T14:37:10Z",
    "updated_at": "2022-05-19T14:37:10Z",
    "author_association": "CONTRIBUTOR",
    "body": "Locally with the code modified as follows:\r\n\r\n```\r\n  getBeaconProposersNextEpoch(): ValidatorIndex[] {\r\n    if (!this.proposersNextEpoch.computed) {\r\n      console.log(\"should only console once. Current epoch is: \" + this.epoch);\r\n      const indexes = computeProposers(\r\n        this.proposersNextEpoch.seed,\r\n        this.nextShuffling,\r\n        this.effectiveBalanceIncrements\r\n      );\r\n      this.proposersNextEpoch = {computed: true, indexes};\r\n    }\r\n\r\n    return this.proposersNextEpoch.indexes;\r\n  }\r\n```\r\n\r\nAt current epoch of 94955, making repeated requests for proposers at 94956,  the console:\r\n\r\n```\r\nMay-19 16:34:06.001[]                 info: Synced - slot: 3038570 - head: 3038570 0x1879…e5c1 - finalized: 0x2b30…d099:94953 - peers: 10\r\nshould only console once. Current epoch is: 94955\r\nMay-19 16:34:18.001[]                 info: Synced - slot: 3038571 - head: 3038571 0x3517…6ea6 - finalized: 0x2b30…d099:94953 - peers: 9\r\nshould only console once. Current epoch is: 94955\r\nshould only console once. Current epoch is: 94955\r\nshould only console once. Current epoch is: 94955\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1131792408/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1364469684",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/4039#issuecomment-1364469684",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4039",
    "id": 1364469684,
    "node_id": "IC_kwDOCD5_Gc5RVCe0",
    "user": {
      "login": "dapplion",
      "id": 35266934,
      "node_id": "MDQ6VXNlcjM1MjY2OTM0",
      "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dapplion",
      "html_url": "https://github.com/dapplion",
      "followers_url": "https://api.github.com/users/dapplion/followers",
      "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
      "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
      "organizations_url": "https://api.github.com/users/dapplion/orgs",
      "repos_url": "https://api.github.com/users/dapplion/repos",
      "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dapplion/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-24T06:09:30Z",
    "updated_at": "2022-12-24T06:10:00Z",
    "author_association": "MEMBER",
    "body": "I tested this feature and was unable to request duties for the next epoch since this function throws for any slot ahead of the clock\r\n\r\nhttps://github.com/ChainSafe/lodestar/blob/ab35439d7109101dc162cb997c42c7f7be454843/packages/lodestar/src/api/impl/validator/index.ts#L277\r\n\r\n@dadepo How were you able to test the feature? That check has always been there \r\n\r\n- After fixing it with this PR https://github.com/ChainSafe/lodestar/pull/4941\r\n \r\nCaching works fine, adding manually a console.log I can see that next proposers is computed only once for repeated calls through that epoch. So closing the issue",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1364469684/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
