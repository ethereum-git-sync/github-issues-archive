{
  "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5315",
  "repository_url": "https://api.github.com/repos/ChainSafe/lodestar",
  "labels_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5315/labels{/name}",
  "comments_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5315/comments",
  "events_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5315/events",
  "html_url": "https://github.com/ChainSafe/lodestar/issues/5315",
  "id": 1643899949,
  "node_id": "I_kwDOCD5_Gc5h--wt",
  "number": 5315,
  "title": "Default validator HTTP request timeout is too short",
  "user": {
    "login": "nflaig",
    "id": 38436224,
    "node_id": "MDQ6VXNlcjM4NDM2MjI0",
    "avatar_url": "https://avatars.githubusercontent.com/u/38436224?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/nflaig",
    "html_url": "https://github.com/nflaig",
    "followers_url": "https://api.github.com/users/nflaig/followers",
    "following_url": "https://api.github.com/users/nflaig/following{/other_user}",
    "gists_url": "https://api.github.com/users/nflaig/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/nflaig/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/nflaig/subscriptions",
    "organizations_url": "https://api.github.com/users/nflaig/orgs",
    "repos_url": "https://api.github.com/users/nflaig/repos",
    "events_url": "https://api.github.com/users/nflaig/events{/privacy}",
    "received_events_url": "https://api.github.com/users/nflaig/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1478321239,
      "node_id": "MDU6TGFiZWwxNDc4MzIxMjM5",
      "url": "https://api.github.com/repos/ChainSafe/lodestar/labels/meta-discussion",
      "name": "meta-discussion",
      "color": "a6bddb",
      "default": false,
      "description": "Indicates a topic that requires input from various developers."
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2023-03-28T12:59:09Z",
  "updated_at": "2023-03-31T21:19:13Z",
  "closed_at": "2023-03-31T21:19:13Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "At the moment all HTTP requests done by the VC have a timeout of `SECONDS_PER_SLOT` (12 seconds).\r\n\r\nhttps://github.com/ChainSafe/lodestar/blob/f136f952ddb861976b3cc9484914c49a06ee8d90/packages/validator/src/validator.ts#L83-L84\r\n\r\nMost of the time the HTTP request timeout does not matter at all as we expect that the BN responds within few milliseconds but there might be unexpected network issues and we should account for this.\r\n\r\nIt should be allowed to take longer than the current slot for attestation tasks as late submission of attestations is still acceptable, it will just not give as good rewards but it is still better than completely missing the attestation due to the timeout.\r\nSee [Rewards and Penalties](https://kb.beaconcha.in/rewards-and-penalties).\r\n\r\nThe current timeout also does not really make sense, if a HTTP request is sent at 2/3 of the slot to `getAggregatedAttestation` it would mean the timeout happens after the slot is already over (20 seconds).\r\n\r\n**Current behavior**\r\n\r\nVC has a default HTTP timeout of `SECONDS_PER_SLOT` which could potentially cause missed attestations.\r\n\r\n**Expected behavior**\r\n\r\nVC should account for network issues and have a higher timeout, potentially something like `SECONDS_PER_SLOT * 5` (60 seconds). Timeout should be chosen based on [Attestation Reward Scale](https://www.attestant.io/posts/defining-attestation-effectiveness/) and technical implications of keeping the HTTP request open for too long.\r\n\r\nRelated https://github.com/ChainSafe/lodestar/issues/5314",
  "closed_by": {
    "login": "wemeetagain",
    "id": 1348242,
    "node_id": "MDQ6VXNlcjEzNDgyNDI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1348242?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/wemeetagain",
    "html_url": "https://github.com/wemeetagain",
    "followers_url": "https://api.github.com/users/wemeetagain/followers",
    "following_url": "https://api.github.com/users/wemeetagain/following{/other_user}",
    "gists_url": "https://api.github.com/users/wemeetagain/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/wemeetagain/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/wemeetagain/subscriptions",
    "organizations_url": "https://api.github.com/users/wemeetagain/orgs",
    "repos_url": "https://api.github.com/users/wemeetagain/repos",
    "events_url": "https://api.github.com/users/wemeetagain/events{/privacy}",
    "received_events_url": "https://api.github.com/users/wemeetagain/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5315/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5315/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1489543295",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/5315#issuecomment-1489543295",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5315",
    "id": 1489543295,
    "node_id": "IC_kwDOCD5_Gc5YyKB_",
    "user": {
      "login": "dapplion",
      "id": 35266934,
      "node_id": "MDQ6VXNlcjM1MjY2OTM0",
      "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dapplion",
      "html_url": "https://github.com/dapplion",
      "followers_url": "https://api.github.com/users/dapplion/followers",
      "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
      "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
      "organizations_url": "https://api.github.com/users/dapplion/orgs",
      "repos_url": "https://api.github.com/users/dapplion/repos",
      "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dapplion/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-30T01:11:19Z",
    "updated_at": "2023-03-30T01:11:19Z",
    "author_association": "MEMBER",
    "body": "With current approach timeouts have two impacts:\r\n- (most important IMO) reporting to the user something is wrong + metrics\r\n- limit concurrent active requests\r\n\r\nOnce an HTTP request is sent it's sent. Timeouts should not have a huge impact to normal functioning. If in a specific setup the timeout of SECONDS_PER_SLOT feels short.. I think the setup is not ok, requests must be fast for a validator to function properly. Increasing the timeout just seems like giving bad setups a pass for no clear benefit",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1489543295/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1490840172",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/5315#issuecomment-1490840172",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5315",
    "id": 1490840172,
    "node_id": "IC_kwDOCD5_Gc5Y3Gps",
    "user": {
      "login": "nflaig",
      "id": 38436224,
      "node_id": "MDQ6VXNlcjM4NDM2MjI0",
      "avatar_url": "https://avatars.githubusercontent.com/u/38436224?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nflaig",
      "html_url": "https://github.com/nflaig",
      "followers_url": "https://api.github.com/users/nflaig/followers",
      "following_url": "https://api.github.com/users/nflaig/following{/other_user}",
      "gists_url": "https://api.github.com/users/nflaig/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nflaig/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nflaig/subscriptions",
      "organizations_url": "https://api.github.com/users/nflaig/orgs",
      "repos_url": "https://api.github.com/users/nflaig/repos",
      "events_url": "https://api.github.com/users/nflaig/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nflaig/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-30T19:41:30Z",
    "updated_at": "2023-03-30T19:41:30Z",
    "author_association": "MEMBER",
    "body": "12 seconds is definitely not short, I even chose a [shorter timeout (10s)](https://github.com/ChainSafe/lodestar/blob/a2f749a6f08d5b8f6d1c52147b08f71d48f7abe2/packages/beacon-node/src/monitoring/options.ts#L18) for the monitoring which sends data to a remote service which is most of the time not the case for VC  <> BN requests.\r\n\r\nBut the reasoning behind choosing `SECONDS_PER_SLOT` seems wrong to me, especially because we are not sending http request at the beginning of the slot but rather at 1/3 or 2/3 of the slot.\r\n\r\nhttps://github.com/ChainSafe/lodestar/blob/f136f952ddb861976b3cc9484914c49a06ee8d90/packages/validator/src/validator.ts#L83\r\n\r\nFor attestations and sync committee messages this comment is just not true, even if we take much longer than the slot it would still be rewarded (see [Attestation Reward Scale](https://www.attestant.io/posts/defining-attestation-effectiveness/)).\r\n\r\nI totally agree with what you said but we need to be more precise on why we chose a specific timeout here, I think technical implications should be the priority. Using other parameters such as `SECONDS_PER_SLOT` does not make sense to me, there are other tasks that need to be done during a slot and usually involves multiple HTTP requests.\r\n\r\nFinally, what happens if `SECONDS_PER_SLOT` has a lower value due to different chain configuration, lets say 6 seconds, why should http request now timeout ealier? does this change anything related to the setup or network latency?\r\n\r\nTo conclude, I would be in favor of using a fixed timeout (maybe configurable) here instead of making it dependent on `SECONDS_PER_SLOT`. I would be even fine with 10 seconds to be honest it is just important that we chose the value based on technical implications (metrics, limit concurrent active requests, etc.)",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1490840172/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1490877541",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/5315#issuecomment-1490877541",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5315",
    "id": 1490877541,
    "node_id": "IC_kwDOCD5_Gc5Y3Pxl",
    "user": {
      "login": "nflaig",
      "id": 38436224,
      "node_id": "MDQ6VXNlcjM4NDM2MjI0",
      "avatar_url": "https://avatars.githubusercontent.com/u/38436224?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nflaig",
      "html_url": "https://github.com/nflaig",
      "followers_url": "https://api.github.com/users/nflaig/followers",
      "following_url": "https://api.github.com/users/nflaig/following{/other_user}",
      "gists_url": "https://api.github.com/users/nflaig/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nflaig/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nflaig/subscriptions",
      "organizations_url": "https://api.github.com/users/nflaig/orgs",
      "repos_url": "https://api.github.com/users/nflaig/repos",
      "events_url": "https://api.github.com/users/nflaig/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nflaig/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-30T20:04:52Z",
    "updated_at": "2023-03-30T20:38:27Z",
    "author_association": "MEMBER",
    "body": "interesting approach used by Lighthouse, they seem to [adjust the timeout based on task](https://github.com/sigp/lighthouse/blob/a53830fd60a119bf3f659b253360af8027128e83/validator_client/src/lib.rs#L294), see https://github.com/sigp/lighthouse/pull/2352. Seems to be mostly relevant when a fallback BN is configured.\r\nAnd it looks like the also use [slot duration](https://github.com/sigp/lighthouse/blob/a53830fd60a119bf3f659b253360af8027128e83/validator_client/src/lib.rs#L310) as default timeout.",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1490877541/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1491316440",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/5315#issuecomment-1491316440",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5315",
    "id": 1491316440,
    "node_id": "IC_kwDOCD5_Gc5Y467Y",
    "user": {
      "login": "dapplion",
      "id": 35266934,
      "node_id": "MDQ6VXNlcjM1MjY2OTM0",
      "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dapplion",
      "html_url": "https://github.com/dapplion",
      "followers_url": "https://api.github.com/users/dapplion/followers",
      "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
      "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
      "organizations_url": "https://api.github.com/users/dapplion/orgs",
      "repos_url": "https://api.github.com/users/dapplion/repos",
      "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dapplion/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-31T05:26:11Z",
    "updated_at": "2023-03-31T05:26:11Z",
    "author_association": "MEMBER",
    "body": "Using SECONDS_PER_SLOT is arbitrary but any number will feel arbitrary. Picking this number is the least random value, as faster networks should have faster values",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1491316440/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1491798830",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/5315#issuecomment-1491798830",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5315",
    "id": 1491798830,
    "node_id": "IC_kwDOCD5_Gc5Y6wsu",
    "user": {
      "login": "nflaig",
      "id": 38436224,
      "node_id": "MDQ6VXNlcjM4NDM2MjI0",
      "avatar_url": "https://avatars.githubusercontent.com/u/38436224?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nflaig",
      "html_url": "https://github.com/nflaig",
      "followers_url": "https://api.github.com/users/nflaig/followers",
      "following_url": "https://api.github.com/users/nflaig/following{/other_user}",
      "gists_url": "https://api.github.com/users/nflaig/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nflaig/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nflaig/subscriptions",
      "organizations_url": "https://api.github.com/users/nflaig/orgs",
      "repos_url": "https://api.github.com/users/nflaig/repos",
      "events_url": "https://api.github.com/users/nflaig/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nflaig/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-31T11:40:40Z",
    "updated_at": "2023-03-31T11:40:40Z",
    "author_association": "MEMBER",
    "body": "Thanks @dapplion for the rationale. Sounds good to me 👍 ",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1491798830/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
