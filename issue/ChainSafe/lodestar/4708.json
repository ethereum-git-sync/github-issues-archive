{
  "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4708",
  "repository_url": "https://api.github.com/repos/ChainSafe/lodestar",
  "labels_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4708/labels{/name}",
  "comments_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4708/comments",
  "events_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4708/events",
  "html_url": "https://github.com/ChainSafe/lodestar/issues/4708",
  "id": 1430423470,
  "node_id": "I_kwDOCD5_Gc5VQoeu",
  "number": 4708,
  "title": "Allow Lodestar to Continue Running After PROTO_ARRAY_INVALID_LVH_EXECUTION_RESPONSE",
  "user": {
    "login": "SeaMonkey82",
    "id": 20866869,
    "node_id": "MDQ6VXNlcjIwODY2ODY5",
    "avatar_url": "https://avatars.githubusercontent.com/u/20866869?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/SeaMonkey82",
    "html_url": "https://github.com/SeaMonkey82",
    "followers_url": "https://api.github.com/users/SeaMonkey82/followers",
    "following_url": "https://api.github.com/users/SeaMonkey82/following{/other_user}",
    "gists_url": "https://api.github.com/users/SeaMonkey82/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/SeaMonkey82/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/SeaMonkey82/subscriptions",
    "organizations_url": "https://api.github.com/users/SeaMonkey82/orgs",
    "repos_url": "https://api.github.com/users/SeaMonkey82/repos",
    "events_url": "https://api.github.com/users/SeaMonkey82/events{/privacy}",
    "received_events_url": "https://api.github.com/users/SeaMonkey82/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 4116885308,
      "node_id": "LA_kwDOCD5_Gc71Yq88",
      "url": "https://api.github.com/repos/ChainSafe/lodestar/labels/scope-ux",
      "name": "scope-ux",
      "color": "980043",
      "default": false,
      "description": "Issues for CLI UX or general consumer UX."
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2022-10-31T20:04:41Z",
  "updated_at": "2023-05-29T07:30:46Z",
  "closed_at": "2023-05-29T07:30:46Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "The current behavior of Lodestar is to exit if the EL client is attempting to invalidate a previously valid block and `PROTO_ARRAY_INVALID_LVH_EXECUTION_RESPONSE` is encountered.  I think Lodestar should continue to run and produce errors as opposed to exiting entirely.  That way, once the issue with the EL has been resolved, Lodestar can resume syncing without any further interaction.\r\n\r\nHere is a log of the current behavior.\r\n\r\n```\r\nOct-31 15:38:19.336[chain]           error: Block error slot=4219531 code=BLOCK_ERROR_EXECUTION_ERROR, execStatus=INVALID, errorMessage=Block already present in bad block manager.\r\nError: BLOCK_ERROR_EXECUTION_ERROR\r\n    at verifyBlockExecutionPayload (file:///home/seamonkey/Downloads/goerli/lodestar/packages/beacon-node/src/chain/blocks/verifyBlocksExecutionPayloads.ts:292:25)\r\n    at runMicrotasks (<anonymous>)\r\n    at processTicksAndRejections (node:internal/process/task_queues:96:5)\r\n    at verifyBlocksExecutionPayload (file:///home/seamonkey/Downloads/goerli/lodestar/packages/beacon-node/src/chain/blocks/verifyBlocksExecutionPayloads.ts:151:28)\r\n    at async Promise.all (index 2)\r\n    at BeaconChain.verifyBlocksInEpoch (file:///home/seamonkey/Downloads/goerli/lodestar/packages/beacon-node/src/chain/blocks/verifyBlock.ts:67:72)\r\n    at BeaconChain.processBlocks (file:///home/seamonkey/Downloads/goerli/lodestar/packages/beacon-node/src/chain/blocks/index.ts:71:68)\r\n    at JobItemQueue.runJob (file:///home/seamonkey/Downloads/goerli/lodestar/packages/beacon-node/src/util/queue/itemQueue.ts:92:22)\r\nOct-31 15:38:20.099[chain]           error: Failed to run prepareForNextSlot nextEpoch=132128, isEpochTransition=false, prepareSlot=4228092 code=PROTO_ARRAY_INVALID_LVH_EXECUTION_RESPONSE, lvhCode=ValidToInvalid, blockRoot=0xbcc5e6a208351b4aef9e6ab56e79a553900677a0b1dff4ded201c27871e5cee0, execHash=0x78a8667d2be1e381b02650e45df7eb8250735b075592466fd94d205b87580398\r\nError: PROTO_ARRAY_INVALID_LVH_EXECUTION_RESPONSE\r\n    at ProtoArray.findHead (file:///home/seamonkey/Downloads/goerli/lodestar/packages/fork-choice/src/protoArray/protoArray.ts:457:13)\r\n    at ForkChoice.updateHead (file:///home/seamonkey/Downloads/goerli/lodestar/packages/fork-choice/src/forkChoice/forkChoice.ts:230:38)\r\n    at BeaconChain.recomputeForkChoiceHead (file:///home/seamonkey/Downloads/goerli/lodestar/packages/beacon-node/src/chain/chain.ts:412:30)\r\n    at ChainEventEmitter.PrepareNextSlotScheduler.prepareForNextSlot (file:///home/seamonkey/Downloads/goerli/lodestar/packages/beacon-node/src/chain/prepareNextSlot.ts:75:64)\r\nOct-31 15:38:24.307[]                error: Process shutdown requested  code=PROTO_ARRAY_INVALID_LVH_EXECUTION_RESPONSE, lvhCode=ValidToInvalid, blockRoot=0xbcc5e6a208351b4aef9e6ab56e79a553900677a0b1dff4ded201c27871e5cee0, execHash=0x78a8667d2be1e381b02650e45df7eb8250735b075592466fd94d205b87580398\r\nError: PROTO_ARRAY_INVALID_LVH_EXECUTION_RESPONSE\r\n    at ProtoArray.invalidateNodeByIndex (file:///home/seamonkey/Downloads/goerli/lodestar/packages/fork-choice/src/protoArray/protoArray.ts:421:13)\r\n    at ProtoArray.validateLatestHash (file:///home/seamonkey/Downloads/goerli/lodestar/packages/fork-choice/src/protoArray/protoArray.ts:318:14)\r\n    at ForkChoice.validateLatestHash (file:///home/seamonkey/Downloads/goerli/lodestar/packages/fork-choice/src/forkChoice/forkChoice.ts:787:23)\r\n    at BeaconChain.processBlocks (file:///home/seamonkey/Downloads/goerli/lodestar/packages/beacon-node/src/chain/blocks/index.ts:82:25)\r\n    at runMicrotasks (<anonymous>)\r\n    at processTicksAndRejections (node:internal/process/task_queues:96:5)\r\n    at JobItemQueue.runJob (file:///home/seamonkey/Downloads/goerli/lodestar/packages/beacon-node/src/util/queue/itemQueue.ts:92:22)\r\nOct-31 15:38:24.365[]                 info: Stopping gracefully, use Ctrl+C again to force process exit\r\n```\r\n",
  "closed_by": {
    "login": "g11tech",
    "id": 76567250,
    "node_id": "MDQ6VXNlcjc2NTY3MjUw",
    "avatar_url": "https://avatars.githubusercontent.com/u/76567250?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/g11tech",
    "html_url": "https://github.com/g11tech",
    "followers_url": "https://api.github.com/users/g11tech/followers",
    "following_url": "https://api.github.com/users/g11tech/following{/other_user}",
    "gists_url": "https://api.github.com/users/g11tech/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/g11tech/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/g11tech/subscriptions",
    "organizations_url": "https://api.github.com/users/g11tech/orgs",
    "repos_url": "https://api.github.com/users/g11tech/repos",
    "events_url": "https://api.github.com/users/g11tech/events{/privacy}",
    "received_events_url": "https://api.github.com/users/g11tech/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4708/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4708/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1303963018",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/4708#issuecomment-1303963018",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4708",
    "id": 1303963018,
    "node_id": "IC_kwDOCD5_Gc5NuOWK",
    "user": {
      "login": "dapplion",
      "id": 35266934,
      "node_id": "MDQ6VXNlcjM1MjY2OTM0",
      "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dapplion",
      "html_url": "https://github.com/dapplion",
      "followers_url": "https://api.github.com/users/dapplion/followers",
      "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
      "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
      "organizations_url": "https://api.github.com/users/dapplion/orgs",
      "repos_url": "https://api.github.com/users/dapplion/repos",
      "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dapplion/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-11-04T18:07:19Z",
    "updated_at": "2022-11-04T18:07:19Z",
    "author_association": "MEMBER",
    "body": "@g11tech can review but I think this is an un-recoverable error. Killing the process allows Lodestar to drop the in-memory fork-choice structure and retry + alert node runners that the process is a very unhealthy state since it's restarting",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1303963018/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1304418650",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/4708#issuecomment-1304418650",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4708",
    "id": 1304418650,
    "node_id": "IC_kwDOCD5_Gc5Nv9la",
    "user": {
      "login": "g11tech",
      "id": 76567250,
      "node_id": "MDQ6VXNlcjc2NTY3MjUw",
      "avatar_url": "https://avatars.githubusercontent.com/u/76567250?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/g11tech",
      "html_url": "https://github.com/g11tech",
      "followers_url": "https://api.github.com/users/g11tech/followers",
      "following_url": "https://api.github.com/users/g11tech/following{/other_user}",
      "gists_url": "https://api.github.com/users/g11tech/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/g11tech/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/g11tech/subscriptions",
      "organizations_url": "https://api.github.com/users/g11tech/orgs",
      "repos_url": "https://api.github.com/users/g11tech/repos",
      "events_url": "https://api.github.com/users/g11tech/events{/privacy}",
      "received_events_url": "https://api.github.com/users/g11tech/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-11-05T06:06:01Z",
    "updated_at": "2022-11-05T06:06:01Z",
    "author_association": "CONTRIBUTOR",
    "body": "Yea we had a discussion about this in discord, will see if in some conditions we can also just reject the block (and the forkchoice statuses have not yet been fipped)",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1304418650/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1566688483",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/4708#issuecomment-1566688483",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4708",
    "id": 1566688483,
    "node_id": "IC_kwDOCD5_Gc5dYcTj",
    "user": {
      "login": "g11tech",
      "id": 76567250,
      "node_id": "MDQ6VXNlcjc2NTY3MjUw",
      "avatar_url": "https://avatars.githubusercontent.com/u/76567250?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/g11tech",
      "html_url": "https://github.com/g11tech",
      "followers_url": "https://api.github.com/users/g11tech/followers",
      "following_url": "https://api.github.com/users/g11tech/following{/other_user}",
      "gists_url": "https://api.github.com/users/g11tech/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/g11tech/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/g11tech/subscriptions",
      "organizations_url": "https://api.github.com/users/g11tech/orgs",
      "repos_url": "https://api.github.com/users/g11tech/repos",
      "events_url": "https://api.github.com/users/g11tech/events{/privacy}",
      "received_events_url": "https://api.github.com/users/g11tech/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-29T07:30:46Z",
    "updated_at": "2023-05-29T07:30:46Z",
    "author_association": "CONTRIBUTOR",
    "body": "Thought over and realized the best and least error prone option would be to throw away current forkchoice and sync from last synced, \r\n\r\nnow that lodestar always writes finalized state onto the disk from where it can begin re-sync on restarts, restarting lodestar which automatically throws away forkchoice and syncs from last available finalized state in disk (which is last finalized now) seems to be the cleanest and least technical debt solution.\r\n\r\nClosing for now, pls reopen if the issue author feels this still needs to be addressed",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1566688483/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
