{
  "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2878",
  "repository_url": "https://api.github.com/repos/ChainSafe/lodestar",
  "labels_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2878/labels{/name}",
  "comments_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2878/comments",
  "events_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2878/events",
  "html_url": "https://github.com/ChainSafe/lodestar/issues/2878",
  "id": 951249746,
  "node_id": "MDU6SXNzdWU5NTEyNDk3NDY=",
  "number": 2878,
  "title": "[altair-devnet-1] Invalid SyncCommitteeMessage",
  "user": {
    "login": "tuyennhv",
    "id": 10568965,
    "node_id": "MDQ6VXNlcjEwNTY4OTY1",
    "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tuyennhv",
    "html_url": "https://github.com/tuyennhv",
    "followers_url": "https://api.github.com/users/tuyennhv/followers",
    "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
    "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
    "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
    "repos_url": "https://api.github.com/users/tuyennhv/repos",
    "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 2159934357,
      "node_id": "MDU6TGFiZWwyMTU5OTM0MzU3",
      "url": "https://api.github.com/repos/ChainSafe/lodestar/labels/scope-testnet-debugging",
      "name": "scope-testnet-debugging",
      "color": "980043",
      "default": false,
      "description": "Issues uncovered through running a node on a public testnet."
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "tuyennhv",
    "id": 10568965,
    "node_id": "MDQ6VXNlcjEwNTY4OTY1",
    "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tuyennhv",
    "html_url": "https://github.com/tuyennhv",
    "followers_url": "https://api.github.com/users/tuyennhv/followers",
    "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
    "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
    "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
    "repos_url": "https://api.github.com/users/tuyennhv/repos",
    "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "tuyennhv",
      "id": 10568965,
      "node_id": "MDQ6VXNlcjEwNTY4OTY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tuyennhv",
      "html_url": "https://github.com/tuyennhv",
      "followers_url": "https://api.github.com/users/tuyennhv/followers",
      "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
      "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
      "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
      "repos_url": "https://api.github.com/users/tuyennhv/repos",
      "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2021-07-23T04:56:17Z",
  "updated_at": "2021-07-27T14:41:45Z",
  "closed_at": "2021-07-27T14:41:45Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "**Describe the bug**\r\n\r\nAdrian from teku informed us some invalid SyncCommitteeMessage\r\n+ SyncCommitteeMessage 1\r\n```\r\n0xffbf0000000000004e7486693bcc3fd5ec59638782a477efee8b4e746bb730ef2f0402a7dd067b29e401000000000000b64596cc72f57a3d036fe7609ef03fb8bc99e549a23ecadd8a3757b8907161e8616ddffa102fe7267550aea3ebe88ae112410ef75e631800e3806d3f1b877848be49749d492d410180c1c06d16c3b3a4e09f6803203ae548a58e33f6f869a3e6\r\n```\r\n```json\r\nslot: '49151'\r\nbeaconBlockRoot: '0x4e7486693bcc3fd5ec59638782a477efee8b4e746bb730ef2f0402a7dd067b29'\r\nvalidatorIndex: '484'\r\nsignature: >-\r\n  0xb64596cc72f57a3d036fe7609ef03fb8bc99e549a23ecadd8a3757b8907161e8616ddffa102fe7267550aea3ebe88ae112410ef75e631800e3806d3f1b877848be49749d492d410180c1c06d16c3b3a4e09f6803203ae548a58e33f6f869a3e6\r\n```\r\n+ SyncCommitteeMessage 2\r\n```\r\n0xffbf0000000000004e7486693bcc3fd5ec59638782a477efee8b4e746bb730ef2f0402a7dd067b29ce00000000000000b210c73d5b751e537d815657e8f0f356c8142a7e5c37abc619f2f0dfec2e03218295f349daddadc3e081bba192ebb47e10ce5afde48fdca8f59771dd81f05da958541848250eac6da4fa82c2ce2afaab8232cdded6ff4d03f523775d9241db13\r\n```\r\n```json\r\nslot: '49151'\r\nbeaconBlockRoot: '0x4e7486693bcc3fd5ec59638782a477efee8b4e746bb730ef2f0402a7dd067b29'\r\nvalidatorIndex: '206'\r\nsignature: >-\r\n  0xb210c73d5b751e537d815657e8f0f356c8142a7e5c37abc619f2f0dfec2e03218295f349daddadc3e081bba192ebb47e10ce5afde48fdca8f59771dd81f05da958541848250eac6da4fa82c2ce2afaab8232cdded6ff4d03f523775d9241db13\r\n```\r\n\r\n**Expected behavior**\r\n\r\nNeed to investigate why these messages pass our gossip validation from api before being spread to peers through gossip",
  "closed_by": {
    "login": "wemeetagain",
    "id": 1348242,
    "node_id": "MDQ6VXNlcjEzNDgyNDI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1348242?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/wemeetagain",
    "html_url": "https://github.com/wemeetagain",
    "followers_url": "https://api.github.com/users/wemeetagain/followers",
    "following_url": "https://api.github.com/users/wemeetagain/following{/other_user}",
    "gists_url": "https://api.github.com/users/wemeetagain/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/wemeetagain/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/wemeetagain/subscriptions",
    "organizations_url": "https://api.github.com/users/wemeetagain/orgs",
    "repos_url": "https://api.github.com/users/wemeetagain/repos",
    "events_url": "https://api.github.com/users/wemeetagain/events{/privacy}",
    "received_events_url": "https://api.github.com/users/wemeetagain/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2878/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2878/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/885463936",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/2878#issuecomment-885463936",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2878",
    "id": 885463936,
    "node_id": "IC_kwDOCD5_Gc40xxuA",
    "user": {
      "login": "tuyennhv",
      "id": 10568965,
      "node_id": "MDQ6VXNlcjEwNTY4OTY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tuyennhv",
      "html_url": "https://github.com/tuyennhv",
      "followers_url": "https://api.github.com/users/tuyennhv/followers",
      "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
      "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
      "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
      "repos_url": "https://api.github.com/users/tuyennhv/repos",
      "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-07-23T07:51:05Z",
    "updated_at": "2021-07-23T07:51:05Z",
    "author_association": "CONTRIBUTOR",
    "body": "some more logs for validator 206 (`0xa294f3656425d539753f610fac0e435d938027170934bbe631ce9b57dccb92dbda87c853e343924786accb7c9e551135`) at slot 49151:\r\n\r\n1. It signs a SyncCommitteeMessage: `Jul-22 07:50:16.013 []                ^[[34mdebug^[[39m: Signed SyncCommitteeMessage slot=49151, validator=0xa2       94…1135`\r\n2. Validator publish it to node `Jul-22 07:50:16.023 []                 ^[[32minfo^[[39m: Published SyncCommitteeMessage slot=49151, count=10`\r\n3. Node validates the signature of that SyncCommitteeMessage successfully (it should not if it's an invalid signature) and spread it to peers\r\n4. Node produces SyncCommitteeContribution: `Jul-22 07:50:20.004 []              ^[[36mverbose^[[39m: Producing SyncCommitteeContribution slot=49151, index=       0`\r\n5. Validator signs SyncCommitteeContribution: `Jul-22 07:50:20.008 []                ^[[34mdebug^[[39m: Signed SyncCommitteeContribution slot=49151, index=0,        validator=0x8fa0…a348`\r\n6. Only after this stage, node is not able to verify the aggregated signature of it `Jul-22 07:50:20.064 []                ^[[31merror^[[39m: Error publishing SyncCommitteeContribution slot=49151,        index=0 message=Internal Server Error: SYNC_COMMITTEE_INVALID_SIGNATURE`.  Node's log: `Jul-22 07:50:20.053 [API]             ^[[31merror^[[39m: Error on publishContributionAndProofs [0] slot=49151,         subCommitteeIndex=0 code=SYNC_COMMITTEE_INVALID_SIGNATURE`\r\n\r\n\r\nwhy our node can't detect the invalid signature at step 3 of SyncCommitteeMessage but SignedContributionAndProof at step 6? https://github.com/ChainSafe/lodestar/blob/7e00bf41d7fde59c9946150584596e1386465b68/packages/lodestar/src/api/impl/beacon/pool/index.ts#L127",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/885463936/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/886595255",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/2878#issuecomment-886595255",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2878",
    "id": 886595255,
    "node_id": "IC_kwDOCD5_Gc402F63",
    "user": {
      "login": "tuyennhv",
      "id": 10568965,
      "node_id": "MDQ6VXNlcjEwNTY4OTY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tuyennhv",
      "html_url": "https://github.com/tuyennhv",
      "followers_url": "https://api.github.com/users/tuyennhv/followers",
      "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
      "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
      "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
      "repos_url": "https://api.github.com/users/tuyennhv/repos",
      "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-07-26T10:55:37Z",
    "updated_at": "2021-07-26T10:55:37Z",
    "author_association": "CONTRIBUTOR",
    "body": "I was able to resync from genesis to get state 49151 and inspect its current and next sync committee.\r\n[preState_49151.zip](https://github.com/ChainSafe/lodestar/files/6876694/preState_49151.zip)\r\n\r\n+ note that slot 49151 belongs to the 49152 sync period so potentially it's an issue at the edge case\r\n+ the attached state shows that both validator 206 and 484 belong to `currentSyncCommittee` and `nextSyncCommittee`, for sure they are at different index in current and next committee\r\n+ due to this line of code, we send the SyncCommitteeMessage to the wrong subnet https://github.com/ChainSafe/lodestar/blob/d8f702b1cac0135cf94531a43f912fbbc34ef15f/packages/lodestar/src/api/impl/beacon/pool/index.ts#L120\r\n\r\nalso the ContributionAndProof invalid signature issue above is due to the wrong `currentSyncCommittee` usage https://github.com/ChainSafe/lodestar/blob/d8f702b1cac0135cf94531a43f912fbbc34ef15f/packages/lodestar/src/chain/validation/signatureSets/syncCommitteeContribution.ts#L43\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/886595255/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/886981989",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/2878#issuecomment-886981989",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2878",
    "id": 886981989,
    "node_id": "IC_kwDOCD5_Gc403kVl",
    "user": {
      "login": "dapplion",
      "id": 35266934,
      "node_id": "MDQ6VXNlcjM1MjY2OTM0",
      "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dapplion",
      "html_url": "https://github.com/dapplion",
      "followers_url": "https://api.github.com/users/dapplion/followers",
      "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
      "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
      "organizations_url": "https://api.github.com/users/dapplion/orgs",
      "repos_url": "https://api.github.com/users/dapplion/repos",
      "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dapplion/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-07-26T19:53:28Z",
    "updated_at": "2021-07-26T19:53:28Z",
    "author_association": "MEMBER",
    "body": "Oh so you mean we should still check if we are in the current or next sync committee instead of just using whatever head has",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/886981989/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/887163152",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/2878#issuecomment-887163152",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2878",
    "id": 887163152,
    "node_id": "IC_kwDOCD5_Gc404QkQ",
    "user": {
      "login": "tuyennhv",
      "id": 10568965,
      "node_id": "MDQ6VXNlcjEwNTY4OTY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tuyennhv",
      "html_url": "https://github.com/tuyennhv",
      "followers_url": "https://api.github.com/users/tuyennhv/followers",
      "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
      "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
      "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
      "repos_url": "https://api.github.com/users/tuyennhv/repos",
      "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-07-27T02:40:16Z",
    "updated_at": "2021-07-27T02:40:16Z",
    "author_association": "CONTRIBUTOR",
    "body": "> Oh so you mean we should still check if we are in the current or next sync committee instead of just using whatever head has\r\n\r\nyeah, we have that logic in SyncCommitteeMessage validation, just need to apply that same logic everywhere to make sure. Also the spec always does that, for example\r\n```python\r\nif compute_sync_committee_period(get_current_epoch(state)) == compute_sync_committee_period(next_slot_epoch):\r\n        sync_committee = state.current_sync_committee\r\n    else:\r\n        sync_committee = state.next_sync_committee\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/887163152/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
