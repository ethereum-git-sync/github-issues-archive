{
  "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/1701",
  "repository_url": "https://api.github.com/repos/ChainSafe/lodestar",
  "labels_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/1701/labels{/name}",
  "comments_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/1701/comments",
  "events_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/1701/events",
  "html_url": "https://github.com/ChainSafe/lodestar/issues/1701",
  "id": 728744248,
  "node_id": "MDU6SXNzdWU3Mjg3NDQyNDg=",
  "number": 1701,
  "title": "State regen causes OOM",
  "user": {
    "login": "tuyennhv",
    "id": 10568965,
    "node_id": "MDQ6VXNlcjEwNTY4OTY1",
    "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tuyennhv",
    "html_url": "https://github.com/tuyennhv",
    "followers_url": "https://api.github.com/users/tuyennhv/followers",
    "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
    "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
    "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
    "repos_url": "https://api.github.com/users/tuyennhv/repos",
    "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2020-10-24T08:57:41Z",
  "updated_at": "2020-10-30T06:04:13Z",
  "closed_at": "2020-10-30T06:04:13Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "**Describe the bug**\r\nSync to slot 578307 and regen state from 502561 which caused a huge block range to reprocess and OOM happened\r\n```\r\n2020-10-24 11:59:20 [CHAIN]           ^[[34mdebug^[[39m: Block processed slot=578307, root=0xf147a2017ddb16d89b       4e82e0f9097adde4ec6d8e63064177da59351f45819eef\r\n2020-10-24 11:59:24 [CHAIN]           ^[[34mdebug^[[39m: Block processed slot=502561, root=0xfe34181492bd5ae731       b03b39ade8e40ccb388d32cd4a9222a8b532848f22b10a\r\n2020-10-24 11:59:24 [CHAIN]           ^[[34mdebug^[[39m: Block processed slot=502562, root=0x9e0abf1d2cd25f241e       3415768ac3bbef11be0da78f5bd6f6bb2d85b33f8f4222\r\n...\r\n2020-10-24 12:00:08 [CHAIN]           ^[[34mdebug^[[39m: Block processed slot=502684, root=0xc6832f690a0b129728       e7ef322d999147e50d297ff4aa0e3aeb856b512bfecee9\r\n173099 2020-10-24 12:00:08 [CHAIN]           ^[[34mdebug^[[39m: Block processed slot=502687, root=0x5bce3c5f9d31986171       80ad012b8cd5b994b202df52d2dcd321c0c97170de21e1\r\n173100\r\n173101 <--- Last few GCs --->\r\n173102\r\n173103 [98471:0x10284d000] 16936548 ms: Mark-sweep 2004.3 (2067.5) -> 1988.3 (2067.5) MB, 1242.8 / 0.1 ms  (average mu        = 0.116, current mu = 0.029) allocation failure scavenge might not succeed\r\n173104 [98471:0x10284d000] 16937903 ms: Mark-sweep 2004.6 (2067.8) -> 1988.6 (2067.8) MB, 1318.9 / 0.1 ms  (average mu        = 0.072, current mu = 0.027) allocation failure scavenge might not succeed\r\n```\r\n\r\nNote that block 502558 formed the justified checkpoint earlier, that's the last cached state where regen started from.\r\n```\r\n2020-10-24 07:36:39 [CHAIN]         ^[[36mverbose^[[39m: Fork choice justified epoch=15705, root=0x66ba71dfb29b       ada27c3f99e9823dac4272ff1a057814d0672353358571cb0142\r\n```\r\n**Expected behavior**\r\nState regen should not cause OOM.\r\n",
  "closed_by": {
    "login": "tuyennhv",
    "id": 10568965,
    "node_id": "MDQ6VXNlcjEwNTY4OTY1",
    "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tuyennhv",
    "html_url": "https://github.com/tuyennhv",
    "followers_url": "https://api.github.com/users/tuyennhv/followers",
    "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
    "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
    "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
    "repos_url": "https://api.github.com/users/tuyennhv/repos",
    "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/1701/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/1701/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/716995892",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/1701#issuecomment-716995892",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/1701",
    "id": 716995892,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcxNjk5NTg5Mg==",
    "user": {
      "login": "tuyennhv",
      "id": 10568965,
      "node_id": "MDQ6VXNlcjEwNTY4OTY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tuyennhv",
      "html_url": "https://github.com/tuyennhv",
      "followers_url": "https://api.github.com/users/tuyennhv/followers",
      "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
      "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
      "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
      "repos_url": "https://api.github.com/users/tuyennhv/repos",
      "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-10-27T05:37:32Z",
    "updated_at": "2020-10-27T20:48:47Z",
    "author_association": "CONTRIBUTOR",
    "body": "> so I was able to reproduce another case where we synced up to slot 590113 and when it tried to get state for slot 589875 it had to regen (notice that I only have MAX_EPOCHS = 8  in the checkpoint state cache to easily reproduce)\r\nI notice that 589875 is the chain head so probably that came from attestation processor\r\nand it logged number of block to replay is 40511",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/716995892/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/719244081",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/1701#issuecomment-719244081",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/1701",
    "id": 719244081,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcxOTI0NDA4MQ==",
    "user": {
      "login": "tuyennhv",
      "id": 10568965,
      "node_id": "MDQ6VXNlcjEwNTY4OTY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tuyennhv",
      "html_url": "https://github.com/tuyennhv",
      "followers_url": "https://api.github.com/users/tuyennhv/followers",
      "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
      "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
      "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
      "repos_url": "https://api.github.com/users/tuyennhv/repos",
      "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-10-30T06:04:13Z",
    "updated_at": "2020-10-30T06:04:13Z",
    "author_association": "CONTRIBUTOR",
    "body": "didn't see this issue again in my latest sync after the above PR merged",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/719244081/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
