{
  "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5877",
  "repository_url": "https://api.github.com/repos/ChainSafe/lodestar",
  "labels_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5877/labels{/name}",
  "comments_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5877/comments",
  "events_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5877/events",
  "html_url": "https://github.com/ChainSafe/lodestar/issues/5877",
  "id": 1847613771,
  "node_id": "I_kwDOCD5_Gc5uIFlL",
  "number": 5877,
  "title": "Growing heap up to oom crash on Ethereum mainnet. v1.10.0",
  "user": {
    "login": "SpeakinTelnet",
    "id": 105018871,
    "node_id": "U_kgDOBkJ19w",
    "avatar_url": "https://avatars.githubusercontent.com/u/105018871?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/SpeakinTelnet",
    "html_url": "https://github.com/SpeakinTelnet",
    "followers_url": "https://api.github.com/users/SpeakinTelnet/followers",
    "following_url": "https://api.github.com/users/SpeakinTelnet/following{/other_user}",
    "gists_url": "https://api.github.com/users/SpeakinTelnet/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/SpeakinTelnet/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/SpeakinTelnet/subscriptions",
    "organizations_url": "https://api.github.com/users/SpeakinTelnet/orgs",
    "repos_url": "https://api.github.com/users/SpeakinTelnet/repos",
    "events_url": "https://api.github.com/users/SpeakinTelnet/events{/privacy}",
    "received_events_url": "https://api.github.com/users/SpeakinTelnet/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 5670219610,
      "node_id": "LA_kwDOCD5_Gc8AAAABUfivWg",
      "url": "https://api.github.com/repos/ChainSafe/lodestar/labels/meta-bug",
      "name": "meta-bug",
      "color": "E79553",
      "default": false,
      "description": "Issues that identify a bug and require a fix."
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2023-08-12T00:59:50Z",
  "updated_at": "2023-08-12T08:31:28Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Describe the bug\r\n\r\nI have an issue where the heap grows up to the limit of available memory and then crash lodestar. I'm running beacon only on ethereum mainnet.\r\n\r\nLodestar (currently v1.10.0/stable/7546292) is installed from source using `yarn install` followed by `yarn build` and I'm using the following systemd service:\r\n\r\n```\r\n[Unit]\r\nDescription=Lodestar Beacon Node (Ethereum consensus client)\r\nWants=network-online.target\r\nAfter=network-online.target\r\n\r\n[Install]\r\nWantedBy=multi-user.target\r\n\r\n[Service]\r\n\r\nUser=cryptobro\r\nGroup=cryptobro\r\nWorkingDirectory=/opt/lodestar\r\nTimeoutSec=1200\r\nRestart=always\r\n\r\nExecStart=/opt/lodestar/lodestar beacon \\\r\n  --dataDir=/var/opt/lodestar/chain-data \\\r\n  --network.maxPeers 60 \\\r\n  --metrics=true \\\r\n  --metrics.port=8009 \\\r\n  --checkpointSyncUrl=https://beaconstate-mainnet.chainsafe.io \\\r\n  --network=mainnet \\\r\n  --execution.urls=http://10.1.10.91:8551 \\\r\n  --jwt-secret=/var/opt/lodestar/jwt.hex\r\n\r\n```\r\n\r\nHere's how the heap usage looks prior and after growing the max-old-space-size to 6144MiB\r\n\r\n![image](https://github.com/ChainSafe/lodestar/assets/105018871/49549bf0-4478-4090-a99e-3356cbe6c183)\r\n\r\nHere's the trace I get when the node crash:\r\n\r\n```\r\nAug 10 03:51:00 ethereum-cl lodestar[1274]: [1274:0x5928970] 41466040 ms: Mark-sweep 3972.7 (4124.8) -> 3952.4 (4104.8) MB, 1682.5 / 0.0 ms  (average mu = 0.117, current mu = 0.038) allocation failure; scavenge might not succeed\r\nAug 10 03:51:00 ethereum-cl lodestar[1274]: [1274:0x5928970] 41467710 ms: Mark-sweep 3965.8 (4118.2) -> 3952.4 (4104.8) MB, 1606.2 / 0.0 ms  (average mu = 0.081, current mu = 0.039) allocation failure; scavenge might not succeed\r\nAug 10 03:51:00 ethereum-cl lodestar[1274]: <--- JS stacktrace --->\r\nAug 10 03:51:00 ethereum-cl lodestar[1274]: FATAL ERROR: Ineffective mark-compacts near heap limit Allocation failed - JavaScript heap out of memory\r\nAug 10 03:51:00 ethereum-cl lodestar[1274]:  1: 0xb7a940 node::Abort() [node]\r\nAug 10 03:51:00 ethereum-cl lodestar[1274]:  2: 0xa8e823  [node]\r\nAug 10 03:51:00 ethereum-cl lodestar[1274]:  3: 0xd5c940 v8::Utils::ReportOOMFailure(v8::internal::Isolate*, char const*, bool) [node]\r\nAug 10 03:51:00 ethereum-cl lodestar[1274]:  4: 0xd5cce7 v8::internal::V8::FatalProcessOutOfMemory(v8::internal::Isolate*, char const*, bool) [node]\r\nAug 10 03:51:00 ethereum-cl lodestar[1274]:  5: 0xf3a3e5  [node]\r\nAug 10 03:51:00 ethereum-cl lodestar[1274]:  6: 0xf3b2e8 v8::internal::Heap::RecomputeLimits(v8::internal::GarbageCollector) [node]\r\nAug 10 03:51:00 ethereum-cl lodestar[1274]:  7: 0xf4b7f3  [node]\r\nAug 10 03:51:00 ethereum-cl lodestar[1274]:  8: 0xf4c668 v8::internal::Heap::CollectGarbage(v8::internal::AllocationSpace, v8::internal::GarbageCollectionReason, v8::GCCallbackFlags) [node]\r\nAug 10 03:51:00 ethereum-cl lodestar[1274]:  9: 0xf26fce v8::internal::HeapAllocator::AllocateRawWithLightRetrySlowPath(int, v8::internal::AllocationType, v8::internal::AllocationOrigin, v8::internal::AllocationAlignment) [node]\r\nAug 10 03:51:00 ethereum-cl lodestar[1274]: 10: 0xf28397 v8::internal::HeapAllocator::AllocateRawWithRetryOrFailSlowPath(int, v8::internal::AllocationType, v8::internal::AllocationOrigin, v8::internal::AllocationAlignment) [node]\r\nAug 10 03:51:00 ethereum-cl lodestar[1274]: 11: 0xf088e0 v8::internal::Factory::AllocateRaw(int, v8::internal::AllocationType, v8::internal::AllocationAlignment) [node]\r\nAug 10 03:51:00 ethereum-cl lodestar[1274]: 12: 0xeffeac v8::internal::FactoryBase<v8::internal::Factory>::AllocateRawArray(int, v8::internal::AllocationType) [node]\r\nAug 10 03:51:00 ethereum-cl lodestar[1274]: 13: 0xf00025 v8::internal::FactoryBase<v8::internal::Factory>::NewFixedArrayWithFiller(v8::internal::Handle<v8::internal::Map>, int, v8::internal::Handle<v8::internal::Oddball>, v8::internal::AllocationType) [node]\r\nAug 10 03:51:00 ethereum-cl lodestar[1274]: 14: 0x10aff62  [node]\r\nAug 10 03:51:00 ethereum-cl lodestar[1274]: 15: 0x10b96f4  [node]\r\nAug 10 03:51:00 ethereum-cl lodestar[1274]: 16: 0x10e5ca8  [node]\r\nAug 10 03:51:00 ethereum-cl lodestar[1274]: 17: 0x119e81d v8::internal::JSArray::SetLength(v8::internal::Handle<v8::internal::JSArray>, unsigned int) [node]\r\nAug 10 03:51:00 ethereum-cl lodestar[1274]: 18: 0x10e7465 v8::internal::ArrayConstructInitializeElements(v8::internal::Handle<v8::internal::JSArray>, v8::internal::Arguments<(v8::internal::ArgumentsType)1>*) [node]\r\nAug 10 03:51:00 ethereum-cl lodestar[1274]: 19: 0x12be7ea v8::internal::Runtime_NewArray(int, unsigned long*, v8::internal::Isolate*) [node]\r\nAug 10 03:51:00 ethereum-cl lodestar[1274]: 20: 0x16fb6b9  [node]\r\nAug 10 03:51:01 ethereum-cl lodestar[1273]: /opt/lodestar/lodestar: line 7:  1274 Aborted                 node --trace-deprecation --max-old-space-size=4096 ./packages/cli/bin/lodestar.js \"$@\"\r\nAug 10 03:51:01 ethereum-cl systemd[1]: lodestar-beacon.service: Main process exited, code=exited, status=134/n/a\r\nAug 10 03:51:01 ethereum-cl systemd[1]: lodestar-beacon.service: Failed with result 'exit-code'.\r\n```\r\n\r\nI'm running similar configuration on Gnosis with validators without such issue.\r\n\r\n### Expected behavior\r\n\r\nFor lodestar heap to be stable.\r\n\r\n### Operating system\r\n\r\nUbuntu 22.04.2 LTS\r\n\r\n### Lodestar version or commit hash\r\n\r\nv1.10.0/stable/7546292",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5877/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5877/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1675791423",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/5877#issuecomment-1675791423",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5877",
    "id": 1675791423,
    "node_id": "IC_kwDOCD5_Gc5j4ow_",
    "user": {
      "login": "nflaig",
      "id": 38436224,
      "node_id": "MDQ6VXNlcjM4NDM2MjI0",
      "avatar_url": "https://avatars.githubusercontent.com/u/38436224?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nflaig",
      "html_url": "https://github.com/nflaig",
      "followers_url": "https://api.github.com/users/nflaig/followers",
      "following_url": "https://api.github.com/users/nflaig/following{/other_user}",
      "gists_url": "https://api.github.com/users/nflaig/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nflaig/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nflaig/subscriptions",
      "organizations_url": "https://api.github.com/users/nflaig/orgs",
      "repos_url": "https://api.github.com/users/nflaig/repos",
      "events_url": "https://api.github.com/users/nflaig/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nflaig/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-08-12T08:31:28Z",
    "updated_at": "2023-08-12T08:31:28Z",
    "author_association": "MEMBER",
    "body": "Thanks for reporting @SpeakinTelnet. This is a known issue (https://github.com/ChainSafe/lodestar/issues/5851) in Lodestar 1.10 with older NodeJS versions.\r\n\r\nYou have to update NodeJS to a version >=18.17.0 or >=20.1.0. I would recommend to install the latest release of node 20.",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1675791423/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
