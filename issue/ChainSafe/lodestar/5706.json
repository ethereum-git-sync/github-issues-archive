{
  "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5706",
  "repository_url": "https://api.github.com/repos/ChainSafe/lodestar",
  "labels_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5706/labels{/name}",
  "comments_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5706/comments",
  "events_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5706/events",
  "html_url": "https://github.com/ChainSafe/lodestar/issues/5706",
  "id": 1774259690,
  "node_id": "I_kwDOCD5_Gc5pwQ3q",
  "number": 5706,
  "title": "Validator client unclean disconnect on shutdown",
  "user": {
    "login": "nflaig",
    "id": 38436224,
    "node_id": "MDQ6VXNlcjM4NDM2MjI0",
    "avatar_url": "https://avatars.githubusercontent.com/u/38436224?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/nflaig",
    "html_url": "https://github.com/nflaig",
    "followers_url": "https://api.github.com/users/nflaig/followers",
    "following_url": "https://api.github.com/users/nflaig/following{/other_user}",
    "gists_url": "https://api.github.com/users/nflaig/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/nflaig/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/nflaig/subscriptions",
    "organizations_url": "https://api.github.com/users/nflaig/orgs",
    "repos_url": "https://api.github.com/users/nflaig/repos",
    "events_url": "https://api.github.com/users/nflaig/events{/privacy}",
    "received_events_url": "https://api.github.com/users/nflaig/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": {
    "login": "nazarhussain",
    "id": 112468,
    "node_id": "MDQ6VXNlcjExMjQ2OA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/112468?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/nazarhussain",
    "html_url": "https://github.com/nazarhussain",
    "followers_url": "https://api.github.com/users/nazarhussain/followers",
    "following_url": "https://api.github.com/users/nazarhussain/following{/other_user}",
    "gists_url": "https://api.github.com/users/nazarhussain/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/nazarhussain/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/nazarhussain/subscriptions",
    "organizations_url": "https://api.github.com/users/nazarhussain/orgs",
    "repos_url": "https://api.github.com/users/nazarhussain/repos",
    "events_url": "https://api.github.com/users/nazarhussain/events{/privacy}",
    "received_events_url": "https://api.github.com/users/nazarhussain/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "nazarhussain",
      "id": 112468,
      "node_id": "MDQ6VXNlcjExMjQ2OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/112468?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nazarhussain",
      "html_url": "https://github.com/nazarhussain",
      "followers_url": "https://api.github.com/users/nazarhussain/followers",
      "following_url": "https://api.github.com/users/nazarhussain/following{/other_user}",
      "gists_url": "https://api.github.com/users/nazarhussain/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nazarhussain/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nazarhussain/subscriptions",
      "organizations_url": "https://api.github.com/users/nazarhussain/orgs",
      "repos_url": "https://api.github.com/users/nazarhussain/repos",
      "events_url": "https://api.github.com/users/nazarhussain/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nazarhussain/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2023-06-26T08:48:29Z",
  "updated_at": "2023-06-30T13:47:30Z",
  "closed_at": null,
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "### Describe the bug\n\nWhen shutting down the VC is causes the following error on the BN\r\n\r\n```\r\nJun-25 02:58:26.174[rest]            error: Req req-5 eventstream error  aborted\r\nError: aborted\r\n    at connResetException (node:internal/errors:717:14)\r\n    at abortIncoming (node:_http_server:754:17)\r\n    at socketOnClose (node:_http_server:748:3)\r\n    at Socket.emit (node:events:525:35)\r\n    at TCP.<anonymous> (node:net:322:12)\r\n```\r\n\r\nIn rare cases it might also lead to further error on the BN\r\n\r\n```\r\nJun-25 02:58:26.192[]                error: uncaughtException: Cannot set headers after they are sent to the client\r\nError: Cannot set headers after they are sent to the client\r\n    at new NodeError (node:internal/errors:399:5)\r\n    at ServerResponse.setHeader (node:_http_outgoing:645:11)\r\n    at ServerResponse.writeHead (node:_http_server:378:21)\r\n    at onSendEnd (/mnt/goerli/goerli/lodestar/node_modules/fastify/lib/reply.js:596:7)\r\n    at onSendHook (/mnt/goerli/goerli/lodestar/node_modules/fastify/lib/reply.js:529:5)\r\n    at fallbackErrorHandler (/mnt/goerli/goerli/lodestar/node_modules/fastify/lib/error-handler.js:127:3)\r\n    at handleError (/mnt/goerli/goerli/lodestar/node_modules/fastify/lib/error-handler.js:61:5)\r\n    at onErrorHook (/mnt/goerli/goerli/lodestar/node_modules/fastify/lib/reply.js:742:5)\r\n    at Reply.send (/mnt/goerli/goerli/lodestar/node_modules/fastify/lib/reply.js:133:5)\r\n    at defaultErrorHandler (/mnt/goerli/goerli/lodestar/node_modules/fastify/lib/error-handler.js:92:9) Cannot set headers after they are sent to the client\r\nError: Cannot set headers after they are sent to the client\r\n    at new NodeError (node:internal/errors:399:5)\r\n    at ServerResponse.setHeader (node:_http_outgoing:645:11)\r\n    at ServerResponse.writeHead (node:_http_server:378:21)\r\n    at onSendEnd (/mnt/goerli/goerli/lodestar/node_modules/fastify/lib/reply.js:596:7)\r\n    at onSendHook (/mnt/goerli/goerli/lodestar/node_modules/fastify/lib/reply.js:529:5)\r\n    at fallbackErrorHandler (/mnt/goerli/goerli/lodestar/node_modules/fastify/lib/error-handler.js:127:3)\r\n    at handleError (/mnt/goerli/goerli/lodestar/node_modules/fastify/lib/error-handler.js:61:5)\r\n    at onErrorHook (/mnt/goerli/goerli/lodestar/node_modules/fastify/lib/reply.js:742:5)\r\n    at Reply.send (/mnt/goerli/goerli/lodestar/node_modules/fastify/lib/reply.js:133:5)\r\n    at defaultErrorHandler (/mnt/goerli/goerli/lodestar/node_modules/fastify/lib/error-handler.js:92:9)\r\n```\r\n\r\nIt looks like the VC abruptly aborts the connection. Might worth to investigate if we can more gracefully close the connection or if that's not possible at all reduce the verbosity of the log on the BN side.\r\n\r\n\r\n`Error: Cannot set headers after they are sent to the client` should ideally never happen, this is caused when trying to set headers on a request that is already sent or aborted\r\nhttps://github.com/ChainSafe/lodestar/blob/f5d12a893f5b913a04938275bb248ace1ca47539/packages/api/src/beacon/server/events.ts#L26-L27\n\n### Expected behavior\n\nCleanly close all connections when shutting down VC, no error logs on the BN side.\n\n### Steps to reproduce\n\nShutdown VC, observe BN logs\n\n### Additional context\n\n_No response_\n\n### Operating system\n\nLinux\n\n### Lodestar version or commit hash\n\nv1.9.0",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5706/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5706/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1614677165",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/5706#issuecomment-1614677165",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5706",
    "id": 1614677165,
    "node_id": "IC_kwDOCD5_Gc5gPgSt",
    "user": {
      "login": "nazarhussain",
      "id": 112468,
      "node_id": "MDQ6VXNlcjExMjQ2OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/112468?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nazarhussain",
      "html_url": "https://github.com/nazarhussain",
      "followers_url": "https://api.github.com/users/nazarhussain/followers",
      "following_url": "https://api.github.com/users/nazarhussain/following{/other_user}",
      "gists_url": "https://api.github.com/users/nazarhussain/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nazarhussain/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nazarhussain/subscriptions",
      "organizations_url": "https://api.github.com/users/nazarhussain/orgs",
      "repos_url": "https://api.github.com/users/nazarhussain/repos",
      "events_url": "https://api.github.com/users/nazarhussain/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nazarhussain/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-06-30T13:47:30Z",
    "updated_at": "2023-06-30T13:47:30Z",
    "author_association": "CONTRIBUTOR",
    "body": "For the below error, the API client need to carefully abort. If user create a client and just dispose this error will generate because of the event stream. \r\n\r\n> Error: Cannot set headers after they are sent to the client",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1614677165/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
