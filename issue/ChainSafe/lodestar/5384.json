{
  "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5384",
  "repository_url": "https://api.github.com/repos/ChainSafe/lodestar",
  "labels_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5384/labels{/name}",
  "comments_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5384/comments",
  "events_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5384/events",
  "html_url": "https://github.com/ChainSafe/lodestar/issues/5384",
  "id": 1674280522,
  "node_id": "I_kwDOCD5_Gc5jy35K",
  "number": 5384,
  "title": "High regen queue job wait time",
  "user": {
    "login": "tuyennhv",
    "id": 10568965,
    "node_id": "MDQ6VXNlcjEwNTY4OTY1",
    "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tuyennhv",
    "html_url": "https://github.com/tuyennhv",
    "followers_url": "https://api.github.com/users/tuyennhv/followers",
    "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
    "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
    "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
    "repos_url": "https://api.github.com/users/tuyennhv/repos",
    "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "tuyennhv",
    "id": 10568965,
    "node_id": "MDQ6VXNlcjEwNTY4OTY1",
    "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tuyennhv",
    "html_url": "https://github.com/tuyennhv",
    "followers_url": "https://api.github.com/users/tuyennhv/followers",
    "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
    "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
    "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
    "repos_url": "https://api.github.com/users/tuyennhv/repos",
    "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "tuyennhv",
      "id": 10568965,
      "node_id": "MDQ6VXNlcjEwNTY4OTY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tuyennhv",
      "html_url": "https://github.com/tuyennhv",
      "followers_url": "https://api.github.com/users/tuyennhv/followers",
      "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
      "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
      "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
      "repos_url": "https://api.github.com/users/tuyennhv/repos",
      "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2023-04-19T06:53:05Z",
  "updated_at": "2023-04-24T22:11:14Z",
  "closed_at": "2023-04-24T22:11:14Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "**Describe the bug**\r\n\r\nWith the new gossip flow, the Job Wait Time of regen queue is almost 1s, this is likely one of the reason of I/O lag issue\r\n\r\n<img width=\"1306\" alt=\"Screenshot 2023-04-19 at 13 32 46\" src=\"https://user-images.githubusercontent.com/10568965/232986401-ab0fdc99-d051-4e5e-ad0c-4260075598d4.png\">\r\n\r\nright now the regen queue length is limited to 16 to accept new gossip work\r\n\r\n<img width=\"1287\" alt=\"Screenshot 2023-04-19 at 13 34 43\" src=\"https://user-images.githubusercontent.com/10568965/232986769-d808bc8c-a74a-4b70-89e1-4f528162c339.png\">\r\n\r\n\r\n**Expected behavior**\r\n\r\n- This is from stable (v1.7): regen queue is only 1 or 0 and job wait time is way lower\r\n<img width=\"1291\" alt=\"Screenshot 2023-04-19 at 13 40 31\" src=\"https://user-images.githubusercontent.com/10568965/232987994-c2864af0-d3cb-4a65-b238-0e1a7a1b989c.png\">\r\n\r\n<img width=\"1292\" alt=\"Screenshot 2023-04-19 at 13 40 52\" src=\"https://user-images.githubusercontent.com/10568965/232988070-acc1c838-5c4a-495d-9c63-237667c27f1b.png\">\r\n\r\n**Question**\r\n- We have a state cache of 96 items, why are there some attestations with block head not in that cache, is it worth to always regen them? maybe we should skip some of them, see https://github.com/ChainSafe/lodestar/blob/3ee1d8a5acb09160827b185c79d2ead80442c0e7/packages/beacon-node/src/chain/validation/attestation.ts#L139\r\n- Consider reducing REGEN_CAN_ACCEPT_WORK_THRESHOLD (right now it's 16) cc @dapplion ",
  "closed_by": {
    "login": "tuyennhv",
    "id": 10568965,
    "node_id": "MDQ6VXNlcjEwNTY4OTY1",
    "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tuyennhv",
    "html_url": "https://github.com/tuyennhv",
    "followers_url": "https://api.github.com/users/tuyennhv/followers",
    "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
    "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
    "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
    "repos_url": "https://api.github.com/users/tuyennhv/repos",
    "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5384/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5384/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1514304199",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/5384#issuecomment-1514304199",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5384",
    "id": 1514304199,
    "node_id": "IC_kwDOCD5_Gc5aQnLH",
    "user": {
      "login": "tuyennhv",
      "id": 10568965,
      "node_id": "MDQ6VXNlcjEwNTY4OTY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tuyennhv",
      "html_url": "https://github.com/tuyennhv",
      "followers_url": "https://api.github.com/users/tuyennhv/followers",
      "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
      "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
      "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
      "repos_url": "https://api.github.com/users/tuyennhv/repos",
      "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-19T08:00:57Z",
    "updated_at": "2023-04-19T08:00:57Z",
    "author_association": "CONTRIBUTOR",
    "body": "when I zoom in, some Job Wait Time is > 4s which is too big\r\n\r\n<img width=\"1287\" alt=\"Screenshot 2023-04-19 at 15 00 19\" src=\"https://user-images.githubusercontent.com/10568965/233008742-20fdf910-d821-4db8-9d46-5517b7c7857a.png\">\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1514304199/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1514713529",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/5384#issuecomment-1514713529",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5384",
    "id": 1514713529,
    "node_id": "IC_kwDOCD5_Gc5aSLG5",
    "user": {
      "login": "dapplion",
      "id": 35266934,
      "node_id": "MDQ6VXNlcjM1MjY2OTM0",
      "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dapplion",
      "html_url": "https://github.com/dapplion",
      "followers_url": "https://api.github.com/users/dapplion/followers",
      "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
      "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
      "organizations_url": "https://api.github.com/users/dapplion/orgs",
      "repos_url": "https://api.github.com/users/dapplion/repos",
      "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dapplion/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-19T13:13:17Z",
    "updated_at": "2023-04-19T13:13:17Z",
    "author_association": "MEMBER",
    "body": "@tuyennhv for this type of metric is best to capture the histogram to understand the real distribution of values through a longer timeframe. That would allow to answer the question: what % of regen jobs over a day take > 1s",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1514713529/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1515690360",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/5384#issuecomment-1515690360",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5384",
    "id": 1515690360,
    "node_id": "IC_kwDOCD5_Gc5aV5l4",
    "user": {
      "login": "tuyennhv",
      "id": 10568965,
      "node_id": "MDQ6VXNlcjEwNTY4OTY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tuyennhv",
      "html_url": "https://github.com/tuyennhv",
      "followers_url": "https://api.github.com/users/tuyennhv/followers",
      "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
      "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
      "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
      "repos_url": "https://api.github.com/users/tuyennhv/repos",
      "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-20T04:18:26Z",
    "updated_at": "2023-04-20T04:18:26Z",
    "author_association": "CONTRIBUTOR",
    "body": "@dapplion it's about 25% of them take >1s\r\n\r\n<img width=\"1321\" alt=\"Screenshot 2023-04-20 at 11 16 35\" src=\"https://user-images.githubusercontent.com/10568965/233256763-910e7d60-496b-455a-bb57-3d4916738639.png\">\r\n\r\nthis issue happens randomly on stable mainnet node but more consistently on unstable mainnet node (could be because unstable likely validate all attestations with the new gossip)",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1515690360/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1515990303",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/5384#issuecomment-1515990303",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5384",
    "id": 1515990303,
    "node_id": "IC_kwDOCD5_Gc5aXC0f",
    "user": {
      "login": "tuyennhv",
      "id": 10568965,
      "node_id": "MDQ6VXNlcjEwNTY4OTY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tuyennhv",
      "html_url": "https://github.com/tuyennhv",
      "followers_url": "https://api.github.com/users/tuyennhv/followers",
      "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
      "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
      "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
      "repos_url": "https://api.github.com/users/tuyennhv/repos",
      "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-20T09:11:48Z",
    "updated_at": "2023-04-24T22:10:57Z",
    "author_association": "CONTRIBUTOR",
    "body": "Sometimes `getBlockSlotState()` call of `precomputeEpoch` takes up to 3s\r\n\r\n<img width=\"794\" alt=\"Screenshot 2023-04-20 at 16 09 57\" src=\"https://user-images.githubusercontent.com/10568965/233318119-7bd5f745-b556-4070-a43c-ea1c576f65cf.png\">\r\n\r\n<img width=\"799\" alt=\"Screenshot 2023-04-20 at 16 10 05\" src=\"https://user-images.githubusercontent.com/10568965/233318154-adf78a1f-dbf9-4a06-87da-7325f69190de.png\">\r\n\r\n<img width=\"822\" alt=\"Screenshot 2023-04-20 at 16 10 19\" src=\"https://user-images.githubusercontent.com/10568965/233318199-35ef2ad9-7003-4b58-9885-77fd7ec65772.png\">\r\n\r\nupdate: should investigate the long epoch transition in https://github.com/ChainSafe/lodestar/issues/5409",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1515990303/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1520894313",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/5384#issuecomment-1520894313",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5384",
    "id": 1520894313,
    "node_id": "IC_kwDOCD5_Gc5apwFp",
    "user": {
      "login": "tuyennhv",
      "id": 10568965,
      "node_id": "MDQ6VXNlcjEwNTY4OTY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tuyennhv",
      "html_url": "https://github.com/tuyennhv",
      "followers_url": "https://api.github.com/users/tuyennhv/followers",
      "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
      "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
      "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
      "repos_url": "https://api.github.com/users/tuyennhv/repos",
      "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-24T22:09:59Z",
    "updated_at": "2023-04-24T22:09:59Z",
    "author_association": "CONTRIBUTOR",
    "body": "Latest 1h chart in the last 24h in unstable mainnet node:\r\n\r\n<img width=\"792\" alt=\"Screenshot 2023-04-25 at 05 08 40\" src=\"https://user-images.githubusercontent.com/10568965/234127255-ced12188-8268-46c7-8e87-27d4ba5f02df.png\">\r\n\r\nvs stable mainnet node\r\n\r\n<img width=\"803\" alt=\"Screenshot 2023-04-25 at 05 09 16\" src=\"https://user-images.githubusercontent.com/10568965/234127339-2f578de4-fb8e-41f5-8ee3-342a32efc685.png\">\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1520894313/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
