{
  "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5314",
  "repository_url": "https://api.github.com/repos/ChainSafe/lodestar",
  "labels_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5314/labels{/name}",
  "comments_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5314/comments",
  "events_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5314/events",
  "html_url": "https://github.com/ChainSafe/lodestar/issues/5314",
  "id": 1643848868,
  "node_id": "I_kwDOCD5_Gc5h-ySk",
  "number": 5314,
  "title": "Attestations are skipped for slots where previous slot tasks take > `SECONDS_PER_SLOT`",
  "user": {
    "login": "nflaig",
    "id": 38436224,
    "node_id": "MDQ6VXNlcjM4NDM2MjI0",
    "avatar_url": "https://avatars.githubusercontent.com/u/38436224?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/nflaig",
    "html_url": "https://github.com/nflaig",
    "followers_url": "https://api.github.com/users/nflaig/followers",
    "following_url": "https://api.github.com/users/nflaig/following{/other_user}",
    "gists_url": "https://api.github.com/users/nflaig/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/nflaig/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/nflaig/subscriptions",
    "organizations_url": "https://api.github.com/users/nflaig/orgs",
    "repos_url": "https://api.github.com/users/nflaig/repos",
    "events_url": "https://api.github.com/users/nflaig/events{/privacy}",
    "received_events_url": "https://api.github.com/users/nflaig/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1478321239,
      "node_id": "MDU6TGFiZWwxNDc4MzIxMjM5",
      "url": "https://api.github.com/repos/ChainSafe/lodestar/labels/meta-discussion",
      "name": "meta-discussion",
      "color": "a6bddb",
      "default": false,
      "description": "Indicates a topic that requires input from various developers."
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2023-03-28T12:29:25Z",
  "updated_at": "2023-04-05T19:34:22Z",
  "closed_at": null,
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "Lodestar VC consciously skips attestations for slots if the previous slot tasks take > `SECONDS_PER_SLOT` due to `runAtMostEvery` function.\r\n\r\nhttps://github.com/ChainSafe/lodestar/blob/f136f952ddb861976b3cc9484914c49a06ee8d90/packages/validator/src/util/clock.ts#L90\r\n\r\n**Rational behind this**\r\n> If a task happens to take more than one slot to run, we might skip a slot. This is unfortunate,\r\n   however the alternative is to *always* process every slot, which has the chance of creating a\r\n   theoretically unlimited backlog of tasks. It was a conscious decision to choose to drop tasks\r\n   on an overloaded/latent system rather than overload it even more.\r\n   \r\n\r\nThe rational is understandable, however, based on my observations, the overload will most likely not be on the VC side but rather on the BN side in which case the BN should make sure to not accept more tasks. If `runAtMostEvery` is just implemented to \"protect\" the BN we should consider removing it. We should also avoid making assumptions on what BN implementation we are dealing with, might be a DVT middleware or any other CL (lighthouse, prysm, etc.).\r\n\r\nOther VCs seem to not care if the tasks of the previous slot are still pending and just start tasks for the next slot. I think we should follow the same approach in Lodestar VC to make it more robust against (expected) errors such as timeouts.\r\n\r\n**Steps to reproduce**\r\n\r\nThis issue was observed while testing Lodestar VC with DVT middleware Charon (https://github.com/ObolNetwork/charon) where `getAggregatedAttestation` would not return a response due to missing implementation of [distributed aggregation selections](https://docs.google.com/document/d/1q9jOTPcYQa-3L8luRvQJ-M0eegtba4Nmon3dpO79TMk/mobilebasic) which causes the attestation routine for slot *N* to take more than `SECONDS_PER_SLOT` due to the VC default http timeout of [SECONDS_PER_SLOT](https://github.com/ChainSafe/lodestar/blob/f136f952ddb861976b3cc9484914c49a06ee8d90/packages/validator/src/validator.ts#L83-L84) causing the VC to skip slot *N + 1*.\r\n\r\n**Current behavior**\r\n\r\nAttestation routines are not properly decoupled. Issues (such as timeouts) in an attestation routine for slot *N* can lead to missing ALL attestations in slot *N + 1*.\r\n\r\n**Expected behavior**\r\n\r\nAttestation routines for each slot should be independent/decoupled from each other. Issues in a previous routine should not affect the next routine.\r\n\r\nRelated https://github.com/ChainSafe/lodestar/issues/5315",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5314/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5314/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1486884817",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/5314#issuecomment-1486884817",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5314",
    "id": 1486884817,
    "node_id": "IC_kwDOCD5_Gc5YoA_R",
    "user": {
      "login": "tuyennhv",
      "id": 10568965,
      "node_id": "MDQ6VXNlcjEwNTY4OTY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tuyennhv",
      "html_url": "https://github.com/tuyennhv",
      "followers_url": "https://api.github.com/users/tuyennhv/followers",
      "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
      "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
      "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
      "repos_url": "https://api.github.com/users/tuyennhv/repos",
      "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-28T13:25:33Z",
    "updated_at": "2023-03-28T13:25:33Z",
    "author_association": "CONTRIBUTOR",
    "body": "yes this was implemented at the time when we didn't have `vc` metrics, now `vc` metrics don't show any apis that may cause the lag, I think we can remove that feature and do attestation duties for every slot\r\ncc @dapplion ",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1486884817/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1489538765",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/5314#issuecomment-1489538765",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5314",
    "id": 1489538765,
    "node_id": "IC_kwDOCD5_Gc5YyI7N",
    "user": {
      "login": "dapplion",
      "id": 35266934,
      "node_id": "MDQ6VXNlcjM1MjY2OTM0",
      "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dapplion",
      "html_url": "https://github.com/dapplion",
      "followers_url": "https://api.github.com/users/dapplion/followers",
      "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
      "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
      "organizations_url": "https://api.github.com/users/dapplion/orgs",
      "repos_url": "https://api.github.com/users/dapplion/repos",
      "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dapplion/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-30T01:04:17Z",
    "updated_at": "2023-03-30T01:04:17Z",
    "author_association": "MEMBER",
    "body": "Not opposed to removing it, but just be aware that our beacon node does not implement any overload protection at the API level",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1489538765/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1490850586",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/5314#issuecomment-1490850586",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5314",
    "id": 1490850586,
    "node_id": "IC_kwDOCD5_Gc5Y3JMa",
    "user": {
      "login": "nflaig",
      "id": 38436224,
      "node_id": "MDQ6VXNlcjM4NDM2MjI0",
      "avatar_url": "https://avatars.githubusercontent.com/u/38436224?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nflaig",
      "html_url": "https://github.com/nflaig",
      "followers_url": "https://api.github.com/users/nflaig/followers",
      "following_url": "https://api.github.com/users/nflaig/following{/other_user}",
      "gists_url": "https://api.github.com/users/nflaig/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nflaig/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nflaig/subscriptions",
      "organizations_url": "https://api.github.com/users/nflaig/orgs",
      "repos_url": "https://api.github.com/users/nflaig/repos",
      "events_url": "https://api.github.com/users/nflaig/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nflaig/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-30T19:47:24Z",
    "updated_at": "2023-03-30T20:23:04Z",
    "author_association": "MEMBER",
    "body": "> our beacon node does not implement any overload protection at the API level\r\n\r\nOther VCs don't implement such protections, we should not make assumptions to which VC (or multiple) the BN is connected. This even makes it more important that we remove this from the Lodestar VC so we get better insights in BN performance and if required implement some sort of protection there.\r\n\r\nEdit: it seems like Lighthouse also implements this in [their duty service](https://github.com/sigp/lighthouse/blob/a53830fd60a119bf3f659b253360af8027128e83/validator_client/src/duties_service.rs#L260).",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1490850586/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
