{
  "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3764",
  "repository_url": "https://api.github.com/repos/ChainSafe/lodestar",
  "labels_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3764/labels{/name}",
  "comments_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3764/comments",
  "events_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3764/events",
  "html_url": "https://github.com/ChainSafe/lodestar/issues/3764",
  "id": 1139451266,
  "node_id": "I_kwDOCD5_Gc5D6qWC",
  "number": 3764,
  "title": "Invalid State Root error",
  "user": {
    "login": "tuyennhv",
    "id": 10568965,
    "node_id": "MDQ6VXNlcjEwNTY4OTY1",
    "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tuyennhv",
    "html_url": "https://github.com/tuyennhv",
    "followers_url": "https://api.github.com/users/tuyennhv/followers",
    "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
    "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
    "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
    "repos_url": "https://api.github.com/users/tuyennhv/repos",
    "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1200090450,
      "node_id": "MDU6TGFiZWwxMjAwMDkwNDUw",
      "url": "https://api.github.com/repos/ChainSafe/lodestar/labels/prio-critical",
      "name": "prio-critical",
      "color": "fd6f60",
      "default": false,
      "description": "Drop everything to resolve this immediately. Examples: consensus bug, un-usable CLI"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "tuyennhv",
    "id": 10568965,
    "node_id": "MDQ6VXNlcjEwNTY4OTY1",
    "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tuyennhv",
    "html_url": "https://github.com/tuyennhv",
    "followers_url": "https://api.github.com/users/tuyennhv/followers",
    "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
    "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
    "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
    "repos_url": "https://api.github.com/users/tuyennhv/repos",
    "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "tuyennhv",
      "id": 10568965,
      "node_id": "MDQ6VXNlcjEwNTY4OTY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tuyennhv",
      "html_url": "https://github.com/tuyennhv",
      "followers_url": "https://api.github.com/users/tuyennhv/followers",
      "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
      "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
      "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
      "repos_url": "https://api.github.com/users/tuyennhv/repos",
      "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2022-02-16T02:36:12Z",
  "updated_at": "2022-02-17T04:02:54Z",
  "closed_at": "2022-02-17T04:02:54Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "**Describe the bug**\r\n\r\nWith latest master, this error happened twice from yesterday:\r\n```\r\null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null]},\"shift\":15,\"tail\":[0,0,0,0,0,0,0,0,0,0,0,0,0,0],\"length\":277294}}}}\r\nFeb 15 16:05:25 vmi768848 lodestar[263068]: Error: BLOCK_ERROR_INVALID_STATE_ROOT\r\nFeb 15 16:05:25 vmi768848 lodestar[263068]:     at verifyBlockStateTransition (/home/staker/lodestar/packages/lodestar/src/chain/blocks/verifyBlock.ts:276:11)\r\nFeb 15 16:05:25 vmi768848 lodestar[263068]:     at verifyBlock (/home/staker/lodestar/packages/lodestar/src/chain/blocks/verifyBlock.ts:45:40)\r\nFeb 15 16:05:25 vmi768848 lodestar[263068]:     at processChainSegment (/home/staker/lodestar/packages/lodestar/src/chain/blocks/index.ts:101:34)\r\nFeb 15 16:05:25 vmi768848 lodestar[263068]:     at JobItemQueue.runJob (/home/staker/lodestar/packages/lodestar/src/util/queue/itemQueue.ts:90:22)\r\n```\r\n\r\nmemory spiked due to this circular reference log\r\n\r\n```\r\n\"CIRCULAR_REFERENCE\",\"value\":{\"pubkey\":\"0x93b67282fb969f1edaed74b3783a00cea5db1d78c52bca349d10b64294c412e6cceeecf635544ea4e74e270b68b2a0a0\",\"withdrawalCredentials\":\"0x00be4ea92c089d35c3193aa6273bfceec7304c76807eadf3e5b7e82ab61316f9\",\"effectiveBalance\":32000000000,\"slashed\":false,\"activationEligibilityEpoch\":0,\"activationEpoch\":0,\"exitEpoch\":null,\"withdrawableEpoch\":null}}},\"_right\":{\"h0\":1482271310,\"h1\":-296990451,\"h2\":-1327100512,\"h3\":-1538294996,\"h4\":-858908230,\"h5\":-694385282,\"h6\":370182545,\"h7\":1063229127,\"_left\":{\"h0\":-2020796176,\"h1\":1898865535,\"h2\":-114344170,\"h3\":-1873026616,\"h4\":-548623425,\"h5\":1441317735,\"h6\":178512011,\"h7\":-602916184,\"type\":\"CIRCULAR_REFERENCE\"\r\n```\r\n\r\npeers left us, and some node could recover, some couldn't\r\n\r\n**Expected behavior**\r\n\r\n+ Root cause is \"Invalid state root\" issue\r\n+ Make sure no giant \"CIRCULAR_REFERENCE\" log",
  "closed_by": {
    "login": "tuyennhv",
    "id": 10568965,
    "node_id": "MDQ6VXNlcjEwNTY4OTY1",
    "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tuyennhv",
    "html_url": "https://github.com/tuyennhv",
    "followers_url": "https://api.github.com/users/tuyennhv/followers",
    "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
    "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
    "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
    "repos_url": "https://api.github.com/users/tuyennhv/repos",
    "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3764/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3764/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1041211503",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/3764#issuecomment-1041211503",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3764",
    "id": 1041211503,
    "node_id": "IC_kwDOCD5_Gc4-D6Bv",
    "user": {
      "login": "tuyennhv",
      "id": 10568965,
      "node_id": "MDQ6VXNlcjEwNTY4OTY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tuyennhv",
      "html_url": "https://github.com/tuyennhv",
      "followers_url": "https://api.github.com/users/tuyennhv/followers",
      "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
      "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
      "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
      "repos_url": "https://api.github.com/users/tuyennhv/repos",
      "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-02-16T07:55:46Z",
    "updated_at": "2022-02-16T07:55:46Z",
    "author_association": "CONTRIBUTOR",
    "body": "So I was able to download preState, postState and the signedBlock of the issue. It turns out the preState is incorrect, and the preState is actually a checkpoint state (which is produced right after we `processEpoch`)\r\n\r\n1. If I download state 2365150 and process block 2365154, it works as expected.\r\n\r\n2. If I run state transition from download pre state with the downloaded signed block 2365154, I do get the \"incorrect state root\" error\r\n3. It means the downloaded Prestate (slot 2365152) is incorrect, compared to downloaded state 2365150 processing to the next epoch (which becomes state at slot 2365152), the only difference is at validator 277249:\r\n```json\r\n{\r\n         \"activation_eligibility_epoch\": \"18446744073709551615\"\r\n         \"activation_epoch\": \"18446744073709551615\"\r\n      -  \"effective_balance\": \"16000000000\"\r\n      +  \"effective_balance\": \"32000000000\"\r\n         \"exit_epoch\": \"18446744073709551615\"\r\n         \"pubkey\": \"0x800f9f44afe18c16a673d35a909ee8ac9d0bb8bedbbf222163d0ac2b3bebec6817b2f28c9e89bb71e3a7525320e4705f\"\r\n         \"slashed\": false\r\n         \"withdrawable_epoch\": \"18446744073709551615\"\r\n```\r\n\r\nsomehow the effective balance of validator 277249 is 16ETH while it should be 32ETH. \r\n\r\nI notice that the issue happens at epoch 73911, however validator 277249 only submitted attestations from epoch 73927 as shown in https://prater.beaconcha.in/validator/277249#attestations",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1041211503/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
