{
  "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5372",
  "repository_url": "https://api.github.com/repos/ChainSafe/lodestar",
  "labels_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5372/labels{/name}",
  "comments_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5372/comments",
  "events_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5372/events",
  "html_url": "https://github.com/ChainSafe/lodestar/issues/5372",
  "id": 1672512997,
  "node_id": "I_kwDOCD5_Gc5jsIXl",
  "number": 5372,
  "title": "Rejected BlsToExecutionChange gossip messages",
  "user": {
    "login": "tuyennhv",
    "id": 10568965,
    "node_id": "MDQ6VXNlcjEwNTY4OTY1",
    "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tuyennhv",
    "html_url": "https://github.com/tuyennhv",
    "followers_url": "https://api.github.com/users/tuyennhv/followers",
    "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
    "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
    "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
    "repos_url": "https://api.github.com/users/tuyennhv/repos",
    "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2023-04-18T07:22:40Z",
  "updated_at": "2023-04-26T23:01:46Z",
  "closed_at": "2023-04-26T23:01:46Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "**Describe the bug**\r\n\r\nThis happens **only** on test mainnet nodes, got p4 penalties due to rejected BlsToExecutionChange gossip messages\r\n\r\n<img width=\"1300\" alt=\"Screenshot 2023-04-18 at 14 21 02\" src=\"https://user-images.githubusercontent.com/10568965/232701814-6c8bfb94-61f8-4ad7-8c3d-00c1b0adf781.png\">\r\n\r\n\r\nWith v1.7.2 we don't see the log, with latest gossip implementation, the log is like below:\r\n\r\n```\r\nApr-18 06:47:07.492[network]         ^[[34mdebug^[[39m: Gossip validation bls_to_execution_change rejected  code=BLS_TO_EXECUTION_CHANGE_ERROR_INVALID\r\nError: BLS_TO_EXECUTION_CHANGE_ERROR_INVALID\r\n    at validateBlsToExecutionChange (file:///usr/app/packages/beacon-node/src/chain/validation/blsToExecutionChange.ts:33:11)\r\n    at Object.bls_to_execution_change (file:///usr/app/packages/beacon-node/src/network/processor/gossipHandlers.ts:378:13)\r\n    at NetworkWorker.gossipValidatorFn (file:///usr/app/packages/beacon-node/src/network/processor/gossipValidatorFn.ts:35:54)\r\n    at NetworkWorker.processPendingGossipsubMessage (file:///usr/app/packages/beacon-node/src/network/processor/worker.ts:32:35)\r\n    at NetworkEventBus.emit (node:events:513:28)\r\n    at Timeout._onTimeout (file:///usr/app/packages/beacon-node/src/network/gossip/gossipsub.ts:413:19)\r\n    at listOnTimeout (node:internal/timers:569:17)\r\n```\r\n\r\n**Expected behavior**\r\n\r\n- Investigate why I don't see this on prod mainnet nodes?\r\n- Investigate why the validation failed\r\n\r\n**Desktop (please complete the following information):**\r\n\r\n- Version: v1.7.2",
  "closed_by": {
    "login": "tuyennhv",
    "id": 10568965,
    "node_id": "MDQ6VXNlcjEwNTY4OTY1",
    "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tuyennhv",
    "html_url": "https://github.com/tuyennhv",
    "followers_url": "https://api.github.com/users/tuyennhv/followers",
    "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
    "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
    "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
    "repos_url": "https://api.github.com/users/tuyennhv/repos",
    "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5372/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5372/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1521230238",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/5372#issuecomment-1521230238",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5372",
    "id": 1521230238,
    "node_id": "IC_kwDOCD5_Gc5arCGe",
    "user": {
      "login": "dapplion",
      "id": 35266934,
      "node_id": "MDQ6VXNlcjM1MjY2OTM0",
      "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dapplion",
      "html_url": "https://github.com/dapplion",
      "followers_url": "https://api.github.com/users/dapplion/followers",
      "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
      "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
      "organizations_url": "https://api.github.com/users/dapplion/orgs",
      "repos_url": "https://api.github.com/users/dapplion/repos",
      "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dapplion/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-25T06:39:07Z",
    "updated_at": "2023-04-25T06:39:07Z",
    "author_association": "MEMBER",
    "body": "Validity conditions are:\r\n- Refers to known index\r\n- Signature is correct\r\n- Credentials have not already been changed\r\n\r\nIt must be the last one, where nodes are rebroadcasting messages for changes that have already been applied, but should double check. I won't imagine having large amounts of credentials changes with invalid signatures. Are we using the right state to validate?",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1521230238/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1524141197",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/5372#issuecomment-1524141197",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5372",
    "id": 1524141197,
    "node_id": "IC_kwDOCD5_Gc5a2IyN",
    "user": {
      "login": "tuyennhv",
      "id": 10568965,
      "node_id": "MDQ6VXNlcjEwNTY4OTY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tuyennhv",
      "html_url": "https://github.com/tuyennhv",
      "followers_url": "https://api.github.com/users/tuyennhv/followers",
      "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
      "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
      "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
      "repos_url": "https://api.github.com/users/tuyennhv/repos",
      "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-26T23:01:45Z",
    "updated_at": "2023-04-26T23:01:45Z",
    "author_association": "CONTRIBUTOR",
    "body": "there is no epoch/slot in `BlsToExecutionChange` message, we just use head state\r\nyes the reason message was rejected is because withdrawal credential was already changed in the head state, and that's due to the fact that we used to delay the gossip message validation a lot (up to minutes)\r\nthat explains why it only happen with `unstable` not with `stable(v1.7.2)`\r\nsince this PR https://github.com/ChainSafe/lodestar/pull/5407 I haven't seen this issue anymore\r\n\r\n<img width=\"1312\" alt=\"Screenshot 2023-04-27 at 06 00 50\" src=\"https://user-images.githubusercontent.com/10568965/234720601-00a4e638-9d35-46c5-81ea-613d3e3c1fc9.png\">\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1524141197/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
