{
  "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3488",
  "repository_url": "https://api.github.com/repos/ChainSafe/lodestar",
  "labels_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3488/labels{/name}",
  "comments_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3488/comments",
  "events_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3488/events",
  "html_url": "https://github.com/ChainSafe/lodestar/issues/3488",
  "id": 1073082524,
  "node_id": "I_kwDOCD5_Gc4_9fCc",
  "number": 3488,
  "title": "timing preparePayload",
  "user": {
    "login": "g11tech",
    "id": 76567250,
    "node_id": "MDQ6VXNlcjc2NTY3MjUw",
    "avatar_url": "https://avatars.githubusercontent.com/u/76567250?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/g11tech",
    "html_url": "https://github.com/g11tech",
    "followers_url": "https://api.github.com/users/g11tech/followers",
    "following_url": "https://api.github.com/users/g11tech/following{/other_user}",
    "gists_url": "https://api.github.com/users/g11tech/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/g11tech/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/g11tech/subscriptions",
    "organizations_url": "https://api.github.com/users/g11tech/orgs",
    "repos_url": "https://api.github.com/users/g11tech/repos",
    "events_url": "https://api.github.com/users/g11tech/events{/privacy}",
    "received_events_url": "https://api.github.com/users/g11tech/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3352623099,
      "node_id": "MDU6TGFiZWwzMzUyNjIzMDk5",
      "url": "https://api.github.com/repos/ChainSafe/lodestar/labels/spec-bellatrix%20%F0%9F%90%BC",
      "name": "spec-bellatrix 🐼",
      "color": "6baed6",
      "default": false,
      "description": "Issues targeting the merge spec version."
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "g11tech",
    "id": 76567250,
    "node_id": "MDQ6VXNlcjc2NTY3MjUw",
    "avatar_url": "https://avatars.githubusercontent.com/u/76567250?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/g11tech",
    "html_url": "https://github.com/g11tech",
    "followers_url": "https://api.github.com/users/g11tech/followers",
    "following_url": "https://api.github.com/users/g11tech/following{/other_user}",
    "gists_url": "https://api.github.com/users/g11tech/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/g11tech/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/g11tech/subscriptions",
    "organizations_url": "https://api.github.com/users/g11tech/orgs",
    "repos_url": "https://api.github.com/users/g11tech/repos",
    "events_url": "https://api.github.com/users/g11tech/events{/privacy}",
    "received_events_url": "https://api.github.com/users/g11tech/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "g11tech",
      "id": 76567250,
      "node_id": "MDQ6VXNlcjc2NTY3MjUw",
      "avatar_url": "https://avatars.githubusercontent.com/u/76567250?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/g11tech",
      "html_url": "https://github.com/g11tech",
      "followers_url": "https://api.github.com/users/g11tech/followers",
      "following_url": "https://api.github.com/users/g11tech/following{/other_user}",
      "gists_url": "https://api.github.com/users/g11tech/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/g11tech/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/g11tech/subscriptions",
      "organizations_url": "https://api.github.com/users/g11tech/orgs",
      "repos_url": "https://api.github.com/users/g11tech/repos",
      "events_url": "https://api.github.com/users/g11tech/events{/privacy}",
      "received_events_url": "https://api.github.com/users/g11tech/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2021-12-07T08:51:50Z",
  "updated_at": "2022-05-27T12:29:35Z",
  "closed_at": "2022-05-27T12:29:35Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "At time of the block proposal, one needs to signal to EL to prepare payload, it needs to be investigated if preparePayload can  be executed at optimal time as early as possible giving maximum time to EL for preparing payload.\r\ncontext: https://github.com/sigp/lighthouse/issues/2715",
  "closed_by": {
    "login": "g11tech",
    "id": 76567250,
    "node_id": "MDQ6VXNlcjc2NTY3MjUw",
    "avatar_url": "https://avatars.githubusercontent.com/u/76567250?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/g11tech",
    "html_url": "https://github.com/g11tech",
    "followers_url": "https://api.github.com/users/g11tech/followers",
    "following_url": "https://api.github.com/users/g11tech/following{/other_user}",
    "gists_url": "https://api.github.com/users/g11tech/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/g11tech/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/g11tech/subscriptions",
    "organizations_url": "https://api.github.com/users/g11tech/orgs",
    "repos_url": "https://api.github.com/users/g11tech/repos",
    "events_url": "https://api.github.com/users/g11tech/events{/privacy}",
    "received_events_url": "https://api.github.com/users/g11tech/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3488/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3488/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1028990385",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/3488#issuecomment-1028990385",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3488",
    "id": 1028990385,
    "node_id": "IC_kwDOCD5_Gc49VSWx",
    "user": {
      "login": "g11tech",
      "id": 76567250,
      "node_id": "MDQ6VXNlcjc2NTY3MjUw",
      "avatar_url": "https://avatars.githubusercontent.com/u/76567250?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/g11tech",
      "html_url": "https://github.com/g11tech",
      "followers_url": "https://api.github.com/users/g11tech/followers",
      "following_url": "https://api.github.com/users/g11tech/following{/other_user}",
      "gists_url": "https://api.github.com/users/g11tech/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/g11tech/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/g11tech/subscriptions",
      "organizations_url": "https://api.github.com/users/g11tech/orgs",
      "repos_url": "https://api.github.com/users/g11tech/repos",
      "events_url": "https://api.github.com/users/g11tech/events{/privacy}",
      "received_events_url": "https://api.github.com/users/g11tech/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-02-03T13:27:20Z",
    "updated_at": "2022-02-03T13:27:20Z",
    "author_association": "CONTRIBUTOR",
    "body": "UPDATE: @MarekM25 (Nethermind) pointed out that EL's hardly get any time to prepare payloads, from nothing to max about 40-50ms\r\n```\r\n2022-02-02 07:23:36.5174|INFO|188|Executing JSON RPC call engine_forkchoiceUpdatedV1 with params [{\r\n  \"headBlockHash\": \"0x2c984ebdde041c106b18b43858f72bbf25984ddf5e273e816a919c2a3784ad80\",\r\n  \"safeBlockHash\": \"0x2c984ebdde041c106b18b43858f72bbf25984ddf5e273e816a919c2a3784ad80\",\r\n  \"finalizedBlockHash\": \"0x9b033fb932f4d35f77763240e4321e2c9ee12405e11b5e8292fbdc3c9ece499a\"\r\n}] \r\n2022-02-02 07:23:48.0749|INFO|148|Executing JSON RPC call engine_forkchoiceUpdatedV1 with params [{\r\n  \"headBlockHash\": \"0x2c984ebdde041c106b18b43858f72bbf25984ddf5e273e816a919c2a3784ad80\",\r\n  \"safeBlockHash\": \"0x2c984ebdde041c106b18b43858f72bbf25984ddf5e273e816a919c2a3784ad80\",\r\n  \"finalizedBlockHash\": \"0x9b033fb932f4d35f77763240e4321e2c9ee12405e11b5e8292fbdc3c9ece499a\"\r\n},{\r\n  \"timestamp\": \"0x61fa3184\",\r\n  \"random\": \"0x4006d2fdf04d1896879f15012be4ef51c4383c92a8e3c46a7b9e8a8de0f588d9\",\r\n  \"suggestedFeeRecipient\": \"0x0000000000000000000000000000000000000000\"\r\n}] \r\n2022-02-02 07:23:48.0749|INFO|149|Sealed block 290373 (0xce2cdc...f4fd12), diff: 0, tx count: 0 \r\n2022-02-02 07:23:48.0763|INFO|149|Sealed eth2 block 290373 (0xce2cdc...f4fd12), diff: 0, tx count: 0 \r\n2022-02-02 07:23:48.0763|INFO|20|Processed     290373 |   11,667ms, mgasps    0.00 total    0.02, tps    0.00 total    0.45, bps    0.09 total    0.08, recv queue 0, proc queue 0 \r\n2022-02-02 07:23:48.0763|INFO|149|Executing JSON RPC call engine_getPayloadV1 with params [0x87ca98484a6bb833] \r\n2022-02-02 07:23:48.0763|INFO|149|Hash: 0xce2cdcf439c8e5913127165923361fe00b965c2e922ff5daad453bd2f2f4fd12\r\n``` \r\nThis behavior is similar across all clients, which means all CL clients are currently doing the same call flow of prepare payload call -> get payload call one after the other in the same produceBlock flow.\r\n\r\n@MarekM25 futher shared this data on mainnet block execution/production times: (execution/production times would almost be similar):\r\n\r\n![image](https://user-images.githubusercontent.com/76567250/152350620-ec42f247-800a-4a30-aad4-69aeac7e9a28.png)\r\nHere, 2k = 2s is the typical time needed to prepare a mainnet block.\r\n\r\nIt means that timing PreparePayload is the next important step, [here](https://discord.com/channels/595666850260713488/892088344438255616/938760962318684191) is some discussion on Eth R&D discord interop regarding the same.\r\ntl-dr: Need to somehow call prepare payload before the actual produce block, and suggested calling prepare payload consecutively be an idempotent operation (i.e. consecutive calls to prepare payload with the same exact params be accepted without any issue, and keep building the payload). This way CL could have lot of maneuvering to devise strategies to trigger the prepare payload without worrying about caching the payloadId which is basically the handle to fetch the payload.\r\n\r\ncc @dapplion @wemeetagain ",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1028990385/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1029624737",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/3488#issuecomment-1029624737",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3488",
    "id": 1029624737,
    "node_id": "IC_kwDOCD5_Gc49XtOh",
    "user": {
      "login": "dapplion",
      "id": 35266934,
      "node_id": "MDQ6VXNlcjM1MjY2OTM0",
      "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dapplion",
      "html_url": "https://github.com/dapplion",
      "followers_url": "https://api.github.com/users/dapplion/followers",
      "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
      "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
      "organizations_url": "https://api.github.com/users/dapplion/orgs",
      "repos_url": "https://api.github.com/users/dapplion/repos",
      "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dapplion/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-02-04T04:31:20Z",
    "updated_at": "2022-02-04T04:31:20Z",
    "author_association": "MEMBER",
    "body": "That's a good point, let's wait for consensus on the best course of action and then implement",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1029624737/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1029931017",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/3488#issuecomment-1029931017",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3488",
    "id": 1029931017,
    "node_id": "IC_kwDOCD5_Gc49Y4AJ",
    "user": {
      "login": "g11tech",
      "id": 76567250,
      "node_id": "MDQ6VXNlcjc2NTY3MjUw",
      "avatar_url": "https://avatars.githubusercontent.com/u/76567250?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/g11tech",
      "html_url": "https://github.com/g11tech",
      "followers_url": "https://api.github.com/users/g11tech/followers",
      "following_url": "https://api.github.com/users/g11tech/following{/other_user}",
      "gists_url": "https://api.github.com/users/g11tech/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/g11tech/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/g11tech/subscriptions",
      "organizations_url": "https://api.github.com/users/g11tech/orgs",
      "repos_url": "https://api.github.com/users/g11tech/repos",
      "events_url": "https://api.github.com/users/g11tech/events{/privacy}",
      "received_events_url": "https://api.github.com/users/g11tech/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-02-04T12:10:22Z",
    "updated_at": "2022-02-04T12:10:22Z",
    "author_association": "CONTRIBUTOR",
    "body": "UPDATE: It has been [suggested](https://discord.com/channels/595666850260713488/892088344438255616/939109894525681684), that CL if it has to propose in the next slot, makes fcU calls \r\n- if the block for the slot has arrived and processed\r\n- 4 seconds into the slot if the block hasn't arrived by then assuming the slot is skipped\r\n- any subsequent head changes\r\n\r\nHowever another question begs clarity:\r\n  before the fcU should the queued attestations (attestations of current slot which are applicable on next slot where the CL is proposing) be processed to get the correct head?",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1029931017/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 1
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1139573298",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/3488#issuecomment-1139573298",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3488",
    "id": 1139573298,
    "node_id": "IC_kwDOCD5_Gc5D7IIy",
    "user": {
      "login": "g11tech",
      "id": 76567250,
      "node_id": "MDQ6VXNlcjc2NTY3MjUw",
      "avatar_url": "https://avatars.githubusercontent.com/u/76567250?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/g11tech",
      "html_url": "https://github.com/g11tech",
      "followers_url": "https://api.github.com/users/g11tech/followers",
      "following_url": "https://api.github.com/users/g11tech/following{/other_user}",
      "gists_url": "https://api.github.com/users/g11tech/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/g11tech/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/g11tech/subscriptions",
      "organizations_url": "https://api.github.com/users/g11tech/orgs",
      "repos_url": "https://api.github.com/users/g11tech/repos",
      "events_url": "https://api.github.com/users/g11tech/events{/privacy}",
      "received_events_url": "https://api.github.com/users/g11tech/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-27T12:29:35Z",
    "updated_at": "2022-05-27T12:29:35Z",
    "author_association": "CONTRIBUTOR",
    "body": "closing as https://github.com/ChainSafe/lodestar/pull/3965 is merged, optimization is being tackled in separate issue https://github.com/ChainSafe/lodestar/issues/4054",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1139573298/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
