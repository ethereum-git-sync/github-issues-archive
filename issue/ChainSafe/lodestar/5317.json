{
  "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5317",
  "repository_url": "https://api.github.com/repos/ChainSafe/lodestar",
  "labels_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5317/labels{/name}",
  "comments_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5317/comments",
  "events_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5317/events",
  "html_url": "https://github.com/ChainSafe/lodestar/issues/5317",
  "id": 1646117161,
  "node_id": "I_kwDOCD5_Gc5iHcEp",
  "number": 5317,
  "title": "Beacon node exits uncontrolled (too early) during graceful shutdown",
  "user": {
    "login": "nflaig",
    "id": 38436224,
    "node_id": "MDQ6VXNlcjM4NDM2MjI0",
    "avatar_url": "https://avatars.githubusercontent.com/u/38436224?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/nflaig",
    "html_url": "https://github.com/nflaig",
    "followers_url": "https://api.github.com/users/nflaig/followers",
    "following_url": "https://api.github.com/users/nflaig/following{/other_user}",
    "gists_url": "https://api.github.com/users/nflaig/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/nflaig/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/nflaig/subscriptions",
    "organizations_url": "https://api.github.com/users/nflaig/orgs",
    "repos_url": "https://api.github.com/users/nflaig/repos",
    "events_url": "https://api.github.com/users/nflaig/events{/privacy}",
    "received_events_url": "https://api.github.com/users/nflaig/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1200090447,
      "node_id": "MDU6TGFiZWwxMjAwMDkwNDQ3",
      "url": "https://api.github.com/repos/ChainSafe/lodestar/labels/prio-high",
      "name": "prio-high",
      "color": "fd9579",
      "default": false,
      "description": "Resolve issues as soon as possible."
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/milestones/29",
    "html_url": "https://github.com/ChainSafe/lodestar/milestone/29",
    "labels_url": "https://api.github.com/repos/ChainSafe/lodestar/milestones/29/labels",
    "id": 9244445,
    "node_id": "MI_kwDOCD5_Gc4AjQ8d",
    "number": 29,
    "title": "v1.9.0",
    "description": "",
    "creator": {
      "login": "philknows",
      "id": 58080811,
      "node_id": "MDQ6VXNlcjU4MDgwODEx",
      "avatar_url": "https://avatars.githubusercontent.com/u/58080811?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/philknows",
      "html_url": "https://github.com/philknows",
      "followers_url": "https://api.github.com/users/philknows/followers",
      "following_url": "https://api.github.com/users/philknows/following{/other_user}",
      "gists_url": "https://api.github.com/users/philknows/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/philknows/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/philknows/subscriptions",
      "organizations_url": "https://api.github.com/users/philknows/orgs",
      "repos_url": "https://api.github.com/users/philknows/repos",
      "events_url": "https://api.github.com/users/philknows/events{/privacy}",
      "received_events_url": "https://api.github.com/users/philknows/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 7,
    "closed_issues": 13,
    "state": "open",
    "created_at": "2023-04-04T13:04:23Z",
    "updated_at": "2023-06-02T04:59:39Z",
    "due_on": null,
    "closed_at": null
  },
  "comments": 3,
  "created_at": "2023-03-29T16:07:08Z",
  "updated_at": "2023-05-24T20:36:23Z",
  "closed_at": "2023-05-24T15:56:14Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "**Problem**\r\n\r\nLodestar BN does not wait for [all jobs](https://github.com/ChainSafe/lodestar/blob/d360e62bde4abb566444d71f45fdc4fd74584ae7/packages/beacon-node/src/node/nodejs.ts#L309) to be finished during graceful shutdown.\r\nThis is problematic as some operations are not executed such as writing BLSToExecutionChanges to disk (see [discord discussion](https://discord.com/channels/593655374469660673/593655641445367808/1090250663344209983))\r\n\r\n**Root cause**\r\n\r\nLodestar uses [threads package](https://www.npmjs.com/package/@chainsafe/threads) which installs [SIGTERM signal listeners](https://github.com/andywer/threads.js/blob/0d1a882f09273cb8482902ae2601fe4ffed6fbab/src/master/implementation.node.ts#L153)  that exit the main process once all workers are terminated, see [terminateWorkersAndMaster](https://github.com/andywer/threads.js/blob/0d1a882f09273cb8482902ae2601fe4ffed6fbab/src/master/implementation.node.ts#L142).\r\n\r\n\r\n**Related**\r\n\r\n- https://github.com/andywer/threads.js/pull/198\r\n- https://github.com/andywer/threads.js/issues/388\r\n- https://github.com/andywer/threads.js/pull/324\r\n- https://github.com/MatrixAI/Polykey-Desktop/issues/79\r\n- https://github.com/andywer/threads.js/pull/329\r\n\r\n\r\n",
  "closed_by": {
    "login": "wemeetagain",
    "id": 1348242,
    "node_id": "MDQ6VXNlcjEzNDgyNDI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1348242?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/wemeetagain",
    "html_url": "https://github.com/wemeetagain",
    "followers_url": "https://api.github.com/users/wemeetagain/followers",
    "following_url": "https://api.github.com/users/wemeetagain/following{/other_user}",
    "gists_url": "https://api.github.com/users/wemeetagain/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/wemeetagain/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/wemeetagain/subscriptions",
    "organizations_url": "https://api.github.com/users/wemeetagain/orgs",
    "repos_url": "https://api.github.com/users/wemeetagain/repos",
    "events_url": "https://api.github.com/users/wemeetagain/events{/privacy}",
    "received_events_url": "https://api.github.com/users/wemeetagain/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5317/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5317/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1489007822",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/5317#issuecomment-1489007822",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5317",
    "id": 1489007822,
    "node_id": "IC_kwDOCD5_Gc5YwHTO",
    "user": {
      "login": "g11tech",
      "id": 76567250,
      "node_id": "MDQ6VXNlcjc2NTY3MjUw",
      "avatar_url": "https://avatars.githubusercontent.com/u/76567250?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/g11tech",
      "html_url": "https://github.com/g11tech",
      "followers_url": "https://api.github.com/users/g11tech/followers",
      "following_url": "https://api.github.com/users/g11tech/following{/other_user}",
      "gists_url": "https://api.github.com/users/g11tech/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/g11tech/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/g11tech/subscriptions",
      "organizations_url": "https://api.github.com/users/g11tech/orgs",
      "repos_url": "https://api.github.com/users/g11tech/repos",
      "events_url": "https://api.github.com/users/g11tech/events{/privacy}",
      "received_events_url": "https://api.github.com/users/g11tech/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-29T17:22:55Z",
    "updated_at": "2023-03-29T17:22:55Z",
    "author_association": "CONTRIBUTOR",
    "body": "yes i confirm this to be issue as pointed by @nflaig : https://github.com/andywer/threads.js/blob/0d1a882f09273cb8482902ae2601fe4ffed6fbab/src/master/implementation.node.ts#L142\r\n\r\nas soon as i comment out the lines in the local nodemodules, node close follow all close steps (but obviously workers keep going on still), else it seems to be processing this event on the first true async await call (await network.close)\r\n\r\nSo we might need to export the `terminateWorkerAndMaster` and call it explicity and remove these\r\n\r\n```\r\nprocess.on(\"SIGINT\", () => terminateWorkersAndMaster())\r\n  process.on(\"SIGTERM\", () => terminateWorkersAndMaster())\r\n\r\n``",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1489007822/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1496344218",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/5317#issuecomment-1496344218",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5317",
    "id": 1496344218,
    "node_id": "IC_kwDOCD5_Gc5ZMGaa",
    "user": {
      "login": "nflaig",
      "id": 38436224,
      "node_id": "MDQ6VXNlcjM4NDM2MjI0",
      "avatar_url": "https://avatars.githubusercontent.com/u/38436224?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nflaig",
      "html_url": "https://github.com/nflaig",
      "followers_url": "https://api.github.com/users/nflaig/followers",
      "following_url": "https://api.github.com/users/nflaig/following{/other_user}",
      "gists_url": "https://api.github.com/users/nflaig/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nflaig/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nflaig/subscriptions",
      "organizations_url": "https://api.github.com/users/nflaig/orgs",
      "repos_url": "https://api.github.com/users/nflaig/repos",
      "events_url": "https://api.github.com/users/nflaig/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nflaig/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-04T17:29:40Z",
    "updated_at": "2023-05-24T20:36:23Z",
    "author_association": "MEMBER",
    "body": "As discussed in Apr 4 standup we want to push a fix for this before the Shapella hardfork to address the BLSToExecutionChanges issue and other possible issues related to not shutting down properly.\r\n\r\nFor the quickfix we will have to\r\n- [x] release a new version of @chainsafe/threads @wemeetagain \r\n- [x] explicitly call process.exit after `node.close` succeeds (code: 0) or fails (code: 1) @nflaig\r\n- [x] retest that BLSToExecutionChanges  are correctly persistet, best if @g11tech can confirm this once patch is implemented\r\n\r\nIn https://github.com/ChainSafe/lodestar/pull/5330 a cleaner solution will be implemented to make sure all active handlers are actually terminated and we don't need to rely on process.exit. I documented how to work with the branch in case anyone is bored and wants to go on an active handles hunt",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1496344218/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1509520523",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/5317#issuecomment-1509520523",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5317",
    "id": 1509520523,
    "node_id": "IC_kwDOCD5_Gc5Z-XSL",
    "user": {
      "login": "philknows",
      "id": 58080811,
      "node_id": "MDQ6VXNlcjU4MDgwODEx",
      "avatar_url": "https://avatars.githubusercontent.com/u/58080811?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/philknows",
      "html_url": "https://github.com/philknows",
      "followers_url": "https://api.github.com/users/philknows/followers",
      "following_url": "https://api.github.com/users/philknows/following{/other_user}",
      "gists_url": "https://api.github.com/users/philknows/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/philknows/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/philknows/subscriptions",
      "organizations_url": "https://api.github.com/users/philknows/orgs",
      "repos_url": "https://api.github.com/users/philknows/repos",
      "events_url": "https://api.github.com/users/philknows/events{/privacy}",
      "received_events_url": "https://api.github.com/users/philknows/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-15T05:26:06Z",
    "updated_at": "2023-04-15T05:26:06Z",
    "author_association": "MEMBER",
    "body": "Due to not being able to make the timeline for the Shapella hard fork (wasn't super urgent since other clients were able to handle the load as well), we can wait for #5330 and fix this optimally rather than implementing a workaround.",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1509520523/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
