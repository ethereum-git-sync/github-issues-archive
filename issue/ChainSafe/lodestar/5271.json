{
  "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5271",
  "repository_url": "https://api.github.com/repos/ChainSafe/lodestar",
  "labels_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5271/labels{/name}",
  "comments_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5271/comments",
  "events_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5271/events",
  "html_url": "https://github.com/ChainSafe/lodestar/issues/5271",
  "id": 1627812238,
  "node_id": "I_kwDOCD5_Gc5hBnGO",
  "number": 5271,
  "title": "getStateValidators does not dedupe validators",
  "user": {
    "login": "nflaig",
    "id": 38436224,
    "node_id": "MDQ6VXNlcjM4NDM2MjI0",
    "avatar_url": "https://avatars.githubusercontent.com/u/38436224?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/nflaig",
    "html_url": "https://github.com/nflaig",
    "followers_url": "https://api.github.com/users/nflaig/followers",
    "following_url": "https://api.github.com/users/nflaig/following{/other_user}",
    "gists_url": "https://api.github.com/users/nflaig/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/nflaig/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/nflaig/subscriptions",
    "organizations_url": "https://api.github.com/users/nflaig/orgs",
    "repos_url": "https://api.github.com/users/nflaig/repos",
    "events_url": "https://api.github.com/users/nflaig/events{/privacy}",
    "received_events_url": "https://api.github.com/users/nflaig/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1478321239,
      "node_id": "MDU6TGFiZWwxNDc4MzIxMjM5",
      "url": "https://api.github.com/repos/ChainSafe/lodestar/labels/meta-discussion",
      "name": "meta-discussion",
      "color": "a6bddb",
      "default": false,
      "description": "Indicates a topic that requires input from various developers."
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2023-03-16T16:06:28Z",
  "updated_at": "2023-03-20T09:09:05Z",
  "closed_at": null,
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "**Describe the bug**\r\n\r\nNot sure if this should be considered a bug but I think it is better that we dedupe the result of [getStateValidators](https://ethereum.github.io/beacon-APIs/#/Beacon/getStateValidators) if the same validator index/pubkey is provided multiple times.\r\n\r\n**Current behavior**\r\n\r\nReturns the same validator multiple times if index or pubkey is provided multiple times.\r\n\r\nSee implementation https://github.com/ChainSafe/lodestar/blob/3e254d588ce5169a1fd08e2b6ea6b7f509695fbc/packages/beacon-node/src/api/impl/beacon/state/index.ts#L58\r\n\r\n**Expected behavior**\r\n\r\nShould dedupe the result and only return each unique validator once.\r\n\r\n**Steps to Reproduce**\r\n\r\nStart lodestar in dev mode\r\n\r\n```sh\r\n./lodestar dev  --genesisValidators 8 --startValidators 0..7\r\n```\r\n\r\nsend http request to getStateValidators API\r\n\r\n```sh\r\ncurl \"http://localhost:9596/eth/v1/beacon/states/head/validators?id=1,1\" | jq\r\n```\r\n\r\nbe surprised that the validator with index 1 is returned twice\r\n\r\n```json\r\n{\r\n  \"data\": [\r\n    {\r\n      \"index\": \"1\",\r\n      \"balance\": \"32000000000\",\r\n      \"status\": \"active_ongoing\",\r\n      \"validator\": {\r\n        \"pubkey\": \"0xb89bebc699769726a318c8e9971bd3171297c61aea4a6578a7a4f94b547dcba5bac16a89108b6b6a1fe3695d1a874a0b\",\r\n        \"withdrawal_credentials\": \"0x00ec7ef7780c9d151597924036262dd28dc60e1228f4da6fecf9d402cb3f3594\",\r\n        \"effective_balance\": \"32000000000\",\r\n        \"slashed\": false,\r\n        \"activation_eligibility_epoch\": \"0\",\r\n        \"activation_epoch\": \"0\",\r\n        \"exit_epoch\": \"18446744073709551615\",\r\n        \"withdrawable_epoch\": \"18446744073709551615\"\r\n      }\r\n    },\r\n    {\r\n      \"index\": \"1\",\r\n      \"balance\": \"32000000000\",\r\n      \"status\": \"active_ongoing\",\r\n      \"validator\": {\r\n        \"pubkey\": \"0xb89bebc699769726a318c8e9971bd3171297c61aea4a6578a7a4f94b547dcba5bac16a89108b6b6a1fe3695d1a874a0b\",\r\n        \"withdrawal_credentials\": \"0x00ec7ef7780c9d151597924036262dd28dc60e1228f4da6fecf9d402cb3f3594\",\r\n        \"effective_balance\": \"32000000000\",\r\n        \"slashed\": false,\r\n        \"activation_eligibility_epoch\": \"0\",\r\n        \"activation_epoch\": \"0\",\r\n        \"exit_epoch\": \"18446744073709551615\",\r\n        \"withdrawable_epoch\": \"18446744073709551615\"\r\n      }\r\n    }\r\n  ],\r\n  \"execution_optimistic\": false\r\n}\r\n```\r\n\r\n\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5271/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5271/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1475130830",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/5271#issuecomment-1475130830",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5271",
    "id": 1475130830,
    "node_id": "IC_kwDOCD5_Gc5X7LXO",
    "user": {
      "login": "dapplion",
      "id": 35266934,
      "node_id": "MDQ6VXNlcjM1MjY2OTM0",
      "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dapplion",
      "html_url": "https://github.com/dapplion",
      "followers_url": "https://api.github.com/users/dapplion/followers",
      "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
      "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
      "organizations_url": "https://api.github.com/users/dapplion/orgs",
      "repos_url": "https://api.github.com/users/dapplion/repos",
      "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dapplion/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-19T07:03:16Z",
    "updated_at": "2023-03-19T07:03:16Z",
    "author_association": "MEMBER",
    "body": "I mean, you requested the validator at index 1 twice, so it's not wrong tor return the validator with index 1 twice. What does the spec says about this?",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1475130830/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1475142161",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/5271#issuecomment-1475142161",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5271",
    "id": 1475142161,
    "node_id": "IC_kwDOCD5_Gc5X7OIR",
    "user": {
      "login": "nflaig",
      "id": 38436224,
      "node_id": "MDQ6VXNlcjM4NDM2MjI0",
      "avatar_url": "https://avatars.githubusercontent.com/u/38436224?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nflaig",
      "html_url": "https://github.com/nflaig",
      "followers_url": "https://api.github.com/users/nflaig/followers",
      "following_url": "https://api.github.com/users/nflaig/following{/other_user}",
      "gists_url": "https://api.github.com/users/nflaig/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nflaig/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nflaig/subscriptions",
      "organizations_url": "https://api.github.com/users/nflaig/orgs",
      "repos_url": "https://api.github.com/users/nflaig/repos",
      "events_url": "https://api.github.com/users/nflaig/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nflaig/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-19T07:55:31Z",
    "updated_at": "2023-03-19T07:55:31Z",
    "author_association": "MEMBER",
    "body": "@dapplion There is no clear guidance on this in the Beacon API spec itself and neither does the OpenAPI spec details on how to handle duplicate keys in an array query string parameter.\r\n\r\nHowever, the in the Beacon API spec it is at least enforced to have [uniqueItems](https://github.com/ethereum/beacon-APIs/blob/f087fbf2764e657578a6c29bdf0261b36ee8db1e/apis/beacon/states/validators.yaml#L24) which would fail the example query of the issue during schema validation. But then the question would still be what do we do if the same validator is queries with pubkey and index, the schema validation would not fail in that case.\r\n\r\nRegarding, stricter schema validation, I think we can not enforce this at this point as it likely would just cause issues without a major benefit in most cases.\r\n\r\nI think it is fine how our API currently behaves, and considering breaking things if we change the behavior we might just wanna keep it as is. The most important thing is that our APIs behave the same across the board to allow users to make assumptions and potentially save some time.\r\n\r\nThis issue is mostly intended to at least quickly discuss this topic",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1475142161/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1475150008",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/5271#issuecomment-1475150008",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5271",
    "id": 1475150008,
    "node_id": "IC_kwDOCD5_Gc5X7QC4",
    "user": {
      "login": "dapplion",
      "id": 35266934,
      "node_id": "MDQ6VXNlcjM1MjY2OTM0",
      "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dapplion",
      "html_url": "https://github.com/dapplion",
      "followers_url": "https://api.github.com/users/dapplion/followers",
      "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
      "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
      "organizations_url": "https://api.github.com/users/dapplion/orgs",
      "repos_url": "https://api.github.com/users/dapplion/repos",
      "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dapplion/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-19T08:27:59Z",
    "updated_at": "2023-03-19T08:27:59Z",
    "author_association": "MEMBER",
    "body": "If the spec says uniqueItems, then let's obey by it. uniqueItems seems to mean to return 400 if the request contains duplicate items",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1475150008/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1475161754",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/5271#issuecomment-1475161754",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5271",
    "id": 1475161754,
    "node_id": "IC_kwDOCD5_Gc5X7S6a",
    "user": {
      "login": "nflaig",
      "id": 38436224,
      "node_id": "MDQ6VXNlcjM4NDM2MjI0",
      "avatar_url": "https://avatars.githubusercontent.com/u/38436224?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nflaig",
      "html_url": "https://github.com/nflaig",
      "followers_url": "https://api.github.com/users/nflaig/followers",
      "following_url": "https://api.github.com/users/nflaig/following{/other_user}",
      "gists_url": "https://api.github.com/users/nflaig/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nflaig/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nflaig/subscriptions",
      "organizations_url": "https://api.github.com/users/nflaig/orgs",
      "repos_url": "https://api.github.com/users/nflaig/repos",
      "events_url": "https://api.github.com/users/nflaig/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nflaig/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-19T09:04:16Z",
    "updated_at": "2023-03-20T09:09:05Z",
    "author_association": "MEMBER",
    "body": "@dapplion the spec also says [maxItems 30](https://github.com/ethereum/beacon-APIs/blob/f087fbf2764e657578a6c29bdf0261b36ee8db1e/apis/beacon/states/validators.yaml#L23) but nobody (not a single CL client) enforces that as far as I have seen. That's a bit of a pity in my opinion as stricter APIs are usually a good thing to ensure consistency and predictability, even across different implemenations.\r\n\r\n Unfortunately, I think it is too late to fully enforce the OpenAPI spec requirements as downstream tooling relies on this lax API validation. For example, rocketpool sends a request like this `eth/v1/beacon/states/head/validators?id=<1000 validator pubkeys, comma-separated>` and it works with all CL clients.",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1475161754/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1475435073",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/5271#issuecomment-1475435073",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5271",
    "id": 1475435073,
    "node_id": "IC_kwDOCD5_Gc5X8VpB",
    "user": {
      "login": "dapplion",
      "id": 35266934,
      "node_id": "MDQ6VXNlcjM1MjY2OTM0",
      "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dapplion",
      "html_url": "https://github.com/dapplion",
      "followers_url": "https://api.github.com/users/dapplion/followers",
      "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
      "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
      "organizations_url": "https://api.github.com/users/dapplion/orgs",
      "repos_url": "https://api.github.com/users/dapplion/repos",
      "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dapplion/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-19T23:33:48Z",
    "updated_at": "2023-03-19T23:33:48Z",
    "author_association": "MEMBER",
    "body": "Ok, then let's de-duplicate",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1475435073/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
