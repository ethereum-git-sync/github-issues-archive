{
  "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5553",
  "repository_url": "https://api.github.com/repos/ChainSafe/lodestar",
  "labels_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5553/labels{/name}",
  "comments_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5553/comments",
  "events_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5553/events",
  "html_url": "https://github.com/ChainSafe/lodestar/issues/5553",
  "id": 1727439397,
  "node_id": "I_kwDOCD5_Gc5m9qIl",
  "number": 5553,
  "title": "Lighthouse VC to Lodestar BN aggregated attestation errors",
  "user": {
    "login": "nflaig",
    "id": 38436224,
    "node_id": "MDQ6VXNlcjM4NDM2MjI0",
    "avatar_url": "https://avatars.githubusercontent.com/u/38436224?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/nflaig",
    "html_url": "https://github.com/nflaig",
    "followers_url": "https://api.github.com/users/nflaig/followers",
    "following_url": "https://api.github.com/users/nflaig/following{/other_user}",
    "gists_url": "https://api.github.com/users/nflaig/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/nflaig/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/nflaig/subscriptions",
    "organizations_url": "https://api.github.com/users/nflaig/orgs",
    "repos_url": "https://api.github.com/users/nflaig/repos",
    "events_url": "https://api.github.com/users/nflaig/events{/privacy}",
    "received_events_url": "https://api.github.com/users/nflaig/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1200090447,
      "node_id": "MDU6TGFiZWwxMjAwMDkwNDQ3",
      "url": "https://api.github.com/repos/ChainSafe/lodestar/labels/prio-high",
      "name": "prio-high",
      "color": "fd9579",
      "default": false,
      "description": "Resolve issues as soon as possible."
    },
    {
      "id": 4116812272,
      "node_id": "LA_kwDOCD5_Gc71YZHw",
      "url": "https://api.github.com/repos/ChainSafe/lodestar/labels/scope-interop",
      "name": "scope-interop",
      "color": "980043",
      "default": false,
      "description": "Issues that fix interop issues between Lodestar and CL, EL or tooling."
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/milestones/33",
    "html_url": "https://github.com/ChainSafe/lodestar/milestone/33",
    "labels_url": "https://api.github.com/repos/ChainSafe/lodestar/milestones/33/labels",
    "id": 9640172,
    "node_id": "MI_kwDOCD5_Gc4Akxjs",
    "number": 33,
    "title": "v1.12.0",
    "description": "",
    "creator": {
      "login": "philknows",
      "id": 58080811,
      "node_id": "MDQ6VXNlcjU4MDgwODEx",
      "avatar_url": "https://avatars.githubusercontent.com/u/58080811?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/philknows",
      "html_url": "https://github.com/philknows",
      "followers_url": "https://api.github.com/users/philknows/followers",
      "following_url": "https://api.github.com/users/philknows/following{/other_user}",
      "gists_url": "https://api.github.com/users/philknows/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/philknows/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/philknows/subscriptions",
      "organizations_url": "https://api.github.com/users/philknows/orgs",
      "repos_url": "https://api.github.com/users/philknows/repos",
      "events_url": "https://api.github.com/users/philknows/events{/privacy}",
      "received_events_url": "https://api.github.com/users/philknows/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 5,
    "closed_issues": 15,
    "state": "open",
    "created_at": "2023-07-11T02:13:25Z",
    "updated_at": "2023-11-07T19:53:08Z",
    "due_on": null,
    "closed_at": null
  },
  "comments": 3,
  "created_at": "2023-05-26T11:25:50Z",
  "updated_at": "2023-11-07T19:53:08Z",
  "closed_at": "2023-11-07T19:53:08Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "### Describe the bug\r\n\r\nLighthouse VC is not able to produce aggregate attestations\r\n\r\n```\r\nMay 26 10:45:43.120 CRIT Error during attestation routine        slot: 6522826, committee_index: 19, error: \"Some endpoints failed, num_failed: 1 http://consensus:5052/ => RequestFailed(\\\"Failed to produce an aggregate attestation: StatusCode(500)\\\")\", service: attestation\r\n```\r\n\r\nOn Lodestar BN there is the following error\r\n\r\n```\r\nMay-26 10:45:43.119[rest]            error: Req req-1rji getAggregatedAttestation error  No attestation for slot=6522826 dataRoot=0xa609bb3a48bb75756afbd12c925314c8c274ecaa0ebd2ee5dfdee7ae8807306a\r\nError: No attestation for slot=6522826 dataRoot=0xa609bb3a48bb75756afbd12c925314c8c274ecaa0ebd2ee5dfdee7ae8807306a\r\nat AttestationPool.getAggregate (file:///usr/app/packages/beacon-node/src/chain/opPools/attestationPool.ts:136:13)\r\nat Object.getAggregatedAttestation (file:///usr/app/packages/beacon-node/src/api/impl/validator/index.ts:538:37)\r\nat processTicksAndRejections (node:internal/process/task_queues:95:5)\r\nat Object.handler (file:///usr/app/packages/api/src/utils/server/genericJsonServer.ts:45:23)\r\n```\r\n\r\n### Expected behavior\r\n\r\nAggregated attestations should work when running Lighthouse VC with Lodestar BN. No errors should be logged on both services.\r\n\r\n### Steps to reproduce\r\n\r\n1. Run Lodestar BN\r\n2. Attach Lighthouse VC with active validators\r\n3. Observe logs on both services\r\n\r\n### Versions\r\n\r\n- Lodestar: v1.8.0 / v1.9.0-rc.0\r\n- Lighthouse: v4.1.0 / v4.2.0",
  "closed_by": {
    "login": "philknows",
    "id": 58080811,
    "node_id": "MDQ6VXNlcjU4MDgwODEx",
    "avatar_url": "https://avatars.githubusercontent.com/u/58080811?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/philknows",
    "html_url": "https://github.com/philknows",
    "followers_url": "https://api.github.com/users/philknows/followers",
    "following_url": "https://api.github.com/users/philknows/following{/other_user}",
    "gists_url": "https://api.github.com/users/philknows/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/philknows/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/philknows/subscriptions",
    "organizations_url": "https://api.github.com/users/philknows/orgs",
    "repos_url": "https://api.github.com/users/philknows/repos",
    "events_url": "https://api.github.com/users/philknows/events{/privacy}",
    "received_events_url": "https://api.github.com/users/philknows/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5553/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5553/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1671177678",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/5553#issuecomment-1671177678",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5553",
    "id": 1671177678,
    "node_id": "IC_kwDOCD5_Gc5jnCXO",
    "user": {
      "login": "nflaig",
      "id": 38436224,
      "node_id": "MDQ6VXNlcjM4NDM2MjI0",
      "avatar_url": "https://avatars.githubusercontent.com/u/38436224?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nflaig",
      "html_url": "https://github.com/nflaig",
      "followers_url": "https://api.github.com/users/nflaig/followers",
      "following_url": "https://api.github.com/users/nflaig/following{/other_user}",
      "gists_url": "https://api.github.com/users/nflaig/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nflaig/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nflaig/subscriptions",
      "organizations_url": "https://api.github.com/users/nflaig/orgs",
      "repos_url": "https://api.github.com/users/nflaig/repos",
      "events_url": "https://api.github.com/users/nflaig/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nflaig/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-08-09T11:48:13Z",
    "updated_at": "2023-08-10T10:00:15Z",
    "author_association": "MEMBER",
    "body": "Based on the logs it is not clear to me why [getAggregatedAttestation](https://ethereum.github.io/beacon-APIs/#/ValidatorRequiredApi/getAggregatedAttestation) fails, everything in the slot besides getting the aggregate attestation looks pretty healthy.\r\n\r\nPossibly related to different `attestation_data_root` stored in cache compared to what Lighthouse VC passes as query parameter (**Edit:** After a bit more debugging this seems to be the issue), or something else we are handling different. As this happens consistently (100% of the time), it must be something deterministic and is likely unrelated to any timing / processing / lag issues.\r\n\r\nhttps://github.com/ChainSafe/lodestar/blob/e690ac6df8b6c3e766fd5c245254575dad061f7b/packages/beacon-node/src/chain/opPools/attestationPool.ts#L131-L133\r\n\r\nBelow are the logs from both Lodestar BN and Lighthouse VC for slot **7062817** (09/08/2023 10:43:47 UTC)\r\n\r\n### Lodestar BN\r\n\r\nImport and processing of block\r\n```ts\r\nAug-09 10:43:43.099[chain]         verbose: Running prepareForNextSlot nextEpoch=220714, prepareSlot=7062817, headSlot=7062816, headRoot=0x76296e1027bfc345be2e485863a440c67cb1c8eabc8c46103ac1e8f143ab550e, isEpochTransition=false\r\nAug-09 10:43:47.018[chain]         verbose: Clock slot slot=7062817\r\nAug-09 10:43:48.973[network]       verbose: Received gossip block slot=7062817, root=0x7d34…a9d0, curentSlot=7062817, peerId=16Uiu2HAmPkRtMYiQfDj2NHvX3sa1ZfNcGRjKehXmLBW9os1ZeTig, delaySec=1.88100004196167, recvToVal=0.09200000762939453\r\nAug-09 10:43:49.099[chain]         verbose: Transitioned gossip block slot=7062817, recvToTransition=0.21799993515014648\r\nAug-09 10:43:49.104[chain]         verbose: Verified block signatures slot=7062817, recvToSigVer=0.22300004959106445\r\nAug-09 10:43:49.104[chain]           debug: Persist block to hot DB slot=7062817, root=0x7d34f71fd09eb268d68e2735692026046328a19feb84096070d8f175b514a9d0\r\nAug-09 10:43:49.165[sync]          verbose: Added unknown block to pendingBlocks root=0x7d34f71fd09eb268d68e2735692026046328a19feb84096070d8f175b514a9d0\r\nAug-09 10:43:49.165[sync]          verbose: Downloading unknown block root=0x7d34f71fd09eb268d68e2735692026046328a19feb84096070d8f175b514a9d0, pendingBlocks=1\r\nAug-09 10:43:49.285[chain]         verbose: Verified execution payload slot=7062817, recvToVerifiedExecPayload=0.40400004386901855\r\nAug-09 10:43:49.286[chain]         verbose: Added block to forkchoice and state cache slot=7062817, root=0x7d34f71fd09eb268d68e2735692026046328a19feb84096070d8f175b514a9d0\r\nAug-09 10:43:49.399[chain]         verbose: New chain head slot=7062817, root=0x7d34f71fd09eb268d68e2735692026046328a19feb84096070d8f175b514a9d0, delaySec=2.3989999294281006\r\nAug-09 10:43:49.401[chain]         verbose: Imported block slot=7062817, recvToImportedBlock=0.5199999809265137\r\nAug-09 10:43:49.401[chain]         verbose: Block processed slot=7062817, root=0x7d34f71fd09eb268d68e2735692026046328a19feb84096070d8f175b514a9d0, delaySec=2.4010000228881836\r\nAug-09 10:43:49.452[rest]            debug: Req req-fii0 172.18.0.7 getBlockV2\r\nAug-09 10:43:49.471[rest]            debug: Res req-fii0 getBlockV2 - 200\r\nAug-09 10:43:50.041[sync]          verbose: Downloaded unknown block root=0x7d34f71fd09eb268d68e2735692026046328a19feb84096070d8f175b514a9d0, pendingBlocks=1, parentInForkchoice=true\r\nAug-09 10:43:50.041[sync]          verbose: Avoid proposer boost for this block of known proposer blockSlot=7062817, blockRoot=0x7d34f71fd09eb268d68e2735692026046328a19feb84096070d8f175b514a9d0, proposerIndex=370689\r\n```\r\n\r\nProduce and submit attestation\r\n```ts\r\nAug-09 10:43:51.010[rest]            debug: Req req-fii1 172.18.0.16 produceAttestationData\r\nAug-09 10:43:51.011[rest]            debug: Res req-fii1 produceAttestationData - 200\r\nAug-09 10:43:51.033[rest]            debug: Req req-fii2 172.18.0.16 submitPoolAttestations\r\nAug-09 10:43:51.160[vmon]            debug: Local validator published unaggregated attestation validatorIndex=xxx, slot=7062817, committeeIndex=xx, subnet=xx, sentPeers=5, delaySec=0.03399991989135742\r\nAug-09 10:43:51.162[rest]            debug: Res req-fii2 submitPoolAttestations - 200\r\n```\r\n\r\nSync log\r\n```ts\r\nAug-09 10:43:53.000[]                 info: Synced - slot: 7062817 - head: 0x7d34…a9d0 - exec-block: valid(17876827 0x7f96…) - finalized: 0x351d…cf71:220711 - peers: 49\r\n```\r\n\r\nGet aggregate attestation (500 error)\r\n```ts\r\nAug-09 10:43:55.001[rest]            debug: Req req-fii6 172.18.0.16 getAggregatedAttestation\r\nAug-09 10:43:55.001[rest]            error: Req req-fii6 getAggregatedAttestation error  No attestation for slot=7062817 dataRoot=0x4dbec5c57d8319d8f1bedf36418c851e261810f69eff757dee1b66c5a287125d\r\nError: No attestation for slot=7062817 dataRoot=0x4dbec5c57d8319d8f1bedf36418c851e261810f69eff757dee1b66c5a287125d\r\n    at AttestationPool.getAggregate (file:///usr/app/packages/beacon-node/src/chain/opPools/attestationPool.ts:136:13)\r\n    at Object.getAggregatedAttestation (file:///usr/app/packages/beacon-node/src/api/impl/validator/index.ts:602:47)\r\n    at processTicksAndRejections (node:internal/process/task_queues:95:5)\r\n    at Object.handler (file:///usr/app/packages/api/src/utils/server/genericJsonServer.ts:45:23)\r\nAug-09 10:43:55.002[rest]            debug: Res req-fii6 getAggregatedAttestation - 500\r\n```\r\n\r\nBased on validator monitor the submitted attestation was included on chain\r\n```ts\r\nAug-09 10:43:55.321[vmon]            debug: Local validator attestation is included in AggregatedAndProof validatorIndex=xxx, slot=7062817, committeeIndex=xx\r\nAug-09 10:44:02.043[vmon]            debug: Local validator attestation is included in block validatorIndex=xxx, slot=7062817, committeeIndex=xx, inclusionDistance=1, correctHead=true, participants=347\r\n```\r\n\r\n### Lighthouse VC\r\n\r\nPublish attestation\r\n```ts\r\nAug 09 10:43:51.161 INFO Successfully published attestations     type: unaggregated, slot: 7062817, committee_index: xx, head_block: 0x7d34f71fd09eb268d68e2735692026046328a19feb84096070d8f175b514a9d0, validator_indices: [xxx], count: 1, service: attestation\r\n```\r\n\r\nFailed to produce aggregate attestation\r\n```ts\r\nAug 09 10:43:55.002 CRIT Error during attestation routine        slot: 7062817, committee_index: xx, error: \"Some endpoints failed, num_failed: 1 http://consensus:5052/ => RequestFailed(\\\"Failed to produce an aggregate attestation: StatusCode(500)\\\")\", service: attestation\r\n```\r\n\r\nValidator status log\r\n```ts\r\nAug 09 10:43:53.001 INFO All validators active                   slot: 7062817, epoch: 220713, total_validators: x, active_validators: x, current_epoch_proposers: x, service: notifier\r\n```\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1671177678/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1709851624",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/5553#issuecomment-1709851624",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5553",
    "id": 1709851624,
    "node_id": "IC_kwDOCD5_Gc5l6kPo",
    "user": {
      "login": "nflaig",
      "id": 38436224,
      "node_id": "MDQ6VXNlcjM4NDM2MjI0",
      "avatar_url": "https://avatars.githubusercontent.com/u/38436224?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nflaig",
      "html_url": "https://github.com/nflaig",
      "followers_url": "https://api.github.com/users/nflaig/followers",
      "following_url": "https://api.github.com/users/nflaig/following{/other_user}",
      "gists_url": "https://api.github.com/users/nflaig/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nflaig/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nflaig/subscriptions",
      "organizations_url": "https://api.github.com/users/nflaig/orgs",
      "repos_url": "https://api.github.com/users/nflaig/repos",
      "events_url": "https://api.github.com/users/nflaig/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nflaig/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-09-07T09:48:42Z",
    "updated_at": "2023-09-07T09:48:42Z",
    "author_association": "MEMBER",
    "body": "After further debugging this and looking in to LH code base, it looks like this is not an actual problem which would prevent Lodestar BN <> Lighthouse VC combinations from producing aggregates. Mixed client sim tests are passing https://github.com/ChainSafe/lodestar/pull/5940.\r\n\r\nWhat's happening is that Lighthouse VC calls `getAggregatedAttestation` even if there is no aggregator for the slot.\r\nhttps://github.com/sigp/lighthouse/blob/2841f60686d642fcc0785c884d43e34e47a800dc/validator_client/src/attestation_service.rs#L494-L518\r\n\r\nThis deviates from what Lodestar VC (and also other VCs) do, those exit the aggregation flow early if there is no aggregator\r\nhttps://github.com/ChainSafe/lodestar/blob/6ac8c07023bc72c7ef54a6ea66884790793eda21/packages/validator/src/services/attestation.ts#L252-L255\r\n\r\nThe Lodestar BN caches previously submitted attestations (`submitPoolAttestations`) but only if there is an aggregator for the slot which is determined by subnet subscriptions.\r\nhttps://github.com/ChainSafe/lodestar/blob/6ac8c07023bc72c7ef54a6ea66884790793eda21/packages/beacon-node/src/api/impl/beacon/pool/index.ts#L70-L71\r\nhttps://github.com/ChainSafe/lodestar/blob/6ac8c07023bc72c7ef54a6ea66884790793eda21/packages/beacon-node/src/network/processor/gossipHandlers.ts#L398-L399\r\n\r\nThis results in an error when calling `getAggregatedAttestation` as Lodestar is not able to fulfill the request\r\nhttps://github.com/ChainSafe/lodestar/blob/6ac8c07023bc72c7ef54a6ea66884790793eda21/packages/beacon-node/src/chain/opPools/attestationPool.ts#L136\r\n\r\nWe could consider to throw an 404 `ApiError` instead of a 500 `Error` but during normal operation this error should never happen and we usually do not throw `ApiError` at a lower level in the stack.\r\n\r\n**To summarize:**\r\n- not an actual problem, attestations and aggregates are produced correctly\r\n- error only happens with Lighthouse VC, all other VCs work as expected\r\n- ideally should be fixed on Lighthouse https://github.com/sigp/lighthouse/issues/4712\r\n- there is no fix required on Lodestar side, it is expected that we can't fulfill the `getAggregatedAttestation` request\r\n- error verbosity could potentially be reduced on Lodestar\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1709851624/reactions",
      "total_count": 2,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 1,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1740984119",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/5553#issuecomment-1740984119",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5553",
    "id": 1740984119,
    "node_id": "IC_kwDOCD5_Gc5nxU83",
    "user": {
      "login": "nflaig",
      "id": 38436224,
      "node_id": "MDQ6VXNlcjM4NDM2MjI0",
      "avatar_url": "https://avatars.githubusercontent.com/u/38436224?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nflaig",
      "html_url": "https://github.com/nflaig",
      "followers_url": "https://api.github.com/users/nflaig/followers",
      "following_url": "https://api.github.com/users/nflaig/following{/other_user}",
      "gists_url": "https://api.github.com/users/nflaig/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nflaig/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nflaig/subscriptions",
      "organizations_url": "https://api.github.com/users/nflaig/orgs",
      "repos_url": "https://api.github.com/users/nflaig/repos",
      "events_url": "https://api.github.com/users/nflaig/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nflaig/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-09-29T14:27:44Z",
    "updated_at": "2023-09-29T14:27:44Z",
    "author_association": "MEMBER",
    "body": "A fix will be released with Lighthouse v4.6.0 (next release)\r\n- https://github.com/sigp/lighthouse/pull/4774",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1740984119/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
