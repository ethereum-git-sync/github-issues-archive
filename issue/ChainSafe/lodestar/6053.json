{
  "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/6053",
  "repository_url": "https://api.github.com/repos/ChainSafe/lodestar",
  "labels_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/6053/labels{/name}",
  "comments_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/6053/comments",
  "events_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/6053/events",
  "html_url": "https://github.com/ChainSafe/lodestar/issues/6053",
  "id": 1952057936,
  "node_id": "I_kwDOCD5_Gc50WgpQ",
  "number": 6053,
  "title": "Libp2p stop never resolves when shutting down node",
  "user": {
    "login": "nflaig",
    "id": 38436224,
    "node_id": "MDQ6VXNlcjM4NDM2MjI0",
    "avatar_url": "https://avatars.githubusercontent.com/u/38436224?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/nflaig",
    "html_url": "https://github.com/nflaig",
    "followers_url": "https://api.github.com/users/nflaig/followers",
    "following_url": "https://api.github.com/users/nflaig/following{/other_user}",
    "gists_url": "https://api.github.com/users/nflaig/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/nflaig/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/nflaig/subscriptions",
    "organizations_url": "https://api.github.com/users/nflaig/orgs",
    "repos_url": "https://api.github.com/users/nflaig/repos",
    "events_url": "https://api.github.com/users/nflaig/events{/privacy}",
    "received_events_url": "https://api.github.com/users/nflaig/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 5670219610,
      "node_id": "LA_kwDOCD5_Gc8AAAABUfivWg",
      "url": "https://api.github.com/repos/ChainSafe/lodestar/labels/meta-bug",
      "name": "meta-bug",
      "color": "E79553",
      "default": false,
      "description": "Issues that identify a bug and require a fix."
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/milestones/33",
    "html_url": "https://github.com/ChainSafe/lodestar/milestone/33",
    "labels_url": "https://api.github.com/repos/ChainSafe/lodestar/milestones/33/labels",
    "id": 9640172,
    "node_id": "MI_kwDOCD5_Gc4Akxjs",
    "number": 33,
    "title": "v1.12.0",
    "description": "",
    "creator": {
      "login": "philknows",
      "id": 58080811,
      "node_id": "MDQ6VXNlcjU4MDgwODEx",
      "avatar_url": "https://avatars.githubusercontent.com/u/58080811?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/philknows",
      "html_url": "https://github.com/philknows",
      "followers_url": "https://api.github.com/users/philknows/followers",
      "following_url": "https://api.github.com/users/philknows/following{/other_user}",
      "gists_url": "https://api.github.com/users/philknows/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/philknows/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/philknows/subscriptions",
      "organizations_url": "https://api.github.com/users/philknows/orgs",
      "repos_url": "https://api.github.com/users/philknows/repos",
      "events_url": "https://api.github.com/users/philknows/events{/privacy}",
      "received_events_url": "https://api.github.com/users/philknows/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 6,
    "closed_issues": 13,
    "state": "open",
    "created_at": "2023-07-11T02:13:25Z",
    "updated_at": "2023-10-26T15:22:49Z",
    "due_on": null,
    "closed_at": null
  },
  "comments": 14,
  "created_at": "2023-10-19T12:04:38Z",
  "updated_at": "2023-10-27T10:02:40Z",
  "closed_at": null,
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "### Describe the bug\n\nThere seems to be an issue since we have updated libp2p in https://github.com/ChainSafe/lodestar/pull/6015. In some cases, the beacon node never shuts down and just hangs indefinitely. This does not happen all the time but if the node is running for a longer time it seems to happen quite frequently.\r\n\r\nBased on the logs it is clear that the issue is `await this.libp2p.stop();` which just never resolves\r\nhttps://github.com/ChainSafe/lodestar/blob/c50db8f7ae47198c76070487a6cfd0009d9bfd39/packages/beacon-node/src/network/core/networkCore.ts#L271\r\n\r\nSee [libp2p-shutdown-issue-full.log](https://github.com/ChainSafe/lodestar/files/13042237/libp2p-shutdown-issue-full.log)\r\n```bash\r\ndevops@Ubuntu-2204-jammy-amd64-base:~/goerli/data/beacon$ cat beacon-2023-10-19.log | grep \"closing network core running in network worker\"\r\nOct-19 11:40:56.818[network]         debug: closing network core running in network worker\r\ndevops@Ubuntu-2204-jammy-amd64-base:~/goerli/data/beacon$ cat beacon-2023-10-19.log | grep \"network sent goodbye to all peers\"\r\nOct-19 11:40:57.826[network]         debug: network sent goodbye to all peers\r\ndevops@Ubuntu-2204-jammy-amd64-base:~/goerli/data/beacon$ cat beacon-2023-10-19.log | grep \"network peerManager closed\"\r\nOct-19 11:40:57.838[network]         debug: network peerManager closed\r\ndevops@Ubuntu-2204-jammy-amd64-base:~/goerli/data/beacon$ cat beacon-2023-10-19.log | grep \"network reqResp closed\"\r\nOct-19 11:40:57.863[network]         debug: network reqResp closed\r\ndevops@Ubuntu-2204-jammy-amd64-base:~/goerli/data/beacon$ cat beacon-2023-10-19.log | grep \"network lib2p closed\"\r\ndevops@Ubuntu-2204-jammy-amd64-base:~/goerli/data/beacon$ cat beacon-2023-10-19.log | grep \"terminating network worker\"\r\n```\r\n\r\nThis was also brought up by Sea Monkey [on discord](https://discord.com/channels/593655374469660673/593655641445367808/1163812639995068457), corresponding logs [sea-monkey-shutdown-issue.log](https://github.com/ChainSafe/lodestar/files/13042230/sea-monkey-shutdown-issue.log)\n\n### Expected behavior\n\nLibp2p stop should always resolve in a timely manner\n\n### Steps to reproduce\n\nRun beacon node on any network\n\n### Additional context\n\n- Possibly related to https://github.com/libp2p/js-libp2p/pull/2058 \r\n\n\n### Operating system\n\nLinux\n\n### Lodestar version or commit hash\n\nunstable (ab2dfdde652b0b0e4e9b2b96f8d8ee08fec6b720)",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/6053/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/6053/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1770878881",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/6053#issuecomment-1770878881",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/6053",
    "id": 1770878881,
    "node_id": "IC_kwDOCD5_Gc5pjXeh",
    "user": {
      "login": "nazarhussain",
      "id": 112468,
      "node_id": "MDQ6VXNlcjExMjQ2OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/112468?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nazarhussain",
      "html_url": "https://github.com/nazarhussain",
      "followers_url": "https://api.github.com/users/nazarhussain/followers",
      "following_url": "https://api.github.com/users/nazarhussain/following{/other_user}",
      "gists_url": "https://api.github.com/users/nazarhussain/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nazarhussain/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nazarhussain/subscriptions",
      "organizations_url": "https://api.github.com/users/nazarhussain/orgs",
      "repos_url": "https://api.github.com/users/nazarhussain/repos",
      "events_url": "https://api.github.com/users/nazarhussain/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nazarhussain/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-10-19T12:30:33Z",
    "updated_at": "2023-10-19T12:30:33Z",
    "author_association": "CONTRIBUTOR",
    "body": "@nflaig Do you know if there were some special configuration passed to node when this behavior triggered? ",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1770878881/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1770888162",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/6053#issuecomment-1770888162",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/6053",
    "id": 1770888162,
    "node_id": "IC_kwDOCD5_Gc5pjZvi",
    "user": {
      "login": "nflaig",
      "id": 38436224,
      "node_id": "MDQ6VXNlcjM4NDM2MjI0",
      "avatar_url": "https://avatars.githubusercontent.com/u/38436224?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nflaig",
      "html_url": "https://github.com/nflaig",
      "followers_url": "https://api.github.com/users/nflaig/followers",
      "following_url": "https://api.github.com/users/nflaig/following{/other_user}",
      "gists_url": "https://api.github.com/users/nflaig/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nflaig/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nflaig/subscriptions",
      "organizations_url": "https://api.github.com/users/nflaig/orgs",
      "repos_url": "https://api.github.com/users/nflaig/repos",
      "events_url": "https://api.github.com/users/nflaig/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nflaig/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-10-19T12:34:10Z",
    "updated_at": "2023-10-19T12:34:59Z",
    "author_association": "MEMBER",
    "body": "> @nflaig Do you know if there were some special configuration passed to node when this behavior triggered?\r\n\r\nI don't think it is related to specific configuration, it really just happens if the node is running for a longer while, I had the bn running now for 15 minutes and didn't see the issue, but on two consecutive runs which had an uptime of 12+ hours I had the issue. I can't tell what the minimum amount is the bn has to run or if it happens consistently.\r\n\r\nMy command\r\n\r\n```cmd\r\n./lodestar beacon \\\r\n    --dataDir /home/devops/goerli/data/beacon \\\r\n    --rest \\\r\n    --rest.namespace '*' \\\r\n    --rest.address \"0.0.0.0\" \\\r\n    --metrics \\\r\n    --execution.urls http://localhost:8551 \\\r\n    --jwt-secret /home/devops/goerli/data/jwtsecret \\\r\n    --logLevel info \\\r\n    --network goerli \\\r\n    --checkpointSyncUrl \"https://beaconstate-goerli.chainsafe.io/\"  \\\r\n    --subscribeAllSubnets\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1770888162/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1770914395",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/6053#issuecomment-1770914395",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/6053",
    "id": 1770914395,
    "node_id": "IC_kwDOCD5_Gc5pjgJb",
    "user": {
      "login": "nflaig",
      "id": 38436224,
      "node_id": "MDQ6VXNlcjM4NDM2MjI0",
      "avatar_url": "https://avatars.githubusercontent.com/u/38436224?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nflaig",
      "html_url": "https://github.com/nflaig",
      "followers_url": "https://api.github.com/users/nflaig/followers",
      "following_url": "https://api.github.com/users/nflaig/following{/other_user}",
      "gists_url": "https://api.github.com/users/nflaig/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nflaig/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nflaig/subscriptions",
      "organizations_url": "https://api.github.com/users/nflaig/orgs",
      "repos_url": "https://api.github.com/users/nflaig/repos",
      "events_url": "https://api.github.com/users/nflaig/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nflaig/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-10-19T12:45:13Z",
    "updated_at": "2023-10-19T12:45:13Z",
    "author_association": "MEMBER",
    "body": "Just to highlight the difference of this issue compared to https://github.com/ChainSafe/lodestar/issues/5642 and https://github.com/ChainSafe/lodestar/issues/5775\r\n\r\nWhat happens now is that libp2p stop never resolves, we basically have a hanging promise. The other two issues are related to an active handle that is left behind by libp2p after stop is already resolved. The active handle causes issues shutting down the main process and since we switched to a worker preventing that from being terminated by `Thread.terminate` which ends up as a hanging promise in the end as well.\r\n\r\nLet me know if you need more details. As you can see based on the issues I spent quite some time debugging this as well.",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1770914395/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1775295205",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/6053#issuecomment-1775295205",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/6053",
    "id": 1775295205,
    "node_id": "IC_kwDOCD5_Gc5p0Nrl",
    "user": {
      "login": "wemeetagain",
      "id": 1348242,
      "node_id": "MDQ6VXNlcjEzNDgyNDI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1348242?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/wemeetagain",
      "html_url": "https://github.com/wemeetagain",
      "followers_url": "https://api.github.com/users/wemeetagain/followers",
      "following_url": "https://api.github.com/users/wemeetagain/following{/other_user}",
      "gists_url": "https://api.github.com/users/wemeetagain/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/wemeetagain/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/wemeetagain/subscriptions",
      "organizations_url": "https://api.github.com/users/wemeetagain/orgs",
      "repos_url": "https://api.github.com/users/wemeetagain/repos",
      "events_url": "https://api.github.com/users/wemeetagain/events{/privacy}",
      "received_events_url": "https://api.github.com/users/wemeetagain/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-10-23T14:11:28Z",
    "updated_at": "2023-10-23T14:11:28Z",
    "author_association": "MEMBER",
    "body": "@achingbrain any ideas?",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1775295205/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1775508607",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/6053#issuecomment-1775508607",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/6053",
    "id": 1775508607,
    "node_id": "IC_kwDOCD5_Gc5p1Bx_",
    "user": {
      "login": "wemeetagain",
      "id": 1348242,
      "node_id": "MDQ6VXNlcjEzNDgyNDI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1348242?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/wemeetagain",
      "html_url": "https://github.com/wemeetagain",
      "followers_url": "https://api.github.com/users/wemeetagain/followers",
      "following_url": "https://api.github.com/users/wemeetagain/following{/other_user}",
      "gists_url": "https://api.github.com/users/wemeetagain/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/wemeetagain/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/wemeetagain/subscriptions",
      "organizations_url": "https://api.github.com/users/wemeetagain/orgs",
      "repos_url": "https://api.github.com/users/wemeetagain/repos",
      "events_url": "https://api.github.com/users/wemeetagain/events{/privacy}",
      "received_events_url": "https://api.github.com/users/wemeetagain/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-10-23T15:53:21Z",
    "updated_at": "2023-10-23T15:53:21Z",
    "author_association": "MEMBER",
    "body": "Can we look into implementing a hack to unblock our v1.12 while we take time to figure out the root cause?",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1775508607/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1775572108",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/6053#issuecomment-1775572108",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/6053",
    "id": 1775572108,
    "node_id": "IC_kwDOCD5_Gc5p1RSM",
    "user": {
      "login": "nflaig",
      "id": 38436224,
      "node_id": "MDQ6VXNlcjM4NDM2MjI0",
      "avatar_url": "https://avatars.githubusercontent.com/u/38436224?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nflaig",
      "html_url": "https://github.com/nflaig",
      "followers_url": "https://api.github.com/users/nflaig/followers",
      "following_url": "https://api.github.com/users/nflaig/following{/other_user}",
      "gists_url": "https://api.github.com/users/nflaig/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nflaig/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nflaig/subscriptions",
      "organizations_url": "https://api.github.com/users/nflaig/orgs",
      "repos_url": "https://api.github.com/users/nflaig/repos",
      "events_url": "https://api.github.com/users/nflaig/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nflaig/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-10-23T16:29:15Z",
    "updated_at": "2023-10-23T16:29:15Z",
    "author_association": "MEMBER",
    "body": "> Can we look into implementing a hack to unblock our v1.12 while we take time to figure out the root cause?\r\n\r\nMaybe wrap `libp2p.stop` into a `withTimeout`?\r\n\r\nhttps://github.com/ChainSafe/lodestar/blob/18dc0c958189cb60fd8df7db6b1ebdf060edbd96/packages/beacon-node/src/network/peers/peerManager.ts#L664",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1775572108/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1775715285",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/6053#issuecomment-1775715285",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/6053",
    "id": 1775715285,
    "node_id": "IC_kwDOCD5_Gc5p10PV",
    "user": {
      "login": "achingbrain",
      "id": 665810,
      "node_id": "MDQ6VXNlcjY2NTgxMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/665810?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achingbrain",
      "html_url": "https://github.com/achingbrain",
      "followers_url": "https://api.github.com/users/achingbrain/followers",
      "following_url": "https://api.github.com/users/achingbrain/following{/other_user}",
      "gists_url": "https://api.github.com/users/achingbrain/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achingbrain/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achingbrain/subscriptions",
      "organizations_url": "https://api.github.com/users/achingbrain/orgs",
      "repos_url": "https://api.github.com/users/achingbrain/repos",
      "events_url": "https://api.github.com/users/achingbrain/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achingbrain/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-10-23T17:51:12Z",
    "updated_at": "2023-10-23T17:51:12Z",
    "author_association": "NONE",
    "body": "> any ideas?\r\n\r\nNothing specific but I find [why-is-node-running](https://www.npmjs.com/package/why-is-node-running) very helpful when tracking down active handles that stop processes from exiting.",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1775715285/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1775719974",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/6053#issuecomment-1775719974",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/6053",
    "id": 1775719974,
    "node_id": "IC_kwDOCD5_Gc5p11Ym",
    "user": {
      "login": "nflaig",
      "id": 38436224,
      "node_id": "MDQ6VXNlcjM4NDM2MjI0",
      "avatar_url": "https://avatars.githubusercontent.com/u/38436224?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nflaig",
      "html_url": "https://github.com/nflaig",
      "followers_url": "https://api.github.com/users/nflaig/followers",
      "following_url": "https://api.github.com/users/nflaig/following{/other_user}",
      "gists_url": "https://api.github.com/users/nflaig/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nflaig/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nflaig/subscriptions",
      "organizations_url": "https://api.github.com/users/nflaig/orgs",
      "repos_url": "https://api.github.com/users/nflaig/repos",
      "events_url": "https://api.github.com/users/nflaig/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nflaig/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-10-23T17:54:01Z",
    "updated_at": "2023-10-23T17:54:01Z",
    "author_association": "MEMBER",
    "body": "> > any ideas?\r\n> \r\n> Nothing specific but I find [why-is-node-running](https://www.npmjs.com/package/why-is-node-running) very helpful when tracking down active handles that stop processes from exiting.\r\n\r\nIt not related to active handles, `libp2p.stop` promise just never resolves",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1775719974/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1775724957",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/6053#issuecomment-1775724957",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/6053",
    "id": 1775724957,
    "node_id": "IC_kwDOCD5_Gc5p12md",
    "user": {
      "login": "achingbrain",
      "id": 665810,
      "node_id": "MDQ6VXNlcjY2NTgxMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/665810?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achingbrain",
      "html_url": "https://github.com/achingbrain",
      "followers_url": "https://api.github.com/users/achingbrain/followers",
      "following_url": "https://api.github.com/users/achingbrain/following{/other_user}",
      "gists_url": "https://api.github.com/users/achingbrain/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achingbrain/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achingbrain/subscriptions",
      "organizations_url": "https://api.github.com/users/achingbrain/orgs",
      "repos_url": "https://api.github.com/users/achingbrain/repos",
      "events_url": "https://api.github.com/users/achingbrain/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achingbrain/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-10-23T17:57:06Z",
    "updated_at": "2023-10-23T17:57:06Z",
    "author_association": "NONE",
    "body": "The [libp2p.stop method](https://github.com/libp2p/js-libp2p/blob/master/packages/libp2p/src/libp2p.ts#L249-L264) just stops each component.  Do you have any [logs](https://github.com/libp2p/js-libp2p/blob/master/doc/GETTING_STARTED.md#node) available to see which component is causing the problem?",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1775724957/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1775733902",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/6053#issuecomment-1775733902",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/6053",
    "id": 1775733902,
    "node_id": "IC_kwDOCD5_Gc5p14yO",
    "user": {
      "login": "nflaig",
      "id": 38436224,
      "node_id": "MDQ6VXNlcjM4NDM2MjI0",
      "avatar_url": "https://avatars.githubusercontent.com/u/38436224?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nflaig",
      "html_url": "https://github.com/nflaig",
      "followers_url": "https://api.github.com/users/nflaig/followers",
      "following_url": "https://api.github.com/users/nflaig/following{/other_user}",
      "gists_url": "https://api.github.com/users/nflaig/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nflaig/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nflaig/subscriptions",
      "organizations_url": "https://api.github.com/users/nflaig/orgs",
      "repos_url": "https://api.github.com/users/nflaig/repos",
      "events_url": "https://api.github.com/users/nflaig/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nflaig/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-10-23T18:02:25Z",
    "updated_at": "2023-10-23T18:04:34Z",
    "author_association": "MEMBER",
    "body": "> The [libp2p.stop method](https://github.com/libp2p/js-libp2p/blob/master/packages/libp2p/src/libp2p.ts#L249-L264) just stops each component. Do you have any [logs](https://github.com/libp2p/js-libp2p/blob/master/doc/GETTING_STARTED.md#node) available to see which component is causing the problem?\r\n\r\nThe issue is not that easy to reproduce, right now I only have the logs mentioned here https://github.com/ChainSafe/lodestar/issues/6053#issue-1952057936. I will run Lodestar with `DEBUG=\"libp2p:*\"` and see if I can catch it again.",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1775733902/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1776857209",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/6053#issuecomment-1776857209",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/6053",
    "id": 1776857209,
    "node_id": "IC_kwDOCD5_Gc5p6LB5",
    "user": {
      "login": "nflaig",
      "id": 38436224,
      "node_id": "MDQ6VXNlcjM4NDM2MjI0",
      "avatar_url": "https://avatars.githubusercontent.com/u/38436224?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nflaig",
      "html_url": "https://github.com/nflaig",
      "followers_url": "https://api.github.com/users/nflaig/followers",
      "following_url": "https://api.github.com/users/nflaig/following{/other_user}",
      "gists_url": "https://api.github.com/users/nflaig/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nflaig/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nflaig/subscriptions",
      "organizations_url": "https://api.github.com/users/nflaig/orgs",
      "repos_url": "https://api.github.com/users/nflaig/repos",
      "events_url": "https://api.github.com/users/nflaig/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nflaig/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-10-24T09:32:41Z",
    "updated_at": "2023-10-24T09:32:41Z",
    "author_association": "MEMBER",
    "body": "@achingbrain  I caught some DEBUG logs ([libp2p-debug.log](https://github.com/ChainSafe/lodestar/files/13112989/libp2p-debug.log)), I didn't see any `libp2p:*` logs afterwards but the `libp2p.stop` promise never resolved, and the process was not shutting down due to that.\r\n\r\nYou can ignore the `Error: PublishError.InsufficientPeers` logs, this seems to be an issue that our REST API is still allowing requests to come in even though the network is closing.\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1776857209/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1776869736",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/6053#issuecomment-1776869736",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/6053",
    "id": 1776869736,
    "node_id": "IC_kwDOCD5_Gc5p6OFo",
    "user": {
      "login": "achingbrain",
      "id": 665810,
      "node_id": "MDQ6VXNlcjY2NTgxMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/665810?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achingbrain",
      "html_url": "https://github.com/achingbrain",
      "followers_url": "https://api.github.com/users/achingbrain/followers",
      "following_url": "https://api.github.com/users/achingbrain/following{/other_user}",
      "gists_url": "https://api.github.com/users/achingbrain/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achingbrain/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achingbrain/subscriptions",
      "organizations_url": "https://api.github.com/users/achingbrain/orgs",
      "repos_url": "https://api.github.com/users/achingbrain/repos",
      "events_url": "https://api.github.com/users/achingbrain/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achingbrain/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-10-24T09:40:20Z",
    "updated_at": "2023-10-24T09:42:16Z",
    "author_association": "NONE",
    "body": "It's not clear from the logs when shutdown is started ([this line](https://github.com/libp2p/js-libp2p/blob/master/packages/libp2p/src/libp2p.ts#L254) is not present) but it looks like it's still accepting incoming connections so perhaps the tcp socket isn't being closed properly now.\r\n\r\nDoes it happen with `@libp2p/tcp` from before https://github.com/libp2p/js-libp2p/pull/2058?  E.g. when pinned to `8.0.7`\r\n\r\nOr could one of [these lines](https://github.com/ChainSafe/lodestar/blob/c50db8f7ae47198c76070487a6cfd0009d9bfd39/packages/beacon-node/src/network/core/networkCore.ts#L269-L270) be throwing and the error swallowed?",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1776869736/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1776915042",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/6053#issuecomment-1776915042",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/6053",
    "id": 1776915042,
    "node_id": "IC_kwDOCD5_Gc5p6ZJi",
    "user": {
      "login": "nflaig",
      "id": 38436224,
      "node_id": "MDQ6VXNlcjM4NDM2MjI0",
      "avatar_url": "https://avatars.githubusercontent.com/u/38436224?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nflaig",
      "html_url": "https://github.com/nflaig",
      "followers_url": "https://api.github.com/users/nflaig/followers",
      "following_url": "https://api.github.com/users/nflaig/following{/other_user}",
      "gists_url": "https://api.github.com/users/nflaig/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nflaig/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nflaig/subscriptions",
      "organizations_url": "https://api.github.com/users/nflaig/orgs",
      "repos_url": "https://api.github.com/users/nflaig/repos",
      "events_url": "https://api.github.com/users/nflaig/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nflaig/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-10-24T10:09:44Z",
    "updated_at": "2023-10-24T10:09:44Z",
    "author_association": "MEMBER",
    "body": "> It's not clear from the logs when shutdown is started ([this line](https://github.com/libp2p/js-libp2p/blob/master/packages/libp2p/src/libp2p.ts#L254) is not present)\r\n\r\nWas capturing the logs in tmux which seems to only capture the last 2k lines...\r\n\r\n> Does it happen with @libp2p/tcp from before https://github.com/libp2p/js-libp2p/pull/2058? E.g. when pinned to 8.0.7\r\n\r\nIt happens since https://github.com/ChainSafe/lodestar/pull/6015 which bumped `@libp2p/tcp` from `8.0.2` to `8.0.8` but it also includes a bunch of other libp2p dependency updates\r\n\r\n> Or could one of [these lines](https://github.com/ChainSafe/lodestar/blob/c50db8f7ae47198c76070487a6cfd0009d9bfd39/packages/beacon-node/src/network/core/networkCore.ts#L269-L270) be throwing and the error swallowed?\r\n\r\nNo, those are really harmless and just remove listeners. Code has not been modified there recently\r\n\r\n> E.g. when pinned to 8.0.7\r\n\r\nI can try pinning `@libp2p/tcp` to `8.0.7` but the problem is that it is only easy to confirm that the issue still exists, can't really confirm that it doesn't. We had issues before with libp2p actives handles (https://github.com/ChainSafe/lodestar/issues/5642 and https://github.com/ChainSafe/lodestar/issues/5775) and haven't seen those for a week and regarded them  as resolved, but then caught them again...",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1776915042/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1782643661",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/6053#issuecomment-1782643661",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/6053",
    "id": 1782643661,
    "node_id": "IC_kwDOCD5_Gc5qQPvN",
    "user": {
      "login": "nflaig",
      "id": 38436224,
      "node_id": "MDQ6VXNlcjM4NDM2MjI0",
      "avatar_url": "https://avatars.githubusercontent.com/u/38436224?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nflaig",
      "html_url": "https://github.com/nflaig",
      "followers_url": "https://api.github.com/users/nflaig/followers",
      "following_url": "https://api.github.com/users/nflaig/following{/other_user}",
      "gists_url": "https://api.github.com/users/nflaig/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nflaig/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nflaig/subscriptions",
      "organizations_url": "https://api.github.com/users/nflaig/orgs",
      "repos_url": "https://api.github.com/users/nflaig/repos",
      "events_url": "https://api.github.com/users/nflaig/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nflaig/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-10-27T10:02:40Z",
    "updated_at": "2023-10-27T10:02:40Z",
    "author_association": "MEMBER",
    "body": "> Does it happen with @libp2p/tcp from before https://github.com/libp2p/js-libp2p/pull/2058? E.g. when pinned to 8.0.7\r\n\r\nHaven't seen the issue so far when [downgrading @libp2p/tcp to 8.0.7](https://github.com/ChainSafe/lodestar/compare/unstable...nflaig/downgrade-libp2p-tcp), it's been only 3 days so can't tell for sure, but seems to be a high probability that the issue was introduced in @libp2p/tcp v8.0.8",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1782643661/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
