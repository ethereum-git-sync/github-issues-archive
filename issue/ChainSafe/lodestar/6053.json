{
  "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/6053",
  "repository_url": "https://api.github.com/repos/ChainSafe/lodestar",
  "labels_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/6053/labels{/name}",
  "comments_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/6053/comments",
  "events_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/6053/events",
  "html_url": "https://github.com/ChainSafe/lodestar/issues/6053",
  "id": 1952057936,
  "node_id": "I_kwDOCD5_Gc50WgpQ",
  "number": 6053,
  "title": "Libp2p stop never resolves when shutting down node",
  "user": {
    "login": "nflaig",
    "id": 38436224,
    "node_id": "MDQ6VXNlcjM4NDM2MjI0",
    "avatar_url": "https://avatars.githubusercontent.com/u/38436224?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/nflaig",
    "html_url": "https://github.com/nflaig",
    "followers_url": "https://api.github.com/users/nflaig/followers",
    "following_url": "https://api.github.com/users/nflaig/following{/other_user}",
    "gists_url": "https://api.github.com/users/nflaig/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/nflaig/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/nflaig/subscriptions",
    "organizations_url": "https://api.github.com/users/nflaig/orgs",
    "repos_url": "https://api.github.com/users/nflaig/repos",
    "events_url": "https://api.github.com/users/nflaig/events{/privacy}",
    "received_events_url": "https://api.github.com/users/nflaig/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 5670219610,
      "node_id": "LA_kwDOCD5_Gc8AAAABUfivWg",
      "url": "https://api.github.com/repos/ChainSafe/lodestar/labels/meta-bug",
      "name": "meta-bug",
      "color": "E79553",
      "default": false,
      "description": "Issues that identify a bug and require a fix."
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/milestones/33",
    "html_url": "https://github.com/ChainSafe/lodestar/milestone/33",
    "labels_url": "https://api.github.com/repos/ChainSafe/lodestar/milestones/33/labels",
    "id": 9640172,
    "node_id": "MI_kwDOCD5_Gc4Akxjs",
    "number": 33,
    "title": "v1.12.0",
    "description": "",
    "creator": {
      "login": "philknows",
      "id": 58080811,
      "node_id": "MDQ6VXNlcjU4MDgwODEx",
      "avatar_url": "https://avatars.githubusercontent.com/u/58080811?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/philknows",
      "html_url": "https://github.com/philknows",
      "followers_url": "https://api.github.com/users/philknows/followers",
      "following_url": "https://api.github.com/users/philknows/following{/other_user}",
      "gists_url": "https://api.github.com/users/philknows/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/philknows/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/philknows/subscriptions",
      "organizations_url": "https://api.github.com/users/philknows/orgs",
      "repos_url": "https://api.github.com/users/philknows/repos",
      "events_url": "https://api.github.com/users/philknows/events{/privacy}",
      "received_events_url": "https://api.github.com/users/philknows/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 7,
    "closed_issues": 11,
    "state": "open",
    "created_at": "2023-07-11T02:13:25Z",
    "updated_at": "2023-10-20T17:33:40Z",
    "due_on": null,
    "closed_at": null
  },
  "comments": 4,
  "created_at": "2023-10-19T12:04:38Z",
  "updated_at": "2023-10-23T14:11:29Z",
  "closed_at": null,
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "### Describe the bug\n\nThere seems to be an issue since we have updated libp2p in https://github.com/ChainSafe/lodestar/pull/6015. In some cases, the beacon node never shuts down and just hangs indefinitely. This does not happen all the time but if the node is running for a longer time it seems to happen quite frequently.\r\n\r\nBased on the logs it is clear that the issue is `await this.libp2p.stop();` which just never resolves\r\nhttps://github.com/ChainSafe/lodestar/blob/c50db8f7ae47198c76070487a6cfd0009d9bfd39/packages/beacon-node/src/network/core/networkCore.ts#L271\r\n\r\nSee [libp2p-shutdown-issue-full.log](https://github.com/ChainSafe/lodestar/files/13042237/libp2p-shutdown-issue-full.log)\r\n```bash\r\ndevops@Ubuntu-2204-jammy-amd64-base:~/goerli/data/beacon$ cat beacon-2023-10-19.log | grep \"closing network core running in network worker\"\r\nOct-19 11:40:56.818[network]         debug: closing network core running in network worker\r\ndevops@Ubuntu-2204-jammy-amd64-base:~/goerli/data/beacon$ cat beacon-2023-10-19.log | grep \"network sent goodbye to all peers\"\r\nOct-19 11:40:57.826[network]         debug: network sent goodbye to all peers\r\ndevops@Ubuntu-2204-jammy-amd64-base:~/goerli/data/beacon$ cat beacon-2023-10-19.log | grep \"network peerManager closed\"\r\nOct-19 11:40:57.838[network]         debug: network peerManager closed\r\ndevops@Ubuntu-2204-jammy-amd64-base:~/goerli/data/beacon$ cat beacon-2023-10-19.log | grep \"network reqResp closed\"\r\nOct-19 11:40:57.863[network]         debug: network reqResp closed\r\ndevops@Ubuntu-2204-jammy-amd64-base:~/goerli/data/beacon$ cat beacon-2023-10-19.log | grep \"network lib2p closed\"\r\ndevops@Ubuntu-2204-jammy-amd64-base:~/goerli/data/beacon$ cat beacon-2023-10-19.log | grep \"terminating network worker\"\r\n```\r\n\r\nThis was also brought up by Sea Monkey [on discord](https://discord.com/channels/593655374469660673/593655641445367808/1163812639995068457), corresponding logs [sea-monkey-shutdown-issue.log](https://github.com/ChainSafe/lodestar/files/13042230/sea-monkey-shutdown-issue.log)\n\n### Expected behavior\n\nLibp2p stop should always resolve in a timely manner\n\n### Steps to reproduce\n\nRun beacon node on any network\n\n### Additional context\n\n- Possibly related to https://github.com/libp2p/js-libp2p/pull/2058 \r\n\n\n### Operating system\n\nLinux\n\n### Lodestar version or commit hash\n\nunstable (ab2dfdde652b0b0e4e9b2b96f8d8ee08fec6b720)",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/6053/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/6053/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1770878881",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/6053#issuecomment-1770878881",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/6053",
    "id": 1770878881,
    "node_id": "IC_kwDOCD5_Gc5pjXeh",
    "user": {
      "login": "nazarhussain",
      "id": 112468,
      "node_id": "MDQ6VXNlcjExMjQ2OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/112468?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nazarhussain",
      "html_url": "https://github.com/nazarhussain",
      "followers_url": "https://api.github.com/users/nazarhussain/followers",
      "following_url": "https://api.github.com/users/nazarhussain/following{/other_user}",
      "gists_url": "https://api.github.com/users/nazarhussain/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nazarhussain/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nazarhussain/subscriptions",
      "organizations_url": "https://api.github.com/users/nazarhussain/orgs",
      "repos_url": "https://api.github.com/users/nazarhussain/repos",
      "events_url": "https://api.github.com/users/nazarhussain/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nazarhussain/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-10-19T12:30:33Z",
    "updated_at": "2023-10-19T12:30:33Z",
    "author_association": "CONTRIBUTOR",
    "body": "@nflaig Do you know if there were some special configuration passed to node when this behavior triggered? ",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1770878881/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1770888162",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/6053#issuecomment-1770888162",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/6053",
    "id": 1770888162,
    "node_id": "IC_kwDOCD5_Gc5pjZvi",
    "user": {
      "login": "nflaig",
      "id": 38436224,
      "node_id": "MDQ6VXNlcjM4NDM2MjI0",
      "avatar_url": "https://avatars.githubusercontent.com/u/38436224?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nflaig",
      "html_url": "https://github.com/nflaig",
      "followers_url": "https://api.github.com/users/nflaig/followers",
      "following_url": "https://api.github.com/users/nflaig/following{/other_user}",
      "gists_url": "https://api.github.com/users/nflaig/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nflaig/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nflaig/subscriptions",
      "organizations_url": "https://api.github.com/users/nflaig/orgs",
      "repos_url": "https://api.github.com/users/nflaig/repos",
      "events_url": "https://api.github.com/users/nflaig/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nflaig/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-10-19T12:34:10Z",
    "updated_at": "2023-10-19T12:34:59Z",
    "author_association": "MEMBER",
    "body": "> @nflaig Do you know if there were some special configuration passed to node when this behavior triggered?\r\n\r\nI don't think it is related to specific configuration, it really just happens if the node is running for a longer while, I had the bn running now for 15 minutes and didn't see the issue, but on two consecutive runs which had an uptime of 12+ hours I had the issue. I can't tell what the minimum amount is the bn has to run or if it happens consistently.\r\n\r\nMy command\r\n\r\n```cmd\r\n./lodestar beacon \\\r\n    --dataDir /home/devops/goerli/data/beacon \\\r\n    --rest \\\r\n    --rest.namespace '*' \\\r\n    --rest.address \"0.0.0.0\" \\\r\n    --metrics \\\r\n    --execution.urls http://localhost:8551 \\\r\n    --jwt-secret /home/devops/goerli/data/jwtsecret \\\r\n    --logLevel info \\\r\n    --network goerli \\\r\n    --checkpointSyncUrl \"https://beaconstate-goerli.chainsafe.io/\"  \\\r\n    --subscribeAllSubnets\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1770888162/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1770914395",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/6053#issuecomment-1770914395",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/6053",
    "id": 1770914395,
    "node_id": "IC_kwDOCD5_Gc5pjgJb",
    "user": {
      "login": "nflaig",
      "id": 38436224,
      "node_id": "MDQ6VXNlcjM4NDM2MjI0",
      "avatar_url": "https://avatars.githubusercontent.com/u/38436224?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nflaig",
      "html_url": "https://github.com/nflaig",
      "followers_url": "https://api.github.com/users/nflaig/followers",
      "following_url": "https://api.github.com/users/nflaig/following{/other_user}",
      "gists_url": "https://api.github.com/users/nflaig/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nflaig/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nflaig/subscriptions",
      "organizations_url": "https://api.github.com/users/nflaig/orgs",
      "repos_url": "https://api.github.com/users/nflaig/repos",
      "events_url": "https://api.github.com/users/nflaig/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nflaig/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-10-19T12:45:13Z",
    "updated_at": "2023-10-19T12:45:13Z",
    "author_association": "MEMBER",
    "body": "Just to highlight the difference of this issue compared to https://github.com/ChainSafe/lodestar/issues/5642 and https://github.com/ChainSafe/lodestar/issues/5775\r\n\r\nWhat happens now is that libp2p stop never resolves, we basically have a hanging promise. The other two issues are related to an active handle that is left behind by libp2p after stop is already resolved. The active handle causes issues shutting down the main process and since we switched to a worker preventing that from being terminated by `Thread.terminate` which ends up as a hanging promise in the end as well.\r\n\r\nLet me know if you need more details. As you can see based on the issues I spent quite some time debugging this as well.",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1770914395/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1775295205",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/6053#issuecomment-1775295205",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/6053",
    "id": 1775295205,
    "node_id": "IC_kwDOCD5_Gc5p0Nrl",
    "user": {
      "login": "wemeetagain",
      "id": 1348242,
      "node_id": "MDQ6VXNlcjEzNDgyNDI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1348242?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/wemeetagain",
      "html_url": "https://github.com/wemeetagain",
      "followers_url": "https://api.github.com/users/wemeetagain/followers",
      "following_url": "https://api.github.com/users/wemeetagain/following{/other_user}",
      "gists_url": "https://api.github.com/users/wemeetagain/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/wemeetagain/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/wemeetagain/subscriptions",
      "organizations_url": "https://api.github.com/users/wemeetagain/orgs",
      "repos_url": "https://api.github.com/users/wemeetagain/repos",
      "events_url": "https://api.github.com/users/wemeetagain/events{/privacy}",
      "received_events_url": "https://api.github.com/users/wemeetagain/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-10-23T14:11:28Z",
    "updated_at": "2023-10-23T14:11:28Z",
    "author_association": "MEMBER",
    "body": "@achingbrain any ideas?",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1775295205/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
