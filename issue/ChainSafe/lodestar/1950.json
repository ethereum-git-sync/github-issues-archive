{
  "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/1950",
  "repository_url": "https://api.github.com/repos/ChainSafe/lodestar",
  "labels_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/1950/labels{/name}",
  "comments_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/1950/comments",
  "events_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/1950/events",
  "html_url": "https://github.com/ChainSafe/lodestar/issues/1950",
  "id": 785601399,
  "node_id": "MDU6SXNzdWU3ODU2MDEzOTk=",
  "number": 1950,
  "title": "Implement CachedBeaconState",
  "user": {
    "login": "tuyennhv",
    "id": 10568965,
    "node_id": "MDQ6VXNlcjEwNTY4OTY1",
    "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tuyennhv",
    "html_url": "https://github.com/tuyennhv",
    "followers_url": "https://api.github.com/users/tuyennhv/followers",
    "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
    "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
    "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
    "repos_url": "https://api.github.com/users/tuyennhv/repos",
    "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "tuyennhv",
    "id": 10568965,
    "node_id": "MDQ6VXNlcjEwNTY4OTY1",
    "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tuyennhv",
    "html_url": "https://github.com/tuyennhv",
    "followers_url": "https://api.github.com/users/tuyennhv/followers",
    "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
    "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
    "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
    "repos_url": "https://api.github.com/users/tuyennhv/repos",
    "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "tuyennhv",
      "id": 10568965,
      "node_id": "MDQ6VXNlcjEwNTY4OTY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tuyennhv",
      "html_url": "https://github.com/tuyennhv",
      "followers_url": "https://api.github.com/users/tuyennhv/followers",
      "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
      "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
      "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
      "repos_url": "https://api.github.com/users/tuyennhv/repos",
      "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/milestones/11",
    "html_url": "https://github.com/ChainSafe/lodestar/milestone/11",
    "labels_url": "https://api.github.com/repos/ChainSafe/lodestar/milestones/11/labels",
    "id": 6328418,
    "node_id": "MDk6TWlsZXN0b25lNjMyODQxOA==",
    "number": 11,
    "title": "0.15.0",
    "description": "Something inspiring and descriptive should go there",
    "creator": {
      "login": "wemeetagain",
      "id": 1348242,
      "node_id": "MDQ6VXNlcjEzNDgyNDI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1348242?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/wemeetagain",
      "html_url": "https://github.com/wemeetagain",
      "followers_url": "https://api.github.com/users/wemeetagain/followers",
      "following_url": "https://api.github.com/users/wemeetagain/following{/other_user}",
      "gists_url": "https://api.github.com/users/wemeetagain/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/wemeetagain/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/wemeetagain/subscriptions",
      "organizations_url": "https://api.github.com/users/wemeetagain/orgs",
      "repos_url": "https://api.github.com/users/wemeetagain/repos",
      "events_url": "https://api.github.com/users/wemeetagain/events{/privacy}",
      "received_events_url": "https://api.github.com/users/wemeetagain/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 0,
    "closed_issues": 6,
    "state": "closed",
    "created_at": "2021-01-19T15:25:43Z",
    "updated_at": "2022-02-18T05:28:23Z",
    "due_on": "2021-02-02T08:00:00Z",
    "closed_at": "2022-02-18T05:28:23Z"
  },
  "comments": 3,
  "created_at": "2021-01-14T02:34:49Z",
  "updated_at": "2021-03-16T14:57:56Z",
  "closed_at": "2021-03-16T14:57:56Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "The idea came from https://github.com/ChainSafe/lodestar/pull/1925#pullrequestreview-564581634\r\n\r\n> Going forward, we should take some time to possibly re-organize the beacon state, validator cache, epoch context, epoch process, etc. as needed.\r\n\r\n> This is mainly an issue of how we organize the various datastructures (BeaconState, CachedValidatorsBeaconState, EpochContext, EpochProcess, IStateContext). I'm not sure what the right organization is (possibly no re-organization needed) but what we have seems to be getting more cluttered as we've added more and more optimizations. We have several nested datastructures that are all related to the beacon state / epoch state.\r\n\r\n> My hunch is that we may be able to expand the CachedValidatorBeaconState to be more of a general CachedBeaconState at the 'top-level', like IStateContext, which exposes the BeaconState + extra methods, with various caches 'under the hood' (each cache using 'persistent-ts' or similar for cheap cloning).\r\n\r\nNeed to come to an agreement regarding how it looks like before implementation.",
  "closed_by": {
    "login": "wemeetagain",
    "id": 1348242,
    "node_id": "MDQ6VXNlcjEzNDgyNDI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1348242?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/wemeetagain",
    "html_url": "https://github.com/wemeetagain",
    "followers_url": "https://api.github.com/users/wemeetagain/followers",
    "following_url": "https://api.github.com/users/wemeetagain/following{/other_user}",
    "gists_url": "https://api.github.com/users/wemeetagain/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/wemeetagain/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/wemeetagain/subscriptions",
    "organizations_url": "https://api.github.com/users/wemeetagain/orgs",
    "repos_url": "https://api.github.com/users/wemeetagain/repos",
    "events_url": "https://api.github.com/users/wemeetagain/events{/privacy}",
    "received_events_url": "https://api.github.com/users/wemeetagain/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/1950/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/1950/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/760595788",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/1950#issuecomment-760595788",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/1950",
    "id": 760595788,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc2MDU5NTc4OA==",
    "user": {
      "login": "tuyennhv",
      "id": 10568965,
      "node_id": "MDQ6VXNlcjEwNTY4OTY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tuyennhv",
      "html_url": "https://github.com/tuyennhv",
      "followers_url": "https://api.github.com/users/tuyennhv/followers",
      "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
      "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
      "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
      "repos_url": "https://api.github.com/users/tuyennhv/repos",
      "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-01-15T02:05:38Z",
    "updated_at": "2021-01-15T02:05:38Z",
    "author_association": "CONTRIBUTOR",
    "body": "one good thing with caching IFlatValidator (which is currently in CachedValidatorsBeaconState) is we can pull `epochBalances` directly from there instead of having to publish `epochProcess` (in lodestar-beacon-state-transition) to lodestar, the consequence of that is:\r\n+ No need different types of EpochContext (StateTransitionEpochContext, LodestarEpochContext), only EpochContext\r\n+ `epochProcess` stays internal to lodestar-beacon-state-transition and hence it's not a concern\r\n\r\nwe need to do this cleanup work before implementing CachedBeaconState",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/760595788/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/763517895",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/1950#issuecomment-763517895",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/1950",
    "id": 763517895,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc2MzUxNzg5NQ==",
    "user": {
      "login": "tuyennhv",
      "id": 10568965,
      "node_id": "MDQ6VXNlcjEwNTY4OTY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tuyennhv",
      "html_url": "https://github.com/tuyennhv",
      "followers_url": "https://api.github.com/users/tuyennhv/followers",
      "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
      "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
      "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
      "repos_url": "https://api.github.com/users/tuyennhv/repos",
      "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-01-20T10:51:03Z",
    "updated_at": "2021-01-20T10:58:58Z",
    "author_association": "CONTRIBUTOR",
    "body": "so the class looks like this\r\n```ts\r\nexport class CachedBeaconState extends EpochContext {\r\n  ...// old stuff of CachedValidatorsBeaconState\r\n  // same method to EpochContext without param\r\n  public rotateEpochs(): void {\r\n    super.rotateEpochs(this);\r\n  }\r\n  // same method to EpochContext without param\r\n  public syncPubkeys(): void {\r\n    super.syncPubkeys(this.getOriginalState());\r\n  }\r\n}\r\n```\r\n\r\n+ we separate EpochContext (epoch stuff cache) and other BeaconState related cache while consumer only know CacheBeaconState and it has everything it needs\r\n+ `CachedBeaconState.clone()` is cheap\r\n+ EpochContext becomes abstract, noone should use it directly\r\n+ stateTransition function looks like:\r\n```ts\r\nexport function fastStateTransition(\r\n  cachedState: CachedBeaconState,\r\n  signedBlock: SignedBeaconBlock,\r\n  options?: {verifyStateRoot?: boolean; verifyProposer?: boolean; verifySignatures?: boolean}\r\n): CachedBeaconState\r\n```\r\n+ lodestar should use this new CachedBeaconState across the package instead of IStateContext/ITreeStateContext which is removed",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/763517895/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/800332738",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/1950#issuecomment-800332738",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/1950",
    "id": 800332738,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwMDMzMjczOA==",
    "user": {
      "login": "wemeetagain",
      "id": 1348242,
      "node_id": "MDQ6VXNlcjEzNDgyNDI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1348242?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/wemeetagain",
      "html_url": "https://github.com/wemeetagain",
      "followers_url": "https://api.github.com/users/wemeetagain/followers",
      "following_url": "https://api.github.com/users/wemeetagain/following{/other_user}",
      "gists_url": "https://api.github.com/users/wemeetagain/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/wemeetagain/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/wemeetagain/subscriptions",
      "organizations_url": "https://api.github.com/users/wemeetagain/orgs",
      "repos_url": "https://api.github.com/users/wemeetagain/repos",
      "events_url": "https://api.github.com/users/wemeetagain/events{/privacy}",
      "received_events_url": "https://api.github.com/users/wemeetagain/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-16T14:57:56Z",
    "updated_at": "2021-03-16T14:57:56Z",
    "author_association": "MEMBER",
    "body": "resolved in #2172 ",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/800332738/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
