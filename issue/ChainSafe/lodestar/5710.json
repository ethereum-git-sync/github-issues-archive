{
  "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5710",
  "repository_url": "https://api.github.com/repos/ChainSafe/lodestar",
  "labels_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5710/labels{/name}",
  "comments_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5710/comments",
  "events_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5710/events",
  "html_url": "https://github.com/ChainSafe/lodestar/issues/5710",
  "id": 1775406740,
  "node_id": "I_kwDOCD5_Gc5p0o6U",
  "number": 5710,
  "title": "Beacon API v2.4.2 spec compliance",
  "user": {
    "login": "nflaig",
    "id": 38436224,
    "node_id": "MDQ6VXNlcjM4NDM2MjI0",
    "avatar_url": "https://avatars.githubusercontent.com/u/38436224?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/nflaig",
    "html_url": "https://github.com/nflaig",
    "followers_url": "https://api.github.com/users/nflaig/followers",
    "following_url": "https://api.github.com/users/nflaig/following{/other_user}",
    "gists_url": "https://api.github.com/users/nflaig/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/nflaig/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/nflaig/subscriptions",
    "organizations_url": "https://api.github.com/users/nflaig/orgs",
    "repos_url": "https://api.github.com/users/nflaig/repos",
    "events_url": "https://api.github.com/users/nflaig/events{/privacy}",
    "received_events_url": "https://api.github.com/users/nflaig/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3592888034,
      "node_id": "LA_kwDOCD5_Gc7WJx7i",
      "url": "https://api.github.com/repos/ChainSafe/lodestar/labels/Epic",
      "name": "Epic",
      "color": "4660F9",
      "default": false,
      "description": "Issues used as milestones and tracking multiple issues."
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2023-06-26T19:02:41Z",
  "updated_at": "2023-12-18T12:07:49Z",
  "closed_at": null,
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "The current spec tests only check against beacon API spec v2.3.0.\r\n\r\nhttps://github.com/ChainSafe/lodestar/blob/50daa01c80b22136e70b7cfb5ab66c735f9641a8/packages/api/test/unit/beacon/oapiSpec.test.ts#L26\r\n\r\nTo be compliant to latest beacon API spec ([v2.4.2](https://github.com/ethereum/beacon-APIs/releases/tag/v2.4.2)) several updates are required:\r\n\r\n# v2.4.2\r\n\r\n- [ ] https://github.com/ChainSafe/lodestar/issues/6185\r\n\r\n# v2.4.1\r\n\r\n*Nothing*\r\n\r\n# v2.4.0\r\n\r\n- [ ] Ensure operationIds match spec value\r\n- [ ] https://github.com/ChainSafe/lodestar/issues/5693 (WIP)\r\n- [x] https://github.com/ChainSafe/lodestar/issues/5542\r\n- [ ] https://github.com/ChainSafe/lodestar/issues/5694 (WIP)\r\n- [ ] https://github.com/ChainSafe/lodestar/issues/5696\r\n- [x] https://github.com/ChainSafe/lodestar/issues/5698\r\n- [x] https://github.com/ChainSafe/lodestar/issues/5697 (won't implement, will be superseded)\r\n- [ ] https://github.com/ChainSafe/lodestar/issues/5699\r\n- [ ] https://github.com/ChainSafe/lodestar/issues/5700\r\n- [x] https://github.com/ChainSafe/lodestar/issues/5701\r\n- [x] https://github.com/ChainSafe/lodestar/issues/5702\r\n- [ ] https://github.com/ChainSafe/lodestar/issues/4638\r\n- [ ] https://github.com/ChainSafe/lodestar/issues/6167\r\n- [ ] https://github.com/ChainSafe/lodestar/issues/6168\r\n- [ ] https://github.com/ChainSafe/lodestar/issues/6170\r\n\r\nAll the above issues can be tackled independently. \r\nProgress has been started on [this branch](https://github.com/ChainSafe/lodestar/compare/unstable...nflaig/update-beacon-spec-version) which can also be used to run spec tests against latest version.\r\nMight have to add ignore list to spec tests if it is not possible to implement all APIs due to other priorities.",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5710/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5710/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1860240826",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/5710#issuecomment-1860240826",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5710",
    "id": 1860240826,
    "node_id": "IC_kwDOCD5_Gc5u4QW6",
    "user": {
      "login": "naviechan",
      "id": 17676176,
      "node_id": "MDQ6VXNlcjE3Njc2MTc2",
      "avatar_url": "https://avatars.githubusercontent.com/u/17676176?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/naviechan",
      "html_url": "https://github.com/naviechan",
      "followers_url": "https://api.github.com/users/naviechan/followers",
      "following_url": "https://api.github.com/users/naviechan/following{/other_user}",
      "gists_url": "https://api.github.com/users/naviechan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/naviechan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/naviechan/subscriptions",
      "organizations_url": "https://api.github.com/users/naviechan/orgs",
      "repos_url": "https://api.github.com/users/naviechan/repos",
      "events_url": "https://api.github.com/users/naviechan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/naviechan/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-12-18T11:38:51Z",
    "updated_at": "2023-12-18T11:47:44Z",
    "author_association": "CONTRIBUTOR",
    "body": "On a related note, at some point we should update the api error messages to be compliant with the Beacon API spec.\r\n\r\neg.\r\n### [Expected](https://ethereum.github.io/beacon-APIs/#/Beacon/getStateRoot)\r\n```\r\ncurl http://localhost:9596/eth/v1/beacon/states/current/root | jq\r\n{\r\n  \"code\": 400,\r\n  \"message\": \"Invalid state ID: current\"\r\n}\r\n```\r\n### Actual\r\n```\r\n{\r\n  \"statusCode\": 400,\r\n  \"error\": \"Bad Request\",\r\n  \"message\": \"Invalid block id 'current'\"\r\n}\r\n```\r\n\r\n### [Expected](https://ethereum.github.io/beacon-APIs/#/Beacon/getPoolAttestations)\r\n```\r\ncurl \"http://localhost:9596/eth/v1/beacon/pool/attestations?slot=current&committee_index=123\" | jq\r\n{\r\n  \"code\": 400,\r\n  \"message\": \"Invalid slot: current\"\r\n}\r\n```\r\n### Actual\r\n```\r\n[\r\n  {\r\n    \"instancePath\": \"/slot\",\r\n    \"schemaPath\": \"#/properties/slot/type\",\r\n    \"keyword\": \"type\",\r\n    \"params\": {\r\n      \"type\": \"integer\"\r\n    },\r\n    \"message\": \"must be integer\"\r\n  }\r\n]\r\n```\r\n\r\n### [Expected](https://ethereum.github.io/beacon-APIs/#/Beacon/getBlockHeader)\r\n```\r\ncurl http://localhost:9596/eth/v1/beacon/headers/123 | jq\r\n{\r\n  \"code\": 404,\r\n  \"message\": \"Block not found\"\r\n}\r\n```\r\n### Actual\r\n```\r\n{\r\n  \"statusCode\": 404,\r\n  \"error\": \"Not Found\",\r\n  \"message\": \"No block found for id '123'\"\r\n}\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1860240826/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1860315572",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/5710#issuecomment-1860315572",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5710",
    "id": 1860315572,
    "node_id": "IC_kwDOCD5_Gc5u4im0",
    "user": {
      "login": "nflaig",
      "id": 38436224,
      "node_id": "MDQ6VXNlcjM4NDM2MjI0",
      "avatar_url": "https://avatars.githubusercontent.com/u/38436224?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nflaig",
      "html_url": "https://github.com/nflaig",
      "followers_url": "https://api.github.com/users/nflaig/followers",
      "following_url": "https://api.github.com/users/nflaig/following{/other_user}",
      "gists_url": "https://api.github.com/users/nflaig/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nflaig/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nflaig/subscriptions",
      "organizations_url": "https://api.github.com/users/nflaig/orgs",
      "repos_url": "https://api.github.com/users/nflaig/repos",
      "events_url": "https://api.github.com/users/nflaig/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nflaig/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-12-18T12:07:48Z",
    "updated_at": "2023-12-18T12:07:48Z",
    "author_association": "MEMBER",
    "body": "> On a related note, at some point we should update the api error messages to be compliant with the Beacon API spec.\r\n\r\nI have looked at this before, it should be possible to transform the error before we send it\r\nhttps://github.com/ChainSafe/lodestar/blob/54e8c4509b1ada622ebeac9dd7954c8bb1e8932f/packages/beacon-node/src/api/rest/base.ts#L67\r\n\r\nRegarding the `statusCode` property, this is something fastify sets internally as well I did not find a good way to customize this. e.g. is even hard coded here, I don't think we can override those (other than adding custom default error handler)\r\n[fastify.js#L687-L711](https://github.com/fastify/fastify/blob/e3a07eaa444d0e769802195816d4e1718c2fc9ea/fastify.js#L687-L711)\r\n```js\r\nbody = `{\"error\":\"${errorStatus}\",\"message\":\"Client Timeout\",\"statusCode\":408}`\r\n```\r\n\r\nIn case of default json schema error, would have to compile it in a single messages maybe something like\r\n```js\r\nconst { instancePath, message } = errors[0]\r\nconst message = `${instancePath.substring(instancePath.lastIndexOf(\"/\") + 1)} ${message}`\r\n```\r\n\r\nEven though it would be good if we can support all properties I don't think anyone is actually looking at the json body of an error (unless API is used manually). Most important is the http status code and also `res.text` as this is used in Lodestar to display the error message.\r\nhttps://github.com/ChainSafe/lodestar/blob/71160df1c3d930285ad5ef2fa7f162d7a1fcfdeb/packages/api/src/utils/client/httpClient.ts#L312-L313",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1860315572/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
