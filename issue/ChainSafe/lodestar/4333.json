{
  "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4333",
  "repository_url": "https://api.github.com/repos/ChainSafe/lodestar",
  "labels_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4333/labels{/name}",
  "comments_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4333/comments",
  "events_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4333/events",
  "html_url": "https://github.com/ChainSafe/lodestar/issues/4333",
  "id": 1311199582,
  "node_id": "I_kwDOCD5_Gc5OJ1Fe",
  "number": 4333,
  "title": "Lodestar produced block with invalid attestation during Sepolia instability",
  "user": {
    "login": "dapplion",
    "id": 35266934,
    "node_id": "MDQ6VXNlcjM1MjY2OTM0",
    "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/dapplion",
    "html_url": "https://github.com/dapplion",
    "followers_url": "https://api.github.com/users/dapplion/followers",
    "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
    "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
    "organizations_url": "https://api.github.com/users/dapplion/orgs",
    "repos_url": "https://api.github.com/users/dapplion/repos",
    "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
    "received_events_url": "https://api.github.com/users/dapplion/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 2159934357,
      "node_id": "MDU6TGFiZWwyMTU5OTM0MzU3",
      "url": "https://api.github.com/repos/ChainSafe/lodestar/labels/scope-testnet-debugging",
      "name": "scope-testnet-debugging",
      "color": "980043",
      "default": false,
      "description": "Issues uncovered through running a node on a public testnet."
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "tuyennhv",
    "id": 10568965,
    "node_id": "MDQ6VXNlcjEwNTY4OTY1",
    "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tuyennhv",
    "html_url": "https://github.com/tuyennhv",
    "followers_url": "https://api.github.com/users/tuyennhv/followers",
    "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
    "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
    "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
    "repos_url": "https://api.github.com/users/tuyennhv/repos",
    "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "tuyennhv",
      "id": 10568965,
      "node_id": "MDQ6VXNlcjEwNTY4OTY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tuyennhv",
      "html_url": "https://github.com/tuyennhv",
      "followers_url": "https://api.github.com/users/tuyennhv/followers",
      "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
      "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
      "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
      "repos_url": "https://api.github.com/users/tuyennhv/repos",
      "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2022-07-20T14:14:59Z",
  "updated_at": "2022-08-01T15:23:27Z",
  "closed_at": "2022-08-01T15:23:27Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "Post merge Sepolia has 2 unstable epochs\r\n\r\n- the first merge slot was https://sepolia.beaconcha.in/block/115193\r\n- Up until slot 115232, we don't see any of the config issue related validators missing a single slot. 115233 however is missed by lodestar and subsequently 115234&115235 are also missed by Besu and Nimbus. These are providers where no config issue is known, hence it could be a shuffling issue or something else\r\n- The trigger point could be slot 115233, see slot dump from Nimbus node [invalid.tar.gz](https://github.com/ChainSafe/lodestar/files/9150536/invalid.tar.gz)\r\n- Teku also logged that invalid slot. They failed validating the signature but the proposer_index matches the expected one (709) according to beaconcha.in [115233.zip](https://github.com/ChainSafe/lodestar/files/9150573/115233.zip)\r\n- Seems like the block contains an attestation with invalid signature [state_at_115232.ssz.zip](https://github.com/ChainSafe/lodestar/files/9150582/state_at_115232.ssz.zip)\r\n- The offending attestation is\r\n```\r\nIndexedAttestation{attesting_indices=SszList{size=17: 50, 198, 311, 389, 556, 639, 804, 1121, 1238, 1324, 1435, 1448, 1487, 1497, 1612, 1640, 1779}, data=AttestationData{slot=115232, index=0, beacon_block_root=0xacd63ca2b12641cb281fe40a479a5bf37debbba9ae324e4c9089742fdbbe1403, source=Checkpoint{epoch=3599, root=0x5a4b89da91bfe310be27b6cccaf4ead3ec62280d1ed9f4356e6df525a1f2d19b}, target=Checkpoint{epoch=3601, root=0xacd63ca2b12641cb281fe40a479a5bf37debbba9ae324e4c9089742fdbbe1403}}, signature=SszByteVector{0x86330d22c822f54c36456a82420ec64150024016a9ca1dd59218cec47d4d0be8182dbad6eacfff6debecd9ab2c7390840321416e0cb7ce01e6428ddef73f2777ca69e7d7fe448fc1febd86c6bff4d8a509bc29a3ec32e19e3f79aee8661c30ff}}\r\n```\r\n- source is correct, the target is weird. And gap between source and target is a couple of epochs. Source pre-merge and target post-merge.\r\n\r\n**Hypothesis**\r\n- attestation is valid wrt side chain and makes it into pool\r\n- beacon node produces block on mainchain (with divergent shuffling) and pulls thsi attestation from the pool (because it was pre-validated)\r\n- block is invalid because bitfield represents side-chain shuffling and is invalid to the assumed mainchain shuffling in the block\r\n\r\n_continue_\r\n- the gap 3599-3601 is present in other attestations https://sepolia.beaconcha.in/epoch/3601 - the target root is wrong\r\n- But it might be correct wrt to the side chain, which the node had blocks available at the time\r\n- The gap here at the point merge implies that there was still agreement in latest finalized and thus the source correct and thus lodestar still importing side-chain blocks",
  "closed_by": {
    "login": "wemeetagain",
    "id": 1348242,
    "node_id": "MDQ6VXNlcjEzNDgyNDI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1348242?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/wemeetagain",
    "html_url": "https://github.com/wemeetagain",
    "followers_url": "https://api.github.com/users/wemeetagain/followers",
    "following_url": "https://api.github.com/users/wemeetagain/following{/other_user}",
    "gists_url": "https://api.github.com/users/wemeetagain/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/wemeetagain/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/wemeetagain/subscriptions",
    "organizations_url": "https://api.github.com/users/wemeetagain/orgs",
    "repos_url": "https://api.github.com/users/wemeetagain/repos",
    "events_url": "https://api.github.com/users/wemeetagain/events{/privacy}",
    "received_events_url": "https://api.github.com/users/wemeetagain/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4333/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4333/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1191471214",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/4333#issuecomment-1191471214",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4333",
    "id": 1191471214,
    "node_id": "IC_kwDOCD5_Gc5HBGhu",
    "user": {
      "login": "tuyennhv",
      "id": 10568965,
      "node_id": "MDQ6VXNlcjEwNTY4OTY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tuyennhv",
      "html_url": "https://github.com/tuyennhv",
      "followers_url": "https://api.github.com/users/tuyennhv/followers",
      "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
      "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
      "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
      "repos_url": "https://api.github.com/users/tuyennhv/repos",
      "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-21T13:14:43Z",
    "updated_at": "2022-07-21T13:14:43Z",
    "author_association": "CONTRIBUTOR",
    "body": "The hypothesis is correct, the weird block `0xacd63ca2b12641cb281fe40a479a5bf37debbba9ae324e4c9089742fdbbe1403` happened in attestations of block slot 115225 to 115231 as head root. From https://sepolia.beaconcha.in/ I suppose:\r\n\r\n<img width=\"818\" alt=\"Screen Shot 2022-07-21 at 20 11 02\" src=\"https://user-images.githubusercontent.com/10568965/180221659-454a06f3-13ff-4cd0-a9d6-3156118eb2ca.png\">\r\n\r\n\r\n- Note that slot 115224 does not pass the main branch checkpoint (115200), common ancestor is 115192\r\n- At epoch 3600, some validators voted for 115224 as head and their attestations are valid because attester dependent root is last slot of epoch 3598 (same shuffling to main branch)\r\n- At epoch 3601, some validators voted for 115224 as head, it passes gossip validation because we use state 115224 to verify. However attester dependent root (slot 115199) is different to main branch (different shuffling to main branch), i.e if we use head state to validate these attestations, signature verification would failed.\r\n- At slot 115233 (epoch 3601), we produced block and include this conflicted attestation\r\n\r\n\r\n**Note**\r\n- According to the spec https://github.com/ethereum/consensus-specs/blob/dev/specs/phase0/validator.md#attestations : `Up to MAX_ATTESTATIONS, aggregate attestations can be included in the block. The attestations added must satisfy the verification conditions found in [attestation processing](https://github.com/ethereum/consensus-specs/blob/dev/specs/phase0/beacon-chain.md#attestations)`\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1191471214/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1191806544",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/4333#issuecomment-1191806544",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4333",
    "id": 1191806544,
    "node_id": "IC_kwDOCD5_Gc5HCYZQ",
    "user": {
      "login": "dapplion",
      "id": 35266934,
      "node_id": "MDQ6VXNlcjM1MjY2OTM0",
      "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dapplion",
      "html_url": "https://github.com/dapplion",
      "followers_url": "https://api.github.com/users/dapplion/followers",
      "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
      "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
      "organizations_url": "https://api.github.com/users/dapplion/orgs",
      "repos_url": "https://api.github.com/users/dapplion/repos",
      "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dapplion/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-21T18:31:05Z",
    "updated_at": "2022-07-21T18:31:05Z",
    "author_association": "MEMBER",
    "body": "@tuyennhv so is there any issue that causes this block to be valid with respect to Lodestar and invalid to other network participants?",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1191806544/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1192272228",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/4333#issuecomment-1192272228",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4333",
    "id": 1192272228,
    "node_id": "IC_kwDOCD5_Gc5HEKFk",
    "user": {
      "login": "tuyennhv",
      "id": 10568965,
      "node_id": "MDQ6VXNlcjEwNTY4OTY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tuyennhv",
      "html_url": "https://github.com/tuyennhv",
      "followers_url": "https://api.github.com/users/tuyennhv/followers",
      "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
      "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
      "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
      "repos_url": "https://api.github.com/users/tuyennhv/repos",
      "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-22T07:29:47Z",
    "updated_at": "2022-07-22T07:29:47Z",
    "author_association": "CONTRIBUTOR",
    "body": "> @tuyennhv so is there any issue that causes this block to be valid with respect to Lodestar and invalid to other network participants?\r\n\r\nno, lodestar is compatible to other clients. In the example above the produced block is not valid even to lodestar. Before bundling an attestation into block, we need to validate the signature of attestation. But since we did it in gossip validation function, we only need to make sure the shuffling of attestation is compatible to the state used to produce block.",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1192272228/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
