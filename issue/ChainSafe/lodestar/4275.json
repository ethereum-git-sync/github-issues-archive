{
  "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4275",
  "repository_url": "https://api.github.com/repos/ChainSafe/lodestar",
  "labels_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4275/labels{/name}",
  "comments_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4275/comments",
  "events_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4275/events",
  "html_url": "https://github.com/ChainSafe/lodestar/issues/4275",
  "id": 1300020643,
  "node_id": "I_kwDOCD5_Gc5NfL2j",
  "number": 4275,
  "title": "Sim tests overhaul",
  "user": {
    "login": "dapplion",
    "id": 35266934,
    "node_id": "MDQ6VXNlcjM1MjY2OTM0",
    "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/dapplion",
    "html_url": "https://github.com/dapplion",
    "followers_url": "https://api.github.com/users/dapplion/followers",
    "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
    "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
    "organizations_url": "https://api.github.com/users/dapplion/orgs",
    "repos_url": "https://api.github.com/users/dapplion/repos",
    "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
    "received_events_url": "https://api.github.com/users/dapplion/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3592888034,
      "node_id": "LA_kwDOCD5_Gc7WJx7i",
      "url": "https://api.github.com/repos/ChainSafe/lodestar/labels/Epic",
      "name": "Epic",
      "color": "4660F9",
      "default": false,
      "description": "Issues used as milestones and tracking multiple issues."
    },
    {
      "id": 4118053382,
      "node_id": "LA_kwDOCD5_Gc71dIIG",
      "url": "https://api.github.com/repos/ChainSafe/lodestar/labels/scope-testing",
      "name": "scope-testing",
      "color": "980043",
      "default": false,
      "description": "Issues for adding test coverage, fixing existing tests or testing strategies."
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "nazarhussain",
    "id": 112468,
    "node_id": "MDQ6VXNlcjExMjQ2OA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/112468?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/nazarhussain",
    "html_url": "https://github.com/nazarhussain",
    "followers_url": "https://api.github.com/users/nazarhussain/followers",
    "following_url": "https://api.github.com/users/nazarhussain/following{/other_user}",
    "gists_url": "https://api.github.com/users/nazarhussain/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/nazarhussain/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/nazarhussain/subscriptions",
    "organizations_url": "https://api.github.com/users/nazarhussain/orgs",
    "repos_url": "https://api.github.com/users/nazarhussain/repos",
    "events_url": "https://api.github.com/users/nazarhussain/events{/privacy}",
    "received_events_url": "https://api.github.com/users/nazarhussain/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "nazarhussain",
      "id": 112468,
      "node_id": "MDQ6VXNlcjExMjQ2OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/112468?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nazarhussain",
      "html_url": "https://github.com/nazarhussain",
      "followers_url": "https://api.github.com/users/nazarhussain/followers",
      "following_url": "https://api.github.com/users/nazarhussain/following{/other_user}",
      "gists_url": "https://api.github.com/users/nazarhussain/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nazarhussain/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nazarhussain/subscriptions",
      "organizations_url": "https://api.github.com/users/nazarhussain/orgs",
      "repos_url": "https://api.github.com/users/nazarhussain/repos",
      "events_url": "https://api.github.com/users/nazarhussain/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nazarhussain/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 6,
  "created_at": "2022-07-10T21:26:19Z",
  "updated_at": "2022-11-16T15:33:05Z",
  "closed_at": "2022-11-16T09:36:52Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "**Background**\r\n\r\n_Sim test = running a full devnet for some time_\r\n\r\nSim tests are crucial to test blockchain nodes due to their complexity. Unit tests or e2e test never capture the complexity of the system when it's running at full capacity. Even then running a full devnet in CI is not sufficient to capture all bugs since some only appear under certain network size and / or conditions.\r\n\r\nThe scope and goals of sim tests in this repo should be:\r\n- [x] Run small devnet for a relatively short period of time.\r\n- [x] Capture a large amount of metrics to ensure good performance on all fronts.\r\n- [x] Do so every commit, or at least on every commit of the main branch\r\n\r\nSim tests are (and will be) complemented by:\r\n- [x] ~~Kurtosis testing: Run small devnets for short time but with all other client combinations. Medium level of assertions~~ Moved to #4772\r\n- [x] ~~Hive testing: Run small devnets for short time but with unusual network conditions. Low level of assertions https://github.com/ChainSafe/lodestar/issues/4240~~ Moved to #4773\r\n- [x] Deployment on Prater (beta testing): Run big devnet for long periods of time, but only infrequently before releases\r\n\r\n**TODO**\r\n\r\nCurrent sim test implementation is very old an subpar. It could be structured in a way that more modular, mantainable, and stable. However the first important step is to add assertions to cover the missing tick in the scope outline above:\r\n\r\n- [x] Add proper assertions to sim tests https://github.com/ChainSafe/lodestar/issues/4276\r\n- [x] Migrate leftover sim tests from e2e, to make e2e tests more stable and fast\r\n- [x] Consolidate sim tests into less runs: do lightclient, finality, sync tests in one run https://github.com/ChainSafe/lodestar/issues/3931\r\n- [x] Enable multi-node multi-process testing\r\n  - Attempt at implementing https://github.com/ChainSafe/lodestar/pull/2575\r\n  - Blocking issue https://github.com/ChainSafe/lodestar/issues/2542\r\n- [x] ~~If expensive at this point, run in self-deployed GA runner.~~ **EDIT (nov 11th)**: keep the run light to work in Github runners\r\n\r\n**Progressive improvements**\r\n- [x] Log std to file, disable log to file. Enable DEBUG=* for Lodestar\r\n- [x] Run Geth and Nethermind and test going through the merge, until finalizing merge block + 2 epochs\r\n- [x] Ensure all nodes are connected to each other https://github.com/ChainSafe/lodestar/issues/4645\r\n- [x] Once nodes reach untilEpoch, keep the chain running and spawn extra nodes to test syncing\r\n  - [x] Start 1 node from genesis and range sync to head\r\n  - [x] Start 1 node with checkpoint sync and sync to head  \r\n- [x] Update the test timeout to be calculated [deterministically](https://github.com/ChainSafe/lodestar/pull/4673#discussion_r1007250212)\r\n- [x] Disable the file logging for lodestar by explicitly setting it to `none`\r\n- [x] Update the sync tests approach by just testing the sync behavior and not waiting for a particular epoch. ",
  "closed_by": {
    "login": "dapplion",
    "id": 35266934,
    "node_id": "MDQ6VXNlcjM1MjY2OTM0",
    "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/dapplion",
    "html_url": "https://github.com/dapplion",
    "followers_url": "https://api.github.com/users/dapplion/followers",
    "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
    "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
    "organizations_url": "https://api.github.com/users/dapplion/orgs",
    "repos_url": "https://api.github.com/users/dapplion/repos",
    "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
    "received_events_url": "https://api.github.com/users/dapplion/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4275/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4275/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1181793778",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/4275#issuecomment-1181793778",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4275",
    "id": 1181793778,
    "node_id": "IC_kwDOCD5_Gc5GcL3y",
    "user": {
      "login": "nazarhussain",
      "id": 112468,
      "node_id": "MDQ6VXNlcjExMjQ2OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/112468?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nazarhussain",
      "html_url": "https://github.com/nazarhussain",
      "followers_url": "https://api.github.com/users/nazarhussain/followers",
      "following_url": "https://api.github.com/users/nazarhussain/following{/other_user}",
      "gists_url": "https://api.github.com/users/nazarhussain/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nazarhussain/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nazarhussain/subscriptions",
      "organizations_url": "https://api.github.com/users/nazarhussain/orgs",
      "repos_url": "https://api.github.com/users/nazarhussain/repos",
      "events_url": "https://api.github.com/users/nazarhussain/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nazarhussain/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-12T13:56:59Z",
    "updated_at": "2022-07-12T13:56:59Z",
    "author_association": "CONTRIBUTOR",
    "body": "While looking into following issue here is my initial observation. \r\n\r\n1. There is a lot of duplicate logic among the SIM tests and CLI \r\n2. Most of the related code is a kind of factories to create objects and configuration\r\n3. Logic of creating objects is decoupled from the implementation, so the objects not aware what are the optimal way to create related options, configurations. \r\n\r\nI would suggest following approaches to improve: \r\n\r\n1. Create static implementations in the `BeaconNode` and `Validator` to create optimal defaults for the configurations and options. \r\n2. Reuse those static methods inside CLI and SIM tests. \r\n3. This way we will reuse a lot of logic and also code related to objects creation will stay along the objects. \r\n\r\nOther approach would be: \r\n\r\n1. To have separate private package for just for testing \r\n2. That package would consume just the CLI to create all relevant objects for testing \r\n3. We can refactor those CLI code to be easily reusable for testing \r\n4. This way we will be able to create nodes exactly the user will do with CLI \r\n5. We will reuse most of the initialization logic for nodes for the tests \r\n6. We will have one place for all SIM and in future E2E tests. \r\n\r\n\r\nPlease share your thoughts.",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1181793778/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1184528337",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/4275#issuecomment-1184528337",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4275",
    "id": 1184528337,
    "node_id": "IC_kwDOCD5_Gc5GmnfR",
    "user": {
      "login": "dapplion",
      "id": 35266934,
      "node_id": "MDQ6VXNlcjM1MjY2OTM0",
      "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dapplion",
      "html_url": "https://github.com/dapplion",
      "followers_url": "https://api.github.com/users/dapplion/followers",
      "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
      "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
      "organizations_url": "https://api.github.com/users/dapplion/orgs",
      "repos_url": "https://api.github.com/users/dapplion/repos",
      "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dapplion/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-14T14:37:26Z",
    "updated_at": "2022-07-14T14:37:26Z",
    "author_association": "MEMBER",
    "body": "> To have separate private package for just for testing\r\n\r\nWe use to have this and it's not great. Tests should be placed in the package that has all the deps we need: either beacon-node or cli",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1184528337/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1184534806",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/4275#issuecomment-1184534806",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4275",
    "id": 1184534806,
    "node_id": "IC_kwDOCD5_Gc5GmpEW",
    "user": {
      "login": "wemeetagain",
      "id": 1348242,
      "node_id": "MDQ6VXNlcjEzNDgyNDI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1348242?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/wemeetagain",
      "html_url": "https://github.com/wemeetagain",
      "followers_url": "https://api.github.com/users/wemeetagain/followers",
      "following_url": "https://api.github.com/users/wemeetagain/following{/other_user}",
      "gists_url": "https://api.github.com/users/wemeetagain/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/wemeetagain/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/wemeetagain/subscriptions",
      "organizations_url": "https://api.github.com/users/wemeetagain/orgs",
      "repos_url": "https://api.github.com/users/wemeetagain/repos",
      "events_url": "https://api.github.com/users/wemeetagain/events{/privacy}",
      "received_events_url": "https://api.github.com/users/wemeetagain/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-14T14:42:40Z",
    "updated_at": "2022-07-14T14:42:40Z",
    "author_association": "MEMBER",
    "body": "somewhat related: https://github.com/ChainSafe/lodestar/issues/4031\r\nNot a private package, but test utilities def could be better organized for reuse",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1184534806/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1188635586",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/4275#issuecomment-1188635586",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4275",
    "id": 1188635586,
    "node_id": "IC_kwDOCD5_Gc5G2SPC",
    "user": {
      "login": "dapplion",
      "id": 35266934,
      "node_id": "MDQ6VXNlcjM1MjY2OTM0",
      "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dapplion",
      "html_url": "https://github.com/dapplion",
      "followers_url": "https://api.github.com/users/dapplion/followers",
      "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
      "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
      "organizations_url": "https://api.github.com/users/dapplion/orgs",
      "repos_url": "https://api.github.com/users/dapplion/repos",
      "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dapplion/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-19T06:05:38Z",
    "updated_at": "2022-07-19T06:05:38Z",
    "author_association": "MEMBER",
    "body": "> somewhat related: #4031 Not a private package, but test utilities def could be better organized for reuse\r\n\r\nThe initial idea of that package is to generate blocks and attesations valid for running tests without mocks. Since sim tests just run the full chain doesn't really apply",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1188635586/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1312088229",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/4275#issuecomment-1312088229",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4275",
    "id": 1312088229,
    "node_id": "IC_kwDOCD5_Gc5ONOCl",
    "user": {
      "login": "nazarhussain",
      "id": 112468,
      "node_id": "MDQ6VXNlcjExMjQ2OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/112468?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nazarhussain",
      "html_url": "https://github.com/nazarhussain",
      "followers_url": "https://api.github.com/users/nazarhussain/followers",
      "following_url": "https://api.github.com/users/nazarhussain/following{/other_user}",
      "gists_url": "https://api.github.com/users/nazarhussain/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nazarhussain/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nazarhussain/subscriptions",
      "organizations_url": "https://api.github.com/users/nazarhussain/orgs",
      "repos_url": "https://api.github.com/users/nazarhussain/repos",
      "events_url": "https://api.github.com/users/nazarhussain/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nazarhussain/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-11-11T19:15:18Z",
    "updated_at": "2022-11-11T19:15:18Z",
    "author_association": "CONTRIBUTOR",
    "body": "We need to keep the issue open for the rest of the tasks. ",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1312088229/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1312094048",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/4275#issuecomment-1312094048",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4275",
    "id": 1312094048,
    "node_id": "IC_kwDOCD5_Gc5ONPdg",
    "user": {
      "login": "dapplion",
      "id": 35266934,
      "node_id": "MDQ6VXNlcjM1MjY2OTM0",
      "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dapplion",
      "html_url": "https://github.com/dapplion",
      "followers_url": "https://api.github.com/users/dapplion/followers",
      "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
      "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
      "organizations_url": "https://api.github.com/users/dapplion/orgs",
      "repos_url": "https://api.github.com/users/dapplion/repos",
      "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dapplion/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-11-11T19:21:44Z",
    "updated_at": "2022-11-11T20:27:49Z",
    "author_association": "MEMBER",
    "body": "Expanding on \"Migrate leftover sim tests from e2e, to make e2e tests more stable and fast\"\r\n\r\nBy migrate I mean: cover the test / code paths with a successful sim test run and delete the e2e test.\r\n\r\n- [x] Finalized sync test. This one should already be covered by current tests https://github.com/ChainSafe/lodestar/blob/d207b506252a52b0508a521ef0c1a840aff76715/packages/beacon-node/test/e2e/sync/finalizedSync.test.ts#L27\r\n- [ ] Unknown block sync test. This one is not covered. What it does is set up a node without range sync and then manually import a block to the second node to trigger sync by unknown block parent https://github.com/ChainSafe/lodestar/blob/d207b506252a52b0508a521ef0c1a840aff76715/packages/beacon-node/test/e2e/sync/unknownBlockSync.test.ts#L30\r\n- [x] WS sync test. This one should be covered already? https://github.com/ChainSafe/lodestar/blob/d207b506252a52b0508a521ef0c1a840aff76715/packages/beacon-node/test/e2e/sync/wss.test.ts#L25\r\n- [ ] Lightclient sync + follow test. Not covered, should be doable to integrate https://github.com/ChainSafe/lodestar/blob/d207b506252a52b0508a521ef0c1a840aff76715/packages/beacon-node/test/e2e/chain/lightclient.test.ts#L48",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1312094048/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
