{
  "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2325",
  "repository_url": "https://api.github.com/repos/ChainSafe/lodestar",
  "labels_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2325/labels{/name}",
  "comments_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2325/comments",
  "events_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2325/events",
  "html_url": "https://github.com/ChainSafe/lodestar/issues/2325",
  "id": 849844545,
  "node_id": "MDU6SXNzdWU4NDk4NDQ1NDU=",
  "number": 2325,
  "title": "Investigate createFlat() function",
  "user": {
    "login": "tuyennhv",
    "id": 10568965,
    "node_id": "MDQ6VXNlcjEwNTY4OTY1",
    "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tuyennhv",
    "html_url": "https://github.com/tuyennhv",
    "followers_url": "https://api.github.com/users/tuyennhv/followers",
    "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
    "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
    "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
    "repos_url": "https://api.github.com/users/tuyennhv/repos",
    "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "tuyennhv",
    "id": 10568965,
    "node_id": "MDQ6VXNlcjEwNTY4OTY1",
    "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tuyennhv",
    "html_url": "https://github.com/tuyennhv",
    "followers_url": "https://api.github.com/users/tuyennhv/followers",
    "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
    "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
    "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
    "repos_url": "https://api.github.com/users/tuyennhv/repos",
    "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "tuyennhv",
      "id": 10568965,
      "node_id": "MDQ6VXNlcjEwNTY4OTY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tuyennhv",
      "html_url": "https://github.com/tuyennhv",
      "followers_url": "https://api.github.com/users/tuyennhv/followers",
      "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
      "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
      "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
      "repos_url": "https://api.github.com/users/tuyennhv/repos",
      "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2021-04-04T10:22:44Z",
  "updated_at": "2021-04-12T23:43:00Z",
  "closed_at": "2021-04-12T23:43:00Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "**Describe the bug**\r\n\r\nThe createFlat was implemented in a generic way\r\n```ts\r\nexport function createFlat<T = ObjectLike>(value: T): T {\r\n  const flat = {} as Record<string, T[keyof T]>;\r\n  for (const [k, v] of readonlyEntries(value)) {\r\n    // eslint-disable-next-line @typescript-eslint/ban-types\r\n    flat[k as string] = ((v as unknown) as object).valueOf() as T[keyof T];\r\n  }\r\n  return (flat as unknown) as T;\r\n}\r\n```\r\n\r\nbut I found it's much better (in term of performance) if we use this\r\n\r\n```ts\r\nexport function createValidatorFlat(v: Validator): Validator {\r\n  return {\r\n    pubkey: v.pubkey.valueOf() as BLSPubkey,\r\n    withdrawalCredentials: v.withdrawalCredentials.valueOf() as Bytes32,\r\n    effectiveBalance: v.effectiveBalance,\r\n    slashed: v.slashed,\r\n    activationEligibilityEpoch: v.activationEligibilityEpoch,\r\n    activationEpoch: v.activationEpoch,\r\n    exitEpoch: v.exitEpoch,\r\n    withdrawableEpoch: v.withdrawableEpoch,\r\n  };\r\n}\r\n```\r\n\r\nhere's the performance test\r\n\r\n```ts\r\nit.only(\"Array[createFlat] vs Array[createValidatorFlat\", () => {\r\n    const numValidators = 114038;\r\n    const numKeyPairs = 100;\r\n    const secretKeys = interopSecretKeys(numKeyPairs);\r\n    const validators = Array.from({length: numValidators}, (_, i) => {\r\n      return config.types.phase0.Validator.createTreeBackedFromStruct ({\r\n        pubkey: secretKeys[i % numKeyPairs].toPublicKey().toBytes(),\r\n        withdrawalCredentials: Buffer.alloc(32, i),\r\n        effectiveBalance: BigInt(31000000000),\r\n        slashed: false,\r\n        activationEligibilityEpoch: 0,\r\n        activationEpoch: 0,\r\n        exitEpoch: Infinity,\r\n        withdrawableEpoch: Infinity,\r\n      });\r\n    });\r\n    const flatValidators = validators.map((v) => createFlat(v));\r\n    const flatValidators2 = validators.map((v) => createValidatorFlat(v));\r\n    expect(flatValidators).to.be.deep.equal(flatValidators2);\r\n    let start = Date.now();\r\n    for (let i = 0; i < 16; i++) {\r\n      flatValidators.map((v) => v.exitEpoch);\r\n    }\r\n    console.log(\"@@@ map using createFlat in \", Date.now() - start);\r\n    start = Date.now();\r\n    for (let i = 0; i < 16; i++) {\r\n      flatValidators2.map((v) => v.exitEpoch);\r\n    }\r\n    console.log(\"@@@ map using createValidatorFlat in \", Date.now() - start);\r\n  });\r\n```\r\n\r\nthe result is\r\n```\r\n@@@ map using createFlat in  242\r\n@@@ map using createValidatorFlat in  77\r\n```\r\n\r\n**Expected behavior**\r\n\r\nThe performance of the 2 functions should be the same.\r\npart of #2322, this simulate processing 16 validator exits per block.\r\n\r\n**Steps to Reproduce**\r\n\r\nRun the above test.",
  "closed_by": {
    "login": "tuyennhv",
    "id": 10568965,
    "node_id": "MDQ6VXNlcjEwNTY4OTY1",
    "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tuyennhv",
    "html_url": "https://github.com/tuyennhv",
    "followers_url": "https://api.github.com/users/tuyennhv/followers",
    "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
    "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
    "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
    "repos_url": "https://api.github.com/users/tuyennhv/repos",
    "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2325/reactions",
    "total_count": 2,
    "+1": 1,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 1
  },
  "timeline_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2325/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/813009629",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/2325#issuecomment-813009629",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2325",
    "id": 813009629,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgxMzAwOTYyOQ==",
    "user": {
      "login": "tuyennhv",
      "id": 10568965,
      "node_id": "MDQ6VXNlcjEwNTY4OTY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tuyennhv",
      "html_url": "https://github.com/tuyennhv",
      "followers_url": "https://api.github.com/users/tuyennhv/followers",
      "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
      "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
      "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
      "repos_url": "https://api.github.com/users/tuyennhv/repos",
      "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-04-04T10:29:18Z",
    "updated_at": "2021-04-04T10:29:18Z",
    "author_association": "CONTRIBUTOR",
    "body": "to be more specific, this is about the validator object created from `createFlat` function, not the performance of `createFlat` itself.",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/813009629/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/813017694",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/2325#issuecomment-813017694",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2325",
    "id": 813017694,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgxMzAxNzY5NA==",
    "user": {
      "login": "dapplion",
      "id": 35266934,
      "node_id": "MDQ6VXNlcjM1MjY2OTM0",
      "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dapplion",
      "html_url": "https://github.com/dapplion",
      "followers_url": "https://api.github.com/users/dapplion/followers",
      "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
      "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
      "organizations_url": "https://api.github.com/users/dapplion/orgs",
      "repos_url": "https://api.github.com/users/dapplion/repos",
      "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dapplion/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-04-04T11:34:21Z",
    "updated_at": "2021-04-04T11:34:21Z",
    "author_association": "MEMBER",
    "body": "Good idea! No need to have createFlat generic at all it's only used for flat validtor",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/813017694/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/813039793",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/2325#issuecomment-813039793",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2325",
    "id": 813039793,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgxMzAzOTc5Mw==",
    "user": {
      "login": "wemeetagain",
      "id": 1348242,
      "node_id": "MDQ6VXNlcjEzNDgyNDI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1348242?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/wemeetagain",
      "html_url": "https://github.com/wemeetagain",
      "followers_url": "https://api.github.com/users/wemeetagain/followers",
      "following_url": "https://api.github.com/users/wemeetagain/following{/other_user}",
      "gists_url": "https://api.github.com/users/wemeetagain/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/wemeetagain/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/wemeetagain/subscriptions",
      "organizations_url": "https://api.github.com/users/wemeetagain/orgs",
      "repos_url": "https://api.github.com/users/wemeetagain/repos",
      "events_url": "https://api.github.com/users/wemeetagain/events{/privacy}",
      "received_events_url": "https://api.github.com/users/wemeetagain/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-04-04T14:10:03Z",
    "updated_at": "2021-04-04T14:10:03Z",
    "author_association": "MEMBER",
    "body": "I'm surprised by the results.\r\nThe original impl uses a 'readonly' iterator to navigate the tree more efficiently, while the new impl navigates from the root for each property.",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/813039793/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
