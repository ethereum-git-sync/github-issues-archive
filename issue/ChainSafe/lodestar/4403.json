{
  "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4403",
  "repository_url": "https://api.github.com/repos/ChainSafe/lodestar",
  "labels_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4403/labels{/name}",
  "comments_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4403/comments",
  "events_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4403/events",
  "html_url": "https://github.com/ChainSafe/lodestar/issues/4403",
  "id": 1337207285,
  "node_id": "I_kwDOCD5_Gc5PtCn1",
  "number": 4403,
  "title": "Invalid validators index value while connected to nimbus beacon node",
  "user": {
    "login": "TobiWo",
    "id": 10022464,
    "node_id": "MDQ6VXNlcjEwMDIyNDY0",
    "avatar_url": "https://avatars.githubusercontent.com/u/10022464?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/TobiWo",
    "html_url": "https://github.com/TobiWo",
    "followers_url": "https://api.github.com/users/TobiWo/followers",
    "following_url": "https://api.github.com/users/TobiWo/following{/other_user}",
    "gists_url": "https://api.github.com/users/TobiWo/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/TobiWo/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/TobiWo/subscriptions",
    "organizations_url": "https://api.github.com/users/TobiWo/orgs",
    "repos_url": "https://api.github.com/users/TobiWo/repos",
    "events_url": "https://api.github.com/users/TobiWo/events{/privacy}",
    "received_events_url": "https://api.github.com/users/TobiWo/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2022-08-12T13:26:52Z",
  "updated_at": "2022-09-01T15:04:50Z",
  "closed_at": "2022-09-01T15:04:50Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "## NOTE\r\nI don't know whether the following error is an issue with lodestar or nimbus.\r\n\r\n## Description\r\nThe following was tested on Goerli (before the merge):\r\nWhile connecting the lodestar validator to a nimbus beacon node I receive the following error:\r\n\r\n```\r\nAug-09 21:34:25.031[] error: Failed to download attester duties epoch=113472 Bad Request: Invalid validator's index value(s) - Failed to obtain attester duty\r\nError: Bad Request: Invalid validator's index value(s) - Failed to obtain attester duty\r\n    at HttpClient.requestWithBody (file:///usr/app/node_modules/@lodestar/api/src/utils/client/httpClient.ts:121:15)\r\n    at runMicrotasks (<anonymous>)\r\n    at processTicksAndRejections (node:internal/process/task_queues:96:5)\r\n    at HttpClient.json (file:///usr/app/node_modules/@lodestar/api/src/utils/client/httpClient.ts:75:12)\r\n    at Object.request [as getAttesterDuties] (file:///usr/app/node_modules/@lodestar/api/src/utils/client/client.ts:75:21)\r\n    at AttestationDutiesService.pollBeaconAttestersForEpoch (file:///usr/app/node_modules/@lodestar/validator/src/services/attestationDuties.ts:203:28)\r\n    at AttestationDutiesService.pollBeaconAttesters (file:///usr/app/node_modules/@lodestar/validator/src/services/attestationDuties.ts:155:7)\r\n    at async Promise.all (index 0)\r\n    at AttestationDutiesService.runDutiesTasks (file:///usr/app/node_modules/@lodestar/validator/src/services/attestationDuties.ts:116:5)\r\n    at Clock.runAtMostEvery (file:///usr/app/node_modules/@lodestar/validator/src/util/clock.ts:96:7)\r\nAug-09 21:34:25.033[]                error: Failed to download SyncDuties epoch=113727 Bad Request: Invalid validator's index value(s) - Failed to obtain SyncDuties\r\nError: Bad Request: Invalid validator's index value(s) - Failed to obtain SyncDuties\r\n    at HttpClient.requestWithBody (file:///usr/app/node_modules/@lodestar/api/src/utils/client/httpClient.ts:121:15)\r\n    at runMicrotasks (<anonymous>)\r\n    at processTicksAndRejections (node:internal/process/task_queues:96:5)\r\n    at HttpClient.json (file:///usr/app/node_modules/@lodestar/api/src/utils/client/httpClient.ts:75:12)\r\n    at Object.request [as getSyncCommitteeDuties] (file:///usr/app/node_modules/@lodestar/api/src/utils/client/client.ts:75:21)\r\n    at SyncCommitteeDutiesService.pollSyncCommitteesForEpoch (file:///usr/app/node_modules/@lodestar/validator/src/services/syncCommitteeDuties.ts:234:24)\r\n    at SyncCommitteeDutiesService.pollSyncCommittees (file:///usr/app/node_modules/@lodestar/validator/src/services/syncCommitteeDuties.ts:179:7)\r\n    at async Promise.all (index 0)\r\n    at SyncCommitteeDutiesService.runDutiesTasks (file:///usr/app/node_modules/@lodestar/validator/src/services/syncCommitteeDuties.ts:141:5)\r\n    at Clock.runAtMostEvery (file:///usr/app/node_modules/@lodestar/validator/src/util/clock.ts:96:7)\r\n```\r\n\r\nThe validator  fails completely and does not produce any attestations or blocks.\r\n\r\nlodestar version: 0.41.0\r\nnimbus version: 22.7.0",
  "closed_by": {
    "login": "wemeetagain",
    "id": 1348242,
    "node_id": "MDQ6VXNlcjEzNDgyNDI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1348242?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/wemeetagain",
    "html_url": "https://github.com/wemeetagain",
    "followers_url": "https://api.github.com/users/wemeetagain/followers",
    "following_url": "https://api.github.com/users/wemeetagain/following{/other_user}",
    "gists_url": "https://api.github.com/users/wemeetagain/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/wemeetagain/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/wemeetagain/subscriptions",
    "organizations_url": "https://api.github.com/users/wemeetagain/orgs",
    "repos_url": "https://api.github.com/users/wemeetagain/repos",
    "events_url": "https://api.github.com/users/wemeetagain/events{/privacy}",
    "received_events_url": "https://api.github.com/users/wemeetagain/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4403/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4403/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1214172792",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/4403#issuecomment-1214172792",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4403",
    "id": 1214172792,
    "node_id": "IC_kwDOCD5_Gc5IXs54",
    "user": {
      "login": "dapplion",
      "id": 35266934,
      "node_id": "MDQ6VXNlcjM1MjY2OTM0",
      "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dapplion",
      "html_url": "https://github.com/dapplion",
      "followers_url": "https://api.github.com/users/dapplion/followers",
      "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
      "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
      "organizations_url": "https://api.github.com/users/dapplion/orgs",
      "repos_url": "https://api.github.com/users/dapplion/repos",
      "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dapplion/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-13T14:58:07Z",
    "updated_at": "2022-08-13T14:58:07Z",
    "author_association": "MEMBER",
    "body": "If you can, could you put an API sniffer between the beacon and validator? We use this one a lot while testing the merge. It logs all requests and would be great to debug issues like this as we see the exact payload being sent by each party\r\n\r\n```\r\ndocker pull parithoshj/json_rpc_snoop:v1.0.0-x86\r\n```\r\n\r\nYou can run it with command\r\n```\r\n./json_rpc_snoop -p {{beacon_port}} http://127.0.0.1:{{snooper_port}}\r\n```\r\nAnd \r\n- tell the validator to connect to http://127.0.0.1:{{snooper_port}}\r\n- beacon should serve REST API on beacon_port",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1214172792/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1227339825",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/4403#issuecomment-1227339825",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4403",
    "id": 1227339825,
    "node_id": "IC_kwDOCD5_Gc5JJ7gx",
    "user": {
      "login": "TobiWo",
      "id": 10022464,
      "node_id": "MDQ6VXNlcjEwMDIyNDY0",
      "avatar_url": "https://avatars.githubusercontent.com/u/10022464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/TobiWo",
      "html_url": "https://github.com/TobiWo",
      "followers_url": "https://api.github.com/users/TobiWo/followers",
      "following_url": "https://api.github.com/users/TobiWo/following{/other_user}",
      "gists_url": "https://api.github.com/users/TobiWo/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/TobiWo/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/TobiWo/subscriptions",
      "organizations_url": "https://api.github.com/users/TobiWo/orgs",
      "repos_url": "https://api.github.com/users/TobiWo/repos",
      "events_url": "https://api.github.com/users/TobiWo/events{/privacy}",
      "received_events_url": "https://api.github.com/users/TobiWo/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-25T14:29:38Z",
    "updated_at": "2022-08-25T15:26:16Z",
    "author_association": "NONE",
    "body": "@dapplion Sorry for the late reply. I tried the tool but currently have issues to connect to nimbus at all with that tool. I asked parithosh already. Let's see if he can help.\r\nEDIT: I managed to get the tool running but don't see any rpc requests, only the errors of the vc from my original post.",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1227339825/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1228212922",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/4403#issuecomment-1228212922",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4403",
    "id": 1228212922,
    "node_id": "IC_kwDOCD5_Gc5JNQq6",
    "user": {
      "login": "dapplion",
      "id": 35266934,
      "node_id": "MDQ6VXNlcjM1MjY2OTM0",
      "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dapplion",
      "html_url": "https://github.com/dapplion",
      "followers_url": "https://api.github.com/users/dapplion/followers",
      "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
      "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
      "organizations_url": "https://api.github.com/users/dapplion/orgs",
      "repos_url": "https://api.github.com/users/dapplion/repos",
      "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dapplion/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-26T08:30:12Z",
    "updated_at": "2022-08-26T08:30:12Z",
    "author_association": "MEMBER",
    "body": "> @dapplion Sorry for the late reply. I tried the tool but currently have issues to connect to nimbus at all with that tool. I asked parithosh already. Let's see if he can help. EDIT: I managed to get the tool running but don't see any rpc requests, only the errors of the vc from my original post.\r\n\r\nCould you dump here your setup? Is the validator client connecting to the beacon node directly or to the snooper?",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1228212922/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1229406768",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/4403#issuecomment-1229406768",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4403",
    "id": 1229406768,
    "node_id": "IC_kwDOCD5_Gc5JR0Iw",
    "user": {
      "login": "TobiWo",
      "id": 10022464,
      "node_id": "MDQ6VXNlcjEwMDIyNDY0",
      "avatar_url": "https://avatars.githubusercontent.com/u/10022464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/TobiWo",
      "html_url": "https://github.com/TobiWo",
      "followers_url": "https://api.github.com/users/TobiWo/followers",
      "following_url": "https://api.github.com/users/TobiWo/following{/other_user}",
      "gists_url": "https://api.github.com/users/TobiWo/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/TobiWo/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/TobiWo/subscriptions",
      "organizations_url": "https://api.github.com/users/TobiWo/orgs",
      "repos_url": "https://api.github.com/users/TobiWo/repos",
      "events_url": "https://api.github.com/users/TobiWo/events{/privacy}",
      "received_events_url": "https://api.github.com/users/TobiWo/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-28T08:30:12Z",
    "updated_at": "2022-08-28T09:04:34Z",
    "author_association": "NONE",
    "body": "@dapplion Sorry for the delay. I finally got rpc-snoop to work ðŸ˜ƒ (seems my first attempt wasn't successful) . \r\nThis is what I see in the logs of rpc-snoop when I connect the validator to the exposed port of rpc-snoop which forwards everything to the nimbus beacon client:\r\n```\r\nAug 28 08:26:39.294 2022 WARNING: request not formatted as JSON-RPC request [EOF while parsing a value at line 1 column 0]:\r\n```\r\n\r\nEdit: Mhh, I think there is still something going on in my setup with rpc-snoop as I just realized that the log I posted is a very general one and has nothing to do with the error I receive from the validator while I connect it directly to the nimbus beacon client. Sorry for the inconvenience.\r\n\r\nEdit2: Did you ever use rpc-snoop with a validator/beacon node combination because I would interpret that error as a consequence that the validator connects to the beacon node via REST and not via json-rpc. So the tool cannot work with a vc/bn combination.",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1229406768/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1234191835",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/4403#issuecomment-1234191835",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4403",
    "id": 1234191835,
    "node_id": "IC_kwDOCD5_Gc5JkEXb",
    "user": {
      "login": "dapplion",
      "id": 35266934,
      "node_id": "MDQ6VXNlcjM1MjY2OTM0",
      "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dapplion",
      "html_url": "https://github.com/dapplion",
      "followers_url": "https://api.github.com/users/dapplion/followers",
      "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
      "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
      "organizations_url": "https://api.github.com/users/dapplion/orgs",
      "repos_url": "https://api.github.com/users/dapplion/repos",
      "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dapplion/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-01T12:09:22Z",
    "updated_at": "2022-09-01T12:09:22Z",
    "author_association": "MEMBER",
    "body": "Oh you are right, sorry for pointing to the wrong tool. snooper doesn't seem to support paths. I've been researching but didn't find an alternative snooper that logged arbitrary REST calls.\r\n\r\nThere's an open PR https://github.com/ChainSafe/lodestar/pull/4493 to ensure programatically that Lodestar follows the OpenAPI spec for the beacon API. An inconsistency it found was that the body of `getAttesterDuties` and `getSyncCommitteeDuties` send an array of uint64 instead of an array of strings. If Nimbus parsing is very strict that would explain the error.",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1234191835/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
