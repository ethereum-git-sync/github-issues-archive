{
  "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4002",
  "repository_url": "https://api.github.com/repos/ChainSafe/lodestar",
  "labels_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4002/labels{/name}",
  "comments_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4002/comments",
  "events_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4002/events",
  "html_url": "https://github.com/ChainSafe/lodestar/issues/4002",
  "id": 1231165087,
  "node_id": "I_kwDOCD5_Gc5JYhaf",
  "number": 4002,
  "title": "Extreme I/O lag on overloaded nodes",
  "user": {
    "login": "dapplion",
    "id": 35266934,
    "node_id": "MDQ6VXNlcjM1MjY2OTM0",
    "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/dapplion",
    "html_url": "https://github.com/dapplion",
    "followers_url": "https://api.github.com/users/dapplion/followers",
    "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
    "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
    "organizations_url": "https://api.github.com/users/dapplion/orgs",
    "repos_url": "https://api.github.com/users/dapplion/repos",
    "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
    "received_events_url": "https://api.github.com/users/dapplion/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 2963898184,
      "node_id": "MDU6TGFiZWwyOTYzODk4MTg0",
      "url": "https://api.github.com/repos/ChainSafe/lodestar/labels/scope-performance",
      "name": "scope-performance",
      "color": "980043",
      "default": false,
      "description": "Performance issue and ideas to improve performance."
    },
    {
      "id": 3592888034,
      "node_id": "LA_kwDOCD5_Gc7WJx7i",
      "url": "https://api.github.com/repos/ChainSafe/lodestar/labels/Epic",
      "name": "Epic",
      "color": "4660F9",
      "default": false,
      "description": "Issues used as milestones and tracking multiple issues."
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "tuyennhv",
    "id": 10568965,
    "node_id": "MDQ6VXNlcjEwNTY4OTY1",
    "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tuyennhv",
    "html_url": "https://github.com/tuyennhv",
    "followers_url": "https://api.github.com/users/tuyennhv/followers",
    "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
    "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
    "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
    "repos_url": "https://api.github.com/users/tuyennhv/repos",
    "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "tuyennhv",
      "id": 10568965,
      "node_id": "MDQ6VXNlcjEwNTY4OTY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tuyennhv",
      "html_url": "https://github.com/tuyennhv",
      "followers_url": "https://api.github.com/users/tuyennhv/followers",
      "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
      "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
      "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
      "repos_url": "https://api.github.com/users/tuyennhv/repos",
      "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2022-05-10T13:29:14Z",
  "updated_at": "2023-10-19T13:13:46Z",
  "closed_at": "2023-10-19T13:13:45Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "NodeJS due to its single threaded nature experiences exponential degradation of performance under heavy load. We have circumstantial evidence that in low power machines, when attempting to run too many keys performance suffers. Overall time to perform tasks increases, but any network call (vc call beacon api) time increases by x10, x100 respective to internal function times (block processing)\r\n\r\nBy running large amounts of keys on not shitty servers the issue is not apparent. However this issue still poses a future risk\r\n- for solo stakers attempting to run Lodestar in under-powered machines\r\n- post-merge due to extra calls to EL and mev-boost on time critical code paths\r\n\r\n**Step 1: quantify**\r\n\r\nCircumstantial evidence is not enough, we need proper documented metrics on when this issue manifest and how bad it is. We will run Lodestar in different configurations and different servers:\r\n\r\nValidator configurations:\r\n- beacon 1 validator\r\n- beacon 1 validator --subscribeAllSubnets\r\n- beacon + 8 validators\r\n- beacon + 16 validators\r\n- beacon + 32 validators\r\n- beacon + 64 validators\r\n\r\nServers:\r\n- Contabo Cloud VPS S\r\n- Contabo Cloud VPS M\r\n- Hetzner cloud CX41\r\n\r\nData to collect:\r\n- Validator request times histogram `vc_rest_api_client_request_time_seconds_bucket{routeId=\"produceAttestationData\"}`. Average, median, p95, p99.\r\n\r\n**Step 2: reproduce**\r\n\r\nIf the data above proves that this issue of sufficient severity we need to have a reproducible simple case to collect help and potential solutions. A reproducible case must be:\r\n- Standalone repo\r\n- Contain no Lodestar specific code, nor any library at all, pure vanilla NodeJS code \r\n- Create similar conditions to which Lodestar experiences: very high load caused by many short async tasks\r\n- Show that requests times by an external caller (in a separate process) show a similar pattern to the data collected in step 1\r\n\r\n**Step 3: mitigate**\r\n\r\n> Disclaimer: The root solution here is to reduce Lodestar load via optimizations of offloading to workers.\r\n\r\nProvided that a Lodestar is under heavy load we want to minimize this I/O lag to acceptable levels, such that validator performance doesn't degrade. If an VC request time increases from 50ms to 500ms, it's tolerable. However if it increases from 50ms to 5000ms, the validator may miss an attestation and reduce profitability.\r\n\r\n**Related issues**\r\n\r\nMay be the cause of this issues:\r\n\r\n- https://github.com/ChainSafe/lodestar/issues/3110\r\n- https://github.com/ChainSafe/lodestar/issues/3442\r\n- https://github.com/ChainSafe/lodestar/issues/3584\r\n- https://github.com/ChainSafe/lodestar/issues/3694\r\n- https://github.com/ChainSafe/lodestar/issues/4009",
  "closed_by": {
    "login": "tuyennhv",
    "id": 10568965,
    "node_id": "MDQ6VXNlcjEwNTY4OTY1",
    "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tuyennhv",
    "html_url": "https://github.com/tuyennhv",
    "followers_url": "https://api.github.com/users/tuyennhv/followers",
    "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
    "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
    "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
    "repos_url": "https://api.github.com/users/tuyennhv/repos",
    "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4002/reactions",
    "total_count": 1,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 1
  },
  "timeline_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4002/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1133859545",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/4002#issuecomment-1133859545",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4002",
    "id": 1133859545,
    "node_id": "IC_kwDOCD5_Gc5DlVLZ",
    "user": {
      "login": "tuyennhv",
      "id": 10568965,
      "node_id": "MDQ6VXNlcjEwNTY4OTY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tuyennhv",
      "html_url": "https://github.com/tuyennhv",
      "followers_url": "https://api.github.com/users/tuyennhv/followers",
      "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
      "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
      "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
      "repos_url": "https://api.github.com/users/tuyennhv/repos",
      "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-22T09:53:14Z",
    "updated_at": "2022-05-27T08:45:19Z",
    "author_association": "CONTRIBUTOR",
    "body": "## Contabo machines \r\n\r\n```\r\n- Network: Prater\r\n- Slot range: 4 days until [3078725](https://www.beaconcha.in/block/3078725)\r\n- Machine: Contabo - S\r\n- Run config: systemd\r\n- Lodestar version: v0.36.0\r\n```\r\n\r\n|#|Avg (12h)|Median (12h)|p95 (12h)|p99 (12h)|% > 1s|% > 5s|\r\n|-|----|-------|----|----|----|------------------------------|\r\n|Node with 1 validator|100ms - 200ms|48ms-63ms|600ms to 3s|3.5s - 5s|2% - 9%|0% - 3%|\r\n|Node with 1 validator + subscribeAllSubnets|1.8s - 2.4s|890ms - 1.7s|5s|5s|46% - 57%|7% - 19%|\r\n|Node with 8 validators|130ms - 174ms|80ms - 110ms|923ms - 940ms|2s - 3.2s|1.2% - 2%|0% - 0.25%|\r\n|Node with 16 validators|190ms - 330ms|190ms - 330ms|900ms - 1s|1.4s - 4s|1.1% - 4%|0% - 0.6%|\r\n|Node with 32 validators|320ms - 500ms|300ms - 450ms|3s - 3.5s|4.8s-5s|4.7% - 11%|0.7% - 1.5%|\r\n|Node with 64 validators|0.6s - 1.9s|0.4s - 1.3s|4s - 5s|5s|13% - 53%|2% - 11%|\r\n\r\nThere is huge difference between a regular beacon node of 1 validator and one with 1 validator and `subscribeAllSubnets` (which is equivalent to 64 validators)\r\n\r\n---\r\n\r\n```\r\n- Network: Prater\r\n- Slot range: 2 days until [3093675](https://www.beaconcha.in/block/3093675)\r\n- Machine: Contabo - S\r\n- Run config: systemd\r\n- Lodestar version: v0.37.0.beta.0\r\n```\r\n\r\n|#|Avg (12h)|Median (12h)|p95 (12h)|p99 (12h)|% > 1s|% > 5s|\r\n|-|----|-------|----|----|----|------------------------------|\r\n|Node with 1 validator|100ms - 380ms|40ms - 64ms|600ms - 1.6s|3.5s - 5s|2.6% - 5.4%|0% - 2.7%|\r\n|Node with 1 validator + subscribeAllSubnets|850ms|550ms|4.4s|5s|28%|0.9%|\r\n|Node with 8 validators|140ms - 160ms|60ms - 65ms|900ms - 920ms |3s - 3.5s|2% - 2.5%|0% - 0.13%|\r\n|Node with 16 validators|180ms - 400ms|90ms - 350ms|1s - 2s|5s|2% - 6%|0% - 1.4%|\r\n|Node with 32 validators|370ms - 660ms|200ms - 460ms|2.5s - 4.4s|5s|7.4% - 17.8%|0.9% - 2.4%|\r\n|Node with 64 validators|220ms - 570ms|80ms - 280ms|990ms - 4.1s|5s|3.8% - 15.8%|0.8% - 2.3%|\r\n\r\n---\r\n\r\n## Hetzner machines \r\n\r\n```\r\n- Network: Prater\r\n- Slot range: 2.5 days until [3094125](https://www.beaconcha.in/block/3094125)\r\n- Machine: Hetzner\r\n- Run config: Docker\r\n- Lodestar version: v0.36.0\r\n```\r\n\r\n|#|Avg (12h)|Median (12h)|p95 (12h)|p99 (12h)|% > 1s|% > 5s|\r\n|-|----|-------|----|----|----|------------------------------|\r\n|Node with 916 validators|13ms - 20ms|8.3ms - 10ms|89ms - 93ms|100ms - 170ms|0% - 0.4%|0%|\r\n\r\n---\r\n```\r\n- Network: Prater\r\n- Slot range: 2.5 days until [3094125](https://www.beaconcha.in/block/3094125)\r\n- Machine: Hetzner\r\n- Run config: Docker\r\n- Lodestar version: v0.37.0.beta.0\r\n```\r\n\r\n|#|Avg (12h)|Median (12h)|p95 (12h)|p99 (12h)|% > 1s|% > 5s|\r\n|-|----|-------|----|----|----|------------------------------|\r\n|Node with 918 validators|13ms - 17ms|6.5 - 7.1ms|87ms - 92ms|560ms - 730ms|0.14% - 0.25%|0%|",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1133859545/reactions",
      "total_count": 3,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 1,
      "rocket": 0,
      "eyes": 1
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1138501437",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/4002#issuecomment-1138501437",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4002",
    "id": 1138501437,
    "node_id": "IC_kwDOCD5_Gc5D3Cc9",
    "user": {
      "login": "tuyennhv",
      "id": 10568965,
      "node_id": "MDQ6VXNlcjEwNTY4OTY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tuyennhv",
      "html_url": "https://github.com/tuyennhv",
      "followers_url": "https://api.github.com/users/tuyennhv/followers",
      "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
      "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
      "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
      "repos_url": "https://api.github.com/users/tuyennhv/repos",
      "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-26T12:12:44Z",
    "updated_at": "2022-05-26T14:19:55Z",
    "author_association": "CONTRIBUTOR",
    "body": "| Metric name | Query |\r\n| ------------ | ---------- |\r\n|Avg|rate(vc_rest_api_client_request_time_seconds_sum{routeId=\"produceAttestationData\"}[12h]) / rate(vc_rest_api_client_request_time_seconds_count{routeId=\"produceAttestationData\"}[12h])|\r\n|Median|histogram_quantile(0.5, sum(rate(vc_rest_api_client_request_time_seconds_bucket{routeId=\"produceAttestationData\"}[12h])) by (le))|\r\n|p95|histogram_quantile(0.95, sum(rate(vc_rest_api_client_request_time_seconds_bucket{routeId=\"produceAttestationData\"}[12h])) by (le))|\r\n|p99|histogram_quantile(0.99, sum(rate(vc_rest_api_client_request_time_seconds_bucket{routeId=\"produceAttestationData\"}[12h])) by (le))\r\n|% > 1s|1 - (sum(rate(vc_rest_api_client_request_time_seconds_bucket{le=\"1\", routeId=\"produceAttestationData\"}[12h])) by (job) / sum(rate(vc_rest_api_client_request_time_seconds_count{routeId=\"produceAttestationData\"}[12h])) by (job))|\r\n|% > 5s|1 - (sum(rate(vc_rest_api_client_request_time_seconds_bucket{le=\"5\", routeId=\"produceAttestationData\"}[12h])) by (job) / sum(rate(vc_rest_api_client_request_time_seconds_count{routeId=\"produceAttestationData\"}[12h])) by (job))|",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1138501437/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1164169186",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/4002#issuecomment-1164169186",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4002",
    "id": 1164169186,
    "node_id": "IC_kwDOCD5_Gc5FY8_i",
    "user": {
      "login": "tuyennhv",
      "id": 10568965,
      "node_id": "MDQ6VXNlcjEwNTY4OTY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tuyennhv",
      "html_url": "https://github.com/tuyennhv",
      "followers_url": "https://api.github.com/users/tuyennhv/followers",
      "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
      "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
      "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
      "repos_url": "https://api.github.com/users/tuyennhv/repos",
      "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-06-23T09:24:17Z",
    "updated_at": "2022-06-23T09:24:17Z",
    "author_association": "CONTRIBUTOR",
    "body": "Right now we use sync apis in some places which block the event loop\r\n\r\n- Uncompress gossipsub messages, see https://github.com/ChainSafe/lodestar/issues/4170\r\n- Encrypt/decrypt libp2p connection in libp2p-noise, see https://github.com/ChainSafe/lodestar/issues/4140\r\n- gossipsub heartbeat, need to follow its performance https://github.com/ChainSafe/js-libp2p-gossipsub/issues/256",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1164169186/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1770965327",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/4002#issuecomment-1770965327",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4002",
    "id": 1770965327,
    "node_id": "IC_kwDOCD5_Gc5pjslP",
    "user": {
      "login": "tuyennhv",
      "id": 10568965,
      "node_id": "MDQ6VXNlcjEwNTY4OTY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tuyennhv",
      "html_url": "https://github.com/tuyennhv",
      "followers_url": "https://api.github.com/users/tuyennhv/followers",
      "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
      "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
      "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
      "repos_url": "https://api.github.com/users/tuyennhv/repos",
      "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-10-19T13:13:46Z",
    "updated_at": "2023-10-19T13:13:46Z",
    "author_association": "CONTRIBUTOR",
    "body": "As of Oct 2023, we already implemented network thread and batch attestation validation so this is not an issue anymore",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1770965327/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
