{
  "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3039",
  "repository_url": "https://api.github.com/repos/ChainSafe/lodestar",
  "labels_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3039/labels{/name}",
  "comments_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3039/comments",
  "events_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3039/events",
  "html_url": "https://github.com/ChainSafe/lodestar/issues/3039",
  "id": 983031422,
  "node_id": "MDU6SXNzdWU5ODMwMzE0MjI=",
  "number": 3039,
  "title": "Don't store full pubkey in pubkey2index map",
  "user": {
    "login": "dapplion",
    "id": 35266934,
    "node_id": "MDQ6VXNlcjM1MjY2OTM0",
    "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/dapplion",
    "html_url": "https://github.com/dapplion",
    "followers_url": "https://api.github.com/users/dapplion/followers",
    "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
    "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
    "organizations_url": "https://api.github.com/users/dapplion/orgs",
    "repos_url": "https://api.github.com/users/dapplion/repos",
    "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
    "received_events_url": "https://api.github.com/users/dapplion/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1200090453,
      "node_id": "MDU6TGFiZWwxMjAwMDkwNDUz",
      "url": "https://api.github.com/repos/ChainSafe/lodestar/labels/prio-low",
      "name": "prio-low",
      "color": "fde2b4",
      "default": false,
      "description": "This is nice to have."
    },
    {
      "id": 3172006584,
      "node_id": "MDU6TGFiZWwzMTcyMDA2NTg0",
      "url": "https://api.github.com/repos/ChainSafe/lodestar/labels/scope-memory",
      "name": "scope-memory",
      "color": "980043",
      "default": false,
      "description": "Issues to reduce and improve memory usage."
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2021-08-30T17:31:24Z",
  "updated_at": "2022-02-04T12:11:00Z",
  "closed_at": null,
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "<!--NOTE: -->\r\n<!--- General questions should go to the discord chat instead of the issue tracker.-->\r\n\r\n**Describe the feature**\r\n\r\nWe don't need to store the full pubkey since the collision probability is low enough with just a few bytes. Note that ethereum addresses use 20 bytes only.\r\n\r\nCheck a safe minimum byte count and create a map that can extend the size of the key if it detects a collision. Keep an array of key bytes, starting at [10] for example, and if there's a collision extend to [11] and write new keys with 11 bytes. Then to check slice to 11 check, slice to 10 check.",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3039/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3039/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/914180629",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/3039#issuecomment-914180629",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3039",
    "id": 914180629,
    "node_id": "IC_kwDOCD5_Gc42fUoV",
    "user": {
      "login": "dapplion",
      "id": 35266934,
      "node_id": "MDQ6VXNlcjM1MjY2OTM0",
      "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dapplion",
      "html_url": "https://github.com/dapplion",
      "followers_url": "https://api.github.com/users/dapplion/followers",
      "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
      "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
      "organizations_url": "https://api.github.com/users/dapplion/orgs",
      "repos_url": "https://api.github.com/users/dapplion/repos",
      "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dapplion/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-09-07T10:16:23Z",
    "updated_at": "2021-09-07T10:16:23Z",
    "author_association": "MEMBER",
    "body": "pubkey2index map is retaining 320MB in Prater (220_000 validators) which averages 1454 bytes per pubkey :exploding_head: \r\n\r\n![Screenshot from 2021-09-07 12-15-05](https://user-images.githubusercontent.com/35266934/132328103-4151715e-72f0-4248-ac57-cc1563307cf2.png)\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/914180629/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1001650858",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/3039#issuecomment-1001650858",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3039",
    "id": 1001650858,
    "node_id": "IC_kwDOCD5_Gc47s_qq",
    "user": {
      "login": "dapplion",
      "id": 35266934,
      "node_id": "MDQ6VXNlcjM1MjY2OTM0",
      "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dapplion",
      "html_url": "https://github.com/dapplion",
      "followers_url": "https://api.github.com/users/dapplion/followers",
      "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
      "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
      "organizations_url": "https://api.github.com/users/dapplion/orgs",
      "repos_url": "https://api.github.com/users/dapplion/repos",
      "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dapplion/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-12-27T16:44:23Z",
    "updated_at": "2021-12-27T16:44:23Z",
    "author_association": "MEMBER",
    "body": "Proposal:\r\n\r\n- Use only the first N bytes of the pubkey (i.e. 4) and encoded as `base64url` to have a very short key. Use `base64url` since it has no padding and saves 2 characters\r\n- The Map value will be an array of indices that start with that pubkey prefix.\r\n\r\nSince the goal of this Map is to speed up lookup by pubkeys narrowing down from 250_000 to ~10 instead of 1 is good enough.\r\n\r\nAnalysis of probabilities should pick an appropriate byte length. Also must check that BLS pubkeys have a sufficient random distribution of the first N bytes.",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1001650858/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1004102509",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/3039#issuecomment-1004102509",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3039",
    "id": 1004102509,
    "node_id": "IC_kwDOCD5_Gc472WNt",
    "user": {
      "login": "dapplion",
      "id": 35266934,
      "node_id": "MDQ6VXNlcjM1MjY2OTM0",
      "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dapplion",
      "html_url": "https://github.com/dapplion",
      "followers_url": "https://api.github.com/users/dapplion/followers",
      "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
      "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
      "organizations_url": "https://api.github.com/users/dapplion/orgs",
      "repos_url": "https://api.github.com/users/dapplion/repos",
      "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dapplion/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-01-03T13:45:18Z",
    "updated_at": "2022-01-03T13:45:18Z",
    "author_association": "MEMBER",
    "body": "After doing some research today:\r\n\r\n- The bulk of the memory usage is cause by this awful concatenated strings. With https://github.com/ChainSafe/lodestar/pull/3561 the memory usage of the map is reduced by 10x from 350MB to 35MB.\r\n\r\n- With non-concatenated strings, using less bytes has marginal benefits being able to reduce 2.5x extra. However that's an absolute reduction of ~19MB for the entire application so not a lot. Also, using shorter keys adds non-trivial complexity to ensure keys are not known. To do that indexed sync committees MUST not rely of the pubkey2index map but for the first indexation.\r\n\r\n- Using hex, base64 or base64url has not effect of the total memory usage of the Map\r\n\r\nWIP branch: https://github.com/ChainSafe/lodestar/tree/dapplion/pubkey2index-short-key",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1004102509/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1029931430",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/3039#issuecomment-1029931430",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3039",
    "id": 1029931430,
    "node_id": "IC_kwDOCD5_Gc49Y4Gm",
    "user": {
      "login": "dapplion",
      "id": 35266934,
      "node_id": "MDQ6VXNlcjM1MjY2OTM0",
      "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dapplion",
      "html_url": "https://github.com/dapplion",
      "followers_url": "https://api.github.com/users/dapplion/followers",
      "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
      "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
      "organizations_url": "https://api.github.com/users/dapplion/orgs",
      "repos_url": "https://api.github.com/users/dapplion/repos",
      "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dapplion/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-02-04T12:11:00Z",
    "updated_at": "2022-02-04T12:11:00Z",
    "author_association": "MEMBER",
    "body": "The real cause of the memory inefficiency is the concatenated strings as shown here https://github.com/ChainSafe/lodestar/issues/3446\r\n\r\nThe current size of the Pubkey2Index map is 45.5MB for 275496 validators. We could consider reducing the pubkey length but now it's not that prioritary\r\n\r\n![Screenshot from 2022-02-04 17-33-07](https://user-images.githubusercontent.com/35266934/152526839-035d9829-f71f-43cb-91c5-425ec6b6cf99.png)\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1029931430/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
