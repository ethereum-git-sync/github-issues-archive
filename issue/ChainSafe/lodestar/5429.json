{
  "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5429",
  "repository_url": "https://api.github.com/repos/ChainSafe/lodestar",
  "labels_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5429/labels{/name}",
  "comments_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5429/comments",
  "events_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5429/events",
  "html_url": "https://github.com/ChainSafe/lodestar/issues/5429",
  "id": 1687761219,
  "node_id": "I_kwDOCD5_Gc5kmTFD",
  "number": 5429,
  "title": "Investigate high execution payload verification time",
  "user": {
    "login": "tuyennhv",
    "id": 10568965,
    "node_id": "MDQ6VXNlcjEwNTY4OTY1",
    "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tuyennhv",
    "html_url": "https://github.com/tuyennhv",
    "followers_url": "https://api.github.com/users/tuyennhv/followers",
    "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
    "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
    "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
    "repos_url": "https://api.github.com/users/tuyennhv/repos",
    "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 2155825090,
      "node_id": "MDU6TGFiZWwyMTU1ODI1MDkw",
      "url": "https://api.github.com/repos/ChainSafe/lodestar/labels/scope-networking",
      "name": "scope-networking",
      "color": "980043",
      "default": false,
      "description": "All issues related to networking, gossip, and libp2p."
    },
    {
      "id": 2963898184,
      "node_id": "MDU6TGFiZWwyOTYzODk4MTg0",
      "url": "https://api.github.com/repos/ChainSafe/lodestar/labels/scope-performance",
      "name": "scope-performance",
      "color": "980043",
      "default": false,
      "description": "Performance issue and ideas to improve performance."
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2023-04-28T01:44:09Z",
  "updated_at": "2023-05-01T04:18:08Z",
  "closed_at": null,
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "**Describe the bug**\r\n\r\nSometimes it takes significant time to verify execution engine payload on test mainnet nodes\r\n\r\n<img width=\"1309\" alt=\"Screenshot 2023-04-28 at 08 41 45\" src=\"https://user-images.githubusercontent.com/10568965/235034066-4cc06ca7-ba56-4582-a671-3e51d234ad05.png\">\r\n\r\nSome logs:\r\n\r\n```\r\n1143794:Apr-26 23:46:31.425[chain]         verbose: Verified execution payload slot=6310730, recvToVerifiedExecPayload=6.816999912261963\r\nApr-26 23:48:05.877[chain]         verbose: Verified execution payload slot=6310738, recvToVerifiedExecPayload=5.330000162124634\r\n```\r\nit's likely lodestar is busy at that time, not the execution layer's issue\r\n\r\n**Expected behavior**\r\n- <0.5s consistently\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5429/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5429/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1526964180",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/5429#issuecomment-1526964180",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5429",
    "id": 1526964180,
    "node_id": "IC_kwDOCD5_Gc5bA5_U",
    "user": {
      "login": "tuyennhv",
      "id": 10568965,
      "node_id": "MDQ6VXNlcjEwNTY4OTY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tuyennhv",
      "html_url": "https://github.com/tuyennhv",
      "followers_url": "https://api.github.com/users/tuyennhv/followers",
      "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
      "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
      "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
      "repos_url": "https://api.github.com/users/tuyennhv/repos",
      "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-28T04:16:08Z",
    "updated_at": "2023-04-30T08:55:40Z",
    "author_association": "CONTRIBUTOR",
    "body": "was able to take a profile of this block\r\n\r\n```\r\nApr-28 02:37:16.797[chain]         verbose: Verified execution payload slot=6318784, recvToVerifiedExecPayload=1.9059998989105225\r\n```\r\n\r\nfull log:\r\n```\r\nbeacon-2023-04-29.log:292138:Apr-29 05:07:50.846[chain]         verbose: Verified execution payload slot=6326737, recvToVerifiedExecPayload=1.9059998989105225\r\ndevops@feat1-mainnet-hzax41:~/beacon$ grep -e \"6326737\" -rn beacon-2023-04-29.log\r\n292041:Apr-29 05:07:43.367[chain]         verbose: Running prepareForNextSlot nextEpoch=197711, prepareSlot=6326737, headSlot=6326736, headRoot=0xadaca0a5724a5ccca2d7cbd56277c2ab7a5e24d1ec510bc54a8710a6f7166902, isEpochTransition=false\r\n292108:Apr-29 05:07:47.000[chain]         verbose: Clock slot slot=6326737\r\n292129:Apr-29 05:07:48.961[network]       verbose: Received gossip block slot=6326737, root=0x6510…54a5, curentSlot=6326737, peerId=16Uiu2HAmVCyDPHdUYYv9mMY2Z2DDCm2WVRd1PBK5nc4i4F5y6P4K, delaySec=1.940000057220459, recvToVal=0.020999908447265625\r\n292130:Apr-29 05:07:49.301[chain]         verbose: Transitioned gossip block slot=6326737, recvToTransition=0.36100006103515625\r\n292131:Apr-29 05:07:49.336[chain]         verbose: Verified block signatures slot=6326737, recvToSigVer=0.3959999084472656\r\n292138:Apr-29 05:07:50.846[chain]         verbose: Verified execution payload slot=6326737, recvToVerifiedExecPayload=1.9059998989105225\r\n292142:Apr-29 05:07:50.933[chain]           debug: Persisted block to hot DB slot=6326737, root=0x651026bba0f87a45e2efa95534f75c7c0aaa6b8d4f196d438529461a5f4954a5\r\n292143:Apr-29 05:07:50.934[chain]         verbose: Added block to forkchoice and state cache slot=6326737, root=0x651026bba0f87a45e2efa95534f75c7c0aaa6b8d4f196d438529461a5f4954a5\r\n292144:Apr-29 05:07:51.149[chain]         verbose: New chain head slot=6326737, root=0x651026bba0f87a45e2efa95534f75c7c0aaa6b8d4f196d438529461a5f4954a5, delaySec=4.148999929428101\r\n292145:Apr-29 05:07:51.169[chain]         verbose: Imported block slot=6326737, recvToImportedBlock=2.2289998531341553\r\n292146:Apr-29 05:07:51.169[chain]         verbose: Block processed slot=6326737, root=0x651026bba0f87a45e2efa95534f75c7c0aaa6b8d4f196d438529461a5f4954a5, delaySec=4.168999910354614\r\n292149:Apr-29 05:07:53.279[]                 info: Synced - slot: 6326737 - head: 0x6510…54a5 - exec-block: valid(17149575 0x12e8…) - finalized: 0x6793…4739:197708 - peers: 55\r\n292209:Apr-29 05:07:55.175[chain]         verbose: Running prepareForNextSlot nextEpoch=197711, prepareSlot=6326738, headSlot=6326737, headRoot=0x651026bba0f87a45e2efa95534f75c7c0aaa6b8d4f196d438529461a5f4954a5, isEpochTransition=false\r\n```\r\n\r\n\r\n[0428_mainnet_node_IO_lag.cpuprofile.zip](https://github.com/ChainSafe/lodestar/files/11349676/0428_mainnet_node_IO_lag.cpuprofile.zip)\r\n\r\n1. at 32490ms, start `verifyBlocksExecutionPayload`\r\n2. at 32500, it runs `verifyBlocksStateTransitionOnly` and finish in around 32700\r\n3. at 34377ms, process response from `verifyBlocksExecutionPayload`\r\n4. at 34378ms, it adds block to db\r\n5. at 37396ms, it processes state to add checkpoint balance cache (just next command to (note that `this.checkpointBalancesCache.processState` is just next to `this.db.block.add` in our code)\r\n\r\nThere are a lot of time between the gaps (2 to 3, 4 to 5) it just do network I/O tasks:\r\n- handleReceivedRpc\r\n- handleReceivedMessage\r\n- chacha20Poly1305Decrypt\r\n![Screenshot 2023-04-28 at 11 15 49](https://user-images.githubusercontent.com/10568965/235052788-f81f35c3-526e-4c96-9788-88004a17ca72.png)\r\n\r\n\r\n==> the I/O lag seems to be not at lodestar side but at lower network stack libraries (that's why it happens in v1.7.2 too)",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1526964180/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1529332448",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/5429#issuecomment-1529332448",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5429",
    "id": 1529332448,
    "node_id": "IC_kwDOCD5_Gc5bJ8Lg",
    "user": {
      "login": "tuyennhv",
      "id": 10568965,
      "node_id": "MDQ6VXNlcjEwNTY4OTY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tuyennhv",
      "html_url": "https://github.com/tuyennhv",
      "followers_url": "https://api.github.com/users/tuyennhv/followers",
      "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
      "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
      "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
      "repos_url": "https://api.github.com/users/tuyennhv/repos",
      "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-01T04:18:08Z",
    "updated_at": "2023-05-01T04:18:08Z",
    "author_association": "CONTRIBUTOR",
    "body": "we can't control `chacha20Poly1305Decrypt` in lodestar, however we can control `handleReceivedMessage` like in #5413: if we get a gossip block, we can put `handleReceivedMessage` in a lodestar queue to control concurrent messages at the same and yield more to event loop, until the block is processed\r\n\r\nI have a branch to always put `handleReceivedMessage` in lodestar queue, it make lodestar has low number of subnet mesh peers because we don't process them fast enough, we only want to do it in a short window within the first 1/3 of slot",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1529332448/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
