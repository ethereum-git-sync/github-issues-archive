{
  "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2792",
  "repository_url": "https://api.github.com/repos/ChainSafe/lodestar",
  "labels_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2792/labels{/name}",
  "comments_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2792/comments",
  "events_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2792/events",
  "html_url": "https://github.com/ChainSafe/lodestar/issues/2792",
  "id": 935943872,
  "node_id": "MDU6SXNzdWU5MzU5NDM4NzI=",
  "number": 2792,
  "title": "Voluntary exit fails when validator client is already running",
  "user": {
    "login": "yorickdowne",
    "id": 71337066,
    "node_id": "MDQ6VXNlcjcxMzM3MDY2",
    "avatar_url": "https://avatars.githubusercontent.com/u/71337066?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/yorickdowne",
    "html_url": "https://github.com/yorickdowne",
    "followers_url": "https://api.github.com/users/yorickdowne/followers",
    "following_url": "https://api.github.com/users/yorickdowne/following{/other_user}",
    "gists_url": "https://api.github.com/users/yorickdowne/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/yorickdowne/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/yorickdowne/subscriptions",
    "organizations_url": "https://api.github.com/users/yorickdowne/orgs",
    "repos_url": "https://api.github.com/users/yorickdowne/repos",
    "events_url": "https://api.github.com/users/yorickdowne/events{/privacy}",
    "received_events_url": "https://api.github.com/users/yorickdowne/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1200090446,
      "node_id": "MDU6TGFiZWwxMjAwMDkwNDQ2",
      "url": "https://api.github.com/repos/ChainSafe/lodestar/labels/prio-medium",
      "name": "prio-medium",
      "color": "fdc09f",
      "default": false,
      "description": "Resolve this some time soon (tm)."
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2021-07-02T17:19:02Z",
  "updated_at": "2022-05-10T08:54:32Z",
  "closed_at": "2022-05-10T08:54:32Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "**Describe the bug**\r\n\r\nVoluntary exit fails when validator client is already running because of existing lockfile. Example:\r\n\r\n```\r\nyorick@ethlinux:~/eth-docker-devel$ docker-compose run --rm validator-exit\r\n? Which validator do you want to voluntarily exit from the network? 0xad621fc2267c4cbf4ad774c3a86c372ff73473a309e3d71c0f56a7485188ccd4ea75b2f434afbde958d8486d448f5d6c\r\n? Are you sure you want to permantently exit validator 0xad621fc2267c4cbf4ad774c3a86c372ff73473a309e3d71c0f56a7485188ccd4ea75b2f434afbde958d8486d448f5d6c from the prater network?\r\n\r\nWARNING: THIS CANNOT BE UNDONE.\r\n\r\nONCE YOU VOLUNTARILY EXIT, YOU WILL NOT BE ABLE TO WITHDRAW\r\nYOUR DEPOSIT UNTIL PHASE 2 IS LAUNCHED WHICH MAY NOT\r\nBE UNTIL AT LEAST TWO YEARS AFTER THE PHASE 0 MAINNET LAUNCH.\r\n\r\n YES\r\nInitiating voluntary exit for validator 0xad621fc2267c4cbf4ad774c3a86c372ff73473a309e3d71c0f56a7485188ccd4ea75b2f434afbde958d8486d448f5d6c\r\n âœ– Error: EEXIST: file already exists, open '/var/lib/lodestar/validators/keystores/0xad621fc2267c4cbf4ad774c3a86c372ff73473a309e3d71c0f56a7485188ccd4ea75b2f434afbde958d8486d448f5d6c/.lock'\r\n```\r\n\r\n**Expected behavior**\r\n\r\nGiven that a validator needs to continue validating until it has fully exited, being able to submit an exit while the validator client is running is the expected workflow. This is also how the \"other four\" clients work.\r\n\r\n**Steps to Reproduce**\r\n\r\nRun validator client with the following parameters:\r\n\r\n```\r\n    entrypoint:\r\n      - node\r\n      - --max-old-space-size=8192\r\n      - /usr/app/node_modules/.bin/lodestar\r\n      - validator\r\n      - --rootDir\r\n      - /var/lib/lodestar/validators\r\n      - --server\r\n      - http://consensus:9596\r\n      - --graffiti\r\n      - ${GRAFFITI}\r\n      - --logLevel\r\n      - ${LOG_LEVEL}\r\n      - --network\r\n      - ${NETWORK}\r\n```\r\n\r\nThen run a voluntary exit with these parameters:\r\n\r\n```\r\n    entrypoint:\r\n      - node\r\n      - --max-old-space-size=8192\r\n      - /usr/app/node_modules/.bin/lodestar\r\n      - account\r\n      - validator\r\n      - voluntary-exit\r\n      - --rootDir\r\n      - /var/lib/lodestar/validators\r\n      - --server\r\n      - http://consensus:9596\r\n      -  --logLevel\r\n      - ${LOG_LEVEL}\r\n      - --network\r\n      - ${NETWORK}\r\n```\r\n\r\n**Desktop (please complete the following information):**\r\n\r\n- OS: Ubuntu 20.04 with docker\r\n- Version: version=0.25.1 master 88b23663\r\n",
  "closed_by": {
    "login": "dapplion",
    "id": 35266934,
    "node_id": "MDQ6VXNlcjM1MjY2OTM0",
    "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/dapplion",
    "html_url": "https://github.com/dapplion",
    "followers_url": "https://api.github.com/users/dapplion/followers",
    "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
    "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
    "organizations_url": "https://api.github.com/users/dapplion/orgs",
    "repos_url": "https://api.github.com/users/dapplion/repos",
    "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
    "received_events_url": "https://api.github.com/users/dapplion/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2792/reactions",
    "total_count": 1,
    "+1": 1,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2792/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1100640602",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/2792#issuecomment-1100640602",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2792",
    "id": 1100640602,
    "node_id": "IC_kwDOCD5_Gc5BmnFa",
    "user": {
      "login": "stale[bot]",
      "id": 26384082,
      "node_id": "MDM6Qm90MjYzODQwODI=",
      "avatar_url": "https://avatars.githubusercontent.com/in/1724?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/stale%5Bbot%5D",
      "html_url": "https://github.com/apps/stale",
      "followers_url": "https://api.github.com/users/stale%5Bbot%5D/followers",
      "following_url": "https://api.github.com/users/stale%5Bbot%5D/following{/other_user}",
      "gists_url": "https://api.github.com/users/stale%5Bbot%5D/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/stale%5Bbot%5D/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/stale%5Bbot%5D/subscriptions",
      "organizations_url": "https://api.github.com/users/stale%5Bbot%5D/orgs",
      "repos_url": "https://api.github.com/users/stale%5Bbot%5D/repos",
      "events_url": "https://api.github.com/users/stale%5Bbot%5D/events{/privacy}",
      "received_events_url": "https://api.github.com/users/stale%5Bbot%5D/received_events",
      "type": "Bot",
      "site_admin": false
    },
    "created_at": "2022-04-16T11:10:27Z",
    "updated_at": "2022-04-16T11:10:27Z",
    "author_association": "NONE",
    "body": "This issue has been automatically marked as stale because it has not had recent activity. It will be closed in 15 days if no further activity occurs. Thank you for your contributions.\n",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1100640602/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1100648069",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/2792#issuecomment-1100648069",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2792",
    "id": 1100648069,
    "node_id": "IC_kwDOCD5_Gc5Bmo6F",
    "user": {
      "login": "dapplion",
      "id": 35266934,
      "node_id": "MDQ6VXNlcjM1MjY2OTM0",
      "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dapplion",
      "html_url": "https://github.com/dapplion",
      "followers_url": "https://api.github.com/users/dapplion/followers",
      "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
      "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
      "organizations_url": "https://api.github.com/users/dapplion/orgs",
      "repos_url": "https://api.github.com/users/dapplion/repos",
      "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dapplion/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-04-16T11:56:48Z",
    "updated_at": "2022-04-16T11:56:48Z",
    "author_association": "MEMBER",
    "body": "This appears to still be an issue. When opening a keystore to sign a voluntary exit the .lock is not necessary because it can never be slashable offense. However, we must be very careful to only allow skipping the .lock functionality for this very specific purpose.",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1100648069/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1101770229",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/2792#issuecomment-1101770229",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2792",
    "id": 1101770229,
    "node_id": "IC_kwDOCD5_Gc5Bq631",
    "user": {
      "login": "dadepo",
      "id": 272535,
      "node_id": "MDQ6VXNlcjI3MjUzNQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/272535?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dadepo",
      "html_url": "https://github.com/dadepo",
      "followers_url": "https://api.github.com/users/dadepo/followers",
      "following_url": "https://api.github.com/users/dadepo/following{/other_user}",
      "gists_url": "https://api.github.com/users/dadepo/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dadepo/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dadepo/subscriptions",
      "organizations_url": "https://api.github.com/users/dadepo/orgs",
      "repos_url": "https://api.github.com/users/dadepo/repos",
      "events_url": "https://api.github.com/users/dadepo/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dadepo/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-04-18T21:09:29Z",
    "updated_at": "2022-04-18T21:09:29Z",
    "author_association": "CONTRIBUTOR",
    "body": "The `voluntary-exit` supports a `--force` flag that can be used to override the .lock file check. For example the following command will proceed to perform the voluntary exit\r\n\r\n```\r\naccount validator voluntary-exit --publicKey <key> --network prater --force true\r\n```\r\n\r\nI'll suggest minimal code change but just to extend the error message to mention the usage of --force flag",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1101770229/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
