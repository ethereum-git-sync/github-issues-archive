{
  "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5737",
  "repository_url": "https://api.github.com/repos/ChainSafe/lodestar",
  "labels_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5737/labels{/name}",
  "comments_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5737/comments",
  "events_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5737/events",
  "html_url": "https://github.com/ChainSafe/lodestar/issues/5737",
  "id": 1794565974,
  "node_id": "I_kwDOCD5_Gc5q9udW",
  "number": 5737,
  "title": "api: `consensusClient.debug.getStatev2` returns incorrect BeaconState object",
  "user": {
    "login": "ratankaliani",
    "id": 34041956,
    "node_id": "MDQ6VXNlcjM0MDQxOTU2",
    "avatar_url": "https://avatars.githubusercontent.com/u/34041956?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ratankaliani",
    "html_url": "https://github.com/ratankaliani",
    "followers_url": "https://api.github.com/users/ratankaliani/followers",
    "following_url": "https://api.github.com/users/ratankaliani/following{/other_user}",
    "gists_url": "https://api.github.com/users/ratankaliani/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ratankaliani/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ratankaliani/subscriptions",
    "organizations_url": "https://api.github.com/users/ratankaliani/orgs",
    "repos_url": "https://api.github.com/users/ratankaliani/repos",
    "events_url": "https://api.github.com/users/ratankaliani/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ratankaliani/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2023-07-08T00:28:31Z",
  "updated_at": "2023-07-10T05:21:42Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Describe the bug\r\n\r\nI'm currently working with the @lodestar/api package to retrieve `BeaconState` from a consensus node, but it is returning an incomplete `BeaconState` object for `capella` blocks. The objects are fairly large, so I haven't been able to determine which specific containers are malformed, but when I query my consensus node directly over JSON-RPC for the `/eth/v2/debug/beacon/states/{state_id}` endpoint, I get the correct `BeaconState` object.\r\n\r\nSpecifically, I am querying for `BeaconState` and `BeaconBlock` for slot 6491104 and getting the following response:\r\n\r\n```\r\nBeaconBlock root:  0x8326162ea811c76d3135e60d9f0a86805a0b9c756da9fb9d7268535f46810474\r\nBeaconState root:  0xa1dd17accf33890f0821570dde3c1a96beec5e722c108467e84c7182e5eadc99\r\nstateRoot container in BeaconBlock: 0xa92c974e16b3fb3a081db8beb8190f1e05daedac13b598c41ce0be4f86defa64\r\n```\r\n\r\nThe `BeaconState` root and `stateRoot` container in `BeaconBlock` should be equivalent for the same slot.\r\n\r\n### Expected behavior\r\n\r\nThe `stateRoot` container in `BeaconBlock` should match the root hash of the `BeaconState` container.\r\n\r\n### Steps to reproduce\r\n\r\n1. Query `BeaconState` using the @lodestar/api package with `consensusClient.debug.getStateV2(slot)`\r\n2. Query `BeaconBlock` using the @lodestar/api package with `consensusClient.beacon.getBlockV2(slot)`\r\n3. Check if `BeaconState` root hash == `stateRoot` container in `BeaconBlock`\r\n\r\n### Additional context\r\n\r\n_No response_\r\n\r\n### Operating system\r\n\r\nmacOS\r\n\r\n### Lodestar version or commit hash\r\n\r\nv1.9.1",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5737/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5737/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1627305176",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/5737#issuecomment-1627305176",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5737",
    "id": 1627305176,
    "node_id": "IC_kwDOCD5_Gc5g_rTY",
    "user": {
      "login": "nflaig",
      "id": 38436224,
      "node_id": "MDQ6VXNlcjM4NDM2MjI0",
      "avatar_url": "https://avatars.githubusercontent.com/u/38436224?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nflaig",
      "html_url": "https://github.com/nflaig",
      "followers_url": "https://api.github.com/users/nflaig/followers",
      "following_url": "https://api.github.com/users/nflaig/following{/other_user}",
      "gists_url": "https://api.github.com/users/nflaig/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nflaig/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nflaig/subscriptions",
      "organizations_url": "https://api.github.com/users/nflaig/orgs",
      "repos_url": "https://api.github.com/users/nflaig/repos",
      "events_url": "https://api.github.com/users/nflaig/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nflaig/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-08T13:53:36Z",
    "updated_at": "2023-07-08T13:53:36Z",
    "author_association": "MEMBER",
    "body": "Thanks for the detailed report.\r\n\r\nI tried to reproduce this but the result looks as expected for me\r\n\r\n```js\r\nimport { toHexString } from \"@chainsafe/ssz\";\r\nimport { getClient, ApiError } from \"@lodestar/api\";\r\nimport { config } from \"@lodestar/config/default\";\r\nimport { ssz } from \"@lodestar/types\";\r\n\r\nconst api = getClient({ baseUrl: \"http://localhost:9596\" }, { config });\r\nconst slot = process.argv[2];\r\n\r\nconst blockRes = await api.beacon.getBlockV2(slot);\r\nApiError.assert(blockRes);\r\n\r\nconst blockStateRoot = toHexString(blockRes.response.data.message.stateRoot);\r\nconsole.log(\"BeaconBlock stateRoot:    \", blockStateRoot);\r\n\r\nconst stateRes = await api.debug.getStateV2(slot);\r\nApiError.assert(stateRes);\r\n\r\nconst stateRoot = toHexString(ssz.capella.BeaconState.hashTreeRoot(stateRes.response.data));\r\nconsole.log(\"BeaconState hashTreeRoot: \", stateRoot);\r\n\r\nconsole.assert(stateRoot === blockStateRoot);\r\n```\r\n\r\n```sh\r\n> node index.js 6832476\r\nBeaconBlock stateRoot:     0xa80fa56b5f84f323e97eeb10b642190f2fb03b964eca38616e85e6c6e465bf26\r\nBeaconState hashTreeRoot:  0xa80fa56b5f84f323e97eeb10b642190f2fb03b964eca38616e85e6c6e465bf26\r\n\r\n> node index.js 6833329\r\nBeaconBlock stateRoot:     0xc6bf36c98decce99faf8c06a6491de3552daad8cc8f94f216bcd55a3be0ba4ee\r\nBeaconState hashTreeRoot:  0xc6bf36c98decce99faf8c06a6491de3552daad8cc8f94f216bcd55a3be0ba4ee\r\n\r\n> node index.js 6833350\r\nBeaconBlock stateRoot:     0xab26e7b7811b8c48e94edb0d4f2ab3e38969416c47f30b08dcd6a50c472790e4\r\nBeaconState hashTreeRoot:  0xab26e7b7811b8c48e94edb0d4f2ab3e38969416c47f30b08dcd6a50c472790e4\r\n```\r\n\r\nI have checked multiple slots and the results are always correct. Might be an issue with the data for specific slot 6491104 you checked.\r\n\r\nFrom where are you pulling the historic state and is it a Lodestar beacon node?",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1627305176/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1627437753",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/5737#issuecomment-1627437753",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5737",
    "id": 1627437753,
    "node_id": "IC_kwDOCD5_Gc5hALq5",
    "user": {
      "login": "ratankaliani",
      "id": 34041956,
      "node_id": "MDQ6VXNlcjM0MDQxOTU2",
      "avatar_url": "https://avatars.githubusercontent.com/u/34041956?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ratankaliani",
      "html_url": "https://github.com/ratankaliani",
      "followers_url": "https://api.github.com/users/ratankaliani/followers",
      "following_url": "https://api.github.com/users/ratankaliani/following{/other_user}",
      "gists_url": "https://api.github.com/users/ratankaliani/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ratankaliani/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ratankaliani/subscriptions",
      "organizations_url": "https://api.github.com/users/ratankaliani/orgs",
      "repos_url": "https://api.github.com/users/ratankaliani/repos",
      "events_url": "https://api.github.com/users/ratankaliani/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ratankaliani/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-08T17:41:13Z",
    "updated_at": "2023-07-08T17:43:11Z",
    "author_association": "NONE",
    "body": "I'm pulling the historical state from a Prysm beacon node, so the cross-compatibility here might be the issue. It's a bit odd, as when I query for the specific RPC URL, I get the correct `BeaconState`, so this is probably an issue with deserializing responses from different consensus node implementations using the `getStateV2` method.",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1627437753/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1627462304",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/5737#issuecomment-1627462304",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5737",
    "id": 1627462304,
    "node_id": "IC_kwDOCD5_Gc5hARqg",
    "user": {
      "login": "nflaig",
      "id": 38436224,
      "node_id": "MDQ6VXNlcjM4NDM2MjI0",
      "avatar_url": "https://avatars.githubusercontent.com/u/38436224?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nflaig",
      "html_url": "https://github.com/nflaig",
      "followers_url": "https://api.github.com/users/nflaig/followers",
      "following_url": "https://api.github.com/users/nflaig/following{/other_user}",
      "gists_url": "https://api.github.com/users/nflaig/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nflaig/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nflaig/subscriptions",
      "organizations_url": "https://api.github.com/users/nflaig/orgs",
      "repos_url": "https://api.github.com/users/nflaig/repos",
      "events_url": "https://api.github.com/users/nflaig/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nflaig/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-08T18:46:47Z",
    "updated_at": "2023-07-08T18:46:47Z",
    "author_association": "MEMBER",
    "body": "What `version` does Prysm return in `/eth/v2/debug/beacon/states/{state_id}` response?",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1627462304/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1628222846",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/5737#issuecomment-1628222846",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5737",
    "id": 1628222846,
    "node_id": "IC_kwDOCD5_Gc5hDLV-",
    "user": {
      "login": "ratankaliani",
      "id": 34041956,
      "node_id": "MDQ6VXNlcjM0MDQxOTU2",
      "avatar_url": "https://avatars.githubusercontent.com/u/34041956?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ratankaliani",
      "html_url": "https://github.com/ratankaliani",
      "followers_url": "https://api.github.com/users/ratankaliani/followers",
      "following_url": "https://api.github.com/users/ratankaliani/following{/other_user}",
      "gists_url": "https://api.github.com/users/ratankaliani/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ratankaliani/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ratankaliani/subscriptions",
      "organizations_url": "https://api.github.com/users/ratankaliani/orgs",
      "repos_url": "https://api.github.com/users/ratankaliani/repos",
      "events_url": "https://api.github.com/users/ratankaliani/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ratankaliani/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-10T05:21:42Z",
    "updated_at": "2023-07-10T05:21:42Z",
    "author_association": "NONE",
    "body": "I get `capella` so a bit confused.",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1628222846/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
