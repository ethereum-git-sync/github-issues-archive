{
  "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3866",
  "repository_url": "https://api.github.com/repos/ChainSafe/lodestar",
  "labels_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3866/labels{/name}",
  "comments_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3866/comments",
  "events_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3866/events",
  "html_url": "https://github.com/ChainSafe/lodestar/issues/3866",
  "id": 1176259238,
  "node_id": "I_kwDOCD5_Gc5GHEqm",
  "number": 3866,
  "title": "Potential memory leak in Bellatrix merge fork",
  "user": {
    "login": "philknows",
    "id": 58080811,
    "node_id": "MDQ6VXNlcjU4MDgwODEx",
    "avatar_url": "https://avatars.githubusercontent.com/u/58080811?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/philknows",
    "html_url": "https://github.com/philknows",
    "followers_url": "https://api.github.com/users/philknows/followers",
    "following_url": "https://api.github.com/users/philknows/following{/other_user}",
    "gists_url": "https://api.github.com/users/philknows/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/philknows/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/philknows/subscriptions",
    "organizations_url": "https://api.github.com/users/philknows/orgs",
    "repos_url": "https://api.github.com/users/philknows/repos",
    "events_url": "https://api.github.com/users/philknows/events{/privacy}",
    "received_events_url": "https://api.github.com/users/philknows/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1200090447,
      "node_id": "MDU6TGFiZWwxMjAwMDkwNDQ3",
      "url": "https://api.github.com/repos/ChainSafe/lodestar/labels/prio-high",
      "name": "prio-high",
      "color": "fd9579",
      "default": false,
      "description": "Resolve issues as soon as possible."
    },
    {
      "id": 3172006584,
      "node_id": "MDU6TGFiZWwzMTcyMDA2NTg0",
      "url": "https://api.github.com/repos/ChainSafe/lodestar/labels/scope-memory",
      "name": "scope-memory",
      "color": "980043",
      "default": false,
      "description": "Issues to reduce and improve memory usage."
    },
    {
      "id": 3352623099,
      "node_id": "MDU6TGFiZWwzMzUyNjIzMDk5",
      "url": "https://api.github.com/repos/ChainSafe/lodestar/labels/spec-bellatrix%20%F0%9F%90%BC",
      "name": "spec-bellatrix üêº",
      "color": "6baed6",
      "default": false,
      "description": "Issues targeting the merge spec version."
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "g11tech",
    "id": 76567250,
    "node_id": "MDQ6VXNlcjc2NTY3MjUw",
    "avatar_url": "https://avatars.githubusercontent.com/u/76567250?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/g11tech",
    "html_url": "https://github.com/g11tech",
    "followers_url": "https://api.github.com/users/g11tech/followers",
    "following_url": "https://api.github.com/users/g11tech/following{/other_user}",
    "gists_url": "https://api.github.com/users/g11tech/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/g11tech/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/g11tech/subscriptions",
    "organizations_url": "https://api.github.com/users/g11tech/orgs",
    "repos_url": "https://api.github.com/users/g11tech/repos",
    "events_url": "https://api.github.com/users/g11tech/events{/privacy}",
    "received_events_url": "https://api.github.com/users/g11tech/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "g11tech",
      "id": 76567250,
      "node_id": "MDQ6VXNlcjc2NTY3MjUw",
      "avatar_url": "https://avatars.githubusercontent.com/u/76567250?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/g11tech",
      "html_url": "https://github.com/g11tech",
      "followers_url": "https://api.github.com/users/g11tech/followers",
      "following_url": "https://api.github.com/users/g11tech/following{/other_user}",
      "gists_url": "https://api.github.com/users/g11tech/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/g11tech/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/g11tech/subscriptions",
      "organizations_url": "https://api.github.com/users/g11tech/orgs",
      "repos_url": "https://api.github.com/users/g11tech/repos",
      "events_url": "https://api.github.com/users/g11tech/events{/privacy}",
      "received_events_url": "https://api.github.com/users/g11tech/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2022-03-22T04:42:53Z",
  "updated_at": "2022-03-23T03:22:14Z",
  "closed_at": "2022-03-23T03:22:13Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "There have been reports from users about unusual memory spikes abnormal to other networks. Issue #3861 addresses the need to increase memory from the default Docker setting of 2.0GB to a minimum recommended minimum setting of 4.0GB.  \n\nThis issue will track the issue specifically related to the potential memory leak on our Bellatrix merge tests.",
  "closed_by": {
    "login": "dapplion",
    "id": 35266934,
    "node_id": "MDQ6VXNlcjM1MjY2OTM0",
    "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/dapplion",
    "html_url": "https://github.com/dapplion",
    "followers_url": "https://api.github.com/users/dapplion/followers",
    "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
    "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
    "organizations_url": "https://api.github.com/users/dapplion/orgs",
    "repos_url": "https://api.github.com/users/dapplion/repos",
    "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
    "received_events_url": "https://api.github.com/users/dapplion/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3866/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3866/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1075112052",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/3866#issuecomment-1075112052",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3866",
    "id": 1075112052,
    "node_id": "IC_kwDOCD5_Gc5AFOh0",
    "user": {
      "login": "g11tech",
      "id": 76567250,
      "node_id": "MDQ6VXNlcjc2NTY3MjUw",
      "avatar_url": "https://avatars.githubusercontent.com/u/76567250?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/g11tech",
      "html_url": "https://github.com/g11tech",
      "followers_url": "https://api.github.com/users/g11tech/followers",
      "following_url": "https://api.github.com/users/g11tech/following{/other_user}",
      "gists_url": "https://api.github.com/users/g11tech/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/g11tech/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/g11tech/subscriptions",
      "organizations_url": "https://api.github.com/users/g11tech/orgs",
      "repos_url": "https://api.github.com/users/g11tech/repos",
      "events_url": "https://api.github.com/users/g11tech/events{/privacy}",
      "received_events_url": "https://api.github.com/users/g11tech/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-03-22T12:26:30Z",
    "updated_at": "2022-03-22T12:26:30Z",
    "author_association": "CONTRIBUTOR",
    "body": "Did some basic investigation with memory dumps and comparing them over 5,10,60 minutes window, didn't find anything weird going on related to merge/post merge. (snapshots size varies ~ 460-560 range)\r\n\r\n![image](https://user-images.githubusercontent.com/76567250/159481407-61b69b11-556a-402c-a2e1-1d10e0e95b96.png)\r\n\r\nHere is the process heap graph of our own lodestar <> geth setup validation with around ~500 validators:\r\n\r\n![image](https://user-images.githubusercontent.com/76567250/159480937-5908fa05-35c2-4c5f-8524-8969c72afe45.png)\r\n\r\nLodestar seems to be using ~1.8GB of heap memory, total setup : lodestar + geth + 2 validator instances running on kiln ~3.2GB:\r\n\r\n![image](https://user-images.githubusercontent.com/76567250/159481182-055b5550-45ad-4adc-a4a5-c24cebd626e0.png)\r\n\r\n\r\n@philknows any specific pointers by the users? to help narrow this down?",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1075112052/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1075151546",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/3866#issuecomment-1075151546",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3866",
    "id": 1075151546,
    "node_id": "IC_kwDOCD5_Gc5AFYK6",
    "user": {
      "login": "g11tech",
      "id": 76567250,
      "node_id": "MDQ6VXNlcjc2NTY3MjUw",
      "avatar_url": "https://avatars.githubusercontent.com/u/76567250?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/g11tech",
      "html_url": "https://github.com/g11tech",
      "followers_url": "https://api.github.com/users/g11tech/followers",
      "following_url": "https://api.github.com/users/g11tech/following{/other_user}",
      "gists_url": "https://api.github.com/users/g11tech/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/g11tech/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/g11tech/subscriptions",
      "organizations_url": "https://api.github.com/users/g11tech/orgs",
      "repos_url": "https://api.github.com/users/g11tech/repos",
      "events_url": "https://api.github.com/users/g11tech/events{/privacy}",
      "received_events_url": "https://api.github.com/users/g11tech/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-03-22T13:02:19Z",
    "updated_at": "2022-03-22T13:02:19Z",
    "author_association": "CONTRIBUTOR",
    "body": "closest I have come to is to find a bit of correlation between inbound peer connections and heap. The starting of this graph is just after merge transition (when the metrics collection was started on our kiln testnet server).\r\nNoteworthy thing is: there were chaos around the merge transition as a subset of prysm (i think) related nodes were proposing invalid payloads, which might be resulting into some peer turbulence. \r\n\r\n![image](https://user-images.githubusercontent.com/76567250/159487365-ace7e826-f748-4598-b58f-3a0a9df3898c.png)\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1075151546/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1075874357",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/3866#issuecomment-1075874357",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3866",
    "id": 1075874357,
    "node_id": "IC_kwDOCD5_Gc5AIIo1",
    "user": {
      "login": "dapplion",
      "id": 35266934,
      "node_id": "MDQ6VXNlcjM1MjY2OTM0",
      "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dapplion",
      "html_url": "https://github.com/dapplion",
      "followers_url": "https://api.github.com/users/dapplion/followers",
      "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
      "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
      "organizations_url": "https://api.github.com/users/dapplion/orgs",
      "repos_url": "https://api.github.com/users/dapplion/repos",
      "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dapplion/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-03-23T03:22:13Z",
    "updated_at": "2022-03-23T03:22:13Z",
    "author_association": "MEMBER",
    "body": "Pari's Kiln dashboard had a bad query that plotted data wrong. The reported memory usage was of 95% of 8GB, but it was really 4GB. After manually checking each instance, every Lodestar process takes ~1.8GB max with constant memory through 7 days.\r\n\r\nSince there's no hard evidence of a leak anymore, closing",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1075874357/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
