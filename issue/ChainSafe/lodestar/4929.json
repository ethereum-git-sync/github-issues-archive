{
  "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4929",
  "repository_url": "https://api.github.com/repos/ChainSafe/lodestar",
  "labels_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4929/labels{/name}",
  "comments_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4929/comments",
  "events_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4929/events",
  "html_url": "https://github.com/ChainSafe/lodestar/issues/4929",
  "id": 1505571661,
  "node_id": "I_kwDOCD5_Gc5ZvTNN",
  "number": 4929,
  "title": "v1.3.0-rc.0: Not enough subnet mesh peers",
  "user": {
    "login": "tuyennhv",
    "id": 10568965,
    "node_id": "MDQ6VXNlcjEwNTY4OTY1",
    "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tuyennhv",
    "html_url": "https://github.com/tuyennhv",
    "followers_url": "https://api.github.com/users/tuyennhv/followers",
    "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
    "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
    "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
    "repos_url": "https://api.github.com/users/tuyennhv/repos",
    "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2022-12-21T01:33:52Z",
  "updated_at": "2022-12-22T04:18:33Z",
  "closed_at": "2022-12-22T04:18:33Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "**Describe the bug**\r\n\r\nFor a node of ~1k validators, we don't have enough subnet mesh peers\r\n\r\n<img width=\"847\" alt=\"Screen Shot 2022-12-21 at 08 29 49\" src=\"https://user-images.githubusercontent.com/10568965/208799201-e5f27427-984d-4b9f-96ae-8127ae171bf8.png\">\r\n\r\nSome logs \r\n\r\n```\r\ngrep -e \"to gossipsub\" -rn beacon-2022-12-20.log\r\n\r\n17928:Dec-20 00:14:00.004[network]       verbose: Unsubscribe to gossipsub topic topic=/eth2/c2ce3aa8/beacon_attestation_50/ssz_snappy\r\n290536:Dec-20 03:46:00.003[network]       verbose: Unsubscribe to gossipsub topic topic=/eth2/c2ce3aa8/beacon_attestation_2/ssz_snappy\r\n437464:Dec-20 05:40:36.004[network]       verbose: Unsubscribe to gossipsub topic topic=/eth2/c2ce3aa8/beacon_attestation_16/ssz_snappy\r\n544419:Dec-20 07:03:36.003[network]       verbose: Unsubscribe to gossipsub topic topic=/eth2/c2ce3aa8/beacon_attestation_54/ssz_snappy\r\n670745:Dec-20 08:40:00.004[network]       verbose: Unsubscribe to gossipsub topic topic=/eth2/c2ce3aa8/beacon_attestation_1/ssz_snappy\r\n870289:Dec-20 11:13:24.004[network]       verbose: Unsubscribe to gossipsub topic topic=/eth2/c2ce3aa8/beacon_attestation_38/ssz_snappy\r\n989328:Dec-20 12:45:24.004[network]       verbose: Unsubscribe to gossipsub topic topic=/eth2/c2ce3aa8/beacon_attestation_25/ssz_snappy\r\n1304720:Dec-20 16:48:24.011[network]       verbose: Unsubscribe to gossipsub topic topic=/eth2/c2ce3aa8/beacon_attestation_37/ssz_snappy\r\n1360323:Dec-20 17:31:12.073[network]       verbose: Subscribe to gossipsub topic topic=/eth2/c2ce3aa8/sync_committee_2/ssz_snappy\r\n1671313:Dec-20 21:26:12.004[network]       verbose: Unsubscribe to gossipsub topic topic=/eth2/c2ce3aa8/beacon_attestation_19/ssz_snappy\r\n1840351:Dec-20 23:34:12.004[network]       verbose: Unsubscribe to gossipsub topic topic=/eth2/c2ce3aa8/beacon_attestation_13/ssz_snappy\r\n\r\ngrep -e \"to gossipsub\" -rn beacon-2022-12-19.log\r\n\r\n206645:Dec-19 02:39:48.003[network]       verbose: Unsubscribe to gossipsub topic topic=/eth2/c2ce3aa8/beacon_attestation_28/ssz_snappy\r\n612334:Dec-19 07:52:36.004[network]       verbose: Unsubscribe to gossipsub topic topic=/eth2/c2ce3aa8/beacon_attestation_35/ssz_snappy\r\n706957:Dec-19 09:05:00.004[network]       verbose: Unsubscribe to gossipsub topic topic=/eth2/c2ce3aa8/beacon_attestation_62/ssz_snappy\r\n755941:Dec-19 09:42:24.005[network]       verbose: Unsubscribe to gossipsub topic topic=/eth2/c2ce3aa8/beacon_attestation_44/ssz_snappy\r\n861797:Dec-19 11:03:24.005[network]       verbose: Unsubscribe to gossipsub topic topic=/eth2/c2ce3aa8/beacon_attestation_4/ssz_snappy\r\n1024619:Dec-19 13:08:24.004[network]       verbose: Unsubscribe to gossipsub topic topic=/eth2/c2ce3aa8/beacon_attestation_63/ssz_snappy\r\n1038932:Dec-19 13:19:24.004[network]       verbose: Unsubscribe to gossipsub topic topic=/eth2/c2ce3aa8/beacon_attestation_43/ssz_snappy\r\n1099597:Dec-19 14:05:48.003[network]       verbose: Unsubscribe to gossipsub topic topic=/eth2/c2ce3aa8/beacon_attestation_3/ssz_snappy\r\n1120266:Dec-19 14:21:36.004[network]       verbose: Unsubscribe to gossipsub topic topic=/eth2/c2ce3aa8/beacon_attestation_24/ssz_snappy\r\n1396987:Dec-19 17:54:24.004[network]       verbose: Unsubscribe to gossipsub topic topic=/eth2/c2ce3aa8/beacon_attestation_41/ssz_snappy\r\n```\r\n\r\n==> looks like we don't do a subscribe right after a unsubscribe when we rebalance random subnet subscriptions\r\n\r\nThis is not the same to #4818, now gossip score is great\r\n<img width=\"771\" alt=\"Screen Shot 2022-12-21 at 08 32 32\" src=\"https://user-images.githubusercontent.com/10568965/208799489-69ebf07f-d4a0-41fe-894a-3dad0427856f.png\">\r\n\r\n\r\n\r\n**Expected behavior**\r\n\r\nWe should have 64 subnet mesh peers consistently",
  "closed_by": {
    "login": "dapplion",
    "id": 35266934,
    "node_id": "MDQ6VXNlcjM1MjY2OTM0",
    "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/dapplion",
    "html_url": "https://github.com/dapplion",
    "followers_url": "https://api.github.com/users/dapplion/followers",
    "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
    "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
    "organizations_url": "https://api.github.com/users/dapplion/orgs",
    "repos_url": "https://api.github.com/users/dapplion/repos",
    "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
    "received_events_url": "https://api.github.com/users/dapplion/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4929/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4929/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1360797498",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/4929#issuecomment-1360797498",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4929",
    "id": 1360797498,
    "node_id": "IC_kwDOCD5_Gc5RHB86",
    "user": {
      "login": "tuyennhv",
      "id": 10568965,
      "node_id": "MDQ6VXNlcjEwNTY4OTY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tuyennhv",
      "html_url": "https://github.com/tuyennhv",
      "followers_url": "https://api.github.com/users/tuyennhv/followers",
      "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
      "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
      "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
      "repos_url": "https://api.github.com/users/tuyennhv/repos",
      "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-21T03:10:25Z",
    "updated_at": "2022-12-21T03:10:25Z",
    "author_association": "CONTRIBUTOR",
    "body": "since the unsubscription happened per clock slot, it's the expired committee subscription\r\n\r\n```\r\nDec-20 05:40:36.000[chain]         ^[[36mverbose^[[39m: Clock slot slot=4583903\r\nDec-20 05:40:36.004[network]       ^[[36mverbose^[[39m: Unsubscribe to gossipsub topic topic=/eth2/c2ce3aa8/beacon_attestation_16/ssz_snappy\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1360797498/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1360817393",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/4929#issuecomment-1360817393",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/4929",
    "id": 1360817393,
    "node_id": "IC_kwDOCD5_Gc5RHGzx",
    "user": {
      "login": "tuyennhv",
      "id": 10568965,
      "node_id": "MDQ6VXNlcjEwNTY4OTY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tuyennhv",
      "html_url": "https://github.com/tuyennhv",
      "followers_url": "https://api.github.com/users/tuyennhv/followers",
      "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
      "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
      "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
      "repos_url": "https://api.github.com/users/tuyennhv/repos",
      "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-21T03:43:39Z",
    "updated_at": "2022-12-21T03:43:39Z",
    "author_association": "CONTRIBUTOR",
    "body": "for >=64 validator node, since we subscribe to random subnets per slot but unsubscribe per epoch, there's a window where random subscriptions are expired (and not extend), and if committee subscriptions are expired too then we'll physically unsubscribe the subnet. When next epoch comes we only extend the random subscriptions track without knowing that we unsubscribed the subnet.",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1360817393/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
