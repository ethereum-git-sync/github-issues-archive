{
  "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2249",
  "repository_url": "https://api.github.com/repos/ChainSafe/lodestar",
  "labels_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2249/labels{/name}",
  "comments_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2249/comments",
  "events_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2249/events",
  "html_url": "https://github.com/ChainSafe/lodestar/issues/2249",
  "id": 839605274,
  "node_id": "MDU6SXNzdWU4Mzk2MDUyNzQ=",
  "number": 2249,
  "title": "Prater logs - FORKCHOICE_ERROR_INVALID_ATTESTATION",
  "user": {
    "login": "dapplion",
    "id": 35266934,
    "node_id": "MDQ6VXNlcjM1MjY2OTM0",
    "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/dapplion",
    "html_url": "https://github.com/dapplion",
    "followers_url": "https://api.github.com/users/dapplion/followers",
    "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
    "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
    "organizations_url": "https://api.github.com/users/dapplion/orgs",
    "repos_url": "https://api.github.com/users/dapplion/repos",
    "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
    "received_events_url": "https://api.github.com/users/dapplion/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "tuyennhv",
    "id": 10568965,
    "node_id": "MDQ6VXNlcjEwNTY4OTY1",
    "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tuyennhv",
    "html_url": "https://github.com/tuyennhv",
    "followers_url": "https://api.github.com/users/tuyennhv/followers",
    "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
    "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
    "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
    "repos_url": "https://api.github.com/users/tuyennhv/repos",
    "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "tuyennhv",
      "id": 10568965,
      "node_id": "MDQ6VXNlcjEwNTY4OTY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tuyennhv",
      "html_url": "https://github.com/tuyennhv",
      "followers_url": "https://api.github.com/users/tuyennhv/followers",
      "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
      "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
      "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
      "repos_url": "https://api.github.com/users/tuyennhv/repos",
      "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2021-03-24T11:01:37Z",
  "updated_at": "2021-04-06T15:02:57Z",
  "closed_at": "2021-04-06T15:02:57Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "<!--NOTE: -->\r\n<!--- General questions should go to the discord chat instead of the issue tracker.-->\r\n\r\n**Describe the bug**\r\n\r\nIn Prater genesis running our Beacon node in very overloaded conditions this error appears multiple times only after the first log time shown below.\r\n\r\n```\r\n2021-03-23 15:22:46 [CHAIN]         verbose: Block processed slot=36, root=0x7a93e1f09d0c4c398cb70a4d965acb274b56e8ac75cf47cca1479b7383d595d5\r\n2021-03-23 15:22:46 [CHAIN]         verbose: New chain head headSlot=36, headRoot=0x7a93e1f09d0c4c398cb70a4d965acb274b56e8ac75cf47cca1479b7383d595d5\r\n2021-03-23 15:22:46 [CHAIN]           error: Non AttestationError received code=FORKCHOICE_ERROR_INVALID_ATTESTATION, err={\"code\":\"PAST_EPOCH\",\"attestationEpoch\":1,\"currentEpoch\":3}\r\nError: FORKCHOICE_ERROR_INVALID_ATTESTATION\r\n    at LodestarForkChoice.validateOnAttestation (/root/lodestar/packages/lodestar-fork-choice/src/forkChoice/forkChoice.ts:630:13)\r\n    at LodestarForkChoice.onAttestation (/root/lodestar/packages/lodestar-fork-choice/src/forkChoice/forkChoice.ts:377:10)\r\n    at processAttestation (/root/lodestar/packages/lodestar/src/chain/attestation/process.ts:59:14)\r\n    at runNextTicks (internal/process/task_queues.js:62:5)\r\n    at listOnTimeout (internal/timers.js:523:9)\r\n    at processTimers (internal/timers.js:497:7)\r\n    at processAttestationJob (/root/lodestar/packages/lodestar/src/chain/attestation/processor.ts:45:5)\r\n    at AttestationProcessor.processAttestationJob (/root/lodestar/packages/lodestar/src/chain/attestation/processor.ts:28:5)\r\n    at async Promise.all (index 88)\r\n    at BeaconChain.onBlock (/root/lodestar/packages/lodestar/src/chain/eventHandlers.ts:235:5)\r\n\r\n... 42 times more same error\r\n```\r\n\r\n- Why is the chain not expecting this error? `error: Non AttestationError received`\r\n- Why did this attestation make it to the ForkChoice? Maybe it took so long to process that it was still in the same epoch on the chain and then not when it reached the ForkChoice.\r\n- Seems that some validations are done twice in the Chain and ForkChoice, is that expected?\r\n\r\n**Expected behavior**\r\n\r\n<!--A clear and concise description of what you expected to happen.-->\r\n\r\n**Steps to Reproduce**\r\n\r\n<!--Steps to reproduce the behavior:\r\n1. Go to '...'\r\n2. Click on '....'\r\n3. Scroll down to '....'\r\n4. See error\r\n-->\r\n\r\n**Screenshots**\r\n\r\n<!--If applicable, add screenshots to help explain your problem.-->\r\n\r\n**Desktop (please complete the following information):**\r\n\r\n- OS: <!--[e.g. ubuntu, OSX High Siera]-->\r\n- Version: <!--[e.g. 22]-->\r\n- Branch: <!--[Master]-->\r\n- Commit hash: <!--[e8232]-->\r\n",
  "closed_by": {
    "login": "wemeetagain",
    "id": 1348242,
    "node_id": "MDQ6VXNlcjEzNDgyNDI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1348242?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/wemeetagain",
    "html_url": "https://github.com/wemeetagain",
    "followers_url": "https://api.github.com/users/wemeetagain/followers",
    "following_url": "https://api.github.com/users/wemeetagain/following{/other_user}",
    "gists_url": "https://api.github.com/users/wemeetagain/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/wemeetagain/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/wemeetagain/subscriptions",
    "organizations_url": "https://api.github.com/users/wemeetagain/orgs",
    "repos_url": "https://api.github.com/users/wemeetagain/repos",
    "events_url": "https://api.github.com/users/wemeetagain/events{/privacy}",
    "received_events_url": "https://api.github.com/users/wemeetagain/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2249/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2249/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/810751921",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/2249#issuecomment-810751921",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2249",
    "id": 810751921,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgxMDc1MTkyMQ==",
    "user": {
      "login": "tuyennhv",
      "id": 10568965,
      "node_id": "MDQ6VXNlcjEwNTY4OTY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tuyennhv",
      "html_url": "https://github.com/tuyennhv",
      "followers_url": "https://api.github.com/users/tuyennhv/followers",
      "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
      "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
      "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
      "repos_url": "https://api.github.com/users/tuyennhv/repos",
      "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-31T04:31:04Z",
    "updated_at": "2021-03-31T04:31:04Z",
    "author_association": "CONTRIBUTOR",
    "body": "what happened is we process slot 36 at `22:22:46` while the block itself was produced at `21:07` as in https://prater.beaconcha.in/block/7a93e1f09d0c4c398cb70a4d965acb274b56e8ac75cf47cca1479b7383d595d5#overview\r\n\r\ndue to clock drift issue #2240, the `PAST_EPOCH` condition passed when we validate attestations but right after that when they're passed to forkchoice, clock jumps to the correct slot and attestations failed to pass that same condition in forkchoice.\r\n\r\n> Why is the chain not expecting this error? error: Non AttestationError received\r\n\r\nForkchoice throws `ForkChoiceError` with `INVALID_ATTESTATION` code, and lodestar only expects its own `AttestationError`. We need to map these errors so that lodestar handle them correctly\r\n\r\n> Why did this attestation make it to the ForkChoice? Maybe it took so long to process that it was still in the same epoch on the chain and then not when it reached the ForkChoice.\r\n\r\nthis is due to the clock drift issue as explained above\r\n\r\n> Seems that some validations are done twice in the Chain and ForkChoice, is that expected?\r\n\r\nyeah there is a duplication (we do exactly the same thing as commented in the function header), maybe just remove the one in lodestar and keep the one in forkchoice. Then provide a map of forkchoice error to lodestar `AttestationError` and handle it in `eventHandler` finally.",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/810751921/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
