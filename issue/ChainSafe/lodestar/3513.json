{
  "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3513",
  "repository_url": "https://api.github.com/repos/ChainSafe/lodestar",
  "labels_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3513/labels{/name}",
  "comments_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3513/comments",
  "events_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3513/events",
  "html_url": "https://github.com/ChainSafe/lodestar/issues/3513",
  "id": 1077779485,
  "node_id": "I_kwDOCD5_Gc5APZwd",
  "number": 3513,
  "title": "Consider disabling precompute epoch on overloaded nodes",
  "user": {
    "login": "dapplion",
    "id": 35266934,
    "node_id": "MDQ6VXNlcjM1MjY2OTM0",
    "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/dapplion",
    "html_url": "https://github.com/dapplion",
    "followers_url": "https://api.github.com/users/dapplion/followers",
    "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
    "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
    "organizations_url": "https://api.github.com/users/dapplion/orgs",
    "repos_url": "https://api.github.com/users/dapplion/repos",
    "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
    "received_events_url": "https://api.github.com/users/dapplion/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1200090453,
      "node_id": "MDU6TGFiZWwxMjAwMDkwNDUz",
      "url": "https://api.github.com/repos/ChainSafe/lodestar/labels/prio-low",
      "name": "prio-low",
      "color": "fde2b4",
      "default": false,
      "description": "This is nice to have."
    },
    {
      "id": 2963898184,
      "node_id": "MDU6TGFiZWwyOTYzODk4MTg0",
      "url": "https://api.github.com/repos/ChainSafe/lodestar/labels/scope-performance",
      "name": "scope-performance",
      "color": "980043",
      "default": false,
      "description": "Performance issue and ideas to improve performance."
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2021-12-12T11:15:14Z",
  "updated_at": "2022-05-10T13:42:09Z",
  "closed_at": "2022-05-10T13:42:09Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "<!--NOTE: -->\r\n<!--- General questions should go to the discord chat instead of the issue tracker.-->\r\n\r\n**Describe the bug**\r\n\r\nIn contabo-12 2021-12-12 08:02:13 CET the node was very overloaded due to high memory usage with GC using >75% of CPU time. In that situation everything is extremely slow. The precompute epoch kicked in and ran an epoch transition which according to metrics had a total async time of 36 sec. \r\n\r\n![Screenshot from 2021-12-12 12-01-39](https://user-images.githubusercontent.com/35266934/145709838-f27c9aa6-c970-44d5-88b2-77a7a44522d6.png)\r\n\r\nThe resulting state is guaranteed to be useless. However it does not show up in the \"Precompute Epoch Transition\" \"Hit vs Miss\" chart\r\n\r\n![Screenshot from 2021-12-12 12-06-33](https://user-images.githubusercontent.com/35266934/145709865-765fc1aa-b05f-45ed-80f7-d6cc991953b8.png)\r\n\r\n**Expected behavior**\r\n\r\n- Consider disabling precompute epoch on overloaded nodes. This item is not a priority, since we should work on preventing the node from getting overloaded in the first place.\r\n- Review metrics, the state above could not have been used but it still didn't show up as wasted. Maybe I'm missing something?\r\n\r\nAlso the charts could be improved, it's very hard to get a picture of what's going on with the way the info is provided now. For example the chart \"Run Result\"\r\n\r\n![Screenshot from 2021-12-12 12-14-19](https://user-images.githubusercontent.com/35266934/145710077-a3e7bbe1-f668-4376-a720-9d89f01daf27.png)\r\n\r\n\r\nIs answering the question \"What's it the run result of each epoch?, skipped or done? In my opinion doing this tweaks it looks much better\r\n- Scale up to rate per epoch\r\n- Stack\r\n- Reduce interval rate\r\n\r\n![Screenshot from 2021-12-12 12-11-06](https://user-images.githubusercontent.com/35266934/145710031-067973ee-0ad1-436d-bc09-6bd22a051bca.png)\r\n\r\nNow you can clearly see that:\r\n- exactly once run is done per epoch\r\n- the % of skipped runs\r\n",
  "closed_by": {
    "login": "dapplion",
    "id": 35266934,
    "node_id": "MDQ6VXNlcjM1MjY2OTM0",
    "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/dapplion",
    "html_url": "https://github.com/dapplion",
    "followers_url": "https://api.github.com/users/dapplion/followers",
    "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
    "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
    "organizations_url": "https://api.github.com/users/dapplion/orgs",
    "repos_url": "https://api.github.com/users/dapplion/repos",
    "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
    "received_events_url": "https://api.github.com/users/dapplion/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3513/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3513/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/993417205",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/3513#issuecomment-993417205",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3513",
    "id": 993417205,
    "node_id": "IC_kwDOCD5_Gc47Nlf1",
    "user": {
      "login": "tuyennhv",
      "id": 10568965,
      "node_id": "MDQ6VXNlcjEwNTY4OTY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tuyennhv",
      "html_url": "https://github.com/tuyennhv",
      "followers_url": "https://api.github.com/users/tuyennhv/followers",
      "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
      "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
      "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
      "repos_url": "https://api.github.com/users/tuyennhv/repos",
      "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-12-14T10:51:43Z",
    "updated_at": "2021-12-14T10:51:43Z",
    "author_association": "CONTRIBUTOR",
    "body": "@dapplion  The precomputeNextEpochTransition only gets triggered when `headSlot === clockSlot` so I'm not sure why it's useless, since when the next gossip block comes we'll run the epoch transition anyway\r\n\r\nregarding the chart, agree that it looks much better that way ðŸ‘ ",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/993417205/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/994693779",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/3513#issuecomment-994693779",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3513",
    "id": 994693779,
    "node_id": "IC_kwDOCD5_Gc47SdKT",
    "user": {
      "login": "dapplion",
      "id": 35266934,
      "node_id": "MDQ6VXNlcjM1MjY2OTM0",
      "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dapplion",
      "html_url": "https://github.com/dapplion",
      "followers_url": "https://api.github.com/users/dapplion/followers",
      "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
      "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
      "organizations_url": "https://api.github.com/users/dapplion/orgs",
      "repos_url": "https://api.github.com/users/dapplion/repos",
      "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dapplion/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-12-15T11:20:23Z",
    "updated_at": "2021-12-15T11:20:23Z",
    "author_association": "MEMBER",
    "body": "> The precomputeNextEpochTransition only gets triggered when headSlot === clockSlot\r\n\r\nGood point! Then could it be that the node is so overloaded that the clock is also behind?",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/994693779/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/995359556",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/3513#issuecomment-995359556",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3513",
    "id": 995359556,
    "node_id": "IC_kwDOCD5_Gc47U_tE",
    "user": {
      "login": "tuyennhv",
      "id": 10568965,
      "node_id": "MDQ6VXNlcjEwNTY4OTY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tuyennhv",
      "html_url": "https://github.com/tuyennhv",
      "followers_url": "https://api.github.com/users/tuyennhv/followers",
      "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
      "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
      "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
      "repos_url": "https://api.github.com/users/tuyennhv/repos",
      "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-12-16T01:33:29Z",
    "updated_at": "2021-12-16T01:33:29Z",
    "author_association": "CONTRIBUTOR",
    "body": "> Good point! Then could it be that the node is so overloaded that the clock is also behind?\r\n\r\n@dapplion due to #3517 contabo-12 was so unlucky to get  connected to some Unknown peers that don't support any protocols and it caused this memory issue. I'd like to continue monitoring this for a while to decide if precomputing epoch transition is an issue or not.\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/995359556/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1122413787",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/3513#issuecomment-1122413787",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/3513",
    "id": 1122413787,
    "node_id": "IC_kwDOCD5_Gc5C5qzb",
    "user": {
      "login": "dapplion",
      "id": 35266934,
      "node_id": "MDQ6VXNlcjM1MjY2OTM0",
      "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dapplion",
      "html_url": "https://github.com/dapplion",
      "followers_url": "https://api.github.com/users/dapplion/followers",
      "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
      "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
      "organizations_url": "https://api.github.com/users/dapplion/orgs",
      "repos_url": "https://api.github.com/users/dapplion/repos",
      "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dapplion/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-10T13:42:09Z",
    "updated_at": "2022-05-10T13:42:09Z",
    "author_association": "MEMBER",
    "body": "Closing as it has not been observed for months. If the node is really overloaded there are other areas of greater concern that this.",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1122413787/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
