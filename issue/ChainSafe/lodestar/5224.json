{
  "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5224",
  "repository_url": "https://api.github.com/repos/ChainSafe/lodestar",
  "labels_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5224/labels{/name}",
  "comments_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5224/comments",
  "events_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5224/events",
  "html_url": "https://github.com/ChainSafe/lodestar/issues/5224",
  "id": 1605583398,
  "node_id": "I_kwDOCD5_Gc5fs0Im",
  "number": 5224,
  "title": "Lodestar enagages all cores 100% when doing countdown for genesis",
  "user": {
    "login": "g11tech",
    "id": 76567250,
    "node_id": "MDQ6VXNlcjc2NTY3MjUw",
    "avatar_url": "https://avatars.githubusercontent.com/u/76567250?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/g11tech",
    "html_url": "https://github.com/g11tech",
    "followers_url": "https://api.github.com/users/g11tech/followers",
    "following_url": "https://api.github.com/users/g11tech/following{/other_user}",
    "gists_url": "https://api.github.com/users/g11tech/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/g11tech/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/g11tech/subscriptions",
    "organizations_url": "https://api.github.com/users/g11tech/orgs",
    "repos_url": "https://api.github.com/users/g11tech/repos",
    "events_url": "https://api.github.com/users/g11tech/events{/privacy}",
    "received_events_url": "https://api.github.com/users/g11tech/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 2963898184,
      "node_id": "MDU6TGFiZWwyOTYzODk4MTg0",
      "url": "https://api.github.com/repos/ChainSafe/lodestar/labels/scope-performance",
      "name": "scope-performance",
      "color": "980043",
      "default": false,
      "description": "Performance issue and ideas to improve performance."
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2023-03-01T19:59:18Z",
  "updated_at": "2023-03-19T17:46:17Z",
  "closed_at": "2023-03-19T17:46:17Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "\r\n**Describe the bug**\r\nWhen trying to run a lodestar interop locally, noticed that lodestar starts consuming 100% cpu on all cores\r\n![image](https://user-images.githubusercontent.com/76567250/222251355-029c2ad7-2a1d-47f1-b0c8-5bfcb572238e.png)\r\n\r\nwhich returns to normal as soon as genesis countdown is finished and chain starts moving.\r\n\r\n<!--A clear and concise description of what the bug is and steps to reproduce it.-->\r\n\r\nBug seems to be lodestar doing an active wait on some multi threaded workers\r\n\r\n**Expected behavior**\r\nShould not engage CPU cores while genesis countdown\r\n<!--A clear and concise description of what you expected to happen.-->\r\n\r\n**Steps to Reproduce**\r\nrun local interop and observe cpu usage while countdown to genesis\r\n```\r\ncd packages/beacon-node\r\nEL_BINARY_DIR=g11tech/geth:withdrawalsfeb8 EL_SCRIPT_DIR=gethdocker yarn mocha test/sim/withdrawal-interop.test.ts\r\n```\r\n\r\nOS: ubuntu 22.04",
  "closed_by": {
    "login": "g11tech",
    "id": 76567250,
    "node_id": "MDQ6VXNlcjc2NTY3MjUw",
    "avatar_url": "https://avatars.githubusercontent.com/u/76567250?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/g11tech",
    "html_url": "https://github.com/g11tech",
    "followers_url": "https://api.github.com/users/g11tech/followers",
    "following_url": "https://api.github.com/users/g11tech/following{/other_user}",
    "gists_url": "https://api.github.com/users/g11tech/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/g11tech/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/g11tech/subscriptions",
    "organizations_url": "https://api.github.com/users/g11tech/orgs",
    "repos_url": "https://api.github.com/users/g11tech/repos",
    "events_url": "https://api.github.com/users/g11tech/events{/privacy}",
    "received_events_url": "https://api.github.com/users/g11tech/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5224/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5224/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1452801234",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/5224#issuecomment-1452801234",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5224",
    "id": 1452801234,
    "node_id": "IC_kwDOCD5_Gc5Wl_zS",
    "user": {
      "login": "dapplion",
      "id": 35266934,
      "node_id": "MDQ6VXNlcjM1MjY2OTM0",
      "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dapplion",
      "html_url": "https://github.com/dapplion",
      "followers_url": "https://api.github.com/users/dapplion/followers",
      "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
      "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
      "organizations_url": "https://api.github.com/users/dapplion/orgs",
      "repos_url": "https://api.github.com/users/dapplion/repos",
      "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dapplion/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-03T01:24:54Z",
    "updated_at": "2023-03-03T01:26:19Z",
    "author_association": "MEMBER",
    "body": "@g11tech Run locally and could recreate. Tho:\r\n- Extending the genesis delay the 100% CPU only lasts for about 10 seconds, then goes back to idle. So your observation that it lasts for the entire genesis waiting period so happens that the waiting period is about 10 seconds\r\n- I attached a CPU profiler and it was empty. There must be a bug or something so I can't tell what's taking CPU\r\n\r\nCould geth CPU be reported as node's process since it is run a child process? I can't think of anything on start that could max out CPU. We only multithread BLS sig verification",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1452801234/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1455028391",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/5224#issuecomment-1455028391",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5224",
    "id": 1455028391,
    "node_id": "IC_kwDOCD5_Gc5Wufin",
    "user": {
      "login": "g11tech",
      "id": 76567250,
      "node_id": "MDQ6VXNlcjc2NTY3MjUw",
      "avatar_url": "https://avatars.githubusercontent.com/u/76567250?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/g11tech",
      "html_url": "https://github.com/g11tech",
      "followers_url": "https://api.github.com/users/g11tech/followers",
      "following_url": "https://api.github.com/users/g11tech/following{/other_user}",
      "gists_url": "https://api.github.com/users/g11tech/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/g11tech/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/g11tech/subscriptions",
      "organizations_url": "https://api.github.com/users/g11tech/orgs",
      "repos_url": "https://api.github.com/users/g11tech/repos",
      "events_url": "https://api.github.com/users/g11tech/events{/privacy}",
      "received_events_url": "https://api.github.com/users/g11tech/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-05T08:50:43Z",
    "updated_at": "2023-03-05T08:50:43Z",
    "author_association": "CONTRIBUTOR",
    "body": "> @g11tech Run locally and could recreate. Tho:\r\n> \r\n>     * Extending the genesis delay the 100% CPU only lasts for about 10 seconds, then goes back to idle. So your observation that it lasts for the entire genesis waiting period so happens that the waiting period is about 10 seconds\r\n> \r\n>     * I attached a CPU profiler and it was empty. There must be a bug or something so I can't tell what's taking CPU\r\n> \r\n> \r\n> Could geth CPU be reported as node's process since it is run a child process? I can't think of anything on start that could max out CPU. We only multithread BLS sig verification\r\n\r\nhmm yes, it goes back to idle, but CPU during this 10 sec period scales with number of cpu cores (tested on 24 core) and all cores engaged there as well.\r\n\r\nI will try running geth separately as see what happens ",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1455028391/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1475339216",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/5224#issuecomment-1475339216",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/5224",
    "id": 1475339216,
    "node_id": "IC_kwDOCD5_Gc5X7-PQ",
    "user": {
      "login": "g11tech",
      "id": 76567250,
      "node_id": "MDQ6VXNlcjc2NTY3MjUw",
      "avatar_url": "https://avatars.githubusercontent.com/u/76567250?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/g11tech",
      "html_url": "https://github.com/g11tech",
      "followers_url": "https://api.github.com/users/g11tech/followers",
      "following_url": "https://api.github.com/users/g11tech/following{/other_user}",
      "gists_url": "https://api.github.com/users/g11tech/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/g11tech/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/g11tech/subscriptions",
      "organizations_url": "https://api.github.com/users/g11tech/orgs",
      "repos_url": "https://api.github.com/users/g11tech/repos",
      "events_url": "https://api.github.com/users/g11tech/events{/privacy}",
      "received_events_url": "https://api.github.com/users/g11tech/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-19T17:46:17Z",
    "updated_at": "2023-03-19T17:46:17Z",
    "author_association": "CONTRIBUTOR",
    "body": "@dapplion didn't notice with other EL clients so closing the issue as of now",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1475339216/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
