{
  "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2740",
  "repository_url": "https://api.github.com/repos/ChainSafe/lodestar",
  "labels_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2740/labels{/name}",
  "comments_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2740/comments",
  "events_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2740/events",
  "html_url": "https://github.com/ChainSafe/lodestar/issues/2740",
  "id": 928083183,
  "node_id": "MDU6SXNzdWU5MjgwODMxODM=",
  "number": 2740,
  "title": "Unable to archive states",
  "user": {
    "login": "dapplion",
    "id": 35266934,
    "node_id": "MDQ6VXNlcjM1MjY2OTM0",
    "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/dapplion",
    "html_url": "https://github.com/dapplion",
    "followers_url": "https://api.github.com/users/dapplion/followers",
    "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
    "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
    "organizations_url": "https://api.github.com/users/dapplion/orgs",
    "repos_url": "https://api.github.com/users/dapplion/repos",
    "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
    "received_events_url": "https://api.github.com/users/dapplion/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1200090447,
      "node_id": "MDU6TGFiZWwxMjAwMDkwNDQ3",
      "url": "https://api.github.com/repos/ChainSafe/lodestar/labels/prio-high",
      "name": "prio-high",
      "color": "fd9579",
      "default": false,
      "description": "Resolve issues as soon as possible."
    },
    {
      "id": 2159934357,
      "node_id": "MDU6TGFiZWwyMTU5OTM0MzU3",
      "url": "https://api.github.com/repos/ChainSafe/lodestar/labels/scope-testnet-debugging",
      "name": "scope-testnet-debugging",
      "color": "980043",
      "default": false,
      "description": "Issues uncovered through running a node on a public testnet."
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "tuyennhv",
    "id": 10568965,
    "node_id": "MDQ6VXNlcjEwNTY4OTY1",
    "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tuyennhv",
    "html_url": "https://github.com/tuyennhv",
    "followers_url": "https://api.github.com/users/tuyennhv/followers",
    "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
    "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
    "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
    "repos_url": "https://api.github.com/users/tuyennhv/repos",
    "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "tuyennhv",
      "id": 10568965,
      "node_id": "MDQ6VXNlcjEwNTY4OTY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tuyennhv",
      "html_url": "https://github.com/tuyennhv",
      "followers_url": "https://api.github.com/users/tuyennhv/followers",
      "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
      "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
      "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
      "repos_url": "https://api.github.com/users/tuyennhv/repos",
      "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2021-06-23T10:02:26Z",
  "updated_at": "2021-07-06T16:57:33Z",
  "closed_at": "2021-07-06T16:57:33Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "<!--NOTE: -->\r\n<!--- General questions should go to the discord chat instead of the issue tracker.-->\r\n\r\n**Describe the bug**\r\n\r\nIn our Prater node 100,000 slots of sync progress were lost after a node restart.\r\n\r\n![Screenshot from 2021-06-23 12-01-00](https://user-images.githubusercontent.com/35266934/123077947-cb4d2180-d41a-11eb-80c8-5afdbd5f5aa1.png)\r\n\r\n\r\n**Expected behavior**\r\n\r\nStates should be persisted more regularly and just a few epochs would have to be re-processed\r\n\r\n**Steps to Reproduce**\r\n\r\n?\r\n\r\n**Screenshots**\r\n\r\n",
  "closed_by": {
    "login": "wemeetagain",
    "id": 1348242,
    "node_id": "MDQ6VXNlcjEzNDgyNDI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1348242?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/wemeetagain",
    "html_url": "https://github.com/wemeetagain",
    "followers_url": "https://api.github.com/users/wemeetagain/followers",
    "following_url": "https://api.github.com/users/wemeetagain/following{/other_user}",
    "gists_url": "https://api.github.com/users/wemeetagain/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/wemeetagain/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/wemeetagain/subscriptions",
    "organizations_url": "https://api.github.com/users/wemeetagain/orgs",
    "repos_url": "https://api.github.com/users/wemeetagain/repos",
    "events_url": "https://api.github.com/users/wemeetagain/events{/privacy}",
    "received_events_url": "https://api.github.com/users/wemeetagain/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2740/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2740/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/871282011",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/2740#issuecomment-871282011",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2740",
    "id": 871282011,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg3MTI4MjAxMQ==",
    "user": {
      "login": "dapplion",
      "id": 35266934,
      "node_id": "MDQ6VXNlcjM1MjY2OTM0",
      "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dapplion",
      "html_url": "https://github.com/dapplion",
      "followers_url": "https://api.github.com/users/dapplion/followers",
      "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
      "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
      "organizations_url": "https://api.github.com/users/dapplion/orgs",
      "repos_url": "https://api.github.com/users/dapplion/repos",
      "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dapplion/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-06-30T10:25:11Z",
    "updated_at": "2021-06-30T10:25:11Z",
    "author_association": "MEMBER",
    "body": "It happened again. Seems that for two weeks the node hasn't persisted anything to disk\r\n\r\n![Screenshot from 2021-06-30 12-24-17](https://user-images.githubusercontent.com/35266934/123945179-2abcab80-d99e-11eb-84f7-12ea8b4de197.png)\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/871282011/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/871283396",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/2740#issuecomment-871283396",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2740",
    "id": 871283396,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg3MTI4MzM5Ng==",
    "user": {
      "login": "dapplion",
      "id": 35266934,
      "node_id": "MDQ6VXNlcjM1MjY2OTM0",
      "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dapplion",
      "html_url": "https://github.com/dapplion",
      "followers_url": "https://api.github.com/users/dapplion/followers",
      "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
      "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
      "organizations_url": "https://api.github.com/users/dapplion/orgs",
      "repos_url": "https://api.github.com/users/dapplion/repos",
      "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dapplion/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-06-30T10:27:23Z",
    "updated_at": "2021-06-30T10:29:41Z",
    "author_association": "MEMBER",
    "body": "Looking at the logs:\r\n```\r\nJun-30 10:25:02.161 [CHORES]          error: Error processing finalized checkpoint epoch=17537 message=No block found for root 0x37487efdbfbeeb82d7d35c6eb96438c4576f645b0f4c0386184592abab4b1736\r\nError: No block found for root 0x37487efdbfbeeb82d7d35c6eb96438c4576f645b0f4c0386184592abab4b1736\r\n    at /usr/app/packages/lodestar/src/tasks/tasks/archiveBlocks.ts:75:19\r\n    at async Promise.all (index 183)\r\n    at ArchiveBlocksTask.processCanonicalBlocks (/usr/app/packages/lodestar/src/tasks/tasks/archiveBlocks.ts:71:7)\r\n    at ArchiveBlocksTask.run (/usr/app/packages/lodestar/src/tasks/tasks/archiveBlocks.ts:52:7)\r\n    at TasksService.processFinalizedCheckpoint (/usr/app/packages/lodestar/src/tasks/index.ts:79:7)\r\n    at Object.job (/usr/app/packages/lodestar/src/tasks/index.ts:74:43)\r\n    at Timeout._onTimeout (/usr/app/packages/lodestar/src/util/queue/index.ts:106:22)\r\n\r\nJun-30 10:25:15.780 [CHORES]          error: Error processing finalized checkpoint epoch=17538 message=No block found for root 0x37487efdbfbeeb82d7d35c6eb96438c4576f645b0f4c0386184592abab4b1736\r\nError: No block found for root 0x37487efdbfbeeb82d7d35c6eb96438c4576f645b0f4c0386184592abab4b1736\r\n    at /usr/app/packages/lodestar/src/tasks/tasks/archiveBlocks.ts:75:19\r\n    at async Promise.all (index 214)\r\n    at ArchiveBlocksTask.processCanonicalBlocks (/usr/app/packages/lodestar/src/tasks/tasks/archiveBlocks.ts:71:7)\r\n    at ArchiveBlocksTask.run (/usr/app/packages/lodestar/src/tasks/tasks/archiveBlocks.ts:52:7)\r\n    at TasksService.processFinalizedCheckpoint (/usr/app/packages/lodestar/src/tasks/index.ts:79:7)\r\n    at Object.job (/usr/app/packages/lodestar/src/tasks/index.ts:74:43)\r\n    at Timeout._onTimeout (/usr/app/packages/lodestar/src/util/queue/index.ts:106:22)\r\n\r\n```\r\n\r\nThe block is complaining about is this one from 20 days ago. \r\n```\r\nSlot: 560991\r\nTime: Jun 9, 2021, 1:58 PM (20 days ago)\r\n```\r\nhttps://prater.beaconcha.in/block/37487efdbfbeeb82d7d35c6eb96438c4576f645b0f4c0386184592abab4b1736\r\n\r\nIt lines up well with the slot the node reverts to after crashing",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/871283396/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/871395798",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/2740#issuecomment-871395798",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2740",
    "id": 871395798,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg3MTM5NTc5OA==",
    "user": {
      "login": "dapplion",
      "id": 35266934,
      "node_id": "MDQ6VXNlcjM1MjY2OTM0",
      "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dapplion",
      "html_url": "https://github.com/dapplion",
      "followers_url": "https://api.github.com/users/dapplion/followers",
      "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
      "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
      "organizations_url": "https://api.github.com/users/dapplion/orgs",
      "repos_url": "https://api.github.com/users/dapplion/repos",
      "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dapplion/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-06-30T13:16:38Z",
    "updated_at": "2021-06-30T13:16:38Z",
    "author_association": "MEMBER",
    "body": "I synced the node to the head with a weak subjectivity state and it still was unable to archive\r\n\r\n```\r\nJun-30 13:14:10.920 [CHORES]          error: Error processing finalized checkpoint epoch=22265 message=No block found for root 0x1654d3d939ac98216be951c65cfb497716ccfa236192b56c66886e1a43196a23\r\nError: No block found for root 0x1654d3d939ac98216be951c65cfb497716ccfa236192b56c66886e1a43196a23\r\n    at /usr/app/packages/lodestar/src/tasks/tasks/archiveBlocks.ts:75:19\r\n    at async Promise.all (index 29)\r\n    at ArchiveBlocksTask.processCanonicalBlocks (/usr/app/packages/lodestar/src/tasks/tasks/archiveBlocks.ts:71:7)\r\n    at ArchiveBlocksTask.run (/usr/app/packages/lodestar/src/tasks/tasks/archiveBlocks.ts:52:7)\r\n    at TasksService.processFinalizedCheckpoint (/usr/app/packages/lodestar/src/tasks/index.ts:79:7)\r\n    at Object.job (/usr/app/packages/lodestar/src/tasks/index.ts:74:43)\r\n    at Timeout._onTimeout (/usr/app/packages/lodestar/src/util/queue/index.ts:106:22)\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/871395798/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/871888391",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/2740#issuecomment-871888391",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2740",
    "id": 871888391,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg3MTg4ODM5MQ==",
    "user": {
      "login": "tuyennhv",
      "id": 10568965,
      "node_id": "MDQ6VXNlcjEwNTY4OTY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tuyennhv",
      "html_url": "https://github.com/tuyennhv",
      "followers_url": "https://api.github.com/users/tuyennhv/followers",
      "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
      "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
      "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
      "repos_url": "https://api.github.com/users/tuyennhv/repos",
      "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-07-01T03:37:07Z",
    "updated_at": "2021-07-01T03:37:07Z",
    "author_association": "CONTRIBUTOR",
    "body": "When we start from a weak subjectivity checkpoint, we don't have the respective block in `block` db so the issue happens consistently.\r\nI think we have same issue somewhere, but it does not always happen.",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/871888391/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/872033502",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/2740#issuecomment-872033502",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2740",
    "id": 872033502,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg3MjAzMzUwMg==",
    "user": {
      "login": "tuyennhv",
      "id": 10568965,
      "node_id": "MDQ6VXNlcjEwNTY4OTY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/10568965?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tuyennhv",
      "html_url": "https://github.com/tuyennhv",
      "followers_url": "https://api.github.com/users/tuyennhv/followers",
      "following_url": "https://api.github.com/users/tuyennhv/following{/other_user}",
      "gists_url": "https://api.github.com/users/tuyennhv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tuyennhv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tuyennhv/subscriptions",
      "organizations_url": "https://api.github.com/users/tuyennhv/orgs",
      "repos_url": "https://api.github.com/users/tuyennhv/repos",
      "events_url": "https://api.github.com/users/tuyennhv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tuyennhv/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-07-01T08:19:34Z",
    "updated_at": "2021-07-01T08:19:34Z",
    "author_association": "CONTRIBUTOR",
    "body": "## Explanation\r\nSo I traced the issue to the beginning of the log file in `contabo-5`, the `archiveBlock` task really failed from the beginning\r\n```\r\nJun-30 09:02:02.660 []                 ^[[32minfo^[[39m: Initializing beacon state slot=549120, epoch=17160, stateRoot=0xb021a96da54dd89dfafc0e8817e23fe708f5746e924855f49b3f978133c3ac6a\r\n```\r\n```\r\n7027 Jun-30 09:07:38.550 [CHORES]          ^[[31merror^[[39m: Error processing finalized checkpoint epoch=17161 message=No block found for root 0x85d7534b470b817c5b1a65e9eeec8dc712a1f11014232ebf01970444d75ddcf7\r\n```\r\n`0x85d7534b470b817c5b1a65e9eeec8dc712a1f11014232ebf01970444d75ddcf7` is the root of block slot 549120\r\n\r\nonce we fail to process a run, it keeps failing for all next run because some blocks are moved to`blockArchive` db but forkchoice still retain them.\r\n\r\n## Root cause\r\nCurrently, we try to make `block` db to be synchronized to forkchoice and it works fine until we restart the node.\r\n\r\nWhen we restart from an anchor state, if we have the finalized block in db then issue does not happen, otherwise the issue happens.\r\n\r\n## Solution\r\nMake `block` db to be synchronized to `stateArchived` db instead of the forkchoice. Although forkchoice contains the old finalized block, ArchiveBlock should not process it, it should process that in the previous run.\r\n\r\nWhen we restart, ArchiveBlock should not work on the finalized block of the anchor state since that block is finalized already.",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/872033502/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
