{
  "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2206",
  "repository_url": "https://api.github.com/repos/ChainSafe/lodestar",
  "labels_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2206/labels{/name}",
  "comments_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2206/comments",
  "events_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2206/events",
  "html_url": "https://github.com/ChainSafe/lodestar/issues/2206",
  "id": 835883809,
  "node_id": "MDU6SXNzdWU4MzU4ODM4MDk=",
  "number": 2206,
  "title": "Lodestar tree hashing performance",
  "user": {
    "login": "dapplion",
    "id": 35266934,
    "node_id": "MDQ6VXNlcjM1MjY2OTM0",
    "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/dapplion",
    "html_url": "https://github.com/dapplion",
    "followers_url": "https://api.github.com/users/dapplion/followers",
    "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
    "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
    "organizations_url": "https://api.github.com/users/dapplion/orgs",
    "repos_url": "https://api.github.com/users/dapplion/repos",
    "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
    "received_events_url": "https://api.github.com/users/dapplion/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1200090453,
      "node_id": "MDU6TGFiZWwxMjAwMDkwNDUz",
      "url": "https://api.github.com/repos/ChainSafe/lodestar/labels/prio-low",
      "name": "prio-low",
      "color": "fde2b4",
      "default": false,
      "description": "This is nice to have."
    },
    {
      "id": 2963898184,
      "node_id": "MDU6TGFiZWwyOTYzODk4MTg0",
      "url": "https://api.github.com/repos/ChainSafe/lodestar/labels/scope-performance",
      "name": "scope-performance",
      "color": "980043",
      "default": false,
      "description": "Performance issue and ideas to improve performance."
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 7,
  "created_at": "2021-03-19T11:35:52Z",
  "updated_at": "2023-05-26T15:52:10Z",
  "closed_at": "2023-05-26T15:52:10Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "**Purpose**: profiling our state transition function computing the hashTreeRoot of state and blocks has shown to take significant chunk of total time.\r\n\r\nI've compared a benchmark that Lighthouse has on their tree hash lib with our tree backed types. There seems to be some room for improvement on our side. I'm trying to get a benchmark of their hashing lib vs our to help narrow down where is the performance difference coming from.\r\n- Rust bench: https://github.com/sigp/lighthouse/blob/stable/consensus/tree_hash/benches/benches.rs \r\n\r\n\r\nForced single core (ms)\r\n\r\n| test           | LH (no_cache) | LH (empty_cache) | Lodestar      |\r\n| -------------- | ------------- | ---------------- | ------------- |\r\n| minimal/100000 | 511.34        | 517.57           | 3144.3 (x6.1) |\r\n| minimal/300000 | 1441.1        | 1550.1           | 8547.3 (x5.5) |\r\n| mainnet/100000 | 574.10        | 524.31           | 2746.4 (x5.2) |\r\n| mainnet/300000 | 1498.5        | 1529.3           | 8815.0 (x5.7) |\r\n\r\nMulti-threading (8 cores) (ms)\r\n\r\n| test           | LH (no_cache) | LH (empty_cache) | Lodestar |\r\n| -------------- | ------------- | ---------------- | -------- |\r\n| minimal/100000 | 531.99        | 227.35           | 3144.3   |\r\n| minimal/300000 | 1303.2        | 675.44           | 8547.3   |\r\n| mainnet/100000 | 479.16        | 267.50           | 2746.4   |\r\n| mainnet/300000 | 1417.3        | 711.00           | 8815.0   |\r\n\r\nNote on profiling: Doing a profile of hashing is not useful because the resolution is too low. By default the sampling is 1ms, while a fast sha256 implementation can do 1000 hashes in 1ms. I've tried setting [`--cpu-prof interval 1`](https://nodejs.org/api/cli.html#cli_cpu_prof_interval) to increase the sampling frequency x1000 but seems to have no effect on the resulting profile.\r\n",
  "closed_by": {
    "login": "dapplion",
    "id": 35266934,
    "node_id": "MDQ6VXNlcjM1MjY2OTM0",
    "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/dapplion",
    "html_url": "https://github.com/dapplion",
    "followers_url": "https://api.github.com/users/dapplion/followers",
    "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
    "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
    "organizations_url": "https://api.github.com/users/dapplion/orgs",
    "repos_url": "https://api.github.com/users/dapplion/repos",
    "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
    "received_events_url": "https://api.github.com/users/dapplion/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2206/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2206/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/802774949",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/2206#issuecomment-802774949",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2206",
    "id": 802774949,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwMjc3NDk0OQ==",
    "user": {
      "login": "dapplion",
      "id": 35266934,
      "node_id": "MDQ6VXNlcjM1MjY2OTM0",
      "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dapplion",
      "html_url": "https://github.com/dapplion",
      "followers_url": "https://api.github.com/users/dapplion/followers",
      "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
      "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
      "organizations_url": "https://api.github.com/users/dapplion/orgs",
      "repos_url": "https://api.github.com/users/dapplion/repos",
      "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dapplion/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-19T11:44:31Z",
    "updated_at": "2021-03-21T16:29:57Z",
    "author_association": "MEMBER",
    "body": "To profile our hashTreeRoot I've modified [`persistent-merkle-tree/hash.ts:4`](https://github.com/ChainSafe/persistent-merkle-tree/blob/44ec217a1531137ef9d9ebdd2fdf653559e3d4d6/src/hash.ts#L4) in three ways:\r\n| id | code | avg ms for mainnet/100000 (20 runs) |\r\n| -- | -- | -- |\r\n| original | `return SHA256.digest(Buffer.concat([a, b]));` | 2922.8\r\n| no concat | `return SHA256.digest(precomputed64b);` | 2615.6\r\n| no hash | `return a;` | 34.55\r\n\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/802774949/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/803615981",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/2206#issuecomment-803615981",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2206",
    "id": 803615981,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwMzYxNTk4MQ==",
    "user": {
      "login": "dapplion",
      "id": 35266934,
      "node_id": "MDQ6VXNlcjM1MjY2OTM0",
      "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dapplion",
      "html_url": "https://github.com/dapplion",
      "followers_url": "https://api.github.com/users/dapplion/followers",
      "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
      "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
      "organizations_url": "https://api.github.com/users/dapplion/orgs",
      "repos_url": "https://api.github.com/users/dapplion/repos",
      "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dapplion/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-21T16:27:44Z",
    "updated_at": "2021-03-21T16:28:01Z",
    "author_association": "MEMBER",
    "body": "After more tests with different approaches seems that `Buffer.concat` is that fastest way to go. Alternatives:\r\n\r\n- Writing roots a, b directly to the wasm memory buffer.\r\n\r\nHas almost same performance if not a bit worse, +5%.\r\nI have not tested memory efficiency between both approaches\r\n\r\n```ts\r\nupdateRoot(a, b) {\r\n    const INPUT_LENGTH = this.ctx.INPUT_LENGTH;\r\n    const input = new Uint8Array(this.ctx.memory.buffer, this.ctx.input.value, INPUT_LENGTH);\r\n    input.set(a);\r\n    input.set(b, 32);\r\n    this.ctx.update(this.ctx.input.value, 64);\r\n    return this;\r\n}\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/803615981/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/803616424",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/2206#issuecomment-803616424",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2206",
    "id": 803616424,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwMzYxNjQyNA==",
    "user": {
      "login": "dapplion",
      "id": 35266934,
      "node_id": "MDQ6VXNlcjM1MjY2OTM0",
      "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dapplion",
      "html_url": "https://github.com/dapplion",
      "followers_url": "https://api.github.com/users/dapplion/followers",
      "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
      "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
      "organizations_url": "https://api.github.com/users/dapplion/orgs",
      "repos_url": "https://api.github.com/users/dapplion/repos",
      "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dapplion/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-21T16:29:47Z",
    "updated_at": "2021-03-21T16:30:44Z",
    "author_association": "MEMBER",
    "body": "Just as curiosity I compared as-sha256 with bcrypto/sha256, by reverting this commit https://github.com/ChainSafe/persistent-merkle-tree/commit/8460f034ac56ae3443ef30164f77c308c7aa440e\r\n| lib | avg ms for mainnet/100000 (20 runs) |\r\n| -- | -- |\r\n| as-sha256 + concat | 2862.8 |\r\n| bcrypto + concat | 2114.85 |",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/803616424/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/803647940",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/2206#issuecomment-803647940",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2206",
    "id": 803647940,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwMzY0Nzk0MA==",
    "user": {
      "login": "dapplion",
      "id": 35266934,
      "node_id": "MDQ6VXNlcjM1MjY2OTM0",
      "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dapplion",
      "html_url": "https://github.com/dapplion",
      "followers_url": "https://api.github.com/users/dapplion/followers",
      "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
      "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
      "organizations_url": "https://api.github.com/users/dapplion/orgs",
      "repos_url": "https://api.github.com/users/dapplion/repos",
      "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dapplion/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-21T19:41:49Z",
    "updated_at": "2021-03-26T08:03:24Z",
    "author_association": "MEMBER",
    "body": "Benchmarked Lighthouse's hashing lib `ring` in my environment:\r\n```rust\r\nlet start = ProcessTime::now();\r\nfor i in 0..1000000 {\r\n    let res = hash32_concat(&hash_a, &hash_b);\r\n}\r\nlet cpu_time: Duration = start.elapsed();\r\nprintln!(\" {:?}\", cpu_time);\r\n```\r\n\r\nResults compared to JS to concat 2 32bytes + hash:\r\n- Rust `ring`: 2.41 sec for 1000000 hashes: 2.41 μs / hash32_concat.\r\n- JS `as-sha256`: 2.47 sec for 1000000 hashes: 2.47 μs / hash32_concat.\r\n\r\nSo the concat + hash power is the same.\r\n\r\nI've counted the num of hashes computed in each node to get the root of genesis-mainnet-100000 (15587377 bytes)\r\n- Lodestar: 1009104 calls to persistent-merkle-tree.hash()\r\n- Lighthouse: 1309081 calls to hash() (400000) and hash32_concat() (909081)\r\n\r\nIn Lodestar case the numbers are consistent with the hashing power:\r\n- JS as-sha256: 2.77 μs / hash (genesis-mainnet-100000: 1009104 hashes, 2800ms)\r\n- JS bcrypto: 2.08 μs / hash (genesis-mainnet-100000: 1009104 hashes, 2100ms)\r\n\r\nThen, how can Lighthouse compute the root of the state x5 times faster if the hashing function is not faster, and appears to compute a similar number of hashes? Note that my knowledge of the inner workings of Lighthouse's libs is limited, so I must be missing something. However:\r\n\r\n- I've added some `println!()` in Lighthouse and they have 0 cache hits in their cache arena.\r\n- I've run all tests and benchmarks with `taskset -c 0 <command>` to force single core\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/803647940/reactions",
      "total_count": 2,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 2
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/853235016",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/2206#issuecomment-853235016",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2206",
    "id": 853235016,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg1MzIzNTAxNg==",
    "user": {
      "login": "stale[bot]",
      "id": 26384082,
      "node_id": "MDM6Qm90MjYzODQwODI=",
      "avatar_url": "https://avatars.githubusercontent.com/in/1724?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/stale%5Bbot%5D",
      "html_url": "https://github.com/apps/stale",
      "followers_url": "https://api.github.com/users/stale%5Bbot%5D/followers",
      "following_url": "https://api.github.com/users/stale%5Bbot%5D/following{/other_user}",
      "gists_url": "https://api.github.com/users/stale%5Bbot%5D/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/stale%5Bbot%5D/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/stale%5Bbot%5D/subscriptions",
      "organizations_url": "https://api.github.com/users/stale%5Bbot%5D/orgs",
      "repos_url": "https://api.github.com/users/stale%5Bbot%5D/repos",
      "events_url": "https://api.github.com/users/stale%5Bbot%5D/events{/privacy}",
      "received_events_url": "https://api.github.com/users/stale%5Bbot%5D/received_events",
      "type": "Bot",
      "site_admin": false
    },
    "created_at": "2021-06-02T17:18:40Z",
    "updated_at": "2021-06-02T17:18:40Z",
    "author_association": "NONE",
    "body": "This issue has been automatically marked as stale because it has not had recent activity. It will be closed in 15 days if no further activity occurs. Thank you for your contributions.\n",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/853235016/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/853661175",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/2206#issuecomment-853661175",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2206",
    "id": 853661175,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg1MzY2MTE3NQ==",
    "user": {
      "login": "dapplion",
      "id": 35266934,
      "node_id": "MDQ6VXNlcjM1MjY2OTM0",
      "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dapplion",
      "html_url": "https://github.com/dapplion",
      "followers_url": "https://api.github.com/users/dapplion/followers",
      "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
      "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
      "organizations_url": "https://api.github.com/users/dapplion/orgs",
      "repos_url": "https://api.github.com/users/dapplion/repos",
      "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dapplion/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-06-03T07:49:38Z",
    "updated_at": "2021-06-03T07:49:38Z",
    "author_association": "MEMBER",
    "body": "Assigning to me so it doesn't get closed. I stopped the tests on the previous comment, if anyone wants to continue investigating, go for it.",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/853661175/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1564595264",
    "html_url": "https://github.com/ChainSafe/lodestar/issues/2206#issuecomment-1564595264",
    "issue_url": "https://api.github.com/repos/ChainSafe/lodestar/issues/2206",
    "id": 1564595264,
    "node_id": "IC_kwDOCD5_Gc5dQdRA",
    "user": {
      "login": "dapplion",
      "id": 35266934,
      "node_id": "MDQ6VXNlcjM1MjY2OTM0",
      "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dapplion",
      "html_url": "https://github.com/dapplion",
      "followers_url": "https://api.github.com/users/dapplion/followers",
      "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
      "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
      "organizations_url": "https://api.github.com/users/dapplion/orgs",
      "repos_url": "https://api.github.com/users/dapplion/repos",
      "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dapplion/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-26T15:52:10Z",
    "updated_at": "2023-05-26T15:52:10Z",
    "author_association": "MEMBER",
    "body": "Closing since this issue has no actionable items",
    "reactions": {
      "url": "https://api.github.com/repos/ChainSafe/lodestar/issues/comments/1564595264/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
