{
  "url": "https://api.github.com/repos/hyperledger/besu/issues/3389",
  "repository_url": "https://api.github.com/repos/hyperledger/besu",
  "labels_url": "https://api.github.com/repos/hyperledger/besu/issues/3389/labels{/name}",
  "comments_url": "https://api.github.com/repos/hyperledger/besu/issues/3389/comments",
  "events_url": "https://api.github.com/repos/hyperledger/besu/issues/3389/events",
  "html_url": "https://github.com/hyperledger/besu/issues/3389",
  "id": 1126908422,
  "node_id": "I_kwDODE2jmc5DK0IG",
  "number": 3389,
  "title": "contract address in receipt even when deployment fails",
  "user": {
    "login": "macfarla",
    "id": 2627919,
    "node_id": "MDQ6VXNlcjI2Mjc5MTk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2627919?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/macfarla",
    "html_url": "https://github.com/macfarla",
    "followers_url": "https://api.github.com/users/macfarla/followers",
    "following_url": "https://api.github.com/users/macfarla/following{/other_user}",
    "gists_url": "https://api.github.com/users/macfarla/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/macfarla/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/macfarla/subscriptions",
    "organizations_url": "https://api.github.com/users/macfarla/orgs",
    "repos_url": "https://api.github.com/users/macfarla/repos",
    "events_url": "https://api.github.com/users/macfarla/events{/privacy}",
    "received_events_url": "https://api.github.com/users/macfarla/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 2129007612,
      "node_id": "MDU6TGFiZWwyMTI5MDA3NjEy",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/dev%20experience",
      "name": "dev experience",
      "color": "2a0b89",
      "default": false,
      "description": "The build system, things that enable easier development etc."
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2022-02-08T07:55:36Z",
  "updated_at": "2022-02-28T06:20:34Z",
  "closed_at": "2022-02-09T02:47:52Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "### Description\r\nAs a Besu user, I want the contract address to be null so that it is clear that the contract creation fails. \r\n\r\n### Acceptance Criteria\r\n* When the installation of the smart contract fails for any reason, the contractAddress in the tx receipt should be null.\r\n\r\n### Steps to Reproduce (Bug)\r\nNeed to turn on TRACE logging to see the relevant error in Besu logs\r\nsend a garbage tx (eg I sent this via EthSigner)\r\n```\r\n{\r\n  \"jsonrpc\": \"2.0\",\r\n  \"method\": \"eth_sendTransaction\",\r\n  \"params\": [{\r\n  \t\"from\": \"0xfe3b557e8fb62b89f4916b721be55ceb828dbd73\",\r\n  \t\"data\": \"0x0x36303830363034303532333438303135363130303130353736303030383066643562353036313036343938303631303032303630303033393630303066336665363038303630343035323334383031353631303031303537363030303830666435623530363030343336313036313030333635373630303033353630653031633830363362303531646133333134363130303362353738303633636339366663326231343631303036623537356236303030383066643562363130303535363030343830333630333831303139303631303035303931393036313033346335363562363130303962353635623630343035313631303036323931393036313034333635363562363034303531383039313033393066333562363130303835363030343830333630333831303139303631303038303931393036313032666635363562363130313537353635623630343035313631303039323931393036313034316235363562363034303531383039313033393066333562363030303831383035313630323038313031383230313830353138343832353236303230383330313630323038353031323038313833353238303935353035303530353035303530363030303931353039303530383036303030303138303534363130306434393036313035323335363562383036\",\r\n      \"gasPrice\": \"0x03e8\",\r\n  \t\"gas\": \"0xfffff\"\r\n  }],\r\n  \"id\": 1\r\n}\r\n```\r\nthen check the tx receipt\r\neg\r\n```\r\n{\r\n  \"id\": 1,\r\n  \"jsonrpc\": \"2.0\",\r\n  \"method\": \"eth_getTransactionReceipt\",\r\n  \"params\": [\r\n  \t\"{{transactionHash}}\"\r\n  ]\r\n}\r\n```\r\nnote the contractAddress in the receipt (and if you call eth_getCode there isn't any code at that address), and the status 0x0 meaning failed\r\n```\r\n{\r\n    \"jsonrpc\": \"2.0\",\r\n    \"id\": 1,\r\n    \"result\": {\r\n        \"blockHash\": \"0x9ffb2dbd3dcb95244d69ad102f1389fb03b148434bee639860eede755944904f\",\r\n        \"blockNumber\": \"0xf8\",\r\n        \"contractAddress\": \"0x9a3dbca554e9f6b9257aaa24010da8377c57c17e\",\r\n        \"cumulativeGasUsed\": \"0xfffff\",\r\n        \"from\": \"0xfe3b557e8fb62b89f4916b721be55ceb828dbd73\",\r\n        \"gasUsed\": \"0xfffff\",\r\n        \"effectiveGasPrice\": \"0x3e8\",\r\n        \"logs\": [],\r\n        \"logsBloom\": \"0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\",\r\n        \"status\": \"0x0\",\r\n        \"to\": null,\r\n        \"transactionHash\": \"0x15fa782b878633af922a233d75c960096c2294cc2d5ba8600ede98dc7919619c\",\r\n        \"transactionIndex\": \"0x0\"\r\n    }\r\n}\r\n```\r\n\r\n2022-02-08 17:46:42.354+10:00 | pool-7-thread-1 | TRACE | EVM | MessageFrame evaluation halted because of INSUFFICIENT_GAS\r\n2022-02-08 17:46:42.354+10:00 | pool-7-thread-1 | TRACE | MainnetTransactionProcessor | Gas used by transaction: 1048575, by message call/contract creation: 962051\r\n\r\n**Expected behavior:** [What you expect to happen]\r\n\r\n**Actual behavior:** [What actually happens]\r\n\r\n**Frequency:** [What percentage of the time does it occur?]\r\n\r\n### Versions (Add all that apply)\r\n* Software version: [`besu --version`]\r\n* besu/v22.1.0-RC4-dev-3a718def/osx-x86_64/oracle_openjdk-java-11\r\n* Java version: [`java -version`]\r\n* openjdk version \"11.0.10\" 2021-01-19\r\nOpenJDK Runtime Environment (build 11.0.10+9)\r\nOpenJDK 64-Bit Server VM (build 11.0.10+9, mixed mode)\r\n* Kernel Version: [`uname -a`]\r\n* Darwin Kernel Version 21.2.0: Sun Nov 28 20:28:54 PST 2021; root:xnu-8019.61.5~1/RELEASE_X86_64 x86_64\r\n",
  "closed_by": {
    "login": "macfarla",
    "id": 2627919,
    "node_id": "MDQ6VXNlcjI2Mjc5MTk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2627919?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/macfarla",
    "html_url": "https://github.com/macfarla",
    "followers_url": "https://api.github.com/users/macfarla/followers",
    "following_url": "https://api.github.com/users/macfarla/following{/other_user}",
    "gists_url": "https://api.github.com/users/macfarla/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/macfarla/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/macfarla/subscriptions",
    "organizations_url": "https://api.github.com/users/macfarla/orgs",
    "repos_url": "https://api.github.com/users/macfarla/repos",
    "events_url": "https://api.github.com/users/macfarla/events{/privacy}",
    "received_events_url": "https://api.github.com/users/macfarla/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/3389/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/hyperledger/besu/issues/3389/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1033288368",
    "html_url": "https://github.com/hyperledger/besu/issues/3389#issuecomment-1033288368",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/3389",
    "id": 1033288368,
    "node_id": "IC_kwDODE2jmc49lrqw",
    "user": {
      "login": "macfarla",
      "id": 2627919,
      "node_id": "MDQ6VXNlcjI2Mjc5MTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2627919?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/macfarla",
      "html_url": "https://github.com/macfarla",
      "followers_url": "https://api.github.com/users/macfarla/followers",
      "following_url": "https://api.github.com/users/macfarla/following{/other_user}",
      "gists_url": "https://api.github.com/users/macfarla/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/macfarla/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/macfarla/subscriptions",
      "organizations_url": "https://api.github.com/users/macfarla/orgs",
      "repos_url": "https://api.github.com/users/macfarla/repos",
      "events_url": "https://api.github.com/users/macfarla/events{/privacy}",
      "received_events_url": "https://api.github.com/users/macfarla/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-02-09T02:47:52Z",
    "updated_at": "2022-02-09T02:47:52Z",
    "author_association": "CONTRIBUTOR",
    "body": "turns out this is a feature not a bug (or at least a bug that we can fix). I can see why the actual behaviour is confusing, but it's what other clients do and we have to match them. Besu can't change what is in the transaction receipt because it would change the state root and break interop with other clients.\r\nSo the workaround is to always check the status of the transaction receipt, and if it is failed ie 0x0 then you can't send transactions to that address.",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1033288368/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
