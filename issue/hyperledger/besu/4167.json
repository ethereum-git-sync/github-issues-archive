{
  "url": "https://api.github.com/repos/hyperledger/besu/issues/4167",
  "repository_url": "https://api.github.com/repos/hyperledger/besu",
  "labels_url": "https://api.github.com/repos/hyperledger/besu/issues/4167/labels{/name}",
  "comments_url": "https://api.github.com/repos/hyperledger/besu/issues/4167/comments",
  "events_url": "https://api.github.com/repos/hyperledger/besu/issues/4167/events",
  "html_url": "https://github.com/hyperledger/besu/issues/4167",
  "id": 1318118093,
  "node_id": "I_kwDODE2jmc5OkOLN",
  "number": 4167,
  "title": "Reference tests loopMul failure",
  "user": {
    "login": "Filter94",
    "id": 4833306,
    "node_id": "MDQ6VXNlcjQ4MzMzMDY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4833306?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Filter94",
    "html_url": "https://github.com/Filter94",
    "followers_url": "https://api.github.com/users/Filter94/followers",
    "following_url": "https://api.github.com/users/Filter94/following{/other_user}",
    "gists_url": "https://api.github.com/users/Filter94/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Filter94/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Filter94/subscriptions",
    "organizations_url": "https://api.github.com/users/Filter94/orgs",
    "repos_url": "https://api.github.com/users/Filter94/repos",
    "events_url": "https://api.github.com/users/Filter94/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Filter94/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2022-07-26T11:42:33Z",
  "updated_at": "2022-07-26T18:18:10Z",
  "closed_at": "2022-07-26T18:18:10Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "### Description\r\nI've re-implemented retesteth tests executor for our usecase and the only test failing is `vmPerformance/loopMul`, same as on retesteth's website\r\n\r\nI did the analysis of why it happens using debugger and I found the following:\r\n1. Gas limit is [set](https://github.com/ethereum/tests/blob/develop/GeneralStateTests/VMTests/vmPerformance/loopMul.json#L22) to `Long.MAX_VALUE` in the genesis file\r\n2. Transaction's expected gasLimit is [set](https://github.com/ethereum/tests/blob/develop/GeneralStateTests/VMTests/vmPerformance/loopMul.json#L181) to the same value\r\n3. When a new block is mined by `test_mineBlocks` method, gas calculator is trying to get closer to the desired gas limit, which is [hardcoded](https://github.com/hyperledger/besu/blob/main/ethereum/retesteth/src/main/java/org/hyperledger/besu/ethereum/retesteth/methods/TestMineBlocks.java#L67) to 10M\r\n4. Since parent's (genesis file) gas limit is higher than the target gas limit, gas limit for the next block is set as `Long.MAX_VALUE` - `AbstractGasLimitSpecification.DEFAULT_MAX_CONSTANT_ADMUSTMENT_INCREMENT` which is less than transaction's gas limit.\r\n5. Transaction is not included in the block, the mined block doesn't contain the expected transaction\r\n\r\n### Steps to Reproduce (Bug)\r\n1. Run retesteth with `besu -t GeneralStateTests -- --all --lowcpu -j1`, as specified [here](http://retesteth.ethdevops.io/). More info on retesteth [here](https://github.com/ethereum/retesteth) \r\n\r\n**Expected behavior:** \r\n`vmPerformance/loopMul` test should pass\r\n\r\n**Actual behavior:**\r\nIt [fails](http://retesteth.ethdevops.io/results/log//2022-07-25-1658776833-besu.txt) with \r\n```\r\n[0;31mError: StateTest::FillTest: TR hash not found in mined block! (Check that tr is properly mined and not oog)\u001B[33m (vmPerformance/loopMul, fork: Berlin, TrInfo: d: 0, g: 0, v: 0, TrData: `:label add-10M\r\n```\r\n\r\n**Proposed solution:**\r\nInstead of using the hardcoded value of 10M we can\r\n1. Use Long.MAX_VALUE instead so gas limit calculation always would took a step upwards which would make the tests more permissive in terms of gas limit\r\n2. Take gas limit from `blockchain.getChainHeadHeader().getGasLimit()` which would make gas limit constant for a test chain from block to block and equal to the value in genesis file. This option makes more sense to me.\r\n\r\n**Frequency:**\r\nThis issue is not flacky. It happens all the time\r\n\r\n### Versions (Add all that apply)\r\n* Software version: 22.4.1\r\n* OS Name & Version: Whatever is in Besu's docker image (hyperledger/besu:develop-openjdk-latest)\r\n* Docker Version: 20.10.17\r\n\r\n### Additional Information (Add any of the following or anything else that may be relevant)\r\n* Besu setup info - reference tests setup\r\n* System info - 4 Cores (8 hyperthreaded) 2.4 hz Intel i7, 32 GB RAM\r\n",
  "closed_by": {
    "login": "jflo",
    "id": 345937,
    "node_id": "MDQ6VXNlcjM0NTkzNw==",
    "avatar_url": "https://avatars.githubusercontent.com/u/345937?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jflo",
    "html_url": "https://github.com/jflo",
    "followers_url": "https://api.github.com/users/jflo/followers",
    "following_url": "https://api.github.com/users/jflo/following{/other_user}",
    "gists_url": "https://api.github.com/users/jflo/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jflo/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jflo/subscriptions",
    "organizations_url": "https://api.github.com/users/jflo/orgs",
    "repos_url": "https://api.github.com/users/jflo/repos",
    "events_url": "https://api.github.com/users/jflo/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jflo/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/4167/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/hyperledger/besu/issues/4167/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1195565916",
    "html_url": "https://github.com/hyperledger/besu/issues/4167#issuecomment-1195565916",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/4167",
    "id": 1195565916,
    "node_id": "IC_kwDODE2jmc5HQuNc",
    "user": {
      "login": "shemnon",
      "id": 38109,
      "node_id": "MDQ6VXNlcjM4MTA5",
      "avatar_url": "https://avatars.githubusercontent.com/u/38109?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/shemnon",
      "html_url": "https://github.com/shemnon",
      "followers_url": "https://api.github.com/users/shemnon/followers",
      "following_url": "https://api.github.com/users/shemnon/following{/other_user}",
      "gists_url": "https://api.github.com/users/shemnon/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/shemnon/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/shemnon/subscriptions",
      "organizations_url": "https://api.github.com/users/shemnon/orgs",
      "repos_url": "https://api.github.com/users/shemnon/repos",
      "events_url": "https://api.github.com/users/shemnon/events{/privacy}",
      "received_events_url": "https://api.github.com/users/shemnon/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-26T14:34:51Z",
    "updated_at": "2022-07-26T14:34:51Z",
    "author_association": "MEMBER",
    "body": "Sounds reasonable.  I prefer #2, where the gas limit comes from the `gasLimit` in the genesis block of the test or `currentGasLimit` from the env where the test is not block based.  This opens up the tests to test behavior when gas limits are violated, setting it to Long.MAX_VALUE prevents block OOG from tripping.",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1195565916/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1195657023",
    "html_url": "https://github.com/hyperledger/besu/issues/4167#issuecomment-1195657023",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/4167",
    "id": 1195657023,
    "node_id": "IC_kwDODE2jmc5HREc_",
    "user": {
      "login": "Filter94",
      "id": 4833306,
      "node_id": "MDQ6VXNlcjQ4MzMzMDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4833306?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Filter94",
      "html_url": "https://github.com/Filter94",
      "followers_url": "https://api.github.com/users/Filter94/followers",
      "following_url": "https://api.github.com/users/Filter94/following{/other_user}",
      "gists_url": "https://api.github.com/users/Filter94/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Filter94/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Filter94/subscriptions",
      "organizations_url": "https://api.github.com/users/Filter94/orgs",
      "repos_url": "https://api.github.com/users/Filter94/repos",
      "events_url": "https://api.github.com/users/Filter94/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Filter94/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-26T15:48:32Z",
    "updated_at": "2022-07-26T15:48:32Z",
    "author_association": "CONTRIBUTOR",
    "body": "@shemnon The PR is ready, please take a look",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1195657023/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
