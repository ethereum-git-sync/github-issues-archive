{
  "url": "https://api.github.com/repos/hyperledger/besu/issues/4117",
  "repository_url": "https://api.github.com/repos/hyperledger/besu",
  "labels_url": "https://api.github.com/repos/hyperledger/besu/issues/4117/labels{/name}",
  "comments_url": "https://api.github.com/repos/hyperledger/besu/issues/4117/comments",
  "events_url": "https://api.github.com/repos/hyperledger/besu/issues/4117/events",
  "html_url": "https://github.com/hyperledger/besu/issues/4117",
  "id": 1306752345,
  "node_id": "I_kwDODE2jmc5N43VZ",
  "number": 4117,
  "title": "ThreadBlocked checking ancestorIsValidTerminalProofOfWork ",
  "user": {
    "login": "garyschulte",
    "id": 1238512,
    "node_id": "MDQ6VXNlcjEyMzg1MTI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1238512?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/garyschulte",
    "html_url": "https://github.com/garyschulte",
    "followers_url": "https://api.github.com/users/garyschulte/followers",
    "following_url": "https://api.github.com/users/garyschulte/following{/other_user}",
    "gists_url": "https://api.github.com/users/garyschulte/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/garyschulte/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/garyschulte/subscriptions",
    "organizations_url": "https://api.github.com/users/garyschulte/orgs",
    "repos_url": "https://api.github.com/users/garyschulte/repos",
    "events_url": "https://api.github.com/users/garyschulte/events{/privacy}",
    "received_events_url": "https://api.github.com/users/garyschulte/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3013559202,
      "node_id": "MDU6TGFiZWwzMDEzNTU5MjAy",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/mainnet",
      "name": "mainnet",
      "color": "9D578C",
      "default": false,
      "description": ""
    },
    {
      "id": 4328706977,
      "node_id": "LA_kwDODE2jmc8AAAABAgLToQ",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/TeamChupa",
      "name": "TeamChupa",
      "color": "fbca04",
      "default": false,
      "description": "GH issues worked on by Chupacabara Team"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "garyschulte",
    "id": 1238512,
    "node_id": "MDQ6VXNlcjEyMzg1MTI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1238512?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/garyschulte",
    "html_url": "https://github.com/garyschulte",
    "followers_url": "https://api.github.com/users/garyschulte/followers",
    "following_url": "https://api.github.com/users/garyschulte/following{/other_user}",
    "gists_url": "https://api.github.com/users/garyschulte/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/garyschulte/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/garyschulte/subscriptions",
    "organizations_url": "https://api.github.com/users/garyschulte/orgs",
    "repos_url": "https://api.github.com/users/garyschulte/repos",
    "events_url": "https://api.github.com/users/garyschulte/events{/privacy}",
    "received_events_url": "https://api.github.com/users/garyschulte/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "garyschulte",
      "id": 1238512,
      "node_id": "MDQ6VXNlcjEyMzg1MTI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1238512?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/garyschulte",
      "html_url": "https://github.com/garyschulte",
      "followers_url": "https://api.github.com/users/garyschulte/followers",
      "following_url": "https://api.github.com/users/garyschulte/following{/other_user}",
      "gists_url": "https://api.github.com/users/garyschulte/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/garyschulte/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/garyschulte/subscriptions",
      "organizations_url": "https://api.github.com/users/garyschulte/orgs",
      "repos_url": "https://api.github.com/users/garyschulte/repos",
      "events_url": "https://api.github.com/users/garyschulte/events{/privacy}",
      "received_events_url": "https://api.github.com/users/garyschulte/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2022-07-16T08:56:35Z",
  "updated_at": "2022-11-07T17:00:57Z",
  "closed_at": "2022-11-07T17:00:57Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "<!-- Have you done the following? -->\n<!--   * read the Code of Conduct? By filing an Issue, you are expected to -->  \n<!--     comply with it, including treating everyone with respect: -->\n<!--     https://github.com/hyperledger/besu/blob/main/CODE_OF_CONDUCT.md -->\n<!--   * Reproduced the issue in the latest version of the software -->\n<!--   * Read the debugging docs: https://besu.hyperledger.org/en/stable/HowTo/Monitor/Logging/ -->\n<!--   * Duplicate Issue check:  https://github.com/search?q=+is%3Aissue+repo%3Ahyperledger/Besu -->\n<!-- Note:  Not all sections will apply to all issue types. -->\n\n### Description\nWhen fast syncing a post-merge network (fast, snap, or checkpoint) , there is a brief window where there is no finalized block.  During this time besu behaves the same way it does at merge transition, verifying newPayloads and forkchoice calls by ensuring the blocks descend from a valid terminal block.\n\nThis is a problem for post-merge networks, because following the chain back to TTD is more and more time consuming the further the chain is from the TTD block.  Besu will log lots of thread blocked warnings during this time while it follows the chain back to TTD:\n\n```\n{\"@timestamp\":\"2022-07-16T08:43:06,287\",\"level\":\"WARN\",\"thread\":\"vertx-blocked-thread-checker\",\"class\":\"BlockedThreadChecker\",\"message\":\"Thread Thread[vert.x-worker-thread-1,5,main] has been blocked for 101820 ms, time limit is 60000 ms\",\"throwable\":\" io.vertx.core.VertxException: Thread blocked\\n\\tat java.base@11.0.15/jdk.internal.misc.Unsafe.park(Native Method)\\n\\tat java.base@11.0.15/java.util.concurrent.locks.LockSupport.park(LockSupport.java:194)\\n\\tat java.base@11.0.15/java.util.concurrent.CompletableFuture$Signaller.block(CompletableFuture.java:1796)\\n\\tat java.base@11.0.15/java.util.concurrent.ForkJoinPool.managedBlock(ForkJoinPool.java:3128)\\n\\tat java.base@11.0.15/java.util.concurrent.CompletableFuture.waitingGet(CompletableFuture.java:1823)\\n\\tat java.base@11.0.15/java.util.concurrent.CompletableFuture.get(CompletableFuture.java:1998)\\n\\tat app//org.hyperledger.besu.ethereum.api.jsonrpc.internal.methods.ExecutionEngineJsonRpcMethod.response(ExecutionEngineJsonRpcMethod.java:78)\\n\\tat app//org.hyperledger.besu.ethereum.api.jsonrpc.execution.BaseJsonRpcProcessor.process(BaseJsonRpcProcessor.java:42)\\n\\tat app//org.hyperledger.besu.ethereum.api.jsonrpc.execution.TracedJsonRpcProcessor.process(TracedJsonRpcProcessor.java:41)\\n\\tat app//org.hyperledger.besu.ethereum.api.jsonrpc.execution.TimedJsonRpcProcessor.process(TimedJsonRpcProcessor.java:45)\\n\\tat app//org.hyperledger.besu.ethereum.api.jsonrpc.execution.AuthenticatedJsonRpcProcessor.process(AuthenticatedJsonRpcProcessor.java:51)\\n\\tat app//org.hyperledger.besu.ethereum.api.jsonrpc.execution.JsonRpcExecutor.execute(JsonRpcExecutor.java:91)\\n\\tat app//org.hyperledger.besu.ethereum.api.handlers.JsonRpcExecutorHandler.lambda$handler$6(JsonRpcExecutorHandler.java:76)\\n\\tat app//org.hyperledger.besu.ethereum.api.handlers.JsonRpcExecutorHandler$$Lambda$1150/0x00000008006f1c40.handle(Unknown Source)\\n\\tat app//io.vertx.ext.web.impl.BlockingHandlerDecorator.lambda$handle$0(BlockingHandlerDecorator.java:48)\\n\\tat app//io.vertx.ext.web.impl.BlockingHandlerDecorator$$Lambda$1481/0x000000080081a840.handle(Unknown Source)\\n\\tat app//io.vertx.core.impl.ContextImpl.lambda$null$0(ContextImpl.java:159)\\n\\tat app//io.vertx.core.impl.ContextImpl$$Lambda$1357/0x00000008007a1c40.handle(Unknown Source)\\n\\tat app//io.vertx.core.impl.AbstractContext.dispatch(AbstractContext.java:100)\\n\\tat app//io.vertx.core.impl.ContextImpl.lambda$executeBlocking$1(ContextImpl.java:157)\\n\\tat app//io.vertx.core.impl.ContextImpl$$Lambda$1349/0x00000008007a3c40.run(Unknown Source)\\n\\tat app//io.vertx.core.impl.TaskQueue.run(TaskQueue.java:76)\\n\\tat app//io.vertx.core.impl.TaskQueue$$Lambda$726/0x0000000800594c40.run(Unknown Source)\\n\\tat java.base@11.0.15/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)\\n\\tat java.base@11.0.15/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)\\n\\tat app//io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\\n\\tat java.base@11.0.15/java.lang.Thread.run(Thread.java:829)\\n\"}\n```\n\n\n\n### Acceptance Criteria\n* besu should be able to quickly determine that a fast sync pivot descends from a valid TTD block\n* besu should not log excessive thread blocked errors\n\n### Steps to Reproduce (Bug)\n1. snap, fast or checkpoint sync ropsten\n\n**Expected behavior:** [What you expect to happen]\nfast sync completes, backward sync completes, and besu is immediately ready to serve CL requests\n\n**Actual behavior:** [What actually happens]\nOn ropsten, besu will emit blocked thread exceptions for ~ 2 minutes while it walks the chain back to TTD\n\n**Frequency:** [What percentage of the time does it occur?]\n\n### Versions (Add all that apply)\n* Software version: 22.7.0-RC2-SNAPSHOT\n",
  "closed_by": {
    "login": "garyschulte",
    "id": 1238512,
    "node_id": "MDQ6VXNlcjEyMzg1MTI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1238512?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/garyschulte",
    "html_url": "https://github.com/garyschulte",
    "followers_url": "https://api.github.com/users/garyschulte/followers",
    "following_url": "https://api.github.com/users/garyschulte/following{/other_user}",
    "gists_url": "https://api.github.com/users/garyschulte/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/garyschulte/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/garyschulte/subscriptions",
    "organizations_url": "https://api.github.com/users/garyschulte/orgs",
    "repos_url": "https://api.github.com/users/garyschulte/repos",
    "events_url": "https://api.github.com/users/garyschulte/events{/privacy}",
    "received_events_url": "https://api.github.com/users/garyschulte/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/4117/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/hyperledger/besu/issues/4117/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1305911246",
    "html_url": "https://github.com/hyperledger/besu/issues/4117#issuecomment-1305911246",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/4117",
    "id": 1305911246,
    "node_id": "IC_kwDODE2jmc5N1p_O",
    "user": {
      "login": "garyschulte",
      "id": 1238512,
      "node_id": "MDQ6VXNlcjEyMzg1MTI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1238512?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/garyschulte",
      "html_url": "https://github.com/garyschulte",
      "followers_url": "https://api.github.com/users/garyschulte/followers",
      "following_url": "https://api.github.com/users/garyschulte/following{/other_user}",
      "gists_url": "https://api.github.com/users/garyschulte/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/garyschulte/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/garyschulte/subscriptions",
      "organizations_url": "https://api.github.com/users/garyschulte/orgs",
      "repos_url": "https://api.github.com/users/garyschulte/repos",
      "events_url": "https://api.github.com/users/garyschulte/events{/privacy}",
      "received_events_url": "https://api.github.com/users/garyschulte/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-11-07T17:00:57Z",
    "updated_at": "2022-11-07T17:00:57Z",
    "author_association": "CONTRIBUTOR",
    "body": "closed as stale, fast sync post merge has been reworked since this issue was filed",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1305911246/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
