{
  "url": "https://api.github.com/repos/hyperledger/besu/issues/5796",
  "repository_url": "https://api.github.com/repos/hyperledger/besu",
  "labels_url": "https://api.github.com/repos/hyperledger/besu/issues/5796/labels{/name}",
  "comments_url": "https://api.github.com/repos/hyperledger/besu/issues/5796/comments",
  "events_url": "https://api.github.com/repos/hyperledger/besu/issues/5796/events",
  "html_url": "https://github.com/hyperledger/besu/issues/5796",
  "id": 1865286099,
  "node_id": "I_kwDODE2jmc5vLgHT",
  "number": 5796,
  "title": "Bugs causing high memory usage",
  "user": {
    "login": "RogerHKW",
    "id": 135605677,
    "node_id": "U_kgDOCBUtrQ",
    "avatar_url": "https://avatars.githubusercontent.com/u/135605677?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/RogerHKW",
    "html_url": "https://github.com/RogerHKW",
    "followers_url": "https://api.github.com/users/RogerHKW/followers",
    "following_url": "https://api.github.com/users/RogerHKW/following{/other_user}",
    "gists_url": "https://api.github.com/users/RogerHKW/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/RogerHKW/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/RogerHKW/subscriptions",
    "organizations_url": "https://api.github.com/users/RogerHKW/orgs",
    "repos_url": "https://api.github.com/users/RogerHKW/repos",
    "events_url": "https://api.github.com/users/RogerHKW/events{/privacy}",
    "received_events_url": "https://api.github.com/users/RogerHKW/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1537362490,
      "node_id": "MDU6TGFiZWwxNTM3MzYyNDkw",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/bug",
      "name": "bug",
      "color": "d73a4a",
      "default": true,
      "description": "Something isn't working"
    },
    {
      "id": 3013559202,
      "node_id": "MDU6TGFiZWwzMDEzNTU5MjAy",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/mainnet",
      "name": "mainnet",
      "color": "9D578C",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2023-08-24T14:26:31Z",
  "updated_at": "2023-09-06T14:57:53Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "I was excited to install your new version, announced to fix \"bugs with memory usage\". Unfortunately the amount of memory that your software uses now is even worse than before.\n\nDespite the use of `-Xmx11G`, your previous versions were constantly using between 11 GB and 13 GB. Since the installation of version 23.7.1, my machine is totally clogged. Besu uses consistently 21 GB, leaving the absolute minimum to the kernel to work.\n\nMy configuration in `/etc/systemd/system/besu.service` :\n\n> [Unit]\nDescription=Besu Execution Client (Mainnet)\nWants=network-online.target\nAfter=network-online.target\n[Service]\nUser=besu\nGroup=besu\nType=simple\nRestart=always\nRestartSec=5\nEnvironment=\"JAVA_OPTS=-Xmx11G\"\nEnvironment=\"BESU_OPTS=-Xmx11G\"\nEnvironment=\"JAVA_OPTS=-XX:-HeapDumpOnOutOfMemoryError\"\nEnvironment=\"LD_PRELOAD=/usr/lib/x86_64-linux-gnu/libjemalloc.so\"\nExecStart=/usr/local/bin/besu/bin/besu \\\n  --network=mainnet \\\n  --sync-mode=X_SNAP \\\n  --data-path=/dev/data2TB/besu-mainnet \\\n  --data-storage-format=BONSAI \\\n  --engine-jwt-secret=/var/lib/jwtsecret/jwt.hex \\\n  --Xplugin-rocksdb-high-spec-enabled \\\n  --rpc-http-enabled \\\n  --rpc-http-api=ETH,NET,WEB3,TXPOOL \\\n  --tx-pool-max-size=65535 \\\n  --tx-pool-retention-hours=36 \\\n  --tx-pool-price-bump=2 \\\n  --tx-pool-enable-save-restore=true \\\n  --Xlayered-tx-pool=true \\\n  --Xlayered-tx-pool-max-prioritized=16384 \\\n  --Xlayered-tx-pool-layer-max-capacity=134217728 \\\n  --Xlayered-tx-pool-max-future-by-sender=8 \\\n  --max-peers=75\n[Install]\nWantedBy=multi-user.target\n\n**update**: After setting `vm.vfs_cache_pressure` to 33 (previously it was 66) and rebooting, the memory consumption is back to what it was with the previous version. Still above the Xmx limit, but at least the computer is healthy.",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/5796/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/hyperledger/besu/issues/5796/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1695190675",
    "html_url": "https://github.com/hyperledger/besu/issues/5796#issuecomment-1695190675",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/5796",
    "id": 1695190675,
    "node_id": "IC_kwDODE2jmc5lCo6T",
    "user": {
      "login": "matkt",
      "id": 26581503,
      "node_id": "MDQ6VXNlcjI2NTgxNTAz",
      "avatar_url": "https://avatars.githubusercontent.com/u/26581503?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/matkt",
      "html_url": "https://github.com/matkt",
      "followers_url": "https://api.github.com/users/matkt/followers",
      "following_url": "https://api.github.com/users/matkt/following{/other_user}",
      "gists_url": "https://api.github.com/users/matkt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/matkt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/matkt/subscriptions",
      "organizations_url": "https://api.github.com/users/matkt/orgs",
      "repos_url": "https://api.github.com/users/matkt/repos",
      "events_url": "https://api.github.com/users/matkt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/matkt/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-08-28T07:40:00Z",
    "updated_at": "2023-08-28T07:40:00Z",
    "author_association": "CONTRIBUTOR",
    "body": "hello, thanks for your info. could you tell me what is your CL ?",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1695190675/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1695827013",
    "html_url": "https://github.com/hyperledger/besu/issues/5796#issuecomment-1695827013",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/5796",
    "id": 1695827013,
    "node_id": "IC_kwDODE2jmc5lFERF",
    "user": {
      "login": "RogerHKW",
      "id": 135605677,
      "node_id": "U_kgDOCBUtrQ",
      "avatar_url": "https://avatars.githubusercontent.com/u/135605677?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/RogerHKW",
      "html_url": "https://github.com/RogerHKW",
      "followers_url": "https://api.github.com/users/RogerHKW/followers",
      "following_url": "https://api.github.com/users/RogerHKW/following{/other_user}",
      "gists_url": "https://api.github.com/users/RogerHKW/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/RogerHKW/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/RogerHKW/subscriptions",
      "organizations_url": "https://api.github.com/users/RogerHKW/orgs",
      "repos_url": "https://api.github.com/users/RogerHKW/repos",
      "events_url": "https://api.github.com/users/RogerHKW/events{/privacy}",
      "received_events_url": "https://api.github.com/users/RogerHKW/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-08-28T14:43:01Z",
    "updated_at": "2023-08-28T14:43:01Z",
    "author_association": "NONE",
    "body": "> hello, thanks for your info. could you tell me what is your CL ?\n\nThanks for considering my report. This computer runs Teku. According to its self-reporting (that I visualize on the app _beaconcha.in_) Teku's RAM consumption stays always under its own Xmx limit (but is this self measure accurate?)",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1695827013/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1696498654",
    "html_url": "https://github.com/hyperledger/besu/issues/5796#issuecomment-1696498654",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/5796",
    "id": 1696498654,
    "node_id": "IC_kwDODE2jmc5lHoPe",
    "user": {
      "login": "non-fungible-nelson",
      "id": 85905982,
      "node_id": "MDQ6VXNlcjg1OTA1OTgy",
      "avatar_url": "https://avatars.githubusercontent.com/u/85905982?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/non-fungible-nelson",
      "html_url": "https://github.com/non-fungible-nelson",
      "followers_url": "https://api.github.com/users/non-fungible-nelson/followers",
      "following_url": "https://api.github.com/users/non-fungible-nelson/following{/other_user}",
      "gists_url": "https://api.github.com/users/non-fungible-nelson/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/non-fungible-nelson/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/non-fungible-nelson/subscriptions",
      "organizations_url": "https://api.github.com/users/non-fungible-nelson/orgs",
      "repos_url": "https://api.github.com/users/non-fungible-nelson/repos",
      "events_url": "https://api.github.com/users/non-fungible-nelson/events{/privacy}",
      "received_events_url": "https://api.github.com/users/non-fungible-nelson/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-08-28T22:14:03Z",
    "updated_at": "2023-08-28T22:14:03Z",
    "author_association": "CONTRIBUTOR",
    "body": "--Xplugin-rocksdb-high-spec-enabled\r\nRemove this flag and your usage should decrease. This plug-in allows Besu to gobble up a lot of off-heap memory. Removing this flag should reduce the overall footprint.",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1696498654/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1708537002",
    "html_url": "https://github.com/hyperledger/besu/issues/5796#issuecomment-1708537002",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/5796",
    "id": 1708537002,
    "node_id": "IC_kwDODE2jmc5l1jSq",
    "user": {
      "login": "ahamlat",
      "id": 5099602,
      "node_id": "MDQ6VXNlcjUwOTk2MDI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5099602?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ahamlat",
      "html_url": "https://github.com/ahamlat",
      "followers_url": "https://api.github.com/users/ahamlat/followers",
      "following_url": "https://api.github.com/users/ahamlat/following{/other_user}",
      "gists_url": "https://api.github.com/users/ahamlat/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ahamlat/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ahamlat/subscriptions",
      "organizations_url": "https://api.github.com/users/ahamlat/orgs",
      "repos_url": "https://api.github.com/users/ahamlat/repos",
      "events_url": "https://api.github.com/users/ahamlat/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ahamlat/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-09-06T14:57:53Z",
    "updated_at": "2023-09-06T14:57:53Z",
    "author_association": "CONTRIBUTOR",
    "body": "@RogerHKW To use less memory on Besu, you need to reduce -Xmx. If the node is already synced, I suggest to set your -Xmx to 4 GiB if your node is not used as an RPC node. I also recommend these GC options :\r\nexport BESU_OPTS=\"-XX:G1ConcRefinementThreads=2 -XX:G1HeapWastePercent=15 -XX:MaxGCPauseMillis=100\"\r\nWe're thinking of making these flags default.\r\nWith these options and high spec flag disabled, your Besu node will use less than 8 GiB",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1708537002/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
