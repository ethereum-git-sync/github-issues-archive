{
  "url": "https://api.github.com/repos/hyperledger/besu/issues/5348",
  "repository_url": "https://api.github.com/repos/hyperledger/besu",
  "labels_url": "https://api.github.com/repos/hyperledger/besu/issues/5348/labels{/name}",
  "comments_url": "https://api.github.com/repos/hyperledger/besu/issues/5348/comments",
  "events_url": "https://api.github.com/repos/hyperledger/besu/issues/5348/events",
  "html_url": "https://github.com/hyperledger/besu/issues/5348",
  "id": 1669183321,
  "node_id": "I_kwDODE2jmc5jfbdZ",
  "number": 5348,
  "title": "Besu uses 100 % CPU after losing the internet connection",
  "user": {
    "login": "ahamlat",
    "id": 5099602,
    "node_id": "MDQ6VXNlcjUwOTk2MDI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5099602?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ahamlat",
    "html_url": "https://github.com/ahamlat",
    "followers_url": "https://api.github.com/users/ahamlat/followers",
    "following_url": "https://api.github.com/users/ahamlat/following{/other_user}",
    "gists_url": "https://api.github.com/users/ahamlat/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ahamlat/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ahamlat/subscriptions",
    "organizations_url": "https://api.github.com/users/ahamlat/orgs",
    "repos_url": "https://api.github.com/users/ahamlat/repos",
    "events_url": "https://api.github.com/users/ahamlat/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ahamlat/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1537362490,
      "node_id": "MDU6TGFiZWwxNTM3MzYyNDkw",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/bug",
      "name": "bug",
      "color": "d73a4a",
      "default": true,
      "description": "Something isn't working"
    },
    {
      "id": 2051683573,
      "node_id": "MDU6TGFiZWwyMDUxNjgzNTcz",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/P3",
      "name": "P3",
      "color": "ffff00",
      "default": false,
      "description": "Medium (ex: JSON-RPC request not working with a specific client library due to loose spec assumtion)"
    },
    {
      "id": 3013559202,
      "node_id": "MDU6TGFiZWwzMDEzNTU5MjAy",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/mainnet",
      "name": "mainnet",
      "color": "9D578C",
      "default": false,
      "description": ""
    },
    {
      "id": 4328706977,
      "node_id": "LA_kwDODE2jmc8AAAABAgLToQ",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/TeamChupa",
      "name": "TeamChupa",
      "color": "fbca04",
      "default": false,
      "description": "GH issues worked on by Chupacabara Team"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": {
    "login": "ahamlat",
    "id": 5099602,
    "node_id": "MDQ6VXNlcjUwOTk2MDI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5099602?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ahamlat",
    "html_url": "https://github.com/ahamlat",
    "followers_url": "https://api.github.com/users/ahamlat/followers",
    "following_url": "https://api.github.com/users/ahamlat/following{/other_user}",
    "gists_url": "https://api.github.com/users/ahamlat/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ahamlat/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ahamlat/subscriptions",
    "organizations_url": "https://api.github.com/users/ahamlat/orgs",
    "repos_url": "https://api.github.com/users/ahamlat/repos",
    "events_url": "https://api.github.com/users/ahamlat/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ahamlat/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "ahamlat",
      "id": 5099602,
      "node_id": "MDQ6VXNlcjUwOTk2MDI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5099602?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ahamlat",
      "html_url": "https://github.com/ahamlat",
      "followers_url": "https://api.github.com/users/ahamlat/followers",
      "following_url": "https://api.github.com/users/ahamlat/following{/other_user}",
      "gists_url": "https://api.github.com/users/ahamlat/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ahamlat/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ahamlat/subscriptions",
      "organizations_url": "https://api.github.com/users/ahamlat/orgs",
      "repos_url": "https://api.github.com/users/ahamlat/repos",
      "events_url": "https://api.github.com/users/ahamlat/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ahamlat/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 8,
  "created_at": "2023-04-15T06:20:23Z",
  "updated_at": "2023-07-08T20:11:38Z",
  "closed_at": null,
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "<!-- Have you done the following? -->\r\n<!--   * read the Code of Conduct? By filing an Issue, you are expected to -->  \r\n<!--     comply with it, including treating everyone with respect: -->\r\n<!--     https://github.com/hyperledger/besu/blob/main/CODE_OF_CONDUCT.md -->\r\n<!--   * Reproduced the issue in the latest version of the software -->\r\n<!--   * Read the debugging docs: https://besu.hyperledger.org/en/stable/HowTo/Monitor/Logging/ -->\r\n<!--   * Duplicate Issue check:  https://github.com/search?q=+is%3Aissue+repo%3Ahyperledger/Besu -->\r\n<!-- Note:  Not all sections will apply to all issue types. -->\r\n\r\n### Description\r\nA discord user reported Besu consuming 100% CPU after restarting his router. \r\nRAM usage was affected too (from 5.19 to 11.7 GB of 32 GB total).\r\n\r\nBelow the logs shared by the user\r\n```\r\nrocketpool_eth1  |      at app//io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:997)\r\nrocketpool_eth1  |      at app//io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)\r\nrocketpool_eth1  |      at app//io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\r\nrocketpool_eth1  |      at java.base@17.0.6/java.lang.Thread.run(Thread.java:833)\r\nrocketpool_eth1  | 2023-04-14 22:33:32.190+00:00 | vert.x-eventloop-thread-0 | ERROR | ContextImpl | Unhandled exception\r\nrocketpool_eth1  | java.lang.OutOfMemoryError: Java heap space\r\nrocketpool_eth1  | 2023-04-14 22:33:18.618+00:00 | dnsjava NIO selector | ERROR | Besu | Uncaught exception in thread \"dnsjava NIO selector\"\r\nrocketpool_eth1  | java.lang.OutOfMemoryError: Java heap space\r\nrocketpool_eth1  |      at java.base/java.util.concurrent.ConcurrentHashMap$ValuesView.iterator(ConcurrentHashMap.java:4740)\r\nrocketpool_eth1  |      at org.xbill.DNS.NioTcpClient.checkTransactionTimeouts(NioTcpClient.java:53)\r\nrocketpool_eth1  |      at org.xbill.DNS.NioTcpClient$$Lambda$1006/0x000000080113d220.run(Unknown Source)\r\nrocketpool_eth1  |      at org.xbill.DNS.NioClient$$Lambda$1016/0x0000000801141950.accept(Unknown Source)\r\nrocketpool_eth1  |      at java.base/java.util.concurrent.CopyOnWriteArrayList.forEach(CopyOnWriteArrayList.java:807)\r\nrocketpool_eth1  |      at org.xbill.DNS.NioClient.runSelector(NioClient.java:114)\r\nrocketpool_eth1  |      at org.xbill.DNS.NioClient$$Lambda$1008/0x000000080113d890.run(Unknown Source)\r\nrocketpool_eth1  |      at java.base/java.lang.Thread.run(Thread.java:833)\r\nrocketpool_eth1  | 2023-04-14 22:33:35.573+00:00 | nioEventLoopGroup-2-1 | WARN  | NioServerSocketChannel | Failed to create a new channel from an accepted socket.\r\nrocketpool_eth1  | java.lang.OutOfMemoryError: Java heap space\r\nrocketpool_eth1  | 2023-04-14 22:33:36.043+00:00 | EthScheduler-Transactions-0 | ERROR | Besu | Uncaught exception in thread \"EthScheduler-Transactions-0\"\r\nrocketpool_eth1  | java.lang.OutOfMemoryError: Java heap space\r\nrocketpool_eth1  | 2023-04-14 22:33:37.515+00:00 | vertx-blocked-thread-checker | WARN  | BlockedThreadChecker | Thread Thread[vert.x-eventloop-thread-1,5,main] has been blocked for 19215 ms, time limit is 2000 ms\r\nrocketpool_eth1  | io.vertx.core.VertxException: Thread blocked\r\nrocketpool_eth1  |      at java.base@17.0.6/jdk.internal.misc.Unsafe.park(Native Method)\r\nrocketpool_eth1  |      at java.base@17.0.6/java.util.concurrent.locks.LockSupport.park(LockSupport.java:211)\r\nrocketpool_eth1  |      at java.base@17.0.6/java.util.concurrent.locks.AbstractQueuedSynchronizer.acquire(AbstractQueuedSynchronizer.java:715)\r\nrocketpool_eth1  |      at java.base@17.0.6/java.util.concurrent.locks.AbstractQueuedSynchronizer.acquire(AbstractQueuedSynchronizer.java:938)\r\nrocketpool_eth1  |      at java.base@17.0.6/java.util.concurrent.locks.ReentrantLock$Sync.lock(ReentrantLock.java:153)\r\nrocketpool_eth1  |      at java.base@17.0.6/java.util.concurrent.locks.ReentrantLock.lock(ReentrantLock.java:322)\r\nrocketpool_eth1  |      at java.base@17.0.6/java.util.concurrent.LinkedBlockingQueue.signalNotEmpty(LinkedBlockingQueue.java:175)\r\nrocketpool_eth1  |      at java.base@17.0.6/java.util.concurrent.LinkedBlockingQueue.offer(LinkedBlockingQueue.java:423)\r\nrocketpool_eth1  |      at java.base@17.0.6/java.util.concurrent.ThreadPoolExecutor.execute(ThreadPoolExecutor.java:1357)\r\nrocketpool_eth1  |      at app//io.vertx.core.impl.ContextImpl.executeBlocking(ContextImpl.java:172)\r\nrocketpool_eth1  |      at app//io.vertx.core.impl.ContextImpl.executeBlocking(ContextImpl.java:137)\r\nrocketpool_eth1  |      at app//io.vertx.core.impl.EventLoopContext.executeBlocking(EventLoopContext.java:22)\r\nrocketpool_eth1  |      at app//io.vertx.core.impl.AbstractContext.executeBlocking(AbstractContext.java:138)\r\nrocketpool_eth1  |      at app//io.vertx.core.impl.EventLoopContext.executeBlocking(EventLoopContext.java:22)\r\nrocketpool_eth1  |      at app//io.vertx.core.Vertx.executeBlocking(Vertx.java:566)\r\nrocketpool_eth1  |      at app//org.hyperledger.besu.ethereum.p2p.discovery.VertxPeerDiscoveryAgent$VertxAsyncExecutor.execute(VertxPeerDiscoveryAgent.java:316)\r\nrocketpool_eth1  |      at app//org.hyperledger.besu.ethereum.p2p.discovery.internal.PeerDiscoveryController.createPacket(PeerDiscoveryController.java:613)\r\nrocketpool_eth1  |      at app//org.hyperledger.besu.ethereum.p2p.discovery.internal.PeerDiscoveryController.lambda$bond$11(PeerDiscoveryController.java:531)\r\nrocketpool_eth1  |      at app//org.hyperledger.besu.ethereum.p2p.discovery.internal.PeerDiscoveryController$$Lambda$1095/0x000000080118dff0.accept(Unknown Source)\r\nrocketpool_eth1  |      at app//org.hyperledger.besu.ethereum.p2p.discovery.internal.PeerDiscoveryController$PeerInteractionState.execute(PeerDiscoveryController.java:787)\r\nrocketpool_eth1  |      at app//org.hyperledger.besu.ethereum.p2p.discovery.internal.PeerDiscoveryController.dispatchInteraction(PeerDiscoveryController.java:657)\r\nrocketpool_eth1  |      at app//org.hyperledger.besu.ethereum.p2p.discovery.internal.PeerDiscoveryController.bond(PeerDiscoveryController.java:553)\r\nrocketpool_eth1  |      at app//org.hyperledger.besu.ethereum.p2p.discovery.internal.PeerDiscoveryController.onMessage(PeerDiscoveryController.java:324)\r\nrocketpool_eth1  |      at app//org.hyperledger.besu.ethereum.p2p.discovery.PeerDiscoveryAgent.lambda$handleIncomingPacket$5(PeerDiscoveryAgent.java:307)\r\nrocketpool_eth1  |      at app//org.hyperledger.besu.ethereum.p2p.discovery.PeerDiscoveryAgent$$Lambda$1163/0x00000008011a8240.accept(Unknown Source)\r\nrocketpool_eth1  |      at java.base@17.0.6/java.util.Optional.ifPresent(Optional.java:178)\r\nrocketpool_eth1  |      at app//org.hyperledger.besu.ethereum.p2p.discovery.PeerDiscoveryAgent.handleIncomingPacket(PeerDiscoveryAgent.java:307)\r\nrocketpool_eth1  |      at app//org.hyperledger.besu.ethereum.p2p.discovery.VertxPeerDiscoveryAgent.lambda$handlePacket$10(VertxPeerDiscoveryAgent.java:297)\r\nrocketpool_eth1  |      at app//org.hyperledger.besu.ethereum.p2p.discovery.VertxPeerDiscoveryAgent$$Lambda$1156/0x00000008011a67e8.handle(Unknown Source)\r\nrocketpool_eth1  |      at app//io.vertx.core.impl.future.FutureImpl$3.onSuccess(FutureImpl.java:141)\r\nrocketpool_eth1  |      at app//io.vertx.core.impl.future.FutureBase.lambda$emitSuccess$0(FutureBase.java:54)\r\nrocketpool_eth1  |      at app//io.vertx.core.impl.future.FutureBase$$Lambda$816/0x000000080109d198.run(Unknown Source)\r\nrocketpool_eth1  |      at app//io.netty.util.concurrent.AbstractEventExecutor.runTask(AbstractEventExecutor.java:174)\r\nrocketpool_eth1  |      at app//io.netty.util.concurrent.AbstractEventExecutor.safeExecute(AbstractEventExecutor.java:167)\r\nrocketpool_eth1  |      at app//io.netty.util.concurrent.SingleThreadEventExecutor.runAllTasks(SingleThreadEventExecutor.java:470)\r\nrocketpool_eth1  |      at app//io.netty.channel.epoll.EpollEventLoop.run(EpollEventLoop.java:391)\r\nrocketpool_eth1  |      at app//io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:997)\r\nrocketpool_eth1  |      at app//io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)\r\nrocketpool_eth1  |      at app//io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\r\nrocketpool_eth1  |      at java.base@17.0.6/java.lang.Thread.run(Thread.java:833)\r\nrocketpool_eth1  | 2023-04-14 22:33:44.810+00:00 | vertx-blocked-thread-checker | WARN  | BlockedThreadChecker | Thread Thread[vert.x-eventloop-thread-1,5,main] has been blocked for 6800 ms, time limit is 2000 ms\r\nrocketpool_eth1  | io.vertx.core.VertxException: Thread blocked\r\nrocketpool_eth1  |      at app//io.vertx.core.impl.future.FutureImpl.onComplete(FutureImpl.java:137)\r\nrocketpool_eth1  |      at app//io.vertx.core.impl.future.PromiseImpl.onComplete(PromiseImpl.java:23)\r\nrocketpool_eth1  |      at app//io.vertx.core.impl.AbstractContext.setResultHandler(AbstractContext.java:229)\r\nrocketpool_eth1  |      at app//io.vertx.core.impl.AbstractContext.executeBlocking(AbstractContext.java:139)\r\nrocketpool_eth1  |      at app//io.vertx.core.impl.EventLoopContext.executeBlocking(EventLoopContext.java:22)\r\nrocketpool_eth1  |      at app//io.vertx.core.Vertx.executeBlocking(Vertx.java:566)\r\nrocketpool_eth1  |      at app//io.vertx.core.Vertx.executeBlocking(Vertx.java:573)\r\nrocketpool_eth1  |      at app//org.hyperledger.besu.ethereum.p2p.discovery.VertxPeerDiscoveryAgent.handlePacket(VertxPeerDiscoveryAgent.java:283)\r\nrocketpool_eth1  |      at app//org.hyperledger.besu.ethereum.p2p.discovery.VertxPeerDiscoveryAgent$$Lambda$1031/0x000000080115f9a0.handle(Unknown Source)\r\nrocketpool_eth1  |      at app//io.vertx.core.impl.EventLoopContext.emit(EventLoopContext.java:50)\r\nrocketpool_eth1  |      at app//io.vertx.core.impl.ContextImpl.emit(ContextImpl.java:274)\r\nrocketpool_eth1  |      at app//io.vertx.core.impl.EventLoopContext.emit(EventLoopContext.java:22)\r\nrocketpool_eth1  |      at app//io.vertx.core.datagram.impl.DatagramSocketImpl$Connection.handlePacket(DatagramSocketImpl.java:541)\r\nrocketpool_eth1  |      at app//io.vertx.core.datagram.impl.DatagramSocketImpl$Connection.handleMessage(DatagramSocketImpl.java:521)\r\nrocketpool_eth1  |      at app//io.vertx.core.net.impl.ConnectionBase.read(ConnectionBase.java:155)\r\nrocketpool_eth1  |      at app//io.vertx.core.net.impl.VertxHandler.channelRead(VertxHandler.java:153)\r\nrocketpool_eth1  |      at app//io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:379)\r\nrocketpool_eth1  |      at app//io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:365)\r\nrocketpool_eth1  |      at app//io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:357)\r\nrocketpool_eth1  |      at app//io.netty.channel.DefaultChannelPipeline$HeadContext.channelRead(DefaultChannelPipeline.java:1410)\r\nrocketpool_eth1  |      at app//io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:379)\r\nrocketpool_eth1  |      at app//io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:365)\r\nrocketpool_eth1  |      at app//io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:919)\r\nrocketpool_eth1  |      at app//io.netty.channel.epoll.EpollDatagramChannel.processPacket(EpollDatagramChannel.java:616)\r\nrocketpool_eth1  |      at app//io.netty.channel.epoll.EpollDatagramChannel.recvmsg(EpollDatagramChannel.java:651)\r\nrocketpool_eth1  |      at app//io.netty.channel.epoll.EpollDatagramChannel.access$100(EpollDatagramChannel.java:56)\r\nrocketpool_eth1  |      at app//io.netty.channel.epoll.EpollDatagramChannel$EpollDatagramChannelUnsafe.epollInReady(EpollDatagramChannel.java:490)\r\nrocketpool_eth1  |      at app//io.netty.channel.epoll.AbstractEpollChannel$AbstractEpollUnsafe$1.run(AbstractEpollChannel.java:425)\r\nrocketpool_eth1  |      at app//io.netty.util.concurrent.AbstractEventExecutor.runTask(AbstractEventExecutor.java:174)\r\nrocketpool_eth1  |      at app//io.netty.util.concurrent.AbstractEventExecutor.safeExecute(AbstractEventExecutor.java:167)\r\nrocketpool_eth1  |      at app//io.netty.util.concurrent.SingleThreadEventExecutor.runAllTasks(SingleThreadEventExecutor.java:470)\r\nrocketpool_eth1  |      at app//io.netty.channel.epoll.EpollEventLoop.run(EpollEventLoop.java:391)\r\nrocketpool_eth1  |      at app//io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:997)\r\nrocketpool_eth1  |      at app//io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)\r\nrocketpool_eth1  |      at app//io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\r\nrocketpool_eth1  |      at java.base@17.0.6/java.lang.Thread.run(Thread.java:833)\r\n```\r\n\r\nBesu shouldn't trigger OutOfMemoryError after loosing internet connection.",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/5348/reactions",
    "total_count": 2,
    "+1": 2,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/hyperledger/besu/issues/5348/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1573390579",
    "html_url": "https://github.com/hyperledger/besu/issues/5348#issuecomment-1573390579",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/5348",
    "id": 1573390579,
    "node_id": "IC_kwDODE2jmc5dyAjz",
    "user": {
      "login": "schwitin",
      "id": 1662882,
      "node_id": "MDQ6VXNlcjE2NjI4ODI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1662882?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/schwitin",
      "html_url": "https://github.com/schwitin",
      "followers_url": "https://api.github.com/users/schwitin/followers",
      "following_url": "https://api.github.com/users/schwitin/following{/other_user}",
      "gists_url": "https://api.github.com/users/schwitin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/schwitin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/schwitin/subscriptions",
      "organizations_url": "https://api.github.com/users/schwitin/orgs",
      "repos_url": "https://api.github.com/users/schwitin/repos",
      "events_url": "https://api.github.com/users/schwitin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/schwitin/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-06-02T08:55:24Z",
    "updated_at": "2023-06-02T08:55:24Z",
    "author_association": "NONE",
    "body": "Same issue after downtime for abut 10 days (power supply failure).",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1573390579/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1614383576",
    "html_url": "https://github.com/hyperledger/besu/issues/5348#issuecomment-1614383576",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/5348",
    "id": 1614383576,
    "node_id": "IC_kwDODE2jmc5gOYnY",
    "user": {
      "login": "ahamlat",
      "id": 5099602,
      "node_id": "MDQ6VXNlcjUwOTk2MDI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5099602?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ahamlat",
      "html_url": "https://github.com/ahamlat",
      "followers_url": "https://api.github.com/users/ahamlat/followers",
      "following_url": "https://api.github.com/users/ahamlat/following{/other_user}",
      "gists_url": "https://api.github.com/users/ahamlat/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ahamlat/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ahamlat/subscriptions",
      "organizations_url": "https://api.github.com/users/ahamlat/orgs",
      "repos_url": "https://api.github.com/users/ahamlat/repos",
      "events_url": "https://api.github.com/users/ahamlat/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ahamlat/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-06-30T09:22:30Z",
    "updated_at": "2023-06-30T09:22:30Z",
    "author_association": "CONTRIBUTOR",
    "body": "From what I gathered using Debug logs, this issue could be related to Besu enode being blacklisted by other nodes. I would recommend to delete the key file inside Besu data path and restart Besu.\r\nIf anyone is facing this issue, try the steps above and let us know if it resolved the issue.",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1614383576/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1614869352",
    "html_url": "https://github.com/hyperledger/besu/issues/5348#issuecomment-1614869352",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/5348",
    "id": 1614869352,
    "node_id": "IC_kwDODE2jmc5gQPNo",
    "user": {
      "login": "Pablosan",
      "id": 174738,
      "node_id": "MDQ6VXNlcjE3NDczOA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/174738?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Pablosan",
      "html_url": "https://github.com/Pablosan",
      "followers_url": "https://api.github.com/users/Pablosan/followers",
      "following_url": "https://api.github.com/users/Pablosan/following{/other_user}",
      "gists_url": "https://api.github.com/users/Pablosan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Pablosan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Pablosan/subscriptions",
      "organizations_url": "https://api.github.com/users/Pablosan/orgs",
      "repos_url": "https://api.github.com/users/Pablosan/repos",
      "events_url": "https://api.github.com/users/Pablosan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Pablosan/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-06-30T16:04:38Z",
    "updated_at": "2023-06-30T16:04:38Z",
    "author_association": "NONE",
    "body": "I'm pretty sure I had tried that earlier with no success, based on something I found in the Besu documentation. I just tested again and after deleting the `key` file in the `besu` directory I am still seeing blocked threads (`Thread[#33,vert.x-eventloop-thread-1,5,main]` and `Thread[#32,vert.x-eventloop-thread-0,5,main]`) and still getting stack traces.\r\n\r\nEventually I get:\r\n```\r\nException: java.lang.OutOfMemoryError thrown from the UncaughtExceptionHandler in thread \"vertx-blocked-thread-checker\"\r\nException: java.lang.OutOfMemoryError thrown from the UncaughtExceptionHandler in thread \"dnsjava NIO selector\"\r\n2023-06-30 10:59:21.180-05:00 | vertx-blocked-thread-checker | ERROR | Besu | Uncaught exception in thread \"vertx-blocked-thread-checker\"\r\njava.lang.OutOfMemoryError: Java heap space\r\n```\r\n\r\nAfter that I repeatedly get stack traces thrown by `DNSResolver`, `AbstractChannel`, and `rejectedExecution`.\r\n\r\nAgain, this is all after I deleted the `key` file from the `besu` directory as you suggested. So unfortunately this did not resolve my issue.\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1614869352/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1621378451",
    "html_url": "https://github.com/hyperledger/besu/issues/5348#issuecomment-1621378451",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/5348",
    "id": 1621378451,
    "node_id": "IC_kwDODE2jmc5gpEWT",
    "user": {
      "login": "ahamlat",
      "id": 5099602,
      "node_id": "MDQ6VXNlcjUwOTk2MDI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5099602?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ahamlat",
      "html_url": "https://github.com/ahamlat",
      "followers_url": "https://api.github.com/users/ahamlat/followers",
      "following_url": "https://api.github.com/users/ahamlat/following{/other_user}",
      "gists_url": "https://api.github.com/users/ahamlat/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ahamlat/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ahamlat/subscriptions",
      "organizations_url": "https://api.github.com/users/ahamlat/orgs",
      "repos_url": "https://api.github.com/users/ahamlat/repos",
      "events_url": "https://api.github.com/users/ahamlat/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ahamlat/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-05T09:27:14Z",
    "updated_at": "2023-07-05T09:35:27Z",
    "author_association": "CONTRIBUTOR",
    "body": "Thanks for the feedback @Pablosan.\r\nAnalysing the heap dump you shared, I was able to find what causes the outOfMemory error and the peak in CPU usage. \r\nWe can see in the screenshot below that one thread is holding more than 99% of the heap.\r\n<img width=\"960\" alt=\"image\" src=\"https://github.com/hyperledger/besu/assets/5099602/1ac7de3f-0606-49b5-90c7-f9d723df495f\">\r\n<img width=\"960\" alt=\"image\" src=\"https://github.com/hyperledger/besu/assets/5099602/0c30123d-f990-4c7b-a1c5-a8f85ed26855\">\r\n\r\nLooking into the stack strace of the thread holding 99% of the heap, we can see that this happens because Besu tries to do a huge reorg, to a block number 15_537_445 (0a46f5e956718147fe6b8f16301496283c28059fd07c16e6f842c0a3dfc1a711).\r\n\r\n![image](https://github.com/hyperledger/besu/assets/5099602/4b4fc20f-a15c-44ad-b14b-d0b55633c930)\r\n\r\n**_shouldContinuedownloading_** method calls **_rewindToBlock(0a46f5e956718147fe6b8f16301496283c28059fd07c16e6f842c0a3dfc1a711)_**, which calls **_handleChainReorg_**. This method in DefaultBlockchain creates two local list variables, and each one consumes around 2 GiB memory because the chosen pivot block is too far from current chain head in the database (more than 292 days old).\r\n\r\n```\r\nwhile (currentOldChainWithReceipts.getNumber() > currentNewChainWithReceipts.getNumber()) {\r\n      // If oldChain is longer than new chain, walk back until we meet the new chain by number,\r\n      // updating as we go.\r\n      updater.removeBlockHash(currentOldChainWithReceipts.getNumber());\r\n\r\n      removedTransactions.addAll(\r\n          currentOldChainWithReceipts.getBlock().getBody().getTransactions());\r\n      addRemovedLogsWithMetadata(removedLogsWithMetadata, currentOldChainWithReceipts);\r\n\r\n      currentOldChainWithReceipts = getParentBlockWithReceipts(currentOldChainWithReceipts);\r\n    }\r\n\r\n```\r\n<img width=\"1466\" alt=\"image\" src=\"https://github.com/hyperledger/besu/assets/5099602/aabe3818-2b74-48ba-9431-4d14038ce4aa\">\r\n\r\nThe peak in CPU usage is related to GC threads trying to free up some memory with no success, as the lists just keep growing.\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1621378451/reactions",
      "total_count": 2,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 2,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1623365332",
    "html_url": "https://github.com/hyperledger/besu/issues/5348#issuecomment-1623365332",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/5348",
    "id": 1623365332,
    "node_id": "IC_kwDODE2jmc5gwpbU",
    "user": {
      "login": "ahamlat",
      "id": 5099602,
      "node_id": "MDQ6VXNlcjUwOTk2MDI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5099602?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ahamlat",
      "html_url": "https://github.com/ahamlat",
      "followers_url": "https://api.github.com/users/ahamlat/followers",
      "following_url": "https://api.github.com/users/ahamlat/following{/other_user}",
      "gists_url": "https://api.github.com/users/ahamlat/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ahamlat/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ahamlat/subscriptions",
      "organizations_url": "https://api.github.com/users/ahamlat/orgs",
      "repos_url": "https://api.github.com/users/ahamlat/repos",
      "events_url": "https://api.github.com/users/ahamlat/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ahamlat/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-06T09:44:08Z",
    "updated_at": "2023-07-06T09:44:08Z",
    "author_association": "CONTRIBUTOR",
    "body": "To try to understand why Besu trusts this old pivot block and triggers a huge reorg, @matkt suggested to check the file inside [Besu_data_path]/fastsync/pivotBlockHeader.rlp.\r\nDecoding the file shared by @Pablosan, I found the same block besu trying to rewind to (block number 15_537_445). \r\nI suggested to @Pablosan to delete this file and restart Besu to see if is better",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1623365332/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1627348256",
    "html_url": "https://github.com/hyperledger/besu/issues/5348#issuecomment-1627348256",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/5348",
    "id": 1627348256,
    "node_id": "IC_kwDODE2jmc5g_10g",
    "user": {
      "login": "Pablosan",
      "id": 174738,
      "node_id": "MDQ6VXNlcjE3NDczOA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/174738?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Pablosan",
      "html_url": "https://github.com/Pablosan",
      "followers_url": "https://api.github.com/users/Pablosan/followers",
      "following_url": "https://api.github.com/users/Pablosan/following{/other_user}",
      "gists_url": "https://api.github.com/users/Pablosan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Pablosan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Pablosan/subscriptions",
      "organizations_url": "https://api.github.com/users/Pablosan/orgs",
      "repos_url": "https://api.github.com/users/Pablosan/repos",
      "events_url": "https://api.github.com/users/Pablosan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Pablosan/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-08T14:32:32Z",
    "updated_at": "2023-07-08T14:32:32Z",
    "author_association": "NONE",
    "body": "Thanks for all the details @ahamlat. Removing the `pivotBlockHeader.rlp` file did help but it didn't solve the issue entirely. After removing the file I also had to run:\r\n\r\n```\r\ncurl --location --request POST 'http://localhost:8545' \\\r\n--header 'Content-Type: application/json' \\\r\n--data-raw '{\r\n    \"jsonrpc\": \"2.0\",\r\n    \"method\": \"debug_resyncWorldState\",\r\n    \"params\": [],\r\n    \"id\": 1\r\n}'\r\n```\r\n\r\nThis clears the database and starts the syncing process back at the beginning but it did get my node back online eventually. On my machine running at home it took about 38 hours (using SNAP sync on a Mac Mini M1, 16GB RAM, 1 GbE ethernet to a 1 Gigabit fiber connection, using a Thunderbolt 4 2TB SSD).",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1627348256/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1627480206",
    "html_url": "https://github.com/hyperledger/besu/issues/5348#issuecomment-1627480206",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/5348",
    "id": 1627480206,
    "node_id": "IC_kwDODE2jmc5hAWCO",
    "user": {
      "login": "ahamlat",
      "id": 5099602,
      "node_id": "MDQ6VXNlcjUwOTk2MDI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5099602?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ahamlat",
      "html_url": "https://github.com/ahamlat",
      "followers_url": "https://api.github.com/users/ahamlat/followers",
      "following_url": "https://api.github.com/users/ahamlat/following{/other_user}",
      "gists_url": "https://api.github.com/users/ahamlat/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ahamlat/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ahamlat/subscriptions",
      "organizations_url": "https://api.github.com/users/ahamlat/orgs",
      "repos_url": "https://api.github.com/users/ahamlat/repos",
      "events_url": "https://api.github.com/users/ahamlat/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ahamlat/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-08T20:09:01Z",
    "updated_at": "2023-07-08T20:09:20Z",
    "author_association": "CONTRIBUTOR",
    "body": "Thanks for the feedback @Pablosan. Checking the logs you shared with me makes me think you're using Fast sync and not snap sync.\nBTW, the RPC call triggers only a resync of the world state, the blockchain part is not cleared.\nNot sure to understand why it didn't fix the issue if your node was able to get back online.",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1627480206/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1627480641",
    "html_url": "https://github.com/hyperledger/besu/issues/5348#issuecomment-1627480641",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/5348",
    "id": 1627480641,
    "node_id": "IC_kwDODE2jmc5hAWJB",
    "user": {
      "login": "Pablosan",
      "id": 174738,
      "node_id": "MDQ6VXNlcjE3NDczOA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/174738?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Pablosan",
      "html_url": "https://github.com/Pablosan",
      "followers_url": "https://api.github.com/users/Pablosan/followers",
      "following_url": "https://api.github.com/users/Pablosan/following{/other_user}",
      "gists_url": "https://api.github.com/users/Pablosan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Pablosan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Pablosan/subscriptions",
      "organizations_url": "https://api.github.com/users/Pablosan/orgs",
      "repos_url": "https://api.github.com/users/Pablosan/repos",
      "events_url": "https://api.github.com/users/Pablosan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Pablosan/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-08T20:11:38Z",
    "updated_at": "2023-07-08T20:11:38Z",
    "author_association": "NONE",
    "body": "My apologies. It did fix the issue but it didn't get me back to a fully sync'ed node without the extra step I mentioned above. Regarding the long sync time: I must have something wrong in my command line args. I'll take a closer look and see if I notice something amiss.",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1627480641/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
