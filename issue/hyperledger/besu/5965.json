{
  "url": "https://api.github.com/repos/hyperledger/besu/issues/5965",
  "repository_url": "https://api.github.com/repos/hyperledger/besu",
  "labels_url": "https://api.github.com/repos/hyperledger/besu/issues/5965/labels{/name}",
  "comments_url": "https://api.github.com/repos/hyperledger/besu/issues/5965/comments",
  "events_url": "https://api.github.com/repos/hyperledger/besu/issues/5965/events",
  "html_url": "https://github.com/hyperledger/besu/issues/5965",
  "id": 1916899047,
  "node_id": "I_kwDODE2jmc5yQY7n",
  "number": 5965,
  "title": "evmtool crashes on unexpected stateroot",
  "user": {
    "login": "namiloh",
    "id": 143267891,
    "node_id": "U_kgDOCIoYMw",
    "avatar_url": "https://avatars.githubusercontent.com/u/143267891?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/namiloh",
    "html_url": "https://github.com/namiloh",
    "followers_url": "https://api.github.com/users/namiloh/followers",
    "following_url": "https://api.github.com/users/namiloh/following{/other_user}",
    "gists_url": "https://api.github.com/users/namiloh/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/namiloh/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/namiloh/subscriptions",
    "organizations_url": "https://api.github.com/users/namiloh/orgs",
    "repos_url": "https://api.github.com/users/namiloh/repos",
    "events_url": "https://api.github.com/users/namiloh/events{/privacy}",
    "received_events_url": "https://api.github.com/users/namiloh/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 0,
  "created_at": "2023-09-28T07:38:31Z",
  "updated_at": "2023-09-28T07:38:31Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "\r\n\r\n### Steps to Reproduce (Bug)\r\n\r\nRun a test with invalid expected root, see that the trace does not contain the stateroot at the end\r\n```\r\nmartin@worknuk:~/workspace/goevmlab/evms/testdata$ /home/martin/workspace/besu-vm --json --nomemory --notime state-test ./cases/00000936-mixed-1.json 2>/dev/null\r\n...omitted for brevity...\r\n{\"pc\":82,\"op\":8,\"gas\":\"0x79bc20\",\"gasCost\":\"0x8\",\"memSize\":0,\"stack\":[\"0x0\",\"0x1\",\"0x1\",\"0x2\",\"0x2\",\"0xffff\",\"0x1f4\",\"0x78859e5b97166c486532b1595a673e9f9073643f1b519c6f18511b9913\",\"0x2\",\"0x389\",\"0x0\",\"0x0\",\"0x1\",\"0x0\",\"0x3e3d6d5ff042148d326c1898713a76759ca273\",\"0x44852b2a670ade5407e78fb2863c51de9fcb96542a07186fe3aeda6bb8a116d\",\"0xb94f5374fce5edbc8e2a8697c15331677e6ebf0b\",\"0x10\"],\"depth\":1,\"refund\":0,\"opName\":\"ADDMOD\"}\r\n{\"pc\":83,\"op\":62,\"gas\":\"0x79bc18\",\"gasCost\":\"0x0\",\"memSize\":0,\"stack\":[\"0x0\",\"0x1\",\"0x1\",\"0x2\",\"0x2\",\"0xffff\",\"0x1f4\",\"0x78859e5b97166c486532b1595a673e9f9073643f1b519c6f18511b9913\",\"0x2\",\"0x389\",\"0x0\",\"0x0\",\"0x1\",\"0x0\",\"0x3e3d6d5ff042148d326c1898713a76759ca273\",\"0xb94f5374fce5edbc8e2a8697c15331677e6ebf1b\"],\"depth\":1,\"refund\":0,\"opName\":\"RETURNDATACOPY\",\"error\":\"Out of bounds\"}\r\n\r\n```\r\n\r\njson test file can be found here: https://github.com/holiman/goevmlab/tree/master/evms/testdata/cases, and the expected stdout should end with a stateroot, as can be seen [here](https://github.com/holiman/goevmlab/blob/master/evms/testdata/traces/00000936-mixed-1.json.besu.stdout.txt#L26)\r\n\r\nThe reason why the stateroot is not shown can be seen if we look at the stderr: \r\n\r\n```\r\nmartin@worknuk:~/workspace/goevmlab/evms/testdata$ /home/martin/workspace/besu-vm --json --nomemory --notime state-test ./cases/00000936-mixed-1.json 1>/dev/null\r\njava.lang.RuntimeException: World State Root does not match expected value, header 0x0000000000000000000000000000000000000000000000000000000000000000 calculated 0xd14c10ed22a1cfb642e374be985ac581c39f3969bd59249e0405aca3beb47a47\r\n\tat org.hyperledger.besu.ethereum.bonsai.worldview.BonsaiWorldState.persist(BonsaiWorldState.java:398)\r\n\tat org.hyperledger.besu.evmtool.StateTestSubCommand.traceTestSpecs(StateTestSubCommand.java:266)\r\n\tat org.hyperledger.besu.evmtool.StateTestSubCommand.lambda$executeStateTest$0(StateTestSubCommand.java:174)\r\n\tat java.base/java.util.LinkedHashMap.forEach(LinkedHashMap.java:721)\r\n\tat org.hyperledger.besu.evmtool.StateTestSubCommand.executeStateTest(StateTestSubCommand.java:174)\r\n\tat org.hyperledger.besu.evmtool.StateTestSubCommand.run(StateTestSubCommand.java:157)\r\n\tat picocli.CommandLine.executeUserObject(CommandLine.java:2026)\r\n\tat picocli.CommandLine.access$1500(CommandLine.java:148)\r\n\tat picocli.CommandLine$RunLast.executeUserObjectOfLastSubcommandWithSameParent(CommandLine.java:2461)\r\n\tat picocli.CommandLine$RunLast.handle(CommandLine.java:2453)\r\n\tat picocli.CommandLine$RunLast.handle(CommandLine.java:2415)\r\n\tat picocli.CommandLine$AbstractParseResultHandler.execute(CommandLine.java:2273)\r\n\tat picocli.CommandLine$RunLast.execute(CommandLine.java:2417)\r\n\tat picocli.CommandLine.execute(CommandLine.java:2170)\r\n\tat org.hyperledger.besu.evmtool.EvmToolCommand.execute(EvmToolCommand.java:271)\r\n\tat org.hyperledger.besu.evmtool.EvmToolCommand.execute(EvmToolCommand.java:237)\r\n\tat org.hyperledger.besu.evmtool.EvmTool.main(EvmTool.java:23)\r\n```\r\nIt crashes, which makes it not compatible with the fuzzing-framework. \r\n\r\nCommit version 4f49ec9418ea53a88b1ae99e32162e8f1d76e94d\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/5965/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/hyperledger/besu/issues/5965/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[

]
