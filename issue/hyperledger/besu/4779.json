{
  "url": "https://api.github.com/repos/hyperledger/besu/issues/4779",
  "repository_url": "https://api.github.com/repos/hyperledger/besu",
  "labels_url": "https://api.github.com/repos/hyperledger/besu/issues/4779/labels{/name}",
  "comments_url": "https://api.github.com/repos/hyperledger/besu/issues/4779/comments",
  "events_url": "https://api.github.com/repos/hyperledger/besu/issues/4779/events",
  "html_url": "https://github.com/hyperledger/besu/issues/4779",
  "id": 1477134581,
  "node_id": "I_kwDODE2jmc5YC0j1",
  "number": 4779,
  "title": "Exceptions while trying to benchmark node",
  "user": {
    "login": "quickchase",
    "id": 87909910,
    "node_id": "MDQ6VXNlcjg3OTA5OTEw",
    "avatar_url": "https://avatars.githubusercontent.com/u/87909910?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/quickchase",
    "html_url": "https://github.com/quickchase",
    "followers_url": "https://api.github.com/users/quickchase/followers",
    "following_url": "https://api.github.com/users/quickchase/following{/other_user}",
    "gists_url": "https://api.github.com/users/quickchase/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/quickchase/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/quickchase/subscriptions",
    "organizations_url": "https://api.github.com/users/quickchase/orgs",
    "repos_url": "https://api.github.com/users/quickchase/repos",
    "events_url": "https://api.github.com/users/quickchase/events{/privacy}",
    "received_events_url": "https://api.github.com/users/quickchase/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 2058129555,
      "node_id": "MDU6TGFiZWwyMDU4MTI5NTU1",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/performance",
      "name": "performance",
      "color": "d29ce2",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2022-12-05T18:14:31Z",
  "updated_at": "2023-03-23T13:53:16Z",
  "closed_at": "2023-03-23T13:53:15Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "Running the latest binary release, I attempted to do some quick benchmarking of a Besu full node and I noticed that the node was throwing some exceptions.\r\n\r\nI downloaded [ethspam](https://github.com/shazow/ethspam) and [versus](https://github.com/INFURA/versus) and tried to run it against the node:\r\n\r\n```bash\r\n$ ./ethspam --rpc http://localhost:8545 | ./versus --stop-after 10000 --concurrency=10 http://localhost:8545\r\nEndpoints:\r\n\r\n0. \"http://localhost:8545\"\r\n\r\n   Requests:   1001.00 per second, 0.99 per second for errors\r\n   Timing:     0.0100s avg, 0.0002s min, 1.3084s max\r\n               0.0733s standard deviation\r\n\r\n   Percentiles:\r\n     25% in 0.0007s\r\n     50% in 0.0013s\r\n     75% in 0.0026s\r\n     90% in 0.0054s\r\n     95% in 0.0146s\r\n     99% in 0.1354s\r\n\r\n   Errors: 0.03%\r\n     3 Ã— \"bad status code: 400\"\r\n\r\n** Summary for 1 endpoints:\r\n   Completed:  10000 results with 10000 total requests\r\n   Timing:     9.990057ms request avg, 10.305638047s total run time\r\n   Errors:     3 (0.03%)\r\n   Mismatched: 0\r\n```\r\n\r\nYou can see that there were some errors, that's unexpected running against localhost...\r\n\r\nI then grabbed some logs from the node:\r\n\r\n```\r\n2022-12-05 18:05:16.164+00:00 | vert.x-worker-thread-12 | ERROR | MainnetTransactionProcessor | Critical Exception Processing Transaction\r\norg.hyperledger.besu.ethereum.trie.MerkleTrieException: Unable to load trie node value for hash 0xc4252200a1075c1e91304cdcdc9d941dd92253287f0de434c7919354e75cb261 location 0x\r\n        at org.hyperledger.besu.ethereum.trie.StoredNode.lambda$load$0(StoredNode.java:133)\r\n        at java.base/java.util.Optional.orElseThrow(Optional.java:403)\r\n        at org.hyperledger.besu.ethereum.trie.StoredNode.load(StoredNode.java:131)\r\n        at org.hyperledger.besu.ethereum.trie.StoredNode.accept(StoredNode.java:63)\r\n        at org.hyperledger.besu.ethereum.trie.StoredMerklePatriciaTrie.get(StoredMerklePatriciaTrie.java:119)\r\n        at org.hyperledger.besu.ethereum.bonsai.BonsaiWorldStateKeyValueStorage.getStorageValueBySlotHash(BonsaiWorldStateKeyValueStorage.java:200)\r\n        at org.hyperledger.besu.ethereum.bonsai.BonsaiPersistedWorldState.getStorageValueBySlotHash(BonsaiPersistedWorldState.java:421)\r\n        at org.hyperledger.besu.ethereum.bonsai.BonsaiLayeredWorldState.getStorageValueBySlotHash(BonsaiLayeredWorldState.java:156)\r\n        at org.hyperledger.besu.ethereum.bonsai.BonsaiWorldStateUpdater.getStorageValueBySlotHash(BonsaiWorldStateUpdater.java:353)\r\n        at org.hyperledger.besu.ethereum.bonsai.BonsaiWorldStateUpdater.getStorageValue(BonsaiWorldStateUpdater.java:340)\r\n        at org.hyperledger.besu.ethereum.bonsai.BonsaiAccount.getStorageValue(BonsaiAccount.java:208)\r\n        at org.hyperledger.besu.evm.worldstate.UpdateTrackingAccount.getStorageValue(UpdateTrackingAccount.java:213)\r\n        at org.hyperledger.besu.evm.worldstate.UpdateTrackingAccount.getStorageValue(UpdateTrackingAccount.java:213)\r\n        at org.hyperledger.besu.evm.worldstate.UpdateTrackingAccount.getStorageValue(UpdateTrackingAccount.java:213)\r\n        at org.hyperledger.besu.evm.worldstate.UpdateTrackingAccount.getStorageValue(UpdateTrackingAccount.java:213)\r\n        at org.hyperledger.besu.evm.worldstate.UpdateTrackingAccount.getStorageValue(UpdateTrackingAccount.java:213)\r\n        at org.hyperledger.besu.evm.worldstate.UpdateTrackingAccount.getStorageValue(UpdateTrackingAccount.java:213)\r\n        at org.hyperledger.besu.evm.worldstate.UpdateTrackingAccount.getStorageValue(UpdateTrackingAccount.java:213)\r\n        at org.hyperledger.besu.evm.worldstate.UpdateTrackingAccount.getStorageValue(UpdateTrackingAccount.java:213)\r\n        at org.hyperledger.besu.evm.worldstate.UpdateTrackingAccount.getStorageValue(UpdateTrackingAccount.java:213)\r\n        at org.hyperledger.besu.evm.worldstate.UpdateTrackingAccount.getStorageValue(UpdateTrackingAccount.java:213)\r\n        at org.hyperledger.besu.evm.worldstate.UpdateTrackingAccount.getStorageValue(UpdateTrackingAccount.java:213)\r\n        at org.hyperledger.besu.evm.worldstate.UpdateTrackingAccount.getStorageValue(UpdateTrackingAccount.java:213)\r\n        at org.hyperledger.besu.evm.operation.SLoadOperation.execute(SLoadOperation.java:58)\r\n        at org.hyperledger.besu.evm.EVM.runToHalt(EVM.java:282)\r\n        at org.hyperledger.besu.evm.processor.AbstractMessageProcessor.codeExecute(AbstractMessageProcessor.java:161)\r\n        at org.hyperledger.besu.evm.processor.AbstractMessageProcessor.process(AbstractMessageProcessor.java:173)\r\n        at org.hyperledger.besu.ethereum.mainnet.MainnetTransactionProcessor.process(MainnetTransactionProcessor.java:492)\r\n        at org.hyperledger.besu.ethereum.mainnet.MainnetTransactionProcessor.processTransaction(MainnetTransactionProcessor.java:404)\r\n        at org.hyperledger.besu.ethereum.mainnet.MainnetTransactionProcessor.processTransaction(MainnetTransactionProcessor.java:169)\r\n        at org.hyperledger.besu.ethereum.transaction.TransactionSimulator.processWithWorldUpdater(TransactionSimulator.java:227)\r\n        at org.hyperledger.besu.ethereum.transaction.TransactionSimulator.process(TransactionSimulator.java:157)\r\n        at org.hyperledger.besu.ethereum.api.jsonrpc.internal.methods.EthCall.resultByBlockHash(EthCall.java:72)\r\n        at org.hyperledger.besu.ethereum.api.jsonrpc.internal.methods.AbstractBlockParameterOrBlockHashMethod.handleParamTypes(AbstractBlockParameterOrBlockHashMethod.java:85)\r\n        at org.hyperledger.besu.ethereum.api.jsonrpc.internal.methods.EthCall.response(EthCall.java:96)\r\n        at org.hyperledger.besu.ethereum.api.jsonrpc.execution.BaseJsonRpcProcessor.process(BaseJsonRpcProcessor.java:42)\r\n        at org.hyperledger.besu.ethereum.api.jsonrpc.execution.TracedJsonRpcProcessor.process(TracedJsonRpcProcessor.java:41)\r\n        at org.hyperledger.besu.ethereum.api.jsonrpc.execution.TimedJsonRpcProcessor.process(TimedJsonRpcProcessor.java:45)\r\n        at org.hyperledger.besu.ethereum.api.jsonrpc.execution.JsonRpcExecutor.execute(JsonRpcExecutor.java:92)\r\n        at org.hyperledger.besu.ethereum.api.handlers.JsonRpcExecutorHandler.lambda$handler$8(JsonRpcExecutorHandler.java:79)\r\n        at io.vertx.ext.web.impl.BlockingHandlerDecorator.lambda$handle$0(BlockingHandlerDecorator.java:48)\r\n        at io.vertx.core.impl.ContextImpl.lambda$null$0(ContextImpl.java:159)\r\n        at io.vertx.core.impl.AbstractContext.dispatch(AbstractContext.java:100)\r\n        at io.vertx.core.impl.ContextImpl.lambda$executeBlocking$1(ContextImpl.java:157)\r\n        at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1136)\r\n        at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:635)\r\n        at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\r\n        at java.base/java.lang.Thread.run(Thread.java:833)\r\n```\r\n\r\nNode Config:\r\n```\r\nExecStart=/home/eth/besu/bin/besu \\\r\n    --network=MAINNET \\\r\n    --data-path=/home/eth/besu/data \\\r\n    --data-storage-format=BONSAI \\\r\n    --Xbonsai-use-snapshots=false \\\r\n    --sync-mode=X_SNAP \\\r\n    --pruning-enabled=true \\\r\n    --rpc-http-enabled=true \\\r\n    --rpc-http-apis=ADMIN,DEBUG,ETH,NET,TRACE,TXPOOL,WEB3 \\\r\n    --rpc-http-host=0.0.0.0 \\\r\n    --rpc-http-port=8545 \\\r\n    --rpc-http-cors-origins=\"*\" \\\r\n    --host-allowlist=\"*\" \\\r\n    --rpc-ws-enabled=true \\\r\n    --rpc-ws-apis=ADMIN,DEBUG,ETH,NET,TRACE,TXPOOL,WEB3 \\\r\n    --rpc-ws-host=0.0.0.0 \\\r\n    --rpc-ws-port=8546 \\\r\n    --metrics-enabled=true \\\r\n    --metrics-host=0.0.0.0 \\\r\n    --metrics-port=6060 \\\r\n    --engine-rpc-enabled=true \\\r\n    --engine-rpc-port=8551 \\\r\n    --engine-jwt-secret=/home/eth/jwtsecret \\\r\n    --engine-host-allowlist=\"*\" \\\r\n    --Xplugin-rocksdb-high-spec-enabled=true\r\n```",
  "closed_by": {
    "login": "non-fungible-nelson",
    "id": 85905982,
    "node_id": "MDQ6VXNlcjg1OTA1OTgy",
    "avatar_url": "https://avatars.githubusercontent.com/u/85905982?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/non-fungible-nelson",
    "html_url": "https://github.com/non-fungible-nelson",
    "followers_url": "https://api.github.com/users/non-fungible-nelson/followers",
    "following_url": "https://api.github.com/users/non-fungible-nelson/following{/other_user}",
    "gists_url": "https://api.github.com/users/non-fungible-nelson/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/non-fungible-nelson/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/non-fungible-nelson/subscriptions",
    "organizations_url": "https://api.github.com/users/non-fungible-nelson/orgs",
    "repos_url": "https://api.github.com/users/non-fungible-nelson/repos",
    "events_url": "https://api.github.com/users/non-fungible-nelson/events{/privacy}",
    "received_events_url": "https://api.github.com/users/non-fungible-nelson/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/4779/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/hyperledger/besu/issues/4779/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1347348326",
    "html_url": "https://github.com/hyperledger/besu/issues/4779#issuecomment-1347348326",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/4779",
    "id": 1347348326,
    "node_id": "IC_kwDODE2jmc5QTudm",
    "user": {
      "login": "non-fungible-nelson",
      "id": 85905982,
      "node_id": "MDQ6VXNlcjg1OTA1OTgy",
      "avatar_url": "https://avatars.githubusercontent.com/u/85905982?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/non-fungible-nelson",
      "html_url": "https://github.com/non-fungible-nelson",
      "followers_url": "https://api.github.com/users/non-fungible-nelson/followers",
      "following_url": "https://api.github.com/users/non-fungible-nelson/following{/other_user}",
      "gists_url": "https://api.github.com/users/non-fungible-nelson/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/non-fungible-nelson/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/non-fungible-nelson/subscriptions",
      "organizations_url": "https://api.github.com/users/non-fungible-nelson/orgs",
      "repos_url": "https://api.github.com/users/non-fungible-nelson/repos",
      "events_url": "https://api.github.com/users/non-fungible-nelson/events{/privacy}",
      "received_events_url": "https://api.github.com/users/non-fungible-nelson/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-12T21:22:32Z",
    "updated_at": "2022-12-12T21:22:32Z",
    "author_association": "CONTRIBUTOR",
    "body": "Handling this under issue #4785 ",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1347348326/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1481237876",
    "html_url": "https://github.com/hyperledger/besu/issues/4779#issuecomment-1481237876",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/4779",
    "id": 1481237876,
    "node_id": "IC_kwDODE2jmc5YSeV0",
    "user": {
      "login": "non-fungible-nelson",
      "id": 85905982,
      "node_id": "MDQ6VXNlcjg1OTA1OTgy",
      "avatar_url": "https://avatars.githubusercontent.com/u/85905982?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/non-fungible-nelson",
      "html_url": "https://github.com/non-fungible-nelson",
      "followers_url": "https://api.github.com/users/non-fungible-nelson/followers",
      "following_url": "https://api.github.com/users/non-fungible-nelson/following{/other_user}",
      "gists_url": "https://api.github.com/users/non-fungible-nelson/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/non-fungible-nelson/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/non-fungible-nelson/subscriptions",
      "organizations_url": "https://api.github.com/users/non-fungible-nelson/orgs",
      "repos_url": "https://api.github.com/users/non-fungible-nelson/repos",
      "events_url": "https://api.github.com/users/non-fungible-nelson/events{/privacy}",
      "received_events_url": "https://api.github.com/users/non-fungible-nelson/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-23T13:53:15Z",
    "updated_at": "2023-03-23T13:53:15Z",
    "author_association": "CONTRIBUTOR",
    "body": "Closing for bonsai refactor fixes in #5123, please re-open if you experience this on latest. ",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1481237876/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
