{
  "url": "https://api.github.com/repos/hyperledger/besu/issues/5987",
  "repository_url": "https://api.github.com/repos/hyperledger/besu",
  "labels_url": "https://api.github.com/repos/hyperledger/besu/issues/5987/labels{/name}",
  "comments_url": "https://api.github.com/repos/hyperledger/besu/issues/5987/comments",
  "events_url": "https://api.github.com/repos/hyperledger/besu/issues/5987/events",
  "html_url": "https://github.com/hyperledger/besu/issues/5987",
  "id": 1927236018,
  "node_id": "I_kwDODE2jmc5y30my",
  "number": 5987,
  "title": "Bonsai: SnapSync/FullSync and BlockPropagation race error",
  "user": {
    "login": "garyschulte",
    "id": 1238512,
    "node_id": "MDQ6VXNlcjEyMzg1MTI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1238512?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/garyschulte",
    "html_url": "https://github.com/garyschulte",
    "followers_url": "https://api.github.com/users/garyschulte/followers",
    "following_url": "https://api.github.com/users/garyschulte/following{/other_user}",
    "gists_url": "https://api.github.com/users/garyschulte/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/garyschulte/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/garyschulte/subscriptions",
    "organizations_url": "https://api.github.com/users/garyschulte/orgs",
    "repos_url": "https://api.github.com/users/garyschulte/repos",
    "events_url": "https://api.github.com/users/garyschulte/events{/privacy}",
    "received_events_url": "https://api.github.com/users/garyschulte/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1537362490,
      "node_id": "MDU6TGFiZWwxNTM3MzYyNDkw",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/bug",
      "name": "bug",
      "color": "d73a4a",
      "default": true,
      "description": "Something isn't working"
    },
    {
      "id": 1921587647,
      "node_id": "MDU6TGFiZWwxOTIxNTg3NjQ3",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/TeamGroot",
      "name": "TeamGroot",
      "color": "1d76db",
      "default": false,
      "description": "GH issues worked on by Groot Team"
    },
    {
      "id": 2051683248,
      "node_id": "MDU6TGFiZWwyMDUxNjgzMjQ4",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/P2",
      "name": "P2",
      "color": "ff9900",
      "default": false,
      "description": "High (ex: Degrading performance issues, unexpected behavior of core features (DevP2P, syncing, etc))"
    },
    {
      "id": 2152224197,
      "node_id": "MDU6TGFiZWwyMTUyMjI0MTk3",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/TeamRevenant",
      "name": "TeamRevenant",
      "color": "78e298",
      "default": false,
      "description": "GH issues worked on by Revenant Team"
    },
    {
      "id": 3918183887,
      "node_id": "LA_kwDODE2jmc7pir3P",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/snapsync",
      "name": "snapsync",
      "color": "84684F",
      "default": false,
      "description": ""
    },
    {
      "id": 3932728358,
      "node_id": "LA_kwDODE2jmc7qaKwm",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/syncing",
      "name": "syncing",
      "color": "ECC431",
      "default": false,
      "description": ""
    },
    {
      "id": 4328706977,
      "node_id": "LA_kwDODE2jmc8AAAABAgLToQ",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/TeamChupa",
      "name": "TeamChupa",
      "color": "fbca04",
      "default": false,
      "description": "GH issues worked on by Chupacabara Team"
    },
    {
      "id": 5113384824,
      "node_id": "LA_kwDODE2jmc8AAAABMMgPeA",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/bonsai",
      "name": "bonsai",
      "color": "0E8A16",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2023-10-05T01:46:11Z",
  "updated_at": "2023-10-09T22:22:42Z",
  "closed_at": null,
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "<!-- Have you done the following? -->\r\n<!--   * read the Code of Conduct? By filing an Issue, you are expected to -->  \r\n<!--     comply with it, including treating everyone with respect: -->\r\n<!--     https://github.com/hyperledger/besu/blob/main/CODE_OF_CONDUCT.md -->\r\n<!--   * Reproduced the issue in the latest version of the software -->\r\n<!--   * Read the debugging docs: https://besu.hyperledger.org/en/stable/HowTo/Monitor/Logging/ -->\r\n<!--   * Duplicate Issue check:  https://github.com/search?q=+is%3Aissue+repo%3Ahyperledger/Besu -->\r\n<!-- Note:  Not all sections will apply to all issue types. -->\r\n\r\n### Description\r\nOn Bonsai on non-PoS networks, when completing snap sync a race exists that can corrupt the state.  \r\n\r\nWhen the snapsync pipeline completes, the full sync process starts to catch up to head.  If the BlockPropagation manager reacts to a gossip'd block during this time, trie log rolling fails due to a missing trielog:\r\n\r\n### Acceptance Criteria\r\n* [Criteria 1]\r\n\r\n### Steps to Reproduce (Bug)\r\n1. snap sync a non-PoS network using Bonsai storage format\r\n2. once the snap sync completes, especially on networks with a short block time, the block propagation manager attempts to import blocks ahead of the trielog for the current pivot being available.\r\n\r\n**Expected behavior:** [What you expect to happen]\r\nno issue post sync\r\n\r\n**Actual behavior:** [What actually happens]\r\ntrie log rolling fails at the tip of the synced chain due to missing trielog\r\n\r\n**Frequency:** [What percentage of the time does it occur?]\r\nvaries based on network and block time.  Testing locally with clique and 5 second block time this happens about 33% of the time\r\n\r\n### Logs (if a bug)\r\n```\r\n2023-10-04 18:22:30.070-07:00 | EthScheduler-Services-42 (importBlock) | INFO  | SnapWorldDownloadState | Running world state heal process from peers with pivot block 17083\r\n2023-10-04 18:22:30.073-07:00 | EthScheduler-Services-36 (requestCompleteTask) | INFO  | SnapWorldDownloadState | Initiating the healing process for the flat database\r\n2023-10-04 18:22:30.078-07:00 | EthScheduler-Services-36 (requestCompleteTask) | INFO  | SnapsyncMetricsManager | Finished worldstate snapsync with nodes 15 (healed=0) duration 0:2,418.\r\n2023-10-04 18:22:31.009-07:00 | nioEventLoopGroup-3-2 | INFO  | BlockPropagationManager | Saved announced block for future import 17095 (0xba970ed3247b9f2faefa462e0f6bbac711801158f19b56c8fa43c18c9b79033c) - 1 saved block(s)\r\n2023-10-04 18:22:31.010-07:00 | nioEventLoopGroup-3-2 | INFO  | BlockPropagationManager | Retrieving parent 0xf9bc52fdc7ee314f5ea3e955f95319263a8fe330da466dd422dac60b1855eba3 of block 17095 (0xba970ed3247b9f2faefa462e0f6bbac711801158f19b56c8fa43c18c9b79033c)\r\n2023-10-04 18:22:31.021-07:00 | nioEventLoopGroup-3-2 | INFO  | BlockPropagationManager | Saved announced block for future import 17094 (0xf9bc52fdc7ee314f5ea3e955f95319263a8fe330da466dd422dac60b1855eba3) - 2 saved block(s)\r\n2023-10-04 18:22:31.021-07:00 | nioEventLoopGroup-3-2 | INFO  | BlockPropagationManager | Retrieving parent 0x88771787c2d41cadac5ec845badd71da6d6632d03544798ee15a70966c826f0e of block 17094 (0xf9bc52fdc7ee314f5ea3e955f95319263a8fe330da466dd422dac60b1855eba3)\r\n2023-10-04 18:22:31.023-07:00 | nioEventLoopGroup-3-2 | INFO  | BlockPropagationManager | Saved announced block for future import 17093 (0x88771787c2d41cadac5ec845badd71da6d6632d03544798ee15a70966c826f0e) - 3 saved block(s)\r\n2023-10-04 18:22:31.023-07:00 | nioEventLoopGroup-3-2 | INFO  | BlockPropagationManager | Retrieving parent 0x9d8962b55b4f2ff02e69558e8ef52b3f69dfd79533075b3b888417a84f1d1cb9 of block 17093 (0x88771787c2d41cadac5ec845badd71da6d6632d03544798ee15a70966c826f0e)\r\n2023-10-04 18:22:31.024-07:00 | nioEventLoopGroup-3-2 | INFO  | BlockPropagationManager | Saved announced block for future import 17092 (0x9d8962b55b4f2ff02e69558e8ef52b3f69dfd79533075b3b888417a84f1d1cb9) - 4 saved block(s)\r\n2023-10-04 18:22:31.025-07:00 | nioEventLoopGroup-3-2 | INFO  | BlockPropagationManager | Retrieving parent 0x171e9e81cd65b16e0dbdd2e866aa72d5a670d8ec8532e8db184f43ade9efdcc9 of block 17092 (0x9d8962b55b4f2ff02e69558e8ef52b3f69dfd79533075b3b888417a84f1d1cb9)\r\n2023-10-04 18:22:31.026-07:00 | nioEventLoopGroup-3-2 | INFO  | BlockPropagationManager | Saved announced block for future import 17091 (0x171e9e81cd65b16e0dbdd2e866aa72d5a670d8ec8532e8db184f43ade9efdcc9) - 5 saved block(s)\r\n2023-10-04 18:22:31.026-07:00 | nioEventLoopGroup-3-2 | INFO  | BlockPropagationManager | Retrieving parent 0x25bd079593c700b80250e05eace2556c89fd3c45bfd407a40b4b6c92c3230752 of block 17091 (0x171e9e81cd65b16e0dbdd2e866aa72d5a670d8ec8532e8db184f43ade9efdcc9)\r\n2023-10-04 18:22:31.028-07:00 | nioEventLoopGroup-3-2 | INFO  | BlockPropagationManager | Saved announced block for future import 17090 (0x25bd079593c700b80250e05eace2556c89fd3c45bfd407a40b4b6c92c3230752) - 6 saved block(s)\r\n2023-10-04 18:22:31.028-07:00 | nioEventLoopGroup-3-2 | INFO  | BlockPropagationManager | Retrieving parent 0x38b65af81633f8b029ce35ee48ef7a2eddbd0e5bf55449196c7c449f6cdc533d of block 17090 (0x25bd079593c700b80250e05eace2556c89fd3c45bfd407a40b4b6c92c3230752)\r\n2023-10-04 18:22:31.030-07:00 | nioEventLoopGroup-3-2 | INFO  | BlockPropagationManager | Saved announced block for future import 17089 (0x38b65af81633f8b029ce35ee48ef7a2eddbd0e5bf55449196c7c449f6cdc533d) - 7 saved block(s)\r\n2023-10-04 18:22:31.030-07:00 | nioEventLoopGroup-3-2 | INFO  | BlockPropagationManager | Retrieving parent 0xdb3ccc878c8f3653ee3c9f897bb585d75e97c007fb8ccad8a07d04c45cb3a036 of block 17089 (0x38b65af81633f8b029ce35ee48ef7a2eddbd0e5bf55449196c7c449f6cdc533d)\r\n2023-10-04 18:22:31.032-07:00 | nioEventLoopGroup-3-2 | INFO  | BlockPropagationManager | Saved announced block for future import 17088 (0xdb3ccc878c8f3653ee3c9f897bb585d75e97c007fb8ccad8a07d04c45cb3a036) - 8 saved block(s)\r\n2023-10-04 18:22:31.033-07:00 | nioEventLoopGroup-3-2 | INFO  | BlockPropagationManager | Retrieving parent 0x97f4f5357046fdc0e170f96f0ad1c137e3c093e59f3588ebdf0dedf4e252ffa8 of block 17088 (0xdb3ccc878c8f3653ee3c9f897bb585d75e97c007fb8ccad8a07d04c45cb3a036)\r\n2023-10-04 18:22:31.035-07:00 | nioEventLoopGroup-3-2 | INFO  | BlockPropagationManager | Saved announced block for future import 17087 (0x97f4f5357046fdc0e170f96f0ad1c137e3c093e59f3588ebdf0dedf4e252ffa8) - 9 saved block(s)\r\n2023-10-04 18:22:31.035-07:00 | nioEventLoopGroup-3-2 | INFO  | BlockPropagationManager | Retrieving parent 0x92954f4e479d37c0711169ece926fdabd3f3bf66c8a407a57b9c2ede1de0d1df of block 17087 (0x97f4f5357046fdc0e170f96f0ad1c137e3c093e59f3588ebdf0dedf4e252ffa8)\r\n2023-10-04 18:22:31.038-07:00 | nioEventLoopGroup-3-2 | INFO  | BlockPropagationManager | Saved announced block for future import 17086 (0x92954f4e479d37c0711169ece926fdabd3f3bf66c8a407a57b9c2ede1de0d1df) - 10 saved block(s)\r\n2023-10-04 18:22:31.038-07:00 | nioEventLoopGroup-3-2 | INFO  | BlockPropagationManager | Retrieving parent 0x2cdc4f1edd62d3d8e70db61f1ba3bae2b00530d0895cde423487ef05a0d9fb49 of block 17086 (0x92954f4e479d37c0711169ece926fdabd3f3bf66c8a407a57b9c2ede1de0d1df)\r\n2023-10-04 18:22:31.041-07:00 | nioEventLoopGroup-3-2 | INFO  | BlockPropagationManager | Saved announced block for future import 17085 (0x2cdc4f1edd62d3d8e70db61f1ba3bae2b00530d0895cde423487ef05a0d9fb49) - 11 saved block(s)\r\n2023-10-04 18:22:31.041-07:00 | nioEventLoopGroup-3-2 | INFO  | BlockPropagationManager | Retrieving parent 0x49454ea5798a66d744663d789c709f31516eda3c19001c72a556ea11e0103c6f of block 17085 (0x2cdc4f1edd62d3d8e70db61f1ba3bae2b00530d0895cde423487ef05a0d9fb49)\r\n2023-10-04 18:22:31.046-07:00 | EthScheduler-Workers-0 | INFO  | BonsaiWorldStateProvider | rolling mutableState blockHash 0x28b1d6e36173a75b905391390022f13eafff0522cd2909dbdc563cb36c2ecd26 to blockhash 0x6755091b4bd81ef4994b1b6256ceb01a3fccce8f1626baffcdfb54569f113f3c\r\n2023-10-04 18:22:31.046-07:00 | EthScheduler-Workers-0 | INFO  | BonsaiWorldStateProvider | Rollforward 0x6755091b4bd81ef4994b1b6256ceb01a3fccce8f1626baffcdfb54569f113f3c\r\n2023-10-04 18:22:31.046-07:00 | EthScheduler-Workers-0 | INFO  | BonsaiWorldStateProvider | Archive rolling failed for block hash 0x6755091b4bd81ef4994b1b6256ceb01a3fccce8f1626baffcdfb54569f113f3c\r\njava.util.NoSuchElementException: No value present\r\n\tat java.base/java.util.Optional.get(Optional.java:143)\r\n\tat org.hyperledger.besu.ethereum.bonsai.BonsaiWorldStateProvider.rollMutableStateToBlockHash(BonsaiWorldStateProvider.java:218)\r\n\tat org.hyperledger.besu.ethereum.bonsai.BonsaiWorldStateProvider.getMutable(BonsaiWorldStateProvider.java:184)\r\n\tat org.hyperledger.besu.ethereum.bonsai.BonsaiWorldStateProvider.getMutable(BonsaiWorldStateProvider.java:160)\r\n\tat org.hyperledger.besu.ethereum.MainnetBlockValidator.validateAndProcessBlock(MainnetBlockValidator.java:124)\r\n\tat org.hyperledger.besu.ethereum.MainnetBlockValidator.validateAndProcessBlock(MainnetBlockValidator.java:72)\r\n\tat org.hyperledger.besu.ethereum.mainnet.MainnetBlockImporter.importBlock(MainnetBlockImporter.java:45)\r\n\tat org.hyperledger.besu.ethereum.core.BlockImporter.importBlock(BlockImporter.java:45)\r\n\tat org.hyperledger.besu.ethereum.eth.sync.tasks.PersistBlockTask.executeTask(PersistBlockTask.java:203)\r\n\tat org.hyperledger.besu.ethereum.eth.manager.task.AbstractEthTask.executeTaskTimed(AbstractEthTask.java:150)\r\n\tat org.hyperledger.besu.ethereum.eth.manager.task.AbstractEthTask.run(AbstractEthTask.java:75)\r\n\tat org.hyperledger.besu.ethereum.eth.sync.BlockPropagationManager.runImportTask(BlockPropagationManager.java:692)\r\n\tat org.hyperledger.besu.ethereum.eth.sync.BlockPropagationManager.validateAndProcessPendingBlock(BlockPropagationManager.java:671)\r\n\tat org.hyperledger.besu.ethereum.eth.sync.BlockPropagationManager.lambda$importOrSavePendingBlock$21(BlockPropagationManager.java:617)\r\n\tat org.hyperledger.besu.util.FutureUtils.propagateResult(FutureUtils.java:98)\r\n\tat org.hyperledger.besu.ethereum.eth.manager.EthScheduler.lambda$scheduleSyncWorkerTask$0(EthScheduler.java:110)\r\n\tat java.base/java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:539)\r\n\tat java.base/java.util.concurrent.FutureTask.run(FutureTask.java:264)\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1136)\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:635)\r\n\tat java.base/java.lang.Thread.run(Thread.java:833)\r\n2023-10-04 18:22:31.048-07:00 | EthScheduler-Workers-0 | INFO  | DefaultSynchronizer | Stopping synchronizer\r\n2023-10-04 18:22:31.048-07:00 | EthScheduler-Workers-0 | INFO  | FastSyncDownloader | Stopping fast sync\r\n2023-10-04 18:22:31.056-07:00 | EthScheduler-Workers-0 | INFO  | DefaultSynchronizer |\r\n####################################################################################################\r\n#                                                                                                  #\r\n# Besu has identified a problem with its worldstate database.                                      #\r\n# Your node will fetch the correct data from peers to repair the problem.                          #\r\n# Starting the sync pipeline...                                                                    #\r\n#                                                                                                  #\r\n####################################################################################################\r\n2023-10-04 18:22:31.057-07:00 | EthScheduler-Workers-0 | INFO  | TransactionPoolFactory | Disabling transaction handling during re-sync\r\n```\r\n### Versions (Add all that apply)\r\n* Software version: [`besu --version`]\r\n* Java version: [`java -version`]\r\n* OS Name & Version: [`cat /etc/*release`]\r\n* Kernel Version: [`uname -a`]\r\n* Virtual Machine software & version: [`vmware -v`]\r\n* Docker Version: [`docker version`]\r\n* Cloud VM, type, size: [Amazon Web Services I3-large]\r\n* Consensus Client & Version if using Proof of Stake: [e.g. Teku, Lighthouse, Prysm, Nimbus, Lodestar]\r\n\r\n### Smart contract information (If you're reporting an issue arising from deploying or calling a smart contract, please supply related information)\r\n* Solidity version [`solc --version`]\r\n* Repo with minimal set of deployable/reproducible contract code - please provide a link\r\n* Please include specifics on how you are deploying/calling the contract \r\n* Have you reproduced the issue on other eth clients\r\n\r\n### Additional Information (Add any of the following or anything else that may be relevant)\r\n* Besu setup info - genesis file, config options\r\n* System info - memory, CPU\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/5987/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/hyperledger/besu/issues/5987/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1747912975",
    "html_url": "https://github.com/hyperledger/besu/issues/5987#issuecomment-1747912975",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/5987",
    "id": 1747912975,
    "node_id": "IC_kwDODE2jmc5oLwkP",
    "user": {
      "login": "garyschulte",
      "id": 1238512,
      "node_id": "MDQ6VXNlcjEyMzg1MTI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1238512?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/garyschulte",
      "html_url": "https://github.com/garyschulte",
      "followers_url": "https://api.github.com/users/garyschulte/followers",
      "following_url": "https://api.github.com/users/garyschulte/following{/other_user}",
      "gists_url": "https://api.github.com/users/garyschulte/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/garyschulte/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/garyschulte/subscriptions",
      "organizations_url": "https://api.github.com/users/garyschulte/orgs",
      "repos_url": "https://api.github.com/users/garyschulte/repos",
      "events_url": "https://api.github.com/users/garyschulte/events{/privacy}",
      "received_events_url": "https://api.github.com/users/garyschulte/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-10-05T01:47:48Z",
    "updated_at": "2023-10-05T01:47:48Z",
    "author_association": "CONTRIBUTOR",
    "body": "incidentally, the trie repair/healing process that is triggered fails also due to a missing trielog",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1747912975/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
