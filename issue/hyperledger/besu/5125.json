{
  "url": "https://api.github.com/repos/hyperledger/besu/issues/5125",
  "repository_url": "https://api.github.com/repos/hyperledger/besu",
  "labels_url": "https://api.github.com/repos/hyperledger/besu/issues/5125/labels{/name}",
  "comments_url": "https://api.github.com/repos/hyperledger/besu/issues/5125/comments",
  "events_url": "https://api.github.com/repos/hyperledger/besu/issues/5125/events",
  "html_url": "https://github.com/hyperledger/besu/issues/5125",
  "id": 1595597212,
  "node_id": "I_kwDODE2jmc5fGuGc",
  "number": 5125,
  "title": "Unable to recover after worldstate database issue",
  "user": {
    "login": "tiagocmachado",
    "id": 30123077,
    "node_id": "MDQ6VXNlcjMwMTIzMDc3",
    "avatar_url": "https://avatars.githubusercontent.com/u/30123077?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tiagocmachado",
    "html_url": "https://github.com/tiagocmachado",
    "followers_url": "https://api.github.com/users/tiagocmachado/followers",
    "following_url": "https://api.github.com/users/tiagocmachado/following{/other_user}",
    "gists_url": "https://api.github.com/users/tiagocmachado/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tiagocmachado/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tiagocmachado/subscriptions",
    "organizations_url": "https://api.github.com/users/tiagocmachado/orgs",
    "repos_url": "https://api.github.com/users/tiagocmachado/repos",
    "events_url": "https://api.github.com/users/tiagocmachado/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tiagocmachado/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2023-02-22T18:27:42Z",
  "updated_at": "2023-03-22T22:17:11Z",
  "closed_at": "2023-03-22T22:17:10Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Description\r\n```Feb 22 17:40:02  besu[2293926]: 2023-02-22 17:40:02.044+00:00 | PoS-Block-Builder-0 | INFO  | DefaultSynchronizer |\r\nFeb 22 17:40:02  besu[2293926]: ####################################################################################################\r\nFeb 22 17:40:02  besu[2293926]: #                                                                                                  #\r\nFeb 22 17:40:02  besu[2293926]: # Besu has identified a problem with its worldstate database.                                      #\r\nFeb 22 17:40:02  besu[2293926]: # Your node will fetch the correct data from peers to repair the problem.                          #\r\nFeb 22 17:40:02  besu[2293926]: # Starting the sync pipeline...                                                                    #\r\nFeb 22 17:40:02  besu[2293926]: #                                                                                                  #\r\nFeb 22 17:40:02  besu[2293926]: ####################################################################################################\r\nFeb 22 17:40:02  besu[2293926]: 2023-02-22 17:40:02.045+00:00 | PoS-Block-Builder-0 | INFO  | TransactionPoolFactory | Disabling transaction handling during re-sync\r\nFeb 22 17:40:02  besu[2293926]: 2023-02-22 17:40:02.048+00:00 | PoS-Block-Builder-0 | WARN  | BonsaiWorldStateArchive | Invalid node for account 0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2 at location 0x\r\nFeb 22 17:40:02  besu[2293926]: 2023-02-22 17:40:02.174+00:00 | PoS-Block-Builder-0 | INFO  | DefaultSynchronizer | Starting synchronizer.\r\nFeb 22 17:40:02  besu[2293926]: 2023-02-22 17:40:02.174+00:00 | PoS-Block-Builder-0 | INFO  | FastSyncDownloader | Starting sync\r\nFeb 22 17:40:02  besu[2293926]: 2023-02-22 17:40:02.201+00:00 | PoS-Block-Builder-0 | WARN  | MergeCoordinator | Block 0x79cc23a8748c1bc32a46de0756174a0623c06620791fb3db22575b4fce103d42 built for proposal identified by 0x0019b5d189a74885, is not valid reason Optional[Unable to load trie node value for hash 0x05378128769b8e4878cdca04aa5bff604a88306aab6afe970158591842391ca4 location 0x]\r\nFeb 22 17:40:02  besu[2293926]: 2023-02-22 17:40:02.201+00:00 | PoS-Block-Builder-0 | WARN  | MergeCoordinator | caused by\r\nFeb 22 17:40:02  besu[2293926]: org.hyperledger.besu.ethereum.trie.MerkleTrieException: Unable to load trie node value for hash 0x05378128769b8e4878cdca04aa5bff604a88306aab6afe970158591842391ca4 location 0x\r\nFeb 22 17:40:02  besu[2293926]:         at org.hyperledger.besu.ethereum.bonsai.BonsaiWorldStateUpdater.getStorageValueBySlotHash(BonsaiWorldStateUpdater.java:418)\r\nFeb 22 17:40:02  besu[2293926]:         at org.hyperledger.besu.ethereum.bonsai.BonsaiWorldStateUpdater.getStorageValue(BonsaiWorldStateUpdater.java:375)\r\nFeb 22 17:40:02  besu[2293926]:         at org.hyperledger.besu.ethereum.bonsai.BonsaiAccount.getStorageValue(BonsaiAccount.java:208)\r\nFeb 22 17:40:02  besu[2293926]:         at org.hyperledger.besu.evm.worldstate.UpdateTrackingAccount.getStorageValue(UpdateTrackingAccount.java:231)\r\nFeb 22 17:40:02  besu[2293926]:         at org.hyperledger.besu.evm.worldstate.UpdateTrackingAccount.getStorageValue(UpdateTrackingAccount.java:231)\r\nFeb 22 17:40:02  besu[2293926]:         at org.hyperledger.besu.evm.worldstate.UpdateTrackingAccount.getStorageValue(UpdateTrackingAccount.java:231)\r\nFeb 22 17:40:02  besu[2293926]:         at org.hyperledger.besu.evm.worldstate.UpdateTrackingAccount.getStorageValue(UpdateTrackingAccount.java:231)\r\nFeb 22 17:40:02  besu[2293926]:         at org.hyperledger.besu.evm.operation.SLoadOperation.execute(SLoadOperation.java:64)\r\nFeb 22 17:40:02  besu[2293926]:         at org.hyperledger.besu.evm.EVM.runToHalt(EVM.java:307)\r\nFeb 22 17:40:02  besu[2293926]:         at org.hyperledger.besu.evm.processor.AbstractMessageProcessor.codeExecute(AbstractMessageProcessor.java:174)\r\nFeb 22 17:40:02  besu[2293926]:         at org.hyperledger.besu.evm.processor.AbstractMessageProcessor.process(AbstractMessageProcessor.java:192)\r\nFeb 22 17:40:02  besu[2293926]:         at org.hyperledger.besu.ethereum.mainnet.MainnetTransactionProcessor.process(MainnetTransactionProcessor.java:495)\r\nFeb 22 17:40:02  besu[2293926]:         at org.hyperledger.besu.ethereum.mainnet.MainnetTransactionProcessor.processTransaction(MainnetTransactionProcessor.java:405)\r\nFeb 22 17:40:02  besu[2293926]:         at org.hyperledger.besu.ethereum.mainnet.AbstractBlockProcessor.processBlock(AbstractBlockProcessor.java:110)\r\nFeb 22 17:40:02  besu[2293926]:         at org.hyperledger.besu.ethereum.mainnet.BlockProcessor.processBlock(BlockProcessor.java:78)\r\nFeb 22 17:40:02  besu[2293926]:         at org.hyperledger.besu.ethereum.MainnetBlockValidator.processBlock(MainnetBlockValidator.java:218)\r\nFeb 22 17:40:02  besu[2293926]:         at org.hyperledger.besu.ethereum.MainnetBlockValidator.validateAndProcessBlock(MainnetBlockValidator.java:135)\r\nFeb 22 17:40:02  besu[2293926]:         at org.hyperledger.besu.consensus.merge.blockcreation.MergeCoordinator.validateBlock(MergeCoordinator.java:477)\r\nFeb 22 17:40:02  besu[2293926]:         at org.hyperledger.besu.consensus.merge.blockcreation.MergeCoordinator.evaluateNewBlock(MergeCoordinator.java:394)\r\nFeb 22 17:40:02  besu[2293926]:         at org.hyperledger.besu.consensus.merge.blockcreation.MergeCoordinator.recoverableBlockCreation(MergeCoordinator.java:374)\r\nFeb 22 17:40:02  besu[2293926]:         at org.hyperledger.besu.consensus.merge.blockcreation.MergeCoordinator.retryBlockCreationUntilUseful(MergeCoordinator.java:349)\r\nFeb 22 17:40:02  besu[2293926]:         at org.hyperledger.besu.consensus.merge.blockcreation.MergeCoordinator.lambda$tryToBuildBetterBlock$5(MergeCoordinator.java:324)\r\nFeb 22 17:40:02  besu[2293926]:         at java.base/java.util.concurrent.CompletableFuture$AsyncRun.run(CompletableFuture.java:1804)\r\nFeb 22 17:40:02  besu[2293926]:         at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1136)\r\nFeb 22 17:40:02  besu[2293926]:         at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:635)\r\nFeb 22 17:40:02  besu[2293926]:         at java.base/java.lang.Thread.run(Thread.java:833)\r\nFeb 22 17:40:05  besu[2293926]: 2023-02-22 17:40:05.992+00:00 | nioEventLoopGroup-3-5 | INFO  | SnapWorldStateDownloader | Downloading world state from peers for pivot block 16685482 (0x24621a3f3244fc8a56a3e43c64b473fb5d480f5f88a8e2b8f24787d0a03e7197). State root 0xe2832af17f9c6ecacbc2f007fcf0931596c65a56a90d23d06e67f4b4d8a8ce46 pending requests 0\r\nFeb 22 17:40:06  besu[2293926]: pure virtual method called\r\nFeb 22 17:40:06  besu[2293926]: terminate called without an active exception\r\n```\r\n\r\n\r\nAfter the message above the node got stuck with the following error Invalid Block:\r\n```\r\nFeb 22 18:01:00 besu[2332961]: 2023-02-22 18:01:00.521+00:00 | nioEventLoopGroup-3-6 | INFO  | MainnetBlockValidator | Invalid block 16685512 (0x4bc825d559d74804787bbac90ef9e2b8778b85d2c536d57c8eb3c9eeb53c251c): Optional[World State Root does not match expected value, header 0xc08f00d346865520c2790ded1b040b42d9be89a4c61c4d3dd9a8cb19f65703c0 calculated 0x484bf5f88155a3e162bf00d29bf4e256268ef3d7773f7e7dbb11c77b09f9ca18], caused by java.lang.RuntimeException: World State Root does not match expected value, header 0xc08f00d346865520c2790ded1b040b42d9be89a4c61c4d3dd9a8cb19f65703c0 calculated 0x484bf5f88155a3e162bf00d29bf4e256268ef3d7773f7e7dbb11c77b09f9ca18\r\n```\r\n\r\n\r\n### Versions (Add all that apply)\r\n* Software version: v23.1.0\r\n* Java version: \r\nopenjdk 17.0.5 2022-10-18\r\nOpenJDK Runtime Environment (build 17.0.5+8-Ubuntu-2ubuntu122.04)\r\nOpenJDK 64-Bit Server VM (build 17.0.5+8-Ubuntu-2ubuntu122.04, mixed mode, sharing)\r\n* OS Name & Version:\r\nDISTRIB_ID=Ubuntu\r\nDISTRIB_RELEASE=22.04\r\nDISTRIB_CODENAME=jammy\r\nDISTRIB_DESCRIPTION=\"Ubuntu 22.04.2 LTS\"\r\nPRETTY_NAME=\"Ubuntu 22.04.2 LTS\"\r\nNAME=\"Ubuntu\"\r\nVERSION_ID=\"22.04\"\r\nVERSION=\"22.04.2 LTS (Jammy Jellyfish)\"\r\nVERSION_CODENAME=jammy\r\nID=ubuntu\r\nID_LIKE=debian\r\nHOME_URL=\"https://www.ubuntu.com/\"\r\nSUPPORT_URL=\"https://help.ubuntu.com/\"\r\nBUG_REPORT_URL=\"https://bugs.launchpad.net/ubuntu/\"\r\nPRIVACY_POLICY_URL=\"https://www.ubuntu.com/legal/terms-and-policies/privacy-policy\"\r\nUBUNTU_CODENAME=jammy\r\n\r\n",
  "closed_by": {
    "login": "matkt",
    "id": 26581503,
    "node_id": "MDQ6VXNlcjI2NTgxNTAz",
    "avatar_url": "https://avatars.githubusercontent.com/u/26581503?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/matkt",
    "html_url": "https://github.com/matkt",
    "followers_url": "https://api.github.com/users/matkt/followers",
    "following_url": "https://api.github.com/users/matkt/following{/other_user}",
    "gists_url": "https://api.github.com/users/matkt/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/matkt/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/matkt/subscriptions",
    "organizations_url": "https://api.github.com/users/matkt/orgs",
    "repos_url": "https://api.github.com/users/matkt/repos",
    "events_url": "https://api.github.com/users/matkt/events{/privacy}",
    "received_events_url": "https://api.github.com/users/matkt/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/5125/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/hyperledger/besu/issues/5125/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1441530414",
    "html_url": "https://github.com/hyperledger/besu/issues/5125#issuecomment-1441530414",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/5125",
    "id": 1441530414,
    "node_id": "IC_kwDODE2jmc5V7AIu",
    "user": {
      "login": "matkt",
      "id": 26581503,
      "node_id": "MDQ6VXNlcjI2NTgxNTAz",
      "avatar_url": "https://avatars.githubusercontent.com/u/26581503?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/matkt",
      "html_url": "https://github.com/matkt",
      "followers_url": "https://api.github.com/users/matkt/followers",
      "following_url": "https://api.github.com/users/matkt/following{/other_user}",
      "gists_url": "https://api.github.com/users/matkt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/matkt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/matkt/subscriptions",
      "organizations_url": "https://api.github.com/users/matkt/orgs",
      "repos_url": "https://api.github.com/users/matkt/repos",
      "events_url": "https://api.github.com/users/matkt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/matkt/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-02-23T10:36:21Z",
    "updated_at": "2023-02-23T10:36:21Z",
    "author_association": "CONTRIBUTOR",
    "body": "just to know did you tried to restart besu ?\r\n\r\nand could you give the configuration of your Besu node ?",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1441530414/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1441532754",
    "html_url": "https://github.com/hyperledger/besu/issues/5125#issuecomment-1441532754",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/5125",
    "id": 1441532754,
    "node_id": "IC_kwDODE2jmc5V7AtS",
    "user": {
      "login": "matkt",
      "id": 26581503,
      "node_id": "MDQ6VXNlcjI2NTgxNTAz",
      "avatar_url": "https://avatars.githubusercontent.com/u/26581503?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/matkt",
      "html_url": "https://github.com/matkt",
      "followers_url": "https://api.github.com/users/matkt/followers",
      "following_url": "https://api.github.com/users/matkt/following{/other_user}",
      "gists_url": "https://api.github.com/users/matkt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/matkt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/matkt/subscriptions",
      "organizations_url": "https://api.github.com/users/matkt/orgs",
      "repos_url": "https://api.github.com/users/matkt/repos",
      "events_url": "https://api.github.com/users/matkt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/matkt/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-02-23T10:38:14Z",
    "updated_at": "2023-02-23T10:38:14Z",
    "author_association": "CONTRIBUTOR",
    "body": "It maybe related to the fix I added recently in the main branch https://github.com/hyperledger/besu/commit/17455d62e9a8179eae775e66e51ef4c0e7b96882\r\nI think running this commit can help you if you are ok to run a non released version",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1441532754/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1441603485",
    "html_url": "https://github.com/hyperledger/besu/issues/5125#issuecomment-1441603485",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/5125",
    "id": 1441603485,
    "node_id": "IC_kwDODE2jmc5V7R-d",
    "user": {
      "login": "tiagocmachado",
      "id": 30123077,
      "node_id": "MDQ6VXNlcjMwMTIzMDc3",
      "avatar_url": "https://avatars.githubusercontent.com/u/30123077?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tiagocmachado",
      "html_url": "https://github.com/tiagocmachado",
      "followers_url": "https://api.github.com/users/tiagocmachado/followers",
      "following_url": "https://api.github.com/users/tiagocmachado/following{/other_user}",
      "gists_url": "https://api.github.com/users/tiagocmachado/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tiagocmachado/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tiagocmachado/subscriptions",
      "organizations_url": "https://api.github.com/users/tiagocmachado/orgs",
      "repos_url": "https://api.github.com/users/tiagocmachado/repos",
      "events_url": "https://api.github.com/users/tiagocmachado/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tiagocmachado/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-02-23T11:32:21Z",
    "updated_at": "2023-02-23T11:32:21Z",
    "author_association": "NONE",
    "body": "> just to know did you tried to restart besu ?\r\n> \r\n> and could you give the configuration of your Besu node ?\r\n\r\nYes after restart I just got stuck with the following:\r\n```Feb 22 18:01:00 besu[2332961]: 2023-02-22 18:01:00.521+00:00 | nioEventLoopGroup-3-6 | INFO  | MainnetBlockValidator | Invalid block 16685512 (0x4bc825d559d74804787bbac90ef9e2b8778b85d2c536d57c8eb3c9eeb53c251c): Optional[World State Root does not match expected value, header 0xc08f00d346865520c2790ded1b040b42d9be89a4c61c4d3dd9a8cb19f65703c0 calculated 0x484bf5f88155a3e162bf00d29bf4e256268ef3d7773f7e7dbb11c77b09f9ca18], caused by java.lang.RuntimeException: World State Root does not match expected value, header 0xc08f00d346865520c2790ded1b040b42d9be89a4c61c4d3dd9a8cb19f65703c0 calculated 0x484bf5f88155a3e162bf00d29bf4e256268ef3d7773f7e7dbb11c77b09f9ca18```\r\n\r\n\r\nThe relevant config is:\r\n\r\nbesu   --network=mainnet --sync-mode=X_CHECKPOINT  --data-storage-format=BONSAI  --metrics-enabled=true  --Xplugin-rocksdb-high-spec-enabled",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1441603485/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1480329961",
    "html_url": "https://github.com/hyperledger/besu/issues/5125#issuecomment-1480329961",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/5125",
    "id": 1480329961,
    "node_id": "IC_kwDODE2jmc5YPArp",
    "user": {
      "login": "matkt",
      "id": 26581503,
      "node_id": "MDQ6VXNlcjI2NTgxNTAz",
      "avatar_url": "https://avatars.githubusercontent.com/u/26581503?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/matkt",
      "html_url": "https://github.com/matkt",
      "followers_url": "https://api.github.com/users/matkt/followers",
      "following_url": "https://api.github.com/users/matkt/following{/other_user}",
      "gists_url": "https://api.github.com/users/matkt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/matkt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/matkt/subscriptions",
      "organizations_url": "https://api.github.com/users/matkt/orgs",
      "repos_url": "https://api.github.com/users/matkt/repos",
      "events_url": "https://api.github.com/users/matkt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/matkt/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-22T22:17:08Z",
    "updated_at": "2023-03-22T22:17:08Z",
    "author_association": "CONTRIBUTOR",
    "body": "closed this must be fixed in the last release ",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1480329961/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
