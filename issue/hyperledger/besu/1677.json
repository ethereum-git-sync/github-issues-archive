{
  "url": "https://api.github.com/repos/hyperledger/besu/issues/1677",
  "repository_url": "https://api.github.com/repos/hyperledger/besu",
  "labels_url": "https://api.github.com/repos/hyperledger/besu/issues/1677/labels{/name}",
  "comments_url": "https://api.github.com/repos/hyperledger/besu/issues/1677/comments",
  "events_url": "https://api.github.com/repos/hyperledger/besu/issues/1677/events",
  "html_url": "https://github.com/hyperledger/besu/issues/1677",
  "id": 759543227,
  "node_id": "MDU6SXNzdWU3NTk1NDMyMjc=",
  "number": 1677,
  "title": "Readiness check weirdness",
  "user": {
    "login": "e-nikolov",
    "id": 1100051,
    "node_id": "MDQ6VXNlcjExMDAwNTE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1100051?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/e-nikolov",
    "html_url": "https://github.com/e-nikolov",
    "followers_url": "https://api.github.com/users/e-nikolov/followers",
    "following_url": "https://api.github.com/users/e-nikolov/following{/other_user}",
    "gists_url": "https://api.github.com/users/e-nikolov/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/e-nikolov/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/e-nikolov/subscriptions",
    "organizations_url": "https://api.github.com/users/e-nikolov/orgs",
    "repos_url": "https://api.github.com/users/e-nikolov/repos",
    "events_url": "https://api.github.com/users/e-nikolov/events{/privacy}",
    "received_events_url": "https://api.github.com/users/e-nikolov/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1537362490,
      "node_id": "MDU6TGFiZWwxNTM3MzYyNDkw",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/bug",
      "name": "bug",
      "color": "d73a4a",
      "default": true,
      "description": "Something isn't working"
    },
    {
      "id": 2051683573,
      "node_id": "MDU6TGFiZWwyMDUxNjgzNTcz",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/P3",
      "name": "P3",
      "color": "ffff00",
      "default": false,
      "description": "Medium (ex: JSON-RPC request not working with a specific client library due to loose spec assumtion)"
    },
    {
      "id": 2152224197,
      "node_id": "MDU6TGFiZWwyMTUyMjI0MTk3",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/TeamRevenant",
      "name": "TeamRevenant",
      "color": "78e298",
      "default": false,
      "description": "GH issues worked on by Revenant Team"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "mark-terry",
    "id": 36909937,
    "node_id": "MDQ6VXNlcjM2OTA5OTM3",
    "avatar_url": "https://avatars.githubusercontent.com/u/36909937?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mark-terry",
    "html_url": "https://github.com/mark-terry",
    "followers_url": "https://api.github.com/users/mark-terry/followers",
    "following_url": "https://api.github.com/users/mark-terry/following{/other_user}",
    "gists_url": "https://api.github.com/users/mark-terry/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mark-terry/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mark-terry/subscriptions",
    "organizations_url": "https://api.github.com/users/mark-terry/orgs",
    "repos_url": "https://api.github.com/users/mark-terry/repos",
    "events_url": "https://api.github.com/users/mark-terry/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mark-terry/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "mark-terry",
      "id": 36909937,
      "node_id": "MDQ6VXNlcjM2OTA5OTM3",
      "avatar_url": "https://avatars.githubusercontent.com/u/36909937?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mark-terry",
      "html_url": "https://github.com/mark-terry",
      "followers_url": "https://api.github.com/users/mark-terry/followers",
      "following_url": "https://api.github.com/users/mark-terry/following{/other_user}",
      "gists_url": "https://api.github.com/users/mark-terry/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mark-terry/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mark-terry/subscriptions",
      "organizations_url": "https://api.github.com/users/mark-terry/orgs",
      "repos_url": "https://api.github.com/users/mark-terry/repos",
      "events_url": "https://api.github.com/users/mark-terry/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mark-terry/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2020-12-08T15:31:59Z",
  "updated_at": "2021-01-07T12:15:57Z",
  "closed_at": "2020-12-30T22:37:56Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "<!-- Have you done the following? -->\r\n<!--   * read the Code of Conduct? By filing an Issue, you are expected to -->  \r\n<!--     comply with it, including treating everyone with respect: -->\r\n<!--     https://github.com/hyperledger/besu/blob/master/CODE-OF-CONDUCT.md -->\r\n<!--   * Reproduced the issue in the latest version of the software -->\r\n<!--   * Read the debugging wiki: https://github.com/hyperledger/besu/wiki/debugging -->\r\n<!--   * Duplicate Issue check:  https://github.com/search?q=+is%3Aissue+repo%3Ahyperledger/Besu -->\r\n<!-- Note:  Not all sections will apply to all issue types. -->\r\n\r\n### Description\r\n\r\nI am running a besu node for the ropsten test-net and the readiness checks kept randomly cycling between UP and DOWN every few seconds. I checked the container logs and it wasn't actually syncing and was throwing exceptions about being out of memory, but not crashing. I checked the last block synced and it was from about 40 hours before that. I was confused about why the readiness checks sometimes showed as UP even though the node was nowhere near being synced.\r\n\r\nI checked the code of the readiness check in the github repo:\r\nhttps://github.com/hyperledger/besu/blob/8b6f8b6e2f8f498af71523580eb0d6e6779d06c7/ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/health/ReadinessCheck.java\r\n\r\nhttps://github.com/hyperledger/besu/blob/bbcc438244b9966e95ee693150323208c42a87f6/ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/sync/DefaultSynchronizer.java\r\n\r\n```\r\n  public boolean isHealthy(final HealthService.ParamSource params) {\r\n    LOG.debug(\"Invoking readiness check.\");\r\n    if (p2pNetwork.isP2pEnabled()) {\r\n      final int peerCount = p2pNetwork.getPeerCount();\r\n      if (!hasMinimumPeers(params, peerCount)) {\r\n        return false;\r\n      }\r\n    }\r\n    return synchronizer\r\n        .getSyncStatus()\r\n        .map(syncStatus -> isInSync(syncStatus, params))\r\n        .orElse(true);\r\n  }\r\n\r\n```\r\n```\r\n  public Optional<SyncStatus> getSyncStatus() {\r\n    if (!running.get()) {\r\n      return Optional.empty();\r\n    }\r\n    return syncState.syncStatus();\r\n  }\r\n```\r\n\r\nI noticed that if the synchronizer isn't running, an Optional.empty() is returned by the getSyncStatus() function, and the health check has .orElse(true). Does that mean that if the synchronizer is temporarily down the readiness check will return \"UP\" as long as there are enough peers connected?.\r\n\r\n\r\n### Versions (Add all that apply)\r\n* Software version: [`besu --version`]\r\ndocker image hyperledger/besu:1.4.4\r\n\r\n",
  "closed_by": {
    "login": "lucassaldanha",
    "id": 1766440,
    "node_id": "MDQ6VXNlcjE3NjY0NDA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1766440?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/lucassaldanha",
    "html_url": "https://github.com/lucassaldanha",
    "followers_url": "https://api.github.com/users/lucassaldanha/followers",
    "following_url": "https://api.github.com/users/lucassaldanha/following{/other_user}",
    "gists_url": "https://api.github.com/users/lucassaldanha/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/lucassaldanha/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/lucassaldanha/subscriptions",
    "organizations_url": "https://api.github.com/users/lucassaldanha/orgs",
    "repos_url": "https://api.github.com/users/lucassaldanha/repos",
    "events_url": "https://api.github.com/users/lucassaldanha/events{/privacy}",
    "received_events_url": "https://api.github.com/users/lucassaldanha/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/1677/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/hyperledger/besu/issues/1677/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/745315975",
    "html_url": "https://github.com/hyperledger/besu/issues/1677#issuecomment-745315975",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/1677",
    "id": 745315975,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc0NTMxNTk3NQ==",
    "user": {
      "login": "mark-terry",
      "id": 36909937,
      "node_id": "MDQ6VXNlcjM2OTA5OTM3",
      "avatar_url": "https://avatars.githubusercontent.com/u/36909937?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mark-terry",
      "html_url": "https://github.com/mark-terry",
      "followers_url": "https://api.github.com/users/mark-terry/followers",
      "following_url": "https://api.github.com/users/mark-terry/following{/other_user}",
      "gists_url": "https://api.github.com/users/mark-terry/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mark-terry/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mark-terry/subscriptions",
      "organizations_url": "https://api.github.com/users/mark-terry/orgs",
      "repos_url": "https://api.github.com/users/mark-terry/repos",
      "events_url": "https://api.github.com/users/mark-terry/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mark-terry/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-12-15T14:22:39Z",
    "updated_at": "2020-12-15T14:22:39Z",
    "author_association": "CONTRIBUTOR",
    "body": "@e-nikolov I've taken a look and your analysis seems pretty correct - if the synchronizer is down / not running *and* you've got the minimum required peers connected, it reports as healthy. From the description you've provided, it sounds like you may have encountered an edge case where the synchronizer is starting and running out of memory, causing the readiness check value to cycle as the synchronizer starts and stops.\r\n\r\nThe memory exceptions sound like an environment / configuration issue. Were you able to resolve this?",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/745315975/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/745389255",
    "html_url": "https://github.com/hyperledger/besu/issues/1677#issuecomment-745389255",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/1677",
    "id": 745389255,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc0NTM4OTI1NQ==",
    "user": {
      "login": "e-nikolov",
      "id": 1100051,
      "node_id": "MDQ6VXNlcjExMDAwNTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1100051?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/e-nikolov",
      "html_url": "https://github.com/e-nikolov",
      "followers_url": "https://api.github.com/users/e-nikolov/followers",
      "following_url": "https://api.github.com/users/e-nikolov/following{/other_user}",
      "gists_url": "https://api.github.com/users/e-nikolov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/e-nikolov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/e-nikolov/subscriptions",
      "organizations_url": "https://api.github.com/users/e-nikolov/orgs",
      "repos_url": "https://api.github.com/users/e-nikolov/repos",
      "events_url": "https://api.github.com/users/e-nikolov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/e-nikolov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-12-15T16:04:01Z",
    "updated_at": "2020-12-15T16:04:01Z",
    "author_association": "NONE",
    "body": "I manually killed the kubernetes pod which caused it to get recreated and it's been running fine since. But I would expect that the node crashes on its own if it has insufficient memory rather than remaining in this broken state.",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/745389255/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/755208099",
    "html_url": "https://github.com/hyperledger/besu/issues/1677#issuecomment-755208099",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/1677",
    "id": 755208099,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc1NTIwODA5OQ==",
    "user": {
      "login": "e-nikolov",
      "id": 1100051,
      "node_id": "MDQ6VXNlcjExMDAwNTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1100051?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/e-nikolov",
      "html_url": "https://github.com/e-nikolov",
      "followers_url": "https://api.github.com/users/e-nikolov/followers",
      "following_url": "https://api.github.com/users/e-nikolov/following{/other_user}",
      "gists_url": "https://api.github.com/users/e-nikolov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/e-nikolov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/e-nikolov/subscriptions",
      "organizations_url": "https://api.github.com/users/e-nikolov/orgs",
      "repos_url": "https://api.github.com/users/e-nikolov/repos",
      "events_url": "https://api.github.com/users/e-nikolov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/e-nikolov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-01-06T10:07:08Z",
    "updated_at": "2021-01-06T10:07:08Z",
    "author_association": "NONE",
    "body": "@lucassaldanha Why was this issue closed? As far as I can tell the reported behaviour is still happening.",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/755208099/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/756081443",
    "html_url": "https://github.com/hyperledger/besu/issues/1677#issuecomment-756081443",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/1677",
    "id": 756081443,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc1NjA4MTQ0Mw==",
    "user": {
      "login": "mark-terry",
      "id": 36909937,
      "node_id": "MDQ6VXNlcjM2OTA5OTM3",
      "avatar_url": "https://avatars.githubusercontent.com/u/36909937?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mark-terry",
      "html_url": "https://github.com/mark-terry",
      "followers_url": "https://api.github.com/users/mark-terry/followers",
      "following_url": "https://api.github.com/users/mark-terry/following{/other_user}",
      "gists_url": "https://api.github.com/users/mark-terry/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mark-terry/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mark-terry/subscriptions",
      "organizations_url": "https://api.github.com/users/mark-terry/orgs",
      "repos_url": "https://api.github.com/users/mark-terry/repos",
      "events_url": "https://api.github.com/users/mark-terry/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mark-terry/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-01-07T12:15:56Z",
    "updated_at": "2021-01-07T12:15:56Z",
    "author_association": "CONTRIBUTOR",
    "body": "@e-nikolov This ticket was closed because we've tried, but haven't been able to replicate the state that produced the reported behaviour.\r\n\r\nPlease create another issue if you encounter the reported behaviour again. If you're able to provide replication steps, that'd be very helpful.",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/756081443/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
