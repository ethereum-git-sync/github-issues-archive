{
  "url": "https://api.github.com/repos/hyperledger/besu/issues/4091",
  "repository_url": "https://api.github.com/repos/hyperledger/besu",
  "labels_url": "https://api.github.com/repos/hyperledger/besu/issues/4091/labels{/name}",
  "comments_url": "https://api.github.com/repos/hyperledger/besu/issues/4091/comments",
  "events_url": "https://api.github.com/repos/hyperledger/besu/issues/4091/events",
  "html_url": "https://github.com/hyperledger/besu/issues/4091",
  "id": 1302821080,
  "node_id": "I_kwDODE2jmc5Np3jY",
  "number": 4091,
  "title": "Investigate Connect/Disconnect Events Ordering ",
  "user": {
    "login": "iamhsk",
    "id": 2249367,
    "node_id": "MDQ6VXNlcjIyNDkzNjc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2249367?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/iamhsk",
    "html_url": "https://github.com/iamhsk",
    "followers_url": "https://api.github.com/users/iamhsk/followers",
    "following_url": "https://api.github.com/users/iamhsk/following{/other_user}",
    "gists_url": "https://api.github.com/users/iamhsk/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/iamhsk/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/iamhsk/subscriptions",
    "organizations_url": "https://api.github.com/users/iamhsk/orgs",
    "repos_url": "https://api.github.com/users/iamhsk/repos",
    "events_url": "https://api.github.com/users/iamhsk/events{/privacy}",
    "received_events_url": "https://api.github.com/users/iamhsk/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 2152224197,
      "node_id": "MDU6TGFiZWwyMTUyMjI0MTk3",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/TeamRevenant",
      "name": "TeamRevenant",
      "color": "78e298",
      "default": false,
      "description": "GH issues worked on by Revenant Team"
    },
    {
      "id": 3013559202,
      "node_id": "MDU6TGFiZWwzMDEzNTU5MjAy",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/mainnet",
      "name": "mainnet",
      "color": "9D578C",
      "default": false,
      "description": ""
    },
    {
      "id": 3805591260,
      "node_id": "LA_kwDODE2jmc7i1Lbc",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/peering",
      "name": "peering",
      "color": "006b75",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "macfarla",
    "id": 2627919,
    "node_id": "MDQ6VXNlcjI2Mjc5MTk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2627919?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/macfarla",
    "html_url": "https://github.com/macfarla",
    "followers_url": "https://api.github.com/users/macfarla/followers",
    "following_url": "https://api.github.com/users/macfarla/following{/other_user}",
    "gists_url": "https://api.github.com/users/macfarla/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/macfarla/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/macfarla/subscriptions",
    "organizations_url": "https://api.github.com/users/macfarla/orgs",
    "repos_url": "https://api.github.com/users/macfarla/repos",
    "events_url": "https://api.github.com/users/macfarla/events{/privacy}",
    "received_events_url": "https://api.github.com/users/macfarla/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "macfarla",
      "id": 2627919,
      "node_id": "MDQ6VXNlcjI2Mjc5MTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2627919?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/macfarla",
      "html_url": "https://github.com/macfarla",
      "followers_url": "https://api.github.com/users/macfarla/followers",
      "following_url": "https://api.github.com/users/macfarla/following{/other_user}",
      "gists_url": "https://api.github.com/users/macfarla/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/macfarla/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/macfarla/subscriptions",
      "organizations_url": "https://api.github.com/users/macfarla/orgs",
      "repos_url": "https://api.github.com/users/macfarla/repos",
      "events_url": "https://api.github.com/users/macfarla/events{/privacy}",
      "received_events_url": "https://api.github.com/users/macfarla/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 8,
  "created_at": "2022-07-13T02:25:23Z",
  "updated_at": "2022-07-21T23:05:55Z",
  "closed_at": "2022-07-21T23:05:55Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "This may help identifying the problems with #2689 \r\n\r\nPer @mbaxter's comment:\r\nThere could be a race condition wrt how connect and disconnect events are dispatched.  For example, say we’re in the process of handling a new connection and in another thread, we receive a disconnect message from the newly connected peer.  Is it possible we’re dispatching the disconnect event before the connection event?  This would cause stale, disconnected peers to persist in the EthPeers collection.  If this is actually the issue, it should be possible to rework disconnect events so that they are only dispatched after the connection event is dispatched.\r\n",
  "closed_by": {
    "login": "macfarla",
    "id": 2627919,
    "node_id": "MDQ6VXNlcjI2Mjc5MTk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2627919?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/macfarla",
    "html_url": "https://github.com/macfarla",
    "followers_url": "https://api.github.com/users/macfarla/followers",
    "following_url": "https://api.github.com/users/macfarla/following{/other_user}",
    "gists_url": "https://api.github.com/users/macfarla/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/macfarla/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/macfarla/subscriptions",
    "organizations_url": "https://api.github.com/users/macfarla/orgs",
    "repos_url": "https://api.github.com/users/macfarla/repos",
    "events_url": "https://api.github.com/users/macfarla/events{/privacy}",
    "received_events_url": "https://api.github.com/users/macfarla/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/4091/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/hyperledger/besu/issues/4091/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1184007311",
    "html_url": "https://github.com/hyperledger/besu/issues/4091#issuecomment-1184007311",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/4091",
    "id": 1184007311,
    "node_id": "IC_kwDODE2jmc5GkoSP",
    "user": {
      "login": "macfarla",
      "id": 2627919,
      "node_id": "MDQ6VXNlcjI2Mjc5MTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2627919?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/macfarla",
      "html_url": "https://github.com/macfarla",
      "followers_url": "https://api.github.com/users/macfarla/followers",
      "following_url": "https://api.github.com/users/macfarla/following{/other_user}",
      "gists_url": "https://api.github.com/users/macfarla/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/macfarla/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/macfarla/subscriptions",
      "organizations_url": "https://api.github.com/users/macfarla/orgs",
      "repos_url": "https://api.github.com/users/macfarla/repos",
      "events_url": "https://api.github.com/users/macfarla/events{/privacy}",
      "received_events_url": "https://api.github.com/users/macfarla/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-14T05:32:35Z",
    "updated_at": "2022-07-14T05:32:35Z",
    "author_association": "CONTRIBUTOR",
    "body": "it broke some ATs but it works locally with my 3 nodes setup trying this one out in goerli https://github.com/hyperledger/besu/pull/4100",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1184007311/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1190945310",
    "html_url": "https://github.com/hyperledger/besu/issues/4091#issuecomment-1190945310",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/4091",
    "id": 1190945310,
    "node_id": "IC_kwDODE2jmc5G_GIe",
    "user": {
      "login": "macfarla",
      "id": 2627919,
      "node_id": "MDQ6VXNlcjI2Mjc5MTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2627919?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/macfarla",
      "html_url": "https://github.com/macfarla",
      "followers_url": "https://api.github.com/users/macfarla/followers",
      "following_url": "https://api.github.com/users/macfarla/following{/other_user}",
      "gists_url": "https://api.github.com/users/macfarla/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/macfarla/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/macfarla/subscriptions",
      "organizations_url": "https://api.github.com/users/macfarla/orgs",
      "repos_url": "https://api.github.com/users/macfarla/repos",
      "events_url": "https://api.github.com/users/macfarla/events{/privacy}",
      "received_events_url": "https://api.github.com/users/macfarla/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-21T01:49:10Z",
    "updated_at": "2022-07-21T01:49:10Z",
    "author_association": "CONTRIBUTOR",
    "body": "Running up RC2 (with and without this change #4100) on local setup, goerli and mainnet to see if the \"stale disconnected peers\" is still a problem.",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1190945310/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1190945612",
    "html_url": "https://github.com/hyperledger/besu/issues/4091#issuecomment-1190945612",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/4091",
    "id": 1190945612,
    "node_id": "IC_kwDODE2jmc5G_GNM",
    "user": {
      "login": "macfarla",
      "id": 2627919,
      "node_id": "MDQ6VXNlcjI2Mjc5MTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2627919?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/macfarla",
      "html_url": "https://github.com/macfarla",
      "followers_url": "https://api.github.com/users/macfarla/followers",
      "following_url": "https://api.github.com/users/macfarla/following{/other_user}",
      "gists_url": "https://api.github.com/users/macfarla/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/macfarla/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/macfarla/subscriptions",
      "organizations_url": "https://api.github.com/users/macfarla/orgs",
      "repos_url": "https://api.github.com/users/macfarla/repos",
      "events_url": "https://api.github.com/users/macfarla/events{/privacy}",
      "received_events_url": "https://api.github.com/users/macfarla/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-21T01:49:47Z",
    "updated_at": "2022-07-21T02:14:40Z",
    "author_association": "CONTRIBUTOR",
    "body": "Locally - RC2 locally with besu-local-nodes setup (3 x besu, one is a bootnode for the other 2) - I still get the stale disconnected duplicate every time (on the bootnode)\n\n```\n2022-07-21 11:23:55.746+10:00 | nioEventLoopGroup-3-4 | DEBUG | EthProtocolManager | Disconnect - Outbound - 0x05 ALREADY_CONNECTED - PeerInfo{version=5, clientId='besu/v22.7.0-dev-1ff3967d/osx-x86_64/openjdk-java-11', capabilities=[eth/63, eth/64, eth/65, eth/66, snap/1], port=50505, nodeId=0xdcb9390953aec5dde1d60dd556c36827053ca9adaefd1b03f531592fea43824bae2919743f620bb8a9b6c2b9a54439771d4f9a74d261b74af7a10c2dd9f13c97} - 2 peers left\n2022-07-21 11:23:55.746+10:00 | nioEventLoopGroup-3-4 | TRACE | EthProtocolManager | 2 EthPeers {\nPeer 0x3548c87b9920ff16aa... PeerReputation 100, validated? true, disconnected? true,\nPeer 0x3548c87b9920ff16aa... PeerReputation 101, validated? true, disconnected? false}\n2022-07-21 11:23:55.746+10:00 | nioEventLoopGroup-3-4 | TRACE | RlpxAgent | 2 ConnectionsById {\nRemotelyInitiatedRlpxConnection initiatedAt:1658366625488 to 0x3548c87b9920ff16aa4bdcf01c85f25117a29ae1574d759bad48cc9463d8e9f7c3c1d1e9fb0d28e73898951f90e02714abb770fd6d22e90371882a45658800e9 disconnected? false,\nRemotelyInitiatedRlpxConnection initiatedAt:1658366635743 to 0xdcb9390953aec5dde1d60dd556c36827053ca9adaefd1b03f531592fea43824bae2919743f620bb8a9b6c2b9a54439771d4f9a74d261b74af7a10c2dd9f13c97 disconnected? false}\n2022-07-21 11:23:55.747+10:00 | nioEventLoopGroup-3-4 | DEBUG | EthProtocolManager | Sending status message to Peer 0xdcb9390953aec5dde1... PeerReputation 100, validated? true, disconnected? false.\n2022-07-21 11:23:55.748+10:00 | nioEventLoopGroup-3-4 | TRACE | EthProtocolManager | 3 EthPeers {\nPeer 0x3548c87b9920ff16aa... PeerReputation 100, validated? true, disconnected? true,\nPeer 0xdcb9390953aec5dde1... PeerReputation 100, validated? true, disconnected? false,\nPeer 0x3548c87b9920ff16aa... PeerReputation 101, validated? true, disconnected? false}\n```",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1190945612/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1190946236",
    "html_url": "https://github.com/hyperledger/besu/issues/4091#issuecomment-1190946236",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/4091",
    "id": 1190946236,
    "node_id": "IC_kwDODE2jmc5G_GW8",
    "user": {
      "login": "macfarla",
      "id": 2627919,
      "node_id": "MDQ6VXNlcjI2Mjc5MTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2627919?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/macfarla",
      "html_url": "https://github.com/macfarla",
      "followers_url": "https://api.github.com/users/macfarla/followers",
      "following_url": "https://api.github.com/users/macfarla/following{/other_user}",
      "gists_url": "https://api.github.com/users/macfarla/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/macfarla/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/macfarla/subscriptions",
      "organizations_url": "https://api.github.com/users/macfarla/orgs",
      "repos_url": "https://api.github.com/users/macfarla/repos",
      "events_url": "https://api.github.com/users/macfarla/events{/privacy}",
      "received_events_url": "https://api.github.com/users/macfarla/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-21T01:50:54Z",
    "updated_at": "2022-07-21T02:06:50Z",
    "author_association": "CONTRIBUTOR",
    "body": "mainnet with RC2\nzero stale peers after 1 hour\nthe only results for this grep are responses from disconnected peers - which can happen\n```\nmainnet-dev-sally-eth-peers-80369e81:~$ grep \"validated? true, disconnected? true\" /var/log/besu/besu.log\n2022-07-21 00:46:24.398+00:00 | EthScheduler-Transactions-1 | DEBUG | EthPeer | Received useless response for receipts from peer Peer 0xfb9e83d5069af7bc33... PeerReputation 954, validated? true, disconnected? true\n2022-07-21 00:49:19.451+00:00 | nioEventLoopGroup-3-3 | DEBUG | EthPeer | Received useless response for receipts from peer Peer 0x5d17c5c0bfc1507098... PeerReputation 188, validated? true, disconnected? true\n2022-07-21 00:53:23.829+00:00 | nioEventLoopGroup-3-6 | DEBUG | EthPeer | Received useless response for headers from peer Peer 0x4f74b1a923d042983d... PeerReputation 1150, validated? true, disconnected? true\n2022-07-21 01:17:42.185+00:00 | nioEventLoopGroup-3-7 | DEBUG | EthPeer | Received useless response for receipts from peer Peer 0x916be8495734b1641f... PeerReputation 4145, validated? true, disconnected? true\n```\nThis grep for validated false does return some stale peers - but again, they are transient.\n```\ngrep \"validated? false, disconnected? true\" /var/log/besu/besu.log > tmp.txt\nsallymacfarlane@mainnet-dev-sally-eth-peers-80369e81:~$ cat tmp.txt  | wc -l\n5488\nsallymacfarlane@mainnet-dev-sally-eth-peers-80369e81:~$ less tmp.txt\nsallymacfarlane@mainnet-dev-sally-eth-peers-80369e81:~$ cat tmp.txt | sort | uniq > sorted.txt\nsallymacfarlane@mainnet-dev-sally-eth-peers-80369e81:~$ cat sorted.txt | wc -l\n151\n```\n~20 unique stale peers - but all with validated = false\n```\n126 2022-07-21 02:01:08.239+00:00 | EthScheduler-Timer-0 | DEBUG | GetHeadersFromPeerByNumberTask | Requesting 1 headers from peer Peer 0xb522637f3c92f7d2d2... PeerReputation 101, validated? false, disconnected? true.\n127 2022-07-21 02:01:47.670+00:00 | nioEventLoopGroup-3-9 | DEBUG | EthPeer | Received useless response for headers from peer Peer 0x571a4fc1184e9d7ec4... PeerReputation 100, validated? false, disconnected? true\n128 2022-07-21 02:01:47.932+00:00 | nioEventLoopGroup-3-9 | DEBUG | EthPeer | Received useless response for headers from peer Peer 0xd5908ff35f09221e4a... PeerReputation 100, validated? false, disconnected? true\n129 2022-07-21 02:01:52.961+00:00 | EthScheduler-Timer-0 | DEBUG | GetHeadersFromPeerByNumberTask | Requesting 1 headers from peer Peer 0x77260125a138fcbefb... PeerReputation 101, validated? false, disconnected? true.\n130 2022-07-21 02:01:57.376+00:00 | nioEventLoopGroup-3-8 | DEBUG | EthPeer | Received useless response for headers from peer Peer 0x0ec3ea3972823bf1e3... PeerReputation 100, validated? false, disconnected? true\n131 Peer 0x0c8dd71bd4496cf8c4... PeerReputation 100, validated? false, disconnected? true,\n132 Peer 0x14a9737cd1c2bf67f0... PeerReputation 100, validated? false, disconnected? true,\n133 Peer 0x229a29dec21d68779c... PeerReputation 100, validated? false, disconnected? true,\n134 Peer 0x359e0b1509d0f802ae... PeerReputation 100, validated? false, disconnected? true,\n135 Peer 0x36e9a9c605f5a32938... PeerReputation 100, validated? false, disconnected? true,\n136 Peer 0x3a0f6935910fe538d0... PeerReputation 100, validated? false, disconnected? true,\n137 Peer 0x4e2b786d94183134e8... PeerReputation 100, validated? false, disconnected? true,\n138 Peer 0x6bd4942ba74cbdf587... PeerReputation 100, validated? false, disconnected? true,\n139 Peer 0x73b9870bba16ebc407... PeerReputation 100, validated? false, disconnected? true,\n140 Peer 0x767c940827b244f5b5... PeerReputation 100, validated? false, disconnected? true,\n141 Peer 0x7e5c8891ceaac9898c... PeerReputation 100, validated? false, disconnected? true,\n142 Peer 0x8b3519f77c8d31d669... PeerReputation 100, validated? false, disconnected? true,\n143 Peer 0xa9882c8dbbe2b19661... PeerReputation 100, validated? false, disconnected? true,\n144 Peer 0xba95155945f524d3e2... PeerReputation 100, validated? false, disconnected? true,\n145 Peer 0xc9f7831ec2da571de1... PeerReputation 100, validated? false, disconnected? true,\n146 Peer 0xca776ff9688242aac3... PeerReputation 100, validated? false, disconnected? true,\n147 Peer 0xcce28640376ab1ca3b... PeerReputation 100, validated? false, disconnected? true,\n148 Peer 0xd094aaee3baa666249... PeerReputation 100, validated? false, disconnected? true,\n149 Peer 0xfac6b6cef0f9222167... PeerReputation 100, validated? false, disconnected? true,\n150 Peer 0xfbbf9383918ee4c092... PeerReputation 100, validated? false, disconnected? true,\n151 Peer 0xfe9cf74b82c235197d... PeerReputation 100, validated? false, disconnected? true,\n```\nlatest contents of EthPeers. max size I have seen is 26.\n```\n2022-07-21 02:00:03.622+00:00 | nioEventLoopGroup-3-4 | DEBUG | EthProtocolManager | Disconnect - Outbound - 0x10 SUBPROTOCOL_TRIGGERED - PeerInfo{version=5, clientId='Geth/v1.10.1-stable-c2d2f4ed/linux-amd64/go1.17.2', capabilities=[eth/64, eth/65, eth/66, snap/1], port=0, nodeId=0x1b9f01fab982c8621ef78588cd07ce276688e9921c6c02f6072f10856a10521be4544ca6295d17e8b1a589fda5bfa1d05e61fc0ff313d6014b0bca6fc373b210} - 24 peers left\n2022-07-21 02:00:03.622+00:00 | nioEventLoopGroup-3-4 | TRACE | EthProtocolManager | 24 EthPeers {\nPeer 0x54447c865e2ed69e05... PeerReputation 97, validated? true, disconnected? false,\nPeer 0x4dbdfb7780bf6de078... PeerReputation 98, validated? true, disconnected? false,\nPeer 0x7e5c8891ceaac9898c... PeerReputation 100, validated? false, disconnected? true,\nPeer 0x7175786f4600218a97... PeerReputation 100, validated? true, disconnected? false,\nPeer 0xb5044d696f951dd7f3... PeerReputation 100, validated? true, disconnected? false,\nPeer 0x8b70a20f56758736ac... PeerReputation 162, validated? true, disconnected? false,\nPeer 0xe0afef6292e34c2479... PeerReputation 2014, validated? true, disconnected? false,\nPeer 0xb59c40030e61edc266... PeerReputation 2523, validated? true, disconnected? false,\nPeer 0xa5f98757a5cca70a8e... PeerReputation 5174, validated? true, disconnected? false,\nPeer 0xbb30e00d9788286f3d... PeerReputation 6682, validated? true, disconnected? false,\nPeer 0x9496091968442f60a4... PeerReputation 6844, validated? true, disconnected? false,\nPeer 0x80ee0f6f4d7c9dc440... PeerReputation 7833, validated? true, disconnected? false,\nPeer 0x12d128248d9df39b93... PeerReputation 7942, validated? true, disconnected? false,\nPeer 0x64a370fc49ccdd6449... PeerReputation 8020, validated? true, disconnected? false,\nPeer 0xf5d5463c5eacf750d2... PeerReputation 8139, validated? true, disconnected? false,\nPeer 0x46724e6992659fe567... PeerReputation 8877, validated? true, disconnected? false,\nPeer 0x7c5e3b08253275c219... PeerReputation 9081, validated? true, disconnected? false,\nPeer 0xfa006c9f8a2904b558... PeerReputation 9090, validated? true, disconnected? false,\nPeer 0xc9f7831ec2da571de1... PeerReputation 9191, validated? true, disconnected? false,\nPeer 0x7905672741b7f39121... PeerReputation 9373, validated? true, disconnected? false,\nPeer 0x0afb70813ff36b8e13... PeerReputation 9926, validated? true, disconnected? false,\nPeer 0x2a17b2c016a9fa6fe7... PeerReputation 10872, validated? true, disconnected? false,\nPeer 0xe6316690ba3d88acfc... PeerReputation 12589, validated? true, disconnected? false,\nPeer 0x05e9f05046094d22d2... PeerReputation 12895, validated? true, disconnected? false}\n```",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1190946236/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1190947004",
    "html_url": "https://github.com/hyperledger/besu/issues/4091#issuecomment-1190947004",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/4091",
    "id": 1190947004,
    "node_id": "IC_kwDODE2jmc5G_Gi8",
    "user": {
      "login": "macfarla",
      "id": 2627919,
      "node_id": "MDQ6VXNlcjI2Mjc5MTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2627919?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/macfarla",
      "html_url": "https://github.com/macfarla",
      "followers_url": "https://api.github.com/users/macfarla/followers",
      "following_url": "https://api.github.com/users/macfarla/following{/other_user}",
      "gists_url": "https://api.github.com/users/macfarla/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/macfarla/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/macfarla/subscriptions",
      "organizations_url": "https://api.github.com/users/macfarla/orgs",
      "repos_url": "https://api.github.com/users/macfarla/repos",
      "events_url": "https://api.github.com/users/macfarla/events{/privacy}",
      "received_events_url": "https://api.github.com/users/macfarla/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-21T01:52:13Z",
    "updated_at": "2022-07-21T01:54:23Z",
    "author_association": "CONTRIBUTOR",
    "body": "goerli with RC2\n~ 300 unique incidences of stale peers after 3 hours\n```\nsallymacfarlane@goerli-dev-sally-eth-peers-80369e81:~$ grep \"validated? true, disconnected? true\" /var/log/besu/besu.log > tmp.txt\nsallymacfarlane@goerli-dev-sally-eth-peers-80369e81:~$ cat tmp.txt | wc -l\n265857\nsallymacfarlane@goerli-dev-sally-eth-peers-80369e81:~$ cat tmp.txt | sort | uniq > sorted.txt\nsallymacfarlane@goerli-dev-sally-eth-peers-80369e81:~$ cat sorted.txt | wc -l\n301\n```\nand the results in sorted.txt are 50/50 responses from disconnected peers and stale disconnected peers\n```\n119 2022-07-21 01:22:50.330+00:00 | nioEventLoopGroup-3-5 | DEBUG | EthPeer | Received useless response for headers from peer Peer 0xdc120520857d081bf5... PeerReputation 1253, validated? true, disconnected? true\n120 2022-07-21 01:24:57.291+00:00 | nioEventLoopGroup-3-3 | DEBUG | EthPeer | Received useless response for headers from peer Peer 0xc1f8b7c2ac4453271f... PeerReputation 100, validated? true, disconnected? true\n121 2022-07-21 01:30:44.814+00:00 | nioEventLoopGroup-3-6 | DEBUG | EthPeer | Received useless response for headers from peer Peer 0x9fa79a3216b36da24a... PeerReputation 100, validated? true, disconnected? true\n122 2022-07-21 01:32:33.365+00:00 | nioEventLoopGroup-3-2 | DEBUG | EthPeer | Received useless response for bodies from peer Peer 0x9fa79a3216b36da24a... PeerReputation 113, validated? true, disconnected? true\n123 2022-07-21 01:38:36.175+00:00 | nioEventLoopGroup-3-8 | DEBUG | EthPeer | Received useless response for headers from peer Peer 0xa3b2326a562a6acdd6... PeerReputation 100, validated? true, disconnected? true\n124 2022-07-21 01:39:07.130+00:00 | nioEventLoopGroup-3-7 | DEBUG | EthPeer | Received useless response for headers from peer Peer 0xa3b2326a562a6acdd6... PeerReputation 100, validated? true, disconnected? true\n125 Peer 0x01f5f55966260756fd... PeerReputation 100, validated? true, disconnected? true,\n126 Peer 0x02124d01773875e388... PeerReputation 100, validated? true, disconnected? true,\n127 Peer 0x043ec9c426b5459d01... PeerReputation 100, validated? true, disconnected? true,\n128 Peer 0x087998e720e0a08d64... PeerReputation 100, validated? true, disconnected? true,\n129 Peer 0x091f7d3fccc8c5129f... PeerReputation 100, validated? true, disconnected? true,\n130 Peer 0x09329d00c72a861a0b... PeerReputation 100, validated? true, disconnected? true,\n131 Peer 0x0b94e5109af8b17e4f... PeerReputation 100, validated? true, disconnected? true,\n```",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1190947004/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1190950247",
    "html_url": "https://github.com/hyperledger/besu/issues/4091#issuecomment-1190950247",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/4091",
    "id": 1190950247,
    "node_id": "IC_kwDODE2jmc5G_HVn",
    "user": {
      "login": "macfarla",
      "id": 2627919,
      "node_id": "MDQ6VXNlcjI2Mjc5MTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2627919?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/macfarla",
      "html_url": "https://github.com/macfarla",
      "followers_url": "https://api.github.com/users/macfarla/followers",
      "following_url": "https://api.github.com/users/macfarla/following{/other_user}",
      "gists_url": "https://api.github.com/users/macfarla/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/macfarla/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/macfarla/subscriptions",
      "organizations_url": "https://api.github.com/users/macfarla/orgs",
      "repos_url": "https://api.github.com/users/macfarla/repos",
      "events_url": "https://api.github.com/users/macfarla/events{/privacy}",
      "received_events_url": "https://api.github.com/users/macfarla/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-21T01:58:27Z",
    "updated_at": "2022-07-21T02:11:52Z",
    "author_association": "CONTRIBUTOR",
    "body": "goerli with 4100\n~ 100 unique incidences of stale peers after 18 hours\n\n```\nsallymacfarlane@goerli-dev-sally-4001:~$ grep \"validated? true, disconnected? true\" /var/log/besu/besu.log > tmp.txt\nsallymacfarlane@goerli-dev-sally-4001:~$ cat tmp.txt | wc -l\n142\nsallymacfarlane@goerli-dev-sally-4001:~$ cat sorted.txt | wc -l\n138\n```\n\nIt's about 70/30 stale peers and responses\n```\nPeer 670289121 0xe19fa955c58ef2fe73... PeerReputation 100, validated? true, disconnected? true,\n 96 Peer 69032829 0xcdcb2d4a61bfdb943e... PeerReputation 100, validated? true, disconnected? true,\n 97 Peer 692187735 0x99dcf2c3e56534e259... PeerReputation 100, validated? true, disconnected? true,\n 98 Peer 730465720 0x851d38b40c90c0d1e3... PeerReputation 100, validated? true, disconnected? true,\n 99 Peer 730475202 0xc4c9fed80520ff6778... PeerReputation 100, validated? true, disconnected? true,\n100 Peer 75217378 0xd6518f4f318a172158... PeerReputation 100, validated? true, disconnected? true,\n101 Peer 792382767 0x65a8545b97b8331d54... PeerReputation 100, validated? true, disconnected? true,\n102 Peer 798963790 0xa11be9a634a0fcfdc6... PeerReputation 100, validated? true, disconnected? true,\n103 Peer 833205436 0xe205b1c859ae321051... PeerReputation 100, validated? true, disconnected? true,\n104 Peer 929481047 0xc1f109416ce13d4df4... PeerReputation 100, validated? true, disconnected? true,\n105 {\"@timestamp\":\"2022-07-20T06:55:48,493\",\"level\":\"DEBUG\",\"thread\":\"nioEventLoopGroup-3-7\",\"class\":\"EthPeer\",\"message\":\"Received useless response for headers from peer Peer 1322450591 0xbd527c4969165bec48... PeerReputati    on 100, validated? true, disconnected? true\",\"throwable\":\"\"}\n106 {\"@timestamp\":\"2022-07-20T06:55:51,846\",\"level\":\"DEBUG\",\"thread\":\"nioEventLoopGroup-3-1\",\"class\":\"EthPeer\",\"message\":\"Received useless response for headers from peer Peer 333858630 0x5e9c0eb5e496d6bd78... PeerReputatio    n 100, validated? true, disconnected? true\",\"throwable\":\"\"}\n107 {\"@timestamp\":\"2022-07-20T06:56:07,293\",\"level\":\"DEBUG\",\"thread\":\"nioEventLoopGroup-3-8\",\"class\":\"EthPeer\",\"message\":\"Received useless response for headers from peer Peer 1845761819 0xc94e917ff178d4d0b5... PeerReputati    on 100, validated? true, disconnected? true\",\"throwable\":\"\"}\n```\n\nlatest contents of EthPeers\n```\n{\"@timestamp\":\"2022-07-21T01:58:44,994\",\"level\":\"TRACE\",\"thread\":\"nioEventLoopGroup-3-5\",\"class\":\"EthProtocolManager\",\"message\":\"on disconnect: 25 EthPeers {\nPeer 1538216632 0x860f6852a7890332d5... PeerReputation 100, validated? true, disconnected? false,\nPeer 547561703 0x2a06b3bfaa3c35920a... PeerReputation 102, validated? true, disconnected? false,\nPeer 513063988 0x186fffadc7f954f686... PeerReputation 102, validated? true, disconnected? false,\nPeer 293386613 0x9cdfdf5c289d471b43... PeerReputation 104, validated? true, disconnected? false,\nPeer 158703338 0xda88dc0fe9ec8f93ac... PeerReputation 108, validated? true, disconnected? false,\nPeer 891589840 0x9f016d14e6c309490c... PeerReputation 123, validated? true, disconnected? false,\nPeer 2053244661 0x632c1dd9e3a609e9f0... PeerReputation 153, validated? true, disconnected? false,\nPeer 484131586 0xf6d8236998c54e5fa5... PeerReputation 180, validated? true, disconnected? false,\nPeer 1062400970 0x1d99a53c0c6c24e621... PeerReputation 352, validated? true, disconnected? false,\nPeer 1871026841 0x8866424bff9b18ba16... PeerReputation 747, validated? true, disconnected? false,\nPeer 218740909 0x2183ae56082b00d4af... PeerReputation 1711, validated? true, disconnected? false,\nPeer 293822992 0x97fec34494b30caa11... PeerReputation 3228, validated? true, disconnected? false,\nPeer 1869606984 0xeb4d23d657e9b964c1... PeerReputation 3744, validated? true, disconnected? false,\nPeer 1728000883 0x4f3c2bdfb8c33a4cb1... PeerReputation 8401, validated? true, disconnected? false,\nPeer 1239904491 0x9888390ced7f6c2c1d... PeerReputation 10486, validated? true, disconnected? false,\nPeer 1244919122 0x83e042eae862759794... PeerReputation 12752, validated? true, disconnected? false,\nPeer 1251696998 0x1de62c406ce902797f... PeerReputation 14445, validated? true, disconnected? false,\nPeer 1433417271 0x2d8ba444dc9ceb8b32... PeerReputation 23225, validated? true, disconnected? false,\nPeer 113549481 0x1e2b9a6fd46ee8ec26... PeerReputation 28876, validated? true, disconnected? false,\nPeer 90856304 0xf6c8f9aad5fcb25260... PeerReputation 30230, validated? true, disconnected? false,\nPeer 893609276 0xf3b72a2d82e03545f0... PeerReputation 32473, validated? true, disconnected? false,\nPeer 79587359 0x68d90c7c2cbcbf0f5a... PeerReputation 35441, validated? true, disconnected? false,\nPeer 1940587090 0x43975047d1d1df1268... PeerReputation 35738, validated? true, disconnected? false,\nPeer 1538265151 0x5694e56be5672d3b21... PeerReputation 52821, validated? true, disconnected? false,\nPeer 871514133 0xa6fa82cb4a766500c7... PeerReputation 68875, validated? true, disconnected? false}\",\"throwable\":\"\"}\n```",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1190950247/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1190952725",
    "html_url": "https://github.com/hyperledger/besu/issues/4091#issuecomment-1190952725",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/4091",
    "id": 1190952725,
    "node_id": "IC_kwDODE2jmc5G_H8V",
    "user": {
      "login": "macfarla",
      "id": 2627919,
      "node_id": "MDQ6VXNlcjI2Mjc5MTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2627919?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/macfarla",
      "html_url": "https://github.com/macfarla",
      "followers_url": "https://api.github.com/users/macfarla/followers",
      "following_url": "https://api.github.com/users/macfarla/following{/other_user}",
      "gists_url": "https://api.github.com/users/macfarla/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/macfarla/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/macfarla/subscriptions",
      "organizations_url": "https://api.github.com/users/macfarla/orgs",
      "repos_url": "https://api.github.com/users/macfarla/repos",
      "events_url": "https://api.github.com/users/macfarla/events{/privacy}",
      "received_events_url": "https://api.github.com/users/macfarla/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-21T02:03:25Z",
    "updated_at": "2022-07-21T02:12:14Z",
    "author_association": "CONTRIBUTOR",
    "body": "^ in both cases on goerli I can see the stale peers in the logs but they don't persist, and the size doesn't grow over time. They do eventually get removed. Max size I have seen is 26.",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1190952725/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1192015328",
    "html_url": "https://github.com/hyperledger/besu/issues/4091#issuecomment-1192015328",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/4091",
    "id": 1192015328,
    "node_id": "IC_kwDODE2jmc5HDLXg",
    "user": {
      "login": "macfarla",
      "id": 2627919,
      "node_id": "MDQ6VXNlcjI2Mjc5MTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2627919?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/macfarla",
      "html_url": "https://github.com/macfarla",
      "followers_url": "https://api.github.com/users/macfarla/followers",
      "following_url": "https://api.github.com/users/macfarla/following{/other_user}",
      "gists_url": "https://api.github.com/users/macfarla/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/macfarla/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/macfarla/subscriptions",
      "organizations_url": "https://api.github.com/users/macfarla/orgs",
      "repos_url": "https://api.github.com/users/macfarla/repos",
      "events_url": "https://api.github.com/users/macfarla/events{/privacy}",
      "received_events_url": "https://api.github.com/users/macfarla/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-21T23:05:55Z",
    "updated_at": "2022-07-21T23:05:55Z",
    "author_association": "CONTRIBUTOR",
    "body": "Closing this one - conclusion is that there isn't a problem on mainnet/goerli",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1192015328/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
