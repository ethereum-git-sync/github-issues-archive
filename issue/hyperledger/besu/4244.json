{
  "url": "https://api.github.com/repos/hyperledger/besu/issues/4244",
  "repository_url": "https://api.github.com/repos/hyperledger/besu",
  "labels_url": "https://api.github.com/repos/hyperledger/besu/issues/4244/labels{/name}",
  "comments_url": "https://api.github.com/repos/hyperledger/besu/issues/4244/comments",
  "events_url": "https://api.github.com/repos/hyperledger/besu/issues/4244/events",
  "html_url": "https://github.com/hyperledger/besu/issues/4244",
  "id": 1333944870,
  "node_id": "I_kwDODE2jmc5PgmIm",
  "number": 4244,
  "title": "Wrong estimated value when using estimateGas API",
  "user": {
    "login": "JosephK95",
    "id": 86999601,
    "node_id": "MDQ6VXNlcjg2OTk5NjAx",
    "avatar_url": "https://avatars.githubusercontent.com/u/86999601?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/JosephK95",
    "html_url": "https://github.com/JosephK95",
    "followers_url": "https://api.github.com/users/JosephK95/followers",
    "following_url": "https://api.github.com/users/JosephK95/following{/other_user}",
    "gists_url": "https://api.github.com/users/JosephK95/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/JosephK95/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/JosephK95/subscriptions",
    "organizations_url": "https://api.github.com/users/JosephK95/orgs",
    "repos_url": "https://api.github.com/users/JosephK95/repos",
    "events_url": "https://api.github.com/users/JosephK95/events{/privacy}",
    "received_events_url": "https://api.github.com/users/JosephK95/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1537362490,
      "node_id": "MDU6TGFiZWwxNTM3MzYyNDkw",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/bug",
      "name": "bug",
      "color": "d73a4a",
      "default": true,
      "description": "Something isn't working"
    },
    {
      "id": 1537362500,
      "node_id": "MDU6TGFiZWwxNTM3MzYyNTAw",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/good%20first%20issue",
      "name": "good first issue",
      "color": "7057ff",
      "default": true,
      "description": "Good for newcomers"
    },
    {
      "id": 2152224197,
      "node_id": "MDU6TGFiZWwyMTUyMjI0MTk3",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/TeamRevenant",
      "name": "TeamRevenant",
      "color": "78e298",
      "default": false,
      "description": "GH issues worked on by Revenant Team"
    },
    {
      "id": 4609582991,
      "node_id": "LA_kwDODE2jmc8AAAABEsCnjw",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/RPC",
      "name": "RPC",
      "color": "1d76db",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 7,
  "created_at": "2022-08-10T01:21:56Z",
  "updated_at": "2023-04-21T09:10:49Z",
  "closed_at": "2023-04-21T09:10:49Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Description\r\nWhen we execute `estimateGas` API on a smart contract call, it seems that Besu returns a wrong estimated value.\r\n\r\n### Steps to Reproduce (Bug)\r\n1. Download the following file and untar it:\r\n[test_gas_estimation.tar.gz](https://github.com/hyperledger/besu/files/9295689/test_gas_estimation.tar.gz)\r\n2. Execute Besu binary with the following flags:\r\n`besu --data-path test_gas_estimation/data-besu --genesis-file test_gas_estimation/besu.json --rpc-http-port 8549 --rpc-http-enabled --rpc-http-api ETH --network-id 15 --discovery-enabled false`\r\n3. Execute the test case file: `node test1.js`\r\n\r\n**Expected behavior:**\r\nAll other client implementations return 34165.\r\n\r\n**Actual behavior:** \r\nOnly Besu returns 36465.\r\n\r\n**Frequency:**\r\nAlways\r\n\r\n### Versions (Add all that apply)\r\n* Software version: besu/v22.4.4/linux-x86_64/openjdk-java-16\r\n* OS Name & Version: Ubuntu 20.04.4 LTS\r\n* Node.js / web3.js versions: v16.15.0 / v1.7.3\r\n\r\n### Smart contract information (If you're reporting an issue arising from deploying or calling a smart contract, please supply related information)\r\n* Solidity version: v0.8.13\r\n* The contract code is provided in the tar.gz file above.\r\n* The contract is deployed at the following address: 0xAe7405782dcf9Fc759020045E7Acc0795d372bc8\r\n",
  "closed_by": {
    "login": "antonydenyer",
    "id": 469160,
    "node_id": "MDQ6VXNlcjQ2OTE2MA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/469160?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/antonydenyer",
    "html_url": "https://github.com/antonydenyer",
    "followers_url": "https://api.github.com/users/antonydenyer/followers",
    "following_url": "https://api.github.com/users/antonydenyer/following{/other_user}",
    "gists_url": "https://api.github.com/users/antonydenyer/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/antonydenyer/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/antonydenyer/subscriptions",
    "organizations_url": "https://api.github.com/users/antonydenyer/orgs",
    "repos_url": "https://api.github.com/users/antonydenyer/repos",
    "events_url": "https://api.github.com/users/antonydenyer/events{/privacy}",
    "received_events_url": "https://api.github.com/users/antonydenyer/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/4244/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/hyperledger/besu/issues/4244/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1420307265",
    "html_url": "https://github.com/hyperledger/besu/issues/4244#issuecomment-1420307265",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/4244",
    "id": 1420307265,
    "node_id": "IC_kwDODE2jmc5UqCtB",
    "user": {
      "login": "NickSneo",
      "id": 32759145,
      "node_id": "MDQ6VXNlcjMyNzU5MTQ1",
      "avatar_url": "https://avatars.githubusercontent.com/u/32759145?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/NickSneo",
      "html_url": "https://github.com/NickSneo",
      "followers_url": "https://api.github.com/users/NickSneo/followers",
      "following_url": "https://api.github.com/users/NickSneo/following{/other_user}",
      "gists_url": "https://api.github.com/users/NickSneo/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/NickSneo/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/NickSneo/subscriptions",
      "organizations_url": "https://api.github.com/users/NickSneo/orgs",
      "repos_url": "https://api.github.com/users/NickSneo/repos",
      "events_url": "https://api.github.com/users/NickSneo/events{/privacy}",
      "received_events_url": "https://api.github.com/users/NickSneo/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-02-07T07:22:24Z",
    "updated_at": "2023-02-07T07:22:24Z",
    "author_association": "CONTRIBUTOR",
    "body": "Hey @JosephK95 ,\r\nCan you plz mention which all other client implementations you used and version, it will help in verifying and debugging this.",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1420307265/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1432550127",
    "html_url": "https://github.com/hyperledger/besu/issues/4244#issuecomment-1432550127",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/4244",
    "id": 1432550127,
    "node_id": "IC_kwDODE2jmc5VYvrv",
    "user": {
      "login": "NickSneo",
      "id": 32759145,
      "node_id": "MDQ6VXNlcjMyNzU5MTQ1",
      "avatar_url": "https://avatars.githubusercontent.com/u/32759145?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/NickSneo",
      "html_url": "https://github.com/NickSneo",
      "followers_url": "https://api.github.com/users/NickSneo/followers",
      "following_url": "https://api.github.com/users/NickSneo/following{/other_user}",
      "gists_url": "https://api.github.com/users/NickSneo/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/NickSneo/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/NickSneo/subscriptions",
      "organizations_url": "https://api.github.com/users/NickSneo/orgs",
      "repos_url": "https://api.github.com/users/NickSneo/repos",
      "events_url": "https://api.github.com/users/NickSneo/events{/privacy}",
      "received_events_url": "https://api.github.com/users/NickSneo/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-02-16T05:37:09Z",
    "updated_at": "2023-02-16T10:20:22Z",
    "author_association": "CONTRIBUTOR",
    "body": "Hey,\r\nI have been working on this bug. Updating my findings here - \r\n\r\nIts not just an issue with eth_estimateGas api but with the amount of gas consumed by besu and other eth client like geth.\r\nHere I chose geth for the comparison everywhere.\r\n\r\nTo reproduce the error, I started dev networks for both besu and geth and deployed a new simple smart contract, and interacted with it. For each step I noted the gas consumed.\r\n\r\nsimple HelloWorld contract - \r\n```\r\n// SPDX-License-Identifier: GPL-3.0\r\npragma solidity ^0.8.0;\r\n\r\ncontract HelloWorld {\r\n    string greetings;\r\n    function set(string memory greet) public {\r\n        greetings = greet;\r\n    }\r\n    function retrieve() public view returns (string memory){\r\n        return greetings;\r\n    }\r\n}\r\n```\r\n\r\nFor deploying contract gas consumed by \r\ngeth = 410868\r\nbesu = 492040\r\n\r\nFor calling set function with param = \"Hello\",\r\nGeth = 45196\r\nBesu = 43868\r\n\r\nI have compared all the OPCODEs and their static and dynamic gas cost, everything seems fine to me.\r\nRight now I am stuck with no reply on Hyperledger Besu discord channel - https://discord.com/channels/905194001349627914/905205502940696607/1074926946938535946\r\nAny suggestions, pointers, ideas or tips will be helpful or if I am missing anything, thanks!",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1432550127/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1443704176",
    "html_url": "https://github.com/hyperledger/besu/issues/4244#issuecomment-1443704176",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/4244",
    "id": 1443704176,
    "node_id": "IC_kwDODE2jmc5WDS1w",
    "user": {
      "login": "antonydenyer",
      "id": 469160,
      "node_id": "MDQ6VXNlcjQ2OTE2MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/469160?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/antonydenyer",
      "html_url": "https://github.com/antonydenyer",
      "followers_url": "https://api.github.com/users/antonydenyer/followers",
      "following_url": "https://api.github.com/users/antonydenyer/following{/other_user}",
      "gists_url": "https://api.github.com/users/antonydenyer/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/antonydenyer/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/antonydenyer/subscriptions",
      "organizations_url": "https://api.github.com/users/antonydenyer/orgs",
      "repos_url": "https://api.github.com/users/antonydenyer/repos",
      "events_url": "https://api.github.com/users/antonydenyer/events{/privacy}",
      "received_events_url": "https://api.github.com/users/antonydenyer/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-02-24T13:47:35Z",
    "updated_at": "2023-02-24T13:47:35Z",
    "author_association": "MEMBER",
    "body": "I could be wrong but I think it is impossible to implement `eth_estimateGas` and get the same result as what geth produces when using a tracer. The reason for this is that geth will perform a binary search with different gas limits until it finds the boundary of a success and failure. \r\n\r\nI think at best you can do with a tracer is safely provide is the minimum guaranteed gas required to complete the transaction, primarily because of the 2300 stipend and the 63/64 rule. Happy to be proven wrong! ",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1443704176/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1445228341",
    "html_url": "https://github.com/hyperledger/besu/issues/4244#issuecomment-1445228341",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/4244",
    "id": 1445228341,
    "node_id": "IC_kwDODE2jmc5WJG81",
    "user": {
      "login": "NickSneo",
      "id": 32759145,
      "node_id": "MDQ6VXNlcjMyNzU5MTQ1",
      "avatar_url": "https://avatars.githubusercontent.com/u/32759145?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/NickSneo",
      "html_url": "https://github.com/NickSneo",
      "followers_url": "https://api.github.com/users/NickSneo/followers",
      "following_url": "https://api.github.com/users/NickSneo/following{/other_user}",
      "gists_url": "https://api.github.com/users/NickSneo/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/NickSneo/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/NickSneo/subscriptions",
      "organizations_url": "https://api.github.com/users/NickSneo/orgs",
      "repos_url": "https://api.github.com/users/NickSneo/repos",
      "events_url": "https://api.github.com/users/NickSneo/events{/privacy}",
      "received_events_url": "https://api.github.com/users/NickSneo/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-02-25T23:43:23Z",
    "updated_at": "2023-02-26T00:03:18Z",
    "author_association": "CONTRIBUTOR",
    "body": "Hey @antonydenyer ,\r\n\r\nYou are right in Besu the `eth_estimateGas` returns - `return ((long) ((gasUsedByTransaction + gasStipend) * subCallMultiplier));`\r\nIn this the gas stipend is 2300 and subCallMultiplier - `Math.pow(64/65, operationTracer.getMaxDepth());`\r\n\r\nI am not much sure how geth estimate the gas but through my experiments the estimated value returned by geth was always equal to actual gas consumption by the transaction. \r\n\r\nNow if remove the extra gas stipend of 2300 from besu's gas estimation calculations then it will return `gasUsedByTransaction` and this seems to be the exact gas consumed by the transaction and also equal to geth's estimated gas. (*After some fixes)\r\n\r\nI am sure the extra gas stipend and 63/64 rule is an expected behaviour of besu and it is better to leave it as it is. (*But we will need to fix the `gasUsedByTransaction` value)\r\n\r\n*So here during my testing I found an interesting bug in Besu that is **difference in actual transaction gas consumption when compared to geth and remix VM** which I have mentioned in my above comment too.\r\nI was able to fix this behaviour in my PR - #5116 ( It seemed some OPCODEs were commented in gas consumption code, by uncommenting those the difference in actual tx gas consumption is fixed)\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1445228341/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1445386963",
    "html_url": "https://github.com/hyperledger/besu/issues/4244#issuecomment-1445386963",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/4244",
    "id": 1445386963,
    "node_id": "IC_kwDODE2jmc5WJtrT",
    "user": {
      "login": "shemnon",
      "id": 38109,
      "node_id": "MDQ6VXNlcjM4MTA5",
      "avatar_url": "https://avatars.githubusercontent.com/u/38109?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/shemnon",
      "html_url": "https://github.com/shemnon",
      "followers_url": "https://api.github.com/users/shemnon/followers",
      "following_url": "https://api.github.com/users/shemnon/following{/other_user}",
      "gists_url": "https://api.github.com/users/shemnon/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/shemnon/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/shemnon/subscriptions",
      "organizations_url": "https://api.github.com/users/shemnon/orgs",
      "repos_url": "https://api.github.com/users/shemnon/repos",
      "events_url": "https://api.github.com/users/shemnon/events{/privacy}",
      "received_events_url": "https://api.github.com/users/shemnon/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-02-26T15:18:21Z",
    "updated_at": "2023-02-26T15:18:21Z",
    "author_association": "MEMBER",
    "body": "> *So here during my testing I found an interesting bug in Besu that is difference in actual transaction gas consumption when compared to geth and remix VM which I have mentioned in my above comment too.\r\nI was able to fix this behaviour in my PR - https://github.com/hyperledger/besu/pull/5116 ( It seemed some OPCODEs were commented in gas consumption code, by uncommenting those the difference in actual tx gas consumption is fixed)\r\n\r\nPost a test case.  The VM passes all reference tests. I am skeptical that the proposed change actually does what is claimed and need a test case.",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1445386963/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1445919528",
    "html_url": "https://github.com/hyperledger/besu/issues/4244#issuecomment-1445919528",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/4244",
    "id": 1445919528,
    "node_id": "IC_kwDODE2jmc5WLvso",
    "user": {
      "login": "NickSneo",
      "id": 32759145,
      "node_id": "MDQ6VXNlcjMyNzU5MTQ1",
      "avatar_url": "https://avatars.githubusercontent.com/u/32759145?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/NickSneo",
      "html_url": "https://github.com/NickSneo",
      "followers_url": "https://api.github.com/users/NickSneo/followers",
      "following_url": "https://api.github.com/users/NickSneo/following{/other_user}",
      "gists_url": "https://api.github.com/users/NickSneo/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/NickSneo/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/NickSneo/subscriptions",
      "organizations_url": "https://api.github.com/users/NickSneo/orgs",
      "repos_url": "https://api.github.com/users/NickSneo/repos",
      "events_url": "https://api.github.com/users/NickSneo/events{/privacy}",
      "received_events_url": "https://api.github.com/users/NickSneo/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-02-27T08:41:38Z",
    "updated_at": "2023-02-27T08:41:38Z",
    "author_association": "CONTRIBUTOR",
    "body": "For reference pasting link for test script here - https://github.com/hyperledger/besu/pull/5116#issuecomment-1445896269",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1445919528/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1450039503",
    "html_url": "https://github.com/hyperledger/besu/issues/4244#issuecomment-1450039503",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/4244",
    "id": 1450039503,
    "node_id": "IC_kwDODE2jmc5WbdjP",
    "user": {
      "login": "NickSneo",
      "id": 32759145,
      "node_id": "MDQ6VXNlcjMyNzU5MTQ1",
      "avatar_url": "https://avatars.githubusercontent.com/u/32759145?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/NickSneo",
      "html_url": "https://github.com/NickSneo",
      "followers_url": "https://api.github.com/users/NickSneo/followers",
      "following_url": "https://api.github.com/users/NickSneo/following{/other_user}",
      "gists_url": "https://api.github.com/users/NickSneo/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/NickSneo/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/NickSneo/subscriptions",
      "organizations_url": "https://api.github.com/users/NickSneo/orgs",
      "repos_url": "https://api.github.com/users/NickSneo/repos",
      "events_url": "https://api.github.com/users/NickSneo/events{/privacy}",
      "received_events_url": "https://api.github.com/users/NickSneo/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-01T12:10:37Z",
    "updated_at": "2023-03-01T12:10:37Z",
    "author_association": "CONTRIBUTOR",
    "body": "I have unassigned me from the issue as I have closed my PR with comment - https://github.com/hyperledger/besu/pull/5116#issuecomment-1449967929\r\n\r\nAs @antonydenyer has already started working on this issue with his PR - #5142 to fix gas estimate and align with geth implementation, I am no longer working on this. \r\nThanks",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1450039503/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
