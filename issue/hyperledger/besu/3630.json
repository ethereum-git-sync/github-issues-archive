{
  "url": "https://api.github.com/repos/hyperledger/besu/issues/3630",
  "repository_url": "https://api.github.com/repos/hyperledger/besu",
  "labels_url": "https://api.github.com/repos/hyperledger/besu/issues/3630/labels{/name}",
  "comments_url": "https://api.github.com/repos/hyperledger/besu/issues/3630/comments",
  "events_url": "https://api.github.com/repos/hyperledger/besu/issues/3630/events",
  "html_url": "https://github.com/hyperledger/besu/issues/3630",
  "id": 1179830945,
  "node_id": "I_kwDODE2jmc5GUsqh",
  "number": 3630,
  "title": "org.rocksdb.RocksDBException on Fast Sync",
  "user": {
    "login": "ahamlat",
    "id": 5099602,
    "node_id": "MDQ6VXNlcjUwOTk2MDI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5099602?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ahamlat",
    "html_url": "https://github.com/ahamlat",
    "followers_url": "https://api.github.com/users/ahamlat/followers",
    "following_url": "https://api.github.com/users/ahamlat/following{/other_user}",
    "gists_url": "https://api.github.com/users/ahamlat/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ahamlat/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ahamlat/subscriptions",
    "organizations_url": "https://api.github.com/users/ahamlat/orgs",
    "repos_url": "https://api.github.com/users/ahamlat/repos",
    "events_url": "https://api.github.com/users/ahamlat/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ahamlat/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2022-03-24T17:41:39Z",
  "updated_at": "2022-11-08T18:02:37Z",
  "closed_at": null,
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "<!-- Have you done the following? -->\r\n<!--   * read the Code of Conduct? By filing an Issue, you are expected to -->  \r\n<!--     comply with it, including treating everyone with respect: -->\r\n<!--     https://github.com/hyperledger/besu/blob/main/CODE_OF_CONDUCT.md -->\r\n<!--   * Reproduced the issue in the latest version of the software -->\r\n<!--   * Read the debugging docs: https://besu.hyperledger.org/en/stable/HowTo/Monitor/Logging/ -->\r\n<!--   * Duplicate Issue check:  https://github.com/search?q=+is%3Aissue+repo%3Ahyperledger/Besu -->\r\n<!-- Note:  Not all sections will apply to all issue types. -->\r\n\r\n### Description\r\nDuring Fast sync tests on Goerli, I had the same Java Exception 3 times, in 3 different executions. This Exception stops downloading the world state while importing blocks continues its execution. This exception could be related with RocksDB optimistic transactions mode, because in this case commit can fail. In my opinion, we should catch the exception on commit and retry.\r\n\r\n` org.hyperledger.besu.plugin.services.exception.StorageException: org.rocksdb.RocksDBException: Busy\r\n\tat org.hyperledger.besu.plugin.services.storage.rocksdb.segmented.RocksDBColumnarKeyValueStorage$RocksDbTransaction.commit(RocksDBColumnarKeyValueStorage.java:278)\r\n\tat org.hyperledger.besu.services.kvstore.SegmentedKeyValueStorageTransactionTransitionValidatorDecorator.commit(SegmentedKeyValueStorageTransactionTransitionValidatorDecorator.java:49)\r\n\tat org.hyperledger.besu.services.kvstore.SegmentedKeyValueStorageAdapter$1.commit(SegmentedKeyValueStorageAdapter.java:90)\r\n\tat org.hyperledger.besu.ethereum.storage.keyvalue.WorldStateKeyValueStorage$Updater.commit(WorldStateKeyValueStorage.java:206)\r\n\tat org.hyperledger.besu.ethereum.eth.sync.fastsync.worldstate.PersistDataStep.persist(PersistDataStep.java:53)\r\n\tat org.hyperledger.besu.ethereum.eth.sync.fastsync.worldstate.FastWorldStateDownloadProcess$Builder.lambda$build$3(FastWorldStateDownloadProcess.java:202)\r\n\tat org.hyperledger.besu.services.pipeline.MapProcessor.processNextInput(MapProcessor.java:31)\r\n\tat org.hyperledger.besu.services.pipeline.ProcessingStage.run(ProcessingStage.java:38)\r\n\tat org.hyperledger.besu.services.pipeline.Pipeline.lambda$runWithErrorHandling$3(Pipeline.java:152)\r\n\tat java.base/java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:515)\r\n\tat java.base/java.util.concurrent.FutureTask.run(FutureTask.java:264)\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)\r\n\tat java.base/java.lang.Thread.run(Thread.java:829)\r\nCaused by: org.rocksdb.RocksDBException: Busy\r\n\tat org.rocksdb.Transaction.commit(Native Method)\r\n\tat org.rocksdb.Transaction.commit(Transaction.java:206)\r\n\tat org.hyperledger.besu.plugin.services.storage.rocksdb.segmented.RocksDBColumnarKeyValueStorage$RocksDbTransaction.commit(RocksDBColumnarKeyValueStorage.java:272)\r\n\t... 13 more`\r\n### Acceptance Criteria\r\n* Fast sync finishes downloading World State after facing the above exception.\r\n\r\n### Steps to Reproduce (Bug)\r\nThis exception is difficult to reproduce because it does not occur at every Fast sync execution. For my case, I started Fast Sync on Goerli several times, and I got the exception two times.\r\n\r\n**Expected behavior:** \r\nRecover from the exception and continue downloading World State.\r\n\r\n**Actual behavior:** \r\nStop downloading the world state while importing blocks continues its execution. \r\n\r\n**Frequency:**\r\nSometimes\r\n\r\n### Versions (Add all that apply)\r\n* Software version: 22.1.1\r\n* Java version: OpenJDK 64-Bit Server VM Corretto-11.0.14.10.1 (build 11.0.14.1+10-LTS, mixed mode)\r\n* OS Name & Version:  NAME=\"Amazon Linux\", VERSION=\"2\", ID=\"amzn\", ID_LIKE=\"centos rhel fedora\", VERSION_ID=\"2\", PRETTY_NAME=\"Amazon Linux 2\", ANSI_COLOR=\"0;33\", Amazon Linux release 2 (Karoo)\r\n\r\n* Kernel Version: Linux ip-10-0-2-103.us-east-2.compute.internal 4.14.232-177.418.amzn2.x86_64  SMP Tue Jun 15 20:57:50 UTC 2021 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n* Docker Version: Client/Server : 20.10.7\r\n* Cloud VM, type, size: Amazon Web Services i3.xlarge\r\n\r\n\r\n### Additional Information (Add any of the following or anything else that may be relevant)\r\n* Besu setup info : network=goerli\r\n* System info - memory, CPU : 4 vCPU, 30.5 GB RAM, 950 GB NVMe SSD, up to 10 Gbps Network\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/3630/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/hyperledger/besu/issues/3630/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1307622268",
    "html_url": "https://github.com/hyperledger/besu/issues/3630#issuecomment-1307622268",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/3630",
    "id": 1307622268,
    "node_id": "IC_kwDODE2jmc5N8Lt8",
    "user": {
      "login": "non-fungible-nelson",
      "id": 85905982,
      "node_id": "MDQ6VXNlcjg1OTA1OTgy",
      "avatar_url": "https://avatars.githubusercontent.com/u/85905982?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/non-fungible-nelson",
      "html_url": "https://github.com/non-fungible-nelson",
      "followers_url": "https://api.github.com/users/non-fungible-nelson/followers",
      "following_url": "https://api.github.com/users/non-fungible-nelson/following{/other_user}",
      "gists_url": "https://api.github.com/users/non-fungible-nelson/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/non-fungible-nelson/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/non-fungible-nelson/subscriptions",
      "organizations_url": "https://api.github.com/users/non-fungible-nelson/orgs",
      "repos_url": "https://api.github.com/users/non-fungible-nelson/repos",
      "events_url": "https://api.github.com/users/non-fungible-nelson/events{/privacy}",
      "received_events_url": "https://api.github.com/users/non-fungible-nelson/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-11-08T18:02:37Z",
    "updated_at": "2022-11-08T18:02:37Z",
    "author_association": "CONTRIBUTOR",
    "body": "@ahamlat do we still care about this? I am inclined to close this as we have made many improvements to snap and may set it as default. ",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1307622268/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
