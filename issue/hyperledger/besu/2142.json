{
  "url": "https://api.github.com/repos/hyperledger/besu/issues/2142",
  "repository_url": "https://api.github.com/repos/hyperledger/besu",
  "labels_url": "https://api.github.com/repos/hyperledger/besu/issues/2142/labels{/name}",
  "comments_url": "https://api.github.com/repos/hyperledger/besu/issues/2142/comments",
  "events_url": "https://api.github.com/repos/hyperledger/besu/issues/2142/events",
  "html_url": "https://github.com/hyperledger/besu/issues/2142",
  "id": 857702712,
  "node_id": "MDU6SXNzdWU4NTc3MDI3MTI=",
  "number": 2142,
  "title": "Invalid packets in discovery agent throw an error, but should only be logged as a debug message",
  "user": {
    "login": "daniel-iobuilders",
    "id": 44777168,
    "node_id": "MDQ6VXNlcjQ0Nzc3MTY4",
    "avatar_url": "https://avatars.githubusercontent.com/u/44777168?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/daniel-iobuilders",
    "html_url": "https://github.com/daniel-iobuilders",
    "followers_url": "https://api.github.com/users/daniel-iobuilders/followers",
    "following_url": "https://api.github.com/users/daniel-iobuilders/following{/other_user}",
    "gists_url": "https://api.github.com/users/daniel-iobuilders/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/daniel-iobuilders/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/daniel-iobuilders/subscriptions",
    "organizations_url": "https://api.github.com/users/daniel-iobuilders/orgs",
    "repos_url": "https://api.github.com/users/daniel-iobuilders/repos",
    "events_url": "https://api.github.com/users/daniel-iobuilders/events{/privacy}",
    "received_events_url": "https://api.github.com/users/daniel-iobuilders/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2021-04-14T09:22:17Z",
  "updated_at": "2021-04-28T02:14:29Z",
  "closed_at": "2021-04-28T02:14:29Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "Recently a lot of error messages appear in the log when Besu syncs one of the test nets. The error messages look like this:\r\n\r\n```\r\n2021-04-12 18:34:42.924+00:00 | vert.x-eventloop-thread-1 | ERROR | VertxPeerDiscoveryAgent | Encountered error while handling packet\r\njava.lang.IllegalArgumentException: Could not recover public key\r\n\tat org.hyperledger.besu.crypto.SECP256K1.recoverFromSignatureNative(SECP256K1.java:420)\r\n\tat org.hyperledger.besu.crypto.SECP256K1$PublicKey.recoverFromSignature(SECP256K1.java:539)\r\n\tat org.hyperledger.besu.ethereum.p2p.discovery.internal.Packet.<init>(Packet.java:83)\r\n\tat org.hyperledger.besu.ethereum.p2p.discovery.internal.Packet.decode(Packet.java:119)\r\n\tat org.hyperledger.besu.ethereum.p2p.discovery.VertxPeerDiscoveryAgent.lambda$handlePacket$6(VertxPeerDiscoveryAgent.java:221)\r\n\tat io.vertx.core.impl.ContextImpl.lambda$executeBlocking$2(ContextImpl.java:313)\r\n\tat io.vertx.core.impl.TaskQueue.run(TaskQueue.java:76)\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1130)\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:630)\r\n\tat io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\r\n\tat java.base/java.lang.Thread.run(Thread.java:832)\r\n```\r\n\r\n[A PR of mine ](https://github.com/hyperledger/besu/pull/1933) was changing SECP256K1, [so the first assumption was that it was causing this error messages](https://github.com/hyperledger/besu/pull/1933#issuecomment-818600272). [After investigating it and testing it with different releases of Besu](https://github.com/hyperledger/besu/pull/1933#issuecomment-819350912), I found out that the PR in question did not cause it. The same error messages appear with older releases of Besu, like 21.1.0 or 20.10.4, which were released before the PR was merged.\r\n\r\nThis can be verified and reproduced by using one of the mentioned releases or the current one with the following config file:\r\n```\r\nminer-enabled=false\r\ngraphql-http-enabled=false\r\nsync-mode=\"FULL\"\r\npruning-enabled=true\r\nrpc-ws-enabled=false\r\ndata-path=\"/home/USER/chains/ropsten\"\r\nrpc-http-enabled=false\r\nnetwork=\"ROPSTEN\"\r\n```\r\n\r\nAfter about 5 - 15 minutes of syncing the error messages will appear in the log.\r\n\r\nThe problem is that the discovery agent receives packets with invalid signatures and throws an exception afterwards. This packets are not causing any problems, they are simply invalid and should not create an error. I suggest that instead of throwing an exception it should just create a debug message, so it is not cluttering the logs.\r\n\r\nThis is the part of the code that I would suggest to change:\r\n```\r\n// org.hyperledger.besu.ethereum.p2p.discovery.internal.Packet.<init>(Packet.java:83)\r\n\r\n    this.publicKey =\r\n        SIGNATURE_ALGORITHM\r\n            .get()\r\n            .recoverPublicKeyFromSignature(keccak256(signedPayload), this.signature)\r\n            .orElseThrow(\r\n                () ->\r\n                    new PeerDiscoveryPacketDecodingException(\r\n                        \"Invalid packet signature, \" + \"cannot recover public key\"));\r\n```\r\n\r\nI suggest to catch the `IllegalArgumentException` thrown by `org.hyperledger.besu.crypto.SignatureAlgorithm.recoverPublicKeyFromSignature*`  and create a debug log message with `Invalid packet signature cannot recover public key` instead.\r\n\r\nPlease tell me your thoughts about this change. If it is considered to be alright I could create the PR for it.\r\n\r\nOriginal reporters of the issue: @matkt @3nprob",
  "closed_by": {
    "login": "shemnon",
    "id": 38109,
    "node_id": "MDQ6VXNlcjM4MTA5",
    "avatar_url": "https://avatars.githubusercontent.com/u/38109?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/shemnon",
    "html_url": "https://github.com/shemnon",
    "followers_url": "https://api.github.com/users/shemnon/followers",
    "following_url": "https://api.github.com/users/shemnon/following{/other_user}",
    "gists_url": "https://api.github.com/users/shemnon/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/shemnon/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/shemnon/subscriptions",
    "organizations_url": "https://api.github.com/users/shemnon/orgs",
    "repos_url": "https://api.github.com/users/shemnon/repos",
    "events_url": "https://api.github.com/users/shemnon/events{/privacy}",
    "received_events_url": "https://api.github.com/users/shemnon/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/2142/reactions",
    "total_count": 1,
    "+1": 1,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/hyperledger/besu/issues/2142/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/819614135",
    "html_url": "https://github.com/hyperledger/besu/issues/2142#issuecomment-819614135",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/2142",
    "id": 819614135,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgxOTYxNDEzNQ==",
    "user": {
      "login": "RatanRSur",
      "id": 4733314,
      "node_id": "MDQ6VXNlcjQ3MzMzMTQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4733314?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/RatanRSur",
      "html_url": "https://github.com/RatanRSur",
      "followers_url": "https://api.github.com/users/RatanRSur/followers",
      "following_url": "https://api.github.com/users/RatanRSur/following{/other_user}",
      "gists_url": "https://api.github.com/users/RatanRSur/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/RatanRSur/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/RatanRSur/subscriptions",
      "organizations_url": "https://api.github.com/users/RatanRSur/orgs",
      "repos_url": "https://api.github.com/users/RatanRSur/repos",
      "events_url": "https://api.github.com/users/RatanRSur/events{/privacy}",
      "received_events_url": "https://api.github.com/users/RatanRSur/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-04-14T15:36:21Z",
    "updated_at": "2021-04-14T15:36:21Z",
    "author_association": "CONTRIBUTOR",
    "body": "I think that's a good solution and we would welcome a PR!",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/819614135/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/819632494",
    "html_url": "https://github.com/hyperledger/besu/issues/2142#issuecomment-819632494",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/2142",
    "id": 819632494,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgxOTYzMjQ5NA==",
    "user": {
      "login": "shemnon",
      "id": 38109,
      "node_id": "MDQ6VXNlcjM4MTA5",
      "avatar_url": "https://avatars.githubusercontent.com/u/38109?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/shemnon",
      "html_url": "https://github.com/shemnon",
      "followers_url": "https://api.github.com/users/shemnon/followers",
      "following_url": "https://api.github.com/users/shemnon/following{/other_user}",
      "gists_url": "https://api.github.com/users/shemnon/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/shemnon/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/shemnon/subscriptions",
      "organizations_url": "https://api.github.com/users/shemnon/orgs",
      "repos_url": "https://api.github.com/users/shemnon/repos",
      "events_url": "https://api.github.com/users/shemnon/events{/privacy}",
      "received_events_url": "https://api.github.com/users/shemnon/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-04-14T16:01:53Z",
    "updated_at": "2021-04-14T16:01:53Z",
    "author_association": "MEMBER",
    "body": "I concur that the likely cause is some other client sending bogus packets.  But because of the flow logic I think we need to keep the exception.\r\n\r\nIn VertexPeerDiscoveryAgent line 234 is where the handling of the logging occurs.  We already have a check for a specific type of exception.  I think the cleanest fix is to go into org.hyperleder.besu.ethereum.p2p.discovery.internal.Packet and move the `return new Packet(...)` statement inside of the try/catch at lines 120-124.  That will result in all cases where a packet could not be produced resulting in a PeerDiscoveryPacketDecodingException, which will then be logged as debug.",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/819632494/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/820160144",
    "html_url": "https://github.com/hyperledger/besu/issues/2142#issuecomment-820160144",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/2142",
    "id": 820160144,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgyMDE2MDE0NA==",
    "user": {
      "login": "3nprob",
      "id": 74199244,
      "node_id": "MDQ6VXNlcjc0MTk5MjQ0",
      "avatar_url": "https://avatars.githubusercontent.com/u/74199244?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/3nprob",
      "html_url": "https://github.com/3nprob",
      "followers_url": "https://api.github.com/users/3nprob/followers",
      "following_url": "https://api.github.com/users/3nprob/following{/other_user}",
      "gists_url": "https://api.github.com/users/3nprob/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/3nprob/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/3nprob/subscriptions",
      "organizations_url": "https://api.github.com/users/3nprob/orgs",
      "repos_url": "https://api.github.com/users/3nprob/repos",
      "events_url": "https://api.github.com/users/3nprob/events{/privacy}",
      "received_events_url": "https://api.github.com/users/3nprob/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-04-15T06:42:39Z",
    "updated_at": "2021-04-15T06:55:28Z",
    "author_association": "CONTRIBUTOR",
    "body": "@shemnon Followed your directions in #2143 \r\n\r\nWe are now instead hit by #1715  on mainnet nodes",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/820160144/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/827271067",
    "html_url": "https://github.com/hyperledger/besu/issues/2142#issuecomment-827271067",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/2142",
    "id": 827271067,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgyNzI3MTA2Nw==",
    "user": {
      "login": "stevanlohja",
      "id": 10556209,
      "node_id": "MDQ6VXNlcjEwNTU2MjA5",
      "avatar_url": "https://avatars.githubusercontent.com/u/10556209?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/stevanlohja",
      "html_url": "https://github.com/stevanlohja",
      "followers_url": "https://api.github.com/users/stevanlohja/followers",
      "following_url": "https://api.github.com/users/stevanlohja/following{/other_user}",
      "gists_url": "https://api.github.com/users/stevanlohja/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/stevanlohja/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/stevanlohja/subscriptions",
      "organizations_url": "https://api.github.com/users/stevanlohja/orgs",
      "repos_url": "https://api.github.com/users/stevanlohja/repos",
      "events_url": "https://api.github.com/users/stevanlohja/events{/privacy}",
      "received_events_url": "https://api.github.com/users/stevanlohja/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-04-27T02:40:29Z",
    "updated_at": "2021-04-27T02:40:29Z",
    "author_association": "CONTRIBUTOR",
    "body": "I get a similar error message with the classic network.\r\n\r\n```\r\njava.lang.IllegalArgumentException: Could not recover public key\r\n\tat org.hyperledger.besu.crypto.SECP256K1.recoverFromSignatureNative(SECP256K1.java:495)\r\n\tat org.hyperledger.besu.crypto.SECP256K1.recoverPublicKeyFromSignature(SECP256K1.java:370)\r\n\tat org.hyperledger.besu.ethereum.p2p.discovery.internal.Packet.<init>(Packet.java:90)\r\n\tat org.hyperledger.besu.ethereum.p2p.discovery.internal.Packet.decode(Packet.java:126)\r\n\tat org.hyperledger.besu.ethereum.p2p.discovery.VertxPeerDiscoveryAgent.lambda$handlePacket$6(VertxPeerDiscoveryAgent.java:221)\r\n\tat io.vertx.core.impl.ContextImpl.lambda$executeBlocking$2(ContextImpl.java:313)\r\n\tat io.vertx.core.impl.TaskQueue.run(TaskQueue.java:76)\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(Unknown Source)\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source)\r\n\tat io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\r\n\tat java.base/java.lang.Thread.run(Unknown Source)\r\n```\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/827271067/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
