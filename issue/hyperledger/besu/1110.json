{
  "url": "https://api.github.com/repos/hyperledger/besu/issues/1110",
  "repository_url": "https://api.github.com/repos/hyperledger/besu",
  "labels_url": "https://api.github.com/repos/hyperledger/besu/issues/1110/labels{/name}",
  "comments_url": "https://api.github.com/repos/hyperledger/besu/issues/1110/comments",
  "events_url": "https://api.github.com/repos/hyperledger/besu/issues/1110/events",
  "html_url": "https://github.com/hyperledger/besu/issues/1110",
  "id": 640891196,
  "node_id": "MDU6SXNzdWU2NDA4OTExOTY=",
  "number": 1110,
  "title": "Privacy: Restart caused by insufficient memory can cause inconsistent private state ",
  "user": {
    "login": "pinges",
    "id": 16143240,
    "node_id": "MDQ6VXNlcjE2MTQzMjQw",
    "avatar_url": "https://avatars.githubusercontent.com/u/16143240?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/pinges",
    "html_url": "https://github.com/pinges",
    "followers_url": "https://api.github.com/users/pinges/followers",
    "following_url": "https://api.github.com/users/pinges/following{/other_user}",
    "gists_url": "https://api.github.com/users/pinges/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/pinges/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/pinges/subscriptions",
    "organizations_url": "https://api.github.com/users/pinges/orgs",
    "repos_url": "https://api.github.com/users/pinges/repos",
    "events_url": "https://api.github.com/users/pinges/events{/privacy}",
    "received_events_url": "https://api.github.com/users/pinges/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1537362490,
      "node_id": "MDU6TGFiZWwxNTM3MzYyNDkw",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/bug",
      "name": "bug",
      "color": "d73a4a",
      "default": true,
      "description": "Something isn't working"
    },
    {
      "id": 1740324632,
      "node_id": "MDU6TGFiZWwxNzQwMzI0NjMy",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/privacy",
      "name": "privacy",
      "color": "d7f99a",
      "default": false,
      "description": "private transactions"
    },
    {
      "id": 2051683248,
      "node_id": "MDU6TGFiZWwyMDUxNjgzMjQ4",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/P2",
      "name": "P2",
      "color": "ff9900",
      "default": false,
      "description": "High (ex: Degrading performance issues, unexpected behavior of core features (DevP2P, syncing, etc))"
    },
    {
      "id": 2152224197,
      "node_id": "MDU6TGFiZWwyMTUyMjI0MTk3",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/TeamRevenant",
      "name": "TeamRevenant",
      "color": "78e298",
      "default": false,
      "description": "GH issues worked on by Revenant Team"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "pinges",
    "id": 16143240,
    "node_id": "MDQ6VXNlcjE2MTQzMjQw",
    "avatar_url": "https://avatars.githubusercontent.com/u/16143240?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/pinges",
    "html_url": "https://github.com/pinges",
    "followers_url": "https://api.github.com/users/pinges/followers",
    "following_url": "https://api.github.com/users/pinges/following{/other_user}",
    "gists_url": "https://api.github.com/users/pinges/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/pinges/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/pinges/subscriptions",
    "organizations_url": "https://api.github.com/users/pinges/orgs",
    "repos_url": "https://api.github.com/users/pinges/repos",
    "events_url": "https://api.github.com/users/pinges/events{/privacy}",
    "received_events_url": "https://api.github.com/users/pinges/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "pinges",
      "id": 16143240,
      "node_id": "MDQ6VXNlcjE2MTQzMjQw",
      "avatar_url": "https://avatars.githubusercontent.com/u/16143240?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pinges",
      "html_url": "https://github.com/pinges",
      "followers_url": "https://api.github.com/users/pinges/followers",
      "following_url": "https://api.github.com/users/pinges/following{/other_user}",
      "gists_url": "https://api.github.com/users/pinges/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pinges/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pinges/subscriptions",
      "organizations_url": "https://api.github.com/users/pinges/orgs",
      "repos_url": "https://api.github.com/users/pinges/repos",
      "events_url": "https://api.github.com/users/pinges/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pinges/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": {
    "url": "https://api.github.com/repos/hyperledger/besu/milestones/11",
    "html_url": "https://github.com/hyperledger/besu/milestone/11",
    "labels_url": "https://api.github.com/repos/hyperledger/besu/milestones/11/labels",
    "id": 5613832,
    "node_id": "MDk6TWlsZXN0b25lNTYxMzgzMg==",
    "number": 11,
    "title": "1.6 Privacy Features",
    "description": "",
    "creator": {
      "login": "MadelineMurray",
      "id": 43356962,
      "node_id": "MDQ6VXNlcjQzMzU2OTYy",
      "avatar_url": "https://avatars.githubusercontent.com/u/43356962?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MadelineMurray",
      "html_url": "https://github.com/MadelineMurray",
      "followers_url": "https://api.github.com/users/MadelineMurray/followers",
      "following_url": "https://api.github.com/users/MadelineMurray/following{/other_user}",
      "gists_url": "https://api.github.com/users/MadelineMurray/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MadelineMurray/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MadelineMurray/subscriptions",
      "organizations_url": "https://api.github.com/users/MadelineMurray/orgs",
      "repos_url": "https://api.github.com/users/MadelineMurray/repos",
      "events_url": "https://api.github.com/users/MadelineMurray/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MadelineMurray/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 0,
    "closed_issues": 9,
    "state": "closed",
    "created_at": "2020-07-03T01:50:24Z",
    "updated_at": "2021-11-16T09:54:51Z",
    "due_on": "2020-09-30T07:00:00Z",
    "closed_at": "2021-11-16T09:54:51Z"
  },
  "comments": 2,
  "created_at": "2020-06-18T04:09:53Z",
  "updated_at": "2020-08-31T04:28:31Z",
  "closed_at": "2020-08-31T04:28:31Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "Tasks:\n- [x] Deploy updated Orion and Besu to test network\n- [ ] Rerun test scripts and validate changes\n\nWhile running reorg testing with six besu/orion clients the following happened on two of the machines causing the state on that machine to become inconsistent with the rest of the members of the privacy group:\n\nBesu Log:\n{\"timestamp\":\"2020-06-14T02:11:30,248\",\"level\":\"INFO\",\"thread\":\"EthScheduler-Workers-1\",\"class\":\"BlockPropagationManager\",\"message\":\"Imported #8,088,448 / 4 tx / 0 om / 4,475,388 (55.9%) gas / (0xa8f49cdc62fcf7de79b42d46ffcb89cbaafd8656dcc112fb9fd39c8b792c1373) in 0.903s. Peers: 39\",\"throwable\":\"\"}\n{\"timestamp\":\"2020-06-14T02:13:18,932\",\"level\":\"INFO\",\"thread\":\"nioEventLoopGroup-3-1\",\"class\":\"BlockPropagationManager\",\"message\":\"Saving announced block 8088450 (0x8ae8ca9866c1e626933fb4828ab9c8775afae74dc7c577e9e5b16a401178e839) for future import\",\"throwable\":\"\"}\n{\"timestamp\":\"2020-06-14T02:15:05,908\",\"level\":\"INFO\",\"thread\":\"nioEventLoopGroup-3-1\",\"class\":\"BlockPropagationManager\",\"message\":\"Saving announced block 8088451 \n.\n. <some log lines left out>\n.\n{\"timestamp\":\"2020-06-14T02:15:09,286\",\"level\":\"INFO\",\"thread\":\"nioEventLoopGroup-3-5\",\"class\":\"BlockPropagationManager\",\"message\":\"Saving announced block 8088463 (0x2352f8e831f2a2a13dcb4e70f3ffaefb05ff8e09cdafdc1de40d12affe80461a) for future import\",\"throwable\":\"\"}\n{\"timestamp\":\"2020-06-14T02:15:09,300\",\"level\":\"INFO\",\"thread\":\"nioEventLoopGroup-3-5\",\"class\":\"BlockPropagationManager\",\"message\":\"Saving announced block 8088464 (0x207de6caace4575bb29e75b98801e53d321750a9e63b0f1d323938cbb708eab8) for future import\",\"throwable\":\"\"}\nOpenJDK 64-Bit Server VM warning: INFO: os::commit_memory(0x00000000e6c00000, 90177536, 0) failed; error='Not enough space' (errno=12)\n[thread 21178 also had an error]\n[thread 21183 also had an error]\n[thread 21192 also had an error]\n[thread 21257 also had an error]\n[thread 21127 also had an error]\n[thread 21117 also had an error]\n#\n# There is insufficient memory for the Java Runtime Environment to continue.\n# Native memory allocation (mmap) failed to map 90177536 bytes for committing reserved memory.\n# An error report file with more information is saved as:\n# /tmp/hs_err_pid21038.log\n[thread 21179 also had an error]\n[thread 21181 also had an error]\nRecording 1 scheduled to start in 15 s.\n\nUse jcmd 30545 JFR.dump name=1 to copy recording data to file.\nSetting logging level to INFO\n{\"timestamp\":\"2020-06-14T02:15:33,476\",\"level\":\"INFO\",\"thread\":\"main\",\"class\":\"AltBN128PairingPrecompiledContract\",\"message\":\"Using native alt bn128\",\"throwable\":\"\"}\n{\"timestamp\":\"2020-06-14T02:15:34,447\",\"level\":\"INFO\",\"thread\":\"main\",\"class\":\"SECP256K1\",\"message\":\"Using native secp256k1\",\"throwable\":\"\"}\n.\n. <some log lines left out>\n.\n{\"timestamp\":\"2020-06-14T02:15:56,154\",\"level\":\"INFO\",\"thread\":\"nioEventLoopGroup-3-4\",\"class\":\"FullSyncTargetManager\",\"message\":\"No sync target, waiting for peers: 1\",\"throwable\":\"\"}\n{\"timestamp\":\"2020-06-14T02:15:57,949\",\"level\":\"INFO\",\"thread\":\"nioEventLoopGroup-3-4\",\"class\":\"SyncTargetManager\",\"message\":\"Found common ancestor with peer 0x936ac2bf0b816350eb... at block 8088448\",\"throwable\":\"\"}\n{\"timestamp\":\"2020-06-14T02:16:07,093\",\"level\":\"INFO\",\"thread\":\"nioEventLoopGroup-3-4\",\"class\":\"BlockPropagationManager\",\"message\":\"Saving announced block 8088467 (0xd9c239e06ffedcc87005f3d4ac06513260baf3206a21a1585b9f38ef4c7da36f) for future import\",\"throwable\":\"\"}\n{\"timestamp\":\"2020-06-14T02:16:08,486\",\"level\":\"INFO\",\"thread\":\"nioEventLoopGroup-3-6\",\"class\":\"BlockPropagationManager\",\"message\":\"Saving announced block 8088466 (0x11fa862f07df203a8a5e39b100ba21d80900f591c8a1c8930f5322fdeddc56e2) for future import\",\"throwable\":\"\"}\n**{\"timestamp\":\"2020-06-14T02:16:12,404\",\"level\":\"ERROR\",\"thread\":\"EthScheduler-Services-5 (importBlock)\",\"class\":\"PrivacyPrecompiledContract\",\"message\":\"Failed to process private transaction 0x74c37eb6c8d172ca6a41420ffbb963f848ae92eb6aaa28e85bfcaffcb4b429d5: Private Transaction nonce 0, is lower than sender account nonce 1.\",\"throwable\":\"\"}**\n{\"timestamp\":\"2020-06-14T02:16:41,452\",\"level\":\"INFO\",\"thread\":\"EthScheduler-Workers-1\",\"class\":\"BlockPropagationManager\",\"message\":\"Imported 1 pending blocks\",\"throwable\":\"\"}\n\n",
  "closed_by": {
    "login": "pinges",
    "id": 16143240,
    "node_id": "MDQ6VXNlcjE2MTQzMjQw",
    "avatar_url": "https://avatars.githubusercontent.com/u/16143240?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/pinges",
    "html_url": "https://github.com/pinges",
    "followers_url": "https://api.github.com/users/pinges/followers",
    "following_url": "https://api.github.com/users/pinges/following{/other_user}",
    "gists_url": "https://api.github.com/users/pinges/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/pinges/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/pinges/subscriptions",
    "organizations_url": "https://api.github.com/users/pinges/orgs",
    "repos_url": "https://api.github.com/users/pinges/repos",
    "events_url": "https://api.github.com/users/pinges/events{/privacy}",
    "received_events_url": "https://api.github.com/users/pinges/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/1110/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/hyperledger/besu/issues/1110/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/645786271",
    "html_url": "https://github.com/hyperledger/besu/issues/1110#issuecomment-645786271",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/1110",
    "id": 645786271,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY0NTc4NjI3MQ==",
    "user": {
      "login": "pinges",
      "id": 16143240,
      "node_id": "MDQ6VXNlcjE2MTQzMjQw",
      "avatar_url": "https://avatars.githubusercontent.com/u/16143240?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pinges",
      "html_url": "https://github.com/pinges",
      "followers_url": "https://api.github.com/users/pinges/followers",
      "following_url": "https://api.github.com/users/pinges/following{/other_user}",
      "gists_url": "https://api.github.com/users/pinges/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pinges/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pinges/subscriptions",
      "organizations_url": "https://api.github.com/users/pinges/orgs",
      "repos_url": "https://api.github.com/users/pinges/repos",
      "events_url": "https://api.github.com/users/pinges/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pinges/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-06-18T05:38:07Z",
    "updated_at": "2020-06-18T05:40:09Z",
    "author_association": "CONTRIBUTOR",
    "body": "The private transactions used for testing are calling the xor fuction on the following contract:\r\n\r\ncontract ReorgTest {\r\n    event stored(address _to, uint _amount);\r\n    uint _value;\r\n    function xor(uint _input) public returns (uint) {\r\n        uint _tmp = _value;\r\n        _value ^= _input;\r\n        emit xored(msg.sender, _input, _value, _tmp, block.number, blockhash(block.number - 1));\r\n    }\r\n    function value()  view public  returns (uint) {\r\n        return _value;\r\n    }\r\n    event xored(address sender, uint input, uint newValue, uint oldValue, uint blockNumber, bytes32 ParentBlockhash);\r\n}\r\n\r\nThe sender of the private transaction is randomly created for every transaction.\r\n\r\nCorrect state: BlockNumber : 0x7b7017 _value: 0x112218235e554abc10b071f703aa932e9b389bd2130c27703f6199ea0eaf68d3\r\nSydney 0.      : BlockNumber :   0x7b7017 _value: 0x606fe089057cbb05396309f213ab96941c6a83af95acc1decbe660d2ad3868d\r\n\r\nThe failed transaction:\r\n[ec2-user@ip-10-2-2-111 besu]$ curl -X POST --data '{\"jsonrpc\":\"2.0\",\"method\":\"priv_getPrivateTransaction\",\"params\":[\"0x74c37eb6c8d172ca6a41420ffbb963f848ae92eb6aaa28e85bfcaffcb4b429d5\"], \"id\":1}' http://127.0.0.1:8545\r\n{\r\n  \"jsonrpc\" : \"2.0\",\r\n  \"id\" : 1,\r\n  \"result\" : {\r\n    \"from\" : \"0x22196b5f04598f720dcba13441be05269c9135d0\",\r\n    \"gas\" : \"0x1875b\",\r\n    \"gasPrice\" : \"0x4a817c800\",\r\n    \"hash\" : \"0xf5a396a5ea088d6ff1515e837c6407fd31a790039be52fe1e1af370d7c9da397\",\r\n    \"input\" : \"0x9867ef7b**1724e62bce02810c4326416822902a47dafe33e8ea56eb6dd3dfffe7247cee5e**\",\r\n    \"nonce\" : \"0x0\",\r\n    \"to\" : \"0xa00aa0313caf05c2876cd05765c63ad1806b23fb\",\r\n    \"value\" : \"0x0\",\r\n    \"v\" : \"0x2a\",\r\n    \"r\" : \"0xee3415e9f7f17f4c214d10ae8a2559c683acf57f3ecee2188efd9d7b06481e09\",\r\n    \"s\" : \"0xffb3634507d02a91b8831f6a84867cda7561d7a9a05f24935f902935a54cbc7\",\r\n    \"privateFrom\" : \"8+0vxIheTou+qqhpAHXqWRqfryfl4cpU+piYatksf0w=\",\r\n    \"privacyGroupId\" : \"W6d4xi8ju2N8NCSXgmaMuqTNU9dtDRfOjZrN7NbN3Z8=\",\r\n    \"restriction\" : \"restricted\"\r\n  }\r\n\r\nXoring the Sydney0 _value with 1724e62bce02810c4326416822902a47dafe33e8ea56eb6dd3dfffe7247cee5e results in the correct value.\r\n\r\ncurl -X POST --data '{\"jsonrpc\":\"2.0\",\"method\":\"priv_getTransactionCount\",\"params\":[\"0x22196b5f04598f720dcba13441be05269c9135d0\", \"W6d4xi8ju2N8NCSXgmaMuqTNU9dtDRfOjZrN7NbN3Z8=\"], \"id\":1}' http://127.0.0.1:8545\r\n{\r\n  \"jsonrpc\" : \"2.0\",\r\n  \"id\" : 1,\r\n  \"result\" : \"**0x0**\"\r\n}\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/645786271/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/650451623",
    "html_url": "https://github.com/hyperledger/besu/issues/1110#issuecomment-650451623",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/1110",
    "id": 650451623,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY1MDQ1MTYyMw==",
    "user": {
      "login": "MadelineMurray",
      "id": 43356962,
      "node_id": "MDQ6VXNlcjQzMzU2OTYy",
      "avatar_url": "https://avatars.githubusercontent.com/u/43356962?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MadelineMurray",
      "html_url": "https://github.com/MadelineMurray",
      "followers_url": "https://api.github.com/users/MadelineMurray/followers",
      "following_url": "https://api.github.com/users/MadelineMurray/following{/other_user}",
      "gists_url": "https://api.github.com/users/MadelineMurray/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MadelineMurray/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MadelineMurray/subscriptions",
      "organizations_url": "https://api.github.com/users/MadelineMurray/orgs",
      "repos_url": "https://api.github.com/users/MadelineMurray/repos",
      "events_url": "https://api.github.com/users/MadelineMurray/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MadelineMurray/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-06-26T23:39:29Z",
    "updated_at": "2020-06-26T23:39:29Z",
    "author_association": "CONTRIBUTOR",
    "body": "Couldn't recreate in a controlled manner.  Will confirm fixed by running on Ropsten again and comparing the logs. ",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/650451623/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
