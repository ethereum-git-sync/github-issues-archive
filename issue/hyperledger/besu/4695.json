{
  "url": "https://api.github.com/repos/hyperledger/besu/issues/4695",
  "repository_url": "https://api.github.com/repos/hyperledger/besu",
  "labels_url": "https://api.github.com/repos/hyperledger/besu/issues/4695/labels{/name}",
  "comments_url": "https://api.github.com/repos/hyperledger/besu/issues/4695/comments",
  "events_url": "https://api.github.com/repos/hyperledger/besu/issues/4695/events",
  "html_url": "https://github.com/hyperledger/besu/issues/4695",
  "id": 1453301766,
  "node_id": "I_kwDODE2jmc5Wn6AG",
  "number": 4695,
  "title": "P2P MTLS not able to connect to chain certificates (without root in truststore)",
  "user": {
    "login": "daragao",
    "id": 3007280,
    "node_id": "MDQ6VXNlcjMwMDcyODA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3007280?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/daragao",
    "html_url": "https://github.com/daragao",
    "followers_url": "https://api.github.com/users/daragao/followers",
    "following_url": "https://api.github.com/users/daragao/following{/other_user}",
    "gists_url": "https://api.github.com/users/daragao/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/daragao/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/daragao/subscriptions",
    "organizations_url": "https://api.github.com/users/daragao/orgs",
    "repos_url": "https://api.github.com/users/daragao/repos",
    "events_url": "https://api.github.com/users/daragao/events{/privacy}",
    "received_events_url": "https://api.github.com/users/daragao/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 0,
  "created_at": "2022-11-17T12:57:18Z",
  "updated_at": "2022-11-17T12:57:18Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Description\r\nI am creating a Besu private network with uses the P2P MTLS.\r\n\r\n\r\nI have been able to connect nodes in the following situations:\r\n- Self signed certificates are used in the keystore and truststore\r\n- Chain Certificates are used in the keystore and Root Certificates are used in the truststore\r\n\r\n\r\nI am unable to setup the following:\r\n- Chain Certificate in keystore. Only Sender Certificate on the truststore (no root certificate).\r\n\r\nThe reason why I don't want to use the root certificate in the truststore is because that will allow P2P connections  from any certificate signed by that root. I have tested this behavior.\r\n\r\nTo be clear, I am using a chain that has a Sender Certificate + Intermediate Certificate + Root Certificate.\r\n\r\n### Steps to Reproduce (Bug)\r\n1. Setup Network with MTLS P2P\r\n2. Use a chain certificate on the keystore\r\n3. Use a single certificate on the truststore\r\n\r\n**Expected behavior:**\r\nConnection without errors.\r\n\r\n**Actual behavior:**\r\nThere is an SSLHandshake Exception between the nodes, pasting logs bellow:\r\n\r\n```\r\n2022-11-16 23:12:29.909+00:00 | nioEventLoopGroup-3-6 | INFO  | TLSContextFactory | Initializing SSL Context using PKCS12 keystore.\r\n2022-11-16 23:12:29.909+00:00 | nioEventLoopGroup-3-8 | INFO  | TLSContextFactory | Initializing SSL Context using PKCS12 keystore.\r\n2022-11-16 23:12:29.909+00:00 | nioEventLoopGroup-3-7 | INFO  | TLSContextFactory | Initializing SSL Context using PKCS12 keystore.\r\n2022-11-16 23:12:30.029+00:00 | nioEventLoopGroup-3-6 | DEBUG | SslHandler | [id: 0x05b1512f, L:/10.88.153.89:35048 - R:/10.88.109.1:30303] HANDSHAKEN: protocol:TLSv1.3 cipher suite:TLS_AES_256_GCM_SHA384\r\n2022-11-16 23:12:30.029+00:00 | nioEventLoopGroup-3-6 | DEBUG | HandshakeHandlerOutbound | Wrote initial crypto handshake message to /10.88.109.1:30303.\r\n2022-11-16 23:12:30.030+00:00 | nioEventLoopGroup-3-6 | DEBUG | AbstractHandshakeHandler | Handshake error:\r\nio.netty.handler.codec.DecoderException: javax.net.ssl.SSLHandshakeException: Received fatal alert: bad_certificate\r\n at io.netty.handler.codec.ByteToMessageDecoder.callDecode(ByteToMessageDecoder.java:480)\r\n at io.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:279)\r\n at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:379)\r\n at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:365)\r\n at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:357)\r\n at io.netty.channel.DefaultChannelPipeline$HeadContext.channelRead(DefaultChannelPipeline.java:1410)\r\n at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:379)\r\n at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:365)\r\n at io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:919)\r\n at io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:166)\r\n at io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:722)\r\n at io.netty.channel.nio.NioEventLoop.processSelectedKeysOptimized(NioEventLoop.java:658)\r\n at io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:584)\r\n at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:496)\r\n at io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:986)\r\n at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)\r\n at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\r\n at java.base/java.lang.Thread.run(Thread.java:834)\r\nCaused by: javax.net.ssl.SSLHandshakeException: Received fatal alert: bad_certificate\r\n at java.base/sun.security.ssl.Alert.createSSLException(Alert.java:131)\r\n at java.base/sun.security.ssl.Alert.createSSLException(Alert.java:117)\r\n at java.base/sun.security.ssl.TransportContext.fatal(TransportContext.java:356)\r\n at java.base/sun.security.ssl.Alert$AlertConsumer.consume(Alert.java:293)\r\n at java.base/sun.security.ssl.TransportContext.dispatch(TransportContext.java:202)\r\n at java.base/sun.security.ssl.SSLTransport.decode(SSLTransport.java:172)\r\n at java.base/sun.security.ssl.SSLEngineImpl.decode(SSLEngineImpl.java:688)\r\n at java.base/sun.security.ssl.SSLEngineImpl.readRecord(SSLEngineImpl.java:643)\r\n at java.base/sun.security.ssl.SSLEngineImpl.unwrap(SSLEngineImpl.java:461)\r\n at java.base/sun.security.ssl.SSLEngineImpl.unwrap(SSLEngineImpl.java:440)\r\n at java.base/javax.net.ssl.SSLEngine.unwrap(SSLEngine.java:637)\r\n at io.netty.handler.ssl.SslHandler$SslEngineType$3.unwrap(SslHandler.java:295)\r\n at io.netty.handler.ssl.SslHandler.unwrap(SslHandler.java:1342)\r\n at io.netty.handler.ssl.SslHandler.decodeJdkCompatible(SslHandler.java:1235)\r\n at io.netty.handler.ssl.SslHandler.decode(SslHandler.java:1284)\r\n at io.netty.handler.codec.ByteToMessageDecoder.decodeRemovalReentryProtection(ByteToMessageDecoder.java:510)\r\n at io.netty.handler.codec.ByteToMessageDecoder.callDecode(ByteToMessageDecoder.java:449)\r\n ... 17 more\r\n2022-11-16 23:12:30.030+00:00 | nioEventLoopGroup-3-6 | DEBUG | RlpxAgent | Failed to connect to peer 0x832e45315e98a7641cf139be160734ffd1899714c2855e89b4a209dc216226d88e46ed7c48203b65289a15c75194cacef5b3715d35d488bd73c84faaea4b326f: io.netty.handler.codec.DecoderException: javax.net.ssl.SSLHandshakeException: Received fatal alert: bad_certificate\r\n2022-11-16 23:12:30.071+00:00 | nioEventLoopGroup-3-8 | DEBUG | SslHandler | [id: 0x7556f4f2, L:/10.88.153.89:60576 - R:/10.88.144.48:30303] HANDSHAKEN: protocol:TLSv1.3 cipher suite:TLS_AES_256_GCM_SHA384\r\n2022-11-16 23:12:30.071+00:00 | nioEventLoopGroup-3-8 | DEBUG | HandshakeHandlerOutbound | Wrote initial crypto handshake message to /10.88.144.48:30303.\r\n2022-11-16 23:12:30.071+00:00 | nioEventLoopGroup-3-8 | DEBUG | AbstractHandshakeHandler | Handshake error:\r\nio.netty.handler.codec.DecoderException: javax.net.ssl.SSLHandshakeException: Received fatal alert: bad_certificate\r\n at io.netty.handler.codec.ByteToMessageDecoder.callDecode(ByteToMessageDecoder.java:480)\r\n at io.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:279)\r\n at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:379)\r\n at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:365)\r\n at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:357)\r\n at io.netty.channel.DefaultChannelPipeline$HeadContext.channelRead(DefaultChannelPipeline.java:1410)\r\n at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:379)\r\n at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:365)\r\n at io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:919)\r\n at io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:166)\r\n at io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:722)\r\n at io.netty.channel.nio.NioEventLoop.processSelectedKeysOptimized(NioEventLoop.java:658)\r\n at io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:584)\r\n at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:496)\r\n at io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:986)\r\n at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)\r\n at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\r\n at java.base/java.lang.Thread.run(Thread.java:834)\r\nCaused by: javax.net.ssl.SSLHandshakeException: Received fatal alert: bad_certificate\r\n at java.base/sun.security.ssl.Alert.createSSLException(Alert.java:131)\r\n at java.base/sun.security.ssl.Alert.createSSLException(Alert.java:117)\r\n at java.base/sun.security.ssl.TransportContext.fatal(TransportContext.java:356)\r\n at java.base/sun.security.ssl.Alert$AlertConsumer.consume(Alert.java:293)\r\n at java.base/sun.security.ssl.TransportContext.dispatch(TransportContext.java:202)\r\n at java.base/sun.security.ssl.SSLTransport.decode(SSLTransport.java:172)\r\n at java.base/sun.security.ssl.SSLEngineImpl.decode(SSLEngineImpl.java:688)\r\n at java.base/sun.security.ssl.SSLEngineImpl.readRecord(SSLEngineImpl.java:643)\r\n at java.base/sun.security.ssl.SSLEngineImpl.unwrap(SSLEngineImpl.java:461)\r\n at java.base/sun.security.ssl.SSLEngineImpl.unwrap(SSLEngineImpl.java:440)\r\n at java.base/javax.net.ssl.SSLEngine.unwrap(SSLEngine.java:637)\r\n at io.netty.handler.ssl.SslHandler$SslEngineType$3.unwrap(SslHandler.java:295)\r\n at io.netty.handler.ssl.SslHandler.unwrap(SslHandler.java:1342)\r\n at io.netty.handler.ssl.SslHandler.decodeJdkCompatible(SslHandler.java:1235)\r\n at io.netty.handler.ssl.SslHandler.decode(SslHandler.java:1284)\r\n at io.netty.handler.codec.ByteToMessageDecoder.decodeRemovalReentryProtection(ByteToMessageDecoder.java:510)\r\n at io.netty.handler.codec.ByteToMessageDecoder.callDecode(ByteToMessageDecoder.java:449)\r\n ... 17 more\r\n2022-11-16 23:12:30.072+00:00 | nioEventLoopGroup-3-8 | DEBUG | RlpxAgent | Failed to connect to peer 0x064f2765641c0dc6c4e8e9a433ada36e01b001ae93be142aa94d7286e97217dcf90cc0b5e5471f6ade0a11285ee04627d97fbbb17a28d76eb66cbada937c0eb0: io.netty.handler.codec.DecoderException: javax.net.ssl.SSLHandshakeException: Received fatal alert: bad_certificate\r\n2022-11-16 23:12:30.077+00:00 | nioEventLoopGroup-3-7 | DEBUG | SslHandler | [id: 0x3eabd8a9, L:/10.88.153.89:43672 - R:/10.88.163.0:30303] HANDSHAKEN: protocol:TLSv1.3 cipher suite:TLS_AES_256_GCM_SHA384\r\n2022-11-16 23:12:30.077+00:00 | nioEventLoopGroup-3-7 | DEBUG | HandshakeHandlerOutbound | Wrote initial crypto handshake message to /10.88.163.0:30303.\r\n2022-11-16 23:12:30.078+00:00 | nioEventLoopGroup-3-7 | DEBUG | AbstractHandshakeHandler | Handshake error:\r\nio.netty.handler.codec.DecoderException: javax.net.ssl.SSLHandshakeException: Received fatal alert: bad_certificate\r\n at io.netty.handler.codec.ByteToMessageDecoder.callDecode(ByteToMessageDecoder.java:480)\r\n at io.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:279)\r\n at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:379)\r\n at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:365)\r\n at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:357)\r\n at io.netty.channel.DefaultChannelPipeline$HeadContext.channelRead(DefaultChannelPipeline.java:1410)\r\n at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:379)\r\n at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:365)\r\n at io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:919)\r\n at io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:166)\r\n at io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:722)\r\n at io.netty.channel.nio.NioEventLoop.processSelectedKeysOptimized(NioEventLoop.java:658)\r\n at io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:584)\r\n at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:496)\r\n at io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:986)\r\n at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)\r\n at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\r\n at java.base/java.lang.Thread.run(Thread.java:834)\r\nCaused by: javax.net.ssl.SSLHandshakeException: Received fatal alert: bad_certificate\r\n at java.base/sun.security.ssl.Alert.createSSLException(Alert.java:131)\r\n at java.base/sun.security.ssl.Alert.createSSLException(Alert.java:117)\r\n at java.base/sun.security.ssl.TransportContext.fatal(TransportContext.java:356)\r\n at java.base/sun.security.ssl.Alert$AlertConsumer.consume(Alert.java:293)\r\n at java.base/sun.security.ssl.TransportContext.dispatch(TransportContext.java:202)\r\n at java.base/sun.security.ssl.SSLTransport.decode(SSLTransport.java:172)\r\n at java.base/sun.security.ssl.SSLEngineImpl.decode(SSLEngineImpl.java:688)\r\n at java.base/sun.security.ssl.SSLEngineImpl.readRecord(SSLEngineImpl.java:643)\r\n at java.base/sun.security.ssl.SSLEngineImpl.unwrap(SSLEngineImpl.java:461)\r\n at java.base/sun.security.ssl.SSLEngineImpl.unwrap(SSLEngineImpl.java:440)\r\n at java.base/javax.net.ssl.SSLEngine.unwrap(SSLEngine.java:637)\r\n at io.netty.handler.ssl.SslHandler$SslEngineType$3.unwrap(SslHandler.java:295)\r\n at io.netty.handler.ssl.SslHandler.unwrap(SslHandler.java:1342)\r\n at io.netty.handler.ssl.SslHandler.decodeJdkCompatible(SslHandler.java:1235)\r\n at io.netty.handler.ssl.SslHandler.decode(SslHandler.java:1284)\r\n at io.netty.handler.codec.ByteToMessageDecoder.decodeRemovalReentryProtection(ByteToMessageDecoder.java:510)\r\n at io.netty.handler.codec.ByteToMessageDecoder.callDecode(ByteToMessageDecoder.java:449)\r\n ... 17 more\r\n2022-11-16 23:12:30.078+00:00 | nioEventLoopGroup-3-7 | DEBUG | RlpxAgent | Failed to connect to peer 0xef07c06ba62fde3d2bc4671310f9dc4ec68a51bd83a1635c414146c2428ed5aec57a36cba48f9249cf7a2929393979eb411a0c6ef0bed77914860f29a5f0bcdb: io.netty.handler.codec.DecoderException: javax.net.ssl.SSLHandshakeException: Received fatal alert: bad_certificate\r\n2022-11-16 23:12:30.674+00:00 | EthScheduler-Timer-0 | INFO  | FullSyncTargetManager | No sync target, waiting for peers. Current peers: 0\r\n2022-11-16 23:12:30.674+00:00 | EthScheduler-Timer-0 | DEBUG | WaitForPeerTask | Waiting for new peer connection. 0 peers currently connected.\r\n```\r\n\r\n**Frequency:** \r\nAlways happens\r\n\r\n### Versions (Add all that apply)\r\n* Software version: `besu-22.1.3`\r\n* Java version: JDK 11\r\n* OS Name & Version: AWS ECS Linux\r\n\r\n### Additional Information (Add any of the following or anything else that may be relevant)\r\nI am using an old version of Besu, but really need that version.\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/4695/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/hyperledger/besu/issues/4695/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[

]
