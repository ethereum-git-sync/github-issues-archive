{
  "url": "https://api.github.com/repos/hyperledger/besu/issues/4838",
  "repository_url": "https://api.github.com/repos/hyperledger/besu",
  "labels_url": "https://api.github.com/repos/hyperledger/besu/issues/4838/labels{/name}",
  "comments_url": "https://api.github.com/repos/hyperledger/besu/issues/4838/comments",
  "events_url": "https://api.github.com/repos/hyperledger/besu/issues/4838/events",
  "html_url": "https://github.com/hyperledger/besu/issues/4838",
  "id": 1502639350,
  "node_id": "I_kwDODE2jmc5ZkHT2",
  "number": 4838,
  "title": "CPU usage spikes on a synced node",
  "user": {
    "login": "ahamlat",
    "id": 5099602,
    "node_id": "MDQ6VXNlcjUwOTk2MDI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5099602?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ahamlat",
    "html_url": "https://github.com/ahamlat",
    "followers_url": "https://api.github.com/users/ahamlat/followers",
    "following_url": "https://api.github.com/users/ahamlat/following{/other_user}",
    "gists_url": "https://api.github.com/users/ahamlat/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ahamlat/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ahamlat/subscriptions",
    "organizations_url": "https://api.github.com/users/ahamlat/orgs",
    "repos_url": "https://api.github.com/users/ahamlat/repos",
    "events_url": "https://api.github.com/users/ahamlat/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ahamlat/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2022-12-19T09:57:06Z",
  "updated_at": "2023-01-11T21:49:05Z",
  "closed_at": "2023-01-11T21:49:05Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "<!-- Have you done the following? -->\r\n<!--   * read the Code of Conduct? By filing an Issue, you are expected to -->  \r\n<!--     comply with it, including treating everyone with respect: -->\r\n<!--     https://github.com/hyperledger/besu/blob/main/CODE_OF_CONDUCT.md -->\r\n<!--   * Reproduced the issue in the latest version of the software -->\r\n<!--   * Read the debugging docs: https://besu.hyperledger.org/en/stable/HowTo/Monitor/Logging/ -->\r\n<!--   * Duplicate Issue check:  https://github.com/search?q=+is%3Aissue+repo%3Ahyperledger/Besu -->\r\n<!-- Note:  Not all sections will apply to all issue types. -->\r\n\r\n### Description\r\nSome users reported random CPU spikes on a Besu synced nodes.\r\nBelow some of the graphs shared by users :\r\n<img width=\"514\" alt=\"image\" src=\"https://user-images.githubusercontent.com/5099602/208393906-e4a4eacf-16fc-46b8-b374-51014bb8baa6.png\">\r\n\r\n<img width=\"524\" alt=\"image\" src=\"https://user-images.githubusercontent.com/5099602/208394121-e5132f72-5a82-4f1f-aa6c-efc96ddb023e.png\">\r\n\r\nTwo different users shared graphs that show a link between these CPU peaks and the increase of number of pooled transactions.\r\nAnalysing a thread dump during this CPU peak usage, I noticed that one of the threads is running this part of the code, and holding a lock making 3 other threads waiting for this lock. This could mean that this thread was running for some time.\r\n\r\n```\r\njava.lang.Thread.State: RUNNABLE\r\nat java.util.stream.AbstractPipeline.evaluate(java.base@17.0.5/AbstractPipeline.java:234)\r\nat java.util.stream.IntPipeline.reduce(java.base@17.0.5/IntPipeline.java:515)\r\nat java.util.stream.IntPipeline.sum(java.base@17.0.5/IntPipeline.java:473)\r\nat org.hyperledger.besu.ethereum.eth.manager.EthPeer.outstandingRequests(EthPeer.java:524)\r\nat org.hyperledger.besu.ethereum.eth.manager.EthPeer.hasAvailableRequestCapacity(EthPeer.java:532)\r\n```\r\nThis part of the code calculates (sum) the number of outstanding requests and it takes into account those from pooled transactions.\r\n\r\n<img width=\"1275\" alt=\"image\" src=\"https://user-images.githubusercontent.com/5099602/208396916-3b2a7665-bd5c-4b70-8320-db90c0f7471b.png\">\r\n\r\n\r\n### Acceptance Criteria\r\n\r\n### Steps to Reproduce (Bug)\r\n* It is hard to reproduce, it could be part of the resolution of this issue.\r\n\r\n**Expected behavior:** [What you expect to happen]\r\n* Besu has a stable CPU consumption on synced node.\r\n\r\n**Actual behavior:** [What actually happens]\r\n* Besu has some random spikes in CPU usage\r\n\r\n**Frequency:** [What percentage of the time does it occur?]\r\nThis issue is not frequent but some users seem to reproduce more than others, may be related to the use case. \r\n\r\n### Versions (Add all that apply)\r\n* Software version: 22.10.3\r\n* Java version: OpenJDK 64-Bit Server VM (17.0.5+8-Ubuntu-2ubuntu122.04 mixed mode, sharing)\r\n* OS Name & Version: ubuntu 22.04\r\n\r\n",
  "closed_by": {
    "login": "ahamlat",
    "id": 5099602,
    "node_id": "MDQ6VXNlcjUwOTk2MDI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5099602?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ahamlat",
    "html_url": "https://github.com/ahamlat",
    "followers_url": "https://api.github.com/users/ahamlat/followers",
    "following_url": "https://api.github.com/users/ahamlat/following{/other_user}",
    "gists_url": "https://api.github.com/users/ahamlat/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ahamlat/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ahamlat/subscriptions",
    "organizations_url": "https://api.github.com/users/ahamlat/orgs",
    "repos_url": "https://api.github.com/users/ahamlat/repos",
    "events_url": "https://api.github.com/users/ahamlat/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ahamlat/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/4838/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/hyperledger/besu/issues/4838/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1357903883",
    "html_url": "https://github.com/hyperledger/besu/issues/4838#issuecomment-1357903883",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/4838",
    "id": 1357903883,
    "node_id": "IC_kwDODE2jmc5Q7_gL",
    "user": {
      "login": "arbora",
      "id": 94296680,
      "node_id": "U_kgDOBZ7aaA",
      "avatar_url": "https://avatars.githubusercontent.com/u/94296680?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/arbora",
      "html_url": "https://github.com/arbora",
      "followers_url": "https://api.github.com/users/arbora/followers",
      "following_url": "https://api.github.com/users/arbora/following{/other_user}",
      "gists_url": "https://api.github.com/users/arbora/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/arbora/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/arbora/subscriptions",
      "organizations_url": "https://api.github.com/users/arbora/orgs",
      "repos_url": "https://api.github.com/users/arbora/repos",
      "events_url": "https://api.github.com/users/arbora/events{/privacy}",
      "received_events_url": "https://api.github.com/users/arbora/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-19T16:13:56Z",
    "updated_at": "2022-12-19T16:13:56Z",
    "author_association": "NONE",
    "body": "Adding some screenshots of two of my past encounters with this bug, as well as the observation that I first saw it with 22.7.7 and am still seeing it with 22.10.2, and am on Ubuntu 20.04. A restart of Besu always resets the CPU back to normal.\r\n\r\n![Screenshot from 2022-12-09 15-10-21](https://user-images.githubusercontent.com/94296680/208470197-a6a8616a-10eb-4be2-a948-3428570f51b3.png)\r\n![Screenshot from 2022-12-15 16-59-46](https://user-images.githubusercontent.com/94296680/208470252-edab24d2-3d35-4e87-ab13-302410459f7e.png)\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1357903883/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1359589084",
    "html_url": "https://github.com/hyperledger/besu/issues/4838#issuecomment-1359589084",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/4838",
    "id": 1359589084,
    "node_id": "IC_kwDODE2jmc5RCa7c",
    "user": {
      "login": "ThomasDalla",
      "id": 609945,
      "node_id": "MDQ6VXNlcjYwOTk0NQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/609945?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ThomasDalla",
      "html_url": "https://github.com/ThomasDalla",
      "followers_url": "https://api.github.com/users/ThomasDalla/followers",
      "following_url": "https://api.github.com/users/ThomasDalla/following{/other_user}",
      "gists_url": "https://api.github.com/users/ThomasDalla/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ThomasDalla/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ThomasDalla/subscriptions",
      "organizations_url": "https://api.github.com/users/ThomasDalla/orgs",
      "repos_url": "https://api.github.com/users/ThomasDalla/repos",
      "events_url": "https://api.github.com/users/ThomasDalla/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ThomasDalla/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-20T15:44:11Z",
    "updated_at": "2022-12-20T16:13:31Z",
    "author_association": "NONE",
    "body": "Happened to me today.\r\n\r\nIncreased up to 4 cpu usage, then started to show Vertx blocked threads, and then suddenly resumed operations with low CPU usage (without restarting Besu).\r\n\r\nLogs: [besu_logs_2022-12-20_cpu.txt](https://github.com/hyperledger/besu/files/10269892/besu_logs_2022-12-20_cpu.txt)\r\n\r\n```\r\n####################################################################################################\r\n#                                                                                                  #\r\n# Besu 22.10.3                                                                                     #\r\n#                                                                                                  #\r\n# Configuration:                                                                                   #\r\n# Network: Mainnet                                                                                 #\r\n# Data storage: Bonsai                                                                             #\r\n# Sync mode: Snap                                                                                  #\r\n# RPC HTTP APIs: ETH,NET,CLIQUE,DEBUG,ADMIN,EEA,TXPOOL,WEB3                                        #\r\n# RPC HTTP port: 8545                                                                              #\r\n# Engine APIs: ENGINE,ETH                                                                          #\r\n# Engine port: 8551                                                                                #\r\n# High spec configuration enabled                                                                  #\r\n#                                                                                                  #\r\n# Host:                                                                                            #\r\n# Java: openjdk-java-17                                                                            #\r\n# Maximum heap size: 8.00 GB                                                                       #\r\n# OS: linux-x86_64                                                                                 #\r\n# glibc: 2.31                                                                                      #\r\n# Total memory: 31.10 GB                                                                           #\r\n# CPU cores: 20                                                                                    #\r\n#                                                                                                  #\r\n####################################################################################################\r\n```\r\n\r\n![image](https://user-images.githubusercontent.com/609945/208713070-763bde5d-4981-44fd-93a5-1bd57e9afea6.png)\r\n\r\n![image](https://user-images.githubusercontent.com/609945/208706375-497bbe3d-766e-4da6-9521-6cf74328ceaf.png)\r\n\r\n![image](https://user-images.githubusercontent.com/609945/208713355-b881bd0f-dd35-472d-93cf-eec10417213f.png)\r\n\r\n![image](https://user-images.githubusercontent.com/609945/208713454-b07cbb8f-29b6-459e-9173-28ae279513f0.png)\r\n\r\n![image](https://user-images.githubusercontent.com/609945/208713606-90cb8b59-4182-4e84-9f4d-08db43719c0b.png)\r\n\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1359589084/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1360079380",
    "html_url": "https://github.com/hyperledger/besu/issues/4838#issuecomment-1360079380",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/4838",
    "id": 1360079380,
    "node_id": "IC_kwDODE2jmc5RESoU",
    "user": {
      "login": "ahamlat",
      "id": 5099602,
      "node_id": "MDQ6VXNlcjUwOTk2MDI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5099602?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ahamlat",
      "html_url": "https://github.com/ahamlat",
      "followers_url": "https://api.github.com/users/ahamlat/followers",
      "following_url": "https://api.github.com/users/ahamlat/following{/other_user}",
      "gists_url": "https://api.github.com/users/ahamlat/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ahamlat/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ahamlat/subscriptions",
      "organizations_url": "https://api.github.com/users/ahamlat/orgs",
      "repos_url": "https://api.github.com/users/ahamlat/repos",
      "events_url": "https://api.github.com/users/ahamlat/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ahamlat/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-20T19:55:49Z",
    "updated_at": "2022-12-20T19:55:49Z",
    "author_association": "CONTRIBUTOR",
    "body": "Adding here some profiling metrics that confirm the first observation. We're analysing this to understand why it consumes a lot of CPU.\r\n\r\n<img width=\"1717\" alt=\"image\" src=\"https://user-images.githubusercontent.com/5099602/208754687-35f02389-d2dd-4554-a2db-bc878bac39bb.png\">\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1360079380/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
