{
  "url": "https://api.github.com/repos/hyperledger/besu/issues/3724",
  "repository_url": "https://api.github.com/repos/hyperledger/besu",
  "labels_url": "https://api.github.com/repos/hyperledger/besu/issues/3724/labels{/name}",
  "comments_url": "https://api.github.com/repos/hyperledger/besu/issues/3724/comments",
  "events_url": "https://api.github.com/repos/hyperledger/besu/issues/3724/events",
  "html_url": "https://github.com/hyperledger/besu/issues/3724",
  "id": 1202534858,
  "node_id": "I_kwDODE2jmc5HrTnK",
  "number": 3724,
  "title": "Re-pivoting a fast sync across TTD fails",
  "user": {
    "login": "jflo",
    "id": 345937,
    "node_id": "MDQ6VXNlcjM0NTkzNw==",
    "avatar_url": "https://avatars.githubusercontent.com/u/345937?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jflo",
    "html_url": "https://github.com/jflo",
    "followers_url": "https://api.github.com/users/jflo/followers",
    "following_url": "https://api.github.com/users/jflo/following{/other_user}",
    "gists_url": "https://api.github.com/users/jflo/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jflo/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jflo/subscriptions",
    "organizations_url": "https://api.github.com/users/jflo/orgs",
    "repos_url": "https://api.github.com/users/jflo/repos",
    "events_url": "https://api.github.com/users/jflo/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jflo/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3013559202,
      "node_id": "MDU6TGFiZWwzMDEzNTU5MjAy",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/mainnet",
      "name": "mainnet",
      "color": "9D578C",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2022-04-12T23:28:56Z",
  "updated_at": "2022-04-25T11:00:38Z",
  "closed_at": "2022-04-25T11:00:38Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "### Description\r\n- This issue was discovered on the lighthouse/besu pair testing mainnet-shadowfork-1\r\n    - Started a fastsync before ttd first pivot was at 14563240 (pre-merge)\r\n    - During the fast sync, Besu re-pivoted to a new block three times (14563804, 14565117, 14567386) each being past TTD.  It incorrectly failed to apply postmerge rules to 14564208, the first block after TTD.\r\n    - World state however was unaffected, and the world state is now ahead of the blockchain import. Any backwards syncs trigger from engine_forkChoiceUpdated would proceed back to the TTD, and then immediately re-try to import 14564208. Now the correct import rules would be applied, the block would be structurally valid, however we don't have the worldstate the block requires, and so the block cannot be executed.\r\n\r\nImport rules being applied during fast sync need to be merge aware just like everywhere else. Should probably revisit full sync and snap-sync code as well to make sure the validation logic is re-used across all of them.",
  "closed_by": {
    "login": "fab-10",
    "id": 91944855,
    "node_id": "U_kgDOBXr3lw",
    "avatar_url": "https://avatars.githubusercontent.com/u/91944855?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/fab-10",
    "html_url": "https://github.com/fab-10",
    "followers_url": "https://api.github.com/users/fab-10/followers",
    "following_url": "https://api.github.com/users/fab-10/following{/other_user}",
    "gists_url": "https://api.github.com/users/fab-10/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/fab-10/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/fab-10/subscriptions",
    "organizations_url": "https://api.github.com/users/fab-10/orgs",
    "repos_url": "https://api.github.com/users/fab-10/repos",
    "events_url": "https://api.github.com/users/fab-10/events{/privacy}",
    "received_events_url": "https://api.github.com/users/fab-10/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/3724/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/hyperledger/besu/issues/3724/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1097664641",
    "html_url": "https://github.com/hyperledger/besu/issues/3724#issuecomment-1097664641",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/3724",
    "id": 1097664641,
    "node_id": "IC_kwDODE2jmc5BbQiB",
    "user": {
      "login": "mkalinin",
      "id": 1892772,
      "node_id": "MDQ6VXNlcjE4OTI3NzI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1892772?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mkalinin",
      "html_url": "https://github.com/mkalinin",
      "followers_url": "https://api.github.com/users/mkalinin/followers",
      "following_url": "https://api.github.com/users/mkalinin/following{/other_user}",
      "gists_url": "https://api.github.com/users/mkalinin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mkalinin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mkalinin/subscriptions",
      "organizations_url": "https://api.github.com/users/mkalinin/orgs",
      "repos_url": "https://api.github.com/users/mkalinin/repos",
      "events_url": "https://api.github.com/users/mkalinin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mkalinin/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-04-13T07:42:49Z",
    "updated_at": "2022-04-13T07:42:49Z",
    "author_association": "NONE",
    "body": "Why a pre-pivot block (the most recent pivot is far beyond the 14564208 block) would need to be executed during fast sync?",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1097664641/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1098042176",
    "html_url": "https://github.com/hyperledger/besu/issues/3724#issuecomment-1098042176",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/3724",
    "id": 1098042176,
    "node_id": "IC_kwDODE2jmc5BcstA",
    "user": {
      "login": "jflo",
      "id": 345937,
      "node_id": "MDQ6VXNlcjM0NTkzNw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/345937?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jflo",
      "html_url": "https://github.com/jflo",
      "followers_url": "https://api.github.com/users/jflo/followers",
      "following_url": "https://api.github.com/users/jflo/following{/other_user}",
      "gists_url": "https://api.github.com/users/jflo/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jflo/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jflo/subscriptions",
      "organizations_url": "https://api.github.com/users/jflo/orgs",
      "repos_url": "https://api.github.com/users/jflo/repos",
      "events_url": "https://api.github.com/users/jflo/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jflo/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-04-13T13:20:30Z",
    "updated_at": "2022-04-13T13:20:30Z",
    "author_association": "CONTRIBUTOR",
    "body": "It wouldn't, the problem is 14564208 (ttd+1) was a post-pivot block at first, prior to the later re-pivots. ",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1098042176/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
