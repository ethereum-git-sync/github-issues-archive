{
  "url": "https://api.github.com/repos/hyperledger/besu/issues/5468",
  "repository_url": "https://api.github.com/repos/hyperledger/besu",
  "labels_url": "https://api.github.com/repos/hyperledger/besu/issues/5468/labels{/name}",
  "comments_url": "https://api.github.com/repos/hyperledger/besu/issues/5468/comments",
  "events_url": "https://api.github.com/repos/hyperledger/besu/issues/5468/events",
  "html_url": "https://github.com/hyperledger/besu/issues/5468",
  "id": 1713532825,
  "node_id": "I_kwDODE2jmc5mIm-Z",
  "number": 5468,
  "title": "Can't deploy Smart contracts compiled by 0.8.20+ solidity (Shanghai Support PUSH0)",
  "user": {
    "login": "NickSneo",
    "id": 32759145,
    "node_id": "MDQ6VXNlcjMyNzU5MTQ1",
    "avatar_url": "https://avatars.githubusercontent.com/u/32759145?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/NickSneo",
    "html_url": "https://github.com/NickSneo",
    "followers_url": "https://api.github.com/users/NickSneo/followers",
    "following_url": "https://api.github.com/users/NickSneo/following{/other_user}",
    "gists_url": "https://api.github.com/users/NickSneo/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/NickSneo/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/NickSneo/subscriptions",
    "organizations_url": "https://api.github.com/users/NickSneo/orgs",
    "repos_url": "https://api.github.com/users/NickSneo/repos",
    "events_url": "https://api.github.com/users/NickSneo/events{/privacy}",
    "received_events_url": "https://api.github.com/users/NickSneo/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 5290172097,
      "node_id": "LA_kwDODE2jmc8AAAABO1GewQ",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/non%20mainnet%20(private%20networks)",
      "name": "non mainnet (private networks)",
      "color": "0052cc",
      "default": false,
      "description": "not related to mainnet features - covers privacy, permissioning, IBFT2, QBFT"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2023-05-17T09:49:39Z",
  "updated_at": "2023-09-11T02:53:14Z",
  "closed_at": null,
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "### Description\r\nSmart contracts compiled with solidity 0.8.20+ with new OPCODE PUSH0 are failing to deploy on Besu 23.4.0 with error - `Error: Transaction has been reverted by the EVM` with default dev-genesis file\r\n\r\nWhen I am using a modified dev-config genesis.json file to include \"shanghaiTime\" in my genesis file - \r\n```\r\n{\r\n  \"config\": {\r\n    \"chainId\": 1337,\r\n    \"londonBlock\": 0,\r\n    \"shanghaiTime\": 10,\r\n    \"contractSizeLimit\": 2147483647,\r\n    \"ethash\": {\r\n      \"fixeddifficulty\": 100\r\n    }\r\n  },\r\n  \"nonce\": \"0x42\",\r\n  \"baseFeePerGas\":\"0x0\",\r\n  \"timestamp\": \"0x0\",\r\n  \"extraData\": \"0x11bbe8db4e347b4e8c937c1c8370e4b5ed33adb3db69cbdb7a38e1e50b1b82fa\",\r\n  \"gasLimit\": \"0x1fffffffffffff\",\r\n  \"difficulty\": \"0x10000\",\r\n  \"mixHash\": \"0x0000000000000000000000000000000000000000000000000000000000000000\",\r\n  \"coinbase\": \"0x0000000000000000000000000000000000000000\",\r\n  \"alloc\": {\r\n    \"fe3b557e8fb62b89f4916b721be55ceb828dbd73\": {\r\n      \"privateKey\": \"8f2a55949038a9610f50fb23b5883af3b4ecb3c3bb792cbcefbd1542c692be63\",\r\n      \"comment\": \"private key and this comment are ignored.  In a real chain, the private key should NOT be stored\",\r\n      \"balance\": \"0xad78ebc5ac6200000\"\r\n    },\r\n    \"627306090abaB3A6e1400e9345bC60c78a8BEf57\": {\r\n      \"privateKey\": \"c87509a1c067bbde78beb793e6fa76530b6382a4c0241e5e4a9ec0a0f44dc0d3\",\r\n      \"comment\": \"private key and this comment are ignored.  In a real chain, the private key should NOT be stored\",\r\n      \"balance\": \"90000000000000000000000\"\r\n    },\r\n    \"f17f52151EbEF6C7334FAD080c5704D77216b732\": {\r\n      \"privateKey\": \"ae6ae8e5ccbfb04590405997ee2d52d2b330726137b875053c36d94e974d162f\",\r\n      \"comment\": \"private key and this comment are ignored.  In a real chain, the private key should NOT be stored\",\r\n      \"balance\": \"90000000000000000000000\"\r\n    }\r\n  }\r\n```\r\nBut this genesis.json gives me error - \r\n`2023-05-17 15:16:21.853+05:30 | pool-7-thread-1 | INFO  | MainnetBlockValidator | Invalid block 1 (0x029d319a0224571bc0c14dc13b5d735b2c2797772d6abf2cb01a7424d7d91e82): Optional[header validation rule violated, see logs]\r\n2023-05-17 15:16:21.854+05:30 | pool-7-thread-1 | ERROR | BlockMiner | Illegal block mined, could not be imported to local chain.`\r\n\r\nNow if I add `\"terminalTotalDifficulty\":0` in my genesis.json,\r\nBlocks won't start to get mined, seems besu gets stuck\r\n\r\nSmart Contract - \r\n```\r\n// SPDX-License-Identifier: MIT\r\npragma solidity 0.8.20;\r\n\r\ncontract PushZeroContract {\r\n    function pushZero() external pure returns (uint) {\r\n        uint zero = 0;\r\n        return zero;\r\n    }\r\n}\r\n```\r\nABI = \r\n```\r\n[\r\n\t{\r\n\t\t\"inputs\": [],\r\n\t\t\"name\": \"pushZero\",\r\n\t\t\"outputs\": [\r\n\t\t\t{\r\n\t\t\t\t\"internalType\": \"uint256\",\r\n\t\t\t\t\"name\": \"\",\r\n\t\t\t\t\"type\": \"uint256\"\r\n\t\t\t}\r\n\t\t],\r\n\t\t\"stateMutability\": \"pure\",\r\n\t\t\"type\": \"function\"\r\n\t}\r\n]\r\n```\r\n\r\nBytecode = \"608060405234801561000f575f80fd5b5060b38061001c5f395ff3fe6080604052348015600e575f80fd5b50600436106026575f3560e01c8063e83b401e14602a575b5f80fd5b60306044565b604051603b91906066565b60405180910390f35b5f805f90508091505090565b5f819050919050565b6060816050565b82525050565b5f60208201905060775f8301846059565b9291505056fea2646970667358221220ca7b5654de4c4b61649abbf792e0dd121895f41f478845e0debf01b29be16e8764736f6c63430008140033\"\r\n\r\nOpcodes = \"PUSH1 0x80 PUSH1 0x40 MSTORE CALLVALUE DUP1 ISZERO PUSH1 0xE JUMPI PUSH0 DUP1 REVERT JUMPDEST POP PUSH1 0x4 CALLDATASIZE LT PUSH1 0x26 JUMPI PUSH0 CALLDATALOAD PUSH1 0xE0 SHR DUP1 PUSH4 0xE83B401E EQ PUSH1 0x2A JUMPI JUMPDEST PUSH0 DUP1 REVERT JUMPDEST PUSH1 0x30 PUSH1 0x44 JUMP JUMPDEST PUSH1 0x40 MLOAD PUSH1 0x3B SWAP2 SWAP1 PUSH1 0x66 JUMP JUMPDEST PUSH1 0x40 MLOAD DUP1 SWAP2 SUB SWAP1 RETURN JUMPDEST PUSH0 DUP1 PUSH0 SWAP1 POP DUP1 SWAP2 POP POP SWAP1 JUMP JUMPDEST PUSH0 DUP2 SWAP1 POP SWAP2 SWAP1 POP JUMP JUMPDEST PUSH1 0x60 DUP2 PUSH1 0x50 JUMP JUMPDEST DUP3 MSTORE POP POP JUMP JUMPDEST PUSH0 PUSH1 0x20 DUP3 ADD SWAP1 POP PUSH1 0x77 PUSH0 DUP4 ADD DUP5 PUSH1 0x59 JUMP JUMPDEST SWAP3 SWAP2 POP POP JUMP INVALID LOG2 PUSH5 0x6970667358 0x22 SLT KECCAK256 0xCA PUSH28 0x5654DE4C4B61649ABBF792E0DD121895F41F478845E0DEBF01B29BE1 PUSH15 0x8764736F6C63430008140033000000 \"\r\n\r\n### Acceptance Criteria\r\n* Should be able to deploy smart contracts compiled with solidity 0.8.20 with PUSH0 OPCODES\r\n\r\n### Steps to Reproduce (Bug)\r\n1. Start besu 23.4.0\r\n2. Compile the given smart contract with solidity 0.8.20\r\n3. Deploy the smart contract using any library or remix\r\n\r\n**Expected behavior:** \r\nShould be able to deploy smart contracts compiled with solidity 0.8.20 with PUSH0 OPCODES\r\n\r\n**Actual behavior:** \r\nTransaction fails with `Error: Transaction has been reverted by the EVM`\r\n\r\n**Frequency:** \r\nalways\r\n\r\n### Logs (if a bug)\r\n\r\n\r\n### Versions (Add all that apply)\r\n* Software version: besu/v23.4.0/osx-aarch_64/oracle_openjdk-java-19\r\n* Java version: openjdk 19.0.2 2023-01-17\r\n* OS Name & Version: MacOS 13.0 (22A380)\r\n* Kernel Version: Darwin Nischals-MacBook-Pro.local 22.1.0 Darwin Kernel Version 22.1.0: Sun Oct  9 20:15:52 PDT 2022; root:xnu-8792.41.9~2/RELEASE_ARM64_T8112 arm64\r\n* Virtual Machine software & version: [`vmware -v`]\r\n* Docker Version: [`docker version`]\r\n* Cloud VM, type, size: [Amazon Web Services I3-large]\r\n* Consensus Client & Version if using Proof of Stake: [e.g. Teku, Lighthouse, Prysm, Nimbus, Lodestar]\r\n\r\n### Smart contract information (If you're reporting an issue arising from deploying or calling a smart contract, please supply related information)\r\n* Solidity version 0.8.20\r\n* Repo with minimal set of deployable/reproducible contract code - please provide a link\r\n* Please include specifics on how you are deploying/calling the contract \r\n* Have you reproduced the issue on other eth clients\r\n\r\n### Additional Information (Add any of the following or anything else that may be relevant)\r\n* Besu setup info - genesis file, config options\r\n* System info - memory, CPU\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/5468/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/hyperledger/besu/issues/5468/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1551632549",
    "html_url": "https://github.com/hyperledger/besu/issues/5468#issuecomment-1551632549",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/5468",
    "id": 1551632549,
    "node_id": "IC_kwDODE2jmc5cfAil",
    "user": {
      "login": "non-fungible-nelson",
      "id": 85905982,
      "node_id": "MDQ6VXNlcjg1OTA1OTgy",
      "avatar_url": "https://avatars.githubusercontent.com/u/85905982?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/non-fungible-nelson",
      "html_url": "https://github.com/non-fungible-nelson",
      "followers_url": "https://api.github.com/users/non-fungible-nelson/followers",
      "following_url": "https://api.github.com/users/non-fungible-nelson/following{/other_user}",
      "gists_url": "https://api.github.com/users/non-fungible-nelson/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/non-fungible-nelson/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/non-fungible-nelson/subscriptions",
      "organizations_url": "https://api.github.com/users/non-fungible-nelson/orgs",
      "repos_url": "https://api.github.com/users/non-fungible-nelson/repos",
      "events_url": "https://api.github.com/users/non-fungible-nelson/events{/privacy}",
      "received_events_url": "https://api.github.com/users/non-fungible-nelson/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-17T15:41:26Z",
    "updated_at": "2023-05-17T15:41:26Z",
    "author_association": "CONTRIBUTOR",
    "body": "@siladu - not sure where this bug lies, could be in the timestamp piece? if not maybe @shemnon has input. ",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1551632549/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1552341540",
    "html_url": "https://github.com/hyperledger/besu/issues/5468#issuecomment-1552341540",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/5468",
    "id": 1552341540,
    "node_id": "IC_kwDODE2jmc5chtok",
    "user": {
      "login": "jframe",
      "id": 909467,
      "node_id": "MDQ6VXNlcjkwOTQ2Nw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/909467?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jframe",
      "html_url": "https://github.com/jframe",
      "followers_url": "https://api.github.com/users/jframe/followers",
      "following_url": "https://api.github.com/users/jframe/following{/other_user}",
      "gists_url": "https://api.github.com/users/jframe/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jframe/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jframe/subscriptions",
      "organizations_url": "https://api.github.com/users/jframe/orgs",
      "repos_url": "https://api.github.com/users/jframe/repos",
      "events_url": "https://api.github.com/users/jframe/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jframe/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-18T03:06:10Z",
    "updated_at": "2023-05-18T03:06:32Z",
    "author_association": "CONTRIBUTOR",
    "body": "Have been able to reproduce this locally as well. This is a different bug from #5446.\r\n\r\nThe cause of this is that we are building a POW block with nonce and validating against Shanghai header validation rules which don't allow for the nonce as Shanghai is expected to be POS. So not related to the fork timestamps that part is working.\r\n\r\nWe will need to make changes to Besu to support this.",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1552341540/reactions",
      "total_count": 2,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 1
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1713081181",
    "html_url": "https://github.com/hyperledger/besu/issues/5468#issuecomment-1713081181",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/5468",
    "id": 1713081181,
    "node_id": "IC_kwDODE2jmc5mG4td",
    "user": {
      "login": "suraneti",
      "id": 26770227,
      "node_id": "MDQ6VXNlcjI2NzcwMjI3",
      "avatar_url": "https://avatars.githubusercontent.com/u/26770227?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/suraneti",
      "html_url": "https://github.com/suraneti",
      "followers_url": "https://api.github.com/users/suraneti/followers",
      "following_url": "https://api.github.com/users/suraneti/following{/other_user}",
      "gists_url": "https://api.github.com/users/suraneti/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/suraneti/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/suraneti/subscriptions",
      "organizations_url": "https://api.github.com/users/suraneti/orgs",
      "repos_url": "https://api.github.com/users/suraneti/repos",
      "events_url": "https://api.github.com/users/suraneti/events{/privacy}",
      "received_events_url": "https://api.github.com/users/suraneti/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-09-11T02:53:14Z",
    "updated_at": "2023-09-11T02:53:14Z",
    "author_association": "NONE",
    "body": "I faced this issue on Besu `22.10.3` with Solidity `0.8.20+`, and resolved it by reverting to version `0.8.19`.",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1713081181/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
