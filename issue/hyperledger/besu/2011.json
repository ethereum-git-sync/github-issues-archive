{
  "url": "https://api.github.com/repos/hyperledger/besu/issues/2011",
  "repository_url": "https://api.github.com/repos/hyperledger/besu",
  "labels_url": "https://api.github.com/repos/hyperledger/besu/issues/2011/labels{/name}",
  "comments_url": "https://api.github.com/repos/hyperledger/besu/issues/2011/comments",
  "events_url": "https://api.github.com/repos/hyperledger/besu/issues/2011/events",
  "html_url": "https://github.com/hyperledger/besu/issues/2011",
  "id": 830302838,
  "node_id": "MDU6SXNzdWU4MzAzMDI4Mzg=",
  "number": 2011,
  "title": "IBFT2.0 peer connecting issue when multiple Ethereum clients try connect to bootnodes",
  "user": {
    "login": "helderjnpinto",
    "id": 12281088,
    "node_id": "MDQ6VXNlcjEyMjgxMDg4",
    "avatar_url": "https://avatars.githubusercontent.com/u/12281088?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/helderjnpinto",
    "html_url": "https://github.com/helderjnpinto",
    "followers_url": "https://api.github.com/users/helderjnpinto/followers",
    "following_url": "https://api.github.com/users/helderjnpinto/following{/other_user}",
    "gists_url": "https://api.github.com/users/helderjnpinto/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/helderjnpinto/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/helderjnpinto/subscriptions",
    "organizations_url": "https://api.github.com/users/helderjnpinto/orgs",
    "repos_url": "https://api.github.com/users/helderjnpinto/repos",
    "events_url": "https://api.github.com/users/helderjnpinto/events{/privacy}",
    "received_events_url": "https://api.github.com/users/helderjnpinto/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1537362490,
      "node_id": "MDU6TGFiZWwxNTM3MzYyNDkw",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/bug",
      "name": "bug",
      "color": "d73a4a",
      "default": true,
      "description": "Something isn't working"
    },
    {
      "id": 2051683573,
      "node_id": "MDU6TGFiZWwyMDUxNjgzNTcz",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/P3",
      "name": "P3",
      "color": "ffff00",
      "default": false,
      "description": "Medium (ex: JSON-RPC request not working with a specific client library due to loose spec assumtion)"
    },
    {
      "id": 3805591260,
      "node_id": "LA_kwDODE2jmc7i1Lbc",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/peering",
      "name": "peering",
      "color": "006b75",
      "default": false,
      "description": ""
    },
    {
      "id": 4164098293,
      "node_id": "LA_kwDODE2jmc74Mxj1",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/icebox",
      "name": "icebox",
      "color": "1D76DB",
      "default": false,
      "description": "items that need more consideration, time, or can wait"
    },
    {
      "id": 4328706977,
      "node_id": "LA_kwDODE2jmc8AAAABAgLToQ",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/TeamChupa",
      "name": "TeamChupa",
      "color": "fbca04",
      "default": false,
      "description": "GH issues worked on by Chupacabara Team"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2021-03-12T17:07:40Z",
  "updated_at": "2022-07-14T21:41:14Z",
  "closed_at": null,
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "### Description\r\n\r\nI have a network with IBFT 2.0 with the following network setting: \r\n- 5 validators in private network\r\n- 2 public nodes as relayers to private network with load balancer in front for public rpc and p2p connections and this nodes actuate as bootnodes.\r\n- Exists other nodes but for only dedicaded stuff like explorer, monitor, etc... \r\n\r\nFlags used in validators / public nodes are --genesis-file, --required-block, --bootnodes\r\n\r\n\r\nThe problem that i facing is other clients p2p with same protocol of p2p like ethereum like Geth, OpenEthereum, Parity, etc...\r\nare trying connect via my public nodes causing problems of peer discovery.\r\n \r\n(print of jsonrpc `admin_peers` response)\r\n![image](https://user-images.githubusercontent.com/12281088/110960842-15683680-8347-11eb-8362-8fbbc22ae826.png)\r\n\r\n### Steps to Reproduce (Bug)\r\n1. Start IBFT network with my setup private validators + public nodes\r\n2. Giving one public node to ETHEREUM node network\r\n3. Try shutdown one validator for upgrade process and start again\r\n\r\nThis is causing an issue because when i try to upgrade validators client to upper version.\r\nFollowing the process of upgrading a validator or any node when i disconnect one validator and change the image, start again all nodes stopped to mine blocks saying \"waiting for peers\" (network with 5 validators). \r\n\r\nAll start working when i forced adding peers via ADMIN `admin_addPeer`.\r\nI picked up one of the enodes and added to all peers after this all nodes discovery each other and start mining again.\r\n\r\nSo this solution not resolved in one day after trying updating to other version, when i see the logs are several Ethereum nodes try connecting.\r\nResolving this issue closing all p2p port in the firewall for external ips from my network, i restarted all nodes and the network worked well, after i restart the network i open p2p to external ips again because other clients IBFT can be connect for sync purposes and relay transactions, etc.\r\n\r\nI think when several non IBFT peers are connecting to bootnodes maybe stop p2p discovering and when validators try connect again not work.\r\n\r\n### Acceptance Criteria\r\n\r\nAs an client of IBFT 2.0 network, I want p2p discovery filter only for nodes with my category if any peer of ethereum like Geth, OpenEthereum, Parity, GoChain, etc... \r\n\r\nPeers of IBFT 2.0 with --genesis-file, --required-block need to validate before pass to other peers this neighbors:\r\n- Required block\r\n- Genesis-file (Includes chain ID and forks state ...)\r\n- Peer caps like [eth/62, eth/63, IBF/1]\r\n\r\nLike this example of GoChain in one of my validators in private network without public ips, the bootnodes should not pass this peers. \r\n\r\n![image](https://user-images.githubusercontent.com/12281088/110961695-fa49f680-8347-11eb-8edf-334277da73e6.png)\r\n\r\n\r\n**Expected behavior:** \r\nPeers in private network not receive p2p messagens from not filtered criteria\r\nAll nodes sync with bootnode with no problem\r\n\r\n\r\n**Frequency:**\r\n\r\nlately like 99%, a year ago nothing was happening\r\nI have version of 1.4.0 and at least one of validators is 20.10.0 i was trying to update all my nodes when i noticed this problem\r\n\r\n### Versions (Add all that apply)\r\n\r\n* Software version: [`besu --version `] \r\n1.4.0 and one of validators in development network is 20.10.0\r\n* Java version: [`java -version `] \r\noracle openjdk 13 \r\n* OS Name & Version: [`cat /etc/*release`] \r\nAmazon Linux AMI release 2018.03\r\n* Docker Version: [`docker version`]\r\n19.03.13-ce\r\n* Cloud VM, type, size: [Amazon Web Services I3-large]\r\nt3.small for dev network\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/2011/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/hyperledger/besu/issues/2011/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/800741644",
    "html_url": "https://github.com/hyperledger/besu/issues/2011#issuecomment-800741644",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/2011",
    "id": 800741644,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwMDc0MTY0NA==",
    "user": {
      "login": "arash009",
      "id": 33149995,
      "node_id": "MDQ6VXNlcjMzMTQ5OTk1",
      "avatar_url": "https://avatars.githubusercontent.com/u/33149995?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/arash009",
      "html_url": "https://github.com/arash009",
      "followers_url": "https://api.github.com/users/arash009/followers",
      "following_url": "https://api.github.com/users/arash009/following{/other_user}",
      "gists_url": "https://api.github.com/users/arash009/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/arash009/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/arash009/subscriptions",
      "organizations_url": "https://api.github.com/users/arash009/orgs",
      "repos_url": "https://api.github.com/users/arash009/repos",
      "events_url": "https://api.github.com/users/arash009/events{/privacy}",
      "received_events_url": "https://api.github.com/users/arash009/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-17T02:20:22Z",
    "updated_at": "2021-03-17T02:20:22Z",
    "author_association": "CONTRIBUTOR",
    "body": "Hi,\r\nFrom what I can understand of the description of the issue, that you are running a private network of 5 validators using IBFT2.0 and then you have 2 bootnodes that are connected to this network, but also expose RPCs to the public. These 2 bootnodes must also be running IBFT2.0 to be part of the private network, but you are receiving peer requests from other external nodes that try and peer with these 2 public-facing nodes. Is that correct?\r\n\r\nAs far as I understand, discovery is working as intended, so to limit the \"noise\" of additional peers that cant connect to you anyway, you're better off using static peers. Are you intending for external nodes to connect to this network?\r\n\r\nAre you also using the Node Permissioning functionality to limit which peers your nodes communicate with?\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/800741644/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/801809637",
    "html_url": "https://github.com/hyperledger/besu/issues/2011#issuecomment-801809637",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/2011",
    "id": 801809637,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwMTgwOTYzNw==",
    "user": {
      "login": "helderjnpinto",
      "id": 12281088,
      "node_id": "MDQ6VXNlcjEyMjgxMDg4",
      "avatar_url": "https://avatars.githubusercontent.com/u/12281088?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/helderjnpinto",
      "html_url": "https://github.com/helderjnpinto",
      "followers_url": "https://api.github.com/users/helderjnpinto/followers",
      "following_url": "https://api.github.com/users/helderjnpinto/following{/other_user}",
      "gists_url": "https://api.github.com/users/helderjnpinto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/helderjnpinto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/helderjnpinto/subscriptions",
      "organizations_url": "https://api.github.com/users/helderjnpinto/orgs",
      "repos_url": "https://api.github.com/users/helderjnpinto/repos",
      "events_url": "https://api.github.com/users/helderjnpinto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/helderjnpinto/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-18T10:31:11Z",
    "updated_at": "2021-03-18T10:32:02Z",
    "author_association": "CONTRIBUTOR",
    "body": "@arash009 \r\n\r\n> From what I can understand of the description of the issue, that you are running a private network of 5 validators using IBFT2.0 and then you have 2 bootnodes that are connected to this network, but also expose RPCs to the public. These 2 bootnodes must also be running IBFT2.0 to be part of the private network, but you are receiving peer requests from other external nodes that try and peer with these 2 public-facing nodes. Is that correct?\r\n- Yes, clients from Ethereum network\r\n\r\n> Are you also using the Node Permissioning functionality to limit which peers your nodes communicate with?\r\n- I do not have permissioning, i do not want a limited peer network or adding manually each peer external or internal to organization.\r\n\r\n>As far as I understand, discovery is working as intended, so to limit the \"noise\" of additional peers that cant connect to you anyway, you're better off using static peers. Are you intending for external nodes to connect to this network?\r\n- Yes i want to external nodes of same client connect to my public bootnodes, so if i use static_nodes.json config for peers and disabling network peer discovery all external peers that i do not control of my network (IBFT same clients) only connect to my bootnodes for syncing right ? \r\nFor example: \r\nIf i have 100 external peers connect to one bootnode this connection is 100:1 will causing one bottleneck because peer discovery is disable and external nodes will not connect each other.  \r\n\r\n\r\n\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/801809637/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
