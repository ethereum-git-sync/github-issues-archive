{
  "url": "https://api.github.com/repos/hyperledger/besu/issues/2953",
  "repository_url": "https://api.github.com/repos/hyperledger/besu",
  "labels_url": "https://api.github.com/repos/hyperledger/besu/issues/2953/labels{/name}",
  "comments_url": "https://api.github.com/repos/hyperledger/besu/issues/2953/comments",
  "events_url": "https://api.github.com/repos/hyperledger/besu/issues/2953/events",
  "html_url": "https://github.com/hyperledger/besu/issues/2953",
  "id": 1036589579,
  "node_id": "I_kwDODE2jmc49yRoL",
  "number": 2953,
  "title": "[Bonsai] OutOfMemory on ETC full sync",
  "user": {
    "login": "diega",
    "id": 79943,
    "node_id": "MDQ6VXNlcjc5OTQz",
    "avatar_url": "https://avatars.githubusercontent.com/u/79943?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/diega",
    "html_url": "https://github.com/diega",
    "followers_url": "https://api.github.com/users/diega/followers",
    "following_url": "https://api.github.com/users/diega/following{/other_user}",
    "gists_url": "https://api.github.com/users/diega/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/diega/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/diega/subscriptions",
    "organizations_url": "https://api.github.com/users/diega/orgs",
    "repos_url": "https://api.github.com/users/diega/repos",
    "events_url": "https://api.github.com/users/diega/events{/privacy}",
    "received_events_url": "https://api.github.com/users/diega/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2021-10-26T18:00:07Z",
  "updated_at": "2021-11-02T15:24:49Z",
  "closed_at": "2021-11-02T15:24:49Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "### Description\r\nAs an ETC client, I want to full sync my node so that can interact with the network. \r\n\r\n### Acceptance Criteria\r\n* passes ETC block 13771821 \r\n\r\n### Steps to Reproduce (Bug)\r\n1. `$ ~/besu-21.10.0-RC3/bin/besu --network=classic --data-path=/home/admin/classic-besu-data-bonsai --p2p-host=<YOUR_IP> --Xdata-storage-format=BONSAI --sync-mode=FULL`\r\n2. wait to sync (~2 weeks)\r\n\r\n**Expected behavior:** synchronization completes\r\n\r\n**Actual behavior:** loops indefinitely with \r\n```\r\n2021-10-26 16:23:00.389+00:00 | EthScheduler-Services-5 (importBlock) | DEBUG | BonsaiWorldStateArchive | Paired Rollback 0xb68fe78bef86e6ef979742c440c05af83f0510181576e4cec31a9b3c8723d4fc\r\n2021-10-26 16:23:00.389+00:00 | EthScheduler-Services-5 (importBlock) | DEBUG | BonsaiWorldStateArchive | Paired Rollforward 0x48b932cbb4593afc7b2174f619ad0fc25900411f275072be47df7bd62a180dda\r\n```\r\nand eventually starts throwing `OutOfMemoryException`\r\n\r\n**Frequency:** everytime\r\n\r\n### Versions \r\n* Software version: `21.10.0-RC3`\r\n* Java version: `openjdk version \"11.0.6\" 2020-01-14`\r\n* OS Name & Version:\r\n```properties\r\nPRETTY_NAME=\"Debian GNU/Linux 9 (stretch)\"\r\nNAME=\"Debian GNU/Linux\"\r\nVERSION_ID=\"9\"\r\nVERSION=\"9 (stretch)\"\r\nVERSION_CODENAME=stretch\r\nID=debian\r\nHOME_URL=\"https://www.debian.org/\"\r\nSUPPORT_URL=\"https://www.debian.org/support\"\r\nBUG_REPORT_URL=\"https://bugs.debian.org/\"\r\n```\r\n* Kernel Version: `Linux ip-10-0-0-209 4.9.0-12-amd64 #1 SMP Debian 4.9.210-1+deb9u1 (2020-06-07) x86_64 GNU/Linux`\r\n\r\n* Cloud VM, type, size: Amazon Web Services m5-large\r\n\r\n### Additional Information\r\n\r\nA few weeks ago I started a full sync of ETC using _Bonsai_ just to measure storage size. Everything was moving smooth but at block `13771821` it started to throw `OutOfMemoryException`s. Even on restart I got the same behavior. I tried doubling the heap size, but it ate it all. I ran Java Flight Recorder and I saw that memory was consumed mostly by an `ArrayList<TrieLogLayer>` (I have the .jfr file if anyone is interested, I don't want to upload it here b/c it may contain some sensitive information). Then I restarted with DEBUG logging and I saw the repeating lines pasted above.\r\n\r\nLooking at the code, in [BonsaiWorldStateArchive:215](https://github.com/hyperledger/besu/blob/main/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/bonsai/BonsaiWorldStateArchive.java#L215), it seems to me that the `while` condition isn't updated during the execution, which may explain the repetitive log and the increasing `List<TrieLogLayer>`.\r\n\r\nI can also share the _Bonsai_ DB just to test so you don't need to fully sync it (50GB)",
  "closed_by": {
    "login": "shemnon",
    "id": 38109,
    "node_id": "MDQ6VXNlcjM4MTA5",
    "avatar_url": "https://avatars.githubusercontent.com/u/38109?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/shemnon",
    "html_url": "https://github.com/shemnon",
    "followers_url": "https://api.github.com/users/shemnon/followers",
    "following_url": "https://api.github.com/users/shemnon/following{/other_user}",
    "gists_url": "https://api.github.com/users/shemnon/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/shemnon/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/shemnon/subscriptions",
    "organizations_url": "https://api.github.com/users/shemnon/orgs",
    "repos_url": "https://api.github.com/users/shemnon/repos",
    "events_url": "https://api.github.com/users/shemnon/events{/privacy}",
    "received_events_url": "https://api.github.com/users/shemnon/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/2953/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/hyperledger/besu/issues/2953/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/952975356",
    "html_url": "https://github.com/hyperledger/besu/issues/2953#issuecomment-952975356",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/2953",
    "id": 952975356,
    "node_id": "IC_kwDODE2jmc44zT_8",
    "user": {
      "login": "leontastic",
      "id": 5552308,
      "node_id": "MDQ6VXNlcjU1NTIzMDg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5552308?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/leontastic",
      "html_url": "https://github.com/leontastic",
      "followers_url": "https://api.github.com/users/leontastic/followers",
      "following_url": "https://api.github.com/users/leontastic/following{/other_user}",
      "gists_url": "https://api.github.com/users/leontastic/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/leontastic/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/leontastic/subscriptions",
      "organizations_url": "https://api.github.com/users/leontastic/orgs",
      "repos_url": "https://api.github.com/users/leontastic/repos",
      "events_url": "https://api.github.com/users/leontastic/events{/privacy}",
      "received_events_url": "https://api.github.com/users/leontastic/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-10-27T14:15:26Z",
    "updated_at": "2021-10-27T14:15:26Z",
    "author_association": "NONE",
    "body": "I'm seeing this issue on ETH too in 21.7.4",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/952975356/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/954026286",
    "html_url": "https://github.com/hyperledger/besu/issues/2953#issuecomment-954026286",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/2953",
    "id": 954026286,
    "node_id": "IC_kwDODE2jmc443Uku",
    "user": {
      "login": "shemnon",
      "id": 38109,
      "node_id": "MDQ6VXNlcjM4MTA5",
      "avatar_url": "https://avatars.githubusercontent.com/u/38109?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/shemnon",
      "html_url": "https://github.com/shemnon",
      "followers_url": "https://api.github.com/users/shemnon/followers",
      "following_url": "https://api.github.com/users/shemnon/following{/other_user}",
      "gists_url": "https://api.github.com/users/shemnon/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/shemnon/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/shemnon/subscriptions",
      "organizations_url": "https://api.github.com/users/shemnon/orgs",
      "repos_url": "https://api.github.com/users/shemnon/repos",
      "events_url": "https://api.github.com/users/shemnon/events{/privacy}",
      "received_events_url": "https://api.github.com/users/shemnon/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-10-28T16:53:10Z",
    "updated_at": "2021-10-28T16:53:10Z",
    "author_association": "MEMBER",
    "body": "The restart is one needed change.  There is a second change in that the `ArrayList<TrieLogLayer>` should probably be replaced with a cache that is either FIFO or prioritized based on log height, and configurable size via the CLI.\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/954026286/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/954116670",
    "html_url": "https://github.com/hyperledger/besu/issues/2953#issuecomment-954116670",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/2953",
    "id": 954116670,
    "node_id": "IC_kwDODE2jmc443qo-",
    "user": {
      "login": "shemnon",
      "id": 38109,
      "node_id": "MDQ6VXNlcjM4MTA5",
      "avatar_url": "https://avatars.githubusercontent.com/u/38109?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/shemnon",
      "html_url": "https://github.com/shemnon",
      "followers_url": "https://api.github.com/users/shemnon/followers",
      "following_url": "https://api.github.com/users/shemnon/following{/other_user}",
      "gists_url": "https://api.github.com/users/shemnon/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/shemnon/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/shemnon/subscriptions",
      "organizations_url": "https://api.github.com/users/shemnon/orgs",
      "repos_url": "https://api.github.com/users/shemnon/repos",
      "events_url": "https://api.github.com/users/shemnon/events{/privacy}",
      "received_events_url": "https://api.github.com/users/shemnon/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-10-28T18:58:56Z",
    "updated_at": "2021-10-28T18:58:56Z",
    "author_association": "MEMBER",
    "body": "The sync code still needs to be updated to not out of memory.",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/954116670/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/957793736",
    "html_url": "https://github.com/hyperledger/besu/issues/2953#issuecomment-957793736",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/2953",
    "id": 957793736,
    "node_id": "IC_kwDODE2jmc45FsXI",
    "user": {
      "login": "matkt",
      "id": 26581503,
      "node_id": "MDQ6VXNlcjI2NTgxNTAz",
      "avatar_url": "https://avatars.githubusercontent.com/u/26581503?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/matkt",
      "html_url": "https://github.com/matkt",
      "followers_url": "https://api.github.com/users/matkt/followers",
      "following_url": "https://api.github.com/users/matkt/following{/other_user}",
      "gists_url": "https://api.github.com/users/matkt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/matkt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/matkt/subscriptions",
      "organizations_url": "https://api.github.com/users/matkt/orgs",
      "repos_url": "https://api.github.com/users/matkt/repos",
      "events_url": "https://api.github.com/users/matkt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/matkt/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-11-02T15:14:13Z",
    "updated_at": "2021-11-02T15:14:13Z",
    "author_association": "CONTRIBUTOR",
    "body": "> The sync code still needs to be updated to not out of memory.\r\n\r\nWe fixed that on this one https://github.com/hyperledger/besu/pull/2934",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/957793736/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/957816963",
    "html_url": "https://github.com/hyperledger/besu/issues/2953#issuecomment-957816963",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/2953",
    "id": 957816963,
    "node_id": "IC_kwDODE2jmc45FyCD",
    "user": {
      "login": "shemnon",
      "id": 38109,
      "node_id": "MDQ6VXNlcjM4MTA5",
      "avatar_url": "https://avatars.githubusercontent.com/u/38109?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/shemnon",
      "html_url": "https://github.com/shemnon",
      "followers_url": "https://api.github.com/users/shemnon/followers",
      "following_url": "https://api.github.com/users/shemnon/following{/other_user}",
      "gists_url": "https://api.github.com/users/shemnon/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/shemnon/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/shemnon/subscriptions",
      "organizations_url": "https://api.github.com/users/shemnon/orgs",
      "repos_url": "https://api.github.com/users/shemnon/repos",
      "events_url": "https://api.github.com/users/shemnon/events{/privacy}",
      "received_events_url": "https://api.github.com/users/shemnon/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-11-02T15:24:49Z",
    "updated_at": "2021-11-02T15:24:49Z",
    "author_association": "MEMBER",
    "body": "Got it, it was a local variable based list not a object field list growing out of control",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/957816963/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
