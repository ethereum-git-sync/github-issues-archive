{
  "url": "https://api.github.com/repos/hyperledger/besu/issues/4788",
  "repository_url": "https://api.github.com/repos/hyperledger/besu",
  "labels_url": "https://api.github.com/repos/hyperledger/besu/issues/4788/labels{/name}",
  "comments_url": "https://api.github.com/repos/hyperledger/besu/issues/4788/comments",
  "events_url": "https://api.github.com/repos/hyperledger/besu/issues/4788/events",
  "html_url": "https://github.com/hyperledger/besu/issues/4788",
  "id": 1483438553,
  "node_id": "I_kwDODE2jmc5Ya3nZ",
  "number": 4788,
  "title": "Clean up: Remove applyMergeSpecificModifications",
  "user": {
    "login": "siladu",
    "id": 2893793,
    "node_id": "MDQ6VXNlcjI4OTM3OTM=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2893793?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/siladu",
    "html_url": "https://github.com/siladu",
    "followers_url": "https://api.github.com/users/siladu/followers",
    "following_url": "https://api.github.com/users/siladu/following{/other_user}",
    "gists_url": "https://api.github.com/users/siladu/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/siladu/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/siladu/subscriptions",
    "organizations_url": "https://api.github.com/users/siladu/orgs",
    "repos_url": "https://api.github.com/users/siladu/repos",
    "events_url": "https://api.github.com/users/siladu/events{/privacy}",
    "received_events_url": "https://api.github.com/users/siladu/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1921587647,
      "node_id": "MDU6TGFiZWwxOTIxNTg3NjQ3",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/TeamGroot",
      "name": "TeamGroot",
      "color": "1d76db",
      "default": false,
      "description": "GH issues worked on by Groot Team"
    },
    {
      "id": 4328777430,
      "node_id": "LA_kwDODE2jmc8AAAABAgPm1g",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/blocked",
      "name": "blocked",
      "color": "B60205",
      "default": false,
      "description": null
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2022-12-08T02:44:26Z",
  "updated_at": "2023-04-21T00:04:14Z",
  "closed_at": "2023-04-21T00:04:14Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "Following https://github.com/hyperledger/besu/pull/4743\n\nit was discovered that these modifications to the protocol schedule are being applied using an override mechanism when we could just move (some of?) them into the `parisDefinition`.\n\nCompare https://github.com/hyperledger/besu/blob/efa0a759a3b4aca873236b4191a2827a9c45df16/consensus/merge/src/main/java/org/hyperledger/besu/consensus/merge/MergeProtocolSchedule.java#L65-L73 to https://github.com/hyperledger/besu/blob/efa0a759a3b4aca873236b4191a2827a9c45df16/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/MainnetProtocolSpecs.java#L631-L636\n\nparisDefinition implementation may also be wrong. It is currently not used because it's overridden by `applyMergeSpecificModifications`.\n\nNote, in #4743, to support shanghaiTimestamp, we had to add apply these modifications as well otherwise shanghaiDefinition would have inherited the incorrect parisDefinition.\n\n@garyschulte mentioned a desire to avoid having merge protocol schedule specifics leak into the MainnetProtocolSpecs so it may require some thought.",
  "closed_by": {
    "login": "siladu",
    "id": 2893793,
    "node_id": "MDQ6VXNlcjI4OTM3OTM=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2893793?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/siladu",
    "html_url": "https://github.com/siladu",
    "followers_url": "https://api.github.com/users/siladu/followers",
    "following_url": "https://api.github.com/users/siladu/following{/other_user}",
    "gists_url": "https://api.github.com/users/siladu/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/siladu/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/siladu/subscriptions",
    "organizations_url": "https://api.github.com/users/siladu/orgs",
    "repos_url": "https://api.github.com/users/siladu/repos",
    "events_url": "https://api.github.com/users/siladu/events{/privacy}",
    "received_events_url": "https://api.github.com/users/siladu/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/4788/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/hyperledger/besu/issues/4788/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1455273289",
    "html_url": "https://github.com/hyperledger/besu/issues/4788#issuecomment-1455273289",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/4788",
    "id": 1455273289,
    "node_id": "IC_kwDODE2jmc5WvbVJ",
    "user": {
      "login": "siladu",
      "id": 2893793,
      "node_id": "MDQ6VXNlcjI4OTM3OTM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2893793?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/siladu",
      "html_url": "https://github.com/siladu",
      "followers_url": "https://api.github.com/users/siladu/followers",
      "following_url": "https://api.github.com/users/siladu/following{/other_user}",
      "gists_url": "https://api.github.com/users/siladu/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/siladu/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/siladu/subscriptions",
      "organizations_url": "https://api.github.com/users/siladu/orgs",
      "repos_url": "https://api.github.com/users/siladu/repos",
      "events_url": "https://api.github.com/users/siladu/events{/privacy}",
      "received_events_url": "https://api.github.com/users/siladu/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-06T00:48:40Z",
    "updated_at": "2023-03-06T00:49:10Z",
    "author_association": "CONTRIBUTOR",
    "body": "cc @garyschulte I had another go at this: https://github.com/siladu/besu/tree/update-paris-definition\r\n\r\n[Couldn't completely get rid of it because adding MergeBlockProcessor](https://github.com/siladu/besu/commit/5e4a366da16c540e05624f04de5e3a6228798f31#diff-17e01bf54f7f76bf35d2a0401734defa2e6f184dbb660d3e750a6fce1008f9ffR98) to MainnetProtocolSpecs is a cyclical dependency.\r\n\r\nI think this means we need to add this in `applyMergeSpecificModifications` for every future fork! At least for networks that start from the future fork.\r\n\r\nSo how do we get rid of it? Couple of options I can think of:\r\n1. Move MergeBlockProcessor into the core module (breaks consensus module and merge package encapsulation)\r\n2. Rewrite the AbstractBlockProcessor template pattern to use composition and wire the different functionality in via MainnetProtocolSpecs instead.\r\n\r\nUnits tests are broken (mostly `MergeCoordinatorTest` and `MergeReorgTest`) with [my branch](https://github.com/siladu/besu/tree/update-paris-definition) but I think actually that the tests are setup wrong. They are setting the parisBlock even for the terminal PoW block, so they seem to be relying on Paris not triggering certain functionality, which this code now does.\r\n\r\nI did manually sync up zhejiang-testnet so I think the code works...I had to add \"mergeNetSplitBlock: 0\" to make the \"PoS at genesis\" work. \r\nI didn't test block creation.\r\n\r\nHowever, I don't think we can progress this **until ACD has agreed to add mergeNetSplitBlock to goerli and mainnet** because it will change the ForkId. We could hack around the forkId but there's not much benefit IMO.",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1455273289/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1517079011",
    "html_url": "https://github.com/hyperledger/besu/issues/4788#issuecomment-1517079011",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/4788",
    "id": 1517079011,
    "node_id": "IC_kwDODE2jmc5abMnj",
    "user": {
      "login": "siladu",
      "id": 2893793,
      "node_id": "MDQ6VXNlcjI4OTM3OTM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2893793?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/siladu",
      "html_url": "https://github.com/siladu",
      "followers_url": "https://api.github.com/users/siladu/followers",
      "following_url": "https://api.github.com/users/siladu/following{/other_user}",
      "gists_url": "https://api.github.com/users/siladu/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/siladu/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/siladu/subscriptions",
      "organizations_url": "https://api.github.com/users/siladu/orgs",
      "repos_url": "https://api.github.com/users/siladu/repos",
      "events_url": "https://api.github.com/users/siladu/events{/privacy}",
      "received_events_url": "https://api.github.com/users/siladu/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-21T00:04:12Z",
    "updated_at": "2023-04-21T00:04:12Z",
    "author_association": "CONTRIBUTOR",
    "body": "> However, I don't think we can progress this until ACD has agreed to add mergeNetSplitBlock to goerli and mainnet because it will change the ForkId. We could hack around the forkId but there's not much benefit IMO.\n\nTurns out mergeNetSplitBlock isn't intended to be equivalent to the \"proof of stake transition block\", so is not appropriate to use for this purpose.\n\nThis PR  https://github.com/hyperledger/besu/pull/5310  introduces an \"unapplyMergeSpecificModificationsFromShanghaiOnwards\" which means the mergeSpecificModifications are only applies for the Paris fork and the unapply function makes it so that we can continue to rely on MainnetProtocolSpecs instead.\n\nClosing this as the original reason it was opened (Shanghai fork issues) is resolved.",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1517079011/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1517079015",
    "html_url": "https://github.com/hyperledger/besu/issues/4788#issuecomment-1517079015",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/4788",
    "id": 1517079015,
    "node_id": "IC_kwDODE2jmc5abMnn",
    "user": {
      "login": "siladu",
      "id": 2893793,
      "node_id": "MDQ6VXNlcjI4OTM3OTM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2893793?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/siladu",
      "html_url": "https://github.com/siladu",
      "followers_url": "https://api.github.com/users/siladu/followers",
      "following_url": "https://api.github.com/users/siladu/following{/other_user}",
      "gists_url": "https://api.github.com/users/siladu/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/siladu/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/siladu/subscriptions",
      "organizations_url": "https://api.github.com/users/siladu/orgs",
      "repos_url": "https://api.github.com/users/siladu/repos",
      "events_url": "https://api.github.com/users/siladu/events{/privacy}",
      "received_events_url": "https://api.github.com/users/siladu/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-21T00:04:12Z",
    "updated_at": "2023-04-21T00:04:12Z",
    "author_association": "CONTRIBUTOR",
    "body": "> However, I don't think we can progress this until ACD has agreed to add mergeNetSplitBlock to goerli and mainnet because it will change the ForkId. We could hack around the forkId but there's not much benefit IMO.\n\nTurns out mergeNetSplitBlock isn't intended to be equivalent to the \"proof of stake transition block\", so is not appropriate to use for this purpose.\n\nThis PR  https://github.com/hyperledger/besu/pull/5310  introduces an \"unapplyMergeSpecificModificationsFromShanghaiOnwards\" which means the mergeSpecificModifications are only applies for the Paris fork and the unapply function makes it so that we can continue to rely on MainnetProtocolSpecs instead.\n\nClosing this as the original reason it was opened (Shanghai fork issues) is resolved.",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1517079015/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
