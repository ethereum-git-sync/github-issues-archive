{
  "url": "https://api.github.com/repos/hyperledger/besu/issues/1445",
  "repository_url": "https://api.github.com/repos/hyperledger/besu",
  "labels_url": "https://api.github.com/repos/hyperledger/besu/issues/1445/labels{/name}",
  "comments_url": "https://api.github.com/repos/hyperledger/besu/issues/1445/comments",
  "events_url": "https://api.github.com/repos/hyperledger/besu/issues/1445/events",
  "html_url": "https://github.com/hyperledger/besu/issues/1445",
  "id": 719381030,
  "node_id": "MDU6SXNzdWU3MTkzODEwMzA=",
  "number": 1445,
  "title": "500 Internal error returned on eth_estimateGas",
  "user": {
    "login": "jimy74",
    "id": 6338426,
    "node_id": "MDQ6VXNlcjYzMzg0MjY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6338426?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jimy74",
    "html_url": "https://github.com/jimy74",
    "followers_url": "https://api.github.com/users/jimy74/followers",
    "following_url": "https://api.github.com/users/jimy74/following{/other_user}",
    "gists_url": "https://api.github.com/users/jimy74/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jimy74/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jimy74/subscriptions",
    "organizations_url": "https://api.github.com/users/jimy74/orgs",
    "repos_url": "https://api.github.com/users/jimy74/repos",
    "events_url": "https://api.github.com/users/jimy74/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jimy74/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 2051683573,
      "node_id": "MDU6TGFiZWwyMDUxNjgzNTcz",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/P3",
      "name": "P3",
      "color": "ffff00",
      "default": false,
      "description": "Medium (ex: JSON-RPC request not working with a specific client library due to loose spec assumtion)"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "matkt",
    "id": 26581503,
    "node_id": "MDQ6VXNlcjI2NTgxNTAz",
    "avatar_url": "https://avatars.githubusercontent.com/u/26581503?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/matkt",
    "html_url": "https://github.com/matkt",
    "followers_url": "https://api.github.com/users/matkt/followers",
    "following_url": "https://api.github.com/users/matkt/following{/other_user}",
    "gists_url": "https://api.github.com/users/matkt/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/matkt/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/matkt/subscriptions",
    "organizations_url": "https://api.github.com/users/matkt/orgs",
    "repos_url": "https://api.github.com/users/matkt/repos",
    "events_url": "https://api.github.com/users/matkt/events{/privacy}",
    "received_events_url": "https://api.github.com/users/matkt/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "matkt",
      "id": 26581503,
      "node_id": "MDQ6VXNlcjI2NTgxNTAz",
      "avatar_url": "https://avatars.githubusercontent.com/u/26581503?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/matkt",
      "html_url": "https://github.com/matkt",
      "followers_url": "https://api.github.com/users/matkt/followers",
      "following_url": "https://api.github.com/users/matkt/following{/other_user}",
      "gists_url": "https://api.github.com/users/matkt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/matkt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/matkt/subscriptions",
      "organizations_url": "https://api.github.com/users/matkt/orgs",
      "repos_url": "https://api.github.com/users/matkt/repos",
      "events_url": "https://api.github.com/users/matkt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/matkt/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2020-10-12T13:28:36Z",
  "updated_at": "2020-10-30T10:29:16Z",
  "closed_at": "2020-10-27T14:50:12Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Description\r\nAs a JSON-RPC client of a besu node, I want to run a gas estimation so that I can detect that a transaction that try to to send ether to a non-payable contract (fallback) should fail. This allows me to detect if a smart contract have a payable fallback. \r\n\r\n\r\n### Steps to Reproduce (Bug)\r\n1. Sync a node in fast mode with rinkeby, with the config : \r\nBESU_HOST_WHITELIST=\"*\"\r\nBESU_RPC_HTTP_ENABLED=\"true\"\r\nBESU_RPC_HTTP_API=\"ADMIN,WEB3,ETH,NET,TRACE\"\r\nBESU_RPC_HTTP_CORS_ORIGINS=\"*\"\r\nBESU_SYNC_MODE=\"FAST\"\r\nBESU_NETWORK=\"rinkeby\"\r\nBESU_MIN_GAS_PRICE=\"1000000000\"\r\n\r\n2. Have some Ether on the sender address (1 ETH should be more than enough), with the one on example it is already the case.\r\n\r\n3. Run the call : \r\n\r\n```\r\ncurl --data '{\"method\":\"eth_estimateGas\",\"params\":[{\"from\": \"0xdf46E254BB7484A80763767c09E4B42FEDaC07E1\", \"to\": \"0x52A7B377A666be31582532E567DF9e253e433A9d\", \"data\": \"0x\", \"gasLimit\": 300000, \"value\": 100}],\"id\":1,\"jsonrpc\":\"2.0\"}' -H \"Content-Type: application/json\" -X POST http://<myBesuUrl>:<myBesuPort>\r\n```\r\n\r\n\r\n**Expected behavior:** [What you expect to happen]\r\n\r\n```\r\ncurl --data '{\"method\":\"eth_estimateGas\",\"params\":[{\"from\": \"0xdf46E254BB7484A80763767c09E4B42FEDaC07E1\", \"to\": \"0x52A7B377A666be31582532E567DF9e253e433A9d\", \"gasLimit\": 300000, \"value\": \"0x100\"}],\"id\":1,\"jsonrpc\":\"2.0\"}' -H \"Content-Type: application/json\" -X POST http://<myGethUrl>:<myGethPort>\r\n{\"jsonrpc\":\"2.0\",\"id\":1,\"error\":{\"code\":-32000,\"message\":\"execution reverted\"}}\r\n```\r\nAs you can see, the same request on a Geth node returns an understandable error informing that the contract have reverted.\r\n\r\n**Actual behavior:**\r\n\r\n```\r\ncurl --data '{\"method\":\"eth_estimateGas\",\"params\":[{\"from\": \"0xdf46E254BB7484A80763767c09E4B42FEDaC07E1\", \"to\": \"0x52A7B377A666be31582532E567DF9e253e433A9d\", \"data\": \"0x\", \"gasLimit\": 300000, \"value\": 100}],\"id\":1,\"jsonrpc\":\"2.0\"}' -H \"Content-Type: application/json\" -X POST http://<myBesuUrl>:<myBesuPort>\r\n{\r\n  \"jsonrpc\" : \"2.0\",\r\n  \"id\" : 1,\r\n  \"error\" : {\r\n    \"code\" : -32603,\r\n    \"message\" : \"Internal error\"\r\n  }\r\n}%\r\n```\r\n\r\nSame with the value passed in hexadecimal : \r\n```\r\ncurl --data '{\"method\":\"eth_estimateGas\",\"params\":[{\"from\": \"0xdf46E254BB7484A80763767c09E4B42FEDaC07E1\", \"to\": \"0x52A7B377A666be31582532E567DF9e253e433A9d\", \"gasLimit\": 300000, \"value\": \"0x64\"}],\"id\":1,\"jsonrpc\":\"2.0\"}' -H \"Content-Type: application/json\" -X POST http://<myBesuUrl>:<myBesuPort>\r\n{\r\n  \"jsonrpc\" : \"2.0\",\r\n  \"id\" : 1,\r\n  \"error\" : {\r\n    \"code\" : -32603,\r\n    \"message\" : \"Internal error\"\r\n  }\r\n}%\r\n```                                                                \r\n\r\n**Frequency:** 100% of times we run the json-rpc query it return this Internal Error.\r\n\r\n### Versions (Add all that apply)\r\n* Software version: besu/v1.5.5/linux-x86_64/oracle_openjdk-java-11\r\n* Java version: oracle_openjdk-java-11\r\n* OS Name & Version:\r\n\r\n* Kernel Version: 5.4.49+\r\n* Docker Version: 19.03.9\r\n* Cloud VM, type, size: GCP Cloud VM: n2-highmem-4\r\n* Operating System: Container-Optimized OS from Google\r\n\r\n### Additional Information\r\n\r\nI believe the node should reply like geth, at least to say it has an error and it was reverted, without a revert message as I'm in FAST mode anyway and in this case there is no message potentially as it is reverted cause the method is not payable.\r\nHere it fails with a 500 error mean that there is a potential problem in the implementation.\r\n\r\nIf it's really a bug as it looks like, can someone fix it? Otherwise, can someone tell me what I'm doing wrong?\r\n\r\nRather than that, the erro code -32603 is shared between internsl errors and timeout errors, but here with the additional message it seems to be a internal error, maybe worth a sub ticket for that but it's not my concern here.\r\n\r\n",
  "closed_by": {
    "login": "matkt",
    "id": 26581503,
    "node_id": "MDQ6VXNlcjI2NTgxNTAz",
    "avatar_url": "https://avatars.githubusercontent.com/u/26581503?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/matkt",
    "html_url": "https://github.com/matkt",
    "followers_url": "https://api.github.com/users/matkt/followers",
    "following_url": "https://api.github.com/users/matkt/following{/other_user}",
    "gists_url": "https://api.github.com/users/matkt/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/matkt/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/matkt/subscriptions",
    "organizations_url": "https://api.github.com/users/matkt/orgs",
    "repos_url": "https://api.github.com/users/matkt/repos",
    "events_url": "https://api.github.com/users/matkt/events{/privacy}",
    "received_events_url": "https://api.github.com/users/matkt/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/1445/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/hyperledger/besu/issues/1445/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/719472871",
    "html_url": "https://github.com/hyperledger/besu/issues/1445#issuecomment-719472871",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/1445",
    "id": 719472871,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcxOTQ3Mjg3MQ==",
    "user": {
      "login": "matkt",
      "id": 26581503,
      "node_id": "MDQ6VXNlcjI2NTgxNTAz",
      "avatar_url": "https://avatars.githubusercontent.com/u/26581503?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/matkt",
      "html_url": "https://github.com/matkt",
      "followers_url": "https://api.github.com/users/matkt/followers",
      "following_url": "https://api.github.com/users/matkt/following{/other_user}",
      "gists_url": "https://api.github.com/users/matkt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/matkt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/matkt/subscriptions",
      "organizations_url": "https://api.github.com/users/matkt/orgs",
      "repos_url": "https://api.github.com/users/matkt/repos",
      "events_url": "https://api.github.com/users/matkt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/matkt/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-10-30T10:29:16Z",
    "updated_at": "2020-10-30T10:29:16Z",
    "author_association": "CONTRIBUTOR",
    "body": "The bug is fixed. Thank you\r\nThe method will return `Execution reverted` instead of an internal error",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/719472871/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 1,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
