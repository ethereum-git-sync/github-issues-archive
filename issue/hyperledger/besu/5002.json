{
  "url": "https://api.github.com/repos/hyperledger/besu/issues/5002",
  "repository_url": "https://api.github.com/repos/hyperledger/besu",
  "labels_url": "https://api.github.com/repos/hyperledger/besu/issues/5002/labels{/name}",
  "comments_url": "https://api.github.com/repos/hyperledger/besu/issues/5002/comments",
  "events_url": "https://api.github.com/repos/hyperledger/besu/issues/5002/events",
  "html_url": "https://github.com/hyperledger/besu/issues/5002",
  "id": 1556727254,
  "node_id": "I_kwDODE2jmc5cycXW",
  "number": 5002,
  "title": "Besu always needs cluster level permissions for Kubernetes NAT manager on GKE",
  "user": {
    "login": "snigdha920",
    "id": 62167899,
    "node_id": "MDQ6VXNlcjYyMTY3ODk5",
    "avatar_url": "https://avatars.githubusercontent.com/u/62167899?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/snigdha920",
    "html_url": "https://github.com/snigdha920",
    "followers_url": "https://api.github.com/users/snigdha920/followers",
    "following_url": "https://api.github.com/users/snigdha920/following{/other_user}",
    "gists_url": "https://api.github.com/users/snigdha920/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/snigdha920/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/snigdha920/subscriptions",
    "organizations_url": "https://api.github.com/users/snigdha920/orgs",
    "repos_url": "https://api.github.com/users/snigdha920/repos",
    "events_url": "https://api.github.com/users/snigdha920/events{/privacy}",
    "received_events_url": "https://api.github.com/users/snigdha920/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 2129007612,
      "node_id": "MDU6TGFiZWwyMTI5MDA3NjEy",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/dev%20experience",
      "name": "dev experience",
      "color": "2a0b89",
      "default": false,
      "description": "The build system, things that enable easier development etc."
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2023-01-25T14:12:57Z",
  "updated_at": "2023-02-07T21:22:08Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "<!-- Have you done the following? -->\r\n<!--   * read the Code of Conduct? By filing an Issue, you are expected to -->  \r\n<!--     comply with it, including treating everyone with respect: -->\r\n<!--     https://github.com/hyperledger/besu/blob/main/CODE_OF_CONDUCT.md -->\r\n<!--   * Reproduced the issue in the latest version of the software -->\r\n<!--   * Read the debugging docs: https://besu.hyperledger.org/en/stable/HowTo/Monitor/Logging/ -->\r\n<!--   * Duplicate Issue check:  https://github.com/search?q=+is%3Aissue+repo%3Ahyperledger/Besu -->\r\n<!-- Note:  Not all sections will apply to all issue types. -->\r\n\r\n### Description\r\n\r\n\r\n- Currently the Kubernetes NAT manager checks all namespaces to find the besu service here: https://github.com/hyperledger/besu/blob/9eb32836b710bd997887c5c1f77436710be9eff1/nat/src/main/java/org/hyperledger/besu/nat/kubernetes/KubernetesNatManager.java#L87\r\n- For this to work, we need to give cluster level permissions to the `besu` deployment for it to be able to scan all the namespaces\r\n- In some environments, granting cluster level permissions is not authorised (for example, in a lot of banks)\r\n- Even if the besu service is in the same namespace as the besu deployment the NAT manager errors out when we do not grant cluster level permissions since it ALWAYS lists services in all namespaces.\r\n- Falls back to `NONE`, the enode does not have the correct public IP address anymore, instead it is `0.0.0.0`\r\n\r\nWhat we need is the NAT manager to work without the need of cluster level permissions on GKE.\r\n\r\nPerhaps a fallback to just checking in the local namespace (i.e the namespace of the besu deployment) before throwing the error?\r\n\r\n\r\n### Acceptance Criteria\r\n* NAT manager works without cluster level permissions on GKE\r\n\r\n### Steps to Reproduce (Bug)\r\n1. Deploy a besu deployment, service without cluster level permissions\r\n2. The NAT manager errors out, throws the following error:\r\n\r\nhttps://github.com/hyperledger/besu/blob/9eb32836b710bd997887c5c1f77436710be9eff1/nat/src/main/java/org/hyperledger/besu/nat/kubernetes/KubernetesNatManager.java#L97\r\n\r\nand falls back to `NONE`.\r\n3. The enode url of the node has `0.0.0.0` as the public IP\r\n\r\n**Expected behavior:** [What you expect to happen]\r\n\r\nIf searching for the service across all namespaces fails, it should look for the service in the local namespace before falling back to `NONE`.\r\n\r\n**Actual behavior:** [What actually happens]\r\nIf searching for the service across all namespaces fails, it errors out, and falls back to `NONE`.\r\n\r\n**Frequency:** [What percentage of the time does it occur?]\r\n\r\n100%\r\n\r\n### Versions (Add all that apply)\r\n* docker image we use: https://hub.docker.com/layers/hyperledger/besu/22.10.4/images/sha256-036331dda5c27e2d51524614cd628d6f55fc14583b48516e1e019aef0de92a21?context=explore\r\n* Software version: [`besu --version`]\r\n* Java version: [`java -version`]\r\n* OS Name & Version: [`cat /etc/*release`]\r\n* Kernel Version: [`uname -a`]\r\n* Virtual Machine software & version: [`vmware -v`]\r\n* Docker Version: [`docker version`]\r\n* Cloud VM, type, size: [Amazon Web Services I3-large]\r\n\r\n### Smart contract information (If you're reporting an issue arising from deploying or calling a smart contract, please supply related information)\r\nN/A\r\n\r\n### Additional Information (Add any of the following or anything else that may be relevant)\r\nN/A\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/5002/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/hyperledger/besu/issues/5002/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1405125132",
    "html_url": "https://github.com/hyperledger/besu/issues/5002#issuecomment-1405125132",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/5002",
    "id": 1405125132,
    "node_id": "IC_kwDODE2jmc5TwIIM",
    "user": {
      "login": "non-fungible-nelson",
      "id": 85905982,
      "node_id": "MDQ6VXNlcjg1OTA1OTgy",
      "avatar_url": "https://avatars.githubusercontent.com/u/85905982?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/non-fungible-nelson",
      "html_url": "https://github.com/non-fungible-nelson",
      "followers_url": "https://api.github.com/users/non-fungible-nelson/followers",
      "following_url": "https://api.github.com/users/non-fungible-nelson/following{/other_user}",
      "gists_url": "https://api.github.com/users/non-fungible-nelson/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/non-fungible-nelson/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/non-fungible-nelson/subscriptions",
      "organizations_url": "https://api.github.com/users/non-fungible-nelson/orgs",
      "repos_url": "https://api.github.com/users/non-fungible-nelson/repos",
      "events_url": "https://api.github.com/users/non-fungible-nelson/events{/privacy}",
      "received_events_url": "https://api.github.com/users/non-fungible-nelson/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-01-26T14:50:13Z",
    "updated_at": "2023-01-26T14:50:13Z",
    "author_association": "CONTRIBUTOR",
    "body": "@joshuafernandes - Any opinion here?",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1405125132/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1405801431",
    "html_url": "https://github.com/hyperledger/besu/issues/5002#issuecomment-1405801431",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/5002",
    "id": 1405801431,
    "node_id": "IC_kwDODE2jmc5TytPX",
    "user": {
      "login": "joshuafernandes",
      "id": 3722503,
      "node_id": "MDQ6VXNlcjM3MjI1MDM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3722503?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/joshuafernandes",
      "html_url": "https://github.com/joshuafernandes",
      "followers_url": "https://api.github.com/users/joshuafernandes/followers",
      "following_url": "https://api.github.com/users/joshuafernandes/following{/other_user}",
      "gists_url": "https://api.github.com/users/joshuafernandes/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/joshuafernandes/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/joshuafernandes/subscriptions",
      "organizations_url": "https://api.github.com/users/joshuafernandes/orgs",
      "repos_url": "https://api.github.com/users/joshuafernandes/repos",
      "events_url": "https://api.github.com/users/joshuafernandes/events{/privacy}",
      "received_events_url": "https://api.github.com/users/joshuafernandes/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-01-26T23:17:26Z",
    "updated_at": "2023-01-26T23:17:26Z",
    "author_association": "CONTRIBUTOR",
    "body": "Hi @non-fungible-nelson yes this is an issue and I believe tied to how we do things with K8S RBAC (ie Besu doesn't respect RBAC). The NAT manager works perfectly fine as long as cluster wide RBAC is disabled, but when it is enabled (most cases & this should be the norm to be honest) the permissions it requires are too wide. Have discussed with @matkt a while ago but priorities changed I believe\r\n\r\nhttps://github.com/hyperledger/besu/blob/main/nat/src/main/java/org/hyperledger/besu/nat/kubernetes/KubernetesNatManager.java#L87 should be limited to single namespace imho and we pass the namespace in as another cli arg. In the K8S repo I've turned NAT manager off altogether because of this and prefer to remain secure and manually pass in the addresses via [DNS](https://github.com/ConsenSys/quorum-kubernetes/blob/master/helm/charts/besu-node/templates/node-statefulset.yaml#L273)\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1405801431/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1406190343",
    "html_url": "https://github.com/hyperledger/besu/issues/5002#issuecomment-1406190343",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/5002",
    "id": 1406190343,
    "node_id": "IC_kwDODE2jmc5T0MMH",
    "user": {
      "login": "non-fungible-nelson",
      "id": 85905982,
      "node_id": "MDQ6VXNlcjg1OTA1OTgy",
      "avatar_url": "https://avatars.githubusercontent.com/u/85905982?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/non-fungible-nelson",
      "html_url": "https://github.com/non-fungible-nelson",
      "followers_url": "https://api.github.com/users/non-fungible-nelson/followers",
      "following_url": "https://api.github.com/users/non-fungible-nelson/following{/other_user}",
      "gists_url": "https://api.github.com/users/non-fungible-nelson/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/non-fungible-nelson/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/non-fungible-nelson/subscriptions",
      "organizations_url": "https://api.github.com/users/non-fungible-nelson/orgs",
      "repos_url": "https://api.github.com/users/non-fungible-nelson/repos",
      "events_url": "https://api.github.com/users/non-fungible-nelson/events{/privacy}",
      "received_events_url": "https://api.github.com/users/non-fungible-nelson/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-01-27T08:48:31Z",
    "updated_at": "2023-01-27T08:48:31Z",
    "author_association": "CONTRIBUTOR",
    "body": "Thanks for this - leaving open for now. Might make a docs change regarding this for your advice? @alexandratran ping me if you think this makes sense to open a ticket with in besu docs. ",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1406190343/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1421012861",
    "html_url": "https://github.com/hyperledger/besu/issues/5002#issuecomment-1421012861",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/5002",
    "id": 1421012861,
    "node_id": "IC_kwDODE2jmc5Usu99",
    "user": {
      "login": "snigdha920",
      "id": 62167899,
      "node_id": "MDQ6VXNlcjYyMTY3ODk5",
      "avatar_url": "https://avatars.githubusercontent.com/u/62167899?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/snigdha920",
      "html_url": "https://github.com/snigdha920",
      "followers_url": "https://api.github.com/users/snigdha920/followers",
      "following_url": "https://api.github.com/users/snigdha920/following{/other_user}",
      "gists_url": "https://api.github.com/users/snigdha920/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/snigdha920/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/snigdha920/subscriptions",
      "organizations_url": "https://api.github.com/users/snigdha920/orgs",
      "repos_url": "https://api.github.com/users/snigdha920/repos",
      "events_url": "https://api.github.com/users/snigdha920/events{/privacy}",
      "received_events_url": "https://api.github.com/users/snigdha920/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-02-07T15:59:54Z",
    "updated_at": "2023-02-07T16:04:16Z",
    "author_association": "NONE",
    "body": "> Hi @non-fungible-nelson yes this is an issue and I believe tied to how we do things with K8S RBAC (ie Besu doesn't respect RBAC). The NAT manager works perfectly fine as long as cluster wide RBAC is disabled, but when it is enabled (most cases & this should be the norm to be honest) the permissions it requires are too wide. Have discussed with @matkt a while ago but priorities changed I believe\r\n> \r\n> https://github.com/hyperledger/besu/blob/main/nat/src/main/java/org/hyperledger/besu/nat/kubernetes/KubernetesNatManager.java#L87 should be limited to single namespace imho and we pass the namespace in as another cli arg. In the K8S repo I've turned NAT manager off altogether because of this and prefer to remain secure and manually pass in the addresses via [DNS](https://github.com/ConsenSys/quorum-kubernetes/blob/master/helm/charts/besu-node/templates/node-statefulset.yaml#L273)\r\n\r\nHow did you use DNS without the NAT manager and cluster level permissions? \r\n\r\nI went through your [DNS setup](https://github.com/ConsenSys/quorum-kubernetes/blob/master/helm/charts/besu-node/templates/node-statefulset.yaml#L273) and I have the same configuration, but I still get the following issues:\r\n\r\nWhen I try:\r\n- Turning off the NAT manager by setting`nat-method=NONE`, besu doesn't start with the error: \r\n    ```\r\n    The `--Xnat-kube-service-name` parameter is only used in kubernetes mode. Either remove --Xnat-kube-service-name or select the KUBERNETES mode (via --nat--method=KUBERNETES)\r\n    ```\r\n\r\n- Using the K8s NAT manager and starting besu as: \r\n    ```\r\n    exec /opt/besu/bin/besu --config-file=/etc/besu/config.toml --Xdns-enabled=true --Xdns-update-enabled=true --Xnat-kube-service-name=${name} \r\n    ```\r\n    with the following p2p options in my config:\r\n    ```\r\n                'p2p-enabled': true,\r\n                'discovery-enabled': true,\r\n                'p2p-interface': '0.0.0.0',\r\n                'p2p-port': 30303,\r\n                'p2p-host': '0.0.0.0'\r\n                'max-peers': 25,\r\n    ```\r\n    \r\n    The NAT manager crashes and doesn't use the DNS config specified because it doesn't have cluster-level permissions. \r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1421012861/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1421469202",
    "html_url": "https://github.com/hyperledger/besu/issues/5002#issuecomment-1421469202",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/5002",
    "id": 1421469202,
    "node_id": "IC_kwDODE2jmc5UueYS",
    "user": {
      "login": "joshuafernandes",
      "id": 3722503,
      "node_id": "MDQ6VXNlcjM3MjI1MDM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3722503?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/joshuafernandes",
      "html_url": "https://github.com/joshuafernandes",
      "followers_url": "https://api.github.com/users/joshuafernandes/followers",
      "following_url": "https://api.github.com/users/joshuafernandes/following{/other_user}",
      "gists_url": "https://api.github.com/users/joshuafernandes/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/joshuafernandes/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/joshuafernandes/subscriptions",
      "organizations_url": "https://api.github.com/users/joshuafernandes/orgs",
      "repos_url": "https://api.github.com/users/joshuafernandes/repos",
      "events_url": "https://api.github.com/users/joshuafernandes/events{/privacy}",
      "received_events_url": "https://api.github.com/users/joshuafernandes/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-02-07T21:22:08Z",
    "updated_at": "2023-02-07T21:22:08Z",
    "author_association": "CONTRIBUTOR",
    "body": "Hi @snigdha920 it has been a good while since I used it last and maybe code is changed now, but the two should be treated seperate. In the setup I had in the repo, Besu's NAT manager would fail and then it would lookup things via DNS (more so given it was told what the service name was, it didn't need to do the whole lookup). If this has now changed and the DNS lookup isn't working, then this should be fixed @non-fungible-nelson - effectively Besu in K8S will not work",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1421469202/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
