{
  "url": "https://api.github.com/repos/hyperledger/besu/issues/4829",
  "repository_url": "https://api.github.com/repos/hyperledger/besu",
  "labels_url": "https://api.github.com/repos/hyperledger/besu/issues/4829/labels{/name}",
  "comments_url": "https://api.github.com/repos/hyperledger/besu/issues/4829/comments",
  "events_url": "https://api.github.com/repos/hyperledger/besu/issues/4829/events",
  "html_url": "https://github.com/hyperledger/besu/issues/4829",
  "id": 1498257321,
  "node_id": "I_kwDODE2jmc5ZTZep",
  "number": 4829,
  "title": "Segmentation fault during shutdown",
  "user": {
    "login": "benjaminion",
    "id": 20796281,
    "node_id": "MDQ6VXNlcjIwNzk2Mjgx",
    "avatar_url": "https://avatars.githubusercontent.com/u/20796281?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/benjaminion",
    "html_url": "https://github.com/benjaminion",
    "followers_url": "https://api.github.com/users/benjaminion/followers",
    "following_url": "https://api.github.com/users/benjaminion/following{/other_user}",
    "gists_url": "https://api.github.com/users/benjaminion/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/benjaminion/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/benjaminion/subscriptions",
    "organizations_url": "https://api.github.com/users/benjaminion/orgs",
    "repos_url": "https://api.github.com/users/benjaminion/repos",
    "events_url": "https://api.github.com/users/benjaminion/events{/privacy}",
    "received_events_url": "https://api.github.com/users/benjaminion/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1537362490,
      "node_id": "MDU6TGFiZWwxNTM3MzYyNDkw",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/bug",
      "name": "bug",
      "color": "d73a4a",
      "default": true,
      "description": "Something isn't working"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2022-12-15T11:25:10Z",
  "updated_at": "2023-03-09T13:17:16Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "Besu 22.10.2, when terminated via `systemctl` suffered a `SIGSEGV` on one occasion. Normally shutdown is clean.\r\n\r\n```\r\nStopping Besu Client...\r\n2022-12-15 11:13:00.428+00:00 | BesuCommand-Shutdown-Hook | INFO  | NetworkRunner | Stopping Network.\r\n2022-12-15 11:13:00.469+00:00 | BesuCommand-Shutdown-Hook | INFO  | EthProtocolManager | Stopping eth Subprotocol.\r\n2022-12-15 11:13:00.487+00:00 | BesuCommand-Shutdown-Hook | INFO  | EthProtocolManager | eth Subprotocol stopped.\r\n2022-12-15 11:13:00.488+00:00 | BesuCommand-Shutdown-Hook | INFO  | NetworkRunner | Network stopped.\r\n2022-12-15 11:13:00.488+00:00 | BesuCommand-Shutdown-Hook | INFO  | AutoTransactionLogBloomCachingService | Shutting down Auto transaction logs caching service.\r\n2022-12-15 11:13:00.498+00:00 | BesuCommand-Shutdown-Hook | INFO  | NatService | No NAT environment detected so no service could be stopped\r\n[thread 691416 also had an error]\r\n[thread 691420 also had an error]\r\n[thread 691421 also had an error]\r\n#\r\n# A fatal error has been detected by the Java Runtime Environment:\r\n#\r\n#  SIGSEGV (0xb) at pc=0x00007f55379b0a7a, pid=691253, tid=691422\r\n#\r\n# JRE version: OpenJDK Runtime Environment (17.0.5+8) (build 17.0.5+8-Ubuntu-2ubuntu122.04)\r\n# Java VM: OpenJDK 64-Bit Server VM (17.0.5+8-Ubuntu-2ubuntu122.04, mixed mode, sharing, tiered, compressed oops, compressed class ptrs, g1 gc, linux-amd64)\r\n# Problematic frame:\r\n# C  [librocksdbjni6329599237599607171.so+0x3b0a7a]  rocksdb::DBImpl::FailIfCfHasTs(rocksdb::ColumnFamilyHandle const*) const+0x2a\r\n#\r\n# Core dump will be written. Default location: Core dumps may be processed with \"/usr/share/apport/apport -p%p -s%s -c%c -d%d -P%P -u%u -g%g -- %E\" (or dumping to /data/besu/core.691253)\r\n#\r\n# An error report file with more information is saved as:\r\n# /data/besu/hs_err_pid691253.log\r\n...\r\n```\r\n\r\nHappy to provide `hs_err_pid691253.log` if it's useful.\r\n\r\nConfiguration is as follows. I am *not* using `-Xbonsai-use-snapshots=true`.\r\n\r\n```\r\n# Configuration:                                                                                   #\r\n# Network: Mainnet                                                                                 #\r\n# Data storage: Bonsai                                                                             #\r\n# Sync mode: Checkpoint                                                                            #\r\n# RPC HTTP APIs: ETH,NET,WEB3,DEBUG,ADMIN                                                          #\r\n# RPC HTTP port: 8545                                                                              #\r\n# Engine APIs: ENGINE,ETH                                                                          #\r\n# Engine port: 8551                                                                                #\r\n#                                                                                                  #\r\n# Host:                                                                                            #\r\n# Java: openjdk-java-17                                                                            #\r\n# Maximum heap size: 5.00 GB                                                                       #\r\n# OS: linux-x86_64                                                                                 #\r\n# glibc: 2.35                                                                                      #\r\n# Total memory: 15.50 GB                                                                           #\r\n# CPU cores: 6                                                                                     #\r\n```\r\n\r\n",
  "closed_by": {
    "login": "non-fungible-nelson",
    "id": 85905982,
    "node_id": "MDQ6VXNlcjg1OTA1OTgy",
    "avatar_url": "https://avatars.githubusercontent.com/u/85905982?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/non-fungible-nelson",
    "html_url": "https://github.com/non-fungible-nelson",
    "followers_url": "https://api.github.com/users/non-fungible-nelson/followers",
    "following_url": "https://api.github.com/users/non-fungible-nelson/following{/other_user}",
    "gists_url": "https://api.github.com/users/non-fungible-nelson/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/non-fungible-nelson/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/non-fungible-nelson/subscriptions",
    "organizations_url": "https://api.github.com/users/non-fungible-nelson/orgs",
    "repos_url": "https://api.github.com/users/non-fungible-nelson/repos",
    "events_url": "https://api.github.com/users/non-fungible-nelson/events{/privacy}",
    "received_events_url": "https://api.github.com/users/non-fungible-nelson/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/4829/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/hyperledger/besu/issues/4829/timeline",
  "performed_via_github_app": null,
  "state_reason": "reopened"
}
[
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1405106161",
    "html_url": "https://github.com/hyperledger/besu/issues/4829#issuecomment-1405106161",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/4829",
    "id": 1405106161,
    "node_id": "IC_kwDODE2jmc5TwDfx",
    "user": {
      "login": "non-fungible-nelson",
      "id": 85905982,
      "node_id": "MDQ6VXNlcjg1OTA1OTgy",
      "avatar_url": "https://avatars.githubusercontent.com/u/85905982?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/non-fungible-nelson",
      "html_url": "https://github.com/non-fungible-nelson",
      "followers_url": "https://api.github.com/users/non-fungible-nelson/followers",
      "following_url": "https://api.github.com/users/non-fungible-nelson/following{/other_user}",
      "gists_url": "https://api.github.com/users/non-fungible-nelson/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/non-fungible-nelson/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/non-fungible-nelson/subscriptions",
      "organizations_url": "https://api.github.com/users/non-fungible-nelson/orgs",
      "repos_url": "https://api.github.com/users/non-fungible-nelson/repos",
      "events_url": "https://api.github.com/users/non-fungible-nelson/events{/privacy}",
      "received_events_url": "https://api.github.com/users/non-fungible-nelson/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-01-26T14:39:58Z",
    "updated_at": "2023-01-26T14:39:58Z",
    "author_association": "CONTRIBUTOR",
    "body": "Closing for emergency release and snapshots = true (do NOT set snapshots to true for the time being). ",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1405106161/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1461894211",
    "html_url": "https://github.com/hyperledger/besu/issues/4829#issuecomment-1461894211",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/4829",
    "id": 1461894211,
    "node_id": "IC_kwDODE2jmc5XIrxD",
    "user": {
      "login": "fab-10",
      "id": 91944855,
      "node_id": "U_kgDOBXr3lw",
      "avatar_url": "https://avatars.githubusercontent.com/u/91944855?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fab-10",
      "html_url": "https://github.com/fab-10",
      "followers_url": "https://api.github.com/users/fab-10/followers",
      "following_url": "https://api.github.com/users/fab-10/following{/other_user}",
      "gists_url": "https://api.github.com/users/fab-10/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fab-10/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fab-10/subscriptions",
      "organizations_url": "https://api.github.com/users/fab-10/orgs",
      "repos_url": "https://api.github.com/users/fab-10/repos",
      "events_url": "https://api.github.com/users/fab-10/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fab-10/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-09T11:53:35Z",
    "updated_at": "2023-03-09T11:53:35Z",
    "author_association": "CONTRIBUTOR",
    "body": "I am able to reproduce this easily with a vanilla Besu configuration version 23.1.x, forcing a restart every 5 minute while testing the backward sync\r\n```\r\n# Configuration:                                                                                   #\r\n# Network: Mainnet                                                                                 #\r\n# Network Id: 1                                                                                    #\r\n# Data storage: Bonsai                                                                             #\r\n# Sync mode: Checkpoint                                                                            #\r\n# RPC HTTP APIs: ADMIN,DEBUG,NET,ETH,MINER,WEB3                                                    #\r\n# RPC HTTP port: 8545                                                                              #\r\n# Engine APIs: ENGINE,ETH                                                                          #\r\n# Engine port: 8551                                                                                #\r\n#                                                                                                  #\r\n# Host:                                                                                            #\r\n# Java: openjdk-java-17                                                                            #\r\n# Maximum heap size: 3.81 GB                                                                       #\r\n# OS: linux-x86_64                                                                                 #\r\n# glibc: 2.35                                                                                      #\r\n# Total memory: 15.26 GB                                                                           #\r\n# CPU cores: 4                                                                                     #\r\n#                                                                                                  #\r\n```\r\n\r\nSamples of fatal errors during shutdown\r\n\r\n```\r\n#\r\n# A fatal error has been detected by the Java Runtime Environment:\r\n#\r\n#  SIGSEGV (0xb) at pc=0x0000000000000000, pid=43556, tid=43691\r\n#\r\n# JRE version: OpenJDK Runtime Environment (17.0.6+10) (build 17.0.6+10-Ubuntu-0ubuntu122.04)\r\n# Java VM: OpenJDK 64-Bit Server VM (17.0.6+10-Ubuntu-0ubuntu122.04, mixed mode, sharing, tiered, compressed oops, compressed class ptrs, g1 gc, linux-amd64)\r\n# Problematic frame:\r\n# C  0x0000000000000000\r\n#\r\n# Core dump will be written. Default location: Core dumps may be processed with \"/usr/share/apport/apport -p%p -s%s -c%c -d%d -P%P -u%u -g%g -- %E\" (or dumping to //core.43556)\r\n#\r\n# An error report file with more information is saved as:\r\n# /tmp/hs_err_pid43556.log\r\n{\"@timestamp\":\"2023-03-09T11:30:02,220\",\"level\":\"INFO\",\"thread\":\"main\",\"class\":\"Besu\",\"message\":\"jemalloc library not found, memory usage may be reduced by installing it\",\"throwable\":\"\"}\r\n[thread 43684 also had an error]\r\n[thread 43661 also had an error]\r\n#\r\n# If you would like to submit a bug report, please visit:\r\n#   Unknown\r\n# The crash happened outside the Java Virtual Machine in native code.\r\n# See problematic frame for where to report the bug.\r\n#\r\n```\r\n\r\n\r\n```\r\n#\r\n# A fatal error has been detected by the Java Runtime Environment:\r\n#\r\n#  SIGSEGV (0xb) at pc=0x00007fb64babe649, pid=43180, tid=43319\r\n#\r\n# JRE version: OpenJDK Runtime Environment (17.0.6+10) (build 17.0.6+10-Ubuntu-0ubuntu122.04)\r\n# Java VM: OpenJDK 64-Bit Server VM (17.0.6+10-Ubuntu-0ubuntu122.04, mixed mode, sharing, tiered, compressed oops, compressed class ptrs, g1 gc, linux-amd64)\r\n# Problematic frame:\r\n# C  [librocksdbjni365843090998774722.so+0x4be649][thread 43551 also had an error]\r\n  rocksdb::TableCache::ReleaseHandle(rocksdb::Cache::Handle*)+0x9\r\n#\r\n# Core dump will be written. Default location: Core dumps may be processed with \"/usr/share/apport/apport -p%p -s%s -c%c -d%d -P%P -u%u -g%g -- %E\" (or dumping to //core.43180)\r\n#\r\n# An error report file with more information is saved as:\r\n# /tmp/hs_err_pid43180.log\r\n#\r\n# If you would like to submit a bug report, please visit:\r\n#   Unknown\r\n# The crash happened outside the Java Virtual Machine in native code.\r\n# See problematic frame for where to report the bug.\r\n#\r\n```\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1461894211/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1462052943",
    "html_url": "https://github.com/hyperledger/besu/issues/4829#issuecomment-1462052943",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/4829",
    "id": 1462052943,
    "node_id": "IC_kwDODE2jmc5XJShP",
    "user": {
      "login": "jbonofre",
      "id": 158903,
      "node_id": "MDQ6VXNlcjE1ODkwMw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/158903?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jbonofre",
      "html_url": "https://github.com/jbonofre",
      "followers_url": "https://api.github.com/users/jbonofre/followers",
      "following_url": "https://api.github.com/users/jbonofre/following{/other_user}",
      "gists_url": "https://api.github.com/users/jbonofre/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jbonofre/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jbonofre/subscriptions",
      "organizations_url": "https://api.github.com/users/jbonofre/orgs",
      "repos_url": "https://api.github.com/users/jbonofre/repos",
      "events_url": "https://api.github.com/users/jbonofre/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jbonofre/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-09T13:17:16Z",
    "updated_at": "2023-03-09T13:17:16Z",
    "author_association": "NONE",
    "body": "It sounds like we try to access `ColumnFamilyHandle` while it's closed.",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1462052943/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
