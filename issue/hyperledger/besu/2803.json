{
  "url": "https://api.github.com/repos/hyperledger/besu/issues/2803",
  "repository_url": "https://api.github.com/repos/hyperledger/besu",
  "labels_url": "https://api.github.com/repos/hyperledger/besu/issues/2803/labels{/name}",
  "comments_url": "https://api.github.com/repos/hyperledger/besu/issues/2803/comments",
  "events_url": "https://api.github.com/repos/hyperledger/besu/issues/2803/events",
  "html_url": "https://github.com/hyperledger/besu/issues/2803",
  "id": 1006656769,
  "node_id": "I_kwDODE2jmc48AF0B",
  "number": 2803,
  "title": "Private Transaction Failed when invoke a Public Contract with 2 Indirections",
  "user": {
    "login": "albert0-hernandez",
    "id": 39121047,
    "node_id": "MDQ6VXNlcjM5MTIxMDQ3",
    "avatar_url": "https://avatars.githubusercontent.com/u/39121047?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/albert0-hernandez",
    "html_url": "https://github.com/albert0-hernandez",
    "followers_url": "https://api.github.com/users/albert0-hernandez/followers",
    "following_url": "https://api.github.com/users/albert0-hernandez/following{/other_user}",
    "gists_url": "https://api.github.com/users/albert0-hernandez/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/albert0-hernandez/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/albert0-hernandez/subscriptions",
    "organizations_url": "https://api.github.com/users/albert0-hernandez/orgs",
    "repos_url": "https://api.github.com/users/albert0-hernandez/repos",
    "events_url": "https://api.github.com/users/albert0-hernandez/events{/privacy}",
    "received_events_url": "https://api.github.com/users/albert0-hernandez/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1537362490,
      "node_id": "MDU6TGFiZWwxNTM3MzYyNDkw",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/bug",
      "name": "bug",
      "color": "d73a4a",
      "default": true,
      "description": "Something isn't working"
    },
    {
      "id": 2051683573,
      "node_id": "MDU6TGFiZWwyMDUxNjgzNTcz",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/P3",
      "name": "P3",
      "color": "ffff00",
      "default": false,
      "description": "Medium (ex: JSON-RPC request not working with a specific client library due to loose spec assumtion)"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "antonydenyer",
    "id": 469160,
    "node_id": "MDQ6VXNlcjQ2OTE2MA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/469160?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/antonydenyer",
    "html_url": "https://github.com/antonydenyer",
    "followers_url": "https://api.github.com/users/antonydenyer/followers",
    "following_url": "https://api.github.com/users/antonydenyer/following{/other_user}",
    "gists_url": "https://api.github.com/users/antonydenyer/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/antonydenyer/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/antonydenyer/subscriptions",
    "organizations_url": "https://api.github.com/users/antonydenyer/orgs",
    "repos_url": "https://api.github.com/users/antonydenyer/repos",
    "events_url": "https://api.github.com/users/antonydenyer/events{/privacy}",
    "received_events_url": "https://api.github.com/users/antonydenyer/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "antonydenyer",
      "id": 469160,
      "node_id": "MDQ6VXNlcjQ2OTE2MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/469160?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/antonydenyer",
      "html_url": "https://github.com/antonydenyer",
      "followers_url": "https://api.github.com/users/antonydenyer/followers",
      "following_url": "https://api.github.com/users/antonydenyer/following{/other_user}",
      "gists_url": "https://api.github.com/users/antonydenyer/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/antonydenyer/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/antonydenyer/subscriptions",
      "organizations_url": "https://api.github.com/users/antonydenyer/orgs",
      "repos_url": "https://api.github.com/users/antonydenyer/repos",
      "events_url": "https://api.github.com/users/antonydenyer/events{/privacy}",
      "received_events_url": "https://api.github.com/users/antonydenyer/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2021-09-24T16:56:59Z",
  "updated_at": "2021-09-30T10:34:13Z",
  "closed_at": "2021-09-30T10:34:13Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "### Description\r\nAs an besu developer\r\nI want to deploy a private contract which read from public state with two inderections\r\nso my logic executed correctly according to private state read/write rules.\r\n\r\n\r\n### Acceptance Criteria\r\n* The lastes version of Besu behaves in the similar way to Besu v21.1.5 versions\r\n\r\n### Steps to Reproduce (Bug)\r\n1. Clone the Repository https://github.com/albert0-hernandez/private-to-public-besu-tester.git\r\n2. Follow the Readme steps to install, run & test\r\n3. See that the test labelled as 2.c. failed\r\n\r\n**Expected behavior:** \r\nWith Besu versions up to 21.1.5 the test will succeeded with no problem.\r\n\r\n1. Clone the Repository https://github.com/albert0-hernandez/private-to-public-besu-tester.git\r\n2. Modify the base version of Besu from 21.7.4 to 21.1.5 on hyperledger-besu-tessera-network/config/templates/docker-compose-microservices.yaml\r\n3. Follow the Readme steps to  run & test\r\n3. See that the test labelled by 2.c. succeeded\r\n\r\n**Actual behavior:** \r\nWhen you deploy a configuration of Smartcontracts that chain an execution like:\r\n    Private SC (calls) -> Public SC (calls) -> Public SC \r\nThe execution failed.\r\n\r\n**Frequency:** \r\n100%\r\n\r\n### Versions (Add all that apply)\r\n* Software version: >= 21.1.6 \r\n* Java version: Official Dockerized version\r\n* OS Name & Version: Docker\r\n\r\n### Additional Information\r\nThis behaviour is reproduced migrating a validated fully tested SC solution on 21.1.3 to 21.7.4.\r\nWe created a sample project to better (and simplified) behaviour that we observe after migrating.\r\n\r\n\r\n",
  "closed_by": {
    "login": "antonydenyer",
    "id": 469160,
    "node_id": "MDQ6VXNlcjQ2OTE2MA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/469160?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/antonydenyer",
    "html_url": "https://github.com/antonydenyer",
    "followers_url": "https://api.github.com/users/antonydenyer/followers",
    "following_url": "https://api.github.com/users/antonydenyer/following{/other_user}",
    "gists_url": "https://api.github.com/users/antonydenyer/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/antonydenyer/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/antonydenyer/subscriptions",
    "organizations_url": "https://api.github.com/users/antonydenyer/orgs",
    "repos_url": "https://api.github.com/users/antonydenyer/repos",
    "events_url": "https://api.github.com/users/antonydenyer/events{/privacy}",
    "received_events_url": "https://api.github.com/users/antonydenyer/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/2803/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/hyperledger/besu/issues/2803/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/930218505",
    "html_url": "https://github.com/hyperledger/besu/issues/2803#issuecomment-930218505",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/2803",
    "id": 930218505,
    "node_id": "IC_kwDODE2jmc43cgIJ",
    "user": {
      "login": "antonydenyer",
      "id": 469160,
      "node_id": "MDQ6VXNlcjQ2OTE2MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/469160?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/antonydenyer",
      "html_url": "https://github.com/antonydenyer",
      "followers_url": "https://api.github.com/users/antonydenyer/followers",
      "following_url": "https://api.github.com/users/antonydenyer/following{/other_user}",
      "gists_url": "https://api.github.com/users/antonydenyer/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/antonydenyer/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/antonydenyer/subscriptions",
      "organizations_url": "https://api.github.com/users/antonydenyer/orgs",
      "repos_url": "https://api.github.com/users/antonydenyer/repos",
      "events_url": "https://api.github.com/users/antonydenyer/events{/privacy}",
      "received_events_url": "https://api.github.com/users/antonydenyer/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-09-29T14:14:39Z",
    "updated_at": "2021-09-29T14:18:07Z",
    "author_association": "MEMBER",
    "body": "The bug is actually related to value transfer.\r\n\r\nUser → PrivateContract → PublicContract1 → PublicContract2\r\n\r\nInterestingly when the PrivateContract is executed a mutable account is acquired for the PrivateContract then a mutable account is acquired for the PublicContract1 address. This is in preparation for transferring value between accounts, even if the value is zero. Interestingly the PublicContract1 address that is being acquired is actually an address in the private world state! This works because the call is to  `getOrCreate`. \r\n\r\nThen when the PublicContract1 goes to call PublicContract2 it attempts to acquire a mutable account in the public world state which it is not allowed to do. An exception is thrown and the transaction is reverted.\r\n\r\nGiven that we are not transferring value from private to public state we can put some better guards in place so that the `MessageCallProcessor` does not need to acquire a mutable account.\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/930218505/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
