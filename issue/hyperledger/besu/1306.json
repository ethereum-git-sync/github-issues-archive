{
  "url": "https://api.github.com/repos/hyperledger/besu/issues/1306",
  "repository_url": "https://api.github.com/repos/hyperledger/besu",
  "labels_url": "https://api.github.com/repos/hyperledger/besu/issues/1306/labels{/name}",
  "comments_url": "https://api.github.com/repos/hyperledger/besu/issues/1306/comments",
  "events_url": "https://api.github.com/repos/hyperledger/besu/issues/1306/events",
  "html_url": "https://github.com/hyperledger/besu/issues/1306",
  "id": 678398145,
  "node_id": "MDU6SXNzdWU2NzgzOTgxNDU=",
  "number": 1306,
  "title": "Allow sub commands access to options and functionality that are currently private within BesuCommand",
  "user": {
    "login": "brianmcgee",
    "id": 1173648,
    "node_id": "MDQ6VXNlcjExNzM2NDg=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1173648?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/brianmcgee",
    "html_url": "https://github.com/brianmcgee",
    "followers_url": "https://api.github.com/users/brianmcgee/followers",
    "following_url": "https://api.github.com/users/brianmcgee/following{/other_user}",
    "gists_url": "https://api.github.com/users/brianmcgee/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/brianmcgee/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/brianmcgee/subscriptions",
    "organizations_url": "https://api.github.com/users/brianmcgee/orgs",
    "repos_url": "https://api.github.com/users/brianmcgee/repos",
    "events_url": "https://api.github.com/users/brianmcgee/events{/privacy}",
    "received_events_url": "https://api.github.com/users/brianmcgee/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1537362496,
      "node_id": "MDU6TGFiZWwxNTM3MzYyNDk2",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/enhancement",
      "name": "enhancement",
      "color": "a2eeef",
      "default": true,
      "description": "New feature or request"
    },
    {
      "id": 2129007612,
      "node_id": "MDU6TGFiZWwyMTI5MDA3NjEy",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/dev%20experience",
      "name": "dev experience",
      "color": "2a0b89",
      "default": false,
      "description": "The build system, things that enable easier development etc."
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 6,
  "created_at": "2020-08-13T12:28:07Z",
  "updated_at": "2021-09-15T13:48:55Z",
  "closed_at": "2021-09-15T13:46:37Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Description \r\n\r\nAs someone writing plugins with their own sub commands, I would like access to much of the private properties and functionality within `BesuCommand`.\r\n\r\nExtending the Besu cli functionality with sub commands is possible by providing a mixin via the `PicoCLIOptions` service on registration. However when those sub commands execute, they do not have access to things such as the base cli options `dataPath`, `network` and so on that are specified in `BesuCommand` but which are currently private. In addition, the run method for `BesuCommand` performs some useful initialisation using internal builders and other state. \r\n\r\nIdeally there would be some way for sub commands to re-use the base initialisation code and common cli options as well as use services they have registered via their own plugin. \r\n\r\nI can understand why the cli options are currently private since they are required to be mutable in order to function properly with PicoCli. Perhaps they can be exposed in a read-only fashion via a service within the plugin context. \r\n\r\nIf this were to be the case, then the plugin context would need to be initialised before a sub command executes. Which would require some way of re-using `BesuCommand` to perform this initialisation before continuing with the execution of the sub command run method.\r\n\r\nIf an approach is agreed upon I would happy to implement it as this is currently a blocker for me. ",
  "closed_by": {
    "login": "vmichalik",
    "id": 12459761,
    "node_id": "MDQ6VXNlcjEyNDU5NzYx",
    "avatar_url": "https://avatars.githubusercontent.com/u/12459761?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/vmichalik",
    "html_url": "https://github.com/vmichalik",
    "followers_url": "https://api.github.com/users/vmichalik/followers",
    "following_url": "https://api.github.com/users/vmichalik/following{/other_user}",
    "gists_url": "https://api.github.com/users/vmichalik/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/vmichalik/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/vmichalik/subscriptions",
    "organizations_url": "https://api.github.com/users/vmichalik/orgs",
    "repos_url": "https://api.github.com/users/vmichalik/repos",
    "events_url": "https://api.github.com/users/vmichalik/events{/privacy}",
    "received_events_url": "https://api.github.com/users/vmichalik/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/1306/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/hyperledger/besu/issues/1306/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/674554829",
    "html_url": "https://github.com/hyperledger/besu/issues/1306#issuecomment-674554829",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/1306",
    "id": 674554829,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY3NDU1NDgyOQ==",
    "user": {
      "login": "brianmcgee",
      "id": 1173648,
      "node_id": "MDQ6VXNlcjExNzM2NDg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1173648?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/brianmcgee",
      "html_url": "https://github.com/brianmcgee",
      "followers_url": "https://api.github.com/users/brianmcgee/followers",
      "following_url": "https://api.github.com/users/brianmcgee/following{/other_user}",
      "gists_url": "https://api.github.com/users/brianmcgee/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/brianmcgee/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/brianmcgee/subscriptions",
      "organizations_url": "https://api.github.com/users/brianmcgee/orgs",
      "repos_url": "https://api.github.com/users/brianmcgee/repos",
      "events_url": "https://api.github.com/users/brianmcgee/events{/privacy}",
      "received_events_url": "https://api.github.com/users/brianmcgee/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-08-16T17:35:09Z",
    "updated_at": "2020-08-16T17:43:04Z",
    "author_association": "NONE",
    "body": "In the draft PR I've added the `BesuConfiguration` service to the plugin context during the prepare plugins phase, instead of later as part of the run method of `BesuCommand`. \r\n\r\nIn addition I made the plugin context public. This means you can now access the plugin context through the user object available in the top most parent command that you can access via the command spec property. \r\n\r\nI've tested this with a local snapshot version:\r\n\r\n```kotlin\r\n@Command(\r\n  name = \"replication\",\r\n  subcommands = [\r\n    ReplicationRestoreCommand::class,\r\n    ReplicationExportCommand::class\r\n  ],\r\n  description = [\"Replication of your Besu key/value storage for incremental backup and read only replicas.\"]\r\n)\r\nclass ReplicationSubCommand : Runnable {\r\n\r\n  @Spec\r\n  private lateinit var spec: CommandSpec\r\n\r\n  val besuCommand: BesuCommand by lazy {\r\n    spec.parent().userObject() as BesuCommand\r\n  }\r\n\r\n  val pluginContext: BesuContext by lazy { besuCommand.context }\r\n\r\n  val storageService: StorageService by lazy {\r\n    pluginContext\r\n      .getService(StorageService::class.java)\r\n      .orElseThrow { IllegalStateException(\"Storage service not found in plugin context\") }\r\n  }\r\n\r\n  val besuConfig: BesuConfiguration by lazy {\r\n    pluginContext\r\n      .getService(BesuConfiguration::class.java)\r\n      .orElseThrow { IllegalStateException(\"Besu configuration not found in plugin context\") }\r\n  }\r\n  ...\r\n}\r\n\r\n```\r\n\r\nIn addition I modified the `StorageService` to be able to return the configured key value storage factory. \r\n\r\nI feel that having the `BesuConfiguration` and configured storage factory available for sub commands is useful, but admittedly this is heavily skewed towards my own use case at the moment.\r\n\r\nAdditional changes I think would be worthwhile are adding a `EthConfiguration` service, which makes available the genesis config and network id. Both are useful pieces of information, but again I recognize this is skewed towards my own use cases.\r\n\r\nAs for the other config options currently private within `BesuCommand`, on further inspection there isn't much else that I believe would be useful to expose.\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/674554829/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/686125593",
    "html_url": "https://github.com/hyperledger/besu/issues/1306#issuecomment-686125593",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/1306",
    "id": 686125593,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY4NjEyNTU5Mw==",
    "user": {
      "login": "shemnon",
      "id": 38109,
      "node_id": "MDQ6VXNlcjM4MTA5",
      "avatar_url": "https://avatars.githubusercontent.com/u/38109?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/shemnon",
      "html_url": "https://github.com/shemnon",
      "followers_url": "https://api.github.com/users/shemnon/followers",
      "following_url": "https://api.github.com/users/shemnon/following{/other_user}",
      "gists_url": "https://api.github.com/users/shemnon/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/shemnon/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/shemnon/subscriptions",
      "organizations_url": "https://api.github.com/users/shemnon/orgs",
      "repos_url": "https://api.github.com/users/shemnon/repos",
      "events_url": "https://api.github.com/users/shemnon/events{/privacy}",
      "received_events_url": "https://api.github.com/users/shemnon/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-09-02T23:50:54Z",
    "updated_at": "2020-09-02T23:50:54Z",
    "author_association": "MEMBER",
    "body": "I think it can be configured without the need for the CLI interceptor.  Will #1358 address the issue?  (It just contains the `BesuConfigurationService` changes)",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/686125593/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/687130868",
    "html_url": "https://github.com/hyperledger/besu/issues/1306#issuecomment-687130868",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/1306",
    "id": 687130868,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY4NzEzMDg2OA==",
    "user": {
      "login": "brianmcgee",
      "id": 1173648,
      "node_id": "MDQ6VXNlcjExNzM2NDg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1173648?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/brianmcgee",
      "html_url": "https://github.com/brianmcgee",
      "followers_url": "https://api.github.com/users/brianmcgee/followers",
      "following_url": "https://api.github.com/users/brianmcgee/following{/other_user}",
      "gists_url": "https://api.github.com/users/brianmcgee/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/brianmcgee/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/brianmcgee/subscriptions",
      "organizations_url": "https://api.github.com/users/brianmcgee/orgs",
      "repos_url": "https://api.github.com/users/brianmcgee/repos",
      "events_url": "https://api.github.com/users/brianmcgee/events{/privacy}",
      "received_events_url": "https://api.github.com/users/brianmcgee/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-09-04T13:03:30Z",
    "updated_at": "2020-09-04T13:03:30Z",
    "author_association": "NONE",
    "body": "Earlier initialisation of the `BesuConfigurationService` would definitely help. I also saw that Pico cli has been updated to 4.5.0 which I think brings in some other possibilities. I'll wait for #1358 to be merged and then have a play around, see what edge cases remain. ",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/687130868/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/697723830",
    "html_url": "https://github.com/hyperledger/besu/issues/1306#issuecomment-697723830",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/1306",
    "id": 697723830,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY5NzcyMzgzMA==",
    "user": {
      "login": "timbeiko",
      "id": 9390255,
      "node_id": "MDQ6VXNlcjkzOTAyNTU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9390255?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/timbeiko",
      "html_url": "https://github.com/timbeiko",
      "followers_url": "https://api.github.com/users/timbeiko/followers",
      "following_url": "https://api.github.com/users/timbeiko/following{/other_user}",
      "gists_url": "https://api.github.com/users/timbeiko/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/timbeiko/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/timbeiko/subscriptions",
      "organizations_url": "https://api.github.com/users/timbeiko/orgs",
      "repos_url": "https://api.github.com/users/timbeiko/repos",
      "events_url": "https://api.github.com/users/timbeiko/events{/privacy}",
      "received_events_url": "https://api.github.com/users/timbeiko/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-09-23T17:14:39Z",
    "updated_at": "2020-09-23T17:14:39Z",
    "author_association": "CONTRIBUTOR",
    "body": "FYI @brianmcgee #1358 has been merged 😄 ",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/697723830/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/899108378",
    "html_url": "https://github.com/hyperledger/besu/issues/1306#issuecomment-899108378",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/1306",
    "id": 899108378,
    "node_id": "IC_kwDODE2jmc41l04a",
    "user": {
      "login": "vmichalik",
      "id": 12459761,
      "node_id": "MDQ6VXNlcjEyNDU5NzYx",
      "avatar_url": "https://avatars.githubusercontent.com/u/12459761?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vmichalik",
      "html_url": "https://github.com/vmichalik",
      "followers_url": "https://api.github.com/users/vmichalik/followers",
      "following_url": "https://api.github.com/users/vmichalik/following{/other_user}",
      "gists_url": "https://api.github.com/users/vmichalik/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vmichalik/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vmichalik/subscriptions",
      "organizations_url": "https://api.github.com/users/vmichalik/orgs",
      "repos_url": "https://api.github.com/users/vmichalik/repos",
      "events_url": "https://api.github.com/users/vmichalik/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vmichalik/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-08-15T20:53:44Z",
    "updated_at": "2021-08-15T20:53:44Z",
    "author_association": "NONE",
    "body": "Hey @brianmcgee, appreciate it is almost a year later, but just wanted to see if the above thread resolved your issue? If so please go ahead and close the issue :-)",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/899108378/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/920033662",
    "html_url": "https://github.com/hyperledger/besu/issues/1306#issuecomment-920033662",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/1306",
    "id": 920033662,
    "node_id": "IC_kwDODE2jmc421pl-",
    "user": {
      "login": "vmichalik",
      "id": 12459761,
      "node_id": "MDQ6VXNlcjEyNDU5NzYx",
      "avatar_url": "https://avatars.githubusercontent.com/u/12459761?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vmichalik",
      "html_url": "https://github.com/vmichalik",
      "followers_url": "https://api.github.com/users/vmichalik/followers",
      "following_url": "https://api.github.com/users/vmichalik/following{/other_user}",
      "gists_url": "https://api.github.com/users/vmichalik/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vmichalik/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vmichalik/subscriptions",
      "organizations_url": "https://api.github.com/users/vmichalik/orgs",
      "repos_url": "https://api.github.com/users/vmichalik/repos",
      "events_url": "https://api.github.com/users/vmichalik/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vmichalik/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-09-15T13:46:37Z",
    "updated_at": "2021-09-15T13:46:37Z",
    "author_association": "NONE",
    "body": "please go ahead and reopen or create a new ticket if you have further issues!",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/920033662/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
