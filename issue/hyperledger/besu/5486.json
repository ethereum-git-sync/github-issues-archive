{
  "url": "https://api.github.com/repos/hyperledger/besu/issues/5486",
  "repository_url": "https://api.github.com/repos/hyperledger/besu",
  "labels_url": "https://api.github.com/repos/hyperledger/besu/issues/5486/labels{/name}",
  "comments_url": "https://api.github.com/repos/hyperledger/besu/issues/5486/comments",
  "events_url": "https://api.github.com/repos/hyperledger/besu/issues/5486/events",
  "html_url": "https://github.com/hyperledger/besu/issues/5486",
  "id": 1722802622,
  "node_id": "I_kwDODE2jmc5mr-G-",
  "number": 5486,
  "title": "Memory leak on latest version `23.4.0`",
  "user": {
    "login": "ibhagwan",
    "id": 59988195,
    "node_id": "MDQ6VXNlcjU5OTg4MTk1",
    "avatar_url": "https://avatars.githubusercontent.com/u/59988195?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ibhagwan",
    "html_url": "https://github.com/ibhagwan",
    "followers_url": "https://api.github.com/users/ibhagwan/followers",
    "following_url": "https://api.github.com/users/ibhagwan/following{/other_user}",
    "gists_url": "https://api.github.com/users/ibhagwan/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ibhagwan/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ibhagwan/subscriptions",
    "organizations_url": "https://api.github.com/users/ibhagwan/orgs",
    "repos_url": "https://api.github.com/users/ibhagwan/repos",
    "events_url": "https://api.github.com/users/ibhagwan/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ibhagwan/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3013559202,
      "node_id": "MDU6TGFiZWwzMDEzNTU5MjAy",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/mainnet",
      "name": "mainnet",
      "color": "9D578C",
      "default": false,
      "description": ""
    },
    {
      "id": 4328706977,
      "node_id": "LA_kwDODE2jmc8AAAABAgLToQ",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/TeamChupa",
      "name": "TeamChupa",
      "color": "fbca04",
      "default": false,
      "description": "GH issues worked on by Chupacabara Team"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 9,
  "created_at": "2023-05-23T21:20:40Z",
  "updated_at": "2023-05-30T15:53:56Z",
  "closed_at": "2023-05-30T15:53:56Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "<!-- Have you done the following? -->\r\n<!--   * read the Code of Conduct? By filing an Issue, you are expected to -->  \r\n<!--     comply with it, including treating everyone with respect: -->\r\n<!--     https://github.com/hyperledger/besu/blob/main/CODE_OF_CONDUCT.md -->\r\n<!--   * Reproduced the issue in the latest version of the software -->\r\n<!--   * Read the debugging docs: https://besu.hyperledger.org/en/stable/HowTo/Monitor/Logging/ -->\r\n<!--   * Duplicate Issue check:  https://github.com/search?q=+is%3Aissue+repo%3Ahyperledger/Besu -->\r\n<!-- Note:  Not all sections will apply to all issue types. -->\r\n\r\n### Description\r\nMemory leak in latest version `v23.4.0`\r\n\r\n### Steps to Reproduce (Bug)\r\nUse latest version for long enough on a 16GB RAM machine and the process crashes due to OOM\r\n\r\n**Frequency:** **Every run.**\r\n\r\n### Logs (if a bug)\r\nAfter running for a while without restart (on my machine that's about 72hrs) the process crashes with the following log in `dmesg`:\r\n```\r\n[1209583.155590] oom-kill:constraint=CONSTRAINT_NONE,nodemask=(null),cpuset=/,mems_allowed=0,global_oom,task_memcg=/,task=java,pid=25889,uid=1001\r\n[1209583.155668] Out of memory: Killed process 25889 (java) total-vm:39405432kB, anon-rss:13172692kB, file-rss:0kB, shmem-rss:10228kB, UID:1001 pgtables:71072kB oom_score_adj:0\r\n[1209585.951105] oom_reaper: reaped process 25889 (java), now anon-rss:0kB, file-rss:0kB, shmem-rss:0kB\r\n```\r\n\r\n### Versions (Add all that apply)\r\n* Software version: [`besu --version`]\r\n  `besu/v23.4.0/linux-x86_64/openjdk-java-17`\r\n* Java version: [`java -version`]\r\n```\r\nopenjdk 17.0.5 2022-10-18\r\nOpenJDK Runtime Environment (build 17.0.5+7-void-r1)\r\nOpenJDK 64-Bit Server VM (build 17.0.5+7-void-r1, mixed mode, sharing)\r\n```\r\n* OS Name & Version: [`cat /etc/*release`]\r\n```\r\nNAME=\"Void\"\r\nID=\"void\"\r\nPRETTY_NAME=\"Void Linux\"\r\nHOME_URL=\"https://voidlinux.org/\"\r\nDOCUMENTATION_URL=\"https://docs.voidlinux.org/\"\r\nLOGO=\"void-logo\"\r\nANSI_COLOR=\"0;38;2;71;128;97\"\r\n\r\nDISTRIB_ID=\"void\"\r\n```\r\n* Kernel Version: [`uname -a`]\r\n```\r\nLinux istake 6.1.14_1 #1 SMP PREEMPT_DYNAMIC Mon Feb 27 15:21:49 UTC 2023 x86_64 GNU/Linux\r\n```\r\n* Consensus Client & Version if using Proof of Stake: [e.g. Teku, Lighthouse, Prysm, Nimbus, Lodestar]\r\n```\r\nNimbus beacon node v23.5.0-40253a-stateofus\r\nCopyright (c) 2019-2023 Status Research & Development GmbH\r\n\r\neth2 specification v1.3.0\r\n\r\nNim Compiler Version 1.6.12 [Linux: amd64]\r\n```\r\n\r\n\r\n### Additional Information (Add any of the following or anything else that may be relevant)\r\n* Besu setup info - genesis file, config options\r\n> running the process with `JAVA_OPTS=-Xmx5g`\r\n```\r\nsync-mode = \"X_CHECKPOINT\"\r\nnetwork = \"MAINNET\"\r\np2p-enabled = true\r\np2p-port = 30303\r\nhost-allowlist = [ \"localhost\", \"127.0.0.1\", \"::1\" ]\r\nrpc-http-enabled = true\r\nrpc-http-port = 8545\r\nrpc-http-host = \"0.0.0.0\"\r\nrpc-http-cors-origins = [ \"*\" ]\r\nrpc-http-api=[\"ADMIN\",\"ETH\",\"NET\",\"DEBUG\",\"TXPOOL\",\"WEB3\"]\r\nrpc-ws-enabled = true\r\nrpc-ws-port = 8546\r\nrpc-ws-host = \"0.0.0.0\"\r\nengine-jwt-enabled = true\r\nengine-jwt-secret = \"/var/lib/eth/jwtsecret\"\r\nengine-rpc-enabled = true\r\nengine-rpc-port = 8551\r\nengine-host-allowlist = [ \"localhost\", \"127.0.0.1\", \"::1\" ]\r\ngraphql-http-enabled = true\r\ngraphql-http-host = \"0.0.0.0\"\r\ngraphql-http-port = 8547\r\ngraphql-http-cors-origins = [ \"*\" ]\r\ndata-storage-format = \"BONSAI\"\r\ndata-path = \"/data/besu/mainnet\"\r\nXplugin-rocksdb-high-spec-enabled = true\r\n```\r\n* System info - memory, CPU\r\n16GB RAM\r\n\r\n### This didn't happen with the `23.3.x` versions",
  "closed_by": {
    "login": "ibhagwan",
    "id": 59988195,
    "node_id": "MDQ6VXNlcjU5OTg4MTk1",
    "avatar_url": "https://avatars.githubusercontent.com/u/59988195?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ibhagwan",
    "html_url": "https://github.com/ibhagwan",
    "followers_url": "https://api.github.com/users/ibhagwan/followers",
    "following_url": "https://api.github.com/users/ibhagwan/following{/other_user}",
    "gists_url": "https://api.github.com/users/ibhagwan/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ibhagwan/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ibhagwan/subscriptions",
    "organizations_url": "https://api.github.com/users/ibhagwan/orgs",
    "repos_url": "https://api.github.com/users/ibhagwan/repos",
    "events_url": "https://api.github.com/users/ibhagwan/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ibhagwan/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/5486/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/hyperledger/besu/issues/5486/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1561644773",
    "html_url": "https://github.com/hyperledger/besu/issues/5486#issuecomment-1561644773",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/5486",
    "id": 1561644773,
    "node_id": "IC_kwDODE2jmc5dFM7l",
    "user": {
      "login": "non-fungible-nelson",
      "id": 85905982,
      "node_id": "MDQ6VXNlcjg1OTA1OTgy",
      "avatar_url": "https://avatars.githubusercontent.com/u/85905982?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/non-fungible-nelson",
      "html_url": "https://github.com/non-fungible-nelson",
      "followers_url": "https://api.github.com/users/non-fungible-nelson/followers",
      "following_url": "https://api.github.com/users/non-fungible-nelson/following{/other_user}",
      "gists_url": "https://api.github.com/users/non-fungible-nelson/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/non-fungible-nelson/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/non-fungible-nelson/subscriptions",
      "organizations_url": "https://api.github.com/users/non-fungible-nelson/orgs",
      "repos_url": "https://api.github.com/users/non-fungible-nelson/repos",
      "events_url": "https://api.github.com/users/non-fungible-nelson/events{/privacy}",
      "received_events_url": "https://api.github.com/users/non-fungible-nelson/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-24T17:15:49Z",
    "updated_at": "2023-05-24T17:15:49Z",
    "author_association": "CONTRIBUTOR",
    "body": "Can you provide metrics view for this? especially if you have grafana metrics for before the OOM. And Nimbus as well. Do you have logs around OOM time from EL + CL? Curious if this is occurring nearby a re-org ",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1561644773/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1561667707",
    "html_url": "https://github.com/hyperledger/besu/issues/5486#issuecomment-1561667707",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/5486",
    "id": 1561667707,
    "node_id": "IC_kwDODE2jmc5dFSh7",
    "user": {
      "login": "ibhagwan",
      "id": 59988195,
      "node_id": "MDQ6VXNlcjU5OTg4MTk1",
      "avatar_url": "https://avatars.githubusercontent.com/u/59988195?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ibhagwan",
      "html_url": "https://github.com/ibhagwan",
      "followers_url": "https://api.github.com/users/ibhagwan/followers",
      "following_url": "https://api.github.com/users/ibhagwan/following{/other_user}",
      "gists_url": "https://api.github.com/users/ibhagwan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ibhagwan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ibhagwan/subscriptions",
      "organizations_url": "https://api.github.com/users/ibhagwan/orgs",
      "repos_url": "https://api.github.com/users/ibhagwan/repos",
      "events_url": "https://api.github.com/users/ibhagwan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ibhagwan/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-24T17:29:54Z",
    "updated_at": "2023-05-26T17:44:29Z",
    "author_association": "NONE",
    "body": "> Can you provide metrics view for this? especially if you have grafana metrics for before the OOM. And Nimbus as well. Do you have logs around OOM time from EL + CL? Curious if this is occurring nearby a re-org\r\n\r\nUnfortuntely I don't have metrics enabled nor do I use grafana.\r\n\r\nHere's the EL log when the process crashed (and the following restart), nothing out of the ordinary prior to the crash:\r\n```\r\n2023-05-22 04:57:25.435-04:00 | vert.x-worker-thread-0 | INFO  | AbstractEngineForkchoiceUpdated | VALID for fork-choice-update: head: 0xf89a3d19abf40ad803d73709676796c49e33e94b790a932099e3bfe7b02b0f5f, finalized: 0x73b7520a25d8b77961579132cc26d1879f2b1f14b1be8dccbc9d170b4e188f69, safeBlockHash: 0x6553fe2a10473a65096e8f95c81706e719f7cb90cac2469c570924c43924b37e\r\n2023-05-22 04:57:37.508-04:00 | vert.x-worker-thread-0 | INFO  | AbstractEngineNewPayload | Imported #17,313,793 / 134 tx / 16 ws / base fee 31.31 gwei / 17,317,993 (57.7%) gas / (0x63c21a08ed4658e26a5ffff839ee90156a3c3a4be7663bae3369805f3f0ae10c) in 0.785s. Peers: 25\r\n2023-05-22 04:57:49.120-04:00 | vert.x-worker-thread-0 | INFO  | AbstractEngineNewPayload | Imported #17,313,794 / 157 tx / 16 ws / base fee 31.91 gwei / 15,819,168 (52.7%) gas / (0xcedd9c41baabb544e8ab83908cebd7a13834e45268a688365ee06162d3a3cc23) in 0.548s. Peers: 25\r\n2023-05-22 04:58:01.771-04:00 | vert.x-worker-thread-0 | INFO  | AbstractEngineNewPayload | Imported #17,313,795 / 138 tx / 16 ws / base fee 32.13 gwei / 13,696,808 (45.7%) gas / (0x41aa411d3987198e91a6877cfcd20baed8889512389dc2afb22c350f9fe4dd05) in 0.453s. Peers: 25\r\n2023-05-22 04:58:12.754-04:00 | vert.x-worker-thread-0 | INFO  | AbstractEngineNewPayload | Imported #17,313,796 / 136 tx / 16 ws / base fee 31.78 gwei / 10,809,734 (36.0%) gas / (0x821902286256d093d30b6db6adf08ce8488f91f38714e51e09b72646fea5ebe0) in 0.440s. Peers: 25\r\n2023-05-22 04:58:25.533-04:00 | vert.x-worker-thread-0 | INFO  | AbstractEngineNewPayload | Imported #17,313,797 / 159 tx / 16 ws / base fee 30.67 gwei / 19,025,601 (63.4%) gas / (0xd0d40e61f42d631c199ebc24dcc30bac034998af486cfe4be92475701eae2cf7) in 0.608s. Peers: 25\r\n2023-05-22 04:58:25.818-04:00 | vert.x-worker-thread-0 | INFO  | AbstractEngineForkchoiceUpdated | VALID for fork-choice-update: head: 0xd0d40e61f42d631c199ebc24dcc30bac034998af486cfe4be92475701eae2cf7, finalized: 0x73b7520a25d8b77961579132cc26d1879f2b1f14b1be8dccbc9d170b4e188f69, safeBlockHash: 0x6553fe2a10473a65096e8f95c81706e719f7cb90cac2469c570924c43924b37e\r\n2023-05-22 04:58:36.581-04:00 | vert.x-worker-thread-0 | INFO  | AbstractEngineNewPayload | Imported #17,313,798 / 122 tx / 16 ws / base fee 31.70 gwei / 9,049,995 (30.2%) gas / (0x350acff7f7677feed9e91eeac86d07b76fdafc8b10382a22fbba4dac08894420) in 0.388s. Peers: 25\r\n2023-05-22 04:58:49.448-04:00 | vert.x-worker-thread-0 | INFO  | AbstractEngineNewPayload | Imported #17,313,799 / 132 tx / 16 ws / base fee 30.13 gwei / 13,677,086 (45.6%) gas / (0x6342a0be93a98cd3c8be7ca6016efbd1ccd08422dc3ee66db9e5c33c2a54167d) in 0.516s. Peers: 25\r\n2023-05-22 04:59:02.148-04:00 | vert.x-worker-thread-0 | INFO  | AbstractEngineNewPayload | Imported #17,313,800 / 145 tx / 16 ws / base fee 29.80 gwei / 13,510,531 (45.0%) gas / (0x92e1384380abebf848ef3f3662fb07452bf317b774bd8ac780933fca1bc2fc87) in 0.502s. Peers: 25\r\n2023-05-22 04:59:13.916-04:00 | vert.x-worker-thread-0 | INFO  | AbstractEngineNewPayload | Imported #17,313,801 / 163 tx / 16 ws / base fee 29.43 gwei / 19,972,771 (66.6%) gas / (0x8db991773f06902ef616924be42886e7b71aa02105e79833a2b7bee0606c7bb7) in 0.943s. Peers: 25\r\n2023-05-22 04:59:25.222-04:00 | vert.x-worker-thread-0 | INFO  | AbstractEngineNewPayload | Imported #17,313,802 / 108 tx / 16 ws / base fee 30.65 gwei / 9,422,470 (31.4%) gas / (0x99bf48dae6631e9b007fbbc3580e5e8f9934c67571d05f1be1c396305bc9f517) in 0.373s. Peers: 25\r\nKilled\r\nbhagwan@istake ~ took 2d19h13m19s ❯\r\nbhagwan@istake ~ ❯\r\nbhagwan@istake ~ ❯ sudo /var/lib/besu/mainnet/run.sh\r\nPassword:\r\n2023-05-22 08:29:06.567-04:00 | main | INFO  | Besu | Starting Besu\r\n2023-05-22 08:29:06.975-04:00 | main | INFO  | Besu |\r\n####################################################################################################\r\n#                                                                                                  #\r\n# Besu version 23.4.0                                                                              #\r\n#                                                                                                  #\r\n# Configuration:                                                                                   #\r\n# Network: Mainnet                                                                                 #\r\n# Network Id: 1                                                                                    #\r\n# Data storage: Bonsai                                                                             #\r\n# Sync mode: Checkpoint                                                                            #\r\n# RPC HTTP APIs: ADMIN,ETH,NET,DEBUG,TXPOOL,WEB3                                                   #\r\n# RPC HTTP port: 8545                                                                              #\r\n# Engine APIs: ENGINE,ETH                                                                          #\r\n# Engine port: 8551                                                                                #\r\n# Engine JWT: /var/lib/eth/jwtsecret                                                               #\r\n# High spec configuration enabled                                                                  #\r\n#                                                                                                  #\r\n# Host:                                                                                            #\r\n# Java: openjdk-java-17                                                                            #\r\n# Maximum heap size: 5.00 GB                                                                       #\r\n# OS: linux-x86_64                                                                                 #\r\n# glibc: 2.36                                                                                      #\r\n# jemalloc: 5.2.1-0-gea6b3e973b477b8061e0076bb257dbd7f3faa756                                      #\r\n# Total memory: 15.63 GB                                                                           #\r\n# CPU cores: 4                                                                                     #\r\n#                                                                                                  #\r\n####################################################################################################\r\n```\r\n\r\nCorresponding CL log:\r\n```\r\nINF 2023-05-22 04:58:35.000-04:00 Slot start                                 topics=\"beacnde\" slot=6493491 epoch=202921 sync=synced peers=160 head=f1941a17:6493490 finalized=202919:29607c9e delay=188us889ns\r\nINF 2023-05-22 04:58:43.060-04:00 Slot end                                   topics=\"beacnde\" slot=6493491 nextActionWait=39s939ms43us930ns nextAttestationSlot=6493495 nextProposalSlot=-1 syncCommitteeDuties=none head=ae309f23:6493491\r\nINF 2023-05-22 04:58:47.001-04:00 Slot start                                 topics=\"beacnde\" slot=6493492 epoch=202921 sync=synced peers=160 head=ae309f23:6493491 finalized=202919:29607c9e delay=1ms20us551ns\r\nINF 2023-05-22 04:58:55.115-04:00 Slot end                                   topics=\"beacnde\" slot=6493492 nextActionWait=27s884ms180us422ns nextAttestationSlot=6493495 nextProposalSlot=-1 syncCommitteeDuties=none head=fcced50d:6493492\r\nINF 2023-05-22 04:58:59.000-04:00 Slot start                                 topics=\"beacnde\" slot=6493493 epoch=202921 sync=synced peers=160 head=fcced50d:6493492 finalized=202919:29607c9e delay=388us709ns\r\nINF 2023-05-22 04:59:07.064-04:00 Slot end                                   topics=\"beacnde\" slot=6493493 nextActionWait=15s935ms168us481ns nextAttestationSlot=6493495 nextProposalSlot=-1 syncCommitteeDuties=none head=01d074b3:6493493\r\nINF 2023-05-22 04:59:11.000-04:00 Slot start                                 topics=\"beacnde\" slot=6493494 epoch=202921 sync=synced peers=160 head=01d074b3:6493493 finalized=202919:29607c9e delay=981us504ns\r\nINF 2023-05-22 04:59:19.089-04:00 Slot end                                   topics=\"beacnde\" slot=6493494 nextActionWait=3s910ms548us890ns nextAttestationSlot=6493495 nextProposalSlot=-1 syncCommitteeDuties=none head=45298e8e:6493494\r\nINF 2023-05-22 04:59:23.001-04:00 Slot start                                 topics=\"beacnde\" slot=6493495 epoch=202921 sync=synced peers=160 head=45298e8e:6493494 finalized=202919:29607c9e delay=1ms20us72ns\r\nINF 2023-05-22 04:59:31.061-04:00 Slot end                                   topics=\"beacnde\" slot=6493495 nextActionWait=3s938ms745us330ns nextAttestationSlot=6493496 nextProposalSlot=-1 syncCommitteeDuties=none head=c5d23484:6493495\r\nINF 2023-05-22 04:59:35.000-04:00 Slot start                                 topics=\"beacnde\" slot=6493496 epoch=202921 sync=synced peers=160 head=c5d23484:6493495 finalized=202919:29607c9e delay=37us528ns\r\nINF 2023-05-22 05:01:19.122-04:00 Missed multiple heartbeats                 topics=\"libp2p gossipsub\" heartbeat=GossipSub delay=1m37s916ms473us197ns hinterval=700ms\r\nWRN 2023-05-22 05:01:19.130-04:00 Connection to EL node degraded             topics=\"elmon\" url=http://127.0.0.1:8551 failedRequest=newPayload statusCode=0 err=\"Request timed out\"\r\nINF 2023-05-22 05:01:19.148-04:00 Missed multiple heartbeats                 topics=\"libp2p gossipsub\" heartbeat=\"Gossipsub scoring\" delay=1m17s430ms72us84ns hinterval=12s\r\nINF 2023-05-22 05:01:19.191-04:00 Slot end                                   topics=\"beacnde\" slot=6493496 nextActionWait= nextAttestationSlot=6493502 nextProposalSlot=-1 syncCommitteeDuties=none head=c5d23484:6493495\r\nNOT 2023-05-22 05:01:19.399-04:00 Missed expected slot start, catching up    topics=\"beacnde\" delay=1m32s399ms623us321ns curSlot=6493496 nextSlot=6493496\r\nINF 2023-05-22 05:01:19.399-04:00 Slot start                                 topics=\"beacnde\" slot=6493504 epoch=202922 sync=synced peers=160 head=c5d23484:6493495 finalized=202919:29607c9e delay=1m32s399ms623us321ns\r\nINF 2023-05-22 05:01:19.422-04:00 Execution client not in sync; skipping validator duties for now topics=\"beacval\" slot=6493504 headSlot=6493496\r\nINF 2023-05-22 05:01:19.584-04:00 Slot end                                   topics=\"beacnde\" slot=6493504 nextActionWait=39s415ms767us162ns nextAttestationSlot=6493508 nextProposalSlot=-1 syncCommitteeDuties=none head=d67c6925:6493496\r\nWRN 2023-05-22 05:01:19.718-04:00 Failed to obtain the latest block from the EL topics=\"elmon\" err=Timeout url=http://127.0.0.1:8551\r\nWRN 2023-05-22 05:01:19.931-04:00 Failed to exchange transition configuration topics=\"elmon\" url=http://127.0.0.1:8551 err=\"Failed to send POST Request with JSON-RPC: Could not read response headers\"\r\nINF 2023-05-22 05:01:23.855-04:00 State replayed                             topics=\"chaindag\" blocks=0 slots=1 current=4b305fa3:6493503 ancestor=4b305fa3:6493503 target=4b305fa3:6493503@6493504 ancestorStateRoot=364b8112 targetStateRoot=36940513 found=true assignDur=5us501ns replayDur=936ms515us843ns\r\nINF 2023-05-22 05:01:24.159-04:00 Slot start                                 topics=\"beacnde\" slot=6493505 epoch=202922 sync=synced/opt peers=93 head=4b305fa3:6493503 finalized=202919:29607c9e delay=1s159ms131us836ns\r\nINF 2023-05-22 05:01:24.314-04:00 Execution client not in sync; skipping validator duties for now topics=\"beacval\" slot=6493505 headSlot=6493504\r\nINF 2023-05-22 05:01:24.849-04:00 Slot end                                   topics=\"beacnde\" slot=6493505 nextActionWait=34s150ms115us848ns nextAttestationSlot=6493508 nextProposalSlot=-1 syncCommitteeDuties=none head=e69563cc:6493504\r\n```\r\n\r\nI reduced the `JAVA_OPTS=-Xmx3g` and the memory keeps being consumed at a decent rate during what I consider normal operation of both EL & CL.",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1561667707/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1562400656",
    "html_url": "https://github.com/hyperledger/besu/issues/5486#issuecomment-1562400656",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/5486",
    "id": 1562400656,
    "node_id": "IC_kwDODE2jmc5dIFeQ",
    "user": {
      "login": "ahamlat",
      "id": 5099602,
      "node_id": "MDQ6VXNlcjUwOTk2MDI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5099602?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ahamlat",
      "html_url": "https://github.com/ahamlat",
      "followers_url": "https://api.github.com/users/ahamlat/followers",
      "following_url": "https://api.github.com/users/ahamlat/following{/other_user}",
      "gists_url": "https://api.github.com/users/ahamlat/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ahamlat/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ahamlat/subscriptions",
      "organizations_url": "https://api.github.com/users/ahamlat/orgs",
      "repos_url": "https://api.github.com/users/ahamlat/repos",
      "events_url": "https://api.github.com/users/ahamlat/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ahamlat/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-25T07:16:37Z",
    "updated_at": "2023-05-25T07:16:37Z",
    "author_association": "CONTRIBUTOR",
    "body": "Hi @ibhagwan,\r\nThanks for reporting this issue. We can see that Besu was killed by the OOM killer when it was consuming 12.26 GiB.\r\nWe don't recommend any more to enable High Spec flag on 16 GiB, could you disable this flat and run with default setting (without -Xmx, defaulted to 4 GiB) ?\r\nHigh spec flag increase RocksDB cache (Block cache) from 128 MiB to 1 GiB for each column family.",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1562400656/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1563081120",
    "html_url": "https://github.com/hyperledger/besu/issues/5486#issuecomment-1563081120",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/5486",
    "id": 1563081120,
    "node_id": "IC_kwDODE2jmc5dKrmg",
    "user": {
      "login": "ibhagwan",
      "id": 59988195,
      "node_id": "MDQ6VXNlcjU5OTg4MTk1",
      "avatar_url": "https://avatars.githubusercontent.com/u/59988195?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ibhagwan",
      "html_url": "https://github.com/ibhagwan",
      "followers_url": "https://api.github.com/users/ibhagwan/followers",
      "following_url": "https://api.github.com/users/ibhagwan/following{/other_user}",
      "gists_url": "https://api.github.com/users/ibhagwan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ibhagwan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ibhagwan/subscriptions",
      "organizations_url": "https://api.github.com/users/ibhagwan/orgs",
      "repos_url": "https://api.github.com/users/ibhagwan/repos",
      "events_url": "https://api.github.com/users/ibhagwan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ibhagwan/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-25T15:11:49Z",
    "updated_at": "2023-05-25T15:11:49Z",
    "author_association": "NONE",
    "body": "> Hi @ibhagwan,\r\n> Thanks for reporting this issue. We can see that Besu was killed by the OOM killer when it was consuming 12.26 GiB.\r\n> We don't recommend any more to enable High Spec flag on 16 GiB, could you disable this flat and run with default setting (without -Xmx, defaulted to 4 GiB) ?\r\n> High spec flag increase RocksDB cache (Block cache) from 128 MiB to 1 GiB for each column family.\r\n\r\nWill try and report back @ahamlat, hopefully won’t hurt my attestation perf which currently stands at 98-99%.",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1563081120/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1564725035",
    "html_url": "https://github.com/hyperledger/besu/issues/5486#issuecomment-1564725035",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/5486",
    "id": 1564725035,
    "node_id": "IC_kwDODE2jmc5dQ88r",
    "user": {
      "login": "ibhagwan",
      "id": 59988195,
      "node_id": "MDQ6VXNlcjU5OTg4MTk1",
      "avatar_url": "https://avatars.githubusercontent.com/u/59988195?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ibhagwan",
      "html_url": "https://github.com/ibhagwan",
      "followers_url": "https://api.github.com/users/ibhagwan/followers",
      "following_url": "https://api.github.com/users/ibhagwan/following{/other_user}",
      "gists_url": "https://api.github.com/users/ibhagwan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ibhagwan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ibhagwan/subscriptions",
      "organizations_url": "https://api.github.com/users/ibhagwan/orgs",
      "repos_url": "https://api.github.com/users/ibhagwan/repos",
      "events_url": "https://api.github.com/users/ibhagwan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ibhagwan/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-26T17:49:10Z",
    "updated_at": "2023-05-26T17:49:10Z",
    "author_association": "NONE",
    "body": "@ahamlat, update: I haven't yet disabled the high spec flag, since I reduced the heap to 3GB with `JAVA_OPTS=-Xmx3g` I decided to let it run and see if it crashes and it's been over 2 days without OOM and the memory consumption for the process seems to have settled at 10.8GB, with the machine consuming 13.1G/15.6G:\r\n![image](https://github.com/hyperledger/besu/assets/59988195/55da7a7e-7826-4b5b-97ae-68f4dbbbfd27)\r\n\r\n`free -h` also confirms this with `2.2Gi` available mem:\r\n![image](https://github.com/hyperledger/besu/assets/59988195/4dfb23c7-e9d0-4779-ad6d-f895af19c2fd)\r\n\r\nAs of now I am still getting 98-99% attestation effectivness, if this continues to work without OOM'ing would you still recommend to switch to 4GB and no high spec flag or stay with 3GB and high spec flag enabled?",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1564725035/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1566683591",
    "html_url": "https://github.com/hyperledger/besu/issues/5486#issuecomment-1566683591",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/5486",
    "id": 1566683591,
    "node_id": "IC_kwDODE2jmc5dYbHH",
    "user": {
      "login": "ahamlat",
      "id": 5099602,
      "node_id": "MDQ6VXNlcjUwOTk2MDI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5099602?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ahamlat",
      "html_url": "https://github.com/ahamlat",
      "followers_url": "https://api.github.com/users/ahamlat/followers",
      "following_url": "https://api.github.com/users/ahamlat/following{/other_user}",
      "gists_url": "https://api.github.com/users/ahamlat/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ahamlat/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ahamlat/subscriptions",
      "organizations_url": "https://api.github.com/users/ahamlat/orgs",
      "repos_url": "https://api.github.com/users/ahamlat/repos",
      "events_url": "https://api.github.com/users/ahamlat/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ahamlat/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-29T07:25:49Z",
    "updated_at": "2023-05-29T07:25:49Z",
    "author_association": "CONTRIBUTOR",
    "body": "The safe way to do it in my opinion is to switch to 4 GiB (-Xmx4g) and disable high spec flag. I can't confirm that attestation effectiveness  will stay at your current percentage because this depend on many parameters but you will have a more stable node in terms of memory usage.",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1566683591/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1567408076",
    "html_url": "https://github.com/hyperledger/besu/issues/5486#issuecomment-1567408076",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/5486",
    "id": 1567408076,
    "node_id": "IC_kwDODE2jmc5dbL_M",
    "user": {
      "login": "ibhagwan",
      "id": 59988195,
      "node_id": "MDQ6VXNlcjU5OTg4MTk1",
      "avatar_url": "https://avatars.githubusercontent.com/u/59988195?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ibhagwan",
      "html_url": "https://github.com/ibhagwan",
      "followers_url": "https://api.github.com/users/ibhagwan/followers",
      "following_url": "https://api.github.com/users/ibhagwan/following{/other_user}",
      "gists_url": "https://api.github.com/users/ibhagwan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ibhagwan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ibhagwan/subscriptions",
      "organizations_url": "https://api.github.com/users/ibhagwan/orgs",
      "repos_url": "https://api.github.com/users/ibhagwan/repos",
      "events_url": "https://api.github.com/users/ibhagwan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ibhagwan/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-29T18:23:19Z",
    "updated_at": "2023-05-29T18:23:19Z",
    "author_association": "NONE",
    "body": "> The safe way to do it in my opinion is to switch to 4 GiB (-Xmx4g) and disable high spec flag. I can't confirm that attestation effectiveness will stay at your current percentage because this depend on many parameters but you will have a more stable node in terms of memory usage.\r\n\r\nTy @ahamlat, I'm currently getting consistent 98-99% attestation so I'd rather keep it this way as long as there's no leak as the old adage says \"if it works, don't touch it\".\r\n\r\nThe below are the current measurements, mem usage seems slightly up but somewhat normal since the last measuremet from 3 days ago?\r\n> htop \r\n\r\n![image](https://github.com/hyperledger/besu/assets/59988195/ca3d908f-f94b-4f29-b5ef-b053150f148d)\r\n\r\n> `free -h`\r\n\r\n![image](https://github.com/hyperledger/besu/assets/59988195/eebd2dc8-60b4-437c-9b57-67e64f762417)\r\n\r\nDo you consider 0.3GB increase in mem consumption over 3 days a leak or is this to be expected? If this is to be expected I can close this issue and perhaps have a weekly service restart to be on the safe side?\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1567408076/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1568005627",
    "html_url": "https://github.com/hyperledger/besu/issues/5486#issuecomment-1568005627",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/5486",
    "id": 1568005627,
    "node_id": "IC_kwDODE2jmc5ddd37",
    "user": {
      "login": "ahamlat",
      "id": 5099602,
      "node_id": "MDQ6VXNlcjUwOTk2MDI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5099602?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ahamlat",
      "html_url": "https://github.com/ahamlat",
      "followers_url": "https://api.github.com/users/ahamlat/followers",
      "following_url": "https://api.github.com/users/ahamlat/following{/other_user}",
      "gists_url": "https://api.github.com/users/ahamlat/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ahamlat/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ahamlat/subscriptions",
      "organizations_url": "https://api.github.com/users/ahamlat/orgs",
      "repos_url": "https://api.github.com/users/ahamlat/repos",
      "events_url": "https://api.github.com/users/ahamlat/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ahamlat/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-30T08:35:58Z",
    "updated_at": "2023-05-30T08:36:21Z",
    "author_association": "CONTRIBUTOR",
    "body": "Thanks for your reply @ibhagwan.\r\nLet me just clarify some concepts around memory usage in Java applications.\r\nThere're two kind of memory issues on a JAVA application\r\n1. Either the configuration in not enough and the application needs more memory to run without crashing : This can be fixed either by increasing -Xmx or reduce memory allocations if it is possible, and in some case (like Besu), just have more RAM and not increase -Xmx (native allocations).\r\n2. Or there is a memory leak, which means that the memory keeps growing even after GC (Garbage Collector) runs several collections and even when we increase -Xmx or use more RAM. The only solution in this case is to resolve the memory leak as increasing -Xmx will just make the application crash later. \r\n\r\nIn Besu, as we have many nodes running for weeks now, we're pretty confident there is no memory leak under the \"Staking use case\". Under some configurations, Besu can consume a lot of memory, especially with a higher -Xmx and High Spec Flag enabled. In this case, it is more related to the first point above and there is a balance to find between -Xmx and High Spec flag.\r\n\r\n> Do you consider 0.3GB increase in mem consumption over 3 days a leak or is this to be expected? If this is to be expected I can close this issue and perhaps have a weekly service restart to be on the safe side?\r\n\r\nIt's hard to say as you may have a garbage collection that will free up a lot of space. There is a memory leak when the memory after a each full GC is increasing over time. ",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1568005627/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1568682037",
    "html_url": "https://github.com/hyperledger/besu/issues/5486#issuecomment-1568682037",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/5486",
    "id": 1568682037,
    "node_id": "IC_kwDODE2jmc5dgDA1",
    "user": {
      "login": "ibhagwan",
      "id": 59988195,
      "node_id": "MDQ6VXNlcjU5OTg4MTk1",
      "avatar_url": "https://avatars.githubusercontent.com/u/59988195?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ibhagwan",
      "html_url": "https://github.com/ibhagwan",
      "followers_url": "https://api.github.com/users/ibhagwan/followers",
      "following_url": "https://api.github.com/users/ibhagwan/following{/other_user}",
      "gists_url": "https://api.github.com/users/ibhagwan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ibhagwan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ibhagwan/subscriptions",
      "organizations_url": "https://api.github.com/users/ibhagwan/orgs",
      "repos_url": "https://api.github.com/users/ibhagwan/repos",
      "events_url": "https://api.github.com/users/ibhagwan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ibhagwan/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-30T15:53:56Z",
    "updated_at": "2023-05-30T15:53:56Z",
    "author_association": "NONE",
    "body": "> In Besu, as we have many nodes running for weeks now, we're pretty confident there is no memory leak under the \"Staking use case\". Under some configurations, Besu can consume a lot of memory, especially with a higher -Xmx and High Spec Flag enabled. In this case, it is more related to the first point above and there is a balance to find between -Xmx and High Spec flag.\r\n\r\nTysm for the thoughtful reply @ahamlat, given my node has been running for almost a week now with no issues I agree there’s no mem leak, the combo of 5G -Xmx with the high spec flag was probably too much.\r\n\r\nWill close the issue.",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1568682037/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
