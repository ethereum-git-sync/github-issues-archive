{
  "url": "https://api.github.com/repos/hyperledger/besu/issues/3635",
  "repository_url": "https://api.github.com/repos/hyperledger/besu",
  "labels_url": "https://api.github.com/repos/hyperledger/besu/issues/3635/labels{/name}",
  "comments_url": "https://api.github.com/repos/hyperledger/besu/issues/3635/comments",
  "events_url": "https://api.github.com/repos/hyperledger/besu/issues/3635/events",
  "html_url": "https://github.com/hyperledger/besu/issues/3635",
  "id": 1182884282,
  "node_id": "I_kwDODE2jmc5GgWG6",
  "number": 3635,
  "title": "Index out of Bound error was occured when sending concurrent private transaction.",
  "user": {
    "login": "yooseonghyuck",
    "id": 29936747,
    "node_id": "MDQ6VXNlcjI5OTM2NzQ3",
    "avatar_url": "https://avatars.githubusercontent.com/u/29936747?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/yooseonghyuck",
    "html_url": "https://github.com/yooseonghyuck",
    "followers_url": "https://api.github.com/users/yooseonghyuck/followers",
    "following_url": "https://api.github.com/users/yooseonghyuck/following{/other_user}",
    "gists_url": "https://api.github.com/users/yooseonghyuck/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/yooseonghyuck/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/yooseonghyuck/subscriptions",
    "organizations_url": "https://api.github.com/users/yooseonghyuck/orgs",
    "repos_url": "https://api.github.com/users/yooseonghyuck/repos",
    "events_url": "https://api.github.com/users/yooseonghyuck/events{/privacy}",
    "received_events_url": "https://api.github.com/users/yooseonghyuck/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "macfarla",
    "id": 2627919,
    "node_id": "MDQ6VXNlcjI2Mjc5MTk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2627919?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/macfarla",
    "html_url": "https://github.com/macfarla",
    "followers_url": "https://api.github.com/users/macfarla/followers",
    "following_url": "https://api.github.com/users/macfarla/following{/other_user}",
    "gists_url": "https://api.github.com/users/macfarla/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/macfarla/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/macfarla/subscriptions",
    "organizations_url": "https://api.github.com/users/macfarla/orgs",
    "repos_url": "https://api.github.com/users/macfarla/repos",
    "events_url": "https://api.github.com/users/macfarla/events{/privacy}",
    "received_events_url": "https://api.github.com/users/macfarla/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "macfarla",
      "id": 2627919,
      "node_id": "MDQ6VXNlcjI2Mjc5MTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2627919?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/macfarla",
      "html_url": "https://github.com/macfarla",
      "followers_url": "https://api.github.com/users/macfarla/followers",
      "following_url": "https://api.github.com/users/macfarla/following{/other_user}",
      "gists_url": "https://api.github.com/users/macfarla/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/macfarla/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/macfarla/subscriptions",
      "organizations_url": "https://api.github.com/users/macfarla/orgs",
      "repos_url": "https://api.github.com/users/macfarla/repos",
      "events_url": "https://api.github.com/users/macfarla/events{/privacy}",
      "received_events_url": "https://api.github.com/users/macfarla/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 6,
  "created_at": "2022-03-28T04:53:26Z",
  "updated_at": "2022-04-05T07:59:10Z",
  "closed_at": "2022-04-04T04:12:44Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Description\r\n\r\nWhen I used Flexible privacy groups, For sending concurrent private transaction, I distributed each of transactions using priv_distributeRawTransaction, and returned enclaveKey. After returned enclaveKey, I put enclave Key, in the data column of each raw transactions, finally I send transaction using eth_sendRawTransaction. But I found a problem. If enclaveKey vaule is null, an index size error occurs at the member node connected to tessera node. After this error, because of validator node isn't related to private transaction, validator node still staking up blocks. But the member node can't  longer stack up blocks.\r\n\r\n```\r\nCritical Exception Processing Transaction\",\"throwable\":\" java.lang.IndexOutOfBoundsException: index (0) must be less than size (0)\r\n    at com.google.common.base.Preconditions.checkElementIndex(Preconditions.java:1355)\r\n    at com.google.common.base.Preconditions.checkElementIndex(Preconditions.java:1337)\r\n    at org.apache.tuweni.bytes.ArrayWrappingBytes.slice(ArrayWrappingBytes.java:73)\r\n    at org.hyperledger.besu.ethereum.mainnet.precompiles.privacy.FlexiblePrivacyPrecompiledContract.compute(FlexiblePrivacyPrecompiledContract.java:110)\r\n    at org.hyperledger.besu.evm.processor.MessageCallProcessor.executePrecompile(MessageCallProcessor.java:153)\r\n    at org.hyperledger.besu.evm.processor.MessageCallProcessor.start(MessageCallProcessor.java:65)\r\n    ...\r\n```\r\n\r\n I think that error was occured at hyperledger/besu/blob/main/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/precompiles/privacy/FlexiblePrivacyPrecompiledContract.java 110. \r\n\r\n\r\n```\r\nfinal String key = input.slice(0, 32).toBase64String();\r\n```\r\n\r\nThis code do not check whether the input value is not empty array. So, I changed this code as follows, I tried to connect the errors  to EnclaveClientException. It works correctly. Is there any problem with this code?\r\n\r\n```\r\nfinal String key = input.toBase64String();\r\n```\r\n\r\n\r\n### Acceptance Criteria\r\n* In exception handling, Warning occurs that the enclave key is none, and moves on to the next block.\r\n\r\n### Steps to Reproduce (Bug)\r\n1. Distribute each of transactions using priv_distributeRawTransaction, and returned enclaveKey.\r\n2. Put null(supposed to enclaveKey), in the data column of each raw transactions.\r\n3. Send transaction using eth_sendRawTransaction\r\n\r\n**Frequency:**\r\nalways\r\n\r\n### Versions (Add all that apply)\r\n* Software version: 22.1.1, 22.1.2",
  "closed_by": {
    "login": "macfarla",
    "id": 2627919,
    "node_id": "MDQ6VXNlcjI2Mjc5MTk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2627919?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/macfarla",
    "html_url": "https://github.com/macfarla",
    "followers_url": "https://api.github.com/users/macfarla/followers",
    "following_url": "https://api.github.com/users/macfarla/following{/other_user}",
    "gists_url": "https://api.github.com/users/macfarla/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/macfarla/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/macfarla/subscriptions",
    "organizations_url": "https://api.github.com/users/macfarla/orgs",
    "repos_url": "https://api.github.com/users/macfarla/repos",
    "events_url": "https://api.github.com/users/macfarla/events{/privacy}",
    "received_events_url": "https://api.github.com/users/macfarla/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/3635/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/hyperledger/besu/issues/3635/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1083074402",
    "html_url": "https://github.com/hyperledger/besu/issues/3635#issuecomment-1083074402",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/3635",
    "id": 1083074402,
    "node_id": "IC_kwDODE2jmc5Ajmdi",
    "user": {
      "login": "macfarla",
      "id": 2627919,
      "node_id": "MDQ6VXNlcjI2Mjc5MTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2627919?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/macfarla",
      "html_url": "https://github.com/macfarla",
      "followers_url": "https://api.github.com/users/macfarla/followers",
      "following_url": "https://api.github.com/users/macfarla/following{/other_user}",
      "gists_url": "https://api.github.com/users/macfarla/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/macfarla/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/macfarla/subscriptions",
      "organizations_url": "https://api.github.com/users/macfarla/orgs",
      "repos_url": "https://api.github.com/users/macfarla/repos",
      "events_url": "https://api.github.com/users/macfarla/events{/privacy}",
      "received_events_url": "https://api.github.com/users/macfarla/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-03-30T12:24:03Z",
    "updated_at": "2022-03-30T12:24:03Z",
    "author_association": "CONTRIBUTOR",
    "body": "It doesn't make sense for the enclaveKey to be null - the enclaveKey needs to have a value since it is what Tessera uses to lookup the payload. So putting null into the raw transaction is not going to work. You need to figure out why the enclaveKey is null.",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1083074402/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1083246519",
    "html_url": "https://github.com/hyperledger/besu/issues/3635#issuecomment-1083246519",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/3635",
    "id": 1083246519,
    "node_id": "IC_kwDODE2jmc5AkQe3",
    "user": {
      "login": "yooseonghyuck",
      "id": 29936747,
      "node_id": "MDQ6VXNlcjI5OTM2NzQ3",
      "avatar_url": "https://avatars.githubusercontent.com/u/29936747?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/yooseonghyuck",
      "html_url": "https://github.com/yooseonghyuck",
      "followers_url": "https://api.github.com/users/yooseonghyuck/followers",
      "following_url": "https://api.github.com/users/yooseonghyuck/following{/other_user}",
      "gists_url": "https://api.github.com/users/yooseonghyuck/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/yooseonghyuck/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/yooseonghyuck/subscriptions",
      "organizations_url": "https://api.github.com/users/yooseonghyuck/orgs",
      "repos_url": "https://api.github.com/users/yooseonghyuck/repos",
      "events_url": "https://api.github.com/users/yooseonghyuck/events{/privacy}",
      "received_events_url": "https://api.github.com/users/yooseonghyuck/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-03-30T14:57:40Z",
    "updated_at": "2022-03-30T14:57:40Z",
    "author_association": "NONE",
    "body": "It can be exploited.\r\nWhen a malicious person submits a { to: 0x7d, data: less than 32bytes, ... } transaction to the network using FlexiblePrivacyGroups, the nodes connected to tessera verify it and show an IndexOutOfBoundsException and stop syncing.",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1083246519/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1084162583",
    "html_url": "https://github.com/hyperledger/besu/issues/3635#issuecomment-1084162583",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/3635",
    "id": 1084162583,
    "node_id": "IC_kwDODE2jmc5AnwIX",
    "user": {
      "login": "macfarla",
      "id": 2627919,
      "node_id": "MDQ6VXNlcjI2Mjc5MTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2627919?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/macfarla",
      "html_url": "https://github.com/macfarla",
      "followers_url": "https://api.github.com/users/macfarla/followers",
      "following_url": "https://api.github.com/users/macfarla/following{/other_user}",
      "gists_url": "https://api.github.com/users/macfarla/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/macfarla/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/macfarla/subscriptions",
      "organizations_url": "https://api.github.com/users/macfarla/orgs",
      "repos_url": "https://api.github.com/users/macfarla/repos",
      "events_url": "https://api.github.com/users/macfarla/events{/privacy}",
      "received_events_url": "https://api.github.com/users/macfarla/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-03-31T06:48:51Z",
    "updated_at": "2022-03-31T06:48:51Z",
    "author_association": "CONTRIBUTOR",
    "body": "ok thanks for the clarification. I've made a new PR that preserves the existing behaviour and also handles the null case as well as < 32 bytes https://github.com/hyperledger/besu/pull/3664",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1084162583/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1087090981",
    "html_url": "https://github.com/hyperledger/besu/issues/3635#issuecomment-1087090981",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/3635",
    "id": 1087090981,
    "node_id": "IC_kwDODE2jmc5Ay7El",
    "user": {
      "login": "macfarla",
      "id": 2627919,
      "node_id": "MDQ6VXNlcjI2Mjc5MTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2627919?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/macfarla",
      "html_url": "https://github.com/macfarla",
      "followers_url": "https://api.github.com/users/macfarla/followers",
      "following_url": "https://api.github.com/users/macfarla/following{/other_user}",
      "gists_url": "https://api.github.com/users/macfarla/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/macfarla/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/macfarla/subscriptions",
      "organizations_url": "https://api.github.com/users/macfarla/orgs",
      "repos_url": "https://api.github.com/users/macfarla/repos",
      "events_url": "https://api.github.com/users/macfarla/events{/privacy}",
      "received_events_url": "https://api.github.com/users/macfarla/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-04-04T04:12:44Z",
    "updated_at": "2022-04-04T04:12:44Z",
    "author_association": "CONTRIBUTOR",
    "body": "https://github.com/hyperledger/besu/pull/3664 has been merged. Are you able to try your code with the latest besu main branch? \n\nOtherwise, this fix will be included in the next release of besu.",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1087090981/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1088293328",
    "html_url": "https://github.com/hyperledger/besu/issues/3635#issuecomment-1088293328",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/3635",
    "id": 1088293328,
    "node_id": "IC_kwDODE2jmc5A3gnQ",
    "user": {
      "login": "yooseonghyuck",
      "id": 29936747,
      "node_id": "MDQ6VXNlcjI5OTM2NzQ3",
      "avatar_url": "https://avatars.githubusercontent.com/u/29936747?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/yooseonghyuck",
      "html_url": "https://github.com/yooseonghyuck",
      "followers_url": "https://api.github.com/users/yooseonghyuck/followers",
      "following_url": "https://api.github.com/users/yooseonghyuck/following{/other_user}",
      "gists_url": "https://api.github.com/users/yooseonghyuck/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/yooseonghyuck/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/yooseonghyuck/subscriptions",
      "organizations_url": "https://api.github.com/users/yooseonghyuck/orgs",
      "repos_url": "https://api.github.com/users/yooseonghyuck/repos",
      "events_url": "https://api.github.com/users/yooseonghyuck/events{/privacy}",
      "received_events_url": "https://api.github.com/users/yooseonghyuck/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-04-05T05:49:46Z",
    "updated_at": "2022-04-05T05:49:46Z",
    "author_association": "NONE",
    "body": "When syncing the block where the error occurred, As following exception message correctly occurred. \r\nThanks a lot.\r\n\r\n```\r\n\"timestamp\":\"2022-04-05T04:18:50,585\",\"\r\ncontainer\":\"ip-172-31-57-54.ap-northeast-2.compute.internal\",\r\n\"level\":\"ERROR\",\r\n\"thread\":\"EthScheduler-Services-5 (importBlock)\",\r\n\"class\":\"FlexiblePrivacyPrecompiledContract\",\r\n\"message\":\"Can not fetch private transaction payload with key of invalid length 0x\",\"throwable\":\"\"\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1088293328/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1088386977",
    "html_url": "https://github.com/hyperledger/besu/issues/3635#issuecomment-1088386977",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/3635",
    "id": 1088386977,
    "node_id": "IC_kwDODE2jmc5A33eh",
    "user": {
      "login": "macfarla",
      "id": 2627919,
      "node_id": "MDQ6VXNlcjI2Mjc5MTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2627919?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/macfarla",
      "html_url": "https://github.com/macfarla",
      "followers_url": "https://api.github.com/users/macfarla/followers",
      "following_url": "https://api.github.com/users/macfarla/following{/other_user}",
      "gists_url": "https://api.github.com/users/macfarla/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/macfarla/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/macfarla/subscriptions",
      "organizations_url": "https://api.github.com/users/macfarla/orgs",
      "repos_url": "https://api.github.com/users/macfarla/repos",
      "events_url": "https://api.github.com/users/macfarla/events{/privacy}",
      "received_events_url": "https://api.github.com/users/macfarla/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-04-05T07:59:09Z",
    "updated_at": "2022-04-05T07:59:09Z",
    "author_association": "CONTRIBUTOR",
    "body": "Great, thanks for confirming!",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1088386977/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
