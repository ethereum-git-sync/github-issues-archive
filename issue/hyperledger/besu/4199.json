{
  "url": "https://api.github.com/repos/hyperledger/besu/issues/4199",
  "repository_url": "https://api.github.com/repos/hyperledger/besu",
  "labels_url": "https://api.github.com/repos/hyperledger/besu/issues/4199/labels{/name}",
  "comments_url": "https://api.github.com/repos/hyperledger/besu/issues/4199/comments",
  "events_url": "https://api.github.com/repos/hyperledger/besu/issues/4199/events",
  "html_url": "https://github.com/hyperledger/besu/issues/4199",
  "id": 1322346373,
  "node_id": "I_kwDODE2jmc5O0WeF",
  "number": 4199,
  "title": "We need access to a worldstate image of the last 128 blocks with bonsai",
  "user": {
    "login": "matkt",
    "id": 26581503,
    "node_id": "MDQ6VXNlcjI2NTgxNTAz",
    "avatar_url": "https://avatars.githubusercontent.com/u/26581503?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/matkt",
    "html_url": "https://github.com/matkt",
    "followers_url": "https://api.github.com/users/matkt/followers",
    "following_url": "https://api.github.com/users/matkt/following{/other_user}",
    "gists_url": "https://api.github.com/users/matkt/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/matkt/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/matkt/subscriptions",
    "organizations_url": "https://api.github.com/users/matkt/orgs",
    "repos_url": "https://api.github.com/users/matkt/repos",
    "events_url": "https://api.github.com/users/matkt/events{/privacy}",
    "received_events_url": "https://api.github.com/users/matkt/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "garyschulte",
    "id": 1238512,
    "node_id": "MDQ6VXNlcjEyMzg1MTI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1238512?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/garyschulte",
    "html_url": "https://github.com/garyschulte",
    "followers_url": "https://api.github.com/users/garyschulte/followers",
    "following_url": "https://api.github.com/users/garyschulte/following{/other_user}",
    "gists_url": "https://api.github.com/users/garyschulte/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/garyschulte/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/garyschulte/subscriptions",
    "organizations_url": "https://api.github.com/users/garyschulte/orgs",
    "repos_url": "https://api.github.com/users/garyschulte/repos",
    "events_url": "https://api.github.com/users/garyschulte/events{/privacy}",
    "received_events_url": "https://api.github.com/users/garyschulte/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "garyschulte",
      "id": 1238512,
      "node_id": "MDQ6VXNlcjEyMzg1MTI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1238512?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/garyschulte",
      "html_url": "https://github.com/garyschulte",
      "followers_url": "https://api.github.com/users/garyschulte/followers",
      "following_url": "https://api.github.com/users/garyschulte/following{/other_user}",
      "gists_url": "https://api.github.com/users/garyschulte/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/garyschulte/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/garyschulte/subscriptions",
      "organizations_url": "https://api.github.com/users/garyschulte/orgs",
      "repos_url": "https://api.github.com/users/garyschulte/repos",
      "events_url": "https://api.github.com/users/garyschulte/events{/privacy}",
      "received_events_url": "https://api.github.com/users/garyschulte/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2022-07-29T14:48:56Z",
  "updated_at": "2022-11-05T17:42:26Z",
  "closed_at": "2022-11-05T17:42:26Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "With bonsai we have the worldstate of the head and tries logs to be able to rollback or rollforward the worldstate to an old/recent block. This technique with trielogs works very well in the case of reorgs but has limitations.\r\n\r\nIn particular with the snapsync as a server we must be able to provide the nodes of the worldstate of the last 128 blocks. If we have to rollback after every request it will be a lot of work for the node and risks impacting the stability of the node.\r\n\r\nTo avoid this it will be preferable to keep an image of the last 128 blocks and rocksdb's snapshot feature might help to do this\r\n\r\nhttp://rocksdb.org/blog/2015/11/10/use-checkpoints-for-efficient-snapshots.html\r\n\r\nThis feature can also help make bonsai more stable. If we detect worldstate corruption for some reason (crash or bug). We could go back and take the worldstate of block head-1 and resume synchronization from this one\r\n\r\n\r\nExample : \r\n\r\n- 1 : the node tries to import block h+1\r\n- 2 : stateroot mismatch or other issue detected\r\n- 3 : besu take the worldstate image of block h-1 and try again to import block h\r\n- 4: the database is fixed thanks to the new import\r\n- 5: we import block h+1 again\r\n\r\n",
  "closed_by": {
    "login": "garyschulte",
    "id": 1238512,
    "node_id": "MDQ6VXNlcjEyMzg1MTI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1238512?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/garyschulte",
    "html_url": "https://github.com/garyschulte",
    "followers_url": "https://api.github.com/users/garyschulte/followers",
    "following_url": "https://api.github.com/users/garyschulte/following{/other_user}",
    "gists_url": "https://api.github.com/users/garyschulte/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/garyschulte/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/garyschulte/subscriptions",
    "organizations_url": "https://api.github.com/users/garyschulte/orgs",
    "repos_url": "https://api.github.com/users/garyschulte/repos",
    "events_url": "https://api.github.com/users/garyschulte/events{/privacy}",
    "received_events_url": "https://api.github.com/users/garyschulte/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/4199/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/hyperledger/besu/issues/4199/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1211246537",
    "html_url": "https://github.com/hyperledger/besu/issues/4199#issuecomment-1211246537",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/4199",
    "id": 1211246537,
    "node_id": "IC_kwDODE2jmc5IMifJ",
    "user": {
      "login": "garyschulte",
      "id": 1238512,
      "node_id": "MDQ6VXNlcjEyMzg1MTI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1238512?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/garyschulte",
      "html_url": "https://github.com/garyschulte",
      "followers_url": "https://api.github.com/users/garyschulte/followers",
      "following_url": "https://api.github.com/users/garyschulte/following{/other_user}",
      "gists_url": "https://api.github.com/users/garyschulte/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/garyschulte/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/garyschulte/subscriptions",
      "organizations_url": "https://api.github.com/users/garyschulte/orgs",
      "repos_url": "https://api.github.com/users/garyschulte/repos",
      "events_url": "https://api.github.com/users/garyschulte/events{/privacy}",
      "received_events_url": "https://api.github.com/users/garyschulte/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-10T20:40:08Z",
    "updated_at": "2022-08-10T20:43:51Z",
    "author_association": "CONTRIBUTOR",
    "body": "As we discussed, a persistent snapshot (Checkpoint) seems like a viable source to rollback to whereas a collection of n (e.g. 128)  in-memory snapshot-transaction-based worldstates is likely a more suitable mechanism for snapsync server.\r\n\r\nsee https://github.com/garyschulte/besu/tree/feature/bonsai-isolation (re-pushed and rebased off of main) and specifically:\r\n\r\n[RocksDbColumnarKeyValueStorage.takeSnapshot()](https://github.com/garyschulte/besu/blob/feature/bonsai-isolation/plugins/rocksdb/src/main/java/org/hyperledger/besu/plugin/services/storage/rocksdb/segmented/RocksDBColumnarKeyValueStorage.java#L182)\r\n[RocksDbColumnarKeyValueSnapshot](https://github.com/garyschulte/besu/blob/feature/bonsai-isolation/plugins/rocksdb/src/main/java/org/hyperledger/besu/plugin/services/storage/rocksdb/segmented/RocksDBColumnarKeyValueSnapshot.java)\r\n\r\n@jflo ",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1211246537/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
