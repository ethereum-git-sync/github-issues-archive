{
  "url": "https://api.github.com/repos/hyperledger/besu/issues/4330",
  "repository_url": "https://api.github.com/repos/hyperledger/besu",
  "labels_url": "https://api.github.com/repos/hyperledger/besu/issues/4330/labels{/name}",
  "comments_url": "https://api.github.com/repos/hyperledger/besu/issues/4330/comments",
  "events_url": "https://api.github.com/repos/hyperledger/besu/issues/4330/events",
  "html_url": "https://github.com/hyperledger/besu/issues/4330",
  "id": 1356981048,
  "node_id": "I_kwDODE2jmc5Q4eM4",
  "number": 4330,
  "title": "During Snap Sync, the number of blocks executed in Full import step is too high (~10k blocks)",
  "user": {
    "login": "ahamlat",
    "id": 5099602,
    "node_id": "MDQ6VXNlcjUwOTk2MDI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5099602?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ahamlat",
    "html_url": "https://github.com/ahamlat",
    "followers_url": "https://api.github.com/users/ahamlat/followers",
    "following_url": "https://api.github.com/users/ahamlat/following{/other_user}",
    "gists_url": "https://api.github.com/users/ahamlat/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ahamlat/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ahamlat/subscriptions",
    "organizations_url": "https://api.github.com/users/ahamlat/orgs",
    "repos_url": "https://api.github.com/users/ahamlat/repos",
    "events_url": "https://api.github.com/users/ahamlat/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ahamlat/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3013559202,
      "node_id": "MDU6TGFiZWwzMDEzNTU5MjAy",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/mainnet",
      "name": "mainnet",
      "color": "9D578C",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "matkt",
    "id": 26581503,
    "node_id": "MDQ6VXNlcjI2NTgxNTAz",
    "avatar_url": "https://avatars.githubusercontent.com/u/26581503?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/matkt",
    "html_url": "https://github.com/matkt",
    "followers_url": "https://api.github.com/users/matkt/followers",
    "following_url": "https://api.github.com/users/matkt/following{/other_user}",
    "gists_url": "https://api.github.com/users/matkt/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/matkt/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/matkt/subscriptions",
    "organizations_url": "https://api.github.com/users/matkt/orgs",
    "repos_url": "https://api.github.com/users/matkt/repos",
    "events_url": "https://api.github.com/users/matkt/events{/privacy}",
    "received_events_url": "https://api.github.com/users/matkt/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "matkt",
      "id": 26581503,
      "node_id": "MDQ6VXNlcjI2NTgxNTAz",
      "avatar_url": "https://avatars.githubusercontent.com/u/26581503?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/matkt",
      "html_url": "https://github.com/matkt",
      "followers_url": "https://api.github.com/users/matkt/followers",
      "following_url": "https://api.github.com/users/matkt/following{/other_user}",
      "gists_url": "https://api.github.com/users/matkt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/matkt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/matkt/subscriptions",
      "organizations_url": "https://api.github.com/users/matkt/orgs",
      "repos_url": "https://api.github.com/users/matkt/repos",
      "events_url": "https://api.github.com/users/matkt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/matkt/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 0,
  "created_at": "2022-08-31T08:21:50Z",
  "updated_at": "2022-09-15T09:06:17Z",
  "closed_at": "2022-09-15T09:06:17Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "<!-- Have you done the following? -->\r\n<!--   * read the Code of Conduct? By filing an Issue, you are expected to -->  \r\n<!--     comply with it, including treating everyone with respect: -->\r\n<!--     https://github.com/hyperledger/besu/blob/main/CODE_OF_CONDUCT.md -->\r\n<!--   * Reproduced the issue in the latest version of the software -->\r\n<!--   * Read the debugging docs: https://besu.hyperledger.org/en/stable/HowTo/Monitor/Logging/ -->\r\n<!--   * Duplicate Issue check:  https://github.com/search?q=+is%3Aissue+repo%3Ahyperledger/Besu -->\r\n<!-- Note:  Not all sections will apply to all issue types. -->\r\n\r\n### Description\r\nI noticed during my last tests, Snapsync Besu nodes with a Bonsai database, that the number of blocks imported in Full import step (FullImportBlockStep) is too high, around 10K on t3.xlarge and i3.xlarge AWS instances.\r\nI noticed also that this number depends on the speed of the sync (blocks import part, i.e FastImportBlocksStep), the slower the sync, the larger the number of blocks to import in Full import step. This may be related to the number of new created blocks from the last WorldState heal, the further in the past this step is, the greater the number of new blocks will be.\r\n\r\nWe can see in the screenshot below five different Besu nodes where the Full import step started around 10k blocks behind.\r\n<img width=\"1251\" alt=\"image\" src=\"https://user-images.githubusercontent.com/5099602/187623901-8642458d-f295-4c9b-bacf-535f4d530729.png\">\r\n\r\nThe pattern above is a bit confusing because of the logarithmic y-axis, we may think that the full import step is slower which is not true, you can find below a zoom on one of the nodes during the switch from importing block to full import with a linear y-axis. This step took around 5 hours because of the execution of all transaction, which is huge.\r\n\r\n<img width=\"1660\" alt=\"image\" src=\"https://user-images.githubusercontent.com/5099602/187624517-cf4f2ae8-35d4-4852-a94f-280ee0a31ea0.png\">\r\n\r\n### Acceptance Criteria\r\n* Reduce the number of blocks imported in FullImportBlockStep to something around 128 blocks.\r\n\r\n### Steps to Reproduce (Bug)\r\n1. Start a Besu node, with SnapSync and a Bonsai database on a hardware with 4 CPU and 16 GiB, and NVMe SSD Disk.\r\nWe can use a different hardware specification, this will just change the number of blocks to download in the Full import step. With a more powerfull hardware, this number is likely to be lower.\r\n\r\n**Expected behavior:** [What you expect to happen]\r\nThe number of blocks to download in Full import step should be something around 128 blocks, and this step should take less than 20 minutes (with 4 CPU and 16 GiB, and NVMe SSD Disk).\r\n\r\n**Actual behavior:** [What actually happens]\r\nThe number of blocks imported in Full import step is around 10k blocks and this step took 5 hours  (with 4 CPU and 16 GiB, and NVMe SSD Disk).\r\n\r\n**Frequency:** [What percentage of the time does it occur?]\r\n100% \r\n\r\n### Versions (Add all that apply)\r\n* Software version: besu/v22.7.1/linux-x86_64/openjdk-java-11\r\n* Java version: openjdk version \"11.0.16\" 2022-07-19\r\n* OS Name & Version: 22.04.1 LTS (Jammy Jellyfish)\r\n* Cloud VM, type, size: i3.xlarge and t3.xlarge\r\n\r\n",
  "closed_by": {
    "login": "matkt",
    "id": 26581503,
    "node_id": "MDQ6VXNlcjI2NTgxNTAz",
    "avatar_url": "https://avatars.githubusercontent.com/u/26581503?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/matkt",
    "html_url": "https://github.com/matkt",
    "followers_url": "https://api.github.com/users/matkt/followers",
    "following_url": "https://api.github.com/users/matkt/following{/other_user}",
    "gists_url": "https://api.github.com/users/matkt/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/matkt/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/matkt/subscriptions",
    "organizations_url": "https://api.github.com/users/matkt/orgs",
    "repos_url": "https://api.github.com/users/matkt/repos",
    "events_url": "https://api.github.com/users/matkt/events{/privacy}",
    "received_events_url": "https://api.github.com/users/matkt/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/4330/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/hyperledger/besu/issues/4330/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[

]
