{
  "url": "https://api.github.com/repos/hyperledger/besu/issues/3029",
  "repository_url": "https://api.github.com/repos/hyperledger/besu",
  "labels_url": "https://api.github.com/repos/hyperledger/besu/issues/3029/labels{/name}",
  "comments_url": "https://api.github.com/repos/hyperledger/besu/issues/3029/comments",
  "events_url": "https://api.github.com/repos/hyperledger/besu/issues/3029/events",
  "html_url": "https://github.com/hyperledger/besu/issues/3029",
  "id": 1048607367,
  "node_id": "I_kwDODE2jmc4-gHqH",
  "number": 3029,
  "title": "RPC qbft_getSignerMetrics returns incorrect validators after blockheader transition block",
  "user": {
    "login": "siladu",
    "id": 2893793,
    "node_id": "MDQ6VXNlcjI4OTM3OTM=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2893793?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/siladu",
    "html_url": "https://github.com/siladu",
    "followers_url": "https://api.github.com/users/siladu/followers",
    "following_url": "https://api.github.com/users/siladu/following{/other_user}",
    "gists_url": "https://api.github.com/users/siladu/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/siladu/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/siladu/subscriptions",
    "organizations_url": "https://api.github.com/users/siladu/orgs",
    "repos_url": "https://api.github.com/users/siladu/repos",
    "events_url": "https://api.github.com/users/siladu/events{/privacy}",
    "received_events_url": "https://api.github.com/users/siladu/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1537362490,
      "node_id": "MDU6TGFiZWwxNTM3MzYyNDkw",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/bug",
      "name": "bug",
      "color": "d73a4a",
      "default": true,
      "description": "Something isn't working"
    },
    {
      "id": 1921587647,
      "node_id": "MDU6TGFiZWwxOTIxNTg3NjQ3",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/TeamGroot",
      "name": "TeamGroot",
      "color": "1d76db",
      "default": false,
      "description": "GH issues worked on by Groot Team"
    },
    {
      "id": 3372112640,
      "node_id": "MDU6TGFiZWwzMzcyMTEyNjQw",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/consensus",
      "name": "consensus",
      "color": "7A9730",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2021-11-09T13:27:17Z",
  "updated_at": "2022-01-25T01:20:44Z",
  "closed_at": null,
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "When transitioning from `contract` validatorselectionmode to `blockheader` with validator overrides, the RPC incorrectly builds the metrics based on an empty set of validators for some of the block range.\r\n\r\nThis is because the RPCs use a BlockValidatorProvider.nonForkingValidatorProvider which is not aware of the BftValidatorOverrides. Hopefully, simply using a BlockValidatorProvider.forkingValidatorProvider when constructing the RPCs will fix it.\r\n\r\n### Steps to Reproduce (Bug)\r\n1. Network started in validator contract mode with no extra data in genesis block.\r\n2. Transition to blockheader mode with validator overrides\r\n3. Restart node before next epoch is hit\r\n4. Call RPC (before next block is produced so the cache isn’t populated)\r\n5. The metrics will be wrong because no validators are returned for the affected block range. The VoteTallyCache can’t be reconstructed since the previous epoch is a contract-mode block (e.g. genesis block) which has no extra data, and the RPC’s validatorProvider doesn’t have access to the validator overrides so there’s no overrides available to replace the missing cache entries (which is how it works when producing blocks).\r\n\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/3029/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/hyperledger/besu/issues/3029/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/971209422",
    "html_url": "https://github.com/hyperledger/besu/issues/3029#issuecomment-971209422",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/3029",
    "id": 971209422,
    "node_id": "IC_kwDODE2jmc4543rO",
    "user": {
      "login": "siladu",
      "id": 2893793,
      "node_id": "MDQ6VXNlcjI4OTM3OTM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2893793?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/siladu",
      "html_url": "https://github.com/siladu",
      "followers_url": "https://api.github.com/users/siladu/followers",
      "following_url": "https://api.github.com/users/siladu/following{/other_user}",
      "gists_url": "https://api.github.com/users/siladu/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/siladu/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/siladu/subscriptions",
      "organizations_url": "https://api.github.com/users/siladu/orgs",
      "repos_url": "https://api.github.com/users/siladu/repos",
      "events_url": "https://api.github.com/users/siladu/events{/privacy}",
      "received_events_url": "https://api.github.com/users/siladu/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-11-17T05:41:32Z",
    "updated_at": "2021-11-17T05:41:42Z",
    "author_association": "CONTRIBUTOR",
    "body": "We should also use forkingValidatorProvider for IBFT2 RPCs as well.",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/971209422/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
