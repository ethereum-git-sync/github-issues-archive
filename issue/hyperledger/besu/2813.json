{
  "url": "https://api.github.com/repos/hyperledger/besu/issues/2813",
  "repository_url": "https://api.github.com/repos/hyperledger/besu",
  "labels_url": "https://api.github.com/repos/hyperledger/besu/issues/2813/labels{/name}",
  "comments_url": "https://api.github.com/repos/hyperledger/besu/issues/2813/comments",
  "events_url": "https://api.github.com/repos/hyperledger/besu/issues/2813/events",
  "html_url": "https://github.com/hyperledger/besu/issues/2813",
  "id": 1009395197,
  "node_id": "I_kwDODE2jmc48KiX9",
  "number": 2813,
  "title": "Mocks not executed in TransactionPoolTest",
  "user": {
    "login": "taccatisid",
    "id": 88524035,
    "node_id": "MDQ6VXNlcjg4NTI0MDM1",
    "avatar_url": "https://avatars.githubusercontent.com/u/88524035?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/taccatisid",
    "html_url": "https://github.com/taccatisid",
    "followers_url": "https://api.github.com/users/taccatisid/followers",
    "following_url": "https://api.github.com/users/taccatisid/following{/other_user}",
    "gists_url": "https://api.github.com/users/taccatisid/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/taccatisid/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/taccatisid/subscriptions",
    "organizations_url": "https://api.github.com/users/taccatisid/orgs",
    "repos_url": "https://api.github.com/users/taccatisid/repos",
    "events_url": "https://api.github.com/users/taccatisid/events{/privacy}",
    "received_events_url": "https://api.github.com/users/taccatisid/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1537362500,
      "node_id": "MDU6TGFiZWwxNTM3MzYyNTAw",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/good%20first%20issue",
      "name": "good first issue",
      "color": "7057ff",
      "default": true,
      "description": "Good for newcomers"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "jflo",
    "id": 345937,
    "node_id": "MDQ6VXNlcjM0NTkzNw==",
    "avatar_url": "https://avatars.githubusercontent.com/u/345937?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jflo",
    "html_url": "https://github.com/jflo",
    "followers_url": "https://api.github.com/users/jflo/followers",
    "following_url": "https://api.github.com/users/jflo/following{/other_user}",
    "gists_url": "https://api.github.com/users/jflo/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jflo/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jflo/subscriptions",
    "organizations_url": "https://api.github.com/users/jflo/orgs",
    "repos_url": "https://api.github.com/users/jflo/repos",
    "events_url": "https://api.github.com/users/jflo/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jflo/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "jflo",
      "id": 345937,
      "node_id": "MDQ6VXNlcjM0NTkzNw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/345937?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jflo",
      "html_url": "https://github.com/jflo",
      "followers_url": "https://api.github.com/users/jflo/followers",
      "following_url": "https://api.github.com/users/jflo/following{/other_user}",
      "gists_url": "https://api.github.com/users/jflo/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jflo/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jflo/subscriptions",
      "organizations_url": "https://api.github.com/users/jflo/orgs",
      "repos_url": "https://api.github.com/users/jflo/repos",
      "events_url": "https://api.github.com/users/jflo/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jflo/received_events",
      "type": "User",
      "site_admin": false
    },
    {
      "login": "avanideshpande",
      "id": 91753283,
      "node_id": "U_kgDOBXgLQw",
      "avatar_url": "https://avatars.githubusercontent.com/u/91753283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/avanideshpande",
      "html_url": "https://github.com/avanideshpande",
      "followers_url": "https://api.github.com/users/avanideshpande/followers",
      "following_url": "https://api.github.com/users/avanideshpande/following{/other_user}",
      "gists_url": "https://api.github.com/users/avanideshpande/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/avanideshpande/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/avanideshpande/subscriptions",
      "organizations_url": "https://api.github.com/users/avanideshpande/orgs",
      "repos_url": "https://api.github.com/users/avanideshpande/repos",
      "events_url": "https://api.github.com/users/avanideshpande/events{/privacy}",
      "received_events_url": "https://api.github.com/users/avanideshpande/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2021-09-28T07:37:12Z",
  "updated_at": "2021-10-22T00:10:56Z",
  "closed_at": "2021-10-22T00:10:56Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "<!-- Have you done the following? -->\r\n<!--   * read the Code of Conduct? By filing an Issue, you are expected to -->  \r\n<!--     comply with it, including treating everyone with respect: -->\r\n<!--     https://github.com/hyperledger/besu/blob/main/CODE_OF_CONDUCT.md -->\r\n<!--   * Reproduced the issue in the latest version of the software -->\r\n<!--   * Read the debugging docs: https://besu.hyperledger.org/en/stable/HowTo/Monitor/Logging/ -->\r\n<!--   * Duplicate Issue check:  https://github.com/search?q=+is%3Aissue+repo%3Ahyperledger/Besu -->\r\n<!-- Note:  Not all sections will apply to all issue types. -->\r\n\r\n### Description\r\nSome mocked function calls in TransactionPoolTest are not executed. This causes the affected test to pass without testing the desired behaviour.\r\n\r\nThis defect became visible by changing the test runner to MockitoJUnitRunner in https://github.com/hyperledger/besu/pull/2805/files#diff-e87fc07018151e51bb9b524cc7c5f982696ffe79ba6f514ae4787bd7818bc75f. The same commit tags all defective mocks as `lenient()`.\r\n\r\n### Acceptance Criteria\r\n* All mocked function calls are used.\r\n\r\n### Steps to Reproduce (Bug)\r\n1. Remove the lenient() prefix in https://github.com/hyperledger/besu/pull/2805/files#diff-e87fc07018151e51bb9b524cc7c5f982696ffe79ba6f514ae4787bd7818bc75f\r\n2. Unit tests fails on CI with `UnnecessaryStubbingException`\r\n\r\n**Frequency:** Always\r\n\r\n### Versions (Add all that apply)\r\n* Software version: current main branch\r\n\r\n### Additional Information\r\nWhen investigating the issue a weird mocktio pattern became apparent. When setting up a mock once it would be ignored, but when setting it up twice the **first** used setup would used. E.g.\r\n```\r\nwhen(transactionValidator.validate(any(), any(), any()))\r\n        .thenThrow(new Error(\"foo\"));\r\n```\r\nwould no fire despite `transactionValidator.validate` being called. But\r\n```\r\nwhen(transactionValidator.validate(any(), any(), any()))\r\n        .thenThrow(new Error(\"foo\"));\r\nwhen(transactionValidator.validate(any(), any(), any()))\r\n        .thenThrow(new Error(\"bar\"));\r\n```\r\nwould throw `foo` and not `bar`.\r\n\r\nMockito is supposed to overwrite previous mock values with new ones, and should obviously already work when only mocking once.",
  "closed_by": {
    "login": "macfarla",
    "id": 2627919,
    "node_id": "MDQ6VXNlcjI2Mjc5MTk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2627919?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/macfarla",
    "html_url": "https://github.com/macfarla",
    "followers_url": "https://api.github.com/users/macfarla/followers",
    "following_url": "https://api.github.com/users/macfarla/following{/other_user}",
    "gists_url": "https://api.github.com/users/macfarla/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/macfarla/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/macfarla/subscriptions",
    "organizations_url": "https://api.github.com/users/macfarla/orgs",
    "repos_url": "https://api.github.com/users/macfarla/repos",
    "events_url": "https://api.github.com/users/macfarla/events{/privacy}",
    "received_events_url": "https://api.github.com/users/macfarla/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/2813/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/hyperledger/besu/issues/2813/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/932473229",
    "html_url": "https://github.com/hyperledger/besu/issues/2813#issuecomment-932473229",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/2813",
    "id": 932473229,
    "node_id": "IC_kwDODE2jmc43lGmN",
    "user": {
      "login": "avanideshpande",
      "id": 91753283,
      "node_id": "U_kgDOBXgLQw",
      "avatar_url": "https://avatars.githubusercontent.com/u/91753283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/avanideshpande",
      "html_url": "https://github.com/avanideshpande",
      "followers_url": "https://api.github.com/users/avanideshpande/followers",
      "following_url": "https://api.github.com/users/avanideshpande/following{/other_user}",
      "gists_url": "https://api.github.com/users/avanideshpande/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/avanideshpande/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/avanideshpande/subscriptions",
      "organizations_url": "https://api.github.com/users/avanideshpande/orgs",
      "repos_url": "https://api.github.com/users/avanideshpande/repos",
      "events_url": "https://api.github.com/users/avanideshpande/events{/privacy}",
      "received_events_url": "https://api.github.com/users/avanideshpande/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-10-01T18:50:54Z",
    "updated_at": "2021-10-01T18:50:54Z",
    "author_association": "NONE",
    "body": "Please add me to this one instead",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/932473229/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 1,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/949092623",
    "html_url": "https://github.com/hyperledger/besu/issues/2813#issuecomment-949092623",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/2813",
    "id": 949092623,
    "node_id": "IC_kwDODE2jmc44kgEP",
    "user": {
      "login": "macfarla",
      "id": 2627919,
      "node_id": "MDQ6VXNlcjI2Mjc5MTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2627919?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/macfarla",
      "html_url": "https://github.com/macfarla",
      "followers_url": "https://api.github.com/users/macfarla/followers",
      "following_url": "https://api.github.com/users/macfarla/following{/other_user}",
      "gists_url": "https://api.github.com/users/macfarla/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/macfarla/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/macfarla/subscriptions",
      "organizations_url": "https://api.github.com/users/macfarla/orgs",
      "repos_url": "https://api.github.com/users/macfarla/repos",
      "events_url": "https://api.github.com/users/macfarla/events{/privacy}",
      "received_events_url": "https://api.github.com/users/macfarla/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-10-22T00:10:56Z",
    "updated_at": "2021-10-22T00:10:56Z",
    "author_association": "CONTRIBUTOR",
    "body": "@avanideshpande - this has been cleaned up by https://github.com/hyperledger/besu/pull/2805",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/949092623/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
