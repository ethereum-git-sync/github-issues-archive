{
  "url": "https://api.github.com/repos/hyperledger/besu/issues/3038",
  "repository_url": "https://api.github.com/repos/hyperledger/besu",
  "labels_url": "https://api.github.com/repos/hyperledger/besu/issues/3038/labels{/name}",
  "comments_url": "https://api.github.com/repos/hyperledger/besu/issues/3038/comments",
  "events_url": "https://api.github.com/repos/hyperledger/besu/issues/3038/events",
  "html_url": "https://github.com/hyperledger/besu/issues/3038",
  "id": 1050590032,
  "node_id": "I_kwDODE2jmc4-nrtQ",
  "number": 3038,
  "title": "Require Validator Overrides For Blockheader Mode Transitions",
  "user": {
    "login": "siladu",
    "id": 2893793,
    "node_id": "MDQ6VXNlcjI4OTM3OTM=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2893793?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/siladu",
    "html_url": "https://github.com/siladu",
    "followers_url": "https://api.github.com/users/siladu/followers",
    "following_url": "https://api.github.com/users/siladu/following{/other_user}",
    "gists_url": "https://api.github.com/users/siladu/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/siladu/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/siladu/subscriptions",
    "organizations_url": "https://api.github.com/users/siladu/orgs",
    "repos_url": "https://api.github.com/users/siladu/repos",
    "events_url": "https://api.github.com/users/siladu/events{/privacy}",
    "received_events_url": "https://api.github.com/users/siladu/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1921587647,
      "node_id": "MDU6TGFiZWwxOTIxNTg3NjQ3",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/TeamGroot",
      "name": "TeamGroot",
      "color": "1d76db",
      "default": false,
      "description": "GH issues worked on by Groot Team"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "siladu",
    "id": 2893793,
    "node_id": "MDQ6VXNlcjI4OTM3OTM=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2893793?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/siladu",
    "html_url": "https://github.com/siladu",
    "followers_url": "https://api.github.com/users/siladu/followers",
    "following_url": "https://api.github.com/users/siladu/following{/other_user}",
    "gists_url": "https://api.github.com/users/siladu/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/siladu/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/siladu/subscriptions",
    "organizations_url": "https://api.github.com/users/siladu/orgs",
    "repos_url": "https://api.github.com/users/siladu/repos",
    "events_url": "https://api.github.com/users/siladu/events{/privacy}",
    "received_events_url": "https://api.github.com/users/siladu/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "siladu",
      "id": 2893793,
      "node_id": "MDQ6VXNlcjI4OTM3OTM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2893793?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/siladu",
      "html_url": "https://github.com/siladu",
      "followers_url": "https://api.github.com/users/siladu/followers",
      "following_url": "https://api.github.com/users/siladu/following{/other_user}",
      "gists_url": "https://api.github.com/users/siladu/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/siladu/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/siladu/subscriptions",
      "organizations_url": "https://api.github.com/users/siladu/orgs",
      "repos_url": "https://api.github.com/users/siladu/repos",
      "events_url": "https://api.github.com/users/siladu/events{/privacy}",
      "received_events_url": "https://api.github.com/users/siladu/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 0,
  "created_at": "2021-11-11T05:29:49Z",
  "updated_at": "2021-11-15T05:28:35Z",
  "closed_at": "2021-11-15T05:28:35Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "Currently, when we transition from `contract` to `blockheader` mode, we are retrieving the previous block's validators from the contract since there are no validators in the previous block's extra data. Using the previous block's validators isn't necessarily what the user wants to do when they transition, it's just a best guess. They also have the option of specifying a list of `validators` which will override whatever else was going to be used for that block.\r\n\r\nWhen no validator overrides are specified, the above approach currently [suffers from a bug where a stale or empty list of validators are incorrectly used following the blockheader transition](https://github.com/hyperledger/besu/issues/3019). The `VoteTallyCache` is only used with blockheader mode so this causes complexity in repopulating it: we would have to make the cache aware of the previous block's contract validators. This would also impact other BFT code.\r\n\r\nThis proposed change is to force the configurer to specify `validators` at the same time as transitioning into `blockheader` mode. This means the cache doesn't need populating since the [`ForkingVoteTallyCache` already supports this](https://github.com/hyperledger/besu/blob/00b81b6c4b392d8fbc00576ab66ebfd3da586db7/consensus/common/src/main/java/org/hyperledger/besu/consensus/common/validator/blockbased/ForkingVoteTallyCache.java#L40-L49).\r\n\r\nTherefore this transition config would no longer be valid:\r\n```\r\n\"transitions\": {\r\n  \"qbft\": [\r\n    {\r\n      \"block\": 10,\r\n      \"validatorselectionmode\": \"blockheader\"\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\nIf `\"validatorselectionmode\": \"blockheader\"` is present at start up we should error, ensuring that a non-empty validator list is also specified, i.e. \r\n\r\n```\r\n\"transitions\": {\r\n  \"qbft\": [\r\n    {\r\n      \"block\": 1,\r\n      \"validatorselectionmode\": \"blockheader\",\r\n      \"validators\": [\r\n        \"<0xValidatorAddress1>\"\r\n      ]\r\n    }\r\n  ]\r\n}\r\n```",
  "closed_by": {
    "login": "lucassaldanha",
    "id": 1766440,
    "node_id": "MDQ6VXNlcjE3NjY0NDA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1766440?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/lucassaldanha",
    "html_url": "https://github.com/lucassaldanha",
    "followers_url": "https://api.github.com/users/lucassaldanha/followers",
    "following_url": "https://api.github.com/users/lucassaldanha/following{/other_user}",
    "gists_url": "https://api.github.com/users/lucassaldanha/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/lucassaldanha/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/lucassaldanha/subscriptions",
    "organizations_url": "https://api.github.com/users/lucassaldanha/orgs",
    "repos_url": "https://api.github.com/users/lucassaldanha/repos",
    "events_url": "https://api.github.com/users/lucassaldanha/events{/privacy}",
    "received_events_url": "https://api.github.com/users/lucassaldanha/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/3038/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/hyperledger/besu/issues/3038/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[

]
