{
  "url": "https://api.github.com/repos/hyperledger/besu/issues/3322",
  "repository_url": "https://api.github.com/repos/hyperledger/besu",
  "labels_url": "https://api.github.com/repos/hyperledger/besu/issues/3322/labels{/name}",
  "comments_url": "https://api.github.com/repos/hyperledger/besu/issues/3322/comments",
  "events_url": "https://api.github.com/repos/hyperledger/besu/issues/3322/events",
  "html_url": "https://github.com/hyperledger/besu/issues/3322",
  "id": 1113429311,
  "node_id": "I_kwDODE2jmc5CXZU_",
  "number": 3322,
  "title": "Connecting to self | reported by logs and admin_peers RPC",
  "user": {
    "login": "siladu",
    "id": 2893793,
    "node_id": "MDQ6VXNlcjI4OTM3OTM=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2893793?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/siladu",
    "html_url": "https://github.com/siladu",
    "followers_url": "https://api.github.com/users/siladu/followers",
    "following_url": "https://api.github.com/users/siladu/following{/other_user}",
    "gists_url": "https://api.github.com/users/siladu/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/siladu/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/siladu/subscriptions",
    "organizations_url": "https://api.github.com/users/siladu/orgs",
    "repos_url": "https://api.github.com/users/siladu/repos",
    "events_url": "https://api.github.com/users/siladu/events{/privacy}",
    "received_events_url": "https://api.github.com/users/siladu/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1537362490,
      "node_id": "MDU6TGFiZWwxNTM3MzYyNDkw",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/bug",
      "name": "bug",
      "color": "d73a4a",
      "default": true,
      "description": "Something isn't working"
    },
    {
      "id": 2051683573,
      "node_id": "MDU6TGFiZWwyMDUxNjgzNTcz",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/P3",
      "name": "P3",
      "color": "ffff00",
      "default": false,
      "description": "Medium (ex: JSON-RPC request not working with a specific client library due to loose spec assumtion)"
    },
    {
      "id": 3013559202,
      "node_id": "MDU6TGFiZWwzMDEzNTU5MjAy",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/mainnet",
      "name": "mainnet",
      "color": "9D578C",
      "default": false,
      "description": ""
    },
    {
      "id": 3805591260,
      "node_id": "LA_kwDODE2jmc7i1Lbc",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/peering",
      "name": "peering",
      "color": "006b75",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 7,
  "created_at": "2022-01-25T05:03:20Z",
  "updated_at": "2022-06-28T20:12:16Z",
  "closed_at": "2022-02-03T01:15:11Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "Both besu logs and admin_peers RPC show an unexpected number of peers. Other than misreporting, this might be a memory leak because after several days of uptime, the admin_peers response is ~2MB when there are ~3000 duplicate peers reported. \r\n\r\nThe duplicate peer is the node's own enode.\r\n\r\nNote, grafana metrics show the expected number of peers.\r\nRestarting the node resets the peer count, so it is probably a bug in some besu internal state.\r\n\r\nThis issue was discovered while on a dev AKS network using the default configuration at this point in time: https://github.com/ConsenSys/quorum-kubernetes/tree/ec44966433264affb1434f3be34f0b478cfa4c76\r\n\r\nPotentially significant config:\r\n* All nodes use same static-nodes.json which contains all nodes.\r\n* ~discovery enabled~ ruled out see comments\r\n* ~Xdns-enabled/Xdns-update-enabled~ ruled out see comments\r\n* IBFT2\r\n* DEBUG log level\r\n\r\n### Steps to Reproduce with minimal local setup\r\n1. https://github.com/siladu/besu-duplicate-peers\r\n\r\n### Steps to Reproduce locally with Docker\r\n1. `npx quorum-dev-quickstart`\r\n2. Enable DEBUG logging and update `.env` with `BESU_VERSION` (I used `latest` but it's failed on `develop` as well)\r\n3. `./run.sh`\r\n4. Confirm that 4 validators and 1 rpcnode are running and leave it running for > 1 hour\r\n5. admin_peers will return self-referential enode entries for the rpcnode (roughly +1 per hour):\r\n```\r\ncurl --location --request POST 'http://localhost:8545' \\\r\n--header 'Content-Type: application/json' \\\r\n--data-raw '{\r\n    \"jsonrpc\": \"2.0\",\r\n    \"method\": \"admin_peers\",\r\n    \"params\": [],\r\n    \"id\": 1\r\n}' | jq '.result | .[] | .enode' | sort | uniq -c\r\n```\r\n\r\n### Steps to Reproduce on AKS\r\n1. Deploy network to AKS as per: https://github.com/ConsenSys/quorum-kubernetes/blob/master/dev/README.md\r\n2. Add RPC node(s) and leave network running\r\n3. See too many peers in the RPC logs\r\n4. Use admin_peers RPC to see that there are duplicate peers\r\n\r\n**Expected behavior:**\r\nPeers should remain constant and aligned with static nodes.\r\n\r\n**Actual behavior:**\r\nadmin_peers RPC returns duplicate results for rpc node itself. On this AKS network a duplicate is being added every 15-20 blocks:\r\n\r\n```\r\n$ curl --location --request POST 'http://localhost:8545' \\\r\n--header 'Content-Type: application/json' \\\r\n--data-raw '{\r\n    \"jsonrpc\": \"2.0\",\r\n    \"method\": \"admin_peers\",\r\n    \"params\": [],\r\n    \"id\": 1\r\n}' | jq '.result | .[] | .enode' | sort | uniq -c\r\n   1 \"enode://11d9eef174cff4ab6da4f868a893c224d7caeef0ab06d28b067e86526860fb3896cc2aecf066376c4d0759823293e461e719a67006590b724be3d558ae5a583e@besu-node-validator-3-0.besu-node-validator-3.quorum.svc.cluster.local:30303?discport=0\"\r\n   1 \"enode://3debcae3a106b136f7760f8c646ecbc9ecaccdc75a1848d154aaaac4180bd720ee7f31227f6ece7b33011509284bd075f97c7560970a95e615790a7f2cb024a5@10.0.0.166:30303?discport=0\"\r\n   1 \"enode://4fd6a5944900e0387444d2a18b013d8cbcebda6259a89a33edc46913d3d9036243ed3361fad2efb82121457fa4b59e440f8a39af7bbcfd1dd8a821d12f5fda85@besu-node-bootnode-2-0.besu-node-bootnode-2.quorum.svc.cluster.local:30303\"\r\n   1 \"enode://4fd6a5944900e0387444d2a18b013d8cbcebda6259a89a33edc46913d3d9036243ed3361fad2efb82121457fa4b59e440f8a39af7bbcfd1dd8a821d12f5fda85@10.0.0.174:30303?discport=0\"\r\n   1 \"enode://73253a0ef4939f8e19ec99fd38e40d03c7f1fe403402cf6116b0af921834ac599ad93065abec8a54ad8b1004c5db6240db601c5bc4d54fca8469ceaf6484d4c9@besu-node-validator-4-0.besu-node-validator-4.quorum.svc.cluster.local:30303?discport=0\"\r\n   1 \"enode://781818f1c9172eb5153266bc115e3d1486c5ad024a855fc32ceeeaf0a0175c11237125d883c48cfcd4fdd72fbd83b4fb49830cf0c29b2ff21bb92c7537cab93d@besu-node-validator-2-0.besu-node-validator-2.quorum.svc.cluster.local:30303?discport=0\"\r\n   1 \"enode://b875a8e82a0e38da825dee07f639a0a5a184cebedf8dd60df58e55f1cab070d60e3cbec19eedc62fc37b74a79bc6e91c931a0efb8f1be66963bb0b967c485d78@10.0.2.69:30303?discport=0\"\r\n2279 \"enode://d8a84770d66121bda4f2952798bb7016122f8e32c07e265a65575a02da6bc182e774fc11918771e3f2f3bab24d22d871aba4b1afb494c1c9e298b1eebe7de903@besu-node-rpc-1-0.besu-node-rpc-1.quorum.svc.cluster.local:30303?discport=0\"\r\n   1 \"enode://efc3453c41000f146b88d21012430abdb3d348982b47056067191a7b7e335cc2c377dc70c9b2c62c90ace15dabc99fa7ea79a839778ed838bf34abcfadae79cc@besu-node-validator-1-0.besu-node-validator-1.quorum.svc.cluster.local:30303?discport=0\"\r\n```\r\n\r\nCan also be seen in the logs:\r\n\r\n```\r\n2022-01-25 00:58:11.167+00:00 | EthScheduler-Timer-0 | DEBUG | FullSyncTargetManager | Caught up to best peer: 51612, Peers: 2699\r\n```\r\n\r\n### AKS Versions\r\n* **Software version**:\r\nbesu/v22.1.0-RC2-dev-24433205/linux-x86_64/openjdk-java-11\r\n\r\n* **Java version**\r\nopenjdk version \"11.0.13\" 2021-10-19\r\nOpenJDK Runtime Environment (build 11.0.13+8-Ubuntu-0ubuntu1.20.04)\r\nOpenJDK 64-Bit Server VM (build 11.0.13+8-Ubuntu-0ubuntu1.20.04, mixed mode, sharing)\r\n\r\n* **OS Name & Version**\r\nDISTRIB_ID=Ubuntu\r\nDISTRIB_RELEASE=20.04\r\nDISTRIB_CODENAME=focal\r\nDISTRIB_DESCRIPTION=\"Ubuntu 20.04.3 LTS\"\r\nNAME=\"Ubuntu\"\r\nVERSION=\"20.04.3 LTS (Focal Fossa)\"\r\nID=ubuntu\r\nID_LIKE=debian\r\nPRETTY_NAME=\"Ubuntu 20.04.3 LTS\"\r\nVERSION_ID=\"20.04\"\r\nHOME_URL=\"https://www.ubuntu.com/\"\r\nSUPPORT_URL=\"https://help.ubuntu.com/\"\r\nBUG_REPORT_URL=\"https://bugs.launchpad.net/ubuntu/\"\r\nPRIVACY_POLICY_URL=\"https://www.ubuntu.com/legal/terms-and-policies/privacy-policy\"\r\nVERSION_CODENAME=focal\r\nUBUNTU_CODENAME=focal\r\n\r\n* **Kernel Version**\r\nLinux besu-node-member-1-0 5.4.0-1065-azure # 68~18.04.1-Ubuntu SMP Fri Dec 3 14:08:44 UTC 2021 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n### Additional Information\r\n\r\nNot just limited to RPC nodes; querying other node types e.g. validator will also return duplicate peers where the duplicate is the validator's own enode.\r\n\r\nLocal testing with quorum-dev-quickstart has ruled out both DNS and discovery features - the issue happens whether or not they are enabled.\r\n\r\nThe admin_peers response can also contain some near-duplicates, for example bootnode-2 with and without its dns name:\r\n```\r\n\"enode://4fd6a5944900e0387444d2a18b013d8cbcebda6259a89a33edc46913d3d9036243ed3361fad2efb82121457fa4b59e440f8a39af7bbcfd1dd8a821d12f5fda85@besu-node-bootnode-2-0.besu-node-bootnode-2.quorum.svc.cluster.local:30303\"\r\n\"enode://4fd6a5944900e0387444d2a18b013d8cbcebda6259a89a33edc46913d3d9036243ed3361fad2efb82121457fa4b59e440f8a39af7bbcfd1dd8a821d12f5fda85@10.0.0.174:30303?discport=0\"\r\n```\r\n\r\nSimilar to https://github.com/hyperledger/besu/issues/2689 but this bug has seen the self-referential peer count constantly increasing.\r\n\r\nIdeas for further investigation:\r\n* Rule out IBFT2 - does this happen with ethash or clique for example?\r\n* Rule out bootnodes/static nodes",
  "closed_by": {
    "login": "macfarla",
    "id": 2627919,
    "node_id": "MDQ6VXNlcjI2Mjc5MTk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2627919?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/macfarla",
    "html_url": "https://github.com/macfarla",
    "followers_url": "https://api.github.com/users/macfarla/followers",
    "following_url": "https://api.github.com/users/macfarla/following{/other_user}",
    "gists_url": "https://api.github.com/users/macfarla/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/macfarla/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/macfarla/subscriptions",
    "organizations_url": "https://api.github.com/users/macfarla/orgs",
    "repos_url": "https://api.github.com/users/macfarla/repos",
    "events_url": "https://api.github.com/users/macfarla/events{/privacy}",
    "received_events_url": "https://api.github.com/users/macfarla/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/3322/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/hyperledger/besu/issues/3322/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1020828927",
    "html_url": "https://github.com/hyperledger/besu/issues/3322#issuecomment-1020828927",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/3322",
    "id": 1020828927,
    "node_id": "IC_kwDODE2jmc482Jz_",
    "user": {
      "login": "siladu",
      "id": 2893793,
      "node_id": "MDQ6VXNlcjI4OTM3OTM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2893793?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/siladu",
      "html_url": "https://github.com/siladu",
      "followers_url": "https://api.github.com/users/siladu/followers",
      "following_url": "https://api.github.com/users/siladu/following{/other_user}",
      "gists_url": "https://api.github.com/users/siladu/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/siladu/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/siladu/subscriptions",
      "organizations_url": "https://api.github.com/users/siladu/orgs",
      "repos_url": "https://api.github.com/users/siladu/repos",
      "events_url": "https://api.github.com/users/siladu/events{/privacy}",
      "received_events_url": "https://api.github.com/users/siladu/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-01-25T05:34:14Z",
    "updated_at": "2022-01-25T05:34:14Z",
    "author_association": "CONTRIBUTOR",
    "body": "For reference, static-nodes.json:\r\n```\r\nStatic nodes:\r\n[\r\n\"enode://11d9eef174cff4ab6da4f868a893c224d7caeef0ab06d28b067e86526860fb3896cc2aecf066376c4d0759823293e461e719a67006590b724be3d558ae5a583e@besu-node-validator-3-0.besu-node-validator-3.quorum.svc.cluster.local:30303?discport=0\",\r\n\"enode://3debcae3a106b136f7760f8c646ecbc9ecaccdc75a1848d154aaaac4180bd720ee7f31227f6ece7b33011509284bd075f97c7560970a95e615790a7f2cb024a5@besu-node-rpc-2-0.besu-node-rpc-2.quorum.svc.cluster.local:30303?discport=0\",\r\n\"enode://4fd6a5944900e0387444d2a18b013d8cbcebda6259a89a33edc46913d3d9036243ed3361fad2efb82121457fa4b59e440f8a39af7bbcfd1dd8a821d12f5fda85@besu-node-bootnode-2-0.besu-node-bootnode-2.quorum.svc.cluster.local:30303?discport=0\",\r\n\"enode://73253a0ef4939f8e19ec99fd38e40d03c7f1fe403402cf6116b0af921834ac599ad93065abec8a54ad8b1004c5db6240db601c5bc4d54fca8469ceaf6484d4c9@besu-node-validator-4-0.besu-node-validator-4.quorum.svc.cluster.local:30303?discport=0\",\r\n\"enode://781818f1c9172eb5153266bc115e3d1486c5ad024a855fc32ceeeaf0a0175c11237125d883c48cfcd4fdd72fbd83b4fb49830cf0c29b2ff21bb92c7537cab93d@besu-node-validator-2-0.besu-node-validator-2.quorum.svc.cluster.local:30303?discport=0\",\r\n\"enode://b875a8e82a0e38da825dee07f639a0a5a184cebedf8dd60df58e55f1cab070d60e3cbec19eedc62fc37b74a79bc6e91c931a0efb8f1be66963bb0b967c485d78@besu-node-bootnode-1-0.besu-node-bootnode-1.quorum.svc.cluster.local:30303?discport=0\",\r\n\"enode://c4b9379926471822bab5b70bb63ec23516648052fc47352436936f83120fef78227e08bb2d6a24bc8e411100f788baf3972574906eb9662292df658ac4601343@besu-node-member-1-0.besu-node-member-1.quorum.svc.cluster.local:30303?discport=0\",\r\n\"enode://d8a84770d66121bda4f2952798bb7016122f8e32c07e265a65575a02da6bc182e774fc11918771e3f2f3bab24d22d871aba4b1afb494c1c9e298b1eebe7de903@besu-node-rpc-1-0.besu-node-rpc-1.quorum.svc.cluster.local:30303?discport=0\",\r\n\"enode://efc3453c41000f146b88d21012430abdb3d348982b47056067191a7b7e335cc2c377dc70c9b2c62c90ace15dabc99fa7ea79a839778ed838bf34abcfadae79cc@besu-node-validator-1-0.besu-node-validator-1.quorum.svc.cluster.local:30303?discport=0\"\r\n]\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1020828927/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1020829438",
    "html_url": "https://github.com/hyperledger/besu/issues/3322#issuecomment-1020829438",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/3322",
    "id": 1020829438,
    "node_id": "IC_kwDODE2jmc482J7-",
    "user": {
      "login": "siladu",
      "id": 2893793,
      "node_id": "MDQ6VXNlcjI4OTM3OTM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2893793?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/siladu",
      "html_url": "https://github.com/siladu",
      "followers_url": "https://api.github.com/users/siladu/followers",
      "following_url": "https://api.github.com/users/siladu/following{/other_user}",
      "gists_url": "https://api.github.com/users/siladu/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/siladu/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/siladu/subscriptions",
      "organizations_url": "https://api.github.com/users/siladu/orgs",
      "repos_url": "https://api.github.com/users/siladu/repos",
      "events_url": "https://api.github.com/users/siladu/events{/privacy}",
      "received_events_url": "https://api.github.com/users/siladu/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-01-25T05:35:40Z",
    "updated_at": "2022-01-25T05:35:40Z",
    "author_association": "CONTRIBUTOR",
    "body": "DEBUG logs covering the period during which the duplicate peer count increased:\r\n```\r\n2022-01-25 00:58:06.166+00:00 | EthScheduler-Timer-0 | DEBUG | FullSyncTargetManager | Caught up to best peer: 51612, Peers: 2698\r\n2022-01-25 00:58:06.167+00:00 | EthScheduler-Timer-0 | DEBUG | WaitForPeerTask | Waiting for new peer connection. 2698 peers currently connected.\r\n2022-01-25 00:58:06.608+00:00 | vert.x-eventloop-thread-1 | DEBUG | PeerDiscoveryController | Peer table refresh triggered by insufficient peers\r\n2022-01-25 00:58:06.608+00:00 | vert.x-eventloop-thread-1 | DEBUG | RecursivePeerRefreshState | Start peer search.\r\n2022-01-25 00:58:06.608+00:00 | vert.x-eventloop-thread-1 | DEBUG | RecursivePeerRefreshState | Skipping bonding round because no candidates are available\r\n2022-01-25 00:58:06.608+00:00 | vert.x-eventloop-thread-1 | DEBUG | RecursivePeerRefreshState | Initiating neighbours round with 3 candidates from 8 tracked nodes\r\n2022-01-25 00:58:06.616+00:00 | vert.x-eventloop-thread-1 | DEBUG | RecursivePeerRefreshState | Received neighbours packet with 8 neighbours\r\n2022-01-25 00:58:06.617+00:00 | vert.x-eventloop-thread-1 | DEBUG | RecursivePeerRefreshState | Received neighbours packet with 8 neighbours\r\n2022-01-25 00:58:06.617+00:00 | vert.x-eventloop-thread-1 | DEBUG | RecursivePeerRefreshState | Received neighbours packet with 8 neighbours\r\n2022-01-25 00:58:06.617+00:00 | vert.x-eventloop-thread-1 | DEBUG | RecursivePeerRefreshState | Skipping bonding round because no candidates are available\r\n2022-01-25 00:58:06.617+00:00 | vert.x-eventloop-thread-1 | DEBUG | RecursivePeerRefreshState | Initiating neighbours round with 3 candidates from 8 tracked nodes\r\n2022-01-25 00:58:06.619+00:00 | vert.x-eventloop-thread-1 | DEBUG | RecursivePeerRefreshState | Received neighbours packet with 8 neighbours\r\n2022-01-25 00:58:06.619+00:00 | vert.x-eventloop-thread-1 | DEBUG | RecursivePeerRefreshState | Received neighbours packet with 8 neighbours\r\n2022-01-25 00:58:06.620+00:00 | vert.x-eventloop-thread-1 | DEBUG | RecursivePeerRefreshState | Received neighbours packet with 7 neighbours\r\n2022-01-25 00:58:06.620+00:00 | vert.x-eventloop-thread-1 | DEBUG | RecursivePeerRefreshState | Skipping bonding round because no candidates are available\r\n2022-01-25 00:58:06.620+00:00 | vert.x-eventloop-thread-1 | DEBUG | RecursivePeerRefreshState | Initiating neighbours round with 2 candidates from 8 tracked nodes\r\n2022-01-25 00:58:06.621+00:00 | vert.x-eventloop-thread-1 | DEBUG | RecursivePeerRefreshState | Received neighbours packet with 8 neighbours\r\n2022-01-25 00:58:06.621+00:00 | vert.x-eventloop-thread-1 | DEBUG | RecursivePeerRefreshState | Received neighbours packet with 8 neighbours\r\n2022-01-25 00:58:06.621+00:00 | vert.x-eventloop-thread-1 | DEBUG | RecursivePeerRefreshState | Skipping bonding round because no candidates are available\r\n2022-01-25 00:58:06.621+00:00 | vert.x-eventloop-thread-1 | DEBUG | RecursivePeerRefreshState | Iterative peer search complete.  8 peers processed over 4 rounds.\r\n2022-01-25 00:58:10.843+00:00 | nioEventLoopGroup-3-2 | DEBUG | HandshakeHandlerOutbound | Wrote initial crypto handshake message to besu-node-rpc-1-0.besu-node-rpc-1.quorum.svc.cluster.local/10.0.2.2:30303.\r\n2022-01-25 00:58:10.848+00:00 | nioEventLoopGroup-3-2 | DEBUG | RlpxAgent | Outbound connection established to peer: 0xd8a84770d66121bda4f2952798bb7016122f8e32c07e265a65575a02da6bc182e774fc11918771e3f2f3bab24d22d871aba4b1afb494c1c9e298b1eebe7de903\r\n2022-01-25 00:58:10.848+00:00 | nioEventLoopGroup-3-3 | DEBUG | RlpxAgent | Duplicate connection detected, disconnecting previously established connection in favor of new inbound connection for peer:  0xd8a84770d66121bda4f2952798bb7016122f8e32c07e265a65575a02da6bc182e774fc11918771e3f2f3bab24d22d871aba4b1afb494c1c9e298b1eebe7de903\r\n2022-01-25 00:58:10.848+00:00 | nioEventLoopGroup-3-3 | DEBUG | EthProtocolManager | Disconnect - Outbound - 0x05 ALREADY_CONNECTED - PeerInfo{version=5, clientId='besu/v22.1.0-RC2-dev-24433205/linux-x86_64/openjdk-java-11', capabilities=[eth/62, eth/63, eth/64, eth/65, eth/66, IBF/1], port=30303, nodeId=0xd8a84770d66121bda4f2952798bb7016122f8e32c07e265a65575a02da6bc182e774fc11918771e3f2f3bab24d22d871aba4b1afb494c1c9e298b1eebe7de903} - 2698 peers left\r\n2022-01-25 00:58:10.848+00:00 | nioEventLoopGroup-3-2 | DEBUG | EthProtocolManager | Sending status message to Peer 0xd8a84770d66121bda4....\r\n2022-01-25 00:58:10.848+00:00 | nioEventLoopGroup-3-3 | DEBUG | EthProtocolManager | Sending status message to Peer 0xd8a84770d66121bda4....\r\n2022-01-25 00:58:10.848+00:00 | nioEventLoopGroup-3-3 | DEBUG | EthProtocolManager | Disconnect - Inbound - 0x05 ALREADY_CONNECTED - PeerInfo{version=5, clientId='besu/v22.1.0-RC2-dev-24433205/linux-x86_64/openjdk-java-11', capabilities=[eth/62, eth/63, eth/64, eth/65, eth/66, IBF/1], port=30303, nodeId=0xd8a84770d66121bda4f2952798bb7016122f8e32c07e265a65575a02da6bc182e774fc11918771e3f2f3bab24d22d871aba4b1afb494c1c9e298b1eebe7de903} - 2699 peers left\r\n2022-01-25 00:58:10.848+00:00 | nioEventLoopGroup-3-2 | DEBUG | EthProtocolManager | Received status message from Peer 0xd8a84770d66121bda4...: org.hyperledger.besu.ethereum.eth.messages.StatusMessage@f7ddf7e2\r\n2022-01-25 00:58:11.167+00:00 | EthScheduler-Timer-0 | DEBUG | FullSyncTargetManager | Caught up to best peer: 51612, Peers: 2699\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1020829438/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1020990432",
    "html_url": "https://github.com/hyperledger/besu/issues/3322#issuecomment-1020990432",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/3322",
    "id": 1020990432,
    "node_id": "IC_kwDODE2jmc482xPg",
    "user": {
      "login": "siladu",
      "id": 2893793,
      "node_id": "MDQ6VXNlcjI4OTM3OTM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2893793?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/siladu",
      "html_url": "https://github.com/siladu",
      "followers_url": "https://api.github.com/users/siladu/followers",
      "following_url": "https://api.github.com/users/siladu/following{/other_user}",
      "gists_url": "https://api.github.com/users/siladu/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/siladu/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/siladu/subscriptions",
      "organizations_url": "https://api.github.com/users/siladu/orgs",
      "repos_url": "https://api.github.com/users/siladu/repos",
      "events_url": "https://api.github.com/users/siladu/events{/privacy}",
      "received_events_url": "https://api.github.com/users/siladu/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-01-25T09:39:33Z",
    "updated_at": "2022-01-25T09:41:29Z",
    "author_association": "CONTRIBUTOR",
    "body": "Have recreated on a local docker network (quorum-dev-quickstart) with **dns disabled** but discovery enabled.\r\nIt just takes a while for the duplicates to appear (network was up for 3 hours)...\r\n\r\n```\r\ncurl --location --request POST 'http://localhost:8545' \\\r\n--header 'Content-Type: application/json' \\\r\n--data-raw '{\r\n    \"jsonrpc\": \"2.0\",\r\n    \"method\": \"admin_peers\",\r\n    \"params\": [],\r\n    \"id\": 1\r\n}' | jq '.result | .[] | .enode' | sort | uniq -c\r\n   1 \"enode://2fd5b5b6ad529f55b71602026d1849d0036f06482368b5812fa793014195d3571b0840dbc4175617de2a12db8f1222c012420d471ae5c0d982118625cae58868@172.16.239.14:30303?discport=0\"\r\n   1 \"enode://59cf0c623c582fa9b19bdf70fb6bade07f4ae32218dd4d1c7e2c7e65acf87da45cf2ab55d16d27360aafef17622c37c09db60d7680ebcc17b78867f4c05bcaa4@172.16.239.13:30303\"\r\n   1 \"enode://8208a3f344695d44e9cf2c023683cbea7b9343e2f70a5e804bd2c93858e945f8f91439eef96a4ab6c47ff06637d6fbe6472f96de1655a1bee57ea896654f3a22@172.16.239.11:30303\"\r\n   3 \"enode://86fcc16f4730fbfd238dc17ea552854c0943923bb1d5e886e5601b8d884fb0519060e0023f495dd24ffe60a65660fb7fdcdebfceedd2b3673dfa63658825924b@172.16.239.15:30303\"\r\n   1 \"enode://b9050e002aa42464e6b07c811a1f9dfec01249af03f67b753e8415420649b184447bb2a784863ccbf327ad9e31aaba803464979dfe6a7facc669151a5fa6ad1b@172.16.239.12:30303\"\r\n   ```\r\n\r\nwhere rpc node queried is and static-nodes.json is: `86fcc16f4730fbfd238dc17ea552854c0943923bb1d5e886e5601b8d884fb0519060e0023f495dd24ffe60a65660fb7fdcdebfceedd2b3673dfa63658825924b`\r\n```\r\n[\r\n\"enode://8208a3f344695d44e9cf2c023683cbea7b9343e2f70a5e804bd2c93858e945f8f91439eef96a4ab6c47ff06637d6fbe6472f96de1655a1bee57ea896654f3a22@172.16.239.11:30303\",\r\n\"enode://b9050e002aa42464e6b07c811a1f9dfec01249af03f67b753e8415420649b184447bb2a784863ccbf327ad9e31aaba803464979dfe6a7facc669151a5fa6ad1b@172.16.239.12:30303\",\r\n\"enode://59cf0c623c582fa9b19bdf70fb6bade07f4ae32218dd4d1c7e2c7e65acf87da45cf2ab55d16d27360aafef17622c37c09db60d7680ebcc17b78867f4c05bcaa4@172.16.239.13:30303\",\r\n\"enode://2fd5b5b6ad529f55b71602026d1849d0036f06482368b5812fa793014195d3571b0840dbc4175617de2a12db8f1222c012420d471ae5c0d982118625cae58868@172.16.239.14:30303\",\r\n\"enode://86fcc16f4730fbfd238dc17ea552854c0943923bb1d5e886e5601b8d884fb0519060e0023f495dd24ffe60a65660fb7fdcdebfceedd2b3673dfa63658825924b@172.16.239.15:30303\"\r\n]\r\n```\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1020990432/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1021681275",
    "html_url": "https://github.com/hyperledger/besu/issues/3322#issuecomment-1021681275",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/3322",
    "id": 1021681275,
    "node_id": "IC_kwDODE2jmc485Z57",
    "user": {
      "login": "siladu",
      "id": 2893793,
      "node_id": "MDQ6VXNlcjI4OTM3OTM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2893793?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/siladu",
      "html_url": "https://github.com/siladu",
      "followers_url": "https://api.github.com/users/siladu/followers",
      "following_url": "https://api.github.com/users/siladu/following{/other_user}",
      "gists_url": "https://api.github.com/users/siladu/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/siladu/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/siladu/subscriptions",
      "organizations_url": "https://api.github.com/users/siladu/orgs",
      "repos_url": "https://api.github.com/users/siladu/repos",
      "events_url": "https://api.github.com/users/siladu/events{/privacy}",
      "received_events_url": "https://api.github.com/users/siladu/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-01-25T22:49:08Z",
    "updated_at": "2022-01-25T23:30:23Z",
    "author_association": "CONTRIBUTOR",
    "body": "Recreated locally with quorum-dev-quickstart:\r\n* DNS enabled and discovery disabled (12 duplicates over 9 hours)\r\n* DNS disabled and discovery disabled (3 duplicates over 3 hours)\r\n\r\nSo I think this rules out both DNS and p2p discovery.",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1021681275/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1023743012",
    "html_url": "https://github.com/hyperledger/besu/issues/3322#issuecomment-1023743012",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/3322",
    "id": 1023743012,
    "node_id": "IC_kwDODE2jmc49BRQk",
    "user": {
      "login": "siladu",
      "id": 2893793,
      "node_id": "MDQ6VXNlcjI4OTM3OTM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2893793?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/siladu",
      "html_url": "https://github.com/siladu",
      "followers_url": "https://api.github.com/users/siladu/followers",
      "following_url": "https://api.github.com/users/siladu/following{/other_user}",
      "gists_url": "https://api.github.com/users/siladu/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/siladu/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/siladu/subscriptions",
      "organizations_url": "https://api.github.com/users/siladu/orgs",
      "repos_url": "https://api.github.com/users/siladu/repos",
      "events_url": "https://api.github.com/users/siladu/events{/privacy}",
      "received_events_url": "https://api.github.com/users/siladu/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-01-27T23:42:06Z",
    "updated_at": "2022-01-27T23:42:06Z",
    "author_association": "CONTRIBUTOR",
    "body": "Updated description with how to recreate with a minimal local setup: https://github.com/siladu/besu-duplicate-peers",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1023743012/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1028511561",
    "html_url": "https://github.com/hyperledger/besu/issues/3322#issuecomment-1028511561",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/3322",
    "id": 1028511561,
    "node_id": "IC_kwDODE2jmc49TddJ",
    "user": {
      "login": "macfarla",
      "id": 2627919,
      "node_id": "MDQ6VXNlcjI2Mjc5MTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2627919?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/macfarla",
      "html_url": "https://github.com/macfarla",
      "followers_url": "https://api.github.com/users/macfarla/followers",
      "following_url": "https://api.github.com/users/macfarla/following{/other_user}",
      "gists_url": "https://api.github.com/users/macfarla/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/macfarla/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/macfarla/subscriptions",
      "organizations_url": "https://api.github.com/users/macfarla/orgs",
      "repos_url": "https://api.github.com/users/macfarla/repos",
      "events_url": "https://api.github.com/users/macfarla/events{/privacy}",
      "received_events_url": "https://api.github.com/users/macfarla/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-02-03T01:15:11Z",
    "updated_at": "2022-02-03T01:15:11Z",
    "author_association": "CONTRIBUTOR",
    "body": "connecting to self should be fixed now",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1028511561/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1028531483",
    "html_url": "https://github.com/hyperledger/besu/issues/3322#issuecomment-1028531483",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/3322",
    "id": 1028531483,
    "node_id": "IC_kwDODE2jmc49TiUb",
    "user": {
      "login": "macfarla",
      "id": 2627919,
      "node_id": "MDQ6VXNlcjI2Mjc5MTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2627919?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/macfarla",
      "html_url": "https://github.com/macfarla",
      "followers_url": "https://api.github.com/users/macfarla/followers",
      "following_url": "https://api.github.com/users/macfarla/following{/other_user}",
      "gists_url": "https://api.github.com/users/macfarla/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/macfarla/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/macfarla/subscriptions",
      "organizations_url": "https://api.github.com/users/macfarla/orgs",
      "repos_url": "https://api.github.com/users/macfarla/repos",
      "events_url": "https://api.github.com/users/macfarla/events{/privacy}",
      "received_events_url": "https://api.github.com/users/macfarla/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-02-03T01:59:29Z",
    "updated_at": "2022-02-03T01:59:29Z",
    "author_association": "CONTRIBUTOR",
    "body": "still investigating duplicates in https://github.com/hyperledger/besu/issues/2689",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1028531483/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
