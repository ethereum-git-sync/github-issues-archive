{
  "url": "https://api.github.com/repos/hyperledger/besu/issues/4320",
  "repository_url": "https://api.github.com/repos/hyperledger/besu",
  "labels_url": "https://api.github.com/repos/hyperledger/besu/issues/4320/labels{/name}",
  "comments_url": "https://api.github.com/repos/hyperledger/besu/issues/4320/comments",
  "events_url": "https://api.github.com/repos/hyperledger/besu/issues/4320/events",
  "html_url": "https://github.com/hyperledger/besu/issues/4320",
  "id": 1353087177,
  "node_id": "I_kwDODE2jmc5QpnjJ",
  "number": 4320,
  "title": "Do not ban (static) peers for late responses",
  "user": {
    "login": "pietjepuk2",
    "id": 75548277,
    "node_id": "MDQ6VXNlcjc1NTQ4Mjc3",
    "avatar_url": "https://avatars.githubusercontent.com/u/75548277?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/pietjepuk2",
    "html_url": "https://github.com/pietjepuk2",
    "followers_url": "https://api.github.com/users/pietjepuk2/followers",
    "following_url": "https://api.github.com/users/pietjepuk2/following{/other_user}",
    "gists_url": "https://api.github.com/users/pietjepuk2/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/pietjepuk2/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/pietjepuk2/subscriptions",
    "organizations_url": "https://api.github.com/users/pietjepuk2/orgs",
    "repos_url": "https://api.github.com/users/pietjepuk2/repos",
    "events_url": "https://api.github.com/users/pietjepuk2/events{/privacy}",
    "received_events_url": "https://api.github.com/users/pietjepuk2/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2022-08-27T16:27:59Z",
  "updated_at": "2022-10-06T14:40:49Z",
  "closed_at": "2022-10-06T14:40:49Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "## Usecase\r\n(same backstory as #3801) I want to sync my Besu node against a single local (Geth) node, and not connect to the wider internet. The Besu node is in the `trusted-nodes.json` file of Geth, and the Geth node is in the `static-nodes.json` of Besu. \r\n\r\nFor completeness sake, my command line is `./besu --data-storage-format=bonsai --p2p-port=30303 --sync-mode=FAST --fast-sync-min-peers=1 --discovery-enabled=false` (same behavior with `X_SNAP`)\r\n\r\n## Issue\r\n(Possibly related to #4294)\r\nWhen using the command line above, I eventually get a situation where Geth takes _slightly_ too long to respond, e.g. 5.1 seconds. Besu has already considered the request to be timed out, and severely punishes the peer by disconnecting right away with `BREACH_OF_PROTOCOL`. It also never reconnects to it (which is unlike Geth/Nethermind, at least for static nodes).\r\n\r\nThe offending bit of code is https://github.com/hyperledger/besu/blob/113bd54c6b0ff748a3ed23f2e89fa31a4cb73795/ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/manager/RequestManager.java#L70-L93\r\n\r\nI reproduced this issue on Besu/Geth/Nethermind by slightly [modifying Geth ](https://github.com/ethereum/go-ethereum/compare/master...pietjepuk2:go-ethereum:sometimes-delay-response-trusted-nodes) to delay the response to the Nth GetHeaders request.\r\n\r\n## Other clients behavior\r\n- Geth doesn't disconnect on late replies. It does requests sequentially it seems, and just waits with sending a new request until it gets a response (waits more than 10 seconds at least). If I delay the response with a minute, Geth just disconnects the peer after ~40-50 seconds before reconnecting to it a few seconds later.\r\n- Nethermind is a bit weird in that it continuously disconnects and reconnects every minute or so. It doesn't punish a late response (>5 seconds), but either way always reconnects.\r\n- (Not entirely sure). Late responses were probably not punished by Besu with Eth65 (i.e. no `RequestId`). I couldn't quite understand the code (or test it), but my gut feeling is that it just skipped processing the late response or handled it anyway.\r\n\r\n## Suggested solutions\r\n1. Just `LOG.debug(\"Request ID incorrect (BREACH_OF_PROTOCOL), disconnecting peer {}\", peer);` but don't disconnect the peer. Maybe decrease peer reputation.\r\n2. Keep track of timed-out request ids, and if response is in one of them -> ignore. If it's not -> disconnect.\r\n\r\n## Sidenotes\r\n- Even after disconnecting, whether it be \"BREACH_OF_PROTOCOL\" or because the reputation dropped too low, I would expect Besu to reconnect to static nodes regardless. Other clients seem to do so anyway.\r\n- I have at least one logging of Besu receiving a response _barely_ within 5 seconds (in `RequestManager`), but `AbstractPeerRequestTask` still timing out on it ~200 ms later. The processing or delay on Besu's side surely shouldn't be part of the 5 seconds timeout window? \r\n",
  "closed_by": {
    "login": "jflo",
    "id": 345937,
    "node_id": "MDQ6VXNlcjM0NTkzNw==",
    "avatar_url": "https://avatars.githubusercontent.com/u/345937?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jflo",
    "html_url": "https://github.com/jflo",
    "followers_url": "https://api.github.com/users/jflo/followers",
    "following_url": "https://api.github.com/users/jflo/following{/other_user}",
    "gists_url": "https://api.github.com/users/jflo/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jflo/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jflo/subscriptions",
    "organizations_url": "https://api.github.com/users/jflo/orgs",
    "repos_url": "https://api.github.com/users/jflo/repos",
    "events_url": "https://api.github.com/users/jflo/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jflo/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/4320/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/hyperledger/besu/issues/4320/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1232951481",
    "html_url": "https://github.com/hyperledger/besu/issues/4320#issuecomment-1232951481",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/4320",
    "id": 1232951481,
    "node_id": "IC_kwDODE2jmc5JfVi5",
    "user": {
      "login": "non-fungible-nelson",
      "id": 85905982,
      "node_id": "MDQ6VXNlcjg1OTA1OTgy",
      "avatar_url": "https://avatars.githubusercontent.com/u/85905982?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/non-fungible-nelson",
      "html_url": "https://github.com/non-fungible-nelson",
      "followers_url": "https://api.github.com/users/non-fungible-nelson/followers",
      "following_url": "https://api.github.com/users/non-fungible-nelson/following{/other_user}",
      "gists_url": "https://api.github.com/users/non-fungible-nelson/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/non-fungible-nelson/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/non-fungible-nelson/subscriptions",
      "organizations_url": "https://api.github.com/users/non-fungible-nelson/orgs",
      "repos_url": "https://api.github.com/users/non-fungible-nelson/repos",
      "events_url": "https://api.github.com/users/non-fungible-nelson/events{/privacy}",
      "received_events_url": "https://api.github.com/users/non-fungible-nelson/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-31T13:38:20Z",
    "updated_at": "2022-08-31T13:38:20Z",
    "author_association": "CONTRIBUTOR",
    "body": "Thanks for this suggestion - this is a great catch here. We likely will not be able to prioritize this for our next release but will look to fix as soon as we can after the Merge. We will also look for additional mitigations in the short term. If you have any experience with Java and would like help writing and implementing a change, let us know. ",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1232951481/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1242074143",
    "html_url": "https://github.com/hyperledger/besu/issues/4320#issuecomment-1242074143",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/4320",
    "id": 1242074143,
    "node_id": "IC_kwDODE2jmc5KCIwf",
    "user": {
      "login": "pietjepuk2",
      "id": 75548277,
      "node_id": "MDQ6VXNlcjc1NTQ4Mjc3",
      "avatar_url": "https://avatars.githubusercontent.com/u/75548277?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pietjepuk2",
      "html_url": "https://github.com/pietjepuk2",
      "followers_url": "https://api.github.com/users/pietjepuk2/followers",
      "following_url": "https://api.github.com/users/pietjepuk2/following{/other_user}",
      "gists_url": "https://api.github.com/users/pietjepuk2/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pietjepuk2/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pietjepuk2/subscriptions",
      "organizations_url": "https://api.github.com/users/pietjepuk2/orgs",
      "repos_url": "https://api.github.com/users/pietjepuk2/repos",
      "events_url": "https://api.github.com/users/pietjepuk2/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pietjepuk2/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-09T14:50:01Z",
    "updated_at": "2022-09-09T14:50:01Z",
    "author_association": "CONTRIBUTOR",
    "body": "I have been playing around today a bit, and have two small change sets. Will make a PR soon to get some feedback :)",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1242074143/reactions",
      "total_count": 2,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 1,
      "confused": 0,
      "heart": 0,
      "rocket": 1,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
