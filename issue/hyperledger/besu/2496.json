{
  "url": "https://api.github.com/repos/hyperledger/besu/issues/2496",
  "repository_url": "https://api.github.com/repos/hyperledger/besu",
  "labels_url": "https://api.github.com/repos/hyperledger/besu/issues/2496/labels{/name}",
  "comments_url": "https://api.github.com/repos/hyperledger/besu/issues/2496/comments",
  "events_url": "https://api.github.com/repos/hyperledger/besu/issues/2496/events",
  "html_url": "https://github.com/hyperledger/besu/issues/2496",
  "id": 935948836,
  "node_id": "MDU6SXNzdWU5MzU5NDg4MzY=",
  "number": 2496,
  "title": "Erroneous PING and PONG encoding of enr sequence number",
  "user": {
    "login": "holiman",
    "id": 142290,
    "node_id": "MDQ6VXNlcjE0MjI5MA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/holiman",
    "html_url": "https://github.com/holiman",
    "followers_url": "https://api.github.com/users/holiman/followers",
    "following_url": "https://api.github.com/users/holiman/following{/other_user}",
    "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
    "organizations_url": "https://api.github.com/users/holiman/orgs",
    "repos_url": "https://api.github.com/users/holiman/repos",
    "events_url": "https://api.github.com/users/holiman/events{/privacy}",
    "received_events_url": "https://api.github.com/users/holiman/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1537362490,
      "node_id": "MDU6TGFiZWwxNTM3MzYyNDkw",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/bug",
      "name": "bug",
      "color": "d73a4a",
      "default": true,
      "description": "Something isn't working"
    },
    {
      "id": 2051683248,
      "node_id": "MDU6TGFiZWwyMDUxNjgzMjQ4",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/P2",
      "name": "P2",
      "color": "ff9900",
      "default": false,
      "description": "High (ex: Degrading performance issues, unexpected behavior of core features (DevP2P, syncing, etc))"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "jflo",
    "id": 345937,
    "node_id": "MDQ6VXNlcjM0NTkzNw==",
    "avatar_url": "https://avatars.githubusercontent.com/u/345937?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jflo",
    "html_url": "https://github.com/jflo",
    "followers_url": "https://api.github.com/users/jflo/followers",
    "following_url": "https://api.github.com/users/jflo/following{/other_user}",
    "gists_url": "https://api.github.com/users/jflo/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jflo/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jflo/subscriptions",
    "organizations_url": "https://api.github.com/users/jflo/orgs",
    "repos_url": "https://api.github.com/users/jflo/repos",
    "events_url": "https://api.github.com/users/jflo/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jflo/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "jflo",
      "id": 345937,
      "node_id": "MDQ6VXNlcjM0NTkzNw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/345937?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jflo",
      "html_url": "https://github.com/jflo",
      "followers_url": "https://api.github.com/users/jflo/followers",
      "following_url": "https://api.github.com/users/jflo/following{/other_user}",
      "gists_url": "https://api.github.com/users/jflo/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jflo/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jflo/subscriptions",
      "organizations_url": "https://api.github.com/users/jflo/orgs",
      "repos_url": "https://api.github.com/users/jflo/repos",
      "events_url": "https://api.github.com/users/jflo/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jflo/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2021-07-02T17:27:20Z",
  "updated_at": "2021-07-28T21:08:09Z",
  "closed_at": "2021-07-28T21:08:09Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "The besu client does not properly encode the enr sequence number in PONG responses. \r\n\r\n\r\nSee https://github.com/hyperledger/besu/blob/e230a445bb457bbac27bf4c384da449ccbd3f043/ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/discovery/internal/PongPacketData.java#L72 \r\n\r\nEssentially, the enr sequence is written as `writeBytes( seqAsAUint64.toBytes());`\r\n\r\nExample Pong\r\n```\r\n&Pong{\r\n            To:         Endpoint{net.ParseIP(\"127.0.0.1\").To4(), 3322, 5544},\r\n            ReplyTok:   common.HexToHash(\"0x0000000000000000000000000000000000000000000000000000000000001234\").Bytes(),\r\n            Expiration: 1136239445,\r\n            ENRSeq:     0,\r\n        },\r\n```\r\n( it's UDP 3322, TCP 5544)\r\n\r\nBesu encodes the example above as `0xf83bcb847f000001820cfa8215a8a000000000000000000000000000000000000000000000000000000000000012348443b9a355880000000000000000`. \r\n```\r\nrlpdump -hex f83bcb847f000001820cfa8215a8a000000000000000000000000000000000000000000000000000000000000012348443b9a355880000000000000000\r\n[\r\n  [\r\n    7f000001,\r\n    0cfa,\r\n    15a8,\r\n  ],\r\n  0000000000000000000000000000000000000000000000000000000000001234,\r\n  43b9a355,\r\n  0000000000000000,\r\n]\r\n```\r\n\r\nIf the sequence number is `1`, it's encoded as `0xf83bcb847f000001820cfa8215a8a000000000000000000000000000000000000000000000000000000000000012348443b9a355880000000000000001`\r\n\r\n\r\n```\r\n rlpdump -hex f83bcb847f000001820cfa8215a8a000000000000000000000000000000000000000000000000000000000000012348443b9a355880000000000000001\r\n[\r\n  [\r\n    7f000001,\r\n    0cfa,\r\n    15a8,\r\n  ],\r\n  0000000000000000000000000000000000000000000000000000000000001234,\r\n  43b9a355,\r\n  0000000000000001,\r\n]\r\n```\r\nSo apparently the ENR sequence number is encoded as `8` bytes, not as an RLP integer. \r\n\r\nThis was not an _obvious_ problem until geth implemented a change in how packets are decoded, in https://github.com/ethereum/go-ethereum/commit/3e6f46caec51d82aef363632517eb5842eef6db6 . Before this change: \r\n\r\n- Any 'junk' at the end would be ignored. Thus, the `0000000000000001` element was silently discarded, the enr sequence number was always `0`, when decoding a PONG from besu. \r\n- Geth would output `f3cb847f000001820cfa8215a8a000000000000000000000000000000000000000000000000000000000000012348443b9a35580` for the zero-case\r\n\r\n```\r\nrlpdump -hex f3cb847f000001820cfa8215a8a000000000000000000000000000000000000000000000000000000000000012348443b9a35580\r\n[\r\n  [\r\n    7f000001,\r\n    0cfa,\r\n    15a8,\r\n  ],\r\n  0000000000000000000000000000000000000000000000000000000000001234,\r\n  43b9a355,\r\n  \"\",\r\n]\r\n```\r\n- Geth would output the following for the `1`-case\r\n\r\n```\r\nrlpdump -hex f3cb847f000001820cfa8215a8a000000000000000000000000000000000000000000000000000000000000012348443b9a35501\r\n[\r\n  [\r\n    7f000001,\r\n    0cfa,\r\n    15a8,\r\n  ],\r\n  0000000000000000000000000000000000000000000000000000000000001234,\r\n  43b9a355,\r\n  01,\r\n]\r\n```\r\n\r\nNow, however, geth willl reject the 'junk' at the end. \r\nOn output, geth willl output the following for the `0`-case\r\n```\r\n rlpdump -hex f2cb847f000001820cfa8215a8a000000000000000000000000000000000000000000000000000000000000012348443b9a355\r\n[\r\n  [\r\n    7f000001,\r\n    0cfa,\r\n    15a8,\r\n  ],\r\n  0000000000000000000000000000000000000000000000000000000000001234,\r\n  43b9a355,\r\n]\r\n```\r\n\r\nThis issue was found in hive\r\n\r\n![Screenshot_2021-07-02 https hivetests ethdevops io](https://user-images.githubusercontent.com/142290/124309405-f518ed80-db6a-11eb-8404-44eab4c7c275.png)\r\n\r\nUnfortunately, the test-framework also contained another false positive, which caused the 'legit' error from not always being shown (the false positive being ` PONG 'to' endpoint mismatch: got {IP:172.17.0.7 UDP:44025 TCP:44025}, want {IP:172.17.0.7 UDP:44025 TCP:0}`). \r\n\r\nI think the fix would be to just use `writeLongScalar` to write the ENR sequence number. \r\n\r\ncc @fjl @garyschulte \r\n\r\nRelated geth-pr with some encoding examples: https://github.com/ethereum/go-ethereum/pull/23155 \r\nRelated hive logs: https://hivetests.ethdevops.io/?page=v-pills-results-tab&suite=1625138437-05d8c3c144ebe42dbca73551d1d2f73a.json \r\n\r\n\r\n",
  "closed_by": {
    "login": "jflo",
    "id": 345937,
    "node_id": "MDQ6VXNlcjM0NTkzNw==",
    "avatar_url": "https://avatars.githubusercontent.com/u/345937?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jflo",
    "html_url": "https://github.com/jflo",
    "followers_url": "https://api.github.com/users/jflo/followers",
    "following_url": "https://api.github.com/users/jflo/following{/other_user}",
    "gists_url": "https://api.github.com/users/jflo/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jflo/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jflo/subscriptions",
    "organizations_url": "https://api.github.com/users/jflo/orgs",
    "repos_url": "https://api.github.com/users/jflo/repos",
    "events_url": "https://api.github.com/users/jflo/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jflo/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/2496/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/hyperledger/besu/issues/2496/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/873158904",
    "html_url": "https://github.com/hyperledger/besu/issues/2496#issuecomment-873158904",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/2496",
    "id": 873158904,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg3MzE1ODkwNA==",
    "user": {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-07-02T17:42:33Z",
    "updated_at": "2021-07-02T17:42:33Z",
    "author_association": "NONE",
    "body": "The same problem is present in PING aswell: https://github.com/hyperledger/besu/blob/e230a445bb457bbac27bf4c384da449ccbd3f043/ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/discovery/internal/PingPacketData.java ",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/873158904/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/884333192",
    "html_url": "https://github.com/hyperledger/besu/issues/2496#issuecomment-884333192",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/2496",
    "id": 884333192,
    "node_id": "IC_kwDODE2jmc40tdqI",
    "user": {
      "login": "jflo",
      "id": 345937,
      "node_id": "MDQ6VXNlcjM0NTkzNw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/345937?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jflo",
      "html_url": "https://github.com/jflo",
      "followers_url": "https://api.github.com/users/jflo/followers",
      "following_url": "https://api.github.com/users/jflo/following{/other_user}",
      "gists_url": "https://api.github.com/users/jflo/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jflo/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jflo/subscriptions",
      "organizations_url": "https://api.github.com/users/jflo/orgs",
      "repos_url": "https://api.github.com/users/jflo/repos",
      "events_url": "https://api.github.com/users/jflo/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jflo/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-07-21T16:42:34Z",
    "updated_at": "2021-07-21T16:42:34Z",
    "author_association": "CONTRIBUTOR",
    "body": "Add correct handling of IP address being optional.\nAdd correct dispatch of PONG using an array instead of a scalar, to match incoming PING ",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/884333192/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
