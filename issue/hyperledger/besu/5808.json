{
  "url": "https://api.github.com/repos/hyperledger/besu/issues/5808",
  "repository_url": "https://api.github.com/repos/hyperledger/besu",
  "labels_url": "https://api.github.com/repos/hyperledger/besu/issues/5808/labels{/name}",
  "comments_url": "https://api.github.com/repos/hyperledger/besu/issues/5808/comments",
  "events_url": "https://api.github.com/repos/hyperledger/besu/issues/5808/events",
  "html_url": "https://github.com/hyperledger/besu/issues/5808",
  "id": 1867752550,
  "node_id": "I_kwDODE2jmc5vU6Rm",
  "number": 5808,
  "title": "Rocksdb Error when Downgrading from Besu 23.7.1 to 22.10.2",
  "user": {
    "login": "sheharyar12",
    "id": 17731586,
    "node_id": "MDQ6VXNlcjE3NzMxNTg2",
    "avatar_url": "https://avatars.githubusercontent.com/u/17731586?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/sheharyar12",
    "html_url": "https://github.com/sheharyar12",
    "followers_url": "https://api.github.com/users/sheharyar12/followers",
    "following_url": "https://api.github.com/users/sheharyar12/following{/other_user}",
    "gists_url": "https://api.github.com/users/sheharyar12/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/sheharyar12/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/sheharyar12/subscriptions",
    "organizations_url": "https://api.github.com/users/sheharyar12/orgs",
    "repos_url": "https://api.github.com/users/sheharyar12/repos",
    "events_url": "https://api.github.com/users/sheharyar12/events{/privacy}",
    "received_events_url": "https://api.github.com/users/sheharyar12/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1537362490,
      "node_id": "MDU6TGFiZWwxNTM3MzYyNDkw",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/bug",
      "name": "bug",
      "color": "d73a4a",
      "default": true,
      "description": "Something isn't working"
    },
    {
      "id": 4328706977,
      "node_id": "LA_kwDODE2jmc8AAAABAgLToQ",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/TeamChupa",
      "name": "TeamChupa",
      "color": "fbca04",
      "default": false,
      "description": "GH issues worked on by Chupacabara Team"
    },
    {
      "id": 5290172097,
      "node_id": "LA_kwDODE2jmc8AAAABO1GewQ",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/non%20mainnet%20(private%20networks)",
      "name": "non mainnet (private networks)",
      "color": "0052cc",
      "default": false,
      "description": "not related to mainnet features - covers privacy, permissioning, IBFT2, QBFT"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2023-08-25T22:34:17Z",
  "updated_at": "2023-08-31T04:57:19Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "# Rocksdb Error when Downgrading from Besu 23.7.1 to 22.10.2\r\n\r\n- [ x] Have you read the Code of Conduct? By filing an Issue, I agree to comply with it, including treating everyone with respect: [Code of Conduct]()\r\n- [ x] Reproduced the issue in the latest version of the software\r\n- [ x] Read the debugging docs: [Besu Debugging Docs]()\r\n- [ x] Checked for duplicate issues: [Besu Issues]()\r\n\r\n## Description\r\nI want to seamlessly revert from version 23.7.1 to 22.10.2 without any database errors after having successfully upgraded to 23.7.1 and executed the recommended database revert command, and finally downgrading back to 22.10.2.\r\n\r\n## Acceptance Criteria\r\nBesu should revert back to version 22.10.2 without any startup errors after previously upgrading to 23.7.1 and executing the recommended database revert commands. See [here](https://github.com/hyperledger/besu/pull/5471) as recommended.\r\n\r\n## Steps to Reproduce (Bug)\r\n1. Deploy Besu 22.10.2 (with 4 min validators) as a private network.\r\n2. Allow blocks to be imported.\r\n3. Stop Besu 22.10.2 and run besu with version 23.7.1.\r\n4. Allow it to import blocks on 23.7.1.\r\n5. Stop the 23.7.1 version and execute the command: `besu revert storage-variables`\r\n6. Redeploy using version 22.10.2. An error should be encountered during startup.\r\n\r\n**Expected behavior:** Besu 22.10.2 should start without errors after reverting from 23.7.1.\r\n\r\n**Actual behavior:** Encountered an error during the startup of Besu 22.10.2 after reverting.\r\n\r\n**Frequency:** This issue occurs consistently upon reverting.\r\n\r\n### Logs when reverting db via executing subcommand `storage revert-variables`\r\n```\r\n2023-08-18 14:29:43.219+00:00 | main | INFO | DatabaseMetadata | Lookup database metadata file in data directory: /besu/data\r\n2023-08-18 14:29:43.835+00:00 | main | INFO | RocksDBKeyValueStorageFactory | Existing database detected at /besu/data. Version 1. Compacting database..\r\n2023-08-18 14:29:52.733+00:00 | main | INFO | StorageSubCommand$Revert VariablesStorage | Reverted variable storage for key chainHeadHash\r\n2023-08-18 14:29:52.821+00:00 | main | INFO | StorageSubCommand$RevertVariablesStorage | Reverted variable storage for key local-enr-seqno\r\n```\r\n\r\n\r\n### Logs (if a bug)\r\n```\r\n2023-08-22 00:11:15.041+00:00 I main I INFO I RocksDBKeyValueStorageFactory | Existing database detected at /besu/data. Version 1\r\npicocli.CommandLine$ParameterException: org.rocksdb.RocksDBException: Column families not opened: O\r\nat org.hyperledger.besu.cli.BesuCommand.run(BesuCommand.java:1443)\r\nat picocli.CommandLine.executeUserObject(CommandLine.java:1939)\r\nat picocli.CommandLine.access$1300(CommandLine.java:145)\r\nat picocli.CommandLine$RunLast.executeUserObjectOfLastSubcommandWithSameParent(CommandLine.java:2358)\r\nat picocli.CommandLine$RunLast.handle(CommandLine.java:2352)\r\nat picocli.CommandLine$RunLast.handle(CommandLine.java:2314)\r\nat picocli.CommandLine$AbstractParseResultHandler.execute(CommandLine.java:2179)\r\nat picocli.CommandLine$RunLast.execute(CommandLine.java:2316)\r\nat picocli.CommandLine.execute(CommandLine.java:2078)\r\nat org.hyperledger.besu.cli.util.ConfigOptionSearchAndRunHandler.handle(ConfigOptionSearchAndRunHandler.java:54)\r\nat org.hyperledger.besu.cli.util.ConfigOptionSearchAndRunHandler.handle(ConfigOptionSearchAndRunHandler.java:32)\r\nat picocli.CommandLine$AbstractParseResultHandler.execute(CommandLine.java:2179)\r\nat picocli.CommandLine$RunLast.execute(CommandLine.java:2316)\r\nat picocli.CommandLine.execute(CommandLine.java:2078)\r\nat org.hyperledger.besu.cli.BesuCommand.parse(BesuCommand.java:1614)\r\nat org.hyperledger.besu.cli.BesuCommand.parse(BesuCommand.java:1391)\r\nat org.hyperledger.besu.Besu.main(Besu.java:48)\r\nCaused by: picocli.CommandLine$ExecutionException: org.rocksdb.RocksDBException: Column families not opened: O\r\nat org.hyperledger.besu.cli.BesuCommand.buildController(BesuCommand.java:2122)\r\nat org.hyperledger.besu.cli.BesuCommand.initController(BesuCommand.java:2115)\r\nat org.hyperledger.besu.cli.BesuCommand.run(BesuCommand.java:1427)\r\n... 16 more\r\nCaused by: org.hyperledger.besu.plugin.services.exception.StorageException: org.rocksdb.RocksDBException: Column families not opened: D\r\nat org.hyperledger.besu.plugin.services.storage.rocksdb.segmented.RocksDBColumnarKeyValueStorage.<init>(RocksDBColumnarKeyValueStorage.java:166)\r\nat org.hyperledger.besu.plugin.services.storage.rocksdb.RocksDBKeyValueStorageFactory.create(RocksDBKeyValueStorageFactory.java:124)\r\nat org.hyperledger.besu.ethereum.storage.keyvalue.KeyValueStorageProviderBuilder.build(KeyValueStorageProviderBuilder.java:71)\r\nat org.hyperledger.besu.cli.BesuCommand.keyValueStorageProvider(BesuCommand.java:2803)\r\nat org.hyperledger.besu.cli.BesuCommand.getControllerBuilder(BesuCommand.java:2127)\r\nat org.hyperledger.besu.cli.BesuCommand.buildController(BesuCommand.java:2120)\r\nCaused by: org.rocksdb.RocksDBException: Column families not opened: [\r\nat org.rocksdb.OptimisticTransactionDB.open(Native Method)\r\nat org.rocksdb.OptimisticTransactionDB.open(OptimisticTransactionDB.java:80)\r\nat org.hyperledger.besu.plugin.services.storage.rocksdb.segmented.RocksDBColumnarKeyValueStorage.<init>(RocksDBColumnarKeyValueStorage.java:146)\r\n... 23 more\r\nTo display full help: besu [COMMAND] --help\r\n\r\n```\r\n\r\n#### Software version: Initially besu 22.10.2 then upgraded to 23.7.1. Finally wanted to revert back to 22.10.2\r\n#### Additional Information\r\n#### Database storage format : FOREST",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/5808/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/hyperledger/besu/issues/5808/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1696501091",
    "html_url": "https://github.com/hyperledger/besu/issues/5808#issuecomment-1696501091",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/5808",
    "id": 1696501091,
    "node_id": "IC_kwDODE2jmc5lHo1j",
    "user": {
      "login": "non-fungible-nelson",
      "id": 85905982,
      "node_id": "MDQ6VXNlcjg1OTA1OTgy",
      "avatar_url": "https://avatars.githubusercontent.com/u/85905982?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/non-fungible-nelson",
      "html_url": "https://github.com/non-fungible-nelson",
      "followers_url": "https://api.github.com/users/non-fungible-nelson/followers",
      "following_url": "https://api.github.com/users/non-fungible-nelson/following{/other_user}",
      "gists_url": "https://api.github.com/users/non-fungible-nelson/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/non-fungible-nelson/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/non-fungible-nelson/subscriptions",
      "organizations_url": "https://api.github.com/users/non-fungible-nelson/orgs",
      "repos_url": "https://api.github.com/users/non-fungible-nelson/repos",
      "events_url": "https://api.github.com/users/non-fungible-nelson/events{/privacy}",
      "received_events_url": "https://api.github.com/users/non-fungible-nelson/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-08-28T22:16:51Z",
    "updated_at": "2023-08-28T22:16:51Z",
    "author_association": "CONTRIBUTOR",
    "body": "Hi @sheharyar12 thanks for the report. \r\n\r\n@garyschulte can you take a look in fabio's absence? ",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1696501091/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1699846668",
    "html_url": "https://github.com/hyperledger/besu/issues/5808#issuecomment-1699846668",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/5808",
    "id": 1699846668,
    "node_id": "IC_kwDODE2jmc5lUZoM",
    "user": {
      "login": "garyschulte",
      "id": 1238512,
      "node_id": "MDQ6VXNlcjEyMzg1MTI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1238512?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/garyschulte",
      "html_url": "https://github.com/garyschulte",
      "followers_url": "https://api.github.com/users/garyschulte/followers",
      "following_url": "https://api.github.com/users/garyschulte/following{/other_user}",
      "gists_url": "https://api.github.com/users/garyschulte/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/garyschulte/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/garyschulte/subscriptions",
      "organizations_url": "https://api.github.com/users/garyschulte/orgs",
      "repos_url": "https://api.github.com/users/garyschulte/repos",
      "events_url": "https://api.github.com/users/garyschulte/events{/privacy}",
      "received_events_url": "https://api.github.com/users/garyschulte/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-08-30T21:09:24Z",
    "updated_at": "2023-08-31T00:00:09Z",
    "author_association": "CONTRIBUTOR",
    "body": "I was able to reproduce this locally.  `storage revert-variables` works correctly.  \r\n\r\nHowever a breaking change was introduced in [23.1.0](https://github.com/hyperledger/besu/releases/tag/23.1.0) that added a new column family for \"chain pruner state\".  What 22.10.2 is complaining about isn't the storage varaibles, it is complaining that it doesn't know about the new chain pruner column family.\r\n\r\nThis error `Column families not opened: O` is beyond useless, I will put up a PR to fix this error message to be more useful by translating the column family index byte to the column family name.\r\n\r\nIf you need to revert these databases to 22.10.2, reach out on the hyperledger discord and we can help you manually revert ",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1699846668/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1700029380",
    "html_url": "https://github.com/hyperledger/besu/issues/5808#issuecomment-1700029380",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/5808",
    "id": 1700029380,
    "node_id": "IC_kwDODE2jmc5lVGPE",
    "user": {
      "login": "garyschulte",
      "id": 1238512,
      "node_id": "MDQ6VXNlcjEyMzg1MTI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1238512?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/garyschulte",
      "html_url": "https://github.com/garyschulte",
      "followers_url": "https://api.github.com/users/garyschulte/followers",
      "following_url": "https://api.github.com/users/garyschulte/following{/other_user}",
      "gists_url": "https://api.github.com/users/garyschulte/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/garyschulte/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/garyschulte/subscriptions",
      "organizations_url": "https://api.github.com/users/garyschulte/orgs",
      "repos_url": "https://api.github.com/users/garyschulte/repos",
      "events_url": "https://api.github.com/users/garyschulte/events{/privacy}",
      "received_events_url": "https://api.github.com/users/garyschulte/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-08-31T00:04:46Z",
    "updated_at": "2023-08-31T00:04:46Z",
    "author_association": "CONTRIBUTOR",
    "body": "#4686 should only add the chain pruning column family if it is explicitly enabled.  It isn't clear why the chain pruning column family is being created when running 23.7.1.  I will dig into this a bit more and see where/why this is occurring.",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1700029380/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1700367801",
    "html_url": "https://github.com/hyperledger/besu/issues/5808#issuecomment-1700367801",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/5808",
    "id": 1700367801,
    "node_id": "IC_kwDODE2jmc5lWY25",
    "user": {
      "login": "garyschulte",
      "id": 1238512,
      "node_id": "MDQ6VXNlcjEyMzg1MTI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1238512?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/garyschulte",
      "html_url": "https://github.com/garyschulte",
      "followers_url": "https://api.github.com/users/garyschulte/followers",
      "following_url": "https://api.github.com/users/garyschulte/following{/other_user}",
      "gists_url": "https://api.github.com/users/garyschulte/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/garyschulte/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/garyschulte/subscriptions",
      "organizations_url": "https://api.github.com/users/garyschulte/orgs",
      "repos_url": "https://api.github.com/users/garyschulte/repos",
      "events_url": "https://api.github.com/users/garyschulte/events{/privacy}",
      "received_events_url": "https://api.github.com/users/garyschulte/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-08-31T04:57:19Z",
    "updated_at": "2023-08-31T04:57:19Z",
    "author_association": "CONTRIBUTOR",
    "body": "Found, fixed in #5830.  Sorry for the inconvenience.  Again, if you need help migrating those databases back to 22.10.2 reach out on discord and we can help.",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1700367801/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
