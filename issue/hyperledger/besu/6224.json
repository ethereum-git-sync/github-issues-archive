{
  "url": "https://api.github.com/repos/hyperledger/besu/issues/6224",
  "repository_url": "https://api.github.com/repos/hyperledger/besu",
  "labels_url": "https://api.github.com/repos/hyperledger/besu/issues/6224/labels{/name}",
  "comments_url": "https://api.github.com/repos/hyperledger/besu/issues/6224/comments",
  "events_url": "https://api.github.com/repos/hyperledger/besu/issues/6224/events",
  "html_url": "https://github.com/hyperledger/besu/issues/6224",
  "id": 2021066793,
  "node_id": "I_kwDODE2jmc54dwgp",
  "number": 6224,
  "title": "P2P ping packet `From` field is not used to construct the enode URL for a new peer",
  "user": {
    "login": "matthew1001",
    "id": 6599269,
    "node_id": "MDQ6VXNlcjY1OTkyNjk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6599269?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/matthew1001",
    "html_url": "https://github.com/matthew1001",
    "followers_url": "https://api.github.com/users/matthew1001/followers",
    "following_url": "https://api.github.com/users/matthew1001/following{/other_user}",
    "gists_url": "https://api.github.com/users/matthew1001/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/matthew1001/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/matthew1001/subscriptions",
    "organizations_url": "https://api.github.com/users/matthew1001/orgs",
    "repos_url": "https://api.github.com/users/matthew1001/repos",
    "events_url": "https://api.github.com/users/matthew1001/events{/privacy}",
    "received_events_url": "https://api.github.com/users/matthew1001/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1537362490,
      "node_id": "MDU6TGFiZWwxNTM3MzYyNDkw",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/bug",
      "name": "bug",
      "color": "d73a4a",
      "default": true,
      "description": "Something isn't working"
    },
    {
      "id": 3805591260,
      "node_id": "LA_kwDODE2jmc7i1Lbc",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/peering",
      "name": "peering",
      "color": "006b75",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "matthew1001",
    "id": 6599269,
    "node_id": "MDQ6VXNlcjY1OTkyNjk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6599269?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/matthew1001",
    "html_url": "https://github.com/matthew1001",
    "followers_url": "https://api.github.com/users/matthew1001/followers",
    "following_url": "https://api.github.com/users/matthew1001/following{/other_user}",
    "gists_url": "https://api.github.com/users/matthew1001/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/matthew1001/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/matthew1001/subscriptions",
    "organizations_url": "https://api.github.com/users/matthew1001/orgs",
    "repos_url": "https://api.github.com/users/matthew1001/repos",
    "events_url": "https://api.github.com/users/matthew1001/events{/privacy}",
    "received_events_url": "https://api.github.com/users/matthew1001/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "matthew1001",
      "id": 6599269,
      "node_id": "MDQ6VXNlcjY1OTkyNjk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6599269?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/matthew1001",
      "html_url": "https://github.com/matthew1001",
      "followers_url": "https://api.github.com/users/matthew1001/followers",
      "following_url": "https://api.github.com/users/matthew1001/following{/other_user}",
      "gists_url": "https://api.github.com/users/matthew1001/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/matthew1001/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/matthew1001/subscriptions",
      "organizations_url": "https://api.github.com/users/matthew1001/orgs",
      "repos_url": "https://api.github.com/users/matthew1001/repos",
      "events_url": "https://api.github.com/users/matthew1001/events{/privacy}",
      "received_events_url": "https://api.github.com/users/matthew1001/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2023-12-01T15:06:39Z",
  "updated_at": "2024-01-19T10:34:04Z",
  "closed_at": "2024-01-19T10:34:04Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "### Description\r\nI'm running the following on a single laptop, not running in docker/K8S - just running from locally built code.\r\n\r\nOne node is started with minimal config to act as a boot node. Enable `TRACE` to monitor the address used to send a `PONG` packet back to node 2:\r\n\r\n```\r\nbesu --data-path=data --genesis-file=genesis.json --min-gas-price=0 --p2p-port=30303 --nat-method=NONE -l TRACE\r\n```\r\nAnother node is started with similar config but with a different `p2p` port to avoid a clash, a custom but valid `--p2p-host`, and `--bootnodes` to refer to the first one. No need to enable `TRACE` for this node:\r\n```\r\nbesu --data-path=data --genesis-file=genesis.json --min-gas-price=0 --p2p-port=30304  --bootnodes=enode://beea7aa3a6e1f862870a456239dbf9a232d9a69e58edfeda92193f679bdbf3960bb7f41bc6f0d574c4d0c6baa2324c7279045405ef8a240906bc13d3145ccc14@127.0.0.1:30303 --p2p-host=192.168.0.1 --nat-method=NONE\r\n```\r\n\r\n**Expected behavior:**\r\n\r\nMy expectation is to see a line like this in the `TRACE` for node 1:\r\n\r\n```\r\nTRACE | DiscoveryProtocolLogger | <<< Sending PONG  packet to peer 0x9bd8b72c3b53fbe116e7f5be942e159f (enode://9bd8b72c3b53fbe116e7f5be942e159f274bb36989ebf192f67b89629ade816c0129e59d383d8d71e349c0c16db064d60d2317f7064e11719386a6c57897ae0c@192.168.0.1:30304): Packet{type=PONG, data=PongPacketData{to=Endpoint{host='Optional[192.168.0.1]', udpPort=30304, getTcpPort=30304}, ...\r\n```\r\n\r\n**Actual behavior:** \r\n\r\nWhat I actually observe is the following:\r\n\r\n```\r\nTRACE | DiscoveryProtocolLogger | <<< Sending PONG  packet to peer 0x9bd8b72c3b53fbe116e7f5be942e159f (enode://9bd8b72c3b53fbe116e7f5be942e159f274bb36989ebf192f67b89629ade816c0129e59d383d8d71e349c0c16db064d60d2317f7064e11719386a6c57897ae0c@127.0.0.1:30304): Packet{type=PONG, data=PongPacketData{to=Endpoint{host='Optional[127.0.0.1]', udpPort=30304, getTcpPort=30304}, ...\r\n```\r\n\r\nThe pertinent difference is the `127.0.0.1` in the `to` endpoint and URL, rather than the expected `192.168.0.1`.\r\n\r\nThe connection works as expected because `127.0.0.1` is valid. However, the node receiving the `PING` is not honouring the host address specified in the `PING` packet.\r\n\r\nThere seems to have been various discussion around the behaviour of `--p2p-host`, most of which appears to be related to exactly what a node advertises in different situations. The docs (https://besu.hyperledger.org/public-networks/reference/cli/options#p2p-host) state:\r\n\r\n\"The advertised host that can be used to access the node from outside the network in P2P communication. The default is 127.0.0.1.\"\r\n\r\n The following docs issue from 2020 seems to describe clearly the affect that `--nat-method` should have on the advertised host:\r\n\r\nhttps://github.com/hyperledger/besu-docs/issues/332\r\n\r\nChanges to the code in this area include issues with malformed `From` fields in `PING` packets: https://github.com/hyperledger/besu/pull/1236\r\n\r\nBut before these changes (which go back to 2020) it looks like the `host` has always been pulled from the `UDP` packet, not the `PING` packet.\r\n \r\nI've tested and raised a PR that gives the behaviour I expect based on reading the docs. However, it's slightly surprising that this hasn't been noticed before. I'm wondering if it's because often the source address of the `UDP` packet is perfectly fine for connectivity to succeed. But it would seem to suggest that the advertised host specified by `--p2p-host` is never used as the address to connect to (unless of course it happens to be the same as the `UDP` source address.)\r\n",
  "closed_by": {
    "login": "matthew1001",
    "id": 6599269,
    "node_id": "MDQ6VXNlcjY1OTkyNjk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6599269?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/matthew1001",
    "html_url": "https://github.com/matthew1001",
    "followers_url": "https://api.github.com/users/matthew1001/followers",
    "following_url": "https://api.github.com/users/matthew1001/following{/other_user}",
    "gists_url": "https://api.github.com/users/matthew1001/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/matthew1001/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/matthew1001/subscriptions",
    "organizations_url": "https://api.github.com/users/matthew1001/orgs",
    "repos_url": "https://api.github.com/users/matthew1001/repos",
    "events_url": "https://api.github.com/users/matthew1001/events{/privacy}",
    "received_events_url": "https://api.github.com/users/matthew1001/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/6224/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/hyperledger/besu/issues/6224/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1836481169",
    "html_url": "https://github.com/hyperledger/besu/issues/6224#issuecomment-1836481169",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/6224",
    "id": 1836481169,
    "node_id": "IC_kwDODE2jmc5tdnqR",
    "user": {
      "login": "fab-10",
      "id": 91944855,
      "node_id": "U_kgDOBXr3lw",
      "avatar_url": "https://avatars.githubusercontent.com/u/91944855?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fab-10",
      "html_url": "https://github.com/fab-10",
      "followers_url": "https://api.github.com/users/fab-10/followers",
      "following_url": "https://api.github.com/users/fab-10/following{/other_user}",
      "gists_url": "https://api.github.com/users/fab-10/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fab-10/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fab-10/subscriptions",
      "organizations_url": "https://api.github.com/users/fab-10/orgs",
      "repos_url": "https://api.github.com/users/fab-10/repos",
      "events_url": "https://api.github.com/users/fab-10/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fab-10/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-12-01T17:11:49Z",
    "updated_at": "2023-12-01T17:11:49Z",
    "author_association": "CONTRIBUTOR",
    "body": "it seems reasonable, but I want to think more about the fact that since the UDP address was used, and if using UDP could be more effective than the `p2p-host` option, that could be set to the wrong address.",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1836481169/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1838113277",
    "html_url": "https://github.com/hyperledger/besu/issues/6224#issuecomment-1838113277",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/6224",
    "id": 1838113277,
    "node_id": "IC_kwDODE2jmc5tj2H9",
    "user": {
      "login": "matthew1001",
      "id": 6599269,
      "node_id": "MDQ6VXNlcjY1OTkyNjk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6599269?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/matthew1001",
      "html_url": "https://github.com/matthew1001",
      "followers_url": "https://api.github.com/users/matthew1001/followers",
      "following_url": "https://api.github.com/users/matthew1001/following{/other_user}",
      "gists_url": "https://api.github.com/users/matthew1001/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/matthew1001/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/matthew1001/subscriptions",
      "organizations_url": "https://api.github.com/users/matthew1001/orgs",
      "repos_url": "https://api.github.com/users/matthew1001/repos",
      "events_url": "https://api.github.com/users/matthew1001/events{/privacy}",
      "received_events_url": "https://api.github.com/users/matthew1001/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-12-04T09:05:42Z",
    "updated_at": "2023-12-04T09:05:42Z",
    "author_association": "CONTRIBUTOR",
    "body": "Yeah I think a good check which I should be able to do today, is what the different `--nat-method` options + `--p2p-host` translate to in terms of the `From` endpoint set in the packet.",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1838113277/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1838264025",
    "html_url": "https://github.com/hyperledger/besu/issues/6224#issuecomment-1838264025",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/6224",
    "id": 1838264025,
    "node_id": "IC_kwDODE2jmc5tka7Z",
    "user": {
      "login": "matthew1001",
      "id": 6599269,
      "node_id": "MDQ6VXNlcjY1OTkyNjk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6599269?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/matthew1001",
      "html_url": "https://github.com/matthew1001",
      "followers_url": "https://api.github.com/users/matthew1001/followers",
      "following_url": "https://api.github.com/users/matthew1001/following{/other_user}",
      "gists_url": "https://api.github.com/users/matthew1001/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/matthew1001/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/matthew1001/subscriptions",
      "organizations_url": "https://api.github.com/users/matthew1001/orgs",
      "repos_url": "https://api.github.com/users/matthew1001/repos",
      "events_url": "https://api.github.com/users/matthew1001/events{/privacy}",
      "received_events_url": "https://api.github.com/users/matthew1001/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-12-04T10:34:51Z",
    "updated_at": "2023-12-04T10:34:51Z",
    "author_association": "CONTRIBUTOR",
    "body": "@fab-10 I think the safest thing would be to special case `127.0.0.1` in node that receives the `PING` packet, so that they behave much like they would before this PR.\r\n\r\nThis would mean that if the sending node doesn't set `--p2p-host` or have a custom advertised IP through whatever `--nat-method` option they have set, the `From` field in their `PING` will contain `127.0.0.1` and the receiving peer will ignore it (which it does today anyway). For nodes that are actually running on the same host, the receiving node will get the IP from the UDP packet which works today and will continue to work. But for any other address that isn't `127.0.0.1` the receiving node will now try to connect on the advertised host.\r\n\r\nSince this PR is fixing behaviour that people may not have realised is broken, it could affect users who have `--p2p-host` set to a value that actually doesn't work, but their setup has inadvertently relied on it being ignored. Those users could see peering issues until they remove the `--p2p-host` setting, at which point the behaviour should revert to pre-23.10.3 behaviour.",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1838264025/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1838575665",
    "html_url": "https://github.com/hyperledger/besu/issues/6224#issuecomment-1838575665",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/6224",
    "id": 1838575665,
    "node_id": "IC_kwDODE2jmc5tlnAx",
    "user": {
      "login": "matthew1001",
      "id": 6599269,
      "node_id": "MDQ6VXNlcjY1OTkyNjk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6599269?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/matthew1001",
      "html_url": "https://github.com/matthew1001",
      "followers_url": "https://api.github.com/users/matthew1001/followers",
      "following_url": "https://api.github.com/users/matthew1001/following{/other_user}",
      "gists_url": "https://api.github.com/users/matthew1001/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/matthew1001/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/matthew1001/subscriptions",
      "organizations_url": "https://api.github.com/users/matthew1001/orgs",
      "repos_url": "https://api.github.com/users/matthew1001/repos",
      "events_url": "https://api.github.com/users/matthew1001/events{/privacy}",
      "received_events_url": "https://api.github.com/users/matthew1001/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-12-04T12:54:15Z",
    "updated_at": "2023-12-04T12:54:15Z",
    "author_association": "CONTRIBUTOR",
    "body": "@fab-10 I've updated the PR so that if the recipient of the `PING` sees an endpoint `From` address of `127.0.0.1` it takes the source from the UDP packet just to minimise the chance of a behaviour chance for existing users.\r\n\r\nI've also added a unit test to check that a custom value in a `PING` packet shows up correctly in a discovery agent's peer endpoint.",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1838575665/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
