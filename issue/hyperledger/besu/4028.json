{
  "url": "https://api.github.com/repos/hyperledger/besu/issues/4028",
  "repository_url": "https://api.github.com/repos/hyperledger/besu",
  "labels_url": "https://api.github.com/repos/hyperledger/besu/issues/4028/labels{/name}",
  "comments_url": "https://api.github.com/repos/hyperledger/besu/issues/4028/comments",
  "events_url": "https://api.github.com/repos/hyperledger/besu/issues/4028/events",
  "html_url": "https://github.com/hyperledger/besu/issues/4028",
  "id": 1288313675,
  "node_id": "I_kwDODE2jmc5MyhtL",
  "number": 4028,
  "title": "trace_transaction returns internal error for fast synced node with pruning",
  "user": {
    "login": "AdamRylski",
    "id": 48090277,
    "node_id": "MDQ6VXNlcjQ4MDkwMjc3",
    "avatar_url": "https://avatars.githubusercontent.com/u/48090277?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/AdamRylski",
    "html_url": "https://github.com/AdamRylski",
    "followers_url": "https://api.github.com/users/AdamRylski/followers",
    "following_url": "https://api.github.com/users/AdamRylski/following{/other_user}",
    "gists_url": "https://api.github.com/users/AdamRylski/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/AdamRylski/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/AdamRylski/subscriptions",
    "organizations_url": "https://api.github.com/users/AdamRylski/orgs",
    "repos_url": "https://api.github.com/users/AdamRylski/repos",
    "events_url": "https://api.github.com/users/AdamRylski/events{/privacy}",
    "received_events_url": "https://api.github.com/users/AdamRylski/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1537362490,
      "node_id": "MDU6TGFiZWwxNTM3MzYyNDkw",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/bug",
      "name": "bug",
      "color": "d73a4a",
      "default": true,
      "description": "Something isn't working"
    },
    {
      "id": 2152224197,
      "node_id": "MDU6TGFiZWwyMTUyMjI0MTk3",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/TeamRevenant",
      "name": "TeamRevenant",
      "color": "78e298",
      "default": false,
      "description": "GH issues worked on by Revenant Team"
    },
    {
      "id": 4609582991,
      "node_id": "LA_kwDODE2jmc8AAAABEsCnjw",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/RPC",
      "name": "RPC",
      "color": "1d76db",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "Gabriel-Trintinalia",
    "id": 14837672,
    "node_id": "MDQ6VXNlcjE0ODM3Njcy",
    "avatar_url": "https://avatars.githubusercontent.com/u/14837672?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Gabriel-Trintinalia",
    "html_url": "https://github.com/Gabriel-Trintinalia",
    "followers_url": "https://api.github.com/users/Gabriel-Trintinalia/followers",
    "following_url": "https://api.github.com/users/Gabriel-Trintinalia/following{/other_user}",
    "gists_url": "https://api.github.com/users/Gabriel-Trintinalia/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Gabriel-Trintinalia/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Gabriel-Trintinalia/subscriptions",
    "organizations_url": "https://api.github.com/users/Gabriel-Trintinalia/orgs",
    "repos_url": "https://api.github.com/users/Gabriel-Trintinalia/repos",
    "events_url": "https://api.github.com/users/Gabriel-Trintinalia/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Gabriel-Trintinalia/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "Gabriel-Trintinalia",
      "id": 14837672,
      "node_id": "MDQ6VXNlcjE0ODM3Njcy",
      "avatar_url": "https://avatars.githubusercontent.com/u/14837672?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Gabriel-Trintinalia",
      "html_url": "https://github.com/Gabriel-Trintinalia",
      "followers_url": "https://api.github.com/users/Gabriel-Trintinalia/followers",
      "following_url": "https://api.github.com/users/Gabriel-Trintinalia/following{/other_user}",
      "gists_url": "https://api.github.com/users/Gabriel-Trintinalia/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Gabriel-Trintinalia/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Gabriel-Trintinalia/subscriptions",
      "organizations_url": "https://api.github.com/users/Gabriel-Trintinalia/orgs",
      "repos_url": "https://api.github.com/users/Gabriel-Trintinalia/repos",
      "events_url": "https://api.github.com/users/Gabriel-Trintinalia/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Gabriel-Trintinalia/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2022-06-29T07:51:00Z",
  "updated_at": "2023-02-23T23:39:52Z",
  "closed_at": "2023-02-23T23:39:52Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Description\r\nI would like to fetch traces for transactions with method `trace_transaction` for each transaction in block. I'm good with the latest blocks only (like 2-3 days retention in case of emergency), so I wanted to use fast-synced node with `pruning` option.\r\n### Acceptance Criteria\r\n* Node is returning traces for blocks in pruning range (latest X blocks)\r\n### Steps to Reproduce (Bug)\r\n1. Set up a node with version specified below and config specified below\r\n2. Wait for node to sync with the network\r\n3. Query the node with `trace_transaction` for a transaction from the block in pruning range, example payload (I'm using postman)\r\n```\r\n{\r\n\t\"jsonrpc\":\"2.0\",\r\n\t\"method\":\"trace_transaction\",\r\n\t\"params\":[\r\n\t\t\"0xf12eaef052804d23bb0655b0cc44e97813433c2209b9aa5ee1341de1448ca800\"\r\n\t],\r\n\t\"id\":1\r\n}\r\n```\r\nNote:\r\nAt the time of writing, our node was on block `15039675`\r\nwhile the mainnet was on block                      `15039785`\r\nwhich gives us 110 block difference (prune set to 10k). The transaction is from block `15039675`\r\n\r\n**Expected behavior:** I should receive traces for this transaction, according to description of [trace_transaction](https://besu.hyperledger.org/en/stable/Reference/API-Methods/#trace_transaction)\r\n> Your node must be an archive node (that is, synchronized without pruning or fast sync) or the requested transaction must be contained in a block within the number of [blocks retained](https://besu.hyperledger.org/en/stable/Reference/CLI/CLI-Syntax/#pruning-blocks-retained) with [pruning enabled](https://besu.hyperledger.org/en/stable/Reference/CLI/CLI-Syntax/#pruning-enabled) (by default, 1024).\r\n\r\n**Actual behavior:** Node is returning internal error\r\n```\r\n{\r\n    \"jsonrpc\": \"2.0\",\r\n    \"id\": 1,\r\n    \"error\": {\r\n        \"code\": -32603,\r\n        \"message\": \"Internal error\"\r\n    }\r\n}\r\n```\r\nGiven the amount of lines the node is logging, I'll post only errors:\r\n```\r\nJun 28 09:50:38 besu-hl-eth-02 besu-eth[13735]: 2022-06-28 09:50:38.827+00:00 | BesuCommand-Shutdown-Hook | ERROR | Pruner | Failed to shutdown Pruner executor service.\r\nJun 28 09:50:38 besu-hl-eth-02 besu-eth[13735]: 2022-06-28 09:50:38.853+00:00 | EthScheduler-Services-147 (importBlock) | ERROR | PipelineChainDownloader | Chain download failed. Restarting after short delay.\r\nJun 28 10:33:14 besu-hl-eth-02 besu-eth[24406]: 2022-06-28 10:33:14.392+00:00 | Timer-0 | ERROR | Besu | Uncaught exception in thread \"Timer-0\"\r\nJun 28 10:33:22 besu-hl-eth-02 besu-eth[24406]: 2022-06-28 10:33:22.348+00:00 | BesuCommand-Shutdown-Hook | ERROR | Pruner | Failed to shutdown Pruner executor service.\r\nJun 28 10:41:39 besu-hl-eth-02 besu-eth[25483]: ERROR StatusLogger Reconfiguration failed: No configuration found for '5ffd2b27' at 'null' in 'null'\r\nJun 28 10:41:39 besu-hl-eth-02 besu-eth[25483]: ERROR StatusLogger Reconfiguration failed: No configuration found for '5ffd2b27' at 'null' in 'null'\r\nJun 28 10:57:17 besu-hl-eth-02 besu-eth[25483]: 10:57:17.814 [BesuCommand-Shutdown-Hook] ERROR org.hyperledger.besu.ethereum.worldstate.Pruner - Failed to shutdown Pruner executor service.\r\nJun 28 10:57:34 besu-hl-eth-02 besu-eth[25779]: ERROR StatusLogger Reconfiguration failed: No configuration found for '5ffd2b27' at 'null' in 'null'\r\nJun 28 10:57:35 besu-hl-eth-02 besu-eth[25779]: ERROR StatusLogger Reconfiguration failed: No configuration found for '5ffd2b27' at 'null' in 'null'\r\nJun 28 11:09:24 besu-hl-eth-02 besu-eth[25779]: 11:09:24.120 [BesuCommand-Shutdown-Hook] ERROR org.hyperledger.besu.ethereum.worldstate.Pruner - Failed to shutdown Pruner executor service.\r\nJun 28 11:13:50 besu-hl-eth-02 besu-eth[26335]: 2022-06-28 11:13:50.550+00:00 | Timer-0 | ERROR | Besu | Uncaught exception in thread \"Timer-0\"\r\nJun 28 11:13:54 besu-hl-eth-02 besu-eth[26335]: 2022-06-28 11:13:54.712+00:00 | BesuCommand-Shutdown-Hook | ERROR | Pruner | Failed to shutdown Pruner executor service.\r\nJun 28 11:15:40 besu-hl-eth-02 besu-eth[26618]: 2022-06-28 11:15:40.300+00:00 | BesuCommand-Shutdown-Hook | ERROR | Pruner | Failed to shutdown Pruner executor service.\r\n```\r\n**Frequency:** Happens for every transaction, does not matter in which block the transaction was included.\r\n### Versions (Add all that apply)\r\n* Software version:\r\n```\r\nbesu/v22.4.3/linux-x86_64/openjdk-java-11\r\n```\r\n* Java version:\r\n```\r\nopenjdk version \"11.0.15\" 2022-04-19\r\nOpenJDK Runtime Environment (build 11.0.15+10-Ubuntu-0ubuntu0.20.04.1)\r\nOpenJDK 64-Bit Server VM (build 11.0.15+10-Ubuntu-0ubuntu0.20.04.1, mixed mode, sharing)\r\n```\r\n* OS Name & Version:\r\n```\r\nDISTRIB_ID=Ubuntu\r\nDISTRIB_RELEASE=20.04\r\nDISTRIB_CODENAME=focal\r\nDISTRIB_DESCRIPTION=\"Ubuntu 20.04.4 LTS\"\r\nNAME=\"Ubuntu\"\r\nVERSION=\"20.04.4 LTS (Focal Fossa)\"\r\nID=ubuntu\r\nID_LIKE=debian\r\nPRETTY_NAME=\"Ubuntu 20.04.4 LTS\"\r\nVERSION_ID=\"20.04\"\r\nHOME_URL=\"https://www.ubuntu.com/\"\r\nSUPPORT_URL=\"https://help.ubuntu.com/\"\r\nBUG_REPORT_URL=\"https://bugs.launchpad.net/ubuntu/\"\r\nPRIVACY_POLICY_URL=\"https://www.ubuntu.com/legal/terms-and-policies/privacy-policy\"\r\nVERSION_CODENAME=focal\r\nUBUNTU_CODENAME=focal\r\n```\r\n* Kernel Version:\r\n```\r\nLinux besu-hl-eth-02 5.4.0-90-generic #101~18.04.1-Ubuntu SMP Fri Oct 22 09:25:04 UTC 2021 x86_64 x86_64 x86_64 GNU/Linux\r\n````\r\n* Virtual Machine software & version: N/A\r\n* Docker Version: N/A\r\n* Cloud VM, type, size: Hosted VM, 6 cores, 16GB ram\r\n### Additional Information\r\n* Besu is set up as a service with a following script\r\n```\r\n[Install]\r\nDescription=Besu Enterprise Ethereum java client\r\nWantedBy=multi-user.target\r\nAfter=syslog.target network.target\r\n[Service]\r\nUser=besu-eth\r\nType=simple\r\nEnvironment='JAVA_OPTS=\"-Xmx16G\"'\r\nExecStart=/opt/besu/bin/besu --config-file /etc/besu-eth/config.toml\r\nRestart=always\r\nRestartSec=60\r\nPermissionsStartOnly=true\r\nPIDFile=/run/besu-eth/bitcoind.pid\r\nStandardOutput=syslog\r\nStandardError=syslog\r\nSyslogIdentifier=besu-eth\r\nLimitNOFILE=32768\r\nCPUAccounting=yes\r\nMemoryAccounting=yes\r\nProtectSystem=full\r\nPrivateDevices=true\r\nNoNewPrivileges=true\r\nPrivateTmp=true\r\nSuccessExitStatus=143\r\n```\r\n* I'm using the following config file placed in: `/etc/besu-eth/config.toml`\r\n```\r\n# data\r\ndata-path=\"/data/besu-eth/db-fast\"\r\nnetwork=\"MAINNET\"\r\nmin-gas-price=1000\r\nsync-mode=\"FAST\"\r\nhost-allowlist=[\"*\"]\r\n# rpc\r\nrpc-http-enabled=true\r\nrpc-http-host=\"0.0.0.0\"\r\nrpc-http-port=8545\r\nrpc-http-api=[\"ETH\",\"NET\",\"TRACE\",\"WEB3\"]\r\nrpc-http-cors-origins=[\"*\"]\r\n# metrics\r\nmetrics-enabled=true\r\nmetrics-host=\"0.0.0.0\"\r\nmetrics-port=9545\r\npruning-enabled=true\r\npruning-blocks-retained=10000\r\n# logging\r\nlogging=\"INFO\"\r\n```",
  "closed_by": {
    "login": "macfarla",
    "id": 2627919,
    "node_id": "MDQ6VXNlcjI2Mjc5MTk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2627919?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/macfarla",
    "html_url": "https://github.com/macfarla",
    "followers_url": "https://api.github.com/users/macfarla/followers",
    "following_url": "https://api.github.com/users/macfarla/following{/other_user}",
    "gists_url": "https://api.github.com/users/macfarla/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/macfarla/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/macfarla/subscriptions",
    "organizations_url": "https://api.github.com/users/macfarla/orgs",
    "repos_url": "https://api.github.com/users/macfarla/repos",
    "events_url": "https://api.github.com/users/macfarla/events{/privacy}",
    "received_events_url": "https://api.github.com/users/macfarla/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/4028/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/hyperledger/besu/issues/4028/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1169832654",
    "html_url": "https://github.com/hyperledger/besu/issues/4028#issuecomment-1169832654",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/4028",
    "id": 1169832654,
    "node_id": "IC_kwDODE2jmc5FujrO",
    "user": {
      "login": "AdamRylski",
      "id": 48090277,
      "node_id": "MDQ6VXNlcjQ4MDkwMjc3",
      "avatar_url": "https://avatars.githubusercontent.com/u/48090277?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AdamRylski",
      "html_url": "https://github.com/AdamRylski",
      "followers_url": "https://api.github.com/users/AdamRylski/followers",
      "following_url": "https://api.github.com/users/AdamRylski/following{/other_user}",
      "gists_url": "https://api.github.com/users/AdamRylski/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AdamRylski/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AdamRylski/subscriptions",
      "organizations_url": "https://api.github.com/users/AdamRylski/orgs",
      "repos_url": "https://api.github.com/users/AdamRylski/repos",
      "events_url": "https://api.github.com/users/AdamRylski/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AdamRylski/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-06-29T10:51:30Z",
    "updated_at": "2022-06-29T10:51:30Z",
    "author_association": "NONE",
    "body": "I've found similar case here https://github.com/hyperledger/besu/issues/2628, but we are already using the latest version",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1169832654/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1177581834",
    "html_url": "https://github.com/hyperledger/besu/issues/4028#issuecomment-1177581834",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/4028",
    "id": 1177581834,
    "node_id": "IC_kwDODE2jmc5GMHkK",
    "user": {
      "login": "AdamRylski",
      "id": 48090277,
      "node_id": "MDQ6VXNlcjQ4MDkwMjc3",
      "avatar_url": "https://avatars.githubusercontent.com/u/48090277?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AdamRylski",
      "html_url": "https://github.com/AdamRylski",
      "followers_url": "https://api.github.com/users/AdamRylski/followers",
      "following_url": "https://api.github.com/users/AdamRylski/following{/other_user}",
      "gists_url": "https://api.github.com/users/AdamRylski/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AdamRylski/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AdamRylski/subscriptions",
      "organizations_url": "https://api.github.com/users/AdamRylski/orgs",
      "repos_url": "https://api.github.com/users/AdamRylski/repos",
      "events_url": "https://api.github.com/users/AdamRylski/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AdamRylski/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-07T13:04:47Z",
    "updated_at": "2022-07-07T13:04:47Z",
    "author_association": "NONE",
    "body": "We've updated to https://github.com/hyperledger/besu/releases/tag/22.7.0-RC1, but it didn't help. Node is syncing in leaps and returns an internal server error when querying for traces",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1177581834/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1423354444",
    "html_url": "https://github.com/hyperledger/besu/issues/4028#issuecomment-1423354444",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/4028",
    "id": 1423354444,
    "node_id": "IC_kwDODE2jmc5U1qpM",
    "user": {
      "login": "Gabriel-Trintinalia",
      "id": 14837672,
      "node_id": "MDQ6VXNlcjE0ODM3Njcy",
      "avatar_url": "https://avatars.githubusercontent.com/u/14837672?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Gabriel-Trintinalia",
      "html_url": "https://github.com/Gabriel-Trintinalia",
      "followers_url": "https://api.github.com/users/Gabriel-Trintinalia/followers",
      "following_url": "https://api.github.com/users/Gabriel-Trintinalia/following{/other_user}",
      "gists_url": "https://api.github.com/users/Gabriel-Trintinalia/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Gabriel-Trintinalia/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Gabriel-Trintinalia/subscriptions",
      "organizations_url": "https://api.github.com/users/Gabriel-Trintinalia/orgs",
      "repos_url": "https://api.github.com/users/Gabriel-Trintinalia/repos",
      "events_url": "https://api.github.com/users/Gabriel-Trintinalia/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Gabriel-Trintinalia/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-02-08T23:05:31Z",
    "updated_at": "2023-02-14T23:33:42Z",
    "author_association": "CONTRIBUTOR",
    "body": "Hi @AdamRylski , I was not able to replicate this issue. Just synced a node and I am able to retrieve the trace for a block within the prune window. I tested with the latest besu version. Would you be able to check if the issue is still happening?",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1423354444/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
