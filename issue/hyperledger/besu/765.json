{
  "url": "https://api.github.com/repos/hyperledger/besu/issues/765",
  "repository_url": "https://api.github.com/repos/hyperledger/besu",
  "labels_url": "https://api.github.com/repos/hyperledger/besu/issues/765/labels{/name}",
  "comments_url": "https://api.github.com/repos/hyperledger/besu/issues/765/comments",
  "events_url": "https://api.github.com/repos/hyperledger/besu/issues/765/events",
  "html_url": "https://github.com/hyperledger/besu/issues/765",
  "id": 604433312,
  "node_id": "MDU6SXNzdWU2MDQ0MzMzMTI=",
  "number": 765,
  "title": "Adding a validator, but new validator's block did not pass validation.",
  "user": {
    "login": "PeiChia",
    "id": 39792162,
    "node_id": "MDQ6VXNlcjM5NzkyMTYy",
    "avatar_url": "https://avatars.githubusercontent.com/u/39792162?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/PeiChia",
    "html_url": "https://github.com/PeiChia",
    "followers_url": "https://api.github.com/users/PeiChia/followers",
    "following_url": "https://api.github.com/users/PeiChia/following{/other_user}",
    "gists_url": "https://api.github.com/users/PeiChia/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/PeiChia/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/PeiChia/subscriptions",
    "organizations_url": "https://api.github.com/users/PeiChia/orgs",
    "repos_url": "https://api.github.com/users/PeiChia/repos",
    "events_url": "https://api.github.com/users/PeiChia/events{/privacy}",
    "received_events_url": "https://api.github.com/users/PeiChia/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2020-04-22T03:52:44Z",
  "updated_at": "2020-06-21T20:57:24Z",
  "closed_at": "2020-06-21T20:57:07Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "<!-- Have you done the following? -->\r\n<!--   * read the Code of Conduct? By filing an Issue, you are expected to -->  \r\n<!--     comply with it, including treating everyone with respect: -->\r\n<!--     https://github.com/hyperledger/besu/blob/master/CODE-OF-CONDUCT.md -->\r\n<!--   * Reproduced the issue in the latest version of the software -->\r\n<!--   * Read the debugging wiki: https://github.com/hyperledger/besu/wiki/debugging -->\r\n<!--   * Duplicate Issue check:  https://github.com/search?q=+is%3Aissue+repo%3Ahyperledger/Besu -->\r\n<!-- Note:  Not all sections will apply to all issue types. -->\r\n\r\n### Description\r\nI have a network now. (deploy on k8s)\r\nIt has 4 validators, 2 non-validators.\r\n\r\nThe configuration is as follows:\r\nPC1: validator1 ~ validator4, PC2: node, PC3: node.\r\n\r\nNow, I want to convert PC2 node to validator through ibft voting.\r\n\r\n### Steps to Reproduce (Bug)\r\n1. use `ibft_proposeValidatorVote` on validator1 ~ validator4\r\n```\r\ncurl -X POST --data '{\"jsonrpc\":\"2.0\",\"method\":\"ibft_proposeValidatorVote\",\"params\":[\"f54079cbe8f9b21c3251c4371d4ca50d6763a9bf\",true], \"id\":1}' http://{HOST_IP}:8545\r\n```\r\n2. using `ibft_getValidatorsByBlockNumber` to query, and I have seen PC2 node's validator address.\r\n```\r\ncurl -X POST --data '{\"jsonrpc\":\"2.0\",\"method\":\"ibft_getValidatorsByBlockNumber\",\"params\":[\"latest\"], \"id\":1}' http://{HOST_IP}:8545\r\n```\r\n3. check validator1 ~ validator4's log.\r\n```\r\npool-10-thread-1 | INFO | MessageValidator | Invalid Proposal message, block did not pass validation.\r\n```\r\n4. use `ibft_getSignerMetrics`.\r\n```\r\ncurl -X POST --data '{\"jsonrpc\":\"2.0\",\"method\":\"ibft_getSignerMetrics\",\"params\":[\"301000\", \"latest\"], \"id\":1}' http://{HOST_IP}:8545\r\n```\r\nSee PC2 node's address: \"0xf54079cbe8f9b21c3251c4371d4ca50d6763a9bf\".\r\n```\r\n{\r\n  \"jsonrpc\" : \"2.0\",\r\n  \"id\" : 1,\r\n  \"result\" : [ {\r\n    \"address\" : \"0xbdea69de343361d59493e9df3d3b2e7eed1bed42\",\r\n    \"proposedBlockCount\" : \"0x27\",\r\n    \"lastProposedBlockNumber\" : \"0x49861\"\r\n  }, {\r\n    \"address\" : \"0xacdc45d33323aef1ca434dea8bdbefa1872f416a\",\r\n    \"proposedBlockCount\" : \"0x28\",\r\n    \"lastProposedBlockNumber\" : \"0x49864\"\r\n  }, {\r\n    \"address\" : \"0xf54079cbe8f9b21c3251c4371d4ca50d6763a9bf\",\r\n    \"proposedBlockCount\" : \"0x0\",\r\n    \"lastProposedBlockNumber\" : \"0x0\"\r\n  }, {\r\n    \"address\" : \"0x8c4390e977b81555086bf7ed75fe7d04d192ccf3\",\r\n    \"proposedBlockCount\" : \"0x27\",\r\n    \"lastProposedBlockNumber\" : \"0x49863\"\r\n  }, {\r\n    \"address\" : \"0x2fd6084b147bcec6c6786006ba51c4f2230abbce\",\r\n    \"proposedBlockCount\" : \"0x27\",\r\n    \"lastProposedBlockNumber\" : \"0x49862\"\r\n  } ]\r\n}\r\n```\r\n\r\n**Expected behavior:** \r\nPC2 node can import block to chain.\r\n\r\n**Actual behavior:** \r\nPC2 node's block did not pass validation.\r\nThe message is as follows:\r\n`pool-10-thread-1 | INFO | MessageValidator | Invalid Proposal message, block did not pass validation.`\r\n\r\n```\r\n2020-04-22 03:33:32.194+00:00 | pool-10-thread-1 | INFO  | IbftRound | Importing block to chain. round=ConsensusRoundIdentifier{Sequence=300946, Round=1}, hash=0x6964c78dc085eca48b5d40af14181aad77f217d27acd925221cddae4a2c6cb7a\r\n2020-04-22 03:33:32.258+00:00 | EthScheduler-Workers-1 | INFO  | BlockPropagationManager | Imported #300,946 / 0 tx / 0 om / 0 (0.0%) gas / (0x6964c78dc085eca48b5d40af14181aad77f217d27acd925221cddae4a2c6cb7a) in 0.001s. Peers: 5\r\n2020-04-22 03:33:34.070+00:00 | pool-10-thread-1 | INFO  | IbftRound | Importing block to chain. round=ConsensusRoundIdentifier{Sequence=300947, Round=0}, hash=0x66c9d1e67e8e8babfeb21b498b33012857ba4dffc3835385ec7ebad3b38f76da\r\n2020-04-22 03:33:36.063+00:00 | pool-10-thread-1 | INFO  | IbftRound | Importing block to chain. round=ConsensusRoundIdentifier{Sequence=300948, Round=0}, hash=0xa094c451e423e681891158d673613dedb7fa638586f8b58656798d39934bb948\r\n2020-04-22 03:33:36.143+00:00 | EthScheduler-Workers-3 | INFO  | BlockPropagationManager | Imported #300,948 / 0 tx / 0 om / 0 (0.0%) gas / (0xa094c451e423e681891158d673613dedb7fa638586f8b58656798d39934bb948) in 0.000s. Peers: 5\r\n2020-04-22 03:33:38.065+00:00 | pool-10-thread-1 | INFO  | IbftRound | Importing block to chain. round=ConsensusRoundIdentifier{Sequence=300949, Round=0}, hash=0xc3efa7a31b19d1790e5306cfa4c3442e1f219e04223f2988f2ba480490a6fb79\r\n2020-04-22 03:33:38.096+00:00 | pool-10-thread-1 | INFO  | MessageValidator | Invalid Proposal message, block did not pass validation.\r\n2020-04-22 03:33:48.202+00:00 | pool-10-thread-1 | INFO  | IbftRound | Importing block to chain. round=ConsensusRoundIdentifier{Sequence=300950, Round=1}, hash=0x881ed2efeb573b3f3496df62c17d39093e37adc6c0a2e4f5a77caccbfc670582\r\n2020-04-22 03:33:50.062+00:00 | pool-10-thread-1 | INFO  | IbftRound | Importing block to chain. round=ConsensusRoundIdentifier{Sequence=300951, Round=0}, hash=0xd68e18a8bca804094b3b2fe1c677fb05688ef4ba57622c8cae18062ef28eec3b\r\n2020-04-22 03:33:52.077+00:00 | pool-10-thread-1 | INFO  | IbftRound | Importing block to chain. round=ConsensusRoundIdentifier{Sequence=300952, Round=0}, hash=0x309d87653c063df5f353525465b74b3e96242ae66094e48a5043cf5e0dab4cbd\r\n2020-04-22 03:33:52.152+00:00 | EthScheduler-Workers-0 | INFO  | BlockPropagationManager | Imported #300,952 / 0 tx / 0 om / 0 (0.0%) gas / (0x309d87653c063df5f353525465b74b3e96242ae66094e48a5043cf5e0dab4cbd) in 0.000s. Peers: 5\r\n2020-04-22 03:33:54.067+00:00 | pool-10-thread-1 | INFO  | IbftRound | Importing block to chain. round=ConsensusRoundIdentifier{Sequence=300953, Round=0}, hash=0xf4df6692b8fe476b6accaf5dff9de96461dc591ff5fc281dfcba063aa3c81092\r\n2020-04-22 03:33:54.145+00:00 | EthScheduler-Workers-2 | INFO  | BlockPropagationManager | Imported #300,953 / 0 tx / 0 om / 0 (0.0%) gas / (0xf4df6692b8fe476b6accaf5dff9de96461dc591ff5fc281dfcba063aa3c81092) in 0.017s. Peers: 5\r\n2020-04-22 03:33:54.159+00:00 | pool-10-thread-1 | INFO  | MessageValidator | Invalid Proposal message, block did not pass validation.\r\n```\r\n\r\n**Frequency:** \r\nThis error occurs when PC2 node write a block to the chain.\r\n \r\n### Versions (Add all that apply)\r\n* Software version: `besu:1.4.3`\r\n\r\n### Additional Information\r\nI'm sure all four of my validators have voted.\r\nAm I missing something?",
  "closed_by": {
    "login": "MadelineMurray",
    "id": 43356962,
    "node_id": "MDQ6VXNlcjQzMzU2OTYy",
    "avatar_url": "https://avatars.githubusercontent.com/u/43356962?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/MadelineMurray",
    "html_url": "https://github.com/MadelineMurray",
    "followers_url": "https://api.github.com/users/MadelineMurray/followers",
    "following_url": "https://api.github.com/users/MadelineMurray/following{/other_user}",
    "gists_url": "https://api.github.com/users/MadelineMurray/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/MadelineMurray/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/MadelineMurray/subscriptions",
    "organizations_url": "https://api.github.com/users/MadelineMurray/orgs",
    "repos_url": "https://api.github.com/users/MadelineMurray/repos",
    "events_url": "https://api.github.com/users/MadelineMurray/events{/privacy}",
    "received_events_url": "https://api.github.com/users/MadelineMurray/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/765/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/hyperledger/besu/issues/765/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/618068776",
    "html_url": "https://github.com/hyperledger/besu/issues/765#issuecomment-618068776",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/765",
    "id": 618068776,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYxODA2ODc3Ng==",
    "user": {
      "login": "rain-on",
      "id": 37158202,
      "node_id": "MDQ6VXNlcjM3MTU4MjAy",
      "avatar_url": "https://avatars.githubusercontent.com/u/37158202?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rain-on",
      "html_url": "https://github.com/rain-on",
      "followers_url": "https://api.github.com/users/rain-on/followers",
      "following_url": "https://api.github.com/users/rain-on/following{/other_user}",
      "gists_url": "https://api.github.com/users/rain-on/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rain-on/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rain-on/subscriptions",
      "organizations_url": "https://api.github.com/users/rain-on/orgs",
      "repos_url": "https://api.github.com/users/rain-on/repos",
      "events_url": "https://api.github.com/users/rain-on/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rain-on/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-04-22T22:15:31Z",
    "updated_at": "2020-04-22T22:26:28Z",
    "author_association": "CONTRIBUTOR",
    "body": "Hi @PeiChia,\r\nThis behaviour is somewhat surprising, but potentially possible in a healthy setup, I'll seek to replicate this in my environment, but I don't have your exact setup, so may not be visible.\r\n\r\nThe log file produced above - is that from your PC2 node? If so - that implies that the proposal message that is being received by PC2 is being rejected due to an illegal block (rather than any other reason). This in turn implies that either the header of the block failed validation, or the transactions in it were invalid.\r\nA few other things it shows:\r\n* IbftRound message lines indicate this node is participating in IBFT consensus and producing blocks (good)\r\n* BlockPropogationManager lines indicate it is also receiving blocks as part of standard Ethereum protocol (which is entirely valid, and also good)\r\n* MessageValidator lines imply this node is receiving a Proposal which is not valid - and thus you see that the following line has \"Round=1\", implying that a new proposal had to be built (not so good).\r\n\r\nIt appears that your setup is continuing to progress the blockchain - however, there is something odd in that a RoundChange occurs at a relatively fixed cadence ...\r\n\r\nGiven this fixed cadence, I suspect its a header issue in the proposed block - can you confirm the clocks in your k8s are all synchronised - i.e. do they all have the same system-time? If not, that could trip this error.\r\n\r\nAre you able to replicate the bug but with debug logging turned on (--logging=DEBUG), and then supply us with all log files?\r\n\r\nKind regards.",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/618068776/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/620964247",
    "html_url": "https://github.com/hyperledger/besu/issues/765#issuecomment-620964247",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/765",
    "id": 620964247,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyMDk2NDI0Nw==",
    "user": {
      "login": "PeiChia",
      "id": 39792162,
      "node_id": "MDQ6VXNlcjM5NzkyMTYy",
      "avatar_url": "https://avatars.githubusercontent.com/u/39792162?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/PeiChia",
      "html_url": "https://github.com/PeiChia",
      "followers_url": "https://api.github.com/users/PeiChia/followers",
      "following_url": "https://api.github.com/users/PeiChia/following{/other_user}",
      "gists_url": "https://api.github.com/users/PeiChia/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/PeiChia/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/PeiChia/subscriptions",
      "organizations_url": "https://api.github.com/users/PeiChia/orgs",
      "repos_url": "https://api.github.com/users/PeiChia/repos",
      "events_url": "https://api.github.com/users/PeiChia/events{/privacy}",
      "received_events_url": "https://api.github.com/users/PeiChia/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-04-29T02:58:22Z",
    "updated_at": "2020-04-29T02:58:22Z",
    "author_association": "NONE",
    "body": "Hi @rain-on ,\r\n\r\nI'm sorry to reply to you now,\r\nLast week the environment was broken during the test ...\r\n\r\nTherefore, I rebuilt the environment and nodes on the other two computers,\r\nThe result `convert node to validator through ibft voting` was successful.\r\n\r\nSo, the conclusion of the problem is that the error caused by the computer environment, and has nothing to do with the besu network.\r\n\r\nFinally, I truly appreciate your reply! Thanks a lot!",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/620964247/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/647180668",
    "html_url": "https://github.com/hyperledger/besu/issues/765#issuecomment-647180668",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/765",
    "id": 647180668,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY0NzE4MDY2OA==",
    "user": {
      "login": "MadelineMurray",
      "id": 43356962,
      "node_id": "MDQ6VXNlcjQzMzU2OTYy",
      "avatar_url": "https://avatars.githubusercontent.com/u/43356962?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MadelineMurray",
      "html_url": "https://github.com/MadelineMurray",
      "followers_url": "https://api.github.com/users/MadelineMurray/followers",
      "following_url": "https://api.github.com/users/MadelineMurray/following{/other_user}",
      "gists_url": "https://api.github.com/users/MadelineMurray/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MadelineMurray/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MadelineMurray/subscriptions",
      "organizations_url": "https://api.github.com/users/MadelineMurray/orgs",
      "repos_url": "https://api.github.com/users/MadelineMurray/repos",
      "events_url": "https://api.github.com/users/MadelineMurray/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MadelineMurray/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-06-21T20:57:23Z",
    "updated_at": "2020-06-21T20:57:23Z",
    "author_association": "CONTRIBUTOR",
    "body": "Thanks for letting us know @PeiChia ",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/647180668/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
