{
  "url": "https://api.github.com/repos/hyperledger/besu/issues/1252",
  "repository_url": "https://api.github.com/repos/hyperledger/besu",
  "labels_url": "https://api.github.com/repos/hyperledger/besu/issues/1252/labels{/name}",
  "comments_url": "https://api.github.com/repos/hyperledger/besu/issues/1252/comments",
  "events_url": "https://api.github.com/repos/hyperledger/besu/issues/1252/events",
  "html_url": "https://github.com/hyperledger/besu/issues/1252",
  "id": 664811763,
  "node_id": "MDU6SXNzdWU2NjQ4MTE3NjM=",
  "number": 1252,
  "title": "Off chain permissioning issue with Discovery peers",
  "user": {
    "login": "joshuafernandes",
    "id": 3722503,
    "node_id": "MDQ6VXNlcjM3MjI1MDM=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3722503?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/joshuafernandes",
    "html_url": "https://github.com/joshuafernandes",
    "followers_url": "https://api.github.com/users/joshuafernandes/followers",
    "following_url": "https://api.github.com/users/joshuafernandes/following{/other_user}",
    "gists_url": "https://api.github.com/users/joshuafernandes/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/joshuafernandes/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/joshuafernandes/subscriptions",
    "organizations_url": "https://api.github.com/users/joshuafernandes/orgs",
    "repos_url": "https://api.github.com/users/joshuafernandes/repos",
    "events_url": "https://api.github.com/users/joshuafernandes/events{/privacy}",
    "received_events_url": "https://api.github.com/users/joshuafernandes/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1537362490,
      "node_id": "MDU6TGFiZWwxNTM3MzYyNDkw",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/bug",
      "name": "bug",
      "color": "d73a4a",
      "default": true,
      "description": "Something isn't working"
    },
    {
      "id": 2051683573,
      "node_id": "MDU6TGFiZWwyMDUxNjgzNTcz",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/P3",
      "name": "P3",
      "color": "ffff00",
      "default": false,
      "description": "Medium (ex: JSON-RPC request not working with a specific client library due to loose spec assumtion)"
    },
    {
      "id": 2152224197,
      "node_id": "MDU6TGFiZWwyMTUyMjI0MTk3",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/TeamRevenant",
      "name": "TeamRevenant",
      "color": "78e298",
      "default": false,
      "description": "GH issues worked on by Revenant Team"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "macfarla",
    "id": 2627919,
    "node_id": "MDQ6VXNlcjI2Mjc5MTk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2627919?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/macfarla",
    "html_url": "https://github.com/macfarla",
    "followers_url": "https://api.github.com/users/macfarla/followers",
    "following_url": "https://api.github.com/users/macfarla/following{/other_user}",
    "gists_url": "https://api.github.com/users/macfarla/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/macfarla/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/macfarla/subscriptions",
    "organizations_url": "https://api.github.com/users/macfarla/orgs",
    "repos_url": "https://api.github.com/users/macfarla/repos",
    "events_url": "https://api.github.com/users/macfarla/events{/privacy}",
    "received_events_url": "https://api.github.com/users/macfarla/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "macfarla",
      "id": 2627919,
      "node_id": "MDQ6VXNlcjI2Mjc5MTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2627919?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/macfarla",
      "html_url": "https://github.com/macfarla",
      "followers_url": "https://api.github.com/users/macfarla/followers",
      "following_url": "https://api.github.com/users/macfarla/following{/other_user}",
      "gists_url": "https://api.github.com/users/macfarla/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/macfarla/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/macfarla/subscriptions",
      "organizations_url": "https://api.github.com/users/macfarla/orgs",
      "repos_url": "https://api.github.com/users/macfarla/repos",
      "events_url": "https://api.github.com/users/macfarla/events{/privacy}",
      "received_events_url": "https://api.github.com/users/macfarla/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2020-07-23T22:51:12Z",
  "updated_at": "2020-08-25T01:23:44Z",
  "closed_at": "2020-08-25T01:23:44Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "<!-- Have you done the following? -->\r\n<!--   * read the Code of Conduct? By filing an Issue, you are expected to -->  \r\n<!--     comply with it, including treating everyone with respect: -->\r\n<!--     https://github.com/hyperledger/besu/blob/master/CODE-OF-CONDUCT.md -->\r\n<!--   * Reproduced the issue in the latest version of the software -->\r\n<!--   * Read the debugging wiki: https://github.com/hyperledger/besu/wiki/debugging -->\r\n<!--   * Duplicate Issue check:  https://github.com/search?q=+is%3Aissue+repo%3Ahyperledger/Besu -->\r\n<!-- Note:  Not all sections will apply to all issue types. -->\r\n\r\n### Description\r\nIn spinning up a network of 8 nodes I'd like to setup offchain permissioning from the beginning. So have followed the docs and put the enodes in a permissions.json file and started the nodes up which works fine and I can see the chain head progressing, but the issue is that all nodes only report a peer count of 1 instead of 7. When I turn permissions off, all 7 peers are reported straight off. Also not seeing any errors in the logs re disallowed permissions and the chain is progressing so the permissions look about right.\r\n\r\nI've tried stopping and starting a node again and that resulted in it reporting 3 or 4 peers (& the ones it connected to also reported more peers) but not the full 7. Im not sure when the discovery rounds fire and maybe this will be eventually consistent? Ping @arash009 or @joshuafernandes for more details\r\n\r\n### Acceptance Criteria\r\nOffchain node permissioning reports more peers initially than just the bootnode\r\n\r\n### Steps to Reproduce (Bug)\r\nPing @arash009 or @joshuafernandes for more details - test setup can be provided \r\n\r\n**Expected behavior:** [What you expect to happen]\r\nOffchain node permissioning should get all peers reporting 7 nodes in a reasonable time frame\r\n\r\n**Actual behavior:** [What actually happens]\r\nOffchain node permissioning shas all peers reporting 1 peer only out of 7\r\n\r\n**Frequency:** [What percentage of the time does it occur?]\r\n100%\r\n\r\n### Versions (Add all that apply)\r\nBesu 1.5.x on docker-compose\r\n\r\n### Additional Information\r\n\r\n",
  "closed_by": {
    "login": "MadelineMurray",
    "id": 43356962,
    "node_id": "MDQ6VXNlcjQzMzU2OTYy",
    "avatar_url": "https://avatars.githubusercontent.com/u/43356962?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/MadelineMurray",
    "html_url": "https://github.com/MadelineMurray",
    "followers_url": "https://api.github.com/users/MadelineMurray/followers",
    "following_url": "https://api.github.com/users/MadelineMurray/following{/other_user}",
    "gists_url": "https://api.github.com/users/MadelineMurray/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/MadelineMurray/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/MadelineMurray/subscriptions",
    "organizations_url": "https://api.github.com/users/MadelineMurray/orgs",
    "repos_url": "https://api.github.com/users/MadelineMurray/repos",
    "events_url": "https://api.github.com/users/MadelineMurray/events{/privacy}",
    "received_events_url": "https://api.github.com/users/MadelineMurray/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/1252/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/hyperledger/besu/issues/1252/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/664104241",
    "html_url": "https://github.com/hyperledger/besu/issues/1252#issuecomment-664104241",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/1252",
    "id": 664104241,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY2NDEwNDI0MQ==",
    "user": {
      "login": "macfarla",
      "id": 2627919,
      "node_id": "MDQ6VXNlcjI2Mjc5MTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2627919?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/macfarla",
      "html_url": "https://github.com/macfarla",
      "followers_url": "https://api.github.com/users/macfarla/followers",
      "following_url": "https://api.github.com/users/macfarla/following{/other_user}",
      "gists_url": "https://api.github.com/users/macfarla/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/macfarla/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/macfarla/subscriptions",
      "organizations_url": "https://api.github.com/users/macfarla/orgs",
      "repos_url": "https://api.github.com/users/macfarla/repos",
      "events_url": "https://api.github.com/users/macfarla/events{/privacy}",
      "received_events_url": "https://api.github.com/users/macfarla/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-07-27T03:49:07Z",
    "updated_at": "2020-07-27T03:55:00Z",
    "author_association": "CONTRIBUTOR",
    "body": "I can reproduce this behaviour. Best guess is something to do with how/when discovery is initiated. \n\nmodifying dependencies in docker-compose so that the nodes start sequentially (rather than bootnode then the rest all at once) seems to improve things - ie after about 3 min most nodes have n-1 peers. However this is still less than expected, and one node is stuck with only 1 peer.\n\nThat node initiates neighbours round with 1 candidate (bootnode) but does not receive any neighbours packets\n\n`{\"timestamp\":\"2020-07-27T03:21:59,300\",\"container\":\"981c7511f6cb\",\"level\":\"DEBUG\",\"thread\":\"vert.x-eventloop-thread-2\",\"class\":\"RecursivePeerRefreshState\",\"message\":\"Initiating neighbours round with 1 candidates from 1 tracked nodes\",\"throwable\":\"\"}`\n\nAfter restarting this one node, neighbours packets are received, and all nodes then end up with n peers.\n```{\"timestamp\":\"2020-07-27T03:46:38,405\",\"container\":\"981c7511f6cb\",\"level\":\"DEBUG\",\"thread\":\"vert.x-eventloop-thread-2\",\"class\":\"PeerDiscoveryController\",\"message\":\"Peer table refresh triggered by timer expiry\",\"throwable\":\"\"}\n{\"timestamp\":\"2020-07-27T03:46:38,407\",\"container\":\"981c7511f6cb\",\"level\":\"DEBUG\",\"thread\":\"vert.x-eventloop-thread-2\",\"class\":\"RecursivePeerRefreshState\",\"message\":\"Start peer search.\",\"throwable\":\"\"}\n{\"timestamp\":\"2020-07-27T03:46:38,408\",\"container\":\"981c7511f6cb\",\"level\":\"DEBUG\",\"thread\":\"vert.x-eventloop-thread-2\",\"class\":\"RecursivePeerRefreshState\",\"message\":\"Skipping bonding round because no candidates are available\",\"throwable\":\"\"}\n{\"timestamp\":\"2020-07-27T03:46:38,409\",\"container\":\"981c7511f6cb\",\"level\":\"DEBUG\",\"thread\":\"vert.x-eventloop-thread-2\",\"class\":\"RecursivePeerRefreshState\",\"message\":\"Initiating neighbours round with 3 candidates from 4 tracked nodes\",\"throwable\":\"\"}\n{\"timestamp\":\"2020-07-27T03:46:38,430\",\"container\":\"981c7511f6cb\",\"level\":\"DEBUG\",\"thread\":\"vert.x-eventloop-thread-2\",\"class\":\"RecursivePeerRefreshState\",\"message\":\"Received neighbours packet with 4 neighbours\",\"throwable\":\"\"}\n{\"timestamp\":\"2020-07-27T03:46:38,431\",\"container\":\"981c7511f6cb\",\"level\":\"DEBUG\",\"thread\":\"vert.x-eventloop-thread-2\",\"class\":\"RecursivePeerRefreshState\",\"message\":\"Received neighbours packet with 4 neighbours\",\"throwable\":\"\"}\n{\"timestamp\":\"2020-07-27T03:46:38,432\",\"container\":\"981c7511f6cb\",\"level\":\"DEBUG\",\"thread\":\"vert.x-eventloop-thread-2\",\"class\":\"RecursivePeerRefreshState\",\"message\":\"Received neighbours packet with 4 neighbours\",\"throwable\":\"\"}\n{\"timestamp\":\"2020-07-27T03:46:38,433\",\"container\":\"981c7511f6cb\",\"level\":\"DEBUG\",\"thread\":\"vert.x-eventloop-thread-2\",\"class\":\"RecursivePeerRefreshState\",\"message\":\"Skipping bonding round because no candidates are available\",\"throwable\":\"\"}\n{\"timestamp\":\"2020-07-27T03:46:38,434\",\"container\":\"981c7511f6cb\",\"level\":\"DEBUG\",\"thread\":\"vert.x-eventloop-thread-2\",\"class\":\"RecursivePeerRefreshState\",\"message\":\"Initiating neighbours round with 1 candidates from 4 tracked nodes\",\"throwable\":\"\"}\n{\"timestamp\":\"2020-07-27T03:46:38,442\",\"container\":\"981c7511f6cb\",\"level\":\"DEBUG\",\"thread\":\"vert.x-eventloop-thread-2\",\"class\":\"RecursivePeerRefreshState\",\"message\":\"Received neighbours packet with 4 neighbours\",\"throwable\":\"\"}\n{\"timestamp\":\"2020-07-27T03:46:38,443\",\"container\":\"981c7511f6cb\",\"level\":\"DEBUG\",\"thread\":\"vert.x-eventloop-thread-2\",\"class\":\"RecursivePeerRefreshState\",\"message\":\"Skipping bonding round because no candidates are available\",\"throwable\":\"\"}```",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/664104241/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/665268707",
    "html_url": "https://github.com/hyperledger/besu/issues/1252#issuecomment-665268707",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/1252",
    "id": 665268707,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY2NTI2ODcwNw==",
    "user": {
      "login": "macfarla",
      "id": 2627919,
      "node_id": "MDQ6VXNlcjI2Mjc5MTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2627919?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/macfarla",
      "html_url": "https://github.com/macfarla",
      "followers_url": "https://api.github.com/users/macfarla/followers",
      "following_url": "https://api.github.com/users/macfarla/following{/other_user}",
      "gists_url": "https://api.github.com/users/macfarla/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/macfarla/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/macfarla/subscriptions",
      "organizations_url": "https://api.github.com/users/macfarla/orgs",
      "repos_url": "https://api.github.com/users/macfarla/repos",
      "events_url": "https://api.github.com/users/macfarla/events{/privacy}",
      "received_events_url": "https://api.github.com/users/macfarla/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-07-28T20:34:23Z",
    "updated_at": "2020-07-28T20:34:23Z",
    "author_association": "CONTRIBUTOR",
    "body": "TRACE logging at startup shows some connections are being rejected by Node Permissioning Controller with reason \"Sync Status\" which should not be checked for offchain permissioning. ",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/665268707/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/665976739",
    "html_url": "https://github.com/hyperledger/besu/issues/1252#issuecomment-665976739",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/1252",
    "id": 665976739,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY2NTk3NjczOQ==",
    "user": {
      "login": "macfarla",
      "id": 2627919,
      "node_id": "MDQ6VXNlcjI2Mjc5MTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2627919?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/macfarla",
      "html_url": "https://github.com/macfarla",
      "followers_url": "https://api.github.com/users/macfarla/followers",
      "following_url": "https://api.github.com/users/macfarla/following{/other_user}",
      "gists_url": "https://api.github.com/users/macfarla/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/macfarla/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/macfarla/subscriptions",
      "organizations_url": "https://api.github.com/users/macfarla/orgs",
      "repos_url": "https://api.github.com/users/macfarla/repos",
      "events_url": "https://api.github.com/users/macfarla/events{/privacy}",
      "received_events_url": "https://api.github.com/users/macfarla/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-07-29T23:12:08Z",
    "updated_at": "2020-07-29T23:12:24Z",
    "author_association": "CONTRIBUTOR",
    "body": "@joshuafernandes I did a fresh checkout of the quorum-dev repo, reproduced your problem, updated docker-compose.yaml to my local build and it works. Peering AND producing blocks. This PR has been merged into master now, please let us know whether it fixes the problem for you.",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/665976739/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
