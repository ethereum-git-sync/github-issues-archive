{
  "url": "https://api.github.com/repos/hyperledger/besu/issues/614",
  "repository_url": "https://api.github.com/repos/hyperledger/besu",
  "labels_url": "https://api.github.com/repos/hyperledger/besu/issues/614/labels{/name}",
  "comments_url": "https://api.github.com/repos/hyperledger/besu/issues/614/comments",
  "events_url": "https://api.github.com/repos/hyperledger/besu/issues/614/events",
  "html_url": "https://github.com/hyperledger/besu/issues/614",
  "id": 590575491,
  "node_id": "MDU6SXNzdWU1OTA1NzU0OTE=",
  "number": 614,
  "title": "Better handling of private and public nonces with Private Transactions",
  "user": {
    "login": "lucassaldanha",
    "id": 1766440,
    "node_id": "MDQ6VXNlcjE3NjY0NDA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1766440?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/lucassaldanha",
    "html_url": "https://github.com/lucassaldanha",
    "followers_url": "https://api.github.com/users/lucassaldanha/followers",
    "following_url": "https://api.github.com/users/lucassaldanha/following{/other_user}",
    "gists_url": "https://api.github.com/users/lucassaldanha/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/lucassaldanha/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/lucassaldanha/subscriptions",
    "organizations_url": "https://api.github.com/users/lucassaldanha/orgs",
    "repos_url": "https://api.github.com/users/lucassaldanha/repos",
    "events_url": "https://api.github.com/users/lucassaldanha/events{/privacy}",
    "received_events_url": "https://api.github.com/users/lucassaldanha/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1537362496,
      "node_id": "MDU6TGFiZWwxNTM3MzYyNDk2",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/enhancement",
      "name": "enhancement",
      "color": "a2eeef",
      "default": true,
      "description": "New feature or request"
    },
    {
      "id": 1740324632,
      "node_id": "MDU6TGFiZWwxNzQwMzI0NjMy",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/privacy",
      "name": "privacy",
      "color": "d7f99a",
      "default": false,
      "description": "private transactions"
    },
    {
      "id": 2152224197,
      "node_id": "MDU6TGFiZWwyMTUyMjI0MTk3",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/TeamRevenant",
      "name": "TeamRevenant",
      "color": "78e298",
      "default": false,
      "description": "GH issues worked on by Revenant Team"
    },
    {
      "id": 4328777430,
      "node_id": "LA_kwDODE2jmc8AAAABAgPm1g",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/blocked",
      "name": "blocked",
      "color": "B60205",
      "default": false,
      "description": null
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "macfarla",
    "id": 2627919,
    "node_id": "MDQ6VXNlcjI2Mjc5MTk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2627919?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/macfarla",
    "html_url": "https://github.com/macfarla",
    "followers_url": "https://api.github.com/users/macfarla/followers",
    "following_url": "https://api.github.com/users/macfarla/following{/other_user}",
    "gists_url": "https://api.github.com/users/macfarla/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/macfarla/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/macfarla/subscriptions",
    "organizations_url": "https://api.github.com/users/macfarla/orgs",
    "repos_url": "https://api.github.com/users/macfarla/repos",
    "events_url": "https://api.github.com/users/macfarla/events{/privacy}",
    "received_events_url": "https://api.github.com/users/macfarla/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "macfarla",
      "id": 2627919,
      "node_id": "MDQ6VXNlcjI2Mjc5MTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2627919?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/macfarla",
      "html_url": "https://github.com/macfarla",
      "followers_url": "https://api.github.com/users/macfarla/followers",
      "following_url": "https://api.github.com/users/macfarla/following{/other_user}",
      "gists_url": "https://api.github.com/users/macfarla/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/macfarla/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/macfarla/subscriptions",
      "organizations_url": "https://api.github.com/users/macfarla/orgs",
      "repos_url": "https://api.github.com/users/macfarla/repos",
      "events_url": "https://api.github.com/users/macfarla/events{/privacy}",
      "received_events_url": "https://api.github.com/users/macfarla/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2020-03-30T20:31:53Z",
  "updated_at": "2023-01-27T02:26:17Z",
  "closed_at": "2023-01-27T02:26:17Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "This problem was first identified on #571. Given that the private transaction has its own nonce (relative to the sender account withing the privacy group), and the PMT has its own nonce (relative to the account that is creating the PMT), things can get messy.\r\n\r\nThe simplest scenario is the following:\r\n- account X has private nonce 0 in privacy group P\r\n- account X has public nonce 0 in the public world\r\n- User send privTx1 (sender: X, nonce: 0) and privTx2 (sender: X, nonce: 1)\r\n\r\nWhen creating the PMT, we check for pending txs in the pool. However, things happen asynchronously so when creating the second PMT, the first one might not be in the pool yet. So we might end up with:\r\n-  PMT1(privTx1, sender: x, nonce: 0)\r\n- PMT2(privTx2, sender: X, nonce: 0)\r\n\r\nThis will lead to a failure of the second PMT.\r\n\r\nEven worse, depending on the order that the transactions reach the client, we might end up with:\r\n- PMT1(privTx1, sender: x, nonce: 1)\r\n- PMT2(privTx2, sender: X, nonce: 0)\r\n\r\nThis will cause the PMTs to succeed but the underlying private transaction will be executed in the wrong order and will fail.\r\n\r\nWe have identified a workaround, using priv_distributeRawTransaction and eth_sendRawTransaction, to have control over the private and public nonces being used. However, this is hard work and it would be good if we could come up with an alternative.\r\n\r\nThis is the example of using web3js-eea to do it: https://github.com/PegaSysEng/web3js-eea/blob/master/example/concurrentPrivateTransactions/concurrentPrivateTransactions.js",
  "closed_by": {
    "login": "iamhsk",
    "id": 2249367,
    "node_id": "MDQ6VXNlcjIyNDkzNjc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2249367?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/iamhsk",
    "html_url": "https://github.com/iamhsk",
    "followers_url": "https://api.github.com/users/iamhsk/followers",
    "following_url": "https://api.github.com/users/iamhsk/following{/other_user}",
    "gists_url": "https://api.github.com/users/iamhsk/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/iamhsk/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/iamhsk/subscriptions",
    "organizations_url": "https://api.github.com/users/iamhsk/orgs",
    "repos_url": "https://api.github.com/users/iamhsk/repos",
    "events_url": "https://api.github.com/users/iamhsk/events{/privacy}",
    "received_events_url": "https://api.github.com/users/iamhsk/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/614/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/hyperledger/besu/issues/614/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/708106875",
    "html_url": "https://github.com/hyperledger/besu/issues/614#issuecomment-708106875",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/614",
    "id": 708106875,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcwODEwNjg3NQ==",
    "user": {
      "login": "MadelineMurray",
      "id": 43356962,
      "node_id": "MDQ6VXNlcjQzMzU2OTYy",
      "avatar_url": "https://avatars.githubusercontent.com/u/43356962?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MadelineMurray",
      "html_url": "https://github.com/MadelineMurray",
      "followers_url": "https://api.github.com/users/MadelineMurray/followers",
      "following_url": "https://api.github.com/users/MadelineMurray/following{/other_user}",
      "gists_url": "https://api.github.com/users/MadelineMurray/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MadelineMurray/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MadelineMurray/subscriptions",
      "organizations_url": "https://api.github.com/users/MadelineMurray/orgs",
      "repos_url": "https://api.github.com/users/MadelineMurray/repos",
      "events_url": "https://api.github.com/users/MadelineMurray/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MadelineMurray/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-10-14T01:58:13Z",
    "updated_at": "2020-10-14T01:58:13Z",
    "author_association": "CONTRIBUTOR",
    "body": "We should take this into account in the design of the interoperable privacy solution. ",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/708106875/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/725941452",
    "html_url": "https://github.com/hyperledger/besu/issues/614#issuecomment-725941452",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/614",
    "id": 725941452,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcyNTk0MTQ1Mg==",
    "user": {
      "login": "nmvalera",
      "id": 11678274,
      "node_id": "MDQ6VXNlcjExNjc4Mjc0",
      "avatar_url": "https://avatars.githubusercontent.com/u/11678274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nmvalera",
      "html_url": "https://github.com/nmvalera",
      "followers_url": "https://api.github.com/users/nmvalera/followers",
      "following_url": "https://api.github.com/users/nmvalera/following{/other_user}",
      "gists_url": "https://api.github.com/users/nmvalera/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nmvalera/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nmvalera/subscriptions",
      "organizations_url": "https://api.github.com/users/nmvalera/orgs",
      "repos_url": "https://api.github.com/users/nmvalera/repos",
      "events_url": "https://api.github.com/users/nmvalera/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nmvalera/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-11-12T09:00:44Z",
    "updated_at": "2020-11-12T09:02:24Z",
    "author_association": "NONE",
    "body": "Would it be an option to make the private transaction nonce a unique identifier and not an incremental number? So for a private transaction to be processed, it should have a nonce that has not been used by any prior transaction.\r\n\r\nIt would\r\n- protect private transaction against replay attacks\r\n- rely on a single ordering (the PMT nonce)\r\n\r\nThis would require\r\n- storing all nonces already used by an account on the account storage\r\n- checking if a nonce has already been used without a significative drop in performance\r\n\r\nA Bloom filter could maybe do the job but it would probably imply updating the private account data structure which is something we may prefer to avoid.",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/725941452/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/725944104",
    "html_url": "https://github.com/hyperledger/besu/issues/614#issuecomment-725944104",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/614",
    "id": 725944104,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcyNTk0NDEwNA==",
    "user": {
      "login": "nmvalera",
      "id": 11678274,
      "node_id": "MDQ6VXNlcjExNjc4Mjc0",
      "avatar_url": "https://avatars.githubusercontent.com/u/11678274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nmvalera",
      "html_url": "https://github.com/nmvalera",
      "followers_url": "https://api.github.com/users/nmvalera/followers",
      "following_url": "https://api.github.com/users/nmvalera/following{/other_user}",
      "gists_url": "https://api.github.com/users/nmvalera/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nmvalera/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nmvalera/subscriptions",
      "organizations_url": "https://api.github.com/users/nmvalera/orgs",
      "repos_url": "https://api.github.com/users/nmvalera/repos",
      "events_url": "https://api.github.com/users/nmvalera/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nmvalera/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-11-12T09:05:26Z",
    "updated_at": "2020-11-12T09:05:26Z",
    "author_association": "NONE",
    "body": "Btw Orchestrate does not use `eea_sendRawTransaction` anymore but uses a `priv_distributeRawTransaction` then `eth_sendRawTransaction` approach to retain full control over both nonces.",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/725944104/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/938249028",
    "html_url": "https://github.com/hyperledger/besu/issues/614#issuecomment-938249028",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/614",
    "id": 938249028,
    "node_id": "IC_kwDODE2jmc437ItE",
    "user": {
      "login": "macfarla",
      "id": 2627919,
      "node_id": "MDQ6VXNlcjI2Mjc5MTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2627919?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/macfarla",
      "html_url": "https://github.com/macfarla",
      "followers_url": "https://api.github.com/users/macfarla/followers",
      "following_url": "https://api.github.com/users/macfarla/following{/other_user}",
      "gists_url": "https://api.github.com/users/macfarla/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/macfarla/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/macfarla/subscriptions",
      "organizations_url": "https://api.github.com/users/macfarla/orgs",
      "repos_url": "https://api.github.com/users/macfarla/repos",
      "events_url": "https://api.github.com/users/macfarla/events{/privacy}",
      "received_events_url": "https://api.github.com/users/macfarla/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-10-08T00:35:00Z",
    "updated_at": "2021-10-08T00:35:00Z",
    "author_association": "CONTRIBUTOR",
    "body": "One option - keep track of \"pending\" private tx\n* add info to the PMT (what is needed to compute \"pending\" private nonce): privacyGroupId, sender\n* this extra info needs to stay local to the node ie does not get propagated (it is private info)\n* hence the limitation would be that if you submit multiple private tx, they should all be submitted to the same node\n* when calculating the private nonce, inspect what is already in the tx pool",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/938249028/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/955839405",
    "html_url": "https://github.com/hyperledger/besu/issues/614#issuecomment-955839405",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/614",
    "id": 955839405,
    "node_id": "IC_kwDODE2jmc44-POt",
    "user": {
      "login": "macfarla",
      "id": 2627919,
      "node_id": "MDQ6VXNlcjI2Mjc5MTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2627919?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/macfarla",
      "html_url": "https://github.com/macfarla",
      "followers_url": "https://api.github.com/users/macfarla/followers",
      "following_url": "https://api.github.com/users/macfarla/following{/other_user}",
      "gists_url": "https://api.github.com/users/macfarla/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/macfarla/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/macfarla/subscriptions",
      "organizations_url": "https://api.github.com/users/macfarla/orgs",
      "repos_url": "https://api.github.com/users/macfarla/repos",
      "events_url": "https://api.github.com/users/macfarla/events{/privacy}",
      "received_events_url": "https://api.github.com/users/macfarla/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-11-01T01:11:54Z",
    "updated_at": "2021-11-01T01:12:48Z",
    "author_association": "CONTRIBUTOR",
    "body": "https://github.com/hyperledger/besu/pull/2969\nfrom locally run tests:\nsuccessive calls to generateAndSendRawTx:\nwith my change: successful with 20ms sleep. fails with 10ms\nwithout my change, successful with 1500ms. fails with 100. fails with 1000\n\nthat's running PoW, ethash so blocktimes are < 1s",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/955839405/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
