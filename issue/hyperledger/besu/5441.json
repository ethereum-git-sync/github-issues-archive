{
  "url": "https://api.github.com/repos/hyperledger/besu/issues/5441",
  "repository_url": "https://api.github.com/repos/hyperledger/besu",
  "labels_url": "https://api.github.com/repos/hyperledger/besu/issues/5441/labels{/name}",
  "comments_url": "https://api.github.com/repos/hyperledger/besu/issues/5441/comments",
  "events_url": "https://api.github.com/repos/hyperledger/besu/issues/5441/events",
  "html_url": "https://github.com/hyperledger/besu/issues/5441",
  "id": 1698859739,
  "node_id": "I_kwDODE2jmc5lQorb",
  "number": 5441,
  "title": "AbstractBlockProcessor | failed persisting block",
  "user": {
    "login": "superlemon0",
    "id": 132726049,
    "node_id": "U_kgDOB-k9IQ",
    "avatar_url": "https://avatars.githubusercontent.com/u/132726049?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/superlemon0",
    "html_url": "https://github.com/superlemon0",
    "followers_url": "https://api.github.com/users/superlemon0/followers",
    "following_url": "https://api.github.com/users/superlemon0/following{/other_user}",
    "gists_url": "https://api.github.com/users/superlemon0/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/superlemon0/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/superlemon0/subscriptions",
    "organizations_url": "https://api.github.com/users/superlemon0/orgs",
    "repos_url": "https://api.github.com/users/superlemon0/repos",
    "events_url": "https://api.github.com/users/superlemon0/events{/privacy}",
    "received_events_url": "https://api.github.com/users/superlemon0/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1537362490,
      "node_id": "MDU6TGFiZWwxNTM3MzYyNDkw",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/bug",
      "name": "bug",
      "color": "d73a4a",
      "default": true,
      "description": "Something isn't working"
    },
    {
      "id": 1921587647,
      "node_id": "MDU6TGFiZWwxOTIxNTg3NjQ3",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/TeamGroot",
      "name": "TeamGroot",
      "color": "1d76db",
      "default": false,
      "description": "GH issues worked on by Groot Team"
    },
    {
      "id": 2051683573,
      "node_id": "MDU6TGFiZWwyMDUxNjgzNTcz",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/P3",
      "name": "P3",
      "color": "ffff00",
      "default": false,
      "description": "Medium (ex: JSON-RPC request not working with a specific client library due to loose spec assumtion)"
    },
    {
      "id": 4426494776,
      "node_id": "LA_kwDODE2jmc8AAAABB9bzOA",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/snack",
      "name": "snack",
      "color": "fef2c0",
      "default": false,
      "description": "Small coding task"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2023-05-07T02:37:46Z",
  "updated_at": "2023-05-12T03:57:17Z",
  "closed_at": "2023-05-12T03:57:17Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "<!-- Have you done the following? -->\r\n<!--   * read the Code of Conduct? By filing an Issue, you are expected to -->  \r\n<!--     comply with it, including treating everyone with respect: -->\r\n<!--     https://github.com/hyperledger/besu/blob/main/CODE_OF_CONDUCT.md -->\r\n<!--   * Reproduced the issue in the latest version of the software -->\r\n<!--   * Read the debugging docs: https://besu.hyperledger.org/en/stable/HowTo/Monitor/Logging/ -->\r\n<!--   * Duplicate Issue check:  https://github.com/search?q=+is%3Aissue+repo%3Ahyperledger/Besu -->\r\n<!-- Note:  Not all sections will apply to all issue types. -->\r\n\r\n### Description\r\n\r\nAs a staker, I want the execution client to run and recover from errors so that I can stake successfully.\r\n\r\n### Acceptance Criteria\r\n\r\n* Besu gracefully recovers from a storage error, or restarts when it encounters a fatal error\r\n\r\n### Steps to Reproduce (Bug)\r\n\r\nI have not been able to reproduce this issue. I reported it on the #besu-mainnet discord channel and @siladu suggested I file an issue.\r\n\r\n**Expected behavior:** [What you expect to happen]\r\n\r\nBesu recovers and continues to operate after an error.\r\n\r\n**Actual behavior:** [What actually happens]\r\n\r\nBesu continues to attempt the failed storage operation and never recovers. After a restart of Besu, operation returns to normal.\r\n\r\n**Frequency:** [What percentage of the time does it occur?]\r\n\r\nI have encountered this once on 5/6/23.\r\n\r\nEdit: It happened again on 5/7/23.\r\n\r\n### Logs (if a bug)\r\n\r\nThe following is the error message and stack trace that repeated for 15 minutes until I restarted Besu:\r\n\r\n```\r\nMay 05 20:58:28 whopper besu[435498]: 2023-05-05 20:58:28.359-04:00 | vert.x-worker-thread-0 | ERROR | AbstractBlockProcessor | failed persisting block\r\nMay 05 20:58:28 whopper besu[435498]: org.hyperledger.besu.plugin.services.exception.StorageException: org.rocksdb.RocksDBException: While fdatasync: /var/lib/besu/database/416929.sst: Input/output error\r\nMay 05 20:58:28 whopper besu[435498]:         at org.hyperledger.besu.plugin.services.storage.rocksdb.segmented.RocksDBColumnarKeyValueStorage$RocksDbTransaction.commit(RocksDBColumnarKeyValueStorage.java:391)\r\nMay 05 20:58:28 whopper besu[435498]:         at org.hyperledger.besu.services.kvstore.SegmentedKeyValueStorageTransactionTransitionValidatorDecorator.commit(SegmentedKeyValueStorageTransactionTransitionValidatorDecorator.java:59)\r\nMay 05 20:58:28 whopper besu[435498]:         at org.hyperledger.besu.services.kvstore.SegmentedKeyValueStorageAdapter$1.commit(SegmentedKeyValueStorageAdapter.java:114)\r\nMay 05 20:58:28 whopper besu[435498]:         at org.hyperledger.besu.ethereum.bonsai.storage.BonsaiWorldStateKeyValueStorage$Updater.commit(BonsaiWorldStateKeyValueStorage.java:482)\r\nMay 05 20:58:28 whopper besu[435498]:         at org.hyperledger.besu.ethereum.bonsai.worldview.BonsaiWorldState.persist(BonsaiWorldState.java:408)\r\nMay 05 20:58:28 whopper besu[435498]:         at org.hyperledger.besu.ethereum.mainnet.AbstractBlockProcessor.processBlock(AbstractBlockProcessor.java:181)\r\nMay 05 20:58:28 whopper besu[435498]:         at org.hyperledger.besu.ethereum.mainnet.BlockProcessor.processBlock(BlockProcessor.java:79)\r\nMay 05 20:58:28 whopper besu[435498]:         at org.hyperledger.besu.ethereum.MainnetBlockValidator.processBlock(MainnetBlockValidator.java:207)\r\nMay 05 20:58:28 whopper besu[435498]:         at org.hyperledger.besu.ethereum.MainnetBlockValidator.validateAndProcessBlock(MainnetBlockValidator.java:135)\r\nMay 05 20:58:28 whopper besu[435498]:         at org.hyperledger.besu.ethereum.MainnetBlockValidator.validateAndProcessBlock(MainnetBlockValidator.java:83)\r\nMay 05 20:58:28 whopper besu[435498]:         at org.hyperledger.besu.consensus.merge.blockcreation.MergeCoordinator.validateBlock(MergeCoordinator.java:516)\r\nMay 05 20:58:28 whopper besu[435498]:         at org.hyperledger.besu.consensus.merge.blockcreation.MergeCoordinator.rememberBlock(MergeCoordinator.java:546)\r\nMay 05 20:58:28 whopper besu[435498]:         at org.hyperledger.besu.consensus.merge.blockcreation.TransitionCoordinator.rememberBlock(TransitionCoordinator.java:157)\r\nMay 05 20:58:28 whopper besu[435498]:         at org.hyperledger.besu.ethereum.api.jsonrpc.internal.methods.engine.AbstractEngineNewPayload.syncResponse(AbstractEngineNewPayload.java:244)\r\nMay 05 20:58:28 whopper besu[435498]:         at org.hyperledger.besu.ethereum.api.jsonrpc.internal.methods.ExecutionEngineJsonRpcMethod.lambda$response$0(ExecutionEngineJsonRpcMethod.java:73)\r\nMay 05 20:58:28 whopper besu[435498]:         at io.vertx.core.impl.ContextBase.lambda$null$0(ContextBase.java:137)\r\nMay 05 20:58:28 whopper besu[435498]:         at io.vertx.core.impl.ContextInternal.dispatch(ContextInternal.java:264)\r\nMay 05 20:58:28 whopper besu[435498]:         at io.vertx.core.impl.ContextBase.lambda$executeBlocking$1(ContextBase.java:135)\r\nMay 05 20:58:28 whopper besu[435498]:         at io.vertx.core.impl.TaskQueue.run(TaskQueue.java:76)\r\nMay 05 20:58:28 whopper besu[435498]:         at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1136)\r\nMay 05 20:58:28 whopper besu[435498]:         at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:635)\r\nMay 05 20:58:28 whopper besu[435498]:         at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\r\nMay 05 20:58:28 whopper besu[435498]:         at java.base/java.lang.Thread.run(Thread.java:833)\r\nMay 05 20:58:28 whopper besu[435498]: Caused by: org.rocksdb.RocksDBException: While fdatasync: /var/lib/besu/database/416929.sst: Input/output error\r\nMay 05 20:58:28 whopper besu[435498]:         at org.rocksdb.Transaction.commit(Native Method)\r\nMay 05 20:58:28 whopper besu[435498]:         at org.rocksdb.Transaction.commit(Transaction.java:208)\r\nMay 05 20:58:28 whopper besu[435498]:         at org.hyperledger.besu.plugin.services.storage.rocksdb.segmented.RocksDBColumnarKeyValueStorage$RocksDbTransaction.commit(RocksDBColumnarKeyValueStorage.java:385)\r\nMay 05 20:58:28 whopper besu[435498]:         ... 22 more\r\nMay 05 20:58:28 whopper besu[435498]: 2023-05-05 20:58:28.363-04:00 | vert.x-worker-thread-0 | INFO  | MainnetBlockValidator | Invalid block 17198146 (0x198887087bec51add61a58d3d7f329b71b730a7a8402f50ff96e6e76227cb2f3): Optional[org.rocksdb.RocksDBException: While fdatasync: /var/lib/besu/database/416929.sst: Input/output error], caused by org.hyperledger.besu.plugin.services.exception.StorageException: org.rocksdb.RocksDBException: While fdatasync: /var/lib/besu/database/416929.sst: Input/output error\r\n```\r\n\r\nFull logs from Besu and Teku from the beginning of the day when the failure occurred:\r\n\r\n[besu.log](https://github.com/hyperledger/besu/files/11413771/besu.log)\r\n[teku.log](https://github.com/hyperledger/besu/files/11413772/teku.log)\r\n\r\n### Versions (Add all that apply)\r\n\r\n* Software version: `23.4.0`\r\n* Java version: \r\n```\r\nopenjdk version \"17.0.6\" 2023-01-17\r\nOpenJDK Runtime Environment (build 17.0.6+10-Ubuntu-0ubuntu122.04)\r\nOpenJDK 64-Bit Server VM (build 17.0.6+10-Ubuntu-0ubuntu122.04, mixed mode, sharing)\r\n```\r\n* OS Name & Version: `Ubuntu 22.04.2 LTS`\r\n* Kernel Version: `5.15.0-70-generic #77-Ubuntu SMP`\r\n* Consensus Client & Version if using Proof of Stake: `Teku 23.4.0`\r\n\r\n### Additional Information (Add any of the following or anything else that may be relevant)\r\n\r\n* Besu setup info\r\n```\r\nEnvironment=\"JAVA_OPTS=-Xmx8g\"\r\nExecStart=/usr/local/bin/besu/bin/besu \\\r\n  --network=mainnet \\\r\n  --sync-mode=X_SNAP \\\r\n  --data-path=/var/lib/besu \\\r\n  --data-storage-format=BONSAI \\\r\n  --engine-jwt-secret=/var/lib/jwtsecret/jwt.hex \\\r\n  --metrics-enabled=true \\\r\n  --rpc-http-enabled\r\n```\r\n* System info - AMD EPYC 3251 8-Core Processor, 64GB memory, 4TB SSD (2.6TB available)\r\n\r\nIt may be worth noting that I got another storage error in Teku about ~9 hours later, which caused Teku to shut itself down. After it started back up, it resumed operating normally.\r\n\r\n```\r\nFATAL - Exiting due to fatal error in RetryingStorageUpdateChannel tech.pegasys.teku.infrastructure.exceptions.FatalServiceFailureException: java.util.concurrent.CompletionException: org.iq80.leveldb.DBException: IO error: /var/lib/teku/beacon/db/3055058.ldb: Input/output error (See log file for full stack trace)\r\n```\r\n",
  "closed_by": {
    "login": "gfukushima",
    "id": 25556862,
    "node_id": "MDQ6VXNlcjI1NTU2ODYy",
    "avatar_url": "https://avatars.githubusercontent.com/u/25556862?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/gfukushima",
    "html_url": "https://github.com/gfukushima",
    "followers_url": "https://api.github.com/users/gfukushima/followers",
    "following_url": "https://api.github.com/users/gfukushima/following{/other_user}",
    "gists_url": "https://api.github.com/users/gfukushima/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/gfukushima/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/gfukushima/subscriptions",
    "organizations_url": "https://api.github.com/users/gfukushima/orgs",
    "repos_url": "https://api.github.com/users/gfukushima/repos",
    "events_url": "https://api.github.com/users/gfukushima/events{/privacy}",
    "received_events_url": "https://api.github.com/users/gfukushima/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/5441/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/hyperledger/besu/issues/5441/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1537588932",
    "html_url": "https://github.com/hyperledger/besu/issues/5441#issuecomment-1537588932",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/5441",
    "id": 1537588932,
    "node_id": "IC_kwDODE2jmc5bpb7E",
    "user": {
      "login": "siladu",
      "id": 2893793,
      "node_id": "MDQ6VXNlcjI4OTM3OTM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2893793?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/siladu",
      "html_url": "https://github.com/siladu",
      "followers_url": "https://api.github.com/users/siladu/followers",
      "following_url": "https://api.github.com/users/siladu/following{/other_user}",
      "gists_url": "https://api.github.com/users/siladu/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/siladu/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/siladu/subscriptions",
      "organizations_url": "https://api.github.com/users/siladu/orgs",
      "repos_url": "https://api.github.com/users/siladu/repos",
      "events_url": "https://api.github.com/users/siladu/events{/privacy}",
      "received_events_url": "https://api.github.com/users/siladu/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-08T00:40:31Z",
    "updated_at": "2023-05-08T00:40:31Z",
    "author_association": "CONTRIBUTOR",
    "body": "Thanks for the report. Root cause seems like a hardware issue, but I think that besu should be able to recover better from this.",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1537588932/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1545071008",
    "html_url": "https://github.com/hyperledger/besu/issues/5441#issuecomment-1545071008",
    "issue_url": "https://api.github.com/repos/hyperledger/besu/issues/5441",
    "id": 1545071008,
    "node_id": "IC_kwDODE2jmc5cF-mg",
    "user": {
      "login": "gfukushima",
      "id": 25556862,
      "node_id": "MDQ6VXNlcjI1NTU2ODYy",
      "avatar_url": "https://avatars.githubusercontent.com/u/25556862?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gfukushima",
      "html_url": "https://github.com/gfukushima",
      "followers_url": "https://api.github.com/users/gfukushima/followers",
      "following_url": "https://api.github.com/users/gfukushima/following{/other_user}",
      "gists_url": "https://api.github.com/users/gfukushima/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gfukushima/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gfukushima/subscriptions",
      "organizations_url": "https://api.github.com/users/gfukushima/orgs",
      "repos_url": "https://api.github.com/users/gfukushima/repos",
      "events_url": "https://api.github.com/users/gfukushima/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gfukushima/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-12T03:57:17Z",
    "updated_at": "2023-05-12T03:57:17Z",
    "author_association": "CONTRIBUTOR",
    "body": "Hi @superlemon0, we've done some analysis of the issue you've reported and based on all the logs you've provided we've come to the conclusion that the block validation failure you get is due to a faulty hardware which ends up affecting RocksDB, the database used by besu. At that stage there isn't much besu can't do rather that what we're already doing, which is retry. Looking at the RocksDb github it seems that there isn't much more they can do about it as well (https://github.com/facebook/rocksdb/issues/1403#issuecomment-254612859).\r\n ",
    "reactions": {
      "url": "https://api.github.com/repos/hyperledger/besu/issues/comments/1545071008/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
