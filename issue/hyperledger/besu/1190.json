{
  "url": "https://api.github.com/repos/hyperledger/besu/issues/1190",
  "repository_url": "https://api.github.com/repos/hyperledger/besu",
  "labels_url": "https://api.github.com/repos/hyperledger/besu/issues/1190/labels{/name}",
  "comments_url": "https://api.github.com/repos/hyperledger/besu/issues/1190/comments",
  "events_url": "https://api.github.com/repos/hyperledger/besu/issues/1190/events",
  "html_url": "https://github.com/hyperledger/besu/issues/1190",
  "id": 650250478,
  "node_id": "MDU6SXNzdWU2NTAyNTA0Nzg=",
  "number": 1190,
  "title": "K8S Permissioning to use of Service IP's rather than pod IP's which can fail",
  "user": {
    "login": "joshuafernandes",
    "id": 3722503,
    "node_id": "MDQ6VXNlcjM3MjI1MDM=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3722503?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/joshuafernandes",
    "html_url": "https://github.com/joshuafernandes",
    "followers_url": "https://api.github.com/users/joshuafernandes/followers",
    "following_url": "https://api.github.com/users/joshuafernandes/following{/other_user}",
    "gists_url": "https://api.github.com/users/joshuafernandes/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/joshuafernandes/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/joshuafernandes/subscriptions",
    "organizations_url": "https://api.github.com/users/joshuafernandes/orgs",
    "repos_url": "https://api.github.com/users/joshuafernandes/repos",
    "events_url": "https://api.github.com/users/joshuafernandes/events{/privacy}",
    "received_events_url": "https://api.github.com/users/joshuafernandes/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1537362490,
      "node_id": "MDU6TGFiZWwxNTM3MzYyNDkw",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/bug",
      "name": "bug",
      "color": "d73a4a",
      "default": true,
      "description": "Something isn't working"
    },
    {
      "id": 2051683248,
      "node_id": "MDU6TGFiZWwyMDUxNjgzMjQ4",
      "url": "https://api.github.com/repos/hyperledger/besu/labels/P2",
      "name": "P2",
      "color": "ff9900",
      "default": false,
      "description": "High (ex: Degrading performance issues, unexpected behavior of core features (DevP2P, syncing, etc))"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "timbeiko",
    "id": 9390255,
    "node_id": "MDQ6VXNlcjkzOTAyNTU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/9390255?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/timbeiko",
    "html_url": "https://github.com/timbeiko",
    "followers_url": "https://api.github.com/users/timbeiko/followers",
    "following_url": "https://api.github.com/users/timbeiko/following{/other_user}",
    "gists_url": "https://api.github.com/users/timbeiko/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/timbeiko/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/timbeiko/subscriptions",
    "organizations_url": "https://api.github.com/users/timbeiko/orgs",
    "repos_url": "https://api.github.com/users/timbeiko/repos",
    "events_url": "https://api.github.com/users/timbeiko/events{/privacy}",
    "received_events_url": "https://api.github.com/users/timbeiko/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "timbeiko",
      "id": 9390255,
      "node_id": "MDQ6VXNlcjkzOTAyNTU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9390255?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/timbeiko",
      "html_url": "https://github.com/timbeiko",
      "followers_url": "https://api.github.com/users/timbeiko/followers",
      "following_url": "https://api.github.com/users/timbeiko/following{/other_user}",
      "gists_url": "https://api.github.com/users/timbeiko/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/timbeiko/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/timbeiko/subscriptions",
      "organizations_url": "https://api.github.com/users/timbeiko/orgs",
      "repos_url": "https://api.github.com/users/timbeiko/repos",
      "events_url": "https://api.github.com/users/timbeiko/events{/privacy}",
      "received_events_url": "https://api.github.com/users/timbeiko/received_events",
      "type": "User",
      "site_admin": false
    },
    {
      "login": "matkt",
      "id": 26581503,
      "node_id": "MDQ6VXNlcjI2NTgxNTAz",
      "avatar_url": "https://avatars.githubusercontent.com/u/26581503?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/matkt",
      "html_url": "https://github.com/matkt",
      "followers_url": "https://api.github.com/users/matkt/followers",
      "following_url": "https://api.github.com/users/matkt/following{/other_user}",
      "gists_url": "https://api.github.com/users/matkt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/matkt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/matkt/subscriptions",
      "organizations_url": "https://api.github.com/users/matkt/orgs",
      "repos_url": "https://api.github.com/users/matkt/repos",
      "events_url": "https://api.github.com/users/matkt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/matkt/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 0,
  "created_at": "2020-07-02T23:18:36Z",
  "updated_at": "2020-08-26T08:37:21Z",
  "closed_at": "2020-08-26T08:37:21Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "### Description\r\nAs an Ops Engineer, I want to deploy Besu to K8S for consortium type networks and use permissioning to allow/disallow members\r\n\r\n### Acceptance Criteria\r\nPermissioning works on K8S with me using service IPs or equivalent, but not Pod IPs - pods can fail and restart with a new IP which then cannot participate because the IP is different\r\n\r\n### Steps to Reproduce (Bug)\r\n1. Use the new functionality in the Besu Nat-Manager\r\n2. Setup local permissioning (same behaviour with on chain permissioning as well, local is easier to edit and restart) Helm chart [here](https://github.com/joshuafernandes/besu-kubernetes/tree/permissioning-examples/helm/ibft2-with-permissioning/besu)\r\n3. Deploy to K8S\r\n\r\n**Expected behavior:** \r\nThat permissioning works: \r\n- for a start specifying just the enodes with public keys & validator service ips\r\n- that I can add a new node in (acceptable that a new node be deployed as a node + service)\r\n \r\n**Actual behavior:** \r\nNodes don't join and start the network and chain and the like - they check permissions and allow the services, but it appears that some of the socket connections use the pod IP which causes the whole thing to halt\r\n\r\n**Frequency:** \r\nAlways\r\n\r\n### Versions \r\n* Software version: `besu 1.5.1-SNAPSHOT`\r\n* Cloud VM, type, size: [Azure AKS so far that I've test this on, suspect this will be all]\r\n\r\n### Additional Information\r\n- Besu 1.5.1 commit 50db46f855980a48c1d3c115f52ab254a5d668c8 or later will work \r\n- Have been working with @matkt on this to put some examples and templates in place, he's done some really fantiastic work in building the nat manager out to allow for ClusterIp services too and automating that. The guts of it appears to be at the VertX level https://github.com/hyperledger/besu/blob/70ce1682916a61ea2695411e421cb135e4ed95e7/ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/discovery/VertxPeerDiscoveryAgent.java#L217 and believe this needs a ticket to get this looked at and fixed. In the very least something that allows for permissions on K8S that is more tolerant of failure at the pod level.\r\n\r\nSome log messages like the one below where comms should only be on 10.0.x.x (service ips) but enodes are reported coming from 10.244.x.z (pod ips). Initial config for the nodes had the p2p-host set as 10.0.x.x via the nat manager so it should respect that ?\r\n```2020-07-02 04:59:33.731+00:00 | vert.x-eventloop-thread-1 | TRACE | DiscoveryProtocolLogger | <<< Sending  NEIGH packet to peer 0x5fc1f8dc9f0c03087128e4bd724530e8 (enode://5fc1f8dc9f0c03087128e4bd724530e883d7de1a431269876dff9c95b8952f73c7e85ac7b49d85a2ad4950e967319482af435e07a0eab0a98d98449437787a00@10.244.1.38:30303): Packet{type=NEIGHBORS, data=NeighborsPacketData{peers=[DiscoveryPeer{status=bonded, enode=enode://5fc1f8dc9f0c03087128e4bd724530e883d7de1a431269876dff9c95b8952f73c7e85ac7b49d85a2ad4950e967319482af435e07a0eab0a98d98449437787a00@10.244.1.38:30303, firstDiscovered=1593665973436, lastContacted=1593665973518, lastSeen=1593665973526}, DiscoveryPeer{status=bonded, enode=enode://5d812c3c25ff398ab416968fce9009c2be7ed70a87abc8ea30bd667ce17a9287a6341fbf6ce757bb8148436c39c71296639ea81afcc94cdf908b6e1344f26188@10.0.179.209:30303, firstDiscovered=1593665966323, lastContacted=1593665971451, lastSeen=1593665967307}], expiration=1593666033}, hash=0xbcf0644e18e05d0b1ca03d50f634e1f51772522d29c68ad24268d84390688318, signature=SECP256K1.Signature{r=89146151500703781876909065874071324192052354470190482233597100072946940926983, s=52435911823807714770890529437538386980170334409869377928205490124983253432422, recId=1}, publicKey=0x00b20ab6a385a2403d64637b3d93cb6d83215a08f29adb6feb4b8bf03387b734444e8b060f53150dea4b9b897823540d19918c13d6f57a5153d190b5fad7bf51}```\r\n\r\nLog file from one validator attached:\r\n[logs-from-validator3-in-besu-validator3-0.tar.gz](https://github.com/hyperledger/besu/files/4867026/logs-from-validator3-in-besu-validator3-0.tar.gz)\r\n\r\nWe can also see some logs like that `Received PING  packet from peer 0xa77d23cab569301854728da8a3b4e0d5 (enode://a77d23cab569301854728da8a3b4e0d55e1df694d7302102a5228a16b4fc86bbdb198fd58550c533a6e2da5dea4f06dbac5e274498e49960f6effd53ad8a1dba@10.244.0.29:30303): Packet{type=PING, data=PingPacketData{from=Endpoint{host=‘10.0.6.71’, udpPort=30303, getTcpPort=30303}` . In this log there is the valid IP in the PingPacketData message but there is also an invalid IP added by Vertx. Besu is using the IP added by Vertx",
  "closed_by": {
    "login": "matkt",
    "id": 26581503,
    "node_id": "MDQ6VXNlcjI2NTgxNTAz",
    "avatar_url": "https://avatars.githubusercontent.com/u/26581503?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/matkt",
    "html_url": "https://github.com/matkt",
    "followers_url": "https://api.github.com/users/matkt/followers",
    "following_url": "https://api.github.com/users/matkt/following{/other_user}",
    "gists_url": "https://api.github.com/users/matkt/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/matkt/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/matkt/subscriptions",
    "organizations_url": "https://api.github.com/users/matkt/orgs",
    "repos_url": "https://api.github.com/users/matkt/repos",
    "events_url": "https://api.github.com/users/matkt/events{/privacy}",
    "received_events_url": "https://api.github.com/users/matkt/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/hyperledger/besu/issues/1190/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/hyperledger/besu/issues/1190/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[

]
