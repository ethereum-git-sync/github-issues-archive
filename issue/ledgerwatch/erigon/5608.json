{
  "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5608",
  "repository_url": "https://api.github.com/repos/ledgerwatch/erigon",
  "labels_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5608/labels{/name}",
  "comments_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5608/comments",
  "events_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5608/events",
  "html_url": "https://github.com/ledgerwatch/erigon/issues/5608",
  "id": 1395393373,
  "node_id": "I_kwDOC0FsAM5TLANd",
  "number": 5608,
  "title": "Websocket hang after error while notifying subscription",
  "user": {
    "login": "wojski",
    "id": 15378309,
    "node_id": "MDQ6VXNlcjE1Mzc4MzA5",
    "avatar_url": "https://avatars.githubusercontent.com/u/15378309?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/wojski",
    "html_url": "https://github.com/wojski",
    "followers_url": "https://api.github.com/users/wojski/followers",
    "following_url": "https://api.github.com/users/wojski/following{/other_user}",
    "gists_url": "https://api.github.com/users/wojski/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/wojski/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/wojski/subscriptions",
    "organizations_url": "https://api.github.com/users/wojski/orgs",
    "repos_url": "https://api.github.com/users/wojski/repos",
    "events_url": "https://api.github.com/users/wojski/events{/privacy}",
    "received_events_url": "https://api.github.com/users/wojski/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 4406003490,
      "node_id": "LA_kwDOC0FsAM8AAAABBp5HIg",
      "url": "https://api.github.com/repos/ledgerwatch/erigon/labels/gateway",
      "name": "gateway",
      "color": "62DB33",
      "default": false,
      "description": "Issue assigned to gateway team"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": {
    "login": "revitteth",
    "id": 693995,
    "node_id": "MDQ6VXNlcjY5Mzk5NQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/693995?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/revitteth",
    "html_url": "https://github.com/revitteth",
    "followers_url": "https://api.github.com/users/revitteth/followers",
    "following_url": "https://api.github.com/users/revitteth/following{/other_user}",
    "gists_url": "https://api.github.com/users/revitteth/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/revitteth/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/revitteth/subscriptions",
    "organizations_url": "https://api.github.com/users/revitteth/orgs",
    "repos_url": "https://api.github.com/users/revitteth/repos",
    "events_url": "https://api.github.com/users/revitteth/events{/privacy}",
    "received_events_url": "https://api.github.com/users/revitteth/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "revitteth",
      "id": 693995,
      "node_id": "MDQ6VXNlcjY5Mzk5NQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/693995?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/revitteth",
      "html_url": "https://github.com/revitteth",
      "followers_url": "https://api.github.com/users/revitteth/followers",
      "following_url": "https://api.github.com/users/revitteth/following{/other_user}",
      "gists_url": "https://api.github.com/users/revitteth/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/revitteth/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/revitteth/subscriptions",
      "organizations_url": "https://api.github.com/users/revitteth/orgs",
      "repos_url": "https://api.github.com/users/revitteth/repos",
      "events_url": "https://api.github.com/users/revitteth/events{/privacy}",
      "received_events_url": "https://api.github.com/users/revitteth/received_events",
      "type": "User",
      "site_admin": false
    },
    {
      "login": "nanevardanyan",
      "id": 22477943,
      "node_id": "MDQ6VXNlcjIyNDc3OTQz",
      "avatar_url": "https://avatars.githubusercontent.com/u/22477943?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nanevardanyan",
      "html_url": "https://github.com/nanevardanyan",
      "followers_url": "https://api.github.com/users/nanevardanyan/followers",
      "following_url": "https://api.github.com/users/nanevardanyan/following{/other_user}",
      "gists_url": "https://api.github.com/users/nanevardanyan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nanevardanyan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nanevardanyan/subscriptions",
      "organizations_url": "https://api.github.com/users/nanevardanyan/orgs",
      "repos_url": "https://api.github.com/users/nanevardanyan/repos",
      "events_url": "https://api.github.com/users/nanevardanyan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nanevardanyan/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 12,
  "created_at": "2022-10-03T22:07:29Z",
  "updated_at": "2023-04-03T23:23:02Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "#### System information\r\n\r\nErigon version: erigon/2022.09.3/linux-amd64/go1.19.1\r\n\r\nOS & Version:Linux \r\n\r\nCommit hash :  https://hub.docker.com/layers/thorax/erigon/v2022.09.03/images/sha256-a8d14345cf3b8f089e38b660508a11d9d7c7dd659d6906372aab187fbc8ee083?context=explore\r\n\r\n#### Expected behaviour\r\n\r\nWebsocket with message:\r\n\r\n`{\"jsonrpc\":\"2.0\",\"id\": 1, \"method\": \"eth_subscribe\", \"params\": [\"newHeads\"]}`\r\n\r\nShould return new blocks.\r\n\r\n#### Actual behaviour\r\n\r\nAfter some time no new messages came from WS.\r\n\r\nIn rpcDaemon I can find log:\r\n[WARN] [10-03|21:31:53.506] error while notifying subscription       err=\"write tcp 172.22.0.10:8545->**xxxxxxxx**:55508: write: connection timed out\"\r\n\r\nRPC endpoint working correctly.\r\nWS is no longer responsible (I can connect to it, but no messages received)\r\nIts working again after restart container.\r\n\r\nRPCNode:\r\n\r\n```\r\n  erigon:\r\n    image: thorax/erigon:v2022.09.03\r\n    container_name: erigon_eth\r\n    command: erigon --metrics  --metrics.addr=0.0.0.0 --private.api.addr=0.0.0.0:9090 --metrics.port=6060 --pprof --pprof.addr=0.0.0.0 --pprof.port=6061\r\n             --authrpc.jwtsecret=/home/lighthouse/jwtsecret.hex --authrpc.port=8551 --authrpc.addr=\"0.0.0.0\" --authrpc.vhosts=\"*\"\r\n             --override.terminaltotaldifficulty=0xc70d808a128d7380000 --db.read.concurrency=2000 --rpc.batch.concurrency=10000\r\n    volumes:\r\n      - /srv/crypto/erigon/eth/data:/home/erigon/.local/share/erigon\r\n      - /srv/crypto/erigon/eth/lighthouse:/home/lighthouse\r\n    ports:\r\n      - \"30303:30303/tcp\"\r\n      - \"30303:30303/udp\"\r\n      - \"30304:30304/tcp\"\r\n      - \"30304:30304/udp\"\r\n      - \"9091:9090\"\r\n    restart: unless-stopped \r\n```\r\nRPCDeamon:\r\n\r\n```\r\nrpcdaemon:\r\n    image: thorax/erigon:v2022.09.03\r\n    container_name: erigon_eth_rpcdaemon_1\r\n    command: rpcdaemon --datadir=/home/erigon/.local/share/erigon --private.api.addr=erigon:9090  --http.addr=0.0.0.0 --http.vhosts=* --http.corsdomain=* --verbosity=2 --rpc.batch.concurrency=8\r\n             --http.api=eth,debug,net,web3,trace --ws --db.read.concurrency=2000 --rpc.batch.concurrency=60000 --ws.compression=true\r\n    pid: service:erigon # Use erigon's PID namespace. It's required to open Erigon's DB from another process (RPCDaemon local-mode)\r\n    volumes:\r\n      - /srv/crypto/erigon/eth/data:/home/erigon/.local/share/erigon\r\n    ports:\r\n      - \"8550:8545\"\r\n    restart: unless-stopped\r\n```\r\n\r\n#### Steps to reproduce the behaviour\r\n\r\nUse WS for some time with:\r\n\r\n`{\"jsonrpc\":\"2.0\",\"id\": 1, \"method\": \"eth_subscribe\", \"params\": [\"newHeads\"]}`\r\n\r\n#### Backtrace\r\n\r\n````\r\n[WARN] [10-03|21:31:53.506] error while notifying subscription       err=\"write tcp 172.22.0.10:8545->**xxxxxxxx**:55508: write: connection timed out\"\r\n````\r\n\r\n(Same issue on 09.01)\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5608/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5608/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1278391378",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/5608#issuecomment-1278391378",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5608",
    "id": 1278391378,
    "node_id": "IC_kwDOC0FsAM5MMrRS",
    "user": {
      "login": "0x-3FFF",
      "id": 106940772,
      "node_id": "U_kgDOBl_JZA",
      "avatar_url": "https://avatars.githubusercontent.com/u/106940772?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/0x-3FFF",
      "html_url": "https://github.com/0x-3FFF",
      "followers_url": "https://api.github.com/users/0x-3FFF/followers",
      "following_url": "https://api.github.com/users/0x-3FFF/following{/other_user}",
      "gists_url": "https://api.github.com/users/0x-3FFF/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/0x-3FFF/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/0x-3FFF/subscriptions",
      "organizations_url": "https://api.github.com/users/0x-3FFF/orgs",
      "repos_url": "https://api.github.com/users/0x-3FFF/repos",
      "events_url": "https://api.github.com/users/0x-3FFF/events{/privacy}",
      "received_events_url": "https://api.github.com/users/0x-3FFF/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-10-14T02:33:14Z",
    "updated_at": "2022-10-14T02:33:14Z",
    "author_association": "CONTRIBUTOR",
    "body": "problem should be solved by PR #5734 ",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1278391378/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1306581306",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/5608#issuecomment-1306581306",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5608",
    "id": 1306581306,
    "node_id": "IC_kwDOC0FsAM5N4Nk6",
    "user": {
      "login": "sdecker747",
      "id": 3410323,
      "node_id": "MDQ6VXNlcjM0MTAzMjM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3410323?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sdecker747",
      "html_url": "https://github.com/sdecker747",
      "followers_url": "https://api.github.com/users/sdecker747/followers",
      "following_url": "https://api.github.com/users/sdecker747/following{/other_user}",
      "gists_url": "https://api.github.com/users/sdecker747/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sdecker747/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sdecker747/subscriptions",
      "organizations_url": "https://api.github.com/users/sdecker747/orgs",
      "repos_url": "https://api.github.com/users/sdecker747/repos",
      "events_url": "https://api.github.com/users/sdecker747/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sdecker747/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-11-08T03:34:11Z",
    "updated_at": "2022-11-08T03:34:11Z",
    "author_association": "NONE",
    "body": "I believe I am still experiencing a similar issue still on 2.29.0-stable-011a54a2.\r\n\r\nAfter a little while, I am no longer able to get new blocks or new pending blocks via websocket subscription and have the message \"error while notifying subscription\" in my rpc daemon log.\r\n\r\nI've noticed it seems to specifically happen when I am requesting txpool_contents.",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1306581306/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1339728205",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/5608#issuecomment-1339728205",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5608",
    "id": 1339728205,
    "node_id": "IC_kwDOC0FsAM5P2qFN",
    "user": {
      "login": "adrianchiforwm",
      "id": 110109409,
      "node_id": "U_kgDOBpAi4Q",
      "avatar_url": "https://avatars.githubusercontent.com/u/110109409?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/adrianchiforwm",
      "html_url": "https://github.com/adrianchiforwm",
      "followers_url": "https://api.github.com/users/adrianchiforwm/followers",
      "following_url": "https://api.github.com/users/adrianchiforwm/following{/other_user}",
      "gists_url": "https://api.github.com/users/adrianchiforwm/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/adrianchiforwm/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/adrianchiforwm/subscriptions",
      "organizations_url": "https://api.github.com/users/adrianchiforwm/orgs",
      "repos_url": "https://api.github.com/users/adrianchiforwm/repos",
      "events_url": "https://api.github.com/users/adrianchiforwm/events{/privacy}",
      "received_events_url": "https://api.github.com/users/adrianchiforwm/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-06T17:30:06Z",
    "updated_at": "2022-12-06T17:30:06Z",
    "author_association": "NONE",
    "body": "We're still seeing this in 2.30.0",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1339728205/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1345585364",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/5608#issuecomment-1345585364",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5608",
    "id": 1345585364,
    "node_id": "IC_kwDOC0FsAM5QNADU",
    "user": {
      "login": "Hex-Capital",
      "id": 31974540,
      "node_id": "MDQ6VXNlcjMxOTc0NTQw",
      "avatar_url": "https://avatars.githubusercontent.com/u/31974540?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Hex-Capital",
      "html_url": "https://github.com/Hex-Capital",
      "followers_url": "https://api.github.com/users/Hex-Capital/followers",
      "following_url": "https://api.github.com/users/Hex-Capital/following{/other_user}",
      "gists_url": "https://api.github.com/users/Hex-Capital/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Hex-Capital/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Hex-Capital/subscriptions",
      "organizations_url": "https://api.github.com/users/Hex-Capital/orgs",
      "repos_url": "https://api.github.com/users/Hex-Capital/repos",
      "events_url": "https://api.github.com/users/Hex-Capital/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Hex-Capital/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-11T15:37:07Z",
    "updated_at": "2022-12-11T15:37:07Z",
    "author_association": "NONE",
    "body": "I am still seeing this error as well",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1345585364/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1360853556",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/5608#issuecomment-1360853556",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5608",
    "id": 1360853556,
    "node_id": "IC_kwDOC0FsAM5RHPo0",
    "user": {
      "login": "WyseNynja",
      "id": 624221,
      "node_id": "MDQ6VXNlcjYyNDIyMQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/624221?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/WyseNynja",
      "html_url": "https://github.com/WyseNynja",
      "followers_url": "https://api.github.com/users/WyseNynja/followers",
      "following_url": "https://api.github.com/users/WyseNynja/following{/other_user}",
      "gists_url": "https://api.github.com/users/WyseNynja/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/WyseNynja/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/WyseNynja/subscriptions",
      "organizations_url": "https://api.github.com/users/WyseNynja/orgs",
      "repos_url": "https://api.github.com/users/WyseNynja/repos",
      "events_url": "https://api.github.com/users/WyseNynja/events{/privacy}",
      "received_events_url": "https://api.github.com/users/WyseNynja/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-21T04:47:03Z",
    "updated_at": "2022-12-21T04:50:11Z",
    "author_association": "CONTRIBUTOR",
    "body": "Weird. I've been subscribing to new heads without issue after https://github.com/ledgerwatch/erigon/pull/5734 (reported in https://github.com/ledgerwatch/erigon/issues/5577) and merged into v2.28.1.\r\n\r\n(I'm currently running v2.32.0)",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1360853556/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1362467657",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/5608#issuecomment-1362467657",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5608",
    "id": 1362467657,
    "node_id": "IC_kwDOC0FsAM5RNZtJ",
    "user": {
      "login": "elee1766",
      "id": 2260857,
      "node_id": "MDQ6VXNlcjIyNjA4NTc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2260857?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/elee1766",
      "html_url": "https://github.com/elee1766",
      "followers_url": "https://api.github.com/users/elee1766/followers",
      "following_url": "https://api.github.com/users/elee1766/following{/other_user}",
      "gists_url": "https://api.github.com/users/elee1766/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/elee1766/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/elee1766/subscriptions",
      "organizations_url": "https://api.github.com/users/elee1766/orgs",
      "repos_url": "https://api.github.com/users/elee1766/repos",
      "events_url": "https://api.github.com/users/elee1766/events{/privacy}",
      "received_events_url": "https://api.github.com/users/elee1766/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-22T06:27:50Z",
    "updated_at": "2022-12-22T06:42:17Z",
    "author_association": "COLLABORATOR",
    "body": "it would be useful to get the pprof goroutine trace if possible when this happens to your node. \r\n\r\n `--prof --pprof.port=6060 --pprof.addr=0.0.0.0` and then go to http://node-ip:6060/debug/pprof and download the \"full goroutine stack dump\" \r\n  \r\n also if possible - run the rpcdaemon separately so there is less noise in the file.\r\n \r\nkoray's node seem to have locked here: https://github.com/ledgerwatch/erigon/blob/devel/turbo/rpchelper/filters.go#L526 \r\n```\r\ngoroutine 82 [chan send, 29 minutes]:\r\ngithub.com/ledgerwatch/erigon/turbo/rpchelper.(*Filters).OnNewEvent(0xc08c45c680, 0xc00007e120?)\r\n\tgithub.com/ledgerwatch/erigon/turbo/rpchelper/filters.go:526 +0x32b\r\ngithub.com/ledgerwatch/erigon/cmd/rpcdaemon/rpcservices.(*RemoteBackend).Subscribe(0xc08c443310, {0x1e22b68, 0xc0013c5a00}, 0xc025a56c00)\r\n\tgithub.com/ledgerwatch/erigon/cmd/rpcdaemon/rpcservices/eth_backend.go:141 +0x1d5\r\ngithub.com/ledgerwatch/erigon/turbo/rpchelper.New.func1()\r\n\tgithub.com/ledgerwatch/erigon/turbo/rpchelper/filters.go:84 +0xe5\r\ncreated by github.com/ledgerwatch/erigon/turbo/rpchelper.New\r\n\tgithub.com/ledgerwatch/erigon/turbo/rpchelper/filters.go:73 +0x33f\r\n```\r\n\r\nsince OnNewEvent seems to read lock mutex, stopping new subscribers from being added.\r\n\r\n\r\nit could be multiple issues that cause same issue - the filters mutex goes into deadlock, perhaps it is partially fixed, but still other cases where it is not?\r\n\r\n https://github.com/ledgerwatch/erigon/blob/devel/turbo/rpchelper/filters.go#L396\r\n \r\n it seems to also be stuck here, so this is with the patch\r\n \r\n```\r\ngoroutine 29199 [semacquire, 18 minutes]:\r\nsync.runtime_SemacquireMutex(0x42a8a5?, 0x60?, 0x0?)\r\n\truntime/sema.go:71 +0x25\r\nsync.(*RWMutex).Lock(0x1557540?)\r\n\tsync/rwmutex.go:144 +0x71\r\ngithub.com/ledgerwatch/erigon/turbo/rpchelper.(*Filters).UnsubscribePendingTxs(0xc08c45c680, {0xc084710ec0, 0x40})\r\n\tgithub.com/ledgerwatch/erigon/turbo/rpchelper/filters.go:396 +0xe6\r\ngithub.com/ledgerwatch/erigon/cmd/rpcdaemon/commands.(*APIImpl).NewPendingTransactions.func1()\r\n\tgithub.com/ledgerwatch/erigon/cmd/rpcdaemon/commands/eth_filters.go:188 +0x378\r\ncreated by github.com/ledgerwatch/erigon/cmd/rpcdaemon/commands.(*APIImpl).NewPendingTransactions\r\n\tgithub.com/ledgerwatch/erigon/cmd/rpcdaemon/commands/eth_filters.go:174 +0xdc\r\n```\r\n\r\nthere must be another deadlock condition not being caught.\r\n ",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1362467657/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1363496258",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/5608#issuecomment-1363496258",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5608",
    "id": 1363496258,
    "node_id": "IC_kwDOC0FsAM5RRU1C",
    "user": {
      "login": "elee1766",
      "id": 2260857,
      "node_id": "MDQ6VXNlcjIyNjA4NTc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2260857?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/elee1766",
      "html_url": "https://github.com/elee1766",
      "followers_url": "https://api.github.com/users/elee1766/followers",
      "following_url": "https://api.github.com/users/elee1766/following{/other_user}",
      "gists_url": "https://api.github.com/users/elee1766/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/elee1766/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/elee1766/subscriptions",
      "organizations_url": "https://api.github.com/users/elee1766/orgs",
      "repos_url": "https://api.github.com/users/elee1766/repos",
      "events_url": "https://api.github.com/users/elee1766/events{/privacy}",
      "received_events_url": "https://api.github.com/users/elee1766/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-23T01:26:23Z",
    "updated_at": "2022-12-23T01:26:35Z",
    "author_association": "COLLABORATOR",
    "body": "update: \r\n\r\n```\r\ngoroutine 44 [chan send, 97 minutes]:\r\ngithub.com/ledgerwatch/erigon/turbo/rpchelper.(*Filters).OnNewTx(0xc063ebba00, 0xc07d3cb000)\r\n\tgithub.com/ledgerwatch/erigon/turbo/rpchelper/filters.go:580 +0x171\r\ngithub.com/ledgerwatch/erigon/turbo/rpchelper.(*Filters).subscribeToPendingTransactions(0xc000df7a00?, {0x1e22b68, 0xc000df7a00}, {0x1e2ba80, 0xc05e435df0})\r\n\tgithub.com/ledgerwatch/erigon/turbo/rpchelper/filters.go:216 +0x125\r\ngithub.com/ledgerwatch/erigon/turbo/rpchelper.New.func3()\r\n\tgithub.com/ledgerwatch/erigon/turbo/rpchelper/filters.go:132 +0x95\r\ncreated by github.com/ledgerwatch/erigon/turbo/rpchelper.New\r\n\tgithub.com/ledgerwatch/erigon/turbo/rpchelper/filters.go:125 +0x48a\r\n```\r\n\r\nanother one, same issue this time on the other filter. seems something is wrong with this logic for sending to all the subs.",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1363496258/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1379882622",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/5608#issuecomment-1379882622",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5608",
    "id": 1379882622,
    "node_id": "IC_kwDOC0FsAM5SP1Z-",
    "user": {
      "login": "0x-3FFF",
      "id": 106940772,
      "node_id": "U_kgDOBl_JZA",
      "avatar_url": "https://avatars.githubusercontent.com/u/106940772?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/0x-3FFF",
      "html_url": "https://github.com/0x-3FFF",
      "followers_url": "https://api.github.com/users/0x-3FFF/followers",
      "following_url": "https://api.github.com/users/0x-3FFF/following{/other_user}",
      "gists_url": "https://api.github.com/users/0x-3FFF/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/0x-3FFF/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/0x-3FFF/subscriptions",
      "organizations_url": "https://api.github.com/users/0x-3FFF/orgs",
      "repos_url": "https://api.github.com/users/0x-3FFF/repos",
      "events_url": "https://api.github.com/users/0x-3FFF/events{/privacy}",
      "received_events_url": "https://api.github.com/users/0x-3FFF/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-01-12T06:45:36Z",
    "updated_at": "2023-01-12T06:46:19Z",
    "author_association": "CONTRIBUTOR",
    "body": "Thanks for the advises from @elee1766 , i would keep tracking this issue in the future",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1379882622/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1384201390",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/5608#issuecomment-1384201390",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5608",
    "id": 1384201390,
    "node_id": "IC_kwDOC0FsAM5SgTyu",
    "user": {
      "login": "koraykoska",
      "id": 11356621,
      "node_id": "MDQ6VXNlcjExMzU2NjIx",
      "avatar_url": "https://avatars.githubusercontent.com/u/11356621?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/koraykoska",
      "html_url": "https://github.com/koraykoska",
      "followers_url": "https://api.github.com/users/koraykoska/followers",
      "following_url": "https://api.github.com/users/koraykoska/following{/other_user}",
      "gists_url": "https://api.github.com/users/koraykoska/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/koraykoska/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/koraykoska/subscriptions",
      "organizations_url": "https://api.github.com/users/koraykoska/orgs",
      "repos_url": "https://api.github.com/users/koraykoska/repos",
      "events_url": "https://api.github.com/users/koraykoska/events{/privacy}",
      "received_events_url": "https://api.github.com/users/koraykoska/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-01-16T15:16:47Z",
    "updated_at": "2023-01-16T15:16:47Z",
    "author_association": "NONE",
    "body": "Isn't this already fixed? I am not experiencing it any more.",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1384201390/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1384481686",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/5608#issuecomment-1384481686",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5608",
    "id": 1384481686,
    "node_id": "IC_kwDOC0FsAM5ShYOW",
    "user": {
      "login": "WyseNynja",
      "id": 624221,
      "node_id": "MDQ6VXNlcjYyNDIyMQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/624221?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/WyseNynja",
      "html_url": "https://github.com/WyseNynja",
      "followers_url": "https://api.github.com/users/WyseNynja/followers",
      "following_url": "https://api.github.com/users/WyseNynja/following{/other_user}",
      "gists_url": "https://api.github.com/users/WyseNynja/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/WyseNynja/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/WyseNynja/subscriptions",
      "organizations_url": "https://api.github.com/users/WyseNynja/orgs",
      "repos_url": "https://api.github.com/users/WyseNynja/repos",
      "events_url": "https://api.github.com/users/WyseNynja/events{/privacy}",
      "received_events_url": "https://api.github.com/users/WyseNynja/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-01-16T19:45:56Z",
    "updated_at": "2023-01-16T19:45:56Z",
    "author_association": "CONTRIBUTOR",
    "body": "One of the causes is fixed. But there appears to be at least one additional cause. I experienced the deadlock on some polygon nodes. They are running the maticnetwork fork, but that fork has this PR in it. Is there some command I should run if I see the deadlock happen again?On Jan 16, 2023, at 7:17 AM, Koray Koska ***@***.***> wrote:﻿\nIsn't this already fixed? I am not experiencing it any more.\n\n—Reply to this email directly, view it on GitHub, or unsubscribe.You are receiving this because you commented.Message ID: ***@***.***>",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1384481686/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1494201440",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/5608#issuecomment-1494201440",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5608",
    "id": 1494201440,
    "node_id": "IC_kwDOC0FsAM5ZD7Rg",
    "user": {
      "login": "koraykoska",
      "id": 11356621,
      "node_id": "MDQ6VXNlcjExMzU2NjIx",
      "avatar_url": "https://avatars.githubusercontent.com/u/11356621?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/koraykoska",
      "html_url": "https://github.com/koraykoska",
      "followers_url": "https://api.github.com/users/koraykoska/followers",
      "following_url": "https://api.github.com/users/koraykoska/following{/other_user}",
      "gists_url": "https://api.github.com/users/koraykoska/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/koraykoska/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/koraykoska/subscriptions",
      "organizations_url": "https://api.github.com/users/koraykoska/orgs",
      "repos_url": "https://api.github.com/users/koraykoska/repos",
      "events_url": "https://api.github.com/users/koraykoska/events{/privacy}",
      "received_events_url": "https://api.github.com/users/koraykoska/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-03T12:06:21Z",
    "updated_at": "2023-04-03T12:06:21Z",
    "author_association": "NONE",
    "body": "Why is this issue still open? That's worrying",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1494201440/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1495115395",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/5608#issuecomment-1495115395",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5608",
    "id": 1495115395,
    "node_id": "IC_kwDOC0FsAM5ZHaaD",
    "user": {
      "login": "elee1766",
      "id": 2260857,
      "node_id": "MDQ6VXNlcjIyNjA4NTc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2260857?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/elee1766",
      "html_url": "https://github.com/elee1766",
      "followers_url": "https://api.github.com/users/elee1766/followers",
      "following_url": "https://api.github.com/users/elee1766/following{/other_user}",
      "gists_url": "https://api.github.com/users/elee1766/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/elee1766/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/elee1766/subscriptions",
      "organizations_url": "https://api.github.com/users/elee1766/orgs",
      "repos_url": "https://api.github.com/users/elee1766/repos",
      "events_url": "https://api.github.com/users/elee1766/events{/privacy}",
      "received_events_url": "https://api.github.com/users/elee1766/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-03T23:23:01Z",
    "updated_at": "2023-04-03T23:23:01Z",
    "author_association": "COLLABORATOR",
    "body": "> Why is this issue still open? That's worrying\r\n\r\nso i fixed one cause by redoing the subscriptino engine, but it seems there is still something else ?\r\n\r\n@WyseNynja is it still happening? if so, yes. if you run your node with pprof the debug endpoint, <erigon>/debug/pprof/goroutine?debug=1 is super useful",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1495115395/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
