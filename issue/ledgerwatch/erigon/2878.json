{
  "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/2878",
  "repository_url": "https://api.github.com/repos/ledgerwatch/erigon",
  "labels_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/2878/labels{/name}",
  "comments_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/2878/comments",
  "events_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/2878/events",
  "html_url": "https://github.com/ledgerwatch/erigon/issues/2878",
  "id": 1037771603,
  "node_id": "I_kwDOC0FsAM492yNT",
  "number": 2878,
  "title": "Killed by OOM killer, now crashes on loading database, phtread_mutex_lock_full",
  "user": {
    "login": "Tronic",
    "id": 98187,
    "node_id": "MDQ6VXNlcjk4MTg3",
    "avatar_url": "https://avatars.githubusercontent.com/u/98187?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Tronic",
    "html_url": "https://github.com/Tronic",
    "followers_url": "https://api.github.com/users/Tronic/followers",
    "following_url": "https://api.github.com/users/Tronic/following{/other_user}",
    "gists_url": "https://api.github.com/users/Tronic/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Tronic/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Tronic/subscriptions",
    "organizations_url": "https://api.github.com/users/Tronic/orgs",
    "repos_url": "https://api.github.com/users/Tronic/repos",
    "events_url": "https://api.github.com/users/Tronic/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Tronic/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2021-10-27T19:10:26Z",
  "updated_at": "2021-10-27T22:18:48Z",
  "closed_at": "2021-10-27T22:18:48Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "I had this build running for three weeks without issues, but then got an OOM crash (the system has 32 GB RAM, most of it free for Erigon), and now the daemon crashes immediately on startup.\r\n\r\n#### Backtrace\r\n\r\n````\r\n[INFO] [10-27|17:14:30.173] [txpool] stat                            block=13500120 pending=4098 baseFee=10 queued=1024 alloc_mb=742 sys_mb=1619\r\n[INFO] [10-27|17:14:33.363] [16/18 TxLookup] ETL [2/2] Loading       into=BlockTransactionLookup current key=f3a8555a... alloc=\"805.2 MiB\" sys=\"1.6 GiB\"\r\n[INFO] [10-27|17:14:43.962] [16/18 TxLookup] DONE                    in=5m10.671075131s\r\n[203142.399381] Out of memory: Killed process 41361 (erigon) total-vm:4309120364kB, anon-rss:10932468kB, file-rss:12388kB, shmem-rss:0kB, UID:960 pgtables:1024636kB oom_score_adj:0\r\nOct 27 17:15:05 systemd[1]: erigon.service: A process of this unit has been killed by the OOM killer.\r\nOct 27 17:15:06 systemd[1]: erigon.service: Main process exited, code=killed, status=9/KILL\r\nOct 27 17:15:06 systemd[1]: Started Erigon Ethereum Full Node.\r\n[INFO] [10-27|17:15:06.996] Build info                               git_branch=HEAD git_tag=v2021.10.01-otterscan git_commit=0278b5063ccc53379ea9ff6c8f6b65bdb16>\r\n[INFO] [10-27|17:15:06.996] Starting Erigon on Ethereum mainnet...\r\n[INFO] [10-27|17:15:06.997] Maximum peer count                       ETH=100 total=100\r\n[INFO] [10-27|17:15:06.997] Set global gas cap                       cap=50000000\r\n[INFO] [10-27|17:15:07.024] Opening Database                         label=chaindata path=/srv/erigon/chaindata\r\nerigon: ../nptl/pthread_mutex_lock.c:424: __pthread_mutex_lock_full: Assertion `e != ESRCH || !robust' failed.\r\nSIGABRT: abort\r\nPC=0x7fe8b5d53d22 m=4 sigcode=18446744073709551610\r\ngoroutine 0 [idle]:\r\nruntime: unknown pc 0x7fe8b5d53d22\r\ngoroutine 1 [syscall]:\r\nruntime.cgocall(0x1044c40, 0xc000595ee0)\r\n        runtime/cgocall.go:156 +0x5c fp=0xc000595eb8 sp=0xc000595e80 pc=0x44927c\r\ngithub.com/torquem-ch/mdbx-go/mdbx._Cfunc_mdbx_env_set_option(0x7fe878000e00, 0x8, 0x4000)\r\n        _cgo_gotypes.go:763 +0x4c fp=0xc000595ee0 sp=0xc000595eb8 pc=0x8e0c4c\r\ngithub.com/torquem-ch/mdbx-go/mdbx.(*Env).SetOption.func1(0xc000595f48, 0x8, 0x0)\r\n        github.com/torquem-ch/mdbx-go@v0.19.2/mdbx/env.go:461 +0x5f fp=0xc000595f20 sp=0xc000595ee0 pc=0x8e6d5f\r\ngithub.com/torquem-ch/mdbx-go/mdbx.(*Env).SetOption(0xc00032e270, 0xc00032e270, 0xc000000001)\r\n        github.com/torquem-ch/mdbx-go@v0.19.2/mdbx/env.go:461 +0x1d fp=0xc000595f58 sp=0xc000595f20 pc=0x8e6bdd\r\ngithub.com/ledgerwatch/erigon-lib/kv/mdbx.MdbxOpts.Open({0x1cf29b0, {0xc00032e270, 0x15}, 0x0, 0x0, 0x2, 0x20000000000, 0x2800000, {0x1e89e70, 0xc00029e120}, ...>\r\n        github.com/ledgerwatch/erigon-lib@v0.0.0-20210930024651-a59261cb3242/kv/mdbx/kv_mdbx.go:204 +0x4ec fp=0xc000596180 sp=0xc000595f58 pc=0x8ecbcc\r\ngithub.com/ledgerwatch/erigon/node.OpenDatabase.func1(0x60)\r\n        github.com/ledgerwatch/erigon/node/node.go:531 +0x2a9 fp=0xc000596340 sp=0xc000596180 pc=0xcdcda9\r\ngithub.com/ledgerwatch/erigon/node.OpenDatabase(0xc00002db00, {0x1e89e70, 0xc00029e120}, 0x0)\r\n        github.com/ledgerwatch/erigon/node/node.go:534 +0x331 fp=0xc0005964f0 sp=0xc000596340 pc=0xcdc731\r\ngithub.com/ledgerwatch/erigon/eth.New(0xc00013c210, 0x271fae0, {0x1e89e70, 0xc00029e120})\r\n        github.com/ledgerwatch/erigon/eth/backend.go:150 +0x486 fp=0xc000597ad8 sp=0xc0005964f0 pc=0x102c186\r\ngithub.com/ledgerwatch/erigon/turbo/node.RegisterEthService(...)\r\n        github.com/ledgerwatch/erigon/turbo/node/node.go:107\r\ngithub.com/ledgerwatch/erigon/turbo/node.New(0x1e65280, 0x13fbae7, {0x1e89e70, 0xc00029e120})\r\n        github.com/ledgerwatch/erigon/turbo/node/node.go:98 +0x46 fp=0xc000597b20 sp=0xc000597ad8 pc=0x1033b86\r\nmain.runErigon(0xc0000e2160)\r\n        github.com/ledgerwatch/erigon/cmd/erigon/main.go:31 +0x1e5 fp=0xc000597bd0 sp=0xc000597b20 pc=0x1033fa5\r\ngithub.com/urfave/cli.HandleAction({0x11faa80, 0x1cf4e68}, 0xc00012e540)\r\n        github.com/urfave/cli@v1.22.5/app.go:526 +0x50 fp=0xc000597be8 sp=0xc000597bd0 pc=0x74d250\r\ngithub.com/urfave/cli.(*App).Run(0xc00012e540, {0xc00003c0a0, 0x5, 0x5})\r\n        github.com/urfave/cli@v1.22.5/app.go:286 +0x625 fp=0xc000597f28 sp=0xc000597be8 pc=0x74b385\r\nmain.main()\r\n        github.com/ledgerwatch/erigon/cmd/erigon/main.go:18 +0x75 fp=0xc000597f80 sp=0xc000597f28 pc=0x1033d35\r\nruntime.main()\r\n        runtime/proc.go:255 +0x227 fp=0xc000597fe0 sp=0xc000597f80 pc=0x47de07\r\nruntime.goexit()\r\n        runtime/asm_amd64.s:1581 +0x1 fp=0xc000597fe8 sp=0xc000597fe0 pc=0x4af0a1\r\ngoroutine 6 [sleep]:\r\ntime.Sleep(0x22ecb25c00)\r\n        runtime/time.go:193 +0x12e\r\ngithub.com/VictoriaMetrics/metrics.summariesSwapCron(0x45d964b800)\r\n        github.com/VictoriaMetrics/metrics@v1.18.0/summary.go:237 +0x36\r\ncreated by github.com/VictoriaMetrics/metrics.registerSummaryLocked\r\n        github.com/VictoriaMetrics/metrics@v1.18.0/summary.go:211 +0x127\r\ngoroutine 8 [sleep]:\r\ntime.Sleep(0x2614e70)\r\n        runtime/time.go:193 +0x12e\r\ngithub.com/anacrolix/stm/rate.(*Limiter).tokenGenerator(0xc00030c840, 0x2625a00)\r\n        github.com/anacrolix/stm@v0.2.1-0.20201002073511-c35a2c748c6a/rate/ratelimit.go:53 +0x90\r\ncreated by github.com/anacrolix/stm/rate.NewLimiter\r\n        github.com/anacrolix/stm@v0.2.1-0.20201002073511-c35a2c748c6a/rate/ratelimit.go:45 +0x229\r\ngoroutine 9 [chan receive]:\r\ngithub.com/anacrolix/dht/v2.dnsResolverRefresher()\r\n        github.com/anacrolix/dht/v2@v2.8.0/dht.go:103 +0x70\r\ncreated by github.com/anacrolix/dht/v2.init.0\r\n        github.com/anacrolix/dht/v2@v2.8.0/dht.go:109 +0x25\r\nOct 27 17:15:07 systemd[1]: erigon.service: Main process exited, code=exited, status=2/INVALIDARGUMENT\r\n````\r\n",
  "closed_by": {
    "login": "Tronic",
    "id": 98187,
    "node_id": "MDQ6VXNlcjk4MTg3",
    "avatar_url": "https://avatars.githubusercontent.com/u/98187?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Tronic",
    "html_url": "https://github.com/Tronic",
    "followers_url": "https://api.github.com/users/Tronic/followers",
    "following_url": "https://api.github.com/users/Tronic/following{/other_user}",
    "gists_url": "https://api.github.com/users/Tronic/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Tronic/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Tronic/subscriptions",
    "organizations_url": "https://api.github.com/users/Tronic/orgs",
    "repos_url": "https://api.github.com/users/Tronic/repos",
    "events_url": "https://api.github.com/users/Tronic/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Tronic/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/2878/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/2878/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/953352785",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/2878#issuecomment-953352785",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/2878",
    "id": 953352785,
    "node_id": "IC_kwDOC0FsAM440wJR",
    "user": {
      "login": "Tronic",
      "id": 98187,
      "node_id": "MDQ6VXNlcjk4MTg3",
      "avatar_url": "https://avatars.githubusercontent.com/u/98187?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Tronic",
      "html_url": "https://github.com/Tronic",
      "followers_url": "https://api.github.com/users/Tronic/followers",
      "following_url": "https://api.github.com/users/Tronic/following{/other_user}",
      "gists_url": "https://api.github.com/users/Tronic/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Tronic/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Tronic/subscriptions",
      "organizations_url": "https://api.github.com/users/Tronic/orgs",
      "repos_url": "https://api.github.com/users/Tronic/repos",
      "events_url": "https://api.github.com/users/Tronic/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Tronic/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-10-27T22:18:48Z",
    "updated_at": "2021-10-27T22:18:48Z",
    "author_association": "NONE",
    "body": "Shut down erigon and rpcdaemon, and started them again, no more crash. Oddly enough.",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/953352785/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
