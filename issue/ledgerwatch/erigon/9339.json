{
  "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/9339",
  "repository_url": "https://api.github.com/repos/ledgerwatch/erigon",
  "labels_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/9339/labels{/name}",
  "comments_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/9339/comments",
  "events_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/9339/events",
  "html_url": "https://github.com/ledgerwatch/erigon/issues/9339",
  "id": 2105541068,
  "node_id": "I_kwDOC0FsAM59gAHM",
  "number": 9339,
  "title": "Repair invalid/corrupted pages in mdbx",
  "user": {
    "login": "crebsy",
    "id": 121096251,
    "node_id": "U_kgDOBzfIOw",
    "avatar_url": "https://avatars.githubusercontent.com/u/121096251?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/crebsy",
    "html_url": "https://github.com/crebsy",
    "followers_url": "https://api.github.com/users/crebsy/followers",
    "following_url": "https://api.github.com/users/crebsy/following{/other_user}",
    "gists_url": "https://api.github.com/users/crebsy/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/crebsy/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/crebsy/subscriptions",
    "organizations_url": "https://api.github.com/users/crebsy/orgs",
    "repos_url": "https://api.github.com/users/crebsy/repos",
    "events_url": "https://api.github.com/users/crebsy/events{/privacy}",
    "received_events_url": "https://api.github.com/users/crebsy/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2024-01-29T13:47:24Z",
  "updated_at": "2024-01-30T01:15:18Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "#### System information\r\n\r\nErigon version: `erigon version 2.56.2-c9216ce1`\r\n\r\nOS & Version: `alpine:3.17`\r\n\r\nCommit hash: `c9216ce10451a235af1cdde572642eac3640fadf`\r\n\r\nErigon Command (with flags/config):\r\n```\r\nerigon \r\n  --chain=bor-mainnet\r\n  --datadir=/data\r\n  --bor.heimdall=https://heimdall-api.polygon.technology\r\n  --http\r\n  --http.addr=0.0.0.0\r\n  --http.vhosts=any\r\n  --http.api=eth,erigon,engine,web3,net,txpool,ots,debug\r\n  --maxpeers=100\r\n  --db.size.limit=10T\r\n  --db.pagesize=16k\r\n```\r\n\r\nChain/Network: `polygon`\r\n\r\n#### Problem\r\nI've downloaded a datadir snapshot for polygon [here](https://snapshots.polygon.technology/)\r\nUnpacked all and started the node and it was catching up.\r\n\r\nAt some point I realized this at the top of my erigon log:\r\n`mdbx_setup_dxb:15946 filesize mismatch (expect 10976728449024b/669966336p, have 10976812335104b/669971456p)`\r\nI don't know for sure if the error existed in the official snapshot or was created during an unclean shutdown or regular processing.\r\n\r\nResults of `mdbx_chk`:\r\n\r\n```\r\n$ ./mdbx_chk -vvv /polygon/chaindata/mdbx.dat\r\nmdbx_chk v0.12.0-71-g1cac6536 (2022-07-28T09:57:31+07:00, T-9a6d7e5b917e5fbd14dc51835fa749d092aa1d72)\r\nRunning for /polygon/chaindata/mdbx.dat in 'read-only' mode...\r\n   open-MADV_DONTNEED 669972605..669973504\r\n   readahead OFF 0..669972605\r\n - monopolistic mode\r\n - current boot-id b8541757ebff40c6-3223c1359b6a495b\r\n - pagesize 16384 (4096 system), max keysize 8124..8166, max readers 116\r\n - mapsize 10995116277760 (10.00 Tb)\r\n - dynamic datafile: 49152 (48.00 Kb) .. 10995116277760 (10.00 Tb), +16777216 (16.00 Mb), -33554432 (32.00 Mb)\r\n - current datafile: 10976845889536 (9.98 Tb), 669973504 pages\r\n - meta-0: steady txn#18968283, stay\r\n - meta-1: steady txn#18969001, head\r\n - meta-2: weak-intact (same boot-id) txn#18969000, tail\r\n - performs check for meta-pages clashes\r\n - performs full check recent-txn-id with meta-pages\r\n - transactions: recent 18969001, latter reader 18969001, lag 0\r\nTraversal b-tree by txn#18969001...\r\n - found 'AccountChangeSet' area\r\n - found 'AccountHistory' area\r\n - found 'BadHeaderNumber' area\r\n - found 'BlockBody' area\r\n - found 'BlockBorTransactionLookup' area\r\n - found 'BlockTransaction' area\r\n - found 'BlockTransactionLookup' area\r\n - found 'BorEventNums' area\r\n - found 'BorEvents' area\r\n - found 'BorReceipt' area\r\n - found 'BorSpans' area\r\n - found 'CallFromIndex' area\r\n - found 'CallToIndex' area\r\n - found 'CallTraceSet' area\r\n - found 'CanonicalHeader' area\r\n - found 'Code' area\r\n - found 'Config' area\r\n - found 'CumulativeGasIndex' area\r\n - found 'DbInfo' area\r\n - found 'HashedAccount' area\r\n - found 'HashedCodeHash' area\r\n - found 'HashedStorage' area\r\n - found 'Header' area\r\n - found 'HeaderNumber' area\r\n - found 'HeadersTotalDifficulty' area\r\n - found 'IncarnationMap' area\r\n - found 'LastBlock' area\r\n - found 'LastHeader' area\r\n - found 'LogAddressIndex' area\r\n - found 'LogTopicIndex' area\r\n - found 'MaxTxNum' area\r\n - found 'Migration' area\r\n - found 'PlainCodeHash' area\r\n - found 'PlainState' area\r\n ! corrupted leaf-page #300761746, mod-txnid 101201\r\n ! invalid node[0] flags (248)\r\n ! node-data(0 of 124, 4094198550 bytes) beyond (4094198490) page-end\r\n ! node[1] too long key (45459)\r\n ! node[1] key (45331) beyond page-end\r\n ! node[2] too long key (27733)\r\n ! node[2] key (27537) beyond page-end\r\n ! node[3] too long key (10240)\r\n ! node[3] key (9976) beyond page-end\r\n ! node[4] too long key (23574)\r\n ! node[4] key (23242) beyond page-end\r\n ! node[5] too long key (49784)\r\n ! node[5] key (49384) beyond page-end\r\n ! node-data(6 of 124, 671088640 bytes) beyond (671088172) page-end\r\n ! node[7] key (4962) beyond page-end\r\n ! node[9] too long key (53348)\r\n ! node[9] key (52744) beyond page-end\r\n ! node[10] too long key (18177)\r\n ! node[10] key (17505) beyond page-end\r\n ! node[11] too long key (62728)\r\n ! node[11] key (61988) beyond page-end\r\n ! node[12] too long key (61813)\r\n ! node[12] key (61005) beyond page-end\r\n ! node[13] too long key (14744)\r\n ! node[13] key (13868) beyond page-end\r\n     page #300761746: invalid/corrupted (leaf-page)\r\n ! corrupted unknown_0x47-page #511250299, mod-txnid -4901613425160814592\r\n ! pgno mismatch (511250299) != expected (300761747)\r\n     page #300761747: invalid/corrupted (broken-page)\r\n ! corrupted unknown_0x0-page #0, mod-txnid 0\r\n ! pgno mismatch (0) != expected (300761748)\r\n     page #300761748: invalid/corrupted (broken-page)\r\n - found 'Receipt' area\r\n - found 'Sequence' area\r\n - found 'StorageChangeSet' area\r\n - found 'StorageHistory' area\r\n - found 'SyncStage' area\r\n - found 'TransactionLog' area\r\n  - found 'TrieAccount' area\r\n - found 'TrieStorage' area\r\n - found 'TxSender' area\r\n - problems: invalid/corrupted (3)\r\n - pages: walked 650494599, left/unused 19478006\r\n     @GC: subtotal 4774, branch 1, large 4763, leaf 10\r\n     @MAIN: subtotal 1, leaf 1\r\n     @META: subtotal 3\r\n     AccountChangeSet: subtotal 21275405, branch 992948, leaf 20282457 (usual 20282457, sub-dupsort 36166038, dupfixed 0, sub-dupfixed 0)\r\n     AccountHistory: subtotal 3308419, branch 13419, leaf 3295000\r\n     BadHeaderNumber: subtotal 70, branch 1, leaf 69\r\n     BlockBody: subtotal 188391, branch 578, leaf 187813\r\n     BlockBorTransactionLookup: subtotal 2302, branch 9, leaf 2293\r\n     BlockTransaction: subtotal 148717258, branch 145972, large 10801732, leaf 132368379\r\n     BlockTransactionLookup: subtotal 14001668, branch 47791, leaf 13953877\r\n     BorEventNums: subtotal 764, branch 1, leaf 763\r\n     BorEvents: subtotal 84799, branch 95, large 192, leaf 84468\r\n     BorReceipt: subtotal 706, branch 1, leaf 705\r\n     BorSpans: subtotal 7247, branch 1, large 6874, leaf 372\r\n     CallFromIndex: subtotal 3680665, branch 13353, leaf 3667312\r\n     CallToIndex: subtotal 3247969, branch 11925, leaf 3236044\r\n     CallTraceSet: subtotal 66352, branch 1988, leaf 64364 (usual 64364, sub-dupsort 51015, dupfixed 0, sub-dupfixed 0)\r\n     CanonicalHeader: subtotal 310088, branch 385, leaf 309703\r\n     Code: subtotal 732687, branch 753, large 389144, leaf 189375\r\n     Config: subtotal 3, large 1, leaf 1\r\n     CumulativeGasIndex: subtotal 73579, branch 82, leaf 73497\r\n     DbInfo: subtotal 1, leaf 1\r\n     HashedAccount: subtotal 2173873, branch 8010, leaf 2165863\r\n     HashedCodeHash: subtotal 1994645, branch 11403, leaf 1983242\r\n     HashedStorage: subtotal 20512697, branch 259711, leaf 20252986 (usual 20252986, sub-dupsort 13684767, dupfixed 0, sub-dupfixed 0)\r\n     Header: subtotal 2362423, branch 7299, leaf 2355124\r\n     HeaderNumber: subtotal 238178, branch 718, leaf 237460\r\n     HeadersTotalDifficulty: subtotal 187859, branch 580, leaf 187279\r\n     IncarnationMap: subtotal 358951, branch 900, leaf 358051\r\n     LastBlock: subtotal 1, leaf 1\r\n     LastHeader: subtotal 1, leaf 1\r\n     LogAddressIndex: subtotal 524777, branch 1615, leaf 523162\r\n     LogTopicIndex: subtotal 8276871, branch 34351, leaf 8242520\r\n     MaxTxNum: subtotal 1, leaf 1\r\n     Migration: subtotal 1, leaf 1\r\n     PlainCodeHash: subtotal 2037770, branch 7042, leaf 2030728\r\n     PlainState: subtotal 24107127, other 2, branch 277183, leaf 23829942 (usual 23829942, sub-dupsort 13684046, dupfixed 0, sub-dupfixed 0)\r\n     Receipt: subtotal 2097612, branch 2301, large 9855, leaf 2085456\r\n     Sequence: subtotal 1, leaf 1\r\n     StorageChangeSet: subtotal 66549878, branch 3948618, leaf 62601260 (usual 62601260, sub-dupsort 2181184637, dupfixed 0, sub-dupfixed 0)\r\n     StorageHistory: subtotal 47915505, branch 284079, leaf 47631426\r\n     SyncStage: subtotal 1, leaf 1\r\n     TransactionLog: subtotal 263730053, branch 277421, large 22849932, leaf 205756320\r\n     TrieAccount: subtotal 445619, branch 600, leaf 445019\r\n     TrieStorage: subtotal 6281058, branch 30415, leaf 6250643\r\n     TxSender: subtotal 4996546, branch 14103, large 369918, leaf 4594396\r\n - usage: total 10657703510016 bytes, payload 9205261347776 (86.4%), unused 1452442162240 (13.6%)\r\n     @GC: subtotal 78217216 bytes (0.0%), payload 78131976 (99.9%), unused 85240 (0.1%)\r\n     @MAIN: subtotal 16384 bytes (0.0%), payload 10609 (64.8%), unused 5775 (35.2%)\r\n     @META: subtotal 49152 bytes (0.0%), payload 684 (1.4%), unused 48468 (98.6%)\r\n     AccountChangeSet: subtotal 348576235520 bytes (3.3%), payload 246340503316 (70.7%), unused 102235732204 (29.3%)\r\n     AccountHistory: subtotal 54205136896 bytes (0.5%), payload 40934846569 (75.5%), unused 13270290327 (24.5%)\r\n     BadHeaderNumber: subtotal 1146880 bytes (0.0%), payload 890766 (77.7%), unused 256114 (22.3%)\r\n     BlockBody: subtotal 3086598144 bytes (0.0%), payload 3066843615 (99.4%), unused 19754529 (0.6%)\r\n     BlockBorTransactionLookup: subtotal 37715968 bytes (0.0%), payload 22102864 (58.6%), unused 15613104 (41.4%)\r\n     BlockTransaction: subtotal 2436583555072 bytes (22.9%), payload 2284006140242 (93.7%), unused 152577414830 (6.3%)\r\n     BlockTransactionLookup: subtotal 229403328512 bytes (2.2%), payload 162329589663 (70.8%), unused 67073738849 (29.2%)\r\n     BorEventNums: subtotal 12517376 bytes (0.0%), payload 12497670 (99.8%), unused 19706 (0.2%)\r\n     BorEvents: subtotal 1389346816 bytes (0.0%), payload 1365712634 (98.3%), unused 23634182 (1.7%)\r\n     BorReceipt: subtotal 11567104 bytes (0.0%), payload 11056130 (95.6%), unused 510974 (4.4%)\r\n     BorSpans: subtotal 118734848 bytes (0.0%), payload 86503359 (72.9%), unused 32231489 (27.1%)\r\n     CallFromIndex: subtotal 60304015360 bytes (0.6%), payload 37768369679 (62.6%), unused 22535645681 (37.4%)\r\n     CallToIndex: subtotal 53214724096 bytes (0.5%), payload 41350724222 (77.7%), unused 11863999874 (22.3%)\r\n     CallTraceSet: subtotal 1087111168 bytes (0.0%), payload 723244891 (66.5%), unused 363866277 (33.5%)\r\n     CanonicalHeader: subtotal 5080481792 bytes (0.0%), payload 2642347446 (52.0%), unused 2438134346 (48.0%)\r\n     Code: subtotal 12004343808 bytes (0.1%), payload 7829964479 (65.2%), unused 4174379329 (34.8%)\r\n     Config: subtotal 49152 bytes (0.0%), payload 22072 (44.9%), unused 27080 (55.1%)\r\n     CumulativeGasIndex: subtotal 1205518336 bytes (0.0%), payload 1185602764 (98.3%), unused 19915572 (1.7%)\r\n     DbInfo: subtotal 16384 bytes (0.0%), payload 455 (2.8%), unused 15929 (97.2%)\r\n     HashedAccount: subtotal 35616735232 bytes (0.3%), payload 21895978946 (61.5%), unused 13720756286 (38.5%)\r\n     HashedCodeHash: subtotal 32680263680 bytes (0.3%), payload 27566234928 (84.4%), unused 5114028752 (15.6%)\r\n     HashedStorage: subtotal 336080027648 bytes (3.2%), payload 243090569376 (72.3%), unused 92989458272 (27.7%)\r\n     Header: subtotal 38705938432 bytes (0.4%), payload 36841525826 (95.2%), unused 1864412606 (4.8%)\r\n     HeaderNumber: subtotal 3902308352 bytes (0.0%), payload 2683640418 (68.8%), unused 1218667934 (31.2%)\r\n     HeadersTotalDifficulty: subtotal 3077881856 bytes (0.0%), payload 2956574552 (96.1%), unused 121307304 (3.9%)\r\n     IncarnationMap: subtotal 5881053184 bytes (0.1%), payload 3941673404 (67.0%), unused 1939379780 (33.0%)\r\n     LastBlock: subtotal 16384 bytes (0.0%), payload 71 (0.4%), unused 16313 (99.6%)\r\n     LastHeader: subtotal 16384 bytes (0.0%), payload 72 (0.4%), unused 16312 (99.6%)\r\n     LogAddressIndex: subtotal 8597946368 bytes (0.1%), payload 5427508176 (63.1%), unused 3170438192 (36.9%)\r\n     LogTopicIndex: subtotal 135608254464 bytes (1.3%), payload 90749708513 (66.9%), unused 44858545951 (33.1%)\r\n     MaxTxNum: subtotal 16384 bytes (0.0%), payload 46 (0.3%), unused 16338 (99.7%)\r\n     Migration: subtotal 16384 bytes (0.0%), payload 746 (4.6%), unused 15638 (95.4%)\r\n     PlainCodeHash: subtotal 33386823680 bytes (0.3%), payload 23532509606 (70.5%), unused 9854314074 (29.5%)\r\n     PlainState: subtotal 394971168768 bytes (3.7%), payload 261326372311 (66.2%), unused 133644796457 (33.8%)\r\n     Receipt: subtotal 34367275008 bytes (0.3%), payload 32760032349 (95.3%), unused 1607242659 (4.7%)\r\n     Sequence: subtotal 16384 bytes (0.0%), payload 130 (0.8%), unused 16254 (99.2%)\r\n     StorageChangeSet: subtotal 1090353201152 bytes (10.2%), payload 939453475149 (86.2%), unused 150899726003 (13.8%)\r\n     StorageHistory: subtotal 785047633920 bytes (7.4%), payload 553960705066 (70.6%), unused 231086928854 (29.4%)\r\n     SyncStage: subtotal 16384 bytes (0.0%), payload 589 (3.6%), unused 15795 (96.4%)\r\n     TransactionLog: subtotal 4320953188352 bytes (40.5%), payload 3978310357829 (92.1%), unused 342642830523 (7.9%)\r\n     TrieAccount: subtotal 7301021696 bytes (0.1%), payload 3775246549 (51.7%), unused 3525775147 (48.3%)\r\n     TrieStorage: subtotal 102908854272 bytes (1.0%), payload 74324432807 (72.2%), unused 28584421465 (27.8%)\r\n     TxSender: subtotal 81863409664 bytes (0.8%), payload 72909694212 (89.1%), unused 8953715452 (10.9%)\r\n - summary: average fill 86.4%, 3 problems\r\nSkip processing @MAIN since tree is corrupted (5 problems)\r\n ! abort processing '@GC' due to a previous error\r\n - space: 671088640 total pages, backed 669973504 (99.8%), allocated 669972605 (99.8%), remained 1116035 (0.2%), used 650494599 (96.9%), gc 0 (0.0%), detained 0 (0.0%), reclaimable 0 (0.0%), available 1116035 (0.2%)\r\nTotal 32 errors are detected, elapsed 385832.115 seconds.\r\n```\r\n\r\nSo it looks like there are a few corrupt entries :-/\r\n\r\nCould it be possible to repair this db with the info contained in the meta pages ?\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/9339/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/9339/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1915877895",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/9339#issuecomment-1915877895",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/9339",
    "id": 1915877895,
    "node_id": "IC_kwDOC0FsAM5yMfoH",
    "user": {
      "login": "AskAlexSharov",
      "id": 46885206,
      "node_id": "MDQ6VXNlcjQ2ODg1MjA2",
      "avatar_url": "https://avatars.githubusercontent.com/u/46885206?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AskAlexSharov",
      "html_url": "https://github.com/AskAlexSharov",
      "followers_url": "https://api.github.com/users/AskAlexSharov/followers",
      "following_url": "https://api.github.com/users/AskAlexSharov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AskAlexSharov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AskAlexSharov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AskAlexSharov/subscriptions",
      "organizations_url": "https://api.github.com/users/AskAlexSharov/orgs",
      "repos_url": "https://api.github.com/users/AskAlexSharov/repos",
      "events_url": "https://api.github.com/users/AskAlexSharov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AskAlexSharov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2024-01-30T01:15:18Z",
    "updated_at": "2024-01-30T01:15:18Z",
    "author_association": "COLLABORATOR",
    "body": "mdbx_chk: has flags to switch between 3 meta-pages. If one of them will help you - great. If all of them are broken - then only restore from backup. ",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1915877895/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
