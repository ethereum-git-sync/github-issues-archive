{
  "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/1824",
  "repository_url": "https://api.github.com/repos/ledgerwatch/erigon",
  "labels_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/1824/labels{/name}",
  "comments_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/1824/comments",
  "events_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/1824/events",
  "html_url": "https://github.com/ledgerwatch/erigon/issues/1824",
  "id": 868050516,
  "node_id": "MDU6SXNzdWU4NjgwNTA1MTY=",
  "number": 1824,
  "title": "block number ordering issue on newBlockHeader subscription",
  "user": {
    "login": "0xD34D81",
    "id": 83207656,
    "node_id": "MDQ6VXNlcjgzMjA3NjU2",
    "avatar_url": "https://avatars.githubusercontent.com/u/83207656?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/0xD34D81",
    "html_url": "https://github.com/0xD34D81",
    "followers_url": "https://api.github.com/users/0xD34D81/followers",
    "following_url": "https://api.github.com/users/0xD34D81/following{/other_user}",
    "gists_url": "https://api.github.com/users/0xD34D81/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/0xD34D81/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/0xD34D81/subscriptions",
    "organizations_url": "https://api.github.com/users/0xD34D81/orgs",
    "repos_url": "https://api.github.com/users/0xD34D81/repos",
    "events_url": "https://api.github.com/users/0xD34D81/events{/privacy}",
    "received_events_url": "https://api.github.com/users/0xD34D81/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2021-04-26T19:17:29Z",
  "updated_at": "2021-04-27T07:10:01Z",
  "closed_at": "2021-04-27T07:10:01Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "#### System information\r\n\r\nGeth version: `tg version 2021.05.1-alpha`\r\nOS & Version: Linux\r\n\r\n#### Expected behaviour\r\n\r\nWhen subscribing to `newBlockHeader`, block numbers should be received in order.\r\n\r\n#### Actual behaviour\r\n\r\nSometimes when `tg` receives and processes multiple blocks at the same time, block numbers are not broadcasted in the proper order.\r\n\r\n#### Steps to reproduce the behaviour\r\n\r\n```\r\nmkdir reproduction\r\ncd reproduction\r\nnpm install ethers\r\n```\r\n\r\ninside an `index.js` file:\r\n\r\n```\r\nconst ethers = require('ethers');\r\n\r\nconst provider = new ethers.providers.WebSocketProvider('ws://127.0.0.1:8545');\r\n\r\nconst main = async () => {\r\n        let last = Date.now();\r\n        provider.on('block', async (nb) => {\r\n                const logs = await provider.getLogs({\r\n                        fromBlock: nb,\r\n                        toBlock: nb\r\n                });\r\n                console.log('retrieve all block logs', nb, Date.now() - last);\r\n                last = Date.now();\r\n        });\r\n}\r\n\r\nmain();\r\n```\r\n\r\nand run `node index.js`\r\n\r\nSometimes you should see logs like this (displayed values are block number and number of ms since last block event received)\r\n\r\n```\r\nretrieve all block logs 12317681 15568\r\nretrieve all block logs 12317683 14\r\nretrieve all block logs 12317682 13\r\nretrieve all block logs 12317684 24022\r\nretrieve all block logs 12317685 16998\r\nretrieve all block logs 12317686 2641\r\nretrieve all block logs 12317687 24495\r\nretrieve all block logs 12317688 1857\r\nretrieve all block logs 12317689 24636\r\nretrieve all block logs 12317690 21911\r\nretrieve all block logs 12317692 94201\r\nretrieve all block logs 12317691 12\r\nretrieve all block logs 12317693 7067\r\n```\r\n\r\n",
  "closed_by": {
    "login": "0xD34D81",
    "id": 83207656,
    "node_id": "MDQ6VXNlcjgzMjA3NjU2",
    "avatar_url": "https://avatars.githubusercontent.com/u/83207656?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/0xD34D81",
    "html_url": "https://github.com/0xD34D81",
    "followers_url": "https://api.github.com/users/0xD34D81/followers",
    "following_url": "https://api.github.com/users/0xD34D81/following{/other_user}",
    "gists_url": "https://api.github.com/users/0xD34D81/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/0xD34D81/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/0xD34D81/subscriptions",
    "organizations_url": "https://api.github.com/users/0xD34D81/orgs",
    "repos_url": "https://api.github.com/users/0xD34D81/repos",
    "events_url": "https://api.github.com/users/0xD34D81/events{/privacy}",
    "received_events_url": "https://api.github.com/users/0xD34D81/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/1824/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/1824/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/827252448",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/1824#issuecomment-827252448",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/1824",
    "id": 827252448,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgyNzI1MjQ0OA==",
    "user": {
      "login": "AskAlexSharov",
      "id": 46885206,
      "node_id": "MDQ6VXNlcjQ2ODg1MjA2",
      "avatar_url": "https://avatars.githubusercontent.com/u/46885206?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AskAlexSharov",
      "html_url": "https://github.com/AskAlexSharov",
      "followers_url": "https://api.github.com/users/AskAlexSharov/followers",
      "following_url": "https://api.github.com/users/AskAlexSharov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AskAlexSharov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AskAlexSharov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AskAlexSharov/subscriptions",
      "organizations_url": "https://api.github.com/users/AskAlexSharov/orgs",
      "repos_url": "https://api.github.com/users/AskAlexSharov/repos",
      "events_url": "https://api.github.com/users/AskAlexSharov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AskAlexSharov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-04-27T01:53:03Z",
    "updated_at": "2021-04-27T01:53:03Z",
    "author_association": "COLLABORATOR",
    "body": "@0xD34D81  Do you think it’s because of reorg, or because of bug in notifications? If first - what behaviour expected?",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/827252448/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/827336500",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/1824#issuecomment-827336500",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/1824",
    "id": 827336500,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgyNzMzNjUwMA==",
    "user": {
      "login": "0xD34D81",
      "id": 83207656,
      "node_id": "MDQ6VXNlcjgzMjA3NjU2",
      "avatar_url": "https://avatars.githubusercontent.com/u/83207656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/0xD34D81",
      "html_url": "https://github.com/0xD34D81",
      "followers_url": "https://api.github.com/users/0xD34D81/followers",
      "following_url": "https://api.github.com/users/0xD34D81/following{/other_user}",
      "gists_url": "https://api.github.com/users/0xD34D81/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/0xD34D81/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/0xD34D81/subscriptions",
      "organizations_url": "https://api.github.com/users/0xD34D81/orgs",
      "repos_url": "https://api.github.com/users/0xD34D81/repos",
      "events_url": "https://api.github.com/users/0xD34D81/events{/privacy}",
      "received_events_url": "https://api.github.com/users/0xD34D81/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-04-27T06:02:31Z",
    "updated_at": "2021-04-27T06:02:31Z",
    "author_association": "NONE",
    "body": "No, I don’t think it’s reorgs, on geth reorgs would broadcast the same number twice. I believe it’s when tg processes 2 or more blocks at the same time. I’ll try to watch my script and tg at the same time to see If there is some particular behaviour when it happens",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/827336500/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/827337185",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/1824#issuecomment-827337185",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/1824",
    "id": 827337185,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgyNzMzNzE4NQ==",
    "user": {
      "login": "0xD34D81",
      "id": 83207656,
      "node_id": "MDQ6VXNlcjgzMjA3NjU2",
      "avatar_url": "https://avatars.githubusercontent.com/u/83207656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/0xD34D81",
      "html_url": "https://github.com/0xD34D81",
      "followers_url": "https://api.github.com/users/0xD34D81/followers",
      "following_url": "https://api.github.com/users/0xD34D81/following{/other_user}",
      "gists_url": "https://api.github.com/users/0xD34D81/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/0xD34D81/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/0xD34D81/subscriptions",
      "organizations_url": "https://api.github.com/users/0xD34D81/orgs",
      "repos_url": "https://api.github.com/users/0xD34D81/repos",
      "events_url": "https://api.github.com/users/0xD34D81/events{/privacy}",
      "received_events_url": "https://api.github.com/users/0xD34D81/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-04-27T06:04:02Z",
    "updated_at": "2021-04-27T06:04:02Z",
    "author_association": "NONE",
    "body": "Oh wait actually my script moght be wrong as the logging happens after the getLogs call, that might be the issue. I’ll move it before to check.",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/827337185/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/827370363",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/1824#issuecomment-827370363",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/1824",
    "id": 827370363,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgyNzM3MDM2Mw==",
    "user": {
      "login": "0xD34D81",
      "id": 83207656,
      "node_id": "MDQ6VXNlcjgzMjA3NjU2",
      "avatar_url": "https://avatars.githubusercontent.com/u/83207656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/0xD34D81",
      "html_url": "https://github.com/0xD34D81",
      "followers_url": "https://api.github.com/users/0xD34D81/followers",
      "following_url": "https://api.github.com/users/0xD34D81/following{/other_user}",
      "gists_url": "https://api.github.com/users/0xD34D81/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/0xD34D81/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/0xD34D81/subscriptions",
      "organizations_url": "https://api.github.com/users/0xD34D81/orgs",
      "repos_url": "https://api.github.com/users/0xD34D81/repos",
      "events_url": "https://api.github.com/users/0xD34D81/events{/privacy}",
      "received_events_url": "https://api.github.com/users/0xD34D81/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-04-27T07:10:01Z",
    "updated_at": "2021-04-27T07:10:01Z",
    "author_association": "NONE",
    "body": "Properly working, issue was from the getLogs call before logging that baited me into thinking there was an ordering issue",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/827370363/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
