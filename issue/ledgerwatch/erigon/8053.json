{
  "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/8053",
  "repository_url": "https://api.github.com/repos/ledgerwatch/erigon",
  "labels_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/8053/labels{/name}",
  "comments_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/8053/comments",
  "events_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/8053/events",
  "html_url": "https://github.com/ledgerwatch/erigon/issues/8053",
  "id": 1863023223,
  "node_id": "I_kwDOC0FsAM5vC3p3",
  "number": 8053,
  "title": "metrics endpoint producing duplicates, and therefore invalid Prometheus Export Format",
  "user": {
    "login": "angusscott",
    "id": 4872839,
    "node_id": "MDQ6VXNlcjQ4NzI4Mzk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4872839?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/angusscott",
    "html_url": "https://github.com/angusscott",
    "followers_url": "https://api.github.com/users/angusscott/followers",
    "following_url": "https://api.github.com/users/angusscott/following{/other_user}",
    "gists_url": "https://api.github.com/users/angusscott/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/angusscott/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/angusscott/subscriptions",
    "organizations_url": "https://api.github.com/users/angusscott/orgs",
    "repos_url": "https://api.github.com/users/angusscott/repos",
    "events_url": "https://api.github.com/users/angusscott/events{/privacy}",
    "received_events_url": "https://api.github.com/users/angusscott/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2023-08-23T10:14:35Z",
  "updated_at": "2023-08-29T08:04:39Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "#### System information\r\n\r\nErigon version: erigon version 2.48.1-stable-674b77f0\r\n\r\nOS & Version: Windows/Linux/OSX\r\n\r\nErigon Command (with flags/config):\r\n\r\n\r\nChain/Network: Ethereum\r\n\r\n#### Expected behaviour\r\n\r\nExpect metrics to not include duplicates, and #HELP/#TYPE comments to appear in advance of the metrics they define\r\n\r\n#### Actual behaviour\r\n\r\nMetrics are appearing duplicated and out of sequence (#HELP/#TYPE) appearing after the metrics\r\n\r\n#### Steps to reproduce the behaviour\r\n\r\nStart an instance of Erigon, with --metrics enabled, and make a request.\r\n\r\n\r\nFollowing an upgrade from v2.43.0 to v2.48.1 of Erigon, the metrics endpoint (/debug/metrics/prometheus), Telegraf is unable to parse the Prometheus Export Format, caused by duplicate metrics (and metrics appearing out of order, with metric appearing before #HELP and #TYPE information.\r\n\r\n**Result from v2.48.1**\r\n\r\ncurl -s http://localhost:6060/debug/metrics/prometheus | grep \"go_gc_duration_seconds\"\r\n\r\ngo_gc_duration_seconds{quantile=\"0\"} 5.3329e-05\r\ngo_gc_duration_seconds{quantile=\"0.25\"} 9.0795e-05\r\ngo_gc_duration_seconds{quantile=\"0.5\"} 0.000119249\r\ngo_gc_duration_seconds{quantile=\"0.75\"} 0.000179327\r\ngo_gc_duration_seconds{quantile=\"1\"} 0.076610138\r\ngo_gc_duration_seconds_sum 3.005057495\r\ngo_gc_duration_seconds_count 3192\r\n\\# HELP go_gc_duration_seconds A summary of the pause duration of garbage collection cycles.\r\n\\# TYPE go_gc_duration_seconds summary\r\ngo_gc_duration_seconds{quantile=\"0\"} 5.3329e-05\r\ngo_gc_duration_seconds{quantile=\"0.25\"} 9.0795e-05\r\ngo_gc_duration_seconds{quantile=\"0.5\"} 0.000119249\r\ngo_gc_duration_seconds{quantile=\"0.75\"} 0.00018207\r\ngo_gc_duration_seconds{quantile=\"1\"} 0.076610138\r\ngo_gc_duration_seconds_sum 3.005057495\r\ngo_gc_duration_seconds_count 3192\r\n\r\n\r\n**Result from v2.43.0**\r\n\r\ncurl -s http://localhost:6060/debug/metrics/prometheus | grep \"go_gc_duration_seconds\"\r\n\r\ngo_gc_duration_seconds{quantile=\"0\"} 0.000106077\r\ngo_gc_duration_seconds{quantile=\"0.25\"} 0.000119962\r\ngo_gc_duration_seconds{quantile=\"0.5\"} 0.000128057\r\ngo_gc_duration_seconds{quantile=\"0.75\"} 0.000138066\r\ngo_gc_duration_seconds{quantile=\"1\"} 0.00027549\r\ngo_gc_duration_seconds_sum 6.798991387\r\ngo_gc_duration_seconds_count 35210\r\n\r\n\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/8053/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/8053/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1689888288",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/8053#issuecomment-1689888288",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/8053",
    "id": 1689888288,
    "node_id": "IC_kwDOC0FsAM5kuaYg",
    "user": {
      "login": "AskAlexSharov",
      "id": 46885206,
      "node_id": "MDQ6VXNlcjQ2ODg1MjA2",
      "avatar_url": "https://avatars.githubusercontent.com/u/46885206?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AskAlexSharov",
      "html_url": "https://github.com/AskAlexSharov",
      "followers_url": "https://api.github.com/users/AskAlexSharov/followers",
      "following_url": "https://api.github.com/users/AskAlexSharov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AskAlexSharov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AskAlexSharov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AskAlexSharov/subscriptions",
      "organizations_url": "https://api.github.com/users/AskAlexSharov/orgs",
      "repos_url": "https://api.github.com/users/AskAlexSharov/repos",
      "events_url": "https://api.github.com/users/AskAlexSharov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AskAlexSharov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-08-23T12:38:16Z",
    "updated_at": "2023-08-23T12:38:16Z",
    "author_association": "COLLABORATOR",
    "body": "Probably i can fix tomorrow",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1689888288/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1694674760",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/8053#issuecomment-1694674760",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/8053",
    "id": 1694674760,
    "node_id": "IC_kwDOC0FsAM5lAq9I",
    "user": {
      "login": "mh0lt",
      "id": 135143369,
      "node_id": "U_kgDOCA4fyQ",
      "avatar_url": "https://avatars.githubusercontent.com/u/135143369?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mh0lt",
      "html_url": "https://github.com/mh0lt",
      "followers_url": "https://api.github.com/users/mh0lt/followers",
      "following_url": "https://api.github.com/users/mh0lt/following{/other_user}",
      "gists_url": "https://api.github.com/users/mh0lt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mh0lt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mh0lt/subscriptions",
      "organizations_url": "https://api.github.com/users/mh0lt/orgs",
      "repos_url": "https://api.github.com/users/mh0lt/repos",
      "events_url": "https://api.github.com/users/mh0lt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mh0lt/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-08-27T13:53:28Z",
    "updated_at": "2023-08-27T13:53:28Z",
    "author_association": "COLLABORATOR",
    "body": "I have this fixed on this branch https://github.com/ledgerwatch/erigon/tree/heimdall_metrics, which I expect to merge into develop tomorrow after the primary fix in the branch is confirmed.\r\n\r\nJust to confirm this is the output if I run in heimdall_metrics.  Part of the change here is changing the prometheus output to include meta-data which the polygon devops team need in general for thier data dog integration.\r\n```\r\n$ curl -s http://localhost:6060/debug/metrics/prometheus | grep \"go_gc_duration_seconds\"\r\n# HELP go_gc_duration_seconds A summary of the pause duration of garbage collection cycles.\r\n# TYPE go_gc_duration_seconds summary\r\ngo_gc_duration_seconds{quantile=\"0\"} 0\r\ngo_gc_duration_seconds{quantile=\"0.25\"} 0\r\ngo_gc_duration_seconds{quantile=\"0.5\"} 0\r\ngo_gc_duration_seconds{quantile=\"0.75\"} 0\r\ngo_gc_duration_seconds{quantile=\"1\"} 0\r\ngo_gc_duration_seconds_sum 0\r\ngo_gc_duration_seconds_count 4\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1694674760/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1696963543",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/8053#issuecomment-1696963543",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/8053",
    "id": 1696963543,
    "node_id": "IC_kwDOC0FsAM5lJZvX",
    "user": {
      "login": "angusscott",
      "id": 4872839,
      "node_id": "MDQ6VXNlcjQ4NzI4Mzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4872839?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/angusscott",
      "html_url": "https://github.com/angusscott",
      "followers_url": "https://api.github.com/users/angusscott/followers",
      "following_url": "https://api.github.com/users/angusscott/following{/other_user}",
      "gists_url": "https://api.github.com/users/angusscott/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/angusscott/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/angusscott/subscriptions",
      "organizations_url": "https://api.github.com/users/angusscott/orgs",
      "repos_url": "https://api.github.com/users/angusscott/repos",
      "events_url": "https://api.github.com/users/angusscott/events{/privacy}",
      "received_events_url": "https://api.github.com/users/angusscott/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-08-29T08:04:39Z",
    "updated_at": "2023-08-29T08:04:39Z",
    "author_association": "NONE",
    "body": "Great to see, all I ask is you pass the result through expfmt.TextParser's TextToMetricFamilies method, which will guarantee the result is formatted correctly (although the above looks correct. (I believe you're already using expfmt to generate the result, from what I could gleam from the Erigon code base)",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1696963543/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
