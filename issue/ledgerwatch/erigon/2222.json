{
  "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/2222",
  "repository_url": "https://api.github.com/repos/ledgerwatch/erigon",
  "labels_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/2222/labels{/name}",
  "comments_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/2222/comments",
  "events_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/2222/events",
  "html_url": "https://github.com/ledgerwatch/erigon/issues/2222",
  "id": 927824535,
  "node_id": "MDU6SXNzdWU5Mjc4MjQ1MzU=",
  "number": 2222,
  "title": "Crash during `Blocks execution` -- assertion fails in `function mdbx_sync_locked, file mdbx, line 13891`",
  "user": {
    "login": "XertroV",
    "id": 1046448,
    "node_id": "MDQ6VXNlcjEwNDY0NDg=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1046448?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/XertroV",
    "html_url": "https://github.com/XertroV",
    "followers_url": "https://api.github.com/users/XertroV/followers",
    "following_url": "https://api.github.com/users/XertroV/following{/other_user}",
    "gists_url": "https://api.github.com/users/XertroV/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/XertroV/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/XertroV/subscriptions",
    "organizations_url": "https://api.github.com/users/XertroV/orgs",
    "repos_url": "https://api.github.com/users/XertroV/repos",
    "events_url": "https://api.github.com/users/XertroV/events{/privacy}",
    "received_events_url": "https://api.github.com/users/XertroV/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2021-06-23T03:35:33Z",
  "updated_at": "2021-07-30T15:31:55Z",
  "closed_at": "2021-07-30T15:31:54Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "#### System information\r\n\r\nErigon version: `erigon version 2021.06.5-alpha`\r\n\r\nOS & Version: FreeBSD (TrueNAS-12.0-U4)\r\n\r\nCommit hash: `a79ed2fe0bf3b89fca62519dad4da6ae2f0e4634`\r\n\r\n#### Expected behaviour\r\n\r\nErigon does not crash.\r\n\r\n#### Actual behaviour\r\n\r\nErigon crashes.\r\n\r\n#### Steps to reproduce the behaviour\r\n\r\nI'm not sure, however, here is some info about my set-up and things I was doing beforehand:\r\n\r\n##### Background Context\r\n\r\n###### General\r\n\r\nI was curious if ZFS (and it's caching features) could help with a mainnet archive sync. The last time I focused on doing an archive sync was early 2018 when I concluded that one needed 3TB+ of NVMe storage. I think this predates turbo-geth (or close to, anyway) and I was using parity previously. As I was googling around I found this project, so I decided to test Erigon first b/c it should be faster anyway.\r\n\r\n###### Erigon sync -- client killed during recover stage (after block download stage and before execution stage)\r\n\r\n(Not sure if relevant)\r\n\r\nLast night, during the ecrecover stage, the client was killed -- I think by the kernel due to high memory usage based on the line that was printed when the process was ended; the line was just `Killed.` (or something close to that).\r\n\r\nA few hours before that, based on historical system graphs, swap utilization rose to 100% (4GB), but the RAM graph shows that there was still free RAM so IDK what really went on then. I was monitoring `htop` through this period and didn't notice RAM usage at 100%. Erigon was still making steady progress in the recover stage.\r\n\r\n*Note: it would be nice if progress on the ecrecover stage was saved. After Erigon was restarted, it began doing ecrecovery from the genesis block, even though it was at block 4m or 6m when it was killed* :(\r\n\r\n##### Crash 1\r\n\r\nSee <https://maxkaye.s3.wasabisys.com/upload/20210623-erigon-crash-1.txt> -- **note** this is a saved tmux buffer\r\n\r\nRelevant Events:\r\n\r\n* at `06-23|12:09:38` execution is going well & at a rate I expect given another (better) machine that I'm syncing Erigon on.\r\n* at `06-23|12:10:22` there's a `write to db`\r\n* after this progress is MUCH slower (`06-23|12:10:38` onwards)\r\n* at `06-23|12:18:57` I ctrl+c the client, which shuts down safely. after this I start it again. *note:* I'd done this procedure at least once before -- the node ran smoothly for ~45 minutes before it slowed down again.\r\n* the client goes through header + blocks download + recover stages, then starts execution and immediately crashes with:\r\n  * `Assertion failed: ((env->me_flags & (MDBX_RDONLY | (0x80000000U))) == 0), function mdbx_sync_locked, file mdbx, line 13891.`\r\n\r\n##### Crash 2\r\n\r\nAfter the first crash, I restarted the node. See <https://maxkaye.s3.wasabisys.com/upload/20210623-erigon-crash-2.txt>\r\n\r\nThe execution stage ran for 11 minutes before I hit the same assertion failure (tho with a longer traceback I think)\r\n\r\n##### Server Set-up\r\n\r\nI'm running Erigon in a TrueNAS (FreeBSD) jail. The ZFS pool I'm using has 6x spinning disks (HC-320s) in RAIDz2, plus 1x 256 GB NVMe drive acting as ZIL/SLOG (write cache).\r\n\r\nCPU: Ryzen 3400g\r\nRAM: 32 GB (note: I think up to 50-75% of this (roughly) ends up being used by Erigon depending on the stage)\r\n\r\n##### End notes\r\n\r\nMy workaround soln (mb): I did `rm ~/.local/share/erigon/erigon/chaindata/mdbx.lck` and then restarted Erigon. so far it's back to executing blocks: `[7/18 Execution] Executed blocks         number=4508947  blk/s=105.304 tx/s=8059.273  Mgas/s=438.694 batch=138.30MiB alloc=770.04MiB sys=1.26GiB`\r\n\r\n#### Backtrace\r\n\r\nSee <https://maxkaye.s3.wasabisys.com/upload/20210623-erigon-crash-1.txt> and <https://maxkaye.s3.wasabisys.com/upload/20210623-erigon-crash-2.txt>\r\n",
  "closed_by": {
    "login": "AskAlexSharov",
    "id": 46885206,
    "node_id": "MDQ6VXNlcjQ2ODg1MjA2",
    "avatar_url": "https://avatars.githubusercontent.com/u/46885206?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/AskAlexSharov",
    "html_url": "https://github.com/AskAlexSharov",
    "followers_url": "https://api.github.com/users/AskAlexSharov/followers",
    "following_url": "https://api.github.com/users/AskAlexSharov/following{/other_user}",
    "gists_url": "https://api.github.com/users/AskAlexSharov/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/AskAlexSharov/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/AskAlexSharov/subscriptions",
    "organizations_url": "https://api.github.com/users/AskAlexSharov/orgs",
    "repos_url": "https://api.github.com/users/AskAlexSharov/repos",
    "events_url": "https://api.github.com/users/AskAlexSharov/events{/privacy}",
    "received_events_url": "https://api.github.com/users/AskAlexSharov/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/2222/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/2222/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/866629044",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/2222#issuecomment-866629044",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/2222",
    "id": 866629044,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg2NjYyOTA0NA==",
    "user": {
      "login": "AskAlexSharov",
      "id": 46885206,
      "node_id": "MDQ6VXNlcjQ2ODg1MjA2",
      "avatar_url": "https://avatars.githubusercontent.com/u/46885206?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AskAlexSharov",
      "html_url": "https://github.com/AskAlexSharov",
      "followers_url": "https://api.github.com/users/AskAlexSharov/followers",
      "following_url": "https://api.github.com/users/AskAlexSharov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AskAlexSharov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AskAlexSharov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AskAlexSharov/subscriptions",
      "organizations_url": "https://api.github.com/users/AskAlexSharov/orgs",
      "repos_url": "https://api.github.com/users/AskAlexSharov/repos",
      "events_url": "https://api.github.com/users/AskAlexSharov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AskAlexSharov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-06-23T08:13:37Z",
    "updated_at": "2021-06-23T08:13:37Z",
    "author_association": "COLLABORATOR",
    "body": "Hi. \r\n\r\nMDBX already heavily rely on OS's PageCache. I don't think zfs-cache feature may help here. \r\nAnd Erigon does use MDBX in the way where most of read/writes are happening in RAM and dumped to disk by rare big batches (this is reason why you lost all StageSenders progress when did reboot). \r\n\r\nBy default MDBX is fine with `kill -9` and power-off the machine. But if you disable `fsync` then you loose all this guaranties. As i see in article about zfs-cache `When ZFS receives a write request, it doesn't just immediately start writing to disk` - it means it reducing Durability guaranties provided by MDBX. For more details see docs of Durability: https://github.com/erthink/libmdbx/blob/master/mdbx.h#L1163\r\n\r\n`I think up to 50-75% of this (roughly) ends up being used by Erigon` - you need be careful here and separate PageCache (which owned by OS and surviving Erigon's reboot) and memory allocated by Erigon. Some tools (like `htop`) may attribute all this RAM to Erigon and confuse you. And PageCache will use 100% of available RAM - just because DB size > RAM. OS will manage LRU of PageCache and store only Hot part of DB in RAM. Erigon generally using not much RAM (but now we have known problem with \"stage 4 downloading bodies\" - it has spike to 8-10Gb. I hope we will fix it.)\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/866629044/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/889971658",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/2222#issuecomment-889971658",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/2222",
    "id": 889971658,
    "node_id": "IC_kwDOC0FsAM41C-PK",
    "user": {
      "login": "AskAlexSharov",
      "id": 46885206,
      "node_id": "MDQ6VXNlcjQ2ODg1MjA2",
      "avatar_url": "https://avatars.githubusercontent.com/u/46885206?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AskAlexSharov",
      "html_url": "https://github.com/AskAlexSharov",
      "followers_url": "https://api.github.com/users/AskAlexSharov/followers",
      "following_url": "https://api.github.com/users/AskAlexSharov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AskAlexSharov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AskAlexSharov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AskAlexSharov/subscriptions",
      "organizations_url": "https://api.github.com/users/AskAlexSharov/orgs",
      "repos_url": "https://api.github.com/users/AskAlexSharov/repos",
      "events_url": "https://api.github.com/users/AskAlexSharov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AskAlexSharov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-07-30T15:31:54Z",
    "updated_at": "2021-07-30T15:31:54Z",
    "author_association": "COLLABORATOR",
    "body": "Closing because no activity in issue. Feel free to reopen",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/889971658/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
