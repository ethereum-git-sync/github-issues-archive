{
  "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/335",
  "repository_url": "https://api.github.com/repos/ledgerwatch/erigon",
  "labels_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/335/labels{/name}",
  "comments_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/335/comments",
  "events_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/335/events",
  "html_url": "https://github.com/ledgerwatch/erigon/issues/335",
  "id": 555071958,
  "node_id": "MDU6SXNzdWU1NTUwNzE5NTg=",
  "number": 335,
  "title": "Calculate transaction lookup bucket `l` in bulk by sorting",
  "user": {
    "login": "AlexeyAkhunov",
    "id": 13686139,
    "node_id": "MDQ6VXNlcjEzNjg2MTM5",
    "avatar_url": "https://avatars.githubusercontent.com/u/13686139?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/AlexeyAkhunov",
    "html_url": "https://github.com/AlexeyAkhunov",
    "followers_url": "https://api.github.com/users/AlexeyAkhunov/followers",
    "following_url": "https://api.github.com/users/AlexeyAkhunov/following{/other_user}",
    "gists_url": "https://api.github.com/users/AlexeyAkhunov/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/AlexeyAkhunov/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/AlexeyAkhunov/subscriptions",
    "organizations_url": "https://api.github.com/users/AlexeyAkhunov/orgs",
    "repos_url": "https://api.github.com/users/AlexeyAkhunov/repos",
    "events_url": "https://api.github.com/users/AlexeyAkhunov/events{/privacy}",
    "received_events_url": "https://api.github.com/users/AlexeyAkhunov/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "Giulio2002",
    "id": 29233688,
    "node_id": "MDQ6VXNlcjI5MjMzNjg4",
    "avatar_url": "https://avatars.githubusercontent.com/u/29233688?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Giulio2002",
    "html_url": "https://github.com/Giulio2002",
    "followers_url": "https://api.github.com/users/Giulio2002/followers",
    "following_url": "https://api.github.com/users/Giulio2002/following{/other_user}",
    "gists_url": "https://api.github.com/users/Giulio2002/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Giulio2002/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Giulio2002/subscriptions",
    "organizations_url": "https://api.github.com/users/Giulio2002/orgs",
    "repos_url": "https://api.github.com/users/Giulio2002/repos",
    "events_url": "https://api.github.com/users/Giulio2002/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Giulio2002/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "Giulio2002",
      "id": 29233688,
      "node_id": "MDQ6VXNlcjI5MjMzNjg4",
      "avatar_url": "https://avatars.githubusercontent.com/u/29233688?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Giulio2002",
      "html_url": "https://github.com/Giulio2002",
      "followers_url": "https://api.github.com/users/Giulio2002/followers",
      "following_url": "https://api.github.com/users/Giulio2002/following{/other_user}",
      "gists_url": "https://api.github.com/users/Giulio2002/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Giulio2002/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Giulio2002/subscriptions",
      "organizations_url": "https://api.github.com/users/Giulio2002/orgs",
      "repos_url": "https://api.github.com/users/Giulio2002/repos",
      "events_url": "https://api.github.com/users/Giulio2002/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Giulio2002/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2020-01-25T11:01:17Z",
  "updated_at": "2020-04-04T15:21:30Z",
  "closed_at": "2020-04-04T15:21:30Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "When syncing turbo-geth currently, for each transaction we process, we make an entry in the bucket `l` (transaction lookup), which maps `transaction-hash` to the block number where this transaction occurs. Some time ago, I was measuring the amount of bytes written to disk by turbo-geth when syncing, and the writing to bucket `l` came at the top:\r\n````\r\nST (Current contract storage): 472k/block\r\nsecure-key-key- (Preimages): 628k/block\r\nhAT (History of accounts): 1511k/block\r\nB (?): 4k/block\r\nb (Block bodies): 39k/block\r\nl (Index tx_hash -> block;tx_index): 1711k/block\r\nh (Block headers): 2k/block\r\nH (?): 9k/block\r\nAT (Current accounts): 1069/block\r\nCODE (Contract codes): 2k/block\r\nhST (History of contract storage): 602k/block\r\nSUFFIX (List of changed keys): 22k/block\r\n````\r\n\r\nthis could be explained by the fact that transaction hashes are kind of random and distributed very evenly across the bucket. So writing new transaction causes us, with the high probability, to write out an entire page (4k bytes) for 1 entry (40 bytes), which means that the write amplification could be up to 100x.\r\n\r\nWe need to try to skip writing to this bucket during the sync and rather create it after the sync, to reduce the write amplification. So here is the plan. We first download some blocks:\r\n\r\n````\r\nmake\r\n./build/bin/geth --download-only\r\n````\r\n\r\nThen, we create (in memory) the array of `uint64` values, one per transaction. For each transaction, we place in the array the combination of the block number and transaction index inside that block number. Let's say, that it is possible to pack them into 6 bytes. We pack them into the least significant 6 bytes. That leaves 2 most significant bytes free. In the first pass of our algorithm, we put the first 2 bytes of corresponding transaction hash into those 2 bytes.\r\nThen we sort the array. Since the transaction hashes are very close to random, this will effectively split the set of transactions into 2^16 parts of roughly the same size. We remember (in another array) where each part ends. Then, for each of the 2^16 part, we repeat the scheme, but now we put the next 2 bytes of the transaction hash in the most significant bytes of the `uint64` number (basically, bytes [2:4]). Then we sort all the parts separately. And so on, recursively. To save memory on memorising where each part ends, we might want to do depth-first recursion. In the end of the process, we should get the list of pairs `(block_number, tx_index)` sorted by transaction hash. So then we simply create the bucket `l` and write the entries into it in the sorted order, reducing the write amplification greatly.\r\n",
  "closed_by": {
    "login": "AlexeyAkhunov",
    "id": 13686139,
    "node_id": "MDQ6VXNlcjEzNjg2MTM5",
    "avatar_url": "https://avatars.githubusercontent.com/u/13686139?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/AlexeyAkhunov",
    "html_url": "https://github.com/AlexeyAkhunov",
    "followers_url": "https://api.github.com/users/AlexeyAkhunov/followers",
    "following_url": "https://api.github.com/users/AlexeyAkhunov/following{/other_user}",
    "gists_url": "https://api.github.com/users/AlexeyAkhunov/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/AlexeyAkhunov/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/AlexeyAkhunov/subscriptions",
    "organizations_url": "https://api.github.com/users/AlexeyAkhunov/orgs",
    "repos_url": "https://api.github.com/users/AlexeyAkhunov/repos",
    "events_url": "https://api.github.com/users/AlexeyAkhunov/events{/privacy}",
    "received_events_url": "https://api.github.com/users/AlexeyAkhunov/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/335/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/335/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/590823027",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/335#issuecomment-590823027",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/335",
    "id": 590823027,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU5MDgyMzAyNw==",
    "user": {
      "login": "AlexeyAkhunov",
      "id": 13686139,
      "node_id": "MDQ6VXNlcjEzNjg2MTM5",
      "avatar_url": "https://avatars.githubusercontent.com/u/13686139?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AlexeyAkhunov",
      "html_url": "https://github.com/AlexeyAkhunov",
      "followers_url": "https://api.github.com/users/AlexeyAkhunov/followers",
      "following_url": "https://api.github.com/users/AlexeyAkhunov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AlexeyAkhunov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AlexeyAkhunov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AlexeyAkhunov/subscriptions",
      "organizations_url": "https://api.github.com/users/AlexeyAkhunov/orgs",
      "repos_url": "https://api.github.com/users/AlexeyAkhunov/repos",
      "events_url": "https://api.github.com/users/AlexeyAkhunov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AlexeyAkhunov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-02-25T11:34:00Z",
    "updated_at": "2020-02-25T11:34:00Z",
    "author_association": "CONTRIBUTOR",
    "body": "Using RP 349 as a base, I created two function in the `download_fix` branch to test the tx sorting idea:\r\nhttps://github.com/ledgerwatch/turbo-geth/blob/926c952434ec2c34dfd8a7ba2c6ae7acc74f568a/cmd/hack/hack.go#L1390\r\n\r\nthis first function tries to sort transaction as described above.\r\n\r\nhttps://github.com/ledgerwatch/turbo-geth/blob/926c952434ec2c34dfd8a7ba2c6ae7acc74f568a/cmd/hack/hack.go#L1526\r\n\r\nThe second function simply inserts tx lookup entries as they are read from blocks.\r\n\r\nIt turns out that the \"naive\" approach is much faster. It took 26 hours 48 minutes (file `blocks1.log`). I had to stop the proposed approach after 2 days of running (file `blocks.log`).\r\n\r\nblocks.log:\r\n````\r\nINFO [02-19|22:41:10.664] Open databased and deleted tx lookup bucket duration=2.560916704s\r\nINFO [02-19|22:41:19.199] Processed                                blocks=100000 tx count=26970\r\nINFO [02-19|22:41:19.199] Memory                                   alloc=131247 sys=344600 numGC=7\r\nINFO [02-19|22:41:28.848] Processed                                blocks=200000 tx count=121793\r\nINFO [02-19|22:41:28.848] Memory                                   alloc=99765  sys=344600 numGC=14\r\n...\r\nINFO [02-19|23:07:18.769] Processed                                blocks=4600000 tx count=85859035\r\nINFO [02-19|23:07:18.780] Memory                                   alloc=873322  sys=3481405 numGC=723\r\nINFO [02-19|23:09:50.330] Processed                                blocks=4700000 tx count=96539796\r\nINFO [02-19|23:09:50.331] Memory                                   alloc=1583040 sys=3481725 numGC=751\r\nINFO [02-19|23:10:36.712] Reached specified number of transactions \r\nINFO [02-19|23:10:36.712] Processed                                blocks=4725003 tx count=100000164\r\nINFO [02-19|23:10:36.712] Filling up lookup array done             duration=29m26.047848569s\r\nINFO [02-19|23:11:06.937] Sorting lookup array done                duration=30.224687666s\r\nINFO [02-19|23:22:11.445] Processed                                transactions=1000000\r\nINFO [02-19|23:32:37.118] Processed                                transactions=2000000\r\nINFO [02-19|23:42:55.298] Processed                                transactions=3000000\r\n...\r\nINFO [02-20|16:30:48.599] Processed                                transactions=98000000\r\nINFO [02-20|16:41:28.692] Processed                                transactions=99000000\r\nINFO [02-20|16:52:07.701] Processed                                transactions=100000000\r\nINFO [02-20|16:52:08.671] Second roung of sorting done             duration=17h41m1.733607287s\r\nINFO [02-20|17:03:20.111] Commited                                 transactions=1000000\r\nINFO [02-20|17:14:49.165] Commited                                 transactions=2000000\r\nINFO [02-20|17:26:24.978] Commited                                 transactions=3000000\r\n...\r\nINFO [02-21|11:48:47.800] Commited                                 transactions=99000000\r\nINFO [02-21|12:00:12.968] Commited                                 transactions=100000000\r\nINFO [02-21|12:00:13.140] Commited                                 transactions=100000164\r\nINFO [02-21|12:00:13.140] Tx committing done                       duration=19h8m4.372027165s\r\nINFO [02-21|12:02:47.962] Processed                                blocks=4800000 tx count=12117048\r\nINFO [02-21|12:02:48.021] Memory                                   alloc=193011  sys=4517802 numGC=23192\r\nINFO [02-21|12:06:52.421] Processed                                blocks=4900000 tx count=32167567\r\nINFO [02-21|12:06:52.433] Memory                                   alloc=570640  sys=4517802 numGC=23385\r\nINFO [02-21|12:10:38.987] Processed                                blocks=5000000 tx count=49859933\r\nINFO [02-21|12:10:39.010] Memory                                   alloc=732387  sys=4517802 numGC=23484\r\nINFO [02-21|12:13:39.816] Processed                                blocks=5100000 tx count=63819046\r\nINFO [02-21|12:13:39.817] Memory                                   alloc=782315  sys=4517802 numGC=23543\r\nINFO [02-21|12:16:31.635] Processed                                blocks=5200000 tx count=76434497\r\nINFO [02-21|12:16:31.636] Memory                                   alloc=1099200 sys=4517802 numGC=23585\r\nINFO [02-21|12:19:12.887] Processed                                blocks=5300000 tx count=87828603\r\nINFO [02-21|12:19:12.900] Memory                                   alloc=1160346 sys=4517802 numGC=23619\r\nINFO [02-21|12:21:37.013] Processed                                blocks=5400000 tx count=97939340\r\nINFO [02-21|12:21:37.013] Memory                                   alloc=945602  sys=4517802 numGC=23647\r\nINFO [02-21|12:22:07.339] Reached specified number of transactions \r\nINFO [02-21|12:22:07.380] Processed                                blocks=5420741 tx count=100000164\r\nINFO [02-21|12:22:07.380] Filling up lookup array done             duration=21m54.192118416s\r\nINFO [02-21|12:22:38.013] Sorting lookup array done                duration=30.63267101s\r\nINFO [02-21|12:41:27.576] Processed                                transactions=1000000\r\nINFO [02-21|12:57:48.071] Processed                                transactions=2000000\r\nINFO [02-21|13:14:00.481] Processed                                transactions=3000000\r\nINFO [02-21|13:30:14.661] Processed                                transactions=4000000\r\n...\r\nINFO [02-22|06:26:07.245] Processed                                transactions=67000000\r\nINFO [02-22|06:42:10.677] Processed                                transactions=68000000\r\nINFO [02-22|06:58:05.276] Processed                                transactions=69000000\r\nINFO [02-22|07:14:00.114] Processed                                transactions=70000000\r\nINFO [02-22|07:30:00.967] Processed                                transactions=71000000\r\nINFO [02-22|07:45:49.882] Processed                                transactions=72000000\r\n````\r\n\r\nblocks1.log\r\n\r\n````\r\nINFO [02-22|08:00:39.536] Open databased and deleted tx lookup bucket duration=1m39.763831363s\r\nINFO [02-22|08:00:47.792] Processed                                blocks=100000\r\nINFO [02-22|08:00:47.792] Memory                                   alloc=96102 sys=209316 numGC=25\r\nINFO [02-22|08:00:57.930] Processed                                blocks=200000\r\nINFO [02-22|08:00:57.930] Memory                                   alloc=118623 sys=277222 numGC=32\r\nINFO [02-22|08:01:08.583] Processed                                blocks=300000\r\nINFO [02-22|08:01:08.583] Memory                                   alloc=89076  sys=277526 numGC=40\r\nINFO [02-22|08:01:21.472] Processed                                blocks=400000\r\nINFO [02-22|08:01:21.472] Memory                                   alloc=140502 sys=345432 numGC=48\r\nINFO [02-22|08:01:34.099] Processed                                blocks=500000\r\nINFO [02-22|08:01:34.099] Memory                                   alloc=258938 sys=483216 numGC=57\r\n...\r\nINFO [02-23|09:59:16.712] Commited                                 transactions=597000000\r\nINFO [02-23|10:02:59.817] Commited                                 transactions=598000000\r\nINFO [02-23|10:06:41.343] Commited                                 transactions=599000000\r\nINFO [02-23|10:10:22.016] Commited                                 transactions=600000000\r\nINFO [02-23|10:13:42.120] Processed                                blocks=9100000\r\nINFO [02-23|10:13:42.146] Memory                                   alloc=2701429 sys=5166526 numGC=12889\r\nINFO [02-23|10:14:02.243] Commited                                 transactions=601000000\r\nINFO [02-23|10:17:47.625] Commited                                 transactions=602000000\r\nINFO [02-23|10:21:30.966] Commited                                 transactions=603000000\r\nINFO [02-23|10:25:03.366] Commited                                 transactions=604000000\r\nINFO [02-23|10:28:48.747] Commited                                 transactions=605000000\r\nINFO [02-23|10:32:30.618] Commited                                 transactions=606000000\r\nINFO [02-23|10:36:04.413] Commited                                 transactions=607000000\r\nINFO [02-23|10:39:52.300] Commited                                 transactions=608000000\r\nINFO [02-23|10:43:28.925] Commited                                 transactions=609000000\r\nINFO [02-23|10:47:05.938] Commited                                 transactions=610000000\r\nINFO [02-23|10:49:33.281] Commited                                 transactions=610652406\r\nINFO [02-23|10:49:33.281] Processed                                blocks=9184416\r\nINFO [02-23|10:49:33.317] Tx committing done                       duration=26h48m53.781211394s\r\n````\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/590823027/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
