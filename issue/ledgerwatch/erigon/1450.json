{
  "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/1450",
  "repository_url": "https://api.github.com/repos/ledgerwatch/erigon",
  "labels_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/1450/labels{/name}",
  "comments_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/1450/comments",
  "events_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/1450/events",
  "html_url": "https://github.com/ledgerwatch/erigon/issues/1450",
  "id": 792238857,
  "node_id": "MDU6SXNzdWU3OTIyMzg4NTc=",
  "number": 1450,
  "title": "rpcdaemon sending invalid responses",
  "user": {
    "login": "MysticRyuujin",
    "id": 8877131,
    "node_id": "MDQ6VXNlcjg4NzcxMzE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/8877131?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/MysticRyuujin",
    "html_url": "https://github.com/MysticRyuujin",
    "followers_url": "https://api.github.com/users/MysticRyuujin/followers",
    "following_url": "https://api.github.com/users/MysticRyuujin/following{/other_user}",
    "gists_url": "https://api.github.com/users/MysticRyuujin/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/MysticRyuujin/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/MysticRyuujin/subscriptions",
    "organizations_url": "https://api.github.com/users/MysticRyuujin/orgs",
    "repos_url": "https://api.github.com/users/MysticRyuujin/repos",
    "events_url": "https://api.github.com/users/MysticRyuujin/events{/privacy}",
    "received_events_url": "https://api.github.com/users/MysticRyuujin/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1378917657,
      "node_id": "MDU6TGFiZWwxMzc4OTE3NjU3",
      "url": "https://api.github.com/repos/ledgerwatch/erigon/labels/help%20wanted",
      "name": "help wanted",
      "color": "008672",
      "default": true,
      "description": "Extra attention is needed"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2021-01-22T19:06:41Z",
  "updated_at": "2022-05-27T05:08:10Z",
  "closed_at": "2022-05-27T05:08:10Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "I've been wracking my brain trying to figure out why `haproxy` is complaining that `rpcdaemon` is sending invalid responses.\r\n\r\nI've finally narrowed it down to the exact bytes that `haproxy` is seeing in the reply that it doesn't like...\r\n\r\nIn the below haproxy debugs you will see that it says `error at position 130` which coresponds to this line `  00130  d8930676\\r\\n` and I have absolutely no idea what that is...so I'm kinda stuck not knowing how I might resolve this. Was hoping someone would have some idea what that is.\r\n\r\nEven wireshark is telling me that the response is a malformed packet and does not parse the response correctly...\r\n\r\n![image](https://user-images.githubusercontent.com/8877131/105533790-3949bd00-5cb2-11eb-8071-767ec09c69c5.png)\r\n\r\n![image](https://user-images.githubusercontent.com/8877131/105533822-436bbb80-5cb2-11eb-93c0-b04fc0e89b19.png)\r\n\r\nThe curl command that reproduces this is quite ridiculous (the output is 3.4GB) but it's here:\r\n```\r\ncurl -X POST  -H 'Content-Type: application/json' --data '{\"jsonrpc\":\"2.0\",\"method\":\"debug_traceTransaction\",\"params\":[\"0x7a97e47f9399b46c3e8ee444778763a4f331fa182b5c28c1ba98709721f71f7d\"],\"id\":1}'\r\n```\r\n\r\nhaproxy error debug:\r\n```\r\nTotal events captured on [22/Jan/2021:18:41:25.300] : 1\r\n \r\n[22/Jan/2021:18:41:20.864] backend turbogeth (#11): invalid response\r\n  frontend http-https-in (#2), server archive04 (#2), event #0, src <redacted>:39386\r\n  buffer starts at 0 (including 0 out), 14936 free,\r\n  len 1448, wraps at 16336, error at position 130\r\n  H1 connection flags 0x00000000, H1 stream flags 0x00004014\r\n  H1 msg state MSG_CHUNK_SIZE(26), H1 msg flags 0x00001716\r\n  H1 chunk len 0 bytes, H1 body len 0 bytes :\r\n  \r\n  00000  HTTP/1.1 200 OK\\r\\n\r\n  00017  Content-Type: application/json\\r\\n\r\n  00049  Vary: Origin\\r\\n\r\n  00063  Date: Fri, 22 Jan 2021 18:41:20 GMT\\r\\n\r\n  00100  Transfer-Encoding: chunked\\r\\n\r\n  00128  \\r\\n\r\n  00130  d8930676\\r\\n\r\n  00140  {\"jsonrpc\":\"2.0\",\"id\":1,\"result\":{\"gas\":4300872,\"failed\":false,\"return\r\n  00210+ Value\":\"\",\"structLogs\":[{\"pc\":0,\"op\":\"CALLDATASIZE\",\"gas\":5810070,\"gas\r\n  00280+ Cost\":2,\"depth\":1,\"stack\":[],\"memory\":[],\"storage\":{}},{\"pc\":1,\"op\":\"R\r\n  00350+ ETURNDATASIZE\",\"gas\":5810068,\"gasCost\":2,\"depth\":1,\"stack\":[\"000000000\r\n  00420+ 0000000000000000000000000000000000000000000000000000b24\"],\"memory\":[],\r\n  00490+ \"storage\":{}},{\"pc\":2,\"op\":\"RETURNDATASIZE\",\"gas\":5810066,\"gasCost\":2,\r\n  00560+ \"depth\":1,\"stack\":[\"00000000000000000000000000000000000000000000000000\r\n  00630+ 00000000000b24\",\"00000000000000000000000000000000000000000000000000000\r\n  00700+ 00000000000\"],\"memory\":[],\"storage\":{}},{\"pc\":3,\"op\":\"CALLDATACOPY\",\"g\r\n  00770+ as\":5810064,\"gasCost\":558,\"depth\":1,\"stack\":[\"000000000000000000000000\r\n  00840+ 0000000000000000000000000000000000000b24\",\"000000000000000000000000000\r\n  00910+ 0000000000000000000000000000000000000\",\"000000000000000000000000000000\r\n  00980+ 0000000000000000000000000000000000\"],\"memory\":[\"0000000000000000000000\r\n  01050+ 000000000000000000000000000000000000000000\",\"0000000000000000000000000\r\n  01120+ 000000000000000000000000000000000000000\",\"0000000000000000000000000000\r\n  01190+ 000000000000000000000000000000000000\",\"0000000000000000000000000000000\r\n  01260+ 000000000000000000000000000000000\",\"0000000000000000000000000000000000\r\n  01330+ 000000000000000000000000000000\",\"0000000000000000000000000000000000000\r\n  01400+ 000000000000000000000000000\",\"000000000000000000\r\n```",
  "closed_by": {
    "login": "AskAlexSharov",
    "id": 46885206,
    "node_id": "MDQ6VXNlcjQ2ODg1MjA2",
    "avatar_url": "https://avatars.githubusercontent.com/u/46885206?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/AskAlexSharov",
    "html_url": "https://github.com/AskAlexSharov",
    "followers_url": "https://api.github.com/users/AskAlexSharov/followers",
    "following_url": "https://api.github.com/users/AskAlexSharov/following{/other_user}",
    "gists_url": "https://api.github.com/users/AskAlexSharov/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/AskAlexSharov/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/AskAlexSharov/subscriptions",
    "organizations_url": "https://api.github.com/users/AskAlexSharov/orgs",
    "repos_url": "https://api.github.com/users/AskAlexSharov/repos",
    "events_url": "https://api.github.com/users/AskAlexSharov/events{/privacy}",
    "received_events_url": "https://api.github.com/users/AskAlexSharov/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/1450/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/1450/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/765682792",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/1450#issuecomment-765682792",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/1450",
    "id": 765682792,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc2NTY4Mjc5Mg==",
    "user": {
      "login": "MysticRyuujin",
      "id": 8877131,
      "node_id": "MDQ6VXNlcjg4NzcxMzE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8877131?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MysticRyuujin",
      "html_url": "https://github.com/MysticRyuujin",
      "followers_url": "https://api.github.com/users/MysticRyuujin/followers",
      "following_url": "https://api.github.com/users/MysticRyuujin/following{/other_user}",
      "gists_url": "https://api.github.com/users/MysticRyuujin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MysticRyuujin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MysticRyuujin/subscriptions",
      "organizations_url": "https://api.github.com/users/MysticRyuujin/orgs",
      "repos_url": "https://api.github.com/users/MysticRyuujin/repos",
      "events_url": "https://api.github.com/users/MysticRyuujin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MysticRyuujin/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-01-22T21:03:41Z",
    "updated_at": "2021-01-22T21:23:14Z",
    "author_association": "CONTRIBUTOR",
    "body": "tx `0x7bc310ccc81f328b22d1acc5b2b69e4e12b6b8d5ebfaa4d927574430487b13a9` results in the same behavior but the bytes before the json body are different. From my Google searching this is the chunk size. So it seems to be perfectly valid...\r\n\r\nI also noticed that normal transactions are not chunked. I wonder if this is specific only to responses that are chunked?",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/765682792/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/765713160",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/1450#issuecomment-765713160",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/1450",
    "id": 765713160,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc2NTcxMzE2MA==",
    "user": {
      "login": "MysticRyuujin",
      "id": 8877131,
      "node_id": "MDQ6VXNlcjg4NzcxMzE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8877131?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MysticRyuujin",
      "html_url": "https://github.com/MysticRyuujin",
      "followers_url": "https://api.github.com/users/MysticRyuujin/followers",
      "following_url": "https://api.github.com/users/MysticRyuujin/following{/other_user}",
      "gists_url": "https://api.github.com/users/MysticRyuujin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MysticRyuujin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MysticRyuujin/subscriptions",
      "organizations_url": "https://api.github.com/users/MysticRyuujin/orgs",
      "repos_url": "https://api.github.com/users/MysticRyuujin/repos",
      "events_url": "https://api.github.com/users/MysticRyuujin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MysticRyuujin/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-01-22T22:11:38Z",
    "updated_at": "2021-01-22T22:11:38Z",
    "author_association": "CONTRIBUTOR",
    "body": "I'm starting to suspect that this is an haproxy issue and not an rpcdaemon issue. I'll open an issue on their forums.",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/765713160/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/765797116",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/1450#issuecomment-765797116",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/1450",
    "id": 765797116,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc2NTc5NzExNg==",
    "user": {
      "login": "MysticRyuujin",
      "id": 8877131,
      "node_id": "MDQ6VXNlcjg4NzcxMzE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8877131?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MysticRyuujin",
      "html_url": "https://github.com/MysticRyuujin",
      "followers_url": "https://api.github.com/users/MysticRyuujin/followers",
      "following_url": "https://api.github.com/users/MysticRyuujin/following{/other_user}",
      "gists_url": "https://api.github.com/users/MysticRyuujin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MysticRyuujin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MysticRyuujin/subscriptions",
      "organizations_url": "https://api.github.com/users/MysticRyuujin/orgs",
      "repos_url": "https://api.github.com/users/MysticRyuujin/repos",
      "events_url": "https://api.github.com/users/MysticRyuujin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MysticRyuujin/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-01-23T00:23:40Z",
    "updated_at": "2021-01-23T00:24:14Z",
    "author_association": "CONTRIBUTOR",
    "body": "HAProxy does not support chunk sizes larger than 2GB - I've filed a feature request to them but god only knows if they'll do it, or when...\r\n\r\nAccording to some of the go forms I've read this can be avoided by simply setting the Content-Length header before sending it off to the net/http server. I don't know if that's an option here?\r\n\r\n```go\r\n...\r\n        // Check for an explicit (and valid) Content-Length header.\r\n\thasCL := w.contentLength != -1\r\n...\r\n        if w.req.Method == \"HEAD\" || !bodyAllowedForStatus(code) {\r\n\t\t// do nothing\r\n\t} else if code == StatusNoContent {\r\n\t\tdelHeader(\"Transfer-Encoding\")\r\n\t} else if hasCL {\r\n\t\tdelHeader(\"Transfer-Encoding\")\r\n\t} else if w.req.ProtoAtLeast(1, 1) {\r\n\t\t// HTTP/1.1 or greater: Transfer-Encoding has been set to identity, and no\r\n\t\t// content-length has been provided. The connection must be closed after the\r\n\t\t// reply is written, and no chunking is to be done. This is the setup\r\n\t\t// recommended in the Server-Sent Events candidate recommendation 11,\r\n\t\t// section 8.\r\n\t\tif hasTE && te == \"identity\" {\r\n\t\t\tcw.chunking = false\r\n\t\t\tw.closeAfterReply = true\r\n\t\t} else {\r\n\t\t\t// HTTP/1.1 or greater: use chunked transfer encoding\r\n\t\t\t// to avoid closing the connection at EOF.\r\n\t\t\tcw.chunking = true\r\n\t\t\tsetHeader.transferEncoding = \"chunked\"\r\n\t\t\tif hasTE && te == \"chunked\" {\r\n\t\t\t\t// We will send the chunked Transfer-Encoding header later.\r\n\t\t\t\tdelHeader(\"Transfer-Encoding\")\r\n\t\t\t}\r\n\t\t}\r\n\t} else {\r\n\t\t// HTTP version < 1.1: cannot do chunked transfer\r\n\t\t// encoding and we don't know the Content-Length so\r\n\t\t// signal EOF by closing connection.\r\n\t\tw.closeAfterReply = true\r\n\t\tdelHeader(\"Transfer-Encoding\") // in case already set\r\n\t}\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/765797116/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/776902373",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/1450#issuecomment-776902373",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/1450",
    "id": 776902373,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc3NjkwMjM3Mw==",
    "user": {
      "login": "AlexeyAkhunov",
      "id": 13686139,
      "node_id": "MDQ6VXNlcjEzNjg2MTM5",
      "avatar_url": "https://avatars.githubusercontent.com/u/13686139?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AlexeyAkhunov",
      "html_url": "https://github.com/AlexeyAkhunov",
      "followers_url": "https://api.github.com/users/AlexeyAkhunov/followers",
      "following_url": "https://api.github.com/users/AlexeyAkhunov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AlexeyAkhunov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AlexeyAkhunov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AlexeyAkhunov/subscriptions",
      "organizations_url": "https://api.github.com/users/AlexeyAkhunov/orgs",
      "repos_url": "https://api.github.com/users/AlexeyAkhunov/repos",
      "events_url": "https://api.github.com/users/AlexeyAkhunov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AlexeyAkhunov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-02-10T18:02:55Z",
    "updated_at": "2021-02-10T18:02:55Z",
    "author_association": "CONTRIBUTOR",
    "body": "> I don't know if that's an option here?\r\n\r\nDefinitely an option, just need to find where to put it :)",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/776902373/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
