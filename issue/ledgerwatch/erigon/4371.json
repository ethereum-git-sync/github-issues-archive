{
  "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/4371",
  "repository_url": "https://api.github.com/repos/ledgerwatch/erigon",
  "labels_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/4371/labels{/name}",
  "comments_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/4371/comments",
  "events_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/4371/events",
  "html_url": "https://github.com/ledgerwatch/erigon/issues/4371",
  "id": 1261027660,
  "node_id": "I_kwDOC0FsAM5LKcFM",
  "number": 4371,
  "title": "Erigon can't stop wasting CPU",
  "user": {
    "login": "anonqoder",
    "id": 76815541,
    "node_id": "MDQ6VXNlcjc2ODE1NTQx",
    "avatar_url": "https://avatars.githubusercontent.com/u/76815541?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/anonqoder",
    "html_url": "https://github.com/anonqoder",
    "followers_url": "https://api.github.com/users/anonqoder/followers",
    "following_url": "https://api.github.com/users/anonqoder/following{/other_user}",
    "gists_url": "https://api.github.com/users/anonqoder/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/anonqoder/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/anonqoder/subscriptions",
    "organizations_url": "https://api.github.com/users/anonqoder/orgs",
    "repos_url": "https://api.github.com/users/anonqoder/repos",
    "events_url": "https://api.github.com/users/anonqoder/events{/privacy}",
    "received_events_url": "https://api.github.com/users/anonqoder/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2022-06-05T11:36:57Z",
  "updated_at": "2022-06-06T10:16:57Z",
  "closed_at": "2022-06-06T05:43:52Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "erigon version ```2022.05.8-alpha-1d2551e0```\r\n\r\nerigon  --chain=goerli --datadir=/home/data/ethereum/testnet/execution/erigon  --syncmode=snap --prune=hrtc\r\n  \r\nWent through the sync:\r\n\r\n```\r\nJun 04 12:21:54 endor erigon[3401112]: [INFO] [06-04|12:21:54.138] [1/16 Headers] DONE                      in=1h18m34.677848507s\r\nJun 04 12:57:21 endor erigon[3401112]: [INFO] [06-04|12:57:21.990] [4/16 Bodies] DONE                       in=35m21.111533732s\r\nJun 05 00:25:31 endor erigon[3401112]: [INFO] [06-05|00:25:31.911] [6/16 Execution] DONE                    in=11h28m6.209043187s\r\nJun 05 00:41:28 endor erigon[3401112]: [INFO] [06-05|00:41:28.905] [8/16 HashState] DONE                    in=15m56.993899904s\r\nJun 05 00:48:54 endor erigon[3401112]: [INFO] [06-05|00:48:54.002] [9/16 IntermediateHashes] DONE           in=7m25.096978592s\r\nJun 05 00:51:38 endor erigon[3401112]: [INFO] [06-05|00:51:38.845] [13/16 LogIndex] DONE                    in=1m0.545470804s\r\nJun 05 00:55:51 endor erigon[3401112]: [INFO] [06-05|00:55:51.403] [14/16 TxLookup] DONE                    in=4m12.557379725s\r\n```\r\n\r\nTook roughly 12h, but after it can't stop using the CPU to do what seems to be useless processing over and over (concurrently with other normal operations)\r\n\r\n```\r\nJun 05 00:55:51 endor erigon[3401112]: [INFO] [06-05|00:55:51.444] [snapshots] Retire Blocks                range=6500k-6600k\r\nJun 05 00:56:11 endor erigon[3401112]: [INFO] [06-05|00:56:11.545] [snapshots] Dumping txs                  block num=6500758 alloc=1.6Gb sys=11.8Gb\r\n...\r\nJun 05 02:11:11 endor erigon[3401112]: [INFO] [06-05|02:11:11.469] [snapshots] Dumping txs                  block num=6598507 alloc=2.3Gb sys=11.8Gb\r\nJun 05 02:11:32 endor erigon[3401112]: [INFO] [06-05|02:11:32.643] [snapshots] Dumping txs                  block num=6599469 alloc=1.5Gb sys=11.8Gb\r\nJun 05 02:12:49 endor erigon[3401112]: [INFO] [06-05|02:12:49.859] [Transactions] Replacement preprocessing processed=0.93% alloc=2.3Gb sys=11.8Gb\r\nJun 05 02:13:09 endor erigon[3401112]: [INFO] [06-05|02:13:09.859] [Transactions] Replacement preprocessing processed=1.58% alloc=2.3Gb sys=11.8Gb\r\n...\r\nJun 05 03:15:09 endor erigon[3401112]: [INFO] [06-05|03:15:09.893] [Transactions] Replacement preprocessing processed=98.58% alloc=1.8Gb sys=11.8Gb\r\nJun 05 03:15:29 endor erigon[3401112]: [INFO] [06-05|03:15:29.861] [Transactions] Replacement preprocessing processed=98.97% alloc=1.8Gb sys=11.8Gb\r\nJun 05 03:15:49 endor erigon[3401112]: [INFO] [06-05|03:15:49.858] [Transactions] Replacement preprocessing processed=99.72% alloc=1.9Gb sys=11.8Gb\r\nJun 05 03:16:39 endor erigon[3401112]: [INFO] [06-05|03:16:39.188] [snapshots] Compression                  ratio=2.68 file=v1-006500-006600-transactions\r\nJun 05 03:17:02 endor erigon[3401112]: [INFO] [06-05|03:17:02.939] [snapshots] Dumping headers              block num=6596115 alloc=1.6Gb sys=11.8Gb\r\nJun 05 03:17:41 endor erigon[3401112]: [INFO] [06-05|03:17:41.023] [Headers] Replacement preprocessing      processed=76.51% alloc=2.0Gb sys=11.8Gb\r\nJun 05 03:17:49 endor erigon[3401112]: [INFO] [06-05|03:17:49.131] [snapshots] Build indices                from=6499999\r\nJun 05 03:19:25 endor erigon[3401112]: [INFO] [06-05|03:19:25.597] [snapshots] Retire Blocks                range=6500k-6600k\r\nJun 05 03:19:45 endor erigon[3401112]: [INFO] [06-05|03:19:45.607] [snapshots] Dumping txs                  block num=6500787 alloc=1.8Gb sys=11.8Gb\r\nJun 05 03:20:05 endor erigon[3401112]: [INFO] [06-05|03:20:05.598] [snapshots] Dumping txs                  block num=6501163 alloc=1.3Gb sys=11.8Gb\r\n...\r\nJun 05 04:34:08 endor erigon[3401112]: [INFO] [06-05|04:34:08.112] [snapshots] Dumping txs                  block num=6598467 alloc=1.7Gb sys=11.8Gb\r\nJun 05 04:34:25 endor erigon[3401112]: [INFO] [06-05|04:34:25.600] [snapshots] Dumping txs                  block num=6599028 alloc=2.2Gb sys=11.8Gb\r\nJun 05 04:35:49 endor erigon[3401112]: [INFO] [06-05|04:35:49.851] [Transactions] Replacement preprocessing processed=0.93% alloc=2.8Gb sys=11.8Gb\r\nJun 05 04:36:09 endor erigon[3401112]: [INFO] [06-05|04:36:09.856] [Transactions] Replacement preprocessing processed=1.60% alloc=2.9Gb sys=11.8Gb\r\nJun 05 04:36:29 endor erigon[3401112]: [INFO] [06-05|04:36:29.881] [Transactions] Replacement preprocessing processed=2.26% alloc=3.0Gb sys=11.8Gb\r\n...\r\nJun 05 05:38:29 endor erigon[3401112]: [INFO] [06-05|05:38:29.852] [Transactions] Replacement preprocessing processed=99.90% alloc=2.0Gb sys=11.8Gb\r\nJun 05 05:39:11 endor erigon[3401112]: [INFO] [06-05|05:39:11.297] [snapshots] Compression                  ratio=2.68 file=v1-006500-006600-transactions\r\nJun 05 05:39:34 endor erigon[3401112]: [INFO] [06-05|05:39:34.364] [snapshots] Dumping headers              block num=6596115 alloc=1.8Gb sys=11.8Gb\r\nJun 05 05:40:11 endor erigon[3401112]: [INFO] [06-05|05:40:11.723] [Headers] Replacement preprocessing      processed=79.95% alloc=2.1Gb sys=11.8Gb\r\nJun 05 05:40:18 endor erigon[3401112]: [INFO] [06-05|05:40:18.414] [snapshots] Build indices                from=6599999\r\nJun 05 05:40:21 endor erigon[3401112]: [INFO] [06-05|05:40:21.525] [snapshots] Retire Blocks                range=6600k-6700k\r\nJun 05 05:40:43 endor erigon[3401112]: [INFO] [06-05|05:40:43.262] [snapshots] Dumping txs                  block num=6600668 alloc=1.8Gb sys=11.8Gb\r\nJun 05 05:41:04 endor erigon[3401112]: [INFO] [06-05|05:41:04.173] [snapshots] Dumping txs                  block num=6600969 alloc=1.6Gb sys=11.8Gb\r\n...\r\nJun 05 07:15:22 endor erigon[3401112]: [INFO] [06-05|07:15:22.939] [snapshots] Dumping txs                  block num=6699981 alloc=2.8Gb sys=11.8Gb\r\nJun 05 07:16:28 endor erigon[3401112]: [INFO] [06-05|07:16:28.869] [Transactions] Replacement preprocessing processed=0.22% alloc=3.0Gb sys=11.8Gb\r\nJun 05 07:16:48 endor erigon[3401112]: [INFO] [06-05|07:16:48.886] [Transactions] Replacement preprocessing processed=0.38% alloc=3.1Gb sys=11.8Gb\r\nJun 05 07:17:08 endor erigon[3401112]: [INFO] [06-05|07:17:08.891] [Transactions] Replacement preprocessing processed=0.51% alloc=3.1Gb sys=11.8Gb\r\n...\r\nJun 05 08:25:08 endor erigon[3401112]: [INFO] [06-05|08:25:08.941] [Transactions] Replacement preprocessing processed=90.36% alloc=2.2Gb sys=11.8Gb\r\nJun 05 08:26:11 endor erigon[3594447]: [INFO] [06-05|08:26:11.834] [snapshots] Retire Blocks                range=6600k-6700k\r\nJun 05 08:26:33 endor erigon[3594447]: [INFO] [06-05|08:26:33.248] [snapshots] Dumping txs                  block num=6600668 alloc=1.3Gb sys=1.6Gb\r\nJun 05 08:26:53 endor erigon[3594447]: [INFO] [06-05|08:26:53.929] [snapshots] Dumping txs                  block num=6600969 alloc=1.3Gb sys=1.7Gb\r\n...\r\nJun 05 10:29:44 endor erigon[3600537]: [INFO] [06-05|10:29:44.804] [snapshots] Dumping txs                  block num=6699633 alloc=1.7Gb sys=2.8Gb\r\nJun 05 10:30:04 endor erigon[3600537]: [INFO] [06-05|10:30:04.295] [snapshots] Dumping txs                  block num=6699783 alloc=2.1Gb sys=2.8Gb\r\nJun 05 10:31:15 endor erigon[3600537]: [INFO] [06-05|10:31:15.612] [Transactions] Replacement preprocessing processed=0.23% alloc=1.8Gb sys=3.3Gb\r\nJun 05 10:31:35 endor erigon[3600537]: [INFO] [06-05|10:31:35.616] [Transactions] Replacement preprocessing processed=0.39% alloc=1.8Gb sys=3.3Gb\r\n...\r\nJun 05 11:44:55 endor erigon[3600537]: [INFO] [06-05|11:44:55.583] [Transactions] Replacement preprocessing processed=99.19% alloc=2.0Gb sys=3.3Gb\r\nJun 05 11:45:15 endor erigon[3600537]: [INFO] [06-05|11:45:15.586] [Transactions] Replacement preprocessing processed=99.43% alloc=1.6Gb sys=3.3Gb\r\nJun 05 11:45:35 endor erigon[3600537]: [INFO] [06-05|11:45:35.586] [Transactions] Replacement preprocessing processed=99.68% alloc=1.7Gb sys=3.3Gb\r\nJun 05 11:46:36 endor erigon[3600537]: [INFO] [06-05|11:46:36.753] [snapshots] Compression                  ratio=2.30 file=v1-006600-006700-transactions\r\nJun 05 11:46:58 endor erigon[3600537]: [INFO] [06-05|11:46:58.596] [snapshots] Dumping headers              block num=6696123 alloc=1.5Gb sys=3.8Gb\r\nJun 05 11:47:34 endor erigon[3600537]: [INFO] [06-05|11:47:34.605] [Headers] Replacement preprocessing      processed=82.78% alloc=1.8Gb sys=3.8Gb\r\nJun 05 11:47:40 endor erigon[3600537]: [INFO] [06-05|11:47:40.388] [snapshots] Build indices                from=6599999\r\nJun 05 11:49:31 endor erigon[3600537]: [INFO] [06-05|11:49:31.129] [snapshots] Retire Blocks                range=6600k-6700k\r\nJun 05 11:49:54 endor erigon[3600537]: [INFO] [06-05|11:49:54.111] [snapshots] Dumping txs                  block num=6600731 alloc=1.2Gb sys=3.8Gb\r\nJun 05 11:50:12 endor erigon[3600537]: [INFO] [06-05|11:50:12.279] [snapshots] Dumping txs                  block num=6601035 alloc=1.9Gb sys=3.8Gb\r\n...\r\nJun 05 12:29:11 endor erigon[3600537]: [INFO] [06-05|12:29:11.590] [snapshots] Dumping txs                  block num=6642738 alloc=2.6Gb sys=4.5Gb\r\n```\r\n\r\n\r\nIt's been going on in this cycle of 'Dumping Txs' and 'Replacement preprocessing' for over 12h now, and the logs suggest it is redoing some work for no reason: I have seen at least five occurrences of ```range=6600k-6700k```. The main issues is there is one CPU being maxed out only for this\r\n\r\nWhat is going on? \r\n\r\n\r\n\r\n",
  "closed_by": {
    "login": "anonqoder",
    "id": 76815541,
    "node_id": "MDQ6VXNlcjc2ODE1NTQx",
    "avatar_url": "https://avatars.githubusercontent.com/u/76815541?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/anonqoder",
    "html_url": "https://github.com/anonqoder",
    "followers_url": "https://api.github.com/users/anonqoder/followers",
    "following_url": "https://api.github.com/users/anonqoder/following{/other_user}",
    "gists_url": "https://api.github.com/users/anonqoder/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/anonqoder/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/anonqoder/subscriptions",
    "organizations_url": "https://api.github.com/users/anonqoder/orgs",
    "repos_url": "https://api.github.com/users/anonqoder/repos",
    "events_url": "https://api.github.com/users/anonqoder/events{/privacy}",
    "received_events_url": "https://api.github.com/users/anonqoder/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/4371/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/4371/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1146950036",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/4371#issuecomment-1146950036",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/4371",
    "id": 1146950036,
    "node_id": "IC_kwDOC0FsAM5EXRGU",
    "user": {
      "login": "AskAlexSharov",
      "id": 46885206,
      "node_id": "MDQ6VXNlcjQ2ODg1MjA2",
      "avatar_url": "https://avatars.githubusercontent.com/u/46885206?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AskAlexSharov",
      "html_url": "https://github.com/AskAlexSharov",
      "followers_url": "https://api.github.com/users/AskAlexSharov/followers",
      "following_url": "https://api.github.com/users/AskAlexSharov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AskAlexSharov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AskAlexSharov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AskAlexSharov/subscriptions",
      "organizations_url": "https://api.github.com/users/AskAlexSharov/orgs",
      "repos_url": "https://api.github.com/users/AskAlexSharov/repos",
      "events_url": "https://api.github.com/users/AskAlexSharov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AskAlexSharov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-06-06T01:43:12Z",
    "updated_at": "2022-06-06T01:43:12Z",
    "author_association": "COLLABORATOR",
    "body": "It creating nee snapahots in background - in single thread",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1146950036/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1147289514",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/4371#issuecomment-1147289514",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/4371",
    "id": 1147289514,
    "node_id": "IC_kwDOC0FsAM5EYj-q",
    "user": {
      "login": "AskAlexSharov",
      "id": 46885206,
      "node_id": "MDQ6VXNlcjQ2ODg1MjA2",
      "avatar_url": "https://avatars.githubusercontent.com/u/46885206?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AskAlexSharov",
      "html_url": "https://github.com/AskAlexSharov",
      "followers_url": "https://api.github.com/users/AskAlexSharov/followers",
      "following_url": "https://api.github.com/users/AskAlexSharov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AskAlexSharov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AskAlexSharov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AskAlexSharov/subscriptions",
      "organizations_url": "https://api.github.com/users/AskAlexSharov/orgs",
      "repos_url": "https://api.github.com/users/AskAlexSharov/repos",
      "events_url": "https://api.github.com/users/AskAlexSharov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AskAlexSharov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-06-06T10:16:57Z",
    "updated_at": "2022-06-06T10:16:57Z",
    "author_association": "COLLABORATOR",
    "body": "Also likely CPU usage is higher because of this bug: https://github.com/ledgerwatch/erigon/pull/4378\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1147289514/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
