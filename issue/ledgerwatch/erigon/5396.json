{
  "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5396",
  "repository_url": "https://api.github.com/repos/ledgerwatch/erigon",
  "labels_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5396/labels{/name}",
  "comments_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5396/comments",
  "events_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5396/events",
  "html_url": "https://github.com/ledgerwatch/erigon/issues/5396",
  "id": 1375815798,
  "node_id": "I_kwDOC0FsAM5SAUh2",
  "number": 5396,
  "title": "Can't unwind wrt IntermediateHashes",
  "user": {
    "login": "pmdyy",
    "id": 39233499,
    "node_id": "MDQ6VXNlcjM5MjMzNDk5",
    "avatar_url": "https://avatars.githubusercontent.com/u/39233499?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/pmdyy",
    "html_url": "https://github.com/pmdyy",
    "followers_url": "https://api.github.com/users/pmdyy/followers",
    "following_url": "https://api.github.com/users/pmdyy/following{/other_user}",
    "gists_url": "https://api.github.com/users/pmdyy/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/pmdyy/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/pmdyy/subscriptions",
    "organizations_url": "https://api.github.com/users/pmdyy/orgs",
    "repos_url": "https://api.github.com/users/pmdyy/repos",
    "events_url": "https://api.github.com/users/pmdyy/events{/privacy}",
    "received_events_url": "https://api.github.com/users/pmdyy/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2022-09-16T11:28:29Z",
  "updated_at": "2022-09-17T06:53:56Z",
  "closed_at": "2022-09-17T06:53:56Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "#### System information\r\n\r\nErigon version: `./erigon --version`\r\n\r\nOS & Version: Linux\r\n\r\nCommit hash : e5afa7292ea66bb25895b7eb9678e28847ae9f1c\r\n\r\n#### Expected behaviour\r\n\r\nI expected that unwinding via `state_stages` wouldn't throw the following error:\r\n\r\n#### Actual behaviour\r\n\r\nUnwinding via `state_stages` throws the following error:\r\n\r\n```\r\nEROR[09-16|04:19:23.667] Error err=\"[9/16 IntermediateHashes] wrong trie root: a2f15e863462bff0b2adc10a025d36b9d62ff12f2a61960f0e2bb4112df2905c, expected (from header): 00b8d058b4fd37e19d1a54ce8ca5dd17617668a099e84d62b43e4010bfc278c7\"\r\n```\r\n\r\n\r\n#### Steps to reproduce the behaviour\r\n\r\nProviding info as req'd\r\n\r\n#### Backtrace\r\n\r\nCommand \r\n```\r\n./build/bin/integration state_stages --datadir /home/mike/erigon/data/ --unwind=5000 --chain=mainnet --integrity.fast=false\r\n```\r\n\r\nLog\r\n````\r\n(base) mike@mike-AB350M-DS3H:~/erigon-test/erigon-e5afa7292ea66bb25895b7eb9678e28847ae9f1c$ ./build/bin/integration state_stages --datadir /home/mike/erigon/data/ --unwind=5000 --chain=mainnet --integrity.fast=false\r\nEROR[09-16|04:05:12.796] [9/16 IntermediateHashes] Wrong trie root of block 15537393: 0b3b2fcf09f2c6ed5e1cb47f101febef56f0fd82cbe5cd8588881cf7e919a8fd, expected (from header): 4919dafa6ac8becfbbd0c2808f6c9511a057c21e42839caff5dfb6d3ef514951. Block hash: 55b11b918355b1ef9c5db810302ebad0bf2544255b530cdce90674d5887bb286 \r\nINFO[09-16|04:05:12.796] UnwindTo                                 block=15532393 bad_block_hash=0x0000000000000000000000000000000000000000000000000000000000000000\r\nINFO[09-16|04:07:55.996] [12/16 StorageHistoryIndex] Unwind done  in=1m48.793761647s\r\nINFO[09-16|04:09:24.086] [11/16 AccountHistoryIndex] Unwind done  in=1m28.087488759s\r\nINFO[09-16|04:09:24.086] [10/16 CallTraces] Unwind                from=15537393 to=15532393\r\nINFO[09-16|04:11:25.059] [10/16 CallTraces] Unwind done           in=2m0.972749623s\r\nINFO[09-16|04:11:25.059] [8/16 HashState] Unwinding started       from=15537393 to=15532393 storage=false codes=true\r\nINFO[09-16|04:11:36.829] [8/16 HashState] Unwinding started       from=15537393 to=15532393 storage=false codes=false\r\nINFO[09-16|04:12:10.664] [8/16 HashState] ETL [2/2] Loading       into=HashedAccount progress=89 alloc=4.0GB sys=4.9GB\r\nINFO[09-16|04:12:18.349] [8/16 HashState] Unwinding started       from=15537393 to=15532393 storage=true codes=false\r\nINFO[09-16|04:12:58.916] [8/16 HashState] ETL [2/2] Loading       into=HashedStorage progress=83 alloc=3.1GB sys=5.0GB\r\nINFO[09-16|04:13:26.001] [8/16 HashState] Unwind done             in=2m0.942077849s\r\nINFO[09-16|04:13:26.002] [9/16 IntermediateHashes] Unwinding      from=15537419 to=15532393 csbucket=AccountChangeSet\r\nINFO[09-16|04:13:56.004] [9/16 IntermediateHashes] ETL [1/2] Extracting from=AccountChangeSet current key=0000000000ed0aac alloc=3.3GB sys=5.0GB\r\nINFO[09-16|04:14:21.910] [9/16 IntermediateHashes] Unwinding      from=15537419 to=15532393 csbucket=StorageChangeSet\r\nINFO[09-16|04:14:51.912] [9/16 IntermediateHashes] ETL [1/2] Extracting from=StorageChangeSet current key=0000000000ed0831a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480000000000000001 alloc=2.6GB sys=5.0GB\r\nINFO[09-16|04:15:21.912] [9/16 IntermediateHashes] ETL [1/2] Extracting from=StorageChangeSet current key=0000000000ed13544976fb03c32e5b8cfe2b6ccb31c09ba78ebaba410000000000000001 alloc=3.0GB sys=5.0GB\r\nINFO[09-16|04:15:57.632] [9/16 IntermediateHashes] Calculating Merkle root current key=241b9c55...\r\nINFO[09-16|04:16:27.633] [9/16 IntermediateHashes] Calculating Merkle root current key=4aed7a54...\r\nINFO[09-16|04:16:58.112] [9/16 IntermediateHashes] Calculating Merkle root current key=6f898e39...\r\nINFO[09-16|04:17:30.543] [9/16 IntermediateHashes] Calculating Merkle root current key=8679e8ed...\r\nINFO[09-16|04:17:51.647] Flushed buffer file                      name=/home/mike/erigon/data/etl-temp/erigon-sortable-buf-1080665875 alloc=4.6GB sys=5.6GB\r\nINFO[09-16|04:17:57.632] [9/16 IntermediateHashes] Calculating Merkle root current key=a8ba997b...\r\nINFO[09-16|04:18:25.774] Flushed buffer file                      name=/home/mike/erigon/data/etl-temp/erigon-sortable-buf-2012898744 alloc=3.1GB sys=5.9GB\r\nINFO[09-16|04:18:27.632] [9/16 IntermediateHashes] Calculating Merkle root current key=c70a96e2...\r\nINFO[09-16|04:18:57.632] [9/16 IntermediateHashes] Calculating Merkle root current key=edfad58f...\r\nINFO[09-16|04:19:23.613] [9/16 IntermediateHashes] etl: temp files removed total size=224.4MB\r\nINFO[09-16|04:19:23.637] [9/16 IntermediateHashes] etl: temp files removed total size=218.6MB\r\nEROR[09-16|04:19:23.667] Error                                    err=\"[9/16 IntermediateHashes] wrong trie root: a2f15e863462bff0b2adc10a025d36b9d62ff12f2a61960f0e2bb4112df2905c, expected (from header): 00b8d058b4fd37e19d1a54ce8ca5dd17617668a099e84d62b43e4010bfc278c7\"\r\n````\r\n\r\nPrint stages\r\n\r\n```\r\n./build/bin/integration print_stages --datadir /home/mike/erigon/data/ --chain=mainnet\r\n\r\n \t\t\t\t stage_at \t prune_at\r\nSnapshots \t\t\t 15442999 \t 0\r\nHeaders \t\t\t 15537393 \t 0\r\nBlockHashes \t\t\t 15537393 \t 0\r\nBodies \t\t\t\t 15537393 \t 0\r\nSenders \t\t\t 15537393 \t 0\r\nExecution \t\t\t 15537393 \t 15537393\r\nTranslation \t\t\t 0 \t\t 0\r\nHashState \t\t\t 15537393 \t 0\r\nIntermediateHashes \t\t 15537419 \t 15537419\r\nAccountHistoryIndex \t\t 15537393 \t 0\r\nStorageHistoryIndex \t\t 15537393 \t 0\r\nLogIndex \t\t\t 15537393 \t 0\r\nCallTraces \t\t\t 15537393 \t 15537393\r\nTxLookup \t\t\t 15537393 \t 15443000\r\nFinish \t\t\t\t 15537419 \t 0\r\n--\r\nprune distance: \r\n\r\nsequence: EthTx=1742853169, NonCanonicalTx=1742853169\r\n\r\nfirst header in db: 15440300\r\nfirst body in db: 15440300\r\n\r\n--\r\nsnapsthos: blocks=15442999, segments=15442999, indices=15442999\r\n```\r\n",
  "closed_by": {
    "login": "pmdyy",
    "id": 39233499,
    "node_id": "MDQ6VXNlcjM5MjMzNDk5",
    "avatar_url": "https://avatars.githubusercontent.com/u/39233499?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/pmdyy",
    "html_url": "https://github.com/pmdyy",
    "followers_url": "https://api.github.com/users/pmdyy/followers",
    "following_url": "https://api.github.com/users/pmdyy/following{/other_user}",
    "gists_url": "https://api.github.com/users/pmdyy/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/pmdyy/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/pmdyy/subscriptions",
    "organizations_url": "https://api.github.com/users/pmdyy/orgs",
    "repos_url": "https://api.github.com/users/pmdyy/repos",
    "events_url": "https://api.github.com/users/pmdyy/events{/privacy}",
    "received_events_url": "https://api.github.com/users/pmdyy/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5396/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5396/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1249788727",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/5396#issuecomment-1249788727",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5396",
    "id": 1249788727,
    "node_id": "IC_kwDOC0FsAM5KfkM3",
    "user": {
      "login": "pmdyy",
      "id": 39233499,
      "node_id": "MDQ6VXNlcjM5MjMzNDk5",
      "avatar_url": "https://avatars.githubusercontent.com/u/39233499?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pmdyy",
      "html_url": "https://github.com/pmdyy",
      "followers_url": "https://api.github.com/users/pmdyy/followers",
      "following_url": "https://api.github.com/users/pmdyy/following{/other_user}",
      "gists_url": "https://api.github.com/users/pmdyy/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pmdyy/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pmdyy/subscriptions",
      "organizations_url": "https://api.github.com/users/pmdyy/orgs",
      "repos_url": "https://api.github.com/users/pmdyy/repos",
      "events_url": "https://api.github.com/users/pmdyy/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pmdyy/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-16T20:36:05Z",
    "updated_at": "2022-09-16T20:36:05Z",
    "author_association": "NONE",
    "body": "Unwinding using `stage_trie` didn't work also:\r\n\r\n```\r\n./build/bin/integration stage_trie --datadir /home/mike/erigon/data/ --unwind=5000 --chain=mainnet\r\nINFO[09-16|13:34:30.278] StageExec                                progress=15532393\r\nINFO[09-16|13:34:30.278] StageTrie                                progress=15537419\r\nINFO[09-16|13:34:30.278] [9/16 IntermediateHashes] Unwinding      from=15537419 to=15532419 csbucket=AccountChangeSet\r\nINFO[09-16|13:34:30.278] [9/16 IntermediateHashes] Unwinding      from=15537419 to=15532419 csbucket=StorageChangeSet\r\nEROR[09-16|13:34:30.279] Error                                    err=\"wrong trie root: 0b3b2fcf09f2c6ed5e1cb47f101febef56f0fd82cbe5cd8588881cf7e919a8fd, expected (from header): fb8a71dbb9aad17ec6afb6df38934cb459db3ee156b7faca240229faf69e6ad6\"\r\nError: wrong trie root: 0b3b2fcf09f2c6ed5e1cb47f101febef56f0fd82cbe5cd8588881cf7e919a8fd, expected (from header): fb8a71dbb9aad17ec6afb6df38934cb459db3ee156b7faca240229faf69e6ad6\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1249788727/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1250011214",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/5396#issuecomment-1250011214",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5396",
    "id": 1250011214,
    "node_id": "IC_kwDOC0FsAM5KgahO",
    "user": {
      "login": "AskAlexSharov",
      "id": 46885206,
      "node_id": "MDQ6VXNlcjQ2ODg1MjA2",
      "avatar_url": "https://avatars.githubusercontent.com/u/46885206?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AskAlexSharov",
      "html_url": "https://github.com/AskAlexSharov",
      "followers_url": "https://api.github.com/users/AskAlexSharov/followers",
      "following_url": "https://api.github.com/users/AskAlexSharov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AskAlexSharov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AskAlexSharov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AskAlexSharov/subscriptions",
      "organizations_url": "https://api.github.com/users/AskAlexSharov/orgs",
      "repos_url": "https://api.github.com/users/AskAlexSharov/repos",
      "events_url": "https://api.github.com/users/AskAlexSharov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AskAlexSharov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-17T06:23:08Z",
    "updated_at": "2022-09-17T06:23:08Z",
    "author_association": "COLLABORATOR",
    "body": "```\r\nHashState \t\t\t 15537393 \t 0\r\nIntermediateHashes \t\t 15537419 \t 15537419\r\n```\r\nyour HashState is behind IntermediateHashes, it's must not happen in normal scenarios. likely you did run stages unwind manually in wrong order. \r\nI advise you to try:\r\n```\r\nintegration stage_hash_state --reset\r\nintegration stage_trie --reset\r\nintegration stage_exec --unwind=100\r\nintegration stage_hash_state\r\nintegration stage_trie\r\n// start erigon as usually\r\n```\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1250011214/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 1,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1250015133",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/5396#issuecomment-1250015133",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5396",
    "id": 1250015133,
    "node_id": "IC_kwDOC0FsAM5Kgbed",
    "user": {
      "login": "pmdyy",
      "id": 39233499,
      "node_id": "MDQ6VXNlcjM5MjMzNDk5",
      "avatar_url": "https://avatars.githubusercontent.com/u/39233499?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pmdyy",
      "html_url": "https://github.com/pmdyy",
      "followers_url": "https://api.github.com/users/pmdyy/followers",
      "following_url": "https://api.github.com/users/pmdyy/following{/other_user}",
      "gists_url": "https://api.github.com/users/pmdyy/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pmdyy/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pmdyy/subscriptions",
      "organizations_url": "https://api.github.com/users/pmdyy/orgs",
      "repos_url": "https://api.github.com/users/pmdyy/repos",
      "events_url": "https://api.github.com/users/pmdyy/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pmdyy/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-17T06:53:56Z",
    "updated_at": "2022-09-17T06:53:56Z",
    "author_association": "NONE",
    "body": "Thanks that worked",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1250015133/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
