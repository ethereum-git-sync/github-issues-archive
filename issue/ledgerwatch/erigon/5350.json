{
  "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5350",
  "repository_url": "https://api.github.com/repos/ledgerwatch/erigon",
  "labels_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5350/labels{/name}",
  "comments_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5350/comments",
  "events_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5350/events",
  "html_url": "https://github.com/ledgerwatch/erigon/issues/5350",
  "id": 1371067677,
  "node_id": "I_kwDOC0FsAM5RuNUd",
  "number": 5350,
  "title": "peer disconnect when erigon mining",
  "user": {
    "login": "flywukong",
    "id": 19421226,
    "node_id": "MDQ6VXNlcjE5NDIxMjI2",
    "avatar_url": "https://avatars.githubusercontent.com/u/19421226?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/flywukong",
    "html_url": "https://github.com/flywukong",
    "followers_url": "https://api.github.com/users/flywukong/followers",
    "following_url": "https://api.github.com/users/flywukong/following{/other_user}",
    "gists_url": "https://api.github.com/users/flywukong/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/flywukong/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/flywukong/subscriptions",
    "organizations_url": "https://api.github.com/users/flywukong/orgs",
    "repos_url": "https://api.github.com/users/flywukong/repos",
    "events_url": "https://api.github.com/users/flywukong/events{/privacy}",
    "received_events_url": "https://api.github.com/users/flywukong/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 4566396003,
      "node_id": "LA_kwDOC0FsAM8AAAABEC2sYw",
      "url": "https://api.github.com/repos/ledgerwatch/erigon/labels/Stale",
      "name": "Stale",
      "color": "ededed",
      "default": false,
      "description": null
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2022-09-13T08:32:41Z",
  "updated_at": "2022-11-18T03:05:30Z",
  "closed_at": "2022-11-18T03:05:30Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "#### System information\r\n\r\nErigon version: erigon version 2022.08.3-alpha-31940528\r\n\r\nOS & Version: linux\r\n\r\nCommit hash : \r\n836dda97a29228dc0bd89b235902d14a1401345c\r\n\r\n#### Expected behaviour\r\nsync stage should run well when run as erigon validator \r\n\r\n#### Actual behaviour\r\n\r\nTested erigon as a validator on bsc private testnet,   the tps of the chain is 300 , after the validators has runned 1-2 hours ,  I find that validator of erigon began to miss some block which should mining by it , and \r\neventually caused it to be slashed.  Deeply look into the logs ,  I find it may caused by Peer disconnected  , the peer exception caused the sync stage exception and affected the mining jobs.  as the logs show below,  the peer error caused syncing a block took 70s , another strange things is that erigon is keep on mining some block for 2-10 times during this time.  I believe something is abnormal  of peering . This error happened dozens of times and eventually caused the validator to be slashed.\r\n\r\n![image](https://user-images.githubusercontent.com/19421226/189852852-ce098e5d-66ef-452d-a6c0-e8633d78bf0b.png)\r\n\r\n\r\n \r\n#### Backtrace\r\n**_the logs  of erigon show the peer take 70s to recover_**\r\n\r\n[TRACE] [09-09|14:59:31.605] Peer disconnected                        id=\"[249 12 139 193 153 80 134 73 129 204 166 54 54 76 253 192 206 104 244 27 82 126 68 16 232 13 163 29 153 100 217 43 85 177 168 176 12 61 200 201 8 160 97 154 133 129 116 47 110 213 155 246 211 79 237 49 97 15 145 11 27 215 118 0]\" name=Geth/v1.1.12-f68965a6-20220728/linux-amd64/go1.17.10\r\n[TRACE] [09-09|14:59:31.605] [ù^L<8b>Á<99>P<86>I<81>Ì¦66LýÀÎhô^[R~D^Pè^M£^]<99>dÙ+U±¨°^L=ÈÉ^H a<9a><85><81>t/nÕ<9b>öÓOí1a^O<91>^K^[×v^@] Error while running peer: reading message: EOF\r\n\r\n（...ignore some log）\r\n\r\n[TRACE] [09-09|15:00:41.609] Failed p2p handshake                     id=8c8c0185c3236d53233992cd0c885f958ad4db8a073e4962015e226de533eb16 addr=10.90.43.107:30311 conn=staticdial err=\"already connected\"\r\n[TRACE] [09-09|15:00:41.609] Adding p2p peer                          peercount=2 id=5fdd754e399604f824cd10f35cde6837c586acdcc277aa2b0ccd875aea98234a conn=staticdial addr=10.90.41.73:30311 name=Geth/v1.1.12-f68965a...\r\n[TRACE] [09-09|15:00:41.610] Starting protocol eth/66                 id=5fdd754e399604f824cd10f35cde6837c586acdcc277aa2b0ccd875aea98234a conn=staticdial\r\n[TRACE] [09-09|15:00:41.610] [x^Cìp<90>H(^\\g^E w<9a>6µ^WXGêMjC»<9a>w<9e>b<<9e>^Q8&¢@<8f>-<8a><ôT´<9e>ä<8f>E^[­2Ã[^Rl¹Ã^<8a>¡ÃS<8b>&<81>&^@] Start with peer\r\n[TRACE] [09-09|15:00:41.610] Link queue                               size=1\r\n[TRACE] [09-09|15:00:41.610] headerLoop woken up by the incoming request\r\n[DBUG] [09-09|15:00:41.610] Request skeleton                         anchors=1 top seen height=12367 highestInDb=12368\r\n[TRACE] [09-09|15:00:41.610] Rejected peer                            id=5fdd754e399604f824cd10f35cde6837c586acdcc277aa2b0ccd875aea98234a addr=10.90.41.73:59576 conn=inbound err=\"already connected\"\r\n[TRACE] [09-09|15:00:41.610] Protocol eth/66 failed                   id=5fdd754e399604f824cd10f35cde6837c586acdcc277aa2b0ccd875aea98234a conn=staticdial err=\"handshake to peer x^Cï¿½pï¿½H(^\\g^E wï¿½6ï¿½^WXGï¿½MjCï¿½ï¿½wï¿½b<ï¿½^Q8&ï¿½@ï¿½-ï¿½<ï¿½Tï¿½ï¿½ï¿½ï¿½E^[ï¿½2ï¿½[^Rlï¿½ï¿½^ï¿½ï¿½ï¿½Sï¿½&ï¿½&^@: EOF\"\r\n[TRACE] [09-09|15:00:41.610] Removing p2p peer                        peercount=1 id=5fdd754e399604f824cd10f35cde6837c586acdcc277aa2b0ccd875aea98234a duration=909.528Âµs req=true err=\"disconnect requested\"\r\n[TRACE] [09-09|15:00:41.613] Link queue                               size=15\r\n[TRACE] [09-09|15:00:41.613] Link queue                               size=15\r\n[TRACE] [09-09|15:00:41.613] headerLoop woken up by the incoming request\r\n[TRACE] [09-09|15:00:41.613] Empty anchor queue\r\n[INFO] [09-09|15:00:41.615] [1/16 Headers] Processed                 highest inserted=12384 age=1s HighestHash=0x67ce83d3b4a910e0423a4e56d593298cb8719c8a9627ca5cd8138c4e89e7916a\r\n[INFO] [09-09|15:00:41.615] [1/16 Headers] DONE                      in=1m10.198002459s\r\n\r\n**_the log of other bsc validator:_**\r\n2022-09-09T14:59:31+0000 lvl=dbug msg=\"Message handling failed in `eth`\"       id=c2dc66641c2b41b72523d9d0a8efb6f15a9a142ed829eb999ded4a845b71e45a conn=staticdial err=\"invalid message: message msg #6 (12 bytes): invalid message: (code 6) (size 12) rlp: too few elements for eth.BlockBody, decoding into (eth.BlockBodiesPacket66).BlockBodiesPacket[0]\"\r\nt=2022-09-09T14:59:31+0000 lvl=dbug msg=\"Removing Ethereum peer\"                 peer=c2dc6664 snap=false\r\nt=2022-09-09T14:59:31+0000 lvl=dbug msg=\"Removing p2p peer\"                      peercount=2 id=c2dc66641c2b41b72523d9d0a8efb6f15a9a142ed829eb999ded4a845b71e45a duration=4m39.997s   req=false err=\"invalid message: message msg #6 (12 bytes): invalid message: (code 6) (size 12) rlp: too few elements for eth.BlockBody, decoding into (eth.BlockBodiesPacket66).BlockBodiesPacket[0]\"\r\nt=2022-09-09T14:59:31+0000 lvl=info msg=\"Looking for peers\"                      peercount=2 tried=0 static=2\r\nt=2022-09-09T14:59:31+0000 lvl=dbug msg=\"Adding p2p peer\"                        peercount=3 id=c2dc66641c2b41b72523d9d0a8efb6f15a9a142ed829eb999ded4a845b71e45a conn=staticdial addr=10.90.42.57:30311                 name=erigon/v2022.08.3-al...\r\nt=2022-09-09T14:59:31+0000 lvl=dbug msg=\"Ethereum handshake failed\"              id=c2dc66641c2b41b72523d9d0a8efb6f15a9a142ed829eb999ded4a845b71e45a conn=staticdial err=\"no status message: first msg has code 3 (!= 0)\"\r\nt=2022-09-09T14:59:31+0000 lvl=dbug msg=\"Removing p2p peer\"                      peercount=2 id=c2dc66641c2b41b72523d9d0a8efb6f15a9a142ed829eb999ded4a845b71e45a duration=1.091ms     req=false err=\"no status message: first msg has code 3 (!= 0)\"",
  "closed_by": {
    "login": "github-actions[bot]",
    "id": 41898282,
    "node_id": "MDM6Qm90NDE4OTgyODI=",
    "avatar_url": "https://avatars.githubusercontent.com/in/15368?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/github-actions%5Bbot%5D",
    "html_url": "https://github.com/apps/github-actions",
    "followers_url": "https://api.github.com/users/github-actions%5Bbot%5D/followers",
    "following_url": "https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}",
    "gists_url": "https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/github-actions%5Bbot%5D/subscriptions",
    "organizations_url": "https://api.github.com/users/github-actions%5Bbot%5D/orgs",
    "repos_url": "https://api.github.com/users/github-actions%5Bbot%5D/repos",
    "events_url": "https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}",
    "received_events_url": "https://api.github.com/users/github-actions%5Bbot%5D/received_events",
    "type": "Bot",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5350/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5350/timeline",
  "performed_via_github_app": null,
  "state_reason": "not_planned"
}
[
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1246188379",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/5350#issuecomment-1246188379",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5350",
    "id": 1246188379,
    "node_id": "IC_kwDOC0FsAM5KR1Nb",
    "user": {
      "login": "AskAlexSharov",
      "id": 46885206,
      "node_id": "MDQ6VXNlcjQ2ODg1MjA2",
      "avatar_url": "https://avatars.githubusercontent.com/u/46885206?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AskAlexSharov",
      "html_url": "https://github.com/AskAlexSharov",
      "followers_url": "https://api.github.com/users/AskAlexSharov/followers",
      "following_url": "https://api.github.com/users/AskAlexSharov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AskAlexSharov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AskAlexSharov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AskAlexSharov/subscriptions",
      "organizations_url": "https://api.github.com/users/AskAlexSharov/orgs",
      "repos_url": "https://api.github.com/users/AskAlexSharov/repos",
      "events_url": "https://api.github.com/users/AskAlexSharov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AskAlexSharov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-14T03:33:00Z",
    "updated_at": "2022-09-14T03:33:00Z",
    "author_association": "COLLABORATOR",
    "body": "probably fixed by https://github.com/ledgerwatch/erigon/pull/5359",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1246188379/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1246209217",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/5350#issuecomment-1246209217",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5350",
    "id": 1246209217,
    "node_id": "IC_kwDOC0FsAM5KR6TB",
    "user": {
      "login": "flywukong",
      "id": 19421226,
      "node_id": "MDQ6VXNlcjE5NDIxMjI2",
      "avatar_url": "https://avatars.githubusercontent.com/u/19421226?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/flywukong",
      "html_url": "https://github.com/flywukong",
      "followers_url": "https://api.github.com/users/flywukong/followers",
      "following_url": "https://api.github.com/users/flywukong/following{/other_user}",
      "gists_url": "https://api.github.com/users/flywukong/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/flywukong/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/flywukong/subscriptions",
      "organizations_url": "https://api.github.com/users/flywukong/orgs",
      "repos_url": "https://api.github.com/users/flywukong/repos",
      "events_url": "https://api.github.com/users/flywukong/events{/privacy}",
      "received_events_url": "https://api.github.com/users/flywukong/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-14T04:14:18Z",
    "updated_at": "2022-09-15T00:10:18Z",
    "author_association": "NONE",
    "body": "> probably fixed by #5359\r\n\r\nit is tested on a simple private testnet , so I think it is not related to bsc hardfork",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1246209217/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1289951369",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/5350#issuecomment-1289951369",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5350",
    "id": 1289951369,
    "node_id": "IC_kwDOC0FsAM5M4xiJ",
    "user": {
      "login": "github-actions[bot]",
      "id": 41898282,
      "node_id": "MDM6Qm90NDE4OTgyODI=",
      "avatar_url": "https://avatars.githubusercontent.com/in/15368?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/github-actions%5Bbot%5D",
      "html_url": "https://github.com/apps/github-actions",
      "followers_url": "https://api.github.com/users/github-actions%5Bbot%5D/followers",
      "following_url": "https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}",
      "gists_url": "https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/github-actions%5Bbot%5D/subscriptions",
      "organizations_url": "https://api.github.com/users/github-actions%5Bbot%5D/orgs",
      "repos_url": "https://api.github.com/users/github-actions%5Bbot%5D/repos",
      "events_url": "https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}",
      "received_events_url": "https://api.github.com/users/github-actions%5Bbot%5D/received_events",
      "type": "Bot",
      "site_admin": false
    },
    "created_at": "2022-10-25T04:12:20Z",
    "updated_at": "2022-10-25T04:12:20Z",
    "author_association": "NONE",
    "body": "This issue is stale because it has been open for 40 days with no activity. Remove stale label or comment, or this will be closed in 7 days.",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1289951369/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1319485750",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/5350#issuecomment-1319485750",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5350",
    "id": 1319485750,
    "node_id": "IC_kwDOC0FsAM5OpcE2",
    "user": {
      "login": "github-actions[bot]",
      "id": 41898282,
      "node_id": "MDM6Qm90NDE4OTgyODI=",
      "avatar_url": "https://avatars.githubusercontent.com/in/15368?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/github-actions%5Bbot%5D",
      "html_url": "https://github.com/apps/github-actions",
      "followers_url": "https://api.github.com/users/github-actions%5Bbot%5D/followers",
      "following_url": "https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}",
      "gists_url": "https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/github-actions%5Bbot%5D/subscriptions",
      "organizations_url": "https://api.github.com/users/github-actions%5Bbot%5D/orgs",
      "repos_url": "https://api.github.com/users/github-actions%5Bbot%5D/repos",
      "events_url": "https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}",
      "received_events_url": "https://api.github.com/users/github-actions%5Bbot%5D/received_events",
      "type": "Bot",
      "site_admin": false
    },
    "created_at": "2022-11-18T03:05:29Z",
    "updated_at": "2022-11-18T03:05:29Z",
    "author_association": "NONE",
    "body": "This issue was closed because it has been stalled for 7 days with no activity.",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1319485750/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
