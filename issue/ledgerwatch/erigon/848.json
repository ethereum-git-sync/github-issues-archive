{
  "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/848",
  "repository_url": "https://api.github.com/repos/ledgerwatch/erigon",
  "labels_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/848/labels{/name}",
  "comments_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/848/comments",
  "events_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/848/events",
  "html_url": "https://github.com/ledgerwatch/erigon/issues/848",
  "id": 670920143,
  "node_id": "MDU6SXNzdWU2NzA5MjAxNDM=",
  "number": 848,
  "title": "Investigate demoting invalidated transactions",
  "user": {
    "login": "AlexeyAkhunov",
    "id": 13686139,
    "node_id": "MDQ6VXNlcjEzNjg2MTM5",
    "avatar_url": "https://avatars.githubusercontent.com/u/13686139?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/AlexeyAkhunov",
    "html_url": "https://github.com/AlexeyAkhunov",
    "followers_url": "https://api.github.com/users/AlexeyAkhunov/followers",
    "following_url": "https://api.github.com/users/AlexeyAkhunov/following{/other_user}",
    "gists_url": "https://api.github.com/users/AlexeyAkhunov/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/AlexeyAkhunov/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/AlexeyAkhunov/subscriptions",
    "organizations_url": "https://api.github.com/users/AlexeyAkhunov/orgs",
    "repos_url": "https://api.github.com/users/AlexeyAkhunov/repos",
    "events_url": "https://api.github.com/users/AlexeyAkhunov/events{/privacy}",
    "received_events_url": "https://api.github.com/users/AlexeyAkhunov/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2020-08-01T14:31:56Z",
  "updated_at": "2021-12-08T18:36:42Z",
  "closed_at": "2021-12-08T18:36:42Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "This happens during the unwinds, not sure yet if something is wrong\r\n````\r\nINFO [08-01|14:30:36.080] Sync stage 1/10. Download headers... \r\nINFO [08-01|14:30:36.223] Imported new block headers               count=2   elapsed=10.884ms    number=10574423 hash=\"87d2a9…d6bb6d\" reorg=true forkBlockNumber=10574421\r\nINFO [08-01|14:30:36.223] UnwindTo                                 block=10574421\r\nINFO [08-01|14:30:36.272] Sync stage 1/10. Download headers... DONE! \r\nINFO [08-01|14:30:36.272] Unwinding...                             stage=8\r\nINFO [08-01|14:30:36.295] Unwinding... DONE! \r\nINFO [08-01|14:30:36.295] Unwinding...                             stage=7\r\nINFO [08-01|14:30:37.065] Unwinding... DONE! \r\nINFO [08-01|14:30:37.065] Unwinding...                             stage=6\r\nINFO [08-01|14:30:37.694] Unwinding... DONE! \r\nINFO [08-01|14:30:37.694] Unwinding...                             stage=5\r\nINFO [08-01|14:30:37.734] Unwinding... DONE! \r\nINFO [08-01|14:30:37.734] Unwinding...                             stage=4\r\nINFO [08-01|14:30:37.734] Unwinding of intermediate hashes         from=10574422 to=10574421 csbucket=PLAIN-ACS\r\nINFO [08-01|14:30:37.735] Unwinding of intermediate hashes         from=10574422 to=10574421 csbucket=PLAIN-SCS\r\nINFO [08-01|14:30:38.157] Collection finished                      root hash=0xbfba1a62cb8653f0f31705c77a668a6c26c757d442e3e88c4bcf4e1a742c0469 gen IH=420.082903ms\r\nINFO [08-01|14:30:38.260] Unwinding... DONE! \r\nINFO [08-01|14:30:38.260] Unwinding...                             stage=3\r\nINFO [08-01|14:30:38.260] Unwind Execution stage                   from=10574422 to=10574421\r\nINFO [08-01|14:30:38.293] Unwinding... DONE! \r\nINFO [08-01|14:30:38.293] Unwinding...                             stage=9\r\nERROR[08-01|14:30:38.297] Demoting invalidated transaction         hash=\"6ee8a8…92bf22\"\r\nERROR[08-01|14:30:38.299] Demoting invalidated transaction         hash=\"7abab0…eccbed\"\r\nERROR[08-01|14:30:38.299] Demoting invalidated transaction         hash=\"de485c…dcd575\"\r\nERROR[08-01|14:30:38.299] Demoting invalidated transaction         hash=\"3d33a1…bc8f61\"\r\nERROR[08-01|14:30:38.299] Demoting invalidated transaction         hash=\"b11d49…481e7c\"\r\nERROR[08-01|14:30:38.299] Demoting invalidated transaction         hash=\"832d13…076faa\"\r\nERROR[08-01|14:30:38.299] Demoting invalidated transaction         hash=\"859191…0366c0\"\r\nERROR[08-01|14:30:38.299] Demoting invalidated transaction         hash=\"25ee67…e73153\"\r\nERROR[08-01|14:30:38.299] Demoting invalidated transaction         hash=\"166e44…77d593\"\r\nERROR[08-01|14:30:38.300] Demoting invalidated transaction         hash=\"575a75…3be569\"\r\nERROR[08-01|14:30:38.300] Demoting invalidated transaction         hash=\"e41535…a3820b\"\r\nERROR[08-01|14:30:38.300] Demoting invalidated transaction         hash=\"9208c8…169d57\"\r\nERROR[08-01|14:30:38.301] Demoting invalidated transaction         hash=\"4f5b09…ede643\"\r\nERROR[08-01|14:30:38.302] Demoting invalidated transaction         hash=\"e9ba1c…54a72e\"\r\nERROR[08-01|14:30:38.302] Demoting invalidated transaction         hash=\"468d1b…82ce44\"\r\nERROR[08-01|14:30:38.304] Demoting invalidated transaction         hash=\"4ca2b3…9a7fa8\"\r\nERROR[08-01|14:30:38.304] Demoting invalidated transaction         hash=\"e9cb21…113488\"\r\nERROR[08-01|14:30:38.306] Demoting invalidated transaction         hash=\"6ed272…2485d4\"\r\nERROR[08-01|14:30:38.306] Demoting invalidated transaction         hash=\"2111ab…422dfb\"\r\nERROR[08-01|14:30:38.306] Demoting invalidated transaction         hash=\"d2fbff…59bf9f\"\r\nERROR[08-01|14:30:38.306] Demoting invalidated transaction         hash=\"a53a6f…e1dea1\"\r\nERROR[08-01|14:30:38.307] Demoting invalidated transaction         hash=\"6de8f8…064ed8\"\r\nERROR[08-01|14:30:38.307] Demoting invalidated transaction         hash=\"59955f…4547c6\"\r\nERROR[08-01|14:30:38.307] Demoting invalidated transaction         hash=\"bdac81…77d4b6\"\r\nERROR[08-01|14:30:38.307] Demoting invalidated transaction         hash=\"6b484f…277529\"\r\nERROR[08-01|14:30:38.307] Demoting invalidated transaction         hash=\"37cc7c…40e9a0\"\r\nINFO [08-01|14:30:38.328] unwind TxPoolUpdate: Reading canonical hashes complete hashes=1\r\nINFO [08-01|14:30:38.328] unwind TxPoolUpdate: injecting txs into the pool number=0\r\nINFO [08-01|14:30:38.328] Injection complete \r\nINFO [08-01|14:30:38.330] Unwinding... DONE! \r\nINFO [08-01|14:30:38.330] Unwinding...                             stage=2\r\nINFO [08-01|14:30:38.331] Unwinding... DONE! \r\nINFO [08-01|14:30:38.331] Unwinding...                             stage=1\r\nINFO [08-01|14:30:38.333] Unwinding... DONE! \r\nINFO [08-01|14:30:38.333] Unwinding...                             stage=0\r\nINFO [08-01|14:30:38.335] Unwinding... DONE! \r\n\r\n````\r\n",
  "closed_by": {
    "login": "mandrigin",
    "id": 466427,
    "node_id": "MDQ6VXNlcjQ2NjQyNw==",
    "avatar_url": "https://avatars.githubusercontent.com/u/466427?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mandrigin",
    "html_url": "https://github.com/mandrigin",
    "followers_url": "https://api.github.com/users/mandrigin/followers",
    "following_url": "https://api.github.com/users/mandrigin/following{/other_user}",
    "gists_url": "https://api.github.com/users/mandrigin/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mandrigin/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mandrigin/subscriptions",
    "organizations_url": "https://api.github.com/users/mandrigin/orgs",
    "repos_url": "https://api.github.com/users/mandrigin/repos",
    "events_url": "https://api.github.com/users/mandrigin/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mandrigin/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/848/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/848/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/667572695",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/848#issuecomment-667572695",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/848",
    "id": 667572695,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY2NzU3MjY5NQ==",
    "user": {
      "login": "mandrigin",
      "id": 466427,
      "node_id": "MDQ6VXNlcjQ2NjQyNw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/466427?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mandrigin",
      "html_url": "https://github.com/mandrigin",
      "followers_url": "https://api.github.com/users/mandrigin/followers",
      "following_url": "https://api.github.com/users/mandrigin/following{/other_user}",
      "gists_url": "https://api.github.com/users/mandrigin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mandrigin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mandrigin/subscriptions",
      "organizations_url": "https://api.github.com/users/mandrigin/orgs",
      "repos_url": "https://api.github.com/users/mandrigin/repos",
      "events_url": "https://api.github.com/users/mandrigin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mandrigin/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-08-01T18:50:47Z",
    "updated_at": "2020-08-01T18:50:47Z",
    "author_association": "COLLABORATOR",
    "body": "```\r\n\t\t// If there's a gap in front, alert (should never happen) and postpone all transactions\r\n\t\tif list.Len() > 0 && list.txs.Get(nonce) == nil {\r\n\t\t\tgapped := list.Cap(0)\r\n\t\t\tfor _, tx := range gapped {\r\n\t\t\t\thash := tx.Hash()\r\n\t\t\t\tlog.Error(\"Demoting invalidated transaction\", \"hash\", hash)\r\n\t\t\t\tpool.enqueueTx(hash, tx)\r\n\t\t\t}\r\n\t\t\tpendingGauge.Dec(int64(len(gapped)))\r\n\t\t}\r\n```\r\n\r\nit looks like it happens because `pool.currentState.GetNonce(addr)` goes backward on unwinds.\r\nmaybe we can just cleanup the pending transactions on unwinds?",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/667572695/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/805826693",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/848#issuecomment-805826693",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/848",
    "id": 805826693,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwNTgyNjY5Mw==",
    "user": {
      "login": "AlexeyAkhunov",
      "id": 13686139,
      "node_id": "MDQ6VXNlcjEzNjg2MTM5",
      "avatar_url": "https://avatars.githubusercontent.com/u/13686139?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AlexeyAkhunov",
      "html_url": "https://github.com/AlexeyAkhunov",
      "followers_url": "https://api.github.com/users/AlexeyAkhunov/followers",
      "following_url": "https://api.github.com/users/AlexeyAkhunov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AlexeyAkhunov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AlexeyAkhunov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AlexeyAkhunov/subscriptions",
      "organizations_url": "https://api.github.com/users/AlexeyAkhunov/orgs",
      "repos_url": "https://api.github.com/users/AlexeyAkhunov/repos",
      "events_url": "https://api.github.com/users/AlexeyAkhunov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AlexeyAkhunov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-24T13:35:00Z",
    "updated_at": "2021-03-24T13:35:00Z",
    "author_association": "CONTRIBUTOR",
    "body": "I think I know the reason for this. It is because `TxPool` observes the wrong view of the Canonical Hashes during the unwind. It should observe the view BEFORE the unwinding, whereas it observes the view AFTER the unwind. This will be fixed in the new downloader",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/805826693/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/816707099",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/848#issuecomment-816707099",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/848",
    "id": 816707099,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgxNjcwNzA5OQ==",
    "user": {
      "login": "denisgranha",
      "id": 4806080,
      "node_id": "MDQ6VXNlcjQ4MDYwODA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4806080?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/denisgranha",
      "html_url": "https://github.com/denisgranha",
      "followers_url": "https://api.github.com/users/denisgranha/followers",
      "following_url": "https://api.github.com/users/denisgranha/following{/other_user}",
      "gists_url": "https://api.github.com/users/denisgranha/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/denisgranha/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/denisgranha/subscriptions",
      "organizations_url": "https://api.github.com/users/denisgranha/orgs",
      "repos_url": "https://api.github.com/users/denisgranha/repos",
      "events_url": "https://api.github.com/users/denisgranha/events{/privacy}",
      "received_events_url": "https://api.github.com/users/denisgranha/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-04-09T14:05:07Z",
    "updated_at": "2021-04-09T14:06:44Z",
    "author_association": "NONE",
    "body": "should this log be a WARN instead of ERROR? currently is a bit noisy.\r\n\r\nIf it will be solved, all good... but in case is something that will happen from time to time, I would vote for putting it into WARN level",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/816707099/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/880708072",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/848#issuecomment-880708072",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/848",
    "id": 880708072,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg4MDcwODA3Mg==",
    "user": {
      "login": "alysak6075",
      "id": 9685425,
      "node_id": "MDQ6VXNlcjk2ODU0MjU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9685425?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alysak6075",
      "html_url": "https://github.com/alysak6075",
      "followers_url": "https://api.github.com/users/alysak6075/followers",
      "following_url": "https://api.github.com/users/alysak6075/following{/other_user}",
      "gists_url": "https://api.github.com/users/alysak6075/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alysak6075/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alysak6075/subscriptions",
      "organizations_url": "https://api.github.com/users/alysak6075/orgs",
      "repos_url": "https://api.github.com/users/alysak6075/repos",
      "events_url": "https://api.github.com/users/alysak6075/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alysak6075/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-07-15T13:46:30Z",
    "updated_at": "2021-07-15T13:46:30Z",
    "author_association": "NONE",
    "body": "Still seeing this on 2021.07.03-alpha",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/880708072/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/989080304",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/848#issuecomment-989080304",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/848",
    "id": 989080304,
    "node_id": "IC_kwDOC0FsAM469Crw",
    "user": {
      "login": "mandrigin",
      "id": 466427,
      "node_id": "MDQ6VXNlcjQ2NjQyNw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/466427?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mandrigin",
      "html_url": "https://github.com/mandrigin",
      "followers_url": "https://api.github.com/users/mandrigin/followers",
      "following_url": "https://api.github.com/users/mandrigin/following{/other_user}",
      "gists_url": "https://api.github.com/users/mandrigin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mandrigin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mandrigin/subscriptions",
      "organizations_url": "https://api.github.com/users/mandrigin/orgs",
      "repos_url": "https://api.github.com/users/mandrigin/repos",
      "events_url": "https://api.github.com/users/mandrigin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mandrigin/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-12-08T18:36:42Z",
    "updated_at": "2021-12-08T18:36:42Z",
    "author_association": "COLLABORATOR",
    "body": "if repeats with txpool.v2, feel free to reopen.",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/989080304/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
