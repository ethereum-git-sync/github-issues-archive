{
  "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/1211",
  "repository_url": "https://api.github.com/repos/ledgerwatch/erigon",
  "labels_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/1211/labels{/name}",
  "comments_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/1211/comments",
  "events_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/1211/events",
  "html_url": "https://github.com/ledgerwatch/erigon/issues/1211",
  "id": 717749283,
  "node_id": "MDU6SXNzdWU3MTc3NDkyODM=",
  "number": 1211,
  "title": "Sync stage Generate Storage History fails (too many open files). Starts over.",
  "user": {
    "login": "tjayrush",
    "id": 5417918,
    "node_id": "MDQ6VXNlcjU0MTc5MTg=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5417918?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tjayrush",
    "html_url": "https://github.com/tjayrush",
    "followers_url": "https://api.github.com/users/tjayrush/followers",
    "following_url": "https://api.github.com/users/tjayrush/following{/other_user}",
    "gists_url": "https://api.github.com/users/tjayrush/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tjayrush/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tjayrush/subscriptions",
    "organizations_url": "https://api.github.com/users/tjayrush/orgs",
    "repos_url": "https://api.github.com/users/tjayrush/repos",
    "events_url": "https://api.github.com/users/tjayrush/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tjayrush/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2020-10-09T00:07:46Z",
  "updated_at": "2020-10-10T21:15:07Z",
  "closed_at": "2020-10-10T21:15:07Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "#### System information\r\n\r\nTurboGeth version: `latest master`\r\nOS & Version: OSX\r\n\r\n#### Expected behaviour\r\n\r\nSync\r\n\r\n#### Actual behaviour\r\n\r\nFailed sync\r\n\r\n#### Steps to reproduce the behaviour\r\n\r\nI started the sync about a week ago. It seemed to be going okay, but I didn't watch it very closely. The last two days, when I looked at it, it seems to be restarting the `Generate Storage History` stage, but I couldn't tell. Today, I watched and saw the following message. I've highlighted the important **error message**:\r\n\r\n```\r\n058\r\nINFO [10-08|19:36:44.179] ETL [1/2] Extracting                     from=PLAIN-SCS block=10685795 alloc=1.42GiB    sys=3.80GiB   numGC=1058\r\nINFO [10-08|19:37:20.773] Flushed buffer file                      name=/Volumes/Samsung_T4/turbo_geth/etl-temp/tg-sync-sortable-buf771037646 alloc=1.23GiB    sys=3.80GiB   numGC=1065\r\nINFO [10-08|19:37:20.851] ETL [1/2] Extracting                     from=PLAIN-SCS block=10709696 alloc=1.23GiB    sys=3.80GiB   numGC=1065\r\nINFO [10-08|19:37:44.178] ETL [1/2] Extracting                     from=PLAIN-SCS block=10729991 alloc=631.10MiB  sys=3.80GiB   numGC=1070\r\nINFO [10-08|19:37:59.810] Flushed buffer file                      name=/Volumes/Samsung_T4/turbo_geth/etl-temp/tg-sync-sortable-buf583157461 alloc=1.33GiB    sys=3.80GiB   numGC=1072\r\nINFO [10-08|19:38:14.178] ETL [1/2] Extracting                     from=PLAIN-SCS block=10748149 alloc=652.08MiB  sys=3.80GiB   numGC=1074\r\nINFO [10-08|19:38:38.652] Flushed buffer file                      name=/Volumes/Samsung_T4/turbo_geth/etl-temp/tg-sync-sortable-buf771943984 alloc=1.52GiB    sys=3.80GiB   numGC=1078\r\nINFO [10-08|19:38:44.178] ETL [1/2] Extracting                     from=PLAIN-SCS block=10766579 alloc=301.41MiB  sys=3.80GiB   numGC=1080\r\nINFO [10-08|19:39:21.102] etl: temp files removed successfully     total size=\"46.8 GB\"\r\n\r\n**\r\nWARN [10-08|19:39:22.974] Synchronisation failed, retrying         err=\"storage history index: fail to generate index: open /Volumes/Samsung_T4/turbo_geth/etl-temp/tg-sync-sortable-buf002894799: too many open files\"\r\nWARN [10-08|19:39:27.548] Multiple headers for single request      peer=59c94b9d4eb85f33 headers=0\r\nWARN [10-08|19:39:27.548] Synchronisation failed, dropping peer    peer=59c94b9d4eb85f33 err=\"action from bad peer ignored: multiple headers (0) for single request\"\r\n**\r\n\r\nINFO [10-08|19:39:28.071] Sync stage 1/13. Download headers...\r\nspawn sync 2\r\nINFO [10-08|19:39:28.911] Imported new block headers               count=384 elapsed=494.616ms number=11017755 hash=\"6738faâ€¦352bc2\" age=23m12s\r\n```\r\n\r\nAfter that message I killed the process (sorry no stack trace), and restarted the sync. Everything went well until the `Generate Storage History`, which had previously appeared to have finished, started over at block `3444312`.\r\n\r\nThe message `too many open files` is of interest.\r\n\r\nI'm not sure, but it feels like this happened more than once (as I said, it felt like it did, but I wasn't previously watching closely enough).",
  "closed_by": {
    "login": "AlexeyAkhunov",
    "id": 13686139,
    "node_id": "MDQ6VXNlcjEzNjg2MTM5",
    "avatar_url": "https://avatars.githubusercontent.com/u/13686139?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/AlexeyAkhunov",
    "html_url": "https://github.com/AlexeyAkhunov",
    "followers_url": "https://api.github.com/users/AlexeyAkhunov/followers",
    "following_url": "https://api.github.com/users/AlexeyAkhunov/following{/other_user}",
    "gists_url": "https://api.github.com/users/AlexeyAkhunov/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/AlexeyAkhunov/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/AlexeyAkhunov/subscriptions",
    "organizations_url": "https://api.github.com/users/AlexeyAkhunov/orgs",
    "repos_url": "https://api.github.com/users/AlexeyAkhunov/repos",
    "events_url": "https://api.github.com/users/AlexeyAkhunov/events{/privacy}",
    "received_events_url": "https://api.github.com/users/AlexeyAkhunov/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/1211/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/1211/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/706013403",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/1211#issuecomment-706013403",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/1211",
    "id": 706013403,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcwNjAxMzQwMw==",
    "user": {
      "login": "AlexeyAkhunov",
      "id": 13686139,
      "node_id": "MDQ6VXNlcjEzNjg2MTM5",
      "avatar_url": "https://avatars.githubusercontent.com/u/13686139?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AlexeyAkhunov",
      "html_url": "https://github.com/AlexeyAkhunov",
      "followers_url": "https://api.github.com/users/AlexeyAkhunov/followers",
      "following_url": "https://api.github.com/users/AlexeyAkhunov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AlexeyAkhunov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AlexeyAkhunov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AlexeyAkhunov/subscriptions",
      "organizations_url": "https://api.github.com/users/AlexeyAkhunov/orgs",
      "repos_url": "https://api.github.com/users/AlexeyAkhunov/repos",
      "events_url": "https://api.github.com/users/AlexeyAkhunov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AlexeyAkhunov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-10-09T07:11:26Z",
    "updated_at": "2020-10-09T07:11:26Z",
    "author_association": "CONTRIBUTOR",
    "body": "Maybe you can bring back these files (I removed them some time ago) back to fix this: https://github.com/ethereum/go-ethereum/tree/master/common/fdlimit",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/706013403/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/706463668",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/1211#issuecomment-706463668",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/1211",
    "id": 706463668,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcwNjQ2MzY2OA==",
    "user": {
      "login": "tjayrush",
      "id": 5417918,
      "node_id": "MDQ6VXNlcjU0MTc5MTg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5417918?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tjayrush",
      "html_url": "https://github.com/tjayrush",
      "followers_url": "https://api.github.com/users/tjayrush/followers",
      "following_url": "https://api.github.com/users/tjayrush/following{/other_user}",
      "gists_url": "https://api.github.com/users/tjayrush/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tjayrush/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tjayrush/subscriptions",
      "organizations_url": "https://api.github.com/users/tjayrush/orgs",
      "repos_url": "https://api.github.com/users/tjayrush/repos",
      "events_url": "https://api.github.com/users/tjayrush/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tjayrush/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-10-10T01:30:47Z",
    "updated_at": "2020-10-10T01:30:47Z",
    "author_association": "CONTRIBUTOR",
    "body": "Problem may be in this commit: https://github.com/ledgerwatch/turbo-geth/commit/961b1d57c4efc1cf658ce73fd4050238ea11c767. I'll put this code back and see if that fixes the problem.",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/706463668/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/706538117",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/1211#issuecomment-706538117",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/1211",
    "id": 706538117,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcwNjUzODExNw==",
    "user": {
      "login": "tjayrush",
      "id": 5417918,
      "node_id": "MDQ6VXNlcjU0MTc5MTg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5417918?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tjayrush",
      "html_url": "https://github.com/tjayrush",
      "followers_url": "https://api.github.com/users/tjayrush/followers",
      "following_url": "https://api.github.com/users/tjayrush/following{/other_user}",
      "gists_url": "https://api.github.com/users/tjayrush/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tjayrush/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tjayrush/subscriptions",
      "organizations_url": "https://api.github.com/users/tjayrush/orgs",
      "repos_url": "https://api.github.com/users/tjayrush/repos",
      "events_url": "https://api.github.com/users/tjayrush/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tjayrush/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-10-10T11:59:57Z",
    "updated_at": "2020-10-10T11:59:57Z",
    "author_association": "CONTRIBUTOR",
    "body": "I added back code to the increase in file descriptors as mentioned above, but before I did I ran the sync which watching how many open files the process had (`lsof -p <PID>`). The number of open files definitely went over 256 (which is the default max on my machine apparently).\r\n\r\nPrior to the change, the problem was easily repeatable (ignoring the fact it took a long time) and the sync would not proceed past Generate Storage History (stage 9 of 13).\r\n\r\nAfter the change, it works.\r\n\r\nPR incoming...",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/706538117/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
