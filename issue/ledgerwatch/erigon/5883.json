{
  "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5883",
  "repository_url": "https://api.github.com/repos/ledgerwatch/erigon",
  "labels_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5883/labels{/name}",
  "comments_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5883/comments",
  "events_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5883/events",
  "html_url": "https://github.com/ledgerwatch/erigon/issues/5883",
  "id": 1426067430,
  "node_id": "I_kwDOC0FsAM5VAA_m",
  "number": 5883,
  "title": "trace_call on bsc not working if it involves transferFrom at some point (same issue with estimate_gas)",
  "user": {
    "login": "DeepBorys",
    "id": 25698925,
    "node_id": "MDQ6VXNlcjI1Njk4OTI1",
    "avatar_url": "https://avatars.githubusercontent.com/u/25698925?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/DeepBorys",
    "html_url": "https://github.com/DeepBorys",
    "followers_url": "https://api.github.com/users/DeepBorys/followers",
    "following_url": "https://api.github.com/users/DeepBorys/following{/other_user}",
    "gists_url": "https://api.github.com/users/DeepBorys/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/DeepBorys/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/DeepBorys/subscriptions",
    "organizations_url": "https://api.github.com/users/DeepBorys/orgs",
    "repos_url": "https://api.github.com/users/DeepBorys/repos",
    "events_url": "https://api.github.com/users/DeepBorys/events{/privacy}",
    "received_events_url": "https://api.github.com/users/DeepBorys/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 4566396003,
      "node_id": "LA_kwDOC0FsAM8AAAABEC2sYw",
      "url": "https://api.github.com/repos/ledgerwatch/erigon/labels/Stale",
      "name": "Stale",
      "color": "ededed",
      "default": false,
      "description": null
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2022-10-27T18:01:48Z",
  "updated_at": "2022-12-15T02:38:54Z",
  "closed_at": "2022-12-15T02:38:54Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "#### System information\r\n\r\nErigon version: version 2.28.1-stable-9711af6d\r\n\r\nOS & Version: Ubuntu\r\n\r\n#### Expected behaviour\r\n\r\nI have the following transaction, that involves swapping BUSD for another coin.\r\n\r\n{'nonce': '0xa', 'gasprice': '0x12a05f200', 'startgas': '0x2bc2f', 'to': '0x10ed43c718714eb63d5aa57b78b54704e256024e', 'value': '0x0', 'data': '0x18cbafe50000000000000000000000000000000000000000000000001bc16d674ec800000000000000000000000000000000000000000000000000000013b202e78f805400000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000d8eee3054a7ab81eafde847633dd191674e1542c00000000000000000000000000000000000000000000000000000000635ac86f0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000e9e7cea3dedca5984780bafc599bd69add087d56000000000000000000000000bb4cdb9cbd36b01bd1cbaebf2de08d9173bc095c', 'v': '0x93', 'r': '0xff44e6303af82ec98e36af260e036c3654400cc75bf42465cea7c6fe01df34b8', 's': '0x3cc5dcb8edad0ddcc6d22bcf629958904828a120c48fb0d9034f8b059ac57917', 'sender': '0xd8eee3054a7ab81eafde847633dd191674e1542c', 'hash': '0x995e48ead4bef7833ac316a2d2ac831059a7c46afc7608ab7cdc15b7d70008bc'}\r\n\r\nWhen I run trace_transaction after it was already mined. The trace comes back exactly as it should\r\nprovider.make_request('trace_transaction', [tx_dict['hash']])\r\n\r\nThe input to transferFrom is the following below. \r\n\r\n'0x23b872dd000000000000000000000000d8eee3054a7ab81eafde847633dd191674e1542c00000000000000000000000058f876857a02d6762e0101bb5c46a8c1ed44dc160000000000000000000000000000000000000000000000001bc16d674ec80000'\r\n\r\nWhole trace below\r\n\r\n{'id': 9497,\r\n 'jsonrpc': '2.0',\r\n 'result': [{'action': {'callType': 'call',\r\n                        'from': '0xd8eee3054a7ab81eafde847633dd191674e1542c',\r\n                        'gas': '0x26233',\r\n                        'input': '0x18cbafe50000000000000000000000000000000000000000000000001bc16d674ec800000000000000000000000000000000000000000000000000000013b202e78f805400000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000d8eee3054a7ab81eafde847633dd191674e1542c00000000000000000000000000000000000000000000000000000000635ac86f0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000e9e7cea3dedca5984780bafc599bd69add087d56000000000000000000000000bb4cdb9cbd36b01bd1cbaebf2de08d9173bc095c',\r\n                        'to': '0x10ed43c718714eb63d5aa57b78b54704e256024e',\r\n                        'value': '0x0'},\r\n             'blockHash': '0x500f60bf6082fb42e1d19a1e69ef8282ecdb7f270dcf05a9f8ec8c46421a42fd',\r\n             'blockNumber': 22544628,\r\n             'result': {'gasUsed': '0x21b32',\r\n                        'output': '0x000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000001bc16d674ec8000000000000000000000000000000000000000000000000000000189e6d0cec1a4e'},\r\n             'subtraces': 5,\r\n             'traceAddress': [],\r\n             'transactionHash': '0x995e48ead4bef7833ac316a2d2ac831059a7c46afc7608ab7cdc15b7d70008bc',\r\n             'transactionPosition': 85,\r\n             'type': 'call'},\r\n            {'action': {'callType': 'staticcall',\r\n                        'from': '0x10ed43c718714eb63d5aa57b78b54704e256024e',\r\n                        'gas': '0x24870',\r\n                        'input': '0x0902f1ac',\r\n                        'to': '0x58f876857a02d6762e0101bb5c46a8c1ed44dc16',\r\n                        'value': '0x0'},\r\n             'blockHash': '0x500f60bf6082fb42e1d19a1e69ef8282ecdb7f270dcf05a9f8ec8c46421a42fd',\r\n             'blockNumber': 22544628,\r\n             'result': {'gasUsed': '0xbb1',\r\n                        'output': '0x000000000000000000000000000000000000000000004b02e070df3e7e6f5557000000000000000000000000000000000000000000545b6b54537480530ff8b400000000000000000000000000000000000000000000000000000000635ac3da'},\r\n             'subtraces': 0,\r\n             'traceAddress': [0],\r\n             'transactionHash': '0x995e48ead4bef7833ac316a2d2ac831059a7c46afc7608ab7cdc15b7d70008bc',\r\n             'transactionPosition': 85,\r\n             'type': 'call'},\r\n            {'action': {'callType': 'call',\r\n                        'from': '0x10ed43c718714eb63d5aa57b78b54704e256024e',\r\n                        'gas': '0x22fc0',\r\n                        'input': '**0x23b872dd000000000000000000000000d8eee3054a7ab81eafde847633dd191674e1542c00000000000000000000000058f876857a02d6762e0101bb5c46a8c1ed44dc160000000000000000000000000000000000000000000000001bc16d674ec80000**',\r\n                        'to': '0xe9e7cea3dedca5984780bafc599bd69add087d56',\r\n                        'value': '0x0'},\r\n             'blockHash': '0x500f60bf6082fb42e1d19a1e69ef8282ecdb7f270dcf05a9f8ec8c46421a42fd',\r\n             'blockNumber': 22544628,\r\n             'result': {'gasUsed': '0x5932',\r\n                        'output': '0x0000000000000000000000000000000000000000000000000000000000000001'},\r\n             'subtraces': 0,\r\n             'traceAddress': [1],\r\n             'transactionHash': '0x995e48ead4bef7833ac316a2d2ac831059a7c46afc7608ab7cdc15b7d70008bc',\r\n             'transactionPosition': 85,\r\n             'type': 'call'},\r\n\r\n#### Actual behaviour\r\n\r\nWhen I run trace_call before the transaction was mined.\r\nprovider.make_request('trace_call', [tx_dict,[\"trace\"], \"latest\"])\r\n\r\nThe trace comes back with an error, and the actual input to transferFrom is different.\r\n\r\n'0x23b872dd000000000000000000000000000000000000000000000000000000000000000000000000000000000000000058f876857a02d6762e0101bb5c46a8c1ed44dc160000000000000000000000000000000000000000000000001bc16d674ec80000'\r\n\r\nIt tries to transfer BUSD from burn address (0x0000...) instead of the correct one. Note that the first call to router has the exact same input as the one from trace_transaction, only at the transferFrom step it goes bad.\r\n\r\n{'id': 9496,\r\n 'jsonrpc': '2.0',\r\n 'result': {'output': '0x08c379a0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000245472616e7366657248656c7065723a205452414e534645525f46524f4d5f4641494c454400000000000000000000000000000000000000000000000000000000',\r\n            'stateDiff': None,\r\n            'trace': [{'action': {'callType': 'call',\r\n                                  'from': '0x0000000000000000000000000000000000000000',\r\n                                  'gas': '0x2fa9684',\r\n                                  'input': '0x18cbafe50000000000000000000000000000000000000000000000001bc16d674ec800000000000000000000000000000000000000000000000000000013b202e78f805400000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000d8eee3054a7ab81eafde847633dd191674e1542c00000000000000000000000000000000000000000000000000000000635ac86f0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000e9e7cea3dedca5984780bafc599bd69add087d56000000000000000000000000bb4cdb9cbd36b01bd1cbaebf2de08d9173bc095c',\r\n                                  'to': '0x10ed43c718714eb63d5aa57b78b54704e256024e',\r\n                                  'value': '0x0'},\r\n                       'error': 'Reverted',\r\n                       'result': {'gasUsed': '0x2cd4',\r\n                                  'output': '0x08c379a0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000245472616e7366657248656c7065723a205452414e534645525f46524f4d5f4641494c454400000000000000000000000000000000000000000000000000000000'},\r\n                       'subtraces': 2,\r\n                       'traceAddress': [],\r\n                       'type': 'call'},\r\n                      {'action': {'callType': 'staticcall',\r\n                                  'from': '0x10ed43c718714eb63d5aa57b78b54704e256024e',\r\n                                  'gas': '0x2ee9bef',\r\n                                  'input': '0x0902f1ac',\r\n                                  'to': '0x58f876857a02d6762e0101bb5c46a8c1ed44dc16',\r\n                                  'value': '0x0'},\r\n                       'result': {'gasUsed': '0xbb1',\r\n                                  'output': '0x000000000000000000000000000000000000000000004b02e070df3e7e6f5557000000000000000000000000000000000000000000545b6b54537480530ff8b400000000000000000000000000000000000000000000000000000000635ac3da'},\r\n                       'subtraces': 0,\r\n                       'traceAddress': [0],\r\n                       'type': 'call'},\r\n                      {'action': {'callType': 'call',\r\n                                  'from': '0x10ed43c718714eb63d5aa57b78b54704e256024e',\r\n                                  'gas': '0x2ee8340',\r\n                                  'input': '**0x23b872dd000000000000000000000000000000000000000000000000000000000000000000000000000000000000000058f876857a02d6762e0101bb5c46a8c1ed44dc160000000000000000000000000000000000000000000000001bc16d674ec80000**',\r\n                                  'to': '0xe9e7cea3dedca5984780bafc599bd69add087d56',\r\n                                  'value': '0x0'},\r\n                       'error': 'Reverted',\r\n                       'result': {'gasUsed': '0x20f',\r\n                                  'output': '0x08c379a00000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000002542455032303a207472616e736665722066726f6d20746865207a65726f2061646472657373000000000000000000000000000000000000000000000000000000'},\r\n                       'subtraces': 0,\r\n                       'traceAddress': [1],\r\n                       'type': 'call'}],\r\n            'vmTrace': None}}\r\n\r\n#### Steps to reproduce the behaviour\r\n\r\nEvery trace_call of a trade that includes transferFrom has the same mistake. Router calls the coin contract with incorrect input, transaction gets reverted.\r\n\r\nFor transactions that do not involve transferFrom, like swapBNBForExactToken trace_call works fine.\r\n\r\nEDIT:\r\n\r\nI tried to run estimate_gas for those transactions.\r\n\r\nprovider.make_request('eth_estimateGas', [tx_dict])\r\n\r\nAnd estimate_gas runs into the same problem with transferFrom\r\n\r\n{'jsonrpc': '2.0', 'id': 6150, 'error': {'code': 3, 'message': 'execution reverted: TransferHelper: TRANSFER_FROM_FAILED', 'data': '0x08c379a0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000245472616e7366657248656c7065723a205452414e534645525f46524f4d5f4641494c454400000000000000000000000000000000000000000000000000000000'}}\r\n\r\nAnd the transaction mines with no issue.",
  "closed_by": {
    "login": "github-actions[bot]",
    "id": 41898282,
    "node_id": "MDM6Qm90NDE4OTgyODI=",
    "avatar_url": "https://avatars.githubusercontent.com/in/15368?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/github-actions%5Bbot%5D",
    "html_url": "https://github.com/apps/github-actions",
    "followers_url": "https://api.github.com/users/github-actions%5Bbot%5D/followers",
    "following_url": "https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}",
    "gists_url": "https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/github-actions%5Bbot%5D/subscriptions",
    "organizations_url": "https://api.github.com/users/github-actions%5Bbot%5D/orgs",
    "repos_url": "https://api.github.com/users/github-actions%5Bbot%5D/repos",
    "events_url": "https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}",
    "received_events_url": "https://api.github.com/users/github-actions%5Bbot%5D/received_events",
    "type": "Bot",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5883/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5883/timeline",
  "performed_via_github_app": null,
  "state_reason": "not_planned"
}
[
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1340296151",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/5883#issuecomment-1340296151",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5883",
    "id": 1340296151,
    "node_id": "IC_kwDOC0FsAM5P40vX",
    "user": {
      "login": "github-actions[bot]",
      "id": 41898282,
      "node_id": "MDM6Qm90NDE4OTgyODI=",
      "avatar_url": "https://avatars.githubusercontent.com/in/15368?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/github-actions%5Bbot%5D",
      "html_url": "https://github.com/apps/github-actions",
      "followers_url": "https://api.github.com/users/github-actions%5Bbot%5D/followers",
      "following_url": "https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}",
      "gists_url": "https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/github-actions%5Bbot%5D/subscriptions",
      "organizations_url": "https://api.github.com/users/github-actions%5Bbot%5D/orgs",
      "repos_url": "https://api.github.com/users/github-actions%5Bbot%5D/repos",
      "events_url": "https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}",
      "received_events_url": "https://api.github.com/users/github-actions%5Bbot%5D/received_events",
      "type": "Bot",
      "site_admin": false
    },
    "created_at": "2022-12-07T02:40:43Z",
    "updated_at": "2022-12-07T02:40:43Z",
    "author_association": "NONE",
    "body": "This issue is stale because it has been open for 40 days with no activity. Remove stale label or comment, or this will be closed in 7 days.",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1340296151/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1352481173",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/5883#issuecomment-1352481173",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5883",
    "id": 1352481173,
    "node_id": "IC_kwDOC0FsAM5QnTmV",
    "user": {
      "login": "github-actions[bot]",
      "id": 41898282,
      "node_id": "MDM6Qm90NDE4OTgyODI=",
      "avatar_url": "https://avatars.githubusercontent.com/in/15368?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/github-actions%5Bbot%5D",
      "html_url": "https://github.com/apps/github-actions",
      "followers_url": "https://api.github.com/users/github-actions%5Bbot%5D/followers",
      "following_url": "https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}",
      "gists_url": "https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/github-actions%5Bbot%5D/subscriptions",
      "organizations_url": "https://api.github.com/users/github-actions%5Bbot%5D/orgs",
      "repos_url": "https://api.github.com/users/github-actions%5Bbot%5D/repos",
      "events_url": "https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}",
      "received_events_url": "https://api.github.com/users/github-actions%5Bbot%5D/received_events",
      "type": "Bot",
      "site_admin": false
    },
    "created_at": "2022-12-15T02:38:54Z",
    "updated_at": "2022-12-15T02:38:54Z",
    "author_association": "NONE",
    "body": "This issue was closed because it has been stalled for 7 days with no activity.",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1352481173/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
