{
  "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6936",
  "repository_url": "https://api.github.com/repos/ledgerwatch/erigon",
  "labels_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6936/labels{/name}",
  "comments_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6936/comments",
  "events_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6936/events",
  "html_url": "https://github.com/ledgerwatch/erigon/issues/6936",
  "id": 1596274440,
  "node_id": "I_kwDOC0FsAM5fJTcI",
  "number": 6936,
  "title": "Optimize some RPC requests internally",
  "user": {
    "login": "ozgrakkurt",
    "id": 91746947,
    "node_id": "U_kgDOBXfygw",
    "avatar_url": "https://avatars.githubusercontent.com/u/91746947?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ozgrakkurt",
    "html_url": "https://github.com/ozgrakkurt",
    "followers_url": "https://api.github.com/users/ozgrakkurt/followers",
    "following_url": "https://api.github.com/users/ozgrakkurt/following{/other_user}",
    "gists_url": "https://api.github.com/users/ozgrakkurt/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ozgrakkurt/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ozgrakkurt/subscriptions",
    "organizations_url": "https://api.github.com/users/ozgrakkurt/orgs",
    "repos_url": "https://api.github.com/users/ozgrakkurt/repos",
    "events_url": "https://api.github.com/users/ozgrakkurt/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ozgrakkurt/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 4566396003,
      "node_id": "LA_kwDOC0FsAM8AAAABEC2sYw",
      "url": "https://api.github.com/repos/ledgerwatch/erigon/labels/Stale",
      "name": "Stale",
      "color": "ededed",
      "default": false,
      "description": null
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 6,
  "created_at": "2023-02-23T06:04:33Z",
  "updated_at": "2023-04-12T02:20:08Z",
  "closed_at": "2023-04-12T02:20:08Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "Hey!\r\n\r\nIt seems like a batch of getBlockByNumber or a batch of getTransactionReceipt requests are handled in different goroutines. And this seems like it would be a big performance bottleneck.\r\n\r\nWould it make sense to just recognize when the request is a batch of consecutive getBlockByNumber requests and convert it into a single internal request and handle it that way?\r\n\r\nI am willing to implement this with some guidance",
  "closed_by": {
    "login": "github-actions[bot]",
    "id": 41898282,
    "node_id": "MDM6Qm90NDE4OTgyODI=",
    "avatar_url": "https://avatars.githubusercontent.com/in/15368?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/github-actions%5Bbot%5D",
    "html_url": "https://github.com/apps/github-actions",
    "followers_url": "https://api.github.com/users/github-actions%5Bbot%5D/followers",
    "following_url": "https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}",
    "gists_url": "https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/github-actions%5Bbot%5D/subscriptions",
    "organizations_url": "https://api.github.com/users/github-actions%5Bbot%5D/orgs",
    "repos_url": "https://api.github.com/users/github-actions%5Bbot%5D/repos",
    "events_url": "https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}",
    "received_events_url": "https://api.github.com/users/github-actions%5Bbot%5D/received_events",
    "type": "Bot",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6936/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6936/timeline",
  "performed_via_github_app": null,
  "state_reason": "not_planned"
}
[
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1441447059",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/6936#issuecomment-1441447059",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6936",
    "id": 1441447059,
    "node_id": "IC_kwDOC0FsAM5V6ryT",
    "user": {
      "login": "AskAlexSharov",
      "id": 46885206,
      "node_id": "MDQ6VXNlcjQ2ODg1MjA2",
      "avatar_url": "https://avatars.githubusercontent.com/u/46885206?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AskAlexSharov",
      "html_url": "https://github.com/AskAlexSharov",
      "followers_url": "https://api.github.com/users/AskAlexSharov/followers",
      "following_url": "https://api.github.com/users/AskAlexSharov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AskAlexSharov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AskAlexSharov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AskAlexSharov/subscriptions",
      "organizations_url": "https://api.github.com/users/AskAlexSharov/orgs",
      "repos_url": "https://api.github.com/users/AskAlexSharov/repos",
      "events_url": "https://api.github.com/users/AskAlexSharov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AskAlexSharov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-02-23T09:34:40Z",
    "updated_at": "2023-02-23T09:34:40Z",
    "author_association": "COLLABORATOR",
    "body": "@ozgrakkurt \r\n1. fyi we have --rpc.batch.concurrency, --rpc.batch.limit\r\n2. such solution may be good, but has much corner-cases:\r\n- what if all this requests are for old historical blocks (which are not in PageCache)? In this case you may want to parallelize them just because all of them will be disk-io-bounded (also it depends on disk type)\r\n- what if some software like TheGraph want to fetch all historical blocks? (They likely can control parallelism on their end by controlling amount/size of batches). \r\n- do you think it will give us good performance profit for hot-recent blocks which are in baseApi.blocksLRU? I mean - maybe bottleneck is not in goroutines, but in json marshal/unmarshal. \r\n3. what is your use-case?\r\n4. we have streaming support - in theory can send response to client when it's ready. But some users asked us to preserve order of request/response in batch (event that there is requrestID). Make something non-concurrent way will give use obvious order preserving and we can stream responses in this case. \r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1441447059/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1441578214",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/6936#issuecomment-1441578214",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6936",
    "id": 1441578214,
    "node_id": "IC_kwDOC0FsAM5V7Lzm",
    "user": {
      "login": "ozgrakkurt",
      "id": 91746947,
      "node_id": "U_kgDOBXfygw",
      "avatar_url": "https://avatars.githubusercontent.com/u/91746947?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ozgrakkurt",
      "html_url": "https://github.com/ozgrakkurt",
      "followers_url": "https://api.github.com/users/ozgrakkurt/followers",
      "following_url": "https://api.github.com/users/ozgrakkurt/following{/other_user}",
      "gists_url": "https://api.github.com/users/ozgrakkurt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ozgrakkurt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ozgrakkurt/subscriptions",
      "organizations_url": "https://api.github.com/users/ozgrakkurt/orgs",
      "repos_url": "https://api.github.com/users/ozgrakkurt/repos",
      "events_url": "https://api.github.com/users/ozgrakkurt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ozgrakkurt/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-02-23T11:14:11Z",
    "updated_at": "2023-02-23T11:14:33Z",
    "author_association": "NONE",
    "body": "1. I tried those but couldn't get it to be significantly faster\r\n2. My use case is the same as TheGraph. I am getting all data sequentially using batched getBlockByNumber reqs and getLogs reqs. I was guessing this data is fairly sequential in kv-store so opening an iterator and going through it would be more efficient than making parallel get requests.\r\n4. I'm using HTTP and the code needs to be compatible with many rpc providers so I don't think streaming support would work for me.",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1441578214/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1442677227",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/6936#issuecomment-1442677227",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6936",
    "id": 1442677227,
    "node_id": "IC_kwDOC0FsAM5V_YHr",
    "user": {
      "login": "AskAlexSharov",
      "id": 46885206,
      "node_id": "MDQ6VXNlcjQ2ODg1MjA2",
      "avatar_url": "https://avatars.githubusercontent.com/u/46885206?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AskAlexSharov",
      "html_url": "https://github.com/AskAlexSharov",
      "followers_url": "https://api.github.com/users/AskAlexSharov/followers",
      "following_url": "https://api.github.com/users/AskAlexSharov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AskAlexSharov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AskAlexSharov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AskAlexSharov/subscriptions",
      "organizations_url": "https://api.github.com/users/AskAlexSharov/orgs",
      "repos_url": "https://api.github.com/users/AskAlexSharov/repos",
      "events_url": "https://api.github.com/users/AskAlexSharov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AskAlexSharov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-02-24T01:44:13Z",
    "updated_at": "2023-02-24T01:44:13Z",
    "author_association": "COLLABORATOR",
    "body": "- “ fairly sequential in kv-store so opening an iterator and going through it would be more efficient than making parallel get requests” - you are right - yes, we moving from O(log n) to O(1). but true is Data >> Ram and disk touches may eat the difference anyway and json may eat the difference. Also FYI complexity of Get from frozendb (snapshots folder) is O(1) (but need touch semi-random place of .idx file). So, it can be a good idea, but need bench, my head can’t estimate.\r\n- streaming is optional \r\n- FYI: Some disks like gp3 are tuned for high parallel throughput and high latency\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1442677227/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1442679599",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/6936#issuecomment-1442679599",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6936",
    "id": 1442679599,
    "node_id": "IC_kwDOC0FsAM5V_Ysv",
    "user": {
      "login": "keithchew",
      "id": 5557929,
      "node_id": "MDQ6VXNlcjU1NTc5Mjk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5557929?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/keithchew",
      "html_url": "https://github.com/keithchew",
      "followers_url": "https://api.github.com/users/keithchew/followers",
      "following_url": "https://api.github.com/users/keithchew/following{/other_user}",
      "gists_url": "https://api.github.com/users/keithchew/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/keithchew/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/keithchew/subscriptions",
      "organizations_url": "https://api.github.com/users/keithchew/orgs",
      "repos_url": "https://api.github.com/users/keithchew/repos",
      "events_url": "https://api.github.com/users/keithchew/events{/privacy}",
      "received_events_url": "https://api.github.com/users/keithchew/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-02-24T01:48:01Z",
    "updated_at": "2023-02-24T01:48:01Z",
    "author_association": "NONE",
    "body": "@ozgrakkurt what kind of numbers are you getting, eg what is your current blocks/s read rate, and what is the rate you are trying to achieve. ",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1442679599/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1496821462",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/6936#issuecomment-1496821462",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6936",
    "id": 1496821462,
    "node_id": "IC_kwDOC0FsAM5ZN67W",
    "user": {
      "login": "github-actions[bot]",
      "id": 41898282,
      "node_id": "MDM6Qm90NDE4OTgyODI=",
      "avatar_url": "https://avatars.githubusercontent.com/in/15368?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/github-actions%5Bbot%5D",
      "html_url": "https://github.com/apps/github-actions",
      "followers_url": "https://api.github.com/users/github-actions%5Bbot%5D/followers",
      "following_url": "https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}",
      "gists_url": "https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/github-actions%5Bbot%5D/subscriptions",
      "organizations_url": "https://api.github.com/users/github-actions%5Bbot%5D/orgs",
      "repos_url": "https://api.github.com/users/github-actions%5Bbot%5D/repos",
      "events_url": "https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}",
      "received_events_url": "https://api.github.com/users/github-actions%5Bbot%5D/received_events",
      "type": "Bot",
      "site_admin": false
    },
    "created_at": "2023-04-05T02:03:57Z",
    "updated_at": "2023-04-05T02:03:57Z",
    "author_association": "NONE",
    "body": "This issue is stale because it has been open for 40 days with no activity. Remove stale label or comment, or this will be closed in 7 days.",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1496821462/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1504446817",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/6936#issuecomment-1504446817",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6936",
    "id": 1504446817,
    "node_id": "IC_kwDOC0FsAM5ZrAlh",
    "user": {
      "login": "github-actions[bot]",
      "id": 41898282,
      "node_id": "MDM6Qm90NDE4OTgyODI=",
      "avatar_url": "https://avatars.githubusercontent.com/in/15368?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/github-actions%5Bbot%5D",
      "html_url": "https://github.com/apps/github-actions",
      "followers_url": "https://api.github.com/users/github-actions%5Bbot%5D/followers",
      "following_url": "https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}",
      "gists_url": "https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/github-actions%5Bbot%5D/subscriptions",
      "organizations_url": "https://api.github.com/users/github-actions%5Bbot%5D/orgs",
      "repos_url": "https://api.github.com/users/github-actions%5Bbot%5D/repos",
      "events_url": "https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}",
      "received_events_url": "https://api.github.com/users/github-actions%5Bbot%5D/received_events",
      "type": "Bot",
      "site_admin": false
    },
    "created_at": "2023-04-12T02:20:07Z",
    "updated_at": "2023-04-12T02:20:07Z",
    "author_association": "NONE",
    "body": "This issue was closed because it has been stalled for 7 days with no activity.",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1504446817/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
