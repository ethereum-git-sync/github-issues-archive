{
  "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/1743",
  "repository_url": "https://api.github.com/repos/ledgerwatch/erigon",
  "labels_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/1743/labels{/name}",
  "comments_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/1743/comments",
  "events_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/1743/events",
  "html_url": "https://github.com/ledgerwatch/erigon/issues/1743",
  "id": 860700088,
  "node_id": "MDU6SXNzdWU4NjA3MDAwODg=",
  "number": 1743,
  "title": "headers.v2 download with external sentry hangs idle",
  "user": {
    "login": "battlmonstr",
    "id": 11477595,
    "node_id": "MDQ6VXNlcjExNDc3NTk1",
    "avatar_url": "https://avatars.githubusercontent.com/u/11477595?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/battlmonstr",
    "html_url": "https://github.com/battlmonstr",
    "followers_url": "https://api.github.com/users/battlmonstr/followers",
    "following_url": "https://api.github.com/users/battlmonstr/following{/other_user}",
    "gists_url": "https://api.github.com/users/battlmonstr/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/battlmonstr/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/battlmonstr/subscriptions",
    "organizations_url": "https://api.github.com/users/battlmonstr/orgs",
    "repos_url": "https://api.github.com/users/battlmonstr/repos",
    "events_url": "https://api.github.com/users/battlmonstr/events{/privacy}",
    "received_events_url": "https://api.github.com/users/battlmonstr/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2021-04-18T16:05:49Z",
  "updated_at": "2021-05-26T17:01:19Z",
  "closed_at": "2021-05-26T17:01:19Z",
  "author_association": "COLLABORATOR",
  "active_lock_reason": null,
  "body": "#### System information\r\n\r\nOS & Version: macOS 10.15.6\r\nCommit hash : 368f37a02ffa71eb9432695aa18ad63886e8652a\r\n\r\n#### Expected behaviour\r\n\r\nThe block headers start to be downloaded and progress is reported incrementally.\r\n\r\n#### Actual behaviour\r\n\r\nThe data dir is created with about 3Mb, and then nothing happens.\r\nEvery 30 sec it prints:\r\n\r\n    INFO [04-18|17:54:49.879] [1/3 Headers] Processing headers...      from=0\r\n\r\n#### Steps to reproduce the behaviour\r\n\r\nCheckout [rust sentry](https://github.com/rust-ethereum/sentry), and `cargo run` it.\r\n\r\nRun \"download.v2\" with external sentry:\r\n\r\n     make\r\n    ./build/bin/tg --download.v2 --datadir ../tgdata/goerli --chain goerli --sentry.api.addr localhost:8000\r\n\r\n\r\n(old) Run [headers download with external sentry](https://github.com/ledgerwatch/turbo-geth/tree/master/cmd/headers#running-with-an-external-p2p-sentry):\r\n\r\n    make headers\r\n    ./build/bin/headers download --datadir ../tgdata/goerli --chain goerli --sentry.api.addr localhost:8000\r\n\r\n\r\n#### Debugging\r\n\r\n[stage_headers_new.go HeadersForward has a loop](https://github.com/ledgerwatch/turbo-geth/blob/master/eth/stagedsync/stage_headers_new.go#L91) where:\r\n- [`req = hd.RequestMoreHeaders`](https://github.com/ledgerwatch/turbo-geth/blob/master/eth/stagedsync/stage_headers_new.go#L93) always returns nil (due to `hd.anchorQueue.Len() == 0`)\r\n- [`req = hd.RequestSkeleton`](https://github.com/ledgerwatch/turbo-geth/blob/master/eth/stagedsync/stage_headers_new.go#L114) returns nil (due to `hd.topSeenHeight < hd.highestInDb+stride`, as topSeenHeight = 0 and highestInDb = 0)\r\n- the loop will pause for [1 sec timer](https://github.com/ledgerwatch/turbo-geth/blob/master/eth/stagedsync/stage_headers_new.go#L137) and repeat\r\nthus `headerReqSend` is never called!\r\n",
  "closed_by": {
    "login": "AlexeyAkhunov",
    "id": 13686139,
    "node_id": "MDQ6VXNlcjEzNjg2MTM5",
    "avatar_url": "https://avatars.githubusercontent.com/u/13686139?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/AlexeyAkhunov",
    "html_url": "https://github.com/AlexeyAkhunov",
    "followers_url": "https://api.github.com/users/AlexeyAkhunov/followers",
    "following_url": "https://api.github.com/users/AlexeyAkhunov/following{/other_user}",
    "gists_url": "https://api.github.com/users/AlexeyAkhunov/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/AlexeyAkhunov/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/AlexeyAkhunov/subscriptions",
    "organizations_url": "https://api.github.com/users/AlexeyAkhunov/orgs",
    "repos_url": "https://api.github.com/users/AlexeyAkhunov/repos",
    "events_url": "https://api.github.com/users/AlexeyAkhunov/events{/privacy}",
    "received_events_url": "https://api.github.com/users/AlexeyAkhunov/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/1743/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/1743/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/826344902",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/1743#issuecomment-826344902",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/1743",
    "id": 826344902,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgyNjM0NDkwMg==",
    "user": {
      "login": "battlmonstr",
      "id": 11477595,
      "node_id": "MDQ6VXNlcjExNDc3NTk1",
      "avatar_url": "https://avatars.githubusercontent.com/u/11477595?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/battlmonstr",
      "html_url": "https://github.com/battlmonstr",
      "followers_url": "https://api.github.com/users/battlmonstr/followers",
      "following_url": "https://api.github.com/users/battlmonstr/following{/other_user}",
      "gists_url": "https://api.github.com/users/battlmonstr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/battlmonstr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/battlmonstr/subscriptions",
      "organizations_url": "https://api.github.com/users/battlmonstr/orgs",
      "repos_url": "https://api.github.com/users/battlmonstr/repos",
      "events_url": "https://api.github.com/users/battlmonstr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/battlmonstr/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-04-25T15:44:17Z",
    "updated_at": "2021-04-25T15:44:17Z",
    "author_association": "COLLABORATOR",
    "body": "The problem likely is that the rust sentry never finds any peers:\r\nhttps://github.com/rust-ethereum/sentry/issues/6",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/826344902/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/835829051",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/1743#issuecomment-835829051",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/1743",
    "id": 835829051,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgzNTgyOTA1MQ==",
    "user": {
      "login": "battlmonstr",
      "id": 11477595,
      "node_id": "MDQ6VXNlcjExNDc3NTk1",
      "avatar_url": "https://avatars.githubusercontent.com/u/11477595?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/battlmonstr",
      "html_url": "https://github.com/battlmonstr",
      "followers_url": "https://api.github.com/users/battlmonstr/followers",
      "following_url": "https://api.github.com/users/battlmonstr/following{/other_user}",
      "gists_url": "https://api.github.com/users/battlmonstr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/battlmonstr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/battlmonstr/subscriptions",
      "organizations_url": "https://api.github.com/users/battlmonstr/orgs",
      "repos_url": "https://api.github.com/users/battlmonstr/repos",
      "events_url": "https://api.github.com/users/battlmonstr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/battlmonstr/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-05-09T15:30:15Z",
    "updated_at": "2021-05-09T15:30:15Z",
    "author_association": "COLLABORATOR",
    "body": "A new roadblock:\r\n\r\nWhen connected to a geth node synced with the \"fast\" strategy, the geth node requests GetBlockHeaders, and doesn't get any response from the downloader within 15 sec. This is treated as \"useless peer\" by geth, and it disconnects.\r\n\r\n(aka \"checkpoint challenge\")",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/835829051/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/846347233",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/1743#issuecomment-846347233",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/1743",
    "id": 846347233,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg0NjM0NzIzMw==",
    "user": {
      "login": "AskAlexSharov",
      "id": 46885206,
      "node_id": "MDQ6VXNlcjQ2ODg1MjA2",
      "avatar_url": "https://avatars.githubusercontent.com/u/46885206?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AskAlexSharov",
      "html_url": "https://github.com/AskAlexSharov",
      "followers_url": "https://api.github.com/users/AskAlexSharov/followers",
      "following_url": "https://api.github.com/users/AskAlexSharov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AskAlexSharov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AskAlexSharov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AskAlexSharov/subscriptions",
      "organizations_url": "https://api.github.com/users/AskAlexSharov/orgs",
      "repos_url": "https://api.github.com/users/AskAlexSharov/repos",
      "events_url": "https://api.github.com/users/AskAlexSharov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AskAlexSharov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-05-22T04:23:09Z",
    "updated_at": "2021-05-22T04:23:09Z",
    "author_association": "COLLABORATOR",
    "body": "@AlexeyAkhunov , did we fix this?",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/846347233/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
