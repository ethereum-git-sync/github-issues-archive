{
  "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/7007",
  "repository_url": "https://api.github.com/repos/ledgerwatch/erigon",
  "labels_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/7007/labels{/name}",
  "comments_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/7007/comments",
  "events_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/7007/events",
  "html_url": "https://github.com/ledgerwatch/erigon/issues/7007",
  "id": 1607452340,
  "node_id": "I_kwDOC0FsAM5fz8a0",
  "number": 7007,
  "title": "trace_block reports wrong 'action.to' address for traces with callType=callcode",
  "user": {
    "login": "0xgeert",
    "id": 393259,
    "node_id": "MDQ6VXNlcjM5MzI1OQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/393259?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/0xgeert",
    "html_url": "https://github.com/0xgeert",
    "followers_url": "https://api.github.com/users/0xgeert/followers",
    "following_url": "https://api.github.com/users/0xgeert/following{/other_user}",
    "gists_url": "https://api.github.com/users/0xgeert/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/0xgeert/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/0xgeert/subscriptions",
    "organizations_url": "https://api.github.com/users/0xgeert/orgs",
    "repos_url": "https://api.github.com/users/0xgeert/repos",
    "events_url": "https://api.github.com/users/0xgeert/events{/privacy}",
    "received_events_url": "https://api.github.com/users/0xgeert/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2023-03-02T20:39:24Z",
  "updated_at": "2023-03-03T16:26:50Z",
  "closed_at": "2023-03-03T16:26:49Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "#### System information\r\n\r\nErigon version: `./erigon --version`\r\nerigon version 2.30.0-dev-45938124\r\n\r\nOS & Version: Windows/Linux/OSX\r\nUbuntu 22.04\r\n\r\nCommit hash: \r\n? \r\n\r\nErigon Command (with flags/config):\r\n`erigon --datadir /xxx --chain mainnet --prune= --http --ws --http.addr=0.0.0.0 --http.port=9545 --http.api=engine,eth,net,admin,web3,trace --http.vhosts=*`\r\n\r\nConcensus Layer:\r\nincluded in above\r\n\r\nChain/Network: \r\nEthereum mainnet\r\n\r\n#### Expected behaviour\r\n\r\nDoing `eth_getBalance` on block `x` and `x+1 `for a given address gives a state-diff. \r\nThis statediff should be reproducible by  `trace_block(x)`\r\n\r\n#### Actual behaviour\r\nThe above is correct for all cases, except when traces with `callType=callcod` are involved.\r\n\r\n#### Steps to reproduce the behaviour\r\n\r\nFirst do 2 getBalances on block x and x+1 this gives a state/balance - diff. Balance + balance-diff crosschecked with etherscan and appears to be correct. \r\nhttps://etherscan.io/tx/0x63e04753794d94780b585da71820602f1d9ca9764fddf3e56d2d1afb941bfbb9#statechange\r\n\r\n````\r\n{\"method\":\"eth_getBalance\",\"params\":[\"0xd2f06b96b41a6cbd916e3e762e837193ac74e89b\", 119665],\"id\":1,\"jsonrpc\":\"2.0\"}\r\n{\r\n  \"jsonrpc\": \"2.0\",\r\n  \"id\": 1,\r\n  \"result\": \"0x0\" // zero\r\n}\r\n\r\n{\"method\":\"eth_getBalance\",\"params\":[\"0xd2f06b96b41a6cbd916e3e762e837193ac74e89b\", 119666],\"id\":1,\"jsonrpc\":\"2.0\"}\r\n{\r\n  \"jsonrpc\": \"2.0\",\r\n  \"id\": 1,\r\n  \"result\": \"0x8ac7230489e80000\" // 10000000000000000000\r\n}\r\n````\r\n\r\nHowever, the reported 2 traces that lead up to this state change are NOT correct (omitting unrelated reward trace for brevity)\r\nSpecifically, the second trace with type=callcode has an unexplainable 'to' = 0x273930d21e01ee25e4c219b63259d214872220a2\r\nAs per this trace, this results in a balance deduction of 10000000000000000000 from address 0xd2f06b96b41a6cbd916e3e762e837193ac74e89b\r\nAgain this is incorrect as per the `eth_getBalance` above\r\n\r\n\r\n````\r\n{\"method\":\"trace_block\",\"params\":[119666],\"id\":1,\"jsonrpc\":\"2.0\"}\r\n{\r\n  \"jsonrpc\": \"2.0\",\r\n  \"id\": 1,\r\n  \"result\": [\r\n      {\r\n          \"action\": {\r\n              \"from\": \"0xee38df16452bb041e346caa6679efc57c8bd4603\",\r\n              \"callType\": \"call\",\r\n              \"gas\": \"0x1a6d4\",\r\n              \"input\": \"0x\",\r\n              \"to\": \"0xd2f06b96b41a6cbd916e3e762e837193ac74e89b\",\r\n              \"value\": \"0x8ac7230489e80000\"\r\n          },\r\n          \"blockHash\": \"0x8f911b53c5491ac7acf950f343f80e63769925aada620fba16fb5999abc49f72\",\r\n          \"blockNumber\": 119666,\r\n          \"result\": {\r\n              \"gasUsed\": \"0x2034\",\r\n              \"output\": \"0x0000000000000000000000000000000000000000000000000000000000000000\"\r\n          },\r\n          \"subtraces\": 1,\r\n          \"traceAddress\": [],\r\n          \"transactionHash\": \"0x63e04753794d94780b585da71820602f1d9ca9764fddf3e56d2d1afb941bfbb9\",\r\n          \"transactionPosition\": 0,\r\n          \"type\": \"call\"\r\n      },\r\n      {\r\n          \"action\": {\r\n              \"from\": \"0xd2f06b96b41a6cbd916e3e762e837193ac74e89b\",\r\n              \"callType\": \"callcode\",\r\n              \"gas\": \"0x18c56\",\r\n              \"input\": \"0x\",\r\n              // Wrong. According to etherscan it should go to itself. I.e.: from = to. \r\n              // Again getBalance is correct (both listing balance=0 for this address on block=119665 and block=119666)\r\n              \"to\": \"0x273930d21e01ee25e4c219b63259d214872220a2\",  // Wrong\r\n              \"value\": \"0x8ac7230489e80000\"\r\n          },\r\n          \"blockHash\": \"0x8f911b53c5491ac7acf950f343f80e63769925aada620fba16fb5999abc49f72\",\r\n          \"blockNumber\": 119666,\r\n          \"result\": {\r\n              \"gasUsed\": \"0x5a4\",\r\n              \"output\": \"0x\"\r\n          },\r\n          \"subtraces\": 0,\r\n          \"traceAddress\": [\r\n              0\r\n          ],\r\n          \"transactionHash\": \"0x63e04753794d94780b585da71820602f1d9ca9764fddf3e56d2d1afb941bfbb9\",\r\n          \"transactionPosition\": 0,\r\n          \"type\": \"call\"\r\n      },\r\n  ]\r\n}\r\n````\r\n\r\nIt is described [here](https://ethereum.stackexchange.com/a/3672/73032) that callcode has a bug, which is why it was replaced by delegatecall.\r\nPerhaps that's the issue here. Etherscan at least seems to have fixed this to point to itself, i.e. \r\nfrom = 0xd2f06b96b41a6cbd916e3e762e837193ac74e89b / to = 0xd2f06b96b41a6cbd916e3e762e837193ac74e89b\r\n\r\nEssentially making it a no-op. Tracking other traces with callType=callcode (non-exhaustive) etherscan seems to make all callcode-traces noops\r\n\r\n",
  "closed_by": {
    "login": "0xgeert",
    "id": 393259,
    "node_id": "MDQ6VXNlcjM5MzI1OQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/393259?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/0xgeert",
    "html_url": "https://github.com/0xgeert",
    "followers_url": "https://api.github.com/users/0xgeert/followers",
    "following_url": "https://api.github.com/users/0xgeert/following{/other_user}",
    "gists_url": "https://api.github.com/users/0xgeert/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/0xgeert/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/0xgeert/subscriptions",
    "organizations_url": "https://api.github.com/users/0xgeert/orgs",
    "repos_url": "https://api.github.com/users/0xgeert/repos",
    "events_url": "https://api.github.com/users/0xgeert/events{/privacy}",
    "received_events_url": "https://api.github.com/users/0xgeert/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/7007/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/7007/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1453751025",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/7007#issuecomment-1453751025",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/7007",
    "id": 1453751025,
    "node_id": "IC_kwDOC0FsAM5Wpnrx",
    "user": {
      "login": "iFA88",
      "id": 18205395,
      "node_id": "MDQ6VXNlcjE4MjA1Mzk1",
      "avatar_url": "https://avatars.githubusercontent.com/u/18205395?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/iFA88",
      "html_url": "https://github.com/iFA88",
      "followers_url": "https://api.github.com/users/iFA88/followers",
      "following_url": "https://api.github.com/users/iFA88/following{/other_user}",
      "gists_url": "https://api.github.com/users/iFA88/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/iFA88/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/iFA88/subscriptions",
      "organizations_url": "https://api.github.com/users/iFA88/orgs",
      "repos_url": "https://api.github.com/users/iFA88/repos",
      "events_url": "https://api.github.com/users/iFA88/events{/privacy}",
      "received_events_url": "https://api.github.com/users/iFA88/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-03T16:02:44Z",
    "updated_at": "2023-03-03T16:02:44Z",
    "author_association": "CONTRIBUTOR",
    "body": "Hey!\r\nFor me seems that correct.\r\nYou know that this action is a CALLCODE, so the `to` represents the address where is the code what need to be executed, but in the current context.",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1453751025/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1453782249",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/7007#issuecomment-1453782249",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/7007",
    "id": 1453782249,
    "node_id": "IC_kwDOC0FsAM5WpvTp",
    "user": {
      "login": "0xgeert",
      "id": 393259,
      "node_id": "MDQ6VXNlcjM5MzI1OQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/393259?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/0xgeert",
      "html_url": "https://github.com/0xgeert",
      "followers_url": "https://api.github.com/users/0xgeert/followers",
      "following_url": "https://api.github.com/users/0xgeert/following{/other_user}",
      "gists_url": "https://api.github.com/users/0xgeert/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/0xgeert/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/0xgeert/subscriptions",
      "organizations_url": "https://api.github.com/users/0xgeert/orgs",
      "repos_url": "https://api.github.com/users/0xgeert/repos",
      "events_url": "https://api.github.com/users/0xgeert/events{/privacy}",
      "received_events_url": "https://api.github.com/users/0xgeert/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-03T16:26:49Z",
    "updated_at": "2023-03-03T16:26:49Z",
    "author_association": "NONE",
    "body": "@iFA88 Yeah just came in here to close. You're correct.",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1453782249/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
