{
  "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/4408",
  "repository_url": "https://api.github.com/repos/ledgerwatch/erigon",
  "labels_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/4408/labels{/name}",
  "comments_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/4408/comments",
  "events_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/4408/events",
  "html_url": "https://github.com/ledgerwatch/erigon/issues/4408",
  "id": 1264670249,
  "node_id": "I_kwDOC0FsAM5LYVYp",
  "number": 4408,
  "title": "Erigon on BSC archive node has a constant height lag of ~2000-3000 blocks",
  "user": {
    "login": "ghost",
    "id": 10137,
    "node_id": "MDQ6VXNlcjEwMTM3",
    "avatar_url": "https://avatars.githubusercontent.com/u/10137?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ghost",
    "html_url": "https://github.com/ghost",
    "followers_url": "https://api.github.com/users/ghost/followers",
    "following_url": "https://api.github.com/users/ghost/following{/other_user}",
    "gists_url": "https://api.github.com/users/ghost/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ghost/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ghost/subscriptions",
    "organizations_url": "https://api.github.com/users/ghost/orgs",
    "repos_url": "https://api.github.com/users/ghost/repos",
    "events_url": "https://api.github.com/users/ghost/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ghost/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2022-06-08T12:31:10Z",
  "updated_at": "2022-06-16T11:43:40Z",
  "closed_at": "2022-06-16T11:43:40Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "#### System information\r\nErigon version: `erigon version 2022.05.9-alpha-97e8c42d`\r\nOS & Version: ubuntu 20.04 in docker\r\nHardware: 16-cores of CPU / 64GB RAM / ZFS on SSD\r\nCommit hash : 97e8c42d\r\n\r\nTrying to sync BSC archive node for some months, all this time facing the same problem. Generally, node's height grows faster than the chain's. But when the gap becomes like 3000 and the node takes the last 3000 blocks to process, it takes it to process them about 2 hours. In the meantime, about 3000 new blocks are created in the chain, and the cycle repeats.\r\nSometimes the lag grows up to 30000-50000 blocks, but every time it becomes about 3000 blocks and then persists, unable to fully sync.\r\n\r\n````\r\nerigon --chain=bsc --db.pagesize=8kb  --http.api=eth,erigon,web3,net,debug,trace,txpool,db --maxpeers=30 --syncmode=full\r\n````\r\nSome logs:\r\n````\r\n[INFO] [06-08|11:40:24.947] [p2p] GoodPeers                          eth66=2\r\n[INFO] [06-08|11:42:24.946] [p2p] GoodPeers                          eth66=2\r\n[INFO] [06-08|11:42:31.451] [13/16 LogIndex] DONE                    in=5m24.863455808s\r\n[INFO] [06-08|11:43:19.947] [14/16 TxLookup] ETL [2/2] Loading       into=BlockTransactionLookup current key=18378c53... alloc=137.9Mb sys=1.6Gb\r\n[INFO] [06-08|11:43:49.947] [14/16 TxLookup] ETL [2/2] Loading       into=BlockTransactionLookup current key=3039b3eb... alloc=175.6Mb sys=1.6Gb\r\n[INFO] [06-08|11:44:19.946] [14/16 TxLookup] ETL [2/2] Loading       into=BlockTransactionLookup current key=48bbc7b5... alloc=112.1Mb sys=1.6Gb\r\n[INFO] [06-08|11:44:24.946] [p2p] GoodPeers                          eth66=2\r\n[INFO] [06-08|11:44:49.946] [14/16 TxLookup] ETL [2/2] Loading       into=BlockTransactionLookup current key=61ada49d... alloc=159.2Mb sys=1.6Gb\r\n[INFO] [06-08|11:45:19.946] [14/16 TxLookup] ETL [2/2] Loading       into=BlockTransactionLookup current key=7a98c584... alloc=98.0Mb sys=1.6Gb\r\n[INFO] [06-08|11:45:49.946] [14/16 TxLookup] ETL [2/2] Loading       into=BlockTransactionLookup current key=941d5b99... alloc=135.0Mb sys=1.6Gb\r\n[INFO] [06-08|11:46:19.946] [14/16 TxLookup] ETL [2/2] Loading       into=BlockTransactionLookup current key=adcb59b4... alloc=170.3Mb sys=1.6Gb\r\n[INFO] [06-08|11:46:24.946] [p2p] GoodPeers                          eth66=2\r\n[INFO] [06-08|11:46:49.946] [14/16 TxLookup] ETL [2/2] Loading       into=BlockTransactionLookup current key=c8ba310f... alloc=113.0Mb sys=1.6Gb\r\n[INFO] [06-08|11:47:19.948] [14/16 TxLookup] ETL [2/2] Loading       into=BlockTransactionLookup current key=e2cde9a5... alloc=156.3Mb sys=1.6Gb\r\n[INFO] [06-08|11:47:49.946] [14/16 TxLookup] ETL [2/2] Loading       into=BlockTransactionLookup current key=fcfae836... alloc=188.5Mb sys=1.6Gb\r\n[INFO] [06-08|11:48:24.946] [p2p] GoodPeers                          eth66=2\r\n[INFO] [06-08|11:50:24.946] [p2p] GoodPeers                          eth66=2\r\n[INFO] [06-08|11:52:24.946] [p2p] GoodPeers                          eth66=2\r\n[INFO] [06-08|11:52:33.039] [14/16 TxLookup] DONE                    in=10m1.587802298s\r\n[INFO] [06-08|11:52:33.137] Timings (slower than 50ms)               Headers=1m12.657s CumulativeIndex=66ms BlockHashes=5.039s Bodies=29m43.166s Senders=45.584s Execution=23m21.019s HashState=17m36.971s IntermediateHashes=22m48.596s CallTraces=8m12.516s AccountHistoryIndex=5m31.272s StorageHistoryIndex=13m16.232s LogIndex=5m24.863s TxLookup=10m1.587s\r\n[INFO] [06-08|11:52:33.277] RPC Daemon notified of new headers       from=18505162 to=18506186 header sending=129.904772ms log sending=1.332Âµs\r\n[INFO] [06-08|11:52:33.280] [1/16 Headers] Waiting for headers...    from=18506186\r\n[INFO] [06-08|11:52:33.343] [1/16 Headers] Processed                 highest inserted=18506223 age=2h14m57s\r\n[INFO] [06-08|11:52:33.463] [4/16 Bodies] Processing bodies...       from=18506186 to=18506223\r\n[INFO] [06-08|11:52:34.392] [4/16 Bodies] Processed                  highest=18506223\r\n[INFO] [06-08|11:52:34.392] [5/16 Senders] Started                   from=18506186 to=18506223\r\n[INFO] [06-08|11:52:34.542] [6/16 Execution] Blocks execution        from=18506186 to=18506223\r\n[INFO] [06-08|11:52:55.642] [6/16 Execution] Executed blocks         number=18506201 blk/s=0.7 tx/s=117.3 Mgas/s=14.9 gasState=0.00 estimated duration=49.926s batch=457.9Kb alloc=127.7Mb sys=1.6Gb\r\n[INFO] [06-08|11:53:14.631] [6/16 Execution] Executed blocks         number=18506221 blk/s=1.1 tx/s=165.7 Mgas/s=20.8 gasState=0.00 estimated duration=42.000s batch=1.2Mb alloc=143.1Mb sys=1.6Gb\r\n[INFO] [06-08|11:53:17.502] [6/16 Execution] Completed on            block=18506223\r\n[INFO] [06-08|11:53:17.502] [8/16 HashState] Promoting plain state   from=18506186 to=18506223\r\n[INFO] [06-08|11:53:17.502] [8/16 HashState] Incremental promotion started from=18506186 to=18506223 codes=true csbucket=AccountChangeSet\r\n[INFO] [06-08|11:53:25.028] [8/16 HashState] Incremental promotion started from=18506186 to=18506223 codes=false csbucket=AccountChangeSet\r\n[INFO] [06-08|11:53:28.637] [8/16 HashState] Incremental promotion started from=18506186 to=18506223 codes=false csbucket=StorageChangeSet\r\n[INFO] [06-08|11:53:44.860] [9/16 IntermediateHashes] Generating intermediate hashes from=18506186 to=18506223\r\n[INFO] [06-08|11:54:15.566] [9/16 IntermediateHashes] Calculating Merkle root current key=b281bc22...\r\n[INFO] [06-08|11:54:24.947] [p2p] GoodPeers                          eth66=2\r\n[INFO] [06-08|11:54:35.189] [10/16 CallTraces] Pruned call trace intermediate table from=18416186 to=18416222\r\n[INFO] [06-08|11:55:17.614] Timings (slower than 50ms)               Headers=65ms BlockHashes=114ms Bodies=929ms Senders=149ms Execution=42.96s HashState=27.357s IntermediateHashes=50.242s CallTraces=13.101s AccountHistoryIndex=7.927s StorageHistoryIndex=13.307s LogIndex=2.634s TxLookup=5.541s\r\n[INFO] [06-08|11:55:17.614] Tables                                   freelist=325.0Mb PlainState=324.4Gb AccountChangeSet=605.8Gb StorageChangeSet=2.0Tb BlockTransaction=3.2Tb TransactionLog=3.6Tb\r\n\r\n````\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/4408/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/4408/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1149860588",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/4408#issuecomment-1149860588",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/4408",
    "id": 1149860588,
    "node_id": "IC_kwDOC0FsAM5EiXrs",
    "user": {
      "login": "ghost",
      "id": 10137,
      "node_id": "MDQ6VXNlcjEwMTM3",
      "avatar_url": "https://avatars.githubusercontent.com/u/10137?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ghost",
      "html_url": "https://github.com/ghost",
      "followers_url": "https://api.github.com/users/ghost/followers",
      "following_url": "https://api.github.com/users/ghost/following{/other_user}",
      "gists_url": "https://api.github.com/users/ghost/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ghost/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ghost/subscriptions",
      "organizations_url": "https://api.github.com/users/ghost/orgs",
      "repos_url": "https://api.github.com/users/ghost/repos",
      "events_url": "https://api.github.com/users/ghost/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ghost/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-06-08T12:38:24Z",
    "updated_at": "2022-06-08T12:38:24Z",
    "author_association": "NONE",
    "body": "Some metrics from prometheus:\r\n![image](https://user-images.githubusercontent.com/98876795/172617736-ece4136b-5996-441f-9303-a164df344c0c.png)\r\n\r\nThe amount of processed blocks differ, but anyway the node cannot finalize",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1149860588/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1150581735",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/4408#issuecomment-1150581735",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/4408",
    "id": 1150581735,
    "node_id": "IC_kwDOC0FsAM5ElHvn",
    "user": {
      "login": "AskAlexSharov",
      "id": 46885206,
      "node_id": "MDQ6VXNlcjQ2ODg1MjA2",
      "avatar_url": "https://avatars.githubusercontent.com/u/46885206?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AskAlexSharov",
      "html_url": "https://github.com/AskAlexSharov",
      "followers_url": "https://api.github.com/users/AskAlexSharov/followers",
      "following_url": "https://api.github.com/users/AskAlexSharov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AskAlexSharov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AskAlexSharov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AskAlexSharov/subscriptions",
      "organizations_url": "https://api.github.com/users/AskAlexSharov/orgs",
      "repos_url": "https://api.github.com/users/AskAlexSharov/repos",
      "events_url": "https://api.github.com/users/AskAlexSharov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AskAlexSharov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-06-09T01:44:10Z",
    "updated_at": "2022-06-09T01:44:10Z",
    "author_association": "COLLABORATOR",
    "body": "[INFO] [06-08|11:52:33.137] Timings (slower than 50ms)               Headers=1m12.657s CumulativeIndex=66ms BlockHashes=5.039s Bodies=29m43.166s Senders=45.584s Execution=23m21.019s HashState=17m36.971s IntermediateHashes=22m48.596s CallTraces=8m12.516s AccountHistoryIndex=5m31.272s StorageHistoryIndex=13m16.232s LogIndex=5m24.863s TxLookup=10m1.587s\r\n\r\n[INFO] [06-08|11:55:17.614] Timings (slower than 50ms)               Headers=65ms BlockHashes=114ms Bodies=929ms Senders=149ms Execution=42.96s HashState=27.357s IntermediateHashes=50.242s CallTraces=13.101s AccountHistoryIndex=7.927s StorageHistoryIndex=13.307s LogIndex=2.634s TxLookup=5.541s\r\n\r\nI see: 2-nd cycle took 5min, not 2hours. \r\nMeans everything is good.",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1150581735/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1152271706",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/4408#issuecomment-1152271706",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/4408",
    "id": 1152271706,
    "node_id": "IC_kwDOC0FsAM5ErkVa",
    "user": {
      "login": "ghost",
      "id": 10137,
      "node_id": "MDQ6VXNlcjEwMTM3",
      "avatar_url": "https://avatars.githubusercontent.com/u/10137?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ghost",
      "html_url": "https://github.com/ghost",
      "followers_url": "https://api.github.com/users/ghost/followers",
      "following_url": "https://api.github.com/users/ghost/following{/other_user}",
      "gists_url": "https://api.github.com/users/ghost/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ghost/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ghost/subscriptions",
      "organizations_url": "https://api.github.com/users/ghost/orgs",
      "repos_url": "https://api.github.com/users/ghost/repos",
      "events_url": "https://api.github.com/users/ghost/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ghost/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-06-10T11:42:07Z",
    "updated_at": "2022-06-10T11:42:07Z",
    "author_association": "NONE",
    "body": "This is because of erigon takes batches of various size of blocks to process, sometimes it processes 5000 and sometimes it is about 300.\r\nIn the end, we get the working node, but the latest data is 1-2 hours old (or more).\r\nI wonder what would be if the chain stopped generating new blocks for a small time, maybe we could catch up with it and finally have the actual data.\r\n\r\nSo could it be network or IOPS issue?",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1152271706/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1152852622",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/4408#issuecomment-1152852622",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/4408",
    "id": 1152852622,
    "node_id": "IC_kwDOC0FsAM5EtyKO",
    "user": {
      "login": "AskAlexSharov",
      "id": 46885206,
      "node_id": "MDQ6VXNlcjQ2ODg1MjA2",
      "avatar_url": "https://avatars.githubusercontent.com/u/46885206?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AskAlexSharov",
      "html_url": "https://github.com/AskAlexSharov",
      "followers_url": "https://api.github.com/users/AskAlexSharov/followers",
      "following_url": "https://api.github.com/users/AskAlexSharov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AskAlexSharov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AskAlexSharov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AskAlexSharov/subscriptions",
      "organizations_url": "https://api.github.com/users/AskAlexSharov/orgs",
      "repos_url": "https://api.github.com/users/AskAlexSharov/repos",
      "events_url": "https://api.github.com/users/AskAlexSharov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AskAlexSharov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-06-11T04:25:35Z",
    "updated_at": "2022-06-11T04:25:35Z",
    "author_association": "COLLABORATOR",
    "body": "Can be disk latency, can be zfs issue.\r\nShow more logs. ",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1152852622/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1157563862",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/4408#issuecomment-1157563862",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/4408",
    "id": 1157563862,
    "node_id": "IC_kwDOC0FsAM5E_wXW",
    "user": {
      "login": "ghost",
      "id": 10137,
      "node_id": "MDQ6VXNlcjEwMTM3",
      "avatar_url": "https://avatars.githubusercontent.com/u/10137?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ghost",
      "html_url": "https://github.com/ghost",
      "followers_url": "https://api.github.com/users/ghost/followers",
      "following_url": "https://api.github.com/users/ghost/following{/other_user}",
      "gists_url": "https://api.github.com/users/ghost/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ghost/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ghost/subscriptions",
      "organizations_url": "https://api.github.com/users/ghost/orgs",
      "repos_url": "https://api.github.com/users/ghost/repos",
      "events_url": "https://api.github.com/users/ghost/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ghost/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-06-16T11:43:40Z",
    "updated_at": "2022-06-16T11:43:40Z",
    "author_association": "NONE",
    "body": "Finally, I've found that Erigon on BSC mainnet consumes a great deal of I/O operations, as shown in iotop (up to 60%).\r\nAfter stopping it, I see ZFS ARC L2 size metrics became like 2.5 times smaller.\r\nIt runs on the server alongside other healthy blockchain nodes, and I suppose Erigon has to be executed on a dedicated server.",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1157563862/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
