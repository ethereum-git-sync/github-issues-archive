{
  "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/8102",
  "repository_url": "https://api.github.com/repos/ledgerwatch/erigon",
  "labels_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/8102/labels{/name}",
  "comments_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/8102/comments",
  "events_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/8102/events",
  "html_url": "https://github.com/ledgerwatch/erigon/issues/8102",
  "id": 1873293119,
  "node_id": "I_kwDOC0FsAM5vqC8_",
  "number": 8102,
  "title": "bor: revise the integration code",
  "user": {
    "login": "battlmonstr",
    "id": 11477595,
    "node_id": "MDQ6VXNlcjExNDc3NTk1",
    "avatar_url": "https://avatars.githubusercontent.com/u/11477595?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/battlmonstr",
    "html_url": "https://github.com/battlmonstr",
    "followers_url": "https://api.github.com/users/battlmonstr/followers",
    "following_url": "https://api.github.com/users/battlmonstr/following{/other_user}",
    "gists_url": "https://api.github.com/users/battlmonstr/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/battlmonstr/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/battlmonstr/subscriptions",
    "organizations_url": "https://api.github.com/users/battlmonstr/orgs",
    "repos_url": "https://api.github.com/users/battlmonstr/repos",
    "events_url": "https://api.github.com/users/battlmonstr/events{/privacy}",
    "received_events_url": "https://api.github.com/users/battlmonstr/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 4566396003,
      "node_id": "LA_kwDOC0FsAM8AAAABEC2sYw",
      "url": "https://api.github.com/repos/ledgerwatch/erigon/labels/Stale",
      "name": "Stale",
      "color": "ededed",
      "default": false,
      "description": null
    },
    {
      "id": 5877848882,
      "node_id": "LA_kwDOC0FsAM8AAAABXljbMg",
      "url": "https://api.github.com/repos/ledgerwatch/erigon/labels/polygon",
      "name": "polygon",
      "color": "0B1179",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2023-08-30T09:27:04Z",
  "updated_at": "2023-10-10T02:04:04Z",
  "closed_at": null,
  "author_association": "COLLABORATOR",
  "active_lock_reason": null,
  "body": "# Rationale\r\n\r\nCurrently bor-specific code is scattered around the codebase.\r\nMentions of bor/heimdall/polygon exist in the following files and folders:\r\n\r\n```\r\ncmd/devnet/args/node.go\r\ncmd/devnet/contracts/\r\ncmd/devnet/main.go\r\ncmd/devnet/requests/request_generator.go\r\ncmd/devnet/services/context.go\r\ncmd/devnet/services/polygon/\r\ncmd/integration/commands/flags.go\r\ncmd/integration/commands/reset_state.go\r\ncmd/integration/commands/stages.go\r\ncmd/integration/commands/state_stages.go\r\ncmd/rpcdaemon/cli/config.go\r\ncmd/rpcdaemon/main.go\r\ncmd/state/commands/erigon4.go\r\ncmd/utils/flags.go\r\ncommon/paths/paths.go\r\nconsensus/bor/\r\nconsensus/misc/eip1559.go\r\ncore/genesis_write.go\r\ncore/rawdb/bor_receipts.go\r\ncore/types/accounts/account.go\r\ncore/types/bor_receipt.go\r\neth/backend.go\r\neth/ethconfig/config.go\r\neth/ethconsensusconfig/config.go\r\neth/stagedsync/default_stages.go\r\neth/stagedsync/stage_bor_heimdall.go\r\neth/stagedsync/stage_execute.go\r\neth/stagedsync/stage_finish.go\r\neth/stagedsync/stage_postexec.go\r\neth/stagedsync/stage_txlookup.go\r\neth/stagedsync/stagebuilder.go\r\neth/stagedsync/stages/stages.go\r\nparams/config.go\r\nparams/networkname/network_name.go\r\nparams/protocol_params.go\r\ntests/bor/\r\ntests/bor/mocks/IHeimdallClient.go\r\nturbo/adapter/ethapi/api.go\r\nturbo/adapter/ethapi/internal.go\r\nturbo/app/snapshots_cmd.go\r\nturbo/jsonrpc/bor_api.go\r\nturbo/jsonrpc/bor_helper.go\r\nturbo/jsonrpc/bor_snapshot.go\r\nturbo/jsonrpc/daemon.go\r\nturbo/jsonrpc/erigon_receipts.go\r\nturbo/jsonrpc/eth_block.go\r\nturbo/jsonrpc/eth_receipts.go\r\nturbo/jsonrpc/eth_txs.go\r\nturbo/jsonrpc/tracing.go\r\nturbo/jsonrpc/validator_set.go\r\nturbo/services/interfaces.go\r\nturbo/snapshotsync/freezeblocks/block_reader.go\r\nturbo/snapshotsync/freezeblocks/block_snapshots.go\r\nturbo/snapshotsync/freezeblocks/bor_snapshots.go\r\nturbo/snapshotsync/freezeblocks/dump_test.go\r\nturbo/snapshotsync/snapshotsync.go\r\nturbo/stages/mock/mock_sentry.go\r\nturbo/stages/stageloop.go\r\nturbo/transactions/tracing.go\r\n```\r\n\r\nThis intrusive architecture makes it hard to see the full picture, find the right place for new bor-specific code, refactor the code without breaking.\r\n\r\nThe new upcoming PRs like https://github.com/ledgerwatch/erigon/pull/8091 make even more bor-specific changes in various files.\r\n\r\n# Implementation\r\n\r\nDiscuss what's the foreseeable future of this integration.\r\nDecide if we want to be a platform for similar integrations or not.\r\n1. If we want to be a platform, try to define the integration API boundary and decide which parts could be refactored to a separate erigon-bor \"plugin\" code and potentially moved out of the main repo. In this case the erigon-bor project could get erigon changes automatically and report breakages to the main repo.\r\n2. Otherwise, maybe just fork erigon as erigon-bor and remove the integration from the main repo. In this case the erigon-bor team will have to merge erigon changes manually and fix breakages by themselves, and it will become more difficult over time.\r\n3. Some mix of 1 and 2.\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/8102/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/8102/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1699391122",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/8102#issuecomment-1699391122",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/8102",
    "id": 1699391122,
    "node_id": "IC_kwDOC0FsAM5lSqaS",
    "user": {
      "login": "mh0lt",
      "id": 135143369,
      "node_id": "U_kgDOCA4fyQ",
      "avatar_url": "https://avatars.githubusercontent.com/u/135143369?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mh0lt",
      "html_url": "https://github.com/mh0lt",
      "followers_url": "https://api.github.com/users/mh0lt/followers",
      "following_url": "https://api.github.com/users/mh0lt/following{/other_user}",
      "gists_url": "https://api.github.com/users/mh0lt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mh0lt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mh0lt/subscriptions",
      "organizations_url": "https://api.github.com/users/mh0lt/orgs",
      "repos_url": "https://api.github.com/users/mh0lt/repos",
      "events_url": "https://api.github.com/users/mh0lt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mh0lt/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-08-30T15:24:58Z",
    "updated_at": "2023-08-30T15:24:58Z",
    "author_association": "COLLABORATOR",
    "body": "I think that the first phase of this should be to move all of the polygon specifics to a separate package. \r\n\r\nI suggest we should go for a directory structure which is:\r\n\r\npolygon/bor\r\npolygon/heimdall\r\n\r\nbecuase there is a natural split to the code.  It would also make a more natural place to put the polygon specific code from the devnet there. So we'd also likely get\r\n\r\npolygon/proofgen\r\n\r\nI also think this is more future proof if we do additional polygon projects that are not necessarily  POS specific.\r\n\r\nI think this should probably be step 1.   As it has minimal impact other than an internal code move.\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1699391122/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1754204867",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/8102#issuecomment-1754204867",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/8102",
    "id": 1754204867,
    "node_id": "IC_kwDOC0FsAM5ojwrD",
    "user": {
      "login": "github-actions[bot]",
      "id": 41898282,
      "node_id": "MDM6Qm90NDE4OTgyODI=",
      "avatar_url": "https://avatars.githubusercontent.com/in/15368?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/github-actions%5Bbot%5D",
      "html_url": "https://github.com/apps/github-actions",
      "followers_url": "https://api.github.com/users/github-actions%5Bbot%5D/followers",
      "following_url": "https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}",
      "gists_url": "https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/github-actions%5Bbot%5D/subscriptions",
      "organizations_url": "https://api.github.com/users/github-actions%5Bbot%5D/orgs",
      "repos_url": "https://api.github.com/users/github-actions%5Bbot%5D/repos",
      "events_url": "https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}",
      "received_events_url": "https://api.github.com/users/github-actions%5Bbot%5D/received_events",
      "type": "Bot",
      "site_admin": false
    },
    "created_at": "2023-10-10T02:04:03Z",
    "updated_at": "2023-10-10T02:04:03Z",
    "author_association": "NONE",
    "body": "This issue is stale because it has been open for 40 days with no activity. Remove stale label or comment, or this will be closed in 7 days.",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1754204867/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
