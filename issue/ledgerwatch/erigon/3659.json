{
  "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/3659",
  "repository_url": "https://api.github.com/repos/ledgerwatch/erigon",
  "labels_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/3659/labels{/name}",
  "comments_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/3659/comments",
  "events_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/3659/events",
  "html_url": "https://github.com/ledgerwatch/erigon/issues/3659",
  "id": 1163390281,
  "node_id": "I_kwDOC0FsAM5FV-1J",
  "number": 3659,
  "title": "oom in stage 9/16 CallTraces of first sync",
  "user": {
    "login": "muyinliu",
    "id": 3318872,
    "node_id": "MDQ6VXNlcjMzMTg4NzI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3318872?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/muyinliu",
    "html_url": "https://github.com/muyinliu",
    "followers_url": "https://api.github.com/users/muyinliu/followers",
    "following_url": "https://api.github.com/users/muyinliu/following{/other_user}",
    "gists_url": "https://api.github.com/users/muyinliu/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/muyinliu/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/muyinliu/subscriptions",
    "organizations_url": "https://api.github.com/users/muyinliu/orgs",
    "repos_url": "https://api.github.com/users/muyinliu/repos",
    "events_url": "https://api.github.com/users/muyinliu/events{/privacy}",
    "received_events_url": "https://api.github.com/users/muyinliu/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2022-03-09T01:35:57Z",
  "updated_at": "2022-07-02T17:25:24Z",
  "closed_at": "2022-05-27T04:39:10Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "#### System information\r\n\r\nErigon version: erigon version 2022.02.4-beta\r\n\r\nOS & Version: Linux(Ubuntu 20.04.3 LTS (Focal Fossa))\r\n\r\nCommit hash : c4e29e33\r\n\r\n#### Expected behaviour\r\n\r\nerigon \r\n\r\n#### Actual behaviour\r\n\r\nprocess erigon keep increasing used memory, then get killed because oom(max memory of the machine is 126 GB), part of logs:\r\n\r\n```log\r\n[INFO] [03-06|20:08:21.836] [8/16 IntermediateHashes] Regeneration ended\r\n[INFO] [03-06|20:08:31.606] [8/16 IntermediateHashes] DONE           in=37m5.011575162s\r\n[INFO] [03-06|20:08:54.603] [p2p] GoodPeers                          eth66=94\r\n[INFO] [03-06|20:09:01.610] [9/16 CallTraces] Progress               number=2110175 blk/second=70339.133 alloc=\"1.24 GiB\" sys=\"90.89 GiB\"\r\n[INFO] [03-06|20:09:31.610] [9/16 CallTraces] Progress               number=2383633 blk/second=9115.267 alloc=\"2.08 GiB\" sys=\"90.89 GiB\"\r\n[INFO] [03-06|20:10:01.611] [9/16 CallTraces] Progress               number=2386715 blk/second=102.733 alloc=\"1.95 GiB\" sys=\"90.89 GiB\"\r\n[INFO] [03-06|20:10:31.611] [9/16 CallTraces] Progress               number=2406981 blk/second=675.533 alloc=\"2.00 GiB\" sys=\"90.89 GiB\"\r\n[INFO] [03-06|20:10:54.602] [p2p] GoodPeers                          eth66=95\r\n[INFO] [03-06|20:11:02.002] [9/16 CallTraces] Progress               number=2414128 blk/second=238.233 alloc=\"1.88 GiB\" sys=\"90.89 GiB\"\r\n[INFO] [03-06|20:11:31.610] [9/16 CallTraces] Progress               number=2425970 blk/second=394.733 alloc=\"3.91 GiB\" sys=\"90.89 GiB\"\r\n[INFO] [03-06|20:12:01.609] [9/16 CallTraces] Progress               number=2430910 blk/second=164.667 alloc=\"4.96 GiB\" sys=\"90.89 GiB\"\r\n[INFO] [03-06|20:12:41.941] [9/16 CallTraces] Progress               number=2450726 blk/second=660.533 alloc=\"5.59 GiB\" sys=\"90.89 GiB\"\r\n[INFO] [03-06|20:12:54.602] [p2p] GoodPeers                          eth66=95\r\n[INFO] [03-06|20:13:02.017] [9/16 CallTraces] Progress               number=2661824 blk/second=7036.600 alloc=\"5.52 GiB\" sys=\"90.89 GiB\"\r\n[INFO] [03-06|20:13:42.020] [9/16 CallTraces] Progress               number=2699254 blk/second=1247.667 alloc=\"8.50 GiB\" sys=\"90.89 GiB\"\r\n[INFO] [03-06|20:14:02.150] [9/16 CallTraces] Progress               number=2704089 blk/second=161.167 alloc=\"8.61 GiB\" sys=\"90.89 GiB\"\r\n[INFO] [03-06|20:14:31.609] [9/16 CallTraces] Progress               number=2713964 blk/second=329.167 alloc=\"7.62 GiB\" sys=\"90.89 GiB\"\r\n[INFO] [03-06|20:14:54.602] [p2p] GoodPeers                          eth66=95\r\n[INFO] [03-06|20:15:01.610] [9/16 CallTraces] Progress               number=2952114 blk/second=7938.333 alloc=\"6.39 GiB\" sys=\"90.89 GiB\"\r\n[INFO] [03-06|20:15:31.610] [9/16 CallTraces] Progress               number=3646911 blk/second=23159.900 alloc=\"7.38 GiB\" sys=\"90.89 GiB\"\r\n[INFO] [03-06|20:16:01.610] [9/16 CallTraces] Progress               number=3824973 blk/second=5935.400 alloc=\"9.31 GiB\" sys=\"90.89 GiB\"\r\n[INFO] [03-06|20:16:35.296] [9/16 CallTraces] Progress               number=3931806 blk/second=3561.100 alloc=\"11.37 GiB\" sys=\"90.89 GiB\"\r\n[INFO] [03-06|20:16:54.603] [p2p] GoodPeers                          eth66=94\r\n[INFO] [03-06|20:17:01.609] [9/16 CallTraces] Progress               number=4039868 blk/second=3602.067 alloc=\"6.73 GiB\" sys=\"90.89 GiB\"\r\n[INFO] [03-06|20:17:31.610] [9/16 CallTraces] Progress               number=4130741 blk/second=3029.100 alloc=\"8.77 GiB\" sys=\"90.89 GiB\"\r\n[INFO] [03-06|20:18:05.908] [9/16 CallTraces] Progress               number=4192617 blk/second=2062.533 alloc=\"10.78 GiB\" sys=\"90.89 GiB\"\r\n[INFO] [03-06|20:18:31.609] [9/16 CallTraces] Progress               number=4247911 blk/second=1843.133 alloc=\"11.89 GiB\" sys=\"90.89 GiB\"\r\n[INFO] [03-06|20:18:54.602] [p2p] GoodPeers                          eth66=94\r\n[INFO] [03-06|20:19:01.610] [9/16 CallTraces] Progress               number=4279584 blk/second=1055.767 alloc=\"10.76 GiB\" sys=\"90.89 GiB\"\r\n[INFO] [03-06|20:19:37.138] [9/16 CallTraces] Progress               number=4325207 blk/second=1520.767 alloc=\"12.82 GiB\" sys=\"90.89 GiB\"\r\n[INFO] [03-06|20:20:07.281] [9/16 CallTraces] Progress               number=4370912 blk/second=1523.500 alloc=\"14.53 GiB\" sys=\"90.89 GiB\"\r\n[INFO] [03-06|20:20:31.610] [9/16 CallTraces] Progress               number=4438104 blk/second=2239.733 alloc=\"15.91 GiB\" sys=\"90.89 GiB\"\r\n[INFO] [03-06|20:20:54.603] [p2p] GoodPeers                          eth66=95\r\n[INFO] [03-06|20:21:02.661] [9/16 CallTraces] Progress               number=4515005 blk/second=2563.367 alloc=\"9.60 GiB\" sys=\"90.89 GiB\"\r\n[INFO] [03-06|20:21:31.610] [9/16 CallTraces] Progress               number=4578024 blk/second=2100.633 alloc=\"11.29 GiB\" sys=\"90.89 GiB\"\r\n[INFO] [03-06|20:22:02.469] [9/16 CallTraces] Progress               number=4632338 blk/second=1810.467 alloc=\"13.65 GiB\" sys=\"90.89 GiB\"\r\n[INFO] [03-06|20:22:31.817] [9/16 CallTraces] Progress               number=4676562 blk/second=1474.133 alloc=\"15.39 GiB\" sys=\"90.89 GiB\"\r\n.\r\n.\r\n.\r\n[INFO] [03-06|22:58:01.610] [9/16 CallTraces] Progress               number=13754991 blk/second=722.967 alloc=\"82.30 GiB\" sys=\"137.29 GiB\"\r\n[INFO] [03-06|22:58:37.469] [9/16 CallTraces] Progress               number=13775821 blk/second=694.333 alloc=\"84.13 GiB\" sys=\"137.29 GiB\"\r\n[INFO] [03-06|22:58:54.602] [p2p] GoodPeers                          eth66=40\r\n[INFO] [03-06|22:59:01.610] [9/16 CallTraces] Progress               number=13794181 blk/second=612.000 alloc=\"85.35 GiB\" sys=\"137.30 GiB\"\r\n[INFO] [03-06|22:59:31.610] [9/16 CallTraces] Progress               number=13809151 blk/second=499.000 alloc=\"80.76 GiB\" sys=\"137.30 GiB\"\r\n[INFO] [03-06|23:00:01.609] [9/16 CallTraces] Progress               number=13837422 blk/second=942.367 alloc=\"82.09 GiB\" sys=\"137.30 GiB\"\r\n[INFO] [03-06|23:00:31.610] [9/16 CallTraces] Progress               number=13858482 blk/second=702.000 alloc=\"83.78 GiB\" sys=\"137.30 GiB\"\r\n[INFO] [03-06|23:00:54.602] [p2p] GoodPeers                          eth66=40\r\n[INFO] [03-06|23:01:01.610] [9/16 CallTraces] Progress               number=13879518 blk/second=701.200 alloc=\"85.37 GiB\" sys=\"137.30 GiB\"\r\n[INFO] [03-06|23:01:42.244] [9/16 CallTraces] Progress               number=13901112 blk/second=719.800 alloc=\"81.58 GiB\" sys=\"137.30 GiB\"\r\n[INFO] [03-06|23:02:01.609] [9/16 CallTraces] Progress               number=13919778 blk/second=622.200 alloc=\"82.57 GiB\" sys=\"137.30 GiB\"\r\n[INFO] [03-06|23:02:32.545] [9/16 CallTraces] Progress               number=13936738 blk/second=565.333 alloc=\"84.05 GiB\" sys=\"137.30 GiB\"\r\n[INFO] [03-06|23:02:54.603] [p2p] GoodPeers                          eth66=40\r\n[INFO] [03-06|23:03:01.611] [9/16 CallTraces] Progress               number=13962832 blk/second=869.800 alloc=\"85.33 GiB\" sys=\"137.31 GiB\"\r\n```\r\n\r\nduring stage 9/16 CallTraces, the disk usaged of erigon node is NOT increase, still 1.4 TB\r\n\r\n#### Steps to reproduce the behaviour\r\n\r\n```shell\r\n/usr/local/bin/erigon --datadir=/mnt/data/erigon-ethereum --etl.bufferSize 100G --pprof\r\n```\r\n\r\nNote: I have already try options like `--etl.bufferSize 25600M` `--etl.bufferSize 12800M`, still the same: oom.\r\n\r\nNote: use disk swap and get following heap map:\r\n\r\n![erigon-mem9](https://user-images.githubusercontent.com/3318872/157355179-c2af2c19-2b94-45b2-b92f-40a4af8e7547.png)\r\n\r\n\r\n#### Backtrace\r\n\r\n````\r\n[backtrace]\r\n````\r\n",
  "closed_by": {
    "login": "AskAlexSharov",
    "id": 46885206,
    "node_id": "MDQ6VXNlcjQ2ODg1MjA2",
    "avatar_url": "https://avatars.githubusercontent.com/u/46885206?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/AskAlexSharov",
    "html_url": "https://github.com/AskAlexSharov",
    "followers_url": "https://api.github.com/users/AskAlexSharov/followers",
    "following_url": "https://api.github.com/users/AskAlexSharov/following{/other_user}",
    "gists_url": "https://api.github.com/users/AskAlexSharov/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/AskAlexSharov/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/AskAlexSharov/subscriptions",
    "organizations_url": "https://api.github.com/users/AskAlexSharov/orgs",
    "repos_url": "https://api.github.com/users/AskAlexSharov/repos",
    "events_url": "https://api.github.com/users/AskAlexSharov/events{/privacy}",
    "received_events_url": "https://api.github.com/users/AskAlexSharov/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/3659/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/3659/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1062470782",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/3659#issuecomment-1062470782",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/3659",
    "id": 1062470782,
    "node_id": "IC_kwDOC0FsAM4_VAR-",
    "user": {
      "login": "AskAlexSharov",
      "id": 46885206,
      "node_id": "MDQ6VXNlcjQ2ODg1MjA2",
      "avatar_url": "https://avatars.githubusercontent.com/u/46885206?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AskAlexSharov",
      "html_url": "https://github.com/AskAlexSharov",
      "followers_url": "https://api.github.com/users/AskAlexSharov/followers",
      "following_url": "https://api.github.com/users/AskAlexSharov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AskAlexSharov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AskAlexSharov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AskAlexSharov/subscriptions",
      "organizations_url": "https://api.github.com/users/AskAlexSharov/orgs",
      "repos_url": "https://api.github.com/users/AskAlexSharov/repos",
      "events_url": "https://api.github.com/users/AskAlexSharov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AskAlexSharov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-03-09T01:47:39Z",
    "updated_at": "2022-03-09T01:47:39Z",
    "author_association": "COLLABORATOR",
    "body": "@muyinliu `--etl.bufferSize 25600M` it's 25Gb. Please don't use so big values, no real reason for this. ",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1062470782/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1139269726",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/3659#issuecomment-1139269726",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/3659",
    "id": 1139269726,
    "node_id": "IC_kwDOC0FsAM5D5-Be",
    "user": {
      "login": "AskAlexSharov",
      "id": 46885206,
      "node_id": "MDQ6VXNlcjQ2ODg1MjA2",
      "avatar_url": "https://avatars.githubusercontent.com/u/46885206?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AskAlexSharov",
      "html_url": "https://github.com/AskAlexSharov",
      "followers_url": "https://api.github.com/users/AskAlexSharov/followers",
      "following_url": "https://api.github.com/users/AskAlexSharov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AskAlexSharov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AskAlexSharov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AskAlexSharov/subscriptions",
      "organizations_url": "https://api.github.com/users/AskAlexSharov/orgs",
      "repos_url": "https://api.github.com/users/AskAlexSharov/repos",
      "events_url": "https://api.github.com/users/AskAlexSharov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AskAlexSharov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-27T04:39:10Z",
    "updated_at": "2022-05-27T04:39:10Z",
    "author_association": "COLLABORATOR",
    "body": "I believe",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1139269726/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1172904253",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/3659#issuecomment-1172904253",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/3659",
    "id": 1172904253,
    "node_id": "IC_kwDOC0FsAM5F6Rk9",
    "user": {
      "login": "roberto-bayardo",
      "id": 10271917,
      "node_id": "MDQ6VXNlcjEwMjcxOTE3",
      "avatar_url": "https://avatars.githubusercontent.com/u/10271917?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/roberto-bayardo",
      "html_url": "https://github.com/roberto-bayardo",
      "followers_url": "https://api.github.com/users/roberto-bayardo/followers",
      "following_url": "https://api.github.com/users/roberto-bayardo/following{/other_user}",
      "gists_url": "https://api.github.com/users/roberto-bayardo/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/roberto-bayardo/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/roberto-bayardo/subscriptions",
      "organizations_url": "https://api.github.com/users/roberto-bayardo/orgs",
      "repos_url": "https://api.github.com/users/roberto-bayardo/repos",
      "events_url": "https://api.github.com/users/roberto-bayardo/events{/privacy}",
      "received_events_url": "https://api.github.com/users/roberto-bayardo/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-02T14:05:10Z",
    "updated_at": "2022-07-02T17:25:24Z",
    "author_association": "CONTRIBUTOR",
    "body": "@AskAlexSharov you might want to keep this one open. I just got OOM in stage 10 (which is now the CallTraces stage) first time trying to sync:\r\n\r\n```\r\nerigon version 2022.06.5-alpha-295bf6f4\r\n```\r\n\r\n```\r\nINFO[07-01|21:59:31.317] Flushed buffer file                      name=/big/eth/erigon/etl-temp/erigon-sortable-buf-1712869231 alloc=6.6GB sys=15.8GB\r\nINFO[07-01|21:59:33.663] [10/16 CallTraces] Progress              number=4738921 blk/second=632.050 alloc=6.8GB sys=15.8GB\r\nINFO[07-01|21:59:53.281] [10/16 CallTraces] Progress              number=4759078 blk/second=1007.850 alloc=7.8GB sys=15.9GB\r\nINFO[07-01|22:00:13.279] [10/16 CallTraces] Progress              number=4774988 blk/second=795.500 alloc=4.9GB sys=15.9GB\r\nINFO[07-01|22:00:31.456] Flushed buffer file                      name=/big/eth/erigon/etl-temp/erigon-sortable-buf-3717244113 alloc=5.5GB sys=15.9GB\r\nINFO[07-01|22:00:33.749] [10/16 CallTraces] Progress              number=4785771 blk/second=539.150 alloc=5.7GB sys=15.9GB\r\nINFO[07-01|22:00:52.244] Flushed buffer file                      name=/big/eth/erigon/etl-temp/erigon-sortable-buf-3321667001 alloc=6.5GB sys=15.9GB\r\nINFO[07-01|22:00:53.822] [10/16 CallTraces] Progress              number=4799699 blk/second=696.400 alloc=6.6GB sys=15.9GB\r\nINFO[07-01|22:01:10.084] [p2p] GoodPeers                          eth66=33\r\nINFO[07-01|22:01:13.278] [10/16 CallTraces] Progress              number=4814482 blk/second=739.150 alloc=7.3GB sys=15.9GB\r\nINFO[07-01|22:01:33.277] [10/16 CallTraces] Progress              number=4829710 blk/second=761.400 alloc=5.0GB sys=15.9GB\r\nINFO[07-01|22:01:53.277] [10/16 CallTraces] Progress              number=4849477 blk/second=988.350 alloc=6.1GB sys=15.9GB\r\nINFO[07-01|22:02:01.678] Flushed buffer file                      name=/big/eth/erigon/etl-temp/erigon-sortable-buf-2705091662 alloc=6.2GB sys=15.9GB\r\nINFO[07-01|22:02:13.281] [10/16 CallTraces] Progress              number=4857430 blk/second=397.650 alloc=7.1GB sys=15.9GB\r\nINFO[07-01|22:02:25.471] Flushed buffer file                      name=/big/eth/erigon/etl-temp/erigon-sortable-buf-2188550047 alloc=7.2GB sys=15.9GB\r\nINFO[07-01|22:02:33.278] [10/16 CallTraces] Progress              number=4860129 blk/second=134.950 alloc=7.6GB sys=15.9GB\r\nKilled\r\n```\r\nOOM logs:\r\n\r\n```\r\ndmesg -T | egrep -i 'killed process'\r\n\r\n]: dmesg -T  | egrep -i 'killed process'\r\n[Fri Jul  1 22:03:04 2022] Out of memory: Killed process 519331 (erigon) total-vm:15506724144kB, anon-rss:9333524kB, file-rss:0kB, shmem-rss:0kB, UID:1000 pgtables:3159912kB oom_score_adj:0\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1172904253/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
