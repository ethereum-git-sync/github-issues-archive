{
  "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/1436",
  "repository_url": "https://api.github.com/repos/ledgerwatch/erigon",
  "labels_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/1436/labels{/name}",
  "comments_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/1436/comments",
  "events_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/1436/events",
  "html_url": "https://github.com/ledgerwatch/erigon/issues/1436",
  "id": 780490701,
  "node_id": "MDU6SXNzdWU3ODA0OTA3MDE=",
  "number": 1436,
  "title": "Tracing has incorrect gasUsed for value transfers",
  "user": {
    "login": "naddison36",
    "id": 6491112,
    "node_id": "MDQ6VXNlcjY0OTExMTI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6491112?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/naddison36",
    "html_url": "https://github.com/naddison36",
    "followers_url": "https://api.github.com/users/naddison36/followers",
    "following_url": "https://api.github.com/users/naddison36/following{/other_user}",
    "gists_url": "https://api.github.com/users/naddison36/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/naddison36/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/naddison36/subscriptions",
    "organizations_url": "https://api.github.com/users/naddison36/orgs",
    "repos_url": "https://api.github.com/users/naddison36/repos",
    "events_url": "https://api.github.com/users/naddison36/events{/privacy}",
    "received_events_url": "https://api.github.com/users/naddison36/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 4566396003,
      "node_id": "LA_kwDOC0FsAM8AAAABEC2sYw",
      "url": "https://api.github.com/repos/ledgerwatch/erigon/labels/Stale",
      "name": "Stale",
      "color": "ededed",
      "default": false,
      "description": null
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 6,
  "created_at": "2021-01-06T11:39:31Z",
  "updated_at": "2023-09-16T02:01:24Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "I'm seeing incorrect `gasUsed` amounts for ether value transfers from tracing\r\n\r\nAn examples is this Uniswap example that removes ether liquidity [0xed080a06ef45da6f2f09e8371b9f2f7f9c5784ac431f07f55d32cf2fee62a4cc](https://etherscan.io/tx/0xed080a06ef45da6f2f09e8371b9f2f7f9c5784ac431f07f55d32cf2fee62a4cc)\r\n\r\nThe JSON RPC call I used\r\n```json\r\n{\r\n    \"jsonrpc\":\"2.0\",\r\n    \"method\":\"debug_traceTransaction\",\r\n    \"params\":[\"0xed080a06ef45da6f2f09e8371b9f2f7f9c5784ac431f07f55d32cf2fee62a4cc\", {\"tracer\": \"callTracer\"}],\r\n    \"id\":1\r\n}\r\n```\r\n\r\nThe last call in the trace is\r\n```json\r\n{\r\n    \"type\": \"CALL\",\r\n    \"from\": \"0x7a250d5630b4cf539739df2c5dacb4c659f2488d\",\r\n    \"to\": \"0xe4bef064c912bc95c404850019909efe8d357716\",\r\n    \"value\": \"0xa781797b5b33caf\",\r\n    \"gas\": \"0xdeadbeef\",\r\n    \"gasUsed\": \"0xdead4a90\",\r\n    \"input\": \"0x\",\r\n    \"output\": \"0x\"\r\n}\r\n```\r\n\r\nThe 0xdead4a90 (3,735,898,768)  `gasUsed` can't be right as the transaction only used 181,212 gas\r\n\r\nThe code the initiated the last value transfer is\r\n```Solidity\r\nfunction safeTransferETH(address to, uint value) internal {\r\n    (bool success,) = to.call{value:value}(new bytes(0));\r\n    require(success, 'TransferHelper: ETH_TRANSFER_FAILED');\r\n}\r\n```",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/1436/reactions",
    "total_count": 1,
    "+1": 1,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/1436/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/937098049",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/1436#issuecomment-937098049",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/1436",
    "id": 937098049,
    "node_id": "IC_kwDOC0FsAM432vtB",
    "user": {
      "login": "mjpowersjr",
      "id": 133083,
      "node_id": "MDQ6VXNlcjEzMzA4Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/133083?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mjpowersjr",
      "html_url": "https://github.com/mjpowersjr",
      "followers_url": "https://api.github.com/users/mjpowersjr/followers",
      "following_url": "https://api.github.com/users/mjpowersjr/following{/other_user}",
      "gists_url": "https://api.github.com/users/mjpowersjr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mjpowersjr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mjpowersjr/subscriptions",
      "organizations_url": "https://api.github.com/users/mjpowersjr/orgs",
      "repos_url": "https://api.github.com/users/mjpowersjr/repos",
      "events_url": "https://api.github.com/users/mjpowersjr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mjpowersjr/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-10-06T20:43:55Z",
    "updated_at": "2021-10-06T20:43:55Z",
    "author_association": "NONE",
    "body": "I'm not sure if I'm seeing a similar problem with `trace_call` or if I'm mis-interpreting the results. I wrote a simple typescript utility to calculate gasUsed from trace results and compare to a txn receipt. The results from a trace and an actual receipt are very different.\r\n\r\n\r\n```ts\r\nimport process from 'process';\r\nimport { ethers, BigNumber } from 'ethers';\r\n\r\nasync function main(args: string[]) {\r\n    const rpcEndpoint = args[0];\r\n    const txnHash = args[1];\r\n\r\n    // collect txn data\r\n    const provider = new ethers.providers.JsonRpcProvider(rpcEndpoint)\r\n    const txn = await provider.getTransaction(txnHash);\r\n    const txnReceipt = await provider.getTransactionReceipt(txnHash);\r\n\r\n    // trace txn\r\n    console.log(`tracing ${txnHash} @ ${txnReceipt.blockNumber}`)\r\n    const traceResponse = await provider.send('trace_call', [\r\n        {\r\n            from: txn.from,\r\n            to: txn.to,\r\n            data: txn.data,\r\n            value: '0x' + txn.value.toString(),\r\n        },\r\n        ['trace'],\r\n        '0x' + txnReceipt.blockNumber.toString(16)\r\n    ]);\r\n\r\n    // estimate gas usage\r\n    const txnCost = 21000;\r\n    const dataCost = txn.data.length\r\n        ? 68\r\n        : 4;\r\n    const txnGasOverhead = txnCost + dataCost;\r\n\r\n    const gasEstimate = traceResponse.trace\r\n        .reduce((currentGasUsed: BigNumber, step: any) => {\r\n            //console.log(step);\r\n\r\n            const additionalGasUsed = step.result\r\n                ? BigNumber.from(step.result.gasUsed)\r\n                : BigNumber.from(0);\r\n\r\n            const updatedGasUsed = currentGasUsed.add(additionalGasUsed);\r\n            return updatedGasUsed;\r\n        }, BigNumber.from(txnGasOverhead))\r\n\r\n\r\n    console.table({\r\n        txnHash,\r\n        gasUsed: txnReceipt.gasUsed.toString(),\r\n        gasEstimate: gasEstimate.toString(),\r\n    })\r\n}\r\n\r\n\r\nconst args = process.argv.slice(2);\r\n\r\nmain(args).catch((e) => {\r\n    console.error(e);\r\n    process.exit(1);\r\n})\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/937098049/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/937275908",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/1436#issuecomment-937275908",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/1436",
    "id": 937275908,
    "node_id": "IC_kwDOC0FsAM433bIE",
    "user": {
      "login": "tjayrush",
      "id": 5417918,
      "node_id": "MDQ6VXNlcjU0MTc5MTg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5417918?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tjayrush",
      "html_url": "https://github.com/tjayrush",
      "followers_url": "https://api.github.com/users/tjayrush/followers",
      "following_url": "https://api.github.com/users/tjayrush/following{/other_user}",
      "gists_url": "https://api.github.com/users/tjayrush/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tjayrush/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tjayrush/subscriptions",
      "organizations_url": "https://api.github.com/users/tjayrush/orgs",
      "repos_url": "https://api.github.com/users/tjayrush/repos",
      "events_url": "https://api.github.com/users/tjayrush/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tjayrush/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-10-06T22:34:17Z",
    "updated_at": "2021-10-06T22:34:17Z",
    "author_association": "CONTRIBUTOR",
    "body": "Can you provide an example transaction where you think it's failing? I can run against both `Erigon` and `OpenEthereum` and see if the results agree. The reason I'm asking is because I remember looking at a similar issue with `OpenEthereum` and I'd like to see if they are the same. That might help to understand what's going on.",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/937275908/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/937826717",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/1436#issuecomment-937826717",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/1436",
    "id": 937826717,
    "node_id": "IC_kwDOC0FsAM435hmd",
    "user": {
      "login": "mjpowersjr",
      "id": 133083,
      "node_id": "MDQ6VXNlcjEzMzA4Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/133083?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mjpowersjr",
      "html_url": "https://github.com/mjpowersjr",
      "followers_url": "https://api.github.com/users/mjpowersjr/followers",
      "following_url": "https://api.github.com/users/mjpowersjr/following{/other_user}",
      "gists_url": "https://api.github.com/users/mjpowersjr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mjpowersjr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mjpowersjr/subscriptions",
      "organizations_url": "https://api.github.com/users/mjpowersjr/orgs",
      "repos_url": "https://api.github.com/users/mjpowersjr/repos",
      "events_url": "https://api.github.com/users/mjpowersjr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mjpowersjr/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-10-07T14:05:23Z",
    "updated_at": "2021-10-07T14:05:23Z",
    "author_association": "NONE",
    "body": "Hi @tjayrush ! Good to see you. I cleaned up the code above and put it in a repo in case it's helpful in your tests.\r\n\r\nhttps://github.com/mjpowersjr/gas-used-summary-test\r\n\r\n----\r\n\r\nWhen running with `0xe8bf9c4cf705575a7125aa91d359b66119bd84f8a8051fb993e96991bf2e2147`\r\nI get the following results:\r\n```\r\n┌────────────────────┬──────────────────────────────────────────────────────────────────────┐\r\n│      (index)       │                                Values                                │\r\n├────────────────────┼──────────────────────────────────────────────────────────────────────┤\r\n│    Transaction     │ '0xe8bf9c4cf705575a7125aa91d359b66119bd84f8a8051fb993e96991bf2e2147' │\r\n│ Gas Used - Receipt │                               '619690'                               │\r\n│  Gas Used - Trace  │                              '3746628'                               │\r\n└────────────────────┴──────────────────────────────────────────────────────────────────────┘\r\n```\r\n---\r\nWhen running with @naddison36 's original example, I get:\r\n```\r\n┌────────────────────┬──────────────────────────────────────────────────────────────────────┐\r\n│      (index)       │                                Values                                │\r\n├────────────────────┼──────────────────────────────────────────────────────────────────────┤\r\n│    Transaction     │ '0xed080a06ef45da6f2f09e8371b9f2f7f9c5784ac431f07f55d32cf2fee62a4cc' │\r\n│ Gas Used - Receipt │                               '181212'                               │\r\n│  Gas Used - Trace  │                               '21068'                                │\r\n└────────────────────┴──────────────────────────────────────────────────────────────────────┘\r\n\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/937826717/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/947202467",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/1436#issuecomment-947202467",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/1436",
    "id": 947202467,
    "node_id": "IC_kwDOC0FsAM44dSmj",
    "user": {
      "login": "tjayrush",
      "id": 5417918,
      "node_id": "MDQ6VXNlcjU0MTc5MTg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5417918?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tjayrush",
      "html_url": "https://github.com/tjayrush",
      "followers_url": "https://api.github.com/users/tjayrush/followers",
      "following_url": "https://api.github.com/users/tjayrush/following{/other_user}",
      "gists_url": "https://api.github.com/users/tjayrush/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tjayrush/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tjayrush/subscriptions",
      "organizations_url": "https://api.github.com/users/tjayrush/orgs",
      "repos_url": "https://api.github.com/users/tjayrush/repos",
      "events_url": "https://api.github.com/users/tjayrush/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tjayrush/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-10-20T00:18:57Z",
    "updated_at": "2021-10-20T00:29:38Z",
    "author_association": "CONTRIBUTOR",
    "body": "I ran `0xed080a06ef45da6f2f09e8371b9f2f7f9c5784ac431f07f55d32cf2fee62a4cc` against both OpenEthereum and Erigon and got two different results:\r\n\r\n**For OpenEthereum:**\r\n```\r\n┌────────────────────┬──────────────────────────────────────────────────────────────────────┐\r\n│      (index)       │                                Values                                │\r\n├────────────────────┼──────────────────────────────────────────────────────────────────────┤\r\n│    Transaction     │ '0xed080a06ef45da6f2f09e8371b9f2f7f9c5784ac431f07f55d32cf2fee62a4cc' │\r\n│ Gas Used - Receipt │                               '181212'                               │\r\n│  Gas Used - Trace  │                               '21068'                                │\r\n└────────────────────┴──────────────────────────────────────────────────────────────────────┘\r\n```\r\n\r\n**For Erigon:**\r\n```\r\n┌────────────────────┬──────────────────────────────────────────────────────────────────────┐\r\n│      (index)       │                                Values                                │\r\n├────────────────────┼──────────────────────────────────────────────────────────────────────┤\r\n│    Transaction     │ '0xed080a06ef45da6f2f09e8371b9f2f7f9c5784ac431f07f55d32cf2fee62a4cc' │\r\n│ Gas Used - Receipt │                               '181212'                               │\r\n│  Gas Used - Trace  │                               '24068'                                │\r\n└────────────────────┴──────────────────────────────────────────────────────────────────────┘\r\n```\r\n\r\nJust FYI.\r\n\r\nI can't remember the exact reason for this, but a long time ago, when I first started reviewing OpenEthereum traces, I think I found the same confusing discrepancy. I spent a lot of time figuring it out, and I convinced myself that the problem was in the very first trace. We found that simply summing the `gasUsed` values from the traces did not add up to the total gas used in the transaction's receipt.\r\n\r\nThe first trace returned by both OpenEthereum and Erigon is identical to the transaction itself (same `to`, same `from`, same `input` data, etc.) with the exception of one field -- and here's where my memory fails me -- I think it was `gasUsed`. We figured out a way to make sense of that value and if we adjusted for that, then we could spin through the traces and sum them and arrive at the value reported in the receipt. We concluded (and again, please forgive me for not remembering--it was three years ago) that OpenEthereum was reporting an accurate but unexpected value in the first trace.\r\n\r\nJust off the top of my head -- I seem to remember that the `gasUsed` reported in the first trace excluded the cost of the data in the `input` data. In other words, it was only for the operations in that one trace -- not the cost of the data. Does that make sense?\r\n\r\nIf that were true, then you should be able to subtrace the receipt value from the calculated value from the traces and the resulting number would be the cost of the data in the `input`. (But, don't quote me, please.)",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/947202467/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1186127185",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/1436#issuecomment-1186127185",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/1436",
    "id": 1186127185,
    "node_id": "IC_kwDOC0FsAM5Gst1R",
    "user": {
      "login": "mandrigin",
      "id": 466427,
      "node_id": "MDQ6VXNlcjQ2NjQyNw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/466427?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mandrigin",
      "html_url": "https://github.com/mandrigin",
      "followers_url": "https://api.github.com/users/mandrigin/followers",
      "following_url": "https://api.github.com/users/mandrigin/following{/other_user}",
      "gists_url": "https://api.github.com/users/mandrigin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mandrigin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mandrigin/subscriptions",
      "organizations_url": "https://api.github.com/users/mandrigin/orgs",
      "repos_url": "https://api.github.com/users/mandrigin/repos",
      "events_url": "https://api.github.com/users/mandrigin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mandrigin/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-16T09:07:24Z",
    "updated_at": "2022-07-16T09:07:24Z",
    "author_association": "CONTRIBUTOR",
    "body": "@tjayrush is that still the issue?",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1186127185/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1722104007",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/1436#issuecomment-1722104007",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/1436",
    "id": 1722104007,
    "node_id": "IC_kwDOC0FsAM5mpTjH",
    "user": {
      "login": "github-actions[bot]",
      "id": 41898282,
      "node_id": "MDM6Qm90NDE4OTgyODI=",
      "avatar_url": "https://avatars.githubusercontent.com/in/15368?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/github-actions%5Bbot%5D",
      "html_url": "https://github.com/apps/github-actions",
      "followers_url": "https://api.github.com/users/github-actions%5Bbot%5D/followers",
      "following_url": "https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}",
      "gists_url": "https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/github-actions%5Bbot%5D/subscriptions",
      "organizations_url": "https://api.github.com/users/github-actions%5Bbot%5D/orgs",
      "repos_url": "https://api.github.com/users/github-actions%5Bbot%5D/repos",
      "events_url": "https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}",
      "received_events_url": "https://api.github.com/users/github-actions%5Bbot%5D/received_events",
      "type": "Bot",
      "site_admin": false
    },
    "created_at": "2023-09-16T02:01:23Z",
    "updated_at": "2023-09-16T02:01:23Z",
    "author_association": "NONE",
    "body": "This issue is stale because it has been open for 40 days with no activity. Remove stale label or comment, or this will be closed in 7 days.",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1722104007/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
