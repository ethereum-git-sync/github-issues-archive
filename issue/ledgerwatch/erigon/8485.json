{
  "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/8485",
  "repository_url": "https://api.github.com/repos/ledgerwatch/erigon",
  "labels_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/8485/labels{/name}",
  "comments_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/8485/comments",
  "events_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/8485/events",
  "html_url": "https://github.com/ledgerwatch/erigon/issues/8485",
  "id": 1944316975,
  "node_id": "I_kwDOC0FsAM5z4-wv",
  "number": 8485,
  "title": "out of memory kill",
  "user": {
    "login": "1997cui",
    "id": 5462776,
    "node_id": "MDQ6VXNlcjU0NjI3NzY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5462776?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/1997cui",
    "html_url": "https://github.com/1997cui",
    "followers_url": "https://api.github.com/users/1997cui/followers",
    "following_url": "https://api.github.com/users/1997cui/following{/other_user}",
    "gists_url": "https://api.github.com/users/1997cui/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/1997cui/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/1997cui/subscriptions",
    "organizations_url": "https://api.github.com/users/1997cui/orgs",
    "repos_url": "https://api.github.com/users/1997cui/repos",
    "events_url": "https://api.github.com/users/1997cui/events{/privacy}",
    "received_events_url": "https://api.github.com/users/1997cui/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2023-10-16T04:13:24Z",
  "updated_at": "2023-12-15T07:08:55Z",
  "closed_at": "2023-12-15T07:08:55Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "#### System information\r\n\r\nErigon version: `./erigon --version`\r\n\r\nOS & Version: Linux\r\n\r\nCommit hash: 2.52.5-7c5e4e77\r\n\r\nErigon Command (with flags/config):\r\n```\r\nEnvironment=\"GOGC=50\"\r\nEnvironment=\"GOMEMLIMIT=6000MiB\"\r\nEnvironment=\"GOMAXPROCS=4\"\r\nWorkingDirectory=%h/software/blockchain\r\n\r\n%h/software/blockchain/erigon --pprof --torrent.download.rate=80mb --datadir=/srv/blockchain/erigon/ --http.api eth,erigon,trace,debug,web3,net,txpool,ots,engine --http.corsdomain \"*\" --batchSize=8mb --ws --internalcl\r\n```\r\nConcensus Layer: Internal\r\n\r\nConcensus Layer Command (with flags/config): Internal\r\n\r\nChain/Network: \r\n\r\n#### Expected behaviour\r\n\r\nConsistent memory usage\r\n\r\n#### Actual behaviour\r\n\r\nIt seems that memory is leaking.\r\n\r\n#### Steps to reproduce the behaviour\r\n![mem2](https://github.com/ledgerwatch/erigon/assets/5462776/b37b35ab-9b39-4ba7-b04c-d31cad2fc962)\r\n\r\n\r\n#### Backtrace\r\n\r\n````\r\n[backtrace]\r\n````\r\n",
  "closed_by": {
    "login": "1997cui",
    "id": 5462776,
    "node_id": "MDQ6VXNlcjU0NjI3NzY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5462776?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/1997cui",
    "html_url": "https://github.com/1997cui",
    "followers_url": "https://api.github.com/users/1997cui/followers",
    "following_url": "https://api.github.com/users/1997cui/following{/other_user}",
    "gists_url": "https://api.github.com/users/1997cui/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/1997cui/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/1997cui/subscriptions",
    "organizations_url": "https://api.github.com/users/1997cui/orgs",
    "repos_url": "https://api.github.com/users/1997cui/repos",
    "events_url": "https://api.github.com/users/1997cui/events{/privacy}",
    "received_events_url": "https://api.github.com/users/1997cui/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/8485/reactions",
    "total_count": 1,
    "+1": 1,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/8485/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1765585939",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/8485#issuecomment-1765585939",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/8485",
    "id": 1765585939,
    "node_id": "IC_kwDOC0FsAM5pPLQT",
    "user": {
      "login": "AskAlexSharov",
      "id": 46885206,
      "node_id": "MDQ6VXNlcjQ2ODg1MjA2",
      "avatar_url": "https://avatars.githubusercontent.com/u/46885206?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AskAlexSharov",
      "html_url": "https://github.com/AskAlexSharov",
      "followers_url": "https://api.github.com/users/AskAlexSharov/followers",
      "following_url": "https://api.github.com/users/AskAlexSharov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AskAlexSharov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AskAlexSharov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AskAlexSharov/subscriptions",
      "organizations_url": "https://api.github.com/users/AskAlexSharov/orgs",
      "repos_url": "https://api.github.com/users/AskAlexSharov/repos",
      "events_url": "https://api.github.com/users/AskAlexSharov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AskAlexSharov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-10-17T03:01:45Z",
    "updated_at": "2023-10-17T03:01:45Z",
    "author_association": "COLLABORATOR",
    "body": "thank you for good bug-report: here is 1 part of GOMEMLIMIT support https://github.com/ledgerwatch/erigon/pull/8498\r\n\r\nstill need investigate why sendBlocksRequest eating much",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1765585939/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1767159207",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/8485#issuecomment-1767159207",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/8485",
    "id": 1767159207,
    "node_id": "IC_kwDOC0FsAM5pVLWn",
    "user": {
      "login": "luarx",
      "id": 22997139,
      "node_id": "MDQ6VXNlcjIyOTk3MTM5",
      "avatar_url": "https://avatars.githubusercontent.com/u/22997139?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/luarx",
      "html_url": "https://github.com/luarx",
      "followers_url": "https://api.github.com/users/luarx/followers",
      "following_url": "https://api.github.com/users/luarx/following{/other_user}",
      "gists_url": "https://api.github.com/users/luarx/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/luarx/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/luarx/subscriptions",
      "organizations_url": "https://api.github.com/users/luarx/orgs",
      "repos_url": "https://api.github.com/users/luarx/repos",
      "events_url": "https://api.github.com/users/luarx/events{/privacy}",
      "received_events_url": "https://api.github.com/users/luarx/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-10-17T20:51:23Z",
    "updated_at": "2023-10-17T21:23:43Z",
    "author_association": "NONE",
    "body": "Just in case it can help, **we are seeing also a huge memory consumption (and also CPU) since we upgraded** on October 10th two of our Erigon **mainnet** nodes from `v2.42.0 -> v2.50.1` ðŸ˜¨ \r\n\r\nMore info: \r\n- Using Docker\r\n- Lighthouse for Consesus layer. It was upgraded also from `v4.1.0 -> v4.4.1`\r\n- Erigon configuration was not changed between versions\r\n```\r\n            \"--chain=mainnet\",\r\n            \"--metrics\",\r\n            \"--metrics.addr=0.0.0.0\",\r\n            \"--metrics.port=6060\",\r\n            \"--private.api.addr=0.0.0.0:9089\",\r\n            \"--pprof\",\r\n            \"--pprof.addr=0.0.0.0\",\r\n            \"--pprof.port=6061\",\r\n            \"--snapshots=true\",\r\n            \"--torrent.upload.rate=500mb\", # TODO: Remove me\r\n            \"--torrent.download.rate=1200mb\", # TODO: Change to 20mb\r\n            \"--http\",\r\n            \"--http.api=engine,net,eth,debug,trace,txpool,web3\",\r\n            \"--http.addr=0.0.0.0\",\r\n            \"--http.port=8545\",\r\n            \"--http.vhosts=*\",\r\n            \"--http.corsdomain=*\",\r\n            \"--authrpc.addr=0.0.0.0\",\r\n            \"--authrpc.jwtsecret=/mnt/jwtsecret/jwtsecret\",\r\n            \"--authrpc.port=9545\",\r\n            \"--authrpc.vhosts=*\",\r\n            \"--prune=\",\r\n            \"--rpc.batch.limit=1000\",\r\n            \"--rpc.returndata.limit=500000\",\r\n            \"--trace.maxtraces=5000000\"\r\n```\r\n            \r\n![image](https://github.com/ledgerwatch/erigon/assets/22997139/38d59572-8549-42a1-be2a-f710026d033f)\r\n![image](https://github.com/ledgerwatch/erigon/assets/22997139/91a94ce6-9b50-4aa9-8584-c0084bf39397)\r\n\r\nAnd, at the same time, the network rate was increased (more related to `Transmitted bytes`)\r\n![image](https://github.com/ledgerwatch/erigon/assets/22997139/b97ed073-1c99-4d17-9d2d-4ad72cbaa23f)\r\n![image](https://github.com/ledgerwatch/erigon/assets/22997139/ea992314-71f0-4443-9c15-8e5b820b9bed)\r\n\r\nDo you think that this is related to the issue or should I open a new one @AskAlexSharov ?",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1767159207/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1767352401",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/8485#issuecomment-1767352401",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/8485",
    "id": 1767352401,
    "node_id": "IC_kwDOC0FsAM5pV6hR",
    "user": {
      "login": "AskAlexSharov",
      "id": 46885206,
      "node_id": "MDQ6VXNlcjQ2ODg1MjA2",
      "avatar_url": "https://avatars.githubusercontent.com/u/46885206?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AskAlexSharov",
      "html_url": "https://github.com/AskAlexSharov",
      "followers_url": "https://api.github.com/users/AskAlexSharov/followers",
      "following_url": "https://api.github.com/users/AskAlexSharov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AskAlexSharov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AskAlexSharov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AskAlexSharov/subscriptions",
      "organizations_url": "https://api.github.com/users/AskAlexSharov/orgs",
      "repos_url": "https://api.github.com/users/AskAlexSharov/repos",
      "events_url": "https://api.github.com/users/AskAlexSharov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AskAlexSharov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-10-17T23:31:13Z",
    "updated_at": "2023-10-17T23:31:13Z",
    "author_association": "COLLABORATOR",
    "body": "1. can try cherry-pick https://github.com/ledgerwatch/erigon/pull/8431\r\n2. add flag --pprof\r\ngo tool pprof -inuse_space -png http://127.0.0.1:6060/debug/pprof/heap > mem.png\r\nshow this file",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1767352401/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1767953864",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/8485#issuecomment-1767953864",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/8485",
    "id": 1767953864,
    "node_id": "IC_kwDOC0FsAM5pYNXI",
    "user": {
      "login": "luarx",
      "id": 22997139,
      "node_id": "MDQ6VXNlcjIyOTk3MTM5",
      "avatar_url": "https://avatars.githubusercontent.com/u/22997139?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/luarx",
      "html_url": "https://github.com/luarx",
      "followers_url": "https://api.github.com/users/luarx/followers",
      "following_url": "https://api.github.com/users/luarx/following{/other_user}",
      "gists_url": "https://api.github.com/users/luarx/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/luarx/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/luarx/subscriptions",
      "organizations_url": "https://api.github.com/users/luarx/orgs",
      "repos_url": "https://api.github.com/users/luarx/repos",
      "events_url": "https://api.github.com/users/luarx/events{/privacy}",
      "received_events_url": "https://api.github.com/users/luarx/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-10-18T08:31:49Z",
    "updated_at": "2023-10-18T08:53:24Z",
    "author_association": "NONE",
    "body": "Sorry, I use Docker images :( \r\nIs there any other way to test?",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1767953864/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1774280899",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/8485#issuecomment-1774280899",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/8485",
    "id": 1774280899,
    "node_id": "IC_kwDOC0FsAM5pwWDD",
    "user": {
      "login": "1997cui",
      "id": 5462776,
      "node_id": "MDQ6VXNlcjU0NjI3NzY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5462776?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/1997cui",
      "html_url": "https://github.com/1997cui",
      "followers_url": "https://api.github.com/users/1997cui/followers",
      "following_url": "https://api.github.com/users/1997cui/following{/other_user}",
      "gists_url": "https://api.github.com/users/1997cui/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/1997cui/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/1997cui/subscriptions",
      "organizations_url": "https://api.github.com/users/1997cui/orgs",
      "repos_url": "https://api.github.com/users/1997cui/repos",
      "events_url": "https://api.github.com/users/1997cui/events{/privacy}",
      "received_events_url": "https://api.github.com/users/1997cui/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-10-23T01:22:37Z",
    "updated_at": "2023-10-23T01:22:37Z",
    "author_association": "NONE",
    "body": "Hi I cherry-picked #8431 and #8498 , run for 3 days, and here is the latest result:\r\n![mem](https://github.com/ledgerwatch/erigon/assets/5462776/ca906756-2c5c-4b13-837c-f689e13dcb6c)\r\nHere is my git history\r\n```bash\r\nctyi@cuiDesktop:~/software/blockchain/erigonrepo$ git log --oneline \r\n9a652126c (HEAD -> 2.52-try-fix-mem) save\r\nca73eae9d bor: demote some logs\r\nfe1fa86fb sync: refactor headerdownload.Link pruning operations\r\n100f04007 sync: fix a memory leak when header verification fails\r\n8e94473e7 sync: log invalid and rejected header stats\r\n7c5e4e770 (tag: v2.52.5, origin/release/2.52, release/2.52) Patch 2.52.5 (#8468)\r\n48a109950 (tag: v2.52.4) Set root-reserve-mb to 16GB\r\nfe5fdda1e (tag: v2.52.3) Set root-reserve-mb to 4GB\r\nd8ed8e68e (tag: v2.52.2) goreleaser: Maximize build space (#8451)\r\n6f793b5c7 (tag: v2.52.1) Fix invalid pre-fetched header broadcast (#8442) (#8446)\r\n24ee988ea Patch release 2.52.1 (#8440)\r\n761af94b2 (tag: v2.52.0) params: remove dev from v2.52.0 (#8432)\r\n\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1774280899/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
