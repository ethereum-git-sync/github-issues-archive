{
  "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/7702",
  "repository_url": "https://api.github.com/repos/ledgerwatch/erigon",
  "labels_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/7702/labels{/name}",
  "comments_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/7702/comments",
  "events_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/7702/events",
  "html_url": "https://github.com/ledgerwatch/erigon/issues/7702",
  "id": 1751049389,
  "node_id": "I_kwDOC0FsAM5oXuSt",
  "number": 7702,
  "title": "block transaction replay right after block update gives errors",
  "user": {
    "login": "chris-bce",
    "id": 107156386,
    "node_id": "U_kgDOBmMTog",
    "avatar_url": "https://avatars.githubusercontent.com/u/107156386?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/chris-bce",
    "html_url": "https://github.com/chris-bce",
    "followers_url": "https://api.github.com/users/chris-bce/followers",
    "following_url": "https://api.github.com/users/chris-bce/following{/other_user}",
    "gists_url": "https://api.github.com/users/chris-bce/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/chris-bce/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/chris-bce/subscriptions",
    "organizations_url": "https://api.github.com/users/chris-bce/orgs",
    "repos_url": "https://api.github.com/users/chris-bce/repos",
    "events_url": "https://api.github.com/users/chris-bce/events{/privacy}",
    "received_events_url": "https://api.github.com/users/chris-bce/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 4566396003,
      "node_id": "LA_kwDOC0FsAM8AAAABEC2sYw",
      "url": "https://api.github.com/repos/ledgerwatch/erigon/labels/Stale",
      "name": "Stale",
      "color": "ededed",
      "default": false,
      "description": null
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2023-06-10T17:23:34Z",
  "updated_at": "2023-07-31T02:21:32Z",
  "closed_at": "2023-07-31T02:21:32Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "#### System information\r\n\r\nErigon version: `./erigon --version`\r\n\r\nerigon version 2.45.1-stable-83398871\r\n\r\nOS & Version: Linux\r\n\r\nChain/Network: erigon mainnet\r\n\r\n#### Expected behaviour\r\n\r\nreplaying block transactions immediately after block update should succeed\r\n\r\n#### Actual behaviour\r\n\r\nreplaying block transactions immediately after block update shows errors. adding a `time.sleep(1)` after getting the update and before replaying block transactions seems to make them go away\r\n\r\n#### Steps to reproduce the behaviour\r\n\r\nuse the following script:\r\n\r\n```\r\nfrom typing import Optional\r\n\r\nimport json\r\nimport pprint\r\nimport subprocess\r\n\r\ncurrent = None\r\nnext_id = 1\r\n\r\n\r\ndef pop_id() -> int:\r\n    global next_id\r\n    result = next_id\r\n    next_id += 1\r\n    return result\r\n\r\n\r\ndef poll_for_new_block(prev: Optional[str]) -> str:\r\n    while True:\r\n        s = subprocess.check_output(\"\"\"curl -X POST -H \"Content-Type: application/json\" --data '{\"jsonrpc\":\"2.0\",\"method\":\"eth_getBlockByNumber\",\"params\":[\"latest\", false],\"id\":%d}' localhost:8545\"\"\" % pop_id(), shell=True, stderr=subprocess.DEVNULL)\r\n        #print(s)\r\n        data = json.loads(s)\r\n        block_hash = data['result']['hash']\r\n        if prev is None or block_hash != prev:\r\n            return block_hash\r\n\r\ncurrent = poll_for_new_block(None)\r\n\r\nwhile True:\r\n    current = poll_for_new_block(current)\r\n    data = json.loads(subprocess.check_output(\"\"\"curl -X POST -H \"Content-Type: application/json\" --data '{\"jsonrpc\":\"2.0\",\"method\":\"trace_replayBlockTransactions\",\"params\":[\"%s\", [\"stateDiff\"]],\"id\":%d}' localhost:8545\"\"\" % (current, pop_id()), shell=True, stderr=subprocess.DEVNULL))\r\n    pprint.pprint(data)\r\n```\r\n\r\n#### Backtrace\r\n\r\nthere will be a stream of errors in the output like:\r\n\r\n````\r\n{'error': {'code': -32000,\r\n           'message': 'first run for txIndex 0 error: nonce too low: address '\r\n                      '0x1aCa6E70c0aA9A23a340B0F4308eb0dE520dBd9D, tx: 18 '\r\n                      'state: 19'},\r\n 'id': 772,\r\n 'jsonrpc': '2.0'}\r\n{'error': {'code': -32000,\r\n           'message': 'first run for txIndex 0 error: nonce too low: address '\r\n                      '0xD6f859ba5076e7690b2056f697e5097f9FE836Ed, tx: 9483 '\r\n                      'state: 9484'},\r\n 'id': 881,\r\n 'jsonrpc': '2.0'}\r\n {'error': {'code': -32000,\r\n           'message': 'first run for txIndex 0 error: nonce too low: address '\r\n                      '0xd78ceBa1f9291dadE3539bD558eB5D9B969ec66F, tx: 13213 '\r\n                      'state: 13214'},\r\n 'id': 1034,\r\n 'jsonrpc': '2.0'}\r\n````\r\n",
  "closed_by": {
    "login": "github-actions[bot]",
    "id": 41898282,
    "node_id": "MDM6Qm90NDE4OTgyODI=",
    "avatar_url": "https://avatars.githubusercontent.com/in/15368?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/github-actions%5Bbot%5D",
    "html_url": "https://github.com/apps/github-actions",
    "followers_url": "https://api.github.com/users/github-actions%5Bbot%5D/followers",
    "following_url": "https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}",
    "gists_url": "https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/github-actions%5Bbot%5D/subscriptions",
    "organizations_url": "https://api.github.com/users/github-actions%5Bbot%5D/orgs",
    "repos_url": "https://api.github.com/users/github-actions%5Bbot%5D/repos",
    "events_url": "https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}",
    "received_events_url": "https://api.github.com/users/github-actions%5Bbot%5D/received_events",
    "type": "Bot",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/7702/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/7702/timeline",
  "performed_via_github_app": null,
  "state_reason": "not_planned"
}
[
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1586583280",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/7702#issuecomment-1586583280",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/7702",
    "id": 1586583280,
    "node_id": "IC_kwDOC0FsAM5ekVbw",
    "user": {
      "login": "bgelb",
      "id": 203273,
      "node_id": "MDQ6VXNlcjIwMzI3Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/203273?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bgelb",
      "html_url": "https://github.com/bgelb",
      "followers_url": "https://api.github.com/users/bgelb/followers",
      "following_url": "https://api.github.com/users/bgelb/following{/other_user}",
      "gists_url": "https://api.github.com/users/bgelb/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bgelb/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bgelb/subscriptions",
      "organizations_url": "https://api.github.com/users/bgelb/orgs",
      "repos_url": "https://api.github.com/users/bgelb/repos",
      "events_url": "https://api.github.com/users/bgelb/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bgelb/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-06-12T05:04:55Z",
    "updated_at": "2023-06-12T05:04:55Z",
    "author_association": "CONTRIBUTOR",
    "body": "This seems to be due to a regression introduced somewhere after release 2.42.\r\n\r\nI see the failure with 2.45.1, and I don't see it on 2.42 (which is the prior version deployed on my systems).",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1586583280/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1586811066",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/7702#issuecomment-1586811066",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/7702",
    "id": 1586811066,
    "node_id": "IC_kwDOC0FsAM5elNC6",
    "user": {
      "login": "AskAlexSharov",
      "id": 46885206,
      "node_id": "MDQ6VXNlcjQ2ODg1MjA2",
      "avatar_url": "https://avatars.githubusercontent.com/u/46885206?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AskAlexSharov",
      "html_url": "https://github.com/AskAlexSharov",
      "followers_url": "https://api.github.com/users/AskAlexSharov/followers",
      "following_url": "https://api.github.com/users/AskAlexSharov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AskAlexSharov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AskAlexSharov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AskAlexSharov/subscriptions",
      "organizations_url": "https://api.github.com/users/AskAlexSharov/orgs",
      "repos_url": "https://api.github.com/users/AskAlexSharov/repos",
      "events_url": "https://api.github.com/users/AskAlexSharov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AskAlexSharov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-06-12T08:11:54Z",
    "updated_at": "2023-06-12T08:11:54Z",
    "author_association": "COLLABORATOR",
    "body": "hmm... it's already 2nd similar issue (first https://github.com/ledgerwatch/erigon/pull/7686) \r\ni will try to check - maybe we don't call \"commit\" after staged sync cycle. \r\nin-theory we send notification after commit - so all data must be visible for readers. \r\n ",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1586811066/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1586902888",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/7702#issuecomment-1586902888",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/7702",
    "id": 1586902888,
    "node_id": "IC_kwDOC0FsAM5eljdo",
    "user": {
      "login": "AskAlexSharov",
      "id": 46885206,
      "node_id": "MDQ6VXNlcjQ2ODg1MjA2",
      "avatar_url": "https://avatars.githubusercontent.com/u/46885206?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AskAlexSharov",
      "html_url": "https://github.com/AskAlexSharov",
      "followers_url": "https://api.github.com/users/AskAlexSharov/followers",
      "following_url": "https://api.github.com/users/AskAlexSharov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AskAlexSharov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AskAlexSharov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AskAlexSharov/subscriptions",
      "organizations_url": "https://api.github.com/users/AskAlexSharov/orgs",
      "repos_url": "https://api.github.com/users/AskAlexSharov/repos",
      "events_url": "https://api.github.com/users/AskAlexSharov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AskAlexSharov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-06-12T09:04:23Z",
    "updated_at": "2023-06-12T09:04:23Z",
    "author_association": "COLLABORATOR",
    "body": "oookey... seems I understand: Released `v2.45.2`",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1586902888/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1646727034",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/7702#issuecomment-1646727034",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/7702",
    "id": 1646727034,
    "node_id": "IC_kwDOC0FsAM5iJw96",
    "user": {
      "login": "github-actions[bot]",
      "id": 41898282,
      "node_id": "MDM6Qm90NDE4OTgyODI=",
      "avatar_url": "https://avatars.githubusercontent.com/in/15368?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/github-actions%5Bbot%5D",
      "html_url": "https://github.com/apps/github-actions",
      "followers_url": "https://api.github.com/users/github-actions%5Bbot%5D/followers",
      "following_url": "https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}",
      "gists_url": "https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/github-actions%5Bbot%5D/subscriptions",
      "organizations_url": "https://api.github.com/users/github-actions%5Bbot%5D/orgs",
      "repos_url": "https://api.github.com/users/github-actions%5Bbot%5D/repos",
      "events_url": "https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}",
      "received_events_url": "https://api.github.com/users/github-actions%5Bbot%5D/received_events",
      "type": "Bot",
      "site_admin": false
    },
    "created_at": "2023-07-23T02:28:37Z",
    "updated_at": "2023-07-23T02:28:37Z",
    "author_association": "NONE",
    "body": "This issue is stale because it has been open for 40 days with no activity. Remove stale label or comment, or this will be closed in 7 days.",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1646727034/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1657399709",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/7702#issuecomment-1657399709",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/7702",
    "id": 1657399709,
    "node_id": "IC_kwDOC0FsAM5iyemd",
    "user": {
      "login": "github-actions[bot]",
      "id": 41898282,
      "node_id": "MDM6Qm90NDE4OTgyODI=",
      "avatar_url": "https://avatars.githubusercontent.com/in/15368?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/github-actions%5Bbot%5D",
      "html_url": "https://github.com/apps/github-actions",
      "followers_url": "https://api.github.com/users/github-actions%5Bbot%5D/followers",
      "following_url": "https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}",
      "gists_url": "https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/github-actions%5Bbot%5D/subscriptions",
      "organizations_url": "https://api.github.com/users/github-actions%5Bbot%5D/orgs",
      "repos_url": "https://api.github.com/users/github-actions%5Bbot%5D/repos",
      "events_url": "https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}",
      "received_events_url": "https://api.github.com/users/github-actions%5Bbot%5D/received_events",
      "type": "Bot",
      "site_admin": false
    },
    "created_at": "2023-07-31T02:21:31Z",
    "updated_at": "2023-07-31T02:21:31Z",
    "author_association": "NONE",
    "body": "This issue was closed because it has been stalled for 7 days with no activity.",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1657399709/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
