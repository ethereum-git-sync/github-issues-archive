{
  "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/353",
  "repository_url": "https://api.github.com/repos/ledgerwatch/erigon",
  "labels_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/353/labels{/name}",
  "comments_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/353/comments",
  "events_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/353/events",
  "html_url": "https://github.com/ledgerwatch/erigon/issues/353",
  "id": 559898547,
  "node_id": "MDU6SXNzdWU1NTk4OTg1NDc=",
  "number": 353,
  "title": "Wrong incarnation for reInited contracts",
  "user": {
    "login": "AlexeyAkhunov",
    "id": 13686139,
    "node_id": "MDQ6VXNlcjEzNjg2MTM5",
    "avatar_url": "https://avatars.githubusercontent.com/u/13686139?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/AlexeyAkhunov",
    "html_url": "https://github.com/AlexeyAkhunov",
    "followers_url": "https://api.github.com/users/AlexeyAkhunov/followers",
    "following_url": "https://api.github.com/users/AlexeyAkhunov/following{/other_user}",
    "gists_url": "https://api.github.com/users/AlexeyAkhunov/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/AlexeyAkhunov/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/AlexeyAkhunov/subscriptions",
    "organizations_url": "https://api.github.com/users/AlexeyAkhunov/orgs",
    "repos_url": "https://api.github.com/users/AlexeyAkhunov/repos",
    "events_url": "https://api.github.com/users/AlexeyAkhunov/events{/privacy}",
    "received_events_url": "https://api.github.com/users/AlexeyAkhunov/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2020-02-04T18:25:16Z",
  "updated_at": "2020-03-25T20:16:03Z",
  "closed_at": "2020-03-25T20:16:03Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "These are the addresses of 4 contracts that have been re-created after self-destruction:\r\n````\r\n6ffedc1562918c07ae49b0ba210e6d80c7d61eab\r\nb7a14d8f78b877062ce684ecaadc9832adc6c90e\r\n40676789529691dc62d1aba78bf81be2b4e75351\r\n2730a0912eb9ee010d9b086a4eddbcc54fd4cc83\r\n````\r\nthey all have incarnation 1, though they should have incarnation 2\r\n\r\nMost probably cause is that function `nextIncarnation` in the `core/state/database.go` calculates the incarnation using `Walk` operation on the database, which does not take into account storage items that are in the current batch (mutation), but have not been committed yet. Therefore, if the contract creation, filling up the storage, self-destruction, and re-creation all happen without the same batch, the problem will occur. This can be confirmed from the logs",
  "closed_by": {
    "login": "AlexeyAkhunov",
    "id": 13686139,
    "node_id": "MDQ6VXNlcjEzNjg2MTM5",
    "avatar_url": "https://avatars.githubusercontent.com/u/13686139?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/AlexeyAkhunov",
    "html_url": "https://github.com/AlexeyAkhunov",
    "followers_url": "https://api.github.com/users/AlexeyAkhunov/followers",
    "following_url": "https://api.github.com/users/AlexeyAkhunov/following{/other_user}",
    "gists_url": "https://api.github.com/users/AlexeyAkhunov/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/AlexeyAkhunov/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/AlexeyAkhunov/subscriptions",
    "organizations_url": "https://api.github.com/users/AlexeyAkhunov/orgs",
    "repos_url": "https://api.github.com/users/AlexeyAkhunov/repos",
    "events_url": "https://api.github.com/users/AlexeyAkhunov/events{/privacy}",
    "received_events_url": "https://api.github.com/users/AlexeyAkhunov/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/353/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/353/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/582052368",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/353#issuecomment-582052368",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/353",
    "id": 582052368,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU4MjA1MjM2OA==",
    "user": {
      "login": "AlexeyAkhunov",
      "id": 13686139,
      "node_id": "MDQ6VXNlcjEzNjg2MTM5",
      "avatar_url": "https://avatars.githubusercontent.com/u/13686139?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AlexeyAkhunov",
      "html_url": "https://github.com/AlexeyAkhunov",
      "followers_url": "https://api.github.com/users/AlexeyAkhunov/followers",
      "following_url": "https://api.github.com/users/AlexeyAkhunov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AlexeyAkhunov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AlexeyAkhunov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AlexeyAkhunov/subscriptions",
      "organizations_url": "https://api.github.com/users/AlexeyAkhunov/orgs",
      "repos_url": "https://api.github.com/users/AlexeyAkhunov/repos",
      "events_url": "https://api.github.com/users/AlexeyAkhunov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AlexeyAkhunov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-02-04T18:35:11Z",
    "updated_at": "2020-02-04T18:35:11Z",
    "author_association": "CONTRIBUTOR",
    "body": "So, for the contract `6ffedc1562918c07ae49b0ba210e6d80c7d61eab`, the creation happened in the block 9235322, self-destruction in the block 9235353, and re-creation in the block 9235355. According to the logs, it all happened in the same batch:\r\n````\r\nINFO [01-24|12:28:24.493] Imported new chain segment               blocks=63   txs=5236  mgas=433.783  elapsed=8.239s    mgasps=52.646  number=9235296 hash=97d0cc…ce7b0\r\nc batch=76847  age=2w2d17h\r\nINFO [01-24|12:28:50.281] Memory                                   nodes=4999992 alloc=12316618 sys=28107115 numGC=54405\r\nINFO [01-24|12:28:50.281] Database                                 size=687156740096 written=632676353\r\nINFO [01-24|12:28:50.330] Imported new chain segment               blocks=1    txs=67    mgas=3.689    elapsed=20.555s   mgasps=0.179   number=9235343 hash=1c2abb…d3f06\r\ne batch=278    age=2w2d17h\r\nINFO [01-24|12:28:58.513] Imported new chain segment               blocks=69   txs=5261  mgas=446.669  elapsed=8.183s    mgasps=54.581  number=9235412 hash=22d933…71b71\r\n0 batch=42589  age=2w2d16h\r\nINFO [01-24|12:29:06.694] Imported new chain segment               blocks=62   txs=4955  mgas=441.938  elapsed=8.180s    mgasps=54.025  number=9235474 hash=939bd5…8bd71\r\n1 batch=81849  age=2w2d16h\r\nINFO [01-24|12:29:31.411] Memory                                   nodes=4999911 alloc=12416219 sys=28107115 numGC=54406\r\nINFO [01-24|12:29:31.411] Database                                 size=687182008320 written=638238721\r\n````\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/582052368/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/582054631",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/353#issuecomment-582054631",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/353",
    "id": 582054631,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU4MjA1NDYzMQ==",
    "user": {
      "login": "AlexeyAkhunov",
      "id": 13686139,
      "node_id": "MDQ6VXNlcjEzNjg2MTM5",
      "avatar_url": "https://avatars.githubusercontent.com/u/13686139?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AlexeyAkhunov",
      "html_url": "https://github.com/AlexeyAkhunov",
      "followers_url": "https://api.github.com/users/AlexeyAkhunov/followers",
      "following_url": "https://api.github.com/users/AlexeyAkhunov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AlexeyAkhunov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AlexeyAkhunov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AlexeyAkhunov/subscriptions",
      "organizations_url": "https://api.github.com/users/AlexeyAkhunov/orgs",
      "repos_url": "https://api.github.com/users/AlexeyAkhunov/repos",
      "events_url": "https://api.github.com/users/AlexeyAkhunov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AlexeyAkhunov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-02-04T18:40:24Z",
    "updated_at": "2020-02-05T08:11:51Z",
    "author_association": "CONTRIBUTOR",
    "body": "For contract `b7a14d8f78b877062ce684ecaadc9832adc6c90e`, the respective blocks are 9235871, 9235953, and 9235958.\r\n````\r\nINFO [01-24|12:30:35.213] Imported new chain segment               blocks=69   txs=4327  mgas=361.388  elapsed=8.165s    mgasps=44.257  number=9235905 hash=f87ad7…58a93\r\n8 batch=90452  age=2w2d15h\r\nINFO [01-24|12:31:00.492] Memory                                   nodes=4999916 alloc=12153181 sys=28107115 numGC=54409\r\nINFO [01-24|12:31:00.492] Database                                 size=687216054272 written=633769985\r\nINFO [01-24|12:31:00.690] Imported new chain segment               blocks=1    txs=105   mgas=8.315    elapsed=22.288s   mgasps=0.373   number=9235927 hash=e72583…678f1\r\n3 batch=1121   age=2w2d15h\r\nINFO [01-24|12:31:08.692] Imported new chain segment               blocks=67   txs=4122  mgas=417.696  elapsed=8.002s    mgasps=52.194  number=9235994 hash=ca4444…cef95\r\n2 batch=41527  age=2w2d14h\r\nINFO [01-24|12:31:16.735] Imported new chain segment               blocks=68   txs=4212  mgas=405.509  elapsed=8.043s    mgasps=50.417  number=9236062 hash=96a594…a228a\r\n3 batch=81340  age=2w2d14h\r\nINFO [01-24|12:31:37.990] Memory                                   nodes=4999923 alloc=12130371 sys=28107115 numGC=54410\r\nINFO [01-24|12:31:37.990] Database                                 size=687216054272 written=588525569\r\n````\r\n\r\nSo, it was created in the 1st batch, and got self-destructed and re-created in the second batch. And the incarnation of this account is 1.",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/582054631/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/582537537",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/353#issuecomment-582537537",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/353",
    "id": 582537537,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU4MjUzNzUzNw==",
    "user": {
      "login": "AlexeyAkhunov",
      "id": 13686139,
      "node_id": "MDQ6VXNlcjEzNjg2MTM5",
      "avatar_url": "https://avatars.githubusercontent.com/u/13686139?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AlexeyAkhunov",
      "html_url": "https://github.com/AlexeyAkhunov",
      "followers_url": "https://api.github.com/users/AlexeyAkhunov/followers",
      "following_url": "https://api.github.com/users/AlexeyAkhunov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AlexeyAkhunov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AlexeyAkhunov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AlexeyAkhunov/subscriptions",
      "organizations_url": "https://api.github.com/users/AlexeyAkhunov/orgs",
      "repos_url": "https://api.github.com/users/AlexeyAkhunov/repos",
      "events_url": "https://api.github.com/users/AlexeyAkhunov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AlexeyAkhunov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-02-05T18:07:56Z",
    "updated_at": "2020-02-05T18:07:56Z",
    "author_association": "CONTRIBUTOR",
    "body": "For contract `40676789529691dc62d1aba78bf81be2b4e75351`, the respective block numbers are 9248689, 9248793, 9248795\r\n\r\n````\r\nINFO [01-24|13:26:54.403] Imported new chain segment               blocks=14   txs=671   mgas=84.359   elapsed=1.469s    mgasps=57.426  number=9248650 hash=5c1a31…03d7f\r\nc batch=8401   age=2w17h5m\r\nINFO [01-24|13:27:02.020] Memory                                   nodes=4999977 alloc=14476241 sys=28107115 numGC=54518\r\nINFO [01-24|13:27:02.020] Database                                 size=688789942272 written=69029889\r\nINFO [01-24|13:27:02.110] Inserting chain                          start=9248651 end=9250431\r\nINFO [01-24|13:27:10.229] Imported new chain segment               blocks=23   txs=1582  mgas=148.056  elapsed=8.118s    mgasps=18.237  number=9248673 hash=fcc354…d948f\r\ne batch=15942  age=2w16h58m\r\nINFO [01-24|13:27:18.241] Imported new chain segment               blocks=67   txs=3888  mgas=437.593  elapsed=8.011s    mgasps=54.618  number=9248740 hash=f28220…50d94\r\n4 batch=55840  age=2w16h42m\r\nINFO [01-24|13:27:26.476] Imported new chain segment               blocks=46   txs=2570  mgas=283.345  elapsed=8.234s    mgasps=34.407  number=9248786 hash=473ee6…d06e3\r\n4 batch=81540  age=2w16h33m\r\nINFO [01-24|13:27:47.539] Memory                                   nodes=4999902 alloc=12574378 sys=28107115 numGC=54520\r\nINFO [01-24|13:27:47.539] Database                                 size=688815734784 written=543641601\r\n````\r\nall of that happened in the same batch",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/582537537/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/582539089",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/353#issuecomment-582539089",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/353",
    "id": 582539089,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU4MjUzOTA4OQ==",
    "user": {
      "login": "AlexeyAkhunov",
      "id": 13686139,
      "node_id": "MDQ6VXNlcjEzNjg2MTM5",
      "avatar_url": "https://avatars.githubusercontent.com/u/13686139?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AlexeyAkhunov",
      "html_url": "https://github.com/AlexeyAkhunov",
      "followers_url": "https://api.github.com/users/AlexeyAkhunov/followers",
      "following_url": "https://api.github.com/users/AlexeyAkhunov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AlexeyAkhunov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AlexeyAkhunov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AlexeyAkhunov/subscriptions",
      "organizations_url": "https://api.github.com/users/AlexeyAkhunov/orgs",
      "repos_url": "https://api.github.com/users/AlexeyAkhunov/repos",
      "events_url": "https://api.github.com/users/AlexeyAkhunov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AlexeyAkhunov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-02-05T18:11:21Z",
    "updated_at": "2020-02-05T18:11:21Z",
    "author_association": "CONTRIBUTOR",
    "body": "For contract `2730a0912eb9ee010d9b086a4eddbcc54fd4cc83`, the block numbers are 9241129, 9241221, 9241245\r\n\r\n````\r\nNFO [01-24|12:55:04.844] Imported new chain segment               blocks=46   txs=4641  mgas=404.010  elapsed=8.110s    mgasps=49.813  number=9241050 hash=174f54…54100\r\nb batch=77564  age=2w1d20h\r\nINFO [01-24|12:55:27.823] Memory                                   nodes=4999978 alloc=12041329 sys=28107115 numGC=54457\r\nINFO [01-24|12:55:27.823] Database                                 size=687935356928 written=609013761\r\nINFO [01-24|12:55:28.003] Imported new chain segment               blocks=1    txs=162   mgas=9.964    elapsed=19.019s   mgasps=0.524   number=9241079 hash=22afa9…c6d32\r\n8 batch=1411   age=2w1d20h\r\nINFO [01-24|12:55:36.004] Imported new chain segment               blocks=50   txs=6336  mgas=450.433  elapsed=8.000s    mgasps=56.300  number=9241129 hash=fe8b8a…c5ab9\r\n7 batch=49830  age=2w1d20h\r\nINFO [01-24|12:55:44.013] Imported new chain segment               blocks=56   txs=6059  mgas=480.456  elapsed=8.008s    mgasps=59.991  number=9241185 hash=199fa3…74047\r\nd batch=92703  age=2w1d19h\r\nINFO [01-24|12:56:02.916] Memory                                   nodes=4999998 alloc=12157633 sys=28107115 numGC=54458\r\nINFO [01-24|12:56:02.916] Database                                 size=687956709376 written=605667329\r\nINFO [01-24|12:56:03.027] Imported new chain segment               blocks=1    txs=70    mgas=9.993    elapsed=17.527s   mgasps=0.570   number=9241198 hash=1ab569…8becb\r\n4 batch=767    age=2w1d19h\r\nINFO [01-24|12:56:11.063] Imported new chain segment               blocks=57   txs=4466  mgas=497.938  elapsed=8.035s    mgasps=61.965  number=9241255 hash=4d21e5…a1fa3\r\n7 batch=48267  age=2w1d19h\r\nINFO [01-24|12:56:12.644] Imported new chain segment               blocks=17   txs=1080  mgas=123.333  elapsed=1.581s    mgasps=77.997  number=9241272 hash=cb2fba…4c1fc\r\nb batch=59723  age=2w1d19h\r\nINFO [01-24|12:56:19.218] Memory                                   nodes=4999904 alloc=13890808 sys=28107115 numGC=54458\r\nINFO [01-24|12:56:19.218] Database                                 size=687956709376 written=318083073\r\n````\r\nit was created in the 1st batch, and self-destructed and re-created in the second batch",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/582539089/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
