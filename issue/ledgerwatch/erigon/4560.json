{
  "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/4560",
  "repository_url": "https://api.github.com/repos/ledgerwatch/erigon",
  "labels_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/4560/labels{/name}",
  "comments_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/4560/comments",
  "events_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/4560/events",
  "html_url": "https://github.com/ledgerwatch/erigon/issues/4560",
  "id": 1287046656,
  "node_id": "I_kwDOC0FsAM5MtsYA",
  "number": 4560,
  "title": "Improved health check / health check for syncing",
  "user": {
    "login": "gfxlabs",
    "id": 86091021,
    "node_id": "MDQ6VXNlcjg2MDkxMDIx",
    "avatar_url": "https://avatars.githubusercontent.com/u/86091021?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/gfxlabs",
    "html_url": "https://github.com/gfxlabs",
    "followers_url": "https://api.github.com/users/gfxlabs/followers",
    "following_url": "https://api.github.com/users/gfxlabs/following{/other_user}",
    "gists_url": "https://api.github.com/users/gfxlabs/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/gfxlabs/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/gfxlabs/subscriptions",
    "organizations_url": "https://api.github.com/users/gfxlabs/orgs",
    "repos_url": "https://api.github.com/users/gfxlabs/repos",
    "events_url": "https://api.github.com/users/gfxlabs/events{/privacy}",
    "received_events_url": "https://api.github.com/users/gfxlabs/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1378917660,
      "node_id": "MDU6TGFiZWwxMzc4OTE3NjYw",
      "url": "https://api.github.com/repos/ledgerwatch/erigon/labels/good%20first%20issue",
      "name": "good first issue",
      "color": "7057ff",
      "default": true,
      "description": "Good for newcomers"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 8,
  "created_at": "2022-06-28T09:17:52Z",
  "updated_at": "2022-07-06T07:44:39Z",
  "closed_at": "2022-07-06T07:44:39Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "# Rationale\r\n\r\nHi! \r\n\r\nIn order to keep our RPC downtime low, we run multiple nodes and load balance between them.\r\n\r\nHowever, with the current healthcheck, it responds a successful code even if the node is still syncing, and it's hard to configure a \r\n complicated dynamic health check request to use the block number in body for the health check. Not to mention it's a bit annoying sometimes to send a request with data in body. \r\n\r\nWhile it is possible to perform the healthcheck using a shell script, it would be much simpler and safer if was possible to perform this health check using a get request with headers, see traefik and k8s:\r\nhttps://doc.traefik.io/traefik/routing/services/#health-check\r\nhttps://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/#http-probes\r\n \r\n# Implementation\r\n\r\nfor now i just build my own images, and i did this \r\nhttps://github.com/ledgerwatch/erigon/blob/182ea3a118626db7a2af883dda3147d1b73f8e98/cmd/rpcdaemon/health/health.go#L31-L174\r\n\r\nI'm more than happy to implement this, would rather do that than maintain the fork. I know current applications probably depend on the current implementation of the healthcheck, so perhaps making this endpoint /health2 would be better? Anyways, let me know and if it sounds like an okay plan then i can get it done :D \r\n\r\n",
  "closed_by": {
    "login": "mandrigin",
    "id": 466427,
    "node_id": "MDQ6VXNlcjQ2NjQyNw==",
    "avatar_url": "https://avatars.githubusercontent.com/u/466427?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mandrigin",
    "html_url": "https://github.com/mandrigin",
    "followers_url": "https://api.github.com/users/mandrigin/followers",
    "following_url": "https://api.github.com/users/mandrigin/following{/other_user}",
    "gists_url": "https://api.github.com/users/mandrigin/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mandrigin/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mandrigin/subscriptions",
    "organizations_url": "https://api.github.com/users/mandrigin/orgs",
    "repos_url": "https://api.github.com/users/mandrigin/repos",
    "events_url": "https://api.github.com/users/mandrigin/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mandrigin/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/4560/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/4560/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1170364520",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/4560#issuecomment-1170364520",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/4560",
    "id": 1170364520,
    "node_id": "IC_kwDOC0FsAM5Fwlho",
    "user": {
      "login": "tirumerla",
      "id": 57160285,
      "node_id": "MDQ6VXNlcjU3MTYwMjg1",
      "avatar_url": "https://avatars.githubusercontent.com/u/57160285?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tirumerla",
      "html_url": "https://github.com/tirumerla",
      "followers_url": "https://api.github.com/users/tirumerla/followers",
      "following_url": "https://api.github.com/users/tirumerla/following{/other_user}",
      "gists_url": "https://api.github.com/users/tirumerla/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tirumerla/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tirumerla/subscriptions",
      "organizations_url": "https://api.github.com/users/tirumerla/orgs",
      "repos_url": "https://api.github.com/users/tirumerla/repos",
      "events_url": "https://api.github.com/users/tirumerla/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tirumerla/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-06-29T18:46:12Z",
    "updated_at": "2022-06-29T18:46:12Z",
    "author_association": "NONE",
    "body": "@gfxlabs Interesting, i'm in the same boat as you (currently working on an implementation to make sure our nodes sync ). Our nodes are behind an NLB. While health checks are using GET calls, i usually use a POST call to get the latest block number ( to test if the node is syncing properly ). I'm planning on adding a reverse proxy ( like nginx or traefik ) to modify incoming GET request to a POST request to json rpc or adding a flask app route to modify GET request to POST. I'm curious to hear your thoughts. \r\n\r\nBased on what you mention your approach is to pass some headers to the GET request to know if the sync is working?",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1170364520/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1170609406",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/4560#issuecomment-1170609406",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/4560",
    "id": 1170609406,
    "node_id": "IC_kwDOC0FsAM5FxhT-",
    "user": {
      "login": "gfxlabs",
      "id": 86091021,
      "node_id": "MDQ6VXNlcjg2MDkxMDIx",
      "avatar_url": "https://avatars.githubusercontent.com/u/86091021?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gfxlabs",
      "html_url": "https://github.com/gfxlabs",
      "followers_url": "https://api.github.com/users/gfxlabs/followers",
      "following_url": "https://api.github.com/users/gfxlabs/following{/other_user}",
      "gists_url": "https://api.github.com/users/gfxlabs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gfxlabs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gfxlabs/subscriptions",
      "organizations_url": "https://api.github.com/users/gfxlabs/orgs",
      "repos_url": "https://api.github.com/users/gfxlabs/repos",
      "events_url": "https://api.github.com/users/gfxlabs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gfxlabs/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-06-30T00:07:01Z",
    "updated_at": "2022-06-30T01:02:04Z",
    "author_association": "CONTRIBUTOR",
    "body": "@tirumerla yep! here, i actually started writing up what i was thinking with the headers, it's here\r\n\r\nhttps://github.com/ledgerwatch/erigon/blob/182ea3a118626db7a2af883dda3147d1b73f8e98/cmd/rpcdaemon/health/health.go#L31-L174\r\nand yes exactly, i really wanted to avoid putting a proxy in the middle.  so with this, i make a GET request to `/health` with \r\nheaders:\r\n```\r\nX-ERIGON-HEALTHCHECK: synced\r\nX-ERIGON-HEALTHCHECK: min_peer_count10\r\nX-ERIGON-HEALTHCHECK: check_block15039100\r\n```\r\nso this will make sure that the node thinks its synced, that it has more than 10 peers, and the current block is above 15039100\r\n\r\ni'm added also `X-ERIGON-HEALTHCHECK: max_seconds_behind600`, to check if the latest block received is within 600 seconds of current time, for instance. of course you can set the number to whatever.\r\n\r\nif you want to try it, i pushed a docker container up at gfxlabs/erigon:latest (but no promises, it's running on devel)\r\n\r\n\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1170609406/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1171340667",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/4560#issuecomment-1171340667",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/4560",
    "id": 1171340667,
    "node_id": "IC_kwDOC0FsAM5F0T17",
    "user": {
      "login": "mandrigin",
      "id": 466427,
      "node_id": "MDQ6VXNlcjQ2NjQyNw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/466427?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mandrigin",
      "html_url": "https://github.com/mandrigin",
      "followers_url": "https://api.github.com/users/mandrigin/followers",
      "following_url": "https://api.github.com/users/mandrigin/following{/other_user}",
      "gists_url": "https://api.github.com/users/mandrigin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mandrigin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mandrigin/subscriptions",
      "organizations_url": "https://api.github.com/users/mandrigin/orgs",
      "repos_url": "https://api.github.com/users/mandrigin/repos",
      "events_url": "https://api.github.com/users/mandrigin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mandrigin/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-06-30T15:09:25Z",
    "updated_at": "2022-06-30T15:09:25Z",
    "author_association": "COLLABORATOR",
    "body": "@gfxlabs kudos for the issue! we can try to upstream your changes relatively soon, are you running a fork right now?",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1171340667/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1171622280",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/4560#issuecomment-1171622280",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/4560",
    "id": 1171622280,
    "node_id": "IC_kwDOC0FsAM5F1YmI",
    "user": {
      "login": "elee1766",
      "id": 2260857,
      "node_id": "MDQ6VXNlcjIyNjA4NTc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2260857?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/elee1766",
      "html_url": "https://github.com/elee1766",
      "followers_url": "https://api.github.com/users/elee1766/followers",
      "following_url": "https://api.github.com/users/elee1766/following{/other_user}",
      "gists_url": "https://api.github.com/users/elee1766/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/elee1766/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/elee1766/subscriptions",
      "organizations_url": "https://api.github.com/users/elee1766/orgs",
      "repos_url": "https://api.github.com/users/elee1766/repos",
      "events_url": "https://api.github.com/users/elee1766/events{/privacy}",
      "received_events_url": "https://api.github.com/users/elee1766/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-06-30T20:00:32Z",
    "updated_at": "2022-06-30T20:00:45Z",
    "author_association": "COLLABORATOR",
    "body": "> @gfxlabs kudos for the issue! we can try to upstream your changes relatively soon, are you running a fork right now?\n\nhey, thanks!\n\nyeah, I'm running my fork right now on both of my nodes. ",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1171622280/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1171781358",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/4560#issuecomment-1171781358",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/4560",
    "id": 1171781358,
    "node_id": "IC_kwDOC0FsAM5F1_bu",
    "user": {
      "login": "gfxlabs",
      "id": 86091021,
      "node_id": "MDQ6VXNlcjg2MDkxMDIx",
      "avatar_url": "https://avatars.githubusercontent.com/u/86091021?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gfxlabs",
      "html_url": "https://github.com/gfxlabs",
      "followers_url": "https://api.github.com/users/gfxlabs/followers",
      "following_url": "https://api.github.com/users/gfxlabs/following{/other_user}",
      "gists_url": "https://api.github.com/users/gfxlabs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gfxlabs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gfxlabs/subscriptions",
      "organizations_url": "https://api.github.com/users/gfxlabs/orgs",
      "repos_url": "https://api.github.com/users/gfxlabs/repos",
      "events_url": "https://api.github.com/users/gfxlabs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gfxlabs/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-06-30T23:59:12Z",
    "updated_at": "2022-07-01T00:00:16Z",
    "author_association": "CONTRIBUTOR",
    "body": "oh that was my other account lol, the fork is here https://github.com/gfxlabs/erigon/blob/feat/healthcheck-2/cmd/rpcdaemon/health/health.go#L82\r\n\r\nnot sure if i should have put the same changes in rpcdaemon22 so i didnt. (i assume rpcdaemon22 is the WIP version?)",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1171781358/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1173450056",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/4560#issuecomment-1173450056",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/4560",
    "id": 1173450056,
    "node_id": "IC_kwDOC0FsAM5F8W1I",
    "user": {
      "login": "mandrigin",
      "id": 466427,
      "node_id": "MDQ6VXNlcjQ2NjQyNw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/466427?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mandrigin",
      "html_url": "https://github.com/mandrigin",
      "followers_url": "https://api.github.com/users/mandrigin/followers",
      "following_url": "https://api.github.com/users/mandrigin/following{/other_user}",
      "gists_url": "https://api.github.com/users/mandrigin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mandrigin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mandrigin/subscriptions",
      "organizations_url": "https://api.github.com/users/mandrigin/orgs",
      "repos_url": "https://api.github.com/users/mandrigin/repos",
      "events_url": "https://api.github.com/users/mandrigin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mandrigin/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-04T07:26:16Z",
    "updated_at": "2022-07-04T07:26:16Z",
    "author_association": "COLLABORATOR",
    "body": "nah, it is to normal RPCDaemon, but we will check if we can add this natively",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1173450056/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1175173741",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/4560#issuecomment-1175173741",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/4560",
    "id": 1175173741,
    "node_id": "IC_kwDOC0FsAM5GC7pt",
    "user": {
      "login": "mandrigin",
      "id": 466427,
      "node_id": "MDQ6VXNlcjQ2NjQyNw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/466427?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mandrigin",
      "html_url": "https://github.com/mandrigin",
      "followers_url": "https://api.github.com/users/mandrigin/followers",
      "following_url": "https://api.github.com/users/mandrigin/following{/other_user}",
      "gists_url": "https://api.github.com/users/mandrigin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mandrigin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mandrigin/subscriptions",
      "organizations_url": "https://api.github.com/users/mandrigin/orgs",
      "repos_url": "https://api.github.com/users/mandrigin/repos",
      "events_url": "https://api.github.com/users/mandrigin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mandrigin/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-05T15:09:27Z",
    "updated_at": "2022-07-05T15:09:27Z",
    "author_association": "COLLABORATOR",
    "body": "WIP PR for that: https://github.com/ledgerwatch/erigon/pull/4639",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1175173741/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1175894114",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/4560#issuecomment-1175894114",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/4560",
    "id": 1175894114,
    "node_id": "IC_kwDOC0FsAM5GFrhi",
    "user": {
      "login": "mandrigin",
      "id": 466427,
      "node_id": "MDQ6VXNlcjQ2NjQyNw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/466427?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mandrigin",
      "html_url": "https://github.com/mandrigin",
      "followers_url": "https://api.github.com/users/mandrigin/followers",
      "following_url": "https://api.github.com/users/mandrigin/following{/other_user}",
      "gists_url": "https://api.github.com/users/mandrigin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mandrigin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mandrigin/subscriptions",
      "organizations_url": "https://api.github.com/users/mandrigin/orgs",
      "repos_url": "https://api.github.com/users/mandrigin/repos",
      "events_url": "https://api.github.com/users/mandrigin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mandrigin/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-06T07:44:39Z",
    "updated_at": "2022-07-06T07:44:39Z",
    "author_association": "COLLABORATOR",
    "body": "@gfxlabs we merged the healthcheck improvements and HTTP headers support! It will be available in the next alpha release. If you wanna try now, you can build the latest `devel` branch.\r\n\r\nhttps://github.com/ledgerwatch/erigon/pull/4639",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1175894114/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
