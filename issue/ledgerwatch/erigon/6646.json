{
  "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6646",
  "repository_url": "https://api.github.com/repos/ledgerwatch/erigon",
  "labels_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6646/labels{/name}",
  "comments_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6646/comments",
  "events_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6646/events",
  "html_url": "https://github.com/ledgerwatch/erigon/issues/6646",
  "id": 1551624638,
  "node_id": "I_kwDOC0FsAM5ce-m-",
  "number": 6646,
  "title": "OOM within docker",
  "user": {
    "login": "keithchew",
    "id": 5557929,
    "node_id": "MDQ6VXNlcjU1NTc5Mjk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5557929?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/keithchew",
    "html_url": "https://github.com/keithchew",
    "followers_url": "https://api.github.com/users/keithchew/followers",
    "following_url": "https://api.github.com/users/keithchew/following{/other_user}",
    "gists_url": "https://api.github.com/users/keithchew/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/keithchew/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/keithchew/subscriptions",
    "organizations_url": "https://api.github.com/users/keithchew/orgs",
    "repos_url": "https://api.github.com/users/keithchew/repos",
    "events_url": "https://api.github.com/users/keithchew/events{/privacy}",
    "received_events_url": "https://api.github.com/users/keithchew/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 4566396003,
      "node_id": "LA_kwDOC0FsAM8AAAABEC2sYw",
      "url": "https://api.github.com/repos/ledgerwatch/erigon/labels/Stale",
      "name": "Stale",
      "color": "ededed",
      "default": false,
      "description": null
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 27,
  "created_at": "2023-01-21T00:48:31Z",
  "updated_at": "2023-06-16T02:32:07Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "#### System information\r\n\r\nErigon version: `./erigon --version`\r\nv2.35.2\r\n\r\nOS & Version: Windows/Linux/OSX\r\nUbuntu 20.04 (docker-ce 20.10.22)\r\nOS: 64GB RAM\r\ndocker container max memory: 32GB\r\n\r\n#### Expected behaviour\r\nNot to observe unbounded memory increase.\r\n\r\n#### Actual behaviour\r\nMemory keeps increasing until OOM.\r\n\r\n#### Steps to reproduce the behaviour\r\nrun erigon with:\r\n--pprof --chain=mainnet --batchSize=8mb --torrent.conns.perfile=4 --torrent.download.rate=100mb\r\nGOGC=50\r\nGOMEMLIMIT=6000MiB\r\nGODEBUG=gctrace=1\r\n\r\nAfter catching up with latest block, memory is stable at 12GB. gc trace confirms erigon itself only uses 2.9GB.\r\n\r\ngc 321 @7184.801s 0%: 0.53+151+0.020 ms clock, 12+26/908/1809+0.48 ms cpu, 4029->4110->2946 MB, 4472 MB goal, 43 MB stacks, 2 MB globals, 24 P\r\n\r\nRest of RAM is assumed to be used by OS page cache.\r\n\r\nWhile erigon is running, memory consumption grows steadily, until OOM kicks in at 32GB and kills the erigon process. \r\n\r\nTaking a wild guess, could this be caused by libmdbx thinking there is 64GB memory (OS RAM), but in actual fact the docker container is limited at 32GB? Since we can limit GO with the GOMEMLIMIT flag, is there something we can pass to libmdbx to specify the max memory to use?\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6646/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6646/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1399148511",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/6646#issuecomment-1399148511",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6646",
    "id": 1399148511,
    "node_id": "IC_kwDOC0FsAM5TZU_f",
    "user": {
      "login": "AskAlexSharov",
      "id": 46885206,
      "node_id": "MDQ6VXNlcjQ2ODg1MjA2",
      "avatar_url": "https://avatars.githubusercontent.com/u/46885206?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AskAlexSharov",
      "html_url": "https://github.com/AskAlexSharov",
      "followers_url": "https://api.github.com/users/AskAlexSharov/followers",
      "following_url": "https://api.github.com/users/AskAlexSharov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AskAlexSharov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AskAlexSharov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AskAlexSharov/subscriptions",
      "organizations_url": "https://api.github.com/users/AskAlexSharov/orgs",
      "repos_url": "https://api.github.com/users/AskAlexSharov/repos",
      "events_url": "https://api.github.com/users/AskAlexSharov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AskAlexSharov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-01-21T02:03:26Z",
    "updated_at": "2023-01-21T02:03:26Z",
    "author_association": "COLLABORATOR",
    "body": "to understand where Erigon wasted RAM can do:\r\nadd flag `--pprof`\r\n`go tool pprof -inuse_space -png http://127.0.0.1:6060/debug/pprof/heap > mem.png`\r\nshow this file",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1399148511/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1399151781",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/6646#issuecomment-1399151781",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6646",
    "id": 1399151781,
    "node_id": "IC_kwDOC0FsAM5TZVyl",
    "user": {
      "login": "keithchew",
      "id": 5557929,
      "node_id": "MDQ6VXNlcjU1NTc5Mjk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5557929?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/keithchew",
      "html_url": "https://github.com/keithchew",
      "followers_url": "https://api.github.com/users/keithchew/followers",
      "following_url": "https://api.github.com/users/keithchew/following{/other_user}",
      "gists_url": "https://api.github.com/users/keithchew/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/keithchew/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/keithchew/subscriptions",
      "organizations_url": "https://api.github.com/users/keithchew/orgs",
      "repos_url": "https://api.github.com/users/keithchew/repos",
      "events_url": "https://api.github.com/users/keithchew/events{/privacy}",
      "received_events_url": "https://api.github.com/users/keithchew/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-01-21T02:17:15Z",
    "updated_at": "2023-01-21T08:08:15Z",
    "author_association": "NONE",
    "body": "Hi Alex\r\n\r\nGO pprof diagram shows Erigon is not wasting RAM, as noted in the GC log above, ie only 2.9GB used. It is the RAM outside of GO that is slowly growing.",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1399151781/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1399154090",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/6646#issuecomment-1399154090",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6646",
    "id": 1399154090,
    "node_id": "IC_kwDOC0FsAM5TZWWq",
    "user": {
      "login": "AskAlexSharov",
      "id": 46885206,
      "node_id": "MDQ6VXNlcjQ2ODg1MjA2",
      "avatar_url": "https://avatars.githubusercontent.com/u/46885206?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AskAlexSharov",
      "html_url": "https://github.com/AskAlexSharov",
      "followers_url": "https://api.github.com/users/AskAlexSharov/followers",
      "following_url": "https://api.github.com/users/AskAlexSharov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AskAlexSharov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AskAlexSharov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AskAlexSharov/subscriptions",
      "organizations_url": "https://api.github.com/users/AskAlexSharov/orgs",
      "repos_url": "https://api.github.com/users/AskAlexSharov/repos",
      "events_url": "https://api.github.com/users/AskAlexSharov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AskAlexSharov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-01-21T02:27:27Z",
    "updated_at": "2023-01-21T02:27:27Z",
    "author_association": "COLLABORATOR",
    "body": "OOM can’t kill Erigon for external memory, because that memory owned by OS (even can survive Erigon’s reboot). See https://github.com/ledgerwatch/erigon#htop-shows-incorrect-memory-usage",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1399154090/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1399162559",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/6646#issuecomment-1399162559",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6646",
    "id": 1399162559,
    "node_id": "IC_kwDOC0FsAM5TZYa_",
    "user": {
      "login": "AskAlexSharov",
      "id": 46885206,
      "node_id": "MDQ6VXNlcjQ2ODg1MjA2",
      "avatar_url": "https://avatars.githubusercontent.com/u/46885206?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AskAlexSharov",
      "html_url": "https://github.com/AskAlexSharov",
      "followers_url": "https://api.github.com/users/AskAlexSharov/followers",
      "following_url": "https://api.github.com/users/AskAlexSharov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AskAlexSharov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AskAlexSharov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AskAlexSharov/subscriptions",
      "organizations_url": "https://api.github.com/users/AskAlexSharov/orgs",
      "repos_url": "https://api.github.com/users/AskAlexSharov/repos",
      "events_url": "https://api.github.com/users/AskAlexSharov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AskAlexSharov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-01-21T03:11:24Z",
    "updated_at": "2023-01-21T03:11:24Z",
    "author_association": "COLLABORATOR",
    "body": "@keithchew do you have much total RAM on machine? I guess Erigon does some estimations on TotalRam but not on GOMEMLIMIT",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1399162559/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1399164763",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/6646#issuecomment-1399164763",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6646",
    "id": 1399164763,
    "node_id": "IC_kwDOC0FsAM5TZY9b",
    "user": {
      "login": "AskAlexSharov",
      "id": 46885206,
      "node_id": "MDQ6VXNlcjQ2ODg1MjA2",
      "avatar_url": "https://avatars.githubusercontent.com/u/46885206?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AskAlexSharov",
      "html_url": "https://github.com/AskAlexSharov",
      "followers_url": "https://api.github.com/users/AskAlexSharov/followers",
      "following_url": "https://api.github.com/users/AskAlexSharov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AskAlexSharov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AskAlexSharov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AskAlexSharov/subscriptions",
      "organizations_url": "https://api.github.com/users/AskAlexSharov/orgs",
      "repos_url": "https://api.github.com/users/AskAlexSharov/repos",
      "events_url": "https://api.github.com/users/AskAlexSharov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AskAlexSharov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-01-21T03:24:25Z",
    "updated_at": "2023-01-21T03:24:25Z",
    "author_association": "COLLABORATOR",
    "body": "if yes, try slightly reduce GOMAXPROC",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1399164763/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1399167140",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/6646#issuecomment-1399167140",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6646",
    "id": 1399167140,
    "node_id": "IC_kwDOC0FsAM5TZZik",
    "user": {
      "login": "keithchew",
      "id": 5557929,
      "node_id": "MDQ6VXNlcjU1NTc5Mjk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5557929?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/keithchew",
      "html_url": "https://github.com/keithchew",
      "followers_url": "https://api.github.com/users/keithchew/followers",
      "following_url": "https://api.github.com/users/keithchew/following{/other_user}",
      "gists_url": "https://api.github.com/users/keithchew/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/keithchew/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/keithchew/subscriptions",
      "organizations_url": "https://api.github.com/users/keithchew/orgs",
      "repos_url": "https://api.github.com/users/keithchew/repos",
      "events_url": "https://api.github.com/users/keithchew/events{/privacy}",
      "received_events_url": "https://api.github.com/users/keithchew/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-01-21T03:39:41Z",
    "updated_at": "2023-01-21T08:09:03Z",
    "author_association": "NONE",
    "body": "Hi Alex\r\n\r\nTotal RAM on machine is 64GB. \r\n\r\nOOM is killing erigon because the memory reported by docker stats (and confirmed using cgroups) reached 32GB, even though GO is reporting only 2.9GB is used.  So, my assumption was there is another 29.1GB used by the docker container but not reported in GO's pprof/gc trace, is this even possible?\r\n\r\nOK, will have a play with GOMAXPROC and keep us posted.\r\n\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1399167140/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1399187008",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/6646#issuecomment-1399187008",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6646",
    "id": 1399187008,
    "node_id": "IC_kwDOC0FsAM5TZeZA",
    "user": {
      "login": "zqt996",
      "id": 67185303,
      "node_id": "MDQ6VXNlcjY3MTg1MzAz",
      "avatar_url": "https://avatars.githubusercontent.com/u/67185303?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/zqt996",
      "html_url": "https://github.com/zqt996",
      "followers_url": "https://api.github.com/users/zqt996/followers",
      "following_url": "https://api.github.com/users/zqt996/following{/other_user}",
      "gists_url": "https://api.github.com/users/zqt996/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/zqt996/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/zqt996/subscriptions",
      "organizations_url": "https://api.github.com/users/zqt996/orgs",
      "repos_url": "https://api.github.com/users/zqt996/repos",
      "events_url": "https://api.github.com/users/zqt996/events{/privacy}",
      "received_events_url": "https://api.github.com/users/zqt996/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-01-21T05:53:38Z",
    "updated_at": "2023-01-21T06:01:13Z",
    "author_association": "NONE",
    "body": "Use docker to limit memory limit and turn off oom kill",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1399187008/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1399196381",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/6646#issuecomment-1399196381",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6646",
    "id": 1399196381,
    "node_id": "IC_kwDOC0FsAM5TZgrd",
    "user": {
      "login": "keithchew",
      "id": 5557929,
      "node_id": "MDQ6VXNlcjU1NTc5Mjk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5557929?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/keithchew",
      "html_url": "https://github.com/keithchew",
      "followers_url": "https://api.github.com/users/keithchew/followers",
      "following_url": "https://api.github.com/users/keithchew/following{/other_user}",
      "gists_url": "https://api.github.com/users/keithchew/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/keithchew/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/keithchew/subscriptions",
      "organizations_url": "https://api.github.com/users/keithchew/orgs",
      "repos_url": "https://api.github.com/users/keithchew/repos",
      "events_url": "https://api.github.com/users/keithchew/events{/privacy}",
      "received_events_url": "https://api.github.com/users/keithchew/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-01-21T07:08:46Z",
    "updated_at": "2023-01-21T08:04:25Z",
    "author_association": "NONE",
    "body": "As per the description above, memory is already limited in the docker container to 32GB, and it is not a good idea to disable OOM reaper, otherwise it can trigger bigger issues when memory is exhausted.",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1399196381/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1399203771",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/6646#issuecomment-1399203771",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6646",
    "id": 1399203771,
    "node_id": "IC_kwDOC0FsAM5TZie7",
    "user": {
      "login": "emgeee",
      "id": 1541411,
      "node_id": "MDQ6VXNlcjE1NDE0MTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1541411?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/emgeee",
      "html_url": "https://github.com/emgeee",
      "followers_url": "https://api.github.com/users/emgeee/followers",
      "following_url": "https://api.github.com/users/emgeee/following{/other_user}",
      "gists_url": "https://api.github.com/users/emgeee/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/emgeee/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/emgeee/subscriptions",
      "organizations_url": "https://api.github.com/users/emgeee/orgs",
      "repos_url": "https://api.github.com/users/emgeee/repos",
      "events_url": "https://api.github.com/users/emgeee/events{/privacy}",
      "received_events_url": "https://api.github.com/users/emgeee/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-01-21T08:03:05Z",
    "updated_at": "2023-01-21T08:03:05Z",
    "author_association": "NONE",
    "body": "just to chime in here -- I'm seeing something similar with Kubernetes on both versions 2.35 and 2.36",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1399203771/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1399399908",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/6646#issuecomment-1399399908",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6646",
    "id": 1399399908,
    "node_id": "IC_kwDOC0FsAM5TaSXk",
    "user": {
      "login": "keithchew",
      "id": 5557929,
      "node_id": "MDQ6VXNlcjU1NTc5Mjk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5557929?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/keithchew",
      "html_url": "https://github.com/keithchew",
      "followers_url": "https://api.github.com/users/keithchew/followers",
      "following_url": "https://api.github.com/users/keithchew/following{/other_user}",
      "gists_url": "https://api.github.com/users/keithchew/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/keithchew/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/keithchew/subscriptions",
      "organizations_url": "https://api.github.com/users/keithchew/orgs",
      "repos_url": "https://api.github.com/users/keithchew/repos",
      "events_url": "https://api.github.com/users/keithchew/events{/privacy}",
      "received_events_url": "https://api.github.com/users/keithchew/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-01-22T04:12:19Z",
    "updated_at": "2023-01-22T04:12:55Z",
    "author_association": "NONE",
    "body": "Hi Alex\r\n\r\nI have limited docker container to 20GB instead of 32GB (to see if it will trigger an OOM faster) and have set GOMAXPROC=4 instead of default 24 (on the machine).\r\n\r\nI can observe a slowdown, since erigon only has 4 CPUs for parallelism. But RAM is stable at 16GB! Thank you very much for the recommendation, will be able to tweak GOMAXPROC (and other params) to match load and available RAM.\r\n\r\nWill keep monitoring and post here if there are further issues.",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1399399908/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1399401179",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/6646#issuecomment-1399401179",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6646",
    "id": 1399401179,
    "node_id": "IC_kwDOC0FsAM5TaSrb",
    "user": {
      "login": "AskAlexSharov",
      "id": 46885206,
      "node_id": "MDQ6VXNlcjQ2ODg1MjA2",
      "avatar_url": "https://avatars.githubusercontent.com/u/46885206?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AskAlexSharov",
      "html_url": "https://github.com/AskAlexSharov",
      "followers_url": "https://api.github.com/users/AskAlexSharov/followers",
      "following_url": "https://api.github.com/users/AskAlexSharov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AskAlexSharov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AskAlexSharov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AskAlexSharov/subscriptions",
      "organizations_url": "https://api.github.com/users/AskAlexSharov/orgs",
      "repos_url": "https://api.github.com/users/AskAlexSharov/repos",
      "events_url": "https://api.github.com/users/AskAlexSharov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AskAlexSharov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-01-22T04:21:11Z",
    "updated_at": "2023-01-22T04:21:11Z",
    "author_association": "COLLABORATOR",
    "body": "Estimation logic is here: https://github.com/ledgerwatch/erigon/blob/0eebd61ab8cee7eb7590076975700cdc54b68c43/eth/ethconfig/estimate/esitmated_ram.go#L14\r\n\r\nmaybe you can advise us something",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1399401179/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1399403209",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/6646#issuecomment-1399403209",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6646",
    "id": 1399403209,
    "node_id": "IC_kwDOC0FsAM5TaTLJ",
    "user": {
      "login": "keithchew",
      "id": 5557929,
      "node_id": "MDQ6VXNlcjU1NTc5Mjk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5557929?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/keithchew",
      "html_url": "https://github.com/keithchew",
      "followers_url": "https://api.github.com/users/keithchew/followers",
      "following_url": "https://api.github.com/users/keithchew/following{/other_user}",
      "gists_url": "https://api.github.com/users/keithchew/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/keithchew/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/keithchew/subscriptions",
      "organizations_url": "https://api.github.com/users/keithchew/orgs",
      "repos_url": "https://api.github.com/users/keithchew/repos",
      "events_url": "https://api.github.com/users/keithchew/events{/privacy}",
      "received_events_url": "https://api.github.com/users/keithchew/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-01-22T04:37:44Z",
    "updated_at": "2023-01-22T04:37:44Z",
    "author_association": "NONE",
    "body": "Hi Alex\r\n\r\nThank you very much for the reference to that code. \r\n\r\nAh ha, memory.TotalMemory() will return the physical RAM available, without any visibility to cgroups memory limit within docker.\r\n\r\nThe code in estimated_ram might already be correct, and maybe we could have an optional runtime param (say MAX_MEM) which allows us to pass in the value that replaces memory.TotalMemory(). This should work well for users running erigon in docker containers. The current workaround is to limit it via GOMAXPROC.\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1399403209/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1399405400",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/6646#issuecomment-1399405400",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6646",
    "id": 1399405400,
    "node_id": "IC_kwDOC0FsAM5TaTtY",
    "user": {
      "login": "AskAlexSharov",
      "id": 46885206,
      "node_id": "MDQ6VXNlcjQ2ODg1MjA2",
      "avatar_url": "https://avatars.githubusercontent.com/u/46885206?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AskAlexSharov",
      "html_url": "https://github.com/AskAlexSharov",
      "followers_url": "https://api.github.com/users/AskAlexSharov/followers",
      "following_url": "https://api.github.com/users/AskAlexSharov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AskAlexSharov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AskAlexSharov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AskAlexSharov/subscriptions",
      "organizations_url": "https://api.github.com/users/AskAlexSharov/orgs",
      "repos_url": "https://api.github.com/users/AskAlexSharov/repos",
      "events_url": "https://api.github.com/users/AskAlexSharov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AskAlexSharov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-01-22T05:00:15Z",
    "updated_at": "2023-01-22T05:00:15Z",
    "author_association": "COLLABORATOR",
    "body": "No, it’s out of Erigon project scope. Just some lib must check cgroups limits under the hood: https://stackoverflow.com/a/42188649",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1399405400/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1399405770",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/6646#issuecomment-1399405770",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6646",
    "id": 1399405770,
    "node_id": "IC_kwDOC0FsAM5TaTzK",
    "user": {
      "login": "keithchew",
      "id": 5557929,
      "node_id": "MDQ6VXNlcjU1NTc5Mjk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5557929?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/keithchew",
      "html_url": "https://github.com/keithchew",
      "followers_url": "https://api.github.com/users/keithchew/followers",
      "following_url": "https://api.github.com/users/keithchew/following{/other_user}",
      "gists_url": "https://api.github.com/users/keithchew/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/keithchew/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/keithchew/subscriptions",
      "organizations_url": "https://api.github.com/users/keithchew/orgs",
      "repos_url": "https://api.github.com/users/keithchew/repos",
      "events_url": "https://api.github.com/users/keithchew/events{/privacy}",
      "received_events_url": "https://api.github.com/users/keithchew/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-01-22T05:03:56Z",
    "updated_at": "2023-01-22T05:03:56Z",
    "author_association": "NONE",
    "body": "Yes it would be better if done under the hood. At least we have a workaround in the meantime.",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1399405770/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1399406338",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/6646#issuecomment-1399406338",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6646",
    "id": 1399406338,
    "node_id": "IC_kwDOC0FsAM5TaT8C",
    "user": {
      "login": "AskAlexSharov",
      "id": 46885206,
      "node_id": "MDQ6VXNlcjQ2ODg1MjA2",
      "avatar_url": "https://avatars.githubusercontent.com/u/46885206?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AskAlexSharov",
      "html_url": "https://github.com/AskAlexSharov",
      "followers_url": "https://api.github.com/users/AskAlexSharov/followers",
      "following_url": "https://api.github.com/users/AskAlexSharov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AskAlexSharov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AskAlexSharov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AskAlexSharov/subscriptions",
      "organizations_url": "https://api.github.com/users/AskAlexSharov/orgs",
      "repos_url": "https://api.github.com/users/AskAlexSharov/repos",
      "events_url": "https://api.github.com/users/AskAlexSharov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AskAlexSharov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-01-22T05:09:28Z",
    "updated_at": "2023-01-22T05:09:28Z",
    "author_association": "COLLABORATOR",
    "body": "This one does: https://github.com/shirou/gopsutil/blob/301930f9bdd0d576ebb7940a13c6b9242df4e370/docker/docker_linux.go#L259",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1399406338/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1425157327",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/6646#issuecomment-1425157327",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6646",
    "id": 1425157327,
    "node_id": "IC_kwDOC0FsAM5U8izP",
    "user": {
      "login": "fafrd",
      "id": 5905628,
      "node_id": "MDQ6VXNlcjU5MDU2Mjg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5905628?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fafrd",
      "html_url": "https://github.com/fafrd",
      "followers_url": "https://api.github.com/users/fafrd/followers",
      "following_url": "https://api.github.com/users/fafrd/following{/other_user}",
      "gists_url": "https://api.github.com/users/fafrd/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fafrd/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fafrd/subscriptions",
      "organizations_url": "https://api.github.com/users/fafrd/orgs",
      "repos_url": "https://api.github.com/users/fafrd/repos",
      "events_url": "https://api.github.com/users/fafrd/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fafrd/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-02-10T04:25:47Z",
    "updated_at": "2023-02-10T05:35:18Z",
    "author_association": "CONTRIBUTOR",
    "body": "@AskAlexSharov The library shirou/gopsutil doesn't seem like the right choice. On my test system (debian 11, docker, ubuntu 20.04 guest) the cgroup info does not show up in the expected directory:\r\ncode:\r\n```go\r\n    cgmem, err := docker.CgroupMemDocker(hostname)\r\n    if err != nil {\r\n        fmt.Println(err)\r\n        os.Exit(1)\r\n    }\r\n    fmt.Printf(\"CgroupMemStat: %+v\\n\", cgmem)\r\n```\r\noutput:\r\n```bash\r\n(ins) ~/erigon-testing/erigon $ docker run --memory 256m -it image /bin/bash\r\nroot@71173d45655b:/# /usr/local/bin/erigon\r\nopen /sys/fs/cgroup/memory/system.slice/docker-71173d45655b.scope/memory.stat: no such file or directory\r\n```\r\nThe directory `/sys/fs/cgroup/memory` doesn't even exist, on the host or the guest... \r\n\r\nHowever, I do see the correct memory limit in this file:\r\n```bash\r\nroot@71173d45655b:/# cat /sys/fs/cgroup/memory.max\r\n268435456\r\n```\r\n\r\nTurns out this is the difference between cgroup and cgroup2. ~cgroup2 was introduced in linux 4.5 (in 2016). So, i'm going to try to resolve this by reading the file `/sys/fs/cgroup/memory.max`, using that if it exists, else falling back to `memory.TotalMemory()`.~\r\n\r\nEDIT- actually, it started getting adopted by distros around 2021, so relatively recently: https://github.com/opencontainers/runc/blob/main/docs/cgroup-v2.md\r\n\r\n(I opened up an issue with gopsutil: https://github.com/shirou/gopsutil/issues/1416) \r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1425157327/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1425170718",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/6646#issuecomment-1425170718",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6646",
    "id": 1425170718,
    "node_id": "IC_kwDOC0FsAM5U8mEe",
    "user": {
      "login": "keithchew",
      "id": 5557929,
      "node_id": "MDQ6VXNlcjU1NTc5Mjk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5557929?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/keithchew",
      "html_url": "https://github.com/keithchew",
      "followers_url": "https://api.github.com/users/keithchew/followers",
      "following_url": "https://api.github.com/users/keithchew/following{/other_user}",
      "gists_url": "https://api.github.com/users/keithchew/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/keithchew/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/keithchew/subscriptions",
      "organizations_url": "https://api.github.com/users/keithchew/orgs",
      "repos_url": "https://api.github.com/users/keithchew/repos",
      "events_url": "https://api.github.com/users/keithchew/events{/privacy}",
      "received_events_url": "https://api.github.com/users/keithchew/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-02-10T04:51:43Z",
    "updated_at": "2023-02-10T04:53:14Z",
    "author_association": "NONE",
    "body": "on the server machine i am working on, the mem info (from guest) is in:\r\n/sys/fs/cgroup/memory/memory.max_usage_in_bytes\r\n\r\nand from host:\r\n/sys/fs/cgroup/memory/docker/[container id]/memory.max_usage_in_bytes\r\n\r\nSo, the gopsutil library will work. This machine is Ubuntu 20.04, and although using 5.15 kernel, the default installation is configured to use cgroup1.\r\n\r\nI would recommend adding cgroup2 support into the gopsutil library instead of rolling out your own in Erigon. This will enable the library to return the correct mem usage for both cgroup and cgroup2. \r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1425170718/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1480490139",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/6646#issuecomment-1480490139",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6646",
    "id": 1480490139,
    "node_id": "IC_kwDOC0FsAM5YPnyb",
    "user": {
      "login": "github-actions[bot]",
      "id": 41898282,
      "node_id": "MDM6Qm90NDE4OTgyODI=",
      "avatar_url": "https://avatars.githubusercontent.com/in/15368?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/github-actions%5Bbot%5D",
      "html_url": "https://github.com/apps/github-actions",
      "followers_url": "https://api.github.com/users/github-actions%5Bbot%5D/followers",
      "following_url": "https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}",
      "gists_url": "https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/github-actions%5Bbot%5D/subscriptions",
      "organizations_url": "https://api.github.com/users/github-actions%5Bbot%5D/orgs",
      "repos_url": "https://api.github.com/users/github-actions%5Bbot%5D/repos",
      "events_url": "https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}",
      "received_events_url": "https://api.github.com/users/github-actions%5Bbot%5D/received_events",
      "type": "Bot",
      "site_admin": false
    },
    "created_at": "2023-03-23T02:21:57Z",
    "updated_at": "2023-03-23T02:21:57Z",
    "author_association": "NONE",
    "body": "This issue is stale because it has been open for 40 days with no activity. Remove stale label or comment, or this will be closed in 7 days.",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1480490139/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1484561085",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/6646#issuecomment-1484561085",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6646",
    "id": 1484561085,
    "node_id": "IC_kwDOC0FsAM5YfJq9",
    "user": {
      "login": "tdiesler",
      "id": 244946,
      "node_id": "MDQ6VXNlcjI0NDk0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/244946?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tdiesler",
      "html_url": "https://github.com/tdiesler",
      "followers_url": "https://api.github.com/users/tdiesler/followers",
      "following_url": "https://api.github.com/users/tdiesler/following{/other_user}",
      "gists_url": "https://api.github.com/users/tdiesler/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tdiesler/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tdiesler/subscriptions",
      "organizations_url": "https://api.github.com/users/tdiesler/orgs",
      "repos_url": "https://api.github.com/users/tdiesler/repos",
      "events_url": "https://api.github.com/users/tdiesler/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tdiesler/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-27T06:19:57Z",
    "updated_at": "2023-03-27T06:20:55Z",
    "author_association": "NONE",
    "body": "Is it really necessary for erigon to consume > 32G on initial sync? On a machine with 32G total Ram it crashed on me twice in stage 5/15. I assumed when setting a docker `--memory` limit (e.g. 28G) it would respect that and adjust its memory consumption accordingly.\r\n\r\nAnyway, a hard oom crash seem wrong when running in docker\r\n\r\nPS: v2.40.1",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1484561085/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1484919457",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/6646#issuecomment-1484919457",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6646",
    "id": 1484919457,
    "node_id": "IC_kwDOC0FsAM5YghKh",
    "user": {
      "login": "AskAlexSharov",
      "id": 46885206,
      "node_id": "MDQ6VXNlcjQ2ODg1MjA2",
      "avatar_url": "https://avatars.githubusercontent.com/u/46885206?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AskAlexSharov",
      "html_url": "https://github.com/AskAlexSharov",
      "followers_url": "https://api.github.com/users/AskAlexSharov/followers",
      "following_url": "https://api.github.com/users/AskAlexSharov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AskAlexSharov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AskAlexSharov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AskAlexSharov/subscriptions",
      "organizations_url": "https://api.github.com/users/AskAlexSharov/orgs",
      "repos_url": "https://api.github.com/users/AskAlexSharov/repos",
      "events_url": "https://api.github.com/users/AskAlexSharov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AskAlexSharov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-27T10:46:41Z",
    "updated_at": "2023-03-27T10:46:41Z",
    "author_association": "COLLABORATOR",
    "body": "@tdiesler workaround it by reduce GOMAXPROCS",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1484919457/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1536089252",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/6646#issuecomment-1536089252",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6646",
    "id": 1536089252,
    "node_id": "IC_kwDOC0FsAM5bjtyk",
    "user": {
      "login": "AskAlexSharov",
      "id": 46885206,
      "node_id": "MDQ6VXNlcjQ2ODg1MjA2",
      "avatar_url": "https://avatars.githubusercontent.com/u/46885206?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AskAlexSharov",
      "html_url": "https://github.com/AskAlexSharov",
      "followers_url": "https://api.github.com/users/AskAlexSharov/followers",
      "following_url": "https://api.github.com/users/AskAlexSharov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AskAlexSharov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AskAlexSharov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AskAlexSharov/subscriptions",
      "organizations_url": "https://api.github.com/users/AskAlexSharov/orgs",
      "repos_url": "https://api.github.com/users/AskAlexSharov/repos",
      "events_url": "https://api.github.com/users/AskAlexSharov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AskAlexSharov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-05T11:04:13Z",
    "updated_at": "2023-05-05T11:04:13Z",
    "author_association": "COLLABORATOR",
    "body": "let's keep this issue alive",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1536089252/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1536137904",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/6646#issuecomment-1536137904",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6646",
    "id": 1536137904,
    "node_id": "IC_kwDOC0FsAM5bj5qw",
    "user": {
      "login": "elee1766",
      "id": 2260857,
      "node_id": "MDQ6VXNlcjIyNjA4NTc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2260857?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/elee1766",
      "html_url": "https://github.com/elee1766",
      "followers_url": "https://api.github.com/users/elee1766/followers",
      "following_url": "https://api.github.com/users/elee1766/following{/other_user}",
      "gists_url": "https://api.github.com/users/elee1766/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/elee1766/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/elee1766/subscriptions",
      "organizations_url": "https://api.github.com/users/elee1766/orgs",
      "repos_url": "https://api.github.com/users/elee1766/repos",
      "events_url": "https://api.github.com/users/elee1766/events{/privacy}",
      "received_events_url": "https://api.github.com/users/elee1766/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-05T11:44:06Z",
    "updated_at": "2023-05-05T11:44:06Z",
    "author_association": "COLLABORATOR",
    "body": "> @AskAlexSharov The library shirou/gopsutil doesn't seem like the right choice. On my test system (debian 11, docker, ubuntu 20.04 guest) the cgroup info does not show up in the expected directory:\n> code:\n> ```go\n>     cgmem, err := docker.CgroupMemDocker(hostname)\n>     if err != nil {\n>         fmt.Println(err)\n>         os.Exit(1)\n>     }\n>     fmt.Printf(\"CgroupMemStat: %+v\\n\", cgmem)\n> ```\n> output:\n> ```bash\n> (ins) ~/erigon-testing/erigon $ docker run --memory 256m -it image /bin/bash\n> root@71173d45655b:/# /usr/local/bin/erigon\n> open /sys/fs/cgroup/memory/system.slice/docker-71173d45655b.scope/memory.stat: no such file or directory\n> ```\n> The directory `/sys/fs/cgroup/memory` doesn't even exist, on the host or the guest... \n> \n> However, I do see the correct memory limit in this file:\n> ```bash\n> root@71173d45655b:/# cat /sys/fs/cgroup/memory.max\n> 268435456\n> ```\n> \n> Turns out this is the difference between cgroup and cgroup2. ~cgroup2 was introduced in linux 4.5 (in 2016). So, i'm going to try to resolve this by reading the file `/sys/fs/cgroup/memory.max`, using that if it exists, else falling back to `memory.TotalMemory()`.~\n> \n> EDIT- actually, it started getting adopted by distros around 2021, so relatively recently: https://github.com/opencontainers/runc/blob/main/docs/cgroup-v2.md\n> \n> (I opened up an issue with gopsutil: https://github.com/shirou/gopsutil/issues/1416) \n> \n\nhi, try this package for interacting with cgroups, I have had success with it (it's also what k8s uses I believe)\n\nhttps://github.com/containerd/cgroups\n\n",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1536137904/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1536148540",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/6646#issuecomment-1536148540",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6646",
    "id": 1536148540,
    "node_id": "IC_kwDOC0FsAM5bj8Q8",
    "user": {
      "login": "elee1766",
      "id": 2260857,
      "node_id": "MDQ6VXNlcjIyNjA4NTc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2260857?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/elee1766",
      "html_url": "https://github.com/elee1766",
      "followers_url": "https://api.github.com/users/elee1766/followers",
      "following_url": "https://api.github.com/users/elee1766/following{/other_user}",
      "gists_url": "https://api.github.com/users/elee1766/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/elee1766/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/elee1766/subscriptions",
      "organizations_url": "https://api.github.com/users/elee1766/orgs",
      "repos_url": "https://api.github.com/users/elee1766/repos",
      "events_url": "https://api.github.com/users/elee1766/events{/privacy}",
      "received_events_url": "https://api.github.com/users/elee1766/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-05T11:54:55Z",
    "updated_at": "2023-05-05T11:58:59Z",
    "author_association": "COLLABORATOR",
    "body": "hi, chiming in\n\n\nthis is not a bug in erigon, it is a \"feature\" of cgroups. I say feature because it's really a bug.\n\n\ncgroups will count page cache memory usage. the first cgroup to touch a page in page cache, that page will count for the memory usage of the cgroup. however cgroup v1 has no good tools for automatic reclaim of such\n\n\nfrom kernel docs for cgroup v1\n```\n2.3 Shared Page Accounting\n\nShared pages are accounted on the basis of the first touch approach. The\ncgroup that first touches a page is accounted for the page. The principle\nbehind this approach is that a cgroup that aggressively uses a shared\npage will eventually get charged for it (once it is uncharged from\nthe cgroup that brought it in -- this will happen on memory pressure).\n\nBut see section 8.2: when moving a task to another cgroup, its pages may\nbe recharged to the new cgroup, if move_charge_at_immigrate has been chosen.\n\nException: If CONFIG_MEMCG_SWAP is not used.\nWhen you do swapoff and make swapped-out pages of shmem(tmpfs) to\nbe backed into memory in force, charges for pages are accounted against the\ncaller of swapoff rather than the users of shmem\n```\n\nthis causes applications with high page cache usage to constantly get oom killed when running in such environment \n\na related issue in kubernetes repo\n\nhttps://github.com/kubernetes/kubernetes/issues/43916\n\n\nsupposedly cgroup V2 has page reclaim ? but I don't know if it works. many people r still running v1 even if they have support unified in kernel\n\n\nthis is possible fixable in erigon - need to check cgroup usage periodically and tell kernel from within erigon to dispose it's page cache periodically, but I have not gone too deep into it. my solution for now - have more ram when running on cgroup based environment \n\nanother issue from cadvisor https://github.com/google/cadvisor/issues/1529",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1536148540/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1536918105",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/6646#issuecomment-1536918105",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6646",
    "id": 1536918105,
    "node_id": "IC_kwDOC0FsAM5bm4JZ",
    "user": {
      "login": "keithchew",
      "id": 5557929,
      "node_id": "MDQ6VXNlcjU1NTc5Mjk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5557929?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/keithchew",
      "html_url": "https://github.com/keithchew",
      "followers_url": "https://api.github.com/users/keithchew/followers",
      "following_url": "https://api.github.com/users/keithchew/following{/other_user}",
      "gists_url": "https://api.github.com/users/keithchew/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/keithchew/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/keithchew/subscriptions",
      "organizations_url": "https://api.github.com/users/keithchew/orgs",
      "repos_url": "https://api.github.com/users/keithchew/repos",
      "events_url": "https://api.github.com/users/keithchew/events{/privacy}",
      "received_events_url": "https://api.github.com/users/keithchew/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-05T23:57:43Z",
    "updated_at": "2023-05-05T23:57:43Z",
    "author_association": "NONE",
    "body": "hmm, I find that a bit hard to believe. From my observation, GO pprof shows 3GB used but docker stats show 30GB used. Is the additional 27GB caused by cgroups page cache \"bug\"? I only have erigon nodes running in docker in my cluster, so I do not have a baremetal installation to compare memory usage. Maybe someone else can advise the memory usage of Erigon in a non-docker environment and confirm if it matches up with GO pprof? If it does, I am definitely taking docker out of the picture, a 27GB blow out is crazy.",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1536918105/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1537095355",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/6646#issuecomment-1537095355",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6646",
    "id": 1537095355,
    "node_id": "IC_kwDOC0FsAM5bnja7",
    "user": {
      "login": "AskAlexSharov",
      "id": 46885206,
      "node_id": "MDQ6VXNlcjQ2ODg1MjA2",
      "avatar_url": "https://avatars.githubusercontent.com/u/46885206?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AskAlexSharov",
      "html_url": "https://github.com/AskAlexSharov",
      "followers_url": "https://api.github.com/users/AskAlexSharov/followers",
      "following_url": "https://api.github.com/users/AskAlexSharov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AskAlexSharov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AskAlexSharov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AskAlexSharov/subscriptions",
      "organizations_url": "https://api.github.com/users/AskAlexSharov/orgs",
      "repos_url": "https://api.github.com/users/AskAlexSharov/repos",
      "events_url": "https://api.github.com/users/AskAlexSharov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AskAlexSharov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-06T09:02:21Z",
    "updated_at": "2023-05-06T09:02:21Z",
    "author_association": "COLLABORATOR",
    "body": "@keithchew see https://github.com/ledgerwatch/erigon#htop-shows-incorrect-memory-usage",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1537095355/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1537099776",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/6646#issuecomment-1537099776",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6646",
    "id": 1537099776,
    "node_id": "IC_kwDOC0FsAM5bnkgA",
    "user": {
      "login": "keithchew",
      "id": 5557929,
      "node_id": "MDQ6VXNlcjU1NTc5Mjk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5557929?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/keithchew",
      "html_url": "https://github.com/keithchew",
      "followers_url": "https://api.github.com/users/keithchew/followers",
      "following_url": "https://api.github.com/users/keithchew/following{/other_user}",
      "gists_url": "https://api.github.com/users/keithchew/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/keithchew/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/keithchew/subscriptions",
      "organizations_url": "https://api.github.com/users/keithchew/orgs",
      "repos_url": "https://api.github.com/users/keithchew/repos",
      "events_url": "https://api.github.com/users/keithchew/events{/privacy}",
      "received_events_url": "https://api.github.com/users/keithchew/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-06T09:24:22Z",
    "updated_at": "2023-05-06T09:24:22Z",
    "author_association": "NONE",
    "body": "That's why at the moment, I don't rely 100% on any memory usage readings (eg docker stats, htop, ctop, top). I only use them as guidelines. The only thing I trust is the OOM reaper, ie when Erigon gets killed by the OOM reaper, then I am certain that the memory consumed before getting killed is correct (otherwise, every other app on Linux will have the same problem). \r\n\r\nIn my current setup, for mainnet chain, Erigon memory usage is stable under 25GB without getting OOM killed. For example, at the moment, GO pprof reports 5GB and docker stats reports 16GB. When the OOM reaper kicks in, I observed the memory usage reported by docker stats is close to the limit set, so I use that as the best guideline when provisioning resources for Erigon nodes in my cluster.",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1537099776/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1594006269",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/6646#issuecomment-1594006269",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6646",
    "id": 1594006269,
    "node_id": "IC_kwDOC0FsAM5fApr9",
    "user": {
      "login": "github-actions[bot]",
      "id": 41898282,
      "node_id": "MDM6Qm90NDE4OTgyODI=",
      "avatar_url": "https://avatars.githubusercontent.com/in/15368?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/github-actions%5Bbot%5D",
      "html_url": "https://github.com/apps/github-actions",
      "followers_url": "https://api.github.com/users/github-actions%5Bbot%5D/followers",
      "following_url": "https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}",
      "gists_url": "https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/github-actions%5Bbot%5D/subscriptions",
      "organizations_url": "https://api.github.com/users/github-actions%5Bbot%5D/orgs",
      "repos_url": "https://api.github.com/users/github-actions%5Bbot%5D/repos",
      "events_url": "https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}",
      "received_events_url": "https://api.github.com/users/github-actions%5Bbot%5D/received_events",
      "type": "Bot",
      "site_admin": false
    },
    "created_at": "2023-06-16T02:32:06Z",
    "updated_at": "2023-06-16T02:32:06Z",
    "author_association": "NONE",
    "body": "This issue is stale because it has been open for 40 days with no activity. Remove stale label or comment, or this will be closed in 7 days.",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1594006269/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
