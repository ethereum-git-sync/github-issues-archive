{
  "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6255",
  "repository_url": "https://api.github.com/repos/ledgerwatch/erigon",
  "labels_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6255/labels{/name}",
  "comments_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6255/comments",
  "events_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6255/events",
  "html_url": "https://github.com/ledgerwatch/erigon/issues/6255",
  "id": 1485688402,
  "node_id": "I_kwDOC0FsAM5Yjc5S",
  "number": 6255,
  "title": "Switch Docker build to a `glibc` distro",
  "user": {
    "login": "cgst",
    "id": 101628,
    "node_id": "MDQ6VXNlcjEwMTYyOA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/101628?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/cgst",
    "html_url": "https://github.com/cgst",
    "followers_url": "https://api.github.com/users/cgst/followers",
    "following_url": "https://api.github.com/users/cgst/following{/other_user}",
    "gists_url": "https://api.github.com/users/cgst/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/cgst/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/cgst/subscriptions",
    "organizations_url": "https://api.github.com/users/cgst/orgs",
    "repos_url": "https://api.github.com/users/cgst/repos",
    "events_url": "https://api.github.com/users/cgst/events{/privacy}",
    "received_events_url": "https://api.github.com/users/cgst/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 4566396003,
      "node_id": "LA_kwDOC0FsAM8AAAABEC2sYw",
      "url": "https://api.github.com/repos/ledgerwatch/erigon/labels/Stale",
      "name": "Stale",
      "color": "ededed",
      "default": false,
      "description": null
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2022-12-09T00:48:45Z",
  "updated_at": "2023-02-01T02:47:05Z",
  "closed_at": "2023-02-01T02:47:05Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "# Rationale\r\n\r\nThe current Docker build is based on `golang:1.19-alpine3.16`, which is optimized for size but considered experimental.\r\n\r\nQuoting from the [Go project DockerHub](https://hub.docker.com/_/golang):\r\n> ### `golang:<version>-alpine`\r\n>This variant is highly experimental, and not officially supported by the Go project (see [golang/go#19938](https://github.com/golang/go/issues/19938) for details).\r\n>\r\n> The main caveat to note is that it does use [musl libc](https://musl.libc.org/) instead of [glibc and friends](https://www.etalabs.net/compare_libcs.html), which can lead to unexpected behavior. See [this Hacker News comment thread](https://news.ycombinator.com/item?id=10782897) for more discussion of the issues that might arise and some pro/con comparisons of using Alpine-based images.\r\n\r\nThe libc implementation is of particular interest to Erigon users because MDBX makes extensive use of POSIX file locks for shared access. An example unexpected behavior arises when you combine a `glibc`-based database reader (e.g., a locally-built `cmd/hack`) with a `musl`-based writer that holds a non-exclusive lock (e.g., `thorax/erigon` Erigon daemon running in the same process namespace). The reader hangs even though MDBX and Erigon are designed to support this use case. The workaround is to rebuild the reader with `musl` (difficult on most dev workstations) or rebuild the writer with `glibc` (i.e., give up on the official Docker image).\r\n\r\nUsers are free to build Erigon in any number of ways, and those who are sensitive to the libc implementation can roll their own build. Nevertheless, it's reasonable to ask if the default/official Docker build should be based on `glibc` or `musl` libc. It is my personal view that `glibc` is more widely supported and leads to fewer surprises, which makes for a more sensible default.\r\n\r\n# Implementation\r\n\r\nRebase the official [`Dockerfile`](https://github.com/ledgerwatch/erigon/blob/devel/Dockerfile) on a glibc distro, such as Bullseye (Debian). I've tried it locally and it's a small change.\r\n\r\n# Considerations\r\n\r\n- Alpine Linux images are optimized for size, so just about anything else we use will be bigger. For example, Debian's `bullseye-sim` base is [~30MB](https://hub.docker.com/_/debian/tags?page=1&name=bullseye-slim) vs Alpine's [~3MB](https://hub.docker.com/_/alpine/tags).\r\n- Incompatibility goes both ways. It's conceivable others may expect or prefer a `musl`-based Erigon build.\r\n",
  "closed_by": {
    "login": "github-actions[bot]",
    "id": 41898282,
    "node_id": "MDM6Qm90NDE4OTgyODI=",
    "avatar_url": "https://avatars.githubusercontent.com/in/15368?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/github-actions%5Bbot%5D",
    "html_url": "https://github.com/apps/github-actions",
    "followers_url": "https://api.github.com/users/github-actions%5Bbot%5D/followers",
    "following_url": "https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}",
    "gists_url": "https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/github-actions%5Bbot%5D/subscriptions",
    "organizations_url": "https://api.github.com/users/github-actions%5Bbot%5D/orgs",
    "repos_url": "https://api.github.com/users/github-actions%5Bbot%5D/repos",
    "events_url": "https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}",
    "received_events_url": "https://api.github.com/users/github-actions%5Bbot%5D/received_events",
    "type": "Bot",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6255/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6255/timeline",
  "performed_via_github_app": null,
  "state_reason": "not_planned"
}
[
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1345146874",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/6255#issuecomment-1345146874",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6255",
    "id": 1345146874,
    "node_id": "IC_kwDOC0FsAM5QLU_6",
    "user": {
      "login": "elee1766",
      "id": 2260857,
      "node_id": "MDQ6VXNlcjIyNjA4NTc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2260857?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/elee1766",
      "html_url": "https://github.com/elee1766",
      "followers_url": "https://api.github.com/users/elee1766/followers",
      "following_url": "https://api.github.com/users/elee1766/following{/other_user}",
      "gists_url": "https://api.github.com/users/elee1766/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/elee1766/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/elee1766/subscriptions",
      "organizations_url": "https://api.github.com/users/elee1766/orgs",
      "repos_url": "https://api.github.com/users/elee1766/repos",
      "events_url": "https://api.github.com/users/elee1766/events{/privacy}",
      "received_events_url": "https://api.github.com/users/elee1766/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-10T05:41:24Z",
    "updated_at": "2022-12-10T19:54:48Z",
    "author_association": "COLLABORATOR",
    "body": "like abhishek mentioned on discord, would be best imo have both a debian based and alpine based image.\r\n\r\ncan keep the alpine based image as the default - won't break existing things\r\n\r\nit seems the binaries are actually already build in glibc world? https://github.com/ledgerwatch/erigon/blob/devel/.goreleaser.yml but in the release.Dockerfile it's an alpine container.\r\n\r\nnot 100% sure on how erigon does their releases to dockerhub, or really how goreleaser works. I don't see them manually linking to musl in goreleaser. is the release container glibc compiled binaries running in alpine?\r\n \r\n \r\ni think the adduser command needs to be changed for debian based build",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1345146874/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1347686017",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/6255#issuecomment-1347686017",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6255",
    "id": 1347686017,
    "node_id": "IC_kwDOC0FsAM5QVA6B",
    "user": {
      "login": "cgst",
      "id": 101628,
      "node_id": "MDQ6VXNlcjEwMTYyOA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/101628?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cgst",
      "html_url": "https://github.com/cgst",
      "followers_url": "https://api.github.com/users/cgst/followers",
      "following_url": "https://api.github.com/users/cgst/following{/other_user}",
      "gists_url": "https://api.github.com/users/cgst/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cgst/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cgst/subscriptions",
      "organizations_url": "https://api.github.com/users/cgst/orgs",
      "repos_url": "https://api.github.com/users/cgst/repos",
      "events_url": "https://api.github.com/users/cgst/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cgst/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-13T03:11:41Z",
    "updated_at": "2022-12-13T03:11:41Z",
    "author_association": "CONTRIBUTOR",
    "body": "Maybe @timmyers can chime in?",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1347686017/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1353698458",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/6255#issuecomment-1353698458",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6255",
    "id": 1353698458,
    "node_id": "IC_kwDOC0FsAM5Qr8ya",
    "user": {
      "login": "elee1766",
      "id": 2260857,
      "node_id": "MDQ6VXNlcjIyNjA4NTc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2260857?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/elee1766",
      "html_url": "https://github.com/elee1766",
      "followers_url": "https://api.github.com/users/elee1766/followers",
      "following_url": "https://api.github.com/users/elee1766/following{/other_user}",
      "gists_url": "https://api.github.com/users/elee1766/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/elee1766/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/elee1766/subscriptions",
      "organizations_url": "https://api.github.com/users/elee1766/orgs",
      "repos_url": "https://api.github.com/users/elee1766/repos",
      "events_url": "https://api.github.com/users/elee1766/events{/privacy}",
      "received_events_url": "https://api.github.com/users/elee1766/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-15T20:57:10Z",
    "updated_at": "2022-12-15T21:04:26Z",
    "author_association": "COLLABORATOR",
    "body": "so `RUN adduser -D -u $UID -g $GID erigon` will need to be changed to something along the lines of `RUN adduser --uid $UID erigon`\r\n\r\ni moved our company  erigon ci to a [public repo](https://gfx.cafe/images/erigon/-/tree/master/) and moved a node to run on the debian based image.\r\n\r\nwill report if i notice anything wrong with that node in comparison to our others. seems to be fine so far.\r\n\r\n\r\none improvement i found - doing the COPY binary by binary allows parallel upload+download of layers, has really increased the speed of downloading and uploading images. will maybe throw in a PR\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1353698458/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1403013619",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/6255#issuecomment-1403013619",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6255",
    "id": 1403013619,
    "node_id": "IC_kwDOC0FsAM5ToEnz",
    "user": {
      "login": "github-actions[bot]",
      "id": 41898282,
      "node_id": "MDM6Qm90NDE4OTgyODI=",
      "avatar_url": "https://avatars.githubusercontent.com/in/15368?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/github-actions%5Bbot%5D",
      "html_url": "https://github.com/apps/github-actions",
      "followers_url": "https://api.github.com/users/github-actions%5Bbot%5D/followers",
      "following_url": "https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}",
      "gists_url": "https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/github-actions%5Bbot%5D/subscriptions",
      "organizations_url": "https://api.github.com/users/github-actions%5Bbot%5D/orgs",
      "repos_url": "https://api.github.com/users/github-actions%5Bbot%5D/repos",
      "events_url": "https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}",
      "received_events_url": "https://api.github.com/users/github-actions%5Bbot%5D/received_events",
      "type": "Bot",
      "site_admin": false
    },
    "created_at": "2023-01-25T02:31:17Z",
    "updated_at": "2023-01-25T02:31:17Z",
    "author_association": "NONE",
    "body": "This issue is stale because it has been open for 40 days with no activity. Remove stale label or comment, or this will be closed in 7 days.",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1403013619/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1411376991",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/6255#issuecomment-1411376991",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/6255",
    "id": 1411376991,
    "node_id": "IC_kwDOC0FsAM5UH-df",
    "user": {
      "login": "github-actions[bot]",
      "id": 41898282,
      "node_id": "MDM6Qm90NDE4OTgyODI=",
      "avatar_url": "https://avatars.githubusercontent.com/in/15368?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/github-actions%5Bbot%5D",
      "html_url": "https://github.com/apps/github-actions",
      "followers_url": "https://api.github.com/users/github-actions%5Bbot%5D/followers",
      "following_url": "https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}",
      "gists_url": "https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/github-actions%5Bbot%5D/subscriptions",
      "organizations_url": "https://api.github.com/users/github-actions%5Bbot%5D/orgs",
      "repos_url": "https://api.github.com/users/github-actions%5Bbot%5D/repos",
      "events_url": "https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}",
      "received_events_url": "https://api.github.com/users/github-actions%5Bbot%5D/received_events",
      "type": "Bot",
      "site_admin": false
    },
    "created_at": "2023-02-01T02:47:05Z",
    "updated_at": "2023-02-01T02:47:05Z",
    "author_association": "NONE",
    "body": "This issue was closed because it has been stalled for 7 days with no activity.",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1411376991/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
