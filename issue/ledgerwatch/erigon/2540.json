{
  "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/2540",
  "repository_url": "https://api.github.com/repos/ledgerwatch/erigon",
  "labels_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/2540/labels{/name}",
  "comments_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/2540/comments",
  "events_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/2540/events",
  "html_url": "https://github.com/ledgerwatch/erigon/issues/2540",
  "id": 972642393,
  "node_id": "MDU6SXNzdWU5NzI2NDIzOTM=",
  "number": 2540,
  "title": "Batch JSON RPC requests are returned out of order",
  "user": {
    "login": "banteg",
    "id": 4562643,
    "node_id": "MDQ6VXNlcjQ1NjI2NDM=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4562643?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/banteg",
    "html_url": "https://github.com/banteg",
    "followers_url": "https://api.github.com/users/banteg/followers",
    "following_url": "https://api.github.com/users/banteg/following{/other_user}",
    "gists_url": "https://api.github.com/users/banteg/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/banteg/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/banteg/subscriptions",
    "organizations_url": "https://api.github.com/users/banteg/orgs",
    "repos_url": "https://api.github.com/users/banteg/repos",
    "events_url": "https://api.github.com/users/banteg/events{/privacy}",
    "received_events_url": "https://api.github.com/users/banteg/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 6,
  "created_at": "2021-08-17T12:36:05Z",
  "updated_at": "2021-08-19T02:26:32Z",
  "closed_at": "2021-08-19T02:26:32Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "#### System information\r\n\r\nErigon version: erigon version 2021.08.2-alpha\r\n\r\nOS & Version: Linux\r\n\r\nCommit hash : 155186ad3e5d1c08ca947b354a9cd0907fb83308\r\n\r\n#### Expected behaviour\r\n\r\nWhen I do a synchronous batch JSON RPC request with ids going `0, 1, 2, 3, 4, …`, it would make sense if the responses came back in the same order. It's not enforced by [the spec](https://www.jsonrpc.org/specification#batch), but it would help users to avoid hard-to-catch bugs.\r\n\r\n#### Actual behaviour\r\n\r\nThe results come out of order like `36, 32, 34, 29, 39, 28, …`, which is unexpected. This wasn't the case before and I believe it's not the case in other clients. I think this subtlety should be at least addressed in the rpcdaemon docs.\r\n\r\n#### Steps to reproduce the behaviour\r\n\r\n```python\r\nimport requests\r\n\r\nbatch = [\r\n    {\r\n        'jsonrpc': '2.0',\r\n        'id': id,\r\n        'method': 'eth_call',\r\n        'params': [\r\n            {'to': '0x6B175474E89094C44Da98b954EedeAC495271d0F', 'data': \"0x18160ddd\"},\r\n            block,\r\n        ],\r\n    }\r\n    for id, block in enumerate(range(8928158, chain.height, 100000))\r\n]\r\n\r\nresponse = requests.post('http://127.0.0.1:8545', json=batch).json()\r\nreturned_order = [res['id'] for res in response]\r\nprint(returned_order)\r\nprint(returned_order == sorted(returned_order))\r\n```",
  "closed_by": {
    "login": "AskAlexSharov",
    "id": 46885206,
    "node_id": "MDQ6VXNlcjQ2ODg1MjA2",
    "avatar_url": "https://avatars.githubusercontent.com/u/46885206?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/AskAlexSharov",
    "html_url": "https://github.com/AskAlexSharov",
    "followers_url": "https://api.github.com/users/AskAlexSharov/followers",
    "following_url": "https://api.github.com/users/AskAlexSharov/following{/other_user}",
    "gists_url": "https://api.github.com/users/AskAlexSharov/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/AskAlexSharov/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/AskAlexSharov/subscriptions",
    "organizations_url": "https://api.github.com/users/AskAlexSharov/orgs",
    "repos_url": "https://api.github.com/users/AskAlexSharov/repos",
    "events_url": "https://api.github.com/users/AskAlexSharov/events{/privacy}",
    "received_events_url": "https://api.github.com/users/AskAlexSharov/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/2540/reactions",
    "total_count": 2,
    "+1": 2,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/2540/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/900511651",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/2540#issuecomment-900511651",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/2540",
    "id": 900511651,
    "node_id": "IC_kwDOC0FsAM41rLej",
    "user": {
      "login": "floatcoder",
      "id": 77080072,
      "node_id": "MDQ6VXNlcjc3MDgwMDcy",
      "avatar_url": "https://avatars.githubusercontent.com/u/77080072?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/floatcoder",
      "html_url": "https://github.com/floatcoder",
      "followers_url": "https://api.github.com/users/floatcoder/followers",
      "following_url": "https://api.github.com/users/floatcoder/following{/other_user}",
      "gists_url": "https://api.github.com/users/floatcoder/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/floatcoder/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/floatcoder/subscriptions",
      "organizations_url": "https://api.github.com/users/floatcoder/orgs",
      "repos_url": "https://api.github.com/users/floatcoder/repos",
      "events_url": "https://api.github.com/users/floatcoder/events{/privacy}",
      "received_events_url": "https://api.github.com/users/floatcoder/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-08-17T17:54:36Z",
    "updated_at": "2021-08-17T18:24:29Z",
    "author_association": "NONE",
    "body": "We've also been experiencing this along with POKT Network over the past few days. [web3.js#4250](https://github.com/ChainSafe/web3.js/issues/4250) assumes that a batch response is in order when parsing.\r\n\r\nThis is also assumed in the _Experimental_ [JsonRpcBatchProvider](https://github.com/ethers-io/ethers.js/blob/master/packages/providers/src.ts/json-rpc-batch-provider.ts#L68) in ethers.js",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/900511651/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/900533236",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/2540#issuecomment-900533236",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/2540",
    "id": 900533236,
    "node_id": "IC_kwDOC0FsAM41rQv0",
    "user": {
      "login": "tjayrush",
      "id": 5417918,
      "node_id": "MDQ6VXNlcjU0MTc5MTg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5417918?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tjayrush",
      "html_url": "https://github.com/tjayrush",
      "followers_url": "https://api.github.com/users/tjayrush/followers",
      "following_url": "https://api.github.com/users/tjayrush/following{/other_user}",
      "gists_url": "https://api.github.com/users/tjayrush/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tjayrush/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tjayrush/subscriptions",
      "organizations_url": "https://api.github.com/users/tjayrush/orgs",
      "repos_url": "https://api.github.com/users/tjayrush/repos",
      "events_url": "https://api.github.com/users/tjayrush/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tjayrush/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-08-17T18:27:54Z",
    "updated_at": "2021-08-17T18:27:54Z",
    "author_association": "CONTRIBUTOR",
    "body": "Sorting should be optional.\r\n\r\nBy forcing a sort on the server side, you're eliminating the benefit of parallelism. If the calling code also wants to process the returned values in parallel (because each block is independent for example), the benefit disappears if it has to wait while the server sorts. Not to mention sorting means the server must accumulate all the data which puts unnecessary memory pressure on the server for large batches.\r\n\r\nI'm pretty sure this is why the spec doesn't require sorting.",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/900533236/reactions",
      "total_count": 3,
      "+1": 3,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/900792300",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/2540#issuecomment-900792300",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/2540",
    "id": 900792300,
    "node_id": "IC_kwDOC0FsAM41sP_s",
    "user": {
      "login": "AskAlexSharov",
      "id": 46885206,
      "node_id": "MDQ6VXNlcjQ2ODg1MjA2",
      "avatar_url": "https://avatars.githubusercontent.com/u/46885206?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AskAlexSharov",
      "html_url": "https://github.com/AskAlexSharov",
      "followers_url": "https://api.github.com/users/AskAlexSharov/followers",
      "following_url": "https://api.github.com/users/AskAlexSharov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AskAlexSharov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AskAlexSharov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AskAlexSharov/subscriptions",
      "organizations_url": "https://api.github.com/users/AskAlexSharov/orgs",
      "repos_url": "https://api.github.com/users/AskAlexSharov/repos",
      "events_url": "https://api.github.com/users/AskAlexSharov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AskAlexSharov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-08-18T03:54:45Z",
    "updated_at": "2021-08-18T03:54:45Z",
    "author_association": "COLLABORATOR",
    "body": "Fix: https://github.com/ledgerwatch/erigon/pull/2541",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/900792300/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/901036055",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/2540#issuecomment-901036055",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/2540",
    "id": 901036055,
    "node_id": "IC_kwDOC0FsAM41tLgX",
    "user": {
      "login": "mdben1247",
      "id": 10809772,
      "node_id": "MDQ6VXNlcjEwODA5Nzcy",
      "avatar_url": "https://avatars.githubusercontent.com/u/10809772?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mdben1247",
      "html_url": "https://github.com/mdben1247",
      "followers_url": "https://api.github.com/users/mdben1247/followers",
      "following_url": "https://api.github.com/users/mdben1247/following{/other_user}",
      "gists_url": "https://api.github.com/users/mdben1247/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mdben1247/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mdben1247/subscriptions",
      "organizations_url": "https://api.github.com/users/mdben1247/orgs",
      "repos_url": "https://api.github.com/users/mdben1247/repos",
      "events_url": "https://api.github.com/users/mdben1247/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mdben1247/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-08-18T11:27:46Z",
    "updated_at": "2021-08-18T11:27:46Z",
    "author_association": "NONE",
    "body": "Out-of-order breaks `rust-web3` implementation as well. \r\n\r\nThe specs does not specify the order, but it does specify \"The Server should respond ... after all of the batch Request objects have been processed\". So regardless of the order, there is no gain to be had here from parallelism, as everything is returned in a single message anyway. In practice, if results are independent, it makes sense to just send separate requests or batch dependent results together in separate batches.",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/901036055/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/901537275",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/2540#issuecomment-901537275",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/2540",
    "id": 901537275,
    "node_id": "IC_kwDOC0FsAM41vF37",
    "user": {
      "login": "AskAlexSharov",
      "id": 46885206,
      "node_id": "MDQ6VXNlcjQ2ODg1MjA2",
      "avatar_url": "https://avatars.githubusercontent.com/u/46885206?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AskAlexSharov",
      "html_url": "https://github.com/AskAlexSharov",
      "followers_url": "https://api.github.com/users/AskAlexSharov/followers",
      "following_url": "https://api.github.com/users/AskAlexSharov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AskAlexSharov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AskAlexSharov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AskAlexSharov/subscriptions",
      "organizations_url": "https://api.github.com/users/AskAlexSharov/orgs",
      "repos_url": "https://api.github.com/users/AskAlexSharov/repos",
      "events_url": "https://api.github.com/users/AskAlexSharov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AskAlexSharov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-08-19T01:24:00Z",
    "updated_at": "2021-08-19T01:24:00Z",
    "author_association": "COLLABORATOR",
    "body": "@mdben1247 , @floatcoder - there is corner case - notification requests have no response (nil responses do not return to client:\r\nhttps://github.com/ethereum/go-ethereum/blob/master/rpc/handler.go#L119\r\nhttps://github.com/ethereum/go-ethereum/blob/master/rpc/testdata/reqresp-batch.js#L3\r\n\r\nIt means if some notification request will be in the middle of batch then geth will return shifted results - means geth can return non-ordered response general :-) have fun \r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/901537275/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/901559544",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/2540#issuecomment-901559544",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/2540",
    "id": 901559544,
    "node_id": "IC_kwDOC0FsAM41vLT4",
    "user": {
      "login": "AskAlexSharov",
      "id": 46885206,
      "node_id": "MDQ6VXNlcjQ2ODg1MjA2",
      "avatar_url": "https://avatars.githubusercontent.com/u/46885206?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AskAlexSharov",
      "html_url": "https://github.com/AskAlexSharov",
      "followers_url": "https://api.github.com/users/AskAlexSharov/followers",
      "following_url": "https://api.github.com/users/AskAlexSharov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AskAlexSharov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AskAlexSharov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AskAlexSharov/subscriptions",
      "organizations_url": "https://api.github.com/users/AskAlexSharov/orgs",
      "repos_url": "https://api.github.com/users/AskAlexSharov/repos",
      "events_url": "https://api.github.com/users/AskAlexSharov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AskAlexSharov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-08-19T02:26:32Z",
    "updated_at": "2021-08-19T02:26:32Z",
    "author_association": "COLLABORATOR",
    "body": "fixed",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/901559544/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
