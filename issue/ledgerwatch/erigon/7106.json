{
  "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/7106",
  "repository_url": "https://api.github.com/repos/ledgerwatch/erigon",
  "labels_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/7106/labels{/name}",
  "comments_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/7106/comments",
  "events_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/7106/events",
  "html_url": "https://github.com/ledgerwatch/erigon/issues/7106",
  "id": 1623267573,
  "node_id": "I_kwDOC0FsAM5gwRj1",
  "number": 7106,
  "title": "Chaindata Compression",
  "user": {
    "login": "thorstenhirsch",
    "id": 619741,
    "node_id": "MDQ6VXNlcjYxOTc0MQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/619741?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/thorstenhirsch",
    "html_url": "https://github.com/thorstenhirsch",
    "followers_url": "https://api.github.com/users/thorstenhirsch/followers",
    "following_url": "https://api.github.com/users/thorstenhirsch/following{/other_user}",
    "gists_url": "https://api.github.com/users/thorstenhirsch/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/thorstenhirsch/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/thorstenhirsch/subscriptions",
    "organizations_url": "https://api.github.com/users/thorstenhirsch/orgs",
    "repos_url": "https://api.github.com/users/thorstenhirsch/repos",
    "events_url": "https://api.github.com/users/thorstenhirsch/events{/privacy}",
    "received_events_url": "https://api.github.com/users/thorstenhirsch/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2023-03-14T11:19:39Z",
  "updated_at": "2023-03-15T10:30:33Z",
  "closed_at": "2023-03-15T08:06:40Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "# Rationale\r\nWhy should this feature exist?\r\n- Polygon mainnet chaindata is at ~5.9 TB, which can be compressed even with performance-focused algorithms like lz4 to ~2.2 TB (on file level with MDBX backend, so I'm speaking of mdbx.dat)\r\n- Huge storage requirements drive up the costs to operate nodes in the cloud\r\n\r\nWhat are the use-cases?\r\n- All blockchains with huge chaindata\r\n\r\n# Implementation\r\nDo you have ideas regarding the implementation of this feature?\r\n- Compression on dataset (value) level probably won't cut it, my gut feeling is we need to compress the whole database\r\n- Some guys use filesystem compression, which is available in btrfs and zfs, but AFAIK they don't compress on file level, but only records, which are very small parts, thus reaching muss less compression (~10%)\r\n- From a user perspective it's favourable to get compression from the application, i.e. erigon or ergion's kv db backend instead of instructions for using specific filesystems with special configurations, especially when its data can be compressed as good as the chaindata\r\n\r\nSo let's discuss alternatives in this issue...\r\n\r\n# MDBX\r\n- According to my research it is not possible to implement lz4 compression in mdbx at file/memory level due to mmap\r\n- A recent research paper [1] even dismisses the suitability of mmap for transactional databases completely\r\n- Erigon's abstraction layer for the KV database backend should make it easy to switch away from MDBX, or at lease provide a configurable alternative\r\n\r\nAre you willing to implement this feature?\r\n- Yes, but I know that one does not simply write a resilient, transactional, performant DB backend. Let's first checkout if there are other backends available, which might have performed worse compared to MDBX so far, but which are suitable for lz4 compression.\r\n- What do you think about persy [2], sled [3], or btree [4]?\r\n\r\n[1] - https://cs.brown.edu/people/acrotty/pubs/p13-crotty.pdf\r\n[2] - https://persy.rs\r\n[3] - https://github.com/spacejam/sled\r\n[4] - https://github.com/notjustinshaw/btree\r\n",
  "closed_by": {
    "login": "thorstenhirsch",
    "id": 619741,
    "node_id": "MDQ6VXNlcjYxOTc0MQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/619741?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/thorstenhirsch",
    "html_url": "https://github.com/thorstenhirsch",
    "followers_url": "https://api.github.com/users/thorstenhirsch/followers",
    "following_url": "https://api.github.com/users/thorstenhirsch/following{/other_user}",
    "gists_url": "https://api.github.com/users/thorstenhirsch/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/thorstenhirsch/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/thorstenhirsch/subscriptions",
    "organizations_url": "https://api.github.com/users/thorstenhirsch/orgs",
    "repos_url": "https://api.github.com/users/thorstenhirsch/repos",
    "events_url": "https://api.github.com/users/thorstenhirsch/events{/privacy}",
    "received_events_url": "https://api.github.com/users/thorstenhirsch/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/7106/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/7106/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1469282609",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/7106#issuecomment-1469282609",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/7106",
    "id": 1469282609,
    "node_id": "IC_kwDOC0FsAM5Xk3kx",
    "user": {
      "login": "AskAlexSharov",
      "id": 46885206,
      "node_id": "MDQ6VXNlcjQ2ODg1MjA2",
      "avatar_url": "https://avatars.githubusercontent.com/u/46885206?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AskAlexSharov",
      "html_url": "https://github.com/AskAlexSharov",
      "followers_url": "https://api.github.com/users/AskAlexSharov/followers",
      "following_url": "https://api.github.com/users/AskAlexSharov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AskAlexSharov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AskAlexSharov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AskAlexSharov/subscriptions",
      "organizations_url": "https://api.github.com/users/AskAlexSharov/orgs",
      "repos_url": "https://api.github.com/users/AskAlexSharov/repos",
      "events_url": "https://api.github.com/users/AskAlexSharov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AskAlexSharov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-15T03:54:28Z",
    "updated_at": "2023-03-15T03:54:28Z",
    "author_association": "COLLABORATOR",
    "body": "In general:\r\n- compression - means you need RAM for 2 things: compressed and uncompressed data. mans you will have more RAM pressure/CPU caches eviction/loose zero-copy nature of db, etc...\r\n- \"suitability of mmap for transactional databases completely\" - too big topic, too depends on workload, too depends on features required, too depends on implementation of \"non-mmap database in vacuum\", too depends on disk type, ...\r\n- \"Erigon's abstraction layer for the KV database backend\" - we already have abstraction layer - but it using so much db features that you can't imagine. \r\n- \"Some guys use filesystem compression\" you may gain 2x on size here.\r\n\r\nWhat is done: \r\n- Erigon2 moved historical blocks and TxLookup (by tx hash) index from chaindata to `datadir/snapshots`. They are compressed (by file-based compression, not block-base), immutable, way more compact indices (because of immutable property), data stored sequential in this files means more predictable read pattern (means can use madvise), etc...\r\n- Erigon3 moving state history (and related indices) from chaindata to `datadir/snapshots/history`. Not all this snapshots are compressed now - but maybe we will turn-on more compression here in future. Erigon3 is not released yet, but getting close. \r\n- Erigon4 plan to move cold parts of current state from chaindata to `datadir/snapshots/history`. ",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1469282609/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1469533374",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/7106#issuecomment-1469533374",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/7106",
    "id": 1469533374,
    "node_id": "IC_kwDOC0FsAM5Xl0y-",
    "user": {
      "login": "thorstenhirsch",
      "id": 619741,
      "node_id": "MDQ6VXNlcjYxOTc0MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/619741?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/thorstenhirsch",
      "html_url": "https://github.com/thorstenhirsch",
      "followers_url": "https://api.github.com/users/thorstenhirsch/followers",
      "following_url": "https://api.github.com/users/thorstenhirsch/following{/other_user}",
      "gists_url": "https://api.github.com/users/thorstenhirsch/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/thorstenhirsch/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/thorstenhirsch/subscriptions",
      "organizations_url": "https://api.github.com/users/thorstenhirsch/orgs",
      "repos_url": "https://api.github.com/users/thorstenhirsch/repos",
      "events_url": "https://api.github.com/users/thorstenhirsch/events{/privacy}",
      "received_events_url": "https://api.github.com/users/thorstenhirsch/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-15T08:06:40Z",
    "updated_at": "2023-03-15T08:06:40Z",
    "author_association": "CONTRIBUTOR",
    "body": "Thank you very much @AskAlexSharov. So I guess I should wait for the release of Erigon3 before doing something stupid. ;-) \r\nJust let me know if there's a small task I can help with.",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1469533374/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1469748206",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/7106#issuecomment-1469748206",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/7106",
    "id": 1469748206,
    "node_id": "IC_kwDOC0FsAM5XmpPu",
    "user": {
      "login": "AskAlexSharov",
      "id": 46885206,
      "node_id": "MDQ6VXNlcjQ2ODg1MjA2",
      "avatar_url": "https://avatars.githubusercontent.com/u/46885206?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AskAlexSharov",
      "html_url": "https://github.com/AskAlexSharov",
      "followers_url": "https://api.github.com/users/AskAlexSharov/followers",
      "following_url": "https://api.github.com/users/AskAlexSharov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AskAlexSharov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AskAlexSharov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AskAlexSharov/subscriptions",
      "organizations_url": "https://api.github.com/users/AskAlexSharov/orgs",
      "repos_url": "https://api.github.com/users/AskAlexSharov/repos",
      "events_url": "https://api.github.com/users/AskAlexSharov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AskAlexSharov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-15T10:29:11Z",
    "updated_at": "2023-03-15T10:30:33Z",
    "author_association": "COLLABORATOR",
    "body": "@thorstenhirsch if you interesting - you can work on compression-related things. To optimize: \r\n- compressor or decompressor: in “erigon-lib/compress”\r\n- speed of build/read index: in “erigon-lib/recsplit”\r\n- offsets list compression: in “erigon-lib/eliasfano32“",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1469748206/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
