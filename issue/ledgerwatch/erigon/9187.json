{
  "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/9187",
  "repository_url": "https://api.github.com/repos/ledgerwatch/erigon",
  "labels_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/9187/labels{/name}",
  "comments_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/9187/comments",
  "events_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/9187/events",
  "html_url": "https://github.com/ledgerwatch/erigon/issues/9187",
  "id": 2073645697,
  "node_id": "I_kwDOC0FsAM57mVKB",
  "number": 9187,
  "title": "The synchronization status is stuck at block “0x1173c7b” and fell into a loop between `Recovery` and `Blocks execution`",
  "user": {
    "login": "suxnju",
    "id": 19996579,
    "node_id": "MDQ6VXNlcjE5OTk2NTc5",
    "avatar_url": "https://avatars.githubusercontent.com/u/19996579?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/suxnju",
    "html_url": "https://github.com/suxnju",
    "followers_url": "https://api.github.com/users/suxnju/followers",
    "following_url": "https://api.github.com/users/suxnju/following{/other_user}",
    "gists_url": "https://api.github.com/users/suxnju/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/suxnju/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/suxnju/subscriptions",
    "organizations_url": "https://api.github.com/users/suxnju/orgs",
    "repos_url": "https://api.github.com/users/suxnju/repos",
    "events_url": "https://api.github.com/users/suxnju/events{/privacy}",
    "received_events_url": "https://api.github.com/users/suxnju/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2024-01-10T05:56:40Z",
  "updated_at": "2024-01-28T15:07:56Z",
  "closed_at": "2024-01-28T15:07:55Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "In summary, the mainnet was not synchronized for about 2 months, and after re-synchronization, the block height did not grow, but fell into a loop between `Recovery` and `Blocks execution`\r\n\r\n\r\n#### System information\r\n\r\nErigon version: `2.55.1`\r\n\r\nOS & Version: `Linux`\r\n\r\nErigon Command (with flags/config):`nohup erigon --chain mainnet --datadir \"XXX/erigon_full\" --http --http.addr \"0.0.0.0\" --http.vhosts \"*\" --http.api \"eth,net,web3,debug\" --http.port \"8545\" --http.corsdomain \"*\" --ws --authrpc.jwtsecret \"./jwt.hex\" --metrics > ./logs/erigon.log &`\r\n\r\nConsensus Layer:`prysm`\r\n\r\nConsensus Layer Command (with flags/config):`nohup ./prysm.sh beacon-chain --execution-endpoint=http://localhost:8551/ --jwt-secret=./jwt.hex --accept-terms-of-use --checkpoint-sync-url=https://beaconstate.info --genesis-beacon-api-url=https://beaconstate.info > ./logs/prysm.log &`\r\n\r\nChain/Network: `mainnet`\r\n\r\n#### Expected behaviour\r\n\r\nThe mainnet can be synchronized to the latest state\r\n\r\n\r\n#### Actual behaviour\r\n\r\n1. The block number does not increase\r\n\r\n```\r\n$ curl http://localhost:8545  -X POST --data '{\"jsonrpc\":\"2.0\",\"method\":\"eth_blockNumber\",\"params\":[],\"id\":2}' -H \"Content-type: application/json\"\r\n{\"jsonrpc\":\"2.0\",\"id\":2,\"result\":\"0x1173c7b\"}\r\n```\r\n\r\n1. The synchronization state is stuck into a loop between `Recovery` and `Blocks execution`\r\n\r\nFor consensus logs (it seems normal):\r\n\r\n```\r\ntime=\"2024-01-10 13:09:14\" level=info msg=\"Called new payload with optimistic block\" payloadBlockHash=0x8a4a1a1879cd prefix=blockchain slot=8169944\r\ntime=\"2024-01-10 13:09:14\" level=info msg=\"Called fork choice updated with optimistic block\" finalizedPayloadBlockHash=0x88582dc49085 headPayloadBlockHash=0x8a4a1a1879cd headSlot=8169944 prefix=blockchain\r\ntime=\"2024-01-10 13:09:14\" level=info msg=\"Synced new block\" block=0x243326d2... epoch=255310 finalizedEpoch=255308 finalizedRoot=0x8e6c34b2... prefix=blockchain slot=8169944\r\ntime=\"2024-01-10 13:09:14\" level=info msg=\"Finished applying state transition\" attestations=93 payloadHash=0x8a4a1a1879cd prefix=blockchain slot=8169944 syncBitsCount=506 txCount=251\r\ntime=\"2024-01-10 13:09:24\" level=info msg=\"Called new payload with optimistic block\" payloadBlockHash=0x76c8f47f7395 prefix=blockchain slot=8169945\r\ntime=\"2024-01-10 13:09:25\" level=info msg=\"Called fork choice updated with optimistic block\" finalizedPayloadBlockHash=0x88582dc49085 headPayloadBlockHash=0x76c8f47f7395 headSlot=8169945 prefix=blockchain\r\ntime=\"2024-01-10 13:09:25\" level=info msg=\"Synced new block\" block=0x3ebaead8... epoch=255310 finalizedEpoch=255308 finalizedRoot=0x8e6c34b2... prefix=blockchain slot=8169945\r\ntime=\"2024-01-10 13:09:25\" level=info msg=\"Finished applying state transition\" attestations=128 payloadHash=0x76c8f47f7395 prefix=blockchain slot=8169945 syncBitsCount=499 txCount=137\r\n```\r\n\r\nFor erigon logs (stuck in the loop):\r\n\r\n```\r\n[INFO] [01-09|13:56:04.913] [3/12 Senders] Started                   from=18300027 to=18967464\r\n[INFO] [01-09|13:56:34.914] [3/12 Senders] Recovery                  block_number=18310491 ch=0/10000\r\n[INFO] [01-09|13:57:04.913] [3/12 Senders] Recovery                  block_number=18320379 ch=0/10000\r\n[INFO] [01-09|13:57:18.070] [p2p] GoodPeers                          eth68=3 eth67=6 eth66=1\r\n[INFO] [01-09|13:57:30.707] [txpool] stat                            pending=8857 baseFee=0 queued=1402 alloc=2.5GB sys=5.1GB\r\n[INFO] [01-09|13:57:34.913] [3/12 Senders] Recovery                  block_number=18330013 ch=0/10000\r\n[INFO] [01-09|13:58:04.913] [3/12 Senders] Recovery                  block_number=18341096 ch=0/10000\r\n[INFO] [01-09|13:58:34.913] [3/12 Senders] Recovery                  block_number=18352432 ch=0/10000\r\n[INFO] [01-09|13:59:04.913] [3/12 Senders] Recovery                  block_number=18363695 ch=0/10000\r\n[INFO] [01-09|13:59:34.913] [3/12 Senders] Recovery                  block_number=18374750 ch=0/10000\r\n[INFO] [01-09|14:00:04.914] [3/12 Senders] Recovery                  block_number=18385560 ch=0/10000\r\n...\r\n[INFO] [01-09|14:27:30.707] [txpool] stat                            pending=10000 baseFee=0 queued=20150 alloc=2.9GB sys=6.2GB\r\n[INFO] [01-09|14:27:34.913] [3/12 Senders] Recovery                  block_number=18959673 ch=0/10000\r\n[INFO] [01-09|14:27:56.476] [3/12 Senders] Flushed buffer file       name=erigon-sortable-buf-3517567542\r\n[INFO] [01-09|14:28:00.135] [3/12 Senders] DONE                      in=31m55.222111606s\r\n[INFO] [01-09|14:28:00.143] [4/12 Execution] Blocks execution        from=18300027 to=18967464\r\n[INFO] [01-09|14:28:30.265] [4/12 Execution] Executed blocks         number=18300298 blk/s=9.0 tx/s=1216.6 Mgas/s=134.9 gasState=0.01 batch=7.0MB alloc=4.5GB sys=6.2GB\r\n...\r\n[INFO] [01-09|20:08:00.179] [4/12 Execution] Executed blocks         number=18762636 blk/s=25.9 tx/s=3890.5 Mgas/s=391.1 gasState=0.15 batch=182.1MB alloc=3.2GB sys=7.0GB\r\n[WARN] [01-09|20:08:24.984] [4/12 Execution] Execution failed        block=18763272 hash=0x211ba3b9fa098eaced2250b3117aac66f0f4c314fadaaa9f4244a07a099671f0 err=\"invalid block: could not apply tx 264 from block 18763272 [0x0903481bb036f081cab6157bb04d12a74edd67c3231cdef25fefe487ef7cb91e]: nonce too high: address 0x7b36b4b76D3F8876e9E018cf9cb06e8aa2eefb56, tx: 249454 state: 0\"\r\n[INFO] [01-09|20:08:56.757] [] ETL [2/2] Loading                     into=PlainState current_prefix=a0b86991\r\n[INFO] [01-09|20:09:14.960] Write to db                              progress=1.4M/3.1M current table=Code\r\n[INFO] [01-09|20:09:17.642] [4/12 Execution] Completed on            block=18763271\r\n[INFO] [01-09|20:09:17.649] [4/12 Execution] DONE                    in=5h41m17.506603859s\r\n[WARN] [01-09|20:09:17.651] bad forkchoice                           head=0xa312d9aa77366b3f5259d33d0aac85ad2ec800df67632dfd3b56d53e47d1b5bb hash=0x93c2b832e73c004546fa126656ea85b2b1e8c7eab7202e58dc0c48cc53d5fec4\r\n[INFO] [01-09|20:09:18.070] [p2p] GoodPeers                          eth68=33 eth67=31 eth66=2\r\n[INFO] [01-09|20:09:25.636] [NewPayload] Handling new payload        height=18969311 hash=0xb49502a95ecd09bc4c51e85a0045f8e09c1b1eea7119d89c6bc207bdfb7db0b2\r\n[INFO] [01-09|20:09:25.636] [EngineBlockDownloader] Downloading PoS headers... height=unknown hash=0x87313941d88007edbec8ffd005f8de25a522b071dd6f388c1c3ce9ba441615be requestId=0\r\n[INFO] [01-09|20:09:30.707] [txpool] stat                            pending=10000 baseFee=0 queued=30000 alloc=3.1GB sys=7.0GB\r\n[INFO] [01-09|20:09:39.866] [EngineBlockDownloader] Processing bodies... from=18967464 to=18969310\r\n[INFO] [01-09|20:09:47.770] [NewPayload] Handling new payload        height=18969313 hash=0xc19f37f38a6108ce52cfcb7676c65eb430aea0d3c858ad34a0f2c1cea57bfd78\r\n[INFO] [01-09|20:10:00.354] [NewPayload] Handling new payload        height=18969314 hash=0x5f06006389d24a6f4ee70c5fadd77051bab8d7647ee627a53183ce6f57dd321d\r\n[INFO] [01-09|20:10:09.874] [EngineBlockDownloader] Downloading block bodies block_num=18968329 delivery/sec=7.2MB wasted/sec=1.2MB remaining=980 delivered=1318 cache=79.9MB alloc=4.7GB sys=7.0GB\r\n[INFO] [01-09|20:10:13.149] [NewPayload] Handling new payload        height=18969315 hash=0x9f7a379ed87e8f9db009b567a8a0a8d83c5e9a9ec03b6b4087ca703a5e92b220\r\n[INFO] [01-09|20:10:24.427] [NewPayload] Handling new payload        height=18969316 hash=0xdccef71bec6f800a1e44d0a7e9cdb61e4958af5e69c3850e1b70f4d5596aac20\r\n[INFO] [01-09|20:10:30.276] [EngineBlockDownloader] Processed        highest=18969310\r\n[INFO] [01-09|20:10:30.276] Beginning downloaded blocks insertion \r\n[INFO] [01-09|20:10:33.414] [EngineBlockDownloader] Finished downloading blocks from=18967464 to=18969310\r\n[INFO] [01-09|20:10:33.472] [EngineBlockDownloader] block verification skipped \r\n[INFO] [01-09|20:10:36.977] [NewPayload] Handling new payload        height=18969317 hash=0x6d2574aaa7b2c8d9d999a9bab44368d4bf12dad63efe94b5abcf92e732d702ab\r\n[INFO] [01-09|20:10:36.977] [EngineBlockDownloader] Downloading PoS headers... height=unknown hash=0xdccef71bec6f800a1e44d0a7e9cdb61e4958af5e69c3850e1b70f4d5596aac20 requestId=0\r\n[INFO] [01-09|20:10:37.624] [EngineBlockDownloader] Processed        highest=18969316\r\n[INFO] [01-09|20:10:37.624] Beginning downloaded blocks insertion \r\n[INFO] [01-09|20:10:37.692] [EngineBlockDownloader] Finished downloading blocks from=18969311 to=18969316\r\n[INFO] [01-09|20:10:37.693] [EngineBlockDownloader] block verification skipped \r\n[INFO] [01-09|20:11:03.653] [3/12 Senders] Started                   from=18300027 to=18969317\r\n[INFO] [01-09|20:11:33.654] [3/12 Senders] Recovery                  block_number=18310337 ch=0/10000\r\n[INFO] [01-09|20:12:03.654] [3/12 Senders] Recovery                  block_number=18320191 ch=0/10000\r\n[INFO] [01-09|20:12:18.069] [p2p] GoodPeers                          eth68=33 eth67=31 eth66=2\r\n[INFO] [01-09|20:12:30.706] [txpool] stat                            pending=10000 baseFee=0 queued=30000 alloc=3.5GB sys=7.0GB\r\n[INFO] [01-09|20:12:33.654] [3/12 Senders] Recovery                  block_number=18329900 ch=0/10000\r\n...\r\n[INFO] [01-09|20:42:53.311] [3/12 Senders] DONE                      in=31m49.657263438s\r\n[INFO] [01-09|20:42:53.311] [4/12 Execution] Blocks execution        from=18300027 to=18969317\r\n[INFO] [01-09|20:43:23.447] [4/12 Execution] Executed blocks         number=18300294 blk/s=8.9 tx/s=1196.5 Mgas/s=132.8 gasState=0.01 batch=6.9MB alloc=3.5GB sys=7.6GB\r\n```\r\n\r\n#### Steps to reproduce the behaviour\r\n\r\n1. Step 0: start the erigon according the command mentioned above.\r\n2. Step 2: start the consensus layer prysm according the command.\r\n\r\nThe checkpoint slot reaches the latest\r\n\r\n```\r\n$ curl -s http://127.0.0.1:3500/eth/v1/beacon/headers/finalized\r\n{\"execution_optimistic\":true,\"finalized\":true,\"data\":{\"header\":{\"message\":{\"slot\":\"8169824\",\"proposer_index\":\"472099\",\"parent_root\":\"0x3d8965c917dd1cb35586451964fca72d543fa93ee121854725beb21cc67f515b\",\"state_root\":\"0x3b0249fa21e451641ec56c50312d68c35fef745ba1a3653a91ae0cd821cae6fd\",\"body_root\":\"0xf4027871691853646bb8a9666afb94579fab62fb092bfa1e5ff88e70badf208d\"},\"signature\":\"0x9556f6468c9f780b77d9c16ac28624165bcb739effa01ea074f9f03dbf166ff8fdd815f2048d6a67bcb27302347dca220e61ca91e9666099a49d86772d46eae90bf531719bc9f469a420b289575737270bafe457ad60e67a2bd9ea56c083bd6f\"},\"root\":\"0x72a0dc2ca37ac5752f0fef675f63a5caa6f634e1eb0d2f73942b60ad2ee3102b\",\"canonical\":true}}\r\n```\r\n\r\n#### Other information\r\n\r\n1. At the first synchronization, prysm can be used to instantly reach the latest slot. After resynchronizing, it took a long time to get to the latest slot. At the same time, I also switched the endpoint from https://sync.invis.tools/ to https://beaconstate.info/ (No influence).\r\n2. At first, I thought it was due to the version, so I upgraded the erigon version from `1.12.0-stable-e501b3b0` to `2.55.1`\r\n\r\n#### Detailed Logs\r\n- [erigon.log](https://github.com/ledgerwatch/erigon/files/13883558/erigon.log)\r\n- [prysm.log](https://github.com/ledgerwatch/erigon/files/13883788/prysm.log)\r\n\r\n",
  "closed_by": {
    "login": "suxnju",
    "id": 19996579,
    "node_id": "MDQ6VXNlcjE5OTk2NTc5",
    "avatar_url": "https://avatars.githubusercontent.com/u/19996579?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/suxnju",
    "html_url": "https://github.com/suxnju",
    "followers_url": "https://api.github.com/users/suxnju/followers",
    "following_url": "https://api.github.com/users/suxnju/following{/other_user}",
    "gists_url": "https://api.github.com/users/suxnju/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/suxnju/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/suxnju/subscriptions",
    "organizations_url": "https://api.github.com/users/suxnju/orgs",
    "repos_url": "https://api.github.com/users/suxnju/repos",
    "events_url": "https://api.github.com/users/suxnju/events{/privacy}",
    "received_events_url": "https://api.github.com/users/suxnju/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/9187/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/9187/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1913627602",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/9187#issuecomment-1913627602",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/9187",
    "id": 1913627602,
    "node_id": "IC_kwDOC0FsAM5yD6PS",
    "user": {
      "login": "suxnju",
      "id": 19996579,
      "node_id": "MDQ6VXNlcjE5OTk2NTc5",
      "avatar_url": "https://avatars.githubusercontent.com/u/19996579?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/suxnju",
      "html_url": "https://github.com/suxnju",
      "followers_url": "https://api.github.com/users/suxnju/followers",
      "following_url": "https://api.github.com/users/suxnju/following{/other_user}",
      "gists_url": "https://api.github.com/users/suxnju/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/suxnju/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/suxnju/subscriptions",
      "organizations_url": "https://api.github.com/users/suxnju/orgs",
      "repos_url": "https://api.github.com/users/suxnju/repos",
      "events_url": "https://api.github.com/users/suxnju/events{/privacy}",
      "received_events_url": "https://api.github.com/users/suxnju/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2024-01-28T15:07:55Z",
    "updated_at": "2024-01-28T15:07:55Z",
    "author_association": "NONE",
    "body": "Fixed by `integration stage_headers —reset`",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1913627602/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
