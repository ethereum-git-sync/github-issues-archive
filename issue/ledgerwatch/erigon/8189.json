{
  "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/8189",
  "repository_url": "https://api.github.com/repos/ledgerwatch/erigon",
  "labels_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/8189/labels{/name}",
  "comments_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/8189/comments",
  "events_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/8189/events",
  "html_url": "https://github.com/ledgerwatch/erigon/issues/8189",
  "id": 1895551545,
  "node_id": "I_kwDOC0FsAM5w-9I5",
  "number": 8189,
  "title": "OOM kills occurring",
  "user": {
    "login": "Brando753",
    "id": 2963981,
    "node_id": "MDQ6VXNlcjI5NjM5ODE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2963981?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Brando753",
    "html_url": "https://github.com/Brando753",
    "followers_url": "https://api.github.com/users/Brando753/followers",
    "following_url": "https://api.github.com/users/Brando753/following{/other_user}",
    "gists_url": "https://api.github.com/users/Brando753/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Brando753/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Brando753/subscriptions",
    "organizations_url": "https://api.github.com/users/Brando753/orgs",
    "repos_url": "https://api.github.com/users/Brando753/repos",
    "events_url": "https://api.github.com/users/Brando753/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Brando753/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2023-09-14T02:36:33Z",
  "updated_at": "2023-09-14T05:16:16Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "#### System information\r\n\r\nErigon version: `./erigon --version`: `erigon version 2.49.1-stable-205eeda0`\r\n\r\nOS & Version: Windows/Linux/OSX: \r\nDistributor ID:\tDebian\r\nDescription:\tDebian GNU/Linux 12 (bookworm)\r\nRelease:\t12\r\nCodename:\tbookworm\r\nLinux archival-node-one 6.1.0-12-amd64 #1 SMP PREEMPT_DYNAMIC Debian 6.1.52-1 (2023-09-07) x86_64 GNU/Linux\r\nProcessor: Intel i7-12700K\r\nRam: 64 GB DDR4\r\nMotherboard: PRIME Z690M-PLUS D4\r\nFile System: ZFS\r\nBare Metal is not running in any VM, container, or docker instance.\r\n\r\nCommit hash: 205eeda01fd8f8a2956276d6760b9298f70bd18f\r\nCompiled with: go version go1.20.8 linux/amd64\r\n\r\nErigon Command (with flags/config): erigon/build/bin/erigon --datadir '/zfs_pool/ethereum' --chain mainnet --authrpc.port 8555 --torrent.download.rate=999mb --torrent.download.slots=6 --torrent.port=42069 --pprof\r\n\r\nConcensus Layer: lighthouse\r\n\r\nConcensus Layer Command (with flags/config): lighthouse/target/maxperf/lighthouse  beacon_node --execution-endpoint http://127.0.0.1:8555 --execution-jwt /zfs_pool/ethereum/jwt.hex --datadir /zfs_pool/lighthouse --network mainnet --checkpoint-sync-url https://mainnet.checkpoint.sigp.io\r\n\r\nChain/Network: Ethereum Mainnet\r\n\r\n#### Expected behaviour\r\nErigon should sync with the network without using up all system RAM and being killed by the Kernel OOM killer.\r\n\r\n#### Actual behaviour\r\nDuring indexing, the system uses more and more RAM until it is killed by the kernel.\r\n\r\n#### Steps to reproduce the behaviour\r\nI have been having tons of issues trying to get Erigon to work over many versions, almost always related to growing memory consumption. I do not know the cause. I figured past issues may have been due to some corruption in the data-dir, so I wiped it and started fresh with a brand new build of erigon on the latest version, and as it tried to index, it encountered a memory issue. Issue #7864 was one I reported before on Polygon and now I have them on the Ethereum mainnet with the latest versions. \r\n\r\n#### Backtrace\r\n\r\n````\r\nSep 13 17:50:36 archival-node-one erigon[982974]: [INFO] [09-13|17:50:36.726] new subscription to newHeaders established\r\nSep 13 17:50:36 archival-node-one erigon[982974]: [INFO] [09-13|17:50:36.726] New txs subscriber joined\r\nSep 13 17:50:36 archival-node-one erigon[982974]: [INFO] [09-13|17:50:36.736] [1/12 Snapshots] Fetching torrent files metadata\r\nSep 13 17:50:36 archival-node-one erigon[982974]: [INFO] [09-13|17:50:36.736] HTTP endpoint opened                     url=127.0.0.1:8545 ws=false ws.compression=true grpc=false\r\nSep 13 17:50:36 archival-node-one erigon[982974]: [INFO] [09-13|17:50:36.736] Reading JWT secret                       path=/zfs_pool/ethereum/jwt.hex\r\nSep 13 17:50:36 archival-node-one erigon[982974]: [INFO] [09-13|17:50:36.737] HTTP endpoint opened for Engine API      url=127.0.0.1:8555 ws=true ws.compression=true\r\nSep 13 17:50:36 archival-node-one erigon[982974]: [INFO] [09-13|17:50:36.737] [txpool] Started\r\nSep 13 17:50:36 archival-node-one erigon[982974]: [WARN] [09-13|17:50:36.821] NAT ExternalIP resolution has failed, try to pass a different --nat option err=\"no UPnP or NAT-PMP router discovered\"\r\nSep 13 17:50:36 archival-node-one erigon[982974]: [INFO] [09-13|17:50:36.822] Started P2P networking                   version=67 self=enode://bfaab4e64c5b5b2ed786ce78010578e112a709ad7cfa13777a04ed15a0b4521655cf6e15a2b9177b3e884dd37213fd09fd0205edb42be88ee7f78d363783f637@127.0.0.1:0 name=erigon/v2.49.1-stable-205eeda0/linux-amd64/go1.20.8\r\nSep 13 17:50:36 archival-node-one erigon[982974]: [WARN] [09-13|17:50:36.876] NAT ExternalIP resolution has failed, try to pass a different --nat option err=\"no UPnP or NAT-PMP router discovered\"\r\nSep 13 17:50:36 archival-node-one erigon[982974]: [INFO] [09-13|17:50:36.897] Started P2P networking                   version=68 self=enode://bfaab4e64c5b5b2ed786ce78010578e112a709ad7cfa13777a04ed15a0b4521655cf6e15a2b9177b3e884dd37213fd09fd0205edb42be88ee7f78d363783f637@127.0.0.1:0 name=erigon/v2.49.1-stable-205eeda0/linux-amd64/go1.20.8\r\nSep 13 17:50:44 archival-node-one erigon[982974]: [INFO] [09-13|17:50:44.022] [snapshots] Blocks Stat                  blocks=3500k indices=3500k alloc=2.4GB sys=2.5GB\r\nSep 13 17:51:04 archival-node-one erigon[982974]: [INFO] [09-13|17:51:04.027] [1/12 Snapshots] Indexing                progress=\"v1-003500-004000-transactions.seg=7%, v1-004500-005000-transactions.seg=1%, v1-006000-006500-transactions.seg=2%, v1-005000-005500-transactions.seg=1%, v1-010500-011000-transactions.seg=1%, v1-006500-007000-transactions.seg=2%, v1-007000-007500-transactions.seg=2%, v1-007500-008000-transactions.seg=1%, v1-008000-008500-transactions.seg=2%, v1-008500-009000-transactions.seg=2%, v1-009000-009500-transactions.seg=2%, v1-004000-004500-transactions.seg=2%, v1-010000-010500-transactions.seg=1%, v1-009500-010000-transactions.seg=2%, v1-005500-006000-transactions.seg=1%\" total-indexing-time=20s alloc=11.0GB sys=17.0GB\r\nSep 13 17:51:24 archival-node-one erigon[982974]: [INFO] [09-13|17:51:24.028] [1/12 Snapshots] Indexing                progress=\"v1-003500-004000-transactions.seg=19%, v1-004500-005000-transactions.seg=3%, v1-006000-006500-transactions.seg=4%, v1-005000-005500-transactions.seg=3%, v1-010500-011000-transactions.seg=2%, v1-006500-007000-transactions.seg=5%, v1-007000-007500-transactions.seg=4%, v1-007500-008000-transactions.seg=3%, v1-008000-008500-transactions.seg=4%, v1-008500-009000-transactions.seg=4%, v1-009000-009500-transactions.seg=4%, v1-004000-004500-transactions.seg=5%, v1-010000-010500-transactions.seg=3%, v1-009500-010000-transactions.seg=4%, v1-005500-006000-transactions.seg=3%\" total-indexing-time=40s alloc=15.4GB sys=17.0GB\r\nSep 13 17:51:36 archival-node-one erigon[982974]: [INFO] [09-13|17:51:36.732] [txpool] stat                            pending=27 baseFee=0 queued=365 alloc=15.7GB sys=17.0GB\r\nSep 13 17:51:44 archival-node-one erigon[982974]: [INFO] [09-13|17:51:44.025] [1/12 Snapshots] Indexing                progress=\"v1-003500-004000-transactions.seg=28%, v1-004500-005000-transactions.seg=4%, v1-006000-006500-transactions.seg=7%, v1-005000-005500-transactions.seg=6%, v1-010500-011000-transactions.seg=4%, v1-006500-007000-transactions.seg=7%, v1-007000-007500-transactions.seg=7%, v1-007500-008000-transactions.seg=5%, v1-008000-008500-transactions.seg=6%, v1-008500-009000-transactions.seg=6%, v1-009000-009500-transactions.seg=7%, v1-004000-004500-transactions.seg=10%, v1-010000-010500-transactions.seg=4%, v1-009500-010000-transactions.seg=6%, v1-005500-006000-transactions.seg=5%\" total-indexing-time=1m0s alloc=15.8GB sys=17.0GB\r\nSep 13 17:52:04 archival-node-one erigon[982974]: [INFO] [09-13|17:52:04.260] [1/12 Snapshots] Indexing                progress=\"v1-003500-004000-transactions.seg=35%, v1-004500-005000-transactions.seg=6%, v1-006000-006500-transactions.seg=10%, v1-005000-005500-transactions.seg=9%, v1-010500-011000-transactions.seg=5%, v1-006500-007000-transactions.seg=10%, v1-007000-007\r\n500-transactions.seg=9%, v1-007500-008000-transactions.seg=7%, v1-008000-008500-transactions.seg=8%, v1-008500-009000-transactions.seg=8%, v1-009000-009500-transactions.seg=9%, v1-004000-004500-transactions.seg=13%, v1-010000-010500-transactions.seg=6%, v1-009500-010000-transactions.seg=8%, v1-005500-006000-transactions.seg=7%\" total-indexing-time=1m20s alloc=16.2GB sys=17.1GB\r\nSep 13 17:52:24 archival-node-one erigon[982974]: [INFO] [09-13|17:52:24.025] [1/12 Snapshots] Indexing                progress=\"v1-003500-004000-transactions.seg=47%, v1-004500-005000-transactions.seg=8%, v1-006000-006500-transactions.seg=13%, v1-005000-005500-transactions.seg=11%, v1-010500-011000-transactions.seg=7%, v1-006500-007000-transactions.seg=13%, v1-007000-007500-transactions.seg=12%, v1-007500-008000-transactions.seg=10%, v1-008000-008500-transactions.seg=10%, v1-008500-009000-transactions.seg=11%, v1-009000-009500-transactions.seg=11%, v1-004000-004500-transactions.seg=16%, v1-010000-010500-transactions.seg=8%, v1-009500-010000-transactions.seg=10%, v1-005500-006000-transactions.seg=9%\" total-indexing-time=1m40s alloc=16.6GB sys=17.1GB\r\nSep 13 17:52:33 archival-node-one systemd[1]: ethereum.service: A process of this unit has been killed by the OOM killer.\r\nSep 13 17:52:33 archival-node-one systemd[1]: ethereum.service: Main process exited, code=killed, status=9/KILL\r\nSep 13 17:52:33 archival-node-one systemd[1]: ethereum.service: Failed with result 'oom-kill'.\r\nSep 13 17:52:33 archival-node-one systemd[1]: ethereum.service: Consumed 23min 49.379s CPU time.\r\nSep 13 17:52:34 archival-node-one systemd[1]: ethereum.service: Scheduled restart job, restart counter is at 1.\r\nSep 13 17:52:34 archival-node-one systemd[1]: Stopped ethereum.service - Runs Erigon Archival Node on Ethereum Mainnet.\r\nSep 13 17:52:34 archival-node-one systemd[1]: ethereum.service: Consumed 23min 49.379s CPU time.\r\n\r\n````\r\n\r\n![mem_2](https://github.com/ledgerwatch/erigon/assets/2963981/da1844c7-bad0-416a-be47-e53794ff94fb)\r\n\r\n\r\nIt's really hard to capture a snapshot right before it balloons and gets killed. Here is the last one I took before the oom killer got engaged. If it happens again, I will update with another one that will hopefully be in a later state of the memory consumption as I have a script pulling the pprof every 30 seconds.  Current profile files attached. \r\n[profiler.tar.gz](https://github.com/ledgerwatch/erigon/files/12603233/profiler.tar.gz)\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/8189/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/8189/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1718776971",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/8189#issuecomment-1718776971",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/8189",
    "id": 1718776971,
    "node_id": "IC_kwDOC0FsAM5mcnSL",
    "user": {
      "login": "AskAlexSharov",
      "id": 46885206,
      "node_id": "MDQ6VXNlcjQ2ODg1MjA2",
      "avatar_url": "https://avatars.githubusercontent.com/u/46885206?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AskAlexSharov",
      "html_url": "https://github.com/AskAlexSharov",
      "followers_url": "https://api.github.com/users/AskAlexSharov/followers",
      "following_url": "https://api.github.com/users/AskAlexSharov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AskAlexSharov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AskAlexSharov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AskAlexSharov/subscriptions",
      "organizations_url": "https://api.github.com/users/AskAlexSharov/orgs",
      "repos_url": "https://api.github.com/users/AskAlexSharov/repos",
      "events_url": "https://api.github.com/users/AskAlexSharov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AskAlexSharov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-09-14T05:16:16Z",
    "updated_at": "2023-09-14T05:16:16Z",
    "author_association": "COLLABORATOR",
    "body": "temporary workarounds: \r\n- reduce GOMAXPROCS=<half_of_cpus> \r\n- or/and set GOGC=50",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1718776971/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
