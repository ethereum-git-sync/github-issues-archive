{
  "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5694",
  "repository_url": "https://api.github.com/repos/ledgerwatch/erigon",
  "labels_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5694/labels{/name}",
  "comments_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5694/comments",
  "events_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5694/events",
  "html_url": "https://github.com/ledgerwatch/erigon/issues/5694",
  "id": 1404086827,
  "node_id": "I_kwDOC0FsAM5TsKor",
  "number": 5694,
  "title": "erigon mining with bor consensus",
  "user": {
    "login": "manav2401",
    "id": 36959497,
    "node_id": "MDQ6VXNlcjM2OTU5NDk3",
    "avatar_url": "https://avatars.githubusercontent.com/u/36959497?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/manav2401",
    "html_url": "https://github.com/manav2401",
    "followers_url": "https://api.github.com/users/manav2401/followers",
    "following_url": "https://api.github.com/users/manav2401/following{/other_user}",
    "gists_url": "https://api.github.com/users/manav2401/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/manav2401/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/manav2401/subscriptions",
    "organizations_url": "https://api.github.com/users/manav2401/orgs",
    "repos_url": "https://api.github.com/users/manav2401/repos",
    "events_url": "https://api.github.com/users/manav2401/events{/privacy}",
    "received_events_url": "https://api.github.com/users/manav2401/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 4566396003,
      "node_id": "LA_kwDOC0FsAM8AAAABEC2sYw",
      "url": "https://api.github.com/repos/ledgerwatch/erigon/labels/Stale",
      "name": "Stale",
      "color": "ededed",
      "default": false,
      "description": null
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2022-10-11T06:41:17Z",
  "updated_at": "2022-11-29T02:44:05Z",
  "closed_at": "2022-11-29T02:44:05Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "#### System information\r\n\r\nErigon version: `erigon version 2022.99.99-dev-05243bb4`\r\nOS & Version: Ubuntu, 20.04 LTS\r\nErigon Commit hash: 05243bb4954e29d9de9524c056128f9f9d24073e\r\nErigon lib Commit hash: 404276494a0cae474145df2632ce75f1d5d8d032\r\n\r\n### Abstract\r\nI am using the [polygon fork](https://github.com/maticnetwork/erigon) for running some experiments on mining using a customised load bot. I have made some modifications in the `metaTx.better` function present in erigon-lib's txpool to honour the nonce as well while choosing better transaction. Also, I've increased the number of transactions to pick for mining to 1000 from 200. \r\n\r\n#### Expected behaviour\r\nWhen transactions are bombarded, we expect them to go to the pending txpool and they should be taken up for mining in next sequence of blocks. I am able to run some minimalistic low TPS single account experiments using the same setup. But, when I use somewhat high TPS multi-account load bot, there are 2 visible issues. \r\n\r\n1. Liveness of the network is affected: When the network is bombarded with multi-account transactions, at some point of time it keeps preparing same block again and again and does not make progress. There are transactions present in the pending pool at that moment. Also, we're unable to see any trigger point which might cause this. It just keeps producing same block after 50-60ms. \r\n\r\n2. Lot of transactions get into `nonce too low` error during the state transition. Basically it's trying to execute txs with low nonce where as the state already has some high nonce tx. I have confirmed that there are no duplicate transactions from same account being sent from the load bot. This might be a data race issue. \r\n\r\n#### Actual behaviour\r\nAll transactions should be included in pending pool first and eventually should be included in mining. Liveness of the network shouldn't be affected. \r\n\r\n#### Steps to reproduce the behaviour\r\n1. Setup accounts and TPS in [this loadbot](https://github.com/maticnetwork/go-loadbot). \r\n2. Use the commit hashes provided for erigon and erigon-lib. The [following](https://github.com/ledgerwatch/erigon-lib/blob/404276494a0cae474145df2632ce75f1d5d8d032/txpool/pool.go#L2196) line in `metaTx.better` function in txpool in erigon-lib has been updated and also has an additional check. \r\n```\r\n+               if mt.nonceDistance != than.nonceDistance && mt.Tx.SenderID == than.Tx.SenderID {\r\n+                       return mt.nonceDistance < than.nonceDistance\r\n+               }\r\n```\r\n3. Run using the following command: `/home/ubuntu/erigon/build/bin/erigon --chain=bor-devnet --datadir ~/.erigon/data --mine --bor.withoutheimdall --txpool.accountslots 100000 --http --http.api \"eth,txpool,debug\"`\r\n\r\nThe load bot will fund accounts initially (those txs should easily go through). When it starts sending transactions from those newly created accounts, the issues mentioned above should be visible. \r\n\r\n#### Logs\r\nhttps://gist.github.com/manav2401/b3402e225edf619749561c4b83fb370e",
  "closed_by": {
    "login": "github-actions[bot]",
    "id": 41898282,
    "node_id": "MDM6Qm90NDE4OTgyODI=",
    "avatar_url": "https://avatars.githubusercontent.com/in/15368?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/github-actions%5Bbot%5D",
    "html_url": "https://github.com/apps/github-actions",
    "followers_url": "https://api.github.com/users/github-actions%5Bbot%5D/followers",
    "following_url": "https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}",
    "gists_url": "https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/github-actions%5Bbot%5D/subscriptions",
    "organizations_url": "https://api.github.com/users/github-actions%5Bbot%5D/orgs",
    "repos_url": "https://api.github.com/users/github-actions%5Bbot%5D/repos",
    "events_url": "https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}",
    "received_events_url": "https://api.github.com/users/github-actions%5Bbot%5D/received_events",
    "type": "Bot",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5694/reactions",
    "total_count": 1,
    "+1": 1,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5694/timeline",
  "performed_via_github_app": null,
  "state_reason": "not_planned"
}
[
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1321393410",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/5694#issuecomment-1321393410",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5694",
    "id": 1321393410,
    "node_id": "IC_kwDOC0FsAM5Owt0C",
    "user": {
      "login": "github-actions[bot]",
      "id": 41898282,
      "node_id": "MDM6Qm90NDE4OTgyODI=",
      "avatar_url": "https://avatars.githubusercontent.com/in/15368?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/github-actions%5Bbot%5D",
      "html_url": "https://github.com/apps/github-actions",
      "followers_url": "https://api.github.com/users/github-actions%5Bbot%5D/followers",
      "following_url": "https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}",
      "gists_url": "https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/github-actions%5Bbot%5D/subscriptions",
      "organizations_url": "https://api.github.com/users/github-actions%5Bbot%5D/orgs",
      "repos_url": "https://api.github.com/users/github-actions%5Bbot%5D/repos",
      "events_url": "https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}",
      "received_events_url": "https://api.github.com/users/github-actions%5Bbot%5D/received_events",
      "type": "Bot",
      "site_admin": false
    },
    "created_at": "2022-11-21T03:06:58Z",
    "updated_at": "2022-11-21T03:06:58Z",
    "author_association": "NONE",
    "body": "This issue is stale because it has been open for 40 days with no activity. Remove stale label or comment, or this will be closed in 7 days.",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1321393410/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1330001923",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/5694#issuecomment-1330001923",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5694",
    "id": 1330001923,
    "node_id": "IC_kwDOC0FsAM5PRjgD",
    "user": {
      "login": "github-actions[bot]",
      "id": 41898282,
      "node_id": "MDM6Qm90NDE4OTgyODI=",
      "avatar_url": "https://avatars.githubusercontent.com/in/15368?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/github-actions%5Bbot%5D",
      "html_url": "https://github.com/apps/github-actions",
      "followers_url": "https://api.github.com/users/github-actions%5Bbot%5D/followers",
      "following_url": "https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}",
      "gists_url": "https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/github-actions%5Bbot%5D/subscriptions",
      "organizations_url": "https://api.github.com/users/github-actions%5Bbot%5D/orgs",
      "repos_url": "https://api.github.com/users/github-actions%5Bbot%5D/repos",
      "events_url": "https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}",
      "received_events_url": "https://api.github.com/users/github-actions%5Bbot%5D/received_events",
      "type": "Bot",
      "site_admin": false
    },
    "created_at": "2022-11-29T02:44:04Z",
    "updated_at": "2022-11-29T02:44:04Z",
    "author_association": "NONE",
    "body": "This issue was closed because it has been stalled for 7 days with no activity.",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1330001923/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
