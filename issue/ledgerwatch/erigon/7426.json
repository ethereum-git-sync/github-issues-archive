{
  "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/7426",
  "repository_url": "https://api.github.com/repos/ledgerwatch/erigon",
  "labels_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/7426/labels{/name}",
  "comments_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/7426/comments",
  "events_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/7426/events",
  "html_url": "https://github.com/ledgerwatch/erigon/issues/7426",
  "id": 1692766034,
  "node_id": "I_kwDOC0FsAM5k5Y9S",
  "number": 7426,
  "title": "Erigon gets killed because system is out of memory",
  "user": {
    "login": "SuchJitter",
    "id": 89609527,
    "node_id": "MDQ6VXNlcjg5NjA5NTI3",
    "avatar_url": "https://avatars.githubusercontent.com/u/89609527?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/SuchJitter",
    "html_url": "https://github.com/SuchJitter",
    "followers_url": "https://api.github.com/users/SuchJitter/followers",
    "following_url": "https://api.github.com/users/SuchJitter/following{/other_user}",
    "gists_url": "https://api.github.com/users/SuchJitter/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/SuchJitter/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/SuchJitter/subscriptions",
    "organizations_url": "https://api.github.com/users/SuchJitter/orgs",
    "repos_url": "https://api.github.com/users/SuchJitter/repos",
    "events_url": "https://api.github.com/users/SuchJitter/events{/privacy}",
    "received_events_url": "https://api.github.com/users/SuchJitter/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2023-05-02T16:55:01Z",
  "updated_at": "2023-05-15T07:53:05Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "#### System information\r\n\r\nErigon version: `2.43.0-stable-7e8beecf`\r\n\r\nOS & Version: `CentOS 8`\r\n\r\nErigon Command (with flags/config):\r\n`./erigon --chain=mainnet --datadir=/home/neweth --authrpc.jwtsecret=/opt/jwtsecret  --private.api.addr=0.0.0.0:9090  --http.addr=0.0.0.0 --ws --ws.compression=true --db.read.concurrency 100 --rpc.batch.concurrency 100 --rpc.batch.limit 100000  --http.api=eth,erigon,web3,net,debug,trace,txpool`\r\n\r\n\r\nConcensus Layer: `Prysm`\r\n\r\nConcensus Layer Command (with flags/config):\r\n`./prysm.sh beacon-chain --execution-endpoint=http://localhost:8551 --accept-terms-of-use=true --jwt-secret=/opt/jwtsecret --datadir=/home/eth2/eth2`\r\n\r\nChain/Network: `Mainnet`\r\n\r\n#### Expected behaviour\r\nRegular syncing and handling RPC requests\r\n\r\n\r\n#### Actual behaviour\r\n\r\ntripping over eth_unsubscribe function and eventually getting killed by the OS.\r\n\r\nLaunching and killing happens within 30 minutes, looks like it depends on the amount of RPC calls that happen, might have to do something with memory leaks? The machine has 64GB of ram\r\n\r\n[eth_unsubscribe errors](https://gyazo.com/45320b4e2bd1805602e07a6a94d83216)\r\n\r\n`[16499191.786140] Out of memory: Killed process 3392009 (erigon) total-vm:23337403712kB, anon-rss:55008180kB, file-rss:0kB, shmem-rss:0kB, UID:0 pgtables:2540008kB oom_score_adj:0`\r\n\r\n\r\n\r\n\r\n#### Steps to reproduce the behaviour\r\nRegular syncing and having a couple of websockets connected to the node for RPC requests\r\n\r\n#### Backtrace\r\nNone\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/7426/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/7426/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1546747941",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/7426#issuecomment-1546747941",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/7426",
    "id": 1546747941,
    "node_id": "IC_kwDOC0FsAM5cMYAl",
    "user": {
      "login": "luncht1me",
      "id": 3420404,
      "node_id": "MDQ6VXNlcjM0MjA0MDQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3420404?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/luncht1me",
      "html_url": "https://github.com/luncht1me",
      "followers_url": "https://api.github.com/users/luncht1me/followers",
      "following_url": "https://api.github.com/users/luncht1me/following{/other_user}",
      "gists_url": "https://api.github.com/users/luncht1me/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/luncht1me/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/luncht1me/subscriptions",
      "organizations_url": "https://api.github.com/users/luncht1me/orgs",
      "repos_url": "https://api.github.com/users/luncht1me/repos",
      "events_url": "https://api.github.com/users/luncht1me/events{/privacy}",
      "received_events_url": "https://api.github.com/users/luncht1me/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-13T20:54:20Z",
    "updated_at": "2023-05-13T20:54:20Z",
    "author_association": "NONE",
    "body": "I'm getting OOM kills on devel branch also, 16gb of physical RAM, 9gb Swap and swappiness value set to 10.",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1546747941/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1546775901",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/7426#issuecomment-1546775901",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/7426",
    "id": 1546775901,
    "node_id": "IC_kwDOC0FsAM5cMe1d",
    "user": {
      "login": "keithchew",
      "id": 5557929,
      "node_id": "MDQ6VXNlcjU1NTc5Mjk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5557929?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/keithchew",
      "html_url": "https://github.com/keithchew",
      "followers_url": "https://api.github.com/users/keithchew/followers",
      "following_url": "https://api.github.com/users/keithchew/following{/other_user}",
      "gists_url": "https://api.github.com/users/keithchew/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/keithchew/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/keithchew/subscriptions",
      "organizations_url": "https://api.github.com/users/keithchew/orgs",
      "repos_url": "https://api.github.com/users/keithchew/repos",
      "events_url": "https://api.github.com/users/keithchew/events{/privacy}",
      "received_events_url": "https://api.github.com/users/keithchew/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-14T00:23:56Z",
    "updated_at": "2023-05-14T00:23:56Z",
    "author_association": "NONE",
    "body": "@luncht1me I don't believe 16GB is enough, if you are on Mainnet. My node is currently running stable under 25GB for the past 3 months. On occasions it creeps close to 25GB, but not over which keeps the OOM reaper at bay.",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1546775901/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1546784957",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/7426#issuecomment-1546784957",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/7426",
    "id": 1546784957,
    "node_id": "IC_kwDOC0FsAM5cMhC9",
    "user": {
      "login": "AskAlexSharov",
      "id": 46885206,
      "node_id": "MDQ6VXNlcjQ2ODg1MjA2",
      "avatar_url": "https://avatars.githubusercontent.com/u/46885206?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AskAlexSharov",
      "html_url": "https://github.com/AskAlexSharov",
      "followers_url": "https://api.github.com/users/AskAlexSharov/followers",
      "following_url": "https://api.github.com/users/AskAlexSharov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AskAlexSharov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AskAlexSharov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AskAlexSharov/subscriptions",
      "organizations_url": "https://api.github.com/users/AskAlexSharov/orgs",
      "repos_url": "https://api.github.com/users/AskAlexSharov/repos",
      "events_url": "https://api.github.com/users/AskAlexSharov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AskAlexSharov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-14T01:37:14Z",
    "updated_at": "2023-05-14T01:37:14Z",
    "author_association": "COLLABORATOR",
    "body": "I guess you are running in Docker, we don't support cgroupsv2 ram limit detection:  https://github.com/ledgerwatch/erigon/issues/6646#issuecomment-1425157327\r\n\r\nyou can reduce RAM usage by:\r\n- a bit reduce GOMAXPROCS\r\n- try add GOGC=50\r\n- to understand where wasted RAM can do:\r\nadd flag --pprof\r\ngo tool pprof -inuse_space -png http://127.0.0.1:6060/debug/pprof/heap > mem.png\r\nshow this file\r\n- reduce a bit --batchSize\r\n- reduce a bit --bodies.cache\r\n- ",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1546784957/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1547350413",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/7426#issuecomment-1547350413",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/7426",
    "id": 1547350413,
    "node_id": "IC_kwDOC0FsAM5cOrGN",
    "user": {
      "login": "luncht1me",
      "id": 3420404,
      "node_id": "MDQ6VXNlcjM0MjA0MDQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3420404?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/luncht1me",
      "html_url": "https://github.com/luncht1me",
      "followers_url": "https://api.github.com/users/luncht1me/followers",
      "following_url": "https://api.github.com/users/luncht1me/following{/other_user}",
      "gists_url": "https://api.github.com/users/luncht1me/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/luncht1me/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/luncht1me/subscriptions",
      "organizations_url": "https://api.github.com/users/luncht1me/orgs",
      "repos_url": "https://api.github.com/users/luncht1me/repos",
      "events_url": "https://api.github.com/users/luncht1me/events{/privacy}",
      "received_events_url": "https://api.github.com/users/luncht1me/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-15T07:46:05Z",
    "updated_at": "2023-05-15T07:48:25Z",
    "author_association": "NONE",
    "body": "> don't believe 16GB is enough,\r\n\r\nI'm at 7/15 on block 14mil, I've only ran into OOM 2 or 3 times after a few days, and seems to happen when my swap is full. I had an error when I tired reducing the `batchSize` to 128M so just chillin at 256M default. It seems to work quite well until eventually an exceptionally large block hits while RAM is tapped out.\r\n\r\n\r\n> running in Docker,\r\n\r\nI'm running bare metal, Manjaro. Not running inside a docker instance. Go version is 1.20. I only have a dual core + thread so don't really want to reduce `GOMAXPROCS` from 4 to 3 since it's already a fairly limited CPU as is.\r\n\r\nI can try GOGC, that could be the problem, just GC being slightly larger than available RAM + Swap at certain large blocks. I had an IO error reducing batchSize but it may have just been a one-off and will try again. Kind of reluctant to try reducing again cause last thing I need is my db to corrupt on an IO error and throw the last 5 days out the window syncing lol. I'm soooo close.",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1547350413/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1547360176",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/7426#issuecomment-1547360176",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/7426",
    "id": 1547360176,
    "node_id": "IC_kwDOC0FsAM5cOtew",
    "user": {
      "login": "keithchew",
      "id": 5557929,
      "node_id": "MDQ6VXNlcjU1NTc5Mjk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5557929?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/keithchew",
      "html_url": "https://github.com/keithchew",
      "followers_url": "https://api.github.com/users/keithchew/followers",
      "following_url": "https://api.github.com/users/keithchew/following{/other_user}",
      "gists_url": "https://api.github.com/users/keithchew/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/keithchew/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/keithchew/subscriptions",
      "organizations_url": "https://api.github.com/users/keithchew/orgs",
      "repos_url": "https://api.github.com/users/keithchew/repos",
      "events_url": "https://api.github.com/users/keithchew/events{/privacy}",
      "received_events_url": "https://api.github.com/users/keithchew/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-15T07:51:18Z",
    "updated_at": "2023-05-15T07:53:05Z",
    "author_association": "NONE",
    "body": "hi @luncht1me I just re-read your post and didn't catch you had swap. 16GB RAM + 9GB swap is equivalent to my 25GB RAM. Mine has been running solid without OOM, but with these settings:\r\n```\r\nGOGC=50\r\nGOMEMLIMIT=6000MiB\r\nGOMAXPROCS=2\r\n```\r\nI used to have GOMAXPROCS=4, but have reduced it lately to 2 (after changing from internal CL to Prysm) which is enough for my setup.\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1547360176/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
