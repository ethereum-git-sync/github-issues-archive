{
  "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5294",
  "repository_url": "https://api.github.com/repos/ledgerwatch/erigon",
  "labels_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5294/labels{/name}",
  "comments_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5294/comments",
  "events_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5294/events",
  "html_url": "https://github.com/ledgerwatch/erigon/issues/5294",
  "id": 1363458820,
  "node_id": "I_kwDOC0FsAM5RRLsE",
  "number": 5294,
  "title": "[2022.09.01] Killed Due To Memory Leak with History v2 Enabled",
  "user": {
    "login": "Texnomic",
    "id": 1648586,
    "node_id": "MDQ6VXNlcjE2NDg1ODY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1648586?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Texnomic",
    "html_url": "https://github.com/Texnomic",
    "followers_url": "https://api.github.com/users/Texnomic/followers",
    "following_url": "https://api.github.com/users/Texnomic/following{/other_user}",
    "gists_url": "https://api.github.com/users/Texnomic/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Texnomic/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Texnomic/subscriptions",
    "organizations_url": "https://api.github.com/users/Texnomic/orgs",
    "repos_url": "https://api.github.com/users/Texnomic/repos",
    "events_url": "https://api.github.com/users/Texnomic/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Texnomic/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2022-09-06T15:24:36Z",
  "updated_at": "2022-09-07T05:14:34Z",
  "closed_at": "2022-09-07T05:14:34Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "#### System information\r\n\r\nErigon version: `erigon version 2022.09.1-alpha-4067b7c4`\r\n\r\nOS & Version: `Linux ethereum-erigon 5.4.0-125-generic #141-Ubuntu SMP Wed Aug 10 13:42:03 UTC 2022 x86_64 x86_64 x86_64 GNU/Linux`\r\n\r\n#### Expected behaviour\r\n\r\nMemory Usage Around **16 GB** in `v2022.09.01` with History v2 `disabled`.\r\n\r\n#### Actual behaviour\r\n\r\nMemory Usage Beyond **49 GB** in `v2022.09.01` with History v2 `enabled`.\r\n\r\n#### Steps to reproduce the behaviour\r\n\r\n### Notes\r\n\r\nBoth Use The Same Exact Yaml File with Exception Of `history.v2` Flag.\r\n\r\n### YAML Config \r\n\r\n````yaml\r\n# -----------------\r\n# Basics\r\n# -----------------\r\nchain: \"mainnet\"\r\ndatadir: \"/mnt/data\"\r\nhttp.api: \"eth,erigon,engine,web3,net,debug,trace,txpool,db,parity\"\r\nnat: \"any\"\r\nstaticpeers: \"enode://<SNIP>\"\r\n\r\n# -----------------\r\n# Memory Pool\r\n# -----------------\r\ntxpool.globalslots: \"1000000\"\r\ntxpool.globalbasefeeslots: \"1000000\"\r\ntxpool.globalqueue: \"1000000\"\r\ntxpool.lifetime: \"720h\"\r\nmaxpeers: \"200\"\r\n\r\n# -----------------\r\n# Downloader\r\n# -----------------\r\ntorrent.maxpeers: \"1\"\r\ntorrent.upload.rate: \"1kb\"\r\ntorrent.download.rate: \"1mb\"\r\n\r\n# -----------------\r\n# IPs\r\n# -----------------\r\nauthrpc.addr: \"0.0.0.0\"\r\nmetrics.addr: \"0.0.0.0\"\r\nprivate.api.addr: \"0.0.0.0:9090\"\r\npprof.addr: \"0.0.0.0\"\r\nhttp.addr: \"0.0.0.0\"\r\n\r\n# -----------------\r\n# Ports\r\n# -----------------\r\nport: \"30303\"\r\nhttp.port: \"8545\"\r\nauthrpc.port: \"8551\"\r\npprof.port: \"6060\"\r\nmetrics.port: \"6070\"\r\n\r\n# -----------------\r\n# Hosts\r\n# -----------------\r\nhttp.vhosts: \"*\"\r\nauthrpc.vhosts: \"*\"\r\nhttp.corsdomain: \"*\"\r\n\r\n# -----------------\r\n# Flags\r\n# -----------------\r\nhistory.v2: \"true\"\r\nwatch-the-burn: \"true\"\r\nmetrics: \"true\"\r\nmetrics.expensive: \"true\"\r\npprof: \"true\"\r\nws: \"true\"\r\nhttp: \"true\"\r\nsnapshots: \"true\"\r\nno-downloader: \"false\"\r\nhealthcheck: \"true\"\r\nhttp.compression: \"true\"\r\nhttp.trace: \"true\"\r\nv5disc: \"true\"\r\n````\r\n### Logs\r\n\r\n````zsh\r\n/home/texnomic/erigon/build/bin/erigon --config /mnt/data/Erigon.yaml\r\n\r\nINFO[09-06|16:52:53.372] Build info                               git_branch=HEAD git_tag=v2022.09.01 git_commit=4067b7c4da6c5d741d3027d95ae2afdf6b7a943a\r\nINFO[09-06|16:52:53.405] Starting Erigon on Ethereum mainnet...\r\nINFO[09-06|16:52:53.411] Maximum peer count                       ETH=200 total=200\r\nINFO[09-06|16:52:53.412] starting HTTP APIs                       APIs=eth,erigon,engine,web3,net,debug,trace,txpool,db,parity\r\nINFO[09-06|16:52:53.413] torrent verbosity                        level=WRN\r\nINFO[09-06|16:52:55.517] Set global gas cap                       cap=50000000\r\nINFO[09-06|16:52:55.700] Opening Database                         label=chaindata path=/mnt/data/chaindata\r\nINFO[09-06|16:52:55.719] Initialised chain configuration          config=\"{ChainID: 1, Homestead: 1150000, DAO: 1920000, DAO Support: true, Tangerine Whistle: 2463000, Spurious Dragon: 2675000, Byzantium: 4370000, Constantinople: 7280000, Petersburg: 7280000, Istanbul: 9069000, Muir Glacier: 9200000, Berlin: 12244000, London: 12965000, Arrow Glacier: 13773000, Gray Glacier: 15050000, Terminal Total Difficulty: 58750000000000000000000, Merge Netsplit: <nil>, Shanghai: <nil>, Cancun: <nil>, Engine: ethash}\" genesis=0xd4e56740f876aef8c010b86a40d5f56745a118d0906a34e69aec8c0db1cb8fa3\r\nINFO[09-06|16:52:55.720] Effective                                prune_flags= snapshot_flags=\"--snapshots=true\" history.v2=true\r\nINFO[09-06|16:53:00.493] Initialising Ethereum protocol           network=1\r\nINFO[09-06|16:53:00.493] Disk storage enabled for ethash DAGs     dir=/mnt/data/ethash-dags count=2\r\nINFO[09-06|16:53:06.525] Starting private RPC server              on=0.0.0.0:9090\r\nINFO[09-06|16:53:06.525] new subscription to logs established\r\nINFO[09-06|16:53:06.525] rpc filters: subscribing to Erigon events\r\nINFO[09-06|16:53:06.526] New txs subscriber joined\r\nINFO[09-06|16:53:06.526] new subscription to newHeaders established\r\nINFO[09-06|16:53:06.528] Reading JWT secret                       path=/mnt/data/jwt.hex\r\nINFO[09-06|16:53:06.529] HTTP endpoint opened for Engine API      url=0.0.0.0:8551 ws=true ws.compression=true\r\nINFO[09-06|16:53:06.530] HTTP endpoint opened                     url=0.0.0.0:8545 ws=true ws.compression=true grpc=false\r\nINFO[09-06|16:53:06.547] [Snapshots] Fetching torrent files metadata\r\nINFO[09-06|16:53:06.621] Started P2P networking                   version=66 self=enode://9f506ac130465425c71014d34f9f3fde6b077b7048e72c74d470ed08bc11585cce0a24ab0eb31f2ec9f92271e88400f0147cb5644afb5415c302882cfe228995@127.0.0.1:30303 name=erigon/v2022.09.1-alpha-4067b7c4/linux-amd64/go1.18.3\r\nINFO[09-06|16:53:33.166] [Snapshots] Stat                         blocks=15310k indices=15310k alloc=2.7GB sys=2.9GB\r\nINFO[09-06|16:53:33.167] [1/15 Headers] Waiting for headers...    from=15484590\r\nINFO[09-06|16:53:36.194] Generating ethash verification cache     epoch=516 percentage=53 elapsed=3.001s\r\nINFO[09-06|16:53:39.052] Generated ethash verification cache      epoch=516 elapsed=5.858s\r\nINFO[09-06|16:53:39.739] Estimated to reaching TTD                blocks=52043\r\nINFO[09-06|16:53:40.461] Estimated to reaching TTD                blocks=52013\r\nINFO[09-06|16:53:42.055] Generating ethash verification cache     epoch=517 percentage=47 elapsed=3.000s\r\nINFO[09-06|16:53:45.056] Generating ethash verification cache     epoch=517 percentage=80 elapsed=6.001s\r\nINFO[09-06|16:53:45.069] Estimated to reaching TTD                blocks=52011\r\nINFO[09-06|16:53:45.074] [1/15 Headers] Processed                 highest inserted=15484736 age=27s\r\nINFO[09-06|16:53:45.182] [4/15 Bodies] Processing bodies...       from=15484590 to=15484736\r\nINFO[09-06|16:53:46.248] Generated ethash verification cache      epoch=517 elapsed=7.193s\r\nINFO[09-06|16:53:58.724] [4/15 Bodies] Processed                  highest=15484736\r\nINFO[09-06|16:53:58.724] [5/15 Senders] Started                   from=15484590 to=15484736\r\nINFO[09-06|16:54:00.146] [6/15 Execution] Blocks execution        from=15051019 to=15484736\r\nINFO[09-06|16:55:00.395] [p2p] GoodPeers                          eth66=3\r\nINFO[09-06|16:57:00.395] [p2p] GoodPeers                          eth66=4\r\nINFO[09-06|16:57:52.433] [txpool] Started\r\nINFO[09-06|16:57:53.173] [txpool] stat                            block=15484590 pending=257979 baseFee=0 queued=581638 alloc=12.6GB sys=13.4GB\r\nINFO[09-06|16:58:06.528] [txpool] stat                            block=15484590 pending=257966 baseFee=0 queued=581877 alloc=10.7GB sys=13.7GB\r\nINFO[09-06|16:59:00.396] [p2p] GoodPeers                          eth66=4\r\nINFO[09-06|16:59:07.068] [txpool] stat                            block=15484590 pending=257947 baseFee=0 queued=582505 alloc=13.5GB sys=14.4GB\r\nINFO[09-06|17:00:06.643] [txpool] stat                            block=15484590 pending=257929 baseFee=0 queued=583237 alloc=13.9GB sys=16.8GB\r\nINFO[09-06|17:01:00.395] [p2p] GoodPeers                          eth66=4\r\nINFO[09-06|17:01:06.626] [txpool] stat                            block=15484590 pending=257915 baseFee=0 queued=583903 alloc=16.3GB sys=17.4GB\r\nINFO[09-06|17:02:06.532] [txpool] stat                            block=15484590 pending=257913 baseFee=0 queued=584366 alloc=18.6GB sys=19.8GB\r\nINFO[09-06|17:03:00.395] [p2p] GoodPeers                          eth66=4\r\nINFO[09-06|17:03:06.547] [txpool] stat                            block=15484590 pending=257883 baseFee=0 queued=584839 alloc=19.6GB sys=20.8GB\r\nINFO[09-06|17:04:06.552] [txpool] stat                            block=15484590 pending=257873 baseFee=0 queued=585310 alloc=22.3GB sys=23.6GB\r\nINFO[09-06|17:05:00.395] [p2p] GoodPeers                          eth66=4\r\nINFO[09-06|17:05:07.072] [txpool] stat                            block=15484590 pending=257867 baseFee=0 queued=585709 alloc=23.5GB sys=25.3GB\r\nINFO[09-06|17:06:07.119] [txpool] stat                            block=15484590 pending=257854 baseFee=0 queued=586174 alloc=26.0GB sys=27.6GB\r\nINFO[09-06|17:07:00.395] [p2p] GoodPeers                          eth66=4\r\nINFO[09-06|17:07:06.698] [txpool] stat                            block=15484590 pending=257846 baseFee=0 queued=586614 alloc=26.2GB sys=28.4GB\r\nINFO[09-06|17:08:21.953] [txpool] stat                            block=15484590 pending=257835 baseFee=0 queued=587201 alloc=29.4GB sys=31.2GB\r\nINFO[09-06|17:09:00.395] [p2p] GoodPeers                          eth66=4\r\nINFO[09-06|17:09:06.552] [txpool] stat                            block=15484590 pending=257824 baseFee=0 queued=587678 alloc=29.4GB sys=32.0GB\r\nINFO[09-06|17:10:06.601] [txpool] stat                            block=15484590 pending=257820 baseFee=0 queued=588154 alloc=31.8GB sys=33.8GB\r\nINFO[09-06|17:11:00.395] [p2p] GoodPeers                          eth66=4\r\nINFO[09-06|17:11:06.716] [txpool] stat                            block=15484590 pending=257803 baseFee=0 queued=588587 alloc=32.3GB sys=35.3GB\r\nINFO[09-06|17:12:06.594] [txpool] stat                            block=15484590 pending=257798 baseFee=0 queued=588970 alloc=34.7GB sys=36.8GB\r\nINFO[09-06|17:13:00.395] [p2p] GoodPeers                          eth66=4\r\nINFO[09-06|17:13:06.546] [txpool] stat                            block=15484590 pending=257780 baseFee=0 queued=589429 alloc=35.2GB sys=38.8GB\r\nINFO[09-06|17:14:07.164] [txpool] stat                            block=15484590 pending=257773 baseFee=0 queued=589844 alloc=38.5GB sys=40.9GB\r\nINFO[09-06|17:15:00.404] [p2p] GoodPeers                          eth66=4\r\nINFO[09-06|17:15:06.533] [txpool] stat                            block=15484590 pending=257770 baseFee=0 queued=590212 alloc=40.5GB sys=43.0GB\r\nINFO[09-06|17:16:06.549] [txpool] stat                            block=15484590 pending=257736 baseFee=0 queued=590687 alloc=41.7GB sys=44.8GB\r\nINFO[09-06|17:17:00.395] [p2p] GoodPeers                          eth66=5\r\nINFO[09-06|17:17:07.142] [txpool] stat                            block=15484590 pending=257730 baseFee=0 queued=591073 alloc=44.5GB sys=47.2GB\r\nINFO[09-06|17:18:06.652] [txpool] stat                            block=15484590 pending=257717 baseFee=0 queued=591527 alloc=45.1GB sys=48.4GB\r\nINFO[09-06|17:19:00.398] [p2p] GoodPeers                          eth66=5\r\nINFO[09-06|17:19:06.530] [txpool] stat                            block=15484590 pending=257715 baseFee=0 queued=591903 alloc=47.8GB sys=50.8GB\r\nINFO[09-06|17:20:06.667] [txpool] stat                            block=15484590 pending=257701 baseFee=0 queued=592315 alloc=49.6GB sys=52.7GB\r\nINFO[09-06|17:21:00.420] [p2p] GoodPeers                          eth66=5\r\nINFO[09-06|17:21:09.977] [txpool] stat                            block=15484590 pending=257690 baseFee=0 queued=592746 alloc=51.3GB sys=54.5GB\r\nINFO[09-06|17:22:06.542] [txpool] stat                            block=15484590 pending=257689 baseFee=0 queued=592774 alloc=52.6GB sys=55.9GB\r\nINFO[09-06|17:23:00.540] [p2p] GoodPeers                          eth66=7\r\n[1]    377846 killed     /home/texnomic/erigon/build/bin/erigon --config /mnt/data/Erigon.yaml\r\n\r\n````\r\n\r\n\r\n",
  "closed_by": {
    "login": "AskAlexSharov",
    "id": 46885206,
    "node_id": "MDQ6VXNlcjQ2ODg1MjA2",
    "avatar_url": "https://avatars.githubusercontent.com/u/46885206?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/AskAlexSharov",
    "html_url": "https://github.com/AskAlexSharov",
    "followers_url": "https://api.github.com/users/AskAlexSharov/followers",
    "following_url": "https://api.github.com/users/AskAlexSharov/following{/other_user}",
    "gists_url": "https://api.github.com/users/AskAlexSharov/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/AskAlexSharov/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/AskAlexSharov/subscriptions",
    "organizations_url": "https://api.github.com/users/AskAlexSharov/orgs",
    "repos_url": "https://api.github.com/users/AskAlexSharov/repos",
    "events_url": "https://api.github.com/users/AskAlexSharov/events{/privacy}",
    "received_events_url": "https://api.github.com/users/AskAlexSharov/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5294/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5294/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1238916452",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/5294#issuecomment-1238916452",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5294",
    "id": 1238916452,
    "node_id": "IC_kwDOC0FsAM5J2F1k",
    "user": {
      "login": "AskAlexSharov",
      "id": 46885206,
      "node_id": "MDQ6VXNlcjQ2ODg1MjA2",
      "avatar_url": "https://avatars.githubusercontent.com/u/46885206?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AskAlexSharov",
      "html_url": "https://github.com/AskAlexSharov",
      "followers_url": "https://api.github.com/users/AskAlexSharov/followers",
      "following_url": "https://api.github.com/users/AskAlexSharov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AskAlexSharov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AskAlexSharov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AskAlexSharov/subscriptions",
      "organizations_url": "https://api.github.com/users/AskAlexSharov/orgs",
      "repos_url": "https://api.github.com/users/AskAlexSharov/repos",
      "events_url": "https://api.github.com/users/AskAlexSharov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AskAlexSharov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-07T05:14:34Z",
    "updated_at": "2022-09-07T05:14:34Z",
    "author_association": "COLLABORATOR",
    "body": "thank you, but I really don't recommend you use --history.v2 flag. I will rename it to --experimental.history.v2",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1238916452/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
