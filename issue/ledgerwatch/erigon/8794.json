{
  "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/8794",
  "repository_url": "https://api.github.com/repos/ledgerwatch/erigon",
  "labels_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/8794/labels{/name}",
  "comments_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/8794/comments",
  "events_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/8794/events",
  "html_url": "https://github.com/ledgerwatch/erigon/issues/8794",
  "id": 2002189869,
  "node_id": "I_kwDOC0FsAM53Vv4t",
  "number": 8794,
  "title": "Memory Leak when doing normal RPC calls to node",
  "user": {
    "login": "chromafunk",
    "id": 3601695,
    "node_id": "MDQ6VXNlcjM2MDE2OTU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3601695?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/chromafunk",
    "html_url": "https://github.com/chromafunk",
    "followers_url": "https://api.github.com/users/chromafunk/followers",
    "following_url": "https://api.github.com/users/chromafunk/following{/other_user}",
    "gists_url": "https://api.github.com/users/chromafunk/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/chromafunk/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/chromafunk/subscriptions",
    "organizations_url": "https://api.github.com/users/chromafunk/orgs",
    "repos_url": "https://api.github.com/users/chromafunk/repos",
    "events_url": "https://api.github.com/users/chromafunk/events{/privacy}",
    "received_events_url": "https://api.github.com/users/chromafunk/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 6,
  "created_at": "2023-11-20T13:16:49Z",
  "updated_at": "2023-11-22T10:14:07Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "#### System information\r\n\r\nErigon version: `./erigon --version`\r\n\r\nerigon version 2.54.0-aeec5221\r\n\r\nOS & Version: Windows/Linux/OSX\r\n\r\nLinux\r\n\r\nCommit hash: \r\n\r\naeec5221\r\n\r\nErigon Command (with flags/config):\r\n\r\n./erigon/build/bin/erigon --datadir mainnet_data --http --http.addr 192.168.1.69 --http.port 8545 --ws --torrent.download.rate=60mb --authrpc.jwtsecret=/home/funk/crucialp5/prysm/jwt.hex --authrpc.addr=0.0.0.0 --authrpc.vhosts=*\r\n\r\nConsensus Layer:\r\n\r\nprysm\r\n\r\nConsensus Layer Command (with flags/config):\r\n\r\n./prysm.sh beacon-chain --execution-endpoint=http://192.168.1.69:8551 --suggested-fee-recipient=0xEa6D2a732700B387BCD259AE2d25805E3fa1b9BE --checkpoint-sync-url=https://beaconstate.ethstaker.cc/ -genesis-beacon-api-url=https://beaconstate.ethstaker.cc/ --jwt-secret=jwt.hex\r\n\r\nChain/Network: \r\n\r\nEthereum\r\n\r\n#### Expected behaviour\r\n\r\nI have a client API that I developed in Geth and worked just fine. Decided to move to Erigon for archive node. When it startup, it collects data from factories and instantiates pair objects, and does things like update reserves, in goroutines. The expected behaviour is that it runs just like it did with Geth, where I collect data in parallel and then I do statistic operations with it. Since Erigon doesn't seem to support IPC sockets, I have configured the connection to the node via websockets.\r\n\r\n#### Actual behaviour\r\nErigon starts taking more and more RAM until the server starts swapping and gets rendered unusable. Since it works with a full Geth node, I wonder what would be the cause of this, and if maybe it's been fixed in some devel branch commit.\r\n\r\n#### Steps to reproduce the behaviour\r\nMaybe just try to get the reserves of 3K pairs or more in a go-routine, or something similar ( heavy parallel calls ) \r\nAnd also, subscribe to events of 3-5K pairs or more\r\n\r\n#### Backtrace\r\n\r\n````\r\n[backtrace]\r\n````\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/8794/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/8794/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1819161350",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/8794#issuecomment-1819161350",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/8794",
    "id": 1819161350,
    "node_id": "IC_kwDOC0FsAM5sbjMG",
    "user": {
      "login": "AskAlexSharov",
      "id": 46885206,
      "node_id": "MDQ6VXNlcjQ2ODg1MjA2",
      "avatar_url": "https://avatars.githubusercontent.com/u/46885206?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AskAlexSharov",
      "html_url": "https://github.com/AskAlexSharov",
      "followers_url": "https://api.github.com/users/AskAlexSharov/followers",
      "following_url": "https://api.github.com/users/AskAlexSharov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AskAlexSharov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AskAlexSharov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AskAlexSharov/subscriptions",
      "organizations_url": "https://api.github.com/users/AskAlexSharov/orgs",
      "repos_url": "https://api.github.com/users/AskAlexSharov/repos",
      "events_url": "https://api.github.com/users/AskAlexSharov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AskAlexSharov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-11-20T14:23:20Z",
    "updated_at": "2023-11-20T14:23:27Z",
    "author_association": "COLLABORATOR",
    "body": "IPC - does support - see last release notes\r\n\r\nCan see where leaking ram by: add `--pprof` flag \r\nrun `go tool pprof -inuse_space -png http://127.0.0.1:6060/debug/pprof/heap > mem.png` and share picture.\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1819161350/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1819526990",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/8794#issuecomment-1819526990",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/8794",
    "id": 1819526990,
    "node_id": "IC_kwDOC0FsAM5sc8dO",
    "user": {
      "login": "chromafunk",
      "id": 3601695,
      "node_id": "MDQ6VXNlcjM2MDE2OTU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3601695?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chromafunk",
      "html_url": "https://github.com/chromafunk",
      "followers_url": "https://api.github.com/users/chromafunk/followers",
      "following_url": "https://api.github.com/users/chromafunk/following{/other_user}",
      "gists_url": "https://api.github.com/users/chromafunk/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chromafunk/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chromafunk/subscriptions",
      "organizations_url": "https://api.github.com/users/chromafunk/orgs",
      "repos_url": "https://api.github.com/users/chromafunk/repos",
      "events_url": "https://api.github.com/users/chromafunk/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chromafunk/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-11-20T17:40:47Z",
    "updated_at": "2023-11-20T17:42:52Z",
    "author_association": "NONE",
    "body": "when I took this, it has taken like 40 GB RAM and kept on going non-stop. I can only stop the crash If I shutdown Erigon![image](https://github.com/ledgerwatch/erigon/assets/3601695/5e202f18-c0c1-4a20-858c-af8bd2dae100)\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1819526990/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1820707619",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/8794#issuecomment-1820707619",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/8794",
    "id": 1820707619,
    "node_id": "IC_kwDOC0FsAM5shcsj",
    "user": {
      "login": "chromafunk",
      "id": 3601695,
      "node_id": "MDQ6VXNlcjM2MDE2OTU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3601695?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chromafunk",
      "html_url": "https://github.com/chromafunk",
      "followers_url": "https://api.github.com/users/chromafunk/followers",
      "following_url": "https://api.github.com/users/chromafunk/following{/other_user}",
      "gists_url": "https://api.github.com/users/chromafunk/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chromafunk/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chromafunk/subscriptions",
      "organizations_url": "https://api.github.com/users/chromafunk/orgs",
      "repos_url": "https://api.github.com/users/chromafunk/repos",
      "events_url": "https://api.github.com/users/chromafunk/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chromafunk/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-11-21T11:08:20Z",
    "updated_at": "2023-11-21T11:09:27Z",
    "author_association": "NONE",
    "body": "I saw in some other issue that there are problems with eth_newFilter, is it possible that it comes from there ? Is this bug already identified ? If so, is there any patch for it ? I'm using autogenerated bindings for the event subscription. Can I circumvent this by avoiding the autogen bindings maybe ?",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1820707619/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1820954378",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/8794#issuecomment-1820954378",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/8794",
    "id": 1820954378,
    "node_id": "IC_kwDOC0FsAM5siY8K",
    "user": {
      "login": "chromafunk",
      "id": 3601695,
      "node_id": "MDQ6VXNlcjM2MDE2OTU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3601695?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chromafunk",
      "html_url": "https://github.com/chromafunk",
      "followers_url": "https://api.github.com/users/chromafunk/followers",
      "following_url": "https://api.github.com/users/chromafunk/following{/other_user}",
      "gists_url": "https://api.github.com/users/chromafunk/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chromafunk/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chromafunk/subscriptions",
      "organizations_url": "https://api.github.com/users/chromafunk/orgs",
      "repos_url": "https://api.github.com/users/chromafunk/repos",
      "events_url": "https://api.github.com/users/chromafunk/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chromafunk/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-11-21T13:44:44Z",
    "updated_at": "2023-11-21T13:50:16Z",
    "author_association": "NONE",
    "body": "update : this only happens with event receivers. I have receivers for Mint, Burn Sync, Swap, Transfer. To test further, I have first tested without receivers which yields zero problems. After that I have activated only Syncs. The same happens, it takes way too much RAM at initialization, but then, interestingly it gets almost completely garbage collected and it goes back to normal. So the problem seems to be at the initialization only, but gets aggravated by having more types of receivers. So, it does some crazy allocation ( which doesn't happen in geth ) and then it gets garbage collected. This is still a problem, because you might need 1TB of RAM just to initialize 100K receivers or so",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1820954378/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1821151222",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/8794#issuecomment-1821151222",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/8794",
    "id": 1821151222,
    "node_id": "IC_kwDOC0FsAM5sjI_2",
    "user": {
      "login": "AskAlexSharov",
      "id": 46885206,
      "node_id": "MDQ6VXNlcjQ2ODg1MjA2",
      "avatar_url": "https://avatars.githubusercontent.com/u/46885206?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AskAlexSharov",
      "html_url": "https://github.com/AskAlexSharov",
      "followers_url": "https://api.github.com/users/AskAlexSharov/followers",
      "following_url": "https://api.github.com/users/AskAlexSharov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AskAlexSharov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AskAlexSharov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AskAlexSharov/subscriptions",
      "organizations_url": "https://api.github.com/users/AskAlexSharov/orgs",
      "repos_url": "https://api.github.com/users/AskAlexSharov/repos",
      "events_url": "https://api.github.com/users/AskAlexSharov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AskAlexSharov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-11-21T15:30:34Z",
    "updated_at": "2023-11-21T15:30:34Z",
    "author_association": "COLLABORATOR",
    "body": "Let’s do: \r\ngo tool pprof -inuse_space -png -lines -focus=SubscribeLogs http://127.0.0.1:6060/debug/pprof/heap > mem.png",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1821151222/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1822475291",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/8794#issuecomment-1822475291",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/8794",
    "id": 1822475291,
    "node_id": "IC_kwDOC0FsAM5soMQb",
    "user": {
      "login": "chromafunk",
      "id": 3601695,
      "node_id": "MDQ6VXNlcjM2MDE2OTU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3601695?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chromafunk",
      "html_url": "https://github.com/chromafunk",
      "followers_url": "https://api.github.com/users/chromafunk/followers",
      "following_url": "https://api.github.com/users/chromafunk/following{/other_user}",
      "gists_url": "https://api.github.com/users/chromafunk/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chromafunk/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chromafunk/subscriptions",
      "organizations_url": "https://api.github.com/users/chromafunk/orgs",
      "repos_url": "https://api.github.com/users/chromafunk/repos",
      "events_url": "https://api.github.com/users/chromafunk/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chromafunk/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-11-22T10:14:06Z",
    "updated_at": "2023-11-22T10:14:06Z",
    "author_association": "NONE",
    "body": "![image](https://github.com/ledgerwatch/erigon/assets/3601695/4b4fce93-d5a4-4cbb-9a16-bd52ccaa6a2a)\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1822475291/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
