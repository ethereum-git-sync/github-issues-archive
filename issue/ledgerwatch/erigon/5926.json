{
  "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5926",
  "repository_url": "https://api.github.com/repos/ledgerwatch/erigon",
  "labels_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5926/labels{/name}",
  "comments_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5926/comments",
  "events_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5926/events",
  "html_url": "https://github.com/ledgerwatch/erigon/issues/5926",
  "id": 1431178732,
  "node_id": "I_kwDOC0FsAM5VTg3s",
  "number": 5926,
  "title": "EIP-3860 changes to txpool",
  "user": {
    "login": "yperbasis",
    "id": 34320705,
    "node_id": "MDQ6VXNlcjM0MzIwNzA1",
    "avatar_url": "https://avatars.githubusercontent.com/u/34320705?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/yperbasis",
    "html_url": "https://github.com/yperbasis",
    "followers_url": "https://api.github.com/users/yperbasis/followers",
    "following_url": "https://api.github.com/users/yperbasis/following{/other_user}",
    "gists_url": "https://api.github.com/users/yperbasis/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/yperbasis/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/yperbasis/subscriptions",
    "organizations_url": "https://api.github.com/users/yperbasis/orgs",
    "repos_url": "https://api.github.com/users/yperbasis/repos",
    "events_url": "https://api.github.com/users/yperbasis/events{/privacy}",
    "received_events_url": "https://api.github.com/users/yperbasis/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 4667387573,
      "node_id": "LA_kwDOC0FsAM8AAAABFjKutQ",
      "url": "https://api.github.com/repos/ledgerwatch/erigon/labels/shapella",
      "name": "shapella",
      "color": "bfdadc",
      "default": false,
      "description": "The Shanghai/Capella protocol upgrade"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "hexoscott",
    "id": 70711990,
    "node_id": "MDQ6VXNlcjcwNzExOTkw",
    "avatar_url": "https://avatars.githubusercontent.com/u/70711990?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/hexoscott",
    "html_url": "https://github.com/hexoscott",
    "followers_url": "https://api.github.com/users/hexoscott/followers",
    "following_url": "https://api.github.com/users/hexoscott/following{/other_user}",
    "gists_url": "https://api.github.com/users/hexoscott/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/hexoscott/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/hexoscott/subscriptions",
    "organizations_url": "https://api.github.com/users/hexoscott/orgs",
    "repos_url": "https://api.github.com/users/hexoscott/repos",
    "events_url": "https://api.github.com/users/hexoscott/events{/privacy}",
    "received_events_url": "https://api.github.com/users/hexoscott/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "hexoscott",
      "id": 70711990,
      "node_id": "MDQ6VXNlcjcwNzExOTkw",
      "avatar_url": "https://avatars.githubusercontent.com/u/70711990?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hexoscott",
      "html_url": "https://github.com/hexoscott",
      "followers_url": "https://api.github.com/users/hexoscott/followers",
      "following_url": "https://api.github.com/users/hexoscott/following{/other_user}",
      "gists_url": "https://api.github.com/users/hexoscott/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hexoscott/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hexoscott/subscriptions",
      "organizations_url": "https://api.github.com/users/hexoscott/orgs",
      "repos_url": "https://api.github.com/users/hexoscott/repos",
      "events_url": "https://api.github.com/users/hexoscott/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hexoscott/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2022-11-01T10:06:52Z",
  "updated_at": "2023-01-17T11:07:58Z",
  "closed_at": "2023-01-17T11:07:58Z",
  "author_association": "COLLABORATOR",
  "active_lock_reason": null,
  "body": "PR #5892 implemented most of [EIP-3860](https://eips.ethereum.org/EIPS/eip-3860): \"Limit and meter initcode\", but it didn't cover txpool. Basically we need to somehow let txpool know whether a block is post-Shanghai (timestamp >= `ShanghaiTime`) or not, and, if post-Shanghai, reject transactions violating Rule 1 of EIP-3860 as invalid. Also update the intrinsic gas calculation in txpool according to Rule 2 (copy the `IntrinsicGas` changes from PR #5892 to txpool in erigon-lib) for post-Shanghai transactions.\r\n\r\nQuestion: Anything else we need to change in erigon-lib for EIP-3860?",
  "closed_by": {
    "login": "hexoscott",
    "id": 70711990,
    "node_id": "MDQ6VXNlcjcwNzExOTkw",
    "avatar_url": "https://avatars.githubusercontent.com/u/70711990?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/hexoscott",
    "html_url": "https://github.com/hexoscott",
    "followers_url": "https://api.github.com/users/hexoscott/followers",
    "following_url": "https://api.github.com/users/hexoscott/following{/other_user}",
    "gists_url": "https://api.github.com/users/hexoscott/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/hexoscott/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/hexoscott/subscriptions",
    "organizations_url": "https://api.github.com/users/hexoscott/orgs",
    "repos_url": "https://api.github.com/users/hexoscott/repos",
    "events_url": "https://api.github.com/users/hexoscott/events{/privacy}",
    "received_events_url": "https://api.github.com/users/hexoscott/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5926/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5926/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1384096155",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/5926#issuecomment-1384096155",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5926",
    "id": 1384096155,
    "node_id": "IC_kwDOC0FsAM5Sf6Gb",
    "user": {
      "login": "yperbasis",
      "id": 34320705,
      "node_id": "MDQ6VXNlcjM0MzIwNzA1",
      "avatar_url": "https://avatars.githubusercontent.com/u/34320705?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/yperbasis",
      "html_url": "https://github.com/yperbasis",
      "followers_url": "https://api.github.com/users/yperbasis/followers",
      "following_url": "https://api.github.com/users/yperbasis/following{/other_user}",
      "gists_url": "https://api.github.com/users/yperbasis/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/yperbasis/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/yperbasis/subscriptions",
      "organizations_url": "https://api.github.com/users/yperbasis/orgs",
      "repos_url": "https://api.github.com/users/yperbasis/repos",
      "events_url": "https://api.github.com/users/yperbasis/events{/privacy}",
      "received_events_url": "https://api.github.com/users/yperbasis/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-01-16T13:55:44Z",
    "updated_at": "2023-01-16T13:56:00Z",
    "author_association": "COLLABORATOR",
    "body": "Also please note the following issue [raised](https://discord.com/channels/595666850260713488/745077610685661265/1064537000595689542) by Marius:\r\n\r\nI just found a pretty nasty edge case wrt. 3860 (Max init code size).\r\nI send a bunch of handcrafted interesting transactions to my node, and the \r\ntransactions got stuck all the time. After the 20th time (I know) I decided to investigate.\r\nThe issue was that transactions with initdata > MaxInitCodeSize were not rejected by \r\nthe transaction pool. They would be rejected by nodes executing them, but not by the txpool.\r\nThis could've been used to flood a txpool with unexecutable transactions.\r\nSince they are valid looking, they would be propagated to peers and stay in the mempool.\r\nSo it would be great if all EL teams could check that their txpool rejects transactions\r\nwhere the transaction is a contract creation and the tx.data exceeds maxInitCodeSize.\r\nI've pushed my fuzzer here: https://github.com/MariusVanDerWijden/tx-fuzz/tree/mutator,\r\ncmd/shanghai/shanghai can be used to send a bunch of transactions. Just make sure that \r\nthe cycle runs a few times and no transactions are stuck.",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1384096155/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1384123424",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/5926#issuecomment-1384123424",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/5926",
    "id": 1384123424,
    "node_id": "IC_kwDOC0FsAM5SgAwg",
    "user": {
      "login": "hexoscott",
      "id": 70711990,
      "node_id": "MDQ6VXNlcjcwNzExOTkw",
      "avatar_url": "https://avatars.githubusercontent.com/u/70711990?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hexoscott",
      "html_url": "https://github.com/hexoscott",
      "followers_url": "https://api.github.com/users/hexoscott/followers",
      "following_url": "https://api.github.com/users/hexoscott/following{/other_user}",
      "gists_url": "https://api.github.com/users/hexoscott/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hexoscott/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hexoscott/subscriptions",
      "organizations_url": "https://api.github.com/users/hexoscott/orgs",
      "repos_url": "https://api.github.com/users/hexoscott/repos",
      "events_url": "https://api.github.com/users/hexoscott/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hexoscott/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-01-16T14:12:01Z",
    "updated_at": "2023-01-16T14:12:01Z",
    "author_association": "CONTRIBUTOR",
    "body": "We should be OK here\r\n\r\n```\r\nfunc (p *TxPool) validateTx(txn *types.TxSlot, isLocal bool, stateCache kvcache.CacheView) DiscardReason {\r\n\tisShanghai := p.isShanghai()\r\n\tif isShanghai {\r\n\t\tif txn.DataLen > fixedgas.MaxInitCodeSize {\r\n\t\t\treturn InitCodeTooLarge\r\n\t\t}\r\n\t}\r\n```\r\n\r\nI'll look into the fuzzer and see if I can get that running locally",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1384123424/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
