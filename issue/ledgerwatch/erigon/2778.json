{
  "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/2778",
  "repository_url": "https://api.github.com/repos/ledgerwatch/erigon",
  "labels_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/2778/labels{/name}",
  "comments_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/2778/comments",
  "events_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/2778/events",
  "html_url": "https://github.com/ledgerwatch/erigon/issues/2778",
  "id": 1015717908,
  "node_id": "I_kwDOC0FsAM48iqAU",
  "number": 2778,
  "title": "`rpcdaemon` crashes on `eth_call` occasionally after v2021.10.01",
  "user": {
    "login": "zzh1996",
    "id": 10773481,
    "node_id": "MDQ6VXNlcjEwNzczNDgx",
    "avatar_url": "https://avatars.githubusercontent.com/u/10773481?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/zzh1996",
    "html_url": "https://github.com/zzh1996",
    "followers_url": "https://api.github.com/users/zzh1996/followers",
    "following_url": "https://api.github.com/users/zzh1996/following{/other_user}",
    "gists_url": "https://api.github.com/users/zzh1996/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/zzh1996/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/zzh1996/subscriptions",
    "organizations_url": "https://api.github.com/users/zzh1996/orgs",
    "repos_url": "https://api.github.com/users/zzh1996/repos",
    "events_url": "https://api.github.com/users/zzh1996/events{/privacy}",
    "received_events_url": "https://api.github.com/users/zzh1996/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2021-10-04T23:12:27Z",
  "updated_at": "2021-10-05T11:26:29Z",
  "closed_at": "2021-10-05T11:26:29Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "#### System information\r\n\r\nErigon version: erigon version 2021.10.1-alpha\r\n\r\nOS & Version: Linux Ubuntu 21.04\r\n\r\nCommit hash: ef80fd54b\r\n\r\n#### Expected behaviour\r\n\r\n`rpcdaemon` doesn't crash, just like v2021.09.05 and previous versions.\r\n\r\nReturn data should be:\r\n\r\n`[{\"jsonrpc\":\"2.0\",\"id\":0,\"result\":\"0x\"},{\"jsonrpc\":\"2.0\",\"id\":1,\"result\":\"0x\"},{\"jsonrpc\":\"2.0\",\"id\":2,\"result\":\"0x\"},{\"jsonrpc\":\"2.0\",\"id\":3,\"result\":\"0x\"},{\"jsonrpc\":\"2.0\",\"id\":4,\"result\":\"0x\"}]`\r\n\r\n#### Actual behaviour\r\n\r\n`rpcdaemon` crashes sometimes.\r\n\r\n`[{\"jsonrpc\":\"2.0\",\"id\":0,\"error\":{\"code\":-32000,\"message\":\"method handler crashed\"}},{\"jsonrpc\":\"2.0\",\"id\":1,\"error\":{\"code\":-32000,\"message\":\"method handler crashed\"}},{\"jsonrpc\":\"2.0\",\"id\":2,\"result\":\"0x\"\r\n},{\"jsonrpc\":\"2.0\",\"id\":3,\"result\":\"0x\"},{\"jsonrpc\":\"2.0\",\"id\":4,\"result\":\"0x\"}]`\r\n\r\nIn addition, sometimes wrong results are returned.\r\n\r\n`[{\"jsonrpc\":\"2.0\",\"id\":0,\"result\":\"0x\"},{\"jsonrpc\":\"2.0\",\"id\":1,\"result\":\"0x\"},{\"jsonrpc\":\"2.0\",\"id\":2,\"error\":{\"code\":-32000,\"message\":\"insufficient funds for gas * price + value: address 0xBE0eB53F46cd790\r\nCd13851d5EFf43D12404d33E8 have 116 want 100000000000000000\"}},{\"jsonrpc\":\"2.0\",\"id\":3,\"result\":\"0x\"},{\"jsonrpc\":\"2.0\",\"id\":4,\"result\":\"0x\"}]`\r\n\r\n`[{\"jsonrpc\":\"2.0\",\"id\":0,\"result\":\"0x\"},{\"jsonrpc\":\"2.0\",\"id\":1,\"result\":\"0x\"},{\"jsonrpc\":\"2.0\",\"id\":2,\"error\":{\"code\":-32000,\"message\":\"invalid jump destination\"}},{\"jsonrpc\":\"2.0\",\"id\":3,\"result\":\"0x\"},{\"\r\njsonrpc\":\"2.0\",\"id\":4,\"result\":\"0x\"}]`\r\n\r\n#### Steps to reproduce the behaviour\r\n\r\n```\r\ncurl http://127.0.0.1:8545/ -H \"Content-Type: application/json\" --data '[{\"method\": \"eth_call\", \"params\": [{\"from\": \"0xBE0eB53F46cd790Cd13851d5EFf43D12404d33E8\", \"to\": \"0xbaa54d6e90c3f4d7ebec11bd180134c7ed8ebb52\", \"gas\": \"0xe4e1c0\", \"value\": \"0x16345785d8a0000\", \"data\": \"0x\"}, \"latest\"], \"id\": 0, \"jsonrpc\": \"2.0\"}, {\"method\": \"eth_call\", \"params\": [{\"from\": \"0xBE0eB53F46cd790Cd13851d5EFf43D12404d33E8\", \"to\": \"0xbaa54d6e90c3f4d7ebec11bd180134c7ed8ebb52\", \"gas\": \"0xe4e1c0\", \"value\": \"0x16345785d8a0000\", \"data\": \"0x\"}, \"latest\"], \"id\": 1, \"jsonrpc\": \"2.0\"}, {\"method\": \"eth_call\", \"params\": [{\"from\": \"0xBE0eB53F46cd790Cd13851d5EFf43D12404d33E8\", \"to\": \"0xbaa54d6e90c3f4d7ebec11bd180134c7ed8ebb52\", \"gas\": \"0xe4e1c0\", \"value\": \"0x16345785d8a0000\", \"data\": \"0x\"}, \"latest\"], \"id\": 2, \"jsonrpc\": \"2.0\"}, {\"method\": \"eth_call\", \"params\": [{\"from\": \"0xBE0eB53F46cd790Cd13851d5EFf43D12404d33E8\", \"to\": \"0xbaa54d6e90c3f4d7ebec11bd180134c7ed8ebb52\", \"gas\": \"0xe4e1c0\", \"value\": \"0x16345785d8a0000\", \"data\": \"0x\"}, \"latest\"], \"id\": 3, \"jsonrpc\": \"2.0\"}, {\"method\": \"eth_call\", \"params\": [{\"from\": \"0xBE0eB53F46cd790Cd13851d5EFf43D12404d33E8\", \"to\": \"0xbaa54d6e90c3f4d7ebec11bd180134c7ed8ebb52\", \"gas\": \"0xe4e1c0\", \"value\": \"0x16345785d8a0000\", \"data\": \"0x\"}, \"latest\"], \"id\": 4, \"jsonrpc\": \"2.0\"}]'\r\n```\r\n\r\n#### Backtrace\r\n\r\n````\r\nEROR[10-05|06:54:44.870] RPC method eth_call crashed: runtime error: index out of range [1] with length 1\r\ngoroutine 571766 [running]:\r\ngithub.com/ledgerwatch/erigon/rpc.(*callback).call.func1(0xc00398a430, 0x8, 0xc0006ddd60)\r\n        github.com/ledgerwatch/erigon/rpc/service.go:219 +0xbd\r\npanic(0x113f960, 0xc0040a4750)\r\n        runtime/panic.go:965 +0x1b9\r\ngithub.com/ledgerwatch/erigon/core/types/accounts.(*Account).DecodeForStorage(0xc000547980, 0xc0033212c8, 0x1, 0x1, 0xc0033212c8, 0x1)\r\n        github.com/ledgerwatch/erigon/core/types/accounts/account.go:468 +0x837\r\ngithub.com/ledgerwatch/erigon/core/state.(*CachedReader2).ReadAccountData(0xc001942540, 0xc79cd463fb50ebe, 0x123df4efd55138d1, 0xe8334d40, 0x0, 0x0, 0x0)\r\n        github.com/ledgerwatch/erigon/core/state/cached_reader2.go:36 +0xf9\r\ngithub.com/ledgerwatch/erigon/core/state.(*IntraBlockState).getStateObject(0xc000a3b260, 0xc79cd463fb50ebe, 0x123df4efd55138d1, 0xe8334d40, 0x0)\r\n        github.com/ledgerwatch/erigon/core/state/intra_block_state.go:548 +0xf6\r\ngithub.com/ledgerwatch/erigon/core/state.(*IntraBlockState).GetBalance(0xc000a3b260, 0xc79cd463fb50ebe, 0x123df4efd55138d1, 0xc0e8334d40, 0xe4e1c0)\r\n        github.com/ledgerwatch/erigon/core/state/intra_block_state.go:260 +0x56\r\ngithub.com/ledgerwatch/erigon/core.(*StateTransition).buyGas(0xc000033710, 0x0, 0xc00225ff48, 0x1)\r\n        github.com/ledgerwatch/erigon/core/state_transition.go:210 +0x10c\r\ngithub.com/ledgerwatch/erigon/core.(*StateTransition).preCheck(0xc000033710, 0x20300000000000, 0x7f284d687fff, 0x7f2848762090)\r\n        github.com/ledgerwatch/erigon/core/state_transition.go:264 +0x490\r\ngithub.com/ledgerwatch/erigon/core.(*StateTransition).TransitionDb(0xc000033710, 0x1340001, 0xc0008e6a50, 0xc00225ff60, 0xc000033710)\r\n        github.com/ledgerwatch/erigon/core/state_transition.go:292 +0x4f\r\ngithub.com/ledgerwatch/erigon/core.ApplyMessage(0xc0008f6000, 0x134bc58, 0xc0008e6a50, 0xc00225ff60, 0xc0008f0001, 0x62581d100901a8f8, 0xc9b72352, 0x1caa85f)\r\n        github.com/ledgerwatch/erigon/core/state_transition.go:189 +0x6d\r\ngithub.com/ledgerwatch/erigon/turbo/transactions.DoCall(0x1340498, 0xc0031504e0, 0xc00408e2b8, 0xc00408e2e8, 0xc003321828, 0x0, 0x0, 0x0, 0xc002d0eea0, 0xc0005aec78, ...)\r\n        github.com/ledgerwatch/erigon/turbo/transactions/call.go:133 +0xe49\r\ngithub.com/ledgerwatch/erigon/cmd/rpcdaemon/commands.(*APIImpl).Call(0xc0002a02d0, 0x1340498, 0xc00462f240, 0xc00408e2b8, 0xc00408e2e8, 0xc003321828, 0x0, 0x0, 0x0, 0xc002d0eea0, ...)\r\n        github.com/ledgerwatch/erigon/cmd/rpcdaemon/commands/eth_call.go:44 +0x289\r\nreflect.Value.call(0xc0005ba380, 0xc000294100, 0x13, 0x11caf4b, 0x4, 0xc0002cf980, 0x5, 0x5, 0xc0002cf9b0, 0xc002b80dc0, ...)\r\n        reflect/value.go:476 +0x8e7\r\nreflect.Value.Call(0xc0005ba380, 0xc000294100, 0x13, 0xc0002cf980, 0x5, 0x5, 0x104d500, 0x1311c58, 0x0)\r\n        reflect/value.go:337 +0xb9\r\ngithub.com/ledgerwatch/erigon/rpc.(*callback).call(0xc00028e7e0, 0x1340498, 0xc00462f240, 0xc00398a430, 0x8, 0xc002b80dc0, 0x3, 0x3, 0xc0038076e0, 0x0, ...)\r\n        github.com/ledgerwatch/erigon/rpc/service.go:226 +0x392\r\ngithub.com/ledgerwatch/erigon/rpc.(*handler).runMethod(0xc00066ae60, 0x1340498, 0xc00462f240, 0xc00059aa80, 0xc00028e7e0, 0xc002b80dc0, 0x3, 0x3, 0xc0038076e0, 0x0)\r\n        github.com/ledgerwatch/erigon/rpc/handler.go:491 +0xb2c\r\ngithub.com/ledgerwatch/erigon/rpc.(*handler).handleCall(0xc00066ae60, 0xc0002911a0, 0xc00059aa80, 0xc0038076e0, 0x60)\r\n        github.com/ledgerwatch/erigon/rpc/handler.go:396 +0x25f\r\ngithub.com/ledgerwatch/erigon/rpc.(*handler).handleCallMsg(0xc00066ae60, 0xc0002911a0, 0xc00059aa80, 0xc0038076e0, 0x4)\r\n        github.com/ledgerwatch/erigon/rpc/handler.go:350 +0x1a5\r\ngithub.com/ledgerwatch/erigon/rpc.(*handler).handleBatch.func2.1(0xc00398a4b4, 0xc003a5ac00, 0xc0002911a0, 0xc00066ae60, 0xc0002910b0, 0x5, 0x5, 0xc0037820f0, 0x5, 0x5, ...)\r\n        github.com/ledgerwatch/erigon/rpc/handler.go:148 +0x1e5\r\ncreated by github.com/ledgerwatch/erigon/rpc.(*handler).handleBatch.func2\r\n        github.com/ledgerwatch/erigon/rpc/handler.go:134 +0x1dc\r\n````",
  "closed_by": {
    "login": "AskAlexSharov",
    "id": 46885206,
    "node_id": "MDQ6VXNlcjQ2ODg1MjA2",
    "avatar_url": "https://avatars.githubusercontent.com/u/46885206?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/AskAlexSharov",
    "html_url": "https://github.com/AskAlexSharov",
    "followers_url": "https://api.github.com/users/AskAlexSharov/followers",
    "following_url": "https://api.github.com/users/AskAlexSharov/following{/other_user}",
    "gists_url": "https://api.github.com/users/AskAlexSharov/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/AskAlexSharov/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/AskAlexSharov/subscriptions",
    "organizations_url": "https://api.github.com/users/AskAlexSharov/orgs",
    "repos_url": "https://api.github.com/users/AskAlexSharov/repos",
    "events_url": "https://api.github.com/users/AskAlexSharov/events{/privacy}",
    "received_events_url": "https://api.github.com/users/AskAlexSharov/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/2778/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/2778/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/934004364",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/2778#issuecomment-934004364",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/2778",
    "id": 934004364,
    "node_id": "IC_kwDOC0FsAM43q8aM",
    "user": {
      "login": "AskAlexSharov",
      "id": 46885206,
      "node_id": "MDQ6VXNlcjQ2ODg1MjA2",
      "avatar_url": "https://avatars.githubusercontent.com/u/46885206?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AskAlexSharov",
      "html_url": "https://github.com/AskAlexSharov",
      "followers_url": "https://api.github.com/users/AskAlexSharov/followers",
      "following_url": "https://api.github.com/users/AskAlexSharov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AskAlexSharov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AskAlexSharov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AskAlexSharov/subscriptions",
      "organizations_url": "https://api.github.com/users/AskAlexSharov/orgs",
      "repos_url": "https://api.github.com/users/AskAlexSharov/repos",
      "events_url": "https://api.github.com/users/AskAlexSharov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AskAlexSharov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-10-05T02:21:36Z",
    "updated_at": "2021-10-05T02:21:36Z",
    "author_association": "COLLABORATOR",
    "body": "I will take a look today",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/934004364/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/934027208",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/2778#issuecomment-934027208",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/2778",
    "id": 934027208,
    "node_id": "IC_kwDOC0FsAM43rB_I",
    "user": {
      "login": "AskAlexSharov",
      "id": 46885206,
      "node_id": "MDQ6VXNlcjQ2ODg1MjA2",
      "avatar_url": "https://avatars.githubusercontent.com/u/46885206?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AskAlexSharov",
      "html_url": "https://github.com/AskAlexSharov",
      "followers_url": "https://api.github.com/users/AskAlexSharov/followers",
      "following_url": "https://api.github.com/users/AskAlexSharov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AskAlexSharov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AskAlexSharov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AskAlexSharov/subscriptions",
      "organizations_url": "https://api.github.com/users/AskAlexSharov/orgs",
      "repos_url": "https://api.github.com/users/AskAlexSharov/repos",
      "events_url": "https://api.github.com/users/AskAlexSharov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AskAlexSharov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-10-05T03:24:30Z",
    "updated_at": "2021-10-05T05:08:19Z",
    "author_association": "COLLABORATOR",
    "body": "@zzh1996 hi, can you help me to test - if `state_stream_default` branch solves your problem (rebuild erigon and rpcdaemon)",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/934027208/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/934148469",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/2778#issuecomment-934148469",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/2778",
    "id": 934148469,
    "node_id": "IC_kwDOC0FsAM43rfl1",
    "user": {
      "login": "zzh1996",
      "id": 10773481,
      "node_id": "MDQ6VXNlcjEwNzczNDgx",
      "avatar_url": "https://avatars.githubusercontent.com/u/10773481?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/zzh1996",
      "html_url": "https://github.com/zzh1996",
      "followers_url": "https://api.github.com/users/zzh1996/followers",
      "following_url": "https://api.github.com/users/zzh1996/following{/other_user}",
      "gists_url": "https://api.github.com/users/zzh1996/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/zzh1996/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/zzh1996/subscriptions",
      "organizations_url": "https://api.github.com/users/zzh1996/orgs",
      "repos_url": "https://api.github.com/users/zzh1996/repos",
      "events_url": "https://api.github.com/users/zzh1996/events{/privacy}",
      "received_events_url": "https://api.github.com/users/zzh1996/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-10-05T07:38:31Z",
    "updated_at": "2021-10-05T07:38:31Z",
    "author_association": "NONE",
    "body": "> @zzh1996 hi, can you help me to test - if `state_stream_default` branch solves your problem (rebuild erigon and rpcdaemon)\r\n\r\nIt's not working. The same error message.",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/934148469/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
