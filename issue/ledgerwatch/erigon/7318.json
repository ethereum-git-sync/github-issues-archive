{
  "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/7318",
  "repository_url": "https://api.github.com/repos/ledgerwatch/erigon",
  "labels_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/7318/labels{/name}",
  "comments_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/7318/comments",
  "events_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/7318/events",
  "html_url": "https://github.com/ledgerwatch/erigon/issues/7318",
  "id": 1670137165,
  "node_id": "I_kwDOC0FsAM5jjEVN",
  "number": 7318,
  "title": "getTransaction returns null (Different txlookup stage)",
  "user": {
    "login": "etelpmoc",
    "id": 45206975,
    "node_id": "MDQ6VXNlcjQ1MjA2OTc1",
    "avatar_url": "https://avatars.githubusercontent.com/u/45206975?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/etelpmoc",
    "html_url": "https://github.com/etelpmoc",
    "followers_url": "https://api.github.com/users/etelpmoc/followers",
    "following_url": "https://api.github.com/users/etelpmoc/following{/other_user}",
    "gists_url": "https://api.github.com/users/etelpmoc/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/etelpmoc/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/etelpmoc/subscriptions",
    "organizations_url": "https://api.github.com/users/etelpmoc/orgs",
    "repos_url": "https://api.github.com/users/etelpmoc/repos",
    "events_url": "https://api.github.com/users/etelpmoc/events{/privacy}",
    "received_events_url": "https://api.github.com/users/etelpmoc/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2023-04-16T20:56:24Z",
  "updated_at": "2023-04-17T08:48:16Z",
  "closed_at": "2023-04-17T08:47:42Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "**System information**\r\n2.42.0-stable-d8d04663\r\nOS & Version : Ubuntu 22.04\r\n\r\n**Erigon Command (with flags/config):**\r\n./build/bin/erigon --datadir ../../erigon --torrent.download.rate=20mb --authrpc.addr=0.0.0.0 --authrpc.vhosts=* --authrpc.jwtsecret=jwt.hex --http.api eth,web3,net,debug,trace,txpool --externalcl\r\n\r\n**Consensus Layer**: Lighthouse\r\n\r\n**Consensus Layer Command (with flags/config):**\r\n./lighthouse bn --network mainnet --execution-endpoint http://localhost:8551 --execution-jwt ../../../sdb/sw/new_erigon/erigon/jwt.hex --disable-deposit-contract-sync --datadir lighthouse_data2 --checkpoint-sync-url https://mainnet.checkpoint.sigp.io\r\n\r\n**Chain/Network**: mainnet\r\n\r\n**Expected behaviour**\r\nIn geth console, \r\ngetTransaction and getTransactionReceipt all returns normal transaction data\r\n\r\n**Actual behavior**\r\n\r\ngetTransaction, getTransactionReceipt returns null for the block between 15000000 and 17015837 (which is the time my server was down)\r\n\r\ngetBlock and getTranactionFromBlock, and even getLogs all work well.\r\n\r\n```\r\n> eth.getTransaction(\"0xc1da8e6a67e955fccef5112d9e30ad918e477ae833d8f6ab486b1562a7048881\")\r\nnull\r\n``` \r\n\r\n\r\n**Steps to reproduce the behaviour**\r\n\r\nMy server was down a few days ago (4/10) and I attempted to resume erigon in 4/12\r\n\r\nI was using erigon version 2022.09.3-stable-32bd69e5 before the server went down, \r\n\r\nbut there were some problems in resuming so I updated my the erigon to the recent version (2.42.0-stable-d8d04663) .\r\n\r\nThe logs at that time told me, it is the old version so it is pruning over 400k blocks.\r\n\r\nAfter pruning to the block 15000000, it started again syncing (stage 1~15) so I waited until today.\r\n\r\nstage 1~6 did well for block 15000000 to 17043126,  but from stage 7 (Execution) it only downloaded only the block from 17015837 (server down time) to 17043126.\r\n\r\nI also get this error when I terminate Erigon\r\n\r\n```\r\nWARN[04-17|13:31:06.755] [snapshots] retire blocks                err=\"DumpBlocks: context canceled\" fromBlock=15000000 toBlock=15500000\r\n\r\n``` \r\n\r\nI think this might be the reason why I cannot get transaction, receipts data . \r\n\r\nCould anyone please help me to restore tx and receipts data?\r\n\r\nThank you in advance.\r\n\r\n\r\n\r\n",
  "closed_by": {
    "login": "etelpmoc",
    "id": 45206975,
    "node_id": "MDQ6VXNlcjQ1MjA2OTc1",
    "avatar_url": "https://avatars.githubusercontent.com/u/45206975?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/etelpmoc",
    "html_url": "https://github.com/etelpmoc",
    "followers_url": "https://api.github.com/users/etelpmoc/followers",
    "following_url": "https://api.github.com/users/etelpmoc/following{/other_user}",
    "gists_url": "https://api.github.com/users/etelpmoc/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/etelpmoc/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/etelpmoc/subscriptions",
    "organizations_url": "https://api.github.com/users/etelpmoc/orgs",
    "repos_url": "https://api.github.com/users/etelpmoc/repos",
    "events_url": "https://api.github.com/users/etelpmoc/events{/privacy}",
    "received_events_url": "https://api.github.com/users/etelpmoc/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/7318/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/7318/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1510685265",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/7318#issuecomment-1510685265",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/7318",
    "id": 1510685265,
    "node_id": "IC_kwDOC0FsAM5aCzpR",
    "user": {
      "login": "etelpmoc",
      "id": 45206975,
      "node_id": "MDQ6VXNlcjQ1MjA2OTc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/45206975?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/etelpmoc",
      "html_url": "https://github.com/etelpmoc",
      "followers_url": "https://api.github.com/users/etelpmoc/followers",
      "following_url": "https://api.github.com/users/etelpmoc/following{/other_user}",
      "gists_url": "https://api.github.com/users/etelpmoc/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/etelpmoc/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/etelpmoc/subscriptions",
      "organizations_url": "https://api.github.com/users/etelpmoc/orgs",
      "repos_url": "https://api.github.com/users/etelpmoc/repos",
      "events_url": "https://api.github.com/users/etelpmoc/events{/privacy}",
      "received_events_url": "https://api.github.com/users/etelpmoc/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-17T04:36:54Z",
    "updated_at": "2023-04-17T04:54:21Z",
    "author_association": "NONE",
    "body": "Also, when I type in \r\n\r\n```\r\nprint_stages --chain mainnet --datadir ../../erigon\r\n```\r\nIt shows like\r\n```\r\n                                 stage_at        prune_at\r\nSnapshots                        17063869        0\r\nHeaders                          17063869        0\r\nBlockHashes                      17063869        0\r\nBodies                           17063869        0\r\nSenders                          17063869        0\r\nExecution                        17063869        17063869\r\nTranslation                      0               0\r\nHashState                        17063869        0\r\nIntermediateHashes               17063869        17063869\r\nAccountHistoryIndex              17063869        0\r\nStorageHistoryIndex              17063869        0\r\nLogIndex                         17063869        0\r\nCallTraces                       17063869        17063869\r\nTxLookup                         17063869        15000000\r\nFinish                           17063869        0\r\n--\r\nprune distance: \r\n\r\nblocks.v2: blocks=14999999, segments=15499999, indices=14999999\r\n\r\nhistory.v3: false, idx steps: 0.00, lastMaxTxNum=0->0, lastBlockInSnap=0\r\n\r\nsequence: EthTx=1972292112, NonCanonicalTx=0\r\n\r\nin db: first header 15000000, last header 17064097, first body 15000000, last body 17063869\r\n``` \r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1510685265/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1510947128",
    "html_url": "https://github.com/ledgerwatch/erigon/issues/7318#issuecomment-1510947128",
    "issue_url": "https://api.github.com/repos/ledgerwatch/erigon/issues/7318",
    "id": 1510947128,
    "node_id": "IC_kwDOC0FsAM5aDzk4",
    "user": {
      "login": "etelpmoc",
      "id": 45206975,
      "node_id": "MDQ6VXNlcjQ1MjA2OTc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/45206975?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/etelpmoc",
      "html_url": "https://github.com/etelpmoc",
      "followers_url": "https://api.github.com/users/etelpmoc/followers",
      "following_url": "https://api.github.com/users/etelpmoc/following{/other_user}",
      "gists_url": "https://api.github.com/users/etelpmoc/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/etelpmoc/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/etelpmoc/subscriptions",
      "organizations_url": "https://api.github.com/users/etelpmoc/orgs",
      "repos_url": "https://api.github.com/users/etelpmoc/repos",
      "events_url": "https://api.github.com/users/etelpmoc/events{/privacy}",
      "received_events_url": "https://api.github.com/users/etelpmoc/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-17T08:47:42Z",
    "updated_at": "2023-04-17T08:48:16Z",
    "author_association": "NONE",
    "body": "I tried a few things and luckily resolved this issue.\r\n\r\n1. Run Erigon with snap.stop and no externalcl\r\n```\r\n./build/bin/erigon --datadir ../../erigon --torrent.download.rate=20mb --authrpc.addr=0.0.0.0 --authrpc.vhosts=* --authrpc.jwtsecret=jwt.hex --http.api eth,web3,net,debug,trace,txpool --snap.stop\r\n``` \r\nNothing had happened in console, but I guess it deleted or initialized some snapshots.\r\n\r\n2. Run Erigon again without snap.stop and no externalcl\r\n```\r\n./build/bin/erigon --datadir ../../erigon --torrent.download.rate=20mb --authrpc.addr=0.0.0.0 --authrpc.vhosts=* --authrpc.jwtsecret=jwt.hex --http.api eth,web3,net,debug,trace,txpool \r\n``` \r\nIt then started to get snapshot (1/16) from block 15000000 to 15500000\r\n\r\n3. Sync Erigon with option externalcl \r\n```\r\n./build/bin/erigon --datadir ../../erigon --torrent.download.rate=20mb --authrpc.addr=0.0.0.0 --authrpc.vhosts=* --authrpc.jwtsecret=jwt.hex --http.api eth,web3,net,debug,trace,txpool --externalcl\r\n``` \r\n\r\nThen TxLookup prune_at moved to 15500000\r\n```\r\n                                 stage_at        prune_at\r\nSnapshots                        17064789        0\r\nHeaders                          17064979        0\r\nBlockHashes                      17064979        0\r\nBodies                           17064979        0\r\nSenders                          17064979        0\r\nExecution                        17064979        17064979\r\nTranslation                      0               0\r\nHashState                        17064979        0\r\nIntermediateHashes               17064979        17064979\r\nAccountHistoryIndex              17064979        0\r\nStorageHistoryIndex              17064979        0\r\nLogIndex                         17064979        0\r\nCallTraces                       17064979        17064979\r\nTxLookup                         17064979        15500000\r\nFinish                           17064979        0\r\n--\r\nprune distance: \r\n\r\nblocks.v2: blocks=15499999, segments=15499999, indices=15499999\r\n\r\nhistory.v3: false, idx steps: 0.00, lastMaxTxNum=0->0, lastBlockInSnap=0\r\n\r\nsequence: EthTx=1972441920, NonCanonicalTx=0\r\n\r\nin db: first header 15001600, last header 17065356, first body 15001600, last body 17064979\r\n``` \r\n\r\nI repeated step 1 to step 3 again to get 1550k ~ 1600k, 1600k ~ 1650k, 1650k ~ 1700k\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ledgerwatch/erigon/issues/comments/1510947128/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
