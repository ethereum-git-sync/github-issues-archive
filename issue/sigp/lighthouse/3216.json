{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/3216",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/3216/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/3216/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/3216/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/3216",
  "id": 1247269383,
  "node_id": "I_kwDOCFeAzc5KV9IH",
  "number": 3216,
  "title": "Signature caching in the VC",
  "user": {
    "login": "paulhauner",
    "id": 6660660,
    "node_id": "MDQ6VXNlcjY2NjA2NjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/paulhauner",
    "html_url": "https://github.com/paulhauner",
    "followers_url": "https://api.github.com/users/paulhauner/followers",
    "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
    "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
    "organizations_url": "https://api.github.com/users/paulhauner/orgs",
    "repos_url": "https://api.github.com/users/paulhauner/repos",
    "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
    "received_events_url": "https://api.github.com/users/paulhauner/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2022-05-25T00:49:02Z",
  "updated_at": "2022-09-12T08:25:12Z",
  "closed_at": "2022-09-12T08:25:12Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\n@jmcruz1983 (Juan) has pointed out that Lighthouse is doing orders of magnitude more signing requests to Web3Signer than Teku. At scale (e.g., thousands of validators), this can overload infrastructure and cause real problems.\r\n\r\nBased on some data from Juan, I suspect this is caused by duplicate signing of selection proofs (I'm not sure if it's for [attestations](https://github.com/sigp/lighthouse/blob/aa72088f8fc91d41106a8afce7a0179cde64ce5d/validator_client/src/signing_method.rs#L41) or [sync messages](https://github.com/sigp/lighthouse/blob/aa72088f8fc91d41106a8afce7a0179cde64ce5d/validator_client/src/signing_method.rs#L42)).\r\n\r\nI have a proposed solution that should be simple to implement and will:\r\n\r\n- *Definitely* be useful for Juan to test on his infra to see if it resolves the issue.\r\n- *Probably* be a tenable long-term solution.\r\n\r\n## Proposed Solution\r\n\r\nIn the [validator_store](https://github.com/sigp/lighthouse/blob/stable/validator_client/src/validator_store.rs), create a `signature_cache: SignatureCache<T>(HashMap<(T, SigningContext), Signature>)` struct. \r\n\r\n1. Attached to the `ValidatorStore` is one `signature_cache` (probably wrapped in an `RwLock`) for [`produce_selection_proof`](https://github.com/sigp/lighthouse/blob/aa72088f8fc91d41106a8afce7a0179cde64ce5d/validator_client/src/validator_store.rs#L560-L592) and one for [`produce_sync_selection_proof`](https://github.com/sigp/lighthouse/blob/aa72088f8fc91d41106a8afce7a0179cde64ce5d/validator_client/src/validator_store.rs#L594-L629).\r\n1. When a selection proof is requested, we check the cache to see if it already exists. If so, we return early with that signature.\r\n1. After we create a signature (because it wasn't in the cache), we add it to the cache.\r\n    - If, during the cache add, we discover that the cache is over a certain size (64?) then we prune the entry with the lowest slot.\r\n\r\nWhenever the signature cache reaches a certain size (4?) it will prune the entry",
  "closed_by": {
    "login": "paulhauner",
    "id": 6660660,
    "node_id": "MDQ6VXNlcjY2NjA2NjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/paulhauner",
    "html_url": "https://github.com/paulhauner",
    "followers_url": "https://api.github.com/users/paulhauner/followers",
    "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
    "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
    "organizations_url": "https://api.github.com/users/paulhauner/orgs",
    "repos_url": "https://api.github.com/users/paulhauner/repos",
    "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
    "received_events_url": "https://api.github.com/users/paulhauner/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/3216/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/3216/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1136574964",
    "html_url": "https://github.com/sigp/lighthouse/issues/3216#issuecomment-1136574964",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3216",
    "id": 1136574964,
    "node_id": "IC_kwDOCFeAzc5DvsH0",
    "user": {
      "login": "paulhauner",
      "id": 6660660,
      "node_id": "MDQ6VXNlcjY2NjA2NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/paulhauner",
      "html_url": "https://github.com/paulhauner",
      "followers_url": "https://api.github.com/users/paulhauner/followers",
      "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
      "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
      "organizations_url": "https://api.github.com/users/paulhauner/orgs",
      "repos_url": "https://api.github.com/users/paulhauner/repos",
      "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/paulhauner/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-25T00:55:03Z",
    "updated_at": "2022-05-25T00:55:03Z",
    "author_association": "MEMBER",
    "body": "Oh wait, I just realised that those `signature_cache`s need to be *per validator*. Perhaps attaching them to the `SigningMethod` would be more appropriate.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1136574964/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1136575913",
    "html_url": "https://github.com/sigp/lighthouse/issues/3216#issuecomment-1136575913",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3216",
    "id": 1136575913,
    "node_id": "IC_kwDOCFeAzc5DvsWp",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-25T00:56:35Z",
    "updated_at": "2022-05-25T00:56:35Z",
    "author_association": "MEMBER",
    "body": "We already pre-compute all the sync selection proof signatures. It could be that this burst of signing is what shows up on web3signer's end.\r\n\r\nOr, alternatively if we do adopt a cache we can probably drop the signature pre-compute, as I think a cache would obsolete the pre-compute.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1136575913/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1243388210",
    "html_url": "https://github.com/sigp/lighthouse/issues/3216#issuecomment-1243388210",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3216",
    "id": 1243388210,
    "node_id": "IC_kwDOCFeAzc5KHJky",
    "user": {
      "login": "paulhauner",
      "id": 6660660,
      "node_id": "MDQ6VXNlcjY2NjA2NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/paulhauner",
      "html_url": "https://github.com/paulhauner",
      "followers_url": "https://api.github.com/users/paulhauner/followers",
      "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
      "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
      "organizations_url": "https://api.github.com/users/paulhauner/orgs",
      "repos_url": "https://api.github.com/users/paulhauner/repos",
      "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/paulhauner/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-12T08:25:12Z",
    "updated_at": "2022-09-12T08:25:12Z",
    "author_association": "MEMBER",
    "body": "Closing since #3223 implemented this feature and saw little to no benefit.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1243388210/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
