{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/3446",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/3446/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/3446/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/3446/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/3446",
  "id": 1333438916,
  "node_id": "I_kwDOCFeAzc5PeqnE",
  "number": 3446,
  "title": "Allow provisioning of the api-token.txt file (HTTP server auth)",
  "user": {
    "login": "jvbriones",
    "id": 1674192,
    "node_id": "MDQ6VXNlcjE2NzQxOTI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1674192?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jvbriones",
    "html_url": "https://github.com/jvbriones",
    "followers_url": "https://api.github.com/users/jvbriones/followers",
    "following_url": "https://api.github.com/users/jvbriones/following{/other_user}",
    "gists_url": "https://api.github.com/users/jvbriones/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jvbriones/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jvbriones/subscriptions",
    "organizations_url": "https://api.github.com/users/jvbriones/orgs",
    "repos_url": "https://api.github.com/users/jvbriones/repos",
    "events_url": "https://api.github.com/users/jvbriones/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jvbriones/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2022-08-09T15:36:15Z",
  "updated_at": "2022-08-10T12:35:12Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nTo communicate via HTTP [a Bearer token](https://lighthouse-book.sigmaprime.io/api-vc-auth-header.html) is needed which is generated at the startup and placed in _validators-dir/api-token.txt._ This HTTP communication is now required for some actions, e.g. after https://github.com/sigp/lighthouse/issues/3264, the only way now to update the fee recipient config is via [Key Manager API](https://ethereum.github.io/keymanager-APIs/#/Fee%20Recipient).\r\n\r\nThe _api-token.txt_ file is re-generated when restarting the service even if the file already exists in the expected location. This is problematic when automating the configuration of the system resulting in 403 HTTP responses due a change of the token.\r\n\r\nThis approach does not allow you to provision a specific token used by the different services that consume the validator and communicate via HTTP.\r\n\r\nIt would be better if we could provision the token as we already do with the JWT token needed for the EL communication.\r\n\r\n## Version\r\n\r\ndocker - v2.5.1-modern\r\n\r\n## Present Behaviour\r\n\r\nThe _api-token.txt_ file is re-generated when restarting the service.\r\n\r\n## Expected Behaviour\r\n\r\nGenerate _api-token.txt_ file only if is missing.\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/3446/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/3446/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1210063079",
    "html_url": "https://github.com/sigp/lighthouse/issues/3446#issuecomment-1210063079",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3446",
    "id": 1210063079,
    "node_id": "IC_kwDOCFeAzc5IIBjn",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-10T01:57:35Z",
    "updated_at": "2022-08-10T01:57:35Z",
    "author_association": "MEMBER",
    "body": "This is on our long-term TODO list, so I'll leave this issue open, however if you'd like an immediate workaround you _can_ provision the API token if you generate a valid secp256k1 keypair.\r\n\r\nLighthouse's API token is actually serving a dual purpose, it acts as both a shared secret _and_ the public key for the validator client's signed responses. There's some information on the signing process [here](https://lighthouse-book.sigmaprime.io/api-vc-sig-header.html). If you'd like to keep the same key across restarts you need to generate (or persist) two files:\r\n\r\n- `.secp-sk`: an secp256k1 private key stored as 0x-prefixed hex\r\n- `api-token.txt`: an secp256k1 public key stored as `api-token-0x{pubkey}`\r\n\r\nIn other words, the `api-token.txt` cannot just be arbitrary bytes, if it isn't part of a valid keypair then the VC will generate a new keypair and overwrite it.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1210063079/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1210589640",
    "html_url": "https://github.com/sigp/lighthouse/issues/3446#issuecomment-1210589640",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3446",
    "id": 1210589640,
    "node_id": "IC_kwDOCFeAzc5IKCHI",
    "user": {
      "login": "jmcruz1983",
      "id": 15966694,
      "node_id": "MDQ6VXNlcjE1OTY2Njk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/15966694?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jmcruz1983",
      "html_url": "https://github.com/jmcruz1983",
      "followers_url": "https://api.github.com/users/jmcruz1983/followers",
      "following_url": "https://api.github.com/users/jmcruz1983/following{/other_user}",
      "gists_url": "https://api.github.com/users/jmcruz1983/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jmcruz1983/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jmcruz1983/subscriptions",
      "organizations_url": "https://api.github.com/users/jmcruz1983/orgs",
      "repos_url": "https://api.github.com/users/jmcruz1983/repos",
      "events_url": "https://api.github.com/users/jmcruz1983/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jmcruz1983/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-10T12:14:53Z",
    "updated_at": "2022-08-10T12:14:53Z",
    "author_association": "NONE",
    "body": "Thanks @michaelsproul for the workaround,\r\nI am just wondering how this would work together with lighthouse validator using a remove web3signer,\r\nwould this key pair conflict in some way?",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1210589640/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1210612113",
    "html_url": "https://github.com/sigp/lighthouse/issues/3446#issuecomment-1210612113",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3446",
    "id": 1210612113,
    "node_id": "IC_kwDOCFeAzc5IKHmR",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-10T12:35:12Z",
    "updated_at": "2022-08-10T12:35:12Z",
    "author_association": "MEMBER",
    "body": "Hey @jmcruz1983, I don't think there's any conflict even when using web3signer, the VC just needs an arbitrary secp256k1 key on disk to sign the HTTP responses. If you don't care about those signatures (and most people don't) then there's no need to have that signing key come from web3signer. Those signature on the HTTP response just prove to the caller that it is communicating with the authentic issuer of the API token. Most other consensus clients don't have any mechanism for proving VC authenticity AFAIK. It's mostly the other direction that's important (proving the caller is authorised to talk to the VC).",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1210612113/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
