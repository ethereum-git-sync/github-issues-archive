{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/3433",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/3433/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/3433/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/3433/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/3433",
  "id": 1330037846,
  "node_id": "I_kwDOCFeAzc5PRsRW",
  "number": 3433,
  "title": "State Reconstruction reaches a faulty state",
  "user": {
    "login": "ghost",
    "id": 10137,
    "node_id": "MDQ6VXNlcjEwMTM3",
    "avatar_url": "https://avatars.githubusercontent.com/u/10137?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ghost",
    "html_url": "https://github.com/ghost",
    "followers_url": "https://api.github.com/users/ghost/followers",
    "following_url": "https://api.github.com/users/ghost/following{/other_user}",
    "gists_url": "https://api.github.com/users/ghost/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ghost/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ghost/subscriptions",
    "organizations_url": "https://api.github.com/users/ghost/orgs",
    "repos_url": "https://api.github.com/users/ghost/repos",
    "events_url": "https://api.github.com/users/ghost/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ghost/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 985647281,
      "node_id": "MDU6TGFiZWw5ODU2NDcyODE=",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/bug",
      "name": "bug",
      "color": "d73a4a",
      "default": true,
      "description": "Something isn't working"
    },
    {
      "id": 2336798682,
      "node_id": "MDU6TGFiZWwyMzM2Nzk4Njgy",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/database",
      "name": "database",
      "color": "C01C9D",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2022-08-05T14:50:33Z",
  "updated_at": "2022-08-26T07:41:26Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nI started my lighthouse client with the `--reconstruct-historic-states` flag and restarted the client. Once I started the client again, I got an error that did not stop the client, only stopped the state reconstruction:\r\n\r\n`ERRO State reconstruction failed error: VectorChunkError(Missing { chunk_index: 357 }), service: beacon`\r\n\r\n## Version\r\n\r\nUsing version `2.5.1-stable` (non-portable).\r\n\r\n## Possible solution\r\n\r\nIt seems that the failure is observed in the following function:\r\n\r\n```\r\n// Chunks at the end index are included.\r\n// TODO: could be more efficient with a real range query (perhaps RocksDB)\r\nfn range_query<S: KeyValueStore<E>, E: EthSpec, T: Decode + Encode>(\r\n    store: &S,\r\n    column: DBColumn,\r\n    start_index: usize,\r\n    end_index: usize,\r\n) -> Result<Vec<Chunk<T>>, Error> {\r\n    let range = start_index..=end_index;\r\n    let len = range\r\n        .end()\r\n        // Add one to account for inclusive range.\r\n        .saturating_add(1)\r\n        .saturating_sub(*range.start());\r\n    let mut result = Vec::with_capacity(len);\r\n\r\n    for chunk_index in range {\r\n        let key = &chunk_key(chunk_index)[..];\r\n        let chunk = Chunk::load(store, column, key)?.ok_or(ChunkError::Missing { chunk_index })?;\r\n        result.push(chunk);\r\n    }\r\n\r\n    Ok(result)\r\n}\r\n```",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/3433/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/3433/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1207074401",
    "html_url": "https://github.com/sigp/lighthouse/issues/3433#issuecomment-1207074401",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3433",
    "id": 1207074401,
    "node_id": "IC_kwDOCFeAzc5H8n5h",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-05T22:51:27Z",
    "updated_at": "2022-08-05T22:51:27Z",
    "author_association": "MEMBER",
    "body": "I think this is an instance of this bug https://github.com/sigp/lighthouse/issues/3011, which I've been trying to solve on and off for a while. The strangest thing about it is that it doesn't seem to happen consistently (and AFAICT there's no obvious flaw in the logic).\n\nRecently @tthebst also had a go at fixing it and found a more reliable way to reproduce it, I need to go and dig in to his changes but haven't had time yet.\n\nHopefully we'll have this fixed soon. In the meantime you could try running it again and seeing if you can get lucky.\n\nOut of interest, how much free space was available on your disk when you encountered this? I have a suspicion that it's more likely when the disk is close to full (like <40GB free)",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1207074401/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1207078468",
    "html_url": "https://github.com/sigp/lighthouse/issues/3433#issuecomment-1207078468",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3433",
    "id": 1207078468,
    "node_id": "IC_kwDOCFeAzc5H8o5E",
    "user": {
      "login": "ghost",
      "id": 10137,
      "node_id": "MDQ6VXNlcjEwMTM3",
      "avatar_url": "https://avatars.githubusercontent.com/u/10137?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ghost",
      "html_url": "https://github.com/ghost",
      "followers_url": "https://api.github.com/users/ghost/followers",
      "following_url": "https://api.github.com/users/ghost/following{/other_user}",
      "gists_url": "https://api.github.com/users/ghost/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ghost/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ghost/subscriptions",
      "organizations_url": "https://api.github.com/users/ghost/orgs",
      "repos_url": "https://api.github.com/users/ghost/repos",
      "events_url": "https://api.github.com/users/ghost/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ghost/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-05T23:03:46Z",
    "updated_at": "2022-08-05T23:04:05Z",
    "author_association": "NONE",
    "body": "> I think this is an instance of this bug #3011, which I've been trying to solve on and off for a while. The strangest thing about it is that it doesn't seem to happen consistently (and AFAICT there's no obvious flaw in the logic).\r\n> \r\n> Recently @tthebst also had a go at fixing it and found a more reliable way to reproduce it, I need to go and dig in to his changes but haven't had time yet.\r\n> \r\n> Hopefully we'll have this fixed soon. In the meantime you could try running it again and seeing if you can get lucky.\r\n> \r\n> Out of interest, how much free space was available on your disk when you encountered this? I have a suspicion that it's more likely when the disk is close to full (like <40GB free)\r\n\r\nThank you for your answer. Actually, I had over 600GB free on my SSD when this issue occurred. A few details I should probably have mentioned in the description:\r\n\r\n- The issue occurred on 2 of my nodes (on separate servers and separate networks) when I restarted the node process a lot (I was testing a few things), after about 20-30 restarts of running the node for a while and then restarting. Both nodes were running the identical lighthouse version `v2.5.1`\r\n- For now, I backed up my current datadir (~150GB) and restarted the sync - I will let you know if anything changes",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1207078468/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1228162782",
    "html_url": "https://github.com/sigp/lighthouse/issues/3433#issuecomment-1228162782",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3433",
    "id": 1228162782,
    "node_id": "IC_kwDOCFeAzc5JNEbe",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-26T07:41:26Z",
    "updated_at": "2022-08-26T07:41:26Z",
    "author_association": "MEMBER",
    "body": "Added some debugging tools in this PR which might help us get an idea of what happened: https://github.com/sigp/lighthouse/pull/3511",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1228162782/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
