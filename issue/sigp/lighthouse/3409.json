{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/3409",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/3409/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/3409/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/3409/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/3409",
  "id": 1325675432,
  "node_id": "I_kwDOCFeAzc5PBDOo",
  "number": 3409,
  "title": "Flag to define headers in engine API requests",
  "user": {
    "login": "pablomendezroyo",
    "id": 41727368,
    "node_id": "MDQ6VXNlcjQxNzI3MzY4",
    "avatar_url": "https://avatars.githubusercontent.com/u/41727368?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/pablomendezroyo",
    "html_url": "https://github.com/pablomendezroyo",
    "followers_url": "https://api.github.com/users/pablomendezroyo/followers",
    "following_url": "https://api.github.com/users/pablomendezroyo/following{/other_user}",
    "gists_url": "https://api.github.com/users/pablomendezroyo/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/pablomendezroyo/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/pablomendezroyo/subscriptions",
    "organizations_url": "https://api.github.com/users/pablomendezroyo/orgs",
    "repos_url": "https://api.github.com/users/pablomendezroyo/repos",
    "events_url": "https://api.github.com/users/pablomendezroyo/events{/privacy}",
    "received_events_url": "https://api.github.com/users/pablomendezroyo/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2022-08-02T10:57:02Z",
  "updated_at": "2022-08-04T07:17:30Z",
  "closed_at": "2022-08-04T07:17:30Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Description\r\n\r\nWith the upcoming merge, 1 EL node cannot receive the head chain from multiple CL nodes due to subjectivity. For this reason, makes sense to look for ways to restrict the use of the engine API in the EL, so it is used by one CL at a time.\r\n\r\n### Describe the solution you'd like\r\n\r\nIn addition to the `auth-token` would be nice to add headers to the EL endpoint (`--execution-endpoint`) requests, to indicate the Host who is requesting. This could be used in conjunction with the host whitelist in Geth `--authrpc.vhosts value`, see [geth docs](https://geth.ethereum.org/docs/interface/command-line-options).\r\n",
  "closed_by": {
    "login": "pablomendezroyo",
    "id": 41727368,
    "node_id": "MDQ6VXNlcjQxNzI3MzY4",
    "avatar_url": "https://avatars.githubusercontent.com/u/41727368?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/pablomendezroyo",
    "html_url": "https://github.com/pablomendezroyo",
    "followers_url": "https://api.github.com/users/pablomendezroyo/followers",
    "following_url": "https://api.github.com/users/pablomendezroyo/following{/other_user}",
    "gists_url": "https://api.github.com/users/pablomendezroyo/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/pablomendezroyo/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/pablomendezroyo/subscriptions",
    "organizations_url": "https://api.github.com/users/pablomendezroyo/orgs",
    "repos_url": "https://api.github.com/users/pablomendezroyo/repos",
    "events_url": "https://api.github.com/users/pablomendezroyo/events{/privacy}",
    "received_events_url": "https://api.github.com/users/pablomendezroyo/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/3409/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/3409/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1203418825",
    "html_url": "https://github.com/sigp/lighthouse/issues/3409#issuecomment-1203418825",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3409",
    "id": 1203418825,
    "node_id": "IC_kwDOCFeAzc5HurbJ",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-03T02:41:28Z",
    "updated_at": "2022-08-03T02:42:58Z",
    "author_association": "MEMBER",
    "body": "Geth's `vhosts` flag checks the HTTP request's [`Host`](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Host) header against the server's list of allowed hostnames. So if you're hosting Geth on `localhost` (with `--authrpc.vhosts localhost`, the default), it will refuse requests made to `geth.com` (assuming traffic from `geth.com` is routed to Geth via a reverse proxy).\r\n\r\nTo use this to enforce engine connections from a single CL you would need to have the controlling CL use a different hostname for Geth than the other API consumers. You could have `engine.geth.com` and `rpc.geth.com`, where `engine.geth.com` is only accessible to the controlling CL, and Geth enforces this with `--authrpc.vhosts engine.geth.com`. But then you still need to lock down `engine.geth.com` using authentication (a JWT?) or there's nothing to stop clients just putting `Host: engine.geth.com` in their requests and bypassing the `vhosts` check.\r\n\r\nI'm open-minded to the idea of extra headers on engine API requests, but I think the above example demonstrates that it would require more than just Geth's `vhosts` flag to be useful. I suspect you'd need some kind of multiplexer middleware which checks that certain engine API requests are from the controlling CL and only forwards them if they are. Seeing as the CLs support JWTs already, I think you could use a unique JWT for each CL like this:\r\n\r\n```\r\nCL1 -> jwt1 ->\r\nCL2 -> jwt2 -> middleware -> jwt4 -> EL\r\nCL3 -> jwt3 ->\r\n```\r\n\r\nEach CL could use a unique [`id`](https://github.com/ethereum/execution-apis/blob/main/src/engine/authentication.md#jwt-claims) in its claims so that the middleware knows which JWT secret to use when verifying. The middleware would then only forward sensitive requests (like `forkchoiceUpdated`) for the currently nominated controlling CL (which could change dynamically!). For this it would use a separate JWT secret known only to the middleware and the EL. Anyway, this scheme _still_ doesn't require custom headers and would be do-able using Lighthouse's existing `--execution-jwt-id` flag.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1203418825/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1204862466",
    "html_url": "https://github.com/sigp/lighthouse/issues/3409#issuecomment-1204862466",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3409",
    "id": 1204862466,
    "node_id": "IC_kwDOCFeAzc5H0L4C",
    "user": {
      "login": "pablomendezroyo",
      "id": 41727368,
      "node_id": "MDQ6VXNlcjQxNzI3MzY4",
      "avatar_url": "https://avatars.githubusercontent.com/u/41727368?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pablomendezroyo",
      "html_url": "https://github.com/pablomendezroyo",
      "followers_url": "https://api.github.com/users/pablomendezroyo/followers",
      "following_url": "https://api.github.com/users/pablomendezroyo/following{/other_user}",
      "gists_url": "https://api.github.com/users/pablomendezroyo/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pablomendezroyo/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pablomendezroyo/subscriptions",
      "organizations_url": "https://api.github.com/users/pablomendezroyo/orgs",
      "repos_url": "https://api.github.com/users/pablomendezroyo/repos",
      "events_url": "https://api.github.com/users/pablomendezroyo/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pablomendezroyo/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-04T07:17:30Z",
    "updated_at": "2022-08-04T07:17:30Z",
    "author_association": "NONE",
    "body": "thank you for the suggestion!",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1204862466/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
