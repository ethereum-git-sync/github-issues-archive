{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/908",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/908/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/908/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/908/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/908",
  "id": 580284339,
  "node_id": "MDU6SXNzdWU1ODAyODQzMzk=",
  "number": 908,
  "title": "Ensure Sync aligns on epoch boundaries",
  "user": {
    "login": "AgeManning",
    "id": 7454587,
    "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/AgeManning",
    "html_url": "https://github.com/AgeManning",
    "followers_url": "https://api.github.com/users/AgeManning/followers",
    "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
    "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
    "organizations_url": "https://api.github.com/users/AgeManning/orgs",
    "repos_url": "https://api.github.com/users/AgeManning/repos",
    "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
    "received_events_url": "https://api.github.com/users/AgeManning/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 985647286,
      "node_id": "MDU6TGFiZWw5ODU2NDcyODY=",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/good%20first%20issue",
      "name": "good first issue",
      "color": "7057ff",
      "default": true,
      "description": "Good for newcomers"
    },
    {
      "id": 1802005347,
      "node_id": "MDU6TGFiZWwxODAyMDA1MzQ3",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/syncing",
      "name": "syncing",
      "color": "ff5b2d",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "divagant-martian",
    "id": 26765164,
    "node_id": "MDQ6VXNlcjI2NzY1MTY0",
    "avatar_url": "https://avatars.githubusercontent.com/u/26765164?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/divagant-martian",
    "html_url": "https://github.com/divagant-martian",
    "followers_url": "https://api.github.com/users/divagant-martian/followers",
    "following_url": "https://api.github.com/users/divagant-martian/following{/other_user}",
    "gists_url": "https://api.github.com/users/divagant-martian/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/divagant-martian/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/divagant-martian/subscriptions",
    "organizations_url": "https://api.github.com/users/divagant-martian/orgs",
    "repos_url": "https://api.github.com/users/divagant-martian/repos",
    "events_url": "https://api.github.com/users/divagant-martian/events{/privacy}",
    "received_events_url": "https://api.github.com/users/divagant-martian/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "divagant-martian",
      "id": 26765164,
      "node_id": "MDQ6VXNlcjI2NzY1MTY0",
      "avatar_url": "https://avatars.githubusercontent.com/u/26765164?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/divagant-martian",
      "html_url": "https://github.com/divagant-martian",
      "followers_url": "https://api.github.com/users/divagant-martian/followers",
      "following_url": "https://api.github.com/users/divagant-martian/following{/other_user}",
      "gists_url": "https://api.github.com/users/divagant-martian/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/divagant-martian/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/divagant-martian/subscriptions",
      "organizations_url": "https://api.github.com/users/divagant-martian/orgs",
      "repos_url": "https://api.github.com/users/divagant-martian/repos",
      "events_url": "https://api.github.com/users/divagant-martian/events{/privacy}",
      "received_events_url": "https://api.github.com/users/divagant-martian/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2020-03-12T23:44:21Z",
  "updated_at": "2020-04-27T04:18:10Z",
  "closed_at": "2020-04-27T04:18:10Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nDoing batched block downloads can be processed faster if the batch aligns to an epoch. From memory, this should naturally be the case for Finalized chain sync (provided the `BLOCKS_PER_BATCH` is a multiple of `slots_per_epoch`). \r\n\r\nThis issue, is to ensure that when a finalized chain is created, the batches always align to an epoch. \r\nThere is potentially an edge case when finalized chains switch (i.e more peers exist on a new finalized chain) and sync swaps to the new finalized chain. The new chain continues from where the old one left of, however it may be the case that this is no longer aligned to an epoch. \r\n\r\nWe need to make sure that when resuming or starting a finalized chain, we always start from an epoch boundary. If the resumed chain has some portion of an epoch worth of blocks downloaded, we should download the rest of the epoch, then continue from the next epoch. \r\n\r\nNote: This logic is all contained within `Network::sync::range_sync`\r\n\r\nFurther info given upon request",
  "closed_by": {
    "login": "AgeManning",
    "id": 7454587,
    "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/AgeManning",
    "html_url": "https://github.com/AgeManning",
    "followers_url": "https://api.github.com/users/AgeManning/followers",
    "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
    "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
    "organizations_url": "https://api.github.com/users/AgeManning/orgs",
    "repos_url": "https://api.github.com/users/AgeManning/repos",
    "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
    "received_events_url": "https://api.github.com/users/AgeManning/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/908/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/908/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/604045717",
    "html_url": "https://github.com/sigp/lighthouse/issues/908#issuecomment-604045717",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/908",
    "id": 604045717,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYwNDA0NTcxNw==",
    "user": {
      "login": "divagant-martian",
      "id": 26765164,
      "node_id": "MDQ6VXNlcjI2NzY1MTY0",
      "avatar_url": "https://avatars.githubusercontent.com/u/26765164?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/divagant-martian",
      "html_url": "https://github.com/divagant-martian",
      "followers_url": "https://api.github.com/users/divagant-martian/followers",
      "following_url": "https://api.github.com/users/divagant-martian/following{/other_user}",
      "gists_url": "https://api.github.com/users/divagant-martian/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/divagant-martian/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/divagant-martian/subscriptions",
      "organizations_url": "https://api.github.com/users/divagant-martian/orgs",
      "repos_url": "https://api.github.com/users/divagant-martian/repos",
      "events_url": "https://api.github.com/users/divagant-martian/events{/privacy}",
      "received_events_url": "https://api.github.com/users/divagant-martian/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-03-25T19:40:23Z",
    "updated_at": "2020-03-25T19:40:23Z",
    "author_association": "COLLABORATOR",
    "body": "I'll take this one",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/604045717/reactions",
      "total_count": 2,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 2,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/604754022",
    "html_url": "https://github.com/sigp/lighthouse/issues/908#issuecomment-604754022",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/908",
    "id": 604754022,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYwNDc1NDAyMg==",
    "user": {
      "login": "AgeManning",
      "id": 7454587,
      "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AgeManning",
      "html_url": "https://github.com/AgeManning",
      "followers_url": "https://api.github.com/users/AgeManning/followers",
      "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
      "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
      "organizations_url": "https://api.github.com/users/AgeManning/orgs",
      "repos_url": "https://api.github.com/users/AgeManning/repos",
      "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AgeManning/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-03-27T00:27:30Z",
    "updated_at": "2020-03-27T00:27:30Z",
    "author_association": "MEMBER",
    "body": "All yours",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/604754022/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/613228224",
    "html_url": "https://github.com/sigp/lighthouse/issues/908#issuecomment-613228224",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/908",
    "id": 613228224,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYxMzIyODIyNA==",
    "user": {
      "login": "AgeManning",
      "id": 7454587,
      "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AgeManning",
      "html_url": "https://github.com/AgeManning",
      "followers_url": "https://api.github.com/users/AgeManning/followers",
      "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
      "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
      "organizations_url": "https://api.github.com/users/AgeManning/orgs",
      "repos_url": "https://api.github.com/users/AgeManning/repos",
      "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AgeManning/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-04-14T05:06:18Z",
    "updated_at": "2020-04-14T05:06:18Z",
    "author_association": "MEMBER",
    "body": "@divagant-martian - Is there anything to report on this one?",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/613228224/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/613694295",
    "html_url": "https://github.com/sigp/lighthouse/issues/908#issuecomment-613694295",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/908",
    "id": 613694295,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYxMzY5NDI5NQ==",
    "user": {
      "login": "divagant-martian",
      "id": 26765164,
      "node_id": "MDQ6VXNlcjI2NzY1MTY0",
      "avatar_url": "https://avatars.githubusercontent.com/u/26765164?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/divagant-martian",
      "html_url": "https://github.com/divagant-martian",
      "followers_url": "https://api.github.com/users/divagant-martian/followers",
      "following_url": "https://api.github.com/users/divagant-martian/following{/other_user}",
      "gists_url": "https://api.github.com/users/divagant-martian/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/divagant-martian/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/divagant-martian/subscriptions",
      "organizations_url": "https://api.github.com/users/divagant-martian/orgs",
      "repos_url": "https://api.github.com/users/divagant-martian/repos",
      "events_url": "https://api.github.com/users/divagant-martian/events{/privacy}",
      "received_events_url": "https://api.github.com/users/divagant-martian/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-04-14T21:37:34Z",
    "updated_at": "2020-04-14T22:16:18Z",
    "author_association": "COLLABORATOR",
    "body": "Hi!, here is my take on the matter:\r\n\r\nFirst, I wasn't able to make it fail _properly_ (I'll explain). I asked @paulhauner for steps to reproduce a scenario where things could get misaligned, but he said this was more of a \"It might be happening\" thing, so I took his suggestion of playing with the sync sim.\r\n\r\nWhat I did was run the sync sim several times (all strategies) and check that the boundaries of the epochs in which each slot (start and end) fall are consistent with these slots. So concretely, that: \r\n```rust\r\nbatch_start_slot.epoch(slots_per_epoch).start_slot() == batch_start_slot\r\n``` \r\nand\r\n```rust\r\nbatch_end_slot.epoch(slots_per_epoch).start_slot() == batch_end_slot\r\n```\r\nLast one is the start slot of the epoch since the `end_slot` is not inclusive.\r\n\r\nWith `BLOCKS_PER_BATCH = 64` as in v0.2.0, instead of 50 (current value in master, which needs to be changed) they are consistent _as long as this batch is not the last one_ (thus the _properly_ above)\r\n\r\nIn the case of last batches, (I think) it makes sense to have them misaligned but not sure if it makes sense to have a batch in the first place. Some examples of things I got: \r\n\r\n```bash\r\nbatch_start_slot = 384\r\nbatch_end_slot = 385\r\ntarget_head_slot = 384\r\n# we just want to request one block\r\n-----\r\nbatch_start_slot = 360\r\nbatch_end_slot = 393\r\ntarget_head_slot = 392\r\n# I think this one is ok?\r\n```\r\nAll failures are on final batches, so: \r\n- If these failures (batches in which the `target_head_slot` falls between the start of the batch and the would-be-end) are admissible, I think this is ok. `BLOCKS_PER_BATCH` still needs to be changed tho.\r\n- If the batch should request blocks from slots beyond the `target_head_slot` then I think an improvement would be to change `BLOCKS_PER_BATCH` to `EPOCHS_PER_BATCH` and have each batch have a `start_epoch` and a number of `requested_epochs >= 1`. From what I understand, this is what is actually intended and this way if `slots_per_epoch` changes (I don't think it does? but still..) sync would still be consistent\r\n\r\nWhat do you think?",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/613694295/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/613838749",
    "html_url": "https://github.com/sigp/lighthouse/issues/908#issuecomment-613838749",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/908",
    "id": 613838749,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYxMzgzODc0OQ==",
    "user": {
      "login": "AgeManning",
      "id": 7454587,
      "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AgeManning",
      "html_url": "https://github.com/AgeManning",
      "followers_url": "https://api.github.com/users/AgeManning/followers",
      "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
      "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
      "organizations_url": "https://api.github.com/users/AgeManning/orgs",
      "repos_url": "https://api.github.com/users/AgeManning/repos",
      "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AgeManning/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-04-15T06:15:21Z",
    "updated_at": "2020-04-15T06:15:21Z",
    "author_association": "MEMBER",
    "body": "Hey awesome. \r\nThis sounds good to me. The case I was worried about off the top of my head, was when we switch to a higher priority (more peers) chain.\r\nhttps://github.com/sigp/lighthouse/blob/v0.2.0/beacon_node/network/src/sync/range_sync/chain_collection.rs#L206\r\nWe stop and start chains in this case: \r\nhttps://github.com/sigp/lighthouse/blob/v0.2.0/beacon_node/network/src/sync/range_sync/chain_collection.rs#L257\r\n\r\nThe start function should update the chain to already downloaded blocks:\r\nhttps://github.com/sigp/lighthouse/blob/v0.2.0/beacon_node/network/src/sync/range_sync/chain.rs#L528\r\n\r\nHowever after just skimming this it looks like we don't update the chain with the `local_finalized_slot` and simply start the chain again from scratch (woops). Unless I'm mistaken we should have a line in there that changes the `self.start_slot` to `local_finalized_slot`. \r\nMy concern was that `local_finalized_slot` might not lie on an epoch boundary. But it seems that it should right?\r\n\r\nCould you confirm this is a bug and update it so the chain updates. I think we would also update the logs. It looks to me that `chain.start_slot` should be replaced with `local_slot` in these lines:\r\nhttps://github.com/sigp/lighthouse/blob/v0.2.0/beacon_node/network/src/sync/range_sync/chain_collection.rs#L244\r\nhttps://github.com/sigp/lighthouse/blob/v0.2.0/beacon_node/network/src/sync/range_sync/chain_collection.rs#L248\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/613838749/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
