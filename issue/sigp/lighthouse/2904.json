{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/2904",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/2904/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/2904/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/2904/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/2904",
  "id": 1100447400,
  "node_id": "I_kwDOCFeAzc5Bl36o",
  "number": 2904,
  "title": "Beacon node excessive cpu usage",
  "user": {
    "login": "pnowosie",
    "id": 1813036,
    "node_id": "MDQ6VXNlcjE4MTMwMzY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1813036?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/pnowosie",
    "html_url": "https://github.com/pnowosie",
    "followers_url": "https://api.github.com/users/pnowosie/followers",
    "following_url": "https://api.github.com/users/pnowosie/following{/other_user}",
    "gists_url": "https://api.github.com/users/pnowosie/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/pnowosie/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/pnowosie/subscriptions",
    "organizations_url": "https://api.github.com/users/pnowosie/orgs",
    "repos_url": "https://api.github.com/users/pnowosie/repos",
    "events_url": "https://api.github.com/users/pnowosie/events{/privacy}",
    "received_events_url": "https://api.github.com/users/pnowosie/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 10,
  "created_at": "2022-01-12T15:03:54Z",
  "updated_at": "2022-05-18T07:04:32Z",
  "closed_at": "2022-05-18T07:04:32Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nI'm observing an excessive usage of the CPU (all cores, 100% constantly). It is permanent besides the node is fully synced.\r\n\r\n## Version\r\n\r\nI'm using [2.0.1 version](https://github.com/sigp/lighthouse/releases/tag/v2.0.1) with binaries available in GH release (lighthouse-v2.0.1-aarch64-unknown-linux-gnu.tar.gz) on custom 64-bit linux distro (build via [yocto](https://www.yoctoproject.org/))\r\nbut same behavioiur was observed on 64-bit ubuntu 20.04.\r\nHardware is RaspberryPi 4\r\n\r\nI'm syncing mainnet beacon chain. Here is a command\r\n```bash\r\nlighthouse bn --http \\\r\n  --datadir \"/DATA/lighthouse\" \\\r\n  --http-address \"0.0.0.0\" \\\r\n  --http-port 5052\r\n```\r\n\r\n## Present Behaviour\r\n\r\nCPU usage constantly on 100% on all (4) available cores which starves other processes.\r\nI've tested with setting `CPU Affinity` and limitting the process to just one core - it's able to sync - but it's still a bit too much and unexpected behaviour as the node is synced.\r\n\r\n\r\n## Expected Behaviour\r\n\r\nCPU usage increment is expected when the node is syncing new data. Then it should decrease.\r\n\r\n## Steps to resolve\r\n\r\n-\r\n",
  "closed_by": {
    "login": "michaelsproul",
    "id": 4452260,
    "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/michaelsproul",
    "html_url": "https://github.com/michaelsproul",
    "followers_url": "https://api.github.com/users/michaelsproul/followers",
    "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
    "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
    "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
    "repos_url": "https://api.github.com/users/michaelsproul/repos",
    "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
    "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/2904/reactions",
    "total_count": 2,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 2
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/2904/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1013977484",
    "html_url": "https://github.com/sigp/lighthouse/issues/2904#issuecomment-1013977484",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/2904",
    "id": 1013977484,
    "node_id": "IC_kwDOCFeAzc48cBGM",
    "user": {
      "login": "paulhauner",
      "id": 6660660,
      "node_id": "MDQ6VXNlcjY2NjA2NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/paulhauner",
      "html_url": "https://github.com/paulhauner",
      "followers_url": "https://api.github.com/users/paulhauner/followers",
      "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
      "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
      "organizations_url": "https://api.github.com/users/paulhauner/orgs",
      "repos_url": "https://api.github.com/users/paulhauner/repos",
      "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/paulhauner/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-01-16T23:27:47Z",
    "updated_at": "2022-01-16T23:27:47Z",
    "author_association": "MEMBER",
    "body": "Thanks for the report @pnowosie. Would you mind sharing the details of your CPU please? For example, using `less /proc/cpuinfo` I can see that my CPU is a `Intel(R) Core(TM) i7-8700K CPU @ 3.70GHz`.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1013977484/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1015211906",
    "html_url": "https://github.com/sigp/lighthouse/issues/2904#issuecomment-1015211906",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/2904",
    "id": 1015211906,
    "node_id": "IC_kwDOCFeAzc48gueC",
    "user": {
      "login": "pnowosie",
      "id": 1813036,
      "node_id": "MDQ6VXNlcjE4MTMwMzY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1813036?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pnowosie",
      "html_url": "https://github.com/pnowosie",
      "followers_url": "https://api.github.com/users/pnowosie/followers",
      "following_url": "https://api.github.com/users/pnowosie/following{/other_user}",
      "gists_url": "https://api.github.com/users/pnowosie/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pnowosie/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pnowosie/subscriptions",
      "organizations_url": "https://api.github.com/users/pnowosie/orgs",
      "repos_url": "https://api.github.com/users/pnowosie/repos",
      "events_url": "https://api.github.com/users/pnowosie/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pnowosie/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-01-18T09:13:56Z",
    "updated_at": "2022-01-18T09:13:56Z",
    "author_association": "NONE",
    "body": "```bash\r\nless /proc/cpuinfo\r\nprocessor       : 0\r\nBogoMIPS        : 108.00\r\nFeatures        : fp asimd evtstrm crc32 cpuid\r\nCPU implementer : 0x41\r\nCPU architecture: 8\r\nCPU variant     : 0x0\r\nCPU part        : 0xd08\r\nCPU revision    : 3\r\n\r\nprocessor       : 1\r\nBogoMIPS        : 108.00\r\nFeatures        : fp asimd evtstrm crc32 cpuid\r\nCPU implementer : 0x41\r\nCPU architecture: 8\r\nCPU variant     : 0x0\r\nCPU part        : 0xd08\r\nCPU revision    : 3\r\n\r\nprocessor       : 2\r\nBogoMIPS        : 108.00\r\nFeatures        : fp asimd evtstrm crc32 cpuid\r\nCPU implementer : 0x41\r\nCPU architecture: 8\r\nCPU variant     : 0x0\r\nCPU part        : 0xd08\r\nCPU revision    : 3\r\n\r\nprocessor       : 3\r\nBogoMIPS        : 108.00\r\nFeatures        : fp asimd evtstrm crc32 cpuid\r\nCPU implementer : 0x41\r\nCPU architecture: 8\r\nCPU variant     : 0x0\r\nCPU part        : 0xd08\r\nCPU revision    : 3\r\n\r\nHardware        : BCM2835\r\nRevision        : d03114\r\nSerial          : 10000000de8e140b\r\nModel           : Raspberry Pi 4 Model B Rev 1.4\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1015211906/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1020983534",
    "html_url": "https://github.com/sigp/lighthouse/issues/2904#issuecomment-1020983534",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/2904",
    "id": 1020983534,
    "node_id": "IC_kwDOCFeAzc482vju",
    "user": {
      "login": "pnowosie",
      "id": 1813036,
      "node_id": "MDQ6VXNlcjE4MTMwMzY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1813036?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pnowosie",
      "html_url": "https://github.com/pnowosie",
      "followers_url": "https://api.github.com/users/pnowosie/followers",
      "following_url": "https://api.github.com/users/pnowosie/following{/other_user}",
      "gists_url": "https://api.github.com/users/pnowosie/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pnowosie/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pnowosie/subscriptions",
      "organizations_url": "https://api.github.com/users/pnowosie/orgs",
      "repos_url": "https://api.github.com/users/pnowosie/repos",
      "events_url": "https://api.github.com/users/pnowosie/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pnowosie/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-01-25T09:31:14Z",
    "updated_at": "2022-01-25T09:31:14Z",
    "author_association": "NONE",
    "body": "Hey guys I'll appreciate any suggestions what I can do?\r\nI tried to set also `CPU Quota=50%`. It resulted to significant lagging (~hundreds of slots behind infura).\r\nThanks in advance to any help!",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1020983534/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1027558286",
    "html_url": "https://github.com/sigp/lighthouse/issues/2904#issuecomment-1027558286",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/2904",
    "id": 1027558286,
    "node_id": "IC_kwDOCFeAzc49P0uO",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-02-02T04:10:33Z",
    "updated_at": "2022-02-02T04:10:33Z",
    "author_association": "MEMBER",
    "body": "@pnowosie Running on a Raspi is \"hard mode\" for staking. The Rocket Pool docs contain some good tips: https://docs.rocketpool.net/guides/node/local/prepare-pi.html\r\n\r\nThe TL;DR is:\r\n\r\n* Use an 8GB Raspi\r\n* Don't try to run Geth on the same Pi that you run Lighthouse\r\n* Make sure you have a fast SSD connected via USB 3\r\n* Overclock if you're comfortable doing so",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1027558286/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1030709867",
    "html_url": "https://github.com/sigp/lighthouse/issues/2904#issuecomment-1030709867",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/2904",
    "id": 1030709867,
    "node_id": "IC_kwDOCFeAzc49b2Jr",
    "user": {
      "login": "jmcruz1983",
      "id": 15966694,
      "node_id": "MDQ6VXNlcjE1OTY2Njk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/15966694?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jmcruz1983",
      "html_url": "https://github.com/jmcruz1983",
      "followers_url": "https://api.github.com/users/jmcruz1983/followers",
      "following_url": "https://api.github.com/users/jmcruz1983/following{/other_user}",
      "gists_url": "https://api.github.com/users/jmcruz1983/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jmcruz1983/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jmcruz1983/subscriptions",
      "organizations_url": "https://api.github.com/users/jmcruz1983/orgs",
      "repos_url": "https://api.github.com/users/jmcruz1983/repos",
      "events_url": "https://api.github.com/users/jmcruz1983/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jmcruz1983/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-02-05T22:42:27Z",
    "updated_at": "2022-02-05T22:42:27Z",
    "author_association": "NONE",
    "body": "Hi guys,\r\nI am also suffering from cpu spikes when running beacon nodes in k8s\r\nwhere beacon usually is using 2-3 cpus and spiking to 6 cpus is causing  `SIGTERM`.\r\n```\r\nFeb 05 22:21:39.948 INFO Shutting down.. reason: Success(\"Received SIGTERM\")\r\n```\r\nBeacon node gets killed as it is depleting cpu available in the k8s node.\r\n\r\nAlso worth mentioning this happening after upgrading to `v2.1.1`.\r\n\r\nI would appreciate any suggestion to mitigate this issue.\r\nThanks",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1030709867/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1030936517",
    "html_url": "https://github.com/sigp/lighthouse/issues/2904#issuecomment-1030936517",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/2904",
    "id": 1030936517,
    "node_id": "IC_kwDOCFeAzc49ctfF",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-02-06T23:14:32Z",
    "updated_at": "2022-02-06T23:14:32Z",
    "author_association": "MEMBER",
    "body": "> Also worth mentioning this happening after upgrading to v2.1.1.\r\n\r\nIs this only happening after upgrading to v2.1.x?\r\n\r\n> I am also suffering from cpu spikes when running beacon nodes in k8s\r\nwhere beacon usually is using 2-3 cpus and spiking to 6 cpus is causing SIGTERM.\r\n\r\nLighthouse needs to spike CPU usage in order to keep latency low. For the beacon chain latency is everything: we want to be able to process blocks quickly and attest on time.\r\n\r\nI've never used Kubernetes before, but based on [this article](https://sysdig.com/blog/troubleshoot-kubernetes-oom/) it seems like K8s won't kill a task for using too much CPU:\r\n\r\n> _A container using more memory than the limit will most likely die, but using CPU can never be the reason of Kubernetes killing a container. CPU management is delegated to the system scheduler, and it uses two different mechanisms for the requests and the limits enforcement._\r\n\r\nIt might be worth checking your K8s memory limits to see if Lighthouse is exceeding them. If the OOM killer is in play then `dmesg` should show the kill in its log.\r\n\r\n> I would appreciate any suggestion to mitigate this issue.\r\n\r\nIn addition to checking the memory limit (and raising it if necessary) I think you could also try:\r\n\r\n* Setting the number of virtual CPUs available to Lighthouse (I _think_ K8s [`-cpus N`](https://kubernetes.io/docs/tasks/configure-pod-container/assign-cpu-resource/#specify-a-cpu-request-and-a-cpu-limit) flag might do this).\r\n* Setting the `RAYON_NUM_THREADS` environment variable.\r\n* If memory usage is an issue, setting the `MALLOC_ARENA_MAX` environment variable to 1 or 2 (prevents heap fragmentation at the cost of CPU usage).\r\n\r\nAll of these changes come with trade-offs however, and Lighthouse is unlikely to perform as well when its CPU and memory are tightly constrained.\r\n\r\nI've also opened https://github.com/sigp/lighthouse/issues/3000 to track some changes we could make in Lighthouse to make configuring the number of threads used more straightforward.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1030936517/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1031262972",
    "html_url": "https://github.com/sigp/lighthouse/issues/2904#issuecomment-1031262972",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/2904",
    "id": 1031262972,
    "node_id": "IC_kwDOCFeAzc49d9L8",
    "user": {
      "login": "jmcruz1983",
      "id": 15966694,
      "node_id": "MDQ6VXNlcjE1OTY2Njk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/15966694?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jmcruz1983",
      "html_url": "https://github.com/jmcruz1983",
      "followers_url": "https://api.github.com/users/jmcruz1983/followers",
      "following_url": "https://api.github.com/users/jmcruz1983/following{/other_user}",
      "gists_url": "https://api.github.com/users/jmcruz1983/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jmcruz1983/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jmcruz1983/subscriptions",
      "organizations_url": "https://api.github.com/users/jmcruz1983/orgs",
      "repos_url": "https://api.github.com/users/jmcruz1983/repos",
      "events_url": "https://api.github.com/users/jmcruz1983/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jmcruz1983/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-02-07T09:42:28Z",
    "updated_at": "2022-02-07T11:35:38Z",
    "author_association": "NONE",
    "body": "Thanks @michaelsproul for reply\r\n\r\n> Is this only happening after upgrading to v2.1.x?\r\n\r\nYes I tested with `v2.1.1`, `v2.1.2` & `v2.1.2-modern` and all of them were spiking and getting killed.\r\n\r\n> I've never used Kubernetes before, but based on [this article](https://sysdig.com/blog/troubleshoot-kubernetes-oom/) it seems like K8s won't kill a task for using too much CPU:\r\n\r\nYes I am aware that k8s doesn't kill you when running above cpu request limit. And I don't have a hard limit configured, so basically would use all the cpu available.\r\nBut the case here is that beacons are getting killed because they are using all the cpu available in the node and node kills them to avoid cpu depletion. \r\n\r\n> In addition to checking the memory limit (and raising it if necessary) I think you could also try:\r\n\r\nCurrently each beacon is running with 3 cpus allocated as soft limit (request limit) and no hard limit so it can use all the cpu available in the node (each node has 4 cpus). \r\nJust worth to mention that 3 cpus were more than enough for `v2.0.1` and they never got killed.\r\n\r\nThanks",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1031262972/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1031364417",
    "html_url": "https://github.com/sigp/lighthouse/issues/2904#issuecomment-1031364417",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/2904",
    "id": 1031364417,
    "node_id": "IC_kwDOCFeAzc49eV9B",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-02-07T11:30:14Z",
    "updated_at": "2022-02-07T11:30:14Z",
    "author_association": "MEMBER",
    "body": "> node kills them to avoid memory depletion.\r\n\r\nHow much memory is each beacon node using when it gets killed? The SigP mainnet nodes use 1.2 GB - 2.3 GB each.\r\n\r\n> Just worth to mention that 3 cpus were more than enough for v2.0.1 and they never got killed.\r\n\r\nThe main change since v2.0.1 that could cause increased memory usage is https://github.com/sigp/lighthouse/pull/2832, which opts to keep more beacon states available in memory so that block processing can be faster. If memory usage is just a bit higher it could be that change, but if it's a lot higher it could be fragmentation. We have a [Malloc Info](https://gist.github.com/michaelsproul/abe1ece32c42d611e6a862915c7a33a7) Grafana dashboard that will show the breakdown of memory usage: look for high free block memory (indicates fragmentation) or high mmap usage correlated with the snapshot cache size (indicates #2832).\r\n\r\nCould you also please try the `MALLOC_ARENA_MAX=1` env var and let me know if that helps?\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1031364417/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1031380817",
    "html_url": "https://github.com/sigp/lighthouse/issues/2904#issuecomment-1031380817",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/2904",
    "id": 1031380817,
    "node_id": "IC_kwDOCFeAzc49eZ9R",
    "user": {
      "login": "jmcruz1983",
      "id": 15966694,
      "node_id": "MDQ6VXNlcjE1OTY2Njk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/15966694?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jmcruz1983",
      "html_url": "https://github.com/jmcruz1983",
      "followers_url": "https://api.github.com/users/jmcruz1983/followers",
      "following_url": "https://api.github.com/users/jmcruz1983/following{/other_user}",
      "gists_url": "https://api.github.com/users/jmcruz1983/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jmcruz1983/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jmcruz1983/subscriptions",
      "organizations_url": "https://api.github.com/users/jmcruz1983/orgs",
      "repos_url": "https://api.github.com/users/jmcruz1983/repos",
      "events_url": "https://api.github.com/users/jmcruz1983/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jmcruz1983/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-02-07T11:49:37Z",
    "updated_at": "2022-02-07T11:49:37Z",
    "author_association": "NONE",
    "body": "My bad @michaelsproul \r\nI corrected my comment above.\r\n\r\nMy issue is entirely related to cpu consumption.\r\nBeacons when spiking are using max cpu available in the node and get killed.\r\nEach node where beacons run have 4 cpus and we allocate already 3 cpus to each beacon.\r\n\r\nI don't have any problem with memory as we grant plenty of memory to each beacon. \r\n\r\nHere I am attaching an screenshot from the resource dashboard,\r\nwe after upgrading to `v2.1.x` cpu was spiking:\r\n<img width=\"1589\" alt=\"cpu\" src=\"https://user-images.githubusercontent.com/15966694/152782787-27b09607-b621-4d02-a133-b3957b92ce44.png\">\r\nAfter downgrading to v2.0.1 cpu was back to range.\r\n\r\nThanks",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1031380817/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1129647298",
    "html_url": "https://github.com/sigp/lighthouse/issues/2904#issuecomment-1129647298",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/2904",
    "id": 1129647298,
    "node_id": "IC_kwDOCFeAzc5DVQzC",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-18T07:04:32Z",
    "updated_at": "2022-05-18T07:04:32Z",
    "author_association": "MEMBER",
    "body": "Closing because this is stale, and the scope is overly broad. If we find a specific bug that induces increased CPU usage we can open a new issue",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1129647298/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
