{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/4564",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/4564/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/4564/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/4564/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/4564",
  "id": 1832731065,
  "node_id": "I_kwDOCFeAzc5tPUG5",
  "number": 4564,
  "title": "Reduce binary size by compressing `genesis.ssz`",
  "user": {
    "login": "paulhauner",
    "id": 6660660,
    "node_id": "MDQ6VXNlcjY2NjA2NjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/paulhauner",
    "html_url": "https://github.com/paulhauner",
    "followers_url": "https://api.github.com/users/paulhauner/followers",
    "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
    "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
    "organizations_url": "https://api.github.com/users/paulhauner/orgs",
    "repos_url": "https://api.github.com/users/paulhauner/repos",
    "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
    "received_events_url": "https://api.github.com/users/paulhauner/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1999784343,
      "node_id": "MDU6TGFiZWwxOTk5Nzg0MzQz",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/optimization",
      "name": "optimization",
      "color": "f9de40",
      "default": false,
      "description": "Something to make Lighthouse run more efficiently."
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2023-08-02T08:48:36Z",
  "updated_at": "2023-08-04T15:19:40Z",
  "closed_at": null,
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nWe presently include the *uncompressed* genesis state for supported networks in our binary. We have several of these files:\r\n\r\n```bash\r\n[3.3M]  common/eth2_network_config/built_in_network_configs/chiado/genesis.ssz\r\n[3.1M]  common/eth2_network_config/built_in_network_configs/gnosis/genesis.ssz\r\n[5.2M]  common/eth2_network_config/built_in_network_configs/mainnet/genesis.ssz\r\n[ 28M]  common/eth2_network_config/built_in_network_configs/prater/genesis.ssz\r\n[ 15M]  common/eth2_network_config/built_in_network_configs/ropsten/genesis.ssz\r\n[2.8M]  common/eth2_network_config/built_in_network_configs/sepolia/genesis.ssz\r\n```\r\n\r\nThe total of these files is 57.4M, which goes straight to our ~~hips~~ binary size (presently ~110M). I suspect we could significantly reduce the size of the binaries by storing *compressed* `genesis.ssz` bytes in the binary and then decompressing on-demand (i.e. at startup).\r\n\r\nI propose that we use *snappy* compression, since it's used by the P2P layer and therefore available in the binary.\r\n\r\nBefore committing to this change, I would be keen to know the time it takes to decompress the state at startup. Perhaps getting numbers for mainnet and Prater would be good. We want to be careful not to slow-down BN/VC startup.\r\n\r\n## Details\r\n\r\nThe method for including the `genesis.ssz` can be a bit tricky to understand because it's written in macros. I think this should be fairly straight-forward once you get your head across it. I've included some links below to give a lay of the land.\r\n\r\nThe bytes are added to the binary here:\r\n\r\nhttps://github.com/sigp/lighthouse/blob/dfcb3363c757671eb19d5f8e519b4b94ac74677a/common/eth2_config/src/lib.rs#L129-L137\r\n\r\nThe `genesis.ssz` file used by the `include_bytes!` macro is generated here (this is where we'd want to do the snappy compression):\r\n\r\nhttps://github.com/sigp/lighthouse/blob/dfcb3363c757671eb19d5f8e519b4b94ac74677a/common/eth2_network_config/build.rs#L30-L47\r\n\r\nThe application accesses the included bytes here (this is where we'd want to do the snappy *decompression*):\r\n\r\nhttps://github.com/sigp/lighthouse/blob/dfcb3363c757671eb19d5f8e519b4b94ac74677a/common/eth2_network_config/src/lib.rs#L98-L108",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/4564/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/4564/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1661793240",
    "html_url": "https://github.com/sigp/lighthouse/issues/4564#issuecomment-1661793240",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4564",
    "id": 1661793240,
    "node_id": "IC_kwDOCFeAzc5jDPPY",
    "user": {
      "login": "paulhauner",
      "id": 6660660,
      "node_id": "MDQ6VXNlcjY2NjA2NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/paulhauner",
      "html_url": "https://github.com/paulhauner",
      "followers_url": "https://api.github.com/users/paulhauner/followers",
      "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
      "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
      "organizations_url": "https://api.github.com/users/paulhauner/orgs",
      "repos_url": "https://api.github.com/users/paulhauner/repos",
      "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/paulhauner/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-08-02T08:48:53Z",
    "updated_at": "2023-08-02T08:48:53Z",
    "author_association": "MEMBER",
    "body": "Credit to @dapplion for suggesting this in a DM.\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1661793240/reactions",
      "total_count": 2,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 2,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1662320898",
    "html_url": "https://github.com/sigp/lighthouse/issues/4564#issuecomment-1662320898",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4564",
    "id": 1662320898,
    "node_id": "IC_kwDOCFeAzc5jFQEC",
    "user": {
      "login": "eserilev",
      "id": 7217615,
      "node_id": "MDQ6VXNlcjcyMTc2MTU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7217615?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/eserilev",
      "html_url": "https://github.com/eserilev",
      "followers_url": "https://api.github.com/users/eserilev/followers",
      "following_url": "https://api.github.com/users/eserilev/following{/other_user}",
      "gists_url": "https://api.github.com/users/eserilev/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/eserilev/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/eserilev/subscriptions",
      "organizations_url": "https://api.github.com/users/eserilev/orgs",
      "repos_url": "https://api.github.com/users/eserilev/repos",
      "events_url": "https://api.github.com/users/eserilev/events{/privacy}",
      "received_events_url": "https://api.github.com/users/eserilev/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-08-02T14:30:42Z",
    "updated_at": "2023-08-02T14:30:42Z",
    "author_association": "CONTRIBUTOR",
    "body": "I'd like to work on this. I can start by benchmarking the time it takes to decompress the mainnet/prater genesis state and post the results here",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1662320898/reactions",
      "total_count": 2,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 2,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1665529422",
    "html_url": "https://github.com/sigp/lighthouse/issues/4564#issuecomment-1665529422",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4564",
    "id": 1665529422,
    "node_id": "IC_kwDOCFeAzc5jRfZO",
    "user": {
      "login": "eserilev",
      "id": 7217615,
      "node_id": "MDQ6VXNlcjcyMTc2MTU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7217615?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/eserilev",
      "html_url": "https://github.com/eserilev",
      "followers_url": "https://api.github.com/users/eserilev/followers",
      "following_url": "https://api.github.com/users/eserilev/following{/other_user}",
      "gists_url": "https://api.github.com/users/eserilev/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/eserilev/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/eserilev/subscriptions",
      "organizations_url": "https://api.github.com/users/eserilev/orgs",
      "repos_url": "https://api.github.com/users/eserilev/repos",
      "events_url": "https://api.github.com/users/eserilev/events{/privacy}",
      "received_events_url": "https://api.github.com/users/eserilev/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-08-04T12:27:42Z",
    "updated_at": "2023-08-04T15:19:40Z",
    "author_association": "CONTRIBUTOR",
    "body": "I have a repo here: https://github.com/eserilev/snappy-genesis-benchmark that compresses/decompresses `genesis.ssz` files for mainnet and prater. I left some notes in the README. To summarize:\r\n\r\nOn my machine the time it took to decompress `genesis.ssz`:\r\n\r\n```\r\nmainnet: 1.5s\r\nprater: 9.8s\r\n```\r\n\r\nfile sizes for the compressed and decompressed `genesis.ssz`\r\n```\r\ndecompressed mainnet: 5.4M\r\ncompressed mainnet: 1.8M\r\n\r\ndecompressed prater: 29.8M\r\ncompressed prater: 18.1M\r\n``` \r\nSnappy compression seems to reduce file size by ~50%, while increasing start-up time by potentially 10s of seconds.\r\n\r\nI measured elapsed time using `std::time::Instant::now()`, which I think should be sufficient. We could do more elaborate benchmarking, but I think thats probably overkill\r\n\r\nI think adding 10s of seconds to BN/VC start up time is a fair trade off for reducing ~25M in binary size. What do you think?",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1665529422/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
