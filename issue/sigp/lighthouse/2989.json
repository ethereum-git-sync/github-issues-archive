{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/2989",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/2989/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/2989/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/2989/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/2989",
  "id": 1121505584,
  "node_id": "I_kwDOCFeAzc5C2NEw",
  "number": 2989,
  "title": "Gossipsub message queuing",
  "user": {
    "login": "AgeManning",
    "id": 7454587,
    "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/AgeManning",
    "html_url": "https://github.com/AgeManning",
    "followers_url": "https://api.github.com/users/AgeManning/followers",
    "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
    "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
    "organizations_url": "https://api.github.com/users/AgeManning/orgs",
    "repos_url": "https://api.github.com/users/AgeManning/repos",
    "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
    "received_events_url": "https://api.github.com/users/AgeManning/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 2336800125,
      "node_id": "MDU6TGFiZWwyMzM2ODAwMTI1",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/t%20Networking",
      "name": "t Networking",
      "color": "40E0D0",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2022-02-02T04:49:01Z",
  "updated_at": "2022-10-20T17:08:32Z",
  "closed_at": null,
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nAlthough in practice this is a code modification for the rust-libp2p repo, it's useful to discuss and track here as the ramifications will affect Lighthouse.\r\n\r\nIf a node has limited outbound bandwidth, in principle we could build up enormous queues in the peer `Handler` inside gossipsub. Messages could be queued for a while and when eventually sent, could be sent very late.\r\n\r\nThis could be one reason we are seeing nodes sending late messages, essentially that their outbound bandwidth is limited and we just queue for large periods of time.\r\n\r\nThere are two solutions I was contemplating:\r\n1. For each message in a handler's message queue (called `send_queue` in handler.rs) we tag it with a timestamp or duration in which it must be sent otherwise it is expired and dropped. I imagine this could be configurable as a default message timeout, or we could be fancy and implement some system that does it per-message. I think its simpler for a single timeout for all messages compareable to a few gossipsub heartbeats. Any messages that can't be processed in this time, expire and are dropped and we can emit an event to the end-user indicating this is occuring.\r\n2. We bound the handler outbound message queue. Overflowing this bound, would result in dropping new messages. Its a simpler approach to 1. but I think it's in our best interest (and gossipsub in general) to preference lively messages (i.e option 1.) rather than preference of when was published (option 2.)\r\n\r\nA useful thing to note is that these queue's exist per-peer. So some peers can be slower than others and the timeout approach in 1. makes expirations uniform regardless of invidivudal peers connection speeds.",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/2989/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/2989/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1027582516",
    "html_url": "https://github.com/sigp/lighthouse/issues/2989#issuecomment-1027582516",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/2989",
    "id": 1027582516,
    "node_id": "IC_kwDOCFeAzc49P6o0",
    "user": {
      "login": "winksaville",
      "id": 1024284,
      "node_id": "MDQ6VXNlcjEwMjQyODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1024284?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/winksaville",
      "html_url": "https://github.com/winksaville",
      "followers_url": "https://api.github.com/users/winksaville/followers",
      "following_url": "https://api.github.com/users/winksaville/following{/other_user}",
      "gists_url": "https://api.github.com/users/winksaville/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/winksaville/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/winksaville/subscriptions",
      "organizations_url": "https://api.github.com/users/winksaville/orgs",
      "repos_url": "https://api.github.com/users/winksaville/repos",
      "events_url": "https://api.github.com/users/winksaville/events{/privacy}",
      "received_events_url": "https://api.github.com/users/winksaville/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-02-02T05:05:13Z",
    "updated_at": "2022-02-02T05:05:13Z",
    "author_association": "CONTRIBUTOR",
    "body": "Is there a metric or log entry on the length of these queues? It might be nice to see stats on the max length over the last 24 hours and max length life time.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1027582516/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1027604805",
    "html_url": "https://github.com/sigp/lighthouse/issues/2989#issuecomment-1027604805",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/2989",
    "id": 1027604805,
    "node_id": "IC_kwDOCFeAzc49QAFF",
    "user": {
      "login": "AgeManning",
      "id": 7454587,
      "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AgeManning",
      "html_url": "https://github.com/AgeManning",
      "followers_url": "https://api.github.com/users/AgeManning/followers",
      "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
      "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
      "organizations_url": "https://api.github.com/users/AgeManning/orgs",
      "repos_url": "https://api.github.com/users/AgeManning/repos",
      "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AgeManning/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-02-02T05:36:48Z",
    "updated_at": "2022-02-02T05:36:48Z",
    "author_association": "MEMBER",
    "body": "Not inside gossipsub. We've only just introduced some more advanced metrics in gossipsub but these queues are not part of it.\r\n\r\nLighthouse has a bunch of metrics, but according to those and our code, we send in a timely fashion but we're seeing different results on the network, leading me to believe its the lower layer libp2p we may need to adjust.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1027604805/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1061010274",
    "html_url": "https://github.com/sigp/lighthouse/issues/2989#issuecomment-1061010274",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/2989",
    "id": 1061010274,
    "node_id": "IC_kwDOCFeAzc4_Pbti",
    "user": {
      "login": "divagant-martian",
      "id": 26765164,
      "node_id": "MDQ6VXNlcjI2NzY1MTY0",
      "avatar_url": "https://avatars.githubusercontent.com/u/26765164?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/divagant-martian",
      "html_url": "https://github.com/divagant-martian",
      "followers_url": "https://api.github.com/users/divagant-martian/followers",
      "following_url": "https://api.github.com/users/divagant-martian/following{/other_user}",
      "gists_url": "https://api.github.com/users/divagant-martian/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/divagant-martian/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/divagant-martian/subscriptions",
      "organizations_url": "https://api.github.com/users/divagant-martian/orgs",
      "repos_url": "https://api.github.com/users/divagant-martian/repos",
      "events_url": "https://api.github.com/users/divagant-martian/events{/privacy}",
      "received_events_url": "https://api.github.com/users/divagant-martian/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-03-07T18:43:42Z",
    "updated_at": "2022-03-07T18:43:42Z",
    "author_association": "COLLABORATOR",
    "body": "is this something we still want to do now that we have found the reason behind the late messages?",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1061010274/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
