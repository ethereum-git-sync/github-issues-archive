{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/4856",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/4856/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/4856/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/4856/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/4856",
  "id": 1949572849,
  "node_id": "I_kwDOCFeAzc50NB7x",
  "number": 4856,
  "title": "Rewards API: proposer rewards are incorrectly included in phase 0 attestation rewards",
  "user": {
    "login": "jimmygchen",
    "id": 742762,
    "node_id": "MDQ6VXNlcjc0Mjc2Mg==",
    "avatar_url": "https://avatars.githubusercontent.com/u/742762?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jimmygchen",
    "html_url": "https://github.com/jimmygchen",
    "followers_url": "https://api.github.com/users/jimmygchen/followers",
    "following_url": "https://api.github.com/users/jimmygchen/following{/other_user}",
    "gists_url": "https://api.github.com/users/jimmygchen/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jimmygchen/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jimmygchen/subscriptions",
    "organizations_url": "https://api.github.com/users/jimmygchen/orgs",
    "repos_url": "https://api.github.com/users/jimmygchen/repos",
    "events_url": "https://api.github.com/users/jimmygchen/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jimmygchen/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 985647281,
      "node_id": "MDU6TGFiZWw5ODU2NDcyODE=",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/bug",
      "name": "bug",
      "color": "d73a4a",
      "default": true,
      "description": "Something isn't working"
    },
    {
      "id": 2336800343,
      "node_id": "MDU6TGFiZWwyMzM2ODAwMzQz",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/HTTP-API",
      "name": "HTTP-API",
      "color": "5A63A2",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2023-10-18T11:59:31Z",
  "updated_at": "2023-10-25T12:50:41Z",
  "closed_at": null,
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\n[Attestation Rewards API specification](https://ethereum.github.io/beacon-APIs/?urls.primaryName=dev#/Rewards/getAttestationsRewards)\r\n\r\nWhile reviewing #4512, we noticed that **Phase 0** proposer rewards are being incorrectly included  as part of  `inclusion_delay`, which falls under attestation rewards. We know this because the attestation rewards tests below are passing without taking block rewards into account: \r\n\r\nhttps://github.com/sigp/lighthouse/blob/fc7f1ba6b94ac3300338aad4d5168aaac5df3fac/beacon_node/beacon_chain/tests/rewards.rs#L130 \r\nhttps://github.com/sigp/lighthouse/blob/fc7f1ba6b94ac3300338aad4d5168aaac5df3fac/beacon_node/beacon_chain/tests/rewards.rs#L171\r\nhttps://github.com/sigp/lighthouse/blob/fc7f1ba6b94ac3300338aad4d5168aaac5df3fac/beacon_node/beacon_chain/tests/rewards.rs#L223\r\n\r\nIf we add block rewards to the validator balances, these tests will fail. \r\n\r\nThanks to @zack-scott for working on Altair attestation rewards calculation and adding tests in #4807, which helped uncover this bug! ☺️ \r\n\r\n## Version\r\n\r\nLighthouse 4.5.0\r\n\r\n## Present Behaviour\r\n\r\n`inclusion_delay` in attestation rewards response incorrectly includes proposer rewards, which means the `total_rewards.inclusion_delay` could exceed `ideal_rewards.inclusion_delay` if the validator is a proposer in the epoch.\r\n\r\n## Expected Behaviour\r\n\r\n`inclusion_delay` in attestation rewards response should exclude proposer rewards amount.\r\n\r\n## Additional Info\r\n\r\nSome suggestions on fixing this:\r\n- [Calculate block rewards](https://github.com/sigp/lighthouse/pull/4807/files#diff-1169096a7f174331a2c69819e18b6ede3d40f3951d539f6d6f0de38e01878b39R250-R257) in the tests and apply the rewards to validators balance, this should make the phase 0 rewards tests listed above fail.\r\n- When calculating attestation rewards, we pass a `Vec` of validator indices to [`get_attestation_deltas_subset`](https://github.com/sigp/lighthouse/blob/fc7f1ba6b94ac3300338aad4d5168aaac5df3fac/consensus/state_processing/src/per_epoch_processing/base/rewards_and_penalties.rs#L86), which in turn calls the [`get_attestation_deltas`](https://github.com/sigp/lighthouse/blob/fc7f1ba6b94ac3300338aad4d5168aaac5df3fac/consensus/state_processing/src/per_epoch_processing/base/rewards_and_penalties.rs#L106) function to calculate attestation rewards delta. Note that this same function is also used by the consensus crate during state processing, and we currently use the following logic to decide whether to include validator delta for the rewards API:\r\nhttps://github.com/sigp/lighthouse/blob/fc7f1ba6b94ac3300338aad4d5168aaac5df3fac/consensus/state_processing/src/per_epoch_processing/base/rewards_and_penalties.rs#L122-L127\r\n\r\nThe `include_validator_delta` function is then used to compute:\r\n1. whether to include compute attestation rewards deltas for the validator\r\n2. whether to add proposer rewards delta to the validator delta\r\n\r\nThis is fine for consensus state processing, however we should exclude the proposer rewards (2) above when calling this function from the rewards API. \r\n\r\nA nice suggestion from @michaelsproul is to replace the `maybe_validators_subset` `Option` here with an enum (e.g. `RewardsCalculationType` or a better name!), which contains `Consensus` and `API(&Vec<usize>)` variants, and always exclude proposer rewards if `rewards_calculation_type == API`.\r\n\r\nhttps://github.com/sigp/lighthouse/blob/fc7f1ba6b94ac3300338aad4d5168aaac5df3fac/consensus/state_processing/src/per_epoch_processing/base/rewards_and_penalties.rs#L106-L111",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/4856/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/4856/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1769061291",
    "html_url": "https://github.com/sigp/lighthouse/issues/4856#issuecomment-1769061291",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4856",
    "id": 1769061291,
    "node_id": "IC_kwDOCFeAzc5pcbur",
    "user": {
      "login": "Gua00va",
      "id": 105484243,
      "node_id": "U_kgDOBkmP0w",
      "avatar_url": "https://avatars.githubusercontent.com/u/105484243?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Gua00va",
      "html_url": "https://github.com/Gua00va",
      "followers_url": "https://api.github.com/users/Gua00va/followers",
      "following_url": "https://api.github.com/users/Gua00va/following{/other_user}",
      "gists_url": "https://api.github.com/users/Gua00va/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Gua00va/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Gua00va/subscriptions",
      "organizations_url": "https://api.github.com/users/Gua00va/orgs",
      "repos_url": "https://api.github.com/users/Gua00va/repos",
      "events_url": "https://api.github.com/users/Gua00va/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Gua00va/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-10-18T17:59:15Z",
    "updated_at": "2023-10-18T17:59:15Z",
    "author_association": "CONTRIBUTOR",
    "body": "I would like to work on this.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1769061291/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1777174998",
    "html_url": "https://github.com/sigp/lighthouse/issues/4856#issuecomment-1777174998",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4856",
    "id": 1777174998,
    "node_id": "IC_kwDOCFeAzc5p7YnW",
    "user": {
      "login": "Gua00va",
      "id": 105484243,
      "node_id": "U_kgDOBkmP0w",
      "avatar_url": "https://avatars.githubusercontent.com/u/105484243?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Gua00va",
      "html_url": "https://github.com/Gua00va",
      "followers_url": "https://api.github.com/users/Gua00va/followers",
      "following_url": "https://api.github.com/users/Gua00va/following{/other_user}",
      "gists_url": "https://api.github.com/users/Gua00va/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Gua00va/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Gua00va/subscriptions",
      "organizations_url": "https://api.github.com/users/Gua00va/orgs",
      "repos_url": "https://api.github.com/users/Gua00va/repos",
      "events_url": "https://api.github.com/users/Gua00va/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Gua00va/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-10-24T13:09:31Z",
    "updated_at": "2023-10-24T13:09:31Z",
    "author_association": "CONTRIBUTOR",
    "body": "@jimmygchen, Why is ok to include inclusion delay in Consensus but not in thr Rewards API?  ",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1777174998/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1777249838",
    "html_url": "https://github.com/sigp/lighthouse/issues/4856#issuecomment-1777249838",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4856",
    "id": 1777249838,
    "node_id": "IC_kwDOCFeAzc5p7q4u",
    "user": {
      "login": "zack-scott",
      "id": 106991885,
      "node_id": "U_kgDOBmCRDQ",
      "avatar_url": "https://avatars.githubusercontent.com/u/106991885?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/zack-scott",
      "html_url": "https://github.com/zack-scott",
      "followers_url": "https://api.github.com/users/zack-scott/followers",
      "following_url": "https://api.github.com/users/zack-scott/following{/other_user}",
      "gists_url": "https://api.github.com/users/zack-scott/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/zack-scott/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/zack-scott/subscriptions",
      "organizations_url": "https://api.github.com/users/zack-scott/orgs",
      "repos_url": "https://api.github.com/users/zack-scott/repos",
      "events_url": "https://api.github.com/users/zack-scott/events{/privacy}",
      "received_events_url": "https://api.github.com/users/zack-scott/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-10-24T13:50:44Z",
    "updated_at": "2023-10-24T14:00:39Z",
    "author_association": "NONE",
    "body": "@Gua00va from what I understand, the inclusion delay is okay to include in Rewards API for Phase0. The issue is that the inclusion delay is also counting proposal rewards that you would see from the `/eth/v1/beacon/rewards/blocks/{block_id}` API.\r\n\r\nThe present behavior is:\r\n`inclusion_delay` in attestation rewards response incorrectly includes `proposer rewards`, which means the `total_rewards.inclusion_delay` could exceed `ideal_rewards.inclusion_delay` **if the validator is a proposer in the epoch**.\r\n\r\nThe Phase0 reward test is passing at the moment without taking into account proposal rewards, which is wrong due to inclusion_delay double counting. One of the tests passing for Phase0 that shouldn't is below:\r\nhttps://github.com/sigp/lighthouse/blob/unstable/beacon_node/beacon_chain/tests/rewards.rs#L171\r\n\r\n\r\nThe Altair test I wrote for inactivity leak is taking into account the proposal rewards with the logic starting on the line below:\r\nhttps://github.com/sigp/lighthouse/blob/unstable/beacon_node/beacon_chain/tests/rewards.rs#L242\r\n\r\nFor the [Phase0 test](https://github.com/sigp/lighthouse/blob/unstable/beacon_node/beacon_chain/tests/rewards.rs#L171), we will need to take into account the proposal rewards similar to the Altair test, and we need to remove the proposal reward double counting in the `inclusion_delay` for Phase0.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1777249838/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1778557032",
    "html_url": "https://github.com/sigp/lighthouse/issues/4856#issuecomment-1778557032",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4856",
    "id": 1778557032,
    "node_id": "IC_kwDOCFeAzc5qAqBo",
    "user": {
      "login": "Gua00va",
      "id": 105484243,
      "node_id": "U_kgDOBkmP0w",
      "avatar_url": "https://avatars.githubusercontent.com/u/105484243?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Gua00va",
      "html_url": "https://github.com/Gua00va",
      "followers_url": "https://api.github.com/users/Gua00va/followers",
      "following_url": "https://api.github.com/users/Gua00va/following{/other_user}",
      "gists_url": "https://api.github.com/users/Gua00va/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Gua00va/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Gua00va/subscriptions",
      "organizations_url": "https://api.github.com/users/Gua00va/orgs",
      "repos_url": "https://api.github.com/users/Gua00va/repos",
      "events_url": "https://api.github.com/users/Gua00va/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Gua00va/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-10-25T05:49:05Z",
    "updated_at": "2023-10-25T05:49:05Z",
    "author_association": "CONTRIBUTOR",
    "body": "Ahh, Got it!\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1778557032/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1778968003",
    "html_url": "https://github.com/sigp/lighthouse/issues/4856#issuecomment-1778968003",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4856",
    "id": 1778968003,
    "node_id": "IC_kwDOCFeAzc5qCOXD",
    "user": {
      "login": "Gua00va",
      "id": 105484243,
      "node_id": "U_kgDOBkmP0w",
      "avatar_url": "https://avatars.githubusercontent.com/u/105484243?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Gua00va",
      "html_url": "https://github.com/Gua00va",
      "followers_url": "https://api.github.com/users/Gua00va/followers",
      "following_url": "https://api.github.com/users/Gua00va/following{/other_user}",
      "gists_url": "https://api.github.com/users/Gua00va/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Gua00va/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Gua00va/subscriptions",
      "organizations_url": "https://api.github.com/users/Gua00va/orgs",
      "repos_url": "https://api.github.com/users/Gua00va/repos",
      "events_url": "https://api.github.com/users/Gua00va/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Gua00va/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-10-25T10:29:06Z",
    "updated_at": "2023-10-25T12:50:41Z",
    "author_association": "CONTRIBUTOR",
    "body": "Okay, so I have studied the whole issue and tried to understand it. Here is what I understood :\r\n\r\nSo in Phase 0, we have attestation rewards and proposer rewards. The problem here is that `inclusion_delay` is also including proposer rewards when we call this function : \r\nhttps://github.com/sigp/lighthouse/blob/d4f26ee123a3185b7e43b08dec69681265e1fde2/consensus/state_processing/src/per_epoch_processing/base/rewards_and_penalties.rs#L106\r\nOn the following line proposer rewards are being included \r\nhttps://github.com/sigp/lighthouse/blob/d4f26ee123a3185b7e43b08dec69681265e1fde2/consensus/state_processing/src/per_epoch_processing/base/rewards_and_penalties.rs#L165 \r\n\r\nSo the given tests are passing even though we have not included block rewards in them because if I compute block rewards and add it to the validator balances, the proposer rewards (_for including attestations from other validators_ in the case of \"base\") will be included twice.\r\nPlease correct me if I am wrong.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1778968003/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
