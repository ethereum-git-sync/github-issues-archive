{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/3795",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/3795/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/3795/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/3795/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/3795",
  "id": 1494353435,
  "node_id": "I_kwDOCFeAzc5ZEgYb",
  "number": 3795,
  "title": "Enable/Disable builder proposals via HTTP reloads whole validator definitions",
  "user": {
    "login": "ricardolyn",
    "id": 1945557,
    "node_id": "MDQ6VXNlcjE5NDU1NTc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1945557?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ricardolyn",
    "html_url": "https://github.com/ricardolyn",
    "followers_url": "https://api.github.com/users/ricardolyn/followers",
    "following_url": "https://api.github.com/users/ricardolyn/following{/other_user}",
    "gists_url": "https://api.github.com/users/ricardolyn/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ricardolyn/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ricardolyn/subscriptions",
    "organizations_url": "https://api.github.com/users/ricardolyn/orgs",
    "repos_url": "https://api.github.com/users/ricardolyn/repos",
    "events_url": "https://api.github.com/users/ricardolyn/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ricardolyn/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1245875191,
      "node_id": "MDU6TGFiZWwxMjQ1ODc1MTkx",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/val-client",
      "name": "val-client",
      "color": "9cd6fc",
      "default": false,
      "description": "Relates to the validator client binary"
    },
    {
      "id": 1999784343,
      "node_id": "MDU6TGFiZWwxOTk5Nzg0MzQz",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/optimization",
      "name": "optimization",
      "color": "f9de40",
      "default": false,
      "description": "Something to make Lighthouse run more efficiently."
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 10,
  "created_at": "2022-12-13T14:26:05Z",
  "updated_at": "2023-02-08T13:06:55Z",
  "closed_at": "2023-01-15T23:30:15Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nWe have a setup of LH running BN and VC separated. The VC is loading thousands of validator keys through from the validation_definitions file. We use web3signer externally for singing purposes.\r\n\r\nWe are working on activating the builder proposals to some of the validators (not all, so removing the `--builder-proposals` argument). We are using the API as documented on [this link](https://lighthouse-book.sigmaprime.io/builders.html#enabledisable-builder- proposals-via-http).\r\n\r\nWhen experimenting with this API by only calling the PATCH to 1 validator, we noticed that it loads ALL validator keys again from the definitions file, creating high CPU usage.\r\n \r\nThe request is something like: `PATCH lighthouse/validators/{pubkey}` with a body with `{ \"builder_proposals\": true }`. When making the request, the logs of LH VC show the following:\r\n```\r\n│ lighthouse-validator Dec 13 10:30:26.246 INFO Enabled validator                       voting_pubkey: <pubkey1>, signing_method: remote_signer    │\r\n│ lighthouse-validator Dec 13 10:30:26.246 INFO Enabled validator                       voting_pubkey: <pubkey2>, signing_method: remote_signer    │\r\n│ lighthouse-validator Dec 13 10:30:26.246 INFO Enabled validator                       voting_pubkey: <pubkey3>, signing_method: remote_signer\r\n```\r\nSo it loads all pub keys again. on the example we did, it loads the 500 keys even though we only patched 1. Imagine that it loads 500 keys for the 500 requests we need to update the state of all keys, and it becomes an exponential problem.\r\n\r\nOn the tests we did, the CPU usage and Storage I/O goes high when compared to not doing those requests.\r\n\r\n## Version\r\n\r\n`version: Lighthouse/v3.3.0-bf533c8`\r\n\r\n## Present Behaviour\r\n\r\nWhen patching the `builder_proposal` value for a validator key, the LH VC service reloads all validators again.\r\n\r\n## Expected Behaviour\r\n\r\nIt should update that validator and not reload the data for all validators configured.\r\n",
  "closed_by": {
    "login": "michaelsproul",
    "id": 4452260,
    "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/michaelsproul",
    "html_url": "https://github.com/michaelsproul",
    "followers_url": "https://api.github.com/users/michaelsproul/followers",
    "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
    "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
    "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
    "repos_url": "https://api.github.com/users/michaelsproul/repos",
    "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
    "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/3795/reactions",
    "total_count": 1,
    "+1": 1,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/3795/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1348704772",
    "html_url": "https://github.com/sigp/lighthouse/issues/3795#issuecomment-1348704772",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3795",
    "id": 1348704772,
    "node_id": "IC_kwDOCFeAzc5QY5oE",
    "user": {
      "login": "jmcruz1983",
      "id": 15966694,
      "node_id": "MDQ6VXNlcjE1OTY2Njk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/15966694?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jmcruz1983",
      "html_url": "https://github.com/jmcruz1983",
      "followers_url": "https://api.github.com/users/jmcruz1983/followers",
      "following_url": "https://api.github.com/users/jmcruz1983/following{/other_user}",
      "gists_url": "https://api.github.com/users/jmcruz1983/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jmcruz1983/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jmcruz1983/subscriptions",
      "organizations_url": "https://api.github.com/users/jmcruz1983/orgs",
      "repos_url": "https://api.github.com/users/jmcruz1983/repos",
      "events_url": "https://api.github.com/users/jmcruz1983/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jmcruz1983/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-13T14:38:31Z",
    "updated_at": "2022-12-13T14:38:31Z",
    "author_association": "NONE",
    "body": "CC: @paulhauner ",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1348704772/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1349878656",
    "html_url": "https://github.com/sigp/lighthouse/issues/3795#issuecomment-1349878656",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3795",
    "id": 1349878656,
    "node_id": "IC_kwDOCFeAzc5QdYOA",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-13T22:16:33Z",
    "updated_at": "2022-12-13T22:16:33Z",
    "author_association": "MEMBER",
    "body": "I think this is an issue affecting web3signer validators specifically. The PATCH method triggers a call to `update_validators` which is meant to ensure that the validators in-memory are in sync with the validators on disk. For local validators there's a check which skips the expensive parts of key reloading if the validator already exists in memory, here:\r\n\r\nhttps://github.com/sigp/lighthouse/blob/bf533c8e42cc73c35730e285c21df8add0195369/validator_client/src/initialized_validators.rs#L995-L997\r\n\r\nThere's no similar check in the web3signer case, so we end up re-initializing every validator for every request here:\r\n\r\nhttps://github.com/sigp/lighthouse/blob/bf533c8e42cc73c35730e285c21df8add0195369/validator_client/src/initialized_validators.rs#L1053-L1059\r\n\r\nI think a simple fix might be just to add a similar duplicate check to the web3signer branch.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1349878656/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1350876514",
    "html_url": "https://github.com/sigp/lighthouse/issues/3795#issuecomment-1350876514",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3795",
    "id": 1350876514,
    "node_id": "IC_kwDOCFeAzc5QhL1i",
    "user": {
      "login": "ricardolyn",
      "id": 1945557,
      "node_id": "MDQ6VXNlcjE5NDU1NTc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1945557?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ricardolyn",
      "html_url": "https://github.com/ricardolyn",
      "followers_url": "https://api.github.com/users/ricardolyn/followers",
      "following_url": "https://api.github.com/users/ricardolyn/following{/other_user}",
      "gists_url": "https://api.github.com/users/ricardolyn/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ricardolyn/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ricardolyn/subscriptions",
      "organizations_url": "https://api.github.com/users/ricardolyn/orgs",
      "repos_url": "https://api.github.com/users/ricardolyn/repos",
      "events_url": "https://api.github.com/users/ricardolyn/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ricardolyn/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-14T10:43:22Z",
    "updated_at": "2022-12-14T10:43:22Z",
    "author_association": "NONE",
    "body": "@michaelsproul thanks\r\n\r\nhttps://github.com/sigp/lighthouse/blob/bf533c8e42cc73c35730e285c21df8add0195369/validator_client/src/initialized_validators.rs#L995-L997\r\nwhich test validates that if above? I wanted to check if there was something similar that could be added as a test for the web3signer flow.\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1350876514/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1351767002",
    "html_url": "https://github.com/sigp/lighthouse/issues/3795#issuecomment-1351767002",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3795",
    "id": 1351767002,
    "node_id": "IC_kwDOCFeAzc5QklPa",
    "user": {
      "login": "ricardolyn",
      "id": 1945557,
      "node_id": "MDQ6VXNlcjE5NDU1NTc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1945557?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ricardolyn",
      "html_url": "https://github.com/ricardolyn",
      "followers_url": "https://api.github.com/users/ricardolyn/followers",
      "following_url": "https://api.github.com/users/ricardolyn/following{/other_user}",
      "gists_url": "https://api.github.com/users/ricardolyn/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ricardolyn/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ricardolyn/subscriptions",
      "organizations_url": "https://api.github.com/users/ricardolyn/orgs",
      "repos_url": "https://api.github.com/users/ricardolyn/repos",
      "events_url": "https://api.github.com/users/ricardolyn/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ricardolyn/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-14T16:55:50Z",
    "updated_at": "2022-12-14T16:55:50Z",
    "author_association": "NONE",
    "body": "I tried that change and tested it manually, but it didn't work. It loaded the whole validator anyway again.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1351767002/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1352222577",
    "html_url": "https://github.com/sigp/lighthouse/issues/3795#issuecomment-1352222577",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3795",
    "id": 1352222577,
    "node_id": "IC_kwDOCFeAzc5QmUdx",
    "user": {
      "login": "realbigsean",
      "id": 5160426,
      "node_id": "MDQ6VXNlcjUxNjA0MjY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5160426?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/realbigsean",
      "html_url": "https://github.com/realbigsean",
      "followers_url": "https://api.github.com/users/realbigsean/followers",
      "following_url": "https://api.github.com/users/realbigsean/following{/other_user}",
      "gists_url": "https://api.github.com/users/realbigsean/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/realbigsean/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/realbigsean/subscriptions",
      "organizations_url": "https://api.github.com/users/realbigsean/orgs",
      "repos_url": "https://api.github.com/users/realbigsean/repos",
      "events_url": "https://api.github.com/users/realbigsean/events{/privacy}",
      "received_events_url": "https://api.github.com/users/realbigsean/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-14T21:23:19Z",
    "updated_at": "2022-12-14T21:23:19Z",
    "author_association": "COLLABORATOR",
    "body": "@ricardolyn I tried Michael's suggestion in this PR https://github.com/sigp/lighthouse/pull/3801\r\n\r\nIt does look like it's working for me",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1352222577/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 1,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1352767861",
    "html_url": "https://github.com/sigp/lighthouse/issues/3795#issuecomment-1352767861",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3795",
    "id": 1352767861,
    "node_id": "IC_kwDOCFeAzc5QoZl1",
    "user": {
      "login": "ricardolyn",
      "id": 1945557,
      "node_id": "MDQ6VXNlcjE5NDU1NTc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1945557?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ricardolyn",
      "html_url": "https://github.com/ricardolyn",
      "followers_url": "https://api.github.com/users/ricardolyn/followers",
      "following_url": "https://api.github.com/users/ricardolyn/following{/other_user}",
      "gists_url": "https://api.github.com/users/ricardolyn/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ricardolyn/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ricardolyn/subscriptions",
      "organizations_url": "https://api.github.com/users/ricardolyn/orgs",
      "repos_url": "https://api.github.com/users/ricardolyn/repos",
      "events_url": "https://api.github.com/users/ricardolyn/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ricardolyn/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-15T09:18:00Z",
    "updated_at": "2022-12-15T09:18:00Z",
    "author_association": "NONE",
    "body": "let me do a test on my side as I didn't change the code in the same way you did. ",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1352767861/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1383284324",
    "html_url": "https://github.com/sigp/lighthouse/issues/3795#issuecomment-1383284324",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3795",
    "id": 1383284324,
    "node_id": "IC_kwDOCFeAzc5Scz5k",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-01-15T23:30:08Z",
    "updated_at": "2023-01-15T23:30:08Z",
    "author_association": "MEMBER",
    "body": "Closed by #3801 (v3.4.0) :tada: Please comment if you find it isn't fixed",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1383284324/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1422257924",
    "html_url": "https://github.com/sigp/lighthouse/issues/3795#issuecomment-1422257924",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3795",
    "id": 1422257924,
    "node_id": "IC_kwDOCFeAzc5Uxe8E",
    "user": {
      "login": "ricardolyn",
      "id": 1945557,
      "node_id": "MDQ6VXNlcjE5NDU1NTc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1945557?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ricardolyn",
      "html_url": "https://github.com/ricardolyn",
      "followers_url": "https://api.github.com/users/ricardolyn/followers",
      "following_url": "https://api.github.com/users/ricardolyn/following{/other_user}",
      "gists_url": "https://api.github.com/users/ricardolyn/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ricardolyn/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ricardolyn/subscriptions",
      "organizations_url": "https://api.github.com/users/ricardolyn/orgs",
      "repos_url": "https://api.github.com/users/ricardolyn/repos",
      "events_url": "https://api.github.com/users/ricardolyn/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ricardolyn/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-02-08T09:03:41Z",
    "updated_at": "2023-02-08T09:16:58Z",
    "author_association": "NONE",
    "body": "@michaelsproul The team has been testing the v3.4.0 version of Lighthouse and encountered an issue with the PATCH lighthouse/validators/{pubkey} request, which is being performed every 2 minutes. Despite the fact that Lighthouse is not being killed every 2 minutes, it is still being restarted around every 2 hours by Kubernetes due to CPU throttling when updating 6 validators concurrently. \r\n\r\nThis could be a major problem in production, where there could be more than a thousand public keys in the same service, potentially leading to even more frequent restarts. \r\n\r\nAny ideas on what may be causing this excessive CPU usage during the PATCH request?",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1422257924/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1422444905",
    "html_url": "https://github.com/sigp/lighthouse/issues/3795#issuecomment-1422444905",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3795",
    "id": 1422444905,
    "node_id": "IC_kwDOCFeAzc5UyMlp",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-02-08T11:28:09Z",
    "updated_at": "2023-02-08T11:28:09Z",
    "author_association": "MEMBER",
    "body": "> The team has been testing the v3.4.0 version of Lighthouse and encountered an issue with the PATCH lighthouse/validators/{pubkey} request, which is being performed every 2 minutes.\r\n\r\nWhat's the PATCH body that's being sent? Is it toggling `{ enabled: true/false }`?\r\n\r\n> Despite the fact that Lighthouse is not being killed every 2 minutes, it is still being restarted around every 2 hours by Kubernetes due to CPU throttling when updating 6 validators concurrently.\r\n\r\nHow high does the CPU spike and for how long? As an aside, I'm always confused by the Kubernetes policy to _kill_ services that use too much CPU, as that just seems to slow everything down, causing more work to restart everything and then just re-creating the bug as soon as the process has restarted. Nonetheless, it would be good to fix the underlying issue. When you say 6 validators, do you mean there are 6 validators in the VC total, or just that there are 6 requests made at the same time and the number of validators is another number? If so, how many validators are registered to the VC total?",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1422444905/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1422566538",
    "html_url": "https://github.com/sigp/lighthouse/issues/3795#issuecomment-1422566538",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3795",
    "id": 1422566538,
    "node_id": "IC_kwDOCFeAzc5UyqSK",
    "user": {
      "login": "ricardolyn",
      "id": 1945557,
      "node_id": "MDQ6VXNlcjE5NDU1NTc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1945557?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ricardolyn",
      "html_url": "https://github.com/ricardolyn",
      "followers_url": "https://api.github.com/users/ricardolyn/followers",
      "following_url": "https://api.github.com/users/ricardolyn/following{/other_user}",
      "gists_url": "https://api.github.com/users/ricardolyn/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ricardolyn/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ricardolyn/subscriptions",
      "organizations_url": "https://api.github.com/users/ricardolyn/orgs",
      "repos_url": "https://api.github.com/users/ricardolyn/repos",
      "events_url": "https://api.github.com/users/ricardolyn/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ricardolyn/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-02-08T13:05:17Z",
    "updated_at": "2023-02-08T13:06:55Z",
    "author_association": "NONE",
    "body": "> What's the PATCH body that's being sent? Is it toggling { enabled: true/false }?\r\n\r\nThe body of the PATCH request is `{ builder_proposals: <true|false> }`, as documented by LH.\r\n\r\n>How high does the CPU spike and for how long?\r\n\r\nLet me correct my sentence in the previous message: the service is being killed by Kubernetes not due to CPU throttling but because the liveness probe fails.\r\n\r\nThis is the probe config we use: `Liveness:   http-get http://:metrics/metrics delay=0s timeout=5s period=10s #success=1 #failure=1`. We are using the `metrics` endpoint to check for liveness (as we don't have http endpoint enabled by default). **We believe that the high CPU spike occurs during the PATCH and the validator can't handle the requests to the metrics endpoint, leading to the restart by k8s**.\r\n\r\nExample of the liveness probe fail:\r\n`Warning  Unhealthy  97s (x3 over 5m37s)    Liveness probe failed: Get \"http://<X.X.X.X>:8008/metrics\": context deadline exceeded (Client.Timeout exceeded while awaiting headers)`\r\n\r\nWe could also use the `/lighthouse/health` endpoint for this but it asks for the [Authentication header which seems strange](https://lighthouse-book.sigmaprime.io/api-vc-endpoints.html#get-lighthouseuihealth).\r\n\r\nFYI: This chart shows the relation between `container_cpu_cfs_throttled_periods_total` and `container_cpu_cfs_periods_total` (is a dashboard provided by Kubernetes). In the following image, you can see before and after the enable of those requests clearly:\r\n<img width=\"1337\" alt=\"Screenshot 2023-02-08 at 12 54 47\" src=\"https://user-images.githubusercontent.com/1945557/217535534-728ff35a-823a-4599-a97d-a55a8a5f9295.png\">\r\n\r\n> Nonetheless, it would be good to fix the underlying issue. When you say 6 validators, do you mean there are 6 validators in the VC total, or just that there are 6 requests made at the same time and the number of validators is another number?\r\n\r\nThere are 500 keys being loaded through the definitions file, but only 6 are active. 6 parallel PATCH requests are made every 2 minutes to update the builder_proposals\r\n\r\nExample log: `INFO Some validators active                  slot: 4946100, epoch: 154565, total_validators: 500, active_validators: 7, current_epoch_proposers: 0, service: notifier`",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1422566538/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
