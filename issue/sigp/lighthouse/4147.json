{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/4147",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/4147/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/4147/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/4147/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/4147",
  "id": 1648379197,
  "node_id": "I_kwDOCFeAzc5iQEU9",
  "number": 4147,
  "title": "Discovery returns no results when peering with any prysm client due to discv5 implementation",
  "user": {
    "login": "bretep",
    "id": 787344,
    "node_id": "MDQ6VXNlcjc4NzM0NA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/787344?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/bretep",
    "html_url": "https://github.com/bretep",
    "followers_url": "https://api.github.com/users/bretep/followers",
    "following_url": "https://api.github.com/users/bretep/following{/other_user}",
    "gists_url": "https://api.github.com/users/bretep/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/bretep/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/bretep/subscriptions",
    "organizations_url": "https://api.github.com/users/bretep/orgs",
    "repos_url": "https://api.github.com/users/bretep/repos",
    "events_url": "https://api.github.com/users/bretep/events{/privacy}",
    "received_events_url": "https://api.github.com/users/bretep/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 12,
  "created_at": "2023-03-30T21:56:09Z",
  "updated_at": "2023-03-31T02:31:17Z",
  "closed_at": "2023-03-31T01:24:32Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nWhen lighthouse is configured with bootnodes that are prysm, `discv5` does not work properly. LH will peer with the bootnode but the discovery request will return `Discovery query yielded no results`\r\n\r\n## Version\r\n\r\nv3.3.0 - v4.0.1\r\n\r\n## Present Behaviour\r\n\r\n`DEBG Discovery query yielded no results.     service: libp2p`\r\n\r\nThe prysm bootnode:\r\n![tg_image_2667874591](https://user-images.githubusercontent.com/787344/228972814-929c230d-680e-4f81-8aeb-51c0b136d2d1.jpeg)\r\n\r\n\r\n## Expected Behaviour\r\n\r\n`DEBG Discovery query completed               peers_found: 16, service: libp2p`\r\n\r\n## Steps to resolve\r\n\r\nI tracked it down to the protocoIId not being valid\r\n\r\ndsicv5 rejected that packet as an invalid packet header\r\n\r\nPrysm uses go-ethereum v5wire for validation: https://github.com/ethereum/go-ethereum/blob/a236e03d0094fd2703cecfb235d91e1e36d0b276/p2p/discover/v5wire/encoding.go#L645\r\n\r\nThe expected protocolID: `protocolID = [6]byte{'d', 'i', 's', 'c', 'v', '5'}`\r\nhttps://github.com/ethereum/go-ethereum/blob/a236e03d0094fd2703cecfb235d91e1e36d0b276/p2p/discover/v5wire/encoding.go#L103\r\n\r\n",
  "closed_by": {
    "login": "AgeManning",
    "id": 7454587,
    "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/AgeManning",
    "html_url": "https://github.com/AgeManning",
    "followers_url": "https://api.github.com/users/AgeManning/followers",
    "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
    "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
    "organizations_url": "https://api.github.com/users/AgeManning/orgs",
    "repos_url": "https://api.github.com/users/AgeManning/repos",
    "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
    "received_events_url": "https://api.github.com/users/AgeManning/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/4147/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/4147/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1491018168",
    "html_url": "https://github.com/sigp/lighthouse/issues/4147#issuecomment-1491018168",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4147",
    "id": 1491018168,
    "node_id": "IC_kwDOCFeAzc5Y3yG4",
    "user": {
      "login": "bretep",
      "id": 787344,
      "node_id": "MDQ6VXNlcjc4NzM0NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/787344?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bretep",
      "html_url": "https://github.com/bretep",
      "followers_url": "https://api.github.com/users/bretep/followers",
      "following_url": "https://api.github.com/users/bretep/following{/other_user}",
      "gists_url": "https://api.github.com/users/bretep/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bretep/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bretep/subscriptions",
      "organizations_url": "https://api.github.com/users/bretep/orgs",
      "repos_url": "https://api.github.com/users/bretep/repos",
      "events_url": "https://api.github.com/users/bretep/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bretep/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-30T21:59:29Z",
    "updated_at": "2023-03-30T21:59:29Z",
    "author_association": "NONE",
    "body": "Using lighthouse as a bootnode works as expected because there is no check for the protocolId",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1491018168/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1491049065",
    "html_url": "https://github.com/sigp/lighthouse/issues/4147#issuecomment-1491049065",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4147",
    "id": 1491049065,
    "node_id": "IC_kwDOCFeAzc5Y35pp",
    "user": {
      "login": "bretep",
      "id": 787344,
      "node_id": "MDQ6VXNlcjc4NzM0NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/787344?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bretep",
      "html_url": "https://github.com/bretep",
      "followers_url": "https://api.github.com/users/bretep/followers",
      "following_url": "https://api.github.com/users/bretep/following{/other_user}",
      "gists_url": "https://api.github.com/users/bretep/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bretep/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bretep/subscriptions",
      "organizations_url": "https://api.github.com/users/bretep/orgs",
      "repos_url": "https://api.github.com/users/bretep/repos",
      "events_url": "https://api.github.com/users/bretep/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bretep/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-30T22:29:25Z",
    "updated_at": "2023-03-30T22:29:25Z",
    "author_association": "NONE",
    "body": "I was hoping this would be resolved with the `4.0.1` release:\r\nhttps://github.com/sigp/lighthouse/blob/a53830fd60a119bf3f659b253360af8027128e83/beacon_node/lighthouse_network/Cargo.toml#L8\r\n\r\nWhich had this fix:\r\nhttps://github.com/sigp/discv5/blob/d20340164ae558287db55de32122a89b2ccd2757/src/packet/mod.rs#L35\r\n\r\nHowever, for the discovery, prysm is still throwing the `err=\"invalid packet header\"` error.\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1491049065/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1491055434",
    "html_url": "https://github.com/sigp/lighthouse/issues/4147#issuecomment-1491055434",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4147",
    "id": 1491055434,
    "node_id": "IC_kwDOCFeAzc5Y37NK",
    "user": {
      "login": "bretep",
      "id": 787344,
      "node_id": "MDQ6VXNlcjc4NzM0NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/787344?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bretep",
      "html_url": "https://github.com/bretep",
      "followers_url": "https://api.github.com/users/bretep/followers",
      "following_url": "https://api.github.com/users/bretep/following{/other_user}",
      "gists_url": "https://api.github.com/users/bretep/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bretep/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bretep/subscriptions",
      "organizations_url": "https://api.github.com/users/bretep/orgs",
      "repos_url": "https://api.github.com/users/bretep/repos",
      "events_url": "https://api.github.com/users/bretep/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bretep/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-30T22:38:54Z",
    "updated_at": "2023-03-30T22:38:54Z",
    "author_association": "NONE",
    "body": "It appears that the `FindPeers` query is the request being sent that has an invalid packet header\r\nhttps://github.com/sigp/lighthouse/blob/a53830fd60a119bf3f659b253360af8027128e83/beacon_node/lighthouse_network/src/discovery/mod.rs#L348",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1491055434/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1491066347",
    "html_url": "https://github.com/sigp/lighthouse/issues/4147#issuecomment-1491066347",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4147",
    "id": 1491066347,
    "node_id": "IC_kwDOCFeAzc5Y393r",
    "user": {
      "login": "bretep",
      "id": 787344,
      "node_id": "MDQ6VXNlcjc4NzM0NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/787344?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bretep",
      "html_url": "https://github.com/bretep",
      "followers_url": "https://api.github.com/users/bretep/followers",
      "following_url": "https://api.github.com/users/bretep/following{/other_user}",
      "gists_url": "https://api.github.com/users/bretep/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bretep/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bretep/subscriptions",
      "organizations_url": "https://api.github.com/users/bretep/orgs",
      "repos_url": "https://api.github.com/users/bretep/repos",
      "events_url": "https://api.github.com/users/bretep/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bretep/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-30T22:50:01Z",
    "updated_at": "2023-03-30T22:51:51Z",
    "author_association": "NONE",
    "body": "It seems that the libp2p has not implemented the `FindPeers`, only the `FindNode`. I wonder if they are the same, but logically one developer decided `FindPeers` was more descriptive, and another developer used`FindNode` which everyone else uses for discv5.\r\nhttps://github.com/ethereum/go-ethereum/blob/d0fbb10658a85f0b2bd4466892747758bacddaf7/p2p/discover/v5wire/msg.go#L124\r\n\r\nI see no reference to `FindPeers` on the v5wire library that prysm uses from the go-ethereum library",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1491066347/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1491069824",
    "html_url": "https://github.com/sigp/lighthouse/issues/4147#issuecomment-1491069824",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4147",
    "id": 1491069824,
    "node_id": "IC_kwDOCFeAzc5Y3-uA",
    "user": {
      "login": "bretep",
      "id": 787344,
      "node_id": "MDQ6VXNlcjc4NzM0NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/787344?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bretep",
      "html_url": "https://github.com/bretep",
      "followers_url": "https://api.github.com/users/bretep/followers",
      "following_url": "https://api.github.com/users/bretep/following{/other_user}",
      "gists_url": "https://api.github.com/users/bretep/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bretep/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bretep/subscriptions",
      "organizations_url": "https://api.github.com/users/bretep/orgs",
      "repos_url": "https://api.github.com/users/bretep/repos",
      "events_url": "https://api.github.com/users/bretep/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bretep/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-30T22:55:08Z",
    "updated_at": "2023-03-30T22:55:08Z",
    "author_association": "NONE",
    "body": "@AgeManning can you take a look at this?",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1491069824/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1491138139",
    "html_url": "https://github.com/sigp/lighthouse/issues/4147#issuecomment-1491138139",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4147",
    "id": 1491138139,
    "node_id": "IC_kwDOCFeAzc5Y4PZb",
    "user": {
      "login": "AgeManning",
      "id": 7454587,
      "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AgeManning",
      "html_url": "https://github.com/AgeManning",
      "followers_url": "https://api.github.com/users/AgeManning/followers",
      "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
      "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
      "organizations_url": "https://api.github.com/users/AgeManning/orgs",
      "repos_url": "https://api.github.com/users/AgeManning/repos",
      "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AgeManning/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-31T00:40:14Z",
    "updated_at": "2023-03-31T00:40:14Z",
    "author_association": "MEMBER",
    "body": "Hey, haven't had a chance to look at this yet. But are you sure the bootnode ENR matches the node you are connecting to?\r\n\r\nIf prysm changes their node-id/peer-id on restart and it differs from the original ENR bootnode you are connecting to, then you are likely to see an error like this. \r\nAlternatively if the boot-node ENR points to the same IP address as another node with a different id you may see a simiar issue. \r\n\r\nCan you please check the node-id/peer-id of the bootnode ENR matches the prysm node that you are connecting to",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1491138139/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1491138578",
    "html_url": "https://github.com/sigp/lighthouse/issues/4147#issuecomment-1491138578",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4147",
    "id": 1491138578,
    "node_id": "IC_kwDOCFeAzc5Y4PgS",
    "user": {
      "login": "divagant-martian",
      "id": 26765164,
      "node_id": "MDQ6VXNlcjI2NzY1MTY0",
      "avatar_url": "https://avatars.githubusercontent.com/u/26765164?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/divagant-martian",
      "html_url": "https://github.com/divagant-martian",
      "followers_url": "https://api.github.com/users/divagant-martian/followers",
      "following_url": "https://api.github.com/users/divagant-martian/following{/other_user}",
      "gists_url": "https://api.github.com/users/divagant-martian/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/divagant-martian/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/divagant-martian/subscriptions",
      "organizations_url": "https://api.github.com/users/divagant-martian/orgs",
      "repos_url": "https://api.github.com/users/divagant-martian/repos",
      "events_url": "https://api.github.com/users/divagant-martian/events{/privacy}",
      "received_events_url": "https://api.github.com/users/divagant-martian/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-31T00:41:10Z",
    "updated_at": "2023-03-31T00:46:50Z",
    "author_association": "CONTRIBUTOR",
    "body": "Thanks @bretep for your report\r\n\r\nThere are a couple of clarifications to be made so that we can get to the bottom of the issue.\r\n1. `FindPeers` is a LH query type, the corresponding query in discv5 (after some rather long code paths) is [`FindNode`](https://github.com/sigp/discv5/blob/b86e45de3f5900fca23eac68652912d37fb6e383/src/rpc.rs#L72-L75). The fact that lighthouse models a query that (in some way) wraps this as a dependent of the `discv5` crate should not be an issue. \r\n2. The default protocol id has always been `discv5`. It's appended on every package [here](https://github.com/sigp/discv5/blob/d20340164ae558287db55de32122a89b2ccd2757/src/packet/mod.rs#L108-L109) and decoded as well, there is a check for expected protocol id and version [here](https://github.com/sigp/discv5/blob/d20340164ae558287db55de32122a89b2ccd2757/src/packet/mod.rs#L455-L466)\r\n\r\nI just ran the `discv5` [`find_node` example](https://github.com/sigp/discv5/blob/d86707d79c1183b14b8cf31ef62a8a74ef9cd3e4/examples/find_nodes.rs) against three prysm mainnet bootnodes and it works as expected. Run example\r\n ```bash\r\n cargo run --example find_nodes -- --remote-peer enr:-Ku4QP2xDnEtUXIjzJ_DhlCRN9SN99RYQPJL92TMlSv7U5C1YnYLjwOQHgZIUXw6c-BvRg2Yc2QsZxxoS_pPRVe0yK8Bh2F0dG5ldHOIAAAAAAAAAACEZXRoMpD1pf1CAAAAAP__________gmlkgnY0gmlwhBLf22SJc2VjcDI1NmsxoQMeFF5GrS7UZpAH2Ly84aLK-TyvH-dRo0JM1i8yygH50YN1ZHCCJxA\r\n ```\r\n\r\nNow building latest master from `discv5` and `geth` I run a lh `discv5` node as\r\n```bash\r\n$ cargo run --example find_nodes -- --enr-ip4 127.0.0.1 --events\r\n# INFO find_nodes: Base64 ENR: <generated local enr>\r\n```\r\n\r\nAnd then run geth's `discv5` test suite against this node\r\n```bash\r\n./devp2p discv5 test <generated local enr from prev command>\r\n# -- RUN Ping\r\n# .. \r\n# -- OK Ping (9.3ms)\r\n# -- RUN PingLargeRequestID\r\n# ..\r\n# -- OK PingLargeRequestID (303.6ms)\r\n# -- RUN PingMultiIP\r\n# ..\r\n#  got WHOAREYOU for new session as expected\r\n# ..\r\n#  got WHOAREYOU for new session as expected\r\n# -- OK PingMultiIP (35.3ms)\r\n# -- RUN PingHandshakeInterrupted\r\n# ..\r\n#  expected WHOAREYOU, got read udp 127.0.0.1:53554: i/o timeout\r\n# -- FAIL PingHandshakeInterrupted (305.4ms)\r\n# -- RUN TalkRequest\r\n# ..\r\n# -- OK TalkRequest (21.5ms)\r\n# -- RUN FindnodeZeroDistance\r\n# ..\r\n# -- OK FindnodeZeroDistance (23.1ms)\r\n# -- RUN FindnodeResults\r\n# ..\r\n#  remote returned 5 nodes for distance list [254 256 253 255]\r\n#  all 5 expected nodes were returned\r\n# ..\r\n# -- OK FindnodeResults (13.1108s)\r\n# 6/7 tests passed.\r\n```\r\nNotably, the interrumpted ping test fails, but this isn't really an issue, every test regarding communication between the nodes, including the Findnode test, passes.\r\n\r\nAs such, I don't identify an issue that looks like what you describe. Perhaps if you could provide commands that generate a reproducible test environment that fails we could further look into it.\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1491138578/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1491144895",
    "html_url": "https://github.com/sigp/lighthouse/issues/4147#issuecomment-1491144895",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4147",
    "id": 1491144895,
    "node_id": "IC_kwDOCFeAzc5Y4RC_",
    "user": {
      "login": "bretep",
      "id": 787344,
      "node_id": "MDQ6VXNlcjc4NzM0NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/787344?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bretep",
      "html_url": "https://github.com/bretep",
      "followers_url": "https://api.github.com/users/bretep/followers",
      "following_url": "https://api.github.com/users/bretep/following{/other_user}",
      "gists_url": "https://api.github.com/users/bretep/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bretep/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bretep/subscriptions",
      "organizations_url": "https://api.github.com/users/bretep/orgs",
      "repos_url": "https://api.github.com/users/bretep/repos",
      "events_url": "https://api.github.com/users/bretep/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bretep/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-31T00:54:42Z",
    "updated_at": "2023-03-31T01:18:03Z",
    "author_association": "NONE",
    "body": "> Hey, haven't had a chance to look at this yet. But are you sure the bootnode ENR matches the node you are connecting to?\r\n> \r\n100% sure. I grep by my lighthouse IP address on the prysm logs. \r\n\r\n> If prysm changes their node-id/peer-id on restart and it differs from the original ENR bootnode you are connecting to, then you are likely to see an error like this. Alternatively if the boot-node ENR points to the same IP address as another node with a different id you may see a simiar issue.\r\n> \r\n> Can you please check the node-id/peer-id of the bootnode ENR matches the prysm node that you are connecting to\r\n\r\nWe're not using mainnet bootnodes. These are on our own network.\r\n\r\nSome notes:\r\nLH peers with all three bootnodes:\r\n```\r\n# PulseChain Official (aws-us-east-1)\r\n- enr:-MK4QC37TFAfc973oOezRlVoOCygtjT-rlOoKbbuZNmrJ5dhXS-IfrsH3yhjNP0dfy3-UpyFZy2hy6lOE__ykFfj3lKGAYa95Co5h2F0dG5ldHOIAAAAAAAAAACEZXRoMpBbnJIGAAAJRP__________gmlkgnY0gmlwhAPsylWJc2VjcDI1NmsxoQOpEhsSXVShFW4yvaww_SI0A-H0pix0aJlOdYJgyIgbjYhzeW5jbmV0cwCDdGNwgjLIg3VkcIIu4A\r\n- enr:-MK4QM1JpOXnj-zpjfPvG1GkCEvjYMg8dEk6t7VLtpFuionhBz59n2ZIwixpO2exzoNLMV4_v7jCHGQqi0zYtc-Gp3OGAYa94lhqh2F0dG5ldHOIAAAAAAAAAACEZXRoMpBbnJIGAAAJRP__________gmlkgnY0gmlwhCzKVYOJc2VjcDI1NmsxoQK24rqFwR7W3HJgLVVGDSMy8PiMculxF6VOJgAlG4wmXohzeW5jbmV0cwCDdGNwgjLIg3VkcIIu4A\r\n- enr:-MK4QBAlroGpM1xtk7WzWP8lbKnI2UjVpoQNsKJeNRS-kVvFCswNyVRBZHwMOvfW2G3j0qaaDsUpMxXY-t9LdGAZgQGGAYa94IQmh2F0dG5ldHOIAAAAAAAAAACEZXRoMpBbnJIGAAAJRP__________gmlkgnY0gmlwhK6BYN-Jc2VjcDI1NmsxoQJNoBFGkhcAMKIbrDPHoI7dYVAY99Z832TimlqhpoYo7YhzeW5jbmV0cwCDdGNwgjLIg3VkcIIu4A\r\n```\r\nhttps://gitlab.com/pulsechaincom/lighthouse-pulse/-/blob/rebase-upstream-v4.0.1/common/eth2_network_config/built_in_network_configs/pulsechain-testnet-v3/boot_enr.yaml\r\n\r\nAll three are prysm nodes. \r\n\r\nTo make things easier, I'm only going to focus on the last ENR in the list.\r\n\r\n### https://enr-viewer.com/\r\n```\r\nSignature: 0x1025ae81a9335c6d93b5b358ff256ca9c8d948d5a6840db0a25e3514be915bc50acc0dc95441647c0c3af7d6d86de3d2a69a0ec5293315d8fadf4b7460198101\r\nseq: 1678222853158\r\nattnets: 0x0000000000000000\r\neth2: 0x5b9c920600000944ffffffffffffffff\r\nid: v4\r\nip: 174.129.96.223\r\nsecp256k1: 0x024da0114692170030a21bac33c7a08edd615018f7d67cdf64e29a5aa1a68628ed\r\nsyncnets: 0x00\r\ntcp: 13000\r\nudp: 12000\r\n\r\nDerived Fields\r\nnode id: b42e8e7cdb610cc36238195704aa923f243da0a6a74dd090e9040a3eb5cb07e4\r\npeer id: 16Uiu2HAkzegwK4y2UtAtMXi1sPSsptmbn6Hko6svJ4so8KY7EotY\r\ntcp4 multiaddr: /ip4/174.129.96.223/tcp/13000/p2p/16Uiu2HAkzegwK4y2UtAtMXi1sPSsptmbn6Hko6svJ4so8KY7EotY\r\nudp4 multiaddr: /ip4/174.129.96.223/udp/12000/p2p/16Uiu2HAkzegwK4y2UtAtMXi1sPSsptmbn6Hko6svJ4so8KY7EotY\r\n```\r\n### Bootnode:\r\n```\r\ncurl -1s http:/127.0.0.1:3500/eth/v1/node/identity | jq\r\n{\r\n  \"data\": {\r\n    \"peer_id\": \"16Uiu2HAm1vNgVmv3W9YQLaBJcFeJnT6ArXnmwjsFZxzwMnSAhqjG\",\r\n    \"enr\": \"enr:-MK4QJjQTAXVWXESp_dilbbaJr7VhUFc6oTmqb6M-VyToqdOBweaaUT5ys8SONJs5Eb_0mlOJumrvkJVqJTrSbOn_6OGAYcm5RmUh2F0dG5ldHOIAAAAAAAAAACEZXRoMpBbnJIGAAAJRP__________gmlkgnY0gmlwhK6BYN-Jc2VjcDI1NmsxoQJggGfmwto714VLc0bCjw5j8G4yiy1LvtAinB5sVVvwA4hzeW5jbmV0cwCDdGNwgjLIg3VkcIIu4A\",\r\n    \"p2p_addresses\": [\r\n      \"/ip4/10.0.6.24/tcp/13000/p2p/16Uiu2HAm1vNgVmv3W9YQLaBJcFeJnT6ArXnmwjsFZxzwMnSAhqjG\",\r\n      \"/ip4/174.129.96.223/tcp/13000/p2p/16Uiu2HAm1vNgVmv3W9YQLaBJcFeJnT6ArXnmwjsFZxzwMnSAhqjG\",\r\n      \"/ip4/174.129.96.223/tcp/13000/p2p/16Uiu2HAm1vNgVmv3W9YQLaBJcFeJnT6ArXnmwjsFZxzwMnSAhqjG\"\r\n    ],\r\n    \"discovery_addresses\": [\r\n      \"/ip4/174.129.96.223/udp/12000/p2p/16Uiu2HAm1vNgVmv3W9YQLaBJcFeJnT6ArXnmwjsFZxzwMnSAhqjG\"\r\n    ],\r\n    \"metadata\": {\r\n      \"seq_number\": \"1\",\r\n      \"attnets\": \"0x0000000000000000\"\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1491144895/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1491151635",
    "html_url": "https://github.com/sigp/lighthouse/issues/4147#issuecomment-1491151635",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4147",
    "id": 1491151635,
    "node_id": "IC_kwDOCFeAzc5Y4SsT",
    "user": {
      "login": "bretep",
      "id": 787344,
      "node_id": "MDQ6VXNlcjc4NzM0NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/787344?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bretep",
      "html_url": "https://github.com/bretep",
      "followers_url": "https://api.github.com/users/bretep/followers",
      "following_url": "https://api.github.com/users/bretep/following{/other_user}",
      "gists_url": "https://api.github.com/users/bretep/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bretep/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bretep/subscriptions",
      "organizations_url": "https://api.github.com/users/bretep/orgs",
      "repos_url": "https://api.github.com/users/bretep/repos",
      "events_url": "https://api.github.com/users/bretep/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bretep/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-31T01:06:17Z",
    "updated_at": "2023-03-31T01:07:10Z",
    "author_association": "NONE",
    "body": "These are the logs when peering with the prysm boot nodes: (I don't get any neighbors/peers)\r\n[LH_client_prysm_bootnode.log](https://github.com/sigp/lighthouse/files/11117239/LH_client_prysm_bootnode.log)\r\n\r\nIf I add a lighthouse peer:\r\n\r\n```\r\n--boot-nodes=enr:-L64QNIt1R1_ou9Aw5ci8gLAsV1TrK2MtWiPNGy21YsTW0HpA86hGowakgk3IVEZNjBOTVdqtXObXyErbEfxEi8Y8Z-CARSHYXR0bmV0c4j__________4RldGgykFuckgYAAAlE__________-CaWSCdjSCaXCEA--2T4lzZWNwMjU2azGhArzEiK-HUz_pnQBn_F8g7sCRKLU4GUocVeq_TX6UlFXIiHN5bmNuZXRzD4N0Y3CCIyiDdWRwgiMo\r\n```\r\n\r\n\r\nThen I get this log: (I get all the neighbors/peers)\r\n[lighthouse_LH_trace.txt](https://github.com/sigp/lighthouse/files/11117248/lighthouse_LH_trace.txt)\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1491151635/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1491158912",
    "html_url": "https://github.com/sigp/lighthouse/issues/4147#issuecomment-1491158912",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4147",
    "id": 1491158912,
    "node_id": "IC_kwDOCFeAzc5Y4UeA",
    "user": {
      "login": "AgeManning",
      "id": 7454587,
      "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AgeManning",
      "html_url": "https://github.com/AgeManning",
      "followers_url": "https://api.github.com/users/AgeManning/followers",
      "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
      "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
      "organizations_url": "https://api.github.com/users/AgeManning/orgs",
      "repos_url": "https://api.github.com/users/AgeManning/repos",
      "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AgeManning/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-31T01:17:28Z",
    "updated_at": "2023-03-31T01:17:28Z",
    "author_association": "MEMBER",
    "body": "Yeah, the ENR you looked at doesn't have the same peer-id as the node you got the ID from. This is your problem. \r\n\r\nThe ENR does not match the node you are connecting to.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1491158912/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1491163471",
    "html_url": "https://github.com/sigp/lighthouse/issues/4147#issuecomment-1491163471",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4147",
    "id": 1491163471,
    "node_id": "IC_kwDOCFeAzc5Y4VlP",
    "user": {
      "login": "AgeManning",
      "id": 7454587,
      "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AgeManning",
      "html_url": "https://github.com/AgeManning",
      "followers_url": "https://api.github.com/users/AgeManning/followers",
      "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
      "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
      "organizations_url": "https://api.github.com/users/AgeManning/orgs",
      "repos_url": "https://api.github.com/users/AgeManning/repos",
      "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AgeManning/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-31T01:24:31Z",
    "updated_at": "2023-03-31T01:24:31Z",
    "author_association": "MEMBER",
    "body": "The ENR used as a boot-node did not match the node it was connecting to. The receiving node cannot decrypt packets that were not meant for it. This is as expected.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1491163471/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1491164055",
    "html_url": "https://github.com/sigp/lighthouse/issues/4147#issuecomment-1491164055",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4147",
    "id": 1491164055,
    "node_id": "IC_kwDOCFeAzc5Y4VuX",
    "user": {
      "login": "bretep",
      "id": 787344,
      "node_id": "MDQ6VXNlcjc4NzM0NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/787344?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bretep",
      "html_url": "https://github.com/bretep",
      "followers_url": "https://api.github.com/users/bretep/followers",
      "following_url": "https://api.github.com/users/bretep/following{/other_user}",
      "gists_url": "https://api.github.com/users/bretep/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bretep/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bretep/subscriptions",
      "organizations_url": "https://api.github.com/users/bretep/orgs",
      "repos_url": "https://api.github.com/users/bretep/repos",
      "events_url": "https://api.github.com/users/bretep/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bretep/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-31T01:25:31Z",
    "updated_at": "2023-03-31T02:31:17Z",
    "author_association": "NONE",
    "body": "The boot node peer id did change.\r\n\r\nIncase other run into this @AgeManning gave an explanation to as why:\r\n```\r\nAll communication is encrypted via the network key. The peer-id and node-id are the public keys of the network secret key which is used to encrypt all traffic\r\n\r\nThe reason you get a bad packet error is because you are encrypting messages to a node id which cannot be decrypted by the receiving node (as it has the wrong node-id)\r\n```\r\n\r\nDocumentation about discv5 and encryption can be found here: https://github.com/ethereum/devp2p/blob/master/discv5/discv5-rationale.md",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1491164055/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 1,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
