{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/4189",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/4189/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/4189/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/4189/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/4189",
  "id": 1666760476,
  "node_id": "I_kwDOCFeAzc5jWL8c",
  "number": 4189,
  "title": "On-chain exits remaining in node pool",
  "user": {
    "login": "mcdee",
    "id": 511384,
    "node_id": "MDQ6VXNlcjUxMTM4NA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/511384?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mcdee",
    "html_url": "https://github.com/mcdee",
    "followers_url": "https://api.github.com/users/mcdee/followers",
    "following_url": "https://api.github.com/users/mcdee/following{/other_user}",
    "gists_url": "https://api.github.com/users/mcdee/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mcdee/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mcdee/subscriptions",
    "organizations_url": "https://api.github.com/users/mcdee/orgs",
    "repos_url": "https://api.github.com/users/mcdee/repos",
    "events_url": "https://api.github.com/users/mcdee/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mcdee/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2023-04-13T16:40:43Z",
  "updated_at": "2023-04-16T21:06:28Z",
  "closed_at": "2023-04-16T21:06:28Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nNode does not clear voluntary exits from pool once the validator is exiting.\r\n\r\n```\r\ncurl -s http://localhost:5051/eth/v1/beacon/pool/voluntary_exits | jq -c '.data[] | select(.message.validator_index == \"122622\")' | jq .\r\n{\r\n  \"message\": {\r\n    \"epoch\": \"194119\",\r\n    \"validator_index\": \"122622\"\r\n  },\r\n  \"signature\": \"0x93a9424dd5408c06b96142d893109a948749217042545c49db104501f9d265f8e6ca5da47a19bd75fd8f636ec530abf80e22f5f8b874f62dcf381db3b9aeb05535da904aaaf424b62820e345e3f7695e6f2105dfa69f622c980067c96bd80b7d\"\r\n}\r\n\r\ncurl -s http://localhost:5051/eth/v1/beacon/states/head/validators/122622 | jq\r\n{\r\n  \"execution_optimistic\": false,\r\n  \"data\": {\r\n    \"index\": \"122622\",\r\n    \"balance\": \"35250997039\",\r\n    \"status\": \"active_exiting\",\r\n    \"validator\": {\r\n      \"pubkey\": \"0x972330aa3387c394018ac6f90877a9b5bcfc561e03a963b76c34a8cd7386291dd9bc1b0c94abcd2e415b717cd02631af\",\r\n      \"withdrawal_credentials\": \"0x0077a266d9d7e1ea61b54d5d306bd57bca32ea8fb945f0e2caf818ab6eba5006\",\r\n      \"effective_balance\": \"32000000000\",\r\n      \"slashed\": false,\r\n      \"activation_eligibility_epoch\": \"32098\",\r\n      \"activation_epoch\": \"32114\",\r\n      \"exit_epoch\": \"196264\",\r\n      \"withdrawable_epoch\": \"196520\"\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nThis results in many exits remaining in the pool:\r\n\r\n```\r\ncurl -s http://localhost:5051/eth/v1/beacon/pool/voluntary_exits | jq -c '.data | length'\r\n17624\r\n```\r\n## Version\r\n\r\n```\r\nLighthouse v4.0.1-a53830f\r\nBLS library: blst-modern\r\nSHA256 hardware acceleration: true\r\nAllocator: jemalloc\r\nSpecs: mainnet (true), minimal (false), gnosis (true)\r\n```\r\n\r\n## Present Behaviour\r\n\r\nLighthouse appears to keep voluntary exits in its pool even after they have been included on-chain.\r\n\r\n## Expected Behaviour\r\n\r\nThe exit should be removed from the pool.\r\n\r\n## Steps to resolve\r\n\r\n",
  "closed_by": {
    "login": "mcdee",
    "id": 511384,
    "node_id": "MDQ6VXNlcjUxMTM4NA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/511384?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mcdee",
    "html_url": "https://github.com/mcdee",
    "followers_url": "https://api.github.com/users/mcdee/followers",
    "following_url": "https://api.github.com/users/mcdee/following{/other_user}",
    "gists_url": "https://api.github.com/users/mcdee/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mcdee/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mcdee/subscriptions",
    "organizations_url": "https://api.github.com/users/mcdee/orgs",
    "repos_url": "https://api.github.com/users/mcdee/repos",
    "events_url": "https://api.github.com/users/mcdee/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mcdee/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/4189/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/4189/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1507663937",
    "html_url": "https://github.com/sigp/lighthouse/issues/4189#issuecomment-1507663937",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4189",
    "id": 1507663937,
    "node_id": "IC_kwDOCFeAzc5Z3SBB",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-13T22:05:32Z",
    "updated_at": "2023-04-13T22:05:32Z",
    "author_association": "MEMBER",
    "body": "They're pruned once the validator's `exit_epoch` is finalized:\r\n\r\nhttps://github.com/sigp/lighthouse/blob/a53830fd60a119bf3f659b253360af8027128e83/beacon_node/operation_pool/src/lib.rs#L507-L519\r\n\r\nThis validator's exit epoch is still in the future (`196264`), so it will be pruned once that epoch arrives next week.\r\n\r\nThe reason we prune like this (as the code comment says) is for simplicity. The ideal pruning criteria would be when the block that the exit is included in is finalized, but that's not readily available from the `BeaconState` â€“ we would need to iterate the chain history, which is slow(er).\r\n\r\nHaving a few thousand of these in memory isn't an issue, they're small, and block packing will quickly skip over them when it sees they are no longer relevant to include at the head of the chain.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1507663937/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1510488176",
    "html_url": "https://github.com/sigp/lighthouse/issues/4189#issuecomment-1510488176",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4189",
    "id": 1510488176,
    "node_id": "IC_kwDOCFeAzc5aCDhw",
    "user": {
      "login": "mcdee",
      "id": 511384,
      "node_id": "MDQ6VXNlcjUxMTM4NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/511384?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mcdee",
      "html_url": "https://github.com/mcdee",
      "followers_url": "https://api.github.com/users/mcdee/followers",
      "following_url": "https://api.github.com/users/mcdee/following{/other_user}",
      "gists_url": "https://api.github.com/users/mcdee/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mcdee/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mcdee/subscriptions",
      "organizations_url": "https://api.github.com/users/mcdee/orgs",
      "repos_url": "https://api.github.com/users/mcdee/repos",
      "events_url": "https://api.github.com/users/mcdee/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mcdee/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-16T21:06:28Z",
    "updated_at": "2023-04-16T21:06:28Z",
    "author_association": "CONTRIBUTOR",
    "body": "It does make it hard to know which exits have been included on-chain (albeit not finalized), which makes it tricky when checking pool sizes over time and across instances, but understand the rationale here so closing the issue.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1510488176/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
