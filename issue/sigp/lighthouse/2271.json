{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/2271",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/2271/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/2271/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/2271/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/2271",
  "id": 834772371,
  "node_id": "MDU6SXNzdWU4MzQ3NzIzNzE=",
  "number": 2271,
  "title": "Silent Failure after Cache Lock Timeout",
  "user": {
    "login": "Brianfit",
    "id": 3415783,
    "node_id": "MDQ6VXNlcjM0MTU3ODM=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3415783?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Brianfit",
    "html_url": "https://github.com/Brianfit",
    "followers_url": "https://api.github.com/users/Brianfit/followers",
    "following_url": "https://api.github.com/users/Brianfit/following{/other_user}",
    "gists_url": "https://api.github.com/users/Brianfit/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Brianfit/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Brianfit/subscriptions",
    "organizations_url": "https://api.github.com/users/Brianfit/orgs",
    "repos_url": "https://api.github.com/users/Brianfit/repos",
    "events_url": "https://api.github.com/users/Brianfit/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Brianfit/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 6,
  "created_at": "2021-03-18T12:49:39Z",
  "updated_at": "2021-04-23T10:30:02Z",
  "closed_at": "2021-04-23T10:30:02Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nAfter a brief loss of connectivity and Cache Lock Timeout, Lighthouse continues to log Block Received and Synced messages despite attestations actually failing\r\n\r\n## Version\r\n\r\nLighthouse v1.1.3-46920a8\r\n\r\n## Present Behaviour\r\n\r\nVC fails, Attestations fail, log carries on with INFO messages  \r\n\r\n## Expected Behaviour\r\n\r\nVC fails, Attestations fail, log issues CRIT or ERRO warning that VC is down\r\n\r\n## Steps to resolve\r\n\r\nRebooted system. Source of problem causing OOM reaper to shut down lighthouse vc unknown.  \r\n\r\n## Syslog:\r\n\r\n[WTFMar13Log.txt](https://www.brian-fitzgerald.net/wtflog/WTFMar13Log.txt)\r\n",
  "closed_by": {
    "login": "paulhauner",
    "id": 6660660,
    "node_id": "MDQ6VXNlcjY2NjA2NjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/paulhauner",
    "html_url": "https://github.com/paulhauner",
    "followers_url": "https://api.github.com/users/paulhauner/followers",
    "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
    "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
    "organizations_url": "https://api.github.com/users/paulhauner/orgs",
    "repos_url": "https://api.github.com/users/paulhauner/repos",
    "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
    "received_events_url": "https://api.github.com/users/paulhauner/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/2271/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/2271/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/801911494",
    "html_url": "https://github.com/sigp/lighthouse/issues/2271#issuecomment-801911494",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/2271",
    "id": 801911494,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwMTkxMTQ5NA==",
    "user": {
      "login": "pawanjay176",
      "id": 9890508,
      "node_id": "MDQ6VXNlcjk4OTA1MDg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9890508?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pawanjay176",
      "html_url": "https://github.com/pawanjay176",
      "followers_url": "https://api.github.com/users/pawanjay176/followers",
      "following_url": "https://api.github.com/users/pawanjay176/following{/other_user}",
      "gists_url": "https://api.github.com/users/pawanjay176/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pawanjay176/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pawanjay176/subscriptions",
      "organizations_url": "https://api.github.com/users/pawanjay176/orgs",
      "repos_url": "https://api.github.com/users/pawanjay176/repos",
      "events_url": "https://api.github.com/users/pawanjay176/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pawanjay176/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-18T13:06:24Z",
    "updated_at": "2021-03-18T13:06:24Z",
    "author_association": "MEMBER",
    "body": "Could you reupload the logs? I think it didn't upload properly.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/801911494/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/802053956",
    "html_url": "https://github.com/sigp/lighthouse/issues/2271#issuecomment-802053956",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/2271",
    "id": 802053956,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwMjA1Mzk1Ng==",
    "user": {
      "login": "Brianfit",
      "id": 3415783,
      "node_id": "MDQ6VXNlcjM0MTU3ODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3415783?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Brianfit",
      "html_url": "https://github.com/Brianfit",
      "followers_url": "https://api.github.com/users/Brianfit/followers",
      "following_url": "https://api.github.com/users/Brianfit/following{/other_user}",
      "gists_url": "https://api.github.com/users/Brianfit/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Brianfit/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Brianfit/subscriptions",
      "organizations_url": "https://api.github.com/users/Brianfit/orgs",
      "repos_url": "https://api.github.com/users/Brianfit/repos",
      "events_url": "https://api.github.com/users/Brianfit/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Brianfit/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-18T16:09:26Z",
    "updated_at": "2021-03-18T16:09:26Z",
    "author_association": "NONE",
    "body": "@pawanjay176 Sorry about that. Fixed. ",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/802053956/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/802367041",
    "html_url": "https://github.com/sigp/lighthouse/issues/2271#issuecomment-802367041",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/2271",
    "id": 802367041,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwMjM2NzA0MQ==",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-18T22:57:14Z",
    "updated_at": "2021-03-18T23:01:25Z",
    "author_association": "MEMBER",
    "body": "Interpreting the logs:\r\n\r\n1. It looks like the Lighthouse beacon node (PID 251005) was killed by the OOM killer, and its resident set size was ~3.79GB when it was killed. This is about what we expect these days for mainnet, without the use of the [memory allocator hack described here](https://lighthouse.sigmaprime.io/update-34.html) (which we are not yet ready to enable universally).\r\n2. Your `systemd` setup gracefully stopped the Lighthouse validator client (PID 250997) on the line `Stopping Lighthouse Eth2 Client Validator Node`, seemingly because you have it set up to stop whenever the BN stops? I think this is the root of the problem: systemd stopped the VC and never restarted it. There's no `Started Lighthouse Eth2 Client Validator Node` as there is for the beacon node (`Started Lighthouse Beacon Node`).\r\n3. The BN (post restart) proceeded to experience the validator pubkey lock timeout (which is caused by the CPU being overloaded usually), and then gracefully recovered and regained sync. As far as I can tell from those logs the BN was doing the best it could in the conditions, and nothing I've seen is indicative of a bug in Lighthouse.\r\n\r\nMy recommendations are:\r\n\r\n* Tweak your systemd service files so that the validator client doesn't shutdown and stay down if the BN dies. It's safe to keep it running even if the BN goes down.\r\n* Try to reduce the memory pressure, either by using the memory hack I linked, removing Geth from the node, or (sorry to say it) moving to more powerful hardware. It's also possible that system load will settle down once Geth finishes constructing its snapshot.\r\n\r\nLet us know if you need help, hopefully we can get your validator up and running smoothly.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/802367041/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/802375980",
    "html_url": "https://github.com/sigp/lighthouse/issues/2271#issuecomment-802375980",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/2271",
    "id": 802375980,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwMjM3NTk4MA==",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-18T23:15:06Z",
    "updated_at": "2021-03-18T23:15:06Z",
    "author_association": "MEMBER",
    "body": "I'm trying to work out what systemd configuration would case the behaviour you're experiencing. Would you mind posting the contents of any Lighthouse-related `.service` files from `/etc/systemd/system/`?",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/802375980/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/803005020",
    "html_url": "https://github.com/sigp/lighthouse/issues/2271#issuecomment-803005020",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/2271",
    "id": 803005020,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwMzAwNTAyMA==",
    "user": {
      "login": "Brianfit",
      "id": 3415783,
      "node_id": "MDQ6VXNlcjM0MTU3ODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3415783?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Brianfit",
      "html_url": "https://github.com/Brianfit",
      "followers_url": "https://api.github.com/users/Brianfit/followers",
      "following_url": "https://api.github.com/users/Brianfit/following{/other_user}",
      "gists_url": "https://api.github.com/users/Brianfit/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Brianfit/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Brianfit/subscriptions",
      "organizations_url": "https://api.github.com/users/Brianfit/orgs",
      "repos_url": "https://api.github.com/users/Brianfit/repos",
      "events_url": "https://api.github.com/users/Brianfit/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Brianfit/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-19T17:47:20Z",
    "updated_at": "2021-03-19T17:50:36Z",
    "author_association": "NONE",
    "body": "Thanks, Michael. I appreciate the detailed forensics -- very helpful. And to be clear, I was back up and running on reboot. I've been preparing a move of Geth on to another Pi to reduce memory pressure, and will finish that job this weekend. I've had a couple other instances of out-of-memory events, but I thought I'd solved it by removing glances as a background process.  \r\n \r\n> Your systemd setup gracefully stopped the Lighthouse validator client (PID 250997) on the line Stopping Lighthouse Eth2 \r\n> Client Validator Node, seemingly because you have it set up to stop whenever the BN stops?\r\n\r\nNot knowingly! I followed the Somer Esat guides without any modification to the .service files other than cranking down the geth cache size.\r\n\r\nHere are links to my [lighthousebeacon.service](https://brian-fitzgerald.net/wtflog/lighthousebeacon.service.txt) and [lighthousevalidator.service ](https://brian-fitzgerald.net/wtflog/lighthousevalidator.service.txt)\r\n\r\nPerhaps this is a Feature Request instead of a bug report: that the Beacon Node detect when the validator is not running, and indicate its state via a CRIT report.\r\n\r\nThe sad fact is that I had unknowingly switched off notifications from beaconcha.in. I do a daily look at the log for any problems and saw the CRIT warning about the Cache failure, but what appeared to be full recovery and normal info messages indicating all was well -- but in fact my attestations were failing.  Had I been more rigorous in parsing the log, and maintained the discipline of checking Beaconcha.in I would have known action was required. Missed a block proposal as a result. So thought it might benefit someone in the future to see a log shout that action was required.  \r\n\r\nThanks again and appreciate both what you and the Lighthouse team do and your excellent communications. ",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/803005020/reactions",
      "total_count": 2,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 2,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/825564512",
    "html_url": "https://github.com/sigp/lighthouse/issues/2271#issuecomment-825564512",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/2271",
    "id": 825564512,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgyNTU2NDUxMg==",
    "user": {
      "login": "paulhauner",
      "id": 6660660,
      "node_id": "MDQ6VXNlcjY2NjA2NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/paulhauner",
      "html_url": "https://github.com/paulhauner",
      "followers_url": "https://api.github.com/users/paulhauner/followers",
      "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
      "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
      "organizations_url": "https://api.github.com/users/paulhauner/orgs",
      "repos_url": "https://api.github.com/users/paulhauner/repos",
      "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/paulhauner/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-04-23T10:29:59Z",
    "updated_at": "2021-04-23T10:29:59Z",
    "author_association": "MEMBER",
    "body": "> that the Beacon Node detect when the validator is not running, and indicate its state via a CRIT report.\r\n\r\nI agree that this would be nice, however the BN/VC relationship is structured such that the BN has no knowledge of the validator client. It's annoying in this case, but it's very nice in many other cases (such as your VC being able to arbitrarily switch to any other BN on the fly).\r\n\r\nI think what would really help you here is the `--validator-monitor-auto` flag on `lighthouse bn`. If you add this flag to your BN, it will infer which validators are your own (based on requests from the VC) and then give you `ERRO` logs if it detects they aren't performing well. It'll also give you `INFO` logs when they *are* performing well and some Prometheus metrics. You can read more about it here: https://lighthouse-book.sigmaprime.io/validator-monitoring.html\r\n\r\n> Thanks again and appreciate both what you and the Lighthouse team do and your excellent communications.\r\n\r\nThanks for the positive feedback, it means a lot!\r\n\r\nI'm going to close this one since I think we've addressed the issue here. Please feel free to reopen if you disagree :)",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/825564512/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
