{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/1067",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/1067/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/1067/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/1067/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/1067",
  "id": 607518313,
  "node_id": "MDU6SXNzdWU2MDc1MTgzMTM=",
  "number": 1067,
  "title": "thread 'tokio-runtime-worker-7' panicked at 'elapsed=7481664; when=7481664'",
  "user": {
    "login": "q9f",
    "id": 58883403,
    "node_id": "MDQ6VXNlcjU4ODgzNDAz",
    "avatar_url": "https://avatars.githubusercontent.com/u/58883403?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/q9f",
    "html_url": "https://github.com/q9f",
    "followers_url": "https://api.github.com/users/q9f/followers",
    "following_url": "https://api.github.com/users/q9f/following{/other_user}",
    "gists_url": "https://api.github.com/users/q9f/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/q9f/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/q9f/subscriptions",
    "organizations_url": "https://api.github.com/users/q9f/orgs",
    "repos_url": "https://api.github.com/users/q9f/repos",
    "events_url": "https://api.github.com/users/q9f/events{/privacy}",
    "received_events_url": "https://api.github.com/users/q9f/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 985647281,
      "node_id": "MDU6TGFiZWw5ODU2NDcyODE=",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/bug",
      "name": "bug",
      "color": "d73a4a",
      "default": true,
      "description": "Something isn't working"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 20,
  "created_at": "2020-04-27T12:43:44Z",
  "updated_at": "2020-05-19T23:11:36Z",
  "closed_at": "2020-05-18T11:53:03Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nThe sync manager shut down and I temporarily lost finality on Schlesi Testnet.\r\n\r\n```\r\nthread 'tokio-runtime-worker-7' panicked at 'elapsed=7481664; when=7481664', /home/user/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-timer-0.2.13/src/wheel/mod.rs:244:5\r\n```\r\n\r\n## Version\r\n\r\nUsing Lighthouse from this branch #1052 @ 310cc4fb504f6b3d6f4b0e9a5f53715a0c848138\r\n\r\nUsing Schlesi config: https://github.com/goerli/schlesi\r\n\r\n## Present Behavior\r\n\r\nConnected a validator client to a beacon node locally, lost sync manager on the beacon node:\r\n\r\n```\r\nApr 27 13:18:00.206 INFO Block from local validator              block_slot: 390, block_root: 0x7e2d…96d0, service: http\r\nApr 27 13:18:06.000 INFO Synced                                  slot: 390, epoch: 12, finalized_epoch: 10, finalized_root: 0xd017…bed4, peers: 6, service: slot_notifier\r\nApr 27 13:18:16.020 INFO Attestation from local validator        slot: 391, index: 0, source: 11, target: 11, service: http\r\nApr 27 13:18:18.001 INFO Synced                                  slot: 391, epoch: 12, finalized_epoch: 10, finalized_root: 0xd017…bed4, peers: 6, service: slot_notifier\r\nApr 27 13:18:20.041 INFO Attestation from local validator        slot: 391, index: 0, source: 11, target: 11, service: http\r\nthread 'tokio-runtime-worker-7' panicked at 'elapsed=7481664; when=7481664', /home/user/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-timer-0.2.13/src/wheel/mod.rs:244:5\r\nnote: run with `RUST_BACKTRACE=1` environment variable to display a backtrace\r\nApr 27 13:18:21.453 INFO Sync Manager shutdown                   service: sync, service: network\r\nApr 27 13:18:30.001 INFO Synced                                  slot: 392, epoch: 12, finalized_epoch: 10, finalized_root: 0xd017…bed4, peers: 6, service: slot_notifier\r\nApr 27 13:18:36.146 ERRO No valid eth1_data votes, `votes_to_consider` empty, outcome: casting `state.eth1_data` as eth1 vote, genesis_time: 1587981600, earliest_block_timestamp: 1587974284, lowest_block_number: 2596126, service: beacon\r\nApr 27 13:18:36.177 INFO Block from local validator              block_slot: 393, block_root: 0x7d1e…64e9, service: http\r\nApr 27 13:18:42.001 INFO Synced                                  slot: 393, epoch: 12, finalized_epoch: 10, finalized_root: 0xd017…bed4, peers: 6, service: slot_notifier\r\nApr 27 13:18:54.001 INFO Synced                                  slot: 394, epoch: 12, finalized_epoch: 10, finalized_root: 0xd017…bed4, peers: 6, service: slot_notifier\r\nApr 27 13:19:00.170 ERRO No valid eth1_data votes, `votes_to_consider` empty, outcome: casting `state.eth1_data` as eth1 vote, genesis_time: 1587981600, earliest_block_timestamp: 1587974284, lowest_block_number: 2596126, service: beacon\r\nApr 27 13:19:00.244 INFO Block from local validator              block_slot: 395, block_root: 0xfcac…31d4, service: http\r\nApr 27 13:19:06.001 INFO Synced                                  slot: 395, epoch: 12, finalized_epoch: 10, finalized_root: 0xd017…bed4, peers: 6, service: slot_notifier\r\nApr 27 13:19:18.001 INFO Synced                                  slot: 396, epoch: 12, finalized_epoch: 10, finalized_root: 0xd017…bed4, peers: 6, service: slot_notifier\r\n```\r\n\r\nValidator lost ability to submit blocks:\r\n\r\n```\r\nApr 27 13:18:04.002 INFO Successfully subscribed validators      failed_validators: 2, validators: 2, service: attestation\r\nApr 27 13:18:06.001 INFO Some validators active                  slot: 390, epoch: 12, total_validators: 3, active_validators: 2, proposers: 2, service: notifier\r\nApr 27 13:18:16.002 INFO Successfully subscribed validators      failed_validators: 2, validators: 2, service: attestation\r\nApr 27 13:18:16.020 INFO Successfully published attestations     slot: 391, committee_index: 0, head_block: 0x0f3fbc341d18706b67578838e9bdda5314d0a7eb87b9e48d26825dd9fd84ca0d, count: 1, service: attestation\r\nApr 27 13:18:18.001 INFO Some validators active                  slot: 391, epoch: 12, total_validators: 3, active_validators: 2, proposers: 2, service: notifier\r\nApr 27 13:18:20.042 INFO Successfully published aggregate attestations, slot: 391, committee_index: 0, head_block: 0x0f3f…ca0d, signatures: 1, service: attestation\r\nApr 27 13:18:28.002 CRIT Error during attestation production     error: Failed to subscribe validators: ReqwestError(Error(Status(500), \"http://localhost:5052/validator/subscribe\")), service: attestation\r\nApr 27 13:18:30.001 INFO Some validators active                  slot: 392, epoch: 12, total_validators: 3, active_validators: 2, proposers: 2, service: notifier\r\nApr 27 13:18:36.177 CRIT Error whilst producing block            message: Error from beacon node when publishing block: ReqwestError(Error(Status(500), \"http://localhost:5052/validator/block\")), service: block\r\nApr 27 13:18:40.002 CRIT Error during attestation production     error: Failed to subscribe validators: ReqwestError(Error(Status(500), \"http://localhost:5052/validator/subscribe\")), service: attestation\r\nApr 27 13:18:42.001 INFO Some validators active                  slot: 393, epoch: 12, total_validators: 3, active_validators: 2, proposers: 2, service: notifier\r\nApr 27 13:18:52.001 CRIT Error during attestation production     error: Failed to subscribe validators: ReqwestError(Error(Status(500), \"http://localhost:5052/validator/subscribe\")), service: attestation\r\nApr 27 13:18:54.001 INFO Some validators active                  slot: 394, epoch: 12, total_validators: 3, active_validators: 2, proposers: 2, service: notifier\r\nApr 27 13:19:00.244 CRIT Error whilst producing block            message: Error from beacon node when publishing block: ReqwestError(Error(Status(500), \"http://localhost:5052/validator/block\")), service: block\r\nApr 27 13:19:04.002 CRIT Error during attestation production     error: Failed to subscribe validators: ReqwestError(Error(Status(500), \"http://localhost:5052/validator/subscribe\")), service: attestation\r\nApr 27 13:19:06.001 INFO Some validators active                  slot: 395, epoch: 12, total_validators: 3, active_validators: 2, proposers: 2, service: notifier\r\nApr 27 13:19:16.002 CRIT Error during attestation production     error: Failed to subscribe validators: ReqwestError(Error(Status(500), \"http://localhost:5052/validator/subscribe\")), service: attestation\r\nApr 27 13:19:18.001 INFO Some validators active                  slot: 396, epoch: 12, total_validators: 3, active_validators: 2, proposers: 2, service: notifier\r\n```\r\n\r\n## Expected Behavior\r\n\r\nShould not panic :)\r\n\r\n## Steps to resolve\r\n\r\n A restart was able to resolve this.",
  "closed_by": {
    "login": "AgeManning",
    "id": 7454587,
    "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/AgeManning",
    "html_url": "https://github.com/AgeManning",
    "followers_url": "https://api.github.com/users/AgeManning/followers",
    "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
    "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
    "organizations_url": "https://api.github.com/users/AgeManning/orgs",
    "repos_url": "https://api.github.com/users/AgeManning/repos",
    "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
    "received_events_url": "https://api.github.com/users/AgeManning/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/1067/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/1067/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/620296800",
    "html_url": "https://github.com/sigp/lighthouse/issues/1067#issuecomment-620296800",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1067",
    "id": 620296800,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyMDI5NjgwMA==",
    "user": {
      "login": "paulhauner",
      "id": 6660660,
      "node_id": "MDQ6VXNlcjY2NjA2NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/paulhauner",
      "html_url": "https://github.com/paulhauner",
      "followers_url": "https://api.github.com/users/paulhauner/followers",
      "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
      "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
      "organizations_url": "https://api.github.com/users/paulhauner/orgs",
      "repos_url": "https://api.github.com/users/paulhauner/repos",
      "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/paulhauner/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-04-27T23:57:59Z",
    "updated_at": "2020-04-27T23:57:59Z",
    "author_association": "MEMBER",
    "body": "I couldn't find the tag for `tokio-timer-0.2.13` github.com/tokio-rs, but by looking at the crates.io code, it seems that  `tokio-timer-0.2.12` is equivalent for this purpose.\r\n\r\nDigging into that code, it seems that the panic is [here](https://github.com/tokio-rs/tokio/blob/97565c0e7565c2d260bf5ce3102a4034fdd9652b/tokio-timer/src/wheel/mod.rs#L244):\r\n\r\n```rust\r\nfn level_for(elapsed: u64, when: u64) -> usize {\r\n    let masked = elapsed ^ when;\r\n\r\n    assert!(masked != 0, \"elapsed={}; when={}\", elapsed, when);\r\n\r\n    let leading_zeros = masked.leading_zeros() as usize;\r\n    let significant = 63 - leading_zeros;\r\n    significant / 6\r\n}\r\n```\r\n\r\nSo I think this panic means `elapsed == when`.\r\n\r\nWe can follow a call-chain to end up at `HashSetDelay::update_timeout`, where @AgeManning previously indicated the panic was:\r\n\r\n[`wheel::level_for`](https://github.com/tokio-rs/tokio/blob/97565c0e7565c2d260bf5ce3102a4034fdd9652b/tokio-timer/src/wheel/mod.rs#L241) <- [`Wheel::insert`](https://github.com/tokio-rs/tokio/blob/97565c0e7565c2d260bf5ce3102a4034fdd9652b/tokio-timer/src/wheel/mod.rs#L99) <- [`DelayQueue::insert_idx`](https://github.com/tokio-rs/tokio/blob/97565c0e7565c2d260bf5ce3102a4034fdd9652b/tokio-timer/src/delay_queue.rs#L408) <- [`DelayQueue::reset_at`](https://github.com/tokio-rs/tokio/blob/97565c0e7565c2d260bf5ce3102a4034fdd9652b/tokio-timer/src/delay_queue.rs#L504) <- [`DelayQueue::reset`](https://github.com/tokio-rs/tokio/blob/97565c0e7565c2d260bf5ce3102a4034fdd9652b/tokio-timer/src/delay_queue.rs#L561) <- [`HashSetDelay::update_timeout`](https://github.com/sigp/lighthouse/blob/15a3af89662c4f2bc02f3eeaffca46be70a532b1/eth2/utils/hashmap_delay/src/hashset_delay.rs#L96).\r\n\r\nConsidering the call chain, it seems like the panic is caused by `DelayQueue::insert_idx` being called with a `when` that is equal to the current time of it's underlying `Wheel`. I think this happens if we call `HashSetDelay::update_timeout` with `timeout == 0`.\r\n\r\nHaving a poke around it seems to explicity happen here:\r\n\r\nhttps://github.com/sigp/lighthouse/blob/500f6b53d17c5bc7f3cffb1855800cf1ac8bb159/beacon_node/network/src/attestation_service/mod.rs#L312\r\n\r\nOr perhaps here:\r\n\r\nhttps://github.com/sigp/lighthouse/blob/500f6b53d17c5bc7f3cffb1855800cf1ac8bb159/beacon_node/network/src/attestation_service/mod.rs#L260-L278",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/620296800/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/620298626",
    "html_url": "https://github.com/sigp/lighthouse/issues/1067#issuecomment-620298626",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1067",
    "id": 620298626,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyMDI5ODYyNg==",
    "user": {
      "login": "paulhauner",
      "id": 6660660,
      "node_id": "MDQ6VXNlcjY2NjA2NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/paulhauner",
      "html_url": "https://github.com/paulhauner",
      "followers_url": "https://api.github.com/users/paulhauner/followers",
      "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
      "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
      "organizations_url": "https://api.github.com/users/paulhauner/orgs",
      "repos_url": "https://api.github.com/users/paulhauner/repos",
      "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/paulhauner/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-04-28T00:03:35Z",
    "updated_at": "2020-04-28T00:03:35Z",
    "author_association": "MEMBER",
    "body": "Trying to test this now. Not having any luck though, perhaps I'm not on the right path.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/620298626/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/620312602",
    "html_url": "https://github.com/sigp/lighthouse/issues/1067#issuecomment-620312602",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1067",
    "id": 620312602,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyMDMxMjYwMg==",
    "user": {
      "login": "paulhauner",
      "id": 6660660,
      "node_id": "MDQ6VXNlcjY2NjA2NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/paulhauner",
      "html_url": "https://github.com/paulhauner",
      "followers_url": "https://api.github.com/users/paulhauner/followers",
      "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
      "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
      "organizations_url": "https://api.github.com/users/paulhauner/orgs",
      "repos_url": "https://api.github.com/users/paulhauner/repos",
      "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/paulhauner/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-04-28T00:53:01Z",
    "updated_at": "2020-04-28T00:53:01Z",
    "author_association": "MEMBER",
    "body": "Hmm `Wheel::insert` [already ensures](https://github.com/tokio-rs/tokio/blob/97565c0e7565c2d260bf5ce3102a4034fdd9652b/tokio-timer/src/wheel/mod.rs#L105-L109) that `when > self.elapsed` before calling `level_for`:\r\n\r\n```rust\r\n        if when <= self.elapsed {\r\n            return Err((item, InsertError::Elapsed));\r\n        } else if when - self.elapsed > MAX_DURATION {\r\n            return Err((item, InsertError::Invalid));\r\n        }\r\n\r\n        // Get the level at which the entry should be stored\r\n        let level = self.level_for(when);\r\n```\r\n\r\nShifting focus to [`Wheel::remove`](https://github.com/tokio-rs/tokio/blob/97565c0e7565c2d260bf5ce3102a4034fdd9652b/tokio-timer/src/wheel/mod.rs#L127).",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/620312602/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/620319694",
    "html_url": "https://github.com/sigp/lighthouse/issues/1067#issuecomment-620319694",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1067",
    "id": 620319694,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyMDMxOTY5NA==",
    "user": {
      "login": "paulhauner",
      "id": 6660660,
      "node_id": "MDQ6VXNlcjY2NjA2NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/paulhauner",
      "html_url": "https://github.com/paulhauner",
      "followers_url": "https://api.github.com/users/paulhauner/followers",
      "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
      "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
      "organizations_url": "https://api.github.com/users/paulhauner/orgs",
      "repos_url": "https://api.github.com/users/paulhauner/repos",
      "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/paulhauner/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-04-28T01:16:45Z",
    "updated_at": "2020-04-28T01:16:45Z",
    "author_association": "MEMBER",
    "body": "So `Wheel::reset_at` [calls](https://github.com/tokio-rs/tokio/blob/97565c0e7565c2d260bf5ce3102a4034fdd9652b/tokio-timer/src/delay_queue.rs#L505) `Wheel::remove`!\r\n\r\n```rust\r\n    pub fn reset_at(&mut self, key: &Key, when: Instant) {\r\n        self.wheel.remove(&key.index, &mut self.slab);\r\n\r\n        // Normalize the deadline. Values cannot be set to expire in the past.\r\n        let when = self.normalize_deadline(when);\r\n\r\n        self.slab[key.index].when = when;\r\n        self.insert_idx(when, key.index);\r\n\r\n        let next_deadline = self.next_deadline();\r\n        if let (Some(ref mut delay), Some(deadline)) = (&mut self.delay, next_deadline) {\r\n            delay.reset(deadline);\r\n        }\r\n    }\r\n```\r\n\r\nGoing deeper...",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/620319694/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/620330405",
    "html_url": "https://github.com/sigp/lighthouse/issues/1067#issuecomment-620330405",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1067",
    "id": 620330405,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyMDMzMDQwNQ==",
    "user": {
      "login": "paulhauner",
      "id": 6660660,
      "node_id": "MDQ6VXNlcjY2NjA2NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/paulhauner",
      "html_url": "https://github.com/paulhauner",
      "followers_url": "https://api.github.com/users/paulhauner/followers",
      "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
      "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
      "organizations_url": "https://api.github.com/users/paulhauner/orgs",
      "repos_url": "https://api.github.com/users/paulhauner/repos",
      "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/paulhauner/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-04-28T01:56:24Z",
    "updated_at": "2020-04-28T01:56:24Z",
    "author_association": "MEMBER",
    "body": "Alright, I manged to trigger the panic by adding this test to the end of [hashmap_delay.rs](https://github.com/sigp/lighthouse/blob/master/eth2/utils/hashmap_delay/src/hashmap_delay.rs):\r\n\r\n```rust\r\n    #[test]\r\n    #[should_panic]\r\n    fn panic() {\r\n        let key = 2;\r\n        let value = 2;\r\n\r\n        let mut map = HashMapDelay::default();\r\n\r\n        std::thread::sleep(Duration::from_secs(1));\r\n\r\n        for _ in 0..10000 {\r\n            for _ in 0..100 {\r\n                let _ = map.poll();\r\n            }\r\n            map.insert(key, value);\r\n            map.update_timeout(&key, Duration::from_secs(0));\r\n        }\r\n    }\r\n```\r\n\r\nNow I need to refine this and figure out if tokio is being naughty and how we can avoid it.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/620330405/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/620331859",
    "html_url": "https://github.com/sigp/lighthouse/issues/1067#issuecomment-620331859",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1067",
    "id": 620331859,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyMDMzMTg1OQ==",
    "user": {
      "login": "paulhauner",
      "id": 6660660,
      "node_id": "MDQ6VXNlcjY2NjA2NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/paulhauner",
      "html_url": "https://github.com/paulhauner",
      "followers_url": "https://api.github.com/users/paulhauner/followers",
      "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
      "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
      "organizations_url": "https://api.github.com/users/paulhauner/orgs",
      "repos_url": "https://api.github.com/users/paulhauner/repos",
      "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/paulhauner/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-04-28T02:01:38Z",
    "updated_at": "2020-04-28T02:01:38Z",
    "author_association": "MEMBER",
    "body": "For clarity, here's the panic message:\r\n\r\n```\r\n**thread 'hashmap_delay::tests::panic' panicked at 'elapsed=98304; when=98304', /home/paul/development/tokio/tokio-timer/src/wheel/mod.rs:244:5\r\nnote: run with `RUST_BACKTRACE=1` environment variable to display a backtrace.**\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/620331859/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/621058472",
    "html_url": "https://github.com/sigp/lighthouse/issues/1067#issuecomment-621058472",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1067",
    "id": 621058472,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyMTA1ODQ3Mg==",
    "user": {
      "login": "paulhauner",
      "id": 6660660,
      "node_id": "MDQ6VXNlcjY2NjA2NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/paulhauner",
      "html_url": "https://github.com/paulhauner",
      "followers_url": "https://api.github.com/users/paulhauner/followers",
      "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
      "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
      "organizations_url": "https://api.github.com/users/paulhauner/orgs",
      "repos_url": "https://api.github.com/users/paulhauner/repos",
      "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/paulhauner/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-04-29T08:19:16Z",
    "updated_at": "2020-04-29T08:19:16Z",
    "author_association": "MEMBER",
    "body": "Alright, so I've been looking into this some more and I'll document where I'm up to for history sake.\r\n\r\nSo the panic we're looking for comes from `elapsed == when` in [`wheel::level_for`](https://github.com/tokio-rs/tokio/blob/97565c0e7565c2d260bf5ce3102a4034fdd9652b/tokio-timer/src/wheel/mod.rs#L241-L249) which is a private fn and only called in two places:\r\n\r\n- [`Wheel::insert`](https://github.com/tokio-rs/tokio/blob/97565c0e7565c2d260bf5ce3102a4034fdd9652b/tokio-timer/src/wheel/mod.rs#L99-L124): this call is [guarded against](https://github.com/tokio-rs/tokio/blob/97565c0e7565c2d260bf5ce3102a4034fdd9652b/tokio-timer/src/wheel/mod.rs#L105) `elapsed == when`.\r\n- [`Wheel::remove`](https://github.com/tokio-rs/tokio/blob/97565c0e7565c2d260bf5ce3102a4034fdd9652b/tokio-timer/src/wheel/mod.rs#L127-L132): not guarded from this condition.\r\n\r\nGiven this, `Wheel::remove` must be the culprit.\r\n\r\nSo how can `elapsed == when`? Let's look at how these variables are set:\r\n\r\n- `elapsed`: [always set to](https://github.com/tokio-rs/tokio/blob/97565c0e7565c2d260bf5ce3102a4034fdd9652b/tokio-timer/src/wheel/mod.rs#L237) `Wheel::elapsed`. But where is the private `self.elapsed` var set?\r\n  - Via [`Wheel::set_elapsed`](https://github.com/tokio-rs/tokio/blob/97565c0e7565c2d260bf5ce3102a4034fdd9652b/tokio-timer/src/wheel/mod.rs#L219) which is only called via [`Wheel::poll`](https://github.com/tokio-rs/tokio/blob/97565c0e7565c2d260bf5ce3102a4034fdd9652b/tokio-timer/src/wheel/mod.rs#L139-L167).\r\n- `when`: set [here](https://github.com/tokio-rs/tokio/blob/97565c0e7565c2d260bf5ce3102a4034fdd9652b/tokio-timer/src/wheel/mod.rs#L114) in `Wheel::insert` to a value that must be higher than `self.elapsed` (so previously mentioned guard condition).\r\n\r\nGiven this, `when` can never be set to equal `elapsed`. But, `self.elapsed` can be set to equal `when` via `Wheel:poll`.\r\n\r\nPoll pops the next expired task off the wheel and maybe sets `self.elapsed`. So, what I can figure is that we have multiple processes that are set to expire at the same time and we've popped one of them (and updated `self.elapsed`) but failed to pop the rest of them off via `poll`. Then, before calling `poll` again we've tried to `Wheel::remove` one of those expired-but-not-popped entries.\r\n\r\nSo, why would we pop one entry but not the rest? We call poll in this in two places:\r\n\r\n- [`AttestationService`](https://github.com/sigp/lighthouse/blob/7f2121205aed5d0a5dadd11e09e2970f57e56254/beacon_node/network/src/attestation_service/mod.rs#L605)\r\n- [`PeerManager`](https://github.com/sigp/lighthouse/blob/7f2121205aed5d0a5dadd11e09e2970f57e56254/beacon_node/eth2-libp2p/src/peer_manager/mod.rs#L321)\r\n\r\nBoth of these we poll till we get `None`, unless we hit an error. So, we must be hitting an error. We can hit an error via:\r\n\r\n- [In `HashSetDelay`](https://github.com/sigp/lighthouse/blob/7f2121205aed5d0a5dadd11e09e2970f57e56254/eth2/utils/hashmap_delay/src/hashset_delay.rs#L155) a value exists in `self.expirations` but not in `self.entries`:  I can't for the life of me figure out how this is possible.\r\n- Via an upstream [`tokio_timer::Error`](https://docs.rs/tokio-timer/0.2.11/tokio_timer/struct.Error.html): the only error that seems reachable here is `Shutdown`, which means the timer is shutdown and we can never recover. This certainly doesn't seem like the case to me.\r\n\r\nSo, I'm at a bit of a loss here. My solution now is to patch `Wheel::remove` with:\r\n\r\n```rust\r\n        let level = if when == self.elapsed {\r\n            0\r\n        } else {\r\n            self.level_for(when)\r\n        };\r\n```\r\n\r\nI'm not convinced that this is the right solution, but it seems to be my only solution available at the moment so I'm going to take a shot.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/621058472/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/621318614",
    "html_url": "https://github.com/sigp/lighthouse/issues/1067#issuecomment-621318614",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1067",
    "id": 621318614,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyMTMxODYxNA==",
    "user": {
      "login": "q9f",
      "id": 58883403,
      "node_id": "MDQ6VXNlcjU4ODgzNDAz",
      "avatar_url": "https://avatars.githubusercontent.com/u/58883403?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/q9f",
      "html_url": "https://github.com/q9f",
      "followers_url": "https://api.github.com/users/q9f/followers",
      "following_url": "https://api.github.com/users/q9f/following{/other_user}",
      "gists_url": "https://api.github.com/users/q9f/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/q9f/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/q9f/subscriptions",
      "organizations_url": "https://api.github.com/users/q9f/orgs",
      "repos_url": "https://api.github.com/users/q9f/repos",
      "events_url": "https://api.github.com/users/q9f/events{/privacy}",
      "received_events_url": "https://api.github.com/users/q9f/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-04-29T16:23:05Z",
    "updated_at": "2020-04-29T16:23:05Z",
    "author_association": "CONTRIBUTOR",
    "body": "```\r\nthread 'tokio-runtime-worker-6' panicked at 'elapsed=5186752; when=5186752', /home/user/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-timer-0.2.13/src/wheel/mod.rs:244:5\r\nstack backtrace:\r\n   0: backtrace::backtrace::libunwind::trace\r\n             at /cargo/registry/src/github.com-1ecc6299db9ec823/backtrace-0.3.44/src/backtrace/libunwind.rs:86\r\n   1: backtrace::backtrace::trace_unsynchronized\r\n             at /cargo/registry/src/github.com-1ecc6299db9ec823/backtrace-0.3.44/src/backtrace/mod.rs:66\r\n   2: std::sys_common::backtrace::_print_fmt\r\n             at src/libstd/sys_common/backtrace.rs:78\r\n   3: <std::sys_common::backtrace::_print::DisplayBacktrace as core::fmt::Display>::fmt\r\n             at src/libstd/sys_common/backtrace.rs:59\r\n   4: core::fmt::write\r\n             at src/libcore/fmt/mod.rs:1063\r\n   5: std::io::Write::write_fmt\r\n             at src/libstd/io/mod.rs:1426\r\n   6: std::sys_common::backtrace::_print\r\n             at src/libstd/sys_common/backtrace.rs:62\r\n   7: std::sys_common::backtrace::print\r\n             at src/libstd/sys_common/backtrace.rs:49\r\n   8: std::panicking::default_hook::{{closure}}\r\n             at src/libstd/panicking.rs:204\r\n   9: std::panicking::default_hook\r\n             at src/libstd/panicking.rs:224\r\n  10: std::panicking::rust_panic_with_hook\r\n             at src/libstd/panicking.rs:470\r\n  11: rust_begin_unwind\r\n             at src/libstd/panicking.rs:378\r\n  12: std::panicking::begin_panic_fmt\r\n             at src/libstd/panicking.rs:332\r\n  13: tokio_timer::wheel::level_for\r\n  14: tokio_timer::wheel::Wheel<T>::remove\r\n  15: tokio_timer::delay_queue::DelayQueue<T>::reset\r\n  16: hashmap_delay::hashset_delay::HashSetDelay<K>::insert\r\n  17: eth2_libp2p::peer_manager::PeerManager<TSpec>::ping_request\r\n  18: <eth2_libp2p::behaviour::Behaviour<TSubstream,TSpec> as libp2p_swarm::behaviour::NetworkBehaviour>::poll\r\n  19: <libp2p_swarm::ExpandedSwarm<TTransport,TBehaviour,TInEvent,TOutEvent,THandler,THandlerErr,TConnInfo> as futures::stream::Stream>::poll\r\n  20: <eth2_libp2p::service::Service<TSpec> as futures::stream::Stream>::poll\r\n  21: <futures::future::poll_fn::PollFn<F> as futures::future::Future>::poll\r\n  22: futures::task_impl::std::set\r\n  23: std::panicking::try::do_call\r\n  24: __rust_maybe_catch_panic\r\n             at src/libpanic_unwind/lib.rs:86\r\n  25: tokio_threadpool::task::Task::run\r\n  26: tokio_threadpool::worker::Worker::run_task\r\n  27: tokio_threadpool::worker::Worker::run\r\n  28: tokio_timer::clock::clock::with_default\r\n  29: tokio::runtime::threadpool::builder::Builder::build::{{closure}}\r\n  30: std::thread::local::LocalKey<T>::with\r\n  31: std::thread::local::LocalKey<T>::with\r\nnote: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/621318614/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/621561331",
    "html_url": "https://github.com/sigp/lighthouse/issues/1067#issuecomment-621561331",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1067",
    "id": 621561331,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyMTU2MTMzMQ==",
    "user": {
      "login": "paulhauner",
      "id": 6660660,
      "node_id": "MDQ6VXNlcjY2NjA2NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/paulhauner",
      "html_url": "https://github.com/paulhauner",
      "followers_url": "https://api.github.com/users/paulhauner/followers",
      "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
      "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
      "organizations_url": "https://api.github.com/users/paulhauner/orgs",
      "repos_url": "https://api.github.com/users/paulhauner/repos",
      "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/paulhauner/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-04-30T01:39:49Z",
    "updated_at": "2020-04-30T01:39:49Z",
    "author_association": "MEMBER",
    "body": "Alright, new progress. I still think it's possible to make `tokio_timer` panic if you do a `Wheel::remove` between calls to `Wheel::poll`, however I don't think that's what we're doing here. The fact that we're taking mutable references to `HashSetDelay` means that we can statically analyze the struct on it's own and determine that it's impossible for this to happen with the current code. Ofc, I haven't formally proved it but that's what I get from detailed reading of it.\r\n\r\nThe new thing is that we're using `PeerId` in a `HashMap`. `PeerId` has [the following caveat](https://github.com/libp2p/rust-libp2p/blob/1be34fd7a363b04a985b596abf0dba4941ae9a01/core/src/peer_id.rs#L212-L219) on it's `AsRef<[u8]>` impl (notably, not on it's `Hash` or `Eq` impls):\r\n\r\n```rust\r\n/// **NOTE:** This byte representation is not necessarily consistent with\r\n/// equality of peer IDs. That is, two peer IDs may be considered equal\r\n/// while having a different byte representation as per `AsRef<[u8]>`.\r\nimpl AsRef<[u8]> for PeerId {\r\n    fn as_ref(&self) -> &[u8] {\r\n        self.as_bytes()\r\n    }\r\n```\r\n\r\nThis breaks an assumption by [`std::collections::HashMap`](https://doc.rust-lang.org/std/collections/struct.HashMap.html):\r\n\r\n> ... if two keys are equal, their hashes must be equal.\r\n\r\nThis gives us reason to assume that `HashSetDelay::expirations` and `HashSetDelay::items` can become disjoint. This is certainly a path worth exploring.\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/621561331/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/621622128",
    "html_url": "https://github.com/sigp/lighthouse/issues/1067#issuecomment-621622128",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1067",
    "id": 621622128,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyMTYyMjEyOA==",
    "user": {
      "login": "AgeManning",
      "id": 7454587,
      "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AgeManning",
      "html_url": "https://github.com/AgeManning",
      "followers_url": "https://api.github.com/users/AgeManning/followers",
      "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
      "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
      "organizations_url": "https://api.github.com/users/AgeManning/orgs",
      "repos_url": "https://api.github.com/users/AgeManning/repos",
      "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AgeManning/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-04-30T05:33:22Z",
    "updated_at": "2020-04-30T05:33:22Z",
    "author_association": "MEMBER",
    "body": "Seems tokio::DelayQueue is all kinds of broken in the version we are using. \r\n\r\nWe've added a patch, which corrects its behaviour is some initial testing. Was not able to reproduce the panic in a testing environment but hopefully the corrected behaviour addresses this in the wild. ",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/621622128/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/621654810",
    "html_url": "https://github.com/sigp/lighthouse/issues/1067#issuecomment-621654810",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1067",
    "id": 621654810,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyMTY1NDgxMA==",
    "user": {
      "login": "paulhauner",
      "id": 6660660,
      "node_id": "MDQ6VXNlcjY2NjA2NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/paulhauner",
      "html_url": "https://github.com/paulhauner",
      "followers_url": "https://api.github.com/users/paulhauner/followers",
      "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
      "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
      "organizations_url": "https://api.github.com/users/paulhauner/orgs",
      "repos_url": "https://api.github.com/users/paulhauner/repos",
      "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/paulhauner/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-04-30T07:08:45Z",
    "updated_at": "2020-04-30T07:08:45Z",
    "author_association": "MEMBER",
    "body": "We discovered that if you call `DelayQueue::insert` during a series of `DelayQueue::poll` calls it will cause the next `DelayQueue:poll` to return `Async::NotReady`. I believe this can cause the issue I mentioned in https://github.com/sigp/lighthouse/issues/1067#issuecomment-621058472. We were not able to recreate, though.\r\n\r\nWe tested against the latest version of `tokio` and did not observe this weird behavior. We're upgrading to this version via #879, so I think the best course is to patch for now. This saves us getting deep into a older version of tokio that we're going to replace in a week or so anyway.\r\n\r\nI think we should leave this issue open until @q9f and myself don't observe this panic for a couple of days.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/621654810/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/622302247",
    "html_url": "https://github.com/sigp/lighthouse/issues/1067#issuecomment-622302247",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1067",
    "id": 622302247,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyMjMwMjI0Nw==",
    "user": {
      "login": "q9f",
      "id": 58883403,
      "node_id": "MDQ6VXNlcjU4ODgzNDAz",
      "avatar_url": "https://avatars.githubusercontent.com/u/58883403?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/q9f",
      "html_url": "https://github.com/q9f",
      "followers_url": "https://api.github.com/users/q9f/followers",
      "following_url": "https://api.github.com/users/q9f/following{/other_user}",
      "gists_url": "https://api.github.com/users/q9f/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/q9f/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/q9f/subscriptions",
      "organizations_url": "https://api.github.com/users/q9f/orgs",
      "repos_url": "https://api.github.com/users/q9f/repos",
      "events_url": "https://api.github.com/users/q9f/events{/privacy}",
      "received_events_url": "https://api.github.com/users/q9f/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-01T08:38:30Z",
    "updated_at": "2020-05-01T08:38:30Z",
    "author_association": "CONTRIBUTOR",
    "body": "I can no longer observe this.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/622302247/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 1,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/623109350",
    "html_url": "https://github.com/sigp/lighthouse/issues/1067#issuecomment-623109350",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1067",
    "id": 623109350,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyMzEwOTM1MA==",
    "user": {
      "login": "AgeManning",
      "id": 7454587,
      "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AgeManning",
      "html_url": "https://github.com/AgeManning",
      "followers_url": "https://api.github.com/users/AgeManning/followers",
      "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
      "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
      "organizations_url": "https://api.github.com/users/AgeManning/orgs",
      "repos_url": "https://api.github.com/users/AgeManning/repos",
      "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AgeManning/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-03T13:20:46Z",
    "updated_at": "2020-05-03T13:20:46Z",
    "author_association": "MEMBER",
    "body": "Closing as this is either resolved currently, or will soon be resolved with upgrades to tokio",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/623109350/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/623112724",
    "html_url": "https://github.com/sigp/lighthouse/issues/1067#issuecomment-623112724",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1067",
    "id": 623112724,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyMzExMjcyNA==",
    "user": {
      "login": "q9f",
      "id": 58883403,
      "node_id": "MDQ6VXNlcjU4ODgzNDAz",
      "avatar_url": "https://avatars.githubusercontent.com/u/58883403?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/q9f",
      "html_url": "https://github.com/q9f",
      "followers_url": "https://api.github.com/users/q9f/followers",
      "following_url": "https://api.github.com/users/q9f/following{/other_user}",
      "gists_url": "https://api.github.com/users/q9f/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/q9f/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/q9f/subscriptions",
      "organizations_url": "https://api.github.com/users/q9f/orgs",
      "repos_url": "https://api.github.com/users/q9f/repos",
      "events_url": "https://api.github.com/users/q9f/events{/privacy}",
      "received_events_url": "https://api.github.com/users/q9f/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-03T13:46:43Z",
    "updated_at": "2020-05-03T13:46:43Z",
    "author_association": "CONTRIBUTOR",
    "body": "Happened again this morning on master @ b6c027b9ecc77182d64f99594e6d4418764d01b8\r\n\r\n```\r\nMay 03 11:33:42.000 INFO Synced                                  slot: 43068, block:    …  empty, epoch: 1345, finalized_epoch: 1343, finalized_root: 0x2926…c66c, peers: 5, service: slot_notifier\r\nMay 03 11:33:51.244 INFO Imported eth1 block(s)                  new: 1, total_cached_blocks: 4096, latest_block: 2630036, latest_block_age: 256 mins, service: eth1_rpc\r\nMay 03 11:33:54.001 INFO Synced                                  slot: 43069, block: 0xe208…7e86, epoch: 1345, finalized_epoch: 1343, finalized_root: 0x2926…c66c, peers: 5, service: slot_notifier\r\nMay 03 11:34:00.188 INFO Block from local validator              block_slot: 43070, block_root: 0xafd8…aea0, service: http\r\nMay 03 11:34:04.023 INFO Attestation from local validator        slot: 43070, index: 0, source: 1344, target: 1344, service: http\r\nthread 'tokio-runtime-worker-3' panicked at 'elapsed=87109568; when=87109568', /home/user/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-timer-0.2.13/src/wheel/mod.rs:244:5\r\nnote: run with `RUST_BACKTRACE=1` environment variable to display a backtrace\r\nMay 03 11:34:04.066 INFO Sync Manager shutdown                   service: sync, service: network\r\nMay 03 11:34:05.330 INFO Imported eth1 block(s)                  new: 1, total_cached_blocks: 4096, latest_block: 2630037, latest_block_age: 256 mins, service: eth1_rpc\r\nMay 03 11:34:06.001 INFO Synced                                  slot: 43070, block: 0xafd8…aea0, epoch: 1345, finalized_epoch: 1343, finalized_root: 0x2926…c66c, peers: 5, service: slot_notifier\r\nMay 03 11:34:08.046 INFO Attestation from local validator        slot: 43070, index: 0, source: 1344, target: 1344, service: http\r\nMay 03 11:34:18.000 INFO Synced                                  slot: 43071, block:    …  empty, epoch: 1345, finalized_epoch: 1343, finalized_root: 0x2926…c66c, peers: 5, service: slot_notifier\r\nMay 03 11:34:19.406 INFO Imported eth1 block(s)                  new: 1, total_cached_blocks: 4096, latest_block: 2630038, latest_block_age: 256 mins, service: eth1_rpc\r\nMay 03 11:34:30.001 INFO Synced                                  slot: 43072, block:    …  empty, epoch: 1346, finalized_epoch: 1343, finalized_root: 0x2926…c66c, peers: 5, service: slot_notifier\r\nMay 03 11:34:33.478 INFO Imported eth1 block(s)                  new: 1, total_cached_blocks: 4096, latest_block: 2630039, latest_block_age: 256 mins, service: eth1_rpc\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/623112724/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/623189988",
    "html_url": "https://github.com/sigp/lighthouse/issues/1067#issuecomment-623189988",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1067",
    "id": 623189988,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyMzE4OTk4OA==",
    "user": {
      "login": "paulhauner",
      "id": 6660660,
      "node_id": "MDQ6VXNlcjY2NjA2NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/paulhauner",
      "html_url": "https://github.com/paulhauner",
      "followers_url": "https://api.github.com/users/paulhauner/followers",
      "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
      "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
      "organizations_url": "https://api.github.com/users/paulhauner/orgs",
      "repos_url": "https://api.github.com/users/paulhauner/repos",
      "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/paulhauner/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-03T22:07:44Z",
    "updated_at": "2020-05-03T22:07:44Z",
    "author_association": "MEMBER",
    "body": "Nooooo! That commit should indeed have the #1087 fix in it...\r\n\r\nI might just re-open this until we haven't seen it for a while and/or our [upstream issue](https://github.com/tokio-rs/tokio/issues/2473) is resolved.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/623189988/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/623221400",
    "html_url": "https://github.com/sigp/lighthouse/issues/1067#issuecomment-623221400",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1067",
    "id": 623221400,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyMzIyMTQwMA==",
    "user": {
      "login": "AgeManning",
      "id": 7454587,
      "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AgeManning",
      "html_url": "https://github.com/AgeManning",
      "followers_url": "https://api.github.com/users/AgeManning/followers",
      "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
      "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
      "organizations_url": "https://api.github.com/users/AgeManning/orgs",
      "repos_url": "https://api.github.com/users/AgeManning/repos",
      "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AgeManning/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-04T01:30:26Z",
    "updated_at": "2020-05-04T01:30:26Z",
    "author_association": "MEMBER",
    "body": "Tokio upgrades are inbound (this week) which should hopefully address this",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/623221400/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 1,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/628001892",
    "html_url": "https://github.com/sigp/lighthouse/issues/1067#issuecomment-628001892",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1067",
    "id": 628001892,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyODAwMTg5Mg==",
    "user": {
      "login": "AgeManning",
      "id": 7454587,
      "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AgeManning",
      "html_url": "https://github.com/AgeManning",
      "followers_url": "https://api.github.com/users/AgeManning/followers",
      "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
      "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
      "organizations_url": "https://api.github.com/users/AgeManning/orgs",
      "repos_url": "https://api.github.com/users/AgeManning/repos",
      "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AgeManning/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-13T13:53:34Z",
    "updated_at": "2020-05-13T13:53:34Z",
    "author_association": "MEMBER",
    "body": "Ok, I'm hoping the `stable-futures` branch resolves this. If anyone sees this on the `stable-futures` branch we are in trouble. Will be doing extensive testing. If we don't see it in a few days, will re-close this issue",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/628001892/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/630130696",
    "html_url": "https://github.com/sigp/lighthouse/issues/1067#issuecomment-630130696",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1067",
    "id": 630130696,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYzMDEzMDY5Ng==",
    "user": {
      "login": "AgeManning",
      "id": 7454587,
      "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AgeManning",
      "html_url": "https://github.com/AgeManning",
      "followers_url": "https://api.github.com/users/AgeManning/followers",
      "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
      "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
      "organizations_url": "https://api.github.com/users/AgeManning/orgs",
      "repos_url": "https://api.github.com/users/AgeManning/repos",
      "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AgeManning/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-18T11:53:03Z",
    "updated_at": "2020-05-18T11:53:03Z",
    "author_association": "MEMBER",
    "body": "I have not witnessed this in the stable futures upgrade. I'm going to consider this resolved again.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/630130696/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/630790534",
    "html_url": "https://github.com/sigp/lighthouse/issues/1067#issuecomment-630790534",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1067",
    "id": 630790534,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYzMDc5MDUzNA==",
    "user": {
      "login": "q9f",
      "id": 58883403,
      "node_id": "MDQ6VXNlcjU4ODgzNDAz",
      "avatar_url": "https://avatars.githubusercontent.com/u/58883403?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/q9f",
      "html_url": "https://github.com/q9f",
      "followers_url": "https://api.github.com/users/q9f/followers",
      "following_url": "https://api.github.com/users/q9f/following{/other_user}",
      "gists_url": "https://api.github.com/users/q9f/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/q9f/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/q9f/subscriptions",
      "organizations_url": "https://api.github.com/users/q9f/orgs",
      "repos_url": "https://api.github.com/users/q9f/repos",
      "events_url": "https://api.github.com/users/q9f/events{/privacy}",
      "received_events_url": "https://api.github.com/users/q9f/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-19T12:39:45Z",
    "updated_at": "2020-05-19T12:39:45Z",
    "author_association": "CONTRIBUTOR",
    "body": "Didn't see this either. :+1:",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/630790534/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/631135123",
    "html_url": "https://github.com/sigp/lighthouse/issues/1067#issuecomment-631135123",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1067",
    "id": 631135123,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYzMTEzNTEyMw==",
    "user": {
      "login": "AgeManning",
      "id": 7454587,
      "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AgeManning",
      "html_url": "https://github.com/AgeManning",
      "followers_url": "https://api.github.com/users/AgeManning/followers",
      "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
      "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
      "organizations_url": "https://api.github.com/users/AgeManning/orgs",
      "repos_url": "https://api.github.com/users/AgeManning/repos",
      "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AgeManning/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-19T23:11:36Z",
    "updated_at": "2020-05-19T23:11:36Z",
    "author_association": "MEMBER",
    "body": "I saw a notification for this thread and my heart sank a little. \r\n\r\nTurns out it's all good!! Wooh :tada: :taco: ",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/631135123/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
