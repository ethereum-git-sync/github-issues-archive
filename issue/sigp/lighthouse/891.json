{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/891",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/891/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/891/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/891/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/891",
  "id": 575161114,
  "node_id": "MDU6SXNzdWU1NzUxNjExMTQ=",
  "number": 891,
  "title": "Prune forks from the database",
  "user": {
    "login": "michaelsproul",
    "id": 4452260,
    "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/michaelsproul",
    "html_url": "https://github.com/michaelsproul",
    "followers_url": "https://api.github.com/users/michaelsproul/followers",
    "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
    "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
    "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
    "repos_url": "https://api.github.com/users/michaelsproul/repos",
    "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
    "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 985647284,
      "node_id": "MDU6TGFiZWw5ODU2NDcyODQ=",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/enhancement",
      "name": "enhancement",
      "color": "a2eeef",
      "default": true,
      "description": "New feature or request"
    },
    {
      "id": 1783740159,
      "node_id": "MDU6TGFiZWwxNzgzNzQwMTU5",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/security",
      "name": "security",
      "color": "d30ca8",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "adaszko",
    "id": 165678,
    "node_id": "MDQ6VXNlcjE2NTY3OA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/165678?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/adaszko",
    "html_url": "https://github.com/adaszko",
    "followers_url": "https://api.github.com/users/adaszko/followers",
    "following_url": "https://api.github.com/users/adaszko/following{/other_user}",
    "gists_url": "https://api.github.com/users/adaszko/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/adaszko/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/adaszko/subscriptions",
    "organizations_url": "https://api.github.com/users/adaszko/orgs",
    "repos_url": "https://api.github.com/users/adaszko/repos",
    "events_url": "https://api.github.com/users/adaszko/events{/privacy}",
    "received_events_url": "https://api.github.com/users/adaszko/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "adaszko",
      "id": 165678,
      "node_id": "MDQ6VXNlcjE2NTY3OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/165678?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/adaszko",
      "html_url": "https://github.com/adaszko",
      "followers_url": "https://api.github.com/users/adaszko/followers",
      "following_url": "https://api.github.com/users/adaszko/following{/other_user}",
      "gists_url": "https://api.github.com/users/adaszko/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/adaszko/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/adaszko/subscriptions",
      "organizations_url": "https://api.github.com/users/adaszko/orgs",
      "repos_url": "https://api.github.com/users/adaszko/repos",
      "events_url": "https://api.github.com/users/adaszko/events{/privacy}",
      "received_events_url": "https://api.github.com/users/adaszko/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2020-03-04T06:09:29Z",
  "updated_at": "2020-06-01T12:46:22Z",
  "closed_at": "2020-06-01T12:46:22Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nAt the moment Lighthouse will keep blocks and states from non-canonical forks in the hot database indefinitely. This wastes disk space, and represents a potential resource exhaustion attack vector.\r\n\r\n## Expected Behaviour\r\n\r\nWhen the chain finalizes (or on some subset of finalization events), we should prune all blocks and states that don't descend from the finalized state. This could probably be done efficiently using the head tracker, and maybe some help from fork choice (for determining if a head is descended from the finalized state).",
  "closed_by": {
    "login": "michaelsproul",
    "id": 4452260,
    "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/michaelsproul",
    "html_url": "https://github.com/michaelsproul",
    "followers_url": "https://api.github.com/users/michaelsproul/followers",
    "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
    "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
    "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
    "repos_url": "https://api.github.com/users/michaelsproul/repos",
    "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
    "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/891/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/891/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/595779905",
    "html_url": "https://github.com/sigp/lighthouse/issues/891#issuecomment-595779905",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/891",
    "id": 595779905,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU5NTc3OTkwNQ==",
    "user": {
      "login": "adaszko",
      "id": 165678,
      "node_id": "MDQ6VXNlcjE2NTY3OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/165678?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/adaszko",
      "html_url": "https://github.com/adaszko",
      "followers_url": "https://api.github.com/users/adaszko/followers",
      "following_url": "https://api.github.com/users/adaszko/following{/other_user}",
      "gists_url": "https://api.github.com/users/adaszko/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/adaszko/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/adaszko/subscriptions",
      "organizations_url": "https://api.github.com/users/adaszko/orgs",
      "repos_url": "https://api.github.com/users/adaszko/repos",
      "events_url": "https://api.github.com/users/adaszko/events{/privacy}",
      "received_events_url": "https://api.github.com/users/adaszko/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-03-06T14:00:11Z",
    "updated_at": "2020-03-06T14:00:11Z",
    "author_association": "CONTRIBUTOR",
    "body": "I'm claiming this issue :)",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/595779905/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 1,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/596263462",
    "html_url": "https://github.com/sigp/lighthouse/issues/891#issuecomment-596263462",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/891",
    "id": 596263462,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU5NjI2MzQ2Mg==",
    "user": {
      "login": "paulhauner",
      "id": 6660660,
      "node_id": "MDQ6VXNlcjY2NjA2NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/paulhauner",
      "html_url": "https://github.com/paulhauner",
      "followers_url": "https://api.github.com/users/paulhauner/followers",
      "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
      "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
      "organizations_url": "https://api.github.com/users/paulhauner/orgs",
      "repos_url": "https://api.github.com/users/paulhauner/repos",
      "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/paulhauner/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-03-08T23:03:00Z",
    "updated_at": "2020-03-08T23:03:00Z",
    "author_association": "MEMBER",
    "body": "Awesome!\r\n\r\nSince we don't keep forward-pointers from parent block to child block, we're most likely going to need to start and the head block and iterate backwards through it's ancestors. There are three ways we can iterate backwards:\r\n\r\n- From the head (start) block use `block.state_root` to read the corresponding `BeaconState` from the database and use the `state.block_roots` field to iterate backwards (using `state.state_roots` to load the next state once you run out of block roots). The [`ReverseBlockRootIterator`](https://github.com/sigp/lighthouse/blob/371e5adcf89d99a5958b802cf9925a990bd66ba6/beacon_node/store/src/iter.rs#L264-L265) achieves this.\r\n  - Pro: You get 8,192 block roots from a state (in mainnet spec) so this single state will likely serve most normal circumstances.\r\n  - Pro: simple, straight-forward.\r\n  - Con: involves reading a beacon state from db. This is Bad™ since it involves reading from disk and doing lots de-serialization.\r\n  - Con: pruning several heads will result in several big DB reads.\r\n- From the head (start) block use `block.parent_root` to load the previous block root. Repeat.\r\n   - Pro: simple straight-forward.\r\n   - Pro: never loads a `BeaconState`\r\n   - Con: results in one disk read per pruned block.\r\n   - Con: unnecessary de-serialization of block fields other than `parent_root` (could be avoided with a custom `Store` method).\r\n- Our `ForkChoice` struct [stores](https://github.com/sigp/lighthouse/blob/371e5adcf89d99a5958b802cf9925a990bd66ba6/eth2/proto_array_fork_choice/src/proto_array.rs#L13) the parent for each block and could expose a function (akin to [`ProtoArrayForkChoice::block_slot`](https://github.com/sigp/lighthouse/blob/371e5adcf89d99a5958b802cf9925a990bd66ba6/eth2/proto_array_fork_choice/src/proto_array_fork_choice.rs#L180-L187)) that provides `fn parent_root(&self, block_root: &Hash256) -> Option<Hash256>`.\r\n  - Pro: finding the parent for some block root only involves reading a `HashMap` then doing a `Vec` access.\r\n  - Con: will involve taking a read-lock on the fork choice which might delay other functions (if you're careful about this the impact can be minimal).\r\n  - Con: more complicated since the `proto_array_fork_choice` is only guaranteed to hold non-finalized blocks. If you need to prune blocks that have been finalized you'll probably have to default back to recursive database lookups (like the previous option).\r\n\r\nAfter writing this, I'm thinking that the second option (using `block.parent_root`) is how I would move forward. I avoid loading `BeaconState` from disk since it doesn't scale well with large validator counts and I'm concerned that using `proto_array_fork_choice` is a little too complex.\r\n\r\nPerhaps you have some thoughts @michaelsproul? :)",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/596263462/reactions",
      "total_count": 2,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 1,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/596265706",
    "html_url": "https://github.com/sigp/lighthouse/issues/891#issuecomment-596265706",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/891",
    "id": 596265706,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU5NjI2NTcwNg==",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-03-08T23:27:10Z",
    "updated_at": "2020-03-08T23:27:10Z",
    "author_association": "MEMBER",
    "body": "I agree that using the parent root seems like the best option at the moment, in terms of simplicity and performance. I suspect that the burden on disk reads won't be too severe, as blocks are reasonably sized and we won't be pruning super often. The [`ParentBlockRootIterator`](https://github.com/sigp/lighthouse/blob/8c5bcfe53a34bc624f79e11b5038c691d18a9477/beacon_node/store/src/iter.rs#L107-L139) iterates using the `parent_root` strategy, and might be useful.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/596265706/reactions",
      "total_count": 2,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 2,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/636840954",
    "html_url": "https://github.com/sigp/lighthouse/issues/891#issuecomment-636840954",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/891",
    "id": 636840954,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYzNjg0MDk1NA==",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-06-01T12:46:22Z",
    "updated_at": "2020-06-01T12:46:22Z",
    "author_association": "MEMBER",
    "body": "Ooo, @adaszko fixed this! Closing! 🎉 ",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/636840954/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
