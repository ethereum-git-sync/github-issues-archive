{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/3804",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/3804/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/3804/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/3804/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/3804",
  "id": 1497620700,
  "node_id": "I_kwDOCFeAzc5ZQ-Dc",
  "number": 3804,
  "title": "Cache Validator Info For Last 10 Epochs",
  "user": {
    "login": "AgeManning",
    "id": 7454587,
    "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/AgeManning",
    "html_url": "https://github.com/AgeManning",
    "followers_url": "https://api.github.com/users/AgeManning/followers",
    "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
    "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
    "organizations_url": "https://api.github.com/users/AgeManning/orgs",
    "repos_url": "https://api.github.com/users/AgeManning/repos",
    "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
    "received_events_url": "https://api.github.com/users/AgeManning/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 4799962538,
      "node_id": "LA_kwDOCFeAzc8AAAABHhmdqg",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/gui",
      "name": "gui",
      "color": "46A79B",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "michaelsproul",
    "id": 4452260,
    "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/michaelsproul",
    "html_url": "https://github.com/michaelsproul",
    "followers_url": "https://api.github.com/users/michaelsproul/followers",
    "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
    "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
    "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
    "repos_url": "https://api.github.com/users/michaelsproul/repos",
    "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
    "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    {
      "login": "rickimoore",
      "id": 12932889,
      "node_id": "MDQ6VXNlcjEyOTMyODg5",
      "avatar_url": "https://avatars.githubusercontent.com/u/12932889?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rickimoore",
      "html_url": "https://github.com/rickimoore",
      "followers_url": "https://api.github.com/users/rickimoore/followers",
      "following_url": "https://api.github.com/users/rickimoore/following{/other_user}",
      "gists_url": "https://api.github.com/users/rickimoore/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rickimoore/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rickimoore/subscriptions",
      "organizations_url": "https://api.github.com/users/rickimoore/orgs",
      "repos_url": "https://api.github.com/users/rickimoore/repos",
      "events_url": "https://api.github.com/users/rickimoore/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rickimoore/received_events",
      "type": "User",
      "site_admin": false
    },
    {
      "login": "macladson",
      "id": 58379419,
      "node_id": "MDQ6VXNlcjU4Mzc5NDE5",
      "avatar_url": "https://avatars.githubusercontent.com/u/58379419?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/macladson",
      "html_url": "https://github.com/macladson",
      "followers_url": "https://api.github.com/users/macladson/followers",
      "following_url": "https://api.github.com/users/macladson/following{/other_user}",
      "gists_url": "https://api.github.com/users/macladson/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/macladson/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/macladson/subscriptions",
      "organizations_url": "https://api.github.com/users/macladson/orgs",
      "repos_url": "https://api.github.com/users/macladson/repos",
      "events_url": "https://api.github.com/users/macladson/events{/privacy}",
      "received_events_url": "https://api.github.com/users/macladson/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2022-12-15T00:49:56Z",
  "updated_at": "2023-05-03T01:29:17Z",
  "closed_at": "2023-05-03T01:29:17Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nThe UI builds a graph which requires the balances of the validators over the last 10 epochs. Currently it is requesting this via the \r\n/eth/v1/beacon/states/{states}/validators?id={vals} API end-point. \r\n\r\nThe issue is that the request takes a very long time in order to complete, likely because its trying to fetch and old state. We also need the validators balance from a year ago and also a month ago. \r\n\r\nIn order to make this user friendly and not have to wait > 1m to collect these endpoints, I was thinking when the `--gui` CLI flag is set, we could cache these values. \r\n\r\nI.e Store a cache that holds the last 10 epochs for validators we are monitoring and then make this endpoint return super fast.\r\n\r\nAs for the state a year ago, perhaps this is a problem for another time, unless anyone has some suggestions (maybe @michaelsproul)\r\n",
  "closed_by": {
    "login": "AgeManning",
    "id": 7454587,
    "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/AgeManning",
    "html_url": "https://github.com/AgeManning",
    "followers_url": "https://api.github.com/users/AgeManning/followers",
    "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
    "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
    "organizations_url": "https://api.github.com/users/AgeManning/orgs",
    "repos_url": "https://api.github.com/users/AgeManning/repos",
    "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
    "received_events_url": "https://api.github.com/users/AgeManning/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/3804/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/3804/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1352435154",
    "html_url": "https://github.com/sigp/lighthouse/issues/3804#issuecomment-1352435154",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3804",
    "id": 1352435154,
    "node_id": "IC_kwDOCFeAzc5QnIXS",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-15T01:19:57Z",
    "updated_at": "2022-12-15T01:19:57Z",
    "author_association": "MEMBER",
    "body": "Caching could be a good short-term solution, but nodes that have checkpoint synced only have access to states from when they started, and can't access states from a month/year ago even if they're willing to pay slow processing times (they have to opt in to reconstructing historic states, which takes about a week).\r\n\r\nThis seems to be a pretty fundamental tension in the GUI: we want users to be able to access historic data quickly on their own node, but we also don't want them to have to pay the expensive storage cost to make this feasible. Tree states helps a bit because it makes running an archival node cheaper in terms of disk space, but there'll still be users who don't want to opt in to _any_ extra storage for historic states. If we implement https://github.com/sigp/lighthouse/issues/3211 users can even run in perpetuity with no historic states at all.\r\n\r\nGiven this, my preference is:\r\n\r\n- Periodically cache 10 epoch, 1mo, 1y balances on a best-effort basis. If any required state doesn't exist, cache its non-existence and serve an error on the balance endpoint.\r\n- When balance data isn't available, have the UI fail gracefully and suggest enabling `--reconstruct-historic-states`.\r\n- Optionally allow users to pull this data from somewhere else, e.g. `beacon.watch`, `beaconcha.in`, or another BN with history.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1352435154/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1352481259",
    "html_url": "https://github.com/sigp/lighthouse/issues/3804#issuecomment-1352481259",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3804",
    "id": 1352481259,
    "node_id": "IC_kwDOCFeAzc5QnTnr",
    "user": {
      "login": "AgeManning",
      "id": 7454587,
      "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AgeManning",
      "html_url": "https://github.com/AgeManning",
      "followers_url": "https://api.github.com/users/AgeManning/followers",
      "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
      "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
      "organizations_url": "https://api.github.com/users/AgeManning/orgs",
      "repos_url": "https://api.github.com/users/AgeManning/repos",
      "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AgeManning/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-15T02:39:02Z",
    "updated_at": "2022-12-15T02:39:02Z",
    "author_association": "MEMBER",
    "body": "Yeah, agreed. I was thinking we don't worry about the long-term cases. Potentially these can be pulled from somewhere else. \r\n\r\nBut the short-term 10 epochs I think should be do-able in a cache. I'd imagine most BN's will be running for longer than 10 epochs. ",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1352481259/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1375275135",
    "html_url": "https://github.com/sigp/lighthouse/issues/3804#issuecomment-1375275135",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3804",
    "id": 1375275135,
    "node_id": "IC_kwDOCFeAzc5R-Qh_",
    "user": {
      "login": "macladson",
      "id": 58379419,
      "node_id": "MDQ6VXNlcjU4Mzc5NDE5",
      "avatar_url": "https://avatars.githubusercontent.com/u/58379419?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/macladson",
      "html_url": "https://github.com/macladson",
      "followers_url": "https://api.github.com/users/macladson/followers",
      "following_url": "https://api.github.com/users/macladson/following{/other_user}",
      "gists_url": "https://api.github.com/users/macladson/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/macladson/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/macladson/subscriptions",
      "organizations_url": "https://api.github.com/users/macladson/orgs",
      "repos_url": "https://api.github.com/users/macladson/repos",
      "events_url": "https://api.github.com/users/macladson/events{/privacy}",
      "received_events_url": "https://api.github.com/users/macladson/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-01-09T08:45:05Z",
    "updated_at": "2023-01-10T01:50:01Z",
    "author_association": "COLLABORATOR",
    "body": "I had a bit of a different take in #3863. I instead expanded the scope of the validator monitor to cache additional values. It will need to populate the values after the node boots for the first time but does not require any state reads.\r\n\r\nUnfortunately this does not solve historical values (1 month / 1 year) so is not a complete solution.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1375275135/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 1,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
