{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/4717",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/4717/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/4717/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/4717/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/4717",
  "id": 1888507783,
  "node_id": "I_kwDOCFeAzc5wkFeH",
  "number": 4717,
  "title": "Historic sync duties queries fail for recently-activated validators",
  "user": {
    "login": "michaelsproul",
    "id": 4452260,
    "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/michaelsproul",
    "html_url": "https://github.com/michaelsproul",
    "followers_url": "https://api.github.com/users/michaelsproul/followers",
    "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
    "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
    "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
    "repos_url": "https://api.github.com/users/michaelsproul/repos",
    "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
    "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 985647281,
      "node_id": "MDU6TGFiZWw5ODU2NDcyODE=",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/bug",
      "name": "bug",
      "color": "d73a4a",
      "default": true,
      "description": "Something isn't working"
    },
    {
      "id": 2336800343,
      "node_id": "MDU6TGFiZWwyMzM2ODAwMzQz",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/HTTP-API",
      "name": "HTTP-API",
      "color": "5A63A2",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2023-09-09T00:26:25Z",
  "updated_at": "2024-01-26T13:08:35Z",
  "closed_at": null,
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nThere's a bug in the calculation of historic sync committee duties, where by this error will be returned:\r\n\r\n```\r\ncurl -X POST -H \"Content-Type: application/json\" --data '[\"155654\"]' \"http://localhost:5052/eth/v1/validator/duties/sync/688802\"\r\n```\r\n\r\n```json\r\n{\"code\":500,\"message\":\"UNHANDLED_ERROR: SyncDutiesError(UnknownValidator(155654))\",\"stacktraces\":[]}\r\n```\r\n\r\n(This example is from Gnosis chain, reported by one of our users)\r\n\r\nIt occurs because there's an optimisation in the endpoint that tries to avoid expensive state loads:\r\n\r\nhttps://github.com/sigp/lighthouse/blob/2841f60686d642fcc0785c884d43e34e47a800dc/beacon_node/http_api/src/sync_committees.rs#L99-L109\r\n\r\nAlthough the validator 155654 exists on-chain at epoch 688802, the state loaded is from epoch `(688802 // 512 - 1) * 512 = 688128` where it does not exist. Using the state from the start of the current period also isn't sufficient because that would yield the state at epoch 688640, where the validator also doesn't exist.\r\n\r\nIn some sense this optimisation is still sound, because the validator _cannot_ actually be part of sync committee at this point, because sync committees are determined 512 epochs in advance. One way to fix it would be to just avoid erroring out here:\r\n\r\nhttps://github.com/sigp/lighthouse/blob/2841f60686d642fcc0785c884d43e34e47a800dc/consensus/types/src/beacon_state.rs#L935\r\n\r\nI need to think more about the best way to fix it.\r\n\r\n## Version\r\n\r\nLighthouse v4.4.1\r\n\r\n## Additional Info\r\n\r\nThere may also be another bug lurking in the duties-from-head codepath, as the user reports the error occurring \"live\" while trying to request duties for the current epoch. I haven't spotted the bug there (yet), but will link it here if I find one.\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/4717/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/4717/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1902064215",
    "html_url": "https://github.com/sigp/lighthouse/issues/4717#issuecomment-1902064215",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4717",
    "id": 1902064215,
    "node_id": "IC_kwDOCFeAzc5xXzJX",
    "user": {
      "login": "dknopik",
      "id": 107140945,
      "node_id": "U_kgDOBmLXUQ",
      "avatar_url": "https://avatars.githubusercontent.com/u/107140945?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dknopik",
      "html_url": "https://github.com/dknopik",
      "followers_url": "https://api.github.com/users/dknopik/followers",
      "following_url": "https://api.github.com/users/dknopik/following{/other_user}",
      "gists_url": "https://api.github.com/users/dknopik/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dknopik/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dknopik/subscriptions",
      "organizations_url": "https://api.github.com/users/dknopik/orgs",
      "repos_url": "https://api.github.com/users/dknopik/repos",
      "events_url": "https://api.github.com/users/dknopik/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dknopik/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2024-01-20T10:53:52Z",
    "updated_at": "2024-01-20T10:53:52Z",
    "author_association": "CONTRIBUTOR",
    "body": "I'll take a look at this",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1902064215/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 1,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1912043798",
    "html_url": "https://github.com/sigp/lighthouse/issues/4717#issuecomment-1912043798",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4717",
    "id": 1912043798,
    "node_id": "IC_kwDOCFeAzc5x93kW",
    "user": {
      "login": "dknopik",
      "id": 107140945,
      "node_id": "U_kgDOBmLXUQ",
      "avatar_url": "https://avatars.githubusercontent.com/u/107140945?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dknopik",
      "html_url": "https://github.com/dknopik",
      "followers_url": "https://api.github.com/users/dknopik/followers",
      "following_url": "https://api.github.com/users/dknopik/following{/other_user}",
      "gists_url": "https://api.github.com/users/dknopik/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dknopik/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dknopik/subscriptions",
      "organizations_url": "https://api.github.com/users/dknopik/orgs",
      "repos_url": "https://api.github.com/users/dknopik/repos",
      "events_url": "https://api.github.com/users/dknopik/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dknopik/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2024-01-26T13:08:33Z",
    "updated_at": "2024-01-26T13:08:33Z",
    "author_association": "CONTRIBUTOR",
    "body": "I investigated this a bit.\r\n\r\n1. I believe the optimisation to load the state at the beginning of the previous sync committee period is not really the problem, as the validator might have also been missing from the state at `(688802 // 512) * 512 = 688640` (without the `- 1`). The optimisation therefore only widens the window where this error might occur, if I'm correct.\r\n2. Your suggested fix would cause validator indices that really are invalid (with respect to the requested epoch) to silently be handled as if they have no duty, which violates the spec (http 400). Currently, the spec is also violated, as a http 500 is returned. So to properly fix this, I would load the state at the requested epoch, check if the requested validator is present, and subsequently ignore `UnknownValidator` in `sync_committee_duties`'s match expressions.  However, this would add another state load, so I can also understand arguments in favour of avoiding the performance hit.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1912043798/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
