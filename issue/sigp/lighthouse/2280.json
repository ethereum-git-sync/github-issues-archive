{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/2280",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/2280/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/2280/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/2280/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/2280",
  "id": 838892306,
  "node_id": "MDU6SXNzdWU4Mzg4OTIzMDY=",
  "number": 2280,
  "title": "Bug: Validator client is ahead of current epoch",
  "user": {
    "login": "djoyahoy",
    "id": 11904287,
    "node_id": "MDQ6VXNlcjExOTA0Mjg3",
    "avatar_url": "https://avatars.githubusercontent.com/u/11904287?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/djoyahoy",
    "html_url": "https://github.com/djoyahoy",
    "followers_url": "https://api.github.com/users/djoyahoy/followers",
    "following_url": "https://api.github.com/users/djoyahoy/following{/other_user}",
    "gists_url": "https://api.github.com/users/djoyahoy/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/djoyahoy/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/djoyahoy/subscriptions",
    "organizations_url": "https://api.github.com/users/djoyahoy/orgs",
    "repos_url": "https://api.github.com/users/djoyahoy/repos",
    "events_url": "https://api.github.com/users/djoyahoy/events{/privacy}",
    "received_events_url": "https://api.github.com/users/djoyahoy/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 985647281,
      "node_id": "MDU6TGFiZWw5ODU2NDcyODE=",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/bug",
      "name": "bug",
      "color": "d73a4a",
      "default": true,
      "description": "Something isn't working"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "paulhauner",
    "id": 6660660,
    "node_id": "MDQ6VXNlcjY2NjA2NjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/paulhauner",
    "html_url": "https://github.com/paulhauner",
    "followers_url": "https://api.github.com/users/paulhauner/followers",
    "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
    "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
    "organizations_url": "https://api.github.com/users/paulhauner/orgs",
    "repos_url": "https://api.github.com/users/paulhauner/repos",
    "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
    "received_events_url": "https://api.github.com/users/paulhauner/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "paulhauner",
      "id": 6660660,
      "node_id": "MDQ6VXNlcjY2NjA2NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/paulhauner",
      "html_url": "https://github.com/paulhauner",
      "followers_url": "https://api.github.com/users/paulhauner/followers",
      "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
      "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
      "organizations_url": "https://api.github.com/users/paulhauner/orgs",
      "repos_url": "https://api.github.com/users/paulhauner/repos",
      "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/paulhauner/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2021-03-23T16:15:21Z",
  "updated_at": "2021-03-30T04:23:48Z",
  "closed_at": "2021-03-30T04:23:48Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nI have one beacon node and one validator running on separate pods in the same kubernetes namespace. They are running against the pyrmont test network. The validator is still submitting attestations correctly. However, the validator is intermittently reporting:\r\n\r\n```\r\nMar 23 16:09:43.005 ERRO Failed to download proposer duties      err: All endpoints failed https://<URL> => RequestFailed(ServerMessage(ErrorMessage { code: 400, message: \"BAD_REQUEST: request epoch 28164 is ahead of the current epoch 28163\", stacktraces: [] })), service: duties\r\nMar 23 16:09:43.005 ERRO Failed to download attester duties      err: FailedToDownloadAttesters(\"All endpoints failed https://<URL> => RequestFailed(ServerMessage(ErrorMessage { code: 400, message: \\\"BAD_REQUEST: request epoch 28165 is more than one epoch past the current epoch 28163\\\", stacktraces: [] }))\"), request_epoch: 28165, current_epoch: 28164, service: duties\r\n```\r\n\r\nThe client and the beacon containers report the same time and are running on the same node so I don't suspect there is any time drift.\r\n\r\n## Version\r\n\r\nLighthouse v1.2.1-b34a79d\r\nrustc 1.50.0\r\n\r\n## Present Behaviour\r\n\r\nSee description.\r\n\r\n## Expected Behaviour\r\n\r\nThis error should not be reported.\r\n\r\n## Steps to resolve\r\n\r\nN/A\r\n",
  "closed_by": {
    "login": "paulhauner",
    "id": 6660660,
    "node_id": "MDQ6VXNlcjY2NjA2NjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/paulhauner",
    "html_url": "https://github.com/paulhauner",
    "followers_url": "https://api.github.com/users/paulhauner/followers",
    "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
    "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
    "organizations_url": "https://api.github.com/users/paulhauner/orgs",
    "repos_url": "https://api.github.com/users/paulhauner/repos",
    "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
    "received_events_url": "https://api.github.com/users/paulhauner/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/2280/reactions",
    "total_count": 2,
    "+1": 2,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/2280/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/805339855",
    "html_url": "https://github.com/sigp/lighthouse/issues/2280#issuecomment-805339855",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/2280",
    "id": 805339855,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwNTMzOTg1NQ==",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-23T23:09:12Z",
    "updated_at": "2021-03-23T23:09:42Z",
    "author_association": "MEMBER",
    "body": "I think this must be a consequence of #2243 where we removed a 100ms delay from the duties service. For now downgrading to v1.2.0 should be safe.\r\n\r\nTo resolve the issue I think we have a few options:\r\n\r\n- Add the delay back in. I'm not fond of this option because it punishes nodes without clock sync issues by forcing them to always wait the delay. We could make the delay 0 by default and configurable, but that just feels like pushing the burden onto the end user.\r\n- Modify the proposer and attester duties API endpoints on the beacon node so that they're capable of responding to queries for the current_epoch +1/+2. If the BN thinks it's in the last slot of the epoch, and it already has a (canonical) block for that slot, then it knows what the duties are for the next epoch, and will already have computed them via the state advance timer. If we extend the state advance timer to handle skip slots, then it will always know the duties for the next epoch near the end of the current epoch. This would open up the option of polling _before_ the start of the relevant slot.\r\n- In addition to modifying the BN duties endpoints, we could get the VC to subscribe to the head events as [suggested by the API docs](https://ethereum.github.io/eth2.0-APIs/#/Validator/getProposerDuties), and use that to determine when the duties could have changed. It's push-based! No more polling!\r\n\r\nCC @paulhauner, would like your input on the above",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/805339855/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/805358897",
    "html_url": "https://github.com/sigp/lighthouse/issues/2280#issuecomment-805358897",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/2280",
    "id": 805358897,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwNTM1ODg5Nw==",
    "user": {
      "login": "paulhauner",
      "id": 6660660,
      "node_id": "MDQ6VXNlcjY2NjA2NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/paulhauner",
      "html_url": "https://github.com/paulhauner",
      "followers_url": "https://api.github.com/users/paulhauner/followers",
      "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
      "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
      "organizations_url": "https://api.github.com/users/paulhauner/orgs",
      "repos_url": "https://api.github.com/users/paulhauner/repos",
      "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/paulhauner/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-23T23:57:38Z",
    "updated_at": "2021-03-23T23:57:38Z",
    "author_association": "MEMBER",
    "body": "Hmm, interesting. AFAICT there's necessarily *some* clock drift happening here, but it could be very slight. I think we could do better to tolerate this drift, though.\r\n\r\n> Add the delay back in. I'm not fond of this option...\r\n\r\nI agree.\r\n\r\n> Modify the proposer and attester duties API endpoints on the beacon node so that they're capable of responding to queries for the current_epoch +1/+2.\r\n\r\nI also prefer this style of approach. My initial thoughts are to add a [`MAXIMUM_GOSSIP_CLOCK_DISPARITY`](https://github.com/sigp/lighthouse/blob/b34a79dc0b02e04441ba01fd0f304d1e203d877d/beacon_node/beacon_chain/src/beacon_chain.rs#L99-L102) tolerance to these endpoints. In effect, the BN would permit users to poll for duties up to 500ms before they become relevant. Some advantages of this approach:\r\n\r\n- We already permit this tolerance on the gossip network. This means that we're not really changing anything when it comes to proposer or current-epoch attester duties; P2P users could already force us to learn these duties early. P2P couldn't trigger next-epoch attester duties, but I don't think it's a significant change.\r\n- There are already some assumptions about the VC being within the clock disparity of the BN. We verify things from the API practically the same as things from the gossip network; we'll still publish blocks/attestations if they're early but within that tolerance.\r\n\r\n> In addition to modifying the BN duties endpoints, we could get the VC to subscribe to the head events\r\n\r\nThis would be nice, but I'm not sure any of the present events would solve this issue. There's no event to say \"a new epoch has started and therefore caused a change in the proposer/attester duties\". ",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/805358897/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/809896839",
    "html_url": "https://github.com/sigp/lighthouse/issues/2280#issuecomment-809896839",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/2280",
    "id": 809896839,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwOTg5NjgzOQ==",
    "user": {
      "login": "paulhauner",
      "id": 6660660,
      "node_id": "MDQ6VXNlcjY2NjA2NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/paulhauner",
      "html_url": "https://github.com/paulhauner",
      "followers_url": "https://api.github.com/users/paulhauner/followers",
      "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
      "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
      "organizations_url": "https://api.github.com/users/paulhauner/orgs",
      "repos_url": "https://api.github.com/users/paulhauner/repos",
      "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/paulhauner/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-30T04:23:48Z",
    "updated_at": "2021-03-30T04:23:48Z",
    "author_association": "MEMBER",
    "body": "Resolved in #2283",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/809896839/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
