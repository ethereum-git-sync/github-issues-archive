{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/1089",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/1089/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/1089/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/1089/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/1089",
  "id": 609744280,
  "node_id": "MDU6SXNzdWU2MDk3NDQyODA=",
  "number": 1089,
  "title": "Isolate consensus from the rest of the codebase",
  "user": {
    "login": "JustinDrake",
    "id": 731743,
    "node_id": "MDQ6VXNlcjczMTc0Mw==",
    "avatar_url": "https://avatars.githubusercontent.com/u/731743?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/JustinDrake",
    "html_url": "https://github.com/JustinDrake",
    "followers_url": "https://api.github.com/users/JustinDrake/followers",
    "following_url": "https://api.github.com/users/JustinDrake/following{/other_user}",
    "gists_url": "https://api.github.com/users/JustinDrake/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/JustinDrake/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/JustinDrake/subscriptions",
    "organizations_url": "https://api.github.com/users/JustinDrake/orgs",
    "repos_url": "https://api.github.com/users/JustinDrake/repos",
    "events_url": "https://api.github.com/users/JustinDrake/events{/privacy}",
    "received_events_url": "https://api.github.com/users/JustinDrake/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1232620456,
      "node_id": "MDU6TGFiZWwxMjMyNjIwNDU2",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/RFC",
      "name": "RFC",
      "color": "4aaa19",
      "default": false,
      "description": "Request for comment"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2020-04-30T09:14:00Z",
  "updated_at": "2020-05-03T21:55:07Z",
  "closed_at": "2020-05-03T21:55:06Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "In Bitcoin-land they have isolated the consensus part in a library called [Libbitcoin Consensus](https://github.com/libbitcoin/libbitcoin-consensus). Isolating the consensus logic into a separate library (I guess in Rust that means a separate crate?) comes with  bunch of security advantages:\r\n\r\n* easier to reason about and audit\r\n* minimises complexities arising from unforeseen interactions with the environment (database, networking, etc.)\r\n* allows for security-conscious processes to be enforced (e.g. require at least 3 reviewers to merge a PR, whereas the non-consensus critical part of the codebase can have just 1 reviewer in addition to the author)\r\n* allows for reusability without too much baggage (e.g. for fuzzing efforts that only want to fuzz consensus)\r\n\r\nIn my mind Ligthouse's mission is to build the most secure Eth2 client and as such isolating consensus from the rest of the codebase feels natural. The earlier such a refactor is done the less painful it will be. (Bitcoin did this relatively late in the game and it was painfulâ€”it took years if I recall correctly.)",
  "closed_by": {
    "login": "paulhauner",
    "id": 6660660,
    "node_id": "MDQ6VXNlcjY2NjA2NjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/paulhauner",
    "html_url": "https://github.com/paulhauner",
    "followers_url": "https://api.github.com/users/paulhauner/followers",
    "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
    "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
    "organizations_url": "https://api.github.com/users/paulhauner/orgs",
    "repos_url": "https://api.github.com/users/paulhauner/repos",
    "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
    "received_events_url": "https://api.github.com/users/paulhauner/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/1089/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/1089/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/622252378",
    "html_url": "https://github.com/sigp/lighthouse/issues/1089#issuecomment-622252378",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1089",
    "id": 622252378,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyMjI1MjM3OA==",
    "user": {
      "login": "paulhauner",
      "id": 6660660,
      "node_id": "MDQ6VXNlcjY2NjA2NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/paulhauner",
      "html_url": "https://github.com/paulhauner",
      "followers_url": "https://api.github.com/users/paulhauner/followers",
      "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
      "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
      "organizations_url": "https://api.github.com/users/paulhauner/orgs",
      "repos_url": "https://api.github.com/users/paulhauner/repos",
      "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/paulhauner/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-01T05:15:35Z",
    "updated_at": "2020-05-01T05:15:35Z",
    "author_association": "MEMBER",
    "body": "I also agree that isolating consensus code is desired. We already do separate it into crates, where `/eth2/state_processing` and `eth2/proto_array_fork_choice` are the top-level consensus crates. Below them we only have:\r\n\r\n- `eth2/utils/bls`\r\n- `eth2/utils/ssz_types`\r\n- `eth2/utils/merkle_proof`\r\n- `eth2/utils/safe_arith`\r\n- `eth2/types`\r\n- `eth2/utils/eth2_hashing`\r\n- `eth2_utils/int_to_bytes`\r\n\r\nEach of these crates are a series of pure functions completed abstracted from databases, networking etc. They're tested and fuzzed independently and can be audited stand-alone.\r\n\r\n@JustinDrake in another chat you suggested moving it into another repo, I'm not particularly enthused about this. At one stage we did split apart our repos and we found that having a single \"monorepo\" was much easier to manage for:\r\n\r\n- Project management: a single place to raise issues, manage milestones, etc.\r\n- Everyday development: debugging or developing across two separate repos means you need to make modifications to the `Cargo.toml` into order to pull your deps locally instead of via Github. This gets annoying for core devs (e.g., I just spent an hour debugging only to realise I was using the wrong dep) and it's also another barrier-to-entry for contributors that needs to be documented.\r\n\r\nPerhaps there's a middle ground, though. As expressed in #467, I'm not particularly fond of our current, emergent directory structure (e.g., why is something in `eth2` but not `eth2/utils`?). So, here's an updated proposal that includes separation of consensus code: https://github.com/sigp/lighthouse/issues/467#issuecomment-622248701.\r\n\r\nI believe this proposed directory structure would address @JustinDrake's points first, second and fourth points quite simply. The second point is more of a challenge though:\r\n\r\n> allows for security-conscious processes to be enforced (e.g. require at least 3 reviewers to merge a PR, whereas the non-consensus critical part of the codebase can have just 1 reviewer in addition to the author)\r\n\r\nAs far as I can tell, with vanilla Github we can't say \"this dir requires one review and this dir requires three\", however I'm pretty sure we can use the [Mergable](https://probot.github.io/apps/mergeable/) bot with the [Change Set](https://github.com/mergeability/mergeable#change-set) config. We would have to throughly review the permissions of the bot before letting it anywhere near the repo, of course.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/622252378/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/622304437",
    "html_url": "https://github.com/sigp/lighthouse/issues/1089#issuecomment-622304437",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1089",
    "id": 622304437,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyMjMwNDQzNw==",
    "user": {
      "login": "JustinDrake",
      "id": 731743,
      "node_id": "MDQ6VXNlcjczMTc0Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/731743?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/JustinDrake",
      "html_url": "https://github.com/JustinDrake",
      "followers_url": "https://api.github.com/users/JustinDrake/followers",
      "following_url": "https://api.github.com/users/JustinDrake/following{/other_user}",
      "gists_url": "https://api.github.com/users/JustinDrake/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/JustinDrake/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/JustinDrake/subscriptions",
      "organizations_url": "https://api.github.com/users/JustinDrake/orgs",
      "repos_url": "https://api.github.com/users/JustinDrake/repos",
      "events_url": "https://api.github.com/users/JustinDrake/events{/privacy}",
      "received_events_url": "https://api.github.com/users/JustinDrake/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-01T08:45:27Z",
    "updated_at": "2020-05-01T08:45:27Z",
    "author_association": "CONTRIBUTOR",
    "body": "> Below them we only have:\r\n\r\nEnumerating all the consensus dependencies like that is helpful for me in the short term to familiarise myself with the codebase :)\r\n\r\n> Each of these crates are a series of pure functions completed abstracted from databases, networking etc. They're tested and fuzzed independently and can be audited stand-alone.\r\n\r\nðŸ‘ðŸ‘ðŸ‘\r\n\r\n> here's an updated proposal that includes separation of consensus code\r\n\r\nDirectory separation of consensus code is definitely helpful ðŸ‘\r\n\r\n> I'm pretty sure we can use the Mergable bot with the Change Set config\r\n\r\nMakes sense :)",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/622304437/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/623188525",
    "html_url": "https://github.com/sigp/lighthouse/issues/1089#issuecomment-623188525",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1089",
    "id": 623188525,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyMzE4ODUyNQ==",
    "user": {
      "login": "paulhauner",
      "id": 6660660,
      "node_id": "MDQ6VXNlcjY2NjA2NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/paulhauner",
      "html_url": "https://github.com/paulhauner",
      "followers_url": "https://api.github.com/users/paulhauner/followers",
      "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
      "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
      "organizations_url": "https://api.github.com/users/paulhauner/orgs",
      "repos_url": "https://api.github.com/users/paulhauner/repos",
      "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/paulhauner/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-03T21:55:06Z",
    "updated_at": "2020-05-03T21:55:06Z",
    "author_association": "MEMBER",
    "body": "I might close this one for now and it can live on via #467 :)",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/623188525/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
