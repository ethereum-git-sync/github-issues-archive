{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/847",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/847/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/847/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/847/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/847",
  "id": 563662154,
  "node_id": "MDU6SXNzdWU1NjM2NjIxNTQ=",
  "number": 847,
  "title": "100k validators on t2.mediums",
  "user": {
    "login": "paulhauner",
    "id": 6660660,
    "node_id": "MDQ6VXNlcjY2NjA2NjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/paulhauner",
    "html_url": "https://github.com/paulhauner",
    "followers_url": "https://api.github.com/users/paulhauner/followers",
    "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
    "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
    "organizations_url": "https://api.github.com/users/paulhauner/orgs",
    "repos_url": "https://api.github.com/users/paulhauner/repos",
    "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
    "received_events_url": "https://api.github.com/users/paulhauner/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2020-02-12T01:02:44Z",
  "updated_at": "2020-08-25T22:00:54Z",
  "closed_at": "2020-08-25T22:00:54Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nOur latest testnet is running 8x validator nodes on AWS t2.medium nodes (2-vCPU, 4GB RAM), each with 12.5k validators. These nodes ran fine for the first 24hrs but then started to crumble when the network experienced instability. What I observe is that the nodes get full CPU utilization and are unable to clear their work queue (incoming attestations, blocks, API calls, etc) and get stuck in a bit of a spiral of falling behind and producing fork blocks. There are also occasions where nodes run out of RAM and the OS kills the processes.\r\n\r\nI think there are a several issues leading to these problems. I've made a list of the tasks I think we need to focus on to ensure we can have stability when running 100k validators on t2.mediums:\r\n\r\n\r\n- [ ] **Optimize the `BeaconChain::persist` function (#851):** this is taking several seconds (even minutes) on the AWS nodes. Storing everything, all at once, every block is how we do it now and unsurprisingly we need to find a more nuanced way to do this.\r\n- [ ] **Revisit the way we cache `BeaconState` (related: #850):** the caches we're using in `Store` are very liberal about what gets added into the LRU cache so I think we're seeing the caches getting washed out by syncing iterators and migrations leaving `per_block_processing` and `find_head` to load from disk.\r\n- [ ] **Reconsider our approach to caching decompressed validator public keys (#848):** Presently each pubkey stores the compressed bytes and optionally the decompressed bytes and we use `BeaconState::decompress_validator_pubkeys` to iterate through all of them and build them. This is very expensive on a low-spec machine with 100k validators (several seconds). When we combine this with the above caching issue, we're seeing either (a) really long times to decompress all the keys at once or (b) very slow block processing verification because it needs to decompress each key.\r\n- [ ] **Reduce memory usage:** The 4gb nodes are at a bit of knifes-edge regarding memory usage, I've seen a few nodes run our of RAM and kill `lighthouse`. I suspect that caching and holding-in-memory `BeaconStates` is what's eating our RAM (I did some **rough** experiments and found that keeping one beacon state with fully-build caches in memory takes ~110mb of physical RAM). Now that we have attestation caches (#841) that rarely need to read `BeaconState`, I think we can make our caches targeted towards block processing; we can store fewer of them and we can mutate them as we receive new blocks (reducing copies and therefore states held in memory).\r\n- [ ] **Improve the threading model:** presently we're blocking the tokio executor with long-running tasks. This means we start timing out on API and p2p calls. We definitely need to switch over to the new tokio runtime so we can utilize a blocking thread-pool. We may also want to consider introducing specialized threadpools for blocks/attestations so we can have some control over how big those queues get to help with performance and DoS hardening. (e.g., give us the ability to start dropping attestations if we have more than `n` already queued). Note: this is a bit of longer-term goal and I don't think will be immediately necessary if we can solve the above issue.\r\n\r\nTo action these, I think we can split each one off into new issues/PRs. Ofc, keen to hear thoughts/suggestions.",
  "closed_by": {
    "login": "paulhauner",
    "id": 6660660,
    "node_id": "MDQ6VXNlcjY2NjA2NjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/paulhauner",
    "html_url": "https://github.com/paulhauner",
    "followers_url": "https://api.github.com/users/paulhauner/followers",
    "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
    "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
    "organizations_url": "https://api.github.com/users/paulhauner/orgs",
    "repos_url": "https://api.github.com/users/paulhauner/repos",
    "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
    "received_events_url": "https://api.github.com/users/paulhauner/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/847/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/847/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/584970322",
    "html_url": "https://github.com/sigp/lighthouse/issues/847#issuecomment-584970322",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/847",
    "id": 584970322,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU4NDk3MDMyMg==",
    "user": {
      "login": "AgeManning",
      "id": 7454587,
      "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AgeManning",
      "html_url": "https://github.com/AgeManning",
      "followers_url": "https://api.github.com/users/AgeManning/followers",
      "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
      "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
      "organizations_url": "https://api.github.com/users/AgeManning/orgs",
      "repos_url": "https://api.github.com/users/AgeManning/repos",
      "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AgeManning/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-02-12T01:26:45Z",
    "updated_at": "2020-02-12T01:26:45Z",
    "author_association": "MEMBER",
    "body": "For the threading model, if there are expensive long-running tasks, for now we can simply spawn whatever task as an OS thread rather than using the executor. I've done this currently in syncing. \r\n\r\nOnce we've shifted to stable futures, it won't be difficult to spawn the OS thread back to a blocking thread on the executor.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/584970322/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/680290971",
    "html_url": "https://github.com/sigp/lighthouse/issues/847#issuecomment-680290971",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/847",
    "id": 680290971,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY4MDI5MDk3MQ==",
    "user": {
      "login": "paulhauner",
      "id": 6660660,
      "node_id": "MDQ6VXNlcjY2NjA2NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/paulhauner",
      "html_url": "https://github.com/paulhauner",
      "followers_url": "https://api.github.com/users/paulhauner/followers",
      "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
      "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
      "organizations_url": "https://api.github.com/users/paulhauner/orgs",
      "repos_url": "https://api.github.com/users/paulhauner/repos",
      "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/paulhauner/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-08-25T22:00:54Z",
    "updated_at": "2020-08-25T22:00:54Z",
    "author_association": "MEMBER",
    "body": "Closing this since a lot has changed and I don't think most of this is really relevant anymore.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/680290971/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
