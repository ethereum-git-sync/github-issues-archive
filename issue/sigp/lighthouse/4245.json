{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/4245",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/4245/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/4245/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/4245/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/4245",
  "id": 1687954133,
  "node_id": "I_kwDOCFeAzc5knCLV",
  "number": 4245,
  "title": "Beacon API events SSE stream unexpected disconnections",
  "user": {
    "login": "Savid",
    "id": 1709934,
    "node_id": "MDQ6VXNlcjE3MDk5MzQ=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1709934?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Savid",
    "html_url": "https://github.com/Savid",
    "followers_url": "https://api.github.com/users/Savid/followers",
    "following_url": "https://api.github.com/users/Savid/following{/other_user}",
    "gists_url": "https://api.github.com/users/Savid/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Savid/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Savid/subscriptions",
    "organizations_url": "https://api.github.com/users/Savid/orgs",
    "repos_url": "https://api.github.com/users/Savid/repos",
    "events_url": "https://api.github.com/users/Savid/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Savid/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 985647281,
      "node_id": "MDU6TGFiZWw5ODU2NDcyODE=",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/bug",
      "name": "bug",
      "color": "d73a4a",
      "default": true,
      "description": "Something isn't working"
    },
    {
      "id": 2336800343,
      "node_id": "MDU6TGFiZWwyMzM2ODAwMzQz",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/HTTP-API",
      "name": "HTTP-API",
      "color": "5A63A2",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2023-04-28T06:04:23Z",
  "updated_at": "2023-07-13T04:28:34Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nWhen connecting to the [`/eth/v1/events`](https://ethereum.github.io/beacon-APIs/?urls.primaryName=dev#/Events/eventstream) event stream, clients will get unexpected disconnections from the lighthouse beacon node. Especially on the `attestation` topic for mainnet while subscribing all subnets.\r\n\r\n## Version\r\n\r\nRust - `1.69.0 (84c898d65 2023-04-16)`\r\n`unstable` - commit `7456e1e8faac7a581705f8e71b0dc4f09a36ee5c`\r\n`stable` - commit `693886b94176faa4cb450f024696cb69cda2fe58`\r\n\r\n## Present Behaviour\r\n\r\nTo replicate the current behaviour easily connect via curl;\r\n\r\n```bash\r\ncurl \"http://127.0.0.1:5052/eth/v1/events?topics=attestation\" -H \"accept: text/event-stream\"\r\n```\r\n\r\nEventually you'll get disconnected with the libcurl error;\r\n\r\n```bash\r\ncurl: (18) transfer closed with outstanding read data remaining\r\n```\r\n\r\nIf you want to speed this up run the beacon node with `--subscribe-all-subnets --import-all-attestations` flags on mainnet to have more attestation events published. With a \"fast\" machine you will get disconnected multiple times a slot.\r\n\r\n## Expected Behaviour\r\n\r\nShould not disconnect unexpectedly.",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/4245/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/4245/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1633447296",
    "html_url": "https://github.com/sigp/lighthouse/issues/4245#issuecomment-1633447296",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4245",
    "id": 1633447296,
    "node_id": "IC_kwDOCFeAzc5hXG2A",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-13T02:28:02Z",
    "updated_at": "2023-07-13T02:28:02Z",
    "author_association": "MEMBER",
    "body": "I think this could be due to the channel filling up, and the stream being terminated by our error handling here:\r\n\r\nhttps://github.com/sigp/lighthouse/blob/dfcb3363c757671eb19d5f8e519b4b94ac74677a/beacon_node/http_api/src/lib.rs#L3820-L3822\r\n\r\nThe broadcast receiver will return \"lag errors\" as described [here](https://docs.rs/tokio/1.28.0/tokio/sync/broadcast/index.html#lagging) when the channel fills up:\r\n\r\n> If a value is sent when the channel is at capacity, the oldest value currently held by the channel is released. This frees up space for the new value. Any receiver that has not yet seen the released value will return [RecvError::Lagged](https://docs.rs/tokio/1.28.0/tokio/sync/broadcast/error/enum.RecvError.html#variant.Lagged) the next time [recv](https://docs.rs/tokio/1.28.0/tokio/sync/broadcast/struct.Receiver.html#method.recv) is called.\r\n\r\nI think we could map these `RecvError::Lagged` errors into no-op events, maybe a comment that says \":dropped some events\".\r\n\r\nWe could also set some more generous defaults for the channel capacity, which is currently hardcoded at 16 here:\r\n\r\nhttps://github.com/sigp/lighthouse/blob/dfcb3363c757671eb19d5f8e519b4b94ac74677a/beacon_node/beacon_chain/src/events.rs#L7\r\n\r\nDifferent capacities for different events would probably make sense, and a way to adjust them via the CLI (maybe an integer multiplier that applies to all channel capacities).\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1633447296/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1633447919",
    "html_url": "https://github.com/sigp/lighthouse/issues/4245#issuecomment-1633447919",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4245",
    "id": 1633447919,
    "node_id": "IC_kwDOCFeAzc5hXG_v",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-13T02:29:01Z",
    "updated_at": "2023-07-13T02:29:01Z",
    "author_association": "MEMBER",
    "body": "Implementation of this fix should happen on top of https://github.com/sigp/lighthouse/pull/4462",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1633447919/reactions",
      "total_count": 3,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 3,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1633496139",
    "html_url": "https://github.com/sigp/lighthouse/issues/4245#issuecomment-1633496139",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4245",
    "id": 1633496139,
    "node_id": "IC_kwDOCFeAzc5hXSxL",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-13T03:34:21Z",
    "updated_at": "2023-07-13T03:34:21Z",
    "author_association": "MEMBER",
    "body": "WIP PR for initial testing here: https://github.com/sigp/lighthouse/pull/4500\r\n\r\nI haven't been able to get it to produce the `:error - dropped N messages` comment yet, but will run it for a few hours and see what happens",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1633496139/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 1,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1633527069",
    "html_url": "https://github.com/sigp/lighthouse/issues/4245#issuecomment-1633527069",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4245",
    "id": 1633527069,
    "node_id": "IC_kwDOCFeAzc5hXaUd",
    "user": {
      "login": "Savid",
      "id": 1709934,
      "node_id": "MDQ6VXNlcjE3MDk5MzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1709934?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Savid",
      "html_url": "https://github.com/Savid",
      "followers_url": "https://api.github.com/users/Savid/followers",
      "following_url": "https://api.github.com/users/Savid/following{/other_user}",
      "gists_url": "https://api.github.com/users/Savid/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Savid/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Savid/subscriptions",
      "organizations_url": "https://api.github.com/users/Savid/orgs",
      "repos_url": "https://api.github.com/users/Savid/repos",
      "events_url": "https://api.github.com/users/Savid/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Savid/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-13T04:28:34Z",
    "updated_at": "2023-07-13T04:28:34Z",
    "author_association": "NONE",
    "body": "awesome, thanks. Just built an [image](https://hub.docker.com/layers/ethpandaops/lighthouse/xatu-sentry-channel-test-9f3c103/images/sha256-226a5ca5514f6e1390470e7b1306d35b9253f20bada2952ef4b28d00fc294ee5). Will roll it out to one of our mainnet sentries and let you know how it looks",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1633527069/reactions",
      "total_count": 2,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 2,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
