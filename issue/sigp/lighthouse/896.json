{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/896",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/896/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/896/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/896/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/896",
  "id": 576003437,
  "node_id": "MDU6SXNzdWU1NzYwMDM0Mzc=",
  "number": 896,
  "title": "Shift parent chain lookup block processing to dedicated thread",
  "user": {
    "login": "AgeManning",
    "id": 7454587,
    "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/AgeManning",
    "html_url": "https://github.com/AgeManning",
    "followers_url": "https://api.github.com/users/AgeManning/followers",
    "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
    "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
    "organizations_url": "https://api.github.com/users/AgeManning/orgs",
    "repos_url": "https://api.github.com/users/AgeManning/repos",
    "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
    "received_events_url": "https://api.github.com/users/AgeManning/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 985647286,
      "node_id": "MDU6TGFiZWw5ODU2NDcyODY=",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/good%20first%20issue",
      "name": "good first issue",
      "color": "7057ff",
      "default": true,
      "description": "Good for newcomers"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2020-03-05T05:31:13Z",
  "updated_at": "2020-03-23T01:07:41Z",
  "closed_at": "2020-03-23T01:07:41Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nWhen an unknown block is seen on the gossip channel, lighthouse tries to find a chain of blocks that links it to the current known canonical chain. The depth of the lookup is specified by a constant and can be quite large.\r\n\r\nOnce a chain can be processed, we process all the downloaded blocks at once. This is currently done in the syncing thread task, which will block the executor. This block processing logic should be shifted to a dedicated thread as was done in the range sync.",
  "closed_by": {
    "login": "AgeManning",
    "id": 7454587,
    "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/AgeManning",
    "html_url": "https://github.com/AgeManning",
    "followers_url": "https://api.github.com/users/AgeManning/followers",
    "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
    "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
    "organizations_url": "https://api.github.com/users/AgeManning/orgs",
    "repos_url": "https://api.github.com/users/AgeManning/repos",
    "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
    "received_events_url": "https://api.github.com/users/AgeManning/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/896/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/896/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/595834247",
    "html_url": "https://github.com/sigp/lighthouse/issues/896#issuecomment-595834247",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/896",
    "id": 595834247,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU5NTgzNDI0Nw==",
    "user": {
      "login": "divagant-martian",
      "id": 26765164,
      "node_id": "MDQ6VXNlcjI2NzY1MTY0",
      "avatar_url": "https://avatars.githubusercontent.com/u/26765164?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/divagant-martian",
      "html_url": "https://github.com/divagant-martian",
      "followers_url": "https://api.github.com/users/divagant-martian/followers",
      "following_url": "https://api.github.com/users/divagant-martian/following{/other_user}",
      "gists_url": "https://api.github.com/users/divagant-martian/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/divagant-martian/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/divagant-martian/subscriptions",
      "organizations_url": "https://api.github.com/users/divagant-martian/orgs",
      "repos_url": "https://api.github.com/users/divagant-martian/repos",
      "events_url": "https://api.github.com/users/divagant-martian/events{/privacy}",
      "received_events_url": "https://api.github.com/users/divagant-martian/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-03-06T15:59:28Z",
    "updated_at": "2020-03-06T15:59:28Z",
    "author_association": "COLLABORATOR",
    "body": "I'll work on this one",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/595834247/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/596023554",
    "html_url": "https://github.com/sigp/lighthouse/issues/896#issuecomment-596023554",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/896",
    "id": 596023554,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU5NjAyMzU1NA==",
    "user": {
      "login": "AgeManning",
      "id": 7454587,
      "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AgeManning",
      "html_url": "https://github.com/AgeManning",
      "followers_url": "https://api.github.com/users/AgeManning/followers",
      "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
      "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
      "organizations_url": "https://api.github.com/users/AgeManning/orgs",
      "repos_url": "https://api.github.com/users/AgeManning/repos",
      "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AgeManning/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-03-07T00:53:16Z",
    "updated_at": "2020-03-07T00:53:16Z",
    "author_association": "MEMBER",
    "body": "Awesome! Thanks for the help!\r\n\r\nLet me point you at some code to make things a bit clearer (as some parts here are a little convoluted). \r\n\r\nSometimes we see a block flying over the network that we've not seen before. When this happens, we try and add it into our chain. However, if we don't know it's parent, we can't add it.. we have to recursively lookup the blocks ancestry until it either matches our current chain or becomes too long. \r\n\r\nEach time we find a new parent, we try and process the entire chain of blocks here: https://github.com/sigp/lighthouse/blob/parent-lookup-update/beacon_node/network/src/sync/manager.rs#L583\r\n\r\nApologies for this being on a branch (I'll merge it to master soon). \r\n\r\nSpecifically the chained block processing occurs here:\r\nhttps://github.com/sigp/lighthouse/blob/parent-lookup-update/beacon_node/network/src/sync/manager.rs#L642\r\n\r\nNow, block processing isn't exactly a fast task, so we want to shift the chain processing off into it's own OS thread, rather than have it run inside a task on our tokio executor. \r\n\r\nI've done a similar thing when we are syncing. See here to send off a request to process a chunk of blocks:\r\nhttps://github.com/sigp/lighthouse/blob/master/beacon_node/network/src/sync/range_sync/chain.rs#L241\r\n\r\nAnd here is a the code that spawns a block processing thread: \r\nhttps://github.com/sigp/lighthouse/blob/master/beacon_node/network/src/sync/range_sync/batch_processing.rs\r\n\r\nIt's currently called batch processor because I originally built it to process a batch of blocks during sync, we could rename it. \r\n\r\nI imagine we can use the batch processor and similar dispatch logic in the parent lookup case. This might actually be simpler as we don't  necessarily need to check the result of the processing, so don't need to update the logic to being async here. I think in this section of code, it doesn't matter if the blocks get processed or not, as in either case we drop the parent lookup. So in principle we can just send it off to a block processing thread and not wait any response. \r\nAlthough the block processing thread may then have to inform the user of success failure and downvote peers in the failure case.\r\n\r\nLet me know if I can explain or help further",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/596023554/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
