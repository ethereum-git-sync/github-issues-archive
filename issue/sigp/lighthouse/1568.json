{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/1568",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/1568/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/1568/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/1568/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/1568",
  "id": 685666450,
  "node_id": "MDU6SXNzdWU2ODU2NjY0NTA=",
  "number": 1568,
  "title": "Lighthouse replies to undersized RANDOM PACKETS",
  "user": {
    "login": "jrhea",
    "id": 5555162,
    "node_id": "MDQ6VXNlcjU1NTUxNjI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5555162?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jrhea",
    "html_url": "https://github.com/jrhea",
    "followers_url": "https://api.github.com/users/jrhea/followers",
    "following_url": "https://api.github.com/users/jrhea/following{/other_user}",
    "gists_url": "https://api.github.com/users/jrhea/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jrhea/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jrhea/subscriptions",
    "organizations_url": "https://api.github.com/users/jrhea/orgs",
    "repos_url": "https://api.github.com/users/jrhea/repos",
    "events_url": "https://api.github.com/users/jrhea/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jrhea/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2020-08-25T17:33:34Z",
  "updated_at": "2020-09-01T01:59:45Z",
  "closed_at": "2020-09-01T01:59:44Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Description\r\nLighthouse doesn't properly validate the `RANDOM PACKET` size before replying with `WHOAREYOU`.  Per the discv5 protocol a `RANDOM_PACKET` is sent to initiate a handshake and the receiving node replies with `WHOAREYOU`.  The `RANDOM_PACKET` should have the following layout:\r\n\r\n> tag -> 32 bytes \r\n> auth-tag -> 12 bytes (RLP format)\r\n> random_data -> 44+ bytes\r\n\r\nThe Discv5 rationale document specifically mentions that the `RANDOM PACKET` size should be > `WHOAREYOU` to ensure that an attack using the `RANDOM PACKET` format will require more bandwidth for the attacker.  Lighthouse will reply to `RANDOM PACKETS` as small as 46 bytes - in other words, the `random_data` field does not seem to be required in this implementation.  88 bytes + 2 bytes for RLP length prefix should be the minimum acceptable size.\r\n\r\n\r\nThe following is screenshot showing Lighthouse's reply to a malformed `RANDOM PACKET` that is undersized:\r\n\r\nInvalid `RANDOM PACKET`:\r\n![image](https://user-images.githubusercontent.com/5555162/91206808-61b29880-e6cd-11ea-98ae-5ab4f7f88d2f.png)\r\n\r\n\r\nLighthouse's `WHOAREYOU` response:\r\n![image](https://user-images.githubusercontent.com/5555162/91206834-6d9e5a80-e6cd-11ea-8e47-31f7ca88535b.png)\r\n\r\n\r\n\r\n### Steps to Reproduce\r\n\r\nYou can recreate the issue by using this command to send a malformed message to Lighthouse:\r\n\r\n`> hping3 -d 46 --fast --udp -p [PORT] [IP] -E lh.payload`\r\n\r\nwhere lh.payload is the following hex string converted to binary:\r\n\r\n```\r\n> cat lh.input \r\n01010101010101010101010101010101010101010101010101010101010101018c020202020202020202020202\r\n```\r\n\r\nif it helps, you can use the following python code to convert the hex string above to the appropriate format:\r\n\r\n```python\r\nimport binascii\r\n \r\nwith open('lh.input') as f, open('lh.payload', 'wb') as fout:\r\n     for line in f:\r\n         fout.write(\r\n             binascii.unhexlify(''.join(line.split()))\r\n         )\r\n```\r\nor just modify one of the mysteriously similar discv5 unit tests ðŸ˜‰",
  "closed_by": {
    "login": "AgeManning",
    "id": 7454587,
    "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/AgeManning",
    "html_url": "https://github.com/AgeManning",
    "followers_url": "https://api.github.com/users/AgeManning/followers",
    "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
    "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
    "organizations_url": "https://api.github.com/users/AgeManning/orgs",
    "repos_url": "https://api.github.com/users/AgeManning/repos",
    "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
    "received_events_url": "https://api.github.com/users/AgeManning/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/1568/reactions",
    "total_count": 3,
    "+1": 3,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/1568/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/683222780",
    "html_url": "https://github.com/sigp/lighthouse/issues/1568#issuecomment-683222780",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1568",
    "id": 683222780,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY4MzIyMjc4MA==",
    "user": {
      "login": "AgeManning",
      "id": 7454587,
      "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AgeManning",
      "html_url": "https://github.com/AgeManning",
      "followers_url": "https://api.github.com/users/AgeManning/followers",
      "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
      "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
      "organizations_url": "https://api.github.com/users/AgeManning/orgs",
      "repos_url": "https://api.github.com/users/AgeManning/repos",
      "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AgeManning/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-08-29T02:27:18Z",
    "updated_at": "2020-08-29T02:27:18Z",
    "author_association": "MEMBER",
    "body": "Ah yeah cool. I'll check this out and update discv5 accordingly. Will close this once complete. \r\n\r\nThanks for the work done here!",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/683222780/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/683414834",
    "html_url": "https://github.com/sigp/lighthouse/issues/1568#issuecomment-683414834",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1568",
    "id": 683414834,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY4MzQxNDgzNA==",
    "user": {
      "login": "fjl",
      "id": 6915,
      "node_id": "MDQ6VXNlcjY5MTU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6915?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjl",
      "html_url": "https://github.com/fjl",
      "followers_url": "https://api.github.com/users/fjl/followers",
      "following_url": "https://api.github.com/users/fjl/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjl/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjl/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjl/subscriptions",
      "organizations_url": "https://api.github.com/users/fjl/orgs",
      "repos_url": "https://api.github.com/users/fjl/repos",
      "events_url": "https://api.github.com/users/fjl/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjl/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-08-30T12:30:31Z",
    "updated_at": "2020-08-30T12:32:28Z",
    "author_association": "NONE",
    "body": "I think this is a great finding, and go-ethereum probably has the same issue. But there is an issue in the spec that we need to address also: requiring the random-packet to be larger than 44 bytes exists because it is supposed to prevent traffic amplification attacks, i.e. for any packet you can send that would trigger a WHOAREYOU response, the incoming packet should be equal in size or larger than WHOAREYOU.\r\n\r\nConsider the scenario where A and B had a session going on, but then B drops the session because it restarts or something. The next PING sent by A cannot be decrypted by B and it should respond with WHOAREYOU to get the session back on.\r\n\r\nSo what we need to change in the spec is requiring all request packets to be larger than WHOAREYOU, not just the initial random packet.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/683414834/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/683486440",
    "html_url": "https://github.com/sigp/lighthouse/issues/1568#issuecomment-683486440",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1568",
    "id": 683486440,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY4MzQ4NjQ0MA==",
    "user": {
      "login": "jrhea",
      "id": 5555162,
      "node_id": "MDQ6VXNlcjU1NTUxNjI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5555162?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jrhea",
      "html_url": "https://github.com/jrhea",
      "followers_url": "https://api.github.com/users/jrhea/followers",
      "following_url": "https://api.github.com/users/jrhea/following{/other_user}",
      "gists_url": "https://api.github.com/users/jrhea/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jrhea/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jrhea/subscriptions",
      "organizations_url": "https://api.github.com/users/jrhea/orgs",
      "repos_url": "https://api.github.com/users/jrhea/repos",
      "events_url": "https://api.github.com/users/jrhea/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jrhea/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-08-30T23:40:13Z",
    "updated_at": "2020-08-30T23:40:13Z",
    "author_association": "NONE",
    "body": "> I think this is a great finding, and go-ethereum probably has the same issue.\r\n \r\nI can confirm it does + it also allows invalid RLP length prefixes before the Auth_tag.  @fjl checkout the issue I opened here: \r\n\r\nhttps://github.com/prysmaticlabs/prysm/issues/7110",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/683486440/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/684145884",
    "html_url": "https://github.com/sigp/lighthouse/issues/1568#issuecomment-684145884",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1568",
    "id": 684145884,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY4NDE0NTg4NA==",
    "user": {
      "login": "AgeManning",
      "id": 7454587,
      "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AgeManning",
      "html_url": "https://github.com/AgeManning",
      "followers_url": "https://api.github.com/users/AgeManning/followers",
      "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
      "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
      "organizations_url": "https://api.github.com/users/AgeManning/orgs",
      "repos_url": "https://api.github.com/users/AgeManning/repos",
      "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AgeManning/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-09-01T01:59:44Z",
    "updated_at": "2020-09-01T01:59:44Z",
    "author_association": "MEMBER",
    "body": "This requires a spec update to properly address. I'm going to close this for now. \r\n\r\nWe will keep up to date with the spec which should in the future address this. ",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/684145884/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
