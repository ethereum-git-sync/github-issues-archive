{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/2857",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/2857/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/2857/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/2857/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/2857",
  "id": 1072992736,
  "node_id": "I_kwDOCFeAzc4_9JHg",
  "number": 2857,
  "title": "`malloc_utils` sets `M_MMAP_MAX` rather than `M_MMAP_THRESHOLD`",
  "user": {
    "login": "michaelsproul",
    "id": 4452260,
    "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/michaelsproul",
    "html_url": "https://github.com/michaelsproul",
    "followers_url": "https://api.github.com/users/michaelsproul/followers",
    "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
    "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
    "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
    "repos_url": "https://api.github.com/users/michaelsproul/repos",
    "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
    "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 985647281,
      "node_id": "MDU6TGFiZWw5ODU2NDcyODE=",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/bug",
      "name": "bug",
      "color": "d73a4a",
      "default": true,
      "description": "Something isn't working"
    },
    {
      "id": 1999784343,
      "node_id": "MDU6TGFiZWwxOTk5Nzg0MzQz",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/optimization",
      "name": "optimization",
      "color": "f9de40",
      "default": false,
      "description": "Something to make Lighthouse run more efficiently."
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2021-12-07T07:08:19Z",
  "updated_at": "2022-01-27T23:19:22Z",
  "closed_at": "2022-01-27T23:19:21Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nWe set a constant for `M_MMAP_THRESHOLD` to `-4` here:\r\n\r\nhttps://github.com/sigp/lighthouse/blob/fff01b24ddedcd54486e374460855ca20d3dd232/common/malloc_utils/src/glibc.rs#L28-L29\r\n\r\nBut it should actually be `-3` per the link in the comment:\r\n\r\nhttps://github.com/lattera/glibc/blob/895ef79e04a953cac1493863bcae29ad85657ee1/malloc/malloc.h#L115-L123\r\n\r\nThe effect of this is that we've been setting the maximum number of chunks to allocate with `mmap` to 2M. Whether or not we want to continue doing this is open for investigation (i.e. do we correct the constant's name or its value).\r\n\r\n## Version\r\n\r\nLighthouse v2.0.1\r\n",
  "closed_by": {
    "login": "michaelsproul",
    "id": 4452260,
    "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/michaelsproul",
    "html_url": "https://github.com/michaelsproul",
    "followers_url": "https://api.github.com/users/michaelsproul/followers",
    "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
    "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
    "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
    "repos_url": "https://api.github.com/users/michaelsproul/repos",
    "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
    "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/2857/reactions",
    "total_count": 1,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 1
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/2857/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1016209027",
    "html_url": "https://github.com/sigp/lighthouse/issues/2857#issuecomment-1016209027",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/2857",
    "id": 1016209027,
    "node_id": "IC_kwDOCFeAzc48kh6D",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-01-19T08:45:23Z",
    "updated_at": "2022-01-19T08:45:23Z",
    "author_association": "MEMBER",
    "body": "My current theory for why it's _good_ to set `M_MMAP_MAX` as we do is:\r\n\r\n1. It increases the number of allocations that `malloc` may make using `mmap`. These allocations are less prone to fragmentation, and are freed immediately to the OS. The [`mallopt` docs][mallopt] are a bit misleading because they make it sound like this is about _concurrent_ `mmap` requests, but reading the glibc source ( :scream: ) reveals that it is in fact about the total number of `mmap` allocations in existence at a given time, see [`n_mmaps` here](https://github.com/bminor/glibc/blob/1e000d3d33211d5a954300e2a69b90f93f18a1a1/malloc/malloc.c#L2572-L2582).\r\n2. Setting a static value for `M_MMAP_MAX` _disables_ the dynamic adjustment of the `mmap` threshold. This means that the `mmap` threshold is fixed at the 128KB default and all allocations larger than 128KB are eligible to be `mmap`'d. This means that [contrary to the existing doc comments](https://github.com/sigp/lighthouse/blob/fff01b24ddedcd54486e374460855ca20d3dd232/common/malloc_utils/src/glibc.rs#L14-L22) we _will_ allocate tree hash cache arenas with `mmap`, and this is _good_. The relevant excerpt from the [`mallopt`][mallopt] docs is:\r\n\r\n> Note: Nowadays, glibc uses a dynamic mmap threshold by default.  The initial value of the threshold is 128*1024, but when blocks larger than the current threshold and less than or equal to DEFAULT_MMAP_THRESHOLD_MAX are freed, the threshold is adjusted upward to the size of the freed block.  When dynamic mmap thresholding is in effect, the threshold for trimming the heap is also dynamically adjusted to be twice the dynamic mmap threshold.  **Dynamic adjustment of the mmap threshold is disabled if any of the M_TRIM_THRESHOLD, M_TOP_PAD, M_MMAP_THRESHOLD, or M_MMAP_MAX parameters is set.**\r\n\r\nObservations consistent with the above:\r\n\r\nA) I overrode Lighthouse's choice of `MMAP_MAX` and set it below the typical number of arenas used to 128, and memory usage ballooned out of control. Lots of memory got allocated on the regular heap, and then fragmentation caused the amount of unused free memory (and the RSS) to grow continuously.\r\nB) Using `--disable-memory-profiling` results in runaway memory usage as well. I think this is explained by the allocator increasing the dynamic threshold too high and then struggling to keep the heap defragmented.\r\nC) Setting `MMAP_MAX` to the default 65536 and `MMAP_THRESHOLD` to 128KB (static) seems to exhibit similar performance to Lighthouse's current settings. This implies (reassuringly) that the effect of increasing `MMAP_MAX` to 2M from 64K is inconsequential and that point (2) above is the real reason for the improvement.\r\n\r\nTherefore I suspect we don't need to touch the `MMAP_MAX` limit at all and could more directly achieve what we want by _just_ setting `MMAP_THRESHOLD` to the 128KB static value which overrides the dynamic adjustments. Will try that tomorrow.\r\n\r\n[mallopt]: https://man7.org/linux/man-pages/man3/mallopt.3.html",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1016209027/reactions",
      "total_count": 2,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 1,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1023730369",
    "html_url": "https://github.com/sigp/lighthouse/issues/2857#issuecomment-1023730369",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/2857",
    "id": 1023730369,
    "node_id": "IC_kwDOCFeAzc49BOLB",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-01-27T23:19:21Z",
    "updated_at": "2022-01-27T23:19:21Z",
    "author_association": "MEMBER",
    "body": "Closed by #2937",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1023730369/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
