{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/4281",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/4281/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/4281/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/4281/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/4281",
  "id": 1708082458,
  "node_id": "I_kwDOCFeAzc5lz0Ua",
  "number": 4281,
  "title": "Enshrine head state shuffling in the `shuffling_cache`",
  "user": {
    "login": "paulhauner",
    "id": 6660660,
    "node_id": "MDQ6VXNlcjY2NjA2NjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/paulhauner",
    "html_url": "https://github.com/paulhauner",
    "followers_url": "https://api.github.com/users/paulhauner/followers",
    "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
    "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
    "organizations_url": "https://api.github.com/users/paulhauner/orgs",
    "repos_url": "https://api.github.com/users/paulhauner/repos",
    "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
    "received_events_url": "https://api.github.com/users/paulhauner/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 5383189287,
      "node_id": "LA_kwDOCFeAzc8AAAABQNzzJw",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/v4.2.0",
      "name": "v4.2.0",
      "color": "337948",
      "default": false,
      "description": "Q2 2023"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "jimmygchen",
    "id": 742762,
    "node_id": "MDQ6VXNlcjc0Mjc2Mg==",
    "avatar_url": "https://avatars.githubusercontent.com/u/742762?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jimmygchen",
    "html_url": "https://github.com/jimmygchen",
    "followers_url": "https://api.github.com/users/jimmygchen/followers",
    "following_url": "https://api.github.com/users/jimmygchen/following{/other_user}",
    "gists_url": "https://api.github.com/users/jimmygchen/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jimmygchen/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jimmygchen/subscriptions",
    "organizations_url": "https://api.github.com/users/jimmygchen/orgs",
    "repos_url": "https://api.github.com/users/jimmygchen/repos",
    "events_url": "https://api.github.com/users/jimmygchen/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jimmygchen/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "jimmygchen",
      "id": 742762,
      "node_id": "MDQ6VXNlcjc0Mjc2Mg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/742762?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jimmygchen",
      "html_url": "https://github.com/jimmygchen",
      "followers_url": "https://api.github.com/users/jimmygchen/followers",
      "following_url": "https://api.github.com/users/jimmygchen/following{/other_user}",
      "gists_url": "https://api.github.com/users/jimmygchen/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jimmygchen/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jimmygchen/subscriptions",
      "organizations_url": "https://api.github.com/users/jimmygchen/orgs",
      "repos_url": "https://api.github.com/users/jimmygchen/repos",
      "events_url": "https://api.github.com/users/jimmygchen/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jimmygchen/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2023-05-12T19:09:05Z",
  "updated_at": "2023-05-21T22:46:46Z",
  "closed_at": "2023-05-21T22:46:46Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nDuring the mainnet instability on the 12th & 13th of May we saw some logs like this:\r\n\r\n```\r\nERRO Failed to download attester duties      err: FailedToDownloadAttesters(\"Some endpoints failed, num_failed: 1 http://redacted:5052/ => RequestFailed(ServerMessage(ErrorMessage { code: 500, message: \"UNHANDLED_ERROR: MaxCommitteePromises(2)\", stacktraces: [] }))\"), request_epoch: 200554, current_epoch: 200553, service: duties\r\n```\r\n\r\nThis is a result of the DoS prevention mechanism that prevents us from concurrently loading and unbounded number of states from the DB to serve requests for shuffling (triggered via P2P or HTTP API): \r\n\r\nhttps://github.com/sigp/lighthouse/blob/693886b94176faa4cb450f024696cb69cda2fe58/beacon_node/beacon_chain/src/shuffling_cache.rs#L14-L23\r\n\r\nThis mechanism is likely the one that kept us stable during the network instability. However, we did notice that our [shuffling cache](https://github.com/sigp/lighthouse/blob/stable/beacon_node/beacon_chain/src/shuffling_cache.rs) doesn't enshrine the shuffling of the head block in the same way that our [`snapshot_cache` does](https://github.com/sigp/lighthouse/blob/693886b94176faa4cb450f024696cb69cda2fe58/beacon_node/beacon_chain/src/snapshot_cache.rs#L225-L229). By \"enshrine\" I mean that the cache should know what the attester shuffling key is for the head block (at the current wall-clock epoch) and it should not allow some other shuffling to replace it. This should prevent us from ever dropping attestations to the head block because we've reached `MaxCommitteePromises`.\r\n\r\n## Steps to Resolve\r\n\r\nFrom a high level, I think we need to:\r\n\r\n1. Store the `AttestationShufflingId` for the head block and current wall-clock epoch on the `ShufflingCache`\r\n    - It might actually turn out to be best to just store the shuffling decision root for the head block on the `ShufflingCache` and also provide the cache with access to the `SlotClock`, so it can figure out the current wall-clock epoch on its own accord.\r\n1. Ensure that any insertions to the cache (e.g., `self.cache.put`) don't override the enshrined head values.\r\n\r\nI think (1) is fairly straight-forward. The `shuffling_cache` already provides an example of how this is done.\r\n\r\n(2) is a little more complex since the shuffling cache uses an `LruCache` which natively just replaces the oldest entry rather than a specific one. I see two ways to address this:\r\n\r\n- Touch the enshrined head shuffling before any insert, so it's always the most recent and least-likely to be removed.\r\n- Switch away from an LruCache to something that prefers to remove the entry with the lowest epoch (this is how the `snapshot_cache` does it).\r\n\r\nAt this moment, I prefer the latter since it seems a little smarter than just an LRU cache. However I'm not convinced since there are some complexities around tie-breaking when two entries have the same epoch. Perhaps preferring entries in the canonical chain is best? It's pretty late here so I'd have to come back to this to reason it out properly.\r\n",
  "closed_by": {
    "login": "michaelsproul",
    "id": 4452260,
    "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/michaelsproul",
    "html_url": "https://github.com/michaelsproul",
    "followers_url": "https://api.github.com/users/michaelsproul/followers",
    "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
    "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
    "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
    "repos_url": "https://api.github.com/users/michaelsproul/repos",
    "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
    "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/4281/reactions",
    "total_count": 2,
    "+1": 2,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/4281/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1546176916",
    "html_url": "https://github.com/sigp/lighthouse/issues/4281#issuecomment-1546176916",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4281",
    "id": 1546176916,
    "node_id": "IC_kwDOCFeAzc5cKMmU",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-12T19:22:15Z",
    "updated_at": "2023-05-12T19:22:15Z",
    "author_association": "MEMBER",
    "body": "It might also be good to make the concurrency limit configurable via the CLI. Then users can throw more CPU at it if the default is too low",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1546176916/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1547035142",
    "html_url": "https://github.com/sigp/lighthouse/issues/4281#issuecomment-1547035142",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4281",
    "id": 1547035142,
    "node_id": "IC_kwDOCFeAzc5cNeIG",
    "user": {
      "login": "jimmygchen",
      "id": 742762,
      "node_id": "MDQ6VXNlcjc0Mjc2Mg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/742762?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jimmygchen",
      "html_url": "https://github.com/jimmygchen",
      "followers_url": "https://api.github.com/users/jimmygchen/followers",
      "following_url": "https://api.github.com/users/jimmygchen/following{/other_user}",
      "gists_url": "https://api.github.com/users/jimmygchen/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jimmygchen/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jimmygchen/subscriptions",
      "organizations_url": "https://api.github.com/users/jimmygchen/orgs",
      "repos_url": "https://api.github.com/users/jimmygchen/repos",
      "events_url": "https://api.github.com/users/jimmygchen/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jimmygchen/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-14T23:59:29Z",
    "updated_at": "2023-05-14T23:59:29Z",
    "author_association": "MEMBER",
    "body": "Hi, I'll look into this one!",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1547035142/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 1,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1556314987",
    "html_url": "https://github.com/sigp/lighthouse/issues/4281#issuecomment-1556314987",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4281",
    "id": 1556314987,
    "node_id": "IC_kwDOCFeAzc5cw3tr",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-21T22:46:45Z",
    "updated_at": "2023-05-21T22:46:45Z",
    "author_association": "MEMBER",
    "body": "Fixed in #4296!",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1556314987/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
