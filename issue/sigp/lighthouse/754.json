{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/754",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/754/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/754/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/754/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/754",
  "id": 541651188,
  "node_id": "MDU6SXNzdWU1NDE2NTExODg=",
  "number": 754,
  "title": "Implement max number of response chunks",
  "user": {
    "login": "AgeManning",
    "id": 7454587,
    "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/AgeManning",
    "html_url": "https://github.com/AgeManning",
    "followers_url": "https://api.github.com/users/AgeManning/followers",
    "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
    "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
    "organizations_url": "https://api.github.com/users/AgeManning/orgs",
    "repos_url": "https://api.github.com/users/AgeManning/repos",
    "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
    "received_events_url": "https://api.github.com/users/AgeManning/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 2336800125,
      "node_id": "MDU6TGFiZWwyMzM2ODAwMTI1",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/t%20Networking",
      "name": "t Networking",
      "color": "40E0D0",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "AgeManning",
    "id": 7454587,
    "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/AgeManning",
    "html_url": "https://github.com/AgeManning",
    "followers_url": "https://api.github.com/users/AgeManning/followers",
    "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
    "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
    "organizations_url": "https://api.github.com/users/AgeManning/orgs",
    "repos_url": "https://api.github.com/users/AgeManning/repos",
    "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
    "received_events_url": "https://api.github.com/users/AgeManning/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "AgeManning",
      "id": 7454587,
      "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AgeManning",
      "html_url": "https://github.com/AgeManning",
      "followers_url": "https://api.github.com/users/AgeManning/followers",
      "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
      "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
      "organizations_url": "https://api.github.com/users/AgeManning/orgs",
      "repos_url": "https://api.github.com/users/AgeManning/repos",
      "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AgeManning/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": {
    "url": "https://api.github.com/repos/sigp/lighthouse/milestones/3",
    "html_url": "https://github.com/sigp/lighthouse/milestone/3",
    "labels_url": "https://api.github.com/repos/sigp/lighthouse/milestones/3/labels",
    "id": 4917495,
    "node_id": "MDk6TWlsZXN0b25lNDkxNzQ5NQ==",
    "number": 3,
    "title": "v0.2.0",
    "description": null,
    "creator": {
      "login": "AgeManning",
      "id": 7454587,
      "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AgeManning",
      "html_url": "https://github.com/AgeManning",
      "followers_url": "https://api.github.com/users/AgeManning/followers",
      "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
      "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
      "organizations_url": "https://api.github.com/users/AgeManning/orgs",
      "repos_url": "https://api.github.com/users/AgeManning/repos",
      "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AgeManning/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 0,
    "closed_issues": 24,
    "state": "open",
    "created_at": "2019-12-10T02:14:12Z",
    "updated_at": "2020-11-08T23:26:43Z",
    "due_on": null,
    "closed_at": null
  },
  "comments": 6,
  "created_at": "2019-12-23T08:55:09Z",
  "updated_at": "2022-10-20T17:09:16Z",
  "closed_at": "2020-05-18T11:56:19Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nA maximum number of chunks can be read before an RPC stream is considered failed. This needs to be implemented in the RPC handler.",
  "closed_by": {
    "login": "AgeManning",
    "id": 7454587,
    "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/AgeManning",
    "html_url": "https://github.com/AgeManning",
    "followers_url": "https://api.github.com/users/AgeManning/followers",
    "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
    "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
    "organizations_url": "https://api.github.com/users/AgeManning/orgs",
    "repos_url": "https://api.github.com/users/AgeManning/repos",
    "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
    "received_events_url": "https://api.github.com/users/AgeManning/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/754/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/754/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/623483458",
    "html_url": "https://github.com/sigp/lighthouse/issues/754#issuecomment-623483458",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/754",
    "id": 623483458,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyMzQ4MzQ1OA==",
    "user": {
      "login": "b-m-f",
      "id": 2843450,
      "node_id": "MDQ6VXNlcjI4NDM0NTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2843450?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/b-m-f",
      "html_url": "https://github.com/b-m-f",
      "followers_url": "https://api.github.com/users/b-m-f/followers",
      "following_url": "https://api.github.com/users/b-m-f/following{/other_user}",
      "gists_url": "https://api.github.com/users/b-m-f/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/b-m-f/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/b-m-f/subscriptions",
      "organizations_url": "https://api.github.com/users/b-m-f/orgs",
      "repos_url": "https://api.github.com/users/b-m-f/repos",
      "events_url": "https://api.github.com/users/b-m-f/events{/privacy}",
      "received_events_url": "https://api.github.com/users/b-m-f/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-04T14:03:30Z",
    "updated_at": "2020-05-04T14:03:30Z",
    "author_association": "CONTRIBUTOR",
    "body": "@AgeManning is this done with #811?",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/623483458/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/623932507",
    "html_url": "https://github.com/sigp/lighthouse/issues/754#issuecomment-623932507",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/754",
    "id": 623932507,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyMzkzMjUwNw==",
    "user": {
      "login": "AgeManning",
      "id": 7454587,
      "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AgeManning",
      "html_url": "https://github.com/AgeManning",
      "followers_url": "https://api.github.com/users/AgeManning/followers",
      "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
      "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
      "organizations_url": "https://api.github.com/users/AgeManning/orgs",
      "repos_url": "https://api.github.com/users/AgeManning/repos",
      "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AgeManning/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-05T08:44:44Z",
    "updated_at": "2020-05-05T08:44:44Z",
    "author_association": "MEMBER",
    "body": "No, I've left this one out. Still on the old to-do list.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/623932507/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/624123821",
    "html_url": "https://github.com/sigp/lighthouse/issues/754#issuecomment-624123821",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/754",
    "id": 624123821,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyNDEyMzgyMQ==",
    "user": {
      "login": "b-m-f",
      "id": 2843450,
      "node_id": "MDQ6VXNlcjI4NDM0NTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2843450?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/b-m-f",
      "html_url": "https://github.com/b-m-f",
      "followers_url": "https://api.github.com/users/b-m-f/followers",
      "following_url": "https://api.github.com/users/b-m-f/following{/other_user}",
      "gists_url": "https://api.github.com/users/b-m-f/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/b-m-f/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/b-m-f/subscriptions",
      "organizations_url": "https://api.github.com/users/b-m-f/orgs",
      "repos_url": "https://api.github.com/users/b-m-f/repos",
      "events_url": "https://api.github.com/users/b-m-f/events{/privacy}",
      "received_events_url": "https://api.github.com/users/b-m-f/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-05T15:27:26Z",
    "updated_at": "2020-05-05T19:03:53Z",
    "author_association": "CONTRIBUTOR",
    "body": "@AgeManning thanks for the quick reply. I would like to pick this one up if there is no blocker.\r\n\r\n**Edit:**\r\n\r\nI have done some research and stumbled upon \r\n```pub fn multiple_responses(&self) -> bool {\r\n        match self {\r\n            RPCRequest::Status(_) => false,\r\n            RPCRequest::Goodbye(_) => false,\r\n            RPCRequest::BlocksByRange(_) => true,\r\n            RPCRequest::BlocksByRoot(_) => true,\r\n            RPCRequest::Ping(_) => false,\r\n            RPCRequest::MetaData(_) => false,\r\n        }\r\n    }\r\n```\r\nwhich seems to be implemented twice: `rpc/protocol.rs` and `rpc/methods.rs`.\r\n\r\nThis function should be enough to take care of the single chunk responses, correct?\r\n\r\nThe question that remains then:  What to do about `BlocksByRange` and `BlocksByRoot`.\r\n\r\nShould the maximum amount of `response chunks` that are allowed per stream be hardcoded?\r\n\r\nShould it be calculated based on the current `block number` and the latest one included in the `response chunk` -> `current_block - block_in_response`?\r\n\r\nIn the discord the idea came up to deprioritize the stream after a certain amount of `chunks` to stay responsive for other RPC calls. I am not sure how relevant this is given the asynchronous runtime in the background. Should it not be able to stay responsive anyway?\r\n\r\nSo I am a bit confused as to when a stream is considered failed.\r\n\r\n\r\nAlso should the check be done at https://github.com/sigp/lighthouse/blob/master/beacon_node/eth2-libp2p/src/rpc/handler.rs#L664?",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/624123821/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/624398188",
    "html_url": "https://github.com/sigp/lighthouse/issues/754#issuecomment-624398188",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/754",
    "id": 624398188,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyNDM5ODE4OA==",
    "user": {
      "login": "AgeManning",
      "id": 7454587,
      "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AgeManning",
      "html_url": "https://github.com/AgeManning",
      "followers_url": "https://api.github.com/users/AgeManning/followers",
      "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
      "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
      "organizations_url": "https://api.github.com/users/AgeManning/orgs",
      "repos_url": "https://api.github.com/users/AgeManning/repos",
      "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AgeManning/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-06T01:32:22Z",
    "updated_at": "2020-05-06T01:32:22Z",
    "author_association": "MEMBER",
    "body": "Hey, let me explain this issue a bit more. \r\nIn the discord, there are two ideas which are two distinct issues here. The first is preventing a peer from continuously sending data for ever (eventually the data sent will be invalid and we will kick the peer, but it would be nice to stop the data based on the request we sent). This is this issue. The rate limiting and prioritising streams is dealt with in #1056. \r\n\r\nFor this issue. Given a request, for example a BlocksByRange request of 20 blocks, we want to end or close the stream after we have received 20 chunks. For a blocks by root, if we request 3 blocks we want to end the stream after a 3 chunks have been received. RPC requests that don't expect multiple responses are already handled. \r\n\r\nNow in terms of the code, the RPCRequest should only be implemented in protocol.rs no in methods. The Response variant is in `methods` there is a reason for this, but I won't go into it here. \r\n\r\nSo when we create a request, if the peer supports the protocol and everything all good with the connection, we create an outbound_substream [here](https://github.com/sigp/lighthouse/blob/master/beacon_node/eth2-libp2p/src/rpc/handler.rs#L310)\r\n\r\nWe create an `outbound_substream` which is an object that implements `Stream` and `Sink`. We store it in a mapping by its ID, along with a key for when it should expire and the protocol its based on. See [here](https://github.com/sigp/lighthouse/blob/master/beacon_node/eth2-libp2p/src/rpc/handler.rs#L353)\r\n\r\nFor this issue, along with the protocol and delay key we may want to store number of chunks responded. So that as we receive chunks we increment the count until the maximum is reached and then we end the stream. As the request is stored along with the substream state, we can use the request to determine what the number of expected responses should be. \r\n\r\nA response from the stream appears [here](https://github.com/sigp/lighthouse/blob/master/beacon_node/eth2-libp2p/src/rpc/handler.rs#L663)\r\n\r\nI imagine here we can increment the number of chunks received and we can use the available request in this part to determine if we have received the maximum or expected number of chunks. If so transition the stream to the closing state. \r\n\r\nHopefully this sheds some light on the issue and the surrounding code. \r\n\r\nThere is a caveat in that the handler has been modified quite a bit in the `stable-futures` branch. If at all possible, have a look at that branch as I'll be fixing it up and merging down ideally this week. \r\nIt doesn't compile just yet, but will give you an idea of the structure (it still needs a bit of cleaning)\r\n\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/624398188/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/627622458",
    "html_url": "https://github.com/sigp/lighthouse/issues/754#issuecomment-627622458",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/754",
    "id": 627622458,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyNzYyMjQ1OA==",
    "user": {
      "login": "divagant-martian",
      "id": 26765164,
      "node_id": "MDQ6VXNlcjI2NzY1MTY0",
      "avatar_url": "https://avatars.githubusercontent.com/u/26765164?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/divagant-martian",
      "html_url": "https://github.com/divagant-martian",
      "followers_url": "https://api.github.com/users/divagant-martian/followers",
      "following_url": "https://api.github.com/users/divagant-martian/following{/other_user}",
      "gists_url": "https://api.github.com/users/divagant-martian/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/divagant-martian/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/divagant-martian/subscriptions",
      "organizations_url": "https://api.github.com/users/divagant-martian/orgs",
      "repos_url": "https://api.github.com/users/divagant-martian/repos",
      "events_url": "https://api.github.com/users/divagant-martian/events{/privacy}",
      "received_events_url": "https://api.github.com/users/divagant-martian/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-12T22:02:52Z",
    "updated_at": "2020-05-12T22:02:52Z",
    "author_association": "CONTRIBUTOR",
    "body": "Isn't this the same as / included in #909?",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/627622458/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/630132193",
    "html_url": "https://github.com/sigp/lighthouse/issues/754#issuecomment-630132193",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/754",
    "id": 630132193,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYzMDEzMjE5Mw==",
    "user": {
      "login": "AgeManning",
      "id": 7454587,
      "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AgeManning",
      "html_url": "https://github.com/AgeManning",
      "followers_url": "https://api.github.com/users/AgeManning/followers",
      "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
      "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
      "organizations_url": "https://api.github.com/users/AgeManning/orgs",
      "repos_url": "https://api.github.com/users/AgeManning/repos",
      "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AgeManning/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-18T11:56:19Z",
    "updated_at": "2020-05-18T11:56:19Z",
    "author_association": "MEMBER",
    "body": "Resolved in #1126 ",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/630132193/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
