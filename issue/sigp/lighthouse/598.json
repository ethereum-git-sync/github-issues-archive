{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/598",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/598/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/598/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/598/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/598",
  "id": 520735380,
  "node_id": "MDU6SXNzdWU1MjA3MzUzODA=",
  "number": 598,
  "title": "Optimise calculation of proposer indices",
  "user": {
    "login": "michaelsproul",
    "id": 4452260,
    "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/michaelsproul",
    "html_url": "https://github.com/michaelsproul",
    "followers_url": "https://api.github.com/users/michaelsproul/followers",
    "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
    "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
    "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
    "repos_url": "https://api.github.com/users/michaelsproul/repos",
    "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
    "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1999784343,
      "node_id": "MDU6TGFiZWwxOTk5Nzg0MzQz",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/optimization",
      "name": "optimization",
      "color": "f9de40",
      "default": false,
      "description": "Something to make Lighthouse run more efficiently."
    },
    {
      "id": 2034355093,
      "node_id": "MDU6TGFiZWwyMDM0MzU1MDkz",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/consensus",
      "name": "consensus",
      "color": "5e59bf",
      "default": false,
      "description": "An issue/PR that touches consensus code, such as state_processing or block verification."
    },
    {
      "id": 2490305065,
      "node_id": "MDU6TGFiZWwyNDkwMzA1MDY1",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/A1",
      "name": "A1",
      "color": "223184",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2019-11-11T04:36:42Z",
  "updated_at": "2022-11-09T05:03:45Z",
  "closed_at": null,
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nIn v0.9 of the spec, proposer selection was changed so that it depends on a _per slot_ shuffling of the active validators. This invalidates any attempt to use the existing committee cache to compute the proposer, but doesn't rule out doing something else clever.\r\n\r\nThe relevant functions in the spec are [`get_beacon_proposer_index`](https://github.com/ethereum/eth2.0-specs/blob/v0.9.1/specs/core/0_beacon-chain.md#get_beacon_proposer_index) and [`compute_proposer_index`](https://github.com/ethereum/eth2.0-specs/blob/v0.9.1/specs/core/0_beacon-chain.md#compute_proposer_index).\r\n\r\n## Present Behaviour\r\n\r\nWith https://github.com/sigp/lighthouse/pull/597, I've taken the simplest approach of recomputing the (ordered) active validators and their shuffling each time the beacon proposer for a slot is requested.\r\n\r\n## Proposed Behaviour\r\n\r\nWe could construct a cache of proposer indices _at the start of each epoch_. This would look like a `Vec<u64>` of length `SLOTS_PER_EPOCH`, that contains the Beacon proposer index for each slot of the epoch at vec index `slot % SLOTS_PER_EPOCH`.\r\n\r\nWe are able to compute this cache because the selection of proposers depends upon:\r\n\r\n* The list of active validators, which is fixed for the duration of the epoch\r\n* The seed, which we know a whole epoch in advance, and the slot number (which is predictable), i.e. we can easily calculate: `hash(get_seed(state, epoch, DOMAIN_BEACON_PROPOSER) + int_to_bytes(slot, length=8))` for all slots in the epoch.\r\n* The effective balances of the active validators, which are only updated in the `process_final_updates` function as part of an epoch transition, and are therefore stable for the entirety of the epoch. Unlike the committee cache which we can compute a full epoch in advance, the dependence on the effective balances (which change right up to the end of the previous epoch), prevents us from computing the proposer index cache until we transition into the current epoch.\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/598/reactions",
    "total_count": 2,
    "+1": 2,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/598/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/552290168",
    "html_url": "https://github.com/sigp/lighthouse/issues/598#issuecomment-552290168",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/598",
    "id": 552290168,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU1MjI5MDE2OA==",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-11-11T04:37:42Z",
    "updated_at": "2019-11-11T04:37:42Z",
    "author_association": "MEMBER",
    "body": "Blocked on merging of v0.9 into master: https://github.com/sigp/lighthouse/pull/597",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/552290168/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/593194342",
    "html_url": "https://github.com/sigp/lighthouse/issues/598#issuecomment-593194342",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/598",
    "id": 593194342,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU5MzE5NDM0Mg==",
    "user": {
      "login": "paulhauner",
      "id": 6660660,
      "node_id": "MDQ6VXNlcjY2NjA2NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/paulhauner",
      "html_url": "https://github.com/paulhauner",
      "followers_url": "https://api.github.com/users/paulhauner/followers",
      "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
      "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
      "organizations_url": "https://api.github.com/users/paulhauner/orgs",
      "repos_url": "https://api.github.com/users/paulhauner/repos",
      "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/paulhauner/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-03-02T02:47:12Z",
    "updated_at": "2020-03-02T02:47:12Z",
    "author_association": "MEMBER",
    "body": "Hey @michaelsproul is this still relevant?",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/593194342/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/593716224",
    "html_url": "https://github.com/sigp/lighthouse/issues/598#issuecomment-593716224",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/598",
    "id": 593716224,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU5MzcxNjIyNA==",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-03-03T01:18:23Z",
    "updated_at": "2020-03-03T01:18:23Z",
    "author_association": "MEMBER",
    "body": "I'd concluded that it wasn't really worth doing, because the calculation of a single proposer index doesn't seem to take that long. But I will confirm this suspicion with a benchmark on 100k validators (I think last I looked was with 16k validators)",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/593716224/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/644550375",
    "html_url": "https://github.com/sigp/lighthouse/issues/598#issuecomment-644550375",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/598",
    "id": 644550375,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY0NDU1MDM3NQ==",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-06-16T06:03:46Z",
    "updated_at": "2020-06-16T06:03:46Z",
    "author_association": "MEMBER",
    "body": "I did some benchmarks\r\n\r\n* 16k validators: `get_beacon_proposer_index` takes 0.26ms, compare:\r\n    + block processing with signature verification: 183ms (0.14%)\r\n    + block processing without sigs: 2.83ms (9.18%)\r\n* 300k validators: `get_beacon_proposer_index` takes 3.26ms, compare:\r\n    + block processing with signature verification: 186ms (1.75%)\r\n    + block processing without sigs: 7.51ms (43.4%)\r\n\r\nNoting that we currently do two proposer calculations per block processed, the calls to `get_beacon_proposer_index` potentially represent ~85% of no-sig block processing! Given that we use these sorts of block replays for states fetched from disk, cutting this time down could be a potentially fruitful area for further optimisation (but one I don't feel like pursuing right now).\r\n\r\n(all benchmarks run using mainnet spec, `average_block`)",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/644550375/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/645065120",
    "html_url": "https://github.com/sigp/lighthouse/issues/598#issuecomment-645065120",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/598",
    "id": 645065120,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY0NTA2NTEyMA==",
    "user": {
      "login": "paulhauner",
      "id": 6660660,
      "node_id": "MDQ6VXNlcjY2NjA2NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/paulhauner",
      "html_url": "https://github.com/paulhauner",
      "followers_url": "https://api.github.com/users/paulhauner/followers",
      "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
      "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
      "organizations_url": "https://api.github.com/users/paulhauner/orgs",
      "repos_url": "https://api.github.com/users/paulhauner/repos",
      "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/paulhauner/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-06-16T23:40:23Z",
    "updated_at": "2020-06-16T23:40:23Z",
    "author_association": "MEMBER",
    "body": "> Noting that we currently do two proposer calculations per block processed, the calls to get_beacon_proposer_index potentially represent ~85% of no-sig block processing!\r\n\r\nGreat find! Good to know we have this up our sleeve!",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/645065120/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
