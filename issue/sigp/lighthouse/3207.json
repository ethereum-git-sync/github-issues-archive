{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/3207",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/3207/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/3207/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/3207/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/3207",
  "id": 1244885315,
  "node_id": "I_kwDOCFeAzc5KM3FD",
  "number": 3207,
  "title": "Beacon data directory grows indefinitely",
  "user": {
    "login": "jmcruz1983",
    "id": 15966694,
    "node_id": "MDQ6VXNlcjE1OTY2Njk0",
    "avatar_url": "https://avatars.githubusercontent.com/u/15966694?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jmcruz1983",
    "html_url": "https://github.com/jmcruz1983",
    "followers_url": "https://api.github.com/users/jmcruz1983/followers",
    "following_url": "https://api.github.com/users/jmcruz1983/following{/other_user}",
    "gists_url": "https://api.github.com/users/jmcruz1983/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jmcruz1983/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jmcruz1983/subscriptions",
    "organizations_url": "https://api.github.com/users/jmcruz1983/orgs",
    "repos_url": "https://api.github.com/users/jmcruz1983/repos",
    "events_url": "https://api.github.com/users/jmcruz1983/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jmcruz1983/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2022-05-23T09:42:25Z",
  "updated_at": "2022-05-24T01:26:46Z",
  "closed_at": "2022-05-24T01:26:46Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nRunning beacon with `--datadir=/data` and mounted that directory in a separated volume,\r\nI noticed following issue that volume keeps growing and thus I need to resize it,\r\n\r\nRunning for about 90 days already filled up 100 GiB\r\n\r\n<img width=\"1634\" alt=\"beacon\" src=\"https://user-images.githubusercontent.com/15966694/169791407-b70a05bb-a534-465d-8641-e260ee0a8e9c.png\">\r\n\r\nFrom beacon options I understand that auto-compacting database is enabled by default:\r\n\r\n```\r\nOPTIONS:\r\n        --auto-compact-db <auto-compact-db>\r\n            Enable or disable automatic compaction of the database on finalization. [default: true]\r\n```\r\n\r\n## Version\r\n\r\nVersion used is public `v2.2.1`\r\n\r\n## Conclusion\r\n\r\nIs there any recommended size for beacons `datadir`?\r\nIs auto-compacting working as expected?\r\nAny mitigation?\r\n\r\nThanks",
  "closed_by": {
    "login": "michaelsproul",
    "id": 4452260,
    "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/michaelsproul",
    "html_url": "https://github.com/michaelsproul",
    "followers_url": "https://api.github.com/users/michaelsproul/followers",
    "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
    "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
    "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
    "repos_url": "https://api.github.com/users/michaelsproul/repos",
    "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
    "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/3207/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/3207/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1134510786",
    "html_url": "https://github.com/sigp/lighthouse/issues/3207#issuecomment-1134510786",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3207",
    "id": 1134510786,
    "node_id": "IC_kwDOCFeAzc5Dn0LC",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-23T10:42:26Z",
    "updated_at": "2022-05-23T10:42:26Z",
    "author_association": "MEMBER",
    "body": "Most of that space (~80GB) is consumed by the beacon blocks themselves, and there are more of them to store with each passing day. We have a few plans up our sleeve to curtail the growth:\r\n\r\n1. Apply compression to the blocks (likely a 2-4x reduction). This can be done at any time but needs to be done carefully and with a DB migration. We'll probably do it after the merge.\r\n2. Limit the storage of historical blocks (similar to EIP-4444). This is a change of the P2P protocol guarantees, and requires agreement and coordination with the other clients and the community. It will no longer be possible to sync from genesis if everybody adopts this change.\r\n3. Add a mode for running without historical states. These states aren't necessary for validating nodes, so dropping them can save around 20GB of space. This might be added as a flag before the merge, depending on time constraints.\r\n\r\nI'll open targeted issues for the 3 planned upgrades tomorrow because currently they're not on Github.\r\n\r\nAs a temporary workaround you can:\r\n\r\n1. Make sure new nodes start with checkpoint sync so that they store as few historical states as possible.\r\n2. Make sure you're using `--slots-per-restore-point 8192`, which is the default for new databases as of v2.2.0.\r\n\r\nIf you're willing to re-sync existing nodes you could get both benefits, although you'll have to download all of the historic blocks again which I know has caused issues with your setup in the past (#2904). I re-synced my own BN about two months ago and it's using 83.6GB, split 79GB for the `chain_db` (the blocks) and 4.6GB for the `freezer_db` (historic states).",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1134510786/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1134521896",
    "html_url": "https://github.com/sigp/lighthouse/issues/3207#issuecomment-1134521896",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3207",
    "id": 1134521896,
    "node_id": "IC_kwDOCFeAzc5Dn24o",
    "user": {
      "login": "jmcruz1983",
      "id": 15966694,
      "node_id": "MDQ6VXNlcjE1OTY2Njk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/15966694?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jmcruz1983",
      "html_url": "https://github.com/jmcruz1983",
      "followers_url": "https://api.github.com/users/jmcruz1983/followers",
      "following_url": "https://api.github.com/users/jmcruz1983/following{/other_user}",
      "gists_url": "https://api.github.com/users/jmcruz1983/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jmcruz1983/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jmcruz1983/subscriptions",
      "organizations_url": "https://api.github.com/users/jmcruz1983/orgs",
      "repos_url": "https://api.github.com/users/jmcruz1983/repos",
      "events_url": "https://api.github.com/users/jmcruz1983/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jmcruz1983/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-23T10:55:33Z",
    "updated_at": "2022-05-23T10:55:33Z",
    "author_association": "NONE",
    "body": "Thanks @michaelsproul for suggestions,\r\nI'll keep an eye on upcoming upgrades & feature flags,\r\n\r\nAbout checkpoint sync, we do use that one to avoid full re-sync,\r\nbut as side effect beacon node becomes bit unstable for some hours (like 24h)\r\nas it is backfilling in the background and getting CPU spikes,\r\nCan you confirm that this behaviour is still happening?\r\nThanks",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1134521896/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1134528669",
    "html_url": "https://github.com/sigp/lighthouse/issues/3207#issuecomment-1134528669",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3207",
    "id": 1134528669,
    "node_id": "IC_kwDOCFeAzc5Dn4id",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-23T11:03:22Z",
    "updated_at": "2022-05-23T11:03:22Z",
    "author_association": "MEMBER",
    "body": "> Can you confirm that this behaviour is still happening?\r\n\r\nYeah, we've had a few reports of that. We also need to open an issue for rate-limiting block backfill, thanks for the reminder!",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1134528669/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1135300304",
    "html_url": "https://github.com/sigp/lighthouse/issues/3207#issuecomment-1135300304",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3207",
    "id": 1135300304,
    "node_id": "IC_kwDOCFeAzc5Dq07Q",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-24T01:26:46Z",
    "updated_at": "2022-05-24T01:26:46Z",
    "author_association": "MEMBER",
    "body": "Ok, closing in favour of 5 new issues which I've finally put down on paper!\r\n\r\n#3212 #3211 #3210 #3209 #3208",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1135300304/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
