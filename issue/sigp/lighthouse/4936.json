{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/4936",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/4936/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/4936/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/4936/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/4936",
  "id": 2002623607,
  "node_id": "I_kwDOCFeAzc53XZx3",
  "number": 4936,
  "title": "Performance Degradation and OOM Events During API Calls to Update Validators",
  "user": {
    "login": "screwyprof",
    "id": 1536274,
    "node_id": "MDQ6VXNlcjE1MzYyNzQ=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1536274?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/screwyprof",
    "html_url": "https://github.com/screwyprof",
    "followers_url": "https://api.github.com/users/screwyprof/followers",
    "following_url": "https://api.github.com/users/screwyprof/following{/other_user}",
    "gists_url": "https://api.github.com/users/screwyprof/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/screwyprof/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/screwyprof/subscriptions",
    "organizations_url": "https://api.github.com/users/screwyprof/orgs",
    "repos_url": "https://api.github.com/users/screwyprof/repos",
    "events_url": "https://api.github.com/users/screwyprof/events{/privacy}",
    "received_events_url": "https://api.github.com/users/screwyprof/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 985647281,
      "node_id": "MDU6TGFiZWw5ODU2NDcyODE=",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/bug",
      "name": "bug",
      "color": "d73a4a",
      "default": true,
      "description": "Something isn't working"
    },
    {
      "id": 2336802021,
      "node_id": "MDU6TGFiZWwyMzM2ODAyMDIx",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/UX-and-logs",
      "name": "UX-and-logs",
      "color": "DB9046",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 11,
  "created_at": "2023-11-20T16:53:33Z",
  "updated_at": "2024-01-15T02:10:42Z",
  "closed_at": null,
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nOur Lighthouse instance grapples with a critical performance downturn when executing a batch job to update multiple validators in the local development environment. This degradation not only hinders Lighthouse's efficiency in fulfilling its validator duties but also, in numerous instances, triggers interventions from the OOM killer.  \r\n\r\n## Version\r\n\r\n- Rust Version: `1.69.0`\r\n- Production Version: `v4.4.1`\r\n- Dev Version: Latest unstable (commit: `051c3e84`)\r\n\r\n## Present Behaviour\r\n\r\nLighthouse is hampered by significant performance degradation when executing a batch job to update multiple validators in the local development environment. The symptoms include:\r\n\r\n- A noticeable slowdown in performance during the batch job execution.\r\n- Frequent interventions from the OOM killer, leading to the termination of the Lighthouse process.\r\n- Modest but consistent memory consumption growth \r\n- Errors in the logs, suggesting potential issues with the logger buffer overflow:\r\n```\r\nNov 13 21:16:43.600 ERRO slog-async: logger dropped messages due to channel overflow, count: 7\r\nNov 13 21:16:43.600 ERRO slog-async: logger dropped messages due to channel overflow, count: 5\r\nNov 13 21:16:43.600 ERRO slog-async: logger dropped messages due to channel overflow, count: 7\r\n```\r\n\r\nAttempts to capture a CPU profile pointed towards `slog`, indicating potential performance bottlenecks related to logging.\r\n\r\n## Expected Behaviour\r\n\r\nLighthouse should seamlessly update multiple validators without succumbing to notable performance degradation. The application's performance should remain optimal, and interventions from the OOM killer should be eliminated.\r\n\r\n## Steps to resolve\r\n\r\nEfforts to address the issue involved:\r\n\r\n- CPU Profiling: Attempted CPU profiling which highlighted that a significant portion of time is allocated to `async-slog`, with logging consuming 1 second out of a 10-second profile. This observation suggested potential issues with `async-slog` and correlated with the errors in the logs, indicating a logger buffer overflow\r\n- Memory Profiling: Tried to capture heap profile with `heaptrack` with no luck.\r\n- Memory Monitoring: Lighthouse's memory consumption using the `top` command, noting modest but consistent growth.\r\n- Logger Optimisation: Increased logger buffer size and removed logger calls completely at the problematic endpoint, yet still encountered persistent OOM killer interventions.\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/4936/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/4936/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1819485173",
    "html_url": "https://github.com/sigp/lighthouse/issues/4936#issuecomment-1819485173",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4936",
    "id": 1819485173,
    "node_id": "IC_kwDOCFeAzc5scyP1",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-11-20T17:12:41Z",
    "updated_at": "2023-11-20T17:12:41Z",
    "author_association": "MEMBER",
    "body": "@screwyprof Which API or command are you running exactly? Is it a bunch of calls to [`PATCH /lighthouse/validators/:voting_pubkey`](https://lighthouse-book.sigmaprime.io/api-vc-endpoints.html#patch-lighthousevalidatorsvoting_pubkey), or something else?",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1819485173/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1819810182",
    "html_url": "https://github.com/sigp/lighthouse/issues/4936#issuecomment-1819810182",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4936",
    "id": 1819810182,
    "node_id": "IC_kwDOCFeAzc5seBmG",
    "user": {
      "login": "screwyprof",
      "id": 1536274,
      "node_id": "MDQ6VXNlcjE1MzYyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1536274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/screwyprof",
      "html_url": "https://github.com/screwyprof",
      "followers_url": "https://api.github.com/users/screwyprof/followers",
      "following_url": "https://api.github.com/users/screwyprof/following{/other_user}",
      "gists_url": "https://api.github.com/users/screwyprof/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/screwyprof/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/screwyprof/subscriptions",
      "organizations_url": "https://api.github.com/users/screwyprof/orgs",
      "repos_url": "https://api.github.com/users/screwyprof/repos",
      "events_url": "https://api.github.com/users/screwyprof/events{/privacy}",
      "received_events_url": "https://api.github.com/users/screwyprof/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-11-20T21:12:10Z",
    "updated_at": "2023-11-20T21:12:10Z",
    "author_association": "CONTRIBUTOR",
    "body": "Hey @michaelsproul, yes exactly that one.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1819810182/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1819815940",
    "html_url": "https://github.com/sigp/lighthouse/issues/4936#issuecomment-1819815940",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4936",
    "id": 1819815940,
    "node_id": "IC_kwDOCFeAzc5seDAE",
    "user": {
      "login": "screwyprof",
      "id": 1536274,
      "node_id": "MDQ6VXNlcjE1MzYyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1536274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/screwyprof",
      "html_url": "https://github.com/screwyprof",
      "followers_url": "https://api.github.com/users/screwyprof/followers",
      "following_url": "https://api.github.com/users/screwyprof/following{/other_user}",
      "gists_url": "https://api.github.com/users/screwyprof/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/screwyprof/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/screwyprof/subscriptions",
      "organizations_url": "https://api.github.com/users/screwyprof/orgs",
      "repos_url": "https://api.github.com/users/screwyprof/repos",
      "events_url": "https://api.github.com/users/screwyprof/events{/privacy}",
      "received_events_url": "https://api.github.com/users/screwyprof/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-11-20T21:16:44Z",
    "updated_at": "2023-11-20T21:16:44Z",
    "author_association": "CONTRIBUTOR",
    "body": "Also, if it helps we are using web3signer definitions and I can see slog errors at the bootstrap when loading a lot of definitions.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1819815940/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1820667257",
    "html_url": "https://github.com/sigp/lighthouse/issues/4936#issuecomment-1820667257",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4936",
    "id": 1820667257,
    "node_id": "IC_kwDOCFeAzc5shS15",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-11-21T10:43:49Z",
    "updated_at": "2023-11-21T10:43:49Z",
    "author_association": "MEMBER",
    "body": "Thanks @screwyprof. Just a couple more questions to help us narrow it down and reproduce:\r\n\r\n1. How many _concurrent_ requests do you make at any given time? Do you have a thread pool of a fixed size or anything that would constrain the number of parallel requests?\r\n2. How many _total_ requests do you make per batch/period, e.g. 500 in 12s, etc.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1820667257/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1820860343",
    "html_url": "https://github.com/sigp/lighthouse/issues/4936#issuecomment-1820860343",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4936",
    "id": 1820860343,
    "node_id": "IC_kwDOCFeAzc5siB-3",
    "user": {
      "login": "screwyprof",
      "id": 1536274,
      "node_id": "MDQ6VXNlcjE1MzYyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1536274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/screwyprof",
      "html_url": "https://github.com/screwyprof",
      "followers_url": "https://api.github.com/users/screwyprof/followers",
      "following_url": "https://api.github.com/users/screwyprof/following{/other_user}",
      "gists_url": "https://api.github.com/users/screwyprof/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/screwyprof/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/screwyprof/subscriptions",
      "organizations_url": "https://api.github.com/users/screwyprof/orgs",
      "repos_url": "https://api.github.com/users/screwyprof/repos",
      "events_url": "https://api.github.com/users/screwyprof/events{/privacy}",
      "received_events_url": "https://api.github.com/users/screwyprof/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-11-21T12:46:38Z",
    "updated_at": "2023-11-21T12:46:38Z",
    "author_association": "CONTRIBUTOR",
    "body": "Hey @michaelsproul. \r\n\r\n1. We donâ€™t do any concurrent requests, they run sequentially.\r\n2. I was able to reproduce the problem by crafting a bash script which called the API endpoint to disable the same validator in a loop. The problem occurred randomly sometimes with 300 iterations total, sometimes earlier, sometimes after 500.\r\n\r\nin our prod environment we would expect to update on average 2,500 validators with peaks at 5,000 once per epoch.\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1820860343/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1884698819",
    "html_url": "https://github.com/sigp/lighthouse/issues/4936#issuecomment-1884698819",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4936",
    "id": 1884698819,
    "node_id": "IC_kwDOCFeAzc5wVjjD",
    "user": {
      "login": "jmcruz1983",
      "id": 15966694,
      "node_id": "MDQ6VXNlcjE1OTY2Njk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/15966694?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jmcruz1983",
      "html_url": "https://github.com/jmcruz1983",
      "followers_url": "https://api.github.com/users/jmcruz1983/followers",
      "following_url": "https://api.github.com/users/jmcruz1983/following{/other_user}",
      "gists_url": "https://api.github.com/users/jmcruz1983/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jmcruz1983/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jmcruz1983/subscriptions",
      "organizations_url": "https://api.github.com/users/jmcruz1983/orgs",
      "repos_url": "https://api.github.com/users/jmcruz1983/repos",
      "events_url": "https://api.github.com/users/jmcruz1983/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jmcruz1983/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2024-01-10T11:47:14Z",
    "updated_at": "2024-01-10T11:47:14Z",
    "author_association": "NONE",
    "body": "Hey @michaelsproul any update for this matter?",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1884698819/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1884706969",
    "html_url": "https://github.com/sigp/lighthouse/issues/4936#issuecomment-1884706969",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4936",
    "id": 1884706969,
    "node_id": "IC_kwDOCFeAzc5wVliZ",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2024-01-10T11:53:07Z",
    "updated_at": "2024-01-10T11:53:07Z",
    "author_association": "MEMBER",
    "body": "Hey @jmcruz1983 haven't had a chance to repro yet, we're pushing a (big) v4.6.0-rc.0 release at the moment. Will try to get some time this week",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1884706969/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1886354414",
    "html_url": "https://github.com/sigp/lighthouse/issues/4936#issuecomment-1886354414",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4936",
    "id": 1886354414,
    "node_id": "IC_kwDOCFeAzc5wb3vu",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2024-01-11T06:09:47Z",
    "updated_at": "2024-01-11T06:09:47Z",
    "author_association": "MEMBER",
    "body": "I had a bit of time to try this today, spun up a VC with 500 inactive keys and spammed 1000x PATCH messages at it. No luck. Everything was fine. The highest memory consumption was 300MB.\r\n\r\nI'll try tomorrow on a VC with active keys, and failing that, a VC with active web3signer keys (I don't think it's likely to be specific to web3signer, but it could be).",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1886354414/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1888483983",
    "html_url": "https://github.com/sigp/lighthouse/issues/4936#issuecomment-1888483983",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4936",
    "id": 1888483983,
    "node_id": "IC_kwDOCFeAzc5wj_qP",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2024-01-12T06:01:46Z",
    "updated_at": "2024-01-12T06:02:36Z",
    "author_association": "MEMBER",
    "body": "I didn't manage to repro the OOM, but I can see CPU usage spiking on a validator with 1000 keys. I've started optimising the \"no-op\" PATCH requests, because they should be easy to catch. Am I correct in thinking that a substantial number of PATCH requests you make are redundant, i.e. should already be reflected in the VC's state? e.g. disabling a validator that is already disabled, setting the fee recipient to the same value that it's already set to.\r\n\r\nIf so, the no-op optimisations will help (I'll have a branch for you soon). If not, we'll need to do some more involved refactoring and optimising of the key cache, which is a bit of a beast.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1888483983/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1889583431",
    "html_url": "https://github.com/sigp/lighthouse/issues/4936#issuecomment-1889583431",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4936",
    "id": 1889583431,
    "node_id": "IC_kwDOCFeAzc5woMFH",
    "user": {
      "login": "screwyprof",
      "id": 1536274,
      "node_id": "MDQ6VXNlcjE1MzYyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1536274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/screwyprof",
      "html_url": "https://github.com/screwyprof",
      "followers_url": "https://api.github.com/users/screwyprof/followers",
      "following_url": "https://api.github.com/users/screwyprof/following{/other_user}",
      "gists_url": "https://api.github.com/users/screwyprof/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/screwyprof/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/screwyprof/subscriptions",
      "organizations_url": "https://api.github.com/users/screwyprof/orgs",
      "repos_url": "https://api.github.com/users/screwyprof/repos",
      "events_url": "https://api.github.com/users/screwyprof/events{/privacy}",
      "received_events_url": "https://api.github.com/users/screwyprof/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2024-01-12T16:14:51Z",
    "updated_at": "2024-01-12T16:15:02Z",
    "author_association": "CONTRIBUTOR",
    "body": "Hi @michaelsproul,\r\n\r\n> Am I correct in thinking that a substantial number of PATCH requests you make are redundant, i.e. should already be reflected in the VC's state? e.g. disabling a validator that is already disabled, setting the fee recipient to the same value that it's already set to.\r\n\r\nYes, this could well be the case. The problem is lighthouse does not provide a GET endpoint to get the state of builder relays in batches (like teku does for example) so that we could only send the changed values.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1889583431/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1891195059",
    "html_url": "https://github.com/sigp/lighthouse/issues/4936#issuecomment-1891195059",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4936",
    "id": 1891195059,
    "node_id": "IC_kwDOCFeAzc5wuViz",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2024-01-15T02:10:41Z",
    "updated_at": "2024-01-15T02:10:41Z",
    "author_association": "MEMBER",
    "body": "@screwyprof Great, this patch should help then: https://github.com/sigp/lighthouse/pull/5064\r\n\r\nIf you could run that for a bit on your testnet infra and let us know how it goes, that would be really helpful.\r\n\r\nLonger term we'll also look at optimising the API further. We could also add a GET endpoint, although the load on the VC after this patch should be pretty similar to the load required to serve a get endpoint.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1891195059/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
