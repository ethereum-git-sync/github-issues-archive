{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/4936",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/4936/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/4936/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/4936/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/4936",
  "id": 2002623607,
  "node_id": "I_kwDOCFeAzc53XZx3",
  "number": 4936,
  "title": "Performance Degradation and OOM Events During API Calls to Update Validators",
  "user": {
    "login": "screwyprof",
    "id": 1536274,
    "node_id": "MDQ6VXNlcjE1MzYyNzQ=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1536274?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/screwyprof",
    "html_url": "https://github.com/screwyprof",
    "followers_url": "https://api.github.com/users/screwyprof/followers",
    "following_url": "https://api.github.com/users/screwyprof/following{/other_user}",
    "gists_url": "https://api.github.com/users/screwyprof/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/screwyprof/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/screwyprof/subscriptions",
    "organizations_url": "https://api.github.com/users/screwyprof/orgs",
    "repos_url": "https://api.github.com/users/screwyprof/repos",
    "events_url": "https://api.github.com/users/screwyprof/events{/privacy}",
    "received_events_url": "https://api.github.com/users/screwyprof/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 985647281,
      "node_id": "MDU6TGFiZWw5ODU2NDcyODE=",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/bug",
      "name": "bug",
      "color": "d73a4a",
      "default": true,
      "description": "Something isn't working"
    },
    {
      "id": 2336802021,
      "node_id": "MDU6TGFiZWwyMzM2ODAyMDIx",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/UX-and-logs",
      "name": "UX-and-logs",
      "color": "DB9046",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2023-11-20T16:53:33Z",
  "updated_at": "2023-11-21T12:46:38Z",
  "closed_at": null,
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nOur Lighthouse instance grapples with a critical performance downturn when executing a batch job to update multiple validators in the local development environment. This degradation not only hinders Lighthouse's efficiency in fulfilling its validator duties but also, in numerous instances, triggers interventions from the OOM killer.  \r\n\r\n## Version\r\n\r\n- Rust Version: `1.69.0`\r\n- Production Version: `v4.4.1`\r\n- Dev Version: Latest unstable (commit: `051c3e84`)\r\n\r\n## Present Behaviour\r\n\r\nLighthouse is hampered by significant performance degradation when executing a batch job to update multiple validators in the local development environment. The symptoms include:\r\n\r\n- A noticeable slowdown in performance during the batch job execution.\r\n- Frequent interventions from the OOM killer, leading to the termination of the Lighthouse process.\r\n- Modest but consistent memory consumption growth \r\n- Errors in the logs, suggesting potential issues with the logger buffer overflow:\r\n```\r\nNov 13 21:16:43.600 ERRO slog-async: logger dropped messages due to channel overflow, count: 7\r\nNov 13 21:16:43.600 ERRO slog-async: logger dropped messages due to channel overflow, count: 5\r\nNov 13 21:16:43.600 ERRO slog-async: logger dropped messages due to channel overflow, count: 7\r\n```\r\n\r\nAttempts to capture a CPU profile pointed towards `slog`, indicating potential performance bottlenecks related to logging.\r\n\r\n## Expected Behaviour\r\n\r\nLighthouse should seamlessly update multiple validators without succumbing to notable performance degradation. The application's performance should remain optimal, and interventions from the OOM killer should be eliminated.\r\n\r\n## Steps to resolve\r\n\r\nEfforts to address the issue involved:\r\n\r\n- CPU Profiling: Attempted CPU profiling which highlighted that a significant portion of time is allocated to `async-slog`, with logging consuming 1 second out of a 10-second profile. This observation suggested potential issues with `async-slog` and correlated with the errors in the logs, indicating a logger buffer overflow\r\n- Memory Profiling: Tried to capture heap profile with `heaptrack` with no luck.\r\n- Memory Monitoring: Lighthouse's memory consumption using the `top` command, noting modest but consistent growth.\r\n- Logger Optimisation: Increased logger buffer size and removed logger calls completely at the problematic endpoint, yet still encountered persistent OOM killer interventions.\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/4936/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/4936/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1819485173",
    "html_url": "https://github.com/sigp/lighthouse/issues/4936#issuecomment-1819485173",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4936",
    "id": 1819485173,
    "node_id": "IC_kwDOCFeAzc5scyP1",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-11-20T17:12:41Z",
    "updated_at": "2023-11-20T17:12:41Z",
    "author_association": "MEMBER",
    "body": "@screwyprof Which API or command are you running exactly? Is it a bunch of calls to [`PATCH /lighthouse/validators/:voting_pubkey`](https://lighthouse-book.sigmaprime.io/api-vc-endpoints.html#patch-lighthousevalidatorsvoting_pubkey), or something else?",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1819485173/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1819810182",
    "html_url": "https://github.com/sigp/lighthouse/issues/4936#issuecomment-1819810182",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4936",
    "id": 1819810182,
    "node_id": "IC_kwDOCFeAzc5seBmG",
    "user": {
      "login": "screwyprof",
      "id": 1536274,
      "node_id": "MDQ6VXNlcjE1MzYyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1536274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/screwyprof",
      "html_url": "https://github.com/screwyprof",
      "followers_url": "https://api.github.com/users/screwyprof/followers",
      "following_url": "https://api.github.com/users/screwyprof/following{/other_user}",
      "gists_url": "https://api.github.com/users/screwyprof/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/screwyprof/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/screwyprof/subscriptions",
      "organizations_url": "https://api.github.com/users/screwyprof/orgs",
      "repos_url": "https://api.github.com/users/screwyprof/repos",
      "events_url": "https://api.github.com/users/screwyprof/events{/privacy}",
      "received_events_url": "https://api.github.com/users/screwyprof/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-11-20T21:12:10Z",
    "updated_at": "2023-11-20T21:12:10Z",
    "author_association": "CONTRIBUTOR",
    "body": "Hey @michaelsproul, yes exactly that one.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1819810182/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1819815940",
    "html_url": "https://github.com/sigp/lighthouse/issues/4936#issuecomment-1819815940",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4936",
    "id": 1819815940,
    "node_id": "IC_kwDOCFeAzc5seDAE",
    "user": {
      "login": "screwyprof",
      "id": 1536274,
      "node_id": "MDQ6VXNlcjE1MzYyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1536274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/screwyprof",
      "html_url": "https://github.com/screwyprof",
      "followers_url": "https://api.github.com/users/screwyprof/followers",
      "following_url": "https://api.github.com/users/screwyprof/following{/other_user}",
      "gists_url": "https://api.github.com/users/screwyprof/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/screwyprof/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/screwyprof/subscriptions",
      "organizations_url": "https://api.github.com/users/screwyprof/orgs",
      "repos_url": "https://api.github.com/users/screwyprof/repos",
      "events_url": "https://api.github.com/users/screwyprof/events{/privacy}",
      "received_events_url": "https://api.github.com/users/screwyprof/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-11-20T21:16:44Z",
    "updated_at": "2023-11-20T21:16:44Z",
    "author_association": "CONTRIBUTOR",
    "body": "Also, if it helps we are using web3signer definitions and I can see slog errors at the bootstrap when loading a lot of definitions.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1819815940/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1820667257",
    "html_url": "https://github.com/sigp/lighthouse/issues/4936#issuecomment-1820667257",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4936",
    "id": 1820667257,
    "node_id": "IC_kwDOCFeAzc5shS15",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-11-21T10:43:49Z",
    "updated_at": "2023-11-21T10:43:49Z",
    "author_association": "MEMBER",
    "body": "Thanks @screwyprof. Just a couple more questions to help us narrow it down and reproduce:\r\n\r\n1. How many _concurrent_ requests do you make at any given time? Do you have a thread pool of a fixed size or anything that would constrain the number of parallel requests?\r\n2. How many _total_ requests do you make per batch/period, e.g. 500 in 12s, etc.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1820667257/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1820860343",
    "html_url": "https://github.com/sigp/lighthouse/issues/4936#issuecomment-1820860343",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4936",
    "id": 1820860343,
    "node_id": "IC_kwDOCFeAzc5siB-3",
    "user": {
      "login": "screwyprof",
      "id": 1536274,
      "node_id": "MDQ6VXNlcjE1MzYyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1536274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/screwyprof",
      "html_url": "https://github.com/screwyprof",
      "followers_url": "https://api.github.com/users/screwyprof/followers",
      "following_url": "https://api.github.com/users/screwyprof/following{/other_user}",
      "gists_url": "https://api.github.com/users/screwyprof/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/screwyprof/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/screwyprof/subscriptions",
      "organizations_url": "https://api.github.com/users/screwyprof/orgs",
      "repos_url": "https://api.github.com/users/screwyprof/repos",
      "events_url": "https://api.github.com/users/screwyprof/events{/privacy}",
      "received_events_url": "https://api.github.com/users/screwyprof/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-11-21T12:46:38Z",
    "updated_at": "2023-11-21T12:46:38Z",
    "author_association": "CONTRIBUTOR",
    "body": "Hey @michaelsproul. \r\n\r\n1. We don’t do any concurrent requests, they run sequentially.\r\n2. I was able to reproduce the problem by crafting a bash script which called the API endpoint to disable the same validator in a loop. The problem occurred randomly sometimes with 300 iterations total, sometimes earlier, sometimes after 500.\r\n\r\nin our prod environment we would expect to update on average 2,500 validators with peaks at 5,000 once per epoch.\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1820860343/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
