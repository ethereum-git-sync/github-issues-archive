{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/581",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/581/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/581/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/581/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/581",
  "id": 514327624,
  "node_id": "MDU6SXNzdWU1MTQzMjc2MjQ=",
  "number": 581,
  "title": "Support Snappy compression to the RPC",
  "user": {
    "login": "AgeManning",
    "id": 7454587,
    "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/AgeManning",
    "html_url": "https://github.com/AgeManning",
    "followers_url": "https://api.github.com/users/AgeManning/followers",
    "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
    "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
    "organizations_url": "https://api.github.com/users/AgeManning/orgs",
    "repos_url": "https://api.github.com/users/AgeManning/repos",
    "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
    "received_events_url": "https://api.github.com/users/AgeManning/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 2336800125,
      "node_id": "MDU6TGFiZWwyMzM2ODAwMTI1",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/t%20Networking",
      "name": "t Networking",
      "color": "40E0D0",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": {
    "url": "https://api.github.com/repos/sigp/lighthouse/milestones/1",
    "html_url": "https://github.com/sigp/lighthouse/milestone/1",
    "labels_url": "https://api.github.com/repos/sigp/lighthouse/milestones/1/labels",
    "id": 4797099,
    "node_id": "MDk6TWlsZXN0b25lNDc5NzA5OQ==",
    "number": 1,
    "title": "mainnet",
    "description": null,
    "creator": {
      "login": "AgeManning",
      "id": 7454587,
      "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AgeManning",
      "html_url": "https://github.com/AgeManning",
      "followers_url": "https://api.github.com/users/AgeManning/followers",
      "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
      "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
      "organizations_url": "https://api.github.com/users/AgeManning/orgs",
      "repos_url": "https://api.github.com/users/AgeManning/repos",
      "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AgeManning/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 0,
    "closed_issues": 5,
    "state": "open",
    "created_at": "2019-10-30T01:06:34Z",
    "updated_at": "2020-07-20T06:07:20Z",
    "due_on": null,
    "closed_at": null
  },
  "comments": 5,
  "created_at": "2019-10-30T01:06:42Z",
  "updated_at": "2022-10-20T17:14:13Z",
  "closed_at": "2020-04-14T05:15:43Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nSnappy compression needs to be added to the Eth2 rpc as specified in the [networking specification](https://github.com/ethereum/eth2.0-specs/blob/dev/specs/networking/p2p-interface.md). \r\n\r\nThis involves adding the extra protocol ids and prioritising the compression protocols over their non-compressed counter-parts.",
  "closed_by": {
    "login": "AgeManning",
    "id": 7454587,
    "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/AgeManning",
    "html_url": "https://github.com/AgeManning",
    "followers_url": "https://api.github.com/users/AgeManning/followers",
    "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
    "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
    "organizations_url": "https://api.github.com/users/AgeManning/orgs",
    "repos_url": "https://api.github.com/users/AgeManning/repos",
    "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
    "received_events_url": "https://api.github.com/users/AgeManning/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/581/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/581/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/549026255",
    "html_url": "https://github.com/sigp/lighthouse/issues/581#issuecomment-549026255",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/581",
    "id": 549026255,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU0OTAyNjI1NQ==",
    "user": {
      "login": "b-m-f",
      "id": 2843450,
      "node_id": "MDQ6VXNlcjI4NDM0NTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2843450?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/b-m-f",
      "html_url": "https://github.com/b-m-f",
      "followers_url": "https://api.github.com/users/b-m-f/followers",
      "following_url": "https://api.github.com/users/b-m-f/following{/other_user}",
      "gists_url": "https://api.github.com/users/b-m-f/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/b-m-f/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/b-m-f/subscriptions",
      "organizations_url": "https://api.github.com/users/b-m-f/orgs",
      "repos_url": "https://api.github.com/users/b-m-f/repos",
      "events_url": "https://api.github.com/users/b-m-f/events{/privacy}",
      "received_events_url": "https://api.github.com/users/b-m-f/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-11-02T09:18:25Z",
    "updated_at": "2019-11-02T09:19:05Z",
    "author_association": "CONTRIBUTOR",
    "body": "I identified https://github.com/sigp/lighthouse/blob/9aedb12bfc092be95880cdbe4500a1c7768ff2d5/beacon_node/network/src/service.rs#L176 as a place to apply the compression.\r\n\r\nEvery message that is published will then be snappy compressed. If you agree Id open up a PR using the rust-snappy crate for the algorithm",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/549026255/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/549098080",
    "html_url": "https://github.com/sigp/lighthouse/issues/581#issuecomment-549098080",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/581",
    "id": 549098080,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU0OTA5ODA4MA==",
    "user": {
      "login": "AgeManning",
      "id": 7454587,
      "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AgeManning",
      "html_url": "https://github.com/AgeManning",
      "followers_url": "https://api.github.com/users/AgeManning/followers",
      "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
      "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
      "organizations_url": "https://api.github.com/users/AgeManning/orgs",
      "repos_url": "https://api.github.com/users/AgeManning/repos",
      "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AgeManning/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-11-03T02:10:12Z",
    "updated_at": "2019-11-03T02:10:12Z",
    "author_association": "MEMBER",
    "body": "For the compression, we need to support a new `ProtocolId`. \r\n\r\nWe are using libp2p, essentially, how this works, is clients support a number of strings called `ProtocolId`s. Libp2p, based on the supported strings a client supports, will negotiate a protocol to communicate over. \r\n\r\nThe [Req/Resp](https://github.com/ethereum/eth2.0-specs/blob/dev/specs/networking/p2p-interface.md#the-reqresp-domain) defines the `ProtocolId` that we want to support. Specifically, the `Encoding` section. \r\n\r\nTo support Snappy, we want to support the protocol id, that ends with `ssz_snappy`. \r\n\r\nLet me explain roughly how these work in Lighthouse. \r\nThe Req/Resp \"protocol\" exists in this directory: https://github.com/sigp/lighthouse/tree/master/beacon_node/eth2-libp2p/src/rpc\r\n\r\nThe `ProtocolId`'s that we currently support are here (in order that we negotiate them): \r\nhttps://github.com/sigp/lighthouse/blob/master/beacon_node/eth2-libp2p/src/rpc/protocol.rs#L38\r\n\r\nThese are just strings, see the helper struct immediately below. For `snappy` we would need to add the same protocol for each method, replacing the `ssz` string with `ssz_snappy`. The `ssz_snappy` Id's should be placed before their `ssz` counterparts to prioritise the negotiation. This way, we will choose snappy compression if another clients supports it and if not, will fallback to standard ssz encodings. \r\n\r\nAlso, we would need to add the extra protocols to this list: https://github.com/sigp/lighthouse/blob/master/beacon_node/eth2-libp2p/src/rpc/protocol.rs#L170\r\n\r\nOnce we have added protocols here, we need to tell Lighthouse what to do when another client is trying to negotiate one of these protocols. \r\nThis happens here: https://github.com/sigp/lighthouse/blob/master/beacon_node/eth2-libp2p/src/rpc/protocol.rs#L121 (for inbound negotiations)\r\n\r\nand here: https://github.com/sigp/lighthouse/blob/master/beacon_node/eth2-libp2p/src/rpc/protocol.rs#L209 (for outbound requests)\r\n\r\nIn each of these functions they set up a specific `Codec` (https://docs.rs/tokio-io/0.1.3/tokio_io/codec/index.html) of how to encode/decode packets using these negotiated protocols. \r\n\r\nWe only have the ssz codec at the moment, see here: https://github.com/sigp/lighthouse/blob/master/beacon_node/eth2-libp2p/src/rpc/codec/ssz.rs\r\n\r\nI know this part can be confusing and I've not got around to documenting the codecs. But these describe how to encode/decode raw bytes, as they stream in from the network. We are UVI-length prefixing bytes. Also the ssz-codec in many parts doesn't actually ssz-encode or decode, because for reason's i won't go into here, we want to do this at another level. \r\n\r\nI imagine we can just copy the ssz-codec and make an `ssz-snappy-codec` or something similar. This should do almost the same functionality as ssz-encoding but with snappy compression. \r\n\r\nAfter writing this out, I realise that this logic may seem quite complicated and hard to track as some of the logic flows occur in libp2p. If this doesn't make sense, feel free to ask me further questions, or perhaps another issue not so integrated with the libp2p stack may be easier to follow. \r\n\r\n\r\n\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/549098080/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/557141301",
    "html_url": "https://github.com/sigp/lighthouse/issues/581#issuecomment-557141301",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/581",
    "id": 557141301,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU1NzE0MTMwMQ==",
    "user": {
      "login": "b-m-f",
      "id": 2843450,
      "node_id": "MDQ6VXNlcjI4NDM0NTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2843450?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/b-m-f",
      "html_url": "https://github.com/b-m-f",
      "followers_url": "https://api.github.com/users/b-m-f/followers",
      "following_url": "https://api.github.com/users/b-m-f/following{/other_user}",
      "gists_url": "https://api.github.com/users/b-m-f/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/b-m-f/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/b-m-f/subscriptions",
      "organizations_url": "https://api.github.com/users/b-m-f/orgs",
      "repos_url": "https://api.github.com/users/b-m-f/repos",
      "events_url": "https://api.github.com/users/b-m-f/events{/privacy}",
      "received_events_url": "https://api.github.com/users/b-m-f/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-11-21T15:40:57Z",
    "updated_at": "2019-11-21T15:40:57Z",
    "author_association": "CONTRIBUTOR",
    "body": "Hi @AgeManning,\r\n\r\nstarted coding on this again and I have a question regarding the stream directions.\r\n\r\nThere are both Outbound and Inbound en- & decoding on the Codec, which confuses me a bit. \r\n\r\nMy idea was to decode only on received traffic and to only encode outbound.\r\n\r\nSo snappy compression would apply to `SSZSnappyOutboundCode.encode` and `SSZSnappyInboundCode.decode`. \r\n\r\nOr am I missing something here and it should be implemented on all 4 cases?",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/557141301/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/557945811",
    "html_url": "https://github.com/sigp/lighthouse/issues/581#issuecomment-557945811",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/581",
    "id": 557945811,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU1Nzk0NTgxMQ==",
    "user": {
      "login": "AgeManning",
      "id": 7454587,
      "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AgeManning",
      "html_url": "https://github.com/AgeManning",
      "followers_url": "https://api.github.com/users/AgeManning/followers",
      "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
      "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
      "organizations_url": "https://api.github.com/users/AgeManning/orgs",
      "repos_url": "https://api.github.com/users/AgeManning/repos",
      "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AgeManning/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-11-25T00:26:23Z",
    "updated_at": "2019-11-25T00:27:13Z",
    "author_association": "MEMBER",
    "body": "Hey, \r\n\r\nYeah I know this part is confusing. There are updates and comments in the `network-spec-update` branch, which I recommend working from (this will be in master very soon). \r\n\r\nThe reason there are four, is because the encoding and decoding is different depending on whether we are receiving an RPC request or sending one. \r\n\r\nMore specifically, \r\n\r\nAn `InboundCodec` deals with requests from an external peer. The `decode()` decodes an RPC Request coming in and the `encode()` encodes an RPC Response that we send out. \r\n\r\nAn `OutboundCodec` deals with requests that we send to peers. The `encode()` encodes an RPC Request we send out and the `decode()` decodes an RPC Response that we get back. \r\n\r\nThere are four because the Requests and Responses are not symmetric in encoding/decoding\r\n\r\n\r\n\r\n\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/557945811/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/613230469",
    "html_url": "https://github.com/sigp/lighthouse/issues/581#issuecomment-613230469",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/581",
    "id": 613230469,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYxMzIzMDQ2OQ==",
    "user": {
      "login": "AgeManning",
      "id": 7454587,
      "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AgeManning",
      "html_url": "https://github.com/AgeManning",
      "followers_url": "https://api.github.com/users/AgeManning/followers",
      "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
      "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
      "organizations_url": "https://api.github.com/users/AgeManning/orgs",
      "repos_url": "https://api.github.com/users/AgeManning/repos",
      "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AgeManning/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-04-14T05:15:43Z",
    "updated_at": "2020-04-14T05:15:43Z",
    "author_association": "MEMBER",
    "body": "This is resolved in #866",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/613230469/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
