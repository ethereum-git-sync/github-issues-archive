{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/2847",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/2847/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/2847/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/2847/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/2847",
  "id": 1068003207,
  "node_id": "I_kwDOCFeAzc4_qG-H",
  "number": 2847,
  "title": "Shift subnet backbone structure",
  "user": {
    "login": "AgeManning",
    "id": 7454587,
    "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/AgeManning",
    "html_url": "https://github.com/AgeManning",
    "followers_url": "https://api.github.com/users/AgeManning/followers",
    "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
    "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
    "organizations_url": "https://api.github.com/users/AgeManning/orgs",
    "repos_url": "https://api.github.com/users/AgeManning/repos",
    "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
    "received_events_url": "https://api.github.com/users/AgeManning/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 2336800125,
      "node_id": "MDU6TGFiZWwyMzM2ODAwMTI1",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/t%20Networking",
      "name": "t Networking",
      "color": "40E0D0",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "divagant-martian",
    "id": 26765164,
    "node_id": "MDQ6VXNlcjI2NzY1MTY0",
    "avatar_url": "https://avatars.githubusercontent.com/u/26765164?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/divagant-martian",
    "html_url": "https://github.com/divagant-martian",
    "followers_url": "https://api.github.com/users/divagant-martian/followers",
    "following_url": "https://api.github.com/users/divagant-martian/following{/other_user}",
    "gists_url": "https://api.github.com/users/divagant-martian/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/divagant-martian/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/divagant-martian/subscriptions",
    "organizations_url": "https://api.github.com/users/divagant-martian/orgs",
    "repos_url": "https://api.github.com/users/divagant-martian/repos",
    "events_url": "https://api.github.com/users/divagant-martian/events{/privacy}",
    "received_events_url": "https://api.github.com/users/divagant-martian/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "divagant-martian",
      "id": 26765164,
      "node_id": "MDQ6VXNlcjI2NzY1MTY0",
      "avatar_url": "https://avatars.githubusercontent.com/u/26765164?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/divagant-martian",
      "html_url": "https://github.com/divagant-martian",
      "followers_url": "https://api.github.com/users/divagant-martian/followers",
      "following_url": "https://api.github.com/users/divagant-martian/following{/other_user}",
      "gists_url": "https://api.github.com/users/divagant-martian/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/divagant-martian/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/divagant-martian/subscriptions",
      "organizations_url": "https://api.github.com/users/divagant-martian/orgs",
      "repos_url": "https://api.github.com/users/divagant-martian/repos",
      "events_url": "https://api.github.com/users/divagant-martian/events{/privacy}",
      "received_events_url": "https://api.github.com/users/divagant-martian/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2021-12-01T06:10:18Z",
  "updated_at": "2022-10-20T18:21:24Z",
  "closed_at": "2022-10-20T18:21:23Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nAs described in https://github.com/ethereum/consensus-specs/issues/2749 we may need to shift our subnet backbone structure to having one subnet per node. \r\n\r\nThis will simplify the attestation service in the network crate. This should not be merged to `unstable` as the issue is still in an experimental phase. It just might be nice to have a PR ready to participate in new testnets formed. ",
  "closed_by": {
    "login": "divagant-martian",
    "id": 26765164,
    "node_id": "MDQ6VXNlcjI2NzY1MTY0",
    "avatar_url": "https://avatars.githubusercontent.com/u/26765164?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/divagant-martian",
    "html_url": "https://github.com/divagant-martian",
    "followers_url": "https://api.github.com/users/divagant-martian/followers",
    "following_url": "https://api.github.com/users/divagant-martian/following{/other_user}",
    "gists_url": "https://api.github.com/users/divagant-martian/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/divagant-martian/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/divagant-martian/subscriptions",
    "organizations_url": "https://api.github.com/users/divagant-martian/orgs",
    "repos_url": "https://api.github.com/users/divagant-martian/repos",
    "events_url": "https://api.github.com/users/divagant-martian/events{/privacy}",
    "received_events_url": "https://api.github.com/users/divagant-martian/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/2847/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/2847/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/984026956",
    "html_url": "https://github.com/sigp/lighthouse/issues/2847#issuecomment-984026956",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/2847",
    "id": 984026956,
    "node_id": "IC_kwDOCFeAzc46pw9M",
    "user": {
      "login": "pawanjay176",
      "id": 9890508,
      "node_id": "MDQ6VXNlcjk4OTA1MDg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9890508?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pawanjay176",
      "html_url": "https://github.com/pawanjay176",
      "followers_url": "https://api.github.com/users/pawanjay176/followers",
      "following_url": "https://api.github.com/users/pawanjay176/following{/other_user}",
      "gists_url": "https://api.github.com/users/pawanjay176/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pawanjay176/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pawanjay176/subscriptions",
      "organizations_url": "https://api.github.com/users/pawanjay176/orgs",
      "repos_url": "https://api.github.com/users/pawanjay176/repos",
      "events_url": "https://api.github.com/users/pawanjay176/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pawanjay176/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-12-01T20:25:43Z",
    "updated_at": "2021-12-01T20:25:43Z",
    "author_association": "MEMBER",
    "body": "I can work on this guy.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/984026956/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/984214339",
    "html_url": "https://github.com/sigp/lighthouse/issues/2847#issuecomment-984214339",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/2847",
    "id": 984214339,
    "node_id": "IC_kwDOCFeAzc46qetD",
    "user": {
      "login": "AgeManning",
      "id": 7454587,
      "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AgeManning",
      "html_url": "https://github.com/AgeManning",
      "followers_url": "https://api.github.com/users/AgeManning/followers",
      "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
      "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
      "organizations_url": "https://api.github.com/users/AgeManning/orgs",
      "repos_url": "https://api.github.com/users/AgeManning/repos",
      "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AgeManning/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-12-02T01:40:24Z",
    "updated_at": "2021-12-02T01:40:24Z",
    "author_association": "MEMBER",
    "body": "Yeah cool. The mapping between node-id/public-key has not been spec'd yet, so we can't actually build this yet, so this issue is more of a tracking issue for the time being. \r\nWe could put in a stub for the mapping and make the apporiate code changes in the mean-time if we wanted",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/984214339/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1019634804",
    "html_url": "https://github.com/sigp/lighthouse/issues/2847#issuecomment-1019634804",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/2847",
    "id": 1019634804,
    "node_id": "IC_kwDOCFeAzc48xmR0",
    "user": {
      "login": "AgeManning",
      "id": 7454587,
      "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AgeManning",
      "html_url": "https://github.com/AgeManning",
      "followers_url": "https://api.github.com/users/AgeManning/followers",
      "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
      "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
      "organizations_url": "https://api.github.com/users/AgeManning/orgs",
      "repos_url": "https://api.github.com/users/AgeManning/repos",
      "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AgeManning/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-01-24T01:37:06Z",
    "updated_at": "2022-01-24T01:37:06Z",
    "author_association": "MEMBER",
    "body": "There is some duplicate code between sync committees and the attestation service. \r\nIn this update, we should try and group all this logic as the entire attestation service will need to be modified.\r\n\r\nThings we need to consider:\r\n- Peer count and peer management: This change will mean that each peer will be subscribed to one long-lived subnet. We would like to avoid peer-churn, so as we cycle through required subnets, it would be nice to try and maintain 1 peer on each subnet. I think we should increase our default target-peer count to around 70 or 80. \r\nWhen we are pruning peers I think we should prune by score, then by how crowded a subnet is. I.e we have a choice of equal peers but have 2 or 3 on a given subnet, we prune one of those 2 or three peers. Over-time this should help us balance peers uniformly accross subnets. \r\n- Attestation service: We need to remove the logic for long-lived subnets. \r\n- ENR: Remove the ENR mapping field. For backwards compatibility we may temporarily leave it but update it based on our node-id. \r\n- Discovery searches: Based on the node-id mapping we should update our target searches so search for specific node ids. This will remove the ability to do \"grouped\" subnet queries as we are now looking for a specific node-id. We can limit the target peers tho to speed up discovery queries\r\n- Group the sync-comittee logic with the attestation subnet logic",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1019634804/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1143161449",
    "html_url": "https://github.com/sigp/lighthouse/issues/2847#issuecomment-1143161449",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/2847",
    "id": 1143161449,
    "node_id": "IC_kwDOCFeAzc5EI0Jp",
    "user": {
      "login": "AgeManning",
      "id": 7454587,
      "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AgeManning",
      "html_url": "https://github.com/AgeManning",
      "followers_url": "https://api.github.com/users/AgeManning/followers",
      "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
      "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
      "organizations_url": "https://api.github.com/users/AgeManning/orgs",
      "repos_url": "https://api.github.com/users/AgeManning/repos",
      "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AgeManning/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-06-01T06:16:48Z",
    "updated_at": "2022-06-01T06:16:48Z",
    "author_association": "MEMBER",
    "body": "Update with more specific details:\r\n\r\nThe spec issue contains the latest updates on what we are trying to achieve. From an implementation side:\r\n\r\nWe have two files: https://github.com/sigp/lighthouse/blob/stable/beacon_node/network/src/subnet_service/attestation_subnets.rs and https://github.com/sigp/lighthouse/blob/stable/beacon_node/network/src/subnet_service/sync_subnets.rs\r\n\r\nwhich handle attestation and sync subnet logic. There a quite a bit of code duplication going on here. My thoughts were to unify these two. I was thinking we could be either:\r\n- Build a generic struct that can be used by both sync subnets and attnet subnets\r\n- Make a single struct that can handle both\r\n\r\nThe above changes are more of a nice to have, figured we could build this in whilst we are making these modifications.\r\n\r\nThe actual issue involves subscribing to a fixed constant amount of subnets (hopefully 1 for mainnet) per node-id (i.e beacon node). The exact mapping is given in the specs and uses the shuffling functions we already have in the beacon chain. \r\n\r\nTo do this, we need to modify the `AttestationService`. So that is only subscribes to one long-lived subnet.\r\n\r\nSome points to consider: \r\n- We should make this backwards compatible. This means that although its not strictly required moving into this new regime, we should continue to update our ENR to indicate which subnets we are subscribed to (long term). \r\n- We should implement a new discovery function which searches for target node-ids which should correspond to nodes that are subscribed to subnets we want. The issue here is that old-notes won't abide by this, so potentially we search for random targets also in parallel. \r\n- We may need to increase the number of parallel discovery searches (in lighthouse, and maybe the parallelization parameter in discovery config) if we increase the number of \"target-subnets\" that a node can exist in for any given subnet.\r\n- We do not know how the network will respond to these changes. So this feature should not be set by default. We should either:\r\n  - Hide it behind a compilation flag\r\n  - Hide it behind a hidden CLI to enable this\r\n  - Keep it in a fork to be maintained against unstable (this is less ideal because it requires more work)\r\n\r\n\r\n\r\n\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1143161449/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1285964173",
    "html_url": "https://github.com/sigp/lighthouse/issues/2847#issuecomment-1285964173",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/2847",
    "id": 1285964173,
    "node_id": "IC_kwDOCFeAzc5MpkGN",
    "user": {
      "login": "divagant-martian",
      "id": 26765164,
      "node_id": "MDQ6VXNlcjI2NzY1MTY0",
      "avatar_url": "https://avatars.githubusercontent.com/u/26765164?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/divagant-martian",
      "html_url": "https://github.com/divagant-martian",
      "followers_url": "https://api.github.com/users/divagant-martian/followers",
      "following_url": "https://api.github.com/users/divagant-martian/following{/other_user}",
      "gists_url": "https://api.github.com/users/divagant-martian/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/divagant-martian/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/divagant-martian/subscriptions",
      "organizations_url": "https://api.github.com/users/divagant-martian/orgs",
      "repos_url": "https://api.github.com/users/divagant-martian/repos",
      "events_url": "https://api.github.com/users/divagant-martian/events{/privacy}",
      "received_events_url": "https://api.github.com/users/divagant-martian/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-10-20T18:21:23Z",
    "updated_at": "2022-10-20T18:21:23Z",
    "author_association": "CONTRIBUTOR",
    "body": "Most of this is closed with #3453 I've created https://github.com/sigp/lighthouse/issues/3648 with the remaining work",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1285964173/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
