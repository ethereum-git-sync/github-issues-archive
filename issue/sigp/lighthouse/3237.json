{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/3237",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/3237/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/3237/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/3237/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/3237",
  "id": 1259230419,
  "node_id": "I_kwDOCFeAzc5LDlTT",
  "number": 3237,
  "title": "Remove deficit gossipsub scoring during topic transition",
  "user": {
    "login": "AgeManning",
    "id": 7454587,
    "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/AgeManning",
    "html_url": "https://github.com/AgeManning",
    "followers_url": "https://api.github.com/users/AgeManning/followers",
    "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
    "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
    "organizations_url": "https://api.github.com/users/AgeManning/orgs",
    "repos_url": "https://api.github.com/users/AgeManning/repos",
    "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
    "received_events_url": "https://api.github.com/users/AgeManning/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 2336800125,
      "node_id": "MDU6TGFiZWwyMzM2ODAwMTI1",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/t%20Networking",
      "name": "t Networking",
      "color": "40E0D0",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": {
    "login": "ackintosh",
    "id": 1885716,
    "node_id": "MDQ6VXNlcjE4ODU3MTY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1885716?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ackintosh",
    "html_url": "https://github.com/ackintosh",
    "followers_url": "https://api.github.com/users/ackintosh/followers",
    "following_url": "https://api.github.com/users/ackintosh/following{/other_user}",
    "gists_url": "https://api.github.com/users/ackintosh/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ackintosh/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ackintosh/subscriptions",
    "organizations_url": "https://api.github.com/users/ackintosh/orgs",
    "repos_url": "https://api.github.com/users/ackintosh/repos",
    "events_url": "https://api.github.com/users/ackintosh/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ackintosh/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "ackintosh",
      "id": 1885716,
      "node_id": "MDQ6VXNlcjE4ODU3MTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1885716?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ackintosh",
      "html_url": "https://github.com/ackintosh",
      "followers_url": "https://api.github.com/users/ackintosh/followers",
      "following_url": "https://api.github.com/users/ackintosh/following{/other_user}",
      "gists_url": "https://api.github.com/users/ackintosh/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ackintosh/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ackintosh/subscriptions",
      "organizations_url": "https://api.github.com/users/ackintosh/orgs",
      "repos_url": "https://api.github.com/users/ackintosh/repos",
      "events_url": "https://api.github.com/users/ackintosh/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ackintosh/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 7,
  "created_at": "2022-06-03T02:16:38Z",
  "updated_at": "2023-07-22T20:39:12Z",
  "closed_at": null,
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nWhen we fork, we transition between gossipsub topics. We remain subscribed to old topics to keep track of any stragglers. As the optimal case involves everyone shifting to new topics, we would expect little to no messages being sent along the old topics.\r\n\r\nThis poses an issue for gossipsub scoring which expects a minimum number of messages to be sent on a given topic. Thus peers that left on the mesh on old topics get penalized for not sending us the expected minimum number of messages. This can result in disconnecting and potentially banning of honest peers.\r\n\r\nIn the event of a fork or topic transition, we should adjust the scoring parameters such that we eliminate the minimum deficit value indicating that it is perfectly fine to receive no messages on that topic. We can use this function: https://github.com/libp2p/rust-libp2p/blob/master/protocols/gossipsub/src/behaviour.rs#L900 to achieve this.\r\n\r\nThe `network` crate mainly controls the fork-switching logic, so it may need to inform the behaviour of when to adjust the scoring for topics.",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/3237/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/3237/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1616376056",
    "html_url": "https://github.com/sigp/lighthouse/issues/3237#issuecomment-1616376056",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3237",
    "id": 1616376056,
    "node_id": "IC_kwDOCFeAzc5gV_D4",
    "user": {
      "login": "ackintosh",
      "id": 1885716,
      "node_id": "MDQ6VXNlcjE4ODU3MTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1885716?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ackintosh",
      "html_url": "https://github.com/ackintosh",
      "followers_url": "https://api.github.com/users/ackintosh/followers",
      "following_url": "https://api.github.com/users/ackintosh/following{/other_user}",
      "gists_url": "https://api.github.com/users/ackintosh/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ackintosh/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ackintosh/subscriptions",
      "organizations_url": "https://api.github.com/users/ackintosh/orgs",
      "repos_url": "https://api.github.com/users/ackintosh/repos",
      "events_url": "https://api.github.com/users/ackintosh/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ackintosh/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-02T05:15:26Z",
    "updated_at": "2023-07-02T05:15:26Z",
    "author_association": "MEMBER",
    "body": "> We can use this function: https://github.com/libp2p/rust-libp2p/blob/master/protocols/gossipsub/src/behaviour.rs#L900 to achieve this.\r\n\r\n@AgeManning Now the link might be pointing to a different place than you intended at the time. Is `set_application_score` the function?\r\nhttps://github.com/libp2p/rust-libp2p/blob/master/protocols/gossipsub/src/behaviour.rs#L935",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1616376056/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1616826026",
    "html_url": "https://github.com/sigp/lighthouse/issues/3237#issuecomment-1616826026",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3237",
    "id": 1616826026,
    "node_id": "IC_kwDOCFeAzc5gXs6q",
    "user": {
      "login": "divagant-martian",
      "id": 26765164,
      "node_id": "MDQ6VXNlcjI2NzY1MTY0",
      "avatar_url": "https://avatars.githubusercontent.com/u/26765164?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/divagant-martian",
      "html_url": "https://github.com/divagant-martian",
      "followers_url": "https://api.github.com/users/divagant-martian/followers",
      "following_url": "https://api.github.com/users/divagant-martian/following{/other_user}",
      "gists_url": "https://api.github.com/users/divagant-martian/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/divagant-martian/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/divagant-martian/subscriptions",
      "organizations_url": "https://api.github.com/users/divagant-martian/orgs",
      "repos_url": "https://api.github.com/users/divagant-martian/repos",
      "events_url": "https://api.github.com/users/divagant-martian/events{/privacy}",
      "received_events_url": "https://api.github.com/users/divagant-martian/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-02T21:30:01Z",
    "updated_at": "2023-07-02T21:30:23Z",
    "author_association": "CONTRIBUTOR",
    "body": "This is the one you want [`set_topic_params`](https://github.com/libp2p/rust-libp2p/blame/68e6bf9c3cd0d3317415a5ba31a62e91cba0a5d2/protocols/gossipsub/src/behaviour.rs#L920)",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1616826026/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 1,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1620800864",
    "html_url": "https://github.com/sigp/lighthouse/issues/3237#issuecomment-1620800864",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3237",
    "id": 1620800864,
    "node_id": "IC_kwDOCFeAzc5gm3Vg",
    "user": {
      "login": "ackintosh",
      "id": 1885716,
      "node_id": "MDQ6VXNlcjE4ODU3MTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1885716?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ackintosh",
      "html_url": "https://github.com/ackintosh",
      "followers_url": "https://api.github.com/users/ackintosh/followers",
      "following_url": "https://api.github.com/users/ackintosh/following{/other_user}",
      "gists_url": "https://api.github.com/users/ackintosh/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ackintosh/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ackintosh/subscriptions",
      "organizations_url": "https://api.github.com/users/ackintosh/orgs",
      "repos_url": "https://api.github.com/users/ackintosh/repos",
      "events_url": "https://api.github.com/users/ackintosh/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ackintosh/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-04T22:39:11Z",
    "updated_at": "2023-07-04T22:39:11Z",
    "author_association": "MEMBER",
    "body": "@AgeManning @divagant-martian I was thinking about how to reproduce this issue locally, but I couldn't come up with anything. If you have any ideas, please let me know. 🙏 ",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1620800864/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1620816134",
    "html_url": "https://github.com/sigp/lighthouse/issues/3237#issuecomment-1620816134",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3237",
    "id": 1620816134,
    "node_id": "IC_kwDOCFeAzc5gm7EG",
    "user": {
      "login": "divagant-martian",
      "id": 26765164,
      "node_id": "MDQ6VXNlcjI2NzY1MTY0",
      "avatar_url": "https://avatars.githubusercontent.com/u/26765164?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/divagant-martian",
      "html_url": "https://github.com/divagant-martian",
      "followers_url": "https://api.github.com/users/divagant-martian/followers",
      "following_url": "https://api.github.com/users/divagant-martian/following{/other_user}",
      "gists_url": "https://api.github.com/users/divagant-martian/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/divagant-martian/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/divagant-martian/subscriptions",
      "organizations_url": "https://api.github.com/users/divagant-martian/orgs",
      "repos_url": "https://api.github.com/users/divagant-martian/repos",
      "events_url": "https://api.github.com/users/divagant-martian/events{/privacy}",
      "received_events_url": "https://api.github.com/users/divagant-martian/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-04T23:04:41Z",
    "updated_at": "2023-07-08T13:33:47Z",
    "author_association": "CONTRIBUTOR",
    "body": "@ackintosh what did you try? I think reproducing this would be involved. \r\n\r\nEither a local testnet setup that makes it across a fork and monitoring metrics, or maybe a unitest - also somewhat involved (f you want to go this route [this file](https://github.com/sigp/lighthouse/blob/dfcb3363c757671eb19d5f8e519b4b94ac74677a/beacon_node/network/src/service/tests.rs) should give you a head start. \r\n\r\nIn reality, I think these changes should be rather simple to tackle. The logic you need lives here: \r\n- [`next_fork_update`](https://github.com/sigp/lighthouse/blob/dfcb3363c757671eb19d5f8e519b4b94ac74677a/beacon_node/network/src/service.rs#L198-L202) triggered when a fork happens. Linked other two fields to note that subscription and unsubscription don't happen at the time of the fork. Subscription happens before, unsubscription after (as noted in this issue)\r\n- [`update_next_fork`](https://github.com/sigp/lighthouse/blob/dfcb3363c757671eb19d5f8e519b4b94ac74677a/beacon_node/network/src/service.rs#L893) what is executed when a fork happens (so when the one above triggers) so here is where the changes would be done\r\n- Since this is highly related to how unsubscriptions work: \r\n  - [This is what happens when we unsubscribe](https://github.com/sigp/lighthouse/blob/dfcb3363c757671eb19d5f8e519b4b94ac74677a/beacon_node/network/src/service.rs#L449-L454)\r\n  - And here is where the unsubscriptions [are determined](https://github.com/sigp/lighthouse/blob/dfcb3363c757671eb19d5f8e519b4b94ac74677a/beacon_node/lighthouse_network/src/service/mod.rs#L572-L581)\r\n\r\nThe idea would be then to do something similar to what happens with unsubscriptions, removing the topic weight, but ofc, when the fork happens and not when unsubscriptions happen.\r\n\r\nLet me know if this helps or you need more info",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1620816134/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 1,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1626873941",
    "html_url": "https://github.com/sigp/lighthouse/issues/3237#issuecomment-1626873941",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3237",
    "id": 1626873941,
    "node_id": "IC_kwDOCFeAzc5g-CBV",
    "user": {
      "login": "ackintosh",
      "id": 1885716,
      "node_id": "MDQ6VXNlcjE4ODU3MTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1885716?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ackintosh",
      "html_url": "https://github.com/ackintosh",
      "followers_url": "https://api.github.com/users/ackintosh/followers",
      "following_url": "https://api.github.com/users/ackintosh/following{/other_user}",
      "gists_url": "https://api.github.com/users/ackintosh/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ackintosh/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ackintosh/subscriptions",
      "organizations_url": "https://api.github.com/users/ackintosh/orgs",
      "repos_url": "https://api.github.com/users/ackintosh/repos",
      "events_url": "https://api.github.com/users/ackintosh/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ackintosh/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-08T05:41:02Z",
    "updated_at": "2023-07-08T05:41:02Z",
    "author_association": "MEMBER",
    "body": "Thanks for the detailed explanation. it was really helpful!\n\nI have read the code around the links you provided. Below is a diagram of my understanding:\n\n\n\n![Image](https://github.com/sigp/lighthouse/assets/1885716/155e8b7f-f7a2-4e4d-9151-db88ae174785)\n\n",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1626873941/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1627290953",
    "html_url": "https://github.com/sigp/lighthouse/issues/3237#issuecomment-1627290953",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3237",
    "id": 1627290953,
    "node_id": "IC_kwDOCFeAzc5g_n1J",
    "user": {
      "login": "divagant-martian",
      "id": 26765164,
      "node_id": "MDQ6VXNlcjI2NzY1MTY0",
      "avatar_url": "https://avatars.githubusercontent.com/u/26765164?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/divagant-martian",
      "html_url": "https://github.com/divagant-martian",
      "followers_url": "https://api.github.com/users/divagant-martian/followers",
      "following_url": "https://api.github.com/users/divagant-martian/following{/other_user}",
      "gists_url": "https://api.github.com/users/divagant-martian/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/divagant-martian/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/divagant-martian/subscriptions",
      "organizations_url": "https://api.github.com/users/divagant-martian/orgs",
      "repos_url": "https://api.github.com/users/divagant-martian/repos",
      "events_url": "https://api.github.com/users/divagant-martian/events{/privacy}",
      "received_events_url": "https://api.github.com/users/divagant-martian/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-08T13:40:09Z",
    "updated_at": "2023-07-08T13:40:09Z",
    "author_association": "CONTRIBUTOR",
    "body": "yeah I think that's correct",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1627290953/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1646665568",
    "html_url": "https://github.com/sigp/lighthouse/issues/3237#issuecomment-1646665568",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3237",
    "id": 1646665568,
    "node_id": "IC_kwDOCFeAzc5iJh9g",
    "user": {
      "login": "ackintosh",
      "id": 1885716,
      "node_id": "MDQ6VXNlcjE4ODU3MTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1885716?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ackintosh",
      "html_url": "https://github.com/ackintosh",
      "followers_url": "https://api.github.com/users/ackintosh/followers",
      "following_url": "https://api.github.com/users/ackintosh/following{/other_user}",
      "gists_url": "https://api.github.com/users/ackintosh/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ackintosh/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ackintosh/subscriptions",
      "organizations_url": "https://api.github.com/users/ackintosh/orgs",
      "repos_url": "https://api.github.com/users/ackintosh/repos",
      "events_url": "https://api.github.com/users/ackintosh/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ackintosh/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-22T20:26:10Z",
    "updated_at": "2023-07-22T20:39:12Z",
    "author_association": "MEMBER",
    "body": "Filed a draft PR  https://github.com/sigp/lighthouse/pull/4486 to address this issue, and tackling the unit testing.\r\n\r\nQuoting from the changes of unit test:\r\nhttps://github.com/sigp/lighthouse/blob/5589e875be0644fec13b083050cb3b3aff4ab0bf/beacon_node/network/src/service/tests.rs#L199-L216\r\n\r\nI also filed a PR to libp2p to add a getter function obtaining `TopicScoreParam` since there is no way to test topic_weight.\r\nhttps://github.com/libp2p/rust-libp2p/pull/4231",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1646665568/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
