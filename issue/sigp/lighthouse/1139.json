{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/1139",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/1139/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/1139/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/1139/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/1139",
  "id": 616684105,
  "node_id": "MDU6SXNzdWU2MTY2ODQxMDU=",
  "number": 1139,
  "title": "Get rid of MemoryStore",
  "user": {
    "login": "adaszko",
    "id": 165678,
    "node_id": "MDQ6VXNlcjE2NTY3OA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/165678?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/adaszko",
    "html_url": "https://github.com/adaszko",
    "followers_url": "https://api.github.com/users/adaszko/followers",
    "following_url": "https://api.github.com/users/adaszko/following{/other_user}",
    "gists_url": "https://api.github.com/users/adaszko/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/adaszko/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/adaszko/subscriptions",
    "organizations_url": "https://api.github.com/users/adaszko/orgs",
    "repos_url": "https://api.github.com/users/adaszko/repos",
    "events_url": "https://api.github.com/users/adaszko/events{/privacy}",
    "received_events_url": "https://api.github.com/users/adaszko/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 7,
  "created_at": "2020-05-12T14:04:21Z",
  "updated_at": "2020-05-25T07:42:28Z",
  "closed_at": "2020-05-25T07:42:28Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nThis is aimed at code simplification that will ease introduction of atomic operations (https://github.com/sigp/lighthouse/issues/692).  [MemoryStore](https://github.com/sigp/lighthouse/blob/2955e6b941d719c46a326908bed7bd152eb53004/beacon_node/store/src/memory_store.rs#L13-L16) is meant as a faster version of LevelDB-based store for use in tests.  The problem is, with `fsync` disabled, LevelDB should perform on par with the current implementation of `MemoryStore`, i.e. `RwLock<DBHashMap>` so that `MemoryStore` becomes an unnecessary complication.  In addition to that, the `Store` trait along with `StoreItem` and `SimpleStoreItem` complicate database access (think using it atomically and safely) too and getting rid of `MemoryStore` can be seen as a first step towards getting rid of them too.  Therefore, this ticket proposes ditching `MemoryStore` in favor of plain `LevelDB` with `fsync=false`.",
  "closed_by": {
    "login": "adaszko",
    "id": 165678,
    "node_id": "MDQ6VXNlcjE2NTY3OA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/165678?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/adaszko",
    "html_url": "https://github.com/adaszko",
    "followers_url": "https://api.github.com/users/adaszko/followers",
    "following_url": "https://api.github.com/users/adaszko/following{/other_user}",
    "gists_url": "https://api.github.com/users/adaszko/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/adaszko/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/adaszko/subscriptions",
    "organizations_url": "https://api.github.com/users/adaszko/orgs",
    "repos_url": "https://api.github.com/users/adaszko/repos",
    "events_url": "https://api.github.com/users/adaszko/events{/privacy}",
    "received_events_url": "https://api.github.com/users/adaszko/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/1139/reactions",
    "total_count": 1,
    "+1": 1,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/1139/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/627643242",
    "html_url": "https://github.com/sigp/lighthouse/issues/1139#issuecomment-627643242",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1139",
    "id": 627643242,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyNzY0MzI0Mg==",
    "user": {
      "login": "paulhauner",
      "id": 6660660,
      "node_id": "MDQ6VXNlcjY2NjA2NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/paulhauner",
      "html_url": "https://github.com/paulhauner",
      "followers_url": "https://api.github.com/users/paulhauner/followers",
      "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
      "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
      "organizations_url": "https://api.github.com/users/paulhauner/orgs",
      "repos_url": "https://api.github.com/users/paulhauner/repos",
      "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/paulhauner/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-12T22:56:19Z",
    "updated_at": "2020-05-12T22:56:19Z",
    "author_association": "MEMBER",
    "body": "Seems reasonable to me. I can't think of a case where we _need_ `MemoryStore`.\r\n\r\nPerhaps @michaelsproul can think of something?",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/627643242/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/627666281",
    "html_url": "https://github.com/sigp/lighthouse/issues/1139#issuecomment-627666281",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1139",
    "id": 627666281,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyNzY2NjI4MQ==",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-13T00:12:05Z",
    "updated_at": "2020-05-13T00:12:05Z",
    "author_association": "MEMBER",
    "body": "Yep I'm in favour of this.\r\n\r\nFor the `fsync=false` DB to be different from the regular DB also implies we need to turn `WriteOptions::sync` on, which we don't do at the moment. Once we do that we could even run the \r\n\r\n---\r\n\r\nLonger-term, I'm also open to the idea of removing the `Store` trait, as it complicates the implementation of an LMDB backend (because you can't write `type Transaction<'a> = lmdb::RwTransaction<'a>`). BUT, we've settled on LevelDB for now because it's better for write-intensive workloads, and we could probably workaround the associated type issue by making a concrete transaction type shared by both DBs, like:\r\n\r\n```rust\r\nenum Transaction<'a> {\r\n    LevelDBTransaction(leveldb::WriteBatch),\r\n    LMDBTransaction(lmdb::RwTransaction<'a>),\r\n}\r\n```\r\n\r\nAnyway, that's kind of off-topic, delete the memory store!!",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/627666281/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/627667169",
    "html_url": "https://github.com/sigp/lighthouse/issues/1139#issuecomment-627667169",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1139",
    "id": 627667169,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyNzY2NzE2OQ==",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-13T00:15:11Z",
    "updated_at": "2020-05-13T00:15:11Z",
    "author_association": "MEMBER",
    "body": "Ooh I just saw @adaszko's `do_atomically` API, which removes the need for the `Transaction` stuff I was talking about!",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/627667169/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/628068795",
    "html_url": "https://github.com/sigp/lighthouse/issues/1139#issuecomment-628068795",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1139",
    "id": 628068795,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyODA2ODc5NQ==",
    "user": {
      "login": "adaszko",
      "id": 165678,
      "node_id": "MDQ6VXNlcjE2NTY3OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/165678?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/adaszko",
      "html_url": "https://github.com/adaszko",
      "followers_url": "https://api.github.com/users/adaszko/followers",
      "following_url": "https://api.github.com/users/adaszko/following{/other_user}",
      "gists_url": "https://api.github.com/users/adaszko/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/adaszko/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/adaszko/subscriptions",
      "organizations_url": "https://api.github.com/users/adaszko/orgs",
      "repos_url": "https://api.github.com/users/adaszko/repos",
      "events_url": "https://api.github.com/users/adaszko/events{/privacy}",
      "received_events_url": "https://api.github.com/users/adaszko/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-13T15:31:13Z",
    "updated_at": "2020-05-13T15:37:24Z",
    "author_association": "CONTRIBUTOR",
    "body": "Re `Transaction`: Are we talking about non-existent code?  It's not clear to me why it's even necessary.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/628068795/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/628073258",
    "html_url": "https://github.com/sigp/lighthouse/issues/1139#issuecomment-628073258",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1139",
    "id": 628073258,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyODA3MzI1OA==",
    "user": {
      "login": "adaszko",
      "id": 165678,
      "node_id": "MDQ6VXNlcjE2NTY3OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/165678?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/adaszko",
      "html_url": "https://github.com/adaszko",
      "followers_url": "https://api.github.com/users/adaszko/followers",
      "following_url": "https://api.github.com/users/adaszko/following{/other_user}",
      "gists_url": "https://api.github.com/users/adaszko/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/adaszko/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/adaszko/subscriptions",
      "organizations_url": "https://api.github.com/users/adaszko/orgs",
      "repos_url": "https://api.github.com/users/adaszko/repos",
      "events_url": "https://api.github.com/users/adaszko/events{/privacy}",
      "received_events_url": "https://api.github.com/users/adaszko/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-13T15:38:11Z",
    "updated_at": "2020-05-13T15:38:11Z",
    "author_association": "CONTRIBUTOR",
    "body": "> Anyway, that's kind of off-topic, delete the memory store!!\r\n\r\n👍 ",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/628073258/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/628362404",
    "html_url": "https://github.com/sigp/lighthouse/issues/1139#issuecomment-628362404",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1139",
    "id": 628362404,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyODM2MjQwNA==",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-14T03:20:08Z",
    "updated_at": "2020-05-14T03:20:08Z",
    "author_association": "MEMBER",
    "body": "> Re Transaction: Are we talking about non-existent code? It's not clear to me why it's even necessary.\r\n\r\nYou're right, it's not!",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/628362404/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/630976898",
    "html_url": "https://github.com/sigp/lighthouse/issues/1139#issuecomment-630976898",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1139",
    "id": 630976898,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYzMDk3Njg5OA==",
    "user": {
      "login": "adaszko",
      "id": 165678,
      "node_id": "MDQ6VXNlcjE2NTY3OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/165678?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/adaszko",
      "html_url": "https://github.com/adaszko",
      "followers_url": "https://api.github.com/users/adaszko/followers",
      "following_url": "https://api.github.com/users/adaszko/following{/other_user}",
      "gists_url": "https://api.github.com/users/adaszko/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/adaszko/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/adaszko/subscriptions",
      "organizations_url": "https://api.github.com/users/adaszko/orgs",
      "repos_url": "https://api.github.com/users/adaszko/repos",
      "events_url": "https://api.github.com/users/adaszko/events{/privacy}",
      "received_events_url": "https://api.github.com/users/adaszko/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-19T17:43:59Z",
    "updated_at": "2020-05-19T17:43:59Z",
    "author_association": "CONTRIBUTOR",
    "body": "Turns out using real LevelDB in place of MemoryStore is much much slower:\r\n * [MemoryStore](https://github.com/adaszko/lighthouse/runs/677696218) 36m 17s\r\n * [LevelDB](https://github.com/adaszko/lighthouse/runs/689756506) 1h 0m 19s\r\n\r\nThe diff: https://github.com/sigp/lighthouse/compare/master...adaszko:ditch-memory-store \r\nI'm gonna leave MemoryStore in place.\r\n\r\nLevelDB [doesn't support 'in memory only' mode](https://github.com/dain/leveldb/issues/79) to which I attribute the slowdown (i.e. it still hits the disk).  Contrary to [RocksDB](https://github.com/facebook/rocksdb/wiki/RocksDB-In-Memory-Workload-Performance-Benchmarks) or [LMDB](https://stackoverflow.com/questions/36170778/in-memory-databases-with-lmdb).",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/630976898/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
