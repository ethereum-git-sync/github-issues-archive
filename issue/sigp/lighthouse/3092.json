{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/3092",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/3092/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/3092/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/3092/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/3092",
  "id": 1170587179,
  "node_id": "I_kwDOCFeAzc5Fxb4r",
  "number": 3092,
  "title": "Improve Peer Manager Scoring Tests",
  "user": {
    "login": "AgeManning",
    "id": 7454587,
    "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/AgeManning",
    "html_url": "https://github.com/AgeManning",
    "followers_url": "https://api.github.com/users/AgeManning/followers",
    "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
    "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
    "organizations_url": "https://api.github.com/users/AgeManning/orgs",
    "repos_url": "https://api.github.com/users/AgeManning/repos",
    "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
    "received_events_url": "https://api.github.com/users/AgeManning/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 2336800125,
      "node_id": "MDU6TGFiZWwyMzM2ODAwMTI1",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/t%20Networking",
      "name": "t Networking",
      "color": "40E0D0",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2022-03-16T06:10:29Z",
  "updated_at": "2022-10-20T19:02:00Z",
  "closed_at": "2022-10-20T19:02:00Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nThe PeerManager (an object that manages the peers Lighthouse is connected to) has recently added some more complex logic around handling peers, specifically pruning. There are a number of edge cases in this logic that remain untested. The tests we currently have a quite rigid and could be improved with the use of [quickcheck](https://docs.rs/quickcheck/latest/quickcheck/). \r\n\r\nThere is a lot of undocumented complex logic in this section of the code. There is some low-hanging fruit however.\r\n\r\n### Brief Overview of PeerManager Logic\r\n\r\nPeers connect to lighthouse stochastically (if we have open tcp/udp ports). The PeerManager uses a preset `target-peer-count`. This is the desired average number of peers we want to maintain a connection to. As more and more peers connect to us, we permit 10% (or so) more peers above this target. Every 30 seconds the peer manager undergoes a heartbeat:  https://github.com/sigp/lighthouse/blob/stable/beacon_node/lighthouse_network/src/peer_manager/mod.rs#L1114. In this heartbeat, we prune the excess peers, i.e those peers that are above our `target-peer-count` (https://github.com/sigp/lighthouse/blob/stable/beacon_node/lighthouse_network/src/peer_manager/mod.rs#L904). After the heartbeat we expect to disconnect excess peers. \r\n\r\nWe have an internal scoring mechanism that gives us an ability to rate peers. We prune peers based on their score and a number of other heuristics.\r\n\r\nThere are some tests to check if we prune these peers correctly given the complex conditions. See here: https://github.com/sigp/lighthouse/blob/stable/beacon_node/lighthouse_network/src/peer_manager/mod.rs#L1259 (and below). \r\n\r\nIt might be nicer to use `quickcheck` (some examples of its use are: https://github.com/sigp/discv5/blob/master/src/kbucket/bucket.rs#L1380 and https://github.com/libp2p/rust-libp2p/blob/master/protocols/gossipsub/tests/smoke.rs#L188) \r\n\r\nAn example would be to inject a random number of peers, and see if after a heartbeat the peer count is the target peer count. \r\nAnother test could be to inject a random number of peers, with random scores and ensure that we prune the worst ones.\r\n\r\nA further, more sophisticated task would be to attempt to generalize the tests that already exist using quickcheck. \r\n",
  "closed_by": {
    "login": "divagant-martian",
    "id": 26765164,
    "node_id": "MDQ6VXNlcjI2NzY1MTY0",
    "avatar_url": "https://avatars.githubusercontent.com/u/26765164?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/divagant-martian",
    "html_url": "https://github.com/divagant-martian",
    "followers_url": "https://api.github.com/users/divagant-martian/followers",
    "following_url": "https://api.github.com/users/divagant-martian/following{/other_user}",
    "gists_url": "https://api.github.com/users/divagant-martian/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/divagant-martian/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/divagant-martian/subscriptions",
    "organizations_url": "https://api.github.com/users/divagant-martian/orgs",
    "repos_url": "https://api.github.com/users/divagant-martian/repos",
    "events_url": "https://api.github.com/users/divagant-martian/events{/privacy}",
    "received_events_url": "https://api.github.com/users/divagant-martian/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/3092/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/3092/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1140781597",
    "html_url": "https://github.com/sigp/lighthouse/issues/3092#issuecomment-1140781597",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3092",
    "id": 1140781597,
    "node_id": "IC_kwDOCFeAzc5D_vId",
    "user": {
      "login": "ackintosh",
      "id": 1885716,
      "node_id": "MDQ6VXNlcjE4ODU3MTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1885716?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ackintosh",
      "html_url": "https://github.com/ackintosh",
      "followers_url": "https://api.github.com/users/ackintosh/followers",
      "following_url": "https://api.github.com/users/ackintosh/following{/other_user}",
      "gists_url": "https://api.github.com/users/ackintosh/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ackintosh/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ackintosh/subscriptions",
      "organizations_url": "https://api.github.com/users/ackintosh/orgs",
      "repos_url": "https://api.github.com/users/ackintosh/repos",
      "events_url": "https://api.github.com/users/ackintosh/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ackintosh/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-30T07:08:28Z",
    "updated_at": "2022-05-30T07:08:28Z",
    "author_association": "MEMBER",
    "body": "Hi, I'm interested in this issue. ðŸ™‚ \r\n\r\nAs my first step in learning about this issue, I ran code coverage. The following is result about `PeerManager::prune_excess_peers()`. I believe this could be useful.\r\n\r\n<img width=\"482\" alt=\"image\" src=\"https://user-images.githubusercontent.com/1885716/170935964-260bd7cd-9ff5-499e-ac24-3438a6c822a8.png\">\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1140781597/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1141568735",
    "html_url": "https://github.com/sigp/lighthouse/issues/3092#issuecomment-1141568735",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3092",
    "id": 1141568735,
    "node_id": "IC_kwDOCFeAzc5ECvTf",
    "user": {
      "login": "AgeManning",
      "id": 7454587,
      "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AgeManning",
      "html_url": "https://github.com/AgeManning",
      "followers_url": "https://api.github.com/users/AgeManning/followers",
      "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
      "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
      "organizations_url": "https://api.github.com/users/AgeManning/orgs",
      "repos_url": "https://api.github.com/users/AgeManning/repos",
      "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AgeManning/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-31T01:00:09Z",
    "updated_at": "2022-05-31T01:00:09Z",
    "author_association": "MEMBER",
    "body": "Nice. Do you have specific questions about this or anything I can do to help extend the tests?",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1141568735/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 1,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1143882956",
    "html_url": "https://github.com/sigp/lighthouse/issues/3092#issuecomment-1143882956",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3092",
    "id": 1143882956,
    "node_id": "IC_kwDOCFeAzc5ELkTM",
    "user": {
      "login": "ackintosh",
      "id": 1885716,
      "node_id": "MDQ6VXNlcjE4ODU3MTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1885716?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ackintosh",
      "html_url": "https://github.com/ackintosh",
      "followers_url": "https://api.github.com/users/ackintosh/followers",
      "following_url": "https://api.github.com/users/ackintosh/following{/other_user}",
      "gists_url": "https://api.github.com/users/ackintosh/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ackintosh/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ackintosh/subscriptions",
      "organizations_url": "https://api.github.com/users/ackintosh/orgs",
      "repos_url": "https://api.github.com/users/ackintosh/repos",
      "events_url": "https://api.github.com/users/ackintosh/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ackintosh/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-06-01T17:03:27Z",
    "updated_at": "2022-06-01T17:03:27Z",
    "author_association": "MEMBER",
    "body": "Thank you!\r\n\r\nI have read about the implementation of pruning, but I can not understand what the `attestation subnet` and `sync committee subnet` are. (I have googled but no luck.) ðŸ’¦ \r\n\r\nhttps://github.com/sigp/lighthouse/blob/df40700ddd2dcc3c73859cc3f8e315eab899d87c/beacon_node/lighthouse_network/src/types/subnet.rs#L10-L15\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1143882956/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1145562943",
    "html_url": "https://github.com/sigp/lighthouse/issues/3092#issuecomment-1145562943",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3092",
    "id": 1145562943,
    "node_id": "IC_kwDOCFeAzc5ER-c_",
    "user": {
      "login": "AgeManning",
      "id": 7454587,
      "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AgeManning",
      "html_url": "https://github.com/AgeManning",
      "followers_url": "https://api.github.com/users/AgeManning/followers",
      "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
      "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
      "organizations_url": "https://api.github.com/users/AgeManning/orgs",
      "repos_url": "https://api.github.com/users/AgeManning/repos",
      "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AgeManning/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-06-03T04:02:19Z",
    "updated_at": "2022-06-03T04:02:19Z",
    "author_association": "MEMBER",
    "body": "These are ethereum-2 terms. \r\n\r\nHigh level overview can be seen here: https://kb.beaconcha.in/attestation\r\n\r\nTechnical specifications are:\r\n\r\n- https://github.com/ethereum/consensus-specs/blob/dev/specs/phase0/validator.md#attesting\r\n- https://github.com/ethereum/consensus-specs/blob/dev/specs/phase0/p2p-interface.md#the-gossip-domain-gossipsub\r\n\r\nSync committees were introduced in Altair. Can see here: https://github.com/ethereum/consensus-specs/blob/dev/specs/altair/validator.md#sync-committee\r\n\r\nBasically these are objects that we propagate over a gossipsub network on different topics.\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1145562943/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 1,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1286006866",
    "html_url": "https://github.com/sigp/lighthouse/issues/3092#issuecomment-1286006866",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3092",
    "id": 1286006866,
    "node_id": "IC_kwDOCFeAzc5MpuhS",
    "user": {
      "login": "divagant-martian",
      "id": 26765164,
      "node_id": "MDQ6VXNlcjI2NzY1MTY0",
      "avatar_url": "https://avatars.githubusercontent.com/u/26765164?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/divagant-martian",
      "html_url": "https://github.com/divagant-martian",
      "followers_url": "https://api.github.com/users/divagant-martian/followers",
      "following_url": "https://api.github.com/users/divagant-martian/following{/other_user}",
      "gists_url": "https://api.github.com/users/divagant-martian/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/divagant-martian/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/divagant-martian/subscriptions",
      "organizations_url": "https://api.github.com/users/divagant-martian/orgs",
      "repos_url": "https://api.github.com/users/divagant-martian/repos",
      "events_url": "https://api.github.com/users/divagant-martian/events{/privacy}",
      "received_events_url": "https://api.github.com/users/divagant-martian/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-10-20T19:01:55Z",
    "updated_at": "2022-10-20T19:01:55Z",
    "author_association": "CONTRIBUTOR",
    "body": "assuming this closed by  #3248 ",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1286006866/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
