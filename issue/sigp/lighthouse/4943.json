{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/4943",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/4943/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/4943/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/4943/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/4943",
  "id": 2005035810,
  "node_id": "I_kwDOCFeAzc53gmsi",
  "number": 4943,
  "title": "Lighthouse sends genesis block twice in libp2p BlocksByRange response",
  "user": {
    "login": "etan-status",
    "id": 89844309,
    "node_id": "MDQ6VXNlcjg5ODQ0MzA5",
    "avatar_url": "https://avatars.githubusercontent.com/u/89844309?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/etan-status",
    "html_url": "https://github.com/etan-status",
    "followers_url": "https://api.github.com/users/etan-status/followers",
    "following_url": "https://api.github.com/users/etan-status/following{/other_user}",
    "gists_url": "https://api.github.com/users/etan-status/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/etan-status/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/etan-status/subscriptions",
    "organizations_url": "https://api.github.com/users/etan-status/orgs",
    "repos_url": "https://api.github.com/users/etan-status/repos",
    "events_url": "https://api.github.com/users/etan-status/events{/privacy}",
    "received_events_url": "https://api.github.com/users/etan-status/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 985647281,
      "node_id": "MDU6TGFiZWw5ODU2NDcyODE=",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/bug",
      "name": "bug",
      "color": "d73a4a",
      "default": true,
      "description": "Something isn't working"
    },
    {
      "id": 2336798682,
      "node_id": "MDU6TGFiZWwyMzM2Nzk4Njgy",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/database",
      "name": "database",
      "color": "C01C9D",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": {
    "login": "jimmygchen",
    "id": 742762,
    "node_id": "MDQ6VXNlcjc0Mjc2Mg==",
    "avatar_url": "https://avatars.githubusercontent.com/u/742762?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jimmygchen",
    "html_url": "https://github.com/jimmygchen",
    "followers_url": "https://api.github.com/users/jimmygchen/followers",
    "following_url": "https://api.github.com/users/jimmygchen/following{/other_user}",
    "gists_url": "https://api.github.com/users/jimmygchen/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jimmygchen/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jimmygchen/subscriptions",
    "organizations_url": "https://api.github.com/users/jimmygchen/orgs",
    "repos_url": "https://api.github.com/users/jimmygchen/repos",
    "events_url": "https://api.github.com/users/jimmygchen/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jimmygchen/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "jimmygchen",
      "id": 742762,
      "node_id": "MDQ6VXNlcjc0Mjc2Mg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/742762?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jimmygchen",
      "html_url": "https://github.com/jimmygchen",
      "followers_url": "https://api.github.com/users/jimmygchen/followers",
      "following_url": "https://api.github.com/users/jimmygchen/following{/other_user}",
      "gists_url": "https://api.github.com/users/jimmygchen/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jimmygchen/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jimmygchen/subscriptions",
      "organizations_url": "https://api.github.com/users/jimmygchen/orgs",
      "repos_url": "https://api.github.com/users/jimmygchen/repos",
      "events_url": "https://api.github.com/users/jimmygchen/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jimmygchen/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2023-11-21T19:59:55Z",
  "updated_at": "2023-11-29T06:34:48Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nWhen requesting blocks 0 ..< 32 on Holesky from Nimbus, Lighthouse seems to respond with a duplicate Genesis block.\r\n\r\n## Version\r\n\r\nlibp2p identify message: `agent_version=Lighthouse/v4.5.0-441fc16/x86_64-linux`\r\n\r\n## Present Behaviour\r\n\r\nLighthouse responds with slots `[0, 0, 2, 4, 6, 9, 11, 13, 14, 15, 16, 18, 20, 21, 22, 23, 24, 26, 27, 28, 30]`\r\n\r\n## Expected Behaviour\r\n\r\nLighthouse only includes slot `0` once in the response.\r\n\r\n## Steps to resolve\r\n\r\nhttps://github.com/ethereum/consensus-specs/blob/dev/specs/phase0/p2p-interface.md#beaconblocksbyrange\r\n\r\n> Clients MUST respond with blocks that are consistent from a single chain within the context of the request. This applies to any step value. In particular when step == 1, each parent_root MUST match the hash_tree_root of the preceding block.",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/4943/reactions",
    "total_count": 1,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 1
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/4943/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1822101719",
    "html_url": "https://github.com/sigp/lighthouse/issues/4943#issuecomment-1822101719",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4943",
    "id": 1822101719,
    "node_id": "IC_kwDOCFeAzc5smxDX",
    "user": {
      "login": "jimmygchen",
      "id": 742762,
      "node_id": "MDQ6VXNlcjc0Mjc2Mg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/742762?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jimmygchen",
      "html_url": "https://github.com/jimmygchen",
      "followers_url": "https://api.github.com/users/jimmygchen/followers",
      "following_url": "https://api.github.com/users/jimmygchen/following{/other_user}",
      "gists_url": "https://api.github.com/users/jimmygchen/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jimmygchen/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jimmygchen/subscriptions",
      "organizations_url": "https://api.github.com/users/jimmygchen/orgs",
      "repos_url": "https://api.github.com/users/jimmygchen/repos",
      "events_url": "https://api.github.com/users/jimmygchen/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jimmygchen/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-11-22T04:35:35Z",
    "updated_at": "2023-11-22T04:35:35Z",
    "author_association": "MEMBER",
    "body": "@etan-status Thanks for raising this! I'll look into this.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1822101719/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1831300987",
    "html_url": "https://github.com/sigp/lighthouse/issues/4943#issuecomment-1831300987",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4943",
    "id": 1831300987,
    "node_id": "IC_kwDOCFeAzc5tJ297",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-11-29T06:34:41Z",
    "updated_at": "2023-11-29T06:34:41Z",
    "author_association": "MEMBER",
    "body": "I think I know what's happening here.\r\n\r\nWe had a database bug (#4817) which caused the block root at slot 1 **not to be stored** on Holesky _in the case where the node checkpoint synced and backfilled_. We fixed that bug in #4820 in order to fix state reconstruction, however we didn't realise at the time that it would manifest as incorrect BlocksByRange responses. The reason for the incorrect responses is that we store block roots in chunks of 128 at a time. These chunks are default initialised to 0x0, so the block root for slot 1 on buggy Holesky nodes is 0x0. Our database _also_ knows how to resolve the 0x0 root to the genesis block, so in a BlocksByRange we:\r\n\r\n- slot 0: look up the _actual_ genesis block root and get the genesis block\r\n- slot 1: look up the 0x0 genesis block alias and get the genesis block\r\n\r\nThe 0x0 isn't caught by the de-duplication that we apply because it's not equal to the actual genesis block root.\r\n\r\nI think an appropriate fix would be to run a little function at startup on v18 Holesky databases to store the correct block root at slot 1. We didn't implement this initially because we thought the corruption was only relevant to archive nodes, and they were failing loudly.\r\n\r\nTL;DR: some disgusting database junk that only happened on Holesky, requires a patch to fix",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1831300987/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
