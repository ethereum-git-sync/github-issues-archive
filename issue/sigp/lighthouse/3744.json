{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/3744",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/3744/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/3744/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/3744/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/3744",
  "id": 1460213663,
  "node_id": "I_kwDOCFeAzc5XCRef",
  "number": 3744,
  "title": "Bad attestation source votes should be logged",
  "user": {
    "login": "arbora",
    "id": 94296680,
    "node_id": "U_kgDOBZ7aaA",
    "avatar_url": "https://avatars.githubusercontent.com/u/94296680?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/arbora",
    "html_url": "https://github.com/arbora",
    "followers_url": "https://api.github.com/users/arbora/followers",
    "following_url": "https://api.github.com/users/arbora/following{/other_user}",
    "gists_url": "https://api.github.com/users/arbora/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/arbora/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/arbora/subscriptions",
    "organizations_url": "https://api.github.com/users/arbora/orgs",
    "repos_url": "https://api.github.com/users/arbora/repos",
    "events_url": "https://api.github.com/users/arbora/events{/privacy}",
    "received_events_url": "https://api.github.com/users/arbora/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 985647284,
      "node_id": "MDU6TGFiZWw5ODU2NDcyODQ=",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/enhancement",
      "name": "enhancement",
      "color": "a2eeef",
      "default": true,
      "description": "New feature or request"
    },
    {
      "id": 2336802021,
      "node_id": "MDU6TGFiZWwyMzM2ODAyMDIx",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/UX-and-logs",
      "name": "UX-and-logs",
      "color": "DB9046",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2022-11-22T16:42:34Z",
  "updated_at": "2022-11-22T23:51:16Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nWhen Lighthouse logs `ERRO Previous epoch attestation(s) missing`, currently there is no indication whether that attestation was missing because of a bad attestation source vote or not. It should record in the log if a bad source vote occurred, *in addition* to logging the missed attestation.\r\n\r\n## Version\r\n\r\nv3.1.2\r\n\r\n## Present Behaviour\r\n\r\nThe usual two epochs later, when an attestation was missed, Lighthouse logs the following:\r\n\r\n`ERRO Previous epoch attestation(s) missing`\r\n\r\nfor the affected validators. It may also independently log the following, if the target and/or head votes were wrong for any attestations in that previous epoch, potentially including the missing attestation(s):\r\n\r\n`WARN Previous epoch attestation(s) failed to match head`\r\n`WARN Previous epoch attestation(s) failed to match target`\r\n\r\nHowever, it does NOT (to the best of my ability to tell) log if any attestations had incorrect source votes in that previous epoch, presumably because bad source votes always result in missed attestations and so the missed-attestation log supersedes it. But not all missed attestations are a result of a bad source vote, and so having this log would still be useful for debugging, to determine whether or not an attestation was missed due to a bad source vote.\r\n\r\n## Expected Behaviour\r\n\r\nThe following log would be expected any time an attestation in that previous epoch had a bad source vote:\r\n\r\n`WARN Previous epoch attestation(s) failed to match source`\r\n\r\nwith the affected validators listed. This would be *in addition* to the `ERRO Previous epoch attestation(s) missing` log that would be necessarily present in such cases, due to a bad source vote always causing the attestation to miss.\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/3744/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/3744/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1324376153",
    "html_url": "https://github.com/sigp/lighthouse/issues/3744#issuecomment-1324376153",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3744",
    "id": 1324376153,
    "node_id": "IC_kwDOCFeAzc5O8GBZ",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-11-22T23:49:53Z",
    "updated_at": "2022-11-22T23:51:15Z",
    "author_association": "MEMBER",
    "body": "To add a bit of context: one reason this is a bit funny at the moment is because of how attestation accounting works on-chain. In the state we just have a record of 3 bits:\r\n\r\n- One bit for the source vote matching (and being on-time in <=5 slots)\r\n- One bit for the target vote matching (and being on-time in <=32 slots)\r\n- One bit for the head vote matching (on-time in 1 slot by definition)\r\n\r\nSo if all the bits are 0, the attestation is worthless (0 reward) regardless of whether it was actually included on chain or not. Block proposers shouldn't be wasting block space on these attestations, but sometimes they do. I think detecting this is not super useful.\r\n\r\nWhat is more useful is detecting the `010` case where the _target_ matches but the source vote missed because it wasn't included within 5 slots. In this case we should log a more meaningful message about the source vote missing because of the delay. Since Altair there's no precise record of inclusion delay _on-chain_, but the validator monitor already has access to this (or could easily be augmented to track it, I haven't checked).\r\n\r\nIt's also possible we could cover the `000`-but-still-included case with the validator monitor's extra tracking, but I think we should improve the inclusion delay + source reporting first.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1324376153/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
