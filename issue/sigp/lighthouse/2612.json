{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/2612",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/2612/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/2612/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/2612/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/2612",
  "id": 1003688846,
  "node_id": "I_kwDOCFeAzc470xOO",
  "number": 2612,
  "title": "Check proposer index when producing a block",
  "user": {
    "login": "paulhauner",
    "id": 6660660,
    "node_id": "MDQ6VXNlcjY2NjA2NjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/paulhauner",
    "html_url": "https://github.com/paulhauner",
    "followers_url": "https://api.github.com/users/paulhauner/followers",
    "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
    "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
    "organizations_url": "https://api.github.com/users/paulhauner/orgs",
    "repos_url": "https://api.github.com/users/paulhauner/repos",
    "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
    "received_events_url": "https://api.github.com/users/paulhauner/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 985647281,
      "node_id": "MDU6TGFiZWw5ODU2NDcyODE=",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/bug",
      "name": "bug",
      "color": "d73a4a",
      "default": true,
      "description": "Something isn't working"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "pawanjay176",
    "id": 9890508,
    "node_id": "MDQ6VXNlcjk4OTA1MDg=",
    "avatar_url": "https://avatars.githubusercontent.com/u/9890508?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/pawanjay176",
    "html_url": "https://github.com/pawanjay176",
    "followers_url": "https://api.github.com/users/pawanjay176/followers",
    "following_url": "https://api.github.com/users/pawanjay176/following{/other_user}",
    "gists_url": "https://api.github.com/users/pawanjay176/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/pawanjay176/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/pawanjay176/subscriptions",
    "organizations_url": "https://api.github.com/users/pawanjay176/orgs",
    "repos_url": "https://api.github.com/users/pawanjay176/repos",
    "events_url": "https://api.github.com/users/pawanjay176/events{/privacy}",
    "received_events_url": "https://api.github.com/users/pawanjay176/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "pawanjay176",
      "id": 9890508,
      "node_id": "MDQ6VXNlcjk4OTA1MDg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9890508?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pawanjay176",
      "html_url": "https://github.com/pawanjay176",
      "followers_url": "https://api.github.com/users/pawanjay176/followers",
      "following_url": "https://api.github.com/users/pawanjay176/following{/other_user}",
      "gists_url": "https://api.github.com/users/pawanjay176/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pawanjay176/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pawanjay176/subscriptions",
      "organizations_url": "https://api.github.com/users/pawanjay176/orgs",
      "repos_url": "https://api.github.com/users/pawanjay176/repos",
      "events_url": "https://api.github.com/users/pawanjay176/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pawanjay176/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2021-09-22T02:37:45Z",
  "updated_at": "2022-01-20T07:31:14Z",
  "closed_at": "2022-01-20T07:31:14Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nIt came to my attention that it's possible for the VC to publish a block with an invalid signature. Here's the flow:\r\n\r\n1. VC gets proposer duties from the BN\r\n1. BN re-orgs\r\n1. VC requests block from the BN, signs it and returns it.\r\n1. BN publishes it, then verifies it and realises that the block is signed by the wrong validator index.\r\n\r\n## Solutions\r\n\r\nThere are two checks we can implement to prevent this:\r\n\r\n1. Verify the `randao_reveal` in the BN when [producing a block](https://github.com/sigp/lighthouse/blob/f9bba92db3468321b28ddd9010e26b359f88bafe/beacon_node/beacon_chain/src/beacon_chain.rs#L2604-L2623). Presently we verify the block [without checking signatures](https://github.com/sigp/lighthouse/blob/f9bba92db3468321b28ddd9010e26b359f88bafe/beacon_node/beacon_chain/src/beacon_chain.rs#L2782) to speed up block publishing times. If we checked the `randao_reveal` we'd notice that it was signed by the wrong proposer.\r\n1. In the VC, after we [get the block from the BN](https://github.com/sigp/lighthouse/blob/f9bba92db3468321b28ddd9010e26b359f88bafe/validator_client/src/block_service.rs#L269-L273), check that the proposer index matches our request.\r\n\r\n(2) is trivial to implement in terms of runtime cost. (1) is less trivial, but that signature verification should take only a few ms so I think it's worth it.",
  "closed_by": {
    "login": "paulhauner",
    "id": 6660660,
    "node_id": "MDQ6VXNlcjY2NjA2NjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/paulhauner",
    "html_url": "https://github.com/paulhauner",
    "followers_url": "https://api.github.com/users/paulhauner/followers",
    "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
    "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
    "organizations_url": "https://api.github.com/users/paulhauner/orgs",
    "repos_url": "https://api.github.com/users/paulhauner/repos",
    "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
    "received_events_url": "https://api.github.com/users/paulhauner/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/2612/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/2612/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/941080275",
    "html_url": "https://github.com/sigp/lighthouse/issues/2612#issuecomment-941080275",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/2612",
    "id": 941080275,
    "node_id": "IC_kwDOCFeAzc44F77T",
    "user": {
      "login": "pawanjay176",
      "id": 9890508,
      "node_id": "MDQ6VXNlcjk4OTA1MDg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9890508?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pawanjay176",
      "html_url": "https://github.com/pawanjay176",
      "followers_url": "https://api.github.com/users/pawanjay176/followers",
      "following_url": "https://api.github.com/users/pawanjay176/following{/other_user}",
      "gists_url": "https://api.github.com/users/pawanjay176/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pawanjay176/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pawanjay176/subscriptions",
      "organizations_url": "https://api.github.com/users/pawanjay176/orgs",
      "repos_url": "https://api.github.com/users/pawanjay176/repos",
      "events_url": "https://api.github.com/users/pawanjay176/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pawanjay176/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-10-12T14:44:39Z",
    "updated_at": "2021-10-12T14:45:06Z",
    "author_association": "MEMBER",
    "body": "@paulhauner Are you saying we need to implement both the checks? Just one of them should do right?\r\n\r\nAlso, I assume the correct duty is sent to proposer_duties in case of a re-org and that's why it's safe to just reject the bad block without doing anything else?",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/941080275/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/947380289",
    "html_url": "https://github.com/sigp/lighthouse/issues/2612#issuecomment-947380289",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/2612",
    "id": 947380289,
    "node_id": "IC_kwDOCFeAzc44d-BB",
    "user": {
      "login": "paulhauner",
      "id": 6660660,
      "node_id": "MDQ6VXNlcjY2NjA2NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/paulhauner",
      "html_url": "https://github.com/paulhauner",
      "followers_url": "https://api.github.com/users/paulhauner/followers",
      "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
      "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
      "organizations_url": "https://api.github.com/users/paulhauner/orgs",
      "repos_url": "https://api.github.com/users/paulhauner/repos",
      "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/paulhauner/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-10-20T06:53:37Z",
    "updated_at": "2021-10-20T06:53:37Z",
    "author_association": "MEMBER",
    "body": "> Are you saying we need to implement both the checks? Just one of them should do right?\r\n\r\nIt might be worth doing both, then we protect both the VC and BN as separate pieces of software.\r\n\r\n> Also, I assume the correct duty is sent to proposer_duties in case of a re-org and that's why it's safe to just reject the bad block without doing anything else?\r\n\r\nYep, that's right. We assume that if the re-org means another block should be produced soon (unlikely), then we'll do that.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/947380289/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
