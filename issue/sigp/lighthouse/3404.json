{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/3404",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/3404/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/3404/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/3404/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/3404",
  "id": 1325192699,
  "node_id": "I_kwDOCFeAzc5O_NX7",
  "number": 3404,
  "title": "Counterintuitive `warp` error for `Unsupported endpoint version`",
  "user": {
    "login": "michaelsproul",
    "id": 4452260,
    "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/michaelsproul",
    "html_url": "https://github.com/michaelsproul",
    "followers_url": "https://api.github.com/users/michaelsproul/followers",
    "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
    "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
    "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
    "repos_url": "https://api.github.com/users/michaelsproul/repos",
    "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
    "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 985647281,
      "node_id": "MDU6TGFiZWw5ODU2NDcyODE=",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/bug",
      "name": "bug",
      "color": "d73a4a",
      "default": true,
      "description": "Something isn't working"
    },
    {
      "id": 985647286,
      "node_id": "MDU6TGFiZWw5ODU2NDcyODY=",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/good%20first%20issue",
      "name": "good first issue",
      "color": "7057ff",
      "default": true,
      "description": "Good for newcomers"
    },
    {
      "id": 2336800343,
      "node_id": "MDU6TGFiZWwyMzM2ODAwMzQz",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/HTTP-API",
      "name": "HTTP-API",
      "color": "5A63A2",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2022-08-02T02:14:55Z",
  "updated_at": "2023-06-06T01:03:34Z",
  "closed_at": null,
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nWhen hitting the `/eth/v2/validators/blocks/{slot}` endpoint with an invalid `randao_reveal` (and `verify_randao=true` or empty) Lighthouse will return this error:\r\n\r\n```\r\n$ curl \"http://localhost:5052/eth/v2/validator/blocks/1000000\"\r\n{\"code\":400,\"message\":\"BAD_REQUEST: Unsupported endpoint version: v2\",\"stacktraces\":[]}\r\n```\r\n\r\nThis makes _zero sense_, as the endpoint is cleared declared supporting v2 here:\r\n\r\nhttps://github.com/sigp/lighthouse/blob/2983235650811437b44199f9c94e517e948a1e9b/beacon_node/http_api/src/lib.rs#L1928-L1935\r\n\r\nAdding a panic to `unsupported_endpoint_version` to get a backtrace shows some funky `warp` stuff going on:\r\n\r\n```\r\nthread 'tokio-runtime-worker' panicked at 'unsupported_version_rejection: v2', beacon_node/http_api/src/version.rs:60:5\r\nstack backtrace:\r\n   0: rust_begin_unwind\r\n             at /rustc/e092d0b6b43f2de967af0887873151bb1c0b18d3/library/std/src/panicking.rs:584:5\r\n   1: core::panicking::panic_fmt\r\n             at /rustc/e092d0b6b43f2de967af0887873151bb1c0b18d3/library/core/src/panicking.rs:142:14\r\n   2: http_api::version::unsupported_version_rejection\r\n   3: <warp::filter::and_then::AndThenFuture<T,F> as core::future::future::Future>::poll\r\n   4: <warp::filter::and::AndFuture<T,U> as core::future::future::Future>::poll\r\n   5: <warp::filter::and::AndFuture<T,U> as core::future::future::Future>::poll\r\n   6: <warp::filter::and::AndFuture<T,U> as core::future::future::Future>::poll\r\n   7: <warp::filter::and::AndFuture<T,U> as core::future::future::Future>::poll\r\n   8: <warp::filter::and_then::AndThenFuture<T,F> as core::future::future::Future>::poll\r\n   9: <futures_util::future::try_future::into_future::IntoFuture<Fut> as core::future::future::Future>::poll\r\n  10: <warp::filter::or::EitherFuture<T,U> as core::future::future::Future>::poll\r\n  11: <warp::filter::or::EitherFuture<T,U> as core::future::future::Future>::poll\r\n  12: <F as futures_core::future::TryFuture>::try_poll\r\n  13: <warp::filter::or::EitherFuture<T,U> as core::future::future::Future>::poll\r\n  14: <warp::filter::and::AndFuture<T,U> as core::future::future::Future>::poll\r\n  15: <warp::filter::or::EitherFuture<T,U> as core::future::future::Future>::poll\r\n  16: <warp::filter::recover::RecoverFuture<T,F> as core::future::future::Future>::poll\r\n  17: <warp::filters::log::internal::WithLogFuture<FN,F> as core::future::future::Future>::poll\r\n  18: <warp::filters::cors::internal::WrappedFuture<F> as core::future::future::Future>::poll\r\n  19: scoped_tls::ScopedKey<T>::set\r\n  20: <warp::filter::service::FilteredFuture<F> as core::future::future::Future>::poll\r\n  21: hyper::proto::h1::dispatch::Dispatcher<D,Bs,I,T>::poll_catch\r\n  22: <hyper::server::conn::upgrades::UpgradeableConnection<I,S,E> as core::future::future::Future>::poll\r\n  23: <hyper::server::server::new_svc::NewSvcTask<I,N,S,E,W> as core::future::future::Future>::poll\r\n  24: tokio::runtime::task::core::CoreStage<T>::poll\r\n  25: tokio::runtime::task::harness::Harness<T,S>::poll\r\n  26: std::thread::local::LocalKey<T>::with\r\n  27: tokio::runtime::thread_pool::worker::Context::run_task\r\n  28: tokio::runtime::thread_pool::worker::Context::run\r\n  29: tokio::macros::scoped_tls::ScopedKey<T>::set\r\n  30: tokio::runtime::thread_pool::worker::run\r\n  31: <tokio::runtime::blocking::task::BlockingTask<T> as core::future::future::Future>::poll\r\n  32: tokio::runtime::task::harness::Harness<T,S>::poll\r\n  33: tokio::runtime::blocking::pool::Inner::run\r\nnote: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.\r\n```\r\n\r\ni.e. it seems that `warp` is doing some counterintuitive backtracking through a few `and_then`/`and`/`or` until it hits the `unsupported_version_endpoint` for a _different_ endpoint (one that is `v1` only). This makes little sense to me, and would probably require someone to dig pretty deep into `warp` to understand why this happens. I think this is similar to another open issue (https://github.com/sigp/lighthouse/issues/3112) related to our apparent misuse of `warp` combinators.\r\n\r\nFinally, if `verify_randao=false` is set or the randao reveal is valid then no error occurs:\r\n\r\n```\r\n$ curl \"http://localhost:5052/eth/v2/validator/blocks/3574858?verify_randao=false\"\r\n{ .. }\r\n```\r\n\r\n## Version\r\n\r\nv2.5.0\r\n\r\n## Related issues\r\n\r\n- https://github.com/sigp/lighthouse/issues/3112",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/3404/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/3404/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1201942831",
    "html_url": "https://github.com/sigp/lighthouse/issues/3404#issuecomment-1201942831",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3404",
    "id": 1201942831,
    "node_id": "IC_kwDOCFeAzc5HpDEv",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-02T02:26:46Z",
    "updated_at": "2022-08-02T02:26:46Z",
    "author_association": "MEMBER",
    "body": "It may be that we want to avoid `and_then` for our handlers and instead use `then`. The `warp` docs state:\r\n\r\n> Rejections are meant to say “this filter didn’t accept the request, maybe another can”. So for application-level errors, consider using [Filter::then](https://docs.rs/warp/0.3.2/warp/trait.Filter.html#method.then) instead.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1201942831/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1500988532",
    "html_url": "https://github.com/sigp/lighthouse/issues/3404#issuecomment-1500988532",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3404",
    "id": 1500988532,
    "node_id": "IC_kwDOCFeAzc5Zd0R0",
    "user": {
      "login": "muang0",
      "id": 28738612,
      "node_id": "MDQ6VXNlcjI4NzM4NjEy",
      "avatar_url": "https://avatars.githubusercontent.com/u/28738612?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/muang0",
      "html_url": "https://github.com/muang0",
      "followers_url": "https://api.github.com/users/muang0/followers",
      "following_url": "https://api.github.com/users/muang0/following{/other_user}",
      "gists_url": "https://api.github.com/users/muang0/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/muang0/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/muang0/subscriptions",
      "organizations_url": "https://api.github.com/users/muang0/orgs",
      "repos_url": "https://api.github.com/users/muang0/repos",
      "events_url": "https://api.github.com/users/muang0/events{/privacy}",
      "received_events_url": "https://api.github.com/users/muang0/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-08T22:21:08Z",
    "updated_at": "2023-04-08T22:21:08Z",
    "author_association": "NONE",
    "body": "I'll look into this one and follow up, thx",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1500988532/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 1,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1577745605",
    "html_url": "https://github.com/sigp/lighthouse/issues/3404#issuecomment-1577745605",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3404",
    "id": 1577745605,
    "node_id": "IC_kwDOCFeAzc5eCnzF",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-06-06T01:03:33Z",
    "updated_at": "2023-06-06T01:03:33Z",
    "author_association": "MEMBER",
    "body": "> It may be that we want to avoid and_then for our handlers and instead use then.\r\n\r\n@jmcph4 and I got this working on https://github.com/sigp/lighthouse/pull/4316. Our approach avoids returning a `warp::reject::Reject` for errors in the handlers themselves. For now we're converting the rejects into error responses using `handle_rejection`, like this:\r\n\r\nhttps://github.com/sigp/lighthouse/blob/73b30a64472455fa555896b70559b5a55c335db3/beacon_node/http_api/src/lib.rs#L1232-L1264\r\n\r\nJack will fix just the new v2/blocks endpoints in that PR, and this issue can remain open until we roll out the fix across the codebase. We might want to write a small abstraction to minimise the amount of code duplication (something like `then_or_reject`, `then_or_error`).",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1577745605/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
