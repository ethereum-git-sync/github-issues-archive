{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/1856",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/1856/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/1856/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/1856/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/1856",
  "id": 735363416,
  "node_id": "MDU6SXNzdWU3MzUzNjM0MTY=",
  "number": 1856,
  "title": "Centralize the conditions to decide if a peer is relevant and their sync status",
  "user": {
    "login": "divagant-martian",
    "id": 26765164,
    "node_id": "MDQ6VXNlcjI2NzY1MTY0",
    "avatar_url": "https://avatars.githubusercontent.com/u/26765164?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/divagant-martian",
    "html_url": "https://github.com/divagant-martian",
    "followers_url": "https://api.github.com/users/divagant-martian/followers",
    "following_url": "https://api.github.com/users/divagant-martian/following{/other_user}",
    "gists_url": "https://api.github.com/users/divagant-martian/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/divagant-martian/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/divagant-martian/subscriptions",
    "organizations_url": "https://api.github.com/users/divagant-martian/orgs",
    "repos_url": "https://api.github.com/users/divagant-martian/repos",
    "events_url": "https://api.github.com/users/divagant-martian/events{/privacy}",
    "received_events_url": "https://api.github.com/users/divagant-martian/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1690958121,
      "node_id": "MDU6TGFiZWwxNjkwOTU4MTIx",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/code-quality",
      "name": "code-quality",
      "color": "77a7ff",
      "default": false,
      "description": ""
    },
    {
      "id": 2336800125,
      "node_id": "MDU6TGFiZWwyMzM2ODAwMTI1",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/t%20Networking",
      "name": "t Networking",
      "color": "40E0D0",
      "default": false,
      "description": ""
    },
    {
      "id": 2490303709,
      "node_id": "MDU6TGFiZWwyNDkwMzAzNzA5",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/A0",
      "name": "A0",
      "color": "bc3e3a",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2020-11-03T14:26:16Z",
  "updated_at": "2020-11-16T18:54:07Z",
  "closed_at": "2020-11-16T18:54:07Z",
  "author_association": "COLLABORATOR",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nThe conditions we use to decide if a peer is advanced, synced or behind, or relevant to the chain to begin with, are split over a couple of different parts of the code and it's not entirely clear how they get along. We should centralize this logic for maintainability and to reason about this more easily.\r\n\r\nParts that I identify:\r\n1. We have [the `process_status` function in the router's processor](https://github.com/sigp/lighthouse/blob/0a0f4daf9d3539ad75e4c50a96ccb910337e3813/beacon_node/network/src/router/processor.rs#L189-L310). This function for some cases disconnects a peer, for others it informs the sync manager and for other (\"naive\" peer it does nothing else). This last part seems interesting since the sync manages does have the logic to deal with behind peers.\r\n2. We also have the [`PeerSyncInfo`](https://github.com/sigp/lighthouse/blob/0a0f4daf9d3539ad75e4c50a96ccb910337e3813/beacon_node/network/src/sync/peer_sync_info.rs#L53-L108) where we get most of the sync status of a peer if it gets to the sync manager.\r\n3. We have [additional logic in the `SyncManager`](https://github.com/sigp/lighthouse/blob/0a0f4daf9d3539ad75e4c50a96ccb910337e3813/beacon_node/network/src/sync/manager.rs#L279-L308) for when a peer is said to be Advanced wrt to the `PeerSyncInfo`\r\n\r\n## Version\r\nmaster 0a0f4daf9d3539ad75e4c50a96ccb910337e3813",
  "closed_by": {
    "login": "divagant-martian",
    "id": 26765164,
    "node_id": "MDQ6VXNlcjI2NzY1MTY0",
    "avatar_url": "https://avatars.githubusercontent.com/u/26765164?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/divagant-martian",
    "html_url": "https://github.com/divagant-martian",
    "followers_url": "https://api.github.com/users/divagant-martian/followers",
    "following_url": "https://api.github.com/users/divagant-martian/following{/other_user}",
    "gists_url": "https://api.github.com/users/divagant-martian/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/divagant-martian/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/divagant-martian/subscriptions",
    "organizations_url": "https://api.github.com/users/divagant-martian/orgs",
    "repos_url": "https://api.github.com/users/divagant-martian/repos",
    "events_url": "https://api.github.com/users/divagant-martian/events{/privacy}",
    "received_events_url": "https://api.github.com/users/divagant-martian/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/1856/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/1856/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/723693744",
    "html_url": "https://github.com/sigp/lighthouse/issues/1856#issuecomment-723693744",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1856",
    "id": 723693744,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcyMzY5Mzc0NA==",
    "user": {
      "login": "paulhauner",
      "id": 6660660,
      "node_id": "MDQ6VXNlcjY2NjA2NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/paulhauner",
      "html_url": "https://github.com/paulhauner",
      "followers_url": "https://api.github.com/users/paulhauner/followers",
      "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
      "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
      "organizations_url": "https://api.github.com/users/paulhauner/orgs",
      "repos_url": "https://api.github.com/users/paulhauner/repos",
      "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/paulhauner/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-11-09T00:39:29Z",
    "updated_at": "2020-11-09T00:39:29Z",
    "author_association": "MEMBER",
    "body": "@divagant-martian please feel free to set this to `A0` if you see fit :)",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/723693744/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/724338403",
    "html_url": "https://github.com/sigp/lighthouse/issues/1856#issuecomment-724338403",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1856",
    "id": 724338403,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcyNDMzODQwMw==",
    "user": {
      "login": "AgeManning",
      "id": 7454587,
      "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AgeManning",
      "html_url": "https://github.com/AgeManning",
      "followers_url": "https://api.github.com/users/AgeManning/followers",
      "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
      "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
      "organizations_url": "https://api.github.com/users/AgeManning/orgs",
      "repos_url": "https://api.github.com/users/AgeManning/repos",
      "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AgeManning/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-11-09T23:16:00Z",
    "updated_at": "2020-11-09T23:16:00Z",
    "author_association": "MEMBER",
    "body": "Yes. I agree it probably makes sense to group all this logic. \r\n\r\nIn my mind these have been behaving as three layers of filters (in the order you have listed them). \r\n\r\nThe first is a high level filter. This does basic fork checking and more obvious checks based on their status. If they pass this filter and have some use for sync, they then get further evaluated in `PeerSyncInfo`. \r\n\r\nDepending on this phase, the peer can be either synced, or we may need to start a long-range sync. If we need to do a long range sync we send the peer to that module which then gets further evaluated into the type of long range sync as listed in your point 3. \r\n\r\nThere is some small additional logic in the `add_peer()` function in the sync manager also. \r\n\r\nI guess the logic is split as a peer progresses through the different modules router -> manager -> range-sync and each have their own \"filtering\" or identifying of the peer. \r\n\r\nCurious about how this could be re-structured. If we handle all logic in the router, I think we still have to send the peer -> manager -> range-sync if a range-sync is required. \r\n\r\n\r\n\r\n\r\n\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/724338403/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/728257145",
    "html_url": "https://github.com/sigp/lighthouse/issues/1856#issuecomment-728257145",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1856",
    "id": 728257145,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcyODI1NzE0NQ==",
    "user": {
      "login": "divagant-martian",
      "id": 26765164,
      "node_id": "MDQ6VXNlcjI2NzY1MTY0",
      "avatar_url": "https://avatars.githubusercontent.com/u/26765164?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/divagant-martian",
      "html_url": "https://github.com/divagant-martian",
      "followers_url": "https://api.github.com/users/divagant-martian/followers",
      "following_url": "https://api.github.com/users/divagant-martian/following{/other_user}",
      "gists_url": "https://api.github.com/users/divagant-martian/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/divagant-martian/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/divagant-martian/subscriptions",
      "organizations_url": "https://api.github.com/users/divagant-martian/orgs",
      "repos_url": "https://api.github.com/users/divagant-martian/repos",
      "events_url": "https://api.github.com/users/divagant-martian/events{/privacy}",
      "received_events_url": "https://api.github.com/users/divagant-martian/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-11-16T18:54:07Z",
    "updated_at": "2020-11-16T18:54:07Z",
    "author_association": "COLLABORATOR",
    "body": "Closed by #1896 ",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/728257145/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
