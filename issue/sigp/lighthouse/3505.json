{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/3505",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/3505/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/3505/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/3505/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/3505",
  "id": 1350310021,
  "node_id": "I_kwDOCFeAzc5QfBiF",
  "number": 3505,
  "title": "Store pubkey cache decompressed on disk",
  "user": {
    "login": "michaelsproul",
    "id": 4452260,
    "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/michaelsproul",
    "html_url": "https://github.com/michaelsproul",
    "followers_url": "https://api.github.com/users/michaelsproul/followers",
    "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
    "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
    "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
    "repos_url": "https://api.github.com/users/michaelsproul/repos",
    "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
    "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1999784343,
      "node_id": "MDU6TGFiZWwxOTk5Nzg0MzQz",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/optimization",
      "name": "optimization",
      "color": "f9de40",
      "default": false,
      "description": "Something to make Lighthouse run more efficiently."
    },
    {
      "id": 2085863304,
      "node_id": "MDU6TGFiZWwyMDg1ODYzMzA0",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/crypto",
      "name": "crypto",
      "color": "d93f0b",
      "default": false,
      "description": "An issue/PR that touches cryptography code."
    },
    {
      "id": 2336798682,
      "node_id": "MDU6TGFiZWwyMzM2Nzk4Njgy",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/database",
      "name": "database",
      "color": "C01C9D",
      "default": false,
      "description": ""
    },
    {
      "id": 2894028867,
      "node_id": "MDU6TGFiZWwyODk0MDI4ODY3",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/backwards-incompat",
      "name": "backwards-incompat",
      "color": "FEF2C0",
      "default": false,
      "description": "Backwards-incompatible API change"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": {
    "login": "michaelsproul",
    "id": 4452260,
    "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/michaelsproul",
    "html_url": "https://github.com/michaelsproul",
    "followers_url": "https://api.github.com/users/michaelsproul/followers",
    "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
    "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
    "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
    "repos_url": "https://api.github.com/users/michaelsproul/repos",
    "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
    "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2022-08-25T04:36:37Z",
  "updated_at": "2022-12-20T09:34:52Z",
  "closed_at": null,
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nCurrently Lighthouse takes a long time to start up while it reloads the public key cache from disk.\r\n\r\nThe fundamental reason for this is that it stores the BLS pubkeys in their compressed form and then has to decompress every one of them for the in-memory cache:\r\n\r\nhttps://github.com/sigp/lighthouse/blob/18c61a5e8be3e54226a86a69b96f8f4f7fd790e4/beacon_node/beacon_chain/src/validator_pubkey_cache.rs#L166-L169\r\n\r\nJust changing that `PublicKeyBytes` to `PublicKey` would not be sufficient, because the two types share the same compressed SSZ representation:\r\n\r\nhttps://github.com/sigp/lighthouse/blob/18c61a5e8be3e54226a86a69b96f8f4f7fd790e4/crypto/bls/src/macros.rs#L29-L50\r\n\r\nhttps://github.com/sigp/lighthouse/blob/18c61a5e8be3e54226a86a69b96f8f4f7fd790e4/crypto/bls/src/impls/blst.rs#L121-L124\r\n\r\nSo we would need to create new methods on `bls::GenericPublicKey` like `serialize_uncompressed` and `deserialize_uncompressed` which use the 96-byte serialization of the `PublicKey` rather than the 48-byte compressed serialization. For `blst`, we can use the [`PublicKey::serialize`](https://docs.rs/blst/0.3.10/blst/min_pk/struct.PublicKey.html#method.serialize) function. For `milagro` we can use [`PublicKey::as_uncompressed_bytes`](https://github.com/sigp/milagro_bls/blob/421aa3af8a0618a46144560389debbe7e56609db/src/keys.rs#L159-L162). Both libraries also include deserialisation functions acting on the uncompressed bytes.\r\n\r\nOnce these methods are in place in the `bls` wrapper lib, we can call them from the `DatabasePubkey` wrapper. We'll need two versions of `DatabasePubkey` in order to implement the schema migration from compressed keys to uncompressed keys.\r\n\r\nBy storing the bytes uncompressed we'll double the disk space required for the pubkey cache from 500k * 48 bytes = 24 MB to 48 MB. Given the overall size of the database I believe this is an acceptable trade-off. We could attempt to apply a faster compression algorithm like `zstd` to the data, but seeing as the input is pseudo-random bytes I suspect this naive compression would be ineffective.\r\n\r\n## Version\r\n\r\nLighthouse v3.0.0\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/3505/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/3505/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1252530070",
    "html_url": "https://github.com/sigp/lighthouse/issues/3505#issuecomment-1252530070",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3505",
    "id": 1252530070,
    "node_id": "IC_kwDOCFeAzc5KqBeW",
    "user": {
      "login": "ethDreamer",
      "id": 37123614,
      "node_id": "MDQ6VXNlcjM3MTIzNjE0",
      "avatar_url": "https://avatars.githubusercontent.com/u/37123614?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ethDreamer",
      "html_url": "https://github.com/ethDreamer",
      "followers_url": "https://api.github.com/users/ethDreamer/followers",
      "following_url": "https://api.github.com/users/ethDreamer/following{/other_user}",
      "gists_url": "https://api.github.com/users/ethDreamer/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ethDreamer/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ethDreamer/subscriptions",
      "organizations_url": "https://api.github.com/users/ethDreamer/orgs",
      "repos_url": "https://api.github.com/users/ethDreamer/repos",
      "events_url": "https://api.github.com/users/ethDreamer/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ethDreamer/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-20T15:29:43Z",
    "updated_at": "2022-09-20T15:30:01Z",
    "author_association": "COLLABORATOR",
    "body": "I've decided to work on withdrawals for now and I'll come back to this if someone doesn't hop on it :)",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1252530070/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 1,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1272192976",
    "html_url": "https://github.com/sigp/lighthouse/issues/3505#issuecomment-1272192976",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3505",
    "id": 1272192976,
    "node_id": "IC_kwDOCFeAzc5L1B_Q",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-10-08T01:44:45Z",
    "updated_at": "2022-10-08T01:44:45Z",
    "author_association": "MEMBER",
    "body": "I'm making some changes to the on-disk pubkey cache in my tree-states PR, so it may make sense to roll this schema upgrade in there at the same time. Do you mind if I pick this one up @ethDreamer? 🙏",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1272192976/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1272193225",
    "html_url": "https://github.com/sigp/lighthouse/issues/3505#issuecomment-1272193225",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3505",
    "id": 1272193225,
    "node_id": "IC_kwDOCFeAzc5L1CDJ",
    "user": {
      "login": "ethDreamer",
      "id": 37123614,
      "node_id": "MDQ6VXNlcjM3MTIzNjE0",
      "avatar_url": "https://avatars.githubusercontent.com/u/37123614?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ethDreamer",
      "html_url": "https://github.com/ethDreamer",
      "followers_url": "https://api.github.com/users/ethDreamer/followers",
      "following_url": "https://api.github.com/users/ethDreamer/following{/other_user}",
      "gists_url": "https://api.github.com/users/ethDreamer/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ethDreamer/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ethDreamer/subscriptions",
      "organizations_url": "https://api.github.com/users/ethDreamer/orgs",
      "repos_url": "https://api.github.com/users/ethDreamer/repos",
      "events_url": "https://api.github.com/users/ethDreamer/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ethDreamer/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-10-08T01:46:19Z",
    "updated_at": "2022-10-08T01:46:19Z",
    "author_association": "COLLABORATOR",
    "body": "Yeah for sure 😊",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1272193225/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 1,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1359053315",
    "html_url": "https://github.com/sigp/lighthouse/issues/3505#issuecomment-1359053315",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3505",
    "id": 1359053315,
    "node_id": "IC_kwDOCFeAzc5RAYID",
    "user": {
      "login": "jclapis",
      "id": 627896,
      "node_id": "MDQ6VXNlcjYyNzg5Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/627896?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jclapis",
      "html_url": "https://github.com/jclapis",
      "followers_url": "https://api.github.com/users/jclapis/followers",
      "following_url": "https://api.github.com/users/jclapis/following{/other_user}",
      "gists_url": "https://api.github.com/users/jclapis/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jclapis/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jclapis/subscriptions",
      "organizations_url": "https://api.github.com/users/jclapis/orgs",
      "repos_url": "https://api.github.com/users/jclapis/repos",
      "events_url": "https://api.github.com/users/jclapis/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jclapis/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-20T09:15:52Z",
    "updated_at": "2022-12-20T09:15:52Z",
    "author_association": "NONE",
    "body": "Checking in on this - has it been put on the backburner for a while?",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1359053315/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1359063010",
    "html_url": "https://github.com/sigp/lighthouse/issues/3505#issuecomment-1359063010",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3505",
    "id": 1359063010,
    "node_id": "IC_kwDOCFeAzc5RAafi",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-20T09:23:33Z",
    "updated_at": "2022-12-20T09:34:52Z",
    "author_association": "MEMBER",
    "body": "~~@jclapis It's fixed in `unstable`! (or should be)~~\r\n\r\n~~We're just waiting on the new year (and a few more features) to ship v3.4.0~~\r\n\r\nMy bad, I was thinking of the `ValidatorPubkeyCache` lock timeouts!\r\n\r\nThis is implemented and working on the `tree-states` branch. We're planning an alpha or beta release of that branch soon, but it touches _everything_ so we're being cautious. We're also doing a bunch of database cleanups all in one go, so we want to make sure it's perfect so we don't need to do it multiple times.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1359063010/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
