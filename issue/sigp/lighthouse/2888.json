{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/2888",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/2888/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/2888/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/2888/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/2888",
  "id": 1091549291,
  "node_id": "I_kwDOCFeAzc5BD7hr",
  "number": 2888,
  "title": "Improve redundancy behavior",
  "user": {
    "login": "poupas",
    "id": 265706,
    "node_id": "MDQ6VXNlcjI2NTcwNg==",
    "avatar_url": "https://avatars.githubusercontent.com/u/265706?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/poupas",
    "html_url": "https://github.com/poupas",
    "followers_url": "https://api.github.com/users/poupas/followers",
    "following_url": "https://api.github.com/users/poupas/following{/other_user}",
    "gists_url": "https://api.github.com/users/poupas/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/poupas/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/poupas/subscriptions",
    "organizations_url": "https://api.github.com/users/poupas/orgs",
    "repos_url": "https://api.github.com/users/poupas/repos",
    "events_url": "https://api.github.com/users/poupas/events{/privacy}",
    "received_events_url": "https://api.github.com/users/poupas/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 985647284,
      "node_id": "MDU6TGFiZWw5ODU2NDcyODQ=",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/enhancement",
      "name": "enhancement",
      "color": "a2eeef",
      "default": true,
      "description": "New feature or request"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2021-12-31T12:13:49Z",
  "updated_at": "2022-02-07T00:17:53Z",
  "closed_at": "2022-02-07T00:17:53Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nHello. I have been testing the \"multi-beacon node\" feature for redundancy purposes. It works well, provided the failover beacon node is listening on all subnets, as noted in the documentation.\r\n\r\n## Version\r\n\r\nLighthouse/v2.0.1-fff01b2\r\n\r\n## Present Behaviour\r\n\r\nI think the \"fail-back\" behavior could be slightly improved. Right now, when the primary beacon node comes back online and changes its state to \"synced\", the validator is very eager to use the primary node again. In my experience, this seems to have resulted in missed attestations. Even tough the node reports its state as synced, the peer count is still quite low, and this could explain the observed behavior.\r\n\r\n## Expected Behaviour\r\n\r\nSuggestion: as long as the failover beacon node is working correctly, there is no urgent need to change back to the primary beacon node.\r\n\r\nThe validator could wait until the primary beacon node peer count has stabilized, or some time has passed. Additionally, it could request the primary beacon node to subscribe to the subnets the validator is interested in, before switching back to the primary. This way, the primary node wouldn't need to subscribe to all subnets by default.\r\n\r\nI believe this could improve the chances of attestations being seen by the network during fail-back.\r\n\r\n",
  "closed_by": {
    "login": "paulhauner",
    "id": 6660660,
    "node_id": "MDQ6VXNlcjY2NjA2NjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/paulhauner",
    "html_url": "https://github.com/paulhauner",
    "followers_url": "https://api.github.com/users/paulhauner/followers",
    "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
    "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
    "organizations_url": "https://api.github.com/users/paulhauner/orgs",
    "repos_url": "https://api.github.com/users/paulhauner/repos",
    "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
    "received_events_url": "https://api.github.com/users/paulhauner/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/2888/reactions",
    "total_count": 4,
    "+1": 3,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 1,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/2888/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1008251216",
    "html_url": "https://github.com/sigp/lighthouse/issues/2888#issuecomment-1008251216",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/2888",
    "id": 1008251216,
    "node_id": "IC_kwDOCFeAzc48GLFQ",
    "user": {
      "login": "enforest",
      "id": 1701614,
      "node_id": "MDQ6VXNlcjE3MDE2MTQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1701614?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/enforest",
      "html_url": "https://github.com/enforest",
      "followers_url": "https://api.github.com/users/enforest/followers",
      "following_url": "https://api.github.com/users/enforest/following{/other_user}",
      "gists_url": "https://api.github.com/users/enforest/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/enforest/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/enforest/subscriptions",
      "organizations_url": "https://api.github.com/users/enforest/orgs",
      "repos_url": "https://api.github.com/users/enforest/repos",
      "events_url": "https://api.github.com/users/enforest/events{/privacy}",
      "received_events_url": "https://api.github.com/users/enforest/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-01-09T08:16:57Z",
    "updated_at": "2022-01-09T08:16:57Z",
    "author_association": "NONE",
    "body": "Agreed. The validator should track peer count of the beacon nodes. Beacon nodes with peer count lower than a threshold should be marked as unusable to decrease the risk of failure in publishing attestations.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1008251216/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1008438208",
    "html_url": "https://github.com/sigp/lighthouse/issues/2888#issuecomment-1008438208",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/2888",
    "id": 1008438208,
    "node_id": "IC_kwDOCFeAzc48G4vA",
    "user": {
      "login": "paulhauner",
      "id": 6660660,
      "node_id": "MDQ6VXNlcjY2NjA2NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/paulhauner",
      "html_url": "https://github.com/paulhauner",
      "followers_url": "https://api.github.com/users/paulhauner/followers",
      "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
      "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
      "organizations_url": "https://api.github.com/users/paulhauner/orgs",
      "repos_url": "https://api.github.com/users/paulhauner/repos",
      "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/paulhauner/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-01-09T22:41:15Z",
    "updated_at": "2022-01-09T22:41:15Z",
    "author_association": "MEMBER",
    "body": "This is great feedback, thank you! I think we could definitely improve here. I'll add a few comments regarding my thoughts:\r\n\r\n> Suggestion: as long as the failover beacon node is working correctly, there is no urgent need to change back to the primary beacon node.\r\n\r\nThis might not be ideal for users who have a paid service (Infura) as their back-up. I imagine they'd want to switch back to their primary node when ready.\r\n\r\n> Additionally, it could request the primary beacon node to subscribe to the subnets the validator is interested in, before switching back to the primary. \r\n\r\nThis would be helpful indeed. I have considered a setup where subscription requests go to *all* nodes, rather than just active one. It does have a cost of making the backup nodes work harder, though.\r\n\r\n> The validator could wait until the primary beacon node peer count has stabilized, or some time has passed.\r\n\r\nThe simplest solution here I think is \"some time has passed\". I.e., wait some period after a BN comes online before we switch back to it. Just waiting isn't ideal, but it does save us some complexity regarding judging what's a \"good\" peer count, especially when the BN might not be Lighthouse. It might be that some nodes have a purposefully low peer count or the network is unstable so there aren't many peers.\r\n\r\nPerhaps this logic would be suitable: *\"when using an endpoint, if a higher-priority endpoint comes online, wait 2 epochs before connecting to it\"*.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1008438208/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1008788775",
    "html_url": "https://github.com/sigp/lighthouse/issues/2888#issuecomment-1008788775",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/2888",
    "id": 1008788775,
    "node_id": "IC_kwDOCFeAzc48IOUn",
    "user": {
      "login": "poupas",
      "id": 265706,
      "node_id": "MDQ6VXNlcjI2NTcwNg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/265706?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/poupas",
      "html_url": "https://github.com/poupas",
      "followers_url": "https://api.github.com/users/poupas/followers",
      "following_url": "https://api.github.com/users/poupas/following{/other_user}",
      "gists_url": "https://api.github.com/users/poupas/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/poupas/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/poupas/subscriptions",
      "organizations_url": "https://api.github.com/users/poupas/orgs",
      "repos_url": "https://api.github.com/users/poupas/repos",
      "events_url": "https://api.github.com/users/poupas/events{/privacy}",
      "received_events_url": "https://api.github.com/users/poupas/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-01-10T11:34:06Z",
    "updated_at": "2022-01-10T13:50:12Z",
    "author_association": "NONE",
    "body": "> This would be helpful indeed. I have considered a setup where subscription requests go to _all_ nodes, rather than just active one. It does have a cost of making the backup nodes work harder, though.\r\n> \r\nI like this idea a lot. Right now, my backup node has to subscribe to all subnets to be useful during a failover. I only have 1 validator, but my backup beacon node is working \"furiously\", listening and forwarding attestations on all subnets so that one day, it may be called upon. If the validator could ask the backup BC to only subscribe to the subnets it's interested on, I think that might help the environment :)",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1008788775/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1030950250",
    "html_url": "https://github.com/sigp/lighthouse/issues/2888#issuecomment-1030950250",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/2888",
    "id": 1030950250,
    "node_id": "IC_kwDOCFeAzc49cw1q",
    "user": {
      "login": "paulhauner",
      "id": 6660660,
      "node_id": "MDQ6VXNlcjY2NjA2NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/paulhauner",
      "html_url": "https://github.com/paulhauner",
      "followers_url": "https://api.github.com/users/paulhauner/followers",
      "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
      "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
      "organizations_url": "https://api.github.com/users/paulhauner/orgs",
      "repos_url": "https://api.github.com/users/paulhauner/repos",
      "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/paulhauner/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-02-07T00:17:52Z",
    "updated_at": "2022-02-07T00:17:52Z",
    "author_association": "MEMBER",
    "body": "I've opened #3001 and #3002 to track the two enhancements we discussed.\r\n\r\nI'm going to close this and we can track each change individually. Thanks for the discussion, feel free to reopen if you like :)",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1030950250/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
