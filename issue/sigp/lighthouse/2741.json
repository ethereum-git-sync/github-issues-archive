{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/2741",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/2741/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/2741/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/2741/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/2741",
  "id": 1032589269,
  "node_id": "I_kwDOCFeAzc49jA_V",
  "number": 2741,
  "title": "Check justified checkpoint root in fork choice",
  "user": {
    "login": "paulhauner",
    "id": 6660660,
    "node_id": "MDQ6VXNlcjY2NjA2NjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/paulhauner",
    "html_url": "https://github.com/paulhauner",
    "followers_url": "https://api.github.com/users/paulhauner/followers",
    "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
    "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
    "organizations_url": "https://api.github.com/users/paulhauner/orgs",
    "repos_url": "https://api.github.com/users/paulhauner/repos",
    "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
    "received_events_url": "https://api.github.com/users/paulhauner/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 985647281,
      "node_id": "MDU6TGFiZWw5ODU2NDcyODE=",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/bug",
      "name": "bug",
      "color": "d73a4a",
      "default": true,
      "description": "Something isn't working"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "realbigsean",
    "id": 5160426,
    "node_id": "MDQ6VXNlcjUxNjA0MjY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5160426?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/realbigsean",
    "html_url": "https://github.com/realbigsean",
    "followers_url": "https://api.github.com/users/realbigsean/followers",
    "following_url": "https://api.github.com/users/realbigsean/following{/other_user}",
    "gists_url": "https://api.github.com/users/realbigsean/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/realbigsean/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/realbigsean/subscriptions",
    "organizations_url": "https://api.github.com/users/realbigsean/orgs",
    "repos_url": "https://api.github.com/users/realbigsean/repos",
    "events_url": "https://api.github.com/users/realbigsean/events{/privacy}",
    "received_events_url": "https://api.github.com/users/realbigsean/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "realbigsean",
      "id": 5160426,
      "node_id": "MDQ6VXNlcjUxNjA0MjY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5160426?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/realbigsean",
      "html_url": "https://github.com/realbigsean",
      "followers_url": "https://api.github.com/users/realbigsean/followers",
      "following_url": "https://api.github.com/users/realbigsean/following{/other_user}",
      "gists_url": "https://api.github.com/users/realbigsean/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/realbigsean/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/realbigsean/subscriptions",
      "organizations_url": "https://api.github.com/users/realbigsean/orgs",
      "repos_url": "https://api.github.com/users/realbigsean/repos",
      "events_url": "https://api.github.com/users/realbigsean/events{/privacy}",
      "received_events_url": "https://api.github.com/users/realbigsean/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2021-10-21T14:44:59Z",
  "updated_at": "2022-01-20T07:31:16Z",
  "closed_at": "2022-01-20T07:31:16Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\n*Credits to @hwwhww for bringing this to our attention.*\r\n\r\nIn fork choice, Lighthouse checks checkpoint *epochs*:\r\nhttps://github.com/sigp/lighthouse/blob/fff01b24ddedcd54486e374460855ca20d3dd232/consensus/proto_array/src/proto_array.rs#L423-L433\r\n\r\nHowever, the [specification](https://github.com/ethereum/consensus-specs/blob/dev/specs/phase0/fork-choice.md#filter_block_tree) declares:\r\n\r\n```python\r\n    correct_justified = (\r\n        store.justified_checkpoint.epoch == GENESIS_EPOCH\r\n        or head_state.current_justified_checkpoint == store.justified_checkpoint\r\n    )\r\n    correct_finalized = (\r\n        store.finalized_checkpoint.epoch == GENESIS_EPOCH\r\n        or head_state.finalized_checkpoint == store.finalized_checkpoint\r\n    )\r\n ```\r\n\r\nWe have to check \"checkpoints\" are equal. So Lighthouse needs to update to check both epoch *and root*, not just the epoch.\r\n\r\n## Steps to resolve\r\n\r\nIn order to support this, we need to add the root information to the `ProtoNode`:\r\n\r\nhttps://github.com/sigp/lighthouse/blob/fff01b24ddedcd54486e374460855ca20d3dd232/consensus/proto_array/src/proto_array.rs#L31\r\n\r\n... and also the `ProtoArray`:\r\n\r\nhttps://github.com/sigp/lighthouse/blob/fff01b24ddedcd54486e374460855ca20d3dd232/consensus/proto_array/src/proto_array.rs#L45\r\n\r\nThis will require a database migration. I think it should be *fairly* simple to migrate the `ProtoNode`, the roots of all the justified ancestors should be in the `ProtoArray`, so we should just be able to find the roots by just iterating backwards until we find the first ancestor where `ancestor.slot <= start_slot(node.justified_epoch)`.\r\n\r\nFor `ProtoArray`, I *think* we should be able to get the root for the justified checkpoint from the `ForkChoiceStore`, which is persisted alongside it. We'd need to do some more reading to ensure there's a 1:1 relationship between these values, though.",
  "closed_by": {
    "login": "paulhauner",
    "id": 6660660,
    "node_id": "MDQ6VXNlcjY2NjA2NjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/paulhauner",
    "html_url": "https://github.com/paulhauner",
    "followers_url": "https://api.github.com/users/paulhauner/followers",
    "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
    "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
    "organizations_url": "https://api.github.com/users/paulhauner/orgs",
    "repos_url": "https://api.github.com/users/paulhauner/repos",
    "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
    "received_events_url": "https://api.github.com/users/paulhauner/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/2741/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/2741/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/953369287",
    "html_url": "https://github.com/sigp/lighthouse/issues/2741#issuecomment-953369287",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/2741",
    "id": 953369287,
    "node_id": "IC_kwDOCFeAzc4400LH",
    "user": {
      "login": "paulhauner",
      "id": 6660660,
      "node_id": "MDQ6VXNlcjY2NjA2NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/paulhauner",
      "html_url": "https://github.com/paulhauner",
      "followers_url": "https://api.github.com/users/paulhauner/followers",
      "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
      "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
      "organizations_url": "https://api.github.com/users/paulhauner/orgs",
      "repos_url": "https://api.github.com/users/paulhauner/repos",
      "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/paulhauner/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-10-27T22:56:24Z",
    "updated_at": "2021-10-27T22:56:24Z",
    "author_association": "MEMBER",
    "body": "I think @realbigsean is interested in taking this.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/953369287/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/955815771",
    "html_url": "https://github.com/sigp/lighthouse/issues/2741#issuecomment-955815771",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/2741",
    "id": 955815771,
    "node_id": "IC_kwDOCFeAzc44-Jdb",
    "user": {
      "login": "paulhauner",
      "id": 6660660,
      "node_id": "MDQ6VXNlcjY2NjA2NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/paulhauner",
      "html_url": "https://github.com/paulhauner",
      "followers_url": "https://api.github.com/users/paulhauner/followers",
      "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
      "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
      "organizations_url": "https://api.github.com/users/paulhauner/orgs",
      "repos_url": "https://api.github.com/users/paulhauner/repos",
      "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/paulhauner/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-10-31T23:56:45Z",
    "updated_at": "2021-11-01T00:04:50Z",
    "author_association": "MEMBER",
    "body": "> I think it should be fairly simple to migrate the ProtoNode, the roots of all the justified ancestors should be in the ProtoArray, so we should just be able to find the roots by just iterating backwards until we find the first ancestor where ancestor.slot <= start_slot(node.justified_epoch).\r\n\r\nI was wrong here, specifically with \"the roots of all the justified ancestors should be in the ProtoArray\". That's true for the head block, but not necessarily earlier blocks (e.g., the finalized block). Earlier blocks may reference *finalized* blocks as their justified roots, meaning they are no longer in the `ProtoArray`.\r\n\r\nWith the \"fairly simple\" method unavailable, I can see two broad ways to implement this migration:\r\n\r\n1. Full migration: read `BeaconStates` from the `store` during the migration to fill in the justified roots.\r\n2. Partial migration: make the `justified_root` field an `Option<Hash256>`. All new blocks added to the proto-array get `Some(root)`. When we do the check, only check the root if `justified_root.is_some()`. This means the migration happens gradually and we're full migrated once we flush out the proto-array with new blocks (probably a few epochs).\r\n\r\n(1) is nice because it's one clean migration that's contained in database code and the actual fork choice code knows nothing of it. However, it means we need to do some database work on startup that might be a little slow. It also makes the assumption that we have the states for any block that's in `ProtoArray`, which I *think* is fine, but mo assumptions == mo problems.\r\n\r\n(2) is nice because the migration code is blindingly simple. However, it means we need to add complexity to the actual fork choice code to handle the `Option`. It also puts is in a weird \"partially updated\" state that might have side-effects.\r\n\r\nI'm not quite sure which way to go right now, but I'm going to post this so @realbigsean can have a read whilst I think more :thinking: ",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/955815771/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
