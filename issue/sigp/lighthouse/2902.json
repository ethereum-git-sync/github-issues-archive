{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/2902",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/2902/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/2902/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/2902/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/2902",
  "id": 1098665262,
  "node_id": "I_kwDOCFeAzc5BfE0u",
  "number": 2902,
  "title": "Excessive penalties for attestations with unknown head",
  "user": {
    "login": "paulhauner",
    "id": 6660660,
    "node_id": "MDQ6VXNlcjY2NjA2NjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/paulhauner",
    "html_url": "https://github.com/paulhauner",
    "followers_url": "https://api.github.com/users/paulhauner/followers",
    "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
    "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
    "organizations_url": "https://api.github.com/users/paulhauner/orgs",
    "repos_url": "https://api.github.com/users/paulhauner/repos",
    "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
    "received_events_url": "https://api.github.com/users/paulhauner/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 985647281,
      "node_id": "MDU6TGFiZWw5ODU2NDcyODE=",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/bug",
      "name": "bug",
      "color": "d73a4a",
      "default": true,
      "description": "Something isn't working"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 8,
  "created_at": "2022-01-11T05:20:38Z",
  "updated_at": "2022-01-20T07:31:18Z",
  "closed_at": "2022-01-20T07:31:18Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nPresently, I believe we are being too strict on peers who send attestations for an unknown head block.\r\n\r\nWe can see that we do a -10 penalty for a peer if `reprocess_tx.is_none()`:\r\n\r\nhttps://github.com/sigp/lighthouse/blob/fff01b24ddedcd54486e374460855ca20d3dd232/beacon_node/network/src/beacon_processor/worker/gossip_methods.rs#L1403\r\n\r\nHere we can see that we set `reprocess_tx` to `None` when re-processing attestations that were queued due to an unknown head:\r\n\r\nhttps://github.com/sigp/lighthouse/blob/fff01b24ddedcd54486e374460855ca20d3dd232/beacon_node/network/src/beacon_processor/mod.rs#L1499\r\n\r\nSo, nodes incur a -10 penalty for *each attestation* where we were unable to find the head block. This penalty might be applied to peers who weren't even asked for the block, or peers who were asked but we were unable to process their response yet (e.g., on an overloaded node).\r\n\r\n## How to Solve\r\n\r\nThe simplest method would be to just remove this line:\r\n\r\nhttps://github.com/sigp/lighthouse/blob/fff01b24ddedcd54486e374460855ca20d3dd232/beacon_node/network/src/beacon_processor/worker/gossip_methods.rs#L1403\r\n\r\nHowever, we still need to apply some penalty to nodes who provided us an attestation but not the head block. I assume this is possible, but I haven't thought it out yet.\r\n",
  "closed_by": {
    "login": "paulhauner",
    "id": 6660660,
    "node_id": "MDQ6VXNlcjY2NjA2NjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/paulhauner",
    "html_url": "https://github.com/paulhauner",
    "followers_url": "https://api.github.com/users/paulhauner/followers",
    "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
    "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
    "organizations_url": "https://api.github.com/users/paulhauner/orgs",
    "repos_url": "https://api.github.com/users/paulhauner/repos",
    "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
    "received_events_url": "https://api.github.com/users/paulhauner/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/2902/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/2902/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1009952438",
    "html_url": "https://github.com/sigp/lighthouse/issues/2902#issuecomment-1009952438",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/2902",
    "id": 1009952438,
    "node_id": "IC_kwDOCFeAzc48Mqa2",
    "user": {
      "login": "pawanjay176",
      "id": 9890508,
      "node_id": "MDQ6VXNlcjk4OTA1MDg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9890508?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pawanjay176",
      "html_url": "https://github.com/pawanjay176",
      "followers_url": "https://api.github.com/users/pawanjay176/followers",
      "following_url": "https://api.github.com/users/pawanjay176/following{/other_user}",
      "gists_url": "https://api.github.com/users/pawanjay176/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pawanjay176/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pawanjay176/subscriptions",
      "organizations_url": "https://api.github.com/users/pawanjay176/orgs",
      "repos_url": "https://api.github.com/users/pawanjay176/repos",
      "events_url": "https://api.github.com/users/pawanjay176/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pawanjay176/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-01-11T13:13:33Z",
    "updated_at": "2022-01-11T13:13:33Z",
    "author_association": "MEMBER",
    "body": "We already penalise the peer that gave us the attestation but didn't give us the correct head block in sync manager.\r\n\r\nhttps://github.com/sigp/lighthouse/blob/fff01b24ddedcd54486e374460855ca20d3dd232/beacon_node/network/src/sync/manager.rs#L510-L513\r\n\r\nSo removing the penalty in `gossip_methods` seems okay to me.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1009952438/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1010344150",
    "html_url": "https://github.com/sigp/lighthouse/issues/2902#issuecomment-1010344150",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/2902",
    "id": 1010344150,
    "node_id": "IC_kwDOCFeAzc48OKDW",
    "user": {
      "login": "divagant-martian",
      "id": 26765164,
      "node_id": "MDQ6VXNlcjI2NzY1MTY0",
      "avatar_url": "https://avatars.githubusercontent.com/u/26765164?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/divagant-martian",
      "html_url": "https://github.com/divagant-martian",
      "followers_url": "https://api.github.com/users/divagant-martian/followers",
      "following_url": "https://api.github.com/users/divagant-martian/following{/other_user}",
      "gists_url": "https://api.github.com/users/divagant-martian/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/divagant-martian/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/divagant-martian/subscriptions",
      "organizations_url": "https://api.github.com/users/divagant-martian/orgs",
      "repos_url": "https://api.github.com/users/divagant-martian/repos",
      "events_url": "https://api.github.com/users/divagant-martian/events{/privacy}",
      "received_events_url": "https://api.github.com/users/divagant-martian/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-01-11T20:42:55Z",
    "updated_at": "2022-01-11T20:43:18Z",
    "author_association": "COLLABORATOR",
    "body": "What about a middle ground: use a debounce strategy to give HighToleranceErrors (a tenth of the LowT one) for these errors and giving a harsher penalty for not providing the block in sync?",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1010344150/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1010435437",
    "html_url": "https://github.com/sigp/lighthouse/issues/2902#issuecomment-1010435437",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/2902",
    "id": 1010435437,
    "node_id": "IC_kwDOCFeAzc48OgVt",
    "user": {
      "login": "paulhauner",
      "id": 6660660,
      "node_id": "MDQ6VXNlcjY2NjA2NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/paulhauner",
      "html_url": "https://github.com/paulhauner",
      "followers_url": "https://api.github.com/users/paulhauner/followers",
      "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
      "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
      "organizations_url": "https://api.github.com/users/paulhauner/orgs",
      "repos_url": "https://api.github.com/users/paulhauner/repos",
      "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/paulhauner/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-01-11T22:46:39Z",
    "updated_at": "2022-01-11T22:46:39Z",
    "author_association": "MEMBER",
    "body": "> We already penalise the peer that gave us the attestation but didn't give us the correct head block in sync manager.\r\n\r\nThis seems good to me, I'm happy to roll with this. @AgeManning are you also on-board with this?\r\n\r\n> What about a middle ground: use a debounce strategy to give HighToleranceErrors (a tenth of the LowT one) for these errors and giving a harsher penalty for not providing the block in sync?\r\n\r\nPeers can send us several hundred attestations, so we can still get a ban from a single incident. I considered saying \"one attestation-related penalty per epoch\", but if @pawanjay176 is right I think we can just drop the penalty for unknown head attn.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1010435437/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1010449140",
    "html_url": "https://github.com/sigp/lighthouse/issues/2902#issuecomment-1010449140",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/2902",
    "id": 1010449140,
    "node_id": "IC_kwDOCFeAzc48Ojr0",
    "user": {
      "login": "paulhauner",
      "id": 6660660,
      "node_id": "MDQ6VXNlcjY2NjA2NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/paulhauner",
      "html_url": "https://github.com/paulhauner",
      "followers_url": "https://api.github.com/users/paulhauner/followers",
      "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
      "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
      "organizations_url": "https://api.github.com/users/paulhauner/orgs",
      "repos_url": "https://api.github.com/users/paulhauner/repos",
      "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/paulhauner/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-01-11T23:10:53Z",
    "updated_at": "2022-01-11T23:10:53Z",
    "author_association": "MEMBER",
    "body": "> We already penalise the peer that gave us the attestation but didn't give us the correct head block in sync manager.\r\n\r\nI can see it will penalize the peer if they return a block that's invalid. I'm not sure what happens if they don't respond at all, will they get a penalty for timing-out on an RPC request? ",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1010449140/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1010504028",
    "html_url": "https://github.com/sigp/lighthouse/issues/2902#issuecomment-1010504028",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/2902",
    "id": 1010504028,
    "node_id": "IC_kwDOCFeAzc48OxFc",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-01-12T00:24:36Z",
    "updated_at": "2022-01-12T00:27:07Z",
    "author_association": "MEMBER",
    "body": "I think completely removing the penalty on attestations might make us vulnerable to a spam attack.\r\n\r\n1. Malicious peers send attestations with junk data in the `beacon_block_root`\r\n2. Upon processing their attestations, we try to look up the `beacon_block_root`s using single block lookups\r\n3. Honest peers don't know the blocks, and respond with empty blocks by root responses\r\n4. _The malicious peers also respond with empty blocks by root responses_\r\n5. Malicious peers aren't distinguished from honest peers, and can keep spamming\r\n\r\nThe code for the honest peers sending empty responses is [here](https://github.com/sigp/lighthouse/blob/fff01b24ddedcd54486e374460855ca20d3dd232/beacon_node/network/src/beacon_processor/worker/rpc_methods.rs#L123-L152) for reference.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1010504028/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1010543022",
    "html_url": "https://github.com/sigp/lighthouse/issues/2902#issuecomment-1010543022",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/2902",
    "id": 1010543022,
    "node_id": "IC_kwDOCFeAzc48O6mu",
    "user": {
      "login": "paulhauner",
      "id": 6660660,
      "node_id": "MDQ6VXNlcjY2NjA2NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/paulhauner",
      "html_url": "https://github.com/paulhauner",
      "followers_url": "https://api.github.com/users/paulhauner/followers",
      "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
      "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
      "organizations_url": "https://api.github.com/users/paulhauner/orgs",
      "repos_url": "https://api.github.com/users/paulhauner/repos",
      "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/paulhauner/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-01-12T01:37:44Z",
    "updated_at": "2022-01-12T01:37:44Z",
    "author_association": "MEMBER",
    "body": "> I think completely removing the penalty on attestations might make us vulnerable to a spam attack.\r\n\r\nI also agree, I didn't realise there was a way around the penalty with an empty response.\r\n\r\nWe still need to figure out how to fix this issue though. Presently we're banning honest peers.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1010543022/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1010566935",
    "html_url": "https://github.com/sigp/lighthouse/issues/2902#issuecomment-1010566935",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/2902",
    "id": 1010566935,
    "node_id": "IC_kwDOCFeAzc48PAcX",
    "user": {
      "login": "AgeManning",
      "id": 7454587,
      "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AgeManning",
      "html_url": "https://github.com/AgeManning",
      "followers_url": "https://api.github.com/users/AgeManning/followers",
      "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
      "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
      "organizations_url": "https://api.github.com/users/AgeManning/orgs",
      "repos_url": "https://api.github.com/users/AgeManning/repos",
      "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AgeManning/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-01-12T02:25:20Z",
    "updated_at": "2022-01-12T02:25:20Z",
    "author_association": "MEMBER",
    "body": "If the node doesn't respond it counts as a failure. Given enough failures it seems we penalize all peers. \r\n\r\nI think the approach we should take is something similar to sync. Whereby all peers that say a particular block exists, go into a pool. When requesting the block, we sample the pool. If after say 3 attempts, we can't get the block, the entire pool gets penalized. \r\n\r\nI'll knock up a PR for this.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1010566935/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1011748698",
    "html_url": "https://github.com/sigp/lighthouse/issues/2902#issuecomment-1011748698",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/2902",
    "id": 1011748698,
    "node_id": "IC_kwDOCFeAzc48Tg9a",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-01-13T03:25:21Z",
    "updated_at": "2022-01-13T03:25:21Z",
    "author_association": "MEMBER",
    "body": "Noting that the attack I described isn't viable because we only ever ask peers that sent us the attestation for the block, and we penalise empty blocks by root responses in that case (thanks @pawanjay176 for working this out)",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1011748698/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
