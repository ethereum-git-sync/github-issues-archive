{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/878",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/878/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/878/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/878/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/878",
  "id": 572691002,
  "node_id": "MDU6SXNzdWU1NzI2OTEwMDI=",
  "number": 878,
  "title": "Too many open files",
  "user": {
    "login": "adaszko",
    "id": 165678,
    "node_id": "MDQ6VXNlcjE2NTY3OA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/165678?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/adaszko",
    "html_url": "https://github.com/adaszko",
    "followers_url": "https://api.github.com/users/adaszko/followers",
    "following_url": "https://api.github.com/users/adaszko/following{/other_user}",
    "gists_url": "https://api.github.com/users/adaszko/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/adaszko/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/adaszko/subscriptions",
    "organizations_url": "https://api.github.com/users/adaszko/orgs",
    "repos_url": "https://api.github.com/users/adaszko/repos",
    "events_url": "https://api.github.com/users/adaszko/events{/privacy}",
    "received_events_url": "https://api.github.com/users/adaszko/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 2336803064,
      "node_id": "MDU6TGFiZWwyMzM2ODAzMDY0",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/infra-ci",
      "name": "infra-ci",
      "color": "7365BC",
      "default": false,
      "description": ""
    },
    {
      "id": 2490305485,
      "node_id": "MDU6TGFiZWwyNDkwMzA1NDg1",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/A2",
      "name": "A2",
      "color": "000000",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 6,
  "created_at": "2020-02-28T11:15:17Z",
  "updated_at": "2021-01-14T13:39:33Z",
  "closed_at": "2021-01-14T13:39:33Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "## Present Behaviour\r\n\r\n`make test-debug` fails with a `Too many open files` error in *various* tests.\r\n\r\nMore precisely, the error message is: `thread 'tokio-runtime-worker-0' panicked at 'failed to open /dev/urandom: Os { code: 24, kind: Other, message: \"Too many open files\" }', src/libcore/result.rs:1188:5`.\r\n\r\nI only tested on macOS.  File descriptors limit may be lower there.\r\n\r\nThe tests I've seen failing so far:\r\n * `eth1_cache::pruning`\r\n * `eth1_cache::double_update`\r\n* `eth1_cache::big_skip`\r\n* `deposit_tree::updating`\r\n* `fast::deposit_cache_query`\r\n* `test_gossipsub_forward`\r\n* ` fast::deposit_cache_query`\r\n\r\n## Expected Behaviour\r\n\r\n`make test-debug` tests should be passing.",
  "closed_by": {
    "login": "realbigsean",
    "id": 5160426,
    "node_id": "MDQ6VXNlcjUxNjA0MjY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5160426?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/realbigsean",
    "html_url": "https://github.com/realbigsean",
    "followers_url": "https://api.github.com/users/realbigsean/followers",
    "following_url": "https://api.github.com/users/realbigsean/following{/other_user}",
    "gists_url": "https://api.github.com/users/realbigsean/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/realbigsean/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/realbigsean/subscriptions",
    "organizations_url": "https://api.github.com/users/realbigsean/orgs",
    "repos_url": "https://api.github.com/users/realbigsean/repos",
    "events_url": "https://api.github.com/users/realbigsean/events{/privacy}",
    "received_events_url": "https://api.github.com/users/realbigsean/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/878/reactions",
    "total_count": 2,
    "+1": 2,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/878/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/592473071",
    "html_url": "https://github.com/sigp/lighthouse/issues/878#issuecomment-592473071",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/878",
    "id": 592473071,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU5MjQ3MzA3MQ==",
    "user": {
      "login": "adaszko",
      "id": 165678,
      "node_id": "MDQ6VXNlcjE2NTY3OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/165678?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/adaszko",
      "html_url": "https://github.com/adaszko",
      "followers_url": "https://api.github.com/users/adaszko/followers",
      "following_url": "https://api.github.com/users/adaszko/following{/other_user}",
      "gists_url": "https://api.github.com/users/adaszko/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/adaszko/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/adaszko/subscriptions",
      "organizations_url": "https://api.github.com/users/adaszko/orgs",
      "repos_url": "https://api.github.com/users/adaszko/repos",
      "events_url": "https://api.github.com/users/adaszko/events{/privacy}",
      "received_events_url": "https://api.github.com/users/adaszko/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-02-28T11:28:06Z",
    "updated_at": "2020-02-28T11:28:06Z",
    "author_association": "CONTRIBUTOR",
    "body": "I'm working on it.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/592473071/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/592655490",
    "html_url": "https://github.com/sigp/lighthouse/issues/878#issuecomment-592655490",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/878",
    "id": 592655490,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU5MjY1NTQ5MA==",
    "user": {
      "login": "adaszko",
      "id": 165678,
      "node_id": "MDQ6VXNlcjE2NTY3OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/165678?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/adaszko",
      "html_url": "https://github.com/adaszko",
      "followers_url": "https://api.github.com/users/adaszko/followers",
      "following_url": "https://api.github.com/users/adaszko/following{/other_user}",
      "gists_url": "https://api.github.com/users/adaszko/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/adaszko/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/adaszko/subscriptions",
      "organizations_url": "https://api.github.com/users/adaszko/orgs",
      "repos_url": "https://api.github.com/users/adaszko/repos",
      "events_url": "https://api.github.com/users/adaszko/events{/privacy}",
      "received_events_url": "https://api.github.com/users/adaszko/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-02-28T18:08:44Z",
    "updated_at": "2020-02-28T18:08:44Z",
    "author_association": "CONTRIBUTOR",
    "body": "More precise command to reproduce: `cargo test --all --exclude ef_tests -p eth1 --test test`",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/592655490/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/593819929",
    "html_url": "https://github.com/sigp/lighthouse/issues/878#issuecomment-593819929",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/878",
    "id": 593819929,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU5MzgxOTkyOQ==",
    "user": {
      "login": "adaszko",
      "id": 165678,
      "node_id": "MDQ6VXNlcjE2NTY3OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/165678?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/adaszko",
      "html_url": "https://github.com/adaszko",
      "followers_url": "https://api.github.com/users/adaszko/followers",
      "following_url": "https://api.github.com/users/adaszko/following{/other_user}",
      "gists_url": "https://api.github.com/users/adaszko/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/adaszko/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/adaszko/subscriptions",
      "organizations_url": "https://api.github.com/users/adaszko/orgs",
      "repos_url": "https://api.github.com/users/adaszko/repos",
      "events_url": "https://api.github.com/users/adaszko/events{/privacy}",
      "received_events_url": "https://api.github.com/users/adaszko/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-03-03T08:06:35Z",
    "updated_at": "2020-03-03T08:06:35Z",
    "author_association": "CONTRIBUTOR",
    "body": "I've tried adding a macOS executor to GitHub CI and [setting `ulimit -n 256`](https://github.com/adaszko/lighthouse/blob/f11a1f63162d0bb3d96c08dbcc806e6f4cc3058f/.github/workflows/macos.yml#L15) (256 is the default on macOS).  The result is [the job simply hangs](https://github.com/adaszko/lighthouse/runs/480337165).",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/593819929/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/593820808",
    "html_url": "https://github.com/sigp/lighthouse/issues/878#issuecomment-593820808",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/878",
    "id": 593820808,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU5MzgyMDgwOA==",
    "user": {
      "login": "adaszko",
      "id": 165678,
      "node_id": "MDQ6VXNlcjE2NTY3OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/165678?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/adaszko",
      "html_url": "https://github.com/adaszko",
      "followers_url": "https://api.github.com/users/adaszko/followers",
      "following_url": "https://api.github.com/users/adaszko/following{/other_user}",
      "gists_url": "https://api.github.com/users/adaszko/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/adaszko/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/adaszko/subscriptions",
      "organizations_url": "https://api.github.com/users/adaszko/orgs",
      "repos_url": "https://api.github.com/users/adaszko/repos",
      "events_url": "https://api.github.com/users/adaszko/events{/privacy}",
      "received_events_url": "https://api.github.com/users/adaszko/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-03-03T08:09:01Z",
    "updated_at": "2020-03-03T08:09:10Z",
    "author_association": "CONTRIBUTOR",
    "body": "Attaching `dtruss` run shows it's the `/dev/urandom` file that [gets opened a lot](https://gist.github.com/adaszko/1140239814e84f24f703d56ebe6423cc).",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/593820808/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/593912126",
    "html_url": "https://github.com/sigp/lighthouse/issues/878#issuecomment-593912126",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/878",
    "id": 593912126,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU5MzkxMjEyNg==",
    "user": {
      "login": "adaszko",
      "id": 165678,
      "node_id": "MDQ6VXNlcjE2NTY3OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/165678?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/adaszko",
      "html_url": "https://github.com/adaszko",
      "followers_url": "https://api.github.com/users/adaszko/followers",
      "following_url": "https://api.github.com/users/adaszko/following{/other_user}",
      "gists_url": "https://api.github.com/users/adaszko/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/adaszko/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/adaszko/subscriptions",
      "organizations_url": "https://api.github.com/users/adaszko/orgs",
      "repos_url": "https://api.github.com/users/adaszko/repos",
      "events_url": "https://api.github.com/users/adaszko/events{/privacy}",
      "received_events_url": "https://api.github.com/users/adaszko/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-03-03T11:50:29Z",
    "updated_at": "2020-03-03T14:59:57Z",
    "author_association": "CONTRIBUTOR",
    "body": "I tried gdb on Linux but it crashes with no good reason.  Replacing `random_deposit_data()` with `generate_deterministic_keypair()` did not make any effect either.\r\n\r\nFortunately, [`dtruss` backtraces](https://gist.github.com/bd8f8cd311a156be586f8bf356fba56a) reveal what's going on.  The problem is each instance of `EnvironmentBuilder::minimal().single_thread_tokio_runtime()` uses `std::collections::hash_map::HashMap` underneath, which (too avoid certain attack vectors), uses a strong randomness source in the form of `/dev/urandom` on macOS.\r\n\r\nThe mio version we use (0.6.21) [uses HashMap](https://github.com/tokio-rs/mio/blob/cd0423c47209a70d6a42cfd500de6ba3052fa8b8/src/sys/unix/kqueue.rs#L229).  The latest version (0.7.0) [doesn't](https://github.com/tokio-rs/mio/blob/5da8c492a794849621b2b60ab0d351d36c1d0b47/src/sys/unix/selector/kqueue.rs#L319).\r\n\r\nSo I there's a good chance this issue will will go away once we switch to a newer version of tokio that depends on mio 0.7.0.  Current latest tokio 0.2.13 [still depends on mio 0.6.x](https://github.com/tokio-rs/tokio/blob/tokio-0.2.13/tokio/Cargo.toml#L104).",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/593912126/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/760202497",
    "html_url": "https://github.com/sigp/lighthouse/issues/878#issuecomment-760202497",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/878",
    "id": 760202497,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc2MDIwMjQ5Nw==",
    "user": {
      "login": "realbigsean",
      "id": 5160426,
      "node_id": "MDQ6VXNlcjUxNjA0MjY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5160426?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/realbigsean",
      "html_url": "https://github.com/realbigsean",
      "followers_url": "https://api.github.com/users/realbigsean/followers",
      "following_url": "https://api.github.com/users/realbigsean/following{/other_user}",
      "gists_url": "https://api.github.com/users/realbigsean/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/realbigsean/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/realbigsean/subscriptions",
      "organizations_url": "https://api.github.com/users/realbigsean/orgs",
      "repos_url": "https://api.github.com/users/realbigsean/repos",
      "events_url": "https://api.github.com/users/realbigsean/events{/privacy}",
      "received_events_url": "https://api.github.com/users/realbigsean/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-01-14T13:39:33Z",
    "updated_at": "2021-01-14T13:39:33Z",
    "author_association": "COLLABORATOR",
    "body": "tokio 0.3 uses mio 0.7 so I'm going to close this for now ðŸ¤ž  Ran debug tests on my mac and they passed",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/760202497/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
