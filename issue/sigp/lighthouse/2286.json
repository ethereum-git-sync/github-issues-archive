{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/2286",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/2286/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/2286/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/2286/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/2286",
  "id": 843955567,
  "node_id": "MDU6SXNzdWU4NDM5NTU1Njc=",
  "number": 2286,
  "title": "Optimise slasher storage of attester data",
  "user": {
    "login": "michaelsproul",
    "id": 4452260,
    "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/michaelsproul",
    "html_url": "https://github.com/michaelsproul",
    "followers_url": "https://api.github.com/users/michaelsproul/followers",
    "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
    "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
    "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
    "repos_url": "https://api.github.com/users/michaelsproul/repos",
    "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
    "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 2490305065,
      "node_id": "MDU6TGFiZWwyNDkwMzA1MDY1",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/A1",
      "name": "A1",
      "color": "223184",
      "default": false,
      "description": ""
    },
    {
      "id": 2602136164,
      "node_id": "MDU6TGFiZWwyNjAyMTM2MTY0",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/slasher",
      "name": "slasher",
      "color": "FAD722",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2021-03-30T00:57:51Z",
  "updated_at": "2022-01-20T07:31:16Z",
  "closed_at": "2022-01-20T07:31:16Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nThe slasher database is still growing, but ideally we would like it to settle down to an approximately constant size. I initially thought this was a problem with pruning (#1890), but it seems that isn't the case.\r\n\r\nAnalysing a slasher DB from mainnet which has been in use since genesis 4 months ago, we see a large number of pages in use for the `attesters` sub-database. In a DB of ~95 GiB the breakdown is roughly:\r\n\r\n- 55.4 GiB for the `attesters` (14527008 leaf pages x 4 KiB), 448M entries :scream:\r\n- 37.8 GiB for the `indexed_attestations` (9898253 leaf pages) 29M entries\r\n- 2 GiB for _everything else_\r\n\r\nShrinking the `indexed_attestations` data is the subject of https://github.com/sigp/lighthouse/issues/2112.\r\n\r\nTo shrink the `attesters` data will require a database schema change. Currently each entry is at least 80 bytes:\r\n\r\n- 8 bytes: target epoch (key)\r\n- 8 bytes: validator index (key)\r\n- 32 bytes: the hash of the attestation data (value)\r\n- 32 bytes: the hash of the indexed attestation (value)\r\n\r\nGiven this, we might naÃ¯vely expect the attesters DB to be 33 GiB (`448M x 80 bytes`) . What's the extra 22 GiB?? My current theory is that it's the previous versions of some items, which is how LMDB implements multi-version concurrency control (MVCC). There's some more info in this presentation from the LMDB creator:\r\n\r\nhttp://schd.ws/hosted_files/buildstuff14/96/20141120-BuildStuff-Lightning.pdf\r\n\r\nI quite like LMDB, and I'm willing to cop the ~2x overhead to retain its speediness. Hence I think our best option is to make that sub-database intrinsically smaller. Some ideas:\r\n\r\n- The attestation data hash is present _only_ for speed, it could be looked up from the indexed attestation. Although this would require us to do hashing, which would be too slow for _every_ incoming attestation... so a bit of a non-starter.\r\n- We could normalise the data so that there's a layer of indirection between the attesters DB and the 32 byte hashes. Add two new tables: `indexed_attestation_hashes` and `attestation_data_hashes` which map `u64 => Hash256`. This would shrink the two 32 byte hashes in the `attesters` DB to 16 bytes total, plus the total size of the `_hashes` tables, which should be small due to the number of attesters per attestation.\r\n- We could use 5 bytes to encode the validator index (max validator registry size is `2**40`)\r\n- We could use 2 bytes to encode the target epoch (store it modulo `history_length`/4096)\r\n\r\nThe last 3 of these optimisations would bring attester entries to 16 + 7  = 23 bytes, a great reduction from 80! This might yield an attesters table of max size 19.19 GiB (`448M * 23 bytes * 2 versions`). Which gives us some headroom as the validator set grows!\r\n\r\n## Version\r\n\r\nLighthouse v1.2.1\r\n\r\n## Extra Info\r\n\r\nComplete database stats for the DB described above:\r\n\r\n```\r\n$ mdb_stat -a -e slasher_db\r\nEnvironment Info\r\n  Map address: (nil)\r\n  Map size: 274877906944\r\n  Page size: 4096\r\n  Max pages: 67108864\r\n  Number of pages used: 24775669\r\n  Last transaction ID: 868787\r\n  Max readers: 126\r\n  Number of readers used: 0\r\nStatus of Main DB\r\n  Tree depth: 1\r\n  Branch pages: 0\r\n  Leaf pages: 1\r\n  Overflow pages: 0\r\n  Entries: 7\r\nStatus of attesters\r\n  Tree depth: 5\r\n  Branch pages: 135183\r\n  Leaf pages: 14527008\r\n  Overflow pages: 0\r\n  Entries: 448178532\r\nStatus of current_epochs\r\n  Tree depth: 3\r\n  Branch pages: 5\r\n  Leaf pages: 727\r\n  Overflow pages: 0\r\n  Entries: 112640\r\nStatus of indexed_attestations\r\n  Tree depth: 5\r\n  Branch pages: 179246\r\n  Leaf pages: 9898253\r\n  Overflow pages: 0\r\n  Entries: 28548391\r\nStatus of max_targets\r\n  Tree depth: 3\r\n  Branch pages: 20\r\n  Leaf pages: 2525\r\n  Overflow pages: 0\r\n  Entries: 110722\r\nStatus of metadata\r\n  Tree depth: 1\r\n  Branch pages: 0\r\n  Leaf pages: 1\r\n  Overflow pages: 0\r\n  Entries: 2\r\nStatus of min_targets\r\n  Tree depth: 3\r\n  Branch pages: 110\r\n  Leaf pages: 14526\r\n  Overflow pages: 0\r\n  Entries: 112640\r\nStatus of proposers\r\n  Tree depth: 3\r\n  Branch pages: 55\r\n  Leaf pages: 8109\r\n  Overflow pages: 0\r\n  Entries: 129717\r\n```",
  "closed_by": {
    "login": "paulhauner",
    "id": 6660660,
    "node_id": "MDQ6VXNlcjY2NjA2NjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/paulhauner",
    "html_url": "https://github.com/paulhauner",
    "followers_url": "https://api.github.com/users/paulhauner/followers",
    "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
    "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
    "organizations_url": "https://api.github.com/users/paulhauner/orgs",
    "repos_url": "https://api.github.com/users/paulhauner/repos",
    "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
    "received_events_url": "https://api.github.com/users/paulhauner/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/2286/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/2286/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/815312108",
    "html_url": "https://github.com/sigp/lighthouse/issues/2286#issuecomment-815312108",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/2286",
    "id": 815312108,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgxNTMxMjEwOA==",
    "user": {
      "login": "rauljordan",
      "id": 5572669,
      "node_id": "MDQ6VXNlcjU1NzI2Njk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5572669?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rauljordan",
      "html_url": "https://github.com/rauljordan",
      "followers_url": "https://api.github.com/users/rauljordan/followers",
      "following_url": "https://api.github.com/users/rauljordan/following{/other_user}",
      "gists_url": "https://api.github.com/users/rauljordan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rauljordan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rauljordan/subscriptions",
      "organizations_url": "https://api.github.com/users/rauljordan/orgs",
      "repos_url": "https://api.github.com/users/rauljordan/repos",
      "events_url": "https://api.github.com/users/rauljordan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rauljordan/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-04-07T22:52:58Z",
    "updated_at": "2021-04-07T22:52:58Z",
    "author_association": "NONE",
    "body": "Hi @michaelsproul we ended up going with this schema: https://github.com/prysmaticlabs/prysm/pull/8720 to help us reduce the size. We also incorporated the idea of 5 byte validator indices and 2 byte epochs modulo history_length. We ended up incorporating attesting indices as a quick-and-dirty way of reducing duplication in the db in our case",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/815312108/reactions",
      "total_count": 2,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 1,
      "rocket": 1,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
