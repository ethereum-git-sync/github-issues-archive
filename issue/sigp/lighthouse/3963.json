{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/3963",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/3963/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/3963/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/3963/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/3963",
  "id": 1580750837,
  "node_id": "I_kwDOCFeAzc5eOFf1",
  "number": 3963,
  "title": "Produced Orphaned block",
  "user": {
    "login": "PacoBits",
    "id": 38920606,
    "node_id": "MDQ6VXNlcjM4OTIwNjA2",
    "avatar_url": "https://avatars.githubusercontent.com/u/38920606?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/PacoBits",
    "html_url": "https://github.com/PacoBits",
    "followers_url": "https://api.github.com/users/PacoBits/followers",
    "following_url": "https://api.github.com/users/PacoBits/following{/other_user}",
    "gists_url": "https://api.github.com/users/PacoBits/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/PacoBits/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/PacoBits/subscriptions",
    "organizations_url": "https://api.github.com/users/PacoBits/orgs",
    "repos_url": "https://api.github.com/users/PacoBits/repos",
    "events_url": "https://api.github.com/users/PacoBits/events{/privacy}",
    "received_events_url": "https://api.github.com/users/PacoBits/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 985647288,
      "node_id": "MDU6TGFiZWw5ODU2NDcyODg=",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/question",
      "name": "question",
      "color": "d876e3",
      "default": true,
      "description": "Further information is requested"
    },
    {
      "id": 1245875191,
      "node_id": "MDU6TGFiZWwxMjQ1ODc1MTkx",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/val-client",
      "name": "val-client",
      "color": "9cd6fc",
      "default": false,
      "description": "Relates to the validator client binary"
    },
    {
      "id": 4771662300,
      "node_id": "LA_kwDOCFeAzc8AAAABHGnJ3A",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/builder%20API",
      "name": "builder API",
      "color": "C9A283",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2023-02-11T09:13:05Z",
  "updated_at": "2023-03-07T22:09:36Z",
  "closed_at": "2023-03-07T22:09:36Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "We have produced a forked/orfan block:\r\nhttps://beaconcha.in/slot/5770016\r\nValidator: 338395\r\nSlot: 5770016\r\nEpoch: 180313\r\n\r\n\r\nWe have a 3-layer configuration with the validator client, the Beacon node and the execution client running separately.\r\nWe are using Mev-boost.\r\nThe setup is working well before and after the orfand block produced. So the problem is related to something \"casual\"\r\n\r\n\r\n```\r\n\r\nnode07         | Feb 10 16:30:36.495 INFO Successfully published block            slot: 5768551, graffiti: Some(\"Block by Stakely Lido07\"), attestations: 97, deposits: 0, block_type: Blinded, service: block\r\nnode07         | Feb 10 19:14:48.068 INFO Successfully published block            slot: 5769372, graffiti: Some(\"Block by Stakely Lido07\"), attestations: 128, deposits: 0, block_type: Blinded, service: block\r\nnode07         | Feb 10 19:20:35.990 INFO Successfully published block            slot: 5769401, graffiti: Some(\"Block by Stakely Lido07\"), attestations: 77, deposits: 0, block_type: Blinded, service: block\r\nnode07         | Feb 10 21:23:41.061 INFO Successfully published block            slot: 5770016, graffiti: Some(\"Block by Stakely Lido07\"), attestations: 74, deposits: 0, block_type: Blinded, service: block\r\nnode07         | Feb 10 22:49:00.007 INFO Successfully published block            slot: 5770443, graffiti: Some(\"Block by Stakely Lido07\"), attestations: 105, deposits: 0, block_type: Blinded, service: block\r\nnode07         | Feb 11 00:23:35.871 INFO Successfully published block            slot: 5770916, graffiti: Some(\"Block by Stakely Lido07\"), attestations: 99, deposits: 0, block_type: Blinded, service: block\r\n```\r\n\r\n\r\nValidator setup and version: Lighthouse/v3.4.0-38514c0\r\n```\r\nlighthouse vc\r\n--beacon-nodes http://LH,http://SERVER_ON_MAINTENANCE,http://ip3\r\n--network mainnet\r\n--metrics\r\n--metrics-allow-origin *\r\n--graffiti \"Block by xxxxxxx\"\r\n--suggested-fee-recipient 0x388Cxxxxxxxxxxxx\r\n--init-slashing-protection\r\n--metrics-port xxx\r\n--http\r\n--builder-proposals\r\n```\r\n\r\nBeacon setup and version: Lighthouse/v3.4.0-38514c0\r\n```\r\n\r\n      lighthouse beacon\r\n      --network mainnet\r\n      --execution-jwt  /xxxxxxxxxxxxxxx\r\n      --execution-endpoint  http://localhost:xxxxx\r\n      --subscribe-all-subnets\r\n      --import-all-attestations\r\n      --graffiti \"Block by Stakely.io - blh01\"\r\n      --metrics\r\n      --metrics-allow-origin xxxxx\r\n      --http\r\n      --http-address xxxxxxxx\r\n      --http-port xxxxx\r\n      --port xxxxxxx\r\n      --checkpoint-sync-url https://mainnet-checkpoint-sync.stakely.io/\r\n      --suggested-fee-recipient  0xxxxxxxxxx\r\n      --builder http://xxxxxxx\r\n```\r\n\r\nExecution setup and version: Geth/v1.10.26-stable-e5eb32ac/linux-amd64/go1.18.8\r\n```\r\n\r\n      --mainnet\r\n      --syncmode=snap\r\n      --http\r\n      --http.api \"eth,net,web3,engine,admin\"\r\n      --http.corsdomain \"*\"\r\n      --http.addr 127.0.0.1\r\n      --http.port xxxx\r\n      --cache  16384\r\n      --port xxxx\r\n      --authrpc.port xxx\r\n      --authrpc.jwtsecret \"xxxxxx\"\r\n      --authrpc.vhosts \"xxxx\"\r\n```\r\nLighhouse Beacon logs are relevant  because the first lines show the BN loses several seconds because a new  block received changes the parent root of the Prepared beacon proposer for slot 5770016.\r\n\r\n\r\n[lh-bn-orfandblock10022023.txt](https://github.com/sigp/lighthouse/files/10713019/lh-bn-orfandblock10022023.txt)\r\n\r\n[mev-boost-orfandblock10022023.txt](https://github.com/sigp/lighthouse/files/10713027/mev-boost-orfandblock10022023.txt)\r\n\r\nImportant note: VC is connected to several BNs, one of the then is shut down because it is currently undergoing maintenance.This doesnt affect this problem but you'll see warnings in VC logs. \r\n\r\n[lh-vc-orfandblock10022023.txt](https://github.com/sigp/lighthouse/files/10713026/lh-vc-orfandblock10022023.txt)\r\n\r\n\r\n",
  "closed_by": {
    "login": "paulhauner",
    "id": 6660660,
    "node_id": "MDQ6VXNlcjY2NjA2NjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/paulhauner",
    "html_url": "https://github.com/paulhauner",
    "followers_url": "https://api.github.com/users/paulhauner/followers",
    "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
    "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
    "organizations_url": "https://api.github.com/users/paulhauner/orgs",
    "repos_url": "https://api.github.com/users/paulhauner/repos",
    "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
    "received_events_url": "https://api.github.com/users/paulhauner/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/3963/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/3963/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1427180200",
    "html_url": "https://github.com/sigp/lighthouse/issues/3963#issuecomment-1427180200",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3963",
    "id": 1427180200,
    "node_id": "IC_kwDOCFeAzc5VEQqo",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-02-13T00:29:35Z",
    "updated_at": "2023-02-13T00:29:35Z",
    "author_association": "MEMBER",
    "body": "Hey @PacoBits thank you for the detailed report. We're always interested in looking into these cases to ensure Lighthouse is behaving as close to optimally as possible.\r\n\r\nIt seems the problem in this case lies in the connection between the BN and the VC. I'll lay out the timeline below so you can see what I mean.\r\n\r\n- The start of slot 5770016 is `21:23:35`. We see a correct proposer preparation message sent at `21:23:24`, a full 11 seconds prior to this. The previous proposer preparation message you saw (before the parent block arrived) is not an issue as it will be overridden by the more recent one.\r\n- The BN requests a payload from the relay 0.445s into the slot, which is quite quick. Some delay here might be attributed to the link between the VC and the BN.\r\n- The BN receives a payload header from the relay after ~950ms, at 1.4s into the slot. This 950ms is the maximum time that mev-boost will wait for a header, and can be adjusted down with the `-request-timeout-getheader` flag. The reason for this step taking the maximum time is that the bloxroute relays timed out. Still, we're only 1.4s into the slot at this point, so we should have time to publish the block before the 4s attestation deadline.\r\n- Unfortunately we end up publishing the block at `21:23:39.647`, i.e. 4.6 seconds into the slot (late). The logs are a bit bare at this point because the VC only logs this at debug level, but the things that need to happen between the previous step and publishing the header are:\r\n   - Downloading the header to the VC.\r\n   - Signing the header in the VC.\r\n   - Uploading the signed header back to the BN.\r\n   \r\n  If the internet connection between the VC and the BN is slow or unreliable that _could_ explain this step taking ~3.2 seconds.\r\n\r\nBecause the block was published late, it got re-orged by another Lighthouse node, which will now re-org any blocks that fail to get enough attestations (to incentivise on-time blocks).\r\n\r\nIn terms of practical next steps there are a few things to try:\r\n\r\n- Investigate the latency on the connection between the VC and the BNs. If they are in different geographic regions this will add quite a lot of latency which be baked into block proposal times, particularly when using `mev-boost`.\r\n- Try lowering the `getheader` timer on `mev-boost`. This doesn't seem to be the main problem but could help temporarily while you debug network issues.\r\n- DM me debug logs from the validator client. You can find them in `$datadir/beacon/validators/logs/`. You can DM them to me on Discord (`@sproul#3907`). This will help confirm there's no inefficiency lurking in the VC.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1427180200/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1428320019",
    "html_url": "https://github.com/sigp/lighthouse/issues/3963#issuecomment-1428320019",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3963",
    "id": 1428320019,
    "node_id": "IC_kwDOCFeAzc5VIm8T",
    "user": {
      "login": "PacoBits",
      "id": 38920606,
      "node_id": "MDQ6VXNlcjM4OTIwNjA2",
      "avatar_url": "https://avatars.githubusercontent.com/u/38920606?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/PacoBits",
      "html_url": "https://github.com/PacoBits",
      "followers_url": "https://api.github.com/users/PacoBits/followers",
      "following_url": "https://api.github.com/users/PacoBits/following{/other_user}",
      "gists_url": "https://api.github.com/users/PacoBits/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/PacoBits/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/PacoBits/subscriptions",
      "organizations_url": "https://api.github.com/users/PacoBits/orgs",
      "repos_url": "https://api.github.com/users/PacoBits/repos",
      "events_url": "https://api.github.com/users/PacoBits/events{/privacy}",
      "received_events_url": "https://api.github.com/users/PacoBits/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-02-13T17:08:09Z",
    "updated_at": "2023-02-13T17:08:09Z",
    "author_association": "NONE",
    "body": "Thank you for your detailed analysis @michaelsproul \r\nI am sharing with you debug logs from VC on discord. \r\n\r\nLeaving the issue open to share conclusion",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1428320019/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
