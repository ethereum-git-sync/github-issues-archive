{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/1178",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/1178/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/1178/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/1178/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/1178",
  "id": 621613516,
  "node_id": "MDU6SXNzdWU2MjE2MTM1MTY=",
  "number": 1178,
  "title": "Don't count invalid deposits",
  "user": {
    "login": "q9f",
    "id": 58883403,
    "node_id": "MDQ6VXNlcjU4ODgzNDAz",
    "avatar_url": "https://avatars.githubusercontent.com/u/58883403?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/q9f",
    "html_url": "https://github.com/q9f",
    "followers_url": "https://api.github.com/users/q9f/followers",
    "following_url": "https://api.github.com/users/q9f/following{/other_user}",
    "gists_url": "https://api.github.com/users/q9f/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/q9f/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/q9f/subscriptions",
    "organizations_url": "https://api.github.com/users/q9f/orgs",
    "repos_url": "https://api.github.com/users/q9f/repos",
    "events_url": "https://api.github.com/users/q9f/events{/privacy}",
    "received_events_url": "https://api.github.com/users/q9f/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2020-05-20T09:35:31Z",
  "updated_at": "2020-05-26T03:25:53Z",
  "closed_at": "2020-05-26T03:25:53Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nApparently, lighthouse counts deposits regardless of their validity. Don't count them unless they are valid.\r\n\r\n## Version\r\n\r\n`master` @ ddd63c0de146133ce7877bee218710a2b41defd8\r\n\r\n## Present Behaviour\r\n\r\n```\r\n❯ lighthouse bn --http \\\r\n--testnet-dir ~/.opt/goerli/witti/lighthouse \\\r\n--eth1-endpoint http://127.0.0.1:8545\r\n\r\nMay 19 14:53:27.507 WARN Ethereum 2.0 is pre-release. This software is experimental.\r\nMay 19 14:53:27.508 INFO Data directory initialised              datadir: /home/user/.lighthouse\r\nMay 19 14:53:27.536 INFO Waiting for eth2 genesis from eth1      deposit_contract: 0x6225f431644ecf8a30b672d42b77c28297542b13, contract_deploy_block: 2723358, eth1_endpoint: http://127.0.0.1:8545, service: beacon\r\nMay 19 17:13:32.804 INFO Imported deposit log(s)                 new: 32, total: 32, latest_block: 2723546, service: beacon\r\nMay 19 17:13:46.837 INFO Imported deposit log(s)                 new: 32, total: 32, latest_block: 2723546, service: beacon\r\nMay 19 17:58:00.246 INFO Imported deposit log(s)                 new: 1, total: 33, latest_block: 2723724, service: beacon\r\nMay 19 17:58:14.290 INFO Imported deposit log(s)                 new: 32, total: 64, latest_block: 2723725, service: beacon\r\nMay 19 17:58:28.320 INFO Imported deposit log(s)                 new: 31, total: 64, latest_block: 2723725, service: beacon\r\nMay 19 18:19:17.820 INFO Imported deposit log(s)                 new: 2, total: 66, latest_block: 2723809, service: beacon\r\nMay 19 18:19:31.875 INFO Imported deposit log(s)                 new: 3, total: 67, latest_block: 2723810, service: beacon\r\nMay 19 18:19:45.906 INFO Imported deposit log(s)                 new: 15, total: 81, latest_block: 2723811, service: beacon\r\nMay 19 18:19:59.937 INFO Imported deposit log(s)                 new: 15, total: 82, latest_block: 2723812, service: beacon\r\nMay 19 18:20:13.966 INFO Imported deposit log(s)                 new: 15, total: 96, latest_block: 2723813, service: beacon\r\nMay 19 18:20:13.966 INFO Minimum genesis deposit count met       block_number: 2723813, deposit_count: 96, service: beacon\r\nMay 19 18:20:28.007 INFO Imported deposit log(s)                 new: 14, total: 96, latest_block: 2723813, service: beacon\r\nMay 19 23:11:23.400 INFO Imported deposit log(s)                 new: 1, total: 97, latest_block: 2724977, service: beacon\r\nMay 19 23:11:37.471 INFO Imported deposit log(s)                 new: 1, total: 97, latest_block: 2724977, service: beacon\r\nMay 20 00:50:58.651 INFO Imported deposit log(s)                 new: 1, total: 98, latest_block: 2725375, service: beacon\r\nMay 20 00:51:12.699 INFO Imported deposit log(s)                 new: 1, total: 98, latest_block: 2725375, service: beacon\r\nMay 20 00:55:11.757 INFO Imported deposit log(s)                 new: 1, total: 99, latest_block: 2725392, service: beacon\r\nMay 20 00:55:25.802 INFO Imported deposit log(s)                 new: 1, total: 99, latest_block: 2725392, service: beacon\r\n```\r\n\r\nThe line `Minimum genesis deposit count met` indicates that the client might believe those deposits are all valid. However, it turns out that at least 32 are invalid: https://gist.github.com/ajsutton/8e03db5aea6e094d16333a7a0a0e5e39\r\n\r\nI don't think you accept invalid deposits, it's probably just the counting happening before the validation.\r\n\r\n## Expected Behaviour\r\n\r\nOnly count valid deposits.\r\n\r\n## Steps to resolve\r\n\r\nYes.",
  "closed_by": {
    "login": "paulhauner",
    "id": 6660660,
    "node_id": "MDQ6VXNlcjY2NjA2NjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/paulhauner",
    "html_url": "https://github.com/paulhauner",
    "followers_url": "https://api.github.com/users/paulhauner/followers",
    "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
    "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
    "organizations_url": "https://api.github.com/users/paulhauner/orgs",
    "repos_url": "https://api.github.com/users/paulhauner/repos",
    "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
    "received_events_url": "https://api.github.com/users/paulhauner/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/1178/reactions",
    "total_count": 1,
    "+1": 1,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/1178/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/633401387",
    "html_url": "https://github.com/sigp/lighthouse/issues/1178#issuecomment-633401387",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1178",
    "id": 633401387,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYzMzQwMTM4Nw==",
    "user": {
      "login": "paulhauner",
      "id": 6660660,
      "node_id": "MDQ6VXNlcjY2NjA2NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/paulhauner",
      "html_url": "https://github.com/paulhauner",
      "followers_url": "https://api.github.com/users/paulhauner/followers",
      "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
      "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
      "organizations_url": "https://api.github.com/users/paulhauner/orgs",
      "repos_url": "https://api.github.com/users/paulhauner/repos",
      "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/paulhauner/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-25T06:27:54Z",
    "updated_at": "2020-05-25T06:29:48Z",
    "author_association": "MEMBER",
    "body": "This is addressed in #1103. From a logging perspective we have three stages:\r\n\r\n### Waiting for more deposits\r\n\r\nWhen we have less deposits than required validators, so it's impossible to trigger genesis.\r\n\r\n```\r\nMay 25 16:02:29.783 INFO Waiting for more deposits           total_deposits: 8, min_genesis_active_validators: 60, service: beacon\r\n```\r\n\r\n### Waiting for more validators\r\n\r\nWe have enough deposits, but not enough of the deposits result in active validators.\r\n\r\n```\r\nMay 25 16:02:29.783 INFO Waiting for more validators         active_validators: 59, total_deposits: 62, min_genesis_active_validator_count: 60, service: beacon\r\n```\r\n\r\n### Waiting for adequate eth1 timestamp\r\n\r\nWe have enough active validators but we haven't reached the minimum genesis time yet.\r\n\r\n```\r\nMay 25 16:27:24.133 INFO Waiting for adequate eth1 timestamp     estimated_wait: 62-362 mins, service: beacon\r\n```\r\n\r\nLet me know if you see anything weird/lacking :)",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/633401387/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/633653419",
    "html_url": "https://github.com/sigp/lighthouse/issues/1178#issuecomment-633653419",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1178",
    "id": 633653419,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYzMzY1MzQxOQ==",
    "user": {
      "login": "q9f",
      "id": 58883403,
      "node_id": "MDQ6VXNlcjU4ODgzNDAz",
      "avatar_url": "https://avatars.githubusercontent.com/u/58883403?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/q9f",
      "html_url": "https://github.com/q9f",
      "followers_url": "https://api.github.com/users/q9f/followers",
      "following_url": "https://api.github.com/users/q9f/following{/other_user}",
      "gists_url": "https://api.github.com/users/q9f/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/q9f/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/q9f/subscriptions",
      "organizations_url": "https://api.github.com/users/q9f/orgs",
      "repos_url": "https://api.github.com/users/q9f/repos",
      "events_url": "https://api.github.com/users/q9f/events{/privacy}",
      "received_events_url": "https://api.github.com/users/q9f/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-25T17:01:10Z",
    "updated_at": "2020-05-25T17:01:10Z",
    "author_association": "CONTRIBUTOR",
    "body": "Hey @paulhauner,\r\n\r\nI'm on the `faster-genesis` branch, it appears to work, some nitpicks:\r\n\r\n```\r\nMay 25 18:55:06.550 INFO Imported deposit log(s)                 new: 2, total: 6, latest_block: 2758489, service: beacon\r\nMay 25 18:55:06.550 INFO Importing eth1 blocks                   service: beacon\r\nMay 25 18:55:06.558 INFO Waiting for adequate eth1 timestamp     estimated_wait: 26505180-26506620 mins, service: beacon\r\nMay 25 18:55:13.590 INFO Waiting for adequate eth1 timestamp     estimated_wait: 26505180-26506620 mins, service: beacon\r\nMay 25 18:55:20.621 INFO Imported deposit log(s)                 new: 2, total: 6, latest_block: 2758489, service: beacon\r\nMay 25 18:55:20.758 INFO Genesis ceremony complete               genesis_time: 1590537600, genesis_validators: 6, service: beacon\r\nMay 25 18:55:20.766 INFO Block production enabled                method: json rpc via http, endpoint: http://127.0.0.1:9779\r\nMay 25 18:55:20.770 INFO Beacon chain initialized                head_slot: 0, head_block: 0x19aa…ba12, head_state: 0x773c…5b17, service: beacon\r\n```\r\n\r\n* Several statements are always getting printed twice.\r\n* The _estimated wait_ seems off, the genesis time is correct though.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/633653419/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/633762148",
    "html_url": "https://github.com/sigp/lighthouse/issues/1178#issuecomment-633762148",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1178",
    "id": 633762148,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYzMzc2MjE0OA==",
    "user": {
      "login": "paulhauner",
      "id": 6660660,
      "node_id": "MDQ6VXNlcjY2NjA2NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/paulhauner",
      "html_url": "https://github.com/paulhauner",
      "followers_url": "https://api.github.com/users/paulhauner/followers",
      "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
      "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
      "organizations_url": "https://api.github.com/users/paulhauner/orgs",
      "repos_url": "https://api.github.com/users/paulhauner/repos",
      "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/paulhauner/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-26T01:24:16Z",
    "updated_at": "2020-05-26T01:24:16Z",
    "author_association": "MEMBER",
    "body": "Thanks for the nits! I've removed the estimated wait time, it was proving tricky. I'm going to leave the duplicate logs for now, I'm trying to focus on core functionality and I'll come back for polish :)",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/633762148/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
