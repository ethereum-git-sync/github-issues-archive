{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/1168",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/1168/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/1168/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/1168/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/1168",
  "id": 620721355,
  "node_id": "MDU6SXNzdWU2MjA3MjEzNTU=",
  "number": 1168,
  "title": "Consider caching eth1 votes as an optimisation",
  "user": {
    "login": "michaelsproul",
    "id": 4452260,
    "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/michaelsproul",
    "html_url": "https://github.com/michaelsproul",
    "followers_url": "https://api.github.com/users/michaelsproul/followers",
    "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
    "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
    "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
    "repos_url": "https://api.github.com/users/michaelsproul/repos",
    "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
    "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1999784343,
      "node_id": "MDU6TGFiZWwxOTk5Nzg0MzQz",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/optimization",
      "name": "optimization",
      "color": "f9de40",
      "default": false,
      "description": "Something to make Lighthouse run more efficiently."
    },
    {
      "id": 2034355093,
      "node_id": "MDU6TGFiZWwyMDM0MzU1MDkz",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/consensus",
      "name": "consensus",
      "color": "5e59bf",
      "default": false,
      "description": "An issue/PR that touches consensus code, such as state_processing or block verification."
    },
    {
      "id": 2490305065,
      "node_id": "MDU6TGFiZWwyNDkwMzA1MDY1",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/A1",
      "name": "A1",
      "color": "223184",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 6,
  "created_at": "2020-05-19T06:44:05Z",
  "updated_at": "2022-11-09T05:03:06Z",
  "closed_at": "2021-09-12T23:10:48Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nAs raised by @JustinDrake in #1093, a possible optimisation to the state transition could be to cache the count of `Eth1Data` votes so that an iteration over (up to) 1024 votes wouldn't be necessary every block. We _suspect_ this isn't actually a significant cost compared to the expensive operations like signing and hashing, but it's worth a look.\r\n\r\n## Steps to resolve\r\n\r\n1. Time the function `get_new_eth1_data` as a proportion of a block transition. If it's completed dominated by signing and hashing, come back here and close this issue.\r\n2. If the time is significant, implement a cache that maps `Eth1Data` to the number of times it occurs in `state.eth1_data_votes`",
  "closed_by": {
    "login": "paulhauner",
    "id": 6660660,
    "node_id": "MDQ6VXNlcjY2NjA2NjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/paulhauner",
    "html_url": "https://github.com/paulhauner",
    "followers_url": "https://api.github.com/users/paulhauner/followers",
    "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
    "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
    "organizations_url": "https://api.github.com/users/paulhauner/orgs",
    "repos_url": "https://api.github.com/users/paulhauner/repos",
    "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
    "received_events_url": "https://api.github.com/users/paulhauner/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/1168/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/1168/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/632968192",
    "html_url": "https://github.com/sigp/lighthouse/issues/1168#issuecomment-632968192",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1168",
    "id": 632968192,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYzMjk2ODE5Mg==",
    "user": {
      "login": "ethDreamer",
      "id": 37123614,
      "node_id": "MDQ6VXNlcjM3MTIzNjE0",
      "avatar_url": "https://avatars.githubusercontent.com/u/37123614?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ethDreamer",
      "html_url": "https://github.com/ethDreamer",
      "followers_url": "https://api.github.com/users/ethDreamer/followers",
      "following_url": "https://api.github.com/users/ethDreamer/following{/other_user}",
      "gists_url": "https://api.github.com/users/ethDreamer/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ethDreamer/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ethDreamer/subscriptions",
      "organizations_url": "https://api.github.com/users/ethDreamer/orgs",
      "repos_url": "https://api.github.com/users/ethDreamer/repos",
      "events_url": "https://api.github.com/users/ethDreamer/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ethDreamer/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-23T01:58:47Z",
    "updated_at": "2020-05-23T01:58:47Z",
    "author_association": "COLLABORATOR",
    "body": "I can check this out this weekend. I'll time it with and without caching and see what happens.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/632968192/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/633144709",
    "html_url": "https://github.com/sigp/lighthouse/issues/1168#issuecomment-633144709",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1168",
    "id": 633144709,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYzMzE0NDcwOQ==",
    "user": {
      "login": "ethDreamer",
      "id": 37123614,
      "node_id": "MDQ6VXNlcjM3MTIzNjE0",
      "avatar_url": "https://avatars.githubusercontent.com/u/37123614?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ethDreamer",
      "html_url": "https://github.com/ethDreamer",
      "followers_url": "https://api.github.com/users/ethDreamer/followers",
      "following_url": "https://api.github.com/users/ethDreamer/following{/other_user}",
      "gists_url": "https://api.github.com/users/ethDreamer/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ethDreamer/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ethDreamer/subscriptions",
      "organizations_url": "https://api.github.com/users/ethDreamer/orgs",
      "repos_url": "https://api.github.com/users/ethDreamer/repos",
      "events_url": "https://api.github.com/users/ethDreamer/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ethDreamer/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-23T21:47:16Z",
    "updated_at": "2020-05-23T21:55:21Z",
    "author_association": "COLLABORATOR",
    "body": "I've looked closer at this now and I'm working on timing the existing code. These are my initial thoughts:\r\n\r\nI've been trying to interpret @michaelsproul statement:\r\n> Time the function get_new_eth1_data as a proportion of a block transition\r\n\r\nFrom the eth2.0 spec:\r\n```\r\nstate_transition(..):             // renamed to do_transition?\r\n    process_slots(..)             // renamed to per_slot_processing?\r\n    verify_block_signature(..)    // this instead takes place inside process_block()\r\n    process_block(..):            // renamed to per_block_processing?\r\n        process_block_header()\r\n        process_randao()\r\n        process_eth1_data()       // <- this is what we're timing\r\n        process_operations()\r\n```\r\nSo are we timing this as a proportion of **per_block_processing()** or **do_transition()**?\r\n\r\nI also noticed @michaelsproul 's [comment](https://github.com/sigp/lighthouse/pull/1093#pullrequestreview-413280749) on #1093 about **queued_deposits()**. While **queued_deposits()** also calls **process_eth1_data()**, it looks like this is part of an unrelated codepath used by the validator which we are not timing?\r\n\r\nI also found [benchmarking code for per_block_processing()](https://github.com/sigp/lighthouse/blob/master/consensus/state_processing/benches/benches.rs#L104).\r\n\r\nI'm not sure if the plan was to use that framework or just use some manual way to time it on a running beacon node. I'll keep digging either way and maybe I'll answer my own questions but any guidance is appreciated.\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/633144709/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/633160550",
    "html_url": "https://github.com/sigp/lighthouse/issues/1168#issuecomment-633160550",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1168",
    "id": 633160550,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYzMzE2MDU1MA==",
    "user": {
      "login": "ethDreamer",
      "id": 37123614,
      "node_id": "MDQ6VXNlcjM3MTIzNjE0",
      "avatar_url": "https://avatars.githubusercontent.com/u/37123614?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ethDreamer",
      "html_url": "https://github.com/ethDreamer",
      "followers_url": "https://api.github.com/users/ethDreamer/followers",
      "following_url": "https://api.github.com/users/ethDreamer/following{/other_user}",
      "gists_url": "https://api.github.com/users/ethDreamer/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ethDreamer/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ethDreamer/subscriptions",
      "organizations_url": "https://api.github.com/users/ethDreamer/orgs",
      "repos_url": "https://api.github.com/users/ethDreamer/repos",
      "events_url": "https://api.github.com/users/ethDreamer/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ethDreamer/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-24T00:49:26Z",
    "updated_at": "2020-05-24T01:14:47Z",
    "author_association": "COLLABORATOR",
    "body": "So I just used std::time::Instant() and I timed all the lines inside [per_block_processing()](https://github.com/sigp/lighthouse/blob/master/consensus/state_processing/src/per_block_processing.rs#L80) as well as individually timing the call to [process_eth1_data()](https://github.com/sigp/lighthouse/blob/master/consensus/state_processing/src/per_block_processing.rs#L119). Then I blew away my beacon data_dir and started a resync and gathered timing on 100000 calls. It looks like **process_eth1_data()** is **less than 1%** of the time inside **per_block_processing()**.\r\n\r\n  | per_block_processing() | process_eth1_data()\r\n-- | -- | --\r\nMedian [μs] | 170 | 1\r\nAverage [μs] | 236.91781 | 1.92018\r\n\r\nIf I've interpreted this issue correctly (meaning I've timed the right functions), it looks like caching would not provide a significant improvement here.\r\n\r\nIt's worth noting that I did notice a small number of extreme cases where the runtime of **process_eth1_data()** was significantly longer than average for unknown reasons.\r\nprocess_eth1_data stats | count | percent\r\n-- | -- | --\r\n\\>=10000 [μs] | 1 | 0.00%\r\n\\>=5000 [μs] | 2 | 0.00%\r\n\\>=1000 [μs] | 8 | 0.01%\r\n\\>=500 [μs] | 20 | 0.02%\r\n\\>=100 [μs] | 27 | 0.03%\r\n\\>=50 [μs] | 32 | 0.03%\r\n\\>=10 [μs] | 186 | 0.19%\r\n\\>=5 [μs] | 3714 | 3.71%\r\n\\>=4 [μs] | 8588 | 8.59%\r\n\\>=3 [μs] | 18746 | 18.75%\r\n\\>=2 [μs] | 40956 | 40.96%\r\n\\>=1 [μs] | 71964 | 71.96%\r\n\\>=0 [μs] | 100000 | 100.00%\r\n\r\nThese may be nothing to worry about as one explanation is that Linux may have preempted the lighthouse task and context-switched to something else right as execution entered process_eth1_data(). I know how to test this theory if it's worthwhile.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/633160550/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/633255316",
    "html_url": "https://github.com/sigp/lighthouse/issues/1168#issuecomment-633255316",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1168",
    "id": 633255316,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYzMzI1NTMxNg==",
    "user": {
      "login": "JustinDrake",
      "id": 731743,
      "node_id": "MDQ6VXNlcjczMTc0Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/731743?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/JustinDrake",
      "html_url": "https://github.com/JustinDrake",
      "followers_url": "https://api.github.com/users/JustinDrake/followers",
      "following_url": "https://api.github.com/users/JustinDrake/following{/other_user}",
      "gists_url": "https://api.github.com/users/JustinDrake/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/JustinDrake/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/JustinDrake/subscriptions",
      "organizations_url": "https://api.github.com/users/JustinDrake/orgs",
      "repos_url": "https://api.github.com/users/JustinDrake/repos",
      "events_url": "https://api.github.com/users/JustinDrake/events{/privacy}",
      "received_events_url": "https://api.github.com/users/JustinDrake/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-24T16:22:52Z",
    "updated_at": "2020-05-24T16:22:52Z",
    "author_association": "CONTRIBUTOR",
    "body": "> started a resync and gathered timing on 100000 calls\r\n\r\nThinking adversarially, the benchmarks should measure worst-case scenarios. That sync most likely doesn't capture the worst-case scenario.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/633255316/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/633320871",
    "html_url": "https://github.com/sigp/lighthouse/issues/1168#issuecomment-633320871",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1168",
    "id": 633320871,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYzMzMyMDg3MQ==",
    "user": {
      "login": "paulhauner",
      "id": 6660660,
      "node_id": "MDQ6VXNlcjY2NjA2NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/paulhauner",
      "html_url": "https://github.com/paulhauner",
      "followers_url": "https://api.github.com/users/paulhauner/followers",
      "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
      "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
      "organizations_url": "https://api.github.com/users/paulhauner/orgs",
      "repos_url": "https://api.github.com/users/paulhauner/repos",
      "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/paulhauner/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-25T00:10:39Z",
    "updated_at": "2020-05-25T00:10:39Z",
    "author_association": "MEMBER",
    "body": "> > started a resync and gathered timing on 100000 calls\r\n> \r\n> Thinking adversarially, the benchmarks should measure worst-case scenarios. That sync most likely doesn't capture the worst-case scenario.\r\n\r\nI think the worst-case could be achieved by:\r\n\r\n- Define some arbitrary `Eth1Data`: `eth1_data`.\r\n- Define some arbitrary `BeaconState`: `state`.\r\n- Fill `state.eth1_data_votes` with copies of `eth1_data`.\r\n- Call `process_eth1_data(state, eth1_data)`.\r\n\r\nAlso the case where `state.eth1_data_votes` is a list of random `Eth1Data` would be worth checking.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/633320871/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/917728304",
    "html_url": "https://github.com/sigp/lighthouse/issues/1168#issuecomment-917728304",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1168",
    "id": 917728304,
    "node_id": "IC_kwDOCFeAzc42s2ww",
    "user": {
      "login": "paulhauner",
      "id": 6660660,
      "node_id": "MDQ6VXNlcjY2NjA2NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/paulhauner",
      "html_url": "https://github.com/paulhauner",
      "followers_url": "https://api.github.com/users/paulhauner/followers",
      "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
      "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
      "organizations_url": "https://api.github.com/users/paulhauner/orgs",
      "repos_url": "https://api.github.com/users/paulhauner/repos",
      "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/paulhauner/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-09-12T23:10:48Z",
    "updated_at": "2021-09-12T23:10:48Z",
    "author_association": "MEMBER",
    "body": "I'm going to close this one, it's pretty stale by this point and we never come across `process_eth1_data` when we're profiling.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/917728304/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
