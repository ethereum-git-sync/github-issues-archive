{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/4234",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/4234/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/4234/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/4234/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/4234",
  "id": 1684211232,
  "node_id": "I_kwDOCFeAzc5kYwYg",
  "number": 4234,
  "title": "Withdrawals root on \"inconsistent\" attestation verification states",
  "user": {
    "login": "paulhauner",
    "id": 6660660,
    "node_id": "MDQ6VXNlcjY2NjA2NjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/paulhauner",
    "html_url": "https://github.com/paulhauner",
    "followers_url": "https://api.github.com/users/paulhauner/followers",
    "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
    "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
    "organizations_url": "https://api.github.com/users/paulhauner/orgs",
    "repos_url": "https://api.github.com/users/paulhauner/repos",
    "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
    "received_events_url": "https://api.github.com/users/paulhauner/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 5383189287,
      "node_id": "LA_kwDOCFeAzc8AAAABQNzzJw",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/v4.2.0",
      "name": "v4.2.0",
      "color": "337948",
      "default": false,
      "description": "Q2 2023"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "jimmygchen",
    "id": 742762,
    "node_id": "MDQ6VXNlcjc0Mjc2Mg==",
    "avatar_url": "https://avatars.githubusercontent.com/u/742762?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jimmygchen",
    "html_url": "https://github.com/jimmygchen",
    "followers_url": "https://api.github.com/users/jimmygchen/followers",
    "following_url": "https://api.github.com/users/jimmygchen/following{/other_user}",
    "gists_url": "https://api.github.com/users/jimmygchen/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jimmygchen/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jimmygchen/subscriptions",
    "organizations_url": "https://api.github.com/users/jimmygchen/orgs",
    "repos_url": "https://api.github.com/users/jimmygchen/repos",
    "events_url": "https://api.github.com/users/jimmygchen/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jimmygchen/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "jimmygchen",
      "id": 742762,
      "node_id": "MDQ6VXNlcjc0Mjc2Mg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/742762?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jimmygchen",
      "html_url": "https://github.com/jimmygchen",
      "followers_url": "https://api.github.com/users/jimmygchen/followers",
      "following_url": "https://api.github.com/users/jimmygchen/following{/other_user}",
      "gists_url": "https://api.github.com/users/jimmygchen/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jimmygchen/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jimmygchen/subscriptions",
      "organizations_url": "https://api.github.com/users/jimmygchen/orgs",
      "repos_url": "https://api.github.com/users/jimmygchen/repos",
      "events_url": "https://api.github.com/users/jimmygchen/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jimmygchen/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2023-04-26T03:39:37Z",
  "updated_at": "2023-05-15T01:30:08Z",
  "closed_at": "2023-05-15T01:30:08Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nOn April 24 we saw this log across our mainnet SigP fleet:\r\n\r\n```\r\nApr 24 02:14:28.797 ERRO Unable to validate attestation error: DBError(BlockReplayError(BlockProcessing(WithdrawalsRootMismatch { expected: 0xe7ad583501ba8fbbb1fd92fb416cbec416c7b9174f5ca5369d01fa4aa62d3ff2, found: 0xfa3b64cef0f2948013d73b7267b228b62f2ce2901ade70ecaeefbae03a8c39da }))), peer_id: 16Uiu2HAm88gHB8ZjQACD6U3ey9c12ZmBy746pWCWeoosFHPqLNSW, type: \"unaggregated\", slot: Slot(6289867), beacon_block_root: 0xae32ea8\r\n```\r\n\r\nThis is an attestation from the network failing verification due to a `BlockProcessingError::WithdrawalsRootMismatch` error. That error indicates that we were unable to recreate the `BeaconState` we need to process that attestation; it is an internal error in the category of *\"should never happen\"*.\r\n\r\nAn initial diagnosis from @michaelsproul was:\r\n\r\n> I think we're probably corrupting the block_roots array when we do the inconsistent state root replay:\r\n> \r\n> https://github.com/sigp/lighthouse/blob/693886b94176faa4cb450f024696cb69cda2fe58/beacon_node/beacon_chain/src/beacon_chain.rs#L5549-L5552\r\n>\r\n> https://github.com/sigp/lighthouse/blob/693886b94176faa4cb450f024696cb69cda2fe58/consensus/state_processing/src/block_replayer.rs#L184-L187\r\n>\r\n> https://github.com/sigp/lighthouse/blob/693886b94176faa4cb450f024696cb69cda2fe58/consensus/state_processing/src/block_replayer.rs#L235-L236\r\n> \r\n> Once block_roots is corrupted it will cause attestation replay to produce different rewards+penalties, changing balances, and therefore withdrawal amounts. I think this has been the case for a long time, but wasn't checked by the pre-Capella block processing code\r\n\r\nI agree with his diagnosis but I don't believe anyone has proved it yet (e.g. with a unit test).\r\n\r\nIn detail, I believe the sequence of events is:\r\n\r\n1. We receive an attestation from the network where we *do not* have its shuffling cached (in the case of the above error, the attestation pointed to a block that was 45 slots behind; a scenario that is unexpected and probably outside our caches).\r\n1. We end up determining that we need to load the state from disk to know the shuffling.\r\n1. We [call](https://github.com/sigp/lighthouse/blob/693886b94176faa4cb450f024696cb69cda2fe58/beacon_node/beacon_chain/src/beacon_chain.rs#L5549-L5552) `get_inconsistent_state_for_attestation_verification_only`, which loads a state from the DB and does an \"inconsistent\" version of state processing.\r\n1. The inconsistent lookup works by loading an epoch-boundary state from the hot DB and the replaying blocks (and skip slots) to generate the state at the requested slot. The state is \"inconsistent\" because we avoid the significant overhead of computing state roots during the process.\r\n1. A side-effect of using invalid state roots is that the block roots get corrupted too (because the block root contains the state root).\r\n1. Our invalid history of block roots means that we can't assign attestation rewards correctly (practically every attestation will be a miss because they're voting on block roots we don't know).\r\n1. These rewards *generally* don't matter, since we only update balances for attestation participation at epoch boundaries (and we never cross an epoch boundary in an inconsistent state replay). *However*, we do immediately update the balance for the proposer reward portion of an attestation.\r\n1. Therefore, if we have the scenario where a validator receives some proposer reward in an epoch *and* is scheduled for a withdrawal, then we end up giving them the wrong balance for a withdrawal (because we didn't assign them the proposer reward they actually earned).\r\n1. The mismatch in withdrawal amounts causes a withdrawal root mismatch.\r\n\r\n## Potential Solutions\r\n\r\nI see two potential solutions:\r\n\r\n1. Simply skip the withdrawals root check (or all the withdrawals code). Since attester shuffling is created with a 1-2 epoch look ahead and we're skipping less than an epoch, we don't care about the effect that the withdrawals have on the shuffling (if they actually had any affect at all, I don't think they do).\r\n1. [When loading](https://github.com/sigp/lighthouse/blob/693886b94176faa4cb450f024696cb69cda2fe58/beacon_node/beacon_chain/src/beacon_chain.rs#L5546-L5554) the inconsistent state to get the shuffling, just load the state at the epoch boundary and use it to get the shuffling. I don't know why we'd need a mid-epoch state just to get attester shuffling.\r\n\r\n(1) is the simplest solution, I think it's fairly easy to reason that it's correct. (2) is more complicated but perhaps a better solution because it (a) avoids doing unnecessary work and (b) potentially avoids other issues like this one in the future.\r\n ",
  "closed_by": {
    "login": "paulhauner",
    "id": 6660660,
    "node_id": "MDQ6VXNlcjY2NjA2NjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/paulhauner",
    "html_url": "https://github.com/paulhauner",
    "followers_url": "https://api.github.com/users/paulhauner/followers",
    "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
    "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
    "organizations_url": "https://api.github.com/users/paulhauner/orgs",
    "repos_url": "https://api.github.com/users/paulhauner/repos",
    "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
    "received_events_url": "https://api.github.com/users/paulhauner/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/4234/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/4234/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1522756571",
    "html_url": "https://github.com/sigp/lighthouse/issues/4234#issuecomment-1522756571",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4234",
    "id": 1522756571,
    "node_id": "IC_kwDOCFeAzc5aw2vb",
    "user": {
      "login": "paulhauner",
      "id": 6660660,
      "node_id": "MDQ6VXNlcjY2NjA2NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/paulhauner",
      "html_url": "https://github.com/paulhauner",
      "followers_url": "https://api.github.com/users/paulhauner/followers",
      "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
      "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
      "organizations_url": "https://api.github.com/users/paulhauner/orgs",
      "repos_url": "https://api.github.com/users/paulhauner/repos",
      "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/paulhauner/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-26T04:18:44Z",
    "updated_at": "2023-04-26T04:18:59Z",
    "author_association": "MEMBER",
    "body": "I'm having a go at option (2) over in #4235.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1522756571/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1522775240",
    "html_url": "https://github.com/sigp/lighthouse/issues/4234#issuecomment-1522775240",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4234",
    "id": 1522775240,
    "node_id": "IC_kwDOCFeAzc5aw7TI",
    "user": {
      "login": "paulhauner",
      "id": 6660660,
      "node_id": "MDQ6VXNlcjY2NjA2NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/paulhauner",
      "html_url": "https://github.com/paulhauner",
      "followers_url": "https://api.github.com/users/paulhauner/followers",
      "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
      "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
      "organizations_url": "https://api.github.com/users/paulhauner/orgs",
      "repos_url": "https://api.github.com/users/paulhauner/repos",
      "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/paulhauner/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-26T04:47:48Z",
    "updated_at": "2023-04-26T04:47:48Z",
    "author_association": "MEMBER",
    "body": "It turns out that (2) doesn't work since we can't just load the target state when the shuffling epoch is beyond the shuffling lookahead of the epoch of `beacon_block_root`. That's because all blocks in the current epoch of the state are required to compute the randao seed (and the target state doesn't include those blocks).\r\n\r\nLooks like we'll still need to do (1) regardless of whether not not we merge #4235.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1522775240/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1524454402",
    "html_url": "https://github.com/sigp/lighthouse/issues/4234#issuecomment-1524454402",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4234",
    "id": 1524454402,
    "node_id": "IC_kwDOCFeAzc5a3VQC",
    "user": {
      "login": "jimmygchen",
      "id": 742762,
      "node_id": "MDQ6VXNlcjc0Mjc2Mg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/742762?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jimmygchen",
      "html_url": "https://github.com/jimmygchen",
      "followers_url": "https://api.github.com/users/jimmygchen/followers",
      "following_url": "https://api.github.com/users/jimmygchen/following{/other_user}",
      "gists_url": "https://api.github.com/users/jimmygchen/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jimmygchen/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jimmygchen/subscriptions",
      "organizations_url": "https://api.github.com/users/jimmygchen/orgs",
      "repos_url": "https://api.github.com/users/jimmygchen/repos",
      "events_url": "https://api.github.com/users/jimmygchen/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jimmygchen/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-27T02:04:33Z",
    "updated_at": "2023-04-27T02:04:33Z",
    "author_association": "MEMBER",
    "body": "Hi @paulhauner , I'd like to look into this one.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1524454402/reactions",
      "total_count": 2,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 2,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1547069764",
    "html_url": "https://github.com/sigp/lighthouse/issues/4234#issuecomment-1547069764",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4234",
    "id": 1547069764,
    "node_id": "IC_kwDOCFeAzc5cNmlE",
    "user": {
      "login": "paulhauner",
      "id": 6660660,
      "node_id": "MDQ6VXNlcjY2NjA2NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/paulhauner",
      "html_url": "https://github.com/paulhauner",
      "followers_url": "https://api.github.com/users/paulhauner/followers",
      "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
      "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
      "organizations_url": "https://api.github.com/users/paulhauner/orgs",
      "repos_url": "https://api.github.com/users/paulhauner/repos",
      "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/paulhauner/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-15T01:30:08Z",
    "updated_at": "2023-05-15T01:30:08Z",
    "author_association": "MEMBER",
    "body": "Resolved via #4249 ðŸŽ‰ ",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1547069764/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
