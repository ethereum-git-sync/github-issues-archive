{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/1106",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/1106/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/1106/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/1106/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/1106",
  "id": 612743027,
  "node_id": "MDU6SXNzdWU2MTI3NDMwMjc=",
  "number": 1106,
  "title": "thread 'tokio-runtime-worker-11' panicked at 'supplied instant is later than self'",
  "user": {
    "login": "q9f",
    "id": 58883403,
    "node_id": "MDQ6VXNlcjU4ODgzNDAz",
    "avatar_url": "https://avatars.githubusercontent.com/u/58883403?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/q9f",
    "html_url": "https://github.com/q9f",
    "followers_url": "https://api.github.com/users/q9f/followers",
    "following_url": "https://api.github.com/users/q9f/following{/other_user}",
    "gists_url": "https://api.github.com/users/q9f/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/q9f/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/q9f/subscriptions",
    "organizations_url": "https://api.github.com/users/q9f/orgs",
    "repos_url": "https://api.github.com/users/q9f/repos",
    "events_url": "https://api.github.com/users/q9f/events{/privacy}",
    "received_events_url": "https://api.github.com/users/q9f/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2020-05-05T16:42:54Z",
  "updated_at": "2020-05-07T07:20:05Z",
  "closed_at": "2020-05-07T07:20:05Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nHappy to report that latest master is broken :sob: \r\n\r\nI can no longer run beacon nodes on Schlesi.\r\n\r\n## Version\r\n\r\nmaster @ 353e496bcb6aceafb8b6731a6a4972e779a90f6e\r\n\r\n## Present Behaviour\r\n\r\nThis happened on all beacon nodes I upgraded:\r\n\r\n```\r\nMay 05 18:31:30.001 INFO Synced                                  slot: 59557, block: 0xe1b0…8436, epoch: 1861, finalized_epoch: 1859, finalized_root: 0x9981…7c6b, peers: 2, service: slot_notifier\r\nMay 05 18:31:38.606 INFO Imported eth1 block(s)                  new: 1, total_cached_blocks: 4096, latest_block: 2643226, latest_block_age: 256 mins, service: eth1_rpc\r\nMay 05 18:31:42.000 INFO Synced                                  slot: 59558, block: 0x4474…3ac9, epoch: 1861, finalized_epoch: 1859, finalized_root: 0x9981…7c6b, peers: 2, service: slot_notifier\r\nMay 05 18:31:54.000 INFO Synced                                  slot: 59559, block: 0x15f3…2787, epoch: 1861, finalized_epoch: 1859, finalized_root: 0x9981…7c6b, peers: 2, service: slot_notifier\r\nMay 05 18:31:59.686 INFO Imported eth1 block(s)                  new: 1, total_cached_blocks: 4096, latest_block: 2643227, latest_block_age: 256 mins, service: eth1_rpc\r\nthread 'tokio-runtime-worker-11' panicked at 'supplied instant is later than self', src/libstd/time.rs:263:9\r\nstack backtrace:\r\n   0:     0x55c3788552d4 - backtrace::backtrace::libunwind::trace::h5ae3454ebe40b621\r\n                               at /cargo/registry/src/github.com-1ecc6299db9ec823/backtrace-0.3.44/src/backtrace/libunwind.rs:86\r\n   1:     0x55c3788552d4 - backtrace::backtrace::trace_unsynchronized::hbf6f267a483fb2c0\r\n                               at /cargo/registry/src/github.com-1ecc6299db9ec823/backtrace-0.3.44/src/backtrace/mod.rs:66\r\n   2:     0x55c3788552d4 - std::sys_common::backtrace::_print_fmt::h37755015d94b9085\r\n                               at src/libstd/sys_common/backtrace.rs:78\r\n   3:     0x55c3788552d4 - <std::sys_common::backtrace::_print::DisplayBacktrace as core::fmt::Display>::fmt::h0561c8cd3569b40d\r\n                               at src/libstd/sys_common/backtrace.rs:59\r\n   4:     0x55c37887adbc - core::fmt::write::h86a597a35d48a212\r\n                               at src/libcore/fmt/mod.rs:1063\r\n   5:     0x55c37884d0e3 - std::io::Write::write_fmt::h73d9dc0f29eefe48\r\n                               at src/libstd/io/mod.rs:1426\r\n   6:     0x55c378858105 - std::sys_common::backtrace::_print::h6c60c5ee09af0233\r\n                               at src/libstd/sys_common/backtrace.rs:62\r\n   7:     0x55c378858105 - std::sys_common::backtrace::print::hf9d1db01634f9b2a\r\n                               at src/libstd/sys_common/backtrace.rs:49\r\n   8:     0x55c378858105 - std::panicking::default_hook::{{closure}}::h1db9298dd213ae95\r\n                               at src/libstd/panicking.rs:204\r\n   9:     0x55c378857e52 - std::panicking::default_hook::h3272faf6cc91fd2e\r\n                               at src/libstd/panicking.rs:224\r\n  10:     0x55c378858762 - std::panicking::rust_panic_with_hook::hb976084785e50594\r\n                               at src/libstd/panicking.rs:470\r\n  11:     0x55c37885834b - rust_begin_unwind\r\n                               at src/libstd/panicking.rs:378\r\n  12:     0x55c378878b61 - core::panicking::panic_fmt::h45f7d6868edb5678\r\n                               at src/libcore/panicking.rs:85\r\n  13:     0x55c3788788f3 - core::option::expect_failed::h9a8bff6ff005b30d\r\n                               at src/libcore/option.rs:1203\r\n  14:     0x55c378854d58 - core::option::Option<T>::expect::h63f0b1f892892a5a\r\n                               at /rustc/4fb7144ed159f94491249e86d5bbd033b5d60550/src/libcore/option.rs:347\r\n  15:     0x55c378854d58 - std::time::Instant::duration_since::h6f45165ba2fea7fa\r\n                               at src/libstd/time.rs:263\r\n  16:     0x55c378854d58 - <std::time::Instant as core::ops::arith::Sub>::sub::h490f3bc6e9b2f3f5\r\n                               at src/libstd/time.rs:390\r\n  17:     0x55c3776c891f - eth2_libp2p::peer_manager::PeerManager<TSpec>::update_reputations::h2ebd9401c43b0f7d\r\n  18:     0x55c3776c2809 - eth2_libp2p::peer_manager::PeerManager<TSpec>::connect_peer::h8fd5922b91676c75\r\n  19:     0x55c377f81d86 - <eth2_libp2p::behaviour::Behaviour<TSubstream,TSpec> as libp2p_swarm::behaviour::NetworkBehaviour>::poll::hba8d5013332e63b1\r\n  20:     0x55c377e1aa5e - <libp2p_swarm::ExpandedSwarm<TTransport,TBehaviour,TInEvent,TOutEvent,THandler,THandlerErr,TConnInfo> as futures::stream::Stream>::poll::h2b7789d19d917148\r\n  21:     0x55c377dec124 - <eth2_libp2p::service::Service<TSpec> as futures::stream::Stream>::poll::he80dc605eee4251c\r\n  22:     0x55c377d48b34 - network::service::spawn_service::{{closure}}::h2d9a9aa2689e3adc\r\n  23:     0x55c3784ad842 - futures::task_impl::std::set::h70e771bf1fa6ae94\r\n  24:     0x55c3784adc32 - std::panicking::try::do_call::ha809959104cbaff8\r\n  25:     0x55c37885df17 - __rust_maybe_catch_panic\r\n                               at src/libpanic_unwind/lib.rs:86\r\n  26:     0x55c3784abea5 - tokio_threadpool::task::Task::run::h8a25e0fc0b82aed2\r\n  27:     0x55c3784a497e - tokio_threadpool::worker::Worker::run_task::he366337bba3af524\r\n  28:     0x55c3784a4032 - tokio_threadpool::worker::Worker::run::h4f626ae3de8fdd08\r\n  29:     0x55c3784863de - tokio_timer::clock::clock::with_default::hdce9ba1193c06f7d\r\n  30:     0x55c378488973 - tokio::runtime::threadpool::builder::Builder::build::{{closure}}::h9fe6c0b101470e3f\r\n  31:     0x55c3784ab76a - std::thread::local::LocalKey<T>::with::hcc974c4fb796cc4b\r\n  32:     0x55c3784ab899 - std::thread::local::LocalKey<T>::with::hd48affb814e24190\r\n  33:     0x55c3784ac458 - std::sys_common::backtrace::__rust_begin_short_backtrace::h3a88224508a0b894\r\n  34:     0x55c3784adc8c - std::panicking::try::do_call::hdc3d4d4ddaa707e3\r\n  35:     0x55c37885df17 - __rust_maybe_catch_panic\r\n                               at src/libpanic_unwind/lib.rs:86\r\n  36:     0x55c3784ae290 - core::ops::function::FnOnce::call_once{{vtable.shim}}::h23bb8c521ce6a7b9\r\n  37:     0x55c3788446cf - <alloc::boxed::Box<F> as core::ops::function::FnOnce<A>>::call_once::h553ef812d1929d1b\r\n                               at /rustc/4fb7144ed159f94491249e86d5bbd033b5d60550/src/liballoc/boxed.rs:1017\r\n  38:     0x55c37885d00d - <alloc::boxed::Box<F> as core::ops::function::FnOnce<A>>::call_once::h51b51bce029ae491\r\n                               at /rustc/4fb7144ed159f94491249e86d5bbd033b5d60550/src/liballoc/boxed.rs:1017\r\n  39:     0x55c37885d00d - std::sys_common::thread::start_thread::hca943f45f04c8e46\r\n                               at src/libstd/sys_common/thread.rs:13\r\n  40:     0x55c37885d00d - std::sys::unix::thread::Thread::new::thread_start::h352e8a5875b189ee\r\n                               at src/libstd/sys/unix/thread.rs:80\r\n  41:     0x7f1f49e3446f - start_thread\r\n  42:     0x7f1f49d4a3d3 - clone\r\n  43:                0x0 - <unknown>\r\nMay 05 18:32:04.785 INFO Sync Manager shutdown                   service: sync, service: network\r\nMay 05 18:32:06.000 INFO Synced                                  slot: 59560, block: 0x7e5b…0f2b, epoch: 1861, finalized_epoch: 1859, finalized_root: 0x9981…7c6b, peers: 2, service: slot_notifier\r\nMay 05 18:32:13.762 INFO Imported eth1 block(s)                  new: 1, total_cached_blocks: 4096, latest_block: 2643228, latest_block_age: 256 mins, service: eth1_rpc\r\nMay 05 18:32:18.000 INFO Synced                                  slot: 59561, block:    …  empty, epoch: 1861, finalized_epoch: 1859, finalized_root: 0x9981…7c6b, peers: 2, service: slot_notifier\r\nMay 05 18:32:27.832 INFO Imported eth1 block(s)                  new: 1, total_cached_blocks: 4096, latest_block: 2643229, latest_block_age: 256 mins, service: eth1_rpc\r\nMay 05 18:32:30.000 INFO Synced                                  slot: 59562, block:    …  empty, epoch: 1861, finalized_epoch: 1859, finalized_root: 0x9981…7c6b, peers: 2, service: slot_notifier\r\nMay 05 18:32:41.918 INFO Imported eth1 block(s)                  new: 1, total_cached_blocks: 4096, latest_block: 2643230, latest_block_age: 256 mins, service: eth1_rpc\r\nMay 05 18:32:42.001 INFO Synced                                  slot: 59563, block:    …  empty, epoch: 1861, finalized_epoch: 1859, finalized_root: 0x9981…7c6b, peers: 2, service: slot_notifier\r\n```\r\n\r\n## Expected Behaviour\r\n\r\nThe application should behave!\r\n\r\n## Steps to resolve\r\n\r\nN/A\r\n",
  "closed_by": {
    "login": "q9f",
    "id": 58883403,
    "node_id": "MDQ6VXNlcjU4ODgzNDAz",
    "avatar_url": "https://avatars.githubusercontent.com/u/58883403?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/q9f",
    "html_url": "https://github.com/q9f",
    "followers_url": "https://api.github.com/users/q9f/followers",
    "following_url": "https://api.github.com/users/q9f/following{/other_user}",
    "gists_url": "https://api.github.com/users/q9f/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/q9f/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/q9f/subscriptions",
    "organizations_url": "https://api.github.com/users/q9f/orgs",
    "repos_url": "https://api.github.com/users/q9f/repos",
    "events_url": "https://api.github.com/users/q9f/events{/privacy}",
    "received_events_url": "https://api.github.com/users/q9f/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/1106/reactions",
    "total_count": 1,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 1
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/1106/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/624313501",
    "html_url": "https://github.com/sigp/lighthouse/issues/1106#issuecomment-624313501",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1106",
    "id": 624313501,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyNDMxMzUwMQ==",
    "user": {
      "login": "pawanjay176",
      "id": 9890508,
      "node_id": "MDQ6VXNlcjk4OTA1MDg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9890508?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pawanjay176",
      "html_url": "https://github.com/pawanjay176",
      "followers_url": "https://api.github.com/users/pawanjay176/followers",
      "following_url": "https://api.github.com/users/pawanjay176/following{/other_user}",
      "gists_url": "https://api.github.com/users/pawanjay176/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pawanjay176/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pawanjay176/subscriptions",
      "organizations_url": "https://api.github.com/users/pawanjay176/orgs",
      "repos_url": "https://api.github.com/users/pawanjay176/repos",
      "events_url": "https://api.github.com/users/pawanjay176/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pawanjay176/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-05T21:22:11Z",
    "updated_at": "2020-05-05T21:22:11Z",
    "author_association": "MEMBER",
    "body": "The panic must have occurred at https://github.com/sigp/lighthouse/blob/353e496bcb6aceafb8b6731a6a4972e779a90f6e/beacon_node/eth2-libp2p/src/peer_manager/mod.rs#L396 when `self.last_updated < since`.\r\n\r\nOne possible path that could have led to panic is:\r\n1. Peer gets connected \r\n2. Peer gets disconnected \r\n3. [`notify_disconnect`](https://github.com/sigp/lighthouse/blob/master/beacon_node/eth2-libp2p/src/peer_manager/mod.rs#L206) gets called. Call to `update_reputations` updates `self.last_updated` to `now1`. \r\n4. `notify_disconnect`'s call to `peerdb.disconnect(peer_id)` updates `info.connection_status` to `Disconnect {since: now2}` and `now2 > now1`\r\n5. Peer gets connected again and call to `update_reputation` panics as `self.last_updated < since`.\r\n\r\nMight have panicked other ways too but the main issue seems to be the unchecked subtraction and the connection status getting updated in multiple places.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/624313501/reactions",
      "total_count": 3,
      "+1": 3,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/624416840",
    "html_url": "https://github.com/sigp/lighthouse/issues/1106#issuecomment-624416840",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1106",
    "id": 624416840,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyNDQxNjg0MA==",
    "user": {
      "login": "AgeManning",
      "id": 7454587,
      "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AgeManning",
      "html_url": "https://github.com/AgeManning",
      "followers_url": "https://api.github.com/users/AgeManning/followers",
      "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
      "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
      "organizations_url": "https://api.github.com/users/AgeManning/orgs",
      "repos_url": "https://api.github.com/users/AgeManning/repos",
      "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AgeManning/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-06T02:58:40Z",
    "updated_at": "2020-05-06T02:58:40Z",
    "author_association": "MEMBER",
    "body": "Thanks @q9f for raising this and @pawanjay176 for isolating the issue. \r\n\r\n@divagant-martian I have made a PR which updates this part of the code to protect against underflows here. Will merge once reviewed and you're happy the logic here remains intact. ",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/624416840/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/624933575",
    "html_url": "https://github.com/sigp/lighthouse/issues/1106#issuecomment-624933575",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1106",
    "id": 624933575,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyNDkzMzU3NQ==",
    "user": {
      "login": "paulhauner",
      "id": 6660660,
      "node_id": "MDQ6VXNlcjY2NjA2NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/paulhauner",
      "html_url": "https://github.com/paulhauner",
      "followers_url": "https://api.github.com/users/paulhauner/followers",
      "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
      "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
      "organizations_url": "https://api.github.com/users/paulhauner/orgs",
      "repos_url": "https://api.github.com/users/paulhauner/repos",
      "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/paulhauner/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-06T22:57:49Z",
    "updated_at": "2020-05-06T22:57:49Z",
    "author_association": "MEMBER",
    "body": "Is the plan to keep this one open until we haven't seen the panic for a few days?\r\n\r\nAs I understand it we believe the panic is fixed, but were unable to recreate it.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/624933575/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/625077313",
    "html_url": "https://github.com/sigp/lighthouse/issues/1106#issuecomment-625077313",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1106",
    "id": 625077313,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyNTA3NzMxMw==",
    "user": {
      "login": "q9f",
      "id": 58883403,
      "node_id": "MDQ6VXNlcjU4ODgzNDAz",
      "avatar_url": "https://avatars.githubusercontent.com/u/58883403?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/q9f",
      "html_url": "https://github.com/q9f",
      "followers_url": "https://api.github.com/users/q9f/followers",
      "following_url": "https://api.github.com/users/q9f/following{/other_user}",
      "gists_url": "https://api.github.com/users/q9f/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/q9f/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/q9f/subscriptions",
      "organizations_url": "https://api.github.com/users/q9f/orgs",
      "repos_url": "https://api.github.com/users/q9f/repos",
      "events_url": "https://api.github.com/users/q9f/events{/privacy}",
      "received_events_url": "https://api.github.com/users/q9f/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-07T07:20:05Z",
    "updated_at": "2020-05-07T07:20:05Z",
    "author_association": "CONTRIBUTOR",
    "body": "#1111 fixed this. let's close this.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/625077313/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
