{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/5058",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/5058/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/5058/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/5058/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/5058",
  "id": 2077818770,
  "node_id": "I_kwDOCFeAzc572P-S",
  "number": 5058,
  "title": "Slow backfill during checkpoint sync post-deneb",
  "user": {
    "login": "realbigsean",
    "id": 5160426,
    "node_id": "MDQ6VXNlcjUxNjA0MjY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5160426?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/realbigsean",
    "html_url": "https://github.com/realbigsean",
    "followers_url": "https://api.github.com/users/realbigsean/followers",
    "following_url": "https://api.github.com/users/realbigsean/following{/other_user}",
    "gists_url": "https://api.github.com/users/realbigsean/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/realbigsean/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/realbigsean/subscriptions",
    "organizations_url": "https://api.github.com/users/realbigsean/orgs",
    "repos_url": "https://api.github.com/users/realbigsean/repos",
    "events_url": "https://api.github.com/users/realbigsean/events{/privacy}",
    "received_events_url": "https://api.github.com/users/realbigsean/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 985647281,
      "node_id": "MDU6TGFiZWw5ODU2NDcyODE=",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/bug",
      "name": "bug",
      "color": "d73a4a",
      "default": true,
      "description": "Something isn't working"
    },
    {
      "id": 4615284981,
      "node_id": "LA_kwDOCFeAzc8AAAABExeo9Q",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/deneb",
      "name": "deneb",
      "color": "B7BBEC",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": {
    "login": "pawanjay176",
    "id": 9890508,
    "node_id": "MDQ6VXNlcjk4OTA1MDg=",
    "avatar_url": "https://avatars.githubusercontent.com/u/9890508?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/pawanjay176",
    "html_url": "https://github.com/pawanjay176",
    "followers_url": "https://api.github.com/users/pawanjay176/followers",
    "following_url": "https://api.github.com/users/pawanjay176/following{/other_user}",
    "gists_url": "https://api.github.com/users/pawanjay176/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/pawanjay176/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/pawanjay176/subscriptions",
    "organizations_url": "https://api.github.com/users/pawanjay176/orgs",
    "repos_url": "https://api.github.com/users/pawanjay176/repos",
    "events_url": "https://api.github.com/users/pawanjay176/events{/privacy}",
    "received_events_url": "https://api.github.com/users/pawanjay176/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "pawanjay176",
      "id": 9890508,
      "node_id": "MDQ6VXNlcjk4OTA1MDg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9890508?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pawanjay176",
      "html_url": "https://github.com/pawanjay176",
      "followers_url": "https://api.github.com/users/pawanjay176/followers",
      "following_url": "https://api.github.com/users/pawanjay176/following{/other_user}",
      "gists_url": "https://api.github.com/users/pawanjay176/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pawanjay176/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pawanjay176/subscriptions",
      "organizations_url": "https://api.github.com/users/pawanjay176/orgs",
      "repos_url": "https://api.github.com/users/pawanjay176/repos",
      "events_url": "https://api.github.com/users/pawanjay176/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pawanjay176/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2024-01-12T00:24:39Z",
  "updated_at": "2024-01-17T13:54:03Z",
  "closed_at": null,
  "author_association": "COLLABORATOR",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nThese logs show a node syncing devnet 12, backfilling across the DA boundary. There's a massive jump in speed (and I don't think there are that many blobs on devnet 12). There could be a bottle neck somewhere related to rate limiting. The node below is running with `  --disable-backfill-rate-limiting`, without this flag, post-deneb backfill is a meager 8 slots/second.\r\n\r\n```\r\nJan 12 00:10:06.004 INFO Downloading historical blocks           est_time: 1 hr 47 mins, speed: 28.67 slots/sec, distance: 184896 slots (3 weeks 4 days), service: slot_notifier\r\nJan 12 00:11:06.003 INFO Downloading historical blocks           est_time: 2 hrs 0 mins, speed: 25.34 slots/sec, distance: 182944 slots (3 weeks 4 days), service: slot_notifier\r\nJan 12 00:12:06.002 INFO Downloading historical blocks           est_time: 5 mins, speed: 484.02 slots/sec, distance: 158880 slots (3 weeks 1 days), service: slot_notifier\r\nJan 12 00:13:06.001 INFO Downloading historical blocks           est_time: 3 mins, speed: 560.70 slots/sec, distance: 125472 slots (2 weeks 3 days), service: slot_notifier\r\n```\r\n\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/5058/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/5058/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1888512345",
    "html_url": "https://github.com/sigp/lighthouse/issues/5058#issuecomment-1888512345",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/5058",
    "id": 1888512345,
    "node_id": "IC_kwDOCFeAzc5wkGlZ",
    "user": {
      "login": "pawanjay176",
      "id": 9890508,
      "node_id": "MDQ6VXNlcjk4OTA1MDg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9890508?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pawanjay176",
      "html_url": "https://github.com/pawanjay176",
      "followers_url": "https://api.github.com/users/pawanjay176/followers",
      "following_url": "https://api.github.com/users/pawanjay176/following{/other_user}",
      "gists_url": "https://api.github.com/users/pawanjay176/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pawanjay176/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pawanjay176/subscriptions",
      "organizations_url": "https://api.github.com/users/pawanjay176/orgs",
      "repos_url": "https://api.github.com/users/pawanjay176/repos",
      "events_url": "https://api.github.com/users/pawanjay176/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pawanjay176/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2024-01-12T06:37:54Z",
    "updated_at": "2024-01-12T06:37:54Z",
    "author_association": "MEMBER",
    "body": "I'm picking this up",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1888512345/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1890289632",
    "html_url": "https://github.com/sigp/lighthouse/issues/5058#issuecomment-1890289632",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/5058",
    "id": 1890289632,
    "node_id": "IC_kwDOCFeAzc5wq4fg",
    "user": {
      "login": "realbigsean",
      "id": 5160426,
      "node_id": "MDQ6VXNlcjUxNjA0MjY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5160426?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/realbigsean",
      "html_url": "https://github.com/realbigsean",
      "followers_url": "https://api.github.com/users/realbigsean/followers",
      "following_url": "https://api.github.com/users/realbigsean/following{/other_user}",
      "gists_url": "https://api.github.com/users/realbigsean/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/realbigsean/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/realbigsean/subscriptions",
      "organizations_url": "https://api.github.com/users/realbigsean/orgs",
      "repos_url": "https://api.github.com/users/realbigsean/repos",
      "events_url": "https://api.github.com/users/realbigsean/events{/privacy}",
      "received_events_url": "https://api.github.com/users/realbigsean/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2024-01-13T03:47:40Z",
    "updated_at": "2024-01-13T03:48:21Z",
    "author_association": "COLLABORATOR",
    "body": "Sorry Pawan, I didn't see you picked this one up, so I was also digging into it most of today. This is some data from a node I backfill synced. It includes the average time it took to download blocks + blobs (above epoch 5883 is within the DA period)Â or just blocks (below epoch 5883 was when blobs were pruned) from different peers. \r\n\r\nOn devnet 12 there are an average of between 2 and 3 blobs per block in the DA period. So it makes sense it's taking longer, but a lot of these look up to 10x longer ðŸ˜². Some of the worst offenders seem to be other lighthouse nodes too. I was seeing quite a few instances of blobs by range responses taking 20 seconds.\r\n\r\nFrom what I can tell actually processing the blocks+blobs is very fast, it's the download that's a major bottleneck.\r\n\r\n```\r\n{\r\n  \"16Uiu2HAm5TWkzRVUqjxLttLG3sKbk9QjvEkvGQ4JnTfST8JNL9dL\": {\"client\": \"Teku\", \"ave_above_5883\": 4.331660130718955, \"ave_below_5883\": 0.5652424242424241},\r\n  \"16Uiu2HAkyTn7NBzK8oPx84P4BkPiHDZTeGZCuxURmvxCwxa2N12R\": {\"client\": \"Lighthouse\", \"ave_above_5883\": 7.944390624999998, \"ave_below_5883\": 0.9070058823529413},\r\n  \"16Uiu2HAmUXq8HZVkaNXvGxcb6nVDC3VJ8jYN8BYQ7T3vX2dDjAKz\": {\"client\": \"Lighthouse\", \"ave_above_5883\": 7.5444479999999965, \"ave_below_5883\": 0.9348224852071002},\r\n  \"16Uiu2HAm2q3VtL2JJ3LNzmRXhjcMmE1uEhWpTd4QkjfRvcthU8df\": {\"client\": \"Lighthouse\", \"ave_above_5883\": 1.5106870748299321, \"ave_below_5883\": 0.2164069264069264},\r\n  \"16Uiu2HAkyDj54FkSM5ycXBe9rA1Ripew4hkCDgRU4nhcmeLXMEY4\": {\"client\": \"Nimbus\", \"ave_above_5883\": 1.581226277372262, \"ave_below_5883\": 0.29585531914893615},\r\n  \"16Uiu2HAm9extyqLNM2mLECP9ZAMtetZYgKWKfcKPAdFzJE7Zoydp\": {\"client\": \"Nimbus\", \"ave_above_5883\": 5.288608695652173, \"ave_below_5883\": 0.5745909090909089},\r\n  \"16Uiu2HAm4n9keZMiLjFTepTt8NTokrjoVk8VU6kkrxoT3EcJZPPC\": {\"client\": \"Nimbus\", \"ave_above_5883\": 4.852402985074627, \"ave_below_5883\": 0.6732920792079209},\r\n  \"16Uiu2HAmLNqBMyQghPr3HYvhDTDB1zuNWLnbuxkeWA47p7pCJx7L\": {\"client\": \"Teku\", \"ave_above_5883\": 4.241738562091503, \"ave_below_5883\": 0.5153380281690142},\r\n  \"16Uiu2HAm5GEuXcYgcPwhGhEuNjmRudCZbBpVFDVxUnKjEyB5o2hq\": {\"client\": \"Nimbus\", \"ave_above_5883\": 4.547566929133858, \"ave_below_5883\": 0.756716666666667},\r\n  \"16Uiu2HAm4WcpskWGsUeEEjvpw78AKU2WQGaHpBy4JUcP6Df2A8G6\": {\"client\": \"Nimbus\", \"ave_above_5883\": 5.329966666666667, \"ave_below_5883\": 0.5619646464646466},\r\n  \"16Uiu2HAmNyD6PdjfhLzPBhkwP1cZHgmRaHBw9VHN4iEDkaS6oZN1\": {\"client\": \"Teku\", \"ave_above_5883\": 4.778825757575758, \"ave_below_5883\": 0.6471554404145071},\r\n  \"16Uiu2HAmG1T4omgPdbmydgckCstrqRxCmtpQMo5bikmbgFrcc8Px\": {\"client\": \"Teku\", \"ave_above_5883\": 4.298121212121211, \"ave_below_5883\": 0.9621931818181817},\r\n  \"16Uiu2HAmVq818ULsMCGn7MmXgYrqRf27VFUVDXPZLuMEDUKYcEkA\": {\"client\": \"Nimbus\", \"ave_above_5883\": 2.2681085271317825, \"ave_below_5883\": 0.31068303571428574},\r\n  \"16Uiu2HAmPFSCKhiWe6cD29UV5UChqKLsA4DwuchCpN7stCAJNq8Y\": {\"client\": \"Lighthouse\", \"ave_above_5883\": 3.345787671232878, \"ave_below_5883\": 0.5047376237623764},\r\n  \"16Uiu2HAkwR2kiW4b4Q33XZDZyHcsUz8zjoNtzQjuf1nZbyhmxeB3\": {\"client\": \"Nimbus\", \"ave_above_5883\": 3.5957980769230744, \"ave_below_5883\": 1.2696551724137934},\r\n  \"16Uiu2HAm4ZdUHQSrMFAtjTfWWDsdJPfxjHhcyZu9LbACarpGNhkZ\": {\"client\": \"Nimbus\", \"ave_above_5883\": 3.0378983050847475, \"ave_below_5883\": 0.6890175438596491},\r\n  \"16Uiu2HAmH1StaP5y1fBxU5qq1XK4pCt5nzyXy3bBR155irhKA1HB\": {\"client\": \"Nimbus\", \"ave_above_5883\": 5.278046153846152, \"ave_below_5883\": 0.7943218390804598},\r\n  \"16Uiu2HAkyEnNk74LR4MtQz5CBBx9wi1AJM1YJY6wrrDuEJLCvtBC\": {\"client\": \"Teku\", \"ave_above_5883\": 4.089940789473684, \"ave_below_5883\": 1.0763855421686743},\r\n  \"16Uiu2HAkzhegydake1LRdtPZgh7cZCWBUcAWudvYymDvbsCdvRpU\": {\"client\": \"Lighthouse\", \"ave_above_5883\": 4.24456617647059, \"ave_below_5883\": 0.6825},\r\n  \"16Uiu2HAmPhYvvjj8MQTkkrxkornfTjdEPJtMZLEXBRTVCn8jMkWk\": {\"client\": \"Teku\", \"ave_above_5883\": 3.6837499999999994, \"ave_below_5883\": 1.227933884297521},\r\n  \"16Uiu2HAm697RD72UdCwaizX4VDp7xChQRzj5VYk9paFw8cZ7H95t\": {\"client\": \"Teku\", \"ave_above_5883\": 4.832015873015875, \"ave_below_5883\": 0.6475124378109449},\r\n  \"16Uiu2HAmA8Gbyve4CNJjnJJSoY4yEJtsoMJaspGr6Kna3toKSr7u\": {\"client\": \"Nimbus\", \"ave_above_5883\": 2.9518301886792453, \"ave_below_5883\": 0.6919147286821706},\r\n}\r\n```\r\n\r\nSpecifically this is measuring how much time elapses between these two logs (as you can see this one is ~14s):\r\n\r\n```\r\nJan 13 00:58:45.393 DEBG Sending backfill BlocksByRange and BlobsByRange requests, batch_id: 9892, peer: 16Uiu2HAkyEnNk74LR4MtQz5CBBx9wi1AJM1YJY6wrrDuEJLCvtBC, count: 32, method: Mixed by range request, service: sync\r\nJan 13 00:58:59.818 DEBG Completed batch received                awaiting_batches: 0, blocks: 25, epoch: 9892, service: sync\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1890289632/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1895860564",
    "html_url": "https://github.com/sigp/lighthouse/issues/5058#issuecomment-1895860564",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/5058",
    "id": 1895860564,
    "node_id": "IC_kwDOCFeAzc5xAIlU",
    "user": {
      "login": "pawanjay176",
      "id": 9890508,
      "node_id": "MDQ6VXNlcjk4OTA1MDg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9890508?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pawanjay176",
      "html_url": "https://github.com/pawanjay176",
      "followers_url": "https://api.github.com/users/pawanjay176/followers",
      "following_url": "https://api.github.com/users/pawanjay176/following{/other_user}",
      "gists_url": "https://api.github.com/users/pawanjay176/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pawanjay176/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pawanjay176/subscriptions",
      "organizations_url": "https://api.github.com/users/pawanjay176/orgs",
      "repos_url": "https://api.github.com/users/pawanjay176/repos",
      "events_url": "https://api.github.com/users/pawanjay176/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pawanjay176/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2024-01-17T13:54:02Z",
    "updated_at": "2024-01-17T13:54:02Z",
    "author_association": "MEMBER",
    "body": "Yeah this definitely looks like a self rate limiting issue. I think we aren't making enough requests.\r\nWe are only allowing 768 blobs to be downloaded every 10 seconds, so ~76 blobs/sec.\r\n\r\nEach blobs by range request asks for 32 (batch size) * 6 (max_blobs_per_block) = 192 blobs. \r\nSo we start rate limiting as soon as we make <1 request. \r\n\r\nIn contrast, the rate limit for blocks is 1024 every 10 secs so ~102 blocks/sec and we ask for 32 blocks in every batch. So we need 3 concurrent requests atleast before rate limiting starts kicking in.\r\n\r\nWe should definitely have blobs_by_range_limit to be atleast  6 * blocks_by_range_limit. I also think that we can 2x the range limits",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1895860564/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
