{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/1677",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/1677/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/1677/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/1677/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/1677",
  "id": 710131043,
  "node_id": "MDU6SXNzdWU3MTAxMzEwNDM=",
  "number": 1677,
  "title": "Discrepancies regarding the use of `decrease_balance`",
  "user": {
    "login": "JustinDrake",
    "id": 731743,
    "node_id": "MDQ6VXNlcjczMTc0Mw==",
    "avatar_url": "https://avatars.githubusercontent.com/u/731743?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/JustinDrake",
    "html_url": "https://github.com/JustinDrake",
    "followers_url": "https://api.github.com/users/JustinDrake/followers",
    "following_url": "https://api.github.com/users/JustinDrake/following{/other_user}",
    "gists_url": "https://api.github.com/users/JustinDrake/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/JustinDrake/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/JustinDrake/subscriptions",
    "organizations_url": "https://api.github.com/users/JustinDrake/orgs",
    "repos_url": "https://api.github.com/users/JustinDrake/repos",
    "events_url": "https://api.github.com/users/JustinDrake/events{/privacy}",
    "received_events_url": "https://api.github.com/users/JustinDrake/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1690958121,
      "node_id": "MDU6TGFiZWwxNjkwOTU4MTIx",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/code-quality",
      "name": "code-quality",
      "color": "77a7ff",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2020-09-28T10:10:33Z",
  "updated_at": "2020-10-01T13:20:18Z",
  "closed_at": "2020-10-01T13:20:18Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "The function `decrease_balance` (which is defined in `common/mod.rs`) is only used once in `slash_validator`. In `process_slashings` you explicit avoid using `decrease_balance`:\r\n\r\n```rust\r\n            // Equivalent to `decrease_balance(state, index, penalty)`, but avoids borrowing `state`.\r\n            state.balances[index] = state.balances[index].saturating_sub(penalty);\r\n```\r\n\r\nSimilarly, `decrease_balance` is avoided in `process_rewards_and_penalties`. A couple questions:\r\n\r\n1) What does \"avoid borrowing `state`\" mean, and what is the advantage versus called `decrease_balance`?\r\n2) Why is `decrease_balance` not avoided in `slash_validator`? Why not be consistent with `process_slashings`?",
  "closed_by": {
    "login": "michaelsproul",
    "id": 4452260,
    "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/michaelsproul",
    "html_url": "https://github.com/michaelsproul",
    "followers_url": "https://api.github.com/users/michaelsproul/followers",
    "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
    "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
    "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
    "repos_url": "https://api.github.com/users/michaelsproul/repos",
    "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
    "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/1677/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/1677/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/700590911",
    "html_url": "https://github.com/sigp/lighthouse/issues/1677#issuecomment-700590911",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1677",
    "id": 700590911,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcwMDU5MDkxMQ==",
    "user": {
      "login": "paulhauner",
      "id": 6660660,
      "node_id": "MDQ6VXNlcjY2NjA2NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/paulhauner",
      "html_url": "https://github.com/paulhauner",
      "followers_url": "https://api.github.com/users/paulhauner/followers",
      "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
      "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
      "organizations_url": "https://api.github.com/users/paulhauner/orgs",
      "repos_url": "https://api.github.com/users/paulhauner/repos",
      "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/paulhauner/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-09-29T09:41:26Z",
    "updated_at": "2020-09-29T09:42:12Z",
    "author_association": "MEMBER",
    "body": "I haven't looked into this deeply, but for a quick triage:\r\n\r\n1. \"Borrowing state\" is to do with Rust's ownership system. It's generally *the* learning curve with Rust, so I won't go into it in detail but a borrow is akin to taking a reference but with lots of additional constraints from the compiler. These constraints exist generally to allow Rust to be GC-free and also to prevent variable-access race-conditions between threads. The constraints are generally great, but sometimes you need to work a little harder to satisfy the compiler that you're being safe. I think that's the case here.\r\n1. I think it's because we're not already iterating through state in this case, but I'm not sure.\r\n\r\nWe'll look into this in the short-term and get back with a proper answer :)",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/700590911/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/701159545",
    "html_url": "https://github.com/sigp/lighthouse/issues/1677#issuecomment-701159545",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1677",
    "id": 701159545,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcwMTE1OTU0NQ==",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-09-30T05:10:49Z",
    "updated_at": "2020-09-30T05:11:56Z",
    "author_association": "MEMBER",
    "body": "@paulhauner's analysis is spot on, in that this is a constraint imposed by Rust's type system due to the fact that `state.validators` is being iterated here:\r\n\r\nhttps://github.com/sigp/lighthouse/blob/a1a6b01acb44d9c9a336524cc9a3997b8aaad0fe/consensus/state_processing/src/per_epoch_processing/process_slashings.rs#L19-L35\r\n\r\nWe can't obtain a mutable reference to `state` inside that loop, because part of it (`state.validators`) is already borrowed mutably.\r\n\r\nIf we wanted to use a function called `decrease_balance` in both places, we would have to change the definition of `decrease_balance` to only borrow the `state.balances` field that it's _really_ interested in, like:\r\n\r\n```rust\r\n/// Decrease the balance of a validator, saturating upon overflow, as per the spec.\r\n///\r\n/// Spec v0.12.1\r\npub fn decrease_balance(balances: &mut [u64], index: usize, delta: u64) {\r\n    balances[index] = balances[index].saturating_sub(delta);\r\n}\r\n```\r\n\r\nAnd then we would call it like this in that loop (and in `slash_validator`):\r\n\r\n```rust\r\ndecrease_balance(&mut state.balances, index, penalty);\r\n```\r\n\r\nI think both options are similar in terms of elegance/similarity to the spec. Having `decrease_balance` take `&mut state.balances` is itself kind of mysterious, in which case the current approach with the explicit comment about this being a Rust-specific thing isn't so bad IMO.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/701159545/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/702106936",
    "html_url": "https://github.com/sigp/lighthouse/issues/1677#issuecomment-702106936",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1677",
    "id": 702106936,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcwMjEwNjkzNg==",
    "user": {
      "login": "JustinDrake",
      "id": 731743,
      "node_id": "MDQ6VXNlcjczMTc0Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/731743?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/JustinDrake",
      "html_url": "https://github.com/JustinDrake",
      "followers_url": "https://api.github.com/users/JustinDrake/followers",
      "following_url": "https://api.github.com/users/JustinDrake/following{/other_user}",
      "gists_url": "https://api.github.com/users/JustinDrake/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/JustinDrake/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/JustinDrake/subscriptions",
      "organizations_url": "https://api.github.com/users/JustinDrake/orgs",
      "repos_url": "https://api.github.com/users/JustinDrake/repos",
      "events_url": "https://api.github.com/users/JustinDrake/events{/privacy}",
      "received_events_url": "https://api.github.com/users/JustinDrake/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-10-01T12:40:50Z",
    "updated_at": "2020-10-01T12:40:50Z",
    "author_association": "CONTRIBUTOR",
    "body": "Thank you for the explanations :) I'll let you address and close this issue as you see fit.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/702106936/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/702129695",
    "html_url": "https://github.com/sigp/lighthouse/issues/1677#issuecomment-702129695",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1677",
    "id": 702129695,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcwMjEyOTY5NQ==",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-10-01T13:20:18Z",
    "updated_at": "2020-10-01T13:20:18Z",
    "author_association": "MEMBER",
    "body": "I'm going to close for now, but I'll keep it in mind, particularly if anyone else gets tripped up by it",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/702129695/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
