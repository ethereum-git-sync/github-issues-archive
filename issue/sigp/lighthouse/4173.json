{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/4173",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/4173/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/4173/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/4173/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/4173",
  "id": 1659131578,
  "node_id": "I_kwDOCFeAzc5i5Fa6",
  "number": 4173,
  "title": "Extra payload attributes event",
  "user": {
    "login": "realbigsean",
    "id": 5160426,
    "node_id": "MDQ6VXNlcjUxNjA0MjY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5160426?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/realbigsean",
    "html_url": "https://github.com/realbigsean",
    "followers_url": "https://api.github.com/users/realbigsean/followers",
    "following_url": "https://api.github.com/users/realbigsean/following{/other_user}",
    "gists_url": "https://api.github.com/users/realbigsean/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/realbigsean/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/realbigsean/subscriptions",
    "organizations_url": "https://api.github.com/users/realbigsean/orgs",
    "repos_url": "https://api.github.com/users/realbigsean/repos",
    "events_url": "https://api.github.com/users/realbigsean/events{/privacy}",
    "received_events_url": "https://api.github.com/users/realbigsean/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 2336800343,
      "node_id": "MDU6TGFiZWwyMzM2ODAwMzQz",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/HTTP-API",
      "name": "HTTP-API",
      "color": "5A63A2",
      "default": false,
      "description": ""
    },
    {
      "id": 4771662300,
      "node_id": "LA_kwDOCFeAzc8AAAABHGnJ3A",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/builder%20API",
      "name": "builder API",
      "color": "C9A283",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2023-04-07T19:43:12Z",
  "updated_at": "2023-08-14T00:10:29Z",
  "closed_at": null,
  "author_association": "COLLABORATOR",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nIt looks like we're sending an extra payload attributes event at the start of each slot. In this example the slot time is at the 23 second mark and the head hash given that of slot 6168014 where it should be (and is correctly in the second event) 6168015\r\n\r\n```\r\nApr 07 04:03:23: INFO [04-07|04:03:23.009] received payload from event              payloadAttributes=\"{Timestamp:0x642f9617 Random:0xb52232d5c04410623ae6350319a81ab22c8a814f6f8eb1c006921a65310d8e35 SuggestedFeeRecipient:0x0000000000000000000000000000000000000001 Slot:6168016 HeadHash:0xc21f35a06210b399e0f6618e5e260ced3c77b6911790d5a46139e6d81cfbce52 Withdrawals:[] GasLimit:0}\"\r\nApr 07 04:03:23: INFO [04-07|04:03:23.970] received payload from event              payloadAttributes=\"{Timestamp:0x642f9617 Random:0xfe0ccbe75bbea3be9178ca4718f5be1b1c9a3b0e506161bb3764086fab69dd52 SuggestedFeeRecipient:0x0000000000000000000000000000000000000001 Slot:6168016 HeadHash:0xbede1bc8db2b2f4031f96ab25785e182d8028690a9bde912b9a3d2fe46a95bc1 Withdrawals:[] GasLimit:0}\"\r\n```\r\n\r\nI think the extra event's being triggered by this flow: `per_slot_task` -> `recompute_head_at_current_slot`  -> `recompute_head_at_slot` -> `recompute_head_at_slot_internal` -> `spawn_execution_layer_updates` -> `prepare_beacon_proposer`\r\n\r\nWe don't have any `till_prepare_slot` logic for events from what I can tell, we should probably add it to supress this specific event. \r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/4173/reactions",
    "total_count": 1,
    "+1": 1,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/4173/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1500854077",
    "html_url": "https://github.com/sigp/lighthouse/issues/4173#issuecomment-1500854077",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4173",
    "id": 1500854077,
    "node_id": "IC_kwDOCFeAzc5ZdTc9",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-08T10:06:53Z",
    "updated_at": "2023-04-08T10:06:53Z",
    "author_association": "MEMBER",
    "body": "Agree we should apply the `till_prepare_slot` logic, then relays can configure how early they want to receive this \"empty block\" event/whether they want it at all\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1500854077/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1503265893",
    "html_url": "https://github.com/sigp/lighthouse/issues/4173#issuecomment-1503265893",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4173",
    "id": 1503265893,
    "node_id": "IC_kwDOCFeAzc5ZmgRl",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-11T12:47:49Z",
    "updated_at": "2023-04-11T12:47:49Z",
    "author_association": "MEMBER",
    "body": "I need to make sure it doesn't have any unintended side-effects but I think the right thing to do is probably to remove the `always_prepare_payloads` disjunct from here:\r\n\r\nhttps://github.com/sigp/lighthouse/blob/a53830fd60a119bf3f659b253360af8027128e83/beacon_node/beacon_chain/src/beacon_chain.rs#L4931-L4932",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1503265893/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
