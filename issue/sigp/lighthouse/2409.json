{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/2409",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/2409/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/2409/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/2409/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/2409",
  "id": 922002859,
  "node_id": "MDU6SXNzdWU5MjIwMDI4NTk=",
  "number": 2409,
  "title": "Add file locking for validator_definitions.yml",
  "user": {
    "login": "michaelsproul",
    "id": 4452260,
    "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/michaelsproul",
    "html_url": "https://github.com/michaelsproul",
    "followers_url": "https://api.github.com/users/michaelsproul/followers",
    "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
    "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
    "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
    "repos_url": "https://api.github.com/users/michaelsproul/repos",
    "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
    "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 985647281,
      "node_id": "MDU6TGFiZWw5ODU2NDcyODE=",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/bug",
      "name": "bug",
      "color": "d73a4a",
      "default": true,
      "description": "Something isn't working"
    },
    {
      "id": 1245875191,
      "node_id": "MDU6TGFiZWwxMjQ1ODc1MTkx",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/val-client",
      "name": "val-client",
      "color": "9cd6fc",
      "default": false,
      "description": "Relates to the validator client binary"
    },
    {
      "id": 2490305065,
      "node_id": "MDU6TGFiZWwyNDkwMzA1MDY1",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/A1",
      "name": "A1",
      "color": "223184",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2021-06-16T01:56:16Z",
  "updated_at": "2021-06-21T00:48:43Z",
  "closed_at": null,
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nIn the quest to improve all of our I/O and make it race-free, one thing remaining is exclusive locking of the `validator_definitions.yml`.\r\n\r\nThe problem is that account manager commands currently cannot tell if the `validator_definitions.yml` is in use by a validator client, which introduces the possibility for data races. As an example:\r\n\r\n1. VC starts, it loads the file and keeps a copy in memory\r\n2. (concurrent with 3) The user creates a new validator via the API. This mutates the in-memory definitions and queues a disk write via `ValidatorDefinitions::save`.\r\n3. (concurrent with 2) The user disables an existing validator using the account manager (per #2386). This has the same effect of mutating the structure in memory and queuing a disk write.\r\n4. One of the writes clobbers the other, because there was no locking and the reads are now stale. It's as if one of (2) or (3) never happened.\r\n\r\nIn practice this is hopefully unlikely to occur very often, as usually human users will not be making concurrent changes using these two mechanisms so close together. Hopefully automated systems will use the API entirely rather than a mixture of API + account manager, although this is definitely a _gotcha_ to watch out for.\r\n\r\n## Solution\r\n\r\nUsing the `common/lockfile` crate from #1958, add a lockfile called `validator_definitions.yml.lock` which must be locked by the VC & account manager in order to open the validator definitions.",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/2409/reactions",
    "total_count": 4,
    "+1": 4,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/2409/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/864645168",
    "html_url": "https://github.com/sigp/lighthouse/issues/2409#issuecomment-864645168",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/2409",
    "id": 864645168,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg2NDY0NTE2OA==",
    "user": {
      "login": "jmcph4",
      "id": 717268,
      "node_id": "MDQ6VXNlcjcxNzI2OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/717268?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jmcph4",
      "html_url": "https://github.com/jmcph4",
      "followers_url": "https://api.github.com/users/jmcph4/followers",
      "following_url": "https://api.github.com/users/jmcph4/following{/other_user}",
      "gists_url": "https://api.github.com/users/jmcph4/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jmcph4/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jmcph4/subscriptions",
      "organizations_url": "https://api.github.com/users/jmcph4/orgs",
      "repos_url": "https://api.github.com/users/jmcph4/repos",
      "events_url": "https://api.github.com/users/jmcph4/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jmcph4/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-06-21T00:48:43Z",
    "updated_at": "2021-06-21T00:48:43Z",
    "author_association": "COLLABORATOR",
    "body": "@michaelsproul Is something like dff6f57 what you had in mind?",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/864645168/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 1,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
