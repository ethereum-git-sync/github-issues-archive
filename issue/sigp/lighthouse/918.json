{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/918",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/918/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/918/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/918/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/918",
  "id": 582675138,
  "node_id": "MDU6SXNzdWU1ODI2NzUxMzg=",
  "number": 918,
  "title": "Validator client race condition leading to missed duties",
  "user": {
    "login": "paulhauner",
    "id": 6660660,
    "node_id": "MDQ6VXNlcjY2NjA2NjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/paulhauner",
    "html_url": "https://github.com/paulhauner",
    "followers_url": "https://api.github.com/users/paulhauner/followers",
    "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
    "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
    "organizations_url": "https://api.github.com/users/paulhauner/orgs",
    "repos_url": "https://api.github.com/users/paulhauner/repos",
    "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
    "received_events_url": "https://api.github.com/users/paulhauner/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 985647281,
      "node_id": "MDU6TGFiZWw5ODU2NDcyODE=",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/bug",
      "name": "bug",
      "color": "d73a4a",
      "default": true,
      "description": "Something isn't working"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "adaszko",
    "id": 165678,
    "node_id": "MDQ6VXNlcjE2NTY3OA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/165678?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/adaszko",
    "html_url": "https://github.com/adaszko",
    "followers_url": "https://api.github.com/users/adaszko/followers",
    "following_url": "https://api.github.com/users/adaszko/following{/other_user}",
    "gists_url": "https://api.github.com/users/adaszko/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/adaszko/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/adaszko/subscriptions",
    "organizations_url": "https://api.github.com/users/adaszko/orgs",
    "repos_url": "https://api.github.com/users/adaszko/repos",
    "events_url": "https://api.github.com/users/adaszko/events{/privacy}",
    "received_events_url": "https://api.github.com/users/adaszko/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "adaszko",
      "id": 165678,
      "node_id": "MDQ6VXNlcjE2NTY3OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/165678?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/adaszko",
      "html_url": "https://github.com/adaszko",
      "followers_url": "https://api.github.com/users/adaszko/followers",
      "following_url": "https://api.github.com/users/adaszko/following{/other_user}",
      "gists_url": "https://api.github.com/users/adaszko/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/adaszko/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/adaszko/subscriptions",
      "organizations_url": "https://api.github.com/users/adaszko/orgs",
      "repos_url": "https://api.github.com/users/adaszko/repos",
      "events_url": "https://api.github.com/users/adaszko/events{/privacy}",
      "received_events_url": "https://api.github.com/users/adaszko/received_events",
      "type": "User",
      "site_admin": false
    },
    {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2020-03-17T00:30:44Z",
  "updated_at": "2020-07-07T04:03:22Z",
  "closed_at": "2020-07-07T04:03:22Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "## Overview\r\n\r\nThere's a race condition in the validator client that can lead to blocks and attestations being missed.\r\n\r\n## Setup\r\n\r\nThe validator client (specifically, the [`DutiesService`](https://github.com/sigp/lighthouse/blob/master/validator_client/src/duties_service.rs)) periodically polls for duties for the current and next epoch (according its slot clock). It stores these duties in its [`DutiesStore`](https://github.com/sigp/lighthouse/blob/c198bddf9e5f21b99756561c55f4bac799245de3/validator_client/src/duties_service.rs#L71-L74) so that the [`BlockService`](https://github.com/sigp/lighthouse/blob/master/validator_client/src/block_service.rs) and [`AttestationService`](https://github.com/sigp/lighthouse/blob/master/validator_client/src/attestation_service.rs) can know when to produce blocks/attestations.\r\n\r\nPreviously, before an eth2 spec update (I forget which one, perhaps v0.10.0) the only reason the validator duties could change was due to a fork. However, since that aforementioned spec update we only have a 1-epoch look-ahead on proposer duties (since [`compute_proposer_index`](https://github.com/sigp/lighthouse/blob/b1d23ec29422f7feb99677970c166addc015afe2/eth2/types/src/beacon_state.rs#L391-L428) relies upon the effective balance for `state.validators`, which can change on any epoch boundary).\r\n\r\nSo, prior to this spec change this race condition existed but it was not obvious or part of routine, best-case operation. After this spec change, this race condition is expected to happen commonly, even without a forking chain.\r\n\r\n## The race condition\r\n\r\nThe validator client periodically polls for duties for the current and next epoch (according its slot clock). If it detects a change in duties, it simply updates its internal data-store and continues on. It does not trigger the `BlockService` or `AttestationService` to try and produce a block/attestation based upon these duties.\r\n\r\nSo, we have the following race condition:\r\n\r\n1. In epoch `E - 1`, we check the duties and see that validator `V` should produce a block at the 2nd slot of epoch `E`.\r\n1. Epoch `E` arrives. \r\n1. The [`BlockService::do_update`](https://github.com/sigp/lighthouse/blob/b1d23ec29422f7feb99677970c166addc015afe2/validator_client/src/block_service.rs#L158) and the [`DutiesService::do_update`](https://github.com/sigp/lighthouse/blob/b1d23ec29422f7feb99677970c166addc015afe2/validator_client/src/duties_service.rs#L367) function are both triggered simultaneously.\r\n1. The `BlockService` completes first, finding that validator `V` does not need to produce till the 2nd slot of epoch `E` (it is the 1st slot now).\r\n1. Then, `DutiesService` completes, finding that the block proposing duty for `V` has moved to the 1st slot of epoch `E`.\r\n\r\nSince the `BlockService` has already completed it's poll for this slot, it ends up producing a block in the 1st slot.\r\n\r\n## Potential solutions\r\n\r\n1. Have the `BlockService` and `AttestationService` multiple times per slot (e.g., 0%, 50%, 80% through the slot).\r\n1. Have the `DutiesService` trigger an update on `BlockService` and `AttestationService` whenever it finds a duties change.\r\n\r\n(1) is simple to implement, however it is inefficient (will check for changes when none have occurred) and it doesn't completely solve the race-condition (it just mitigates).\r\n\r\n(2) is more difficult to implement however it's an efficient and complete solution to the problem. The main obstacle I see is that `BlockService` and `AttestationService` already have a reference to `DutiesService`, so adding references back is circular. We could solve this using a [futures channel](https://docs.rs/futures/0.3.4/futures/channel/mpsc/index.html) for each of the `BlockService` and `AttestationService`, where the `DutiesService` holds a sender and publishes an event to the relevant service when there's a duties update. That being said, throwing channels around the place can get a bit messy, so perhaps there's a tidier solution (e.g., the `DutiesService` holds optional references to the other services which are updated after instantiation).\r\n",
  "closed_by": {
    "login": "michaelsproul",
    "id": 4452260,
    "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/michaelsproul",
    "html_url": "https://github.com/michaelsproul",
    "followers_url": "https://api.github.com/users/michaelsproul/followers",
    "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
    "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
    "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
    "repos_url": "https://api.github.com/users/michaelsproul/repos",
    "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
    "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/918/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/918/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/599818811",
    "html_url": "https://github.com/sigp/lighthouse/issues/918#issuecomment-599818811",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/918",
    "id": 599818811,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU5OTgxODgxMQ==",
    "user": {
      "login": "paulhauner",
      "id": 6660660,
      "node_id": "MDQ6VXNlcjY2NjA2NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/paulhauner",
      "html_url": "https://github.com/paulhauner",
      "followers_url": "https://api.github.com/users/paulhauner/followers",
      "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
      "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
      "organizations_url": "https://api.github.com/users/paulhauner/orgs",
      "repos_url": "https://api.github.com/users/paulhauner/repos",
      "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/paulhauner/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-03-17T00:31:57Z",
    "updated_at": "2020-03-17T00:31:57Z",
    "author_association": "MEMBER",
    "body": "@adaszko I was thinking you might be interested and available for this one?\r\n\r\n@AgeManning I know you've been deep in the validator client with the aggregation strategy changes. Do you think work on this should be stalled or perhaps start on some non-master branch?",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/599818811/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/599926668",
    "html_url": "https://github.com/sigp/lighthouse/issues/918#issuecomment-599926668",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/918",
    "id": 599926668,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU5OTkyNjY2OA==",
    "user": {
      "login": "adaszko",
      "id": 165678,
      "node_id": "MDQ6VXNlcjE2NTY3OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/165678?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/adaszko",
      "html_url": "https://github.com/adaszko",
      "followers_url": "https://api.github.com/users/adaszko/followers",
      "following_url": "https://api.github.com/users/adaszko/following{/other_user}",
      "gists_url": "https://api.github.com/users/adaszko/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/adaszko/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/adaszko/subscriptions",
      "organizations_url": "https://api.github.com/users/adaszko/orgs",
      "repos_url": "https://api.github.com/users/adaszko/repos",
      "events_url": "https://api.github.com/users/adaszko/events{/privacy}",
      "received_events_url": "https://api.github.com/users/adaszko/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-03-17T07:52:15Z",
    "updated_at": "2020-03-17T07:52:27Z",
    "author_association": "CONTRIBUTOR",
    "body": "Sure, I can take a look.  Feel free to assign the issue to me.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/599926668/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/599934447",
    "html_url": "https://github.com/sigp/lighthouse/issues/918#issuecomment-599934447",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/918",
    "id": 599934447,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU5OTkzNDQ0Nw==",
    "user": {
      "login": "paulhauner",
      "id": 6660660,
      "node_id": "MDQ6VXNlcjY2NjA2NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/paulhauner",
      "html_url": "https://github.com/paulhauner",
      "followers_url": "https://api.github.com/users/paulhauner/followers",
      "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
      "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
      "organizations_url": "https://api.github.com/users/paulhauner/orgs",
      "repos_url": "https://api.github.com/users/paulhauner/repos",
      "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/paulhauner/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-03-17T08:12:02Z",
    "updated_at": "2020-03-17T08:12:02Z",
    "author_association": "MEMBER",
    "body": "I believe @AgeManning wanted this to start from a non-master branch. I think he was still in the process of creating it, perhaps check with him directly before you dig into this :)",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/599934447/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/600008931",
    "html_url": "https://github.com/sigp/lighthouse/issues/918#issuecomment-600008931",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/918",
    "id": 600008931,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYwMDAwODkzMQ==",
    "user": {
      "login": "AgeManning",
      "id": 7454587,
      "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AgeManning",
      "html_url": "https://github.com/AgeManning",
      "followers_url": "https://api.github.com/users/AgeManning/followers",
      "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
      "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
      "organizations_url": "https://api.github.com/users/AgeManning/orgs",
      "repos_url": "https://api.github.com/users/AgeManning/repos",
      "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AgeManning/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-03-17T11:02:15Z",
    "updated_at": "2020-03-17T11:02:15Z",
    "author_association": "MEMBER",
    "body": "Hey, sorry for the late reply. I've been fighting with smaller issues to get my branch to a usable state to work off. \r\n\r\nI've made modifications to the validator client and we might get into conflicts if you solve this in master. \r\n\r\nI think everything @paulhauner ul has said here still applies. The current plan is to eventually merge `v0.2.0` branch to master. This branch has the latest source of truth for the validator client. The branch currently has warnings, which I've left for myself to address in the coming days. \r\n\r\nIf possible, it would be great to solve this issue on the `v0.2.0` branch and submit a PR which targets that. ",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/600008931/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/645835723",
    "html_url": "https://github.com/sigp/lighthouse/issues/918#issuecomment-645835723",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/918",
    "id": 645835723,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY0NTgzNTcyMw==",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-06-18T07:30:23Z",
    "updated_at": "2020-06-18T07:30:23Z",
    "author_association": "MEMBER",
    "body": "I'm going to try tackling this as part of https://github.com/sigp/lighthouse/issues/923",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/645835723/reactions",
      "total_count": 3,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 3,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
