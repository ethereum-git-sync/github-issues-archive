{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/4773",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/4773/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/4773/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/4773/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/4773",
  "id": 1908636851,
  "node_id": "I_kwDOCFeAzc5xw3yz",
  "number": 4773,
  "title": "Lighthouse space usage - Increasing dramastically from 87GB to 430GB in 7 days",
  "user": {
    "login": "luarx",
    "id": 22997139,
    "node_id": "MDQ6VXNlcjIyOTk3MTM5",
    "avatar_url": "https://avatars.githubusercontent.com/u/22997139?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/luarx",
    "html_url": "https://github.com/luarx",
    "followers_url": "https://api.github.com/users/luarx/followers",
    "following_url": "https://api.github.com/users/luarx/following{/other_user}",
    "gists_url": "https://api.github.com/users/luarx/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/luarx/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/luarx/subscriptions",
    "organizations_url": "https://api.github.com/users/luarx/orgs",
    "repos_url": "https://api.github.com/users/luarx/repos",
    "events_url": "https://api.github.com/users/luarx/events{/privacy}",
    "received_events_url": "https://api.github.com/users/luarx/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 985647281,
      "node_id": "MDU6TGFiZWw5ODU2NDcyODE=",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/bug",
      "name": "bug",
      "color": "d73a4a",
      "default": true,
      "description": "Something isn't working"
    },
    {
      "id": 2336798682,
      "node_id": "MDU6TGFiZWwyMzM2Nzk4Njgy",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/database",
      "name": "database",
      "color": "C01C9D",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 11,
  "created_at": "2023-09-22T10:24:22Z",
  "updated_at": "2023-09-29T03:16:03Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nWe are running several Lighthouse clients and I have noticed that in 10% of them there are some ocassions were the volume usage is increased 5x in 7 days!\r\n\r\nMy temporal solution is about deleting the volume date and resync, after that the Lighthouse client is stable again. But some weeks later a different Lighthouse client repeats this weird behaviour...\r\n\r\n![image](https://github.com/sigp/lighthouse/assets/22997139/6f3e2156-8498-44f1-a1ec-c67f563ce2b3)\r\n\r\n\r\n## Version\r\nLighthouse v4.1.0 (docker image)\r\n\r\n## Present Behaviour\r\nThe volume usage increases 5x in 7 days\r\n\r\nParams:\r\n```\r\n          args: [\r\n              \"--debug-level=info\",\r\n              \"--datadir=/beacondata\",\r\n              \"--network=mainnet\",\r\n              \"beacon_node\",\r\n              \"--disable-enr-auto-update\",\r\n              \"--enr-address=127.0.0.1\",\r\n              \"--enr-tcp-port=9000\",\r\n              \"--enr-udp-port=9000\",\r\n              \"--port=9000\" ,\r\n              \"--discovery-port=9000\",\r\n              \"--eth1\",\r\n              \"--http\",\r\n              \"--http-address=0.0.0.0\",\r\n              \"--http-port=5052\",\r\n              \"--metrics\",\r\n              \"--metrics-address=0.0.0.0\",\r\n              \"--metrics-port=5054\",\r\n              \"--listen-address=0.0.0.0\",\r\n              \"--target-peers=100\",\r\n              \"--http-allow-sync-stalled\",\r\n              \"--disable-packet-filter\",\r\n              \"--execution-endpoint=http://localhost:9545\",\r\n              \"--jwt-secrets=/tmp/jwtsecret\",\r\n              \"--disable-deposit-contract-sync\",\r\n              \"--checkpoint-sync-url=https://beaconstate-mainnet.chainsafe.io\"\r\n              ]\r\n```\r\n\r\n## Expected Behaviour\r\nDo not increment so heavy the volume usage in a few days, at least some stable values\r\n\r\n## Steps to resolve\r\nDo not increment so heavy the volume usage in a few days\r\n\r\n\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/4773/reactions",
    "total_count": 2,
    "+1": 2,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/4773/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1731184696",
    "html_url": "https://github.com/sigp/lighthouse/issues/4773#issuecomment-1731184696",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4773",
    "id": 1731184696,
    "node_id": "IC_kwDOCFeAzc5nL8g4",
    "user": {
      "login": "luarx",
      "id": 22997139,
      "node_id": "MDQ6VXNlcjIyOTk3MTM5",
      "avatar_url": "https://avatars.githubusercontent.com/u/22997139?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/luarx",
      "html_url": "https://github.com/luarx",
      "followers_url": "https://api.github.com/users/luarx/followers",
      "following_url": "https://api.github.com/users/luarx/following{/other_user}",
      "gists_url": "https://api.github.com/users/luarx/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/luarx/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/luarx/subscriptions",
      "organizations_url": "https://api.github.com/users/luarx/orgs",
      "repos_url": "https://api.github.com/users/luarx/repos",
      "events_url": "https://api.github.com/users/luarx/events{/privacy}",
      "received_events_url": "https://api.github.com/users/luarx/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-09-22T10:27:01Z",
    "updated_at": "2023-09-22T10:27:01Z",
    "author_association": "NONE",
    "body": "Another screenshot of a different Ligthouse client that is using the same version and same params.\r\nLook how the space was stable again after deleting the volume data and resyncing\r\n\r\n![image](https://github.com/sigp/lighthouse/assets/22997139/07a3d818-0271-4a09-a8bd-c4e5fe51e647)\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1731184696/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1731407424",
    "html_url": "https://github.com/sigp/lighthouse/issues/4773#issuecomment-1731407424",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4773",
    "id": 1731407424,
    "node_id": "IC_kwDOCFeAzc5nMy5A",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-09-22T13:20:25Z",
    "updated_at": "2023-09-22T13:23:00Z",
    "author_association": "MEMBER",
    "body": "If you still have any oversized nodes (or if it happens again) you can try:\n\nRunning `du -sh freezer_db chain_db` in the `$datadir/beacon`. I suspect it's the chain_db that's bloated.\n\nIf it is, you can try running `lighthouse db inspect --column ste --data /your/datadir` to see if the beacon state storage is the culprit (I suspect it is).\n\nWe haven't identified the bug that causes this, but have had a few reports of it. The database schema is getting completely overhauled in a few versions time, with a new system that prunes states more aggressively and so far has not shown any signs of blowing up in the same way (see the tree states releases if you're curious).\n\nStill, if we find the bug in the current DB it would be nice to fix it. Debug logs from an affected node would be helpful (DM me on Discord `@sproul`, or email me: michael at sigmaprime dot io)",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1731407424/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1731503130",
    "html_url": "https://github.com/sigp/lighthouse/issues/4773#issuecomment-1731503130",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4773",
    "id": 1731503130,
    "node_id": "IC_kwDOCFeAzc5nNKQa",
    "user": {
      "login": "luarx",
      "id": 22997139,
      "node_id": "MDQ6VXNlcjIyOTk3MTM5",
      "avatar_url": "https://avatars.githubusercontent.com/u/22997139?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/luarx",
      "html_url": "https://github.com/luarx",
      "followers_url": "https://api.github.com/users/luarx/followers",
      "following_url": "https://api.github.com/users/luarx/following{/other_user}",
      "gists_url": "https://api.github.com/users/luarx/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/luarx/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/luarx/subscriptions",
      "organizations_url": "https://api.github.com/users/luarx/orgs",
      "repos_url": "https://api.github.com/users/luarx/repos",
      "events_url": "https://api.github.com/users/luarx/events{/privacy}",
      "received_events_url": "https://api.github.com/users/luarx/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-09-22T14:17:36Z",
    "updated_at": "2023-09-22T14:21:34Z",
    "author_association": "NONE",
    "body": "Sure! I still have that node oversized to help to debug this issue\r\n\r\nHere you are the results that you have asked for:\r\n```\r\ndu -sh freezer_db chain_db\r\n5.3G\tfreezer_db\r\n432G\tchain_db\r\n```\r\n\r\nI do not know if I am executing correctly this second one:\r\n```\r\nlighthouse db inspect --column ste --datadir beacondata/\r\nSep 22 14:08:26.602 INFO Running database manager for mainnet network\r\nFatal error: DBError { message: \"Error { message: \\\"IO error: lock beacondata/beacon/freezer_db/LOCK: Resource temporarily unavailable\\\" }\" }\r\n```\r\n\r\nPerfect, I will contact you in Discord",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1731503130/reactions",
      "total_count": 2,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 1,
      "rocket": 1,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1732189936",
    "html_url": "https://github.com/sigp/lighthouse/issues/4773#issuecomment-1732189936",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4773",
    "id": 1732189936,
    "node_id": "IC_kwDOCFeAzc5nPx7w",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-09-23T02:48:49Z",
    "updated_at": "2023-09-23T02:48:49Z",
    "author_association": "MEMBER",
    "body": "Looks like you've got the command right but need to just stop the BN while you run it. It will produce quite a lot of output so you might also want to pipe it to a file\n\nI'm afk from Discord for the weekend but will get in touch Monday :)",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1732189936/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 1,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1733403550",
    "html_url": "https://github.com/sigp/lighthouse/issues/4773#issuecomment-1733403550",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4773",
    "id": 1733403550,
    "node_id": "IC_kwDOCFeAzc5nUaOe",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-09-25T10:35:49Z",
    "updated_at": "2023-09-25T10:35:49Z",
    "author_association": "MEMBER",
    "body": "Thanks, I can see what the issue is now:\r\n\r\n- Your node stopped being able to delete finalized states from the database due to an error:\r\n\r\n> WARN Block pruning failed                    error: BeaconStateError(MissingBeaconBlock(SignedBeaconBlockHash(0x69eaa1973c1e57ae88d4d85d46c4a7e30684f0318cb3b3411a1339597aadbecf))), service: beacon\r\n- Due to Lighthouse's current database schema, these states consume a lot of disk space (around 30GB/day).\r\n\r\nThe tree states release I mentioned should alleviate the latter point, because it results in vastly less data being stored on disk. However, it would be good to understand _why_ the database is erroring, as I haven't seen this error before. Strangely the block that's missing from your DB isn't one that I can find: it's not part of the canonical chain and it wasn't seen by the couple of nodes I spot-checked (I'll check more thoroughly tomorrow).\r\n\r\nIt would be great if you could provide logs from around the time the database starting growing, as this might lead us to the mystery block and the root cause. For the best chance of success it would be great to have _debug_ level logs, which should have been written by default to your datadir at `/beacondata/beacon/logs/`. If you could find the file that has Sept 15 (or whenever the issue started on this node) and DM that to me compressed, that would be great.\r\n\r\nThanks!",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1733403550/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1733469590",
    "html_url": "https://github.com/sigp/lighthouse/issues/4773#issuecomment-1733469590",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4773",
    "id": 1733469590,
    "node_id": "IC_kwDOCFeAzc5nUqWW",
    "user": {
      "login": "luarx",
      "id": 22997139,
      "node_id": "MDQ6VXNlcjIyOTk3MTM5",
      "avatar_url": "https://avatars.githubusercontent.com/u/22997139?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/luarx",
      "html_url": "https://github.com/luarx",
      "followers_url": "https://api.github.com/users/luarx/followers",
      "following_url": "https://api.github.com/users/luarx/following{/other_user}",
      "gists_url": "https://api.github.com/users/luarx/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/luarx/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/luarx/subscriptions",
      "organizations_url": "https://api.github.com/users/luarx/orgs",
      "repos_url": "https://api.github.com/users/luarx/repos",
      "events_url": "https://api.github.com/users/luarx/events{/privacy}",
      "received_events_url": "https://api.github.com/users/luarx/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-09-25T11:21:29Z",
    "updated_at": "2023-09-25T11:21:29Z",
    "author_association": "NONE",
    "body": "Good to know that! Thanks!\r\n\r\nUnfortunately, I have only logs from September 20th because of the internal log rotation I would say...\r\nLet me know if I can provide you some other info",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1733469590/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1733484534",
    "html_url": "https://github.com/sigp/lighthouse/issues/4773#issuecomment-1733484534",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4773",
    "id": 1733484534,
    "node_id": "IC_kwDOCFeAzc5nUt_2",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-09-25T11:32:11Z",
    "updated_at": "2023-09-25T11:32:11Z",
    "author_association": "MEMBER",
    "body": "Any info logs from earlier that might have been retained by Docker or the OS?",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1733484534/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1733535927",
    "html_url": "https://github.com/sigp/lighthouse/issues/4773#issuecomment-1733535927",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4773",
    "id": 1733535927,
    "node_id": "IC_kwDOCFeAzc5nU6i3",
    "user": {
      "login": "luarx",
      "id": 22997139,
      "node_id": "MDQ6VXNlcjIyOTk3MTM5",
      "avatar_url": "https://avatars.githubusercontent.com/u/22997139?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/luarx",
      "html_url": "https://github.com/luarx",
      "followers_url": "https://api.github.com/users/luarx/followers",
      "following_url": "https://api.github.com/users/luarx/following{/other_user}",
      "gists_url": "https://api.github.com/users/luarx/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/luarx/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/luarx/subscriptions",
      "organizations_url": "https://api.github.com/users/luarx/orgs",
      "repos_url": "https://api.github.com/users/luarx/repos",
      "events_url": "https://api.github.com/users/luarx/events{/privacy}",
      "received_events_url": "https://api.github.com/users/luarx/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-09-25T12:03:16Z",
    "updated_at": "2023-09-25T12:03:16Z",
    "author_association": "NONE",
    "body": "I have checked and it is not possible neither, they have been rotated :(",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1733535927/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1733582012",
    "html_url": "https://github.com/sigp/lighthouse/issues/4773#issuecomment-1733582012",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4773",
    "id": 1733582012,
    "node_id": "IC_kwDOCFeAzc5nVFy8",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-09-25T12:15:01Z",
    "updated_at": "2023-09-25T12:15:01Z",
    "author_association": "MEMBER",
    "body": "That's ok, thanks for your efforts! I'll see if I can dig up that block from somewhere and see if it provides a clue about what went wrong ",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1733582012/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1738800329",
    "html_url": "https://github.com/sigp/lighthouse/issues/4773#issuecomment-1738800329",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4773",
    "id": 1738800329,
    "node_id": "IC_kwDOCFeAzc5no_zJ",
    "user": {
      "login": "luarx",
      "id": 22997139,
      "node_id": "MDQ6VXNlcjIyOTk3MTM5",
      "avatar_url": "https://avatars.githubusercontent.com/u/22997139?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/luarx",
      "html_url": "https://github.com/luarx",
      "followers_url": "https://api.github.com/users/luarx/followers",
      "following_url": "https://api.github.com/users/luarx/following{/other_user}",
      "gists_url": "https://api.github.com/users/luarx/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/luarx/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/luarx/subscriptions",
      "organizations_url": "https://api.github.com/users/luarx/orgs",
      "repos_url": "https://api.github.com/users/luarx/repos",
      "events_url": "https://api.github.com/users/luarx/events{/privacy}",
      "received_events_url": "https://api.github.com/users/luarx/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-09-28T09:28:14Z",
    "updated_at": "2023-09-28T09:28:14Z",
    "author_association": "NONE",
    "body": "In case that the same issue is present in some of my Lighthouse nodes, I will copy those logs before they are rotated @michaelsproul ",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1738800329/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1740253695",
    "html_url": "https://github.com/sigp/lighthouse/issues/4773#issuecomment-1740253695",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4773",
    "id": 1740253695,
    "node_id": "IC_kwDOCFeAzc5nuin_",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-09-29T03:16:03Z",
    "updated_at": "2023-09-29T03:16:03Z",
    "author_association": "MEMBER",
    "body": "Hey @luarx I did some investigating and found a few interesting things:\r\n\r\n- That block which was missing from your node (`0x69eaa1973c1e57ae88d4d85d46c4a7e30684f0318cb3b3411a1339597aadbecf`) was published at slot 7323584 building on a parent from 12 slots prior (!) at `7323572`. The block graffiti was `Avado` and the proposer was 781777. The parent block has root `0xe6ae158ddfd054042b135fdf3691cc5b60f6b4bd2f01308911f77e72d2466ad3` which is the [canonical block from that slot](https://beaconcha.in/slot/7323572).\r\n- The block was probably published by a Lighthouse validator (according to blockprint). This isn't a bad thing per se, as Lighthouse will publish blocks even when it's slightly out of sync in order to keep the network live. It can't always tell whether there are legitimately no blocks, or it's just out of sync.\r\n\r\nAnyway, the details of the block's publishing probably aren't too important, because the issue is how it was processed by your node.\r\n\r\nTo get that error, the database pruning process must have hit the `Ok(None)` branch here:\r\n\r\nhttps://github.com/sigp/lighthouse/blob/441fc1691b69f9edc4bbdc6665f3efab16265c9b/beacon_node/beacon_chain/src/migrate.rs#L487-L496\r\n\r\nThe pruning is trying to fetch a block which exists in the `head_tracker` from disk, which _should_ always succeed if the `head_tracker` is in sync with what's on disk. The question then becomes:\r\n\r\n> How did we end up with a block in the `head_tracker` which isn't stored on disk?\r\n\r\nThere are only _two places_ where we add a block to the head tracker. The main one is here, after importing the block:\r\n\r\nhttps://github.com/sigp/lighthouse/blob/441fc1691b69f9edc4bbdc6665f3efab16265c9b/beacon_node/beacon_chain/src/beacon_chain.rs#L3105-L3106\r\n\r\nNotably this happens _after_ the block is written to disk, here:\r\n\r\nhttps://github.com/sigp/lighthouse/blob/441fc1691b69f9edc4bbdc6665f3efab16265c9b/beacon_node/beacon_chain/src/beacon_chain.rs#L3024-L3028\r\n\r\nSo on this code path it seems like it would be impossible to end up in a situation where the block is in the head tracker, but _not_ written to disk. Even if the node crashed or was SIGKILLed in between those two calls, the result would be that the block was on disk and _not_ in the head tracker.\r\n\r\nSo where's the other place we call `register_block`? Here, on node startup when reverting a missed hard fork:\r\n\r\nhttps://github.com/sigp/lighthouse/blob/441fc1691b69f9edc4bbdc6665f3efab16265c9b/beacon_node/beacon_chain/src/builder.rs#L680-L697\r\n\r\nI doubt that your node could have hit this, because it hadn't missed the most recent fork (Capella, which happened back in April). It _could_ have tried to run that revert _if_ the head block was corrupt on disk, but even if it did, it wouldn't have selected 7323584 because of the condition here:\r\n\r\nhttps://github.com/sigp/lighthouse/blob/441fc1691b69f9edc4bbdc6665f3efab16265c9b/beacon_node/beacon_chain/src/fork_revert.rs#L57-L58\r\n\r\nSo, in terms of entries being _added_ to the head tracker without the block existing on disk, I think we're in the clear.\r\n\r\nThe other option is that a block was _deleted from disk_, but _not deleted_ from the `head_tracker`. There's only one place where we delete from the head tracker, so lets look for a race there:\r\n\r\nhttps://github.com/sigp/lighthouse/blob/441fc1691b69f9edc4bbdc6665f3efab16265c9b/beacon_node/beacon_chain/src/migrate.rs#L629-L631\r\n\r\nThose head tracker deletions get added to an atomic I/O batch here, together with the block deletions:\r\n\r\nhttps://github.com/sigp/lighthouse/blob/441fc1691b69f9edc4bbdc6665f3efab16265c9b/beacon_node/beacon_chain/src/migrate.rs#L651-L659\r\n \r\nIf LevelDB (and the filesystem) uphold their ACID guarantees, then this batch should happen atomically: either the blocks & head tracker entries are both deleted, or neither are. Even though we release the lock on the head tracker early (`drop(head_tracker)`), the worst that can happen is that another thread writes the updated tracker to disk _before_ the blocks are deleted, leading to the block _not_ appearing in the head tracker while still existing on disk (this is safe, we're looking for the opposite: block in head tracker but _not_ on disk).\r\n\r\nThe other possibility is that blocks are deleted elsewhere, but this is not the case. The only usage of `StoreOp::DeleteBlock` is in the migrator/pruner, and the `delete_block` function is not used outside of tests.\r\n\r\nTherefore, I'm a bit stumped. For the bug to occur, one of the assumptions I've made must have been violated, e.g.\r\n\r\n- LevelDB is not able to do atomic I/O on your disk due to a filesystem issue. I think this is possible if you're using an NFS drive, as NFS drives don't generally provide strong atomicity guarantees. It does look like you're using _Docker_ and/or Kubernetes, so it would be interesting to know if you're using an NFS mount for the datadir.\r\n- LevelDB isn't able to do atomic I/O properly due to us not calling `fsync`. We call `fsync` every so often, but not after every write batch. My understanding on LevelDB's guarantees is that it should still uphold atomicity of batches in this case, but I could be wrong. I think the NFS explanation is more likely.\r\n- The hardware (e.g RAM/disk) is faulty (probably not, as you've seen it on multiple machines).\r\n\r\nEven if we don't understand exactly how it happened, we could still try to mitigate the impact of this occurring by making the pruning process ignore this kind of error. We could simply log a warning whenever this is detected, rather than stalling pruning indefinitely (which is what leads to the database growth). The outcome would be a _little bit_ of database bloat, due to states/blocks that weren't fully cleaned up, but I think it would be better than the alternative. I think this is probably a good harm-minimisation approach, particularly if we discover that this is quite likely on NFS.\r\n\r\nLong-term we could also mitigate it by:\r\n\r\n- Being more aggressive with calling `fsync` (if the fsync hunch turns out to be correct)\r\n- Using a different backend from LevelDB to see if suffers the same issues (this is in-progress here: <https://github.com/sigp/lighthouse/pull/4718>).\r\n\r\n---\r\n\r\nTL;DR: I haven't been able to find an obvious Lighthouse bug, and suspect foul play from the filesystem, possibly NFS.\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1740253695/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
