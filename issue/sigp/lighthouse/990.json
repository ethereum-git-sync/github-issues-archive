{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/990",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/990/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/990/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/990/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/990",
  "id": 596249458,
  "node_id": "MDU6SXNzdWU1OTYyNDk0NTg=",
  "number": 990,
  "title": "RPC Peer Reputation Types/Handling",
  "user": {
    "login": "AgeManning",
    "id": 7454587,
    "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/AgeManning",
    "html_url": "https://github.com/AgeManning",
    "followers_url": "https://api.github.com/users/AgeManning/followers",
    "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
    "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
    "organizations_url": "https://api.github.com/users/AgeManning/orgs",
    "repos_url": "https://api.github.com/users/AgeManning/repos",
    "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
    "received_events_url": "https://api.github.com/users/AgeManning/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 985647284,
      "node_id": "MDU6TGFiZWw5ODU2NDcyODQ=",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/enhancement",
      "name": "enhancement",
      "color": "a2eeef",
      "default": true,
      "description": "New feature or request"
    },
    {
      "id": 2336800125,
      "node_id": "MDU6TGFiZWwyMzM2ODAwMTI1",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/t%20Networking",
      "name": "t Networking",
      "color": "40E0D0",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "divagant-martian",
    "id": 26765164,
    "node_id": "MDQ6VXNlcjI2NzY1MTY0",
    "avatar_url": "https://avatars.githubusercontent.com/u/26765164?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/divagant-martian",
    "html_url": "https://github.com/divagant-martian",
    "followers_url": "https://api.github.com/users/divagant-martian/followers",
    "following_url": "https://api.github.com/users/divagant-martian/following{/other_user}",
    "gists_url": "https://api.github.com/users/divagant-martian/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/divagant-martian/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/divagant-martian/subscriptions",
    "organizations_url": "https://api.github.com/users/divagant-martian/orgs",
    "repos_url": "https://api.github.com/users/divagant-martian/repos",
    "events_url": "https://api.github.com/users/divagant-martian/events{/privacy}",
    "received_events_url": "https://api.github.com/users/divagant-martian/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "divagant-martian",
      "id": 26765164,
      "node_id": "MDQ6VXNlcjI2NzY1MTY0",
      "avatar_url": "https://avatars.githubusercontent.com/u/26765164?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/divagant-martian",
      "html_url": "https://github.com/divagant-martian",
      "followers_url": "https://api.github.com/users/divagant-martian/followers",
      "following_url": "https://api.github.com/users/divagant-martian/following{/other_user}",
      "gists_url": "https://api.github.com/users/divagant-martian/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/divagant-martian/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/divagant-martian/subscriptions",
      "organizations_url": "https://api.github.com/users/divagant-martian/orgs",
      "repos_url": "https://api.github.com/users/divagant-martian/repos",
      "events_url": "https://api.github.com/users/divagant-martian/events{/privacy}",
      "received_events_url": "https://api.github.com/users/divagant-martian/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2020-04-08T01:37:42Z",
  "updated_at": "2022-10-20T17:09:24Z",
  "closed_at": "2020-05-06T01:51:55Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nA variety of Errors can occur in the RPC protocol. They can have a variety of weights when it comes to adjusting the reputation of a peer. This issue, is to more clearly define (likely via enums) specific types of RPC errors, send them to the peer manager and adjust a peer's score based on their type. \r\n\r\nSome things we need to consider:\r\n- A peer should always respond to a PING (it's lightweight and we prioritise it, regardless of processing). We should send/receive these every 30 seconds. If a peer doesn't respond, it should be heavily weighted down (perhaps 2 consecutive pings should disconnect a very reputable peer). It's likely that if a peer is genuinely offline, other rpc methods will be failing and the reputation will be dropping quite fast also. \r\n- A peer that times-out when trying to negotiate a protocol could mean the peer is offline, or overworked (`clogged`). We should be somewhat lenient with over-worked peers, although we should lower their reputation which will make lighthouse favour them less and request less data. \r\n- A peer that doesn't support a specific RPC protocol - For now I think we do not downvote a peer, but maybe built it so that we can prioritise specific methods. For example, a peer that doesn't support PING we drop, but we tolerate a peer that doesn't support blocks_by_root. For this case, just build the ability to distinguish, but don't actually modify the reputation. \r\n- A peer that sends invalid/corrupt data - Should lose reputation. We should punish them pretty heavily. Potentially even disconnect instantly. \r\n\r\nParts of the code relevant to update this logic. \r\n\r\nFor the RPC, when an error occurs, we collect it here: \r\nhttps://github.com/sigp/lighthouse/blob/v0.2.0/beacon_node/eth2-libp2p/src/rpc/handler.rs#L436\r\n\r\nThis will need to be modified, as I'm currently only keeping track of the request_id, where we will need to know the actual request also (for its type, to determine what type of RPC the error occurred for). \r\n\r\nThe errors then get processed here: \r\nhttps://github.com/sigp/lighthouse/blob/v0.2.0/beacon_node/eth2-libp2p/src/rpc/handler.rs#L451\r\nNote that this returns an RPCError (which can be captured by the peer manager as it passes up to the network crate, i'll explain below). \r\n\r\nSo if an peer times-out we could identify the request type and return a more specific RPCError:\r\nhttps://github.com/sigp/lighthouse/blob/v0.2.0/beacon_node/eth2-libp2p/src/rpc/handler.rs#L470\r\nFor example, `RPCError::PingTimeout`\r\n\r\nA decoding error should get propagated from the underlying codecs (i.e some of the other RPCError varints will automagically get sent when they occur)\r\n\r\nThe `RPCError` struct to add variants to is here:\r\nhttps://github.com/sigp/lighthouse/blob/v0.2.0/beacon_node/eth2-libp2p/src/rpc/protocol.rs#L302\r\n\r\nOnce we've added sufficient RPCError variants to match with the reputation logic we want, we can capture these in the behaviour and feed them to the peer manager to adjust the reputation, similar to how the Ping and Metadata RPC methods work:\r\nhttps://github.com/sigp/lighthouse/blob/v0.2.0/beacon_node/eth2-libp2p/src/behaviour.rs#L399\r\n\r\nNote that we still want to add the events to the behaviour event list as these will be propagated to other parts of lighthouse to inform various sections an error occured. We just want to also inform the peer manager here about these errors. \r\n\r\nLet me know if further information is required.",
  "closed_by": {
    "login": "AgeManning",
    "id": 7454587,
    "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/AgeManning",
    "html_url": "https://github.com/AgeManning",
    "followers_url": "https://api.github.com/users/AgeManning/followers",
    "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
    "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
    "organizations_url": "https://api.github.com/users/AgeManning/orgs",
    "repos_url": "https://api.github.com/users/AgeManning/repos",
    "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
    "received_events_url": "https://api.github.com/users/AgeManning/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/990/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/990/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/612295650",
    "html_url": "https://github.com/sigp/lighthouse/issues/990#issuecomment-612295650",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/990",
    "id": 612295650,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYxMjI5NTY1MA==",
    "user": {
      "login": "divagant-martian",
      "id": 26765164,
      "node_id": "MDQ6VXNlcjI2NzY1MTY0",
      "avatar_url": "https://avatars.githubusercontent.com/u/26765164?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/divagant-martian",
      "html_url": "https://github.com/divagant-martian",
      "followers_url": "https://api.github.com/users/divagant-martian/followers",
      "following_url": "https://api.github.com/users/divagant-martian/following{/other_user}",
      "gists_url": "https://api.github.com/users/divagant-martian/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/divagant-martian/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/divagant-martian/subscriptions",
      "organizations_url": "https://api.github.com/users/divagant-martian/orgs",
      "repos_url": "https://api.github.com/users/divagant-martian/repos",
      "events_url": "https://api.github.com/users/divagant-martian/events{/privacy}",
      "received_events_url": "https://api.github.com/users/divagant-martian/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-04-11T01:55:33Z",
    "updated_at": "2020-04-11T01:55:33Z",
    "author_association": "COLLABORATOR",
    "body": "I'll take this one",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/612295650/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/624130886",
    "html_url": "https://github.com/sigp/lighthouse/issues/990#issuecomment-624130886",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/990",
    "id": 624130886,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyNDEzMDg4Ng==",
    "user": {
      "login": "divagant-martian",
      "id": 26765164,
      "node_id": "MDQ6VXNlcjI2NzY1MTY0",
      "avatar_url": "https://avatars.githubusercontent.com/u/26765164?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/divagant-martian",
      "html_url": "https://github.com/divagant-martian",
      "followers_url": "https://api.github.com/users/divagant-martian/followers",
      "following_url": "https://api.github.com/users/divagant-martian/following{/other_user}",
      "gists_url": "https://api.github.com/users/divagant-martian/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/divagant-martian/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/divagant-martian/subscriptions",
      "organizations_url": "https://api.github.com/users/divagant-martian/orgs",
      "repos_url": "https://api.github.com/users/divagant-martian/repos",
      "events_url": "https://api.github.com/users/divagant-martian/events{/privacy}",
      "received_events_url": "https://api.github.com/users/divagant-martian/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-05T15:39:08Z",
    "updated_at": "2020-05-05T15:39:08Z",
    "author_association": "COLLABORATOR",
    "body": "@AgeManning should we consider this one closed?",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/624130886/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/624402375",
    "html_url": "https://github.com/sigp/lighthouse/issues/990#issuecomment-624402375",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/990",
    "id": 624402375,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyNDQwMjM3NQ==",
    "user": {
      "login": "AgeManning",
      "id": 7454587,
      "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AgeManning",
      "html_url": "https://github.com/AgeManning",
      "followers_url": "https://api.github.com/users/AgeManning/followers",
      "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
      "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
      "organizations_url": "https://api.github.com/users/AgeManning/orgs",
      "repos_url": "https://api.github.com/users/AgeManning/repos",
      "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AgeManning/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-06T01:51:55Z",
    "updated_at": "2020-05-06T01:51:55Z",
    "author_association": "MEMBER",
    "body": "Oh yeah. Resolved by @divagant-martian in #1047 ",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/624402375/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
