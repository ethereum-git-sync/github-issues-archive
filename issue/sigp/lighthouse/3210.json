{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/3210",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/3210/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/3210/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/3210/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/3210",
  "id": 1245851847,
  "node_id": "I_kwDOCFeAzc5KQjDH",
  "number": 3210,
  "title": "Remove alignment limitations from checkpoint sync",
  "user": {
    "login": "michaelsproul",
    "id": 4452260,
    "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/michaelsproul",
    "html_url": "https://github.com/michaelsproul",
    "followers_url": "https://api.github.com/users/michaelsproul/followers",
    "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
    "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
    "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
    "repos_url": "https://api.github.com/users/michaelsproul/repos",
    "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
    "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 985647284,
      "node_id": "MDU6TGFiZWw5ODU2NDcyODQ=",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/enhancement",
      "name": "enhancement",
      "color": "a2eeef",
      "default": true,
      "description": "New feature or request"
    },
    {
      "id": 2336798682,
      "node_id": "MDU6TGFiZWwyMzM2Nzk4Njgy",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/database",
      "name": "database",
      "color": "C01C9D",
      "default": false,
      "description": ""
    },
    {
      "id": 5636045869,
      "node_id": "LA_kwDOCFeAzc8AAAABT-88LQ",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/tree-states",
      "name": "tree-states",
      "color": "91FCA5",
      "default": false,
      "description": "Upcoming state and database overhaul"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": {
    "login": "michaelsproul",
    "id": 4452260,
    "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/michaelsproul",
    "html_url": "https://github.com/michaelsproul",
    "followers_url": "https://api.github.com/users/michaelsproul/followers",
    "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
    "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
    "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
    "repos_url": "https://api.github.com/users/michaelsproul/repos",
    "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
    "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2022-05-24T01:07:45Z",
  "updated_at": "2023-07-07T23:18:13Z",
  "closed_at": null,
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nCurrently Lighthouse's checkpoint sync requires that the checkpoint state is not from a skipped slot, see: https://lighthouse-book.sigmaprime.io/checkpoint-sync.html#alignment-requirements\r\n\r\nThis limitation is somewhat artificial, and was taken in order to simplify the initial implementation. I've forgotten exactly _why_ but I'll post more info on this issue when I dive back into it again.",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/3210/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/3210/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1193691296",
    "html_url": "https://github.com/sigp/lighthouse/issues/3210#issuecomment-1193691296",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3210",
    "id": 1193691296,
    "node_id": "IC_kwDOCFeAzc5HJkig",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-25T07:37:32Z",
    "updated_at": "2022-07-25T07:37:32Z",
    "author_association": "MEMBER",
    "body": "Another desirable property: checkpoint sync from a state alone, without having to load the block.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1193691296/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1244751069",
    "html_url": "https://github.com/sigp/lighthouse/issues/3210#issuecomment-1244751069",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3210",
    "id": 1244751069,
    "node_id": "IC_kwDOCFeAzc5KMWTd",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-13T00:43:15Z",
    "updated_at": "2022-09-13T00:43:15Z",
    "author_association": "MEMBER",
    "body": "I think the simplest way to solve this would be to advance the provided state to the nearest epoch boundary, although I might wait for the discussion [here](https://github.com/ethereum/beacon-APIs/pull/226#issuecomment-1244747806) to be resolved until implementing that change.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1244751069/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1588303226",
    "html_url": "https://github.com/sigp/lighthouse/issues/3210#issuecomment-1588303226",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3210",
    "id": 1588303226,
    "node_id": "IC_kwDOCFeAzc5eq5V6",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-06-13T00:41:06Z",
    "updated_at": "2023-06-13T00:41:06Z",
    "author_association": "MEMBER",
    "body": "Regarding the use of unaligned states, I went looking for some places where we look up states for block roots, which might fail if the only state stored is the _advanced_ version of the state (e.g. block was at slot 30 and we've stored its state skipped through to 32).\r\n\r\n1. The main place where this is relevant is in the on-finalization database migration here:\r\n\r\nhttps://github.com/sigp/lighthouse/blob/c547a11b0da48db6fdd03bca2c6ce2448bbcc3a9/beacon_node/beacon_chain/src/canonical_head.rs#L1019-L1041\r\n\r\nThat code takes care to use the advanced form of the finalized block's state, which is exactly what we want.\r\n\r\n2. This usage in the committee cache lookup could be problematic if the fork choice node stores the unadvanced state root:\r\n\r\nhttps://github.com/sigp/lighthouse/blob/c547a11b0da48db6fdd03bca2c6ce2448bbcc3a9/beacon_node/beacon_chain/src/beacon_chain.rs#L5551-L5559\r\n\r\n3. In fork choice itself where we load the balances from the justified state could also be an issue. When we checkpoint sync we artificially set the justified and finalized blocks equal to each other, so this could result in a lookup of the finalized block's state:\r\n\r\nhttps://github.com/sigp/lighthouse/blob/c547a11b0da48db6fdd03bca2c6ce2448bbcc3a9/beacon_node/beacon_chain/src/beacon_fork_choice_store.rs#L324-L328\r\n\r\n4. We load the state for the parent block's state root in block verification:\r\n\r\nhttps://github.com/sigp/lighthouse/blob/c547a11b0da48db6fdd03bca2c6ce2448bbcc3a9/beacon_node/beacon_chain/src/block_verification.rs#L1771-L1778\r\n\r\nThis would cause blocks that are descended from the finalized block (with skips) to error incorrectly. We should definitely fix this.\r\n\r\n5. We load the state for the head block's state root on start-up:\r\n\r\nhttps://github.com/sigp/lighthouse/blob/c547a11b0da48db6fdd03bca2c6ce2448bbcc3a9/beacon_node/beacon_chain/src/canonical_head.rs#L298-L304\r\n\r\nThis could error if the finalized block _is_ the head (e.g. restarting immediately after checkpoint sync).\r\n\r\n---\r\n\r\nThere are probably other places too.\r\n\r\nSome ideas for fixes:\r\n\r\nA. Handle each case independently using bespoke logic. E.g. for fork choice we could make sure the `state_root` stored in the nodes is the advanced state's state root (when initialising from a checkpoint). This _might_ work, but might also break other things.\r\nB. Store the unaligned state in the database, and keep track of this. @paulhauner suggested a separate column, but I think the `BeaconState` column would be fine (using `store_full_state`). We'd just need to keep track of the state root for this unaligned finalized state in the store, and have a special case for loading the unaligned state when `get_state` requests a state root that matches.\r\nC. Alternatively we could do a variant of B where we don't actually store the unaligned state, but we do store its state root and redirect requests for this state root to the aligned/advanced state. I think this is strictly worse, aside from the disk usage, as it breaks a pretty fundamental property of `get_state`.\r\n\r\nSo far I'm in favour of B, with no new column, and a DB schema migration to add the `unaligned_finalized_state_root` to the DB. I think it could reasonably live in the `AnchorInfo`, as it is only relevant when the anchor is non-null (i.e. for non-archive nodes).",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1588303226/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1626353454",
    "html_url": "https://github.com/sigp/lighthouse/issues/3210#issuecomment-1626353454",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3210",
    "id": 1626353454,
    "node_id": "IC_kwDOCFeAzc5g8C8u",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-07T23:18:06Z",
    "updated_at": "2023-07-07T23:18:06Z",
    "author_association": "MEMBER",
    "body": "Adding the tree-states tag, because sorting out the alignment issue is required for https://github.com/sigp/lighthouse/issues/4481, which is required for a `tree-states` database migration.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1626353454/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
