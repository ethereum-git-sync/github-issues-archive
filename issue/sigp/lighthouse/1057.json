{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/1057",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/1057/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/1057/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/1057/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/1057",
  "id": 607217630,
  "node_id": "MDU6SXNzdWU2MDcyMTc2MzA=",
  "number": 1057,
  "title": "Improved discovery handling for subnets",
  "user": {
    "login": "AgeManning",
    "id": 7454587,
    "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/AgeManning",
    "html_url": "https://github.com/AgeManning",
    "followers_url": "https://api.github.com/users/AgeManning/followers",
    "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
    "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
    "organizations_url": "https://api.github.com/users/AgeManning/orgs",
    "repos_url": "https://api.github.com/users/AgeManning/repos",
    "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
    "received_events_url": "https://api.github.com/users/AgeManning/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "realbigsean",
    "id": 5160426,
    "node_id": "MDQ6VXNlcjUxNjA0MjY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5160426?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/realbigsean",
    "html_url": "https://github.com/realbigsean",
    "followers_url": "https://api.github.com/users/realbigsean/followers",
    "following_url": "https://api.github.com/users/realbigsean/following{/other_user}",
    "gists_url": "https://api.github.com/users/realbigsean/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/realbigsean/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/realbigsean/subscriptions",
    "organizations_url": "https://api.github.com/users/realbigsean/orgs",
    "repos_url": "https://api.github.com/users/realbigsean/repos",
    "events_url": "https://api.github.com/users/realbigsean/events{/privacy}",
    "received_events_url": "https://api.github.com/users/realbigsean/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "realbigsean",
      "id": 5160426,
      "node_id": "MDQ6VXNlcjUxNjA0MjY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5160426?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/realbigsean",
      "html_url": "https://github.com/realbigsean",
      "followers_url": "https://api.github.com/users/realbigsean/followers",
      "following_url": "https://api.github.com/users/realbigsean/following{/other_user}",
      "gists_url": "https://api.github.com/users/realbigsean/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/realbigsean/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/realbigsean/subscriptions",
      "organizations_url": "https://api.github.com/users/realbigsean/orgs",
      "repos_url": "https://api.github.com/users/realbigsean/repos",
      "events_url": "https://api.github.com/users/realbigsean/events{/privacy}",
      "received_events_url": "https://api.github.com/users/realbigsean/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2020-04-27T04:12:59Z",
  "updated_at": "2020-07-20T06:04:38Z",
  "closed_at": "2020-07-20T06:04:38Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nThe attestation service manages the timing logic for discovery and connecting to particular subnets for attached validators. Currently the service sends a discovery request for a subnet and leaves it at that. \r\n\r\nThis is not great for a number of reasons. Firstly, if the search reveals no useful peers and we still have time before subscribing to the subnet, we should continue performing searches (perhaps a maximum of 3 searches before giving up). \r\nSecondly, we would like to keep track of the peers that we find and ensure we stay connected to them at least until the time they are needed for subscription to a subnet. \r\n\r\nTo do this, I imagine the discovery request from the attestation service should include a time which indicates how long we should keep the discovered peers for. \r\n\r\nThe discovery request itself should then keep track of its discoveries via an ID (which I will build into discv5 itself) i.e: https://github.com/sigp/lighthouse/blob/master/beacon_node/eth2-libp2p/src/discovery/mod.rs#L256\r\nThis function gets called for a request for discovery. It should now keep the Instant at which we need to keep peers. The query that gets sent will return a `QueryId` (I'll add this into discv5) so that we can match peers that get discovered for the `QueryId` (here: https://github.com/sigp/lighthouse/blob/master/beacon_node/eth2-libp2p/src/discovery/mod.rs#L441) or repeat the query if an insufficient number of peers are found.)\r\n\r\nOnce peers are found for a specific query, we should tag them as being kept alive for the specific amount of time. This can be done via modifying the `PeerDb` which contains information about any given peer. \r\nSee some use of it here: https://github.com/sigp/lighthouse/blob/master/beacon_node/eth2-libp2p/src/discovery/mod.rs#L463\r\n\r\nAdding something like `wanted_until: Option<Instant>` to `PeerInfo` : https://github.com/sigp/lighthouse/blob/master/beacon_node/eth2-libp2p/src/peer_manager/peer_info.rs#L17\r\n\r\nwill allow the peer manager to decide to keep this peer if we need to prune our peers. This way, discovered peers for a particular subnet will not get dropped early. \r\n\r\n",
  "closed_by": {
    "login": "AgeManning",
    "id": 7454587,
    "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/AgeManning",
    "html_url": "https://github.com/AgeManning",
    "followers_url": "https://api.github.com/users/AgeManning/followers",
    "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
    "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
    "organizations_url": "https://api.github.com/users/AgeManning/orgs",
    "repos_url": "https://api.github.com/users/AgeManning/repos",
    "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
    "received_events_url": "https://api.github.com/users/AgeManning/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/1057/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/1057/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/620346117",
    "html_url": "https://github.com/sigp/lighthouse/issues/1057#issuecomment-620346117",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1057",
    "id": 620346117,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyMDM0NjExNw==",
    "user": {
      "login": "realbigsean",
      "id": 5160426,
      "node_id": "MDQ6VXNlcjUxNjA0MjY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5160426?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/realbigsean",
      "html_url": "https://github.com/realbigsean",
      "followers_url": "https://api.github.com/users/realbigsean/followers",
      "following_url": "https://api.github.com/users/realbigsean/following{/other_user}",
      "gists_url": "https://api.github.com/users/realbigsean/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/realbigsean/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/realbigsean/subscriptions",
      "organizations_url": "https://api.github.com/users/realbigsean/orgs",
      "repos_url": "https://api.github.com/users/realbigsean/repos",
      "events_url": "https://api.github.com/users/realbigsean/events{/privacy}",
      "received_events_url": "https://api.github.com/users/realbigsean/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-04-28T02:50:28Z",
    "updated_at": "2020-04-28T02:50:28Z",
    "author_association": "COLLABORATOR",
    "body": "I can work on this.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/620346117/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 1,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/660822706",
    "html_url": "https://github.com/sigp/lighthouse/issues/1057#issuecomment-660822706",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1057",
    "id": 660822706,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY2MDgyMjcwNg==",
    "user": {
      "login": "AgeManning",
      "id": 7454587,
      "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AgeManning",
      "html_url": "https://github.com/AgeManning",
      "followers_url": "https://api.github.com/users/AgeManning/followers",
      "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
      "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
      "organizations_url": "https://api.github.com/users/AgeManning/orgs",
      "repos_url": "https://api.github.com/users/AgeManning/repos",
      "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AgeManning/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-07-20T06:04:38Z",
    "updated_at": "2020-07-20T06:04:38Z",
    "author_association": "MEMBER",
    "body": "Closed in #1203",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/660822706/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
