{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/3421",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/3421/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/3421/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/3421/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/3421",
  "id": 1327636304,
  "node_id": "I_kwDOCFeAzc5PIh9Q",
  "number": 3421,
  "title": "Time discrepancy false positive with Teku",
  "user": {
    "login": "torfbolt",
    "id": 233423,
    "node_id": "MDQ6VXNlcjIzMzQyMw==",
    "avatar_url": "https://avatars.githubusercontent.com/u/233423?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/torfbolt",
    "html_url": "https://github.com/torfbolt",
    "followers_url": "https://api.github.com/users/torfbolt/followers",
    "following_url": "https://api.github.com/users/torfbolt/following{/other_user}",
    "gists_url": "https://api.github.com/users/torfbolt/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/torfbolt/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/torfbolt/subscriptions",
    "organizations_url": "https://api.github.com/users/torfbolt/orgs",
    "repos_url": "https://api.github.com/users/torfbolt/repos",
    "events_url": "https://api.github.com/users/torfbolt/events{/privacy}",
    "received_events_url": "https://api.github.com/users/torfbolt/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1245875191,
      "node_id": "MDU6TGFiZWwxMjQ1ODc1MTkx",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/val-client",
      "name": "val-client",
      "color": "9cd6fc",
      "default": false,
      "description": "Relates to the validator client binary"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2022-08-03T18:35:46Z",
  "updated_at": "2023-06-22T23:46:05Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nDuring the doppelganger protection phase I received multiple error messages from the VC warning about time discrepancy, even though both VC and BN run on the same machine with correct NTP time.\r\n\r\n## Version\r\n\r\n2.5.1 running on Prater\r\n\r\n## Present Behaviour\r\n\r\nAfter upgrading to 2.5.1 and restarting, the Lighthouse VC went into the doppelganger listening phase. It successfully connected to both configured beacon nodes, a Teku 22.8.0 and a Lighthouse 2.5.1 running on the same machine, fully synced. During the doppelganger protection phase I then received multiple times the log message\r\n\r\n> Aug 03 18:01:47 schnecki lighthouse[831307]: Aug 03 18:01:47.087 INFO Connected to beacon node                endpoint: http://localhost:33050/, version: teku/v22.8.0/linux-x86_64/-privatebuild-ope>\r\nAug 03 18:01:47 schnecki lighthouse[831307]: Aug 03 18:01:47.208 ERRO Time discrepancy with beacon node       endpoint: http://localhost:33050/, local_slot: 3586808, beacon_node_slot: 3586804, msg:>\r\nAug 03 18:01:48 schnecki lighthouse[831307]: Aug 03 18:01:48.207 INFO Connected to beacon node                endpoint: http://localhost:33050/, version: teku/v22.8.0/linux-x86_64/-privatebuild-ope>\r\nAug 03 18:01:48 schnecki lighthouse[831307]: Aug 03 18:01:48.208 ERRO Time discrepancy with beacon node       endpoint: http://localhost:33050/, local_slot: 3586809, beacon_node_slot: 3586804, msg:>\r\nAug 03 18:01:54 schnecki lighthouse[831307]: Aug 03 18:01:54.002 INFO Connected to beacon node(s)             synced: 2, available: 2, total: 2, service: notifier\r\n\r\nThere were no error messages about the Lighthouse BN, but that might be only because it was listed as second prio BN.\r\n\r\nAfter the doppelganger protection phase ended, there were no further time discrepancy errors.\r\n\r\n## Expected Behaviour\r\n\r\nNo error messages about time discrepancy also during the doppelganger protection phase.\r\n\r\n## Steps to resolve\r\n\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/3421/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/3421/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1204862766",
    "html_url": "https://github.com/sigp/lighthouse/issues/3421#issuecomment-1204862766",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3421",
    "id": 1204862766,
    "node_id": "IC_kwDOCFeAzc5H0L8u",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-04T07:17:49Z",
    "updated_at": "2022-08-04T07:17:49Z",
    "author_association": "MEMBER",
    "body": "Have you inquired with Teku about this? It looks like it might be a discrepancy in how we define the `sync_distance` in the `/eth/v1/node/syncing` endpoint. Lighthouse tries to use the `sync_distance` to work out the remote beacon node's current slot here:\r\n\r\nhttps://github.com/sigp/lighthouse/blob/df51a73272489fe154bd10995c96199062b6c3f7/validator_client/src/check_synced.rs#L58-L71",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1204862766/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1205739301",
    "html_url": "https://github.com/sigp/lighthouse/issues/3421#issuecomment-1205739301",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3421",
    "id": 1205739301,
    "node_id": "IC_kwDOCFeAzc5H3h8l",
    "user": {
      "login": "torfbolt",
      "id": 233423,
      "node_id": "MDQ6VXNlcjIzMzQyMw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/233423?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/torfbolt",
      "html_url": "https://github.com/torfbolt",
      "followers_url": "https://api.github.com/users/torfbolt/followers",
      "following_url": "https://api.github.com/users/torfbolt/following{/other_user}",
      "gists_url": "https://api.github.com/users/torfbolt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/torfbolt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/torfbolt/subscriptions",
      "organizations_url": "https://api.github.com/users/torfbolt/orgs",
      "repos_url": "https://api.github.com/users/torfbolt/repos",
      "events_url": "https://api.github.com/users/torfbolt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/torfbolt/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-04T20:33:53Z",
    "updated_at": "2022-08-04T20:33:53Z",
    "author_association": "NONE",
    "body": "I think I found out when this happens: if there are two or more consecutive empty slots on the beacon chain. So it looks like Teku doesn't update the head slot (or sync distance) when there are empty slots, while lighthouse expects it to go up.\r\n\r\nTeku logs on Prater:\r\n\r\n> Aug 04 20:16:52 schnecki teku[831696]: 20:16:52.272 INFO  - Slot Event  *** Slot: 3594684, Block: 57c62b660692653c38f26933642565cdf3b2d2173e6af12993af1431b723a9db, Justified: 112332, Finalized: 112>\r\nAug 04 20:17:04 schnecki teku[831696]: 20:17:04.346 INFO  - Slot Event  *** Slot: 3594685, Block:                                                        ... empty, Justified: 112332, Finalized: 112>\r\nAug 04 20:17:16 schnecki teku[831696]: 20:17:16.267 INFO  - Slot Event  *** Slot: 3594686, Block:                                                        ... empty, Justified: 112332, Finalized: 112>\r\nAug 04 20:17:28 schnecki teku[831696]: 20:17:28.276 INFO  - Slot Event  *** Slot: 3594687, Block:                                                        ... empty, Justified: 112332, Finalized: 112>\r\nAug 04 20:17:39 schnecki teku[831696]: 20:17:39.898 INFO  - Epoch Event *** Epoch: 112334, Justified checkpoint: 112333, Finalized checkpoint: 112332, Finalized root: d543a170bf7255ea9a74f719f692ea>\r\n\r\nLighthouse VC logs:\r\n\r\n> Aug 04 20:17:23 schnecki lighthouse[901917]: Aug 04 20:17:23.001 INFO Connected to beacon node                endpoint: http://localhost:33050/, version: teku/v22.8.0/linux-x86_64/-privatebuild-ope>\r\nAug 04 20:17:23 schnecki lighthouse[901917]: Aug 04 20:17:23.001 ERRO Time discrepancy with beacon node       endpoint: http://localhost:33050/, local_slot: 3594686, beacon_node_slot: 3594684, msg:>\r\nAug 04 20:17:30 schnecki lighthouse[901917]: Aug 04 20:17:30.000 INFO Connected to beacon node(s)             synced: 2, available: 2, total: 2, service: notifier\r\nAug 04 20:17:30 schnecki lighthouse[901917]: Aug 04 20:17:30.000 INFO Listening for doppelgangers             doppelganger_detecting_validators: 6, service: notifier\r\nAug 04 20:17:30 schnecki lighthouse[901917]: Aug 04 20:17:30.000 INFO Awaiting activation                     slot: 3594687, epoch: 112333, validators: 6, service: notifier\r\nAug 04 20:17:35 schnecki lighthouse[901917]: Aug 04 20:17:35.001 INFO Connected to beacon node                endpoint: http://localhost:33050/, version: teku/v22.8.0/linux-x86_64/-privatebuild-ope>\r\nAug 04 20:17:35 schnecki lighthouse[901917]: Aug 04 20:17:35.001 ERRO Time discrepancy with beacon node       endpoint: http://localhost:33050/, local_slot: 3594687, beacon_node_slot: 3594684, msg:>\r\nAug 04 20:17:42 schnecki lighthouse[901917]: Aug 04 20:17:42.000 INFO Connected to beacon node(s)             synced: 2, available: 2, total: 2, service: notifier\r\nAug 04 20:17:42 schnecki lighthouse[901917]: Aug 04 20:17:42.000 INFO Listening for doppelgangers             doppelganger_detecting_validators: 6, service: notifier\r\n\r\n\r\nWhat I haven't found out yet is why this error only appears during the doppelganger protection phase.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1205739301/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1214518459",
    "html_url": "https://github.com/sigp/lighthouse/issues/3421#issuecomment-1214518459",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3421",
    "id": 1214518459,
    "node_id": "IC_kwDOCFeAzc5IZBS7",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-15T01:36:49Z",
    "updated_at": "2022-08-15T01:36:49Z",
    "author_association": "MEMBER",
    "body": "> What I haven't found out yet is why this error only appears during the doppelganger protection phase.\r\n\r\nI've seen several reports now of users seeing this even when they're not using doppelganger protection. I think your diagnosis about the head slot behaviour must be correct.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1214518459/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
