{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/2983",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/2983/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/2983/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/2983/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/2983",
  "id": 1120271777,
  "node_id": "I_kwDOCFeAzc5Cxf2h",
  "number": 2983,
  "title": "Retrospective transition block checking",
  "user": {
    "login": "paulhauner",
    "id": 6660660,
    "node_id": "MDQ6VXNlcjY2NjA2NjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/paulhauner",
    "html_url": "https://github.com/paulhauner",
    "followers_url": "https://api.github.com/users/paulhauner/followers",
    "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
    "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
    "organizations_url": "https://api.github.com/users/paulhauner/orgs",
    "repos_url": "https://api.github.com/users/paulhauner/repos",
    "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
    "received_events_url": "https://api.github.com/users/paulhauner/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3743113288,
      "node_id": "LA_kwDOCFeAzc7fG2BI",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/bellatrix",
      "name": "bellatrix",
      "color": "A906A4",
      "default": false,
      "description": "Required to support the Bellatrix Upgrade"
    },
    {
      "id": 4345538011,
      "node_id": "LA_kwDOCFeAzc8AAAABAwOl2w",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/v2.5.0",
      "name": "v2.5.0",
      "color": "8C40DA",
      "default": false,
      "description": "Required for Goerli merge release"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "ethDreamer",
    "id": 37123614,
    "node_id": "MDQ6VXNlcjM3MTIzNjE0",
    "avatar_url": "https://avatars.githubusercontent.com/u/37123614?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ethDreamer",
    "html_url": "https://github.com/ethDreamer",
    "followers_url": "https://api.github.com/users/ethDreamer/followers",
    "following_url": "https://api.github.com/users/ethDreamer/following{/other_user}",
    "gists_url": "https://api.github.com/users/ethDreamer/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ethDreamer/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ethDreamer/subscriptions",
    "organizations_url": "https://api.github.com/users/ethDreamer/orgs",
    "repos_url": "https://api.github.com/users/ethDreamer/repos",
    "events_url": "https://api.github.com/users/ethDreamer/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ethDreamer/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "ethDreamer",
      "id": 37123614,
      "node_id": "MDQ6VXNlcjM3MTIzNjE0",
      "avatar_url": "https://avatars.githubusercontent.com/u/37123614?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ethDreamer",
      "html_url": "https://github.com/ethDreamer",
      "followers_url": "https://api.github.com/users/ethDreamer/followers",
      "following_url": "https://api.github.com/users/ethDreamer/following{/other_user}",
      "gists_url": "https://api.github.com/users/ethDreamer/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ethDreamer/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ethDreamer/subscriptions",
      "organizations_url": "https://api.github.com/users/ethDreamer/orgs",
      "repos_url": "https://api.github.com/users/ethDreamer/repos",
      "events_url": "https://api.github.com/users/ethDreamer/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ethDreamer/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2022-02-01T06:06:46Z",
  "updated_at": "2022-07-30T05:08:10Z",
  "closed_at": "2022-07-30T05:08:10Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nThe \"transition block\" is the first block in a chain that includes a non-empty `ExecutionPayload`. This is effectively the first *merging* of the proof-of-work chain into the proof-of-stake chain.\r\n\r\nThis block requires some [additional verification](https://github.com/sigp/lighthouse/blob/5f628a71d4b2a7e7761b30e726338bba07617cd2/beacon_node/beacon_chain/src/execution_payload.rs#L72-L139) when compared to pre- and post-transition blocks; the consensus client must check that the PoW chain has reached the terminal total difficulty and/or some other criteria.\r\n\r\nThese additional verifications are challenging during optimistic sync. We can't perform them during sync, since the execution client might not be synced enough to respond to the requests. So, we *optimistically* accept the transition block and promise to come back later and check it once the execution client is synced.\r\n\r\nPresently, Lighthouse happily optimistically accepts the transition block, but it fulfills the promise to verify it. Therefore, Lighthouse needs:\r\n\r\n- A way to cache optimistic transition blocks as we come across them during sync.\r\n\t- This cache must persist across reboots, so it needs to be saved to the DB.\r\n- A way to know that the EL is synced and it's therefore time to check all the blocks in the cache.\r\n- Interaction with #2837 to invalidate any blocks where the tranisition *fails* the retrospective check (talk to @paulhauner)\r\n",
  "closed_by": {
    "login": "paulhauner",
    "id": 6660660,
    "node_id": "MDQ6VXNlcjY2NjA2NjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/paulhauner",
    "html_url": "https://github.com/paulhauner",
    "followers_url": "https://api.github.com/users/paulhauner/followers",
    "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
    "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
    "organizations_url": "https://api.github.com/users/paulhauner/orgs",
    "repos_url": "https://api.github.com/users/paulhauner/repos",
    "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
    "received_events_url": "https://api.github.com/users/paulhauner/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/2983/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/2983/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1027465583",
    "html_url": "https://github.com/sigp/lighthouse/issues/2983#issuecomment-1027465583",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/2983",
    "id": 1027465583,
    "node_id": "IC_kwDOCFeAzc49PeFv",
    "user": {
      "login": "ethDreamer",
      "id": 37123614,
      "node_id": "MDQ6VXNlcjM3MTIzNjE0",
      "avatar_url": "https://avatars.githubusercontent.com/u/37123614?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ethDreamer",
      "html_url": "https://github.com/ethDreamer",
      "followers_url": "https://api.github.com/users/ethDreamer/followers",
      "following_url": "https://api.github.com/users/ethDreamer/following{/other_user}",
      "gists_url": "https://api.github.com/users/ethDreamer/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ethDreamer/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ethDreamer/subscriptions",
      "organizations_url": "https://api.github.com/users/ethDreamer/orgs",
      "repos_url": "https://api.github.com/users/ethDreamer/repos",
      "events_url": "https://api.github.com/users/ethDreamer/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ethDreamer/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-02-02T00:50:24Z",
    "updated_at": "2022-02-02T00:50:24Z",
    "author_association": "COLLABORATOR",
    "body": "I ran into some related stuff when working on the engine-api upgrade so I'm going to put all the block conditions here:\r\n - [eth2 spec transition block validation conditions](https://github.com/ethereum/consensus-specs/blob/v1.1.9/specs/bellatrix/fork-choice.md#validate_merge_block)\r\n - [EIP-3675 transition block validation conditions (EE side)](https://eips.ethereum.org/EIPS/eip-3675#transition-block-validity)\r\n - [Invalid transition block response from EE (see #2)](https://github.com/ethereum/execution-apis/blob/v1.0.0-alpha.6/src/engine/specification.md#payload-validation)\r\n\r\nYou'll notice there's a new status `INVALID_TERMINAL_BLOCK` in the response to `newPayloadV1` (formally `executePayloadV1`) from the execution engine.. not sure how that changes what you've discussed here @paulhauner",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1027465583/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1027472661",
    "html_url": "https://github.com/sigp/lighthouse/issues/2983#issuecomment-1027472661",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/2983",
    "id": 1027472661,
    "node_id": "IC_kwDOCFeAzc49Pf0V",
    "user": {
      "login": "paulhauner",
      "id": 6660660,
      "node_id": "MDQ6VXNlcjY2NjA2NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/paulhauner",
      "html_url": "https://github.com/paulhauner",
      "followers_url": "https://api.github.com/users/paulhauner/followers",
      "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
      "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
      "organizations_url": "https://api.github.com/users/paulhauner/orgs",
      "repos_url": "https://api.github.com/users/paulhauner/repos",
      "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/paulhauner/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-02-02T01:01:24Z",
    "updated_at": "2022-02-02T01:01:24Z",
    "author_association": "MEMBER",
    "body": "> You'll notice there's a new status INVALID_TERMINAL_BLOCK in the response to newPayloadV1 (formally executePayloadV1) from the execution engine.. not sure how that changes what you've discussed here @paulhauner\r\n\r\nI don't think that changes anything here, thanks for pointing it out though.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1027472661/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1062494947",
    "html_url": "https://github.com/sigp/lighthouse/issues/2983#issuecomment-1062494947",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/2983",
    "id": 1062494947,
    "node_id": "IC_kwDOCFeAzc4_VGLj",
    "user": {
      "login": "paulhauner",
      "id": 6660660,
      "node_id": "MDQ6VXNlcjY2NjA2NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/paulhauner",
      "html_url": "https://github.com/paulhauner",
      "followers_url": "https://api.github.com/users/paulhauner/followers",
      "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
      "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
      "organizations_url": "https://api.github.com/users/paulhauner/orgs",
      "repos_url": "https://api.github.com/users/paulhauner/repos",
      "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/paulhauner/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-03-09T02:33:50Z",
    "updated_at": "2022-03-09T02:34:26Z",
    "author_association": "MEMBER",
    "body": "I'm thinking that perhaps we want logic along the lines of this:\r\n\r\n1. Whenever a transition block is optimistically imported, insert it into an \"optimistic transition blocks\" (OTB) column in the database.\r\n1. Periodically run a routine that:\r\n    1. Loads all blocks roots from the OTB column.\r\n    1. Removes any blocks from the OTB column that conflict with the finalized checkpoint.\r\n    1. For remaining OTB block roots that are finalized, check them against the EL and kill the client if they're invalid.\r\n    1. For remaining OTB blocks that are not-yet-finalized, run [`BeaconChain::process_invalid_execution_payload`](https://github.com/sigp/lighthouse/blob/267d8babc8cfe20f5b27327f16823324ed0b45a9/beacon_node/beacon_chain/src/beacon_chain.rs#L3200-L3203) for any invalid blocks.\r\n    1. For any blocks that are found to be valid, remove them from the OTB table.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1062494947/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1200091242",
    "html_url": "https://github.com/sigp/lighthouse/issues/2983#issuecomment-1200091242",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/2983",
    "id": 1200091242,
    "node_id": "IC_kwDOCFeAzc5Hh_Bq",
    "user": {
      "login": "paulhauner",
      "id": 6660660,
      "node_id": "MDQ6VXNlcjY2NjA2NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/paulhauner",
      "html_url": "https://github.com/paulhauner",
      "followers_url": "https://api.github.com/users/paulhauner/followers",
      "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
      "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
      "organizations_url": "https://api.github.com/users/paulhauner/orgs",
      "repos_url": "https://api.github.com/users/paulhauner/repos",
      "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/paulhauner/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-30T05:08:09Z",
    "updated_at": "2022-07-30T05:08:09Z",
    "author_association": "MEMBER",
    "body": "Resolved via #3372 :tada: ",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1200091242/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
