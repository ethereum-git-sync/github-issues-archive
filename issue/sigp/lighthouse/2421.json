{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/2421",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/2421/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/2421/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/2421/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/2421",
  "id": 931063118,
  "node_id": "MDU6SXNzdWU5MzEwNjMxMTg=",
  "number": 2421,
  "title": "Preserve orphaned blocks",
  "user": {
    "login": "michaelsproul",
    "id": 4452260,
    "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/michaelsproul",
    "html_url": "https://github.com/michaelsproul",
    "followers_url": "https://api.github.com/users/michaelsproul/followers",
    "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
    "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
    "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
    "repos_url": "https://api.github.com/users/michaelsproul/repos",
    "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
    "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 2336798682,
      "node_id": "MDU6TGFiZWwyMzM2Nzk4Njgy",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/database",
      "name": "database",
      "color": "C01C9D",
      "default": false,
      "description": ""
    },
    {
      "id": 2490305065,
      "node_id": "MDU6TGFiZWwyNDkwMzA1MDY1",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/A1",
      "name": "A1",
      "color": "223184",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2021-06-28T00:50:12Z",
  "updated_at": "2022-04-13T17:17:28Z",
  "closed_at": null,
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nWe currently have no way of preserving orphaned blocks, even though they are useful for block explorers and analytics.\r\n\r\n## Steps to resolve\r\n\r\n* Add a flag to `lighthouse bn` called something like `--keep-orphaned-blocks`\r\n* Add a new column to the database for mapping slots to _vecs of_ orphaned block roots (`DBColumn::OrphanedBlocks`). The blocks themselves can be stored in the hot DB's main block storage, where all other blocks are currently stored.\r\n* In the [pruning code that runs on finalization](https://github.com/sigp/lighthouse/blob/3b600acdc5bf9726367c18277a22486573b8b457/beacon_node/beacon_chain/src/migrate.rs#L260-L268) add logic to keep the blocks when `--keep-orphaned-blocks` is set, storing their block roots under the `slot => Vec<Hash256>` mapping.\r\n* In the API:\r\n  * Modify `/eth/v1/beacon/headers?slot` so that it reads block roots from the orphaned block roots table, and then looks them up in the main block table.\r\n  * Work out what to do with `/eth/v1/beacon/headers?parent_root` (I don't know what we do currently)\r\n  * The orphaned blocks themselves can then be accessed by their root using `/eth/v1/beacon/blocks/{root}` but _not_ by their slot directly.\r\n\r\n## Version\r\n\r\nLighthouse v1.4.0\r\n\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/2421/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/2421/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1055660978",
    "html_url": "https://github.com/sigp/lighthouse/issues/2421#issuecomment-1055660978",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/2421",
    "id": 1055660978,
    "node_id": "IC_kwDOCFeAzc4-7Buy",
    "user": {
      "login": "eklm",
      "id": 206695,
      "node_id": "MDQ6VXNlcjIwNjY5NQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/206695?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/eklm",
      "html_url": "https://github.com/eklm",
      "followers_url": "https://api.github.com/users/eklm/followers",
      "following_url": "https://api.github.com/users/eklm/following{/other_user}",
      "gists_url": "https://api.github.com/users/eklm/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/eklm/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/eklm/subscriptions",
      "organizations_url": "https://api.github.com/users/eklm/orgs",
      "repos_url": "https://api.github.com/users/eklm/repos",
      "events_url": "https://api.github.com/users/eklm/events{/privacy}",
      "received_events_url": "https://api.github.com/users/eklm/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-03-01T17:06:25Z",
    "updated_at": "2022-03-01T17:06:25Z",
    "author_association": "CONTRIBUTOR",
    "body": "I would like to take this.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1055660978/reactions",
      "total_count": 2,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 2,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1055971716",
    "html_url": "https://github.com/sigp/lighthouse/issues/2421#issuecomment-1055971716",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/2421",
    "id": 1055971716,
    "node_id": "IC_kwDOCFeAzc4-8NmE",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-03-01T23:36:06Z",
    "updated_at": "2022-03-01T23:36:06Z",
    "author_association": "MEMBER",
    "body": "Thanks @eklm that would be awesome!\r\n\r\nI'm working on some other database changes at the moment which are making me reconsider this part of the design:\r\n\r\n> The blocks themselves can be stored in the hot DB's main block storage, where all other blocks are currently stored.\r\n\r\nI think it might be better to move the orphaned blocks to a separate part of the database. So maybe the column `DBColumn::OrphanedBlocks` could store values of `Vec<SignedBeaconBlock<E>>`, or we keep the layer of redirection and add two columns: `OrphanedBlockRoots: Slot => Vec<Hash256>` and `OrphanedBlocks: Hash256 => SignedBeaconBlock<E>`.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1055971716/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1098024165",
    "html_url": "https://github.com/sigp/lighthouse/issues/2421#issuecomment-1098024165",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/2421",
    "id": 1098024165,
    "node_id": "IC_kwDOCFeAzc5BcoTl",
    "user": {
      "login": "eklm",
      "id": 206695,
      "node_id": "MDQ6VXNlcjIwNjY5NQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/206695?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/eklm",
      "html_url": "https://github.com/eklm",
      "followers_url": "https://api.github.com/users/eklm/followers",
      "following_url": "https://api.github.com/users/eklm/following{/other_user}",
      "gists_url": "https://api.github.com/users/eklm/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/eklm/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/eklm/subscriptions",
      "organizations_url": "https://api.github.com/users/eklm/orgs",
      "repos_url": "https://api.github.com/users/eklm/repos",
      "events_url": "https://api.github.com/users/eklm/events{/privacy}",
      "received_events_url": "https://api.github.com/users/eklm/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-04-13T13:03:14Z",
    "updated_at": "2022-04-13T17:17:28Z",
    "author_association": "CONTRIBUTOR",
    "body": "Hi @michaelsproul! Didn't have a chance to look at this yet, but I now get back to it and investigated the current implementation. So you are suggesting to move the orphaned blocks to different column in the hot db or also to the cold db?\r\n\r\n> So maybe the column DBColumn::OrphanedBlocks could store values of Vec<SignedBeaconBlock<E>>, or we keep the layer of redirection and add two columns: OrphanedBlockRoots: Slot => Vec<Hash256> and OrphanedBlocks: Hash256 => SignedBeaconBlock<E>.\r\n\r\nThe second variant looks much better for me (`OrphanedBlockRoots: Slot => Vec<Hash256> `and `OrphanedBlocks: Hash256 => SignedBeaconBlock<E>`) as `DBColumn::OrphanedBlocks` in the first case can grow very large.\r\n\r\nI'm also thinking of if we should return the orphaned state in the api if it was requested by the root? I guess yes, right? In order to do that we may go to the corresponding orphaned block first and find the first ancestor which is part of canonical chain and replay the state from there...",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1098024165/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
