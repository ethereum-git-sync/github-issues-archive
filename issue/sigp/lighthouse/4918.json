{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/4918",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/4918/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/4918/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/4918/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/4918",
  "id": 1984669468,
  "node_id": "I_kwDOCFeAzc52S6cc",
  "number": 4918,
  "title": "Large Memory Consumption Tracking Issue (OOM)",
  "user": {
    "login": "AgeManning",
    "id": 7454587,
    "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/AgeManning",
    "html_url": "https://github.com/AgeManning",
    "followers_url": "https://api.github.com/users/AgeManning/followers",
    "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
    "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
    "organizations_url": "https://api.github.com/users/AgeManning/orgs",
    "repos_url": "https://api.github.com/users/AgeManning/repos",
    "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
    "received_events_url": "https://api.github.com/users/AgeManning/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 2336800125,
      "node_id": "MDU6TGFiZWwyMzM2ODAwMTI1",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/t%20Networking",
      "name": "t Networking",
      "color": "40E0D0",
      "default": false,
      "description": ""
    },
    {
      "id": 5984399458,
      "node_id": "LA_kwDOCFeAzc8AAAABZLKwYg",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/v4.6.0",
      "name": "v4.6.0",
      "color": "B2837B",
      "default": false,
      "description": "ETA Q1 2024"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 6,
  "created_at": "2023-11-09T01:43:15Z",
  "updated_at": "2024-01-23T04:34:15Z",
  "closed_at": null,
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nWe are aware of an issue on the mainnet network which is causing Lighthouse to consume more memory than it should. This is leading to Out of Memory (OOM) process terminations on some machines. \r\n\r\nThe root cause of the issue (we believe) are messages being queued on gossipsub to be sent out. This is a combination of messages being published, messages being forward and gossipsub control messages. The queues are filling up and the memory is not being dropped. This appears to only be occuring on mainnet, we assume in part to the size of the network and the number of messages being transmitted. \r\n\r\nThere are a number of solutions being put in place and being tested. This issue is mainly a tracking issue, so users can follow along with development updates as we correct this issue. \r\n\r\nPrimarly the end solution will consist of more efficient memory management (avoid duplicating any memory in messages when sending) this should reduce allocations, a priortisation of messages so that we can prioritise published, forward and control messages individually and finally a dropping mechanism that allows us to drop messages when the queues grow too large.\r\n\r\nMemory Allocations:\r\n- https://github.com/libp2p/rust-libp2p/pull/4782\r\n- Arc-ing messages in gossipsub: https://github.com/libp2p/rust-libp2p/commit/d28ff633810f45d4f6b1dbc6a1e6bb172c5f9125\r\n\r\nMessage Prioritisation:\r\n- https://github.com/libp2p/rust-libp2p/pull/4811\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/4918/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/4918/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1804906250",
    "html_url": "https://github.com/sigp/lighthouse/issues/4918#issuecomment-1804906250",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4918",
    "id": 1804906250,
    "node_id": "IC_kwDOCFeAzc5rlK8K",
    "user": {
      "login": "thomaseizinger",
      "id": 5486389,
      "node_id": "MDQ6VXNlcjU0ODYzODk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5486389?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/thomaseizinger",
      "html_url": "https://github.com/thomaseizinger",
      "followers_url": "https://api.github.com/users/thomaseizinger/followers",
      "following_url": "https://api.github.com/users/thomaseizinger/following{/other_user}",
      "gists_url": "https://api.github.com/users/thomaseizinger/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/thomaseizinger/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/thomaseizinger/subscriptions",
      "organizations_url": "https://api.github.com/users/thomaseizinger/orgs",
      "repos_url": "https://api.github.com/users/thomaseizinger/repos",
      "events_url": "https://api.github.com/users/thomaseizinger/events{/privacy}",
      "received_events_url": "https://api.github.com/users/thomaseizinger/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-11-10T00:53:35Z",
    "updated_at": "2023-11-10T00:53:35Z",
    "author_association": "NONE",
    "body": "> Memory Allocations:\r\n\r\n- [`RawMessage::raw_protobuf_len`](https://github.com/libp2p/rust-libp2p/blob/2ecc7cf1253e5a884d093fc51b4ba35c45a57842/protocols/gossipsub/src/types.rs#L122-L132) can be very expensive as well because it performs _many_ temporary allocations.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1804906250/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1827055249",
    "html_url": "https://github.com/sigp/lighthouse/issues/4918#issuecomment-1827055249",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4918",
    "id": 1827055249,
    "node_id": "IC_kwDOCFeAzc5s5qaR",
    "user": {
      "login": "tobidae-cb",
      "id": 107199804,
      "node_id": "U_kgDOBmO9PA",
      "avatar_url": "https://avatars.githubusercontent.com/u/107199804?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tobidae-cb",
      "html_url": "https://github.com/tobidae-cb",
      "followers_url": "https://api.github.com/users/tobidae-cb/followers",
      "following_url": "https://api.github.com/users/tobidae-cb/following{/other_user}",
      "gists_url": "https://api.github.com/users/tobidae-cb/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tobidae-cb/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tobidae-cb/subscriptions",
      "organizations_url": "https://api.github.com/users/tobidae-cb/orgs",
      "repos_url": "https://api.github.com/users/tobidae-cb/repos",
      "events_url": "https://api.github.com/users/tobidae-cb/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tobidae-cb/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-11-27T03:05:00Z",
    "updated_at": "2023-11-27T03:05:00Z",
    "author_association": "NONE",
    "body": "Following - this may be related to an issue we're also seeing - https://github.com/sigp/lighthouse/issues/4953\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1827055249/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1833136771",
    "html_url": "https://github.com/sigp/lighthouse/issues/4918#issuecomment-1833136771",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4918",
    "id": 1833136771,
    "node_id": "IC_kwDOCFeAzc5tQ3KD",
    "user": {
      "login": "AgeManning",
      "id": 7454587,
      "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AgeManning",
      "html_url": "https://github.com/AgeManning",
      "followers_url": "https://api.github.com/users/AgeManning/followers",
      "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
      "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
      "organizations_url": "https://api.github.com/users/AgeManning/orgs",
      "repos_url": "https://api.github.com/users/AgeManning/repos",
      "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AgeManning/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-11-30T05:34:48Z",
    "updated_at": "2023-11-30T05:42:27Z",
    "author_association": "MEMBER",
    "body": "To keep people updated on the progress. \r\n\r\nWe need to update lighthouse to the latest libp2p:\r\nhttps://github.com/sigp/lighthouse/pull/4935\r\n\r\nWe have message priority sorted: \r\nhttps://github.com/libp2p/rust-libp2p/pull/4914\r\n\r\nAnd we have a form of time-bound message dropping:\r\nhttps://github.com/sigp/rust-libp2p/pull/555\r\n\r\nWe are going to combine these into a rust-libp2p fork and start testing on live networks. \r\n",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1833136771/reactions",
      "total_count": 3,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 3,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1843757454",
    "html_url": "https://github.com/sigp/lighthouse/issues/4918#issuecomment-1843757454",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4918",
    "id": 1843757454,
    "node_id": "IC_kwDOCFeAzc5t5YGO",
    "user": {
      "login": "AgeManning",
      "id": 7454587,
      "node_id": "MDQ6VXNlcjc0NTQ1ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7454587?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AgeManning",
      "html_url": "https://github.com/AgeManning",
      "followers_url": "https://api.github.com/users/AgeManning/followers",
      "following_url": "https://api.github.com/users/AgeManning/following{/other_user}",
      "gists_url": "https://api.github.com/users/AgeManning/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AgeManning/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AgeManning/subscriptions",
      "organizations_url": "https://api.github.com/users/AgeManning/orgs",
      "repos_url": "https://api.github.com/users/AgeManning/repos",
      "events_url": "https://api.github.com/users/AgeManning/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AgeManning/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-12-06T21:59:34Z",
    "updated_at": "2023-12-06T22:00:10Z",
    "author_association": "MEMBER",
    "body": "Further updates. \r\n\r\nWe have a rust-libp2p fork which we are now testing. The new features we have added are:\r\n\r\n- Backpressure in messages and priorities of messages (https://github.com/sigp/rust-libp2p/pull/549)\r\n- Time-based message dropping from non-critical messages (https://github.com/sigp/rust-libp2p/pull/555)\r\n- Gossipsub scoring and the ability of application-level (think Lighthhouse) scoring for slow peers, which will cycle them from the mesh optimizing the gossipsub channel away from slow peers (https://github.com/sigp/rust-libp2p/pull/556)\r\n- Extended metrics so we can visualize what is happening at the gossipsub level (https://github.com/sigp/rust-libp2p/pull/558)\r\n- Improved speed of control messages, as this appears to be an old optimization which appears to be worse on performance. (https://github.com/sigp/rust-libp2p/pull/559)\r\n\r\nWe are adding these to Lighthouse and thoroughly testing ahead of a new lighthouse release. ",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1843757454/reactions",
      "total_count": 3,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 2,
      "confused": 0,
      "heart": 1,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1843816338",
    "html_url": "https://github.com/sigp/lighthouse/issues/4918#issuecomment-1843816338",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4918",
    "id": 1843816338,
    "node_id": "IC_kwDOCFeAzc5t5meS",
    "user": {
      "login": "thomaseizinger",
      "id": 5486389,
      "node_id": "MDQ6VXNlcjU0ODYzODk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5486389?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/thomaseizinger",
      "html_url": "https://github.com/thomaseizinger",
      "followers_url": "https://api.github.com/users/thomaseizinger/followers",
      "following_url": "https://api.github.com/users/thomaseizinger/following{/other_user}",
      "gists_url": "https://api.github.com/users/thomaseizinger/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/thomaseizinger/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/thomaseizinger/subscriptions",
      "organizations_url": "https://api.github.com/users/thomaseizinger/orgs",
      "repos_url": "https://api.github.com/users/thomaseizinger/repos",
      "events_url": "https://api.github.com/users/thomaseizinger/events{/privacy}",
      "received_events_url": "https://api.github.com/users/thomaseizinger/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-12-06T22:51:46Z",
    "updated_at": "2023-12-06T22:51:46Z",
    "author_association": "NONE",
    "body": "Great! Looking forward to seeing these in `rust-libp2p`!",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1843816338/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 1,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1905277599",
    "html_url": "https://github.com/sigp/lighthouse/issues/4918#issuecomment-1905277599",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4918",
    "id": 1905277599,
    "node_id": "IC_kwDOCFeAzc5xkDqf",
    "user": {
      "login": "paulhauner",
      "id": 6660660,
      "node_id": "MDQ6VXNlcjY2NjA2NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/paulhauner",
      "html_url": "https://github.com/paulhauner",
      "followers_url": "https://api.github.com/users/paulhauner/followers",
      "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
      "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
      "organizations_url": "https://api.github.com/users/paulhauner/orgs",
      "repos_url": "https://api.github.com/users/paulhauner/repos",
      "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/paulhauner/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2024-01-23T04:34:14Z",
    "updated_at": "2024-01-23T04:34:14Z",
    "author_association": "MEMBER",
    "body": "Are you happy to close this @AgeManning? If not, perhaps we can at least drop the `v4.6.0` tag.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1905277599/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
