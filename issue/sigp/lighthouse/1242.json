{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/1242",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/1242/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/1242/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/1242/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/1242",
  "id": 630027555,
  "node_id": "MDU6SXNzdWU2MzAwMjc1NTU=",
  "number": 1242,
  "title": "SIGILL when creating wallet on CPU without AVX support",
  "user": {
    "login": "iridescent86",
    "id": 66358571,
    "node_id": "MDQ6VXNlcjY2MzU4NTcx",
    "avatar_url": "https://avatars.githubusercontent.com/u/66358571?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/iridescent86",
    "html_url": "https://github.com/iridescent86",
    "followers_url": "https://api.github.com/users/iridescent86/followers",
    "following_url": "https://api.github.com/users/iridescent86/following{/other_user}",
    "gists_url": "https://api.github.com/users/iridescent86/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/iridescent86/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/iridescent86/subscriptions",
    "organizations_url": "https://api.github.com/users/iridescent86/orgs",
    "repos_url": "https://api.github.com/users/iridescent86/repos",
    "events_url": "https://api.github.com/users/iridescent86/events{/privacy}",
    "received_events_url": "https://api.github.com/users/iridescent86/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 985647281,
      "node_id": "MDU6TGFiZWw5ODU2NDcyODE=",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/bug",
      "name": "bug",
      "color": "d73a4a",
      "default": true,
      "description": "Something isn't working"
    },
    {
      "id": 1152259112,
      "node_id": "MDU6TGFiZWwxMTUyMjU5MTEy",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/blocked",
      "name": "blocked",
      "color": "000000",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2020-06-03T14:08:13Z",
  "updated_at": "2020-09-04T03:24:47Z",
  "closed_at": "2020-09-04T03:24:47Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nRunning `lighthouse account wallet create --name validators --passphrase-file validators.pass` fails with SIGILL when CPU has no AVX support.\r\n\r\n## Version\r\n\r\n- lighthouse 0.1.2 built from master branch, commit ce10db15da0db4cbe76b96b58ccd1b40e39ed124\r\n- rustc 1.43.1 (8d69840ab 2020-05-04)\r\n\r\n## Present Behaviour\r\n\r\nWhen running the `wallet create` command on a CPU that does not has AVX instructions set support, it fails and raises SIGILL:\r\n```\r\n$ ./lighthouse/target/release/lighthouse account wallet create --name validators --passphrase-file validators.pass\r\nIllegal instruction\r\n```\r\n\r\nGDB output:\r\n```\r\n$ gdb ./lighthouse/target/release/lighthouse\r\n(gdb) r account wallet create --name validators --passphrase-file validators.pass\r\nStarting program: /home/admin/lighthouse/target/release/lighthouse account wallet create --name validators --passphrase-file validators.pass\r\n[Thread debugging using libthread_db enabled]\r\nUsing host libthread_db library \"/lib/x86_64-linux-gnu/libthread_db.so.1\".\r\n[New Thread 0x7ffff72c9700 (LWP 31454)]\r\n[New Thread 0x7ffff70c8700 (LWP 31455)]\r\n\r\nThread 1 \"lighthouse\" received signal SIGILL, Illegal instruction.\r\n0x000055555613be01 in rust_crypto_aesni_setup_working_key_128 ()\r\n\r\n(gdb) where\r\n#0  0x000055555613be01 in rust_crypto_aesni_setup_working_key_128 ()\r\n#1  0x000055555613bd97 in rust_crypto_aesni_setup_working_key_128 ()\r\n#2  0x000055555613c311 in crypto::aesni::setup_working_key_aesni_128 ()\r\n#3  0x000055555612fc86 in crypto::aes::ctr ()\r\n#4  0x000055555612c344 in eth2_keystore::keystore::encrypt ()\r\n#5  0x00005555560e35d1 in eth2_wallet::wallet::WalletBuilder::build ()\r\n#6  0x00005555560c2262 in eth2_wallet_manager::wallet_manager::WalletManager::create_wallet ()\r\n#7  0x0000555556061e3a in account_manager::wallet::create::cli_run ()\r\n#8  0x000055555605830f in account_manager::wallet::cli_run ()\r\n#9  0x0000555555ba66e1 in account_manager::run ()\r\n#10 0x0000555555dbab45 in lighthouse::run ()\r\n#11 0x0000555555db3aed in lighthouse::main ()\r\n#12 0x0000555555ab05e3 in std::rt::lang_start::{{closure}} ()\r\n#13 0x00005555569d0b03 in std::rt::lang_start_internal::{{closure}} () at src/libstd/rt.rs:52\r\n#14 std::panicking::try::do_call () at src/libstd/panicking.rs:303\r\n#15 0x00005555569d74b7 in __rust_maybe_catch_panic () at src/libpanic_unwind/lib.rs:86\r\n#16 0x00005555569d162c in std::panicking::try () at src/libstd/panicking.rs:281\r\n#17 std::panic::catch_unwind () at src/libstd/panic.rs:394\r\n#18 std::rt::lang_start_internal () at src/libstd/rt.rs:51\r\n#19 0x0000555555dc0272 in main ()\r\n\r\n(gdb) disassemble 0x000055555613be01\r\nDump of assembler code for function rust_crypto_aesni_setup_working_key_128:\r\n   0x000055555613bd80 <+0>:     movdqu (%rdi),%xmm1\r\n   0x000055555613bd84 <+4>:     movdqu %xmm1,(%rsi)\r\n   0x000055555613bd88 <+8>:     add    $0x10,%rsi\r\n   0x000055555613bd8c <+12>:    aeskeygenassist $0x1,%xmm1,%xmm2\r\n   0x000055555613bd92 <+18>:    callq  0x55555613bdfc <rust_crypto_aesni_setup_working_key_128+124>\r\n   0x000055555613bd97 <+23>:    aeskeygenassist $0x2,%xmm1,%xmm2\r\n   0x000055555613bd9d <+29>:    callq  0x55555613bdfc <rust_crypto_aesni_setup_working_key_128+124>\r\n   0x000055555613bda2 <+34>:    aeskeygenassist $0x4,%xmm1,%xmm2\r\n   0x000055555613bda8 <+40>:    callq  0x55555613bdfc <rust_crypto_aesni_setup_working_key_128+124>\r\n   0x000055555613bdad <+45>:    aeskeygenassist $0x8,%xmm1,%xmm2\r\n   0x000055555613bdb3 <+51>:    callq  0x55555613bdfc <rust_crypto_aesni_setup_working_key_128+124>\r\n   0x000055555613bdb8 <+56>:    aeskeygenassist $0x10,%xmm1,%xmm2\r\n   0x000055555613bdbe <+62>:    callq  0x55555613bdfc <rust_crypto_aesni_setup_working_key_128+124>\r\n   0x000055555613bdc3 <+67>:    aeskeygenassist $0x20,%xmm1,%xmm2\r\n   0x000055555613bdc9 <+73>:    callq  0x55555613bdfc <rust_crypto_aesni_setup_working_key_128+124>\r\n   0x000055555613bdce <+78>:    aeskeygenassist $0x40,%xmm1,%xmm2\r\n   0x000055555613bdd4 <+84>:    callq  0x55555613bdfc <rust_crypto_aesni_setup_working_key_128+124>\r\n   0x000055555613bdd9 <+89>:    aeskeygenassist $0x80,%xmm1,%xmm2\r\n   0x000055555613bddf <+95>:    callq  0x55555613bdfc <rust_crypto_aesni_setup_working_key_128+124>\r\n   0x000055555613bde4 <+100>:   aeskeygenassist $0x1b,%xmm1,%xmm2\r\n   0x000055555613bdea <+106>:   callq  0x55555613bdfc <rust_crypto_aesni_setup_working_key_128+124>\r\n   0x000055555613bdef <+111>:   aeskeygenassist $0x36,%xmm1,%xmm2\r\n   0x000055555613bdf5 <+117>:   callq  0x55555613bdfc <rust_crypto_aesni_setup_working_key_128+124>\r\n   0x000055555613bdfa <+122>:   jmp    0x55555613be29 <rust_crypto_aesni_setup_working_key_128+169>\r\n   0x000055555613bdfc <+124>:   pshufd $0xff,%xmm2,%xmm2\r\n=> 0x000055555613be01 <+129>:   vpslldq $0x4,%xmm1,%xmm3\r\n   0x000055555613be06 <+134>:   pxor   %xmm3,%xmm1\r\n   0x000055555613be0a <+138>:   vpslldq $0x4,%xmm1,%xmm3\r\n   0x000055555613be0f <+143>:   pxor   %xmm3,%xmm1\r\n   0x000055555613be13 <+147>:   vpslldq $0x4,%xmm1,%xmm3\r\n   0x000055555613be18 <+152>:   pxor   %xmm3,%xmm1\r\n   0x000055555613be1c <+156>:   pxor   %xmm2,%xmm1\r\n   0x000055555613be20 <+160>:   movdqu %xmm1,(%rsi)\r\n   0x000055555613be24 <+164>:   add    $0x10,%rsi\r\n   0x000055555613be28 <+168>:   retq\r\n   0x000055555613be29 <+169>:   retq\r\nEnd of assembler dump.\r\n```\r\n\r\n/proc/cpuinfo on the machine on which issue was reproduced:\r\n```\r\n$ cat /proc/cpuinfo\r\nprocessor       : 0\r\nvendor_id       : GenuineIntel\r\ncpu family      : 6\r\nmodel           : 95\r\nmodel name      : Intel(R) Atom(TM) CPU C3758 @ 2.20GHz\r\nstepping        : 1\r\nmicrocode       : 0x1\r\ncpu MHz         : 2200.000\r\ncache size      : 2048 KB\r\nphysical id     : 0\r\nsiblings        : 1\r\ncore id         : 0\r\ncpu cores       : 1\r\napicid          : 0\r\ninitial apicid  : 0\r\nfpu             : yes\r\nfpu_exception   : yes\r\ncpuid level     : 13\r\nwp              : yes\r\nflags           : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 ss syscall nx pdpe1gb rdtscp lm constant_tsc arch_perfmon rep_good nopl xtopology cpuid tsc_known_freq pni pclmulqdq ssse3 cx16 sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave rdrand hypervisor lahf_lm 3dnowprefetch cpuid_fault pti ssbd ibrs ibpb fsgsbase tsc_adjust smep erms mpx rdseed smap clflushopt sha_ni xsaveopt xsavec xgetbv1 xsaves arat umip md_clear\r\nbugs            : cpu_meltdown spectre_v1 spectre_v2 spec_store_bypass\r\nbogomips        : 4400.00\r\nclflush size    : 64\r\ncache_alignment : 64\r\naddress sizes   : 40 bits physical, 48 bits virtual\r\npower management:\r\n```\r\n\r\nOn this machine, the issue was reproduced on a KVM based VM as well as on the bare metal.  \r\nOnly the wallet appears to be affected, the beacon node and the validator client were working fine on that server.\r\n\r\n## Expected Behaviour\r\n\r\nWallet should be created successfuly as it is the case when testing on another machine with AVX support:\r\n```\r\n$ ./lighthouse/target/release/lighthouse account wallet create --name validators --passphrase-file validators.pass\r\nYour wallet's 12-word BIP-39 mnemonic is:\r\n\r\n        (output omitted)\r\n\r\nThis mnemonic can be used to fully restore your wallet, should\r\nyou lose the JSON file or your password.\r\n\r\nIt is very important that you DO NOT SHARE this mnemonic as it will\r\nreveal the private keys of all validators and keys generated with\r\nthis wallet. That would be catastrophic.\r\n\r\nIt is also important to store a backup of this mnemonic so you can\r\nrecover your private keys in the case of data loss. Writing it on\r\na piece of paper and storing it in a safe place would be prudent.\r\n\r\nYour wallet's UUID is:\r\n\r\n        38ceb5f4-23da-4033-b961-54859354e485\r\n\r\nYou do not need to backup your UUID or keep it secret.\r\n```\r\n\r\n## Steps to resolve\r\n\r\nRoot cause appears to be https://github.com/DaGenix/rust-crypto/issues/391 which was never fixed. Unfortunately there does not seem to be much that can be done at the library level as it appears to no longer be maintained.\r\n",
  "closed_by": {
    "login": "paulhauner",
    "id": 6660660,
    "node_id": "MDQ6VXNlcjY2NjA2NjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/paulhauner",
    "html_url": "https://github.com/paulhauner",
    "followers_url": "https://api.github.com/users/paulhauner/followers",
    "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
    "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
    "organizations_url": "https://api.github.com/users/paulhauner/orgs",
    "repos_url": "https://api.github.com/users/paulhauner/repos",
    "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
    "received_events_url": "https://api.github.com/users/paulhauner/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/1242/reactions",
    "total_count": 1,
    "+1": 1,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/1242/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/639172392",
    "html_url": "https://github.com/sigp/lighthouse/issues/1242#issuecomment-639172392",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1242",
    "id": 639172392,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYzOTE3MjM5Mg==",
    "user": {
      "login": "paulhauner",
      "id": 6660660,
      "node_id": "MDQ6VXNlcjY2NjA2NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/paulhauner",
      "html_url": "https://github.com/paulhauner",
      "followers_url": "https://api.github.com/users/paulhauner/followers",
      "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
      "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
      "organizations_url": "https://api.github.com/users/paulhauner/orgs",
      "repos_url": "https://api.github.com/users/paulhauner/repos",
      "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/paulhauner/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-06-04T23:37:49Z",
    "updated_at": "2020-06-04T23:37:49Z",
    "author_association": "MEMBER",
    "body": "Thanks for the detailed report @iridescent86. This does look problematic.\r\n\r\nWe're planning to move away from rust-crypto in the coming week, I hope this will fix this issue as well.\r\n\r\nFor now, I'll mark this as blocked on #1245. Once it's resolved we can come back to this issue and ensure it works.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/639172392/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/686878434",
    "html_url": "https://github.com/sigp/lighthouse/issues/1242#issuecomment-686878434",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/1242",
    "id": 686878434,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY4Njg3ODQzNA==",
    "user": {
      "login": "paulhauner",
      "id": 6660660,
      "node_id": "MDQ6VXNlcjY2NjA2NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/paulhauner",
      "html_url": "https://github.com/paulhauner",
      "followers_url": "https://api.github.com/users/paulhauner/followers",
      "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
      "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
      "organizations_url": "https://api.github.com/users/paulhauner/orgs",
      "repos_url": "https://api.github.com/users/paulhauner/repos",
      "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/paulhauner/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-09-04T03:24:47Z",
    "updated_at": "2020-09-04T03:24:47Z",
    "author_association": "MEMBER",
    "body": "We have replaced `rust-crypto` so this issue has been addressed.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/686878434/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
