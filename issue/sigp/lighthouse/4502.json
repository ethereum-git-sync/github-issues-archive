{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/4502",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/4502/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/4502/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/4502/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/4502",
  "id": 1802453632,
  "node_id": "I_kwDOCFeAzc5rb0KA",
  "number": 4502,
  "title": "[QUESTION] Curious case of state cache",
  "user": {
    "login": "vgorkavenko",
    "id": 32727352,
    "node_id": "MDQ6VXNlcjMyNzI3MzUy",
    "avatar_url": "https://avatars.githubusercontent.com/u/32727352?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/vgorkavenko",
    "html_url": "https://github.com/vgorkavenko",
    "followers_url": "https://api.github.com/users/vgorkavenko/followers",
    "following_url": "https://api.github.com/users/vgorkavenko/following{/other_user}",
    "gists_url": "https://api.github.com/users/vgorkavenko/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/vgorkavenko/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/vgorkavenko/subscriptions",
    "organizations_url": "https://api.github.com/users/vgorkavenko/orgs",
    "repos_url": "https://api.github.com/users/vgorkavenko/repos",
    "events_url": "https://api.github.com/users/vgorkavenko/events{/privacy}",
    "received_events_url": "https://api.github.com/users/vgorkavenko/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2023-07-13T08:11:43Z",
  "updated_at": "2023-07-13T12:15:27Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nWe would like to clarify behaviour of state cache from this [PR](https://github.com/sigp/lighthouse/pull/4228)\r\n\r\nPlease, take a look at this case\r\n\r\n```\r\n     unfinalized              reorg event       finalized\r\n     epoch 100000                  v           epoch 100000\r\n----------|------------------------|----------------|-------------> time\r\n          \r\n          ^                                         ^\r\n  state is requested                          state is requested\r\nresponse cached by slot number        response is equal to cached (0x123...00)\r\n with state data 0x123...00          but should be 0x123...01 after finalization\r\n```\r\n\r\nIs it possible? Even if we request a state by hash\r\n\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/4502/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/4502/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1633780505",
    "html_url": "https://github.com/sigp/lighthouse/issues/4502#issuecomment-1633780505",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4502",
    "id": 1633780505,
    "node_id": "IC_kwDOCFeAzc5hYYMZ",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-13T08:15:56Z",
    "updated_at": "2023-07-13T08:15:56Z",
    "author_association": "MEMBER",
    "body": "Shouldn't be possible. That cache only holds states from the freezer DB which are finalized and can't be reorged. Did you see this in the wild?",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1633780505/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1633792169",
    "html_url": "https://github.com/sigp/lighthouse/issues/4502#issuecomment-1633792169",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4502",
    "id": 1633792169,
    "node_id": "IC_kwDOCFeAzc5hYbCp",
    "user": {
      "login": "vgorkavenko",
      "id": 32727352,
      "node_id": "MDQ6VXNlcjMyNzI3MzUy",
      "avatar_url": "https://avatars.githubusercontent.com/u/32727352?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vgorkavenko",
      "html_url": "https://github.com/vgorkavenko",
      "followers_url": "https://api.github.com/users/vgorkavenko/followers",
      "following_url": "https://api.github.com/users/vgorkavenko/following{/other_user}",
      "gists_url": "https://api.github.com/users/vgorkavenko/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vgorkavenko/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vgorkavenko/subscriptions",
      "organizations_url": "https://api.github.com/users/vgorkavenko/orgs",
      "repos_url": "https://api.github.com/users/vgorkavenko/repos",
      "events_url": "https://api.github.com/users/vgorkavenko/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vgorkavenko/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-13T08:23:54Z",
    "updated_at": "2023-07-13T08:23:54Z",
    "author_association": "NONE",
    "body": "But it depends on `slots_per_restore_point`, am I right?\r\n\r\nWe received inconsistent behavior of finalized state on multiple hosts (4 hosts responded with the same data, and only one of them got it wrong) and are trying to figure out the cause. As soon as we get the details, I'll share them.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1633792169/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1634139433",
    "html_url": "https://github.com/sigp/lighthouse/issues/4502#issuecomment-1634139433",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/4502",
    "id": 1634139433,
    "node_id": "IC_kwDOCFeAzc5hZv0p",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-13T12:15:26Z",
    "updated_at": "2023-07-13T12:15:26Z",
    "author_association": "MEMBER",
    "body": "> But it depends on slots_per_restore_point, am I right?\r\n\r\nYeah, the layout of states on disk depends on `slots-per-restore-point`. The restore points will determine how many blocks get replayed.\r\n\r\n> We received inconsistent behavior of finalized state on multiple hosts (4 hosts responded with the same data, and only one of them got it wrong)\r\n\r\nAh, that sounds like it might be this bug: https://github.com/sigp/lighthouse/issues/3011. We've looked long and hard for the root cause of that bug without finding anything, and to be honest we'll probably never find it. We are in the process of overhauling our database and replacing it with something better, and have an alpha of that here: https://github.com/sigp/lighthouse/releases/tag/v4.2.990-exp. Even though it's experimental, it currently has less known bugs than `stable` due to #3011, so it might be worth adding to your infra.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1634139433/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
