{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/938",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/938/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/938/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/938/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/938",
  "id": 584298490,
  "node_id": "MDU6SXNzdWU1ODQyOTg0OTA=",
  "number": 938,
  "title": "Panic: The next epoch cannot start before now",
  "user": {
    "login": "q9f",
    "id": 58883403,
    "node_id": "MDQ6VXNlcjU4ODgzNDAz",
    "avatar_url": "https://avatars.githubusercontent.com/u/58883403?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/q9f",
    "html_url": "https://github.com/q9f",
    "followers_url": "https://api.github.com/users/q9f/followers",
    "following_url": "https://api.github.com/users/q9f/following{/other_user}",
    "gists_url": "https://api.github.com/users/q9f/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/q9f/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/q9f/subscriptions",
    "organizations_url": "https://api.github.com/users/q9f/orgs",
    "repos_url": "https://api.github.com/users/q9f/repos",
    "events_url": "https://api.github.com/users/q9f/events{/privacy}",
    "received_events_url": "https://api.github.com/users/q9f/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 985647281,
      "node_id": "MDU6TGFiZWw5ODU2NDcyODE=",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/bug",
      "name": "bug",
      "color": "d73a4a",
      "default": true,
      "description": "Something isn't working"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "paulhauner",
    "id": 6660660,
    "node_id": "MDQ6VXNlcjY2NjA2NjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/paulhauner",
    "html_url": "https://github.com/paulhauner",
    "followers_url": "https://api.github.com/users/paulhauner/followers",
    "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
    "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
    "organizations_url": "https://api.github.com/users/paulhauner/orgs",
    "repos_url": "https://api.github.com/users/paulhauner/repos",
    "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
    "received_events_url": "https://api.github.com/users/paulhauner/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "paulhauner",
      "id": 6660660,
      "node_id": "MDQ6VXNlcjY2NjA2NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/paulhauner",
      "html_url": "https://github.com/paulhauner",
      "followers_url": "https://api.github.com/users/paulhauner/followers",
      "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
      "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
      "organizations_url": "https://api.github.com/users/paulhauner/orgs",
      "repos_url": "https://api.github.com/users/paulhauner/repos",
      "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/paulhauner/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2020-03-19T10:08:40Z",
  "updated_at": "2020-04-01T06:40:05Z",
  "closed_at": "2020-04-01T06:40:05Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nThe validator client panicks upon restart.\r\n\r\n## Version\r\n\r\n```\r\n~/.opt/lighthouse testnet5*\r\n❯ git log -n1\r\ncommit 90e456d845bc4b9964f906be59e7a523c998b5c8 (HEAD -> testnet5, origin/testnet5)\r\nMerge: 45e85c8e 394de218\r\nAuthor: Paul Hauner <paul@paulhauner.com>\r\nDate:   Thu Mar 19 00:30:37 2020 +1100\r\n\r\n    Merge branch 'eth1-votes-tree-hash' into testnet5\r\n\r\n~/.opt/lighthouse testnet5*\r\n❯ rustc --version\r\nrustc 1.41.1 (f3e1a954d 2020-02-24)\r\n```\r\n\r\n## Present Behaviour\r\n\r\n```\r\n~/.opt/lighthouse testnet5*\r\n❯ RUST_BACKTRACE=1 ./target/release/lighthouse vc --allow-unsynced\r\nMar 19 11:05:33.898 WARN Ethereum 2.0 is pre-release. This software is experimental.\r\nMar 19 11:05:33.899 INFO Starting validator client               datadir: \"/home/user/.lighthouse/validators\", beacon_node: http://localhost:5052/\r\nMar 19 11:05:33.915 INFO Connected to beacon node                version: Lighthouse/v0.1.0-unstable/x86_64-linux\r\nMar 19 11:05:33.916 INFO Genesis has already occurred            seconds_ago: 72333\r\nMar 19 11:05:33.922 INFO Loaded validator keypair store          voting_validators: 16\r\nthread 'main' panicked at 'The next epoch cannot start before now', src/libcore/option.rs:1188:5\r\nstack backtrace:\r\n   0: backtrace::backtrace::libunwind::trace\r\n             at /cargo/registry/src/github.com-1ecc6299db9ec823/backtrace-0.3.40/src/backtrace/libunwind.rs:88\r\n   1: backtrace::backtrace::trace_unsynchronized\r\n             at /cargo/registry/src/github.com-1ecc6299db9ec823/backtrace-0.3.40/src/backtrace/mod.rs:66\r\n   2: std::sys_common::backtrace::_print_fmt\r\n             at src/libstd/sys_common/backtrace.rs:84\r\n   3: <std::sys_common::backtrace::_print::DisplayBacktrace as core::fmt::Display>::fmt\r\n             at src/libstd/sys_common/backtrace.rs:61\r\n   4: core::fmt::write\r\n             at src/libcore/fmt/mod.rs:1025\r\n   5: std::io::Write::write_fmt\r\n             at src/libstd/io/mod.rs:1426\r\n   6: std::sys_common::backtrace::_print\r\n             at src/libstd/sys_common/backtrace.rs:65\r\n   7: std::sys_common::backtrace::print\r\n             at src/libstd/sys_common/backtrace.rs:50\r\n   8: std::panicking::default_hook::{{closure}}\r\n             at src/libstd/panicking.rs:193\r\n   9: std::panicking::default_hook\r\n             at src/libstd/panicking.rs:210\r\n  10: std::panicking::rust_panic_with_hook\r\n             at src/libstd/panicking.rs:471\r\n  11: rust_begin_unwind\r\n             at src/libstd/panicking.rs:375\r\n  12: core::panicking::panic_fmt\r\n             at src/libcore/panicking.rs:84\r\n  13: core::option::expect_failed\r\n             at src/libcore/option.rs:1188\r\n  14: slot_clock::manual_slot_clock::ManualSlotClock::duration_to_next_epoch_from\r\n  15: <slot_clock::system_time_slot_clock::SystemTimeSlotClock as slot_clock::SlotClock>::duration_to_next_epoch\r\n  16: validator_client::fork_service::ForkService<T,E>::start_update_service\r\n  17: lighthouse::run\r\n  18: lighthouse::main\r\n  19: std::rt::lang_start::{{closure}}\r\n  20: std::rt::lang_start_internal::{{closure}}\r\n             at src/libstd/rt.rs:52\r\n  21: std::panicking::try::do_call\r\n             at src/libstd/panicking.rs:292\r\n  22: __rust_maybe_catch_panic\r\n             at src/libpanic_unwind/lib.rs:78\r\n  23: std::panicking::try\r\n             at src/libstd/panicking.rs:270\r\n  24: std::panic::catch_unwind\r\n             at src/libstd/panic.rs:394\r\n  25: std::rt::lang_start_internal\r\n             at src/libstd/rt.rs:51\r\n  26: main\r\n  27: __libc_start_main\r\n  28: _start\r\nnote: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.\r\n```\r\n\r\n## Expected Behaviour\r\n\r\nIt should not panic and start validating.\r\n\r\n## Steps to resolve\r\n\r\nUnknown.\r\n",
  "closed_by": {
    "login": "paulhauner",
    "id": 6660660,
    "node_id": "MDQ6VXNlcjY2NjA2NjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/paulhauner",
    "html_url": "https://github.com/paulhauner",
    "followers_url": "https://api.github.com/users/paulhauner/followers",
    "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
    "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
    "organizations_url": "https://api.github.com/users/paulhauner/orgs",
    "repos_url": "https://api.github.com/users/paulhauner/repos",
    "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
    "received_events_url": "https://api.github.com/users/paulhauner/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/938/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/938/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/601511809",
    "html_url": "https://github.com/sigp/lighthouse/issues/938#issuecomment-601511809",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/938",
    "id": 601511809,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYwMTUxMTgwOQ==",
    "user": {
      "login": "paulhauner",
      "id": 6660660,
      "node_id": "MDQ6VXNlcjY2NjA2NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/paulhauner",
      "html_url": "https://github.com/paulhauner",
      "followers_url": "https://api.github.com/users/paulhauner/followers",
      "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
      "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
      "organizations_url": "https://api.github.com/users/paulhauner/orgs",
      "repos_url": "https://api.github.com/users/paulhauner/repos",
      "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/paulhauner/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-03-20T03:41:34Z",
    "updated_at": "2020-03-20T03:41:34Z",
    "author_association": "MEMBER",
    "body": "Thanks for raising his @q9f.\r\n\r\nI've done some looking into this and I can only see the following circumstances where this error can be raised:\r\n\r\n### 1. `SECONDS_PER_SLOT == 0`\r\n\r\nIt seems unlikely that this is the case, I doubt you modified this variable. Furthermore, this check protects against that:\r\n\r\nhttps://github.com/sigp/lighthouse/blob/a5fbaef469df221f16b84601e78a83b009e13247/eth2/utils/slot_clock/src/system_time_slot_clock.rs#L17-L19\r\n\r\n### 2. `SLOTS_PER_EPOCH == 0`\r\n\r\nGiven these are hard-coded into the [`EthSpec`](https://github.com/sigp/lighthouse/blob/master/eth2/types/src/eth_spec.rs) trait, I'll assume they have not been modified.\r\n\r\n### 3. Your system time skipped backwards\r\n\r\nPerhaps an NTP sync happened _exactly_ at the wrong moment? This seems quite improbable and it's not a satisfying explanation.\r\n\r\nRegardless, I've [refactored](https://github.com/sigp/lighthouse/pull/929/commits/6ee07d517731053cdf913aa4d650501e260e6995) the code that triggered the panic such that it no longer does two reads of the system clock and therefore could not panic in the same way.\r\n\r\n### 4. `GENESIS_SLOT > 0`\r\n\r\nIt seems unlikely that this was the case. Regardless, the previous refactor will cover this scenario.\r\n\r\n### 5. There's something I missed\r\n\r\nThe previously mentioned refactor improves some code and adds more tests, so hopefully the thing I've missed has been wiped out.\r\n\r\n----\r\n\r\nSo, I've marked #929 to resolve this issue. It's not completely satisfying, but it seems reasonable.\r\n\r\n@q9f it would be good to know if you saw this error more than once. If so, that would make option 3 seem much less likely.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/601511809/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/601610920",
    "html_url": "https://github.com/sigp/lighthouse/issues/938#issuecomment-601610920",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/938",
    "id": 601610920,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYwMTYxMDkyMA==",
    "user": {
      "login": "q9f",
      "id": 58883403,
      "node_id": "MDQ6VXNlcjU4ODgzNDAz",
      "avatar_url": "https://avatars.githubusercontent.com/u/58883403?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/q9f",
      "html_url": "https://github.com/q9f",
      "followers_url": "https://api.github.com/users/q9f/followers",
      "following_url": "https://api.github.com/users/q9f/following{/other_user}",
      "gists_url": "https://api.github.com/users/q9f/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/q9f/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/q9f/subscriptions",
      "organizations_url": "https://api.github.com/users/q9f/orgs",
      "repos_url": "https://api.github.com/users/q9f/repos",
      "events_url": "https://api.github.com/users/q9f/events{/privacy}",
      "received_events_url": "https://api.github.com/users/q9f/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-03-20T09:41:43Z",
    "updated_at": "2020-03-20T09:41:43Z",
    "author_association": "CONTRIBUTOR",
    "body": "> it would be good to know if you saw this error more than once.\r\n\r\nyes, it's reproducable. I compiled `clock-disparity` branch and can confirm #929 fixes the issue :+1:",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/601610920/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 1,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/602451978",
    "html_url": "https://github.com/sigp/lighthouse/issues/938#issuecomment-602451978",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/938",
    "id": 602451978,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYwMjQ1MTk3OA==",
    "user": {
      "login": "paulhauner",
      "id": 6660660,
      "node_id": "MDQ6VXNlcjY2NjA2NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6660660?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/paulhauner",
      "html_url": "https://github.com/paulhauner",
      "followers_url": "https://api.github.com/users/paulhauner/followers",
      "following_url": "https://api.github.com/users/paulhauner/following{/other_user}",
      "gists_url": "https://api.github.com/users/paulhauner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/paulhauner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/paulhauner/subscriptions",
      "organizations_url": "https://api.github.com/users/paulhauner/orgs",
      "repos_url": "https://api.github.com/users/paulhauner/repos",
      "events_url": "https://api.github.com/users/paulhauner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/paulhauner/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-03-23T08:27:09Z",
    "updated_at": "2020-03-23T08:27:09Z",
    "author_association": "MEMBER",
    "body": "> yes, it's reproducable.\r\n\r\nSeems like this is a (5) then, which is a little concerning! Glad that the new code fixed it though.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/602451978/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
