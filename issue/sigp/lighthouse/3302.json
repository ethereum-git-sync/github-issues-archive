{
  "url": "https://api.github.com/repos/sigp/lighthouse/issues/3302",
  "repository_url": "https://api.github.com/repos/sigp/lighthouse",
  "labels_url": "https://api.github.com/repos/sigp/lighthouse/issues/3302/labels{/name}",
  "comments_url": "https://api.github.com/repos/sigp/lighthouse/issues/3302/comments",
  "events_url": "https://api.github.com/repos/sigp/lighthouse/issues/3302/events",
  "html_url": "https://github.com/sigp/lighthouse/issues/3302",
  "id": 1290946256,
  "node_id": "I_kwDOCFeAzc5M8kbQ",
  "number": 3302,
  "title": "VC using excessive memory when using Web3Signer",
  "user": {
    "login": "macladson",
    "id": 58379419,
    "node_id": "MDQ6VXNlcjU4Mzc5NDE5",
    "avatar_url": "https://avatars.githubusercontent.com/u/58379419?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/macladson",
    "html_url": "https://github.com/macladson",
    "followers_url": "https://api.github.com/users/macladson/followers",
    "following_url": "https://api.github.com/users/macladson/following{/other_user}",
    "gists_url": "https://api.github.com/users/macladson/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/macladson/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/macladson/subscriptions",
    "organizations_url": "https://api.github.com/users/macladson/orgs",
    "repos_url": "https://api.github.com/users/macladson/repos",
    "events_url": "https://api.github.com/users/macladson/events{/privacy}",
    "received_events_url": "https://api.github.com/users/macladson/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1245875191,
      "node_id": "MDU6TGFiZWwxMjQ1ODc1MTkx",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/val-client",
      "name": "val-client",
      "color": "9cd6fc",
      "default": false,
      "description": "Relates to the validator client binary"
    },
    {
      "id": 1999784343,
      "node_id": "MDU6TGFiZWwxOTk5Nzg0MzQz",
      "url": "https://api.github.com/repos/sigp/lighthouse/labels/optimization",
      "name": "optimization",
      "color": "f9de40",
      "default": false,
      "description": "Something to make Lighthouse run more efficiently."
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2022-07-01T05:57:39Z",
  "updated_at": "2022-09-08T06:23:08Z",
  "closed_at": "2022-09-08T06:23:07Z",
  "author_association": "COLLABORATOR",
  "active_lock_reason": null,
  "body": "Credit to @jmcruz1983 for discovering.\r\n\r\n## Description\r\n\r\nRunning a validator client using Web3Signer uses significantly more memory than an equivalent local signer.\r\nThe problem becomes more pronounced at higher numbers of validator clients.\r\n\r\nI ran a local network using custom scripts (based on the existing scripts at `scripts/local_testnet` which create 4 validator clients, 3 using local signers and 1 using a web3signer.\r\nScripts can be found here in case anyone wants to run this themselves: https://github.com/macladson/lighthouse/tree/web3signer-local-test\r\n\r\nEven with 200 validators, the effect was pronounced:\r\n~200MB was being used for the VC using the web3signer, but only ~30MB was being used for the other VCs.\r\n\r\nI ran a [heaptrack](https://github.com/KDE/heaptrack) and analyzed the memory profile with help from @michaelsproul.\r\nThe memory allocations appear to be attributed to the `reqwest::Client` which is part of [`SigningMethod`](https://github.com/sigp/lighthouse/blob/unstable/validator_client/src/signing_method.rs#L91).\r\n\r\n[Each validator gets allocated a `SigningMethod`](https://github.com/sigp/lighthouse/blob/unstable/validator_client/src/initialized_validators.rs#L109) so once validator counts reach the 1000s, a significant amount of memory is being used.\r\n\r\n\r\n> Note: It is currently unknown why @jmcruz1983 was seeing reduced memory when building Lighthouse from source (rather than using a pre-built docker image). On my machine, I saw the increase in memory usage even though I was building locally.\r\nAt the very least, the issue seems to be related to the specifics of your configuration when building the binary.\r\n\r\n## Steps to resolve\r\n\r\nAs per the [docuementation for `reqwest::Client`:](https://docs.rs/reqwest/latest/reqwest/struct.Client.html)\r\n> The Client holds a connection pool internally, so it is advised that you create one and reuse it.\r\n\r\n\r\nIf we share the `reqwest::Client` between all the validator instances, we should see a large memory reduction. This seems like the simplest solution to me.\r\n",
  "closed_by": {
    "login": "michaelsproul",
    "id": 4452260,
    "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/michaelsproul",
    "html_url": "https://github.com/michaelsproul",
    "followers_url": "https://api.github.com/users/michaelsproul/followers",
    "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
    "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
    "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
    "repos_url": "https://api.github.com/users/michaelsproul/repos",
    "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
    "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/3302/reactions",
    "total_count": 1,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 1,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/sigp/lighthouse/issues/3302/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1172098514",
    "html_url": "https://github.com/sigp/lighthouse/issues/3302#issuecomment-1172098514",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3302",
    "id": 1172098514,
    "node_id": "IC_kwDOCFeAzc5F3M3S",
    "user": {
      "login": "jmcruz1983",
      "id": 15966694,
      "node_id": "MDQ6VXNlcjE1OTY2Njk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/15966694?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jmcruz1983",
      "html_url": "https://github.com/jmcruz1983",
      "followers_url": "https://api.github.com/users/jmcruz1983/followers",
      "following_url": "https://api.github.com/users/jmcruz1983/following{/other_user}",
      "gists_url": "https://api.github.com/users/jmcruz1983/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jmcruz1983/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jmcruz1983/subscriptions",
      "organizations_url": "https://api.github.com/users/jmcruz1983/orgs",
      "repos_url": "https://api.github.com/users/jmcruz1983/repos",
      "events_url": "https://api.github.com/users/jmcruz1983/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jmcruz1983/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-01T08:45:10Z",
    "updated_at": "2022-07-01T08:45:10Z",
    "author_association": "NONE",
    "body": "Great finding guys!\r\nany idea when this can make it to unstable branch?",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1172098514/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1189732876",
    "html_url": "https://github.com/sigp/lighthouse/issues/3302#issuecomment-1189732876",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3302",
    "id": 1189732876,
    "node_id": "IC_kwDOCFeAzc5G6eIM",
    "user": {
      "login": "macladson",
      "id": 58379419,
      "node_id": "MDQ6VXNlcjU4Mzc5NDE5",
      "avatar_url": "https://avatars.githubusercontent.com/u/58379419?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/macladson",
      "html_url": "https://github.com/macladson",
      "followers_url": "https://api.github.com/users/macladson/followers",
      "following_url": "https://api.github.com/users/macladson/following{/other_user}",
      "gists_url": "https://api.github.com/users/macladson/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/macladson/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/macladson/subscriptions",
      "organizations_url": "https://api.github.com/users/macladson/orgs",
      "repos_url": "https://api.github.com/users/macladson/repos",
      "events_url": "https://api.github.com/users/macladson/events{/privacy}",
      "received_events_url": "https://api.github.com/users/macladson/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-20T02:20:11Z",
    "updated_at": "2022-07-20T02:20:11Z",
    "author_association": "COLLABORATOR",
    "body": "Hi @jmcruz1983, an optimization for the memory usage is now present in `unstable`.\r\nYou will be able to test the changes in the `latest-unstable` or `latest-unstable-modern` docker images.\r\n\r\nIt is also worth noting that the optimization works best when your validators all share a single client identity. If your validators all have unique client identities then you likely won't see any improvements.",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1189732876/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1227968482",
    "html_url": "https://github.com/sigp/lighthouse/issues/3302#issuecomment-1227968482",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3302",
    "id": 1227968482,
    "node_id": "IC_kwDOCFeAzc5JMU_i",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-26T02:17:15Z",
    "updated_at": "2022-08-26T02:17:15Z",
    "author_association": "MEMBER",
    "body": "Hey @jmcruz1983 are you satisfied with the VC memory improvements? Any more issues since updating?",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1227968482/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1228354830",
    "html_url": "https://github.com/sigp/lighthouse/issues/3302#issuecomment-1228354830",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3302",
    "id": 1228354830,
    "node_id": "IC_kwDOCFeAzc5JNzUO",
    "user": {
      "login": "jmcruz1983",
      "id": 15966694,
      "node_id": "MDQ6VXNlcjE1OTY2Njk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/15966694?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jmcruz1983",
      "html_url": "https://github.com/jmcruz1983",
      "followers_url": "https://api.github.com/users/jmcruz1983/followers",
      "following_url": "https://api.github.com/users/jmcruz1983/following{/other_user}",
      "gists_url": "https://api.github.com/users/jmcruz1983/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jmcruz1983/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jmcruz1983/subscriptions",
      "organizations_url": "https://api.github.com/users/jmcruz1983/orgs",
      "repos_url": "https://api.github.com/users/jmcruz1983/repos",
      "events_url": "https://api.github.com/users/jmcruz1983/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jmcruz1983/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-26T10:59:34Z",
    "updated_at": "2022-08-26T11:00:48Z",
    "author_association": "NONE",
    "body": "HI @michaelsproul \r\nyes we are happy with current memory footprint,\r\ngreat improvement since `v2.5.1` & `v3.0.0`\r\n<img width=\"1623\" alt=\"mem usage\" src=\"https://user-images.githubusercontent.com/15966694/186889549-da998320-4a9b-489e-bcf6-d8e55df6c11b.png\">\r\n\r\n\r\nFYI, \r\nthis chart includes tests with internal versions + latest public releases \r\n\r\nThanks!\r\n/Juan",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1228354830/reactions",
      "total_count": 2,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 2,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1240276135",
    "html_url": "https://github.com/sigp/lighthouse/issues/3302#issuecomment-1240276135",
    "issue_url": "https://api.github.com/repos/sigp/lighthouse/issues/3302",
    "id": 1240276135,
    "node_id": "IC_kwDOCFeAzc5J7Ryn",
    "user": {
      "login": "michaelsproul",
      "id": 4452260,
      "node_id": "MDQ6VXNlcjQ0NTIyNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4452260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsproul",
      "html_url": "https://github.com/michaelsproul",
      "followers_url": "https://api.github.com/users/michaelsproul/followers",
      "following_url": "https://api.github.com/users/michaelsproul/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsproul/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsproul/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsproul/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsproul/orgs",
      "repos_url": "https://api.github.com/users/michaelsproul/repos",
      "events_url": "https://api.github.com/users/michaelsproul/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsproul/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-08T06:23:07Z",
    "updated_at": "2022-09-08T06:23:07Z",
    "author_association": "MEMBER",
    "body": "Awesome, I am going to close this issue as resolved!\r\n\r\n@macladson I think we're probably also safe to close https://github.com/sigp/lighthouse/pull/3223, unless you think we might want to merge it anyway?",
    "reactions": {
      "url": "https://api.github.com/repos/sigp/lighthouse/issues/comments/1240276135/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
