{
  "url": "https://api.github.com/repos/ethereum/py-evm/issues/1562",
  "repository_url": "https://api.github.com/repos/ethereum/py-evm",
  "labels_url": "https://api.github.com/repos/ethereum/py-evm/issues/1562/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/py-evm/issues/1562/comments",
  "events_url": "https://api.github.com/repos/ethereum/py-evm/issues/1562/events",
  "html_url": "https://github.com/ethereum/py-evm/issues/1562",
  "id": 388864076,
  "node_id": "MDU6SXNzdWUzODg4NjQwNzY=",
  "number": 1562,
  "title": "test_blockchain_fixtures() works poorly",
  "user": {
    "login": "veox",
    "id": 3036030,
    "node_id": "MDQ6VXNlcjMwMzYwMzA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3036030?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/veox",
    "html_url": "https://github.com/veox",
    "followers_url": "https://api.github.com/users/veox/followers",
    "following_url": "https://api.github.com/users/veox/following{/other_user}",
    "gists_url": "https://api.github.com/users/veox/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/veox/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/veox/subscriptions",
    "organizations_url": "https://api.github.com/users/veox/orgs",
    "repos_url": "https://api.github.com/users/veox/repos",
    "events_url": "https://api.github.com/users/veox/events{/privacy}",
    "received_events_url": "https://api.github.com/users/veox/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2018-12-08T00:42:54Z",
  "updated_at": "2018-12-13T16:51:32Z",
  "closed_at": "2018-12-13T16:51:31Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "* py-evm Version: current `master` (commit b6865d0d615f2eb6d53cdf514e1d8bd2e62f89d2)\r\n* OS: Arch Linux\r\n* Python Version (python --version): 3.7.1\r\n* Environment (output of `pip freeze`): MISSING (sorry!..)\r\n\r\n### What is wrong?\r\n\r\nIn testing for PR #1181 - which spawned PR #1560, and https://github.com/cburgdorf/py-evm/pull/2 in particular - I've done the following ([quote from gitter](https://gitter.im/ethereum/py-evm?at=5c0aee738b656e2b04dc221c)):\r\n\r\n> (...) there's a very handy `verify_account_db()` invocation in `test_blockchain_fixtures()` of `tests/json-fixtures/test_blockchain.py`, which - with a little bit of commenting-out of asserts and checks through a couple files - can be used to easily compare the difference between the upstream test and `py-evm's` result.\r\n> \r\n> Normally, `GeneralStateTests` are skipped in these test runs, to avoid duplication with `tests/json-fixtures/test_state.py`. However, the latter tests are less detailed in their JSON specification - so the comparison trick can't be used.\r\n> \r\n> Using this, [along with increasing the logging level to `5` (trace), ] helps circumvent some guesswork [in debugging externally-provided tests].\r\n\r\n[The test function](https://github.com/ethereum/py-evm/blob/b6865d0d615f2eb6d53cdf514e1d8bd2e62f89d2/tests/json-fixtures/test_blockchain.py#L92), however, works \"poorly\" in general, since it applies `verify_account_db()` unconditionally, and only after it has already applied the blocks (specified in the fixture) that have produced this account-DB-to-be-checked, and has compared the produced blocks (with those in the fixture).\r\n\r\nIn other words:\r\n\r\n> (...) there's no sense in doing these fine-grained state comparisons when [the state root in] the block header already matches. It just slows down the test even more.\r\n\r\nAlso, the `assert` in\r\n\r\nhttps://github.com/ethereum/py-evm/blob/b6865d0d615f2eb6d53cdf514e1d8bd2e62f89d2/tests/json-fixtures/test_blockchain.py#L123-L125\r\n\r\nis never hit, because `apply_fixture_block_to_chain()` has a very similar nested validity check that gets hit in the same conditions - shadowing the `assert`, ~~and terrifying the poor sob debugging this with a single `cytoolz`-/`functools`-obfuscated generic function (aren't these supposed to go on _forever, all the way down_?..)~~.\r\n\r\n\r\n### How can it be fixed\r\n\r\nNot sure about the latter issue, and what \"fixing\" it might break. (Didn't do a `git blame`.)\r\n\r\nRegarding `verify_account_db()`: don't do this in a \"works as expected\" run, but fall back on it if the {block header,state root} check fails. This will become possible when the above is addressed, or if the `chain` is grown without checks against the fixture.\r\n\r\nPerhaps then it would make sense to run _all_ tests from `/BlockchainTests` and not `/GeneralStateTests`... (Not sure.)",
  "closed_by": {
    "login": "veox",
    "id": 3036030,
    "node_id": "MDQ6VXNlcjMwMzYwMzA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3036030?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/veox",
    "html_url": "https://github.com/veox",
    "followers_url": "https://api.github.com/users/veox/followers",
    "following_url": "https://api.github.com/users/veox/following{/other_user}",
    "gists_url": "https://api.github.com/users/veox/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/veox/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/veox/subscriptions",
    "organizations_url": "https://api.github.com/users/veox/orgs",
    "repos_url": "https://api.github.com/users/veox/repos",
    "events_url": "https://api.github.com/users/veox/events{/privacy}",
    "received_events_url": "https://api.github.com/users/veox/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/py-evm/issues/1562/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/py-evm/issues/1562/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/445413889",
    "html_url": "https://github.com/ethereum/py-evm/issues/1562#issuecomment-445413889",
    "issue_url": "https://api.github.com/repos/ethereum/py-evm/issues/1562",
    "id": 445413889,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ0NTQxMzg4OQ==",
    "user": {
      "login": "veox",
      "id": 3036030,
      "node_id": "MDQ6VXNlcjMwMzYwMzA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3036030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/veox",
      "html_url": "https://github.com/veox",
      "followers_url": "https://api.github.com/users/veox/followers",
      "following_url": "https://api.github.com/users/veox/following{/other_user}",
      "gists_url": "https://api.github.com/users/veox/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/veox/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/veox/subscriptions",
      "organizations_url": "https://api.github.com/users/veox/orgs",
      "repos_url": "https://api.github.com/users/veox/repos",
      "events_url": "https://api.github.com/users/veox/events{/privacy}",
      "received_events_url": "https://api.github.com/users/veox/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-12-08T00:47:23Z",
    "updated_at": "2018-12-08T01:51:50Z",
    "author_association": "CONTRIBUTOR",
    "body": "For an example of how this can be useful, see https://github.com/ethereum/py-evm/pull/1181#issuecomment-445359189.\r\n\r\nIn short: it shows exactly what differs between `py-evm` and the externally-provided fixture, which helps narrow down the cause of the failure.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/445413889/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/445989043",
    "html_url": "https://github.com/ethereum/py-evm/issues/1562#issuecomment-445989043",
    "issue_url": "https://api.github.com/repos/ethereum/py-evm/issues/1562",
    "id": 445989043,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ0NTk4OTA0Mw==",
    "user": {
      "login": "veox",
      "id": 3036030,
      "node_id": "MDQ6VXNlcjMwMzYwMzA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3036030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/veox",
      "html_url": "https://github.com/veox",
      "followers_url": "https://api.github.com/users/veox/followers",
      "following_url": "https://api.github.com/users/veox/following{/other_user}",
      "gists_url": "https://api.github.com/users/veox/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/veox/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/veox/subscriptions",
      "organizations_url": "https://api.github.com/users/veox/orgs",
      "repos_url": "https://api.github.com/users/veox/repos",
      "events_url": "https://api.github.com/users/veox/events{/privacy}",
      "received_events_url": "https://api.github.com/users/veox/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-12-10T21:55:27Z",
    "updated_at": "2018-12-10T21:55:27Z",
    "author_association": "CONTRIBUTOR",
    "body": "Here's a gist that demonstrates how I slap this together currently (via `git stash`):\r\n\r\nhttps://gist.github.com/veox/5874314b11cb731e69256c0bd451c88c\r\n\r\n(Note that some changes are part of https://github.com/cburgdorf/py-evm/pull/2.)",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/445989043/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 1,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/446096818",
    "html_url": "https://github.com/ethereum/py-evm/issues/1562#issuecomment-446096818",
    "issue_url": "https://api.github.com/repos/ethereum/py-evm/issues/1562",
    "id": 446096818,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ0NjA5NjgxOA==",
    "user": {
      "login": "lithp",
      "id": 466333,
      "node_id": "MDQ6VXNlcjQ2NjMzMw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/466333?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/lithp",
      "html_url": "https://github.com/lithp",
      "followers_url": "https://api.github.com/users/lithp/followers",
      "following_url": "https://api.github.com/users/lithp/following{/other_user}",
      "gists_url": "https://api.github.com/users/lithp/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/lithp/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/lithp/subscriptions",
      "organizations_url": "https://api.github.com/users/lithp/orgs",
      "repos_url": "https://api.github.com/users/lithp/repos",
      "events_url": "https://api.github.com/users/lithp/events{/privacy}",
      "received_events_url": "https://api.github.com/users/lithp/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-12-11T07:14:47Z",
    "updated_at": "2018-12-11T07:14:47Z",
    "author_association": "MEMBER",
    "body": "This is awesome! I played with the gist and ended up with #1573\r\n\r\nI think it makes sense to only run `BlockchainTests` and drop `GeneralStateTests`; they're perfect duplicates except one is easier to debug. They test more and are consequently a little slower, unfortunately.\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/446096818/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/446371244",
    "html_url": "https://github.com/ethereum/py-evm/issues/1562#issuecomment-446371244",
    "issue_url": "https://api.github.com/repos/ethereum/py-evm/issues/1562",
    "id": 446371244,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ0NjM3MTI0NA==",
    "user": {
      "login": "carver",
      "id": 205327,
      "node_id": "MDQ6VXNlcjIwNTMyNw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/205327?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/carver",
      "html_url": "https://github.com/carver",
      "followers_url": "https://api.github.com/users/carver/followers",
      "following_url": "https://api.github.com/users/carver/following{/other_user}",
      "gists_url": "https://api.github.com/users/carver/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/carver/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/carver/subscriptions",
      "organizations_url": "https://api.github.com/users/carver/orgs",
      "repos_url": "https://api.github.com/users/carver/repos",
      "events_url": "https://api.github.com/users/carver/events{/privacy}",
      "received_events_url": "https://api.github.com/users/carver/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-12-11T21:36:45Z",
    "updated_at": "2018-12-11T21:36:45Z",
    "author_association": "MEMBER",
    "body": "Another possibility for *why* we were using the global state tests is that we were running state tests before we even had code that was able to import blocks. ie~ EVM execution was being tested before chain structure, which makes sense to me from an ordering point of view.\r\n\r\nIf that were true, then we only needed the global state tests for bootstrapping, so we could switch to the blockchain state tests.\r\n\r\nIn general, I can't think of a reason why we can't use the ones inside blockchain tests right now. (Only that a block import failure would cause \"false test failures\" in state tests, which is a pretty minor problem I think)\r\n\r\n---\r\n\r\nMostly unrelated: I can't think of a reason that `ethereum/tests` couldn't copy the `postState` into the other state test jsons, as well. That would help the next brand new client to get started, I expect.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/446371244/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/447040541",
    "html_url": "https://github.com/ethereum/py-evm/issues/1562#issuecomment-447040541",
    "issue_url": "https://api.github.com/repos/ethereum/py-evm/issues/1562",
    "id": 447040541,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ0NzA0MDU0MQ==",
    "user": {
      "login": "veox",
      "id": 3036030,
      "node_id": "MDQ6VXNlcjMwMzYwMzA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3036030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/veox",
      "html_url": "https://github.com/veox",
      "followers_url": "https://api.github.com/users/veox/followers",
      "following_url": "https://api.github.com/users/veox/following{/other_user}",
      "gists_url": "https://api.github.com/users/veox/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/veox/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/veox/subscriptions",
      "organizations_url": "https://api.github.com/users/veox/orgs",
      "repos_url": "https://api.github.com/users/veox/repos",
      "events_url": "https://api.github.com/users/veox/events{/privacy}",
      "received_events_url": "https://api.github.com/users/veox/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-12-13T16:51:31Z",
    "updated_at": "2018-12-13T16:51:31Z",
    "author_association": "CONTRIBUTOR",
    "body": "I think this can be closed as fixed by PR #1573.\r\n\r\nRespond if I'm missing something, will reopen.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/447040541/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
