{
  "url": "https://api.github.com/repos/ethereum/py-evm/issues/1102",
  "repository_url": "https://api.github.com/repos/ethereum/py-evm",
  "labels_url": "https://api.github.com/repos/ethereum/py-evm/issues/1102/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/py-evm/issues/1102/comments",
  "events_url": "https://api.github.com/repos/ethereum/py-evm/issues/1102/events",
  "html_url": "https://github.com/ethereum/py-evm/issues/1102",
  "id": 345034332,
  "node_id": "MDU6SXNzdWUzNDUwMzQzMzI=",
  "number": 1102,
  "title": "Experiment with batching db writes and using a local cache",
  "user": {
    "login": "pipermerriam",
    "id": 824194,
    "node_id": "MDQ6VXNlcjgyNDE5NA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/824194?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/pipermerriam",
    "html_url": "https://github.com/pipermerriam",
    "followers_url": "https://api.github.com/users/pipermerriam/followers",
    "following_url": "https://api.github.com/users/pipermerriam/following{/other_user}",
    "gists_url": "https://api.github.com/users/pipermerriam/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/pipermerriam/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/pipermerriam/subscriptions",
    "organizations_url": "https://api.github.com/users/pipermerriam/orgs",
    "repos_url": "https://api.github.com/users/pipermerriam/repos",
    "events_url": "https://api.github.com/users/pipermerriam/events{/privacy}",
    "received_events_url": "https://api.github.com/users/pipermerriam/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 631592722,
      "node_id": "MDU6TGFiZWw2MzE1OTI3MjI=",
      "url": "https://api.github.com/repos/ethereum/py-evm/labels/Good%20First%20Issue",
      "name": "Good First Issue",
      "color": "0e8a16",
      "default": false,
      "description": null
    },
    {
      "id": 815420353,
      "node_id": "MDU6TGFiZWw4MTU0MjAzNTM=",
      "url": "https://api.github.com/repos/ethereum/py-evm/labels/comp:%20trinity",
      "name": "comp: trinity",
      "color": "bfd4f2",
      "default": false,
      "description": ""
    },
    {
      "id": 983615043,
      "node_id": "MDU6TGFiZWw5ODM2MTUwNDM=",
      "url": "https://api.github.com/repos/ethereum/py-evm/labels/type:%20performance",
      "name": "type: performance",
      "color": "eeeeee",
      "default": false,
      "description": ""
    },
    {
      "id": 983628532,
      "node_id": "MDU6TGFiZWw5ODM2Mjg1MzI=",
      "url": "https://api.github.com/repos/ethereum/py-evm/labels/prio:%20P4%20nice%20to%20have",
      "name": "prio: P4 nice to have",
      "color": "fef2c0",
      "default": false,
      "description": ""
    },
    {
      "id": 983629570,
      "node_id": "MDU6TGFiZWw5ODM2Mjk1NzA=",
      "url": "https://api.github.com/repos/ethereum/py-evm/labels/effort:%20E1%20hours",
      "name": "effort: E1 hours",
      "color": "bfe5bf",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 7,
  "created_at": "2018-07-26T23:02:24Z",
  "updated_at": "2018-07-31T20:44:59Z",
  "closed_at": "2018-07-31T20:44:59Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "### What is wrong?\r\n\r\nAccording to some basic analysis the number of transactions in a block is responsible for most of the time it takes to process that block.\r\n\r\nIt would be interesting to see what kind of difference it makes to use the [batch writing API](https://plyvel.readthedocs.io/en/latest/user.html#write-batches) to reduce the number of times that we have to write directly to LevelDB.\r\n\r\n### How can it be fixed\r\n\r\nWe could put a thin cache on top of the database within the database process, and have a periodic task that writes data from the cache into the database either when the cache reaches a certain size or after a set amount of time (ideally whichever comes first).",
  "closed_by": {
    "login": "pipermerriam",
    "id": 824194,
    "node_id": "MDQ6VXNlcjgyNDE5NA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/824194?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/pipermerriam",
    "html_url": "https://github.com/pipermerriam",
    "followers_url": "https://api.github.com/users/pipermerriam/followers",
    "following_url": "https://api.github.com/users/pipermerriam/following{/other_user}",
    "gists_url": "https://api.github.com/users/pipermerriam/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/pipermerriam/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/pipermerriam/subscriptions",
    "organizations_url": "https://api.github.com/users/pipermerriam/orgs",
    "repos_url": "https://api.github.com/users/pipermerriam/repos",
    "events_url": "https://api.github.com/users/pipermerriam/events{/privacy}",
    "received_events_url": "https://api.github.com/users/pipermerriam/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/py-evm/issues/1102/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/py-evm/issues/1102/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/408261369",
    "html_url": "https://github.com/ethereum/py-evm/issues/1102#issuecomment-408261369",
    "issue_url": "https://api.github.com/repos/ethereum/py-evm/issues/1102",
    "id": 408261369,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQwODI2MTM2OQ==",
    "user": {
      "login": "pipermerriam",
      "id": 824194,
      "node_id": "MDQ6VXNlcjgyNDE5NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/824194?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pipermerriam",
      "html_url": "https://github.com/pipermerriam",
      "followers_url": "https://api.github.com/users/pipermerriam/followers",
      "following_url": "https://api.github.com/users/pipermerriam/following{/other_user}",
      "gists_url": "https://api.github.com/users/pipermerriam/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pipermerriam/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pipermerriam/subscriptions",
      "organizations_url": "https://api.github.com/users/pipermerriam/orgs",
      "repos_url": "https://api.github.com/users/pipermerriam/repos",
      "events_url": "https://api.github.com/users/pipermerriam/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pipermerriam/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-07-26T23:03:59Z",
    "updated_at": "2018-07-26T23:03:59Z",
    "author_association": "MEMBER",
    "body": "If someone picks this up i can provide you with a database dump of the chain data dir at around block 4,900,000 which is where transaction counts get consistently high (and sync times slow down).",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/408261369/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/408728266",
    "html_url": "https://github.com/ethereum/py-evm/issues/1102#issuecomment-408728266",
    "issue_url": "https://api.github.com/repos/ethereum/py-evm/issues/1102",
    "id": 408728266,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQwODcyODI2Ng==",
    "user": {
      "login": "waprin",
      "id": 1075173,
      "node_id": "MDQ6VXNlcjEwNzUxNzM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1075173?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/waprin",
      "html_url": "https://github.com/waprin",
      "followers_url": "https://api.github.com/users/waprin/followers",
      "following_url": "https://api.github.com/users/waprin/following{/other_user}",
      "gists_url": "https://api.github.com/users/waprin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/waprin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/waprin/subscriptions",
      "organizations_url": "https://api.github.com/users/waprin/orgs",
      "repos_url": "https://api.github.com/users/waprin/repos",
      "events_url": "https://api.github.com/users/waprin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/waprin/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-07-30T02:17:30Z",
    "updated_at": "2018-07-30T02:17:30Z",
    "author_association": "NONE",
    "body": "I'd be interested in looking into this (though note I'm a newb with ethereum and this project so no big deal if someone gets it done before me, since it might take me a while to get caught up). \r\n\r\nWhat's the easiest way for me to get the dump? (also how big is it?)",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/408728266/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/408734526",
    "html_url": "https://github.com/ethereum/py-evm/issues/1102#issuecomment-408734526",
    "issue_url": "https://api.github.com/repos/ethereum/py-evm/issues/1102",
    "id": 408734526,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQwODczNDUyNg==",
    "user": {
      "login": "pipermerriam",
      "id": 824194,
      "node_id": "MDQ6VXNlcjgyNDE5NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/824194?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pipermerriam",
      "html_url": "https://github.com/pipermerriam",
      "followers_url": "https://api.github.com/users/pipermerriam/followers",
      "following_url": "https://api.github.com/users/pipermerriam/following{/other_user}",
      "gists_url": "https://api.github.com/users/pipermerriam/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pipermerriam/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pipermerriam/subscriptions",
      "organizations_url": "https://api.github.com/users/pipermerriam/orgs",
      "repos_url": "https://api.github.com/users/pipermerriam/repos",
      "events_url": "https://api.github.com/users/pipermerriam/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pipermerriam/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-07-30T03:09:55Z",
    "updated_at": "2018-07-30T03:09:55Z",
    "author_association": "MEMBER",
    "body": "@waprin 50gb, drop me private message on gitter and I'll send you a link to download the dump from.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/408734526/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/408784767",
    "html_url": "https://github.com/ethereum/py-evm/issues/1102#issuecomment-408784767",
    "issue_url": "https://api.github.com/repos/ethereum/py-evm/issues/1102",
    "id": 408784767,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQwODc4NDc2Nw==",
    "user": {
      "login": "gsalgado",
      "id": 412274,
      "node_id": "MDQ6VXNlcjQxMjI3NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/412274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gsalgado",
      "html_url": "https://github.com/gsalgado",
      "followers_url": "https://api.github.com/users/gsalgado/followers",
      "following_url": "https://api.github.com/users/gsalgado/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsalgado/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gsalgado/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsalgado/subscriptions",
      "organizations_url": "https://api.github.com/users/gsalgado/orgs",
      "repos_url": "https://api.github.com/users/gsalgado/repos",
      "events_url": "https://api.github.com/users/gsalgado/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gsalgado/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-07-30T08:19:14Z",
    "updated_at": "2018-07-30T08:19:14Z",
    "author_association": "MEMBER",
    "body": "ISTM you're talking only about fast-sync here? During a fast-sync, all we do is download the block bodies (transactions, uncles, receipts) and store them in the DB, so yeah, the # of transactions is the main thing that will affect how fast we can import blocks during a fast sync. For someone looking into this, a good starting point would be `eth.db.trie.make_trie_root_and_nodes()` and `BaseChainDB.persist_trie_data_dict()`, and the latter is where I think it'd make sense to use the batching API",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/408784767/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/408931309",
    "html_url": "https://github.com/ethereum/py-evm/issues/1102#issuecomment-408931309",
    "issue_url": "https://api.github.com/repos/ethereum/py-evm/issues/1102",
    "id": 408931309,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQwODkzMTMwOQ==",
    "user": {
      "login": "pipermerriam",
      "id": 824194,
      "node_id": "MDQ6VXNlcjgyNDE5NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/824194?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pipermerriam",
      "html_url": "https://github.com/pipermerriam",
      "followers_url": "https://api.github.com/users/pipermerriam/followers",
      "following_url": "https://api.github.com/users/pipermerriam/following{/other_user}",
      "gists_url": "https://api.github.com/users/pipermerriam/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pipermerriam/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pipermerriam/subscriptions",
      "organizations_url": "https://api.github.com/users/pipermerriam/orgs",
      "repos_url": "https://api.github.com/users/pipermerriam/repos",
      "events_url": "https://api.github.com/users/pipermerriam/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pipermerriam/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-07-30T16:45:42Z",
    "updated_at": "2018-07-30T16:45:42Z",
    "author_association": "MEMBER",
    "body": "https://github.com/ethereum/py-evm/blob/653d563234b5722b9da880cc1f7e6f9ced14d721/eth/db/chain.py#L281\r\n\r\nI believe this also produces an `O(n)` amount of writes during fast sync.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/408931309/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/409143576",
    "html_url": "https://github.com/ethereum/py-evm/issues/1102#issuecomment-409143576",
    "issue_url": "https://api.github.com/repos/ethereum/py-evm/issues/1102",
    "id": 409143576,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQwOTE0MzU3Ng==",
    "user": {
      "login": "gsalgado",
      "id": 412274,
      "node_id": "MDQ6VXNlcjQxMjI3NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/412274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gsalgado",
      "html_url": "https://github.com/gsalgado",
      "followers_url": "https://api.github.com/users/gsalgado/followers",
      "following_url": "https://api.github.com/users/gsalgado/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsalgado/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gsalgado/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsalgado/subscriptions",
      "organizations_url": "https://api.github.com/users/gsalgado/orgs",
      "repos_url": "https://api.github.com/users/gsalgado/repos",
      "events_url": "https://api.github.com/users/gsalgado/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gsalgado/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-07-31T08:42:41Z",
    "updated_at": "2018-07-31T08:42:41Z",
    "author_association": "MEMBER",
    "body": "I'm gathering some profiling stats for fast-sync and although I'm doing so on a 34GB ropsten DB, I believe this is relevant as it suggests optimizing our DB access may not yield any significant performance improvements as the time taken to persist the data is insignificant when compared to the time taken to generate the tries. \r\n\r\n```\r\n    1827    0.050    0.000   44.991    0.025 trie.py:16(make_trie_root_and_nodes)\r\n    ...\r\n    43213    0.603    0.000    0.603    0.000 {method 'put' of 'plyvel._plyvel.DB' objects}\r\n     1704    0.072    0.000    0.601    0.000 chain.py:475(persist_trie_data_dict)\r\n```\r\n\r\n@pipermerriam if you want to get the stats for a run against the mainnet DB you can simply run `python -m p2p.chain -fast -db </path/to/trinity/chain/db> -enode <your-local-geth>`",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/409143576/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 1,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/409361628",
    "html_url": "https://github.com/ethereum/py-evm/issues/1102#issuecomment-409361628",
    "issue_url": "https://api.github.com/repos/ethereum/py-evm/issues/1102",
    "id": 409361628,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQwOTM2MTYyOA==",
    "user": {
      "login": "pipermerriam",
      "id": 824194,
      "node_id": "MDQ6VXNlcjgyNDE5NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/824194?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pipermerriam",
      "html_url": "https://github.com/pipermerriam",
      "followers_url": "https://api.github.com/users/pipermerriam/followers",
      "following_url": "https://api.github.com/users/pipermerriam/following{/other_user}",
      "gists_url": "https://api.github.com/users/pipermerriam/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pipermerriam/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pipermerriam/subscriptions",
      "organizations_url": "https://api.github.com/users/pipermerriam/orgs",
      "repos_url": "https://api.github.com/users/pipermerriam/repos",
      "events_url": "https://api.github.com/users/pipermerriam/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pipermerriam/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-07-31T20:44:57Z",
    "updated_at": "2018-07-31T20:44:57Z",
    "author_association": "MEMBER",
    "body": "Alright, I'm going to close this for now.  Thanks for doing the work to actually measure this :smiley: ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/409361628/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
