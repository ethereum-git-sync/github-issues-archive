{
  "url": "https://api.github.com/repos/ethereum/py-evm/issues/986",
  "repository_url": "https://api.github.com/repos/ethereum/py-evm",
  "labels_url": "https://api.github.com/repos/ethereum/py-evm/issues/986/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/py-evm/issues/986/comments",
  "events_url": "https://api.github.com/repos/ethereum/py-evm/issues/986/events",
  "html_url": "https://github.com/ethereum/py-evm/issues/986",
  "id": 338163255,
  "node_id": "MDU6SXNzdWUzMzgxNjMyNTU=",
  "number": 986,
  "title": "Allowing multiple peer subscribers can be problematic",
  "user": {
    "login": "gsalgado",
    "id": 412274,
    "node_id": "MDQ6VXNlcjQxMjI3NA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/412274?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/gsalgado",
    "html_url": "https://github.com/gsalgado",
    "followers_url": "https://api.github.com/users/gsalgado/followers",
    "following_url": "https://api.github.com/users/gsalgado/following{/other_user}",
    "gists_url": "https://api.github.com/users/gsalgado/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/gsalgado/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/gsalgado/subscriptions",
    "organizations_url": "https://api.github.com/users/gsalgado/orgs",
    "repos_url": "https://api.github.com/users/gsalgado/repos",
    "events_url": "https://api.github.com/users/gsalgado/events{/privacy}",
    "received_events_url": "https://api.github.com/users/gsalgado/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 889922027,
      "node_id": "MDU6TGFiZWw4ODk5MjIwMjc=",
      "url": "https://api.github.com/repos/ethereum/py-evm/labels/comp:%20p2p",
      "name": "comp: p2p",
      "color": "bfd4f2",
      "default": false,
      "description": ""
    },
    {
      "id": 983616278,
      "node_id": "MDU6TGFiZWw5ODM2MTYyNzg=",
      "url": "https://api.github.com/repos/ethereum/py-evm/labels/type:%20RFC%20/%20discussion%20/%20question",
      "name": "type: RFC / discussion / question",
      "color": "eeeeee",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2018-07-04T07:40:04Z",
  "updated_at": "2018-08-13T16:39:56Z",
  "closed_at": "2018-08-13T16:39:56Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "### What is wrong?\r\n\r\nA `p2p.Peer` can have multiple subscribers, and each of them will get a copy of every msg sent by the remote (which allows us to have separate services handling different subsets of messages), but that can be problematic if both subscribers request/process the same type of data as the data requested by one subscriber will be delivered to the other as well, and might interfere other's operation.\r\n\r\nAs an example, we currently have `LightChainSyncer` and `LightPeerChain` as peer subscribers when we run a light node, and they can both request/process `BlockHeader`s, and if the latter requests some headers while the former is in the middle of a sync with a peer, it may try to validate/process those headers and if that fails (which can happen when the headers are further ahead of our local chain head), it will cause the sync with that peer to be aborted. Although this is not that big a deal given that another sync will be triggered as soon as one of our peers notify us of a new block, it is something we need to be aware of. And we must consider other cases where similar issues might happen\r\n\r\nThe above can be seen in practice when running `tests/p2p/test_lightchain_integration.py` as it requests the remote's head (via `LightPeerChain`) while `LightChainSyncer` is in the middle of a sync, which causes the sync to be aborted.\r\n\r\n### How can it be fixed\r\n\r\nIn the case above, it could be fixed by having `LightChainSyncer` keep the `request_id`s used in the `GetBlockHeader` requests sent by itself and only processing the replies for those, but that won't work for services using the `ETH` protocols because there the requests don't include a `request_id`\r\n\r\nI need to think more about this, just writing it down now so I don't forget about it",
  "closed_by": {
    "login": "pipermerriam",
    "id": 824194,
    "node_id": "MDQ6VXNlcjgyNDE5NA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/824194?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/pipermerriam",
    "html_url": "https://github.com/pipermerriam",
    "followers_url": "https://api.github.com/users/pipermerriam/followers",
    "following_url": "https://api.github.com/users/pipermerriam/following{/other_user}",
    "gists_url": "https://api.github.com/users/pipermerriam/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/pipermerriam/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/pipermerriam/subscriptions",
    "organizations_url": "https://api.github.com/users/pipermerriam/orgs",
    "repos_url": "https://api.github.com/users/pipermerriam/repos",
    "events_url": "https://api.github.com/users/pipermerriam/events{/privacy}",
    "received_events_url": "https://api.github.com/users/pipermerriam/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/py-evm/issues/986/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/py-evm/issues/986/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/412512728",
    "html_url": "https://github.com/ethereum/py-evm/issues/986#issuecomment-412512728",
    "issue_url": "https://api.github.com/repos/ethereum/py-evm/issues/986",
    "id": 412512728,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQxMjUxMjcyOA==",
    "user": {
      "login": "gsalgado",
      "id": 412274,
      "node_id": "MDQ6VXNlcjQxMjI3NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/412274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gsalgado",
      "html_url": "https://github.com/gsalgado",
      "followers_url": "https://api.github.com/users/gsalgado/followers",
      "following_url": "https://api.github.com/users/gsalgado/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsalgado/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gsalgado/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsalgado/subscriptions",
      "organizations_url": "https://api.github.com/users/gsalgado/orgs",
      "repos_url": "https://api.github.com/users/gsalgado/repos",
      "events_url": "https://api.github.com/users/gsalgado/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gsalgado/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-08-13T13:11:49Z",
    "updated_at": "2018-08-13T13:11:49Z",
    "author_association": "MEMBER",
    "body": "@pipermerriam is this still an issue, with the subscription and round-trip request/response changes you've made recently?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/412512728/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/412583010",
    "html_url": "https://github.com/ethereum/py-evm/issues/986#issuecomment-412583010",
    "issue_url": "https://api.github.com/repos/ethereum/py-evm/issues/986",
    "id": 412583010,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQxMjU4MzAxMA==",
    "user": {
      "login": "pipermerriam",
      "id": 824194,
      "node_id": "MDQ6VXNlcjgyNDE5NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/824194?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pipermerriam",
      "html_url": "https://github.com/pipermerriam",
      "followers_url": "https://api.github.com/users/pipermerriam/followers",
      "following_url": "https://api.github.com/users/pipermerriam/following{/other_user}",
      "gists_url": "https://api.github.com/users/pipermerriam/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pipermerriam/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pipermerriam/subscriptions",
      "organizations_url": "https://api.github.com/users/pipermerriam/orgs",
      "repos_url": "https://api.github.com/users/pipermerriam/repos",
      "events_url": "https://api.github.com/users/pipermerriam/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pipermerriam/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-08-13T16:39:56Z",
    "updated_at": "2018-08-13T16:39:56Z",
    "author_association": "MEMBER",
    "body": "I don't think so.  closing.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/412583010/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
