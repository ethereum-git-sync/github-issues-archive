{
  "url": "https://api.github.com/repos/ethereum/py-evm/issues/337",
  "repository_url": "https://api.github.com/repos/ethereum/py-evm",
  "labels_url": "https://api.github.com/repos/ethereum/py-evm/issues/337/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/py-evm/issues/337/comments",
  "events_url": "https://api.github.com/repos/ethereum/py-evm/issues/337/events",
  "html_url": "https://github.com/ethereum/py-evm/issues/337",
  "id": 293305700,
  "node_id": "MDU6SXNzdWUyOTMzMDU3MDA=",
  "number": 337,
  "title": "BaseChainDB no longer supports a header-only DB",
  "user": {
    "login": "gsalgado",
    "id": 412274,
    "node_id": "MDQ6VXNlcjQxMjI3NA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/412274?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/gsalgado",
    "html_url": "https://github.com/gsalgado",
    "followers_url": "https://api.github.com/users/gsalgado/followers",
    "following_url": "https://api.github.com/users/gsalgado/following{/other_user}",
    "gists_url": "https://api.github.com/users/gsalgado/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/gsalgado/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/gsalgado/subscriptions",
    "organizations_url": "https://api.github.com/users/gsalgado/orgs",
    "repos_url": "https://api.github.com/users/gsalgado/repos",
    "events_url": "https://api.github.com/users/gsalgado/events{/privacy}",
    "received_events_url": "https://api.github.com/users/gsalgado/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 815420353,
      "node_id": "MDU6TGFiZWw4MTU0MjAzNTM=",
      "url": "https://api.github.com/repos/ethereum/py-evm/labels/comp:%20trinity",
      "name": "comp: trinity",
      "color": "bfd4f2",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 7,
  "created_at": "2018-01-31T20:46:53Z",
  "updated_at": "2018-07-12T08:39:43Z",
  "closed_at": "2018-07-12T08:39:43Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "### What is wrong?\r\n\r\n`BaseChainDB._set_as_canonical_chain_head()` now expects the DB to contain transactions as well, and that breaks `LightChain` since it only syncs headers.\r\n\r\nWhen there's a chain reorg, that method will try to [remove tx lookups from the DB](https://github.com/ethereum/py-evm/blob/master/evm/db/chain.py#L108-L110), but that crashes because we have no transactions in the DB",
  "closed_by": {
    "login": "gsalgado",
    "id": 412274,
    "node_id": "MDQ6VXNlcjQxMjI3NA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/412274?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/gsalgado",
    "html_url": "https://github.com/gsalgado",
    "followers_url": "https://api.github.com/users/gsalgado/followers",
    "following_url": "https://api.github.com/users/gsalgado/following{/other_user}",
    "gists_url": "https://api.github.com/users/gsalgado/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/gsalgado/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/gsalgado/subscriptions",
    "organizations_url": "https://api.github.com/users/gsalgado/orgs",
    "repos_url": "https://api.github.com/users/gsalgado/repos",
    "events_url": "https://api.github.com/users/gsalgado/events{/privacy}",
    "received_events_url": "https://api.github.com/users/gsalgado/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/py-evm/issues/337/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/py-evm/issues/337/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/362066247",
    "html_url": "https://github.com/ethereum/py-evm/issues/337#issuecomment-362066247",
    "issue_url": "https://api.github.com/repos/ethereum/py-evm/issues/337",
    "id": 362066247,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM2MjA2NjI0Nw==",
    "user": {
      "login": "gsalgado",
      "id": 412274,
      "node_id": "MDQ6VXNlcjQxMjI3NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/412274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gsalgado",
      "html_url": "https://github.com/gsalgado",
      "followers_url": "https://api.github.com/users/gsalgado/followers",
      "following_url": "https://api.github.com/users/gsalgado/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsalgado/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gsalgado/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsalgado/subscriptions",
      "organizations_url": "https://api.github.com/users/gsalgado/orgs",
      "repos_url": "https://api.github.com/users/gsalgado/repos",
      "events_url": "https://api.github.com/users/gsalgado/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gsalgado/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-01-31T20:50:53Z",
    "updated_at": "2018-01-31T20:50:53Z",
    "author_association": "MEMBER",
    "body": "Looks like this was introduced in #260",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/362066247/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/362086564",
    "html_url": "https://github.com/ethereum/py-evm/issues/337#issuecomment-362086564",
    "issue_url": "https://api.github.com/repos/ethereum/py-evm/issues/337",
    "id": 362086564,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM2MjA4NjU2NA==",
    "user": {
      "login": "pipermerriam",
      "id": 824194,
      "node_id": "MDQ6VXNlcjgyNDE5NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/824194?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pipermerriam",
      "html_url": "https://github.com/pipermerriam",
      "followers_url": "https://api.github.com/users/pipermerriam/followers",
      "following_url": "https://api.github.com/users/pipermerriam/following{/other_user}",
      "gists_url": "https://api.github.com/users/pipermerriam/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pipermerriam/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pipermerriam/subscriptions",
      "organizations_url": "https://api.github.com/users/pipermerriam/orgs",
      "repos_url": "https://api.github.com/users/pipermerriam/repos",
      "events_url": "https://api.github.com/users/pipermerriam/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pipermerriam/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-01-31T22:04:51Z",
    "updated_at": "2018-01-31T22:04:51Z",
    "author_association": "MEMBER",
    "body": "Thoughts on using different chaindb classes for light and full chains?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/362086564/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/362086611",
    "html_url": "https://github.com/ethereum/py-evm/issues/337#issuecomment-362086611",
    "issue_url": "https://api.github.com/repos/ethereum/py-evm/issues/337",
    "id": 362086611,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM2MjA4NjYxMQ==",
    "user": {
      "login": "pipermerriam",
      "id": 824194,
      "node_id": "MDQ6VXNlcjgyNDE5NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/824194?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pipermerriam",
      "html_url": "https://github.com/pipermerriam",
      "followers_url": "https://api.github.com/users/pipermerriam/followers",
      "following_url": "https://api.github.com/users/pipermerriam/following{/other_user}",
      "gists_url": "https://api.github.com/users/pipermerriam/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pipermerriam/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pipermerriam/subscriptions",
      "organizations_url": "https://api.github.com/users/pipermerriam/orgs",
      "repos_url": "https://api.github.com/users/pipermerriam/repos",
      "events_url": "https://api.github.com/users/pipermerriam/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pipermerriam/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-01-31T22:05:01Z",
    "updated_at": "2018-01-31T22:05:01Z",
    "author_association": "MEMBER",
    "body": "cc @carver ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/362086611/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/362106646",
    "html_url": "https://github.com/ethereum/py-evm/issues/337#issuecomment-362106646",
    "issue_url": "https://api.github.com/repos/ethereum/py-evm/issues/337",
    "id": 362106646,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM2MjEwNjY0Ng==",
    "user": {
      "login": "carver",
      "id": 205327,
      "node_id": "MDQ6VXNlcjIwNTMyNw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/205327?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/carver",
      "html_url": "https://github.com/carver",
      "followers_url": "https://api.github.com/users/carver/followers",
      "following_url": "https://api.github.com/users/carver/following{/other_user}",
      "gists_url": "https://api.github.com/users/carver/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/carver/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/carver/subscriptions",
      "organizations_url": "https://api.github.com/users/carver/orgs",
      "repos_url": "https://api.github.com/users/carver/repos",
      "events_url": "https://api.github.com/users/carver/events{/privacy}",
      "received_events_url": "https://api.github.com/users/carver/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-01-31T23:31:38Z",
    "updated_at": "2018-01-31T23:31:38Z",
    "author_association": "MEMBER",
    "body": "> Thoughts on using different chaindb classes for light and full chains?\r\n\r\nFirst impression: :+1: . This seems like the first of many things that will be different about what they expect to have in storage.\r\n\r\nIf this was the only difference, I might say we just make this a `remove_or_noop`. There's not really a great reason to crash here when trying to delete a missing transaction, besides catching errors early in debugging.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/362106646/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/362188335",
    "html_url": "https://github.com/ethereum/py-evm/issues/337#issuecomment-362188335",
    "issue_url": "https://api.github.com/repos/ethereum/py-evm/issues/337",
    "id": 362188335,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM2MjE4ODMzNQ==",
    "user": {
      "login": "gsalgado",
      "id": 412274,
      "node_id": "MDQ6VXNlcjQxMjI3NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/412274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gsalgado",
      "html_url": "https://github.com/gsalgado",
      "followers_url": "https://api.github.com/users/gsalgado/followers",
      "following_url": "https://api.github.com/users/gsalgado/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsalgado/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gsalgado/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsalgado/subscriptions",
      "organizations_url": "https://api.github.com/users/gsalgado/orgs",
      "repos_url": "https://api.github.com/users/gsalgado/repos",
      "events_url": "https://api.github.com/users/gsalgado/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gsalgado/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-02-01T08:04:48Z",
    "updated_at": "2018-02-01T08:04:48Z",
    "author_association": "MEMBER",
    "body": "We might want to take it a step further and have one DB containing just the headers and another one containing just the block bodies/receipts. That would potentially allow us to have a single header DB for both light/full modes. Also, given the way full-node sync should be implemented (i.e. fetching/validating header chains before fetching the block bodies), having separate DBs would make it easier for us to parallelize parts of it",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/362188335/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/362385421",
    "html_url": "https://github.com/ethereum/py-evm/issues/337#issuecomment-362385421",
    "issue_url": "https://api.github.com/repos/ethereum/py-evm/issues/337",
    "id": 362385421,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM2MjM4NTQyMQ==",
    "user": {
      "login": "carver",
      "id": 205327,
      "node_id": "MDQ6VXNlcjIwNTMyNw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/205327?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/carver",
      "html_url": "https://github.com/carver",
      "followers_url": "https://api.github.com/users/carver/followers",
      "following_url": "https://api.github.com/users/carver/following{/other_user}",
      "gists_url": "https://api.github.com/users/carver/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/carver/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/carver/subscriptions",
      "organizations_url": "https://api.github.com/users/carver/orgs",
      "repos_url": "https://api.github.com/users/carver/repos",
      "events_url": "https://api.github.com/users/carver/events{/privacy}",
      "received_events_url": "https://api.github.com/users/carver/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-02-01T20:04:13Z",
    "updated_at": "2018-02-01T20:04:13Z",
    "author_association": "MEMBER",
    "body": "> We might want to take it a step further and have one DB containing just the headers and another one containing just the block bodies/receipts\r\n\r\nSeems reasonable. Which invites the question: how do we coordinate both databases when the canonical chain head updates?\r\n\r\nSome options:\r\n1. Introduce a pub/sub where the `ChainBodyDB` can subscribe to events in the `ChainHeaderDB` (like \"block header A is no longer in canonical chain\", or \"block header B is now in the canonical chain\"). This might be useful elsewhere\r\n1. Have the `ChainBodyDB` be a subclass of a `ChainHeaderDB`, hooking in some logic for canonical head updates (and wherever else becomes apparent)\r\n3. Add two orchestration classes where we would extract a lot of the current canonical logic: a headers-only and a headers-plus-transaction one\r\n4. Change approach from proactively caching canonical transaction locations to looking them up on demand. Presumably, this is too slow to use in practice without caching. Effective caching would probably need one of the above solutions.\r\n\r\nAt first glance, I'm in favor of 1. It seems like a clean separation, and other objects might benefit from this feature. One downside is that we don't follow that subscription pattern anywhere else that I've seen.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/362385421/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/404435969",
    "html_url": "https://github.com/ethereum/py-evm/issues/337#issuecomment-404435969",
    "issue_url": "https://api.github.com/repos/ethereum/py-evm/issues/337",
    "id": 404435969,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQwNDQzNTk2OQ==",
    "user": {
      "login": "gsalgado",
      "id": 412274,
      "node_id": "MDQ6VXNlcjQxMjI3NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/412274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gsalgado",
      "html_url": "https://github.com/gsalgado",
      "followers_url": "https://api.github.com/users/gsalgado/followers",
      "following_url": "https://api.github.com/users/gsalgado/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsalgado/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gsalgado/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsalgado/subscriptions",
      "organizations_url": "https://api.github.com/users/gsalgado/orgs",
      "repos_url": "https://api.github.com/users/gsalgado/repos",
      "events_url": "https://api.github.com/users/gsalgado/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gsalgado/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-07-12T08:39:43Z",
    "updated_at": "2018-07-12T08:39:43Z",
    "author_association": "MEMBER",
    "body": "We now have separate `HeaderDB` and `ChainDB` classes, and the former's `_set_as_canonical_chain_head()` method doesn't expect the DB to contain transactions in case of a chain reorg, so this is fixed",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/404435969/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
