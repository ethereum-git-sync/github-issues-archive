{
  "url": "https://api.github.com/repos/ethereum/py-evm/issues/1318",
  "repository_url": "https://api.github.com/repos/ethereum/py-evm",
  "labels_url": "https://api.github.com/repos/ethereum/py-evm/issues/1318/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/py-evm/issues/1318/comments",
  "events_url": "https://api.github.com/repos/ethereum/py-evm/issues/1318/events",
  "html_url": "https://github.com/ethereum/py-evm/issues/1318",
  "id": 363656577,
  "node_id": "MDU6SXNzdWUzNjM2NTY1Nzc=",
  "number": 1318,
  "title": "RegularChainSyncer crashes when block importing fails",
  "user": {
    "login": "gsalgado",
    "id": 412274,
    "node_id": "MDQ6VXNlcjQxMjI3NA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/412274?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/gsalgado",
    "html_url": "https://github.com/gsalgado",
    "followers_url": "https://api.github.com/users/gsalgado/followers",
    "following_url": "https://api.github.com/users/gsalgado/following{/other_user}",
    "gists_url": "https://api.github.com/users/gsalgado/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/gsalgado/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/gsalgado/subscriptions",
    "organizations_url": "https://api.github.com/users/gsalgado/orgs",
    "repos_url": "https://api.github.com/users/gsalgado/repos",
    "events_url": "https://api.github.com/users/gsalgado/events{/privacy}",
    "received_events_url": "https://api.github.com/users/gsalgado/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 7,
  "created_at": "2018-09-25T16:07:33Z",
  "updated_at": "2018-09-27T18:33:09Z",
  "closed_at": "2018-09-27T18:33:09Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "So, `validate_rlp_equal()` is raising a `TypeError` even though the diff between the imported block and the original one is empty and they seem to be instances of the same class, and that is causing RegularChainSyncer to crash:\r\n\r\n```\r\n   DEBUG  09-25 17:02:51           ByzantiumVM  BLOCK REWARD: 3000000000000000000 -> b'\\x1b\\xc1\\xeet\\x1b= GT?Yq\\xadu4\\x074\\xc1D\\x13'\r\n   DEBUG  09-25 17:02:51    RegularChainSyncer  <coroutine object RegularChainSyncer._import_ready_blocks at 0x7fd3147e72b0> finished while <trinity.sync.full.chain.           RegularChainSyncer object at 0x7fd3179ac940> is still running, terminating as well\r\n WARNING  09-25 17:02:51    RegularChainSyncer  Task <coroutine object RegularChainSyncer._import_ready_blocks at 0x7fd3147e7308> finished unexpectedly: block                  (<ByzantiumBlock(#Block #4111023)>) != imported block (<ByzantiumBlock(#Block #4111023)>) but got an empty diff\r\n   DEBUG  09-25 17:02:51    RegularChainSyncer  Task failure traceback\r\ntrinity.chains.RemoteTraceback:\r\n\"\"\"\r\nTraceback (most recent call last):\r\n  File \"/home/salgado/src/py-evm/trinity/chains/__init__.py\", line 184, in wrapper\r\n    return attr(*args, **kwargs)\r\n  File \"/home/salgado/src/py-evm/eth/chains/base.py\", line 646, in import_block\r\n    validate_imported_block_unchanged(imported_block, block)\r\n  File \"cytoolz/functoolz.pyx\", line 236, in cytoolz.functoolz.curry.__call__\r\n  File \"cytoolz/functoolz.pyx\", line 232, in cytoolz.functoolz.curry.__call__\r\n  File \"/home/salgado/src/py-evm/eth/utils/rlp.py\", line 65, in validate_rlp_equal\r\n    obj_b,\r\nTypeError: block (<ByzantiumBlock(#Block #4111023)>) != imported block (<ByzantiumBlock(#Block #4111023)>) but got an empty diff\r\n\"\"\"\r\n```",
  "closed_by": {
    "login": "carver",
    "id": 205327,
    "node_id": "MDQ6VXNlcjIwNTMyNw==",
    "avatar_url": "https://avatars.githubusercontent.com/u/205327?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/carver",
    "html_url": "https://github.com/carver",
    "followers_url": "https://api.github.com/users/carver/followers",
    "following_url": "https://api.github.com/users/carver/following{/other_user}",
    "gists_url": "https://api.github.com/users/carver/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/carver/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/carver/subscriptions",
    "organizations_url": "https://api.github.com/users/carver/orgs",
    "repos_url": "https://api.github.com/users/carver/repos",
    "events_url": "https://api.github.com/users/carver/events{/privacy}",
    "received_events_url": "https://api.github.com/users/carver/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/py-evm/issues/1318/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/py-evm/issues/1318/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/424405443",
    "html_url": "https://github.com/ethereum/py-evm/issues/1318#issuecomment-424405443",
    "issue_url": "https://api.github.com/repos/ethereum/py-evm/issues/1318",
    "id": 424405443,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQyNDQwNTQ0Mw==",
    "user": {
      "login": "gsalgado",
      "id": 412274,
      "node_id": "MDQ6VXNlcjQxMjI3NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/412274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gsalgado",
      "html_url": "https://github.com/gsalgado",
      "followers_url": "https://api.github.com/users/gsalgado/followers",
      "following_url": "https://api.github.com/users/gsalgado/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsalgado/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gsalgado/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsalgado/subscriptions",
      "organizations_url": "https://api.github.com/users/gsalgado/orgs",
      "repos_url": "https://api.github.com/users/gsalgado/repos",
      "events_url": "https://api.github.com/users/gsalgado/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gsalgado/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-09-25T16:08:09Z",
    "updated_at": "2018-09-25T16:08:09Z",
    "author_association": "MEMBER",
    "body": "Debug log: [trinity-import-crash.log](https://github.com/ethereum/py-evm/files/2416000/trinity-import-crash.log)\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/424405443/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/424506607",
    "html_url": "https://github.com/ethereum/py-evm/issues/1318#issuecomment-424506607",
    "issue_url": "https://api.github.com/repos/ethereum/py-evm/issues/1318",
    "id": 424506607,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQyNDUwNjYwNw==",
    "user": {
      "login": "pipermerriam",
      "id": 824194,
      "node_id": "MDQ6VXNlcjgyNDE5NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/824194?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pipermerriam",
      "html_url": "https://github.com/pipermerriam",
      "followers_url": "https://api.github.com/users/pipermerriam/followers",
      "following_url": "https://api.github.com/users/pipermerriam/following{/other_user}",
      "gists_url": "https://api.github.com/users/pipermerriam/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pipermerriam/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pipermerriam/subscriptions",
      "organizations_url": "https://api.github.com/users/pipermerriam/orgs",
      "repos_url": "https://api.github.com/users/pipermerriam/repos",
      "events_url": "https://api.github.com/users/pipermerriam/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pipermerriam/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-09-25T21:24:01Z",
    "updated_at": "2018-09-25T21:24:01Z",
    "author_association": "MEMBER",
    "body": "The `__eq__` implementation of `rlp.Serializable` is:\r\n\r\n```python\r\ndef __eq__(self, other):\r\n    return isinstance(other, Serizalizable) and hash(self) == hash(other)\r\ndef __hash__(self):\r\n    return hash(tuple(self))\r\n```\r\n\r\nSince blocks have sequences of transactions and uncles on them, one possible thing that could be happening is that one of those somehow made it onto the object as a `list` instead of a `tuple`.\r\n\r\nBeyond that, I think we need to do the extra work to update `validate_rlp_equal` to do a more robust introspection so that we can get helpful errors in these cases.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/424506607/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/424628427",
    "html_url": "https://github.com/ethereum/py-evm/issues/1318#issuecomment-424628427",
    "issue_url": "https://api.github.com/repos/ethereum/py-evm/issues/1318",
    "id": 424628427,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQyNDYyODQyNw==",
    "user": {
      "login": "gsalgado",
      "id": 412274,
      "node_id": "MDQ6VXNlcjQxMjI3NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/412274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gsalgado",
      "html_url": "https://github.com/gsalgado",
      "followers_url": "https://api.github.com/users/gsalgado/followers",
      "following_url": "https://api.github.com/users/gsalgado/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsalgado/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gsalgado/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsalgado/subscriptions",
      "organizations_url": "https://api.github.com/users/gsalgado/orgs",
      "repos_url": "https://api.github.com/users/gsalgado/repos",
      "events_url": "https://api.github.com/users/gsalgado/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gsalgado/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-09-26T08:20:47Z",
    "updated_at": "2018-09-26T08:20:47Z",
    "author_association": "MEMBER",
    "body": "It's actually the headers that differ because one of them seems to have a stale `._hash_cache`:\r\n```\r\n> /home/salgado/src/py-evm/eth/utils/rlp.py(61)validate_rlp_equal()\r\n-> raise TypeError(\r\n(Pdb) p obj_a.header._hash_cache\r\n606040828753068555\r\n(Pdb) p obj_b.header._hash_cache\r\n1093354690931819732\r\n(Pdb) p hash(tuple(obj_a.header))\r\n606040828753068555\r\n(Pdb) p hash(tuple(obj_b.header))\r\n606040828753068555\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/424628427/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/424655674",
    "html_url": "https://github.com/ethereum/py-evm/issues/1318#issuecomment-424655674",
    "issue_url": "https://api.github.com/repos/ethereum/py-evm/issues/1318",
    "id": 424655674,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQyNDY1NTY3NA==",
    "user": {
      "login": "gsalgado",
      "id": 412274,
      "node_id": "MDQ6VXNlcjQxMjI3NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/412274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gsalgado",
      "html_url": "https://github.com/gsalgado",
      "followers_url": "https://api.github.com/users/gsalgado/followers",
      "following_url": "https://api.github.com/users/gsalgado/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsalgado/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gsalgado/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsalgado/subscriptions",
      "organizations_url": "https://api.github.com/users/gsalgado/orgs",
      "repos_url": "https://api.github.com/users/gsalgado/repos",
      "events_url": "https://api.github.com/users/gsalgado/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gsalgado/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-09-26T09:51:54Z",
    "updated_at": "2018-09-26T09:51:54Z",
    "author_association": "MEMBER",
    "body": "And the above happens because the original block (the one we want to import) is pickled (with its `._hash_cache`) and sent to a different process, but python's `hash()` builtin is [not stable across processes](https://docs.python.org/3/reference/datamodel.html#object.__hash__).\r\n\r\nThis wasn't a problem in the past because it was only recently that [`validate_rlp_equal()` was modified to raise a TypeError when the objects don't compare equally but the diff is empty](https://github.com/ethereum/py-evm/commit/a8aac92a37c8d63b8b3481e08ff5816b5854da20)\r\n\r\nI can see a few alternatives to fix this:\r\n\r\n1. Get rid of `._hash_cache` from rlp.Serializable\r\n2. Add a `__getstate__()` method to rlp.Serializable so we don't pickle the `._hash_cache` attribute\r\n3. Use a stable hashing implementation (e.g. [hashlib](https://docs.python.org/3/library/hashlib.html)) instead of the builtin `hash()`\r\n\r\nI'd be in favour of 1 as I'm not sure caching the hash of `rlp.Serializable`s provides a significant performance improvement anywhere",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/424655674/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/424884821",
    "html_url": "https://github.com/ethereum/py-evm/issues/1318#issuecomment-424884821",
    "issue_url": "https://api.github.com/repos/ethereum/py-evm/issues/1318",
    "id": 424884821,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQyNDg4NDgyMQ==",
    "user": {
      "login": "carver",
      "id": 205327,
      "node_id": "MDQ6VXNlcjIwNTMyNw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/205327?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/carver",
      "html_url": "https://github.com/carver",
      "followers_url": "https://api.github.com/users/carver/followers",
      "following_url": "https://api.github.com/users/carver/following{/other_user}",
      "gists_url": "https://api.github.com/users/carver/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/carver/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/carver/subscriptions",
      "organizations_url": "https://api.github.com/users/carver/orgs",
      "repos_url": "https://api.github.com/users/carver/repos",
      "events_url": "https://api.github.com/users/carver/events{/privacy}",
      "received_events_url": "https://api.github.com/users/carver/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-09-26T22:03:45Z",
    "updated_at": "2018-09-26T22:03:45Z",
    "author_association": "MEMBER",
    "body": "> This wasn't a problem in the past because it was only recently that validate_rlp_equal() was modified to raise a TypeError when the objects don't compare equally but the diff is empty\r\n\r\nNope, it's just a very infrequent bug. The very next line was failing when the diff is empty, because:\r\n\r\n```\r\nValueError: max() arg is an empty sequence\r\n```\r\n\r\nGood deep dive on the hunting and solution!",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/424884821/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/425184159",
    "html_url": "https://github.com/ethereum/py-evm/issues/1318#issuecomment-425184159",
    "issue_url": "https://api.github.com/repos/ethereum/py-evm/issues/1318",
    "id": 425184159,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQyNTE4NDE1OQ==",
    "user": {
      "login": "pipermerriam",
      "id": 824194,
      "node_id": "MDQ6VXNlcjgyNDE5NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/824194?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pipermerriam",
      "html_url": "https://github.com/pipermerriam",
      "followers_url": "https://api.github.com/users/pipermerriam/followers",
      "following_url": "https://api.github.com/users/pipermerriam/following{/other_user}",
      "gists_url": "https://api.github.com/users/pipermerriam/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pipermerriam/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pipermerriam/subscriptions",
      "organizations_url": "https://api.github.com/users/pipermerriam/orgs",
      "repos_url": "https://api.github.com/users/pipermerriam/repos",
      "events_url": "https://api.github.com/users/pipermerriam/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pipermerriam/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-09-27T17:50:57Z",
    "updated_at": "2018-09-27T17:50:57Z",
    "author_association": "MEMBER",
    "body": "Just noting that there is no change needed for the `validate_rlp_equal` since the underlying issue here was beyond the scope of what the function could reasonable handle.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/425184159/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/425184302",
    "html_url": "https://github.com/ethereum/py-evm/issues/1318#issuecomment-425184302",
    "issue_url": "https://api.github.com/repos/ethereum/py-evm/issues/1318",
    "id": 425184302,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQyNTE4NDMwMg==",
    "user": {
      "login": "pipermerriam",
      "id": 824194,
      "node_id": "MDQ6VXNlcjgyNDE5NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/824194?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pipermerriam",
      "html_url": "https://github.com/pipermerriam",
      "followers_url": "https://api.github.com/users/pipermerriam/followers",
      "following_url": "https://api.github.com/users/pipermerriam/following{/other_user}",
      "gists_url": "https://api.github.com/users/pipermerriam/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pipermerriam/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pipermerriam/subscriptions",
      "organizations_url": "https://api.github.com/users/pipermerriam/orgs",
      "repos_url": "https://api.github.com/users/pipermerriam/repos",
      "events_url": "https://api.github.com/users/pipermerriam/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pipermerriam/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-09-27T17:51:22Z",
    "updated_at": "2018-09-27T17:51:22Z",
    "author_association": "MEMBER",
    "body": "This issue can be closed once the `rlp` dependency has been bumped to `>=1.0.3`",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/425184302/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
