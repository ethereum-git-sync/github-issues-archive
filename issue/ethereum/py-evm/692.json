{
  "url": "https://api.github.com/repos/ethereum/py-evm/issues/692",
  "repository_url": "https://api.github.com/repos/ethereum/py-evm",
  "labels_url": "https://api.github.com/repos/ethereum/py-evm/issues/692/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/py-evm/issues/692/comments",
  "events_url": "https://api.github.com/repos/ethereum/py-evm/issues/692/events",
  "html_url": "https://github.com/ethereum/py-evm/issues/692",
  "id": 323039507,
  "node_id": "MDU6SXNzdWUzMjMwMzk1MDc=",
  "number": 692,
  "title": "Intrinsic gas is lower in transaction used for gas estimation than identical signed transaction",
  "user": {
    "login": "dylanjw",
    "id": 8933231,
    "node_id": "MDQ6VXNlcjg5MzMyMzE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/8933231?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/dylanjw",
    "html_url": "https://github.com/dylanjw",
    "followers_url": "https://api.github.com/users/dylanjw/followers",
    "following_url": "https://api.github.com/users/dylanjw/following{/other_user}",
    "gists_url": "https://api.github.com/users/dylanjw/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/dylanjw/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/dylanjw/subscriptions",
    "organizations_url": "https://api.github.com/users/dylanjw/orgs",
    "repos_url": "https://api.github.com/users/dylanjw/repos",
    "events_url": "https://api.github.com/users/dylanjw/events{/privacy}",
    "received_events_url": "https://api.github.com/users/dylanjw/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2018-05-15T01:56:03Z",
  "updated_at": "2018-05-15T17:21:27Z",
  "closed_at": "2018-05-15T17:21:27Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "* py-evm Version: v0.2.0-alpha.6-1018-g9999ca0a\r\n* OS: linux\r\n* Python Version (python --version): Python 3.6.3\r\n* Environment (output of `pip freeze`): \r\n\r\n### What is wrong?\r\n\r\nI updated gas estimation tests in web3 to compare gas estimates to actual gas used.  Gas estimates are more than the intrinsic gas tolerance different.  They are consistently low.\r\n\r\nI have worked to trace why this could be, and noticed that the intrinsic gas for the transaction built for gas estimation is much lower than the real transaction with identical data.\r\n\r\n```python\r\n pytest tests/core/contracts/test_contract_constructor.py --lf -x\r\n============================================================================= test session starts ==============================================================================\r\nplatform linux -- Python 3.6.3, pytest-3.2.5, py-1.5.3, pluggy-0.4.0 -- /home/dwilson/Develop/Projects/ethereum/web3.py/venv36/bin/python\r\ncachedir: .cache\r\nrootdir: /home/dwilson/Develop/Projects/ethereum/web3.py, inifile: pytest.ini\r\nplugins: xdist-1.22.2, pythonpath-0.7.2, mock-1.7.1, forked-0.2, hypothesis-3.50.2, flaky-3.4.0\r\ncollected 22 items                                                                                                                                                              \r\nrun-last-failure: rerun previous 7 failures\r\n\r\ntests/core/contracts/test_contract_constructor.py::test_contract_constructor_gas_estimate_no_constructor \r\n>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> PDB set_trace (IO-capturing turned off) >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>\r\n> /home/dwilson/Develop/Projects/ethereum/py-evm/evm/estimators/gas.py(78)binary_gas_search()\r\n-> return minimum_viable\r\n(Pdb) transaction.intrinsic_gas\r\n56776\r\n(Pdb) transaction.data.count(b'\\x00')\r\n53\r\n(Pdb) len(transaction.data) - transaction.data.count(b'\\x00')\r\n523\r\n(Pdb) transaction\r\n<evm.utils.spoof.SpoofTransaction object at 0x7fec5b1ebeb8>\r\n(Pdb) transaction.spoof_target\r\n<evm.vm.forks.byzantium.transactions.ByzantiumUnsignedTransaction object at 0x7fec5b2090b8>\r\n(Pdb) c\r\n\r\n>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> PDB set_trace (IO-capturing turned off) >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>\r\n> /home/dwilson/Develop/Projects/ethereum/py-evm/evm/estimators/gas.py(78)binary_gas_search()\r\n-> return minimum_viable\r\n(Pdb) c\r\n\r\n>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> PDB set_trace (IO-capturing turned off) >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>\r\n> /home/dwilson/Develop/Projects/ethereum/py-evm/evm/chains/base.py(497)apply_transaction()\r\n-> transactions = base_block.transactions + (transaction, )\r\n(Pdb) transaction.intrinsic_gas\r\n88776\r\n(Pdb) transaction.data.count(b'\\x00')\r\n53\r\n(Pdb) len(transaction.data) - transaction.data.count(b'\\x00')\r\n523\r\n(Pdb) transaction\r\n<evm.vm.forks.byzantium.transactions.ByzantiumTransaction object at 0x7fec65eea748>\r\n(Pdb) \r\n```\r\n\r\nAm I missing something to do with the intrinsic gas calculation?  Shouldnt identical data yield identical intrinsic_gas?\r\n",
  "closed_by": {
    "login": "pipermerriam",
    "id": 824194,
    "node_id": "MDQ6VXNlcjgyNDE5NA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/824194?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/pipermerriam",
    "html_url": "https://github.com/pipermerriam",
    "followers_url": "https://api.github.com/users/pipermerriam/followers",
    "following_url": "https://api.github.com/users/pipermerriam/following{/other_user}",
    "gists_url": "https://api.github.com/users/pipermerriam/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/pipermerriam/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/pipermerriam/subscriptions",
    "organizations_url": "https://api.github.com/users/pipermerriam/orgs",
    "repos_url": "https://api.github.com/users/pipermerriam/repos",
    "events_url": "https://api.github.com/users/pipermerriam/events{/privacy}",
    "received_events_url": "https://api.github.com/users/pipermerriam/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/py-evm/issues/692/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/py-evm/issues/692/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/389025479",
    "html_url": "https://github.com/ethereum/py-evm/issues/692#issuecomment-389025479",
    "issue_url": "https://api.github.com/repos/ethereum/py-evm/issues/692",
    "id": 389025479,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM4OTAyNTQ3OQ==",
    "user": {
      "login": "pipermerriam",
      "id": 824194,
      "node_id": "MDQ6VXNlcjgyNDE5NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/824194?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pipermerriam",
      "html_url": "https://github.com/pipermerriam",
      "followers_url": "https://api.github.com/users/pipermerriam/followers",
      "following_url": "https://api.github.com/users/pipermerriam/following{/other_user}",
      "gists_url": "https://api.github.com/users/pipermerriam/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pipermerriam/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pipermerriam/subscriptions",
      "organizations_url": "https://api.github.com/users/pipermerriam/orgs",
      "repos_url": "https://api.github.com/users/pipermerriam/repos",
      "events_url": "https://api.github.com/users/pipermerriam/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pipermerriam/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-05-15T02:46:28Z",
    "updated_at": "2018-05-15T02:46:28Z",
    "author_association": "MEMBER",
    "body": "Note the two transactions have a difference of `32000` in their intrinsic gas.  This is the `evm.constants.GAS_CREATE` cost which you can see is part of the intrinsic gas calculation in `evm.vm.forks.homestead.transactions`.\r\n\r\nThe *former* transaction is likely `to` an existing address.  The *later* more expensive transaction likely has an empty `to` address, flagging it as a contract creation transaction.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/389025479/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/389032835",
    "html_url": "https://github.com/ethereum/py-evm/issues/692#issuecomment-389032835",
    "issue_url": "https://api.github.com/repos/ethereum/py-evm/issues/692",
    "id": 389032835,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM4OTAzMjgzNQ==",
    "user": {
      "login": "dylanjw",
      "id": 8933231,
      "node_id": "MDQ6VXNlcjg5MzMyMzE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8933231?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dylanjw",
      "html_url": "https://github.com/dylanjw",
      "followers_url": "https://api.github.com/users/dylanjw/followers",
      "following_url": "https://api.github.com/users/dylanjw/following{/other_user}",
      "gists_url": "https://api.github.com/users/dylanjw/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dylanjw/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dylanjw/subscriptions",
      "organizations_url": "https://api.github.com/users/dylanjw/orgs",
      "repos_url": "https://api.github.com/users/dylanjw/repos",
      "events_url": "https://api.github.com/users/dylanjw/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dylanjw/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-05-15T03:38:46Z",
    "updated_at": "2018-05-15T03:52:14Z",
    "author_association": "MEMBER",
    "body": "Its the same transaction parameters (which is not apparent from what I posted), the only difference is that one is a signed transaction and the other is not.\r\n\r\nWhen I added `intrinsic_gas` to both signed and unsigned  base transactions  in #556, I did not make the required changes in all the forks, so for homestead transactions, only HomesteadTransaction objects have the GAS_CREATE added, whereas HomesteadUnsignedTransaction uses the Frontier calculation without the GAS_CREATE added.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/389032835/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/389246197",
    "html_url": "https://github.com/ethereum/py-evm/issues/692#issuecomment-389246197",
    "issue_url": "https://api.github.com/repos/ethereum/py-evm/issues/692",
    "id": 389246197,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM4OTI0NjE5Nw==",
    "user": {
      "login": "pipermerriam",
      "id": 824194,
      "node_id": "MDQ6VXNlcjgyNDE5NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/824194?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pipermerriam",
      "html_url": "https://github.com/pipermerriam",
      "followers_url": "https://api.github.com/users/pipermerriam/followers",
      "following_url": "https://api.github.com/users/pipermerriam/following{/other_user}",
      "gists_url": "https://api.github.com/users/pipermerriam/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pipermerriam/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pipermerriam/subscriptions",
      "organizations_url": "https://api.github.com/users/pipermerriam/orgs",
      "repos_url": "https://api.github.com/users/pipermerriam/repos",
      "events_url": "https://api.github.com/users/pipermerriam/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pipermerriam/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-05-15T17:21:27Z",
    "updated_at": "2018-05-15T17:21:27Z",
    "author_association": "MEMBER",
    "body": "Looks like you figured out it was a bug in the unsigned transaction's implementation of this.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/389246197/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
