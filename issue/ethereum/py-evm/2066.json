{
  "url": "https://api.github.com/repos/ethereum/py-evm/issues/2066",
  "repository_url": "https://api.github.com/repos/ethereum/py-evm",
  "labels_url": "https://api.github.com/repos/ethereum/py-evm/issues/2066/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/py-evm/issues/2066/comments",
  "events_url": "https://api.github.com/repos/ethereum/py-evm/issues/2066/events",
  "html_url": "https://github.com/ethereum/py-evm/issues/2066",
  "id": 1260702615,
  "node_id": "I_kwDOBJ456s5LJMuX",
  "number": 2066,
  "title": "Getting `eth_keys.exceptions.BadSignature: Value -27 is not greater than or equal to 0` when v is `0`",
  "user": {
    "login": "pastet89",
    "id": 7469057,
    "node_id": "MDQ6VXNlcjc0NjkwNTc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/7469057?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/pastet89",
    "html_url": "https://github.com/pastet89",
    "followers_url": "https://api.github.com/users/pastet89/followers",
    "following_url": "https://api.github.com/users/pastet89/following{/other_user}",
    "gists_url": "https://api.github.com/users/pastet89/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/pastet89/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/pastet89/subscriptions",
    "organizations_url": "https://api.github.com/users/pastet89/orgs",
    "repos_url": "https://api.github.com/users/pastet89/repos",
    "events_url": "https://api.github.com/users/pastet89/events{/privacy}",
    "received_events_url": "https://api.github.com/users/pastet89/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2022-06-04T09:58:31Z",
  "updated_at": "2022-06-23T18:29:50Z",
  "closed_at": "2022-06-23T18:19:39Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "* py-evm Version: `0.5.0a3`\r\n* OS: Amazon Linux\r\n* Python Version (python --version):  `3.9.2`\r\n* Environment (output of `pip freeze`):\r\n```\r\naiohttp==3.8.1\r\naiosignal==1.2.0\r\nasync-timeout==4.0.2\r\nattrs==21.4.0\r\nbase58==2.1.1\r\nbitarray==1.2.2\r\ncached-property==1.5.2\r\ncertifi==2022.5.18.1\r\ncharset-normalizer==2.0.12\r\ncytoolz==0.11.2\r\neth-abi==2.1.1\r\neth-account==0.5.7\r\neth-bloom==1.0.4\r\neth-hash==0.3.2\r\neth-keyfile==0.5.1\r\neth-keys==0.3.4\r\neth-rlp==0.2.1\r\neth-typing==2.3.0\r\neth-utils==1.10.0\r\nfrozenlist==1.3.0\r\nhexbytes==0.2.2\r\nidna==3.3\r\nipfshttpclient==0.8.0a2\r\njsonschema==4.6.0\r\nlru-dict==1.1.7\r\nmultiaddr==0.0.9\r\nmultidict==6.0.2\r\nmypy-extensions==0.4.3\r\nnetaddr==0.8.0\r\nparsimonious==0.8.1\r\nprotobuf==3.20.1\r\npy-ecc==5.2.0\r\npy-evm==0.5.0a3\r\npycryptodome==3.14.1\r\npyethash==0.1.27\r\npyrsistent==0.18.1\r\nrequests==2.27.1\r\nrlp==2.0.1\r\nsix==1.16.0\r\nsortedcontainers==2.4.0\r\ntoolz==0.11.2\r\ntrie==2.0.0a5\r\ntyping-extensions==3.10.0.2\r\nurllib3==1.26.9\r\nvarint==1.0.2\r\nweb3==5.29.2\r\nwebsockets==9.1\r\nyarl==1.7.2\r\n```\r\n### What is wrong?\r\n\r\nI am trying to recover the sender address using the following code: \r\n```\r\ndef test_extract_from_account():\r\n    w3 = web3.Web3(web3.HTTPProvider(\"https://eth-mainnet.alchemyapi.io/v2/XXXXXXXXXXXXXXXXXXXXXXXXXX\"))\r\n    tx = w3.eth.getTransaction(\"0x784fed92b7eae2853dd7a22460760613c5345ad97aff660d26c657e9f19c6a3d\")\r\n    raw_tx = recover_raw_transaction(tx)\r\n    TransactionClass = MuirGlacierTransaction\r\n    evm_transaction = rlp.decode(raw_tx, TransactionClass)\r\n    sender = evm_transaction.sender\r\n    print(sender.hex())\r\n```\r\n\r\nIt seems to me it works well for transactions with `v` = `27` or `28`.\r\nBut when `v` of a transaction is `0x0`, I am getting: \r\n```\r\nTraceback (most recent call last):\r\n  File \"/home/my_folder/py-evm/venv/lib/python3.9/site-packages/eth_keys/datatypes.py\", line 380, in __init__\r\n    self.v = v\r\n  File \"/home/my_folder/py-evm/venv/lib/python3.9/site-packages/eth_keys/datatypes.py\", line 393, in v\r\n    validate_signature_v(value)\r\n  File \"/home/my_folder/py-evm/venv/lib/python3.9/site-packages/eth_keys/validation.py\", line 104, in validate_signature_v\r\n    validate_gte(value, minimum=0)\r\n  File \"cytoolz/functoolz.pyx\", line 250, in cytoolz.functoolz.curry.__call__\r\n  File \"/home/my_folder/py-evm/venv/lib/python3.9/site-packages/eth_keys/validation.py\", line 30, in validate_gte\r\n    raise ValidationError(\r\neth_utils.exceptions.ValidationError: Value -27 is not greater than or equal to 0\r\n\r\nThe above exception was the direct cause of the following exception:\r\n\r\nTraceback (most recent call last):\r\n  File \"/home/my_folder/py-evm/recover.py\", line 68, in <module>\r\n    print(test_extract_from_account()) ######################\r\n  File \"/home/my_folder/py-evm/recover.py\", line 65, in test_extract_from_account\r\n    sender = evm_transaction.sender\r\n  File \"/home/my_folder/py-evm/venv/lib/python3.9/site-packages/cached_property.py\", line 36, in __get__\r\n    value = obj.__dict__[self.func.__name__] = self.func(obj)\r\n  File \"/home/my_folder/py-evm/venv/lib/python3.9/site-packages/eth/rlp/transactions.py\", line 85, in sender\r\n    return self.get_sender()\r\n  File \"/home/my_folder/py-evm/venv/lib/python3.9/site-packages/eth/vm/forks/frontier/transactions.py\", line 101, in get_sender\r\n    return extract_transaction_sender(self)\r\n  File \"/home/my_folder/py-evm/venv/lib/python3.9/site-packages/eth/_utils/transactions.py\", line 98, in extract_transaction_sender\r\n    signature = keys.Signature(vrs=vrs)\r\n  File \"/home/my_folder/py-evm/venv/lib/python3.9/site-packages/eth_keys/datatypes.py\", line 382, in __init__\r\n    raise BadSignature(str(error)) from error\r\neth_keys.exceptions.BadSignature: Value -27 is not greater than or equal to 0\r\n```\r\n\r\nHow to solve this?\r\n\r\n",
  "closed_by": {
    "login": "fselmo",
    "id": 3532824,
    "node_id": "MDQ6VXNlcjM1MzI4MjQ=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3532824?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/fselmo",
    "html_url": "https://github.com/fselmo",
    "followers_url": "https://api.github.com/users/fselmo/followers",
    "following_url": "https://api.github.com/users/fselmo/following{/other_user}",
    "gists_url": "https://api.github.com/users/fselmo/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/fselmo/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/fselmo/subscriptions",
    "organizations_url": "https://api.github.com/users/fselmo/orgs",
    "repos_url": "https://api.github.com/users/fselmo/repos",
    "events_url": "https://api.github.com/users/fselmo/events{/privacy}",
    "received_events_url": "https://api.github.com/users/fselmo/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/py-evm/issues/2066/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/py-evm/issues/2066/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/1164728892",
    "html_url": "https://github.com/ethereum/py-evm/issues/2066#issuecomment-1164728892",
    "issue_url": "https://api.github.com/repos/ethereum/py-evm/issues/2066",
    "id": 1164728892,
    "node_id": "IC_kwDOBJ456s5FbFo8",
    "user": {
      "login": "fselmo",
      "id": 3532824,
      "node_id": "MDQ6VXNlcjM1MzI4MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3532824?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fselmo",
      "html_url": "https://github.com/fselmo",
      "followers_url": "https://api.github.com/users/fselmo/followers",
      "following_url": "https://api.github.com/users/fselmo/following{/other_user}",
      "gists_url": "https://api.github.com/users/fselmo/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fselmo/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fselmo/subscriptions",
      "organizations_url": "https://api.github.com/users/fselmo/orgs",
      "repos_url": "https://api.github.com/users/fselmo/repos",
      "events_url": "https://api.github.com/users/fselmo/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fselmo/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-06-23T18:19:39Z",
    "updated_at": "2022-06-23T18:29:50Z",
    "author_association": "MEMBER",
    "body": "Hey @pastet89... I'm not sure at all what's going on in the `recover_raw_transaction()` method you posted but it looks like whatever is happening you are getting `-27`, not `0` for `v`.\r\n\r\nI'm also not sure why you chose `MuirGlacierTransaction` but it looks like the transaction you want was a `DynamicFeeTransaction` and those were not around in the Muir Glacier days - only after the London fork.\r\n\r\nYou can get the result you want like so:\r\n\r\n```py\r\nfrom eth.vm.forks.arrow_glacier.transactions import ArrowGlacierTransactionBuilder\r\nfrom eth_utils import (\r\n  encode_hex,\r\n  to_bytes,\r\n)\r\n\r\n>>> # the signed transaction to decode:\r\n>>> original_hexstr = '0x784fed92b...'\r\n\r\n>>> # convert the hex string to bytes:\r\n>>> signed_tx_as_bytes = to_bytes(hexstr=original_hexstr)\r\n\r\n>>> # deserialize the transaction using the latest transaction builder (Arrow Glacier at the time of writing, soon to be Gray Glacier):\r\n>>> decoded_tx = ArrowGlacierTransactionBuilder().decode(signed_tx_as_bytes)\r\n>>> decoded_tx.__dict__\r\n{'type_id': 2, '_inner': DynamicFeeTransaction(chain_id=1, nonce=105, max_priority_fee_per_gas=1500000000, max_fee_per_gas=72882978399, \r\ngas=282986, to=b'\\x7f&\\x83W\\xa8\\xc2U&#1n%b\\xd9\\x0ed+\\xb58\\xe5', value=348900000000000000, data=b'\\xab\\x83K\\xab\\x00\\x00...{truncated as this is quite lengthy}', access_list=(), \r\ny_parity=0, r=108128106577709960648360555828195390773825675124298788107033477245315938044442, s=43414734651983700962377115237100709991347317735197505540741341915840196120498)}\r\n\r\n>>> # the (human-readable) sender's address:\r\n>>> sender = encode_hex(decoded_tx.sender)\r\n>>> sender\r\n0x355a02...\r\n\r\n```\r\n\r\nClosing because this does not look like an issue but if you feel it is we can re-open. Best of luck.\r\n\r\n---\r\n\r\n**edit:** Relevant blog post that may be helpful and where this sample was taken from: https://snakecharmers.ethereum.org/web3-py-patterns-decoding-signed-transactions/",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/1164728892/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
