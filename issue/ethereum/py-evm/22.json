{
  "url": "https://api.github.com/repos/ethereum/py-evm/issues/22",
  "repository_url": "https://api.github.com/repos/ethereum/py-evm",
  "labels_url": "https://api.github.com/repos/ethereum/py-evm/issues/22/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/py-evm/issues/22/comments",
  "events_url": "https://api.github.com/repos/ethereum/py-evm/issues/22/events",
  "html_url": "https://github.com/ethereum/py-evm/issues/22",
  "id": 239522855,
  "node_id": "MDU6SXNzdWUyMzk1MjI4NTU=",
  "number": 22,
  "title": "Fix `EVM.header` mutation and architecture.",
  "user": {
    "login": "pipermerriam",
    "id": 824194,
    "node_id": "MDQ6VXNlcjgyNDE5NA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/824194?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/pipermerriam",
    "html_url": "https://github.com/pipermerriam",
    "followers_url": "https://api.github.com/users/pipermerriam/followers",
    "following_url": "https://api.github.com/users/pipermerriam/following{/other_user}",
    "gists_url": "https://api.github.com/users/pipermerriam/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/pipermerriam/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/pipermerriam/subscriptions",
    "organizations_url": "https://api.github.com/users/pipermerriam/orgs",
    "repos_url": "https://api.github.com/users/pipermerriam/repos",
    "events_url": "https://api.github.com/users/pipermerriam/events{/privacy}",
    "received_events_url": "https://api.github.com/users/pipermerriam/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2017-06-29T15:41:02Z",
  "updated_at": "2017-07-18T13:15:43Z",
  "closed_at": "2017-07-18T13:03:46Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "This issue is seeded from this comment:  https://github.com/pipermerriam/py-evm/pull/21/files#r124833739\r\n\r\n### What is wrong\r\n\r\nCurrently, `EVM.header` is used to anchor the chain to the current HEAD state.\r\n\r\nMutation of this value occurs in the following places:\r\n\r\n* `EVM.apply_transaction()`\r\n* `EVM.import_block()`\r\n* `EVM.mine_block()`\r\n* `EVM.configure_header()`\r\n\r\nThis mutation introduces the potential for us to have two separate actions modify the `EVM.header` property and to end up either overwriting something we should not, or just to have some sort of inconsistency.  This is not ideal.\r\n\r\n### How can it be fixed.\r\n\r\nNot clear at this time but this is something that should likely be addressed because it has the potential to be very problematic down the road.",
  "closed_by": {
    "login": "pipermerriam",
    "id": 824194,
    "node_id": "MDQ6VXNlcjgyNDE5NA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/824194?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/pipermerriam",
    "html_url": "https://github.com/pipermerriam",
    "followers_url": "https://api.github.com/users/pipermerriam/followers",
    "following_url": "https://api.github.com/users/pipermerriam/following{/other_user}",
    "gists_url": "https://api.github.com/users/pipermerriam/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/pipermerriam/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/pipermerriam/subscriptions",
    "organizations_url": "https://api.github.com/users/pipermerriam/orgs",
    "repos_url": "https://api.github.com/users/pipermerriam/repos",
    "events_url": "https://api.github.com/users/pipermerriam/events{/privacy}",
    "received_events_url": "https://api.github.com/users/pipermerriam/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/py-evm/issues/22/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/py-evm/issues/22/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/316042631",
    "html_url": "https://github.com/ethereum/py-evm/issues/22#issuecomment-316042631",
    "issue_url": "https://api.github.com/repos/ethereum/py-evm/issues/22",
    "id": 316042631,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNjA0MjYzMQ==",
    "user": {
      "login": "gsalgado",
      "id": 412274,
      "node_id": "MDQ6VXNlcjQxMjI3NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/412274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gsalgado",
      "html_url": "https://github.com/gsalgado",
      "followers_url": "https://api.github.com/users/gsalgado/followers",
      "following_url": "https://api.github.com/users/gsalgado/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsalgado/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gsalgado/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsalgado/subscriptions",
      "organizations_url": "https://api.github.com/users/gsalgado/orgs",
      "repos_url": "https://api.github.com/users/gsalgado/repos",
      "events_url": "https://api.github.com/users/gsalgado/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gsalgado/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-18T12:00:58Z",
    "updated_at": "2017-07-18T12:00:58Z",
    "author_association": "MEMBER",
    "body": "I thought we should be able to avoid storing the header as an instance variable in the EVM and instead just store the number of the head block, but that's not easy because there are too many places where we construct an EVM and later call .get_vm() (which needs the head's header) without having first persisted the head block to the DB, so we'd have nowhere to retrieve the header from.\r\n\r\nHowever, ISTM that in EVM.apply_transaction() we don't need to overwrite .header, and EVM.configure_header() is not actually used anywhere, so we end up with just .mine_block() and .import_block() overwriting .header, which doesn't sound so unreasonable",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/316042631/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/316060011",
    "html_url": "https://github.com/ethereum/py-evm/issues/22#issuecomment-316060011",
    "issue_url": "https://api.github.com/repos/ethereum/py-evm/issues/22",
    "id": 316060011,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNjA2MDAxMQ==",
    "user": {
      "login": "pipermerriam",
      "id": 824194,
      "node_id": "MDQ6VXNlcjgyNDE5NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/824194?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pipermerriam",
      "html_url": "https://github.com/pipermerriam",
      "followers_url": "https://api.github.com/users/pipermerriam/followers",
      "following_url": "https://api.github.com/users/pipermerriam/following{/other_user}",
      "gists_url": "https://api.github.com/users/pipermerriam/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pipermerriam/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pipermerriam/subscriptions",
      "organizations_url": "https://api.github.com/users/pipermerriam/orgs",
      "repos_url": "https://api.github.com/users/pipermerriam/repos",
      "events_url": "https://api.github.com/users/pipermerriam/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pipermerriam/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-18T13:15:43Z",
    "updated_at": "2017-07-18T13:15:43Z",
    "author_association": "MEMBER",
    "body": "Good stuff.  Nice to see this mutation reduced to block imports and creation.  What do you think about the following idea for removal of the mutation from those two methods.\r\n\r\nInstead of overwriting the local header object, what if `mine_block()` and `import_block()` returned new EVM instances?\r\n\r\n```python\r\nevm = EVM(....)\r\nhead_evm = EVM(...).import_block(block_0).import_block(block_1)\r\n\r\n# or using some functional tools to apply an arbitrary number of blocks.\r\nblocks_to_import = [block_0, block_1]\r\nhead_evm = toolz.functoolz.pipe(  # http://toolz.readthedocs.io/en/latest/api.html#toolz.functoolz.pipe\r\n    EVM(...), \r\n    *(operator.methodcaller('import_block', block) for block in blocks_to_import)\r\n)\r\n```\r\n\r\nThis does have the downside of making the API a bit less intuitive.\r\n\r\n```python\r\nevm = EVM(....)\r\n# maybe execute some transactions\r\nevm.apply_transaction(...)\r\n# then mine a block.\r\nevm = evm.mine_block()  # Awkward that you have to overwrite the local variable...\r\n# maybe provide an alternate API\r\nevm.mine_block_in_place()  # not ideal....\r\n```\r\n\r\nI'm not convinced this is a good idea but I'm curious if it leads towards one.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/316060011/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
