{
  "url": "https://api.github.com/repos/ethereum/py-evm/issues/901",
  "repository_url": "https://api.github.com/repos/ethereum/py-evm",
  "labels_url": "https://api.github.com/repos/ethereum/py-evm/issues/901/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/py-evm/issues/901/comments",
  "events_url": "https://api.github.com/repos/ethereum/py-evm/issues/901/events",
  "html_url": "https://github.com/ethereum/py-evm/issues/901",
  "id": 331737883,
  "node_id": "MDU6SXNzdWUzMzE3Mzc4ODM=",
  "number": 901,
  "title": "BadAckMessage: Auth ack msg too short: 0",
  "user": {
    "login": "carver",
    "id": 205327,
    "node_id": "MDQ6VXNlcjIwNTMyNw==",
    "avatar_url": "https://avatars.githubusercontent.com/u/205327?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/carver",
    "html_url": "https://github.com/carver",
    "followers_url": "https://api.github.com/users/carver/followers",
    "following_url": "https://api.github.com/users/carver/following{/other_user}",
    "gists_url": "https://api.github.com/users/carver/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/carver/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/carver/subscriptions",
    "organizations_url": "https://api.github.com/users/carver/orgs",
    "repos_url": "https://api.github.com/users/carver/repos",
    "events_url": "https://api.github.com/users/carver/events{/privacy}",
    "received_events_url": "https://api.github.com/users/carver/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 889922027,
      "node_id": "MDU6TGFiZWw4ODk5MjIwMjc=",
      "url": "https://api.github.com/repos/ethereum/py-evm/labels/comp:%20p2p",
      "name": "comp: p2p",
      "color": "bfd4f2",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2018-06-12T20:18:04Z",
  "updated_at": "2018-06-13T16:06:11Z",
  "closed_at": "2018-06-13T16:06:11Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "### What is wrong?\r\n\r\n```\r\n    INFO  06-12 13:10:22        peer  Adding peer: LESPeer <Node(0x053d@79.98.29.154)>\r\n   DEBUG  06-12 13:10:22        peer  Connecting to <Node(0x94c1@192.81.208.223)>...\r\n   DEBUG  06-12 13:10:24  lightchain  fetched headers from 1 to 192\r\n    INFO  06-12 13:10:24        peer  Got bad Ack during peer connection\r\n   DEBUG  06-12 13:10:24        peer  Got bad Ack during peer connection\r\nTraceback (most recent call last):\r\n  File \"/home/jcarver/code/py-evm/p2p/peer.py\", line 654, in connect\r\n    self.cancel_token))\r\n  File \"/home/jcarver/code/py-evm/p2p/service.py\", line 32, in wait\r\n    return await self.wait_first(awaitable, token=token, timeout=timeout)\r\n  File \"/home/jcarver/code/py-evm/p2p/service.py\", line 51, in wait_first\r\n    return await wait_with_token(*awaitables, token=token_chain, timeout=timeout)\r\n  File \"/home/jcarver/code/py-evm/p2p/cancel_token.py\", line 119, in wait_with_token\r\n    return done.pop().result()\r\n  File \"/home/jcarver/code/py-evm/p2p/peer.py\", line 126, in handshake\r\n    ) = await auth.handshake(remote, privkey, token)\r\n  File \"/home/jcarver/code/py-evm/p2p/auth.py\", line 59, in handshake\r\n    initiator, reader, writer, token)\r\n  File \"/home/jcarver/code/py-evm/p2p/auth.py\", line 81, in _handshake\r\n    ephemeral_pubkey, responder_nonce = initiator.decode_auth_ack_message(auth_ack)\r\n  File \"/home/jcarver/code/py-evm/p2p/auth.py\", line 195, in decode_auth_ack_message\r\n    raise BadAckMessage(\"Auth ack msg too short: {}\".format(len(ciphertext)))\r\np2p.exceptions.BadAckMessage: Auth ack msg too short: 0\r\n\r\n```\r\n\r\n### How can it be fixed\r\n\r\n:man_shrugging: \r\n\r\n#885 fixed a similar-sounding bug. I was running from 0fe47acb737dea65a which includes that merge.\r\n\r\n@gsalgado probably has a better idea where to start",
  "closed_by": {
    "login": "gsalgado",
    "id": 412274,
    "node_id": "MDQ6VXNlcjQxMjI3NA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/412274?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/gsalgado",
    "html_url": "https://github.com/gsalgado",
    "followers_url": "https://api.github.com/users/gsalgado/followers",
    "following_url": "https://api.github.com/users/gsalgado/following{/other_user}",
    "gists_url": "https://api.github.com/users/gsalgado/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/gsalgado/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/gsalgado/subscriptions",
    "organizations_url": "https://api.github.com/users/gsalgado/orgs",
    "repos_url": "https://api.github.com/users/gsalgado/repos",
    "events_url": "https://api.github.com/users/gsalgado/events{/privacy}",
    "received_events_url": "https://api.github.com/users/gsalgado/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/py-evm/issues/901/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/py-evm/issues/901/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/396724381",
    "html_url": "https://github.com/ethereum/py-evm/issues/901#issuecomment-396724381",
    "issue_url": "https://api.github.com/repos/ethereum/py-evm/issues/901",
    "id": 396724381,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM5NjcyNDM4MQ==",
    "user": {
      "login": "veox",
      "id": 3036030,
      "node_id": "MDQ6VXNlcjMwMzYwMzA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3036030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/veox",
      "html_url": "https://github.com/veox",
      "followers_url": "https://api.github.com/users/veox/followers",
      "following_url": "https://api.github.com/users/veox/following{/other_user}",
      "gists_url": "https://api.github.com/users/veox/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/veox/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/veox/subscriptions",
      "organizations_url": "https://api.github.com/users/veox/orgs",
      "repos_url": "https://api.github.com/users/veox/repos",
      "events_url": "https://api.github.com/users/veox/events{/privacy}",
      "received_events_url": "https://api.github.com/users/veox/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-06-12T20:34:40Z",
    "updated_at": "2018-06-12T20:41:00Z",
    "author_association": "CONTRIBUTOR",
    "body": "It is a Parity node with no matching capabilities:\r\n\r\n```\r\n   DEBUG  06-12 23:32:48        peer  Connecting to <Node(0x94c1@192.81.208.223)>...\r\n   DEBUG  06-12 23:32:48  lightchain  fetched headers from 0 to 191\r\n   DEBUG  06-12 23:32:48        peer  Could not complete handshake with <Node(0x94c1@192.81.208.223)>: HandshakeFailure(\"No matching capabilities between us ([('les', 1), ('les', 2)]) and <Node(0x94c1@192.81.208.223)> ((('eth', 62), ('eth', 63), ('par', 1), ('par', 2), ('pip', 1))), disconnecting\",)\r\n```\r\n\r\nThis with `trinity-v0.1.0-alpha.11-33-g4958c6a`.\r\n\r\nWith `trinity-v0.1.0-alpha.11-34-g0fe47ac` - after merge of #889; same commit as in your case! - I get the same `HandshakeFailure` behaviour.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/396724381/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/396843826",
    "html_url": "https://github.com/ethereum/py-evm/issues/901#issuecomment-396843826",
    "issue_url": "https://api.github.com/repos/ethereum/py-evm/issues/901",
    "id": 396843826,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM5Njg0MzgyNg==",
    "user": {
      "login": "gsalgado",
      "id": 412274,
      "node_id": "MDQ6VXNlcjQxMjI3NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/412274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gsalgado",
      "html_url": "https://github.com/gsalgado",
      "followers_url": "https://api.github.com/users/gsalgado/followers",
      "following_url": "https://api.github.com/users/gsalgado/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsalgado/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gsalgado/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsalgado/subscriptions",
      "organizations_url": "https://api.github.com/users/gsalgado/orgs",
      "repos_url": "https://api.github.com/users/gsalgado/repos",
      "events_url": "https://api.github.com/users/gsalgado/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gsalgado/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-06-13T07:37:22Z",
    "updated_at": "2018-06-13T07:37:22Z",
    "author_association": "MEMBER",
    "body": "The  Bad ack log msg is from connecting to a different peer -- it is generated by the auth handshake, which happens before the actual P2P handshake. We need to log more info about the peer when we get those bad acks",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/396843826/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/396872315",
    "html_url": "https://github.com/ethereum/py-evm/issues/901#issuecomment-396872315",
    "issue_url": "https://api.github.com/repos/ethereum/py-evm/issues/901",
    "id": 396872315,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM5Njg3MjMxNQ==",
    "user": {
      "login": "gsalgado",
      "id": 412274,
      "node_id": "MDQ6VXNlcjQxMjI3NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/412274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gsalgado",
      "html_url": "https://github.com/gsalgado",
      "followers_url": "https://api.github.com/users/gsalgado/followers",
      "following_url": "https://api.github.com/users/gsalgado/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsalgado/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gsalgado/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsalgado/subscriptions",
      "organizations_url": "https://api.github.com/users/gsalgado/orgs",
      "repos_url": "https://api.github.com/users/gsalgado/repos",
      "events_url": "https://api.github.com/users/gsalgado/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gsalgado/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-06-13T09:19:34Z",
    "updated_at": "2018-06-13T09:19:34Z",
    "author_association": "MEMBER",
    "body": "Ok, I was wrong, it is actually that node that is giving us a BadAck, and that seems to happen only when it has seen our node ID before and knows we don't have matching protocols. When I used my trinity node ID to connect to it, I got a BadAck as well:\r\n>     INFO  06-13 09:58:31        peer  Got bad auth ack from <Node(0x94c15d1b9e2fe7ce56e458b9a3b672ef11894ddedd0c6f247e0f1d3487f52b66208fb4aeb8179fce6e3a749ea93ed147c37976d67af557508d199d9594c35f09@192.81.208.223:30303)>\r\n\r\nWhen I used a different node ID and had matching protocols, I was able to connect just fine:\r\n> 2018-06-13 10:06:36,139 DEBUG: Successfully decoded Status (cmd_id=16) msg: {'protocol_version': 63, 'network_id': 3, 'td': 7977346058529846, 'best_hash': b'S\\xd5\\xfdu\\xa2\\x9c)\\xca\\x95x<\\xf8\\xa9\\x80\\xfb\\x94\\xdbtU\\x9e\\x1dX\\x06\\xcc\\xed\\xc9\\xdba\\x0fs\\x82\\x98', 'genesis_hash': b'A\\x94\\x10#h\\t#\\xe0\\xfeMt\\xa3K\\xda\\xc8\\x14\\x1f%@\\xe3\\xae\\x90b7\\x18\\xe4}f\\xd1\\xcaJ-'}\r\n2018-06-13 10:06:36,145 DEBUG: Finished (eth, 63) handshake with <Node(0x94c1@192.81.208.223)>\r\n\r\nFinally, with a different node ID and no matching protocols, the first time it does the auth dance and sends us a `Hello` msg, but the second time it already knows we don't have a matching protocol so it closes the connection before sending any data, which causes the `BadAck`:\r\n> 2018-06-13 10:12:42,200 DEBUG: Waiting for 192 bytes from <Node(0x94c1@192.81.208.223)>\r\n2018-06-13 10:12:42,205 DEBUG: Got msg with cmd_id: 0\r\n2018-06-13 10:12:42,205 DEBUG: Successfully decoded Hello (cmd_id=0) msg: {'version': 5, 'client_version_string': 'Parity/v1.9.2-beta-0feb0bb-20180201/x86_64-linux-gnu/rustc1.23.0', 'capabilities': (('eth', 62), ('eth', 63), ('par', 1), ('par', 2), ('pip', 1)), 'listen_port': 30303, 'remote_pubkey': b'\\x94\\xc1]\\x1b\\x9e/\\xe7\\xceV\\xe4X\\xb9\\xa3\\xb6r\\xef\\x11\\x89M\\xde\\xdd\\x0co$~\\x0f\\x1d4\\x87\\xf5+f \\x8f\\xb4\\xae\\xb8\\x17\\x9f\\xcen:t\\x9e\\xa9>\\xd1G\\xc3yv\\xd6z\\xf5WP\\x8d\\x19\\x9d\\x95\\x94\\xc3_\\t'}\r\n2018-06-13 10:12:42,206 DEBUG: Sending msg with cmd_id: 1\r\n2018-06-13 10:12:42,209 DEBUG: Could not complete handshake with <Node(0x94c15d1b9e2fe7ce56e458b9a3b672ef11894ddedd0c6f247e0f1d3487f52b66208fb4aeb8179fce6e3a749ea93ed147c37976d67af557508d199d9594c35f09@192.81.208.223:30303)>: HandshakeFailure(\"No matching capabilities between us ([('les', 1), ('les', 2)]) and <Node(0x94c1@192.81.208.223)> ((('eth', 62), ('eth', 63), ('par', 1), ('par', 2), ('pip', 1))), disconnecting\",)\r\n[...]\r\n2018-06-13 10:12:42,209 DEBUG: Connecting to <Node(0x94c1@192.81.208.223)>...\r\n2018-06-13 10:12:43,164 INFO: Got bad auth ack from <Node(0x94c15d1b9e2fe7ce56e458b9a3b672ef11894ddedd0c6f247e0f1d3487f52b66208fb4aeb8179fce6e3a749ea93ed147c37976d67af557508d199d9594c35f09@192.81.208.223:30303)>\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/396872315/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 1,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
