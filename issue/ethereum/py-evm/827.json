{
  "url": "https://api.github.com/repos/ethereum/py-evm/issues/827",
  "repository_url": "https://api.github.com/repos/ethereum/py-evm",
  "labels_url": "https://api.github.com/repos/ethereum/py-evm/issues/827/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/py-evm/issues/827/comments",
  "events_url": "https://api.github.com/repos/ethereum/py-evm/issues/827/events",
  "html_url": "https://github.com/ethereum/py-evm/issues/827",
  "id": 327814721,
  "node_id": "MDU6SXNzdWUzMjc4MTQ3MjE=",
  "number": 827,
  "title": "Clean Exit",
  "user": {
    "login": "fubuloubu",
    "id": 3859395,
    "node_id": "MDQ6VXNlcjM4NTkzOTU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3859395?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/fubuloubu",
    "html_url": "https://github.com/fubuloubu",
    "followers_url": "https://api.github.com/users/fubuloubu/followers",
    "following_url": "https://api.github.com/users/fubuloubu/following{/other_user}",
    "gists_url": "https://api.github.com/users/fubuloubu/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/fubuloubu/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/fubuloubu/subscriptions",
    "organizations_url": "https://api.github.com/users/fubuloubu/orgs",
    "repos_url": "https://api.github.com/users/fubuloubu/repos",
    "events_url": "https://api.github.com/users/fubuloubu/events{/privacy}",
    "received_events_url": "https://api.github.com/users/fubuloubu/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 815420353,
      "node_id": "MDU6TGFiZWw4MTU0MjAzNTM=",
      "url": "https://api.github.com/repos/ethereum/py-evm/labels/comp:%20trinity",
      "name": "comp: trinity",
      "color": "bfd4f2",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "gsalgado",
    "id": 412274,
    "node_id": "MDQ6VXNlcjQxMjI3NA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/412274?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/gsalgado",
    "html_url": "https://github.com/gsalgado",
    "followers_url": "https://api.github.com/users/gsalgado/followers",
    "following_url": "https://api.github.com/users/gsalgado/following{/other_user}",
    "gists_url": "https://api.github.com/users/gsalgado/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/gsalgado/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/gsalgado/subscriptions",
    "organizations_url": "https://api.github.com/users/gsalgado/orgs",
    "repos_url": "https://api.github.com/users/gsalgado/repos",
    "events_url": "https://api.github.com/users/gsalgado/events{/privacy}",
    "received_events_url": "https://api.github.com/users/gsalgado/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "gsalgado",
      "id": 412274,
      "node_id": "MDQ6VXNlcjQxMjI3NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/412274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gsalgado",
      "html_url": "https://github.com/gsalgado",
      "followers_url": "https://api.github.com/users/gsalgado/followers",
      "following_url": "https://api.github.com/users/gsalgado/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsalgado/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gsalgado/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsalgado/subscriptions",
      "organizations_url": "https://api.github.com/users/gsalgado/orgs",
      "repos_url": "https://api.github.com/users/gsalgado/repos",
      "events_url": "https://api.github.com/users/gsalgado/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gsalgado/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2018-05-30T16:53:16Z",
  "updated_at": "2018-06-04T16:47:34Z",
  "closed_at": "2018-06-04T16:47:34Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "### What is wrong?\r\n`ctrl+C` on a running node should trigger a shutdown, this occurs correctly.\r\n\r\nGetting extra error output from the terminal that should not be exposed to the user:\r\n```bash\r\n^CProcess Process-2:3:\r\nTraceback (most recent call last):\r\n  File \"/home/bryant/.pyenv/versions/3.6.5/lib/python3.6/multiprocessing/process.py\", line 258, in _bootstrap\r\n    self.run()\r\n  File \"/home/bryant/.pyenv/versions/3.6.5/lib/python3.6/multiprocessing/process.py\", line 93, in run\r\n    self._target(*self._args, **self._kwargs)\r\n  File \"/home/bryant/.pyenv/versions/3.6.5/lib/python3.6/concurrent/futures/process.py\", line 169, in _process_worker\r\n    call_item = call_queue.get(block=True)\r\n  File \"/home/bryant/.pyenv/versions/3.6.5/lib/python3.6/multiprocessing/queues.py\", line 94, in get\r\n    res = self._recv_bytes()\r\n  File \"/home/bryant/.pyenv/versions/3.6.5/lib/python3.6/multiprocessing/connection.py\", line 216, in recv_bytes\r\n    buf = self._recv_bytes(maxlength)\r\n    INFO  05-30 10:31:31        main  Keyboard Interrupt: Stopping\r\n  File \"/home/bryant/.pyenv/versions/3.6.5/lib/python3.6/multiprocessing/connection.py\", line 407, in _recv_bytes\r\n    buf = self._recv(4)\r\n  File \"/home/bryant/.pyenv/versions/3.6.5/lib/python3.6/multiprocessing/connection.py\", line 379, in _recv\r\n    chunk = read(handle, remaining)\r\nKeyboardInterrupt\r\n    INFO  05-30 10:31:31     service  <p2p.chain.FastChainSyncer object at 0x7ff4ad6666d8> finished: Cancellation requested by RopstenFullNode token\r\n    INFO  05-30 10:31:31       chain  Shutting down FastChainSyncer\r\n    INFO  05-30 10:31:31       chain  Waiting for 18 running peers to finish\r\n   ERROR  05-30 10:31:31        sync  Unclean exit from FullNodeSyncer\r\nTraceback (most recent call last):\r\n  File \"/home/bryant/Dropbox/work/Ethereum/py-evm/p2p/sync.py\", line 44, in _run\r\n    await self._sync()\r\n  File \"/home/bryant/Dropbox/work/Ethereum/py-evm/p2p/sync.py\", line 60, in _sync\r\n    head = await self.chaindb.coro_get_canonical_head()\r\n  File \"/home/bryant/Dropbox/work/Ethereum/py-evm/trinity/utils/mp.py\", line 23, in method\r\n    args,\r\n  File \"/home/bryant/.pyenv/versions/3.6.5/lib/python3.6/concurrent/futures/thread.py\", line 56, in run\r\n    result = self.fn(*self.args, **self.kwargs)\r\n  File \"/home/bryant/.pyenv/versions/3.6.5/lib/python3.6/multiprocessing/managers.py\", line 756, in _callmethod\r\n    conn.send((self._id, methodname, args, kwds))\r\n  File \"/home/bryant/.pyenv/versions/3.6.5/lib/python3.6/multiprocessing/connection.py\", line 206, in send\r\n    self._send_bytes(_ForkingPickler.dumps(obj))\r\n  File \"/home/bryant/.pyenv/versions/3.6.5/lib/python3.6/multiprocessing/connection.py\", line 404, in _send_bytes\r\n    self._send(header + buf)\r\n  File \"/home/bryant/.pyenv/versions/3.6.5/lib/python3.6/multiprocessing/connection.py\", line 368, in _send\r\n    n = write(self._handle, buf)\r\nBrokenPipeError: [Errno 32] Broken pipe\r\n    INFO  05-30 10:31:31      server  Closing server...\r\n    INFO  05-30 10:31:31     service  <p2p.peer.PreferredNodePeerPool object at 0x7ff4a69aa2b0> finished: Cancellation requested by PreferredNodePeerPool token\r\n    INFO  05-30 10:31:31        peer  Stopping all peers ...\r\n    INFO  05-30 10:31:31   discovery  stopping discovery\r\n```\r\n\r\n### How can we fix it?\r\nMay need to catch this and handle shutdowns more gracefully. ",
  "closed_by": {
    "login": "gsalgado",
    "id": 412274,
    "node_id": "MDQ6VXNlcjQxMjI3NA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/412274?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/gsalgado",
    "html_url": "https://github.com/gsalgado",
    "followers_url": "https://api.github.com/users/gsalgado/followers",
    "following_url": "https://api.github.com/users/gsalgado/following{/other_user}",
    "gists_url": "https://api.github.com/users/gsalgado/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/gsalgado/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/gsalgado/subscriptions",
    "organizations_url": "https://api.github.com/users/gsalgado/orgs",
    "repos_url": "https://api.github.com/users/gsalgado/repos",
    "events_url": "https://api.github.com/users/gsalgado/events{/privacy}",
    "received_events_url": "https://api.github.com/users/gsalgado/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/py-evm/issues/827/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/py-evm/issues/827/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/393505751",
    "html_url": "https://github.com/ethereum/py-evm/issues/827#issuecomment-393505751",
    "issue_url": "https://api.github.com/repos/ethereum/py-evm/issues/827",
    "id": 393505751,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM5MzUwNTc1MQ==",
    "user": {
      "login": "gsalgado",
      "id": 412274,
      "node_id": "MDQ6VXNlcjQxMjI3NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/412274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gsalgado",
      "html_url": "https://github.com/gsalgado",
      "followers_url": "https://api.github.com/users/gsalgado/followers",
      "following_url": "https://api.github.com/users/gsalgado/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsalgado/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gsalgado/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsalgado/subscriptions",
      "organizations_url": "https://api.github.com/users/gsalgado/orgs",
      "repos_url": "https://api.github.com/users/gsalgado/repos",
      "events_url": "https://api.github.com/users/gsalgado/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gsalgado/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-05-31T11:52:09Z",
    "updated_at": "2018-05-31T11:52:09Z",
    "author_association": "MEMBER",
    "body": "I think once #665 is fixed this will no longer happen, but not completely sure so leaving this open for now",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/393505751/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/394317506",
    "html_url": "https://github.com/ethereum/py-evm/issues/827#issuecomment-394317506",
    "issue_url": "https://api.github.com/repos/ethereum/py-evm/issues/827",
    "id": 394317506,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM5NDMxNzUwNg==",
    "user": {
      "login": "gsalgado",
      "id": 412274,
      "node_id": "MDQ6VXNlcjQxMjI3NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/412274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gsalgado",
      "html_url": "https://github.com/gsalgado",
      "followers_url": "https://api.github.com/users/gsalgado/followers",
      "following_url": "https://api.github.com/users/gsalgado/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsalgado/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gsalgado/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsalgado/subscriptions",
      "organizations_url": "https://api.github.com/users/gsalgado/orgs",
      "repos_url": "https://api.github.com/users/gsalgado/repos",
      "events_url": "https://api.github.com/users/gsalgado/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gsalgado/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-06-04T11:07:42Z",
    "updated_at": "2018-06-04T11:08:33Z",
    "author_association": "MEMBER",
    "body": "I've had a proper look into this today, and it turns out there's actually a few issues leading to it:\r\n\r\n1. When a user hits Ctrl+C in the terminal, the [SIGINT signal is sent to the foreground process group](http://pubs.opengroup.org/onlinepubs/000095399/basedefs/xbd_chap11.html#tag_11_01_09), which means both the networking and the database processes get interrupted at the same time and not in sequence (first networking, then database) as the code in [`trinity.main()` would like](https://github.com/ethereum/py-evm/blob/master/trinity/main.py#L170-L175)\r\n2. Our [database server catches the KeyboardInterrupt raised by the SIGINT](https://github.com/python/cpython/blob/3.6/Lib/multiprocessing/managers.py#L147-L161) shuts down and exits silently, so we don't realize but it will have already terminated by the time we run `kill_process_gracefully(database_server_process)` in `trinity.main()`\r\n3. Thanks to the above and #665, we get the `BrokenPipeError` in the chain syncer\r\n4. Finally, the unhandled `KeyboardInterrupt`s seem to be caused by us using the `spawn` context for the multiprocessing package. Here are the relevant passages from https://docs.python.org/3.6/library/multiprocessing.html: \r\n ```\r\nOn Unix using the spawn or forkserver start methods will also start a semaphore tracker process which tracks the unlinked\r\nnamed semaphores created by processes of the program.\r\n[...]\r\nIf the SIGINT signal generated by Ctrl-C arrives while the main thread is blocked by a call to BoundedSemaphore.acquire(),\r\nLock.acquire(), RLock.acquire(), Semaphore.acquire(), Condition.acquire() or Condition.wait() then the call will be immediately\r\ninterrupted and KeyboardInterrupt will be raised.\r\n ```",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/394317506/reactions",
      "total_count": 2,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 2,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/394370075",
    "html_url": "https://github.com/ethereum/py-evm/issues/827#issuecomment-394370075",
    "issue_url": "https://api.github.com/repos/ethereum/py-evm/issues/827",
    "id": 394370075,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM5NDM3MDA3NQ==",
    "user": {
      "login": "gsalgado",
      "id": 412274,
      "node_id": "MDQ6VXNlcjQxMjI3NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/412274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gsalgado",
      "html_url": "https://github.com/gsalgado",
      "followers_url": "https://api.github.com/users/gsalgado/followers",
      "following_url": "https://api.github.com/users/gsalgado/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsalgado/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gsalgado/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsalgado/subscriptions",
      "organizations_url": "https://api.github.com/users/gsalgado/orgs",
      "repos_url": "https://api.github.com/users/gsalgado/repos",
      "events_url": "https://api.github.com/users/gsalgado/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gsalgado/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-06-04T14:15:52Z",
    "updated_at": "2018-06-04T14:15:52Z",
    "author_association": "MEMBER",
    "body": "So, with #860 we should no longer get the BrokenPipeErrors here, and although there seem to be other cases in which we get unhandled exceptions when shutting down I think it's better to close this once #860 is merged and create separate ones for the others (e.g. #863 and #862)",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/394370075/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/394389163",
    "html_url": "https://github.com/ethereum/py-evm/issues/827#issuecomment-394389163",
    "issue_url": "https://api.github.com/repos/ethereum/py-evm/issues/827",
    "id": 394389163,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM5NDM4OTE2Mw==",
    "user": {
      "login": "fubuloubu",
      "id": 3859395,
      "node_id": "MDQ6VXNlcjM4NTkzOTU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3859395?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fubuloubu",
      "html_url": "https://github.com/fubuloubu",
      "followers_url": "https://api.github.com/users/fubuloubu/followers",
      "following_url": "https://api.github.com/users/fubuloubu/following{/other_user}",
      "gists_url": "https://api.github.com/users/fubuloubu/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fubuloubu/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fubuloubu/subscriptions",
      "organizations_url": "https://api.github.com/users/fubuloubu/orgs",
      "repos_url": "https://api.github.com/users/fubuloubu/repos",
      "events_url": "https://api.github.com/users/fubuloubu/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fubuloubu/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-06-04T15:08:41Z",
    "updated_at": "2018-06-04T15:08:41Z",
    "author_association": "MEMBER",
    "body": ":+1: I knew there was something weird going on",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/py-evm/issues/comments/394389163/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
