{
  "url": "https://api.github.com/repos/ethereum/solidity/issues/13039",
  "repository_url": "https://api.github.com/repos/ethereum/solidity",
  "labels_url": "https://api.github.com/repos/ethereum/solidity/issues/13039/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/solidity/issues/13039/comments",
  "events_url": "https://api.github.com/repos/ethereum/solidity/issues/13039/events",
  "html_url": "https://github.com/ethereum/solidity/issues/13039",
  "id": 1239743420,
  "node_id": "I_kwDOAm_5kc5J5Pu8",
  "number": 13039,
  "title": "[Optimizer] Does not respect returndatacopy specification",
  "user": {
    "login": "bshastry",
    "id": 2388185,
    "node_id": "MDQ6VXNlcjIzODgxODU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2388185?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/bshastry",
    "html_url": "https://github.com/bshastry",
    "followers_url": "https://api.github.com/users/bshastry/followers",
    "following_url": "https://api.github.com/users/bshastry/following{/other_user}",
    "gists_url": "https://api.github.com/users/bshastry/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/bshastry/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/bshastry/subscriptions",
    "organizations_url": "https://api.github.com/users/bshastry/orgs",
    "repos_url": "https://api.github.com/users/bshastry/repos",
    "events_url": "https://api.github.com/users/bshastry/events{/privacy}",
    "received_events_url": "https://api.github.com/users/bshastry/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 249074435,
      "node_id": "MDU6TGFiZWwyNDkwNzQ0MzU=",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/bug%20:bug:",
      "name": "bug :bug:",
      "color": "fc1313",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2022-05-18T10:20:08Z",
  "updated_at": "2022-05-23T09:32:27Z",
  "closed_at": "2022-05-23T09:32:27Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "The optimizer incorrectly optimizes out `returndatacopy` calls in the following contracts. Found by fuzzing and inputs from @hrkrshnn \r\n\r\n```\r\ncontract C {\r\n  fallback() external\r\n  {\r\n    assembly\r\n    {\r\n      returndatacopy(0, 0, 1)\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nand\r\n\r\n```\r\ncontract C {\r\n  fallback() external\r\n  {\r\n    assembly\r\n    {\r\n      returndatacopy(0, 1, 0)\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nFrom matrix chat\r\n\r\n@hrkrshnn quotes from the spec\r\n\r\n> This opcode has similar semantics to CALLDATACOPY, but instead of copying data from the call data, it copies data from the return data buffer. Furthermore, accessing the return data buffer beyond its size results in a failure; i.e. if start + length overflows or results in a value larger than RETURNDATASIZE, the current call stops in an out-of-gas condition. In particular, reading 0 bytes from the end of the buffer will read 0 bytes; reading 0 bytes from one-byte out of the buffer causes an exception.\r\n\r\nSo technically the optimizer should retain the returndatacopy call so that it would run out of gas.",
  "closed_by": {
    "login": "chriseth",
    "id": 9073706,
    "node_id": "MDQ6VXNlcjkwNzM3MDY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/9073706?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/chriseth",
    "html_url": "https://github.com/chriseth",
    "followers_url": "https://api.github.com/users/chriseth/followers",
    "following_url": "https://api.github.com/users/chriseth/following{/other_user}",
    "gists_url": "https://api.github.com/users/chriseth/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/chriseth/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/chriseth/subscriptions",
    "organizations_url": "https://api.github.com/users/chriseth/orgs",
    "repos_url": "https://api.github.com/users/chriseth/repos",
    "events_url": "https://api.github.com/users/chriseth/events{/privacy}",
    "received_events_url": "https://api.github.com/users/chriseth/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/13039/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/solidity/issues/13039/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1129838013",
    "html_url": "https://github.com/ethereum/solidity/issues/13039#issuecomment-1129838013",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13039",
    "id": 1129838013,
    "node_id": "IC_kwDOAm_5kc5DV_W9",
    "user": {
      "login": "bshastry",
      "id": 2388185,
      "node_id": "MDQ6VXNlcjIzODgxODU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2388185?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bshastry",
      "html_url": "https://github.com/bshastry",
      "followers_url": "https://api.github.com/users/bshastry/followers",
      "following_url": "https://api.github.com/users/bshastry/following{/other_user}",
      "gists_url": "https://api.github.com/users/bshastry/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bshastry/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bshastry/subscriptions",
      "organizations_url": "https://api.github.com/users/bshastry/orgs",
      "repos_url": "https://api.github.com/users/bshastry/repos",
      "events_url": "https://api.github.com/users/bshastry/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bshastry/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-18T10:24:51Z",
    "updated_at": "2022-05-18T10:25:25Z",
    "author_association": "MEMBER",
    "body": "I formatted the edge-cases into semantic test inputs as follows\r\n\r\n```\r\ncontract C {\r\n  fallback() external\r\n  {\r\n    assembly\r\n    {\r\n      returndatacopy(0, 1, 0) // read zero bytes past end-of-returndata-buffer\r\n    }\r\n  }\r\n}\r\n// ====\r\n// compileViaYul: also\r\n// ----\r\n// (): 7 -> FAILURE\r\n```\r\n\r\n```\r\ncontract C {\r\n  fallback() external\r\n  {\r\n    assembly\r\n    {\r\n      returndatacopy(0, 0, 1) // read 1 byte past end-of-returndata-buffer\r\n    }\r\n  }\r\n}\r\n// ====\r\n// compileViaYul: also\r\n// ----\r\n// (): 7 -> FAILURE\r\n```\r\n\r\nBoth correctly fail *without* optimization but incorrectly pass *with* optimization. Also both legacy and IR optimizers behave identically i.e., remove the returndatacopy call.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1129838013/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1129867150",
    "html_url": "https://github.com/ethereum/solidity/issues/13039#issuecomment-1129867150",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13039",
    "id": 1129867150,
    "node_id": "IC_kwDOAm_5kc5DWGeO",
    "user": {
      "login": "ekpyron",
      "id": 1347491,
      "node_id": "MDQ6VXNlcjEzNDc0OTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1347491?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ekpyron",
      "html_url": "https://github.com/ekpyron",
      "followers_url": "https://api.github.com/users/ekpyron/followers",
      "following_url": "https://api.github.com/users/ekpyron/following{/other_user}",
      "gists_url": "https://api.github.com/users/ekpyron/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ekpyron/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ekpyron/subscriptions",
      "organizations_url": "https://api.github.com/users/ekpyron/orgs",
      "repos_url": "https://api.github.com/users/ekpyron/repos",
      "events_url": "https://api.github.com/users/ekpyron/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ekpyron/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-18T10:59:37Z",
    "updated_at": "2022-05-18T10:59:37Z",
    "author_association": "MEMBER",
    "body": "@hrkrshnn mentioned in chat that IR codegen only uses ``returndatasize`` as length argument of ``returndatacopy``, so that should be fine. Given that @chriseth in chat:\r\n> we should check if the last argument is returndatasize() and only remove it in that case\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1129867150/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
