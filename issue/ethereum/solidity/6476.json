{
  "url": "https://api.github.com/repos/ethereum/solidity/issues/6476",
  "repository_url": "https://api.github.com/repos/ethereum/solidity",
  "labels_url": "https://api.github.com/repos/ethereum/solidity/issues/6476/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/solidity/issues/6476/comments",
  "events_url": "https://api.github.com/repos/ethereum/solidity/issues/6476/events",
  "html_url": "https://github.com/ethereum/solidity/issues/6476",
  "id": 429675502,
  "node_id": "MDU6SXNzdWU0Mjk2NzU1MDI=",
  "number": 6476,
  "title": "[yul optimizer] Introducing additional scopes considered benign?",
  "user": {
    "login": "bshastry",
    "id": 2388185,
    "node_id": "MDQ6VXNlcjIzODgxODU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2388185?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/bshastry",
    "html_url": "https://github.com/bshastry",
    "followers_url": "https://api.github.com/users/bshastry/followers",
    "following_url": "https://api.github.com/users/bshastry/following{/other_user}",
    "gists_url": "https://api.github.com/users/bshastry/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/bshastry/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/bshastry/subscriptions",
    "organizations_url": "https://api.github.com/users/bshastry/orgs",
    "repos_url": "https://api.github.com/users/bshastry/repos",
    "events_url": "https://api.github.com/users/bshastry/events{/privacy}",
    "received_events_url": "https://api.github.com/users/bshastry/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1282209978,
      "node_id": "MDU6TGFiZWwxMjgyMjA5OTc4",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/optimizer",
      "name": "optimizer",
      "color": "d4c5f9",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2019-04-05T09:57:58Z",
  "updated_at": "2019-04-12T10:34:48Z",
  "closed_at": "2019-04-12T10:34:48Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nWhen we run the yul optimizer on the following program\r\n\r\n```\r\n{\r\n        let a := 0\r\n        for {\r\n        }\r\n        iszero(eq(a, 98))\r\n        {\r\n            a := add(a, 1)\r\n        }\r\n        {\r\n            a := add(a, 1)\r\n        }\r\n}\r\n```\r\n\r\n... it gets \"optimized\" to\r\n\r\n```\r\n{\r\n    {\r\n        let a := 0\r\n        for {\r\n        }\r\n        iszero(eq(a, 98))\r\n        {\r\n            a := add(a, 1)\r\n        }\r\n        {\r\n            a := add(a, 1)\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nBytecode generated for unoptimized and optimized code are exactly the same as expected\r\n```\r\n60005b606281141515601c576001810190505b6001810190506002565b50\r\n60005b606281141515601c576001810190505b6001810190506002565b50\r\n```\r\n\r\nNote that the source code of the optimized version contains an additional nested scope (which is seemingly of little value). Of course, the two programs are semantically valid, so there is no cause for concern, but it tripped the fuzzer in a weird way.\r\n\r\n### Tripping the fuzzer\r\n\r\nWe set an upper bound (`maxSteps`) on the number of basic blocks executed by the interpreter. This is to bail out of infinite loops. The exact bound is not important to this discussion, let's just call it `N`\r\n\r\nIf the yul optimizer can introduce at least one additional block, it can happen that the unoptimized version contains `N-1` blocks and does not exceed the interpreter's upper bound on num basic blocks executed. However, the optimized version reaches this limit because the optimizer has introduced an additional block.\r\n\r\nThis causes the traces to differ because of our assumption that \"if the unoptimized code does not reach upper bound on number of basic blocks to be executed, then optimized code must not.\"\r\n\r\nSince this assumption is seemingly untrue, what we could do is to unconditionally bail out if \"maxSteps\" is reached, whether in the unoptimized or optimized code.",
  "closed_by": {
    "login": "ekpyron",
    "id": 1347491,
    "node_id": "MDQ6VXNlcjEzNDc0OTE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1347491?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ekpyron",
    "html_url": "https://github.com/ekpyron",
    "followers_url": "https://api.github.com/users/ekpyron/followers",
    "following_url": "https://api.github.com/users/ekpyron/following{/other_user}",
    "gists_url": "https://api.github.com/users/ekpyron/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ekpyron/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ekpyron/subscriptions",
    "organizations_url": "https://api.github.com/users/ekpyron/orgs",
    "repos_url": "https://api.github.com/users/ekpyron/repos",
    "events_url": "https://api.github.com/users/ekpyron/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ekpyron/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/6476/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/solidity/issues/6476/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/480237241",
    "html_url": "https://github.com/ethereum/solidity/issues/6476#issuecomment-480237241",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/6476",
    "id": 480237241,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ4MDIzNzI0MQ==",
    "user": {
      "login": "chriseth",
      "id": 9073706,
      "node_id": "MDQ6VXNlcjkwNzM3MDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9073706?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chriseth",
      "html_url": "https://github.com/chriseth",
      "followers_url": "https://api.github.com/users/chriseth/followers",
      "following_url": "https://api.github.com/users/chriseth/following{/other_user}",
      "gists_url": "https://api.github.com/users/chriseth/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chriseth/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chriseth/subscriptions",
      "organizations_url": "https://api.github.com/users/chriseth/orgs",
      "repos_url": "https://api.github.com/users/chriseth/repos",
      "events_url": "https://api.github.com/users/chriseth/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chriseth/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-04-05T11:09:14Z",
    "updated_at": "2019-04-05T11:09:14Z",
    "author_association": "MEMBER",
    "body": "The optimizer can also unify blocks, inline functions, etc., so I think we cannot rely on those two bounds being the same anyway.\r\n\r\nDoes it make sense to set the bound to some value `N` when executing the non-optimized version and setting it to `N * 1.5` when executing the optimized version? This should make the assumption you name true again in most cases, and the cases where it fails should be inspected manually anyway, because it sounds like the optimizer did  a bad job for those.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/480237241/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/480720299",
    "html_url": "https://github.com/ethereum/solidity/issues/6476#issuecomment-480720299",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/6476",
    "id": 480720299,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ4MDcyMDI5OQ==",
    "user": {
      "login": "bshastry",
      "id": 2388185,
      "node_id": "MDQ6VXNlcjIzODgxODU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2388185?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bshastry",
      "html_url": "https://github.com/bshastry",
      "followers_url": "https://api.github.com/users/bshastry/followers",
      "following_url": "https://api.github.com/users/bshastry/following{/other_user}",
      "gists_url": "https://api.github.com/users/bshastry/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bshastry/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bshastry/subscriptions",
      "organizations_url": "https://api.github.com/users/bshastry/orgs",
      "repos_url": "https://api.github.com/users/bshastry/repos",
      "events_url": "https://api.github.com/users/bshastry/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bshastry/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-04-08T07:41:33Z",
    "updated_at": "2019-04-08T07:41:33Z",
    "author_association": "MEMBER",
    "body": "> Does it make sense to set the bound to some value N when executing the non-optimized version and setting it to N * 1.5 when executing the optimized version? This should make the assumption you name true again in most cases, and the cases where it fails should be inspected manually anyway, because it sounds like the optimizer did a bad job for those.\r\n\r\nThis makes sense, I took your feedback into account in the PR (#6491 ) to close this issue.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/480720299/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
