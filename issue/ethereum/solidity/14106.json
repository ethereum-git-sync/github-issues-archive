{
  "url": "https://api.github.com/repos/ethereum/solidity/issues/14106",
  "repository_url": "https://api.github.com/repos/ethereum/solidity",
  "labels_url": "https://api.github.com/repos/ethereum/solidity/issues/14106/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/solidity/issues/14106/comments",
  "events_url": "https://api.github.com/repos/ethereum/solidity/issues/14106/events",
  "html_url": "https://github.com/ethereum/solidity/issues/14106",
  "id": 1659606687,
  "node_id": "I_kwDOAm_5kc5i65af",
  "number": 14106,
  "title": "Stack too deep error with a struct containing 16 members, only with public state variable",
  "user": {
    "login": "0xSamWitch",
    "id": 84033732,
    "node_id": "MDQ6VXNlcjg0MDMzNzMy",
    "avatar_url": "https://avatars.githubusercontent.com/u/84033732?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/0xSamWitch",
    "html_url": "https://github.com/0xSamWitch",
    "followers_url": "https://api.github.com/users/0xSamWitch/followers",
    "following_url": "https://api.github.com/users/0xSamWitch/following{/other_user}",
    "gists_url": "https://api.github.com/users/0xSamWitch/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/0xSamWitch/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/0xSamWitch/subscriptions",
    "organizations_url": "https://api.github.com/users/0xSamWitch/orgs",
    "repos_url": "https://api.github.com/users/0xSamWitch/repos",
    "events_url": "https://api.github.com/users/0xSamWitch/events{/privacy}",
    "received_events_url": "https://api.github.com/users/0xSamWitch/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 249074435,
      "node_id": "MDU6TGFiZWwyNDkwNzQ0MzU=",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/bug%20:bug:",
      "name": "bug :bug:",
      "color": "fc1313",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2023-04-08T18:30:21Z",
  "updated_at": "2023-04-11T10:19:40Z",
  "closed_at": "2023-04-11T10:19:40Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nUsing a struct with 16 members gives stack too deep error both with and without viaIR, but only with `public` state member. Changing `private` state and creating an equivalent function returning the struct compiles fine.\r\n\r\n## Environment\r\n\r\n- Compiler version:\r\n0.8.19\r\nRemix & hardhat using viaIR\r\n## Steps to Reproduce\r\n\r\nTry and compile this:\r\n```js\r\ncontract C {\r\n\r\n  struct Struct {\r\n    uint16 u1;\r\n    uint16 u2;\r\n    uint16 u3;\r\n    uint16 u4;\r\n    uint16 u5;\r\n    uint16 u6;\r\n    uint16 u7;\r\n    uint16 u8;\r\n    uint16 u9;\r\n    uint16 u10;\r\n    uint16 u11;\r\n    uint16 u12;\r\n    uint16 u13;\r\n    uint16 u14;\r\n    uint16 u15;\r\n    uint16 u16;\r\n  }  \r\n\r\n  Struct public myStruct; // <--- public gives an issue\r\n}\r\n```\r\n> CompilerError: Stack too deep. Try compiling with `--via-ir` (cli) or the equivalent `viaIR: true` (standard JSON) while enabling the optimizer. Otherwise, try removing local variables.\r\n\r\nUsing viaIR:\r\n> YulException: Cannot swap Slot RET with Variable value1: too deep in the stack by 1 slots in [ RET headStart value14 value13 value12 value11 value10 value9 value8 value7 value6 value5 value4 value3 value2 value15 value0 value1 ]\r\nmemoryguard was present.\r\n\r\nNow compile this, changing to private state variable and external function exporting it, works fine:\r\n```js\r\ncontract C {\r\n\r\n  struct Struct {\r\n    uint16 u1;\r\n    uint16 u2;\r\n    uint16 u3;\r\n    uint16 u4;\r\n    uint16 u5;\r\n    uint16 u6;\r\n    uint16 u7;\r\n    uint16 u8;\r\n    uint16 u9;\r\n    uint16 u10;\r\n    uint16 u11;\r\n    uint16 u12;\r\n    uint16 u13;\r\n    uint16 u14;\r\n    uint16 u15;\r\n    uint16 u16;\r\n  }\r\n  \r\n  Struct _myStruct; // <--- remove public and make getter\r\n\r\n  function myStruct() external view returns (Struct memory) {\r\n    return _myStruct;\r\n  }\r\n}\r\n```",
  "closed_by": {
    "login": "ekpyron",
    "id": 1347491,
    "node_id": "MDQ6VXNlcjEzNDc0OTE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1347491?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ekpyron",
    "html_url": "https://github.com/ekpyron",
    "followers_url": "https://api.github.com/users/ekpyron/followers",
    "following_url": "https://api.github.com/users/ekpyron/following{/other_user}",
    "gists_url": "https://api.github.com/users/ekpyron/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ekpyron/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ekpyron/subscriptions",
    "organizations_url": "https://api.github.com/users/ekpyron/orgs",
    "repos_url": "https://api.github.com/users/ekpyron/repos",
    "events_url": "https://api.github.com/users/ekpyron/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ekpyron/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/14106/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/solidity/issues/14106/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1500960353",
    "html_url": "https://github.com/ethereum/solidity/issues/14106#issuecomment-1500960353",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/14106",
    "id": 1500960353,
    "node_id": "IC_kwDOAm_5kc5ZdtZh",
    "user": {
      "login": "Upendra-Jaiswal",
      "id": 37846481,
      "node_id": "MDQ6VXNlcjM3ODQ2NDgx",
      "avatar_url": "https://avatars.githubusercontent.com/u/37846481?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Upendra-Jaiswal",
      "html_url": "https://github.com/Upendra-Jaiswal",
      "followers_url": "https://api.github.com/users/Upendra-Jaiswal/followers",
      "following_url": "https://api.github.com/users/Upendra-Jaiswal/following{/other_user}",
      "gists_url": "https://api.github.com/users/Upendra-Jaiswal/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Upendra-Jaiswal/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Upendra-Jaiswal/subscriptions",
      "organizations_url": "https://api.github.com/users/Upendra-Jaiswal/orgs",
      "repos_url": "https://api.github.com/users/Upendra-Jaiswal/repos",
      "events_url": "https://api.github.com/users/Upendra-Jaiswal/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Upendra-Jaiswal/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-08T19:21:35Z",
    "updated_at": "2023-04-09T05:57:03Z",
    "author_association": "NONE",
    "body": "Actually the issue is that when you declare struct in external scope,it doesn't get stored on stack, it is stored on storage or memory which has huge space to store. When you declare it as public,it gets stored in stack and gives \"stack too deep\" error.\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1500960353/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 1,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1501202940",
    "html_url": "https://github.com/ethereum/solidity/issues/14106#issuecomment-1501202940",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/14106",
    "id": 1501202940,
    "node_id": "IC_kwDOAm_5kc5Zeon8",
    "user": {
      "login": "Upendra-Jaiswal",
      "id": 37846481,
      "node_id": "MDQ6VXNlcjM3ODQ2NDgx",
      "avatar_url": "https://avatars.githubusercontent.com/u/37846481?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Upendra-Jaiswal",
      "html_url": "https://github.com/Upendra-Jaiswal",
      "followers_url": "https://api.github.com/users/Upendra-Jaiswal/followers",
      "following_url": "https://api.github.com/users/Upendra-Jaiswal/following{/other_user}",
      "gists_url": "https://api.github.com/users/Upendra-Jaiswal/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Upendra-Jaiswal/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Upendra-Jaiswal/subscriptions",
      "organizations_url": "https://api.github.com/users/Upendra-Jaiswal/orgs",
      "repos_url": "https://api.github.com/users/Upendra-Jaiswal/repos",
      "events_url": "https://api.github.com/users/Upendra-Jaiswal/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Upendra-Jaiswal/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-09T20:01:37Z",
    "updated_at": "2023-04-09T20:01:37Z",
    "author_association": "NONE",
    "body": "Error should be removed from public scope??",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1501202940/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1503060644",
    "html_url": "https://github.com/ethereum/solidity/issues/14106#issuecomment-1503060644",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/14106",
    "id": 1503060644,
    "node_id": "IC_kwDOAm_5kc5ZluKk",
    "user": {
      "login": "ekpyron",
      "id": 1347491,
      "node_id": "MDQ6VXNlcjEzNDc0OTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1347491?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ekpyron",
      "html_url": "https://github.com/ekpyron",
      "followers_url": "https://api.github.com/users/ekpyron/followers",
      "following_url": "https://api.github.com/users/ekpyron/following{/other_user}",
      "gists_url": "https://api.github.com/users/ekpyron/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ekpyron/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ekpyron/subscriptions",
      "organizations_url": "https://api.github.com/users/ekpyron/orgs",
      "repos_url": "https://api.github.com/users/ekpyron/repos",
      "events_url": "https://api.github.com/users/ekpyron/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ekpyron/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-11T10:19:40Z",
    "updated_at": "2023-04-11T10:19:40Z",
    "author_association": "MEMBER",
    "body": "First of all, for historic reasons, the generated public getter does *not* return a ``Struct memory``, but the 16 elements of the struct as tuple, which makes it harder to generate code for it without stack issues.\r\n\r\nHowever, if I compile your example with ``--via-ir --bin --optimize`` with solc 0.8.19, it actually compiles without issues. So I guess the issue you're seeing is that hardhat compiles the contract with reduced optimizations (e.g. ``--yul-optimizations \"u\"`` does trigger the issue). This is something that should still be fixed - ideally even with minimal optimizations only, the compiler should be able to prevent stack issues in this case.\r\n\r\nSo I'm linking this to https://github.com/ethereum/solidity/issues/13721, which is the umbrella issue for solving remaining stack issues like this and closing this issue as an example case to be considered for #13721.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1503060644/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
