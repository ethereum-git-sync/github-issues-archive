{
  "url": "https://api.github.com/repos/ethereum/solidity/issues/14056",
  "repository_url": "https://api.github.com/repos/ethereum/solidity",
  "labels_url": "https://api.github.com/repos/ethereum/solidity/issues/14056/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/solidity/issues/14056/comments",
  "events_url": "https://api.github.com/repos/ethereum/solidity/issues/14056/events",
  "html_url": "https://github.com/ethereum/solidity/issues/14056",
  "id": 1630934368,
  "node_id": "I_kwDOAm_5kc5hNhVg",
  "number": 14056,
  "title": "Costly keccak of parameter",
  "user": {
    "login": "drortirosh",
    "id": 40341007,
    "node_id": "MDQ6VXNlcjQwMzQxMDA3",
    "avatar_url": "https://avatars.githubusercontent.com/u/40341007?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/drortirosh",
    "html_url": "https://github.com/drortirosh",
    "followers_url": "https://api.github.com/users/drortirosh/followers",
    "following_url": "https://api.github.com/users/drortirosh/following{/other_user}",
    "gists_url": "https://api.github.com/users/drortirosh/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/drortirosh/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/drortirosh/subscriptions",
    "organizations_url": "https://api.github.com/users/drortirosh/orgs",
    "repos_url": "https://api.github.com/users/drortirosh/repos",
    "events_url": "https://api.github.com/users/drortirosh/events{/privacy}",
    "received_events_url": "https://api.github.com/users/drortirosh/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2023-03-19T13:07:42Z",
  "updated_at": "2023-03-24T11:50:11Z",
  "closed_at": "2023-03-24T11:42:19Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "Consider the following Remix sample.\r\n\r\nkeccak of `calldata` parameter takes  extra 150gas for no apparent reason. a simple assembly wrapper can be used to demonstrate getting the same result  for smaller cost.\r\nThis is a \"low-hanging fruit\" optimization. There are other places like this.\r\n\r\n```\r\n// SPDX-License-Identifier: GPL-3.0\r\n\r\npragma solidity >=0.7.0 <0.9.0;\r\nimport \"hardhat/console.sol\";\r\n\r\n//deploy this contract to run the 2 tests\r\ncontract Asd {\r\n    constructor() {\r\n        bytes memory d = \"A\";\r\n        new Test().work2(d);\r\n        new Test().work1(d);\r\n    }\r\n}\r\n\r\ncontract Test {\r\n\r\n    function calldataKeccak(bytes calldata data) internal pure returns (bytes32 ret) {\r\n        assembly {\r\n            let mem := mload(0x40)\r\n            let len := data.length\r\n            calldatacopy(mem, data.offset, len)\r\n            ret := keccak256(mem, len)\r\n        }\r\n    }\r\n\r\n    function work1(bytes calldata input) external view {\r\n        uint g= gasleft();\r\n        bytes32 data = keccak256(input);\r\n        uint g1 = gasleft();\r\n        console.logBytes32(data);\r\n        console.log('gas used', g-g1);\r\n    }\r\n\r\n    function work2(bytes calldata input) external view {\r\n        uint g= gasleft();\r\n        bytes32 data = calldataKeccak(input);\r\n        uint g1 = gasleft();\r\n        console.logBytes32(data);\r\n        console.log('gas used', g-g1);\r\n    }\r\n\r\n}\r\n\r\n```",
  "closed_by": {
    "login": "r0qs",
    "id": 457348,
    "node_id": "MDQ6VXNlcjQ1NzM0OA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/457348?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/r0qs",
    "html_url": "https://github.com/r0qs",
    "followers_url": "https://api.github.com/users/r0qs/followers",
    "following_url": "https://api.github.com/users/r0qs/following{/other_user}",
    "gists_url": "https://api.github.com/users/r0qs/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/r0qs/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/r0qs/subscriptions",
    "organizations_url": "https://api.github.com/users/r0qs/orgs",
    "repos_url": "https://api.github.com/users/r0qs/repos",
    "events_url": "https://api.github.com/users/r0qs/events{/privacy}",
    "received_events_url": "https://api.github.com/users/r0qs/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/14056/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/solidity/issues/14056/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1482669518",
    "html_url": "https://github.com/ethereum/solidity/issues/14056#issuecomment-1482669518",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/14056",
    "id": 1482669518,
    "node_id": "IC_kwDOAm_5kc5YX73O",
    "user": {
      "login": "r0qs",
      "id": 457348,
      "node_id": "MDQ6VXNlcjQ1NzM0OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/457348?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/r0qs",
      "html_url": "https://github.com/r0qs",
      "followers_url": "https://api.github.com/users/r0qs/followers",
      "following_url": "https://api.github.com/users/r0qs/following{/other_user}",
      "gists_url": "https://api.github.com/users/r0qs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/r0qs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/r0qs/subscriptions",
      "organizations_url": "https://api.github.com/users/r0qs/orgs",
      "repos_url": "https://api.github.com/users/r0qs/repos",
      "events_url": "https://api.github.com/users/r0qs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/r0qs/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-24T11:42:18Z",
    "updated_at": "2023-03-24T11:50:11Z",
    "author_association": "MEMBER",
    "body": "Hi @drortirosh thanks for reporting this. Please, consider the snippets below extracted from your example, ignoring the `console.log()` part:\r\n\r\n- sol-keccak.sol\r\n```solidity\r\ncontract Test {\r\n    function run(bytes calldata data) external pure returns (bytes32 ret) {\r\n        ret = keccak256(data);\r\n    }\r\n}\r\n```\r\n\r\n- yul-keccak.sol\r\n```solidity\r\ncontract Test {\r\n    function run(bytes calldata data) external pure returns (bytes32 ret) {\r\n        assembly {\r\n            let mem := mload(0x40)\r\n            let len := data.length\r\n            calldatacopy(mem, data.offset, len)\r\n            ret := keccak256(mem, len)\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n```sh\r\nforge debug --use 0.8.19 --via-ir --optimize sol-keccak.sol --sig \"run(bytes)\" 0x41\r\n# uses 468 gas\r\nforge debug --use 0.8.19 --via-ir --optimize yul-keccak.sol --sig \"run(bytes)\" 0x41\r\n# uses 410 gas\r\n```\r\n\r\nIf you run each of them using `--ir-optimized` compiler flag (e.g. `solc --ir-optimized sol-keccak.sol`), you will notice that the extra gas usage shown above comes from the fact that the Solidity code is doing proper memory allocation for the array and the assembly snippet is not. It does not move the free memory pointer or allocate a size field for the array.\r\n\r\nThis is an already know issue and it is similar to the following ones:\r\n\r\n- https://github.com/ethereum/solidity/issues/12335\r\n- https://github.com/ethereum/solidity/issues/13290\r\n- https://github.com/ethereum/solidity/issues/13885\r\n\r\nOptimizing this falls under https://github.com/ethereum/solidity/issues/13722 which is already in our roadmap. So, I will be closing this issue as duplicated. Please, feel free to reopen it if necessary.\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1482669518/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
