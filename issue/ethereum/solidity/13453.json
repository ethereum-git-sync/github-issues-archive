{
  "url": "https://api.github.com/repos/ethereum/solidity/issues/13453",
  "repository_url": "https://api.github.com/repos/ethereum/solidity",
  "labels_url": "https://api.github.com/repos/ethereum/solidity/issues/13453/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/solidity/issues/13453/comments",
  "events_url": "https://api.github.com/repos/ethereum/solidity/issues/13453/events",
  "html_url": "https://github.com/ethereum/solidity/issues/13453",
  "id": 1355136075,
  "node_id": "I_kwDOAm_5kc5QxbxL",
  "number": 13453,
  "title": "[Yul optimizer] Optimized code runs out of gas, unoptimized does not",
  "user": {
    "login": "bshastry",
    "id": 2388185,
    "node_id": "MDQ6VXNlcjIzODgxODU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2388185?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/bshastry",
    "html_url": "https://github.com/bshastry",
    "followers_url": "https://api.github.com/users/bshastry/followers",
    "following_url": "https://api.github.com/users/bshastry/following{/other_user}",
    "gists_url": "https://api.github.com/users/bshastry/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/bshastry/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/bshastry/subscriptions",
    "organizations_url": "https://api.github.com/users/bshastry/orgs",
    "repos_url": "https://api.github.com/users/bshastry/repos",
    "events_url": "https://api.github.com/users/bshastry/events{/privacy}",
    "received_events_url": "https://api.github.com/users/bshastry/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 249074435,
      "node_id": "MDU6TGFiZWwyNDkwNzQ0MzU=",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/bug%20:bug:",
      "name": "bug :bug:",
      "color": "fc1313",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2022-08-30T04:06:12Z",
  "updated_at": "2023-11-28T13:49:04Z",
  "closed_at": "2023-11-28T11:17:32Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "```\r\n{\r\n  for { let i_0 := 0 } lt(i_0, 1) { i_0 := add(i_0, 1) } {\r\n    mstore(lt(mload(0x100000000), and(signextend(true, 0), 4)), 0)\r\n  }\r\n}\r\n```\r\n\r\nthrows\r\n\r\nhttps://github.com/ethereum/solidity/blob/7fdd494da7afba5172cbbe7933c66bfde17284b7/test/tools/ossfuzz/StackReuseCodegenFuzzer.cpp#L152-L157\r\n\r\nEssentially\r\n  - unoptimized code may be successfully deployed and called\r\n  - optimized code may be successfully deployed but call returns `OUT_OF_GAS`\r\n",
  "closed_by": {
    "login": "ekpyron",
    "id": 1347491,
    "node_id": "MDQ6VXNlcjEzNDc0OTE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1347491?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ekpyron",
    "html_url": "https://github.com/ekpyron",
    "followers_url": "https://api.github.com/users/ekpyron/followers",
    "following_url": "https://api.github.com/users/ekpyron/following{/other_user}",
    "gists_url": "https://api.github.com/users/ekpyron/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ekpyron/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ekpyron/subscriptions",
    "organizations_url": "https://api.github.com/users/ekpyron/orgs",
    "repos_url": "https://api.github.com/users/ekpyron/repos",
    "events_url": "https://api.github.com/users/ekpyron/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ekpyron/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/13453/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/solidity/issues/13453/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1231154680",
    "html_url": "https://github.com/ethereum/solidity/issues/13453#issuecomment-1231154680",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13453",
    "id": 1231154680,
    "node_id": "IC_kwDOAm_5kc5JYe34",
    "user": {
      "login": "bshastry",
      "id": 2388185,
      "node_id": "MDQ6VXNlcjIzODgxODU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2388185?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bshastry",
      "html_url": "https://github.com/bshastry",
      "followers_url": "https://api.github.com/users/bshastry/followers",
      "following_url": "https://api.github.com/users/bshastry/following{/other_user}",
      "gists_url": "https://api.github.com/users/bshastry/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bshastry/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bshastry/subscriptions",
      "organizations_url": "https://api.github.com/users/bshastry/orgs",
      "repos_url": "https://api.github.com/users/bshastry/repos",
      "events_url": "https://api.github.com/users/bshastry/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bshastry/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-30T05:20:47Z",
    "updated_at": "2022-08-30T05:20:47Z",
    "author_association": "MEMBER",
    "body": "Not able to reproduce this outside the fuzzer e.g., via standalone yul optimizer/semantic tests etc. There is something weird going on here.\r\n\r\n@ekpyron Does anything strike you as odd?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1231154680/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1231167488",
    "html_url": "https://github.com/ethereum/solidity/issues/13453#issuecomment-1231167488",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13453",
    "id": 1231167488,
    "node_id": "IC_kwDOAm_5kc5JYiAA",
    "user": {
      "login": "bshastry",
      "id": 2388185,
      "node_id": "MDQ6VXNlcjIzODgxODU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2388185?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bshastry",
      "html_url": "https://github.com/bshastry",
      "followers_url": "https://api.github.com/users/bshastry/followers",
      "following_url": "https://api.github.com/users/bshastry/following{/other_user}",
      "gists_url": "https://api.github.com/users/bshastry/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bshastry/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bshastry/subscriptions",
      "organizations_url": "https://api.github.com/users/bshastry/orgs",
      "repos_url": "https://api.github.com/users/bshastry/repos",
      "events_url": "https://api.github.com/users/bshastry/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bshastry/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-30T05:39:43Z",
    "updated_at": "2022-08-30T05:46:51Z",
    "author_association": "MEMBER",
    "body": "Unoptimized byte code is\r\n\r\n60005b6001811015601557600080526001016002565b50\r\n\r\n```\r\nlabel_0000:\r\n\t0000    60  PUSH1 0x00\r\n\t0002    5B  JUMPDEST\r\n\t0003    60  PUSH1 0x01\r\n\t0005    81  DUP2\r\n\t0006    10  LT\r\n\t0007    15  ISZERO\r\n\t0008    60  PUSH1 0x15\r\n\t000A    57  *JUMPI\r\n\t// Stack delta = +1\r\n\t// Outputs[1] { @0000  stack[0] = 0x00 }\r\n\t// Block ends with conditional jump to [0x0015](https://ethervm.io/decompile#0015), if !(0x00 < 0x01)\r\n\r\nlabel_000B:\r\n\t// Incoming jump from [0x000A](https://ethervm.io/decompile#000A), if not !(stack[-1] < 0x01)\r\n\t// Incoming jump from [0x000A](https://ethervm.io/decompile#000A), if not !(0x00 < 0x01)\r\n\t// Inputs[1] { @0011  stack[-1] }\r\n\t000B    60  PUSH1 0x00\r\n\t000D    80  DUP1\r\n\t000E    52  MSTORE\r\n\t000F    60  PUSH1 0x01\r\n\t0011    01  ADD\r\n\t0012    60  PUSH1 0x02\r\n\t0014    56  *JUMP\r\n\t// Stack delta = +0\r\n\t// Outputs[2]\r\n\t// {\r\n\t//     @000E  memory[0x00:0x20] = 0x00\r\n\t//     @0011  stack[-1] = 0x01 + stack[-1]\r\n\t// }\r\n\t// Block ends with unconditional jump to [0x0002](https://ethervm.io/decompile#0002)\r\n\r\nlabel_0015:\r\n\t// Incoming jump from [0x000A](https://ethervm.io/decompile#000A), if !(stack[-1] < 0x01)\r\n\t// Incoming jump from [0x000A](https://ethervm.io/decompile#000A), if !(0x00 < 0x01)\r\n\t0015    5B  JUMPDEST\r\n\t0016    50  POP\r\n\t// Stack delta = -1\r\n\t// Block terminates\r\n```\r\n\r\nOptimised byte code is\r\n\r\n600080805b60018110600d57005b600190828464010000000051105201600456\r\n\r\n```\r\nlabel_0000:\r\n\t0000    60  PUSH1 0x00\r\n\t0002    80  DUP1\r\n\t0003    80  DUP1\r\n\t0004    5B  JUMPDEST\r\n\t0005    60  PUSH1 0x01\r\n\t0007    81  DUP2\r\n\t0008    10  LT\r\n\t0009    60  PUSH1 0x0d\r\n\t000B    57  *JUMPI\r\n\t// Stack delta = +3\r\n\t// Outputs[3]\r\n\t// {\r\n\t//     @0000  stack[0] = 0x00\r\n\t//     @0002  stack[1] = 0x00\r\n\t//     @0003  stack[2] = 0x00\r\n\t// }\r\n\t// Block ends with conditional jump to [0x000d](https://ethervm.io/decompile#000d), if 0x00 < 0x01\r\n\r\nlabel_000C:\r\n\t// Incoming jump from [0x000B](https://ethervm.io/decompile#000B), if not stack[-1] < 0x01\r\n\t// Incoming jump from [0x000B](https://ethervm.io/decompile#000B), if not 0x00 < 0x01\r\n\t000C    00  *STOP\r\n\t// Stack delta = +0\r\n\t// Outputs[1] { @000C  stop(); }\r\n\t// Block terminates\r\n\r\nlabel_000D:\r\n\t// Incoming jump from [0x000B](https://ethervm.io/decompile#000B), if stack[-1] < 0x01\r\n\t// Incoming jump from [0x000B](https://ethervm.io/decompile#000B), if 0x00 < 0x01\r\n\t// Inputs[4]\r\n\t// {\r\n\t//     @0010  stack[-1]\r\n\t//     @0011  stack[-2]\r\n\t//     @0012  stack[-3]\r\n\t//     @0019  memory[0x0100000000:0x0100000020]\r\n\t// }\r\n\t000D    5B  JUMPDEST\r\n\t000E    60  PUSH1 0x01\r\n\t0010    90  SWAP1\r\n\t0011    82  DUP3\r\n\t0012    84  DUP5\r\n\t0013    64  PUSH5 0x0100000000\r\n\t0019    51  MLOAD\r\n\t001A    10  LT\r\n\t001B    52  MSTORE\r\n\t001C    01  ADD\r\n\t001D    60  PUSH1 0x04\r\n\t001F    56  *JUMP\r\n\t// Stack delta = +0\r\n\t// Outputs[2]\r\n\t// {\r\n\t//     @001B  memory[memory[0x0100000000:0x0100000020] < stack[-3]:memory[0x0100000000:0x0100000020] < stack[-3] + 0x20] = stack[-2]\r\n\t//     @001C  stack[-1] = stack[-1] + 0x01\r\n\t// }\r\n\t// Block ends with unconditional jump to [0x0004](https://ethervm.io/decompile#0004)\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1231167488/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1231174703",
    "html_url": "https://github.com/ethereum/solidity/issues/13453#issuecomment-1231174703",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13453",
    "id": 1231174703,
    "node_id": "IC_kwDOAm_5kc5JYjwv",
    "user": {
      "login": "bshastry",
      "id": 2388185,
      "node_id": "MDQ6VXNlcjIzODgxODU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2388185?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bshastry",
      "html_url": "https://github.com/bshastry",
      "followers_url": "https://api.github.com/users/bshastry/followers",
      "following_url": "https://api.github.com/users/bshastry/following{/other_user}",
      "gists_url": "https://api.github.com/users/bshastry/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bshastry/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bshastry/subscriptions",
      "organizations_url": "https://api.github.com/users/bshastry/orgs",
      "repos_url": "https://api.github.com/users/bshastry/repos",
      "events_url": "https://api.github.com/users/bshastry/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bshastry/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-30T05:50:13Z",
    "updated_at": "2022-08-30T05:57:33Z",
    "author_association": "MEMBER",
    "body": "~~Why doesn't the unoptimized byte code execute the for loop?~~ Why is `MLOAD` missing in the unoptimized byte code?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1231174703/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1829617463",
    "html_url": "https://github.com/ethereum/solidity/issues/13453#issuecomment-1829617463",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13453",
    "id": 1829617463,
    "node_id": "IC_kwDOAm_5kc5tDb83",
    "user": {
      "login": "ekpyron",
      "id": 1347491,
      "node_id": "MDQ6VXNlcjEzNDc0OTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1347491?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ekpyron",
      "html_url": "https://github.com/ekpyron",
      "followers_url": "https://api.github.com/users/ekpyron/followers",
      "following_url": "https://api.github.com/users/ekpyron/following{/other_user}",
      "gists_url": "https://api.github.com/users/ekpyron/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ekpyron/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ekpyron/subscriptions",
      "organizations_url": "https://api.github.com/users/ekpyron/orgs",
      "repos_url": "https://api.github.com/users/ekpyron/repos",
      "events_url": "https://api.github.com/users/ekpyron/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ekpyron/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-11-28T11:17:32Z",
    "updated_at": "2023-11-28T11:17:32Z",
    "author_association": "MEMBER",
    "body": "``and(signextend(true, 0), 4)`` is zero, so the comparison is ``lt(mload(0x100000000), 0)``. Since nothing is ever less than zero, this can be optimized out to false (i.e. ``0``).\r\n\r\nNow the divergence is due to the fact that the mload itself will always run out of gas in practice - however, the optimizer has to assume unbounded gas to be available after which this is semantically correct.\r\n\r\nAt least that's my guess about what's happening here - although I'm not sure if optimized and unoptimized have been labelled incorrectly here :-).\r\n\r\nIn any case, there's no issue here, so I'm closing this.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1829617463/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
