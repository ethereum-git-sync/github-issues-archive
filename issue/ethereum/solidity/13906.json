{
  "url": "https://api.github.com/repos/ethereum/solidity/issues/13906",
  "repository_url": "https://api.github.com/repos/ethereum/solidity",
  "labels_url": "https://api.github.com/repos/ethereum/solidity/issues/13906/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/solidity/issues/13906/comments",
  "events_url": "https://api.github.com/repos/ethereum/solidity/issues/13906/events",
  "html_url": "https://github.com/ethereum/solidity/issues/13906",
  "id": 1563975406,
  "node_id": "I_kwDOAm_5kc5dOF7u",
  "number": 13906,
  "title": "viaIR: true, but still got YulException: Variable expr_25 is 1 too deep in the stack",
  "user": {
    "login": "greenlucid",
    "id": 40367733,
    "node_id": "MDQ6VXNlcjQwMzY3NzMz",
    "avatar_url": "https://avatars.githubusercontent.com/u/40367733?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/greenlucid",
    "html_url": "https://github.com/greenlucid",
    "followers_url": "https://api.github.com/users/greenlucid/followers",
    "following_url": "https://api.github.com/users/greenlucid/following{/other_user}",
    "gists_url": "https://api.github.com/users/greenlucid/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/greenlucid/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/greenlucid/subscriptions",
    "organizations_url": "https://api.github.com/users/greenlucid/orgs",
    "repos_url": "https://api.github.com/users/greenlucid/repos",
    "events_url": "https://api.github.com/users/greenlucid/events{/privacy}",
    "received_events_url": "https://api.github.com/users/greenlucid/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 249074435,
      "node_id": "MDU6TGFiZWwyNDkwNzQ0MzU=",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/bug%20:bug:",
      "name": "bug :bug:",
      "color": "fc1313",
      "default": false,
      "description": ""
    },
    {
      "id": 4438003076,
      "node_id": "LA_kwDOAm_5kc8AAAABCIaNhA",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/medium%20effort",
      "name": "medium effort",
      "color": "ff7df7",
      "default": false,
      "description": "Default level of effort"
    },
    {
      "id": 4438155599,
      "node_id": "LA_kwDOAm_5kc8AAAABCIjhTw",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/medium%20impact",
      "name": "medium impact",
      "color": "314aff",
      "default": false,
      "description": "Default level of impact"
    },
    {
      "id": 4438488423,
      "node_id": "LA_kwDOAm_5kc8AAAABCI31Zw",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/must%20have",
      "name": "must have",
      "color": "ffa12a",
      "default": false,
      "description": "Something we consider an essential part of Solidity 1.0."
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2023-01-31T09:44:20Z",
  "updated_at": "2023-06-26T12:20:07Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\n<!--Please shortly describe the bug you have found, and what you expect instead.-->\r\n\r\nI would have expected my code to compile, but I got \"too deep in the stack\" error. This is because I'm using viaIR: true (as I handle many variables)\r\nI looked around and found this function which I assume handled the error\r\nhttps://github.com/ethereum/solidity/blob/develop/libyul/backends/evm/OptimizedEVMCodeTransform.cpp#L273\r\n\r\nThis only happened after my last commit\r\n\r\n## Environment\r\n\r\n- Compiler version: v0.8.17\r\n- Target EVM version (as per compiler settings):  ? default\r\n- Framework/IDE (e.g. Truffle or Remix): Hardhat\r\n- EVM execution environment / backend / blockchain client: Hardhat ?\r\n- Operating system: Ubuntu 22.10\r\n\r\n## Steps to Reproduce\r\n\r\n### setup environment\r\n`git clone https://github.com/kleros/stake-curate`\r\n`git checkout 777dfd5f1bdd810491bcfce2794a8ba5c3cc49b3`\r\n`cd contracts`\r\n`yarn`\r\n\r\n### compile\r\n\r\n`npx hardhat size-contracts`",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/13906/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/solidity/issues/13906/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1410056849",
    "html_url": "https://github.com/ethereum/solidity/issues/13906#issuecomment-1410056849",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13906",
    "id": 1410056849,
    "node_id": "IC_kwDOAm_5kc5UC8KR",
    "user": {
      "login": "greenlucid",
      "id": 40367733,
      "node_id": "MDQ6VXNlcjQwMzY3NzMz",
      "avatar_url": "https://avatars.githubusercontent.com/u/40367733?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/greenlucid",
      "html_url": "https://github.com/greenlucid",
      "followers_url": "https://api.github.com/users/greenlucid/followers",
      "following_url": "https://api.github.com/users/greenlucid/following{/other_user}",
      "gists_url": "https://api.github.com/users/greenlucid/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/greenlucid/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/greenlucid/subscriptions",
      "organizations_url": "https://api.github.com/users/greenlucid/orgs",
      "repos_url": "https://api.github.com/users/greenlucid/repos",
      "events_url": "https://api.github.com/users/greenlucid/events{/privacy}",
      "received_events_url": "https://api.github.com/users/greenlucid/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-01-31T09:48:32Z",
    "updated_at": "2023-01-31T09:48:32Z",
    "author_association": "NONE",
    "body": "Any suggestions to work around this issue are welcome (should I split the offending code into more functions?)\r\nalthough in this case, the compiler error is not telling me which function is producing the error, so I can only guess.\r\n\r\nI suspect it's this line https://github.com/kleros/stake-curate/blob/777dfd5f1bdd810491bcfce2794a8ba5c3cc49b3/contracts/contracts/StakeCurate.sol#L816 ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1410056849/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1417335621",
    "html_url": "https://github.com/ethereum/solidity/issues/13906#issuecomment-1417335621",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13906",
    "id": 1417335621,
    "node_id": "IC_kwDOAm_5kc5UetNF",
    "user": {
      "login": "cameel",
      "id": 137030,
      "node_id": "MDQ6VXNlcjEzNzAzMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cameel",
      "html_url": "https://github.com/cameel",
      "followers_url": "https://api.github.com/users/cameel/followers",
      "following_url": "https://api.github.com/users/cameel/following{/other_user}",
      "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
      "organizations_url": "https://api.github.com/users/cameel/orgs",
      "repos_url": "https://api.github.com/users/cameel/repos",
      "events_url": "https://api.github.com/users/cameel/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cameel/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-02-05T10:16:03Z",
    "updated_at": "2023-02-05T10:16:03Z",
    "author_association": "MEMBER",
    "body": "I reduced this to a minimal example:\r\n\r\n```bash\r\nsolc test.sol --optimize --via-ir --bin\r\n```\r\n```solidity\r\ncontract C {\r\n    struct S1 {\r\n        uint a;\r\n        uint b;\r\n    }\r\n\r\n    struct S2 {\r\n        uint a;\r\n        uint b;\r\n        uint c;\r\n        uint d;\r\n        uint e;\r\n        uint f;\r\n        uint g;\r\n        uint h;\r\n        uint i;\r\n    }\r\n\r\n    struct S3 {\r\n        uint a;\r\n        uint b;\r\n        uint c;\r\n        uint d;\r\n        uint e;\r\n        uint f;\r\n        uint g;\r\n        uint h;\r\n        uint i;\r\n        uint j;\r\n        uint k;\r\n    }\r\n\r\n    struct S4 {\r\n        uint56 a56;\r\n        uint b;\r\n        uint c;\r\n        uint d;\r\n        uint e;\r\n        uint32 f32;\r\n        uint g;\r\n        uint h;\r\n        uint i;\r\n        uint j;\r\n        uint k;\r\n    }\r\n\r\n    struct S5 {\r\n        uint a;\r\n    }\r\n\r\n    mapping(uint => S4) s4map;\r\n\r\n    function ext1() external pure returns (uint) {}\r\n    function ext2(uint) external returns (bool) {}\r\n\r\n    function to32(uint x) internal pure returns (uint32) {\r\n        if (x == 0)\r\n            return 0;\r\n    }\r\n\r\n    function main1() external {\r\n        S3(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);\r\n    }\r\n\r\n    function main2(bytes calldata) external {\r\n        S1 memory s1;\r\n        S2 memory s2;\r\n        S3 memory s3;\r\n        S5 memory s5;\r\n\r\n        uint u1 = this.ext1();\r\n        uint u2 = uint32(s1.a);\r\n        uint u3 = s2.a * u2 / 10000;\r\n\r\n        this.ext2(s1.a);\r\n        if (u1 + u2 > 0)\r\n            this.ext2(u1);\r\n\r\n        payable(address(uint160(s5.a))).send(u1);\r\n\r\n        s4map[0] = S4({\r\n            a56: 0,\r\n            b: uint56(s1.b),\r\n            c: 0,\r\n            d: to32(u2 / 10000),\r\n            e: to32(u1 + u1),\r\n            f32: uint32(s3.a),\r\n            g: s2.a,\r\n            h: 0,\r\n            i: to32(u3),\r\n            j: 0,\r\n            k: 0\r\n        });\r\n    }\r\n}\r\n```\r\nReproducible down to 0.8.15.\r\n\r\n@ekpyron Hopefully this is small enough to debug the EVM transform.\r\n\r\n@greenlucid As for a workaround, there seem to be quite a few details that need to be combined to cause this - changing pretty much anything in the above repro makes the error go away and it's not even that small. `main2()` is based on `revealChallenge()`. Try moving things around in that function or adding/removing locals. For example simply swapping [`send()` and `transfer()` lines makes the error go away for me](https://github.com/kleros/stake-curate/blob/777dfd5f1bdd810491bcfce2794a8ba5c3cc49b3/contracts/contracts/StakeCurate.sol#L806-L807).",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1417335621/reactions",
      "total_count": 2,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 2,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1420341736",
    "html_url": "https://github.com/ethereum/solidity/issues/13906#issuecomment-1420341736",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13906",
    "id": 1420341736,
    "node_id": "IC_kwDOAm_5kc5UqLHo",
    "user": {
      "login": "greenlucid",
      "id": 40367733,
      "node_id": "MDQ6VXNlcjQwMzY3NzMz",
      "avatar_url": "https://avatars.githubusercontent.com/u/40367733?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/greenlucid",
      "html_url": "https://github.com/greenlucid",
      "followers_url": "https://api.github.com/users/greenlucid/followers",
      "following_url": "https://api.github.com/users/greenlucid/following{/other_user}",
      "gists_url": "https://api.github.com/users/greenlucid/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/greenlucid/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/greenlucid/subscriptions",
      "organizations_url": "https://api.github.com/users/greenlucid/orgs",
      "repos_url": "https://api.github.com/users/greenlucid/repos",
      "events_url": "https://api.github.com/users/greenlucid/events{/privacy}",
      "received_events_url": "https://api.github.com/users/greenlucid/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-02-07T07:55:09Z",
    "updated_at": "2023-02-07T07:55:09Z",
    "author_association": "NONE",
    "body": "I find that repro fascinating, and highly specific. Thanks for looking into it. Swapping two lines and having it compile blew my mind",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1420341736/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1420415963",
    "html_url": "https://github.com/ethereum/solidity/issues/13906#issuecomment-1420415963",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13906",
    "id": 1420415963,
    "node_id": "IC_kwDOAm_5kc5UqdPb",
    "user": {
      "login": "cameel",
      "id": 137030,
      "node_id": "MDQ6VXNlcjEzNzAzMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cameel",
      "html_url": "https://github.com/cameel",
      "followers_url": "https://api.github.com/users/cameel/followers",
      "following_url": "https://api.github.com/users/cameel/following{/other_user}",
      "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
      "organizations_url": "https://api.github.com/users/cameel/orgs",
      "repos_url": "https://api.github.com/users/cameel/repos",
      "events_url": "https://api.github.com/users/cameel/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cameel/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-02-07T08:58:32Z",
    "updated_at": "2023-02-07T08:59:30Z",
    "author_association": "MEMBER",
    "body": "Well, the annoying thing about the Yul->EVM transform is that having 16 stack slots to play with gives it plenty of headroom in simple examples and the ones to trip it must reach a certain level of complexity. That's hard to test manually. This repro is what you get when you take real code and cut out absolutely everything that's not relevant to the problem - you're still left with quite a lot :) It's not any single feature causing the problem, just this particular arrangement of features. This is also why the error goes away when you keep the same features but just move them around a bit.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1420415963/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
