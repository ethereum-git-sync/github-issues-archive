{
  "url": "https://api.github.com/repos/ethereum/solidity/issues/12368",
  "repository_url": "https://api.github.com/repos/ethereum/solidity",
  "labels_url": "https://api.github.com/repos/ethereum/solidity/issues/12368/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/solidity/issues/12368/comments",
  "events_url": "https://api.github.com/repos/ethereum/solidity/issues/12368/events",
  "html_url": "https://github.com/ethereum/solidity/issues/12368",
  "id": 1071551299,
  "node_id": "I_kwDOAm_5kc4_3pND",
  "number": 12368,
  "title": "[Bug] Yul: Empty error for integer conversion to an enum type",
  "user": {
    "login": "hedgar2017",
    "id": 31586236,
    "node_id": "MDQ6VXNlcjMxNTg2MjM2",
    "avatar_url": "https://avatars.githubusercontent.com/u/31586236?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/hedgar2017",
    "html_url": "https://github.com/hedgar2017",
    "followers_url": "https://api.github.com/users/hedgar2017/followers",
    "following_url": "https://api.github.com/users/hedgar2017/following{/other_user}",
    "gists_url": "https://api.github.com/users/hedgar2017/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/hedgar2017/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/hedgar2017/subscriptions",
    "organizations_url": "https://api.github.com/users/hedgar2017/orgs",
    "repos_url": "https://api.github.com/users/hedgar2017/repos",
    "events_url": "https://api.github.com/users/hedgar2017/events{/privacy}",
    "received_events_url": "https://api.github.com/users/hedgar2017/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2021-12-05T20:35:35Z",
  "updated_at": "2021-12-15T14:08:58Z",
  "closed_at": "2021-12-15T14:08:57Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nInteger to enum conversion error is invalid in Yul of `solc 0.8.10`. Empty error is returned instead of `0x21`.\r\n\r\n## Environment\r\n\r\n- Compiler version: 0.8.10\r\n- Target: Yul\r\n- Operating system: Arch Linux (Manjaro) x64\r\n\r\n## Steps to Reproduce\r\n\r\n1. Compile https://solidity-by-example.org/enum/ with `solc 0.8.10` to Yul with optimizations (`--ir-optimized --optimize`).\r\n2. Check the `set` method IR. It performs `revert(0, 0)` if the value is too big, whereas it should return the error `0x21`.",
  "closed_by": {
    "login": "hedgar2017",
    "id": 31586236,
    "node_id": "MDQ6VXNlcjMxNTg2MjM2",
    "avatar_url": "https://avatars.githubusercontent.com/u/31586236?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/hedgar2017",
    "html_url": "https://github.com/hedgar2017",
    "followers_url": "https://api.github.com/users/hedgar2017/followers",
    "following_url": "https://api.github.com/users/hedgar2017/following{/other_user}",
    "gists_url": "https://api.github.com/users/hedgar2017/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/hedgar2017/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/hedgar2017/subscriptions",
    "organizations_url": "https://api.github.com/users/hedgar2017/orgs",
    "repos_url": "https://api.github.com/users/hedgar2017/repos",
    "events_url": "https://api.github.com/users/hedgar2017/events{/privacy}",
    "received_events_url": "https://api.github.com/users/hedgar2017/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/12368/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/solidity/issues/12368/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/986616484",
    "html_url": "https://github.com/ethereum/solidity/issues/12368#issuecomment-986616484",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/12368",
    "id": 986616484,
    "node_id": "IC_kwDOAm_5kc46zpKk",
    "user": {
      "login": "chriseth",
      "id": 9073706,
      "node_id": "MDQ6VXNlcjkwNzM3MDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9073706?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chriseth",
      "html_url": "https://github.com/chriseth",
      "followers_url": "https://api.github.com/users/chriseth/followers",
      "following_url": "https://api.github.com/users/chriseth/following{/other_user}",
      "gists_url": "https://api.github.com/users/chriseth/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chriseth/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chriseth/subscriptions",
      "organizations_url": "https://api.github.com/users/chriseth/orgs",
      "repos_url": "https://api.github.com/users/chriseth/repos",
      "events_url": "https://api.github.com/users/chriseth/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chriseth/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-12-06T09:58:42Z",
    "updated_at": "2021-12-06T09:58:42Z",
    "author_association": "MEMBER",
    "body": "I cannot reproduce this on a smaller example:\r\n```\r\nenum Status { Pending }\r\n\r\ncontract Enum {\r\n    fallback() external {\r\n        int x = 9;\r\n        Status(x);\r\n    }\r\n}\r\n```\r\n\r\n`# solc --optimize --experimental-via-ir --ir-optimized example.sol`\r\n\r\n```\r\nobject \"Enum_15\" {\r\n    code {\r\n        {\r\n            let _1 := memoryguard(0x80)\r\n            mstore(64, _1)\r\n            if callvalue() { revert(0, 0) }\r\n            let _2 := datasize(\"Enum_15_deployed\")\r\n            codecopy(_1, dataoffset(\"Enum_15_deployed\"), _2)\r\n            return(_1, _2)\r\n        }\r\n    }\r\n    object \"Enum_15_deployed\" {\r\n        code {\r\n            {\r\n                mstore(64, memoryguard(0x80))\r\n                if callvalue() { revert(0, 0) }\r\n                mstore(0, shl(224, 0x4e487b71))\r\n                mstore(4, 0x21)\r\n                revert(0, 0x24)\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/986616484/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/988619109",
    "html_url": "https://github.com/ethereum/solidity/issues/12368#issuecomment-988619109",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/12368",
    "id": 988619109,
    "node_id": "IC_kwDOAm_5kc467SFl",
    "user": {
      "login": "hedgar2017",
      "id": 31586236,
      "node_id": "MDQ6VXNlcjMxNTg2MjM2",
      "avatar_url": "https://avatars.githubusercontent.com/u/31586236?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hedgar2017",
      "html_url": "https://github.com/hedgar2017",
      "followers_url": "https://api.github.com/users/hedgar2017/followers",
      "following_url": "https://api.github.com/users/hedgar2017/following{/other_user}",
      "gists_url": "https://api.github.com/users/hedgar2017/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hedgar2017/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hedgar2017/subscriptions",
      "organizations_url": "https://api.github.com/users/hedgar2017/orgs",
      "repos_url": "https://api.github.com/users/hedgar2017/repos",
      "events_url": "https://api.github.com/users/hedgar2017/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hedgar2017/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-12-08T08:56:59Z",
    "updated_at": "2021-12-08T08:57:36Z",
    "author_association": "NONE",
    "body": "May not be happening here. Please, try the original one.\nI can post its Yul here a bit later.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/988619109/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/989869585",
    "html_url": "https://github.com/ethereum/solidity/issues/12368#issuecomment-989869585",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/12368",
    "id": 989869585,
    "node_id": "IC_kwDOAm_5kc47ADYR",
    "user": {
      "login": "hedgar2017",
      "id": 31586236,
      "node_id": "MDQ6VXNlcjMxNTg2MjM2",
      "avatar_url": "https://avatars.githubusercontent.com/u/31586236?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hedgar2017",
      "html_url": "https://github.com/hedgar2017",
      "followers_url": "https://api.github.com/users/hedgar2017/followers",
      "following_url": "https://api.github.com/users/hedgar2017/following{/other_user}",
      "gists_url": "https://api.github.com/users/hedgar2017/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hedgar2017/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hedgar2017/subscriptions",
      "organizations_url": "https://api.github.com/users/hedgar2017/orgs",
      "repos_url": "https://api.github.com/users/hedgar2017/repos",
      "events_url": "https://api.github.com/users/hedgar2017/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hedgar2017/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-12-09T13:49:31Z",
    "updated_at": "2021-12-09T13:49:31Z",
    "author_association": "NONE",
    "body": "```\r\n/*=====================================================*\r\n *                       WARNING                       *\r\n *  Solidity to Yul compilation is still EXPERIMENTAL  *\r\n *       It can result in LOSS OF FUNDS or worse       *\r\n *                !USE AT YOUR OWN RISK!               *\r\n *=====================================================*/\r\n\r\n/// @use-src 0:\"tests/solidity/simple/solidity_by_example/simple/enum.sol\"\r\nobject \"Test_47\" {\r\n    code {\r\n        {\r\n            /// @src 0:1890:2750  \"contract Test {...\"\r\n            let _1 := memoryguard(0x80)\r\n            mstore(64, _1)\r\n            if callvalue() { revert(0, 0) }\r\n            let _2 := datasize(\"Test_47_deployed\")\r\n            codecopy(_1, dataoffset(\"Test_47_deployed\"), _2)\r\n            return(_1, _2)\r\n        }\r\n    }\r\n    /// @use-src 0:\"tests/solidity/simple/solidity_by_example/simple/enum.sol\"\r\n    object \"Test_47_deployed\" {\r\n        code {\r\n            {\r\n                /// @src 0:1890:2750  \"contract Test {...\"\r\n                let _1 := memoryguard(0x80)\r\n                mstore(64, _1)\r\n                if iszero(lt(calldatasize(), 4))\r\n                {\r\n                    let _2 := 0\r\n                    switch shr(224, calldataload(_2))\r\n                    case 0x200d2ed2 {\r\n                        if callvalue() { revert(_2, _2) }\r\n                        abi_decode(calldatasize())\r\n                        return(_1, sub(abi_encode_enum_Status(_1, and(sload(_2), 0xff)), _1))\r\n                    }\r\n                    case 0x24b8ba5f {\r\n                        if callvalue() { revert(_2, _2) }\r\n                        /// @src 0:2490:2506  \"status = _status\"\r\n                        update_storage_value_offsett_enum_Status_to_enum_Status(/** @src 0:1890:2750  \"contract Test {...\" */ abi_decode_enum_Status(calldatasize()))\r\n                        return(mload(64), _2)\r\n                    }\r\n                    case 0x6d4ce63c {\r\n                        if callvalue() { revert(_2, _2) }\r\n                        abi_decode(calldatasize())\r\n                        let ret := and(sload(_2), 0xff)\r\n                        let memPos := mload(64)\r\n                        return(memPos, sub(abi_encode_enum_Status(memPos, ret), memPos))\r\n                    }\r\n                    case 0xd826f88f {\r\n                        if callvalue() { revert(_2, _2) }\r\n                        abi_decode(calldatasize())\r\n                        update_storage_value_enum_Status_to_enum_Status()\r\n                        return(mload(64), _2)\r\n                    }\r\n                    case 0xea8a1af0 {\r\n                        if callvalue() { revert(_2, _2) }\r\n                        abi_decode(calldatasize())\r\n                        /// @src 0:2605:2629  \"status = Status.Canceled\"\r\n                        update_storage_value_offsett_enum_Status_to_enum_Status_534()\r\n                        /// @src 0:1890:2750  \"contract Test {...\"\r\n                        return(mload(64), _2)\r\n                    }\r\n                }\r\n                revert(0, 0)\r\n            }\r\n            function abi_decode(dataEnd)\r\n            {\r\n                if slt(add(dataEnd, not(3)), 0) { revert(0, 0) }\r\n            }\r\n            function abi_encode_enum_Status(headStart, value0) -> tail\r\n            {\r\n                tail := add(headStart, 32)\r\n                if iszero(lt(value0, 5))\r\n                {\r\n                    mstore(/** @src -1:-1:-1 */ 0, /** @src 0:1890:2750  \"contract Test {...\" */ shl(224, 0x4e487b71))\r\n                    mstore(4, 0x21)\r\n                    revert(/** @src -1:-1:-1 */ 0, /** @src 0:1890:2750  \"contract Test {...\" */ 0x24)\r\n                }\r\n                mstore(headStart, value0)\r\n            }\r\n            function abi_decode_enum_Status(dataEnd) -> value0\r\n            {\r\n                if slt(add(dataEnd, not(3)), 32) { revert(0, 0) }\r\n                let value := calldataload(4)\r\n                if iszero(lt(value, 5))\r\n                {\r\n                    revert(/** @src -1:-1:-1 */ 0, 0)\r\n                }\r\n                /// @src 0:1890:2750  \"contract Test {...\"\r\n                value0 := value\r\n            }\r\n            function update_storage_value_offsett_enum_Status_to_enum_Status(value)\r\n            {\r\n                if iszero(lt(value, 5))\r\n                {\r\n                    mstore(0, shl(224, 0x4e487b71))\r\n                    mstore(4, 0x21)\r\n                    revert(0, 0x24)\r\n                }\r\n                let value_1 := and(sload(0), not(255))\r\n                sstore(0, or(value_1, and(value, 255)))\r\n            }\r\n            function update_storage_value_offsett_enum_Status_to_enum_Status_534()\r\n            {\r\n                sstore(/** @src 0:2605:2629  \"status = Status.Canceled\" */ 0x00, /** @src 0:1890:2750  \"contract Test {...\" */ or(and(sload(/** @src 0:2605:2629  \"status = Status.Canceled\" */ 0x00), /** @src 0:1890:2750  \"contract Test {...\" */ not(255)), /** @src 0:2614:2629  \"Status.Canceled\" */ 4))\r\n            }\r\n            /// @src 0:1890:2750  \"contract Test {...\"\r\n            function update_storage_value_enum_Status_to_enum_Status()\r\n            {\r\n                sstore(0, and(sload(0), not(255)))\r\n            }\r\n        }\r\n        data \".metadata\" hex\"a36469706673582212209acf9df3a75d43ea51564dfa7116d9649188ddce18713a99d700d4a5e61973376c6578706572696d656e74616cf564736f6c634300080a0041\"\r\n    }\r\n}\r\n```\r\n`abi_encode_enum_Status` seems to be correct, whereas `abi_decode_enum_Status` seems to be incorrect.\r\nPerhaps, different logic is supposed to be applied to heap and calldata.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/989869585/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/992363199",
    "html_url": "https://github.com/ethereum/solidity/issues/12368#issuecomment-992363199",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/12368",
    "id": 992363199,
    "node_id": "IC_kwDOAm_5kc47JkK_",
    "user": {
      "login": "chriseth",
      "id": 9073706,
      "node_id": "MDQ6VXNlcjkwNzM3MDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9073706?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chriseth",
      "html_url": "https://github.com/chriseth",
      "followers_url": "https://api.github.com/users/chriseth/followers",
      "following_url": "https://api.github.com/users/chriseth/following{/other_user}",
      "gists_url": "https://api.github.com/users/chriseth/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chriseth/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chriseth/subscriptions",
      "organizations_url": "https://api.github.com/users/chriseth/orgs",
      "repos_url": "https://api.github.com/users/chriseth/repos",
      "events_url": "https://api.github.com/users/chriseth/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chriseth/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-12-13T11:20:19Z",
    "updated_at": "2021-12-13T11:20:19Z",
    "author_association": "MEMBER",
    "body": "These are two different situations: Conversion failure from integer to enum in user-supplied code results in `Panic(0x21)`, while ABI-decoding inputs is not a user-supplied conversion: We have to expect that input data is invalid and thus the ABI decoding code only uses `Error()` reverts or their \"shorter\" version (when `--revert-strings` is set to `default`) where the error data is completely empty. On the other hand, if you forcefully convert an integer to an enum in user-code, the idea is that you already checked that the conversion will work out and thus avoid a panic error.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/992363199/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/994825690",
    "html_url": "https://github.com/ethereum/solidity/issues/12368#issuecomment-994825690",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/12368",
    "id": 994825690,
    "node_id": "IC_kwDOAm_5kc47S9Xa",
    "user": {
      "login": "hedgar2017",
      "id": 31586236,
      "node_id": "MDQ6VXNlcjMxNTg2MjM2",
      "avatar_url": "https://avatars.githubusercontent.com/u/31586236?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hedgar2017",
      "html_url": "https://github.com/hedgar2017",
      "followers_url": "https://api.github.com/users/hedgar2017/followers",
      "following_url": "https://api.github.com/users/hedgar2017/following{/other_user}",
      "gists_url": "https://api.github.com/users/hedgar2017/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hedgar2017/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hedgar2017/subscriptions",
      "organizations_url": "https://api.github.com/users/hedgar2017/orgs",
      "repos_url": "https://api.github.com/users/hedgar2017/repos",
      "events_url": "https://api.github.com/users/hedgar2017/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hedgar2017/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-12-15T14:08:57Z",
    "updated_at": "2021-12-15T14:08:57Z",
    "author_association": "NONE",
    "body": "Got it, thanks.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/994825690/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
