{
  "url": "https://api.github.com/repos/ethereum/solidity/issues/9955",
  "repository_url": "https://api.github.com/repos/ethereum/solidity",
  "labels_url": "https://api.github.com/repos/ethereum/solidity/issues/9955/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/solidity/issues/9955/comments",
  "events_url": "https://api.github.com/repos/ethereum/solidity/issues/9955/events",
  "html_url": "https://github.com/ethereum/solidity/issues/9955",
  "id": 714849946,
  "node_id": "MDU6SXNzdWU3MTQ4NDk5NDY=",
  "number": 9955,
  "title": "Consider dividing contract storage into regular and dedicated mapping part.",
  "user": {
    "login": "ekpyron",
    "id": 1347491,
    "node_id": "MDQ6VXNlcjEzNDc0OTE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1347491?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ekpyron",
    "html_url": "https://github.com/ekpyron",
    "followers_url": "https://api.github.com/users/ekpyron/followers",
    "following_url": "https://api.github.com/users/ekpyron/following{/other_user}",
    "gists_url": "https://api.github.com/users/ekpyron/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ekpyron/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ekpyron/subscriptions",
    "organizations_url": "https://api.github.com/users/ekpyron/orgs",
    "repos_url": "https://api.github.com/users/ekpyron/repos",
    "events_url": "https://api.github.com/users/ekpyron/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ekpyron/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 785717317,
      "node_id": "MDU6TGFiZWw3ODU3MTczMTc=",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/language%20design%20:rage4:",
      "name": "language design :rage4:",
      "color": "9d76d3",
      "default": false,
      "description": "Any changes to the language, e.g. new features"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2020-10-05T13:38:12Z",
  "updated_at": "2022-09-14T14:22:28Z",
  "closed_at": "2022-09-14T14:22:27Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "Motivation\r\n--------------\r\n\r\nInspired by the whole fuzz about https://github.com/ethereum/solidity/pull/9746.\r\n\r\nA problem with the \"oversized objects\" warnings is that the choice of sizes at which to start warning about likely collisions is rather arbitrary. Ideally, we would generally avoid any collision from being possible, so maybe it's worth thinking about how costly that would be.\r\n\r\nAn easy way to get rid of the problem of collisions and the problem of us not being able to clear mappings in storage would be the following:\r\n\r\nProposal\r\n------------\r\n\r\nPartition storage into its lower 2^128 bytes and its higher 2^128 bytes, reserving the lower half for \"regular\" state variables and the higher half for mappings. That way we could specify that the lower half of storage (used for \"regular\" state variables) will always need to be cleared on deletion, whereas the upper half of storage (used for mappings) would always need cleaning on creation.\r\n\r\nIf I'm not missing anything, this should be feasible, but, of course, it won't be free.\r\n\r\nEvaluation\r\n--------------\r\n\r\nAdditional costs:\r\n  - Any hash-based calculation of a regular storage slot needs an ``slot := and(slot, shr(sub(0, 1), 1))``.\r\n  - Any storage slot calculation for mappings needs an ``slot := or(slot, shl(1, 255))``.\r\n  - Various bounds checks may need adjustment.\r\n\r\nSo I'd say this is comparably cheap.\r\n\r\nCollision-safety should not be overly affected by reducing the hash from 256 bits to 255 bits.\r\n\r\nMain drawback: This will break the existing storage layout of contracts.\r\nMaybe that drawback is sufficient for not doing this on its own, but it may be worth thinking about it again, in case we want to change the storage layout in some other way as well.\r\n\r\nThis would, of course, also affect a lot of existing attempts at upgradable contracts, resp. any manual construction of storage slots using inline assembly (i.e. when manually constructing slots, it'd be wise to apply the same masking).",
  "closed_by": {
    "login": "ekpyron",
    "id": 1347491,
    "node_id": "MDQ6VXNlcjEzNDc0OTE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1347491?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ekpyron",
    "html_url": "https://github.com/ekpyron",
    "followers_url": "https://api.github.com/users/ekpyron/followers",
    "following_url": "https://api.github.com/users/ekpyron/following{/other_user}",
    "gists_url": "https://api.github.com/users/ekpyron/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ekpyron/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ekpyron/subscriptions",
    "organizations_url": "https://api.github.com/users/ekpyron/orgs",
    "repos_url": "https://api.github.com/users/ekpyron/repos",
    "events_url": "https://api.github.com/users/ekpyron/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ekpyron/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/9955/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/solidity/issues/9955/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/703827087",
    "html_url": "https://github.com/ethereum/solidity/issues/9955#issuecomment-703827087",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/9955",
    "id": 703827087,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcwMzgyNzA4Nw==",
    "user": {
      "login": "cameel",
      "id": 137030,
      "node_id": "MDQ6VXNlcjEzNzAzMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cameel",
      "html_url": "https://github.com/cameel",
      "followers_url": "https://api.github.com/users/cameel/followers",
      "following_url": "https://api.github.com/users/cameel/following{/other_user}",
      "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
      "organizations_url": "https://api.github.com/users/cameel/orgs",
      "repos_url": "https://api.github.com/users/cameel/repos",
      "events_url": "https://api.github.com/users/cameel/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cameel/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-10-05T19:01:14Z",
    "updated_at": "2020-10-05T19:01:14Z",
    "author_association": "MEMBER",
    "body": "Just wondering, is anyone ever likely to get that warning in a working contract? It's issued when your state variable takes more than 512 exabytes (= 2^64 slots) which surely would not fly even if the code was not being executed on a blockchain?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/703827087/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/703872887",
    "html_url": "https://github.com/ethereum/solidity/issues/9955#issuecomment-703872887",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/9955",
    "id": 703872887,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcwMzg3Mjg4Nw==",
    "user": {
      "login": "a3d4",
      "id": 60588784,
      "node_id": "MDQ6VXNlcjYwNTg4Nzg0",
      "avatar_url": "https://avatars.githubusercontent.com/u/60588784?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/a3d4",
      "html_url": "https://github.com/a3d4",
      "followers_url": "https://api.github.com/users/a3d4/followers",
      "following_url": "https://api.github.com/users/a3d4/following{/other_user}",
      "gists_url": "https://api.github.com/users/a3d4/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/a3d4/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/a3d4/subscriptions",
      "organizations_url": "https://api.github.com/users/a3d4/orgs",
      "repos_url": "https://api.github.com/users/a3d4/repos",
      "events_url": "https://api.github.com/users/a3d4/events{/privacy}",
      "received_events_url": "https://api.github.com/users/a3d4/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-10-05T20:33:26Z",
    "updated_at": "2020-10-05T23:39:16Z",
    "author_association": "CONTRIBUTOR",
    "body": "> Inspired by the whole fuzz about #9746.\r\n\r\nThere are two cases:\r\n**(A)** oversized objects leading to collision warnings\r\n**(B)** oversized objects leading to compilation errors.\r\n\r\nI think the PR #9746 (undoubtedly fuzzy), in its current state, focuses rather on **(B)**, while this issue seems to be about **(A)**.\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/703872887/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/705522398",
    "html_url": "https://github.com/ethereum/solidity/issues/9955#issuecomment-705522398",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/9955",
    "id": 705522398,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcwNTUyMjM5OA==",
    "user": {
      "login": "ekpyron",
      "id": 1347491,
      "node_id": "MDQ6VXNlcjEzNDc0OTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1347491?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ekpyron",
      "html_url": "https://github.com/ekpyron",
      "followers_url": "https://api.github.com/users/ekpyron/followers",
      "following_url": "https://api.github.com/users/ekpyron/following{/other_user}",
      "gists_url": "https://api.github.com/users/ekpyron/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ekpyron/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ekpyron/subscriptions",
      "organizations_url": "https://api.github.com/users/ekpyron/orgs",
      "repos_url": "https://api.github.com/users/ekpyron/repos",
      "events_url": "https://api.github.com/users/ekpyron/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ekpyron/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-10-08T12:03:01Z",
    "updated_at": "2020-10-08T12:03:01Z",
    "author_association": "MEMBER",
    "body": "> Just wondering, is anyone ever likely to get that warning in a working contract? It's issued when your state variable takes more than 512 exabytes (= 2^64 slots) which surely would not fly even if the code was not being executed on a blockchain?\r\n\r\nSince storage is implicitly zero-initialized, it's theoretically fine to declare ``contract C { uint256 x[2**120]; }`` and just index into ``x`` sparsely using your own method of managing the space. It's not that far-fetched to do this to basically try to create a cheaper version of a ``mapping(address => uint)`` that doesn't require hashing for example.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/705522398/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/705525305",
    "html_url": "https://github.com/ethereum/solidity/issues/9955#issuecomment-705525305",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/9955",
    "id": 705525305,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcwNTUyNTMwNQ==",
    "user": {
      "login": "ekpyron",
      "id": 1347491,
      "node_id": "MDQ6VXNlcjEzNDc0OTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1347491?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ekpyron",
      "html_url": "https://github.com/ekpyron",
      "followers_url": "https://api.github.com/users/ekpyron/followers",
      "following_url": "https://api.github.com/users/ekpyron/following{/other_user}",
      "gists_url": "https://api.github.com/users/ekpyron/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ekpyron/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ekpyron/subscriptions",
      "organizations_url": "https://api.github.com/users/ekpyron/orgs",
      "repos_url": "https://api.github.com/users/ekpyron/repos",
      "events_url": "https://api.github.com/users/ekpyron/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ekpyron/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-10-08T12:09:26Z",
    "updated_at": "2020-10-08T12:09:26Z",
    "author_association": "MEMBER",
    "body": "It might even be that ``uint256 balances[2**120];`` with ``balances[uint120(someAddr)]`` while also having ``mapping(uint256 => uint256) usersCanWriteToArbitraryKeysInThis;`` is among the primary reasons for the warning we have for such cases :-).",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/705525305/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1246841663",
    "html_url": "https://github.com/ethereum/solidity/issues/9955#issuecomment-1246841663",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/9955",
    "id": 1246841663,
    "node_id": "IC_kwDOAm_5kc5KUUs_",
    "user": {
      "login": "ekpyron",
      "id": 1347491,
      "node_id": "MDQ6VXNlcjEzNDc0OTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1347491?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ekpyron",
      "html_url": "https://github.com/ekpyron",
      "followers_url": "https://api.github.com/users/ekpyron/followers",
      "following_url": "https://api.github.com/users/ekpyron/following{/other_user}",
      "gists_url": "https://api.github.com/users/ekpyron/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ekpyron/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ekpyron/subscriptions",
      "organizations_url": "https://api.github.com/users/ekpyron/orgs",
      "repos_url": "https://api.github.com/users/ekpyron/repos",
      "events_url": "https://api.github.com/users/ekpyron/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ekpyron/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-14T14:22:27Z",
    "updated_at": "2022-09-14T14:22:27Z",
    "author_association": "MEMBER",
    "body": "I don't see us doing this without a larger storage redesign which may happen due to the verkle business, but I don't think this issue is helping, so I'm closing.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1246841663/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
