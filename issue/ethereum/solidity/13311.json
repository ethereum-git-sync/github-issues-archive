{
  "url": "https://api.github.com/repos/ethereum/solidity/issues/13311",
  "repository_url": "https://api.github.com/repos/ethereum/solidity",
  "labels_url": "https://api.github.com/repos/ethereum/solidity/issues/13311/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/solidity/issues/13311/comments",
  "events_url": "https://api.github.com/repos/ethereum/solidity/issues/13311/events",
  "html_url": "https://github.com/ethereum/solidity/issues/13311",
  "id": 1320313157,
  "node_id": "I_kwDOAm_5kc5OsmFF",
  "number": 13311,
  "title": "Deploy Bytecode  Generated by --via-ir Failed ",
  "user": {
    "login": "hpumengzhao",
    "id": 36286293,
    "node_id": "MDQ6VXNlcjM2Mjg2Mjkz",
    "avatar_url": "https://avatars.githubusercontent.com/u/36286293?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/hpumengzhao",
    "html_url": "https://github.com/hpumengzhao",
    "followers_url": "https://api.github.com/users/hpumengzhao/followers",
    "following_url": "https://api.github.com/users/hpumengzhao/following{/other_user}",
    "gists_url": "https://api.github.com/users/hpumengzhao/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/hpumengzhao/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/hpumengzhao/subscriptions",
    "organizations_url": "https://api.github.com/users/hpumengzhao/orgs",
    "repos_url": "https://api.github.com/users/hpumengzhao/repos",
    "events_url": "https://api.github.com/users/hpumengzhao/events{/privacy}",
    "received_events_url": "https://api.github.com/users/hpumengzhao/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2022-07-28T02:34:14Z",
  "updated_at": "2022-07-29T13:16:35Z",
  "closed_at": "2022-07-29T13:16:28Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "I tested the bytecode generated by IR (compiler version is 0.8.15).\r\n\r\nThe source code is here: https://paste.ubuntu.com/p/rxH3snBD6Y/\r\n\r\nI compile it with the following command to obtain the bytecode.\r\n```\r\nsolc --optimize --bin --via-ir  AIOtherdeed.sol\r\n```\r\nI used Ganache (v2.6.0-beta.3) to be the local Ethereum environment.\r\n\r\nThe key part of my deploy script:\r\n```\r\ndeployer_account = '0xEE244D1397baf270C8d9246Cce70B9879c6Bc0e4'\r\nconst PRIVATE_KEY = Buffer.from('33c8727299783362b188e150d3405d56314d5bf25896d598affdd1e5010de5a4', 'hex')\r\n\r\nvar contract = new web3.eth.Contract(ContractABI)\r\n\r\nvar test = contract.deploy({\r\n    data: bytecode, \r\n    arguments: []\r\n}).send({\r\n    from: deployer_account, \r\n    gas: '6721975'\r\n  }, function (e, contract){\r\n   // console.log(e, contract);\r\n   if (typeof contract.address != 'undefined') {\r\n        console.log('Contract mined! address: ' + contract.address + ' transactionHash: ' + contract.transactionHash);\r\n   }\r\n}).then(instance => {\r\n    console.log(instance.options.address)\r\n})\r\n```\r\nThe deployment was revert \r\n```\r\n  data: {\r\n    '0x112039e3df20d578dd27904bee23abbcb264a20db6ebdd60b320fe1a40704074': {\r\n      error: 'revert',\r\n      program_counter: 351,\r\n      return: '0x08c379a00000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000002e455243373231413a20636f6c6c656374696f6e206d75737420686176652061206e6f6e7a65726f20737570706c79000000000000000000000000000000000000',\r\n      reason: 'ERC721A: collection must have a nonzero supply'\r\n    },\r\n    stack: 'RuntimeError: VM Exception while processing transaction: revert ERC721A: collection must have a nonzero supply\\n' +\r\n      '    at Function.RuntimeError.fromResults (C:\\\\Users\\\\23120\\\\AppData\\\\Local\\\\Programs\\\\Ganache\\\\resources\\\\static\\\\node\\\\node_modules\\\\ganache-core\\\\lib\\\\utils\\\\runtimeerror.js:94:13)\\n' +\r\n      '    at BlockchainDouble.processBlock (C:\\\\Users\\\\23120\\\\AppData\\\\Local\\\\Programs\\\\Ganache\\\\resources\\\\static\\\\node\\\\node_modules\\\\ganache-core\\\\lib\\\\blockchain_double.js:627:24)\\n' +\r\n      '    at runMicrotasks (<anonymous>)\\n' +\r\n      '    at processTicksAndRejections (internal/process/task_queues.js:93:5)',\r\n    name: 'RuntimeError'\r\n  }\r\n```\r\nBut the constructor is \r\n\r\n```\r\nconstructor(\r\n) ERC721A(\"AI Otherdeed\", \"AIO\", 100, maxSupply) {\r\n}\r\n```\r\nwhere maxSupply is 4444.\r\n\r\nThe constructor of ERC721A:\r\n```\r\n  constructor(\r\n    string memory name_,\r\n    string memory symbol_,\r\n    uint256 maxBatchSize_,\r\n    uint256 collectionSize_\r\n  ) {\r\n    require(\r\n      collectionSize_ > 0,\r\n      \"ERC721A: collection must have a nonzero supply\"\r\n    );\r\n    require(maxBatchSize_ > 0, \"ERC721A: max batch size must be nonzero\");\r\n    _name = name_;\r\n    _symbol = symbol_;\r\n    maxBatchSize = maxBatchSize_;\r\n    collectionSize = collectionSize_;\r\n  }\r\n```\r\n\r\n\r\nHowever, when I use the command \r\n```\r\nsolc --optimize --bin AIOtherdeed.sol\r\n```\r\nto generate the bytecode. The bytecode can be deployed successfully.\r\n\r\n\r\nActually, I tested 50 real-world smart contracts from Etherscan and 5 of them couldn't be deployed.\r\n\r\nAnother finding is that the gas consumption of IR generator is higher than the legacy generator.\r\n\r\n\r\nUpdate:\r\n\r\nIf I change \r\n```\r\nuint256 public  maxSupply = 4444;\r\n```\r\nto\r\n```\r\nuint256 public constant maxSupply = 4444;\r\n```\r\nIR generator works.\r\n\r\n",
  "closed_by": {
    "login": "hrkrshnn",
    "id": 13174375,
    "node_id": "MDQ6VXNlcjEzMTc0Mzc1",
    "avatar_url": "https://avatars.githubusercontent.com/u/13174375?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/hrkrshnn",
    "html_url": "https://github.com/hrkrshnn",
    "followers_url": "https://api.github.com/users/hrkrshnn/followers",
    "following_url": "https://api.github.com/users/hrkrshnn/following{/other_user}",
    "gists_url": "https://api.github.com/users/hrkrshnn/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/hrkrshnn/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/hrkrshnn/subscriptions",
    "organizations_url": "https://api.github.com/users/hrkrshnn/orgs",
    "repos_url": "https://api.github.com/users/hrkrshnn/repos",
    "events_url": "https://api.github.com/users/hrkrshnn/events{/privacy}",
    "received_events_url": "https://api.github.com/users/hrkrshnn/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/13311/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/solidity/issues/13311/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1199274310",
    "html_url": "https://github.com/ethereum/solidity/issues/13311#issuecomment-1199274310",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13311",
    "id": 1199274310,
    "node_id": "IC_kwDOAm_5kc5He3lG",
    "user": {
      "login": "hrkrshnn",
      "id": 13174375,
      "node_id": "MDQ6VXNlcjEzMTc0Mzc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/13174375?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hrkrshnn",
      "html_url": "https://github.com/hrkrshnn",
      "followers_url": "https://api.github.com/users/hrkrshnn/followers",
      "following_url": "https://api.github.com/users/hrkrshnn/following{/other_user}",
      "gists_url": "https://api.github.com/users/hrkrshnn/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hrkrshnn/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hrkrshnn/subscriptions",
      "organizations_url": "https://api.github.com/users/hrkrshnn/orgs",
      "repos_url": "https://api.github.com/users/hrkrshnn/repos",
      "events_url": "https://api.github.com/users/hrkrshnn/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hrkrshnn/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-29T13:16:28Z",
    "updated_at": "2022-07-29T13:16:35Z",
    "author_association": "MEMBER",
    "body": "The difference is documented in https://docs.soliditylang.org/en/v0.8.15/ir-breaking-changes.html#semantic-only-changes\r\n\r\nThis is due to the order of initialization of `maxSupply`, in the IR pipeline the variable is initialized at towards the end. So in the constructor, the value getting read is zero.\r\n\r\nClosing this for now. Feel free to reply if you have questions.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1199274310/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
