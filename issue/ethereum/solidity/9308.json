{
  "url": "https://api.github.com/repos/ethereum/solidity/issues/9308",
  "repository_url": "https://api.github.com/repos/ethereum/solidity",
  "labels_url": "https://api.github.com/repos/ethereum/solidity/issues/9308/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/solidity/issues/9308/comments",
  "events_url": "https://api.github.com/repos/ethereum/solidity/issues/9308/events",
  "html_url": "https://github.com/ethereum/solidity/issues/9308",
  "id": 650660642,
  "node_id": "MDU6SXNzdWU2NTA2NjA2NDI=",
  "number": 9308,
  "title": "[Yul] optimiser step CSE produces syntactically incorrect code",
  "user": {
    "login": "bshastry",
    "id": 2388185,
    "node_id": "MDQ6VXNlcjIzODgxODU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2388185?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/bshastry",
    "html_url": "https://github.com/bshastry",
    "followers_url": "https://api.github.com/users/bshastry/followers",
    "following_url": "https://api.github.com/users/bshastry/following{/other_user}",
    "gists_url": "https://api.github.com/users/bshastry/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/bshastry/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/bshastry/subscriptions",
    "organizations_url": "https://api.github.com/users/bshastry/orgs",
    "repos_url": "https://api.github.com/users/bshastry/repos",
    "events_url": "https://api.github.com/users/bshastry/events{/privacy}",
    "received_events_url": "https://api.github.com/users/bshastry/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 249074435,
      "node_id": "MDU6TGFiZWwyNDkwNzQ0MzU=",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/bug%20:bug:",
      "name": "bug :bug:",
      "color": "fc1313",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 8,
  "created_at": "2020-07-03T15:25:22Z",
  "updated_at": "2020-07-08T09:19:03Z",
  "closed_at": "2020-07-08T09:19:03Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nThis test passes but it should not. Related to #9301 in that the fuzzer found this test case first which led @ekpyron to propose the test case in the related issue.\r\n\r\n```\r\n{\r\n    let x_1\r\n    x_1, x_1 := f()\r\n    function f() -> o_1, o_2 {}\r\n    let x_2, x_3 := f()\r\n}\r\n// ----\r\n// step: commonSubexpressionEliminator\r\n//\r\n// {\r\n//     let x_1\r\n//     x_1, x_1 := f()\r\n//     function f() -> o_1, o_2\r\n//     { }\r\n//     let x_2, x_3 := x_1\r\n// }\r\n```\r\n\r\n## Environment\r\n\r\n- Compiler version: latest develop\r\n\r\n## Steps to Reproduce\r\n\r\n```\r\n// Copy test to test/libyul/yulOptimizerTests/CSE/test.yul\r\n$ soltest -t yulOptimizerTests/CSE/test\r\n```",
  "closed_by": {
    "login": "bshastry",
    "id": 2388185,
    "node_id": "MDQ6VXNlcjIzODgxODU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2388185?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/bshastry",
    "html_url": "https://github.com/bshastry",
    "followers_url": "https://api.github.com/users/bshastry/followers",
    "following_url": "https://api.github.com/users/bshastry/following{/other_user}",
    "gists_url": "https://api.github.com/users/bshastry/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/bshastry/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/bshastry/subscriptions",
    "organizations_url": "https://api.github.com/users/bshastry/orgs",
    "repos_url": "https://api.github.com/users/bshastry/repos",
    "events_url": "https://api.github.com/users/bshastry/events{/privacy}",
    "received_events_url": "https://api.github.com/users/bshastry/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/9308/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/solidity/issues/9308/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/653598345",
    "html_url": "https://github.com/ethereum/solidity/issues/9308#issuecomment-653598345",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/9308",
    "id": 653598345,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY1MzU5ODM0NQ==",
    "user": {
      "login": "ekpyron",
      "id": 1347491,
      "node_id": "MDQ6VXNlcjEzNDc0OTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1347491?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ekpyron",
      "html_url": "https://github.com/ekpyron",
      "followers_url": "https://api.github.com/users/ekpyron/followers",
      "following_url": "https://api.github.com/users/ekpyron/following{/other_user}",
      "gists_url": "https://api.github.com/users/ekpyron/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ekpyron/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ekpyron/subscriptions",
      "organizations_url": "https://api.github.com/users/ekpyron/orgs",
      "repos_url": "https://api.github.com/users/ekpyron/repos",
      "events_url": "https://api.github.com/users/ekpyron/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ekpyron/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-07-03T15:32:03Z",
    "updated_at": "2020-07-03T15:32:03Z",
    "author_association": "MEMBER",
    "body": "For the record: even if we just syntactically disallow ``x_1, x_1 := f()`` (which would solve this issue), it may still be worth to independently have a look at the CSE to make sure that the cause of this is rendered harmless with disallowing it.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/653598345/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/653598887",
    "html_url": "https://github.com/ethereum/solidity/issues/9308#issuecomment-653598887",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/9308",
    "id": 653598887,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY1MzU5ODg4Nw==",
    "user": {
      "login": "ekpyron",
      "id": 1347491,
      "node_id": "MDQ6VXNlcjEzNDc0OTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1347491?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ekpyron",
      "html_url": "https://github.com/ekpyron",
      "followers_url": "https://api.github.com/users/ekpyron/followers",
      "following_url": "https://api.github.com/users/ekpyron/following{/other_user}",
      "gists_url": "https://api.github.com/users/ekpyron/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ekpyron/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ekpyron/subscriptions",
      "organizations_url": "https://api.github.com/users/ekpyron/orgs",
      "repos_url": "https://api.github.com/users/ekpyron/repos",
      "events_url": "https://api.github.com/users/ekpyron/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ekpyron/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-07-03T15:33:28Z",
    "updated_at": "2020-07-03T15:33:28Z",
    "author_association": "MEMBER",
    "body": "Or put differently: the CSE could use some kind of assertion here instead of just happily producing invalid code, no matter if we disallow these cases from ever occurring or not.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/653598887/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/654723376",
    "html_url": "https://github.com/ethereum/solidity/issues/9308#issuecomment-654723376",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/9308",
    "id": 654723376,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY1NDcyMzM3Ng==",
    "user": {
      "login": "bshastry",
      "id": 2388185,
      "node_id": "MDQ6VXNlcjIzODgxODU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2388185?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bshastry",
      "html_url": "https://github.com/bshastry",
      "followers_url": "https://api.github.com/users/bshastry/followers",
      "following_url": "https://api.github.com/users/bshastry/following{/other_user}",
      "gists_url": "https://api.github.com/users/bshastry/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bshastry/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bshastry/subscriptions",
      "organizations_url": "https://api.github.com/users/bshastry/orgs",
      "repos_url": "https://api.github.com/users/bshastry/repos",
      "events_url": "https://api.github.com/users/bshastry/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bshastry/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-07-07T09:27:02Z",
    "updated_at": "2020-07-07T09:27:02Z",
    "author_association": "MEMBER",
    "body": "> For the record: even if we just syntactically disallow `x_1, x_1 := f()` (which would solve this issue), it may still be worth to independently have a look at the CSE to make sure that the cause of this is rendered harmless with disallowing it.\r\n\r\nI think the syntactically invalid replacement happens here\r\n\r\nhttps://github.com/ethereum/solidity/blob/d72aae20aa356c10a1966a1a2c7d6f36863a2381/libyul/optimiser/CommonSubexpressionEliminator.cpp#L107-L111\r\n\r\nbecause of\r\n  - https://github.com/ethereum/solidity/blob/d72aae20aa356c10a1966a1a2c7d6f36863a2381/libyul/optimiser/SyntacticalEquality.cpp#L51-L55 returning true\r\n  - AND the function call being previously assigned to variable `x_1` I think (but not sure)\r\n\r\nPlease also note that when https://github.com/ethereum/solidity/blob/d72aae20aa356c10a1966a1a2c7d6f36863a2381/libyul/optimiser/DataFlowAnalyzer.cpp#L79-L81 is executed\r\n\r\nthe assignment `x_1, x_1 := f()` in the code above gets treated as an assignment of a single variable (due to the type holding variable names being a set:  https://github.com/ethereum/solidity/blob/d72aae20aa356c10a1966a1a2c7d6f36863a2381/libyul/optimiser/DataFlowAnalyzer.cpp#L79)\r\n\r\nI'm not sure why the syntactic equality check is *not* triggered for\r\n\r\n```\r\n{\r\n    let x_1, x_2\r\n    x_1, x_2 := f()\r\n    function f() -> o_1, o_2 {}\r\n    let x_3, x_4 := f()\r\n}\r\n```\r\n\r\nShouldn't this be simplified to\r\n\r\n```\r\n{\r\n    let x_1, x_2\r\n    x_1, x_2 := f()\r\n    function f() -> o_1, o_2 {}\r\n    let x_3, x_4 := x_1, x_2\r\n}\r\n```\r\n\r\nor is it because tuple assignments are disallowed in yul unless RHS is a function call?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/654723376/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/654754597",
    "html_url": "https://github.com/ethereum/solidity/issues/9308#issuecomment-654754597",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/9308",
    "id": 654754597,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY1NDc1NDU5Nw==",
    "user": {
      "login": "chriseth",
      "id": 9073706,
      "node_id": "MDQ6VXNlcjkwNzM3MDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9073706?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chriseth",
      "html_url": "https://github.com/chriseth",
      "followers_url": "https://api.github.com/users/chriseth/followers",
      "following_url": "https://api.github.com/users/chriseth/following{/other_user}",
      "gists_url": "https://api.github.com/users/chriseth/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chriseth/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chriseth/subscriptions",
      "organizations_url": "https://api.github.com/users/chriseth/orgs",
      "repos_url": "https://api.github.com/users/chriseth/repos",
      "events_url": "https://api.github.com/users/chriseth/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chriseth/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-07-07T10:20:43Z",
    "updated_at": "2020-07-07T10:20:43Z",
    "author_association": "MEMBER",
    "body": "I don't understand this issue - the test _starts_ with `x_1, x_1 := f()`, right?\r\n\r\nThe issue here is that we do not have a good definition of the semantics of `x_1, x_y := f()` - is it?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/654754597/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/654760164",
    "html_url": "https://github.com/ethereum/solidity/issues/9308#issuecomment-654760164",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/9308",
    "id": 654760164,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY1NDc2MDE2NA==",
    "user": {
      "login": "bshastry",
      "id": 2388185,
      "node_id": "MDQ6VXNlcjIzODgxODU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2388185?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bshastry",
      "html_url": "https://github.com/bshastry",
      "followers_url": "https://api.github.com/users/bshastry/followers",
      "following_url": "https://api.github.com/users/bshastry/following{/other_user}",
      "gists_url": "https://api.github.com/users/bshastry/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bshastry/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bshastry/subscriptions",
      "organizations_url": "https://api.github.com/users/bshastry/orgs",
      "repos_url": "https://api.github.com/users/bshastry/repos",
      "events_url": "https://api.github.com/users/bshastry/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bshastry/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-07-07T10:31:12Z",
    "updated_at": "2020-07-07T10:31:12Z",
    "author_association": "MEMBER",
    "body": "> I don't understand this issue - the test _starts_ with `x_1, x_1 := f()`, right?\r\n> \r\n> The issue here is that we do not have a good definition of the semantics of `x_1, x_y := f()` - is it?\r\n\r\nI think the issue is that disallowing `x_1, x_1 := f()` as we now do, will not hide a more serious dormant issue somewhere in CSE. \r\n\r\nI do not yet fully understand why CSE simplified `let x_2, x_3 := f()` with `let x_2, x_3 := x_1`",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/654760164/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/654953373",
    "html_url": "https://github.com/ethereum/solidity/issues/9308#issuecomment-654953373",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/9308",
    "id": 654953373,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY1NDk1MzM3Mw==",
    "user": {
      "login": "bshastry",
      "id": 2388185,
      "node_id": "MDQ6VXNlcjIzODgxODU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2388185?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bshastry",
      "html_url": "https://github.com/bshastry",
      "followers_url": "https://api.github.com/users/bshastry/followers",
      "following_url": "https://api.github.com/users/bshastry/following{/other_user}",
      "gists_url": "https://api.github.com/users/bshastry/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bshastry/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bshastry/subscriptions",
      "organizations_url": "https://api.github.com/users/bshastry/orgs",
      "repos_url": "https://api.github.com/users/bshastry/repos",
      "events_url": "https://api.github.com/users/bshastry/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bshastry/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-07-07T15:46:00Z",
    "updated_at": "2020-07-07T15:46:00Z",
    "author_association": "MEMBER",
    "body": "I think the missing exception was \r\nhttps://github.com/ethereum/solidity/blob/4e55759144535c6e58df37bc4c6ea67b26531d97/libyul/optimiser/DataFlowAnalyzer.cpp#L82\r\n\r\nWhat happened was that the DFA treated `x_1, x_1 := f()` as if it were `x_1 := f()`. This was then used to simplify the RHS of `let x_2, x_3 := f()` into `x_1` because that RHS is syntactically identical to the value assigned to `x_1`.\r\n\r\nThe need for this exception is now made redundant by #9321 \r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/654953373/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/655376835",
    "html_url": "https://github.com/ethereum/solidity/issues/9308#issuecomment-655376835",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/9308",
    "id": 655376835,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY1NTM3NjgzNQ==",
    "user": {
      "login": "chriseth",
      "id": 9073706,
      "node_id": "MDQ6VXNlcjkwNzM3MDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9073706?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chriseth",
      "html_url": "https://github.com/chriseth",
      "followers_url": "https://api.github.com/users/chriseth/followers",
      "following_url": "https://api.github.com/users/chriseth/following{/other_user}",
      "gists_url": "https://api.github.com/users/chriseth/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chriseth/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chriseth/subscriptions",
      "organizations_url": "https://api.github.com/users/chriseth/orgs",
      "repos_url": "https://api.github.com/users/chriseth/repos",
      "events_url": "https://api.github.com/users/chriseth/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chriseth/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-07-08T08:36:53Z",
    "updated_at": "2020-07-08T08:36:53Z",
    "author_association": "MEMBER",
    "body": "So can this be closed now or not?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/655376835/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/655399416",
    "html_url": "https://github.com/ethereum/solidity/issues/9308#issuecomment-655399416",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/9308",
    "id": 655399416,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY1NTM5OTQxNg==",
    "user": {
      "login": "bshastry",
      "id": 2388185,
      "node_id": "MDQ6VXNlcjIzODgxODU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2388185?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bshastry",
      "html_url": "https://github.com/bshastry",
      "followers_url": "https://api.github.com/users/bshastry/followers",
      "following_url": "https://api.github.com/users/bshastry/following{/other_user}",
      "gists_url": "https://api.github.com/users/bshastry/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bshastry/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bshastry/subscriptions",
      "organizations_url": "https://api.github.com/users/bshastry/orgs",
      "repos_url": "https://api.github.com/users/bshastry/repos",
      "events_url": "https://api.github.com/users/bshastry/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bshastry/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-07-08T09:19:03Z",
    "updated_at": "2020-07-08T09:19:03Z",
    "author_association": "MEMBER",
    "body": "Fixed by #9321 ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/655399416/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
