{
  "url": "https://api.github.com/repos/ethereum/solidity/issues/3185",
  "repository_url": "https://api.github.com/repos/ethereum/solidity",
  "labels_url": "https://api.github.com/repos/ethereum/solidity/issues/3185/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/solidity/issues/3185/comments",
  "events_url": "https://api.github.com/repos/ethereum/solidity/issues/3185/events",
  "html_url": "https://github.com/ethereum/solidity/issues/3185",
  "id": 272653407,
  "node_id": "MDU6SXNzdWUyNzI2NTM0MDc=",
  "number": 3185,
  "title": "Better tools for implementing proxies via delegatecall",
  "user": {
    "login": "federicobond",
    "id": 138426,
    "node_id": "MDQ6VXNlcjEzODQyNg==",
    "avatar_url": "https://avatars.githubusercontent.com/u/138426?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/federicobond",
    "html_url": "https://github.com/federicobond",
    "followers_url": "https://api.github.com/users/federicobond/followers",
    "following_url": "https://api.github.com/users/federicobond/following{/other_user}",
    "gists_url": "https://api.github.com/users/federicobond/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/federicobond/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/federicobond/subscriptions",
    "organizations_url": "https://api.github.com/users/federicobond/orgs",
    "repos_url": "https://api.github.com/users/federicobond/repos",
    "events_url": "https://api.github.com/users/federicobond/events{/privacy}",
    "received_events_url": "https://api.github.com/users/federicobond/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 785717317,
      "node_id": "MDU6TGFiZWw3ODU3MTczMTc=",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/language%20design%20:rage4:",
      "name": "language design :rage4:",
      "color": "9d76d3",
      "default": false,
      "description": "Any changes to the language, e.g. new features"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2017-11-09T17:30:13Z",
  "updated_at": "2022-08-17T13:49:15Z",
  "closed_at": null,
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "In the wake of the recent Parity hack, it's clear that we can do better at the language level to improve the security of some of the patterns that have appeared recently due to the increased use of delegatecall.\r\n\r\nWhile putting several hundreds of millions of dollars in a complex contract structure like the one used by Parity was foolish, especially when there are [much better alternatives](https://github.com/gnosis/MultiSigWallet/blob/master/contracts/MultiSigWallet.sol) that have been extensively audited, I think their design goals were reasonable and we should try to improve support for contracts that serve as proxies to a library which implements the actual logic.\r\n\r\nMy own (extremely fresh) proposal looks something like this:\r\n\r\n```javascript\r\nimpl Wallet {\r\n  // rejects all calls that don't come from a delegatecall\r\n  // lets you declare fields that specify the storage layout\r\n}\r\n\r\ncontract MyWallet is Wallet {\r\n  // proxies all internal and external calls transparently via delegatecall\r\n  // but you can overwrite individual methods\r\n  function MyWallet() Wallet(0x692a70d2e424a56d2c6c27aa97d1a86395877b3a) {}\r\n\r\n  function transfer(address to, uint amount) {\r\n    require(additionalCheck);\r\n    super.transfer(to, amount);\r\n  }\r\n}\r\n```\r\n\r\nI would love to hear your feedback on it.",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/3185/reactions",
    "total_count": 2,
    "+1": 2,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/solidity/issues/3185/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/343236922",
    "html_url": "https://github.com/ethereum/solidity/issues/3185#issuecomment-343236922",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/3185",
    "id": 343236922,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM0MzIzNjkyMg==",
    "user": {
      "login": "axic",
      "id": 20340,
      "node_id": "MDQ6VXNlcjIwMzQw",
      "avatar_url": "https://avatars.githubusercontent.com/u/20340?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/axic",
      "html_url": "https://github.com/axic",
      "followers_url": "https://api.github.com/users/axic/followers",
      "following_url": "https://api.github.com/users/axic/following{/other_user}",
      "gists_url": "https://api.github.com/users/axic/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/axic/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/axic/subscriptions",
      "organizations_url": "https://api.github.com/users/axic/orgs",
      "repos_url": "https://api.github.com/users/axic/repos",
      "events_url": "https://api.github.com/users/axic/events{/privacy}",
      "received_events_url": "https://api.github.com/users/axic/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-11-09T17:54:07Z",
    "updated_at": "2017-11-09T17:54:07Z",
    "author_association": "MEMBER",
    "body": "Please see #2296 as part of the suggested solution.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/343236922/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/343251223",
    "html_url": "https://github.com/ethereum/solidity/issues/3185#issuecomment-343251223",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/3185",
    "id": 343251223,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM0MzI1MTIyMw==",
    "user": {
      "login": "federicobond",
      "id": 138426,
      "node_id": "MDQ6VXNlcjEzODQyNg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/138426?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/federicobond",
      "html_url": "https://github.com/federicobond",
      "followers_url": "https://api.github.com/users/federicobond/followers",
      "following_url": "https://api.github.com/users/federicobond/following{/other_user}",
      "gists_url": "https://api.github.com/users/federicobond/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/federicobond/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/federicobond/subscriptions",
      "organizations_url": "https://api.github.com/users/federicobond/orgs",
      "repos_url": "https://api.github.com/users/federicobond/repos",
      "events_url": "https://api.github.com/users/federicobond/events{/privacy}",
      "received_events_url": "https://api.github.com/users/federicobond/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-11-09T18:43:21Z",
    "updated_at": "2017-11-09T18:43:21Z",
    "author_association": "CONTRIBUTOR",
    "body": "Yes, I like the ideas on how to distinguish between delegatecalls and regular calls to the contract (I was thinking about proposing a new opcode CODEADDRESS or something similar, but checking for a magic storage value works too).\r\n\r\nI also agree that we might want to be careful with the fallback function (perhaps a simple check for empty CALLDATA can work).\r\n\r\n@chriseth's proposal requires the master contract to act as a factory for all proxy contracts, so it can enforce certain invariants for all of them. It also makes it impossible for contracts to have individual behaviour independent of the master copy. Whether that's a tradeoff that most users are comfortable with I am not sure, we may need to gather additional feedback.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/343251223/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/344345348",
    "html_url": "https://github.com/ethereum/solidity/issues/3185#issuecomment-344345348",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/3185",
    "id": 344345348,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM0NDM0NTM0OA==",
    "user": {
      "login": "3esmit",
      "id": 224810,
      "node_id": "MDQ6VXNlcjIyNDgxMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/224810?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/3esmit",
      "html_url": "https://github.com/3esmit",
      "followers_url": "https://api.github.com/users/3esmit/followers",
      "following_url": "https://api.github.com/users/3esmit/following{/other_user}",
      "gists_url": "https://api.github.com/users/3esmit/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/3esmit/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/3esmit/subscriptions",
      "organizations_url": "https://api.github.com/users/3esmit/orgs",
      "repos_url": "https://api.github.com/users/3esmit/repos",
      "events_url": "https://api.github.com/users/3esmit/events{/privacy}",
      "received_events_url": "https://api.github.com/users/3esmit/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-11-14T18:04:38Z",
    "updated_at": "2017-11-14T18:04:38Z",
    "author_association": "CONTRIBUTOR",
    "body": "One thing that would be useful is the ability to have storage in stub contract that is not affected in anyway by actions in code at delegatecall. \r\nThe use for this is to set an address variable storage that stores the target (or targets) to delegate call. \r\nI've been able to accomplish this by using a secondary contract to store the target address, but this overloads the gas on each call to the read of an external contract storage. \r\nI'm trying to develop a upgradable stub contract, where stub contracts could opt-in to update itself in case of emergency (such as selfdestruct of library or some other conditions) or in case is available update. \r\nThe \"problem\" is that we need to everytime have that `address libraryAddr = 0xAddr` in all \"library contracts\" that are meant to be used by this contract. See https://github.com/aragon/aragon-core/blob/dev/contracts/kernel/KernelStorage.sol by @izqui \r\n\r\nOther problem is that, in a case of update. when you change the variables of the library address, you might break the storage, unless you do it right - and sometime a migration might be need. \r\nIf we could enforce that some variables use determined pointers, such as the one old contract was using, then this migrations would not be needed. ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/344345348/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/344362614",
    "html_url": "https://github.com/ethereum/solidity/issues/3185#issuecomment-344362614",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/3185",
    "id": 344362614,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM0NDM2MjYxNA==",
    "user": {
      "login": "federicobond",
      "id": 138426,
      "node_id": "MDQ6VXNlcjEzODQyNg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/138426?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/federicobond",
      "html_url": "https://github.com/federicobond",
      "followers_url": "https://api.github.com/users/federicobond/followers",
      "following_url": "https://api.github.com/users/federicobond/following{/other_user}",
      "gists_url": "https://api.github.com/users/federicobond/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/federicobond/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/federicobond/subscriptions",
      "organizations_url": "https://api.github.com/users/federicobond/orgs",
      "repos_url": "https://api.github.com/users/federicobond/repos",
      "events_url": "https://api.github.com/users/federicobond/events{/privacy}",
      "received_events_url": "https://api.github.com/users/federicobond/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-11-14T19:02:29Z",
    "updated_at": "2017-11-14T19:02:29Z",
    "author_association": "CONTRIBUTOR",
    "body": "Yes, upgradeable contracts are going to be really popular, and we must provide better tools at the language level. The issues you mention are real and the solutions we have found so far have been hacky at best. Let me offer some thoughts on your last point.\r\n\r\n> Other problem is that, in a case of update. when you change the variables of the library address, you might break the storage, unless you do it right - and sometime a migration might be need.\r\nIf we could enforce that some variables use determined pointers, such as the one old contract was using, then this migrations would not be needed.\r\n\r\nOne way to perform safe upgrades is to have a language to describe a specific storage layout. Then, you can have multiple versions of the same contract but as long as they follow the same storage layout, you can upgrade the underlying implementation.\r\n\r\n```\r\nstorage TokenStorage {\r\n  mapping(address => uint256) balances;\r\n  uint256 totalSupply;\r\n}\r\n```\r\n```\r\ncontract TokenV2 is TokenStorage {\r\n  // ... TokenV2 cannot add additional state variables\r\n}\r\n```\r\nOf course, the compiler should provide a guarantee that variables are packed in a consistent way in the contract state.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/344362614/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
