{
  "url": "https://api.github.com/repos/ethereum/solidity/issues/13818",
  "repository_url": "https://api.github.com/repos/ethereum/solidity",
  "labels_url": "https://api.github.com/repos/ethereum/solidity/issues/13818/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/solidity/issues/13818/comments",
  "events_url": "https://api.github.com/repos/ethereum/solidity/issues/13818/events",
  "html_url": "https://github.com/ethereum/solidity/issues/13818",
  "id": 1502857787,
  "node_id": "I_kwDOAm_5kc5Zk8o7",
  "number": 13818,
  "title": "Array of static structures have strange `memory` layout",
  "user": {
    "login": "k06a",
    "id": 702124,
    "node_id": "MDQ6VXNlcjcwMjEyNA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/702124?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/k06a",
    "html_url": "https://github.com/k06a",
    "followers_url": "https://api.github.com/users/k06a/followers",
    "following_url": "https://api.github.com/users/k06a/following{/other_user}",
    "gists_url": "https://api.github.com/users/k06a/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/k06a/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k06a/subscriptions",
    "organizations_url": "https://api.github.com/users/k06a/orgs",
    "repos_url": "https://api.github.com/users/k06a/repos",
    "events_url": "https://api.github.com/users/k06a/events{/privacy}",
    "received_events_url": "https://api.github.com/users/k06a/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 7,
  "created_at": "2022-12-19T12:17:35Z",
  "updated_at": "2022-12-19T20:20:37Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nWe discovered that array of static structs have pretty strange `memory` layout comparing to `calldata` layout.\r\n\r\n## Environment\r\n\r\n- Compiler version: 0.8.17\r\n\r\n## Steps to Reproduce\r\n\r\nWe expected the following code to have almost the same layouts for calldata and memory and avoid any huge reencoding on the way from `calldata` to `memory` and back to `calldata` for subcall.\r\n\r\n```solidity\r\ncontract Test {\r\n    struct Data {\r\n        address token;\r\n        uint256 amount;\r\n    }\r\n\r\n    function f(Data[] calldata items) external {\r\n        Data[] memory copied = items;\r\n        target.g(copied);\r\n    }\r\n}\r\n```\r\n\r\nBut currently memory location contain array of offsets of all the static items:\r\n```\r\n[[0x1, 2], [0x3, 4], [0x5, 6]]\r\n```\r\n\r\n`calldata`:\r\n```\r\n0000000000000000000000000000000000000000000000000000000000000003 <= items.length\r\n0000000000000000000000000000000000000000000000000000000000000001 <= items[0]\r\n0000000000000000000000000000000000000000000000000000000000000002\r\n0000000000000000000000000000000000000000000000000000000000000003 <= items[1]\r\n0000000000000000000000000000000000000000000000000000000000000004\r\n0000000000000000000000000000000000000000000000000000000000000005 <= items[2]\r\n0000000000000000000000000000000000000000000000000000000000000006\r\n```\r\n\r\n`memory`:\r\n```\r\n0000000000000000000000000000000000000000000000000000000000000003 <= items.length\r\n0000000000000000000000000000000000000000000000000000000000000060 <= offsets of items[0]\r\n00000000000000000000000000000000000000000000000000000000000000a0 <= offsets of items[1]\r\n00000000000000000000000000000000000000000000000000000000000000e0 <= offsets of items[2]\r\n0000000000000000000000000000000000000000000000000000000000000001 <= items[0]\r\n0000000000000000000000000000000000000000000000000000000000000002\r\n0000000000000000000000000000000000000000000000000000000000000003 <= items[1]\r\n0000000000000000000000000000000000000000000000000000000000000004\r\n0000000000000000000000000000000000000000000000000000000000000005 <= items[2]\r\n0000000000000000000000000000000000000000000000000000000000000006\r\n```",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/13818/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/solidity/issues/13818/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1357600352",
    "html_url": "https://github.com/ethereum/solidity/issues/13818#issuecomment-1357600352",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13818",
    "id": 1357600352,
    "node_id": "IC_kwDOAm_5kc5Q61Zg",
    "user": {
      "login": "axic",
      "id": 20340,
      "node_id": "MDQ6VXNlcjIwMzQw",
      "avatar_url": "https://avatars.githubusercontent.com/u/20340?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/axic",
      "html_url": "https://github.com/axic",
      "followers_url": "https://api.github.com/users/axic/followers",
      "following_url": "https://api.github.com/users/axic/following{/other_user}",
      "gists_url": "https://api.github.com/users/axic/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/axic/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/axic/subscriptions",
      "organizations_url": "https://api.github.com/users/axic/orgs",
      "repos_url": "https://api.github.com/users/axic/repos",
      "events_url": "https://api.github.com/users/axic/events{/privacy}",
      "received_events_url": "https://api.github.com/users/axic/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-19T12:30:55Z",
    "updated_at": "2022-12-19T12:30:55Z",
    "author_association": "MEMBER",
    "body": "Didn't you swap the `calldata`/`memory` labels in your description? Offsets for dynamic types in calldata could be expected, but not in memory.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1357600352/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1357608445",
    "html_url": "https://github.com/ethereum/solidity/issues/13818#issuecomment-1357608445",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13818",
    "id": 1357608445,
    "node_id": "IC_kwDOAm_5kc5Q63X9",
    "user": {
      "login": "hrkrshnn",
      "id": 13174375,
      "node_id": "MDQ6VXNlcjEzMTc0Mzc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/13174375?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hrkrshnn",
      "html_url": "https://github.com/hrkrshnn",
      "followers_url": "https://api.github.com/users/hrkrshnn/followers",
      "following_url": "https://api.github.com/users/hrkrshnn/following{/other_user}",
      "gists_url": "https://api.github.com/users/hrkrshnn/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hrkrshnn/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hrkrshnn/subscriptions",
      "organizations_url": "https://api.github.com/users/hrkrshnn/orgs",
      "repos_url": "https://api.github.com/users/hrkrshnn/repos",
      "events_url": "https://api.github.com/users/hrkrshnn/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hrkrshnn/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-19T12:39:23Z",
    "updated_at": "2022-12-19T12:39:23Z",
    "author_association": "MEMBER",
    "body": "@k06a The encoding of `Data[]` in calldata doesn't look right\r\n\r\n> cast abi-encode \"f((address,uint)[])\" \"[(0xfeebabe6b0418ec13b30aadf129f5dcdd4f70cea,2),(0xfeebabe6b0418ec13b30aadf129f5dcdd4f70cea,4),(0xfeebabe6b0418ec13b30aadf129f5dcdd4f70cea,6)]\"\r\n\r\n```\r\n0000000000000000000000000000000000000000000000000000000000000020\r\n0000000000000000000000000000000000000000000000000000000000000003\r\n000000000000000000000000feebabe6b0418ec13b30aadf129f5dcdd4f70cea\r\n0000000000000000000000000000000000000000000000000000000000000002\r\n000000000000000000000000feebabe6b0418ec13b30aadf129f5dcdd4f70cea\r\n0000000000000000000000000000000000000000000000000000000000000004\r\n000000000000000000000000feebabe6b0418ec13b30aadf129f5dcdd4f70cea\r\n0000000000000000000000000000000000000000000000000000000000000006\r\n```\r\n\r\nThe encoding you provided looks like it is for `Data[3]`. \r\n\r\nAlso, the layout in calldata and the layout in memory for the same types *are* different.\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1357608445/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1357654800",
    "html_url": "https://github.com/ethereum/solidity/issues/13818#issuecomment-1357654800",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13818",
    "id": 1357654800,
    "node_id": "IC_kwDOAm_5kc5Q7CsQ",
    "user": {
      "login": "k06a",
      "id": 702124,
      "node_id": "MDQ6VXNlcjcwMjEyNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/702124?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/k06a",
      "html_url": "https://github.com/k06a",
      "followers_url": "https://api.github.com/users/k06a/followers",
      "following_url": "https://api.github.com/users/k06a/following{/other_user}",
      "gists_url": "https://api.github.com/users/k06a/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/k06a/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/k06a/subscriptions",
      "organizations_url": "https://api.github.com/users/k06a/orgs",
      "repos_url": "https://api.github.com/users/k06a/repos",
      "events_url": "https://api.github.com/users/k06a/events{/privacy}",
      "received_events_url": "https://api.github.com/users/k06a/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-19T13:16:30Z",
    "updated_at": "2022-12-19T13:16:30Z",
    "author_association": "NONE",
    "body": "@hrkrshnn I provided memory layouts, not abi encodings - it is a bit different thing, but part of your message. I expected memory layout to be same as calldata layout, because it is simpler, shorter and non-redundand.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1357654800/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1357920696",
    "html_url": "https://github.com/ethereum/solidity/issues/13818#issuecomment-1357920696",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13818",
    "id": 1357920696,
    "node_id": "IC_kwDOAm_5kc5Q8Dm4",
    "user": {
      "login": "hrkrshnn",
      "id": 13174375,
      "node_id": "MDQ6VXNlcjEzMTc0Mzc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/13174375?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hrkrshnn",
      "html_url": "https://github.com/hrkrshnn",
      "followers_url": "https://api.github.com/users/hrkrshnn/followers",
      "following_url": "https://api.github.com/users/hrkrshnn/following{/other_user}",
      "gists_url": "https://api.github.com/users/hrkrshnn/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hrkrshnn/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hrkrshnn/subscriptions",
      "organizations_url": "https://api.github.com/users/hrkrshnn/orgs",
      "repos_url": "https://api.github.com/users/hrkrshnn/repos",
      "events_url": "https://api.github.com/users/hrkrshnn/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hrkrshnn/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-19T16:25:33Z",
    "updated_at": "2022-12-19T16:25:33Z",
    "author_association": "MEMBER",
    "body": "@k06a So what does the code listing with `calldata` in the issue title refer to?\r\n\r\nAnyway, unlike `calldata` (ABI) and `storage`, memory layout does not need to be standardized. The compiler can technically do whatever it wants. Regardless of that, memory layout should be consistent.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1357920696/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1357931470",
    "html_url": "https://github.com/ethereum/solidity/issues/13818#issuecomment-1357931470",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13818",
    "id": 1357931470,
    "node_id": "IC_kwDOAm_5kc5Q8GPO",
    "user": {
      "login": "k06a",
      "id": 702124,
      "node_id": "MDQ6VXNlcjcwMjEyNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/702124?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/k06a",
      "html_url": "https://github.com/k06a",
      "followers_url": "https://api.github.com/users/k06a/followers",
      "following_url": "https://api.github.com/users/k06a/following{/other_user}",
      "gists_url": "https://api.github.com/users/k06a/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/k06a/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/k06a/subscriptions",
      "organizations_url": "https://api.github.com/users/k06a/orgs",
      "repos_url": "https://api.github.com/users/k06a/repos",
      "events_url": "https://api.github.com/users/k06a/events{/privacy}",
      "received_events_url": "https://api.github.com/users/k06a/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-19T16:34:40Z",
    "updated_at": "2022-12-19T16:34:40Z",
    "author_association": "NONE",
    "body": "@hrkrshnn there are no issues with `calldata`, I see issue with `memory`. With all what you wrote I see we could improve memory layout for such objects to avoid storing offsets for static structures.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1357931470/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1358025133",
    "html_url": "https://github.com/ethereum/solidity/issues/13818#issuecomment-1358025133",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13818",
    "id": 1358025133,
    "node_id": "IC_kwDOAm_5kc5Q8dGt",
    "user": {
      "login": "hrkrshnn",
      "id": 13174375,
      "node_id": "MDQ6VXNlcjEzMTc0Mzc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/13174375?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hrkrshnn",
      "html_url": "https://github.com/hrkrshnn",
      "followers_url": "https://api.github.com/users/hrkrshnn/followers",
      "following_url": "https://api.github.com/users/hrkrshnn/following{/other_user}",
      "gists_url": "https://api.github.com/users/hrkrshnn/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hrkrshnn/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hrkrshnn/subscriptions",
      "organizations_url": "https://api.github.com/users/hrkrshnn/orgs",
      "repos_url": "https://api.github.com/users/hrkrshnn/repos",
      "events_url": "https://api.github.com/users/hrkrshnn/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hrkrshnn/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-19T17:51:49Z",
    "updated_at": "2022-12-19T17:51:49Z",
    "author_association": "MEMBER",
    "body": "@k06a I meant the following:\r\n\r\n> `calldata:`\r\n> \r\n> ```\r\n> 0000000000000000000000000000000000000000000000000000000000000003 <= items.length\r\n> 0000000000000000000000000000000000000000000000000000000000000001 <= items[0]\r\n> 0000000000000000000000000000000000000000000000000000000000000002\r\n> 0000000000000000000000000000000000000000000000000000000000000003 <= items[1]\r\n> 0000000000000000000000000000000000000000000000000000000000000004\r\n> 0000000000000000000000000000000000000000000000000000000000000005 <= items[2]\r\n> 0000000000000000000000000000000000000000000000000000000000000006\r\n> ```\r\n\r\nWhat is that encoding supposed to be?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1358025133/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1358246476",
    "html_url": "https://github.com/ethereum/solidity/issues/13818#issuecomment-1358246476",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13818",
    "id": 1358246476,
    "node_id": "IC_kwDOAm_5kc5Q9TJM",
    "user": {
      "login": "k06a",
      "id": 702124,
      "node_id": "MDQ6VXNlcjcwMjEyNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/702124?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/k06a",
      "html_url": "https://github.com/k06a",
      "followers_url": "https://api.github.com/users/k06a/followers",
      "following_url": "https://api.github.com/users/k06a/following{/other_user}",
      "gists_url": "https://api.github.com/users/k06a/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/k06a/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/k06a/subscriptions",
      "organizations_url": "https://api.github.com/users/k06a/orgs",
      "repos_url": "https://api.github.com/users/k06a/repos",
      "events_url": "https://api.github.com/users/k06a/events{/privacy}",
      "received_events_url": "https://api.github.com/users/k06a/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-19T20:19:05Z",
    "updated_at": "2022-12-19T20:19:05Z",
    "author_association": "NONE",
    "body": "@hrkrshnn I like `calldata` layout which you and me showed, I dislike `memory` layout. I'm not sure why you read my initial message that way that you think I see any problem in `calldata` layout. It is totally fine, I would prefer to have `memory` layout to be the same as `calldata` layout.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1358246476/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
