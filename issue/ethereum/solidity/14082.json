{
  "url": "https://api.github.com/repos/ethereum/solidity/issues/14082",
  "repository_url": "https://api.github.com/repos/ethereum/solidity",
  "labels_url": "https://api.github.com/repos/ethereum/solidity/issues/14082/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/solidity/issues/14082/comments",
  "events_url": "https://api.github.com/repos/ethereum/solidity/issues/14082/events",
  "html_url": "https://github.com/ethereum/solidity/issues/14082",
  "id": 1647301291,
  "node_id": "I_kwDOAm_5kc5iL9Kr",
  "number": 14082,
  "title": "Gnosis external tests failing due stack too deep error when using via-ir and yul-optimizer ",
  "user": {
    "login": "r0qs",
    "id": 457348,
    "node_id": "MDQ6VXNlcjQ1NzM0OA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/457348?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/r0qs",
    "html_url": "https://github.com/r0qs",
    "followers_url": "https://api.github.com/users/r0qs/followers",
    "following_url": "https://api.github.com/users/r0qs/following{/other_user}",
    "gists_url": "https://api.github.com/users/r0qs/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/r0qs/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/r0qs/subscriptions",
    "organizations_url": "https://api.github.com/users/r0qs/orgs",
    "repos_url": "https://api.github.com/users/r0qs/repos",
    "events_url": "https://api.github.com/users/r0qs/events{/privacy}",
    "received_events_url": "https://api.github.com/users/r0qs/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 249074435,
      "node_id": "MDU6TGFiZWwyNDkwNzQ0MzU=",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/bug%20:bug:",
      "name": "bug :bug:",
      "color": "fc1313",
      "default": false,
      "description": ""
    },
    {
      "id": 1018738457,
      "node_id": "MDU6TGFiZWwxMDE4NzM4NDU3",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/testing%20:hammer:",
      "name": "testing :hammer:",
      "color": "ffc6db",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2023-03-30T10:02:24Z",
  "updated_at": "2023-04-04T18:45:46Z",
  "closed_at": null,
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nCompilation of Gnosis external tests started to fail due to stack too deep error when running with `ir-optimize-evm+yul` preset.\r\n\r\n```\r\nYulException: Cannot swap Variable var_operation with Variable _1: too deep in the stack by 4 slots in \r\n[ var_operation RET var_operation var_data_2122_length var_signatures_2137_mpos var_signatures_2137_mpos var_to\r\nvar_refundReceiver var_gasToken var_gasPrice var_baseGas var_safeTxGas var_value var_data_2122_offset \r\nvar_refundReceiver var_to var_data_2122_length var_value var_gasToken var_gasPrice var_baseGas var_safeTxGas _1 ]\r\n\r\nNo memoryguard was present. Consider using memory-safe assembly only and annotating it via 'assembly (\"memory-safe\") { ... }'.\r\n\r\nError HH600: Compilation failed\r\n```\r\nThe problem was introduced by this commit: https://github.com/safe-global/safe-contracts/commit/b9fdbde766eb0fee958cb9b12a3b3e5193fd96ae\r\n\r\n## Environment\r\n\r\n- Compiler version: `0.8.19`\r\n- Compiler settings: `evmVersion: 'paris', viaIR: true,  optimizer: {enabled: true, details: {yul: true}}}`\r\n\r\n## Steps to Reproduce\r\n\r\n```\r\n./test/externalTests/gnosis.sh native $(which solc)\r\n```",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/14082/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/solidity/issues/14082/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1496204226",
    "html_url": "https://github.com/ethereum/solidity/issues/14082#issuecomment-1496204226",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/14082",
    "id": 1496204226,
    "node_id": "IC_kwDOAm_5kc5ZLkPC",
    "user": {
      "login": "mmv08",
      "id": 16622558,
      "node_id": "MDQ6VXNlcjE2NjIyNTU4",
      "avatar_url": "https://avatars.githubusercontent.com/u/16622558?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mmv08",
      "html_url": "https://github.com/mmv08",
      "followers_url": "https://api.github.com/users/mmv08/followers",
      "following_url": "https://api.github.com/users/mmv08/following{/other_user}",
      "gists_url": "https://api.github.com/users/mmv08/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mmv08/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mmv08/subscriptions",
      "organizations_url": "https://api.github.com/users/mmv08/orgs",
      "repos_url": "https://api.github.com/users/mmv08/repos",
      "events_url": "https://api.github.com/users/mmv08/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mmv08/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-04T15:42:30Z",
    "updated_at": "2023-04-04T15:42:30Z",
    "author_association": "NONE",
    "body": "I'm from Safe, and I came to report this exact issue here and was surprised it is already being tracked. One interesting thing we found is that with solc 0.8.16 or 0.8.17, it works flawlessly.\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1496204226/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1496248463",
    "html_url": "https://github.com/ethereum/solidity/issues/14082#issuecomment-1496248463",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/14082",
    "id": 1496248463,
    "node_id": "IC_kwDOAm_5kc5ZLvCP",
    "user": {
      "login": "cameel",
      "id": 137030,
      "node_id": "MDQ6VXNlcjEzNzAzMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cameel",
      "html_url": "https://github.com/cameel",
      "followers_url": "https://api.github.com/users/cameel/followers",
      "following_url": "https://api.github.com/users/cameel/following{/other_user}",
      "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
      "organizations_url": "https://api.github.com/users/cameel/orgs",
      "repos_url": "https://api.github.com/users/cameel/repos",
      "events_url": "https://api.github.com/users/cameel/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cameel/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-04T16:12:16Z",
    "updated_at": "2023-04-04T18:44:15Z",
    "author_association": "MEMBER",
    "body": "Well, the \"Stack too deep\" error is easily affected by even small and seemingly unrelated changes in the piece of code that triggers it. It's not triggered by any single thing in high level code but by stack pressure from multiple small things accumulating and finally spilling over the 16 slot limit. Something we changed in code generation in 0.8.18 might have easily pushed it over if it was already close to that breaking point in your code. See https://github.com/ethereum/solidity/issues/13906#issuecomment-1417335621 for an example of such a situation. You could probably avoid it with trivial modifications around the change that finally triggered it, though often finding that spot is quite tedious and the compiler can't really point at it.\r\n\r\nThe high-level issue about \"Stack too deep\" is one of our roadmap tasks (#13721) and for unoptimized code #13972 will probably be a solution.\r\n\r\nThe issue here is only to patch it in our external tests. Preferably with an upstream patch. We were actually going to file an issue about that. @ekpyron suggested that just marking assembly blocks as `\"memory safe\"` on your side might do the trick.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1496248463/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1496270701",
    "html_url": "https://github.com/ethereum/solidity/issues/14082#issuecomment-1496270701",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/14082",
    "id": 1496270701,
    "node_id": "IC_kwDOAm_5kc5ZL0dt",
    "user": {
      "login": "cameel",
      "id": 137030,
      "node_id": "MDQ6VXNlcjEzNzAzMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cameel",
      "html_url": "https://github.com/cameel",
      "followers_url": "https://api.github.com/users/cameel/followers",
      "following_url": "https://api.github.com/users/cameel/following{/other_user}",
      "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
      "organizations_url": "https://api.github.com/users/cameel/orgs",
      "repos_url": "https://api.github.com/users/cameel/repos",
      "events_url": "https://api.github.com/users/cameel/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cameel/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-04T16:29:11Z",
    "updated_at": "2023-04-04T16:29:11Z",
    "author_association": "MEMBER",
    "body": "By the way, @mmv08 there's actually a related topic we wanted to bring up to you (and other projects we use as external tests for the compiler).\r\n\r\nWould you be willing to add a test run on your side with a bleeding edge compiler build to detect changes that could potentially affect your project? We're currently doing that on our side and the issue is that we often run into breakage that's not caused by the compiler itself but changes in dependencies, Hardhat, etc. Breakage is not that frequent from any single project but with 15 of them in our test suite we see it all the time. Since we're not in the JS ecosystem, it takes some effort to understand what happened and patch it. We thought that it would be more scalable if we could get upstream teams to regularly run their test suite run with the latest binary and report problems to us only when they're actually coming from the compiler. This way you get an early warning about changes that would break your code and we get only relevant reports to deal with. What do you think about it?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1496270701/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 1,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1496287404",
    "html_url": "https://github.com/ethereum/solidity/issues/14082#issuecomment-1496287404",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/14082",
    "id": 1496287404,
    "node_id": "IC_kwDOAm_5kc5ZL4is",
    "user": {
      "login": "mmv08",
      "id": 16622558,
      "node_id": "MDQ6VXNlcjE2NjIyNTU4",
      "avatar_url": "https://avatars.githubusercontent.com/u/16622558?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mmv08",
      "html_url": "https://github.com/mmv08",
      "followers_url": "https://api.github.com/users/mmv08/followers",
      "following_url": "https://api.github.com/users/mmv08/following{/other_user}",
      "gists_url": "https://api.github.com/users/mmv08/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mmv08/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mmv08/subscriptions",
      "organizations_url": "https://api.github.com/users/mmv08/orgs",
      "repos_url": "https://api.github.com/users/mmv08/repos",
      "events_url": "https://api.github.com/users/mmv08/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mmv08/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-04T16:43:04Z",
    "updated_at": "2023-04-04T16:43:04Z",
    "author_association": "NONE",
    "body": "@cameel, I will bring this to the team. It might make sense to do it because we run a GitHub action to detect compilation issues with 0.8.x (this is how we caught this issue)",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1496287404/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1496439256",
    "html_url": "https://github.com/ethereum/solidity/issues/14082#issuecomment-1496439256",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/14082",
    "id": 1496439256,
    "node_id": "IC_kwDOAm_5kc5ZMdnY",
    "user": {
      "login": "cameel",
      "id": 137030,
      "node_id": "MDQ6VXNlcjEzNzAzMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cameel",
      "html_url": "https://github.com/cameel",
      "followers_url": "https://api.github.com/users/cameel/followers",
      "following_url": "https://api.github.com/users/cameel/following{/other_user}",
      "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
      "organizations_url": "https://api.github.com/users/cameel/orgs",
      "repos_url": "https://api.github.com/users/cameel/repos",
      "events_url": "https://api.github.com/users/cameel/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cameel/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-04T18:45:46Z",
    "updated_at": "2023-04-04T18:45:46Z",
    "author_association": "MEMBER",
    "body": "Thanks! Let me know if they agree. We could then think how to set it up. We'd probably prepare some scripts from our side to make it easy to get the compiler and settings for the test.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1496439256/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
