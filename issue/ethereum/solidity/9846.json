{
  "url": "https://api.github.com/repos/ethereum/solidity/issues/9846",
  "repository_url": "https://api.github.com/repos/ethereum/solidity",
  "labels_url": "https://api.github.com/repos/ethereum/solidity/issues/9846/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/solidity/issues/9846/comments",
  "events_url": "https://api.github.com/repos/ethereum/solidity/issues/9846/events",
  "html_url": "https://github.com/ethereum/solidity/issues/9846",
  "id": 705177886,
  "node_id": "MDU6SXNzdWU3MDUxNzc4ODY=",
  "number": 9846,
  "title": "Deleting a struct from the storage is not cheaper than zeroing its fields",
  "user": {
    "login": "CodeSandwich",
    "id": 26183680,
    "node_id": "MDQ6VXNlcjI2MTgzNjgw",
    "avatar_url": "https://avatars.githubusercontent.com/u/26183680?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/CodeSandwich",
    "html_url": "https://github.com/CodeSandwich",
    "followers_url": "https://api.github.com/users/CodeSandwich/followers",
    "following_url": "https://api.github.com/users/CodeSandwich/following{/other_user}",
    "gists_url": "https://api.github.com/users/CodeSandwich/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/CodeSandwich/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/CodeSandwich/subscriptions",
    "organizations_url": "https://api.github.com/users/CodeSandwich/orgs",
    "repos_url": "https://api.github.com/users/CodeSandwich/repos",
    "events_url": "https://api.github.com/users/CodeSandwich/events{/privacy}",
    "received_events_url": "https://api.github.com/users/CodeSandwich/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 7,
  "created_at": "2020-09-20T20:18:04Z",
  "updated_at": "2020-09-23T10:09:00Z",
  "closed_at": "2020-09-21T09:45:51Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nWhen removing from storage a structure, which doesn't fill a single 32 byte word, it's not cheaper to zero out its fields than to delete the whole thing, see \"steps to reproduce\". This doesn't make sense, because deleting should just store zeros while zeroing a single field requires reading before storing to preserve the content of the rest of the fields.\r\n\r\nI've noticed it first while testing a real-world contract compiled with Solidity 0.6.12 running on Buidler EVM, but Remix gas usage estimation on Solidity 0.7.1 aligns closely with it.\r\n\r\nThis effect disappears when the structure fills the storage cell completely, deleting the whole item becomes much cheaper.\r\n\r\n## Environment\r\n\r\n- Compiler version: 0.7.1, 0.6.12.\r\n- Target EVM version (as per compiler settings): Istambul\r\n- Framework/IDE (e.g. Truffle or Remix): Remix / Buidler\r\n- EVM execution environment / backend / blockchain client: Remix / Buidler EVM\r\n- Operating system: Web / Linux\r\n\r\n## Steps to Reproduce\r\n\r\nThe gas usages are Remix estimations, but they match what I've noticed in Buidler EVM tests.\r\n\r\nWhen the struct takes up only a fraction of the storage cell:\r\n\r\n```solidity\r\npragma solidity ^0.7.0;\r\n\r\ncontract WeirdDeleteCostPartial {\r\n    \r\n    struct Data {\r\n        uint32 first;\r\n        uint32 second;\r\n    }\r\n    \r\n    Data private data;\r\n    \r\n    // gas usage: 20984\r\n    function zeroFirst() public {\r\n        data.first = 0;\r\n    }\r\n    \r\n    // gas usage: 20962\r\n    function zeroSecond() public {\r\n        data.second = 0;\r\n    }\r\n    \r\n    // gas usage: 20940\r\n    function zeroBoth() public {\r\n        data.first = 0;\r\n        data.second = 0;\r\n    }\r\n    \r\n    // gas usage: 21006\r\n    function deleteWhole() public {\r\n        delete data;\r\n    }\r\n}\r\n```\r\n\r\nWhen the struct takes up the whole storage cell:\r\n\r\n```solidity\r\npragma solidity ^0.7.0;\r\n\r\ncontract WeirdDeleteCostFull {\r\n    \r\n    struct Data {\r\n        uint128 first;\r\n        uint128 second;\r\n    }\r\n    \r\n    Data private data;\r\n    \r\n    // gas usage: 20984\r\n    function zeroFirst() public {\r\n        data.first = 0;\r\n    }\r\n    \r\n    // gas usage: 20959\r\n    function zeroSecond() public {\r\n        data.second = 0;\r\n    }\r\n    \r\n    // gas usage: 5128\r\n    function zeroBoth() public {\r\n        data.first = 0;\r\n        data.second = 0;\r\n    }\r\n    \r\n    // gas usage: 5194\r\n    function deleteWhole() public {\r\n        delete data;\r\n    }\r\n}\r\n```",
  "closed_by": {
    "login": "chriseth",
    "id": 9073706,
    "node_id": "MDQ6VXNlcjkwNzM3MDY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/9073706?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/chriseth",
    "html_url": "https://github.com/chriseth",
    "followers_url": "https://api.github.com/users/chriseth/followers",
    "following_url": "https://api.github.com/users/chriseth/following{/other_user}",
    "gists_url": "https://api.github.com/users/chriseth/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/chriseth/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/chriseth/subscriptions",
    "organizations_url": "https://api.github.com/users/chriseth/orgs",
    "repos_url": "https://api.github.com/users/chriseth/repos",
    "events_url": "https://api.github.com/users/chriseth/events{/privacy}",
    "received_events_url": "https://api.github.com/users/chriseth/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/9846/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/solidity/issues/9846/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/696010949",
    "html_url": "https://github.com/ethereum/solidity/issues/9846#issuecomment-696010949",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/9846",
    "id": 696010949,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY5NjAxMDk0OQ==",
    "user": {
      "login": "chriseth",
      "id": 9073706,
      "node_id": "MDQ6VXNlcjkwNzM3MDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9073706?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chriseth",
      "html_url": "https://github.com/chriseth",
      "followers_url": "https://api.github.com/users/chriseth/followers",
      "following_url": "https://api.github.com/users/chriseth/following{/other_user}",
      "gists_url": "https://api.github.com/users/chriseth/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chriseth/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chriseth/subscriptions",
      "organizations_url": "https://api.github.com/users/chriseth/orgs",
      "repos_url": "https://api.github.com/users/chriseth/repos",
      "events_url": "https://api.github.com/users/chriseth/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chriseth/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-09-21T09:45:51Z",
    "updated_at": "2020-09-21T09:45:51Z",
    "author_association": "MEMBER",
    "body": "Thanks for opening this issue!\r\n\r\nIf the optimizer is activated, the compiler actually combines the two functions `deleteWhole` and `zeroBoth` into the following:\r\n```\r\n        /* \"/tmp/x.sol\":443:526  function zeroBoth() public {... */\r\n    tag_9:\r\n        /* \"/tmp/x.sol\":493:494  0 */\r\n      0x00\r\n        /* \"/tmp/x.sol\":480:494  data.first = 0 */\r\n      dup1\r\n      sload\r\n      not(0xffffffffffffffff)\r\n        /* \"/tmp/x.sol\":504:519  data.second = 0 */\r\n      and\r\n      swap1\r\n      sstore\r\n        /* \"/tmp/x.sol\":443:526  function zeroBoth() public {... */\r\n      jump\t// out\r\n```\r\n\r\nThe differences in gas cost you see probably stem from the different paths of execution through the dispatch routine.\r\n\r\nNote that for security reasons, the compiler does not assume that it can just \"overwrite\" the rest of the slot. You did not define any variable there but that does not mean that it is unused. It could be used due to an update routine or inline assembly.\r\n\r\nPlease feel free to reopen if you want to further discuss this.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/696010949/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/696078441",
    "html_url": "https://github.com/ethereum/solidity/issues/9846#issuecomment-696078441",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/9846",
    "id": 696078441,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY5NjA3ODQ0MQ==",
    "user": {
      "login": "CodeSandwich",
      "id": 26183680,
      "node_id": "MDQ6VXNlcjI2MTgzNjgw",
      "avatar_url": "https://avatars.githubusercontent.com/u/26183680?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/CodeSandwich",
      "html_url": "https://github.com/CodeSandwich",
      "followers_url": "https://api.github.com/users/CodeSandwich/followers",
      "following_url": "https://api.github.com/users/CodeSandwich/following{/other_user}",
      "gists_url": "https://api.github.com/users/CodeSandwich/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/CodeSandwich/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/CodeSandwich/subscriptions",
      "organizations_url": "https://api.github.com/users/CodeSandwich/orgs",
      "repos_url": "https://api.github.com/users/CodeSandwich/repos",
      "events_url": "https://api.github.com/users/CodeSandwich/events{/privacy}",
      "received_events_url": "https://api.github.com/users/CodeSandwich/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-09-21T12:21:08Z",
    "updated_at": "2020-09-21T12:21:08Z",
    "author_association": "NONE",
    "body": "> the compiler does not assume that it can just \"overwrite\" the rest of the slot\r\n\r\nAah, now with this constraint that behavior makes perfect sense! But that means that as a simple Solidity coder I'm paying 15K of gas for keeping `delete` a little hacky when it comes to releasing storage. It adds up quickly and as of 2020 mainnet that's real money. I'm not planning to use any hidden fields in my storage, is there a fast track to release it cheaply and reliably? One way that comes to my mind would be to fill up the rest of the slot with a dummy field to prove that Solidity is in full control. Is there a more elegant workaround?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/696078441/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/696152776",
    "html_url": "https://github.com/ethereum/solidity/issues/9846#issuecomment-696152776",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/9846",
    "id": 696152776,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY5NjE1Mjc3Ng==",
    "user": {
      "login": "chriseth",
      "id": 9073706,
      "node_id": "MDQ6VXNlcjkwNzM3MDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9073706?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chriseth",
      "html_url": "https://github.com/chriseth",
      "followers_url": "https://api.github.com/users/chriseth/followers",
      "following_url": "https://api.github.com/users/chriseth/following{/other_user}",
      "gists_url": "https://api.github.com/users/chriseth/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chriseth/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chriseth/subscriptions",
      "organizations_url": "https://api.github.com/users/chriseth/orgs",
      "repos_url": "https://api.github.com/users/chriseth/repos",
      "events_url": "https://api.github.com/users/chriseth/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chriseth/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-09-21T14:28:43Z",
    "updated_at": "2020-09-21T14:28:43Z",
    "author_association": "MEMBER",
    "body": "I'm only seeing a difference of 700 gas - where do you get the 15k from?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/696152776/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/696154289",
    "html_url": "https://github.com/ethereum/solidity/issues/9846#issuecomment-696154289",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/9846",
    "id": 696154289,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY5NjE1NDI4OQ==",
    "user": {
      "login": "CodeSandwich",
      "id": 26183680,
      "node_id": "MDQ6VXNlcjI2MTgzNjgw",
      "avatar_url": "https://avatars.githubusercontent.com/u/26183680?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/CodeSandwich",
      "html_url": "https://github.com/CodeSandwich",
      "followers_url": "https://api.github.com/users/CodeSandwich/followers",
      "following_url": "https://api.github.com/users/CodeSandwich/following{/other_user}",
      "gists_url": "https://api.github.com/users/CodeSandwich/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/CodeSandwich/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/CodeSandwich/subscriptions",
      "organizations_url": "https://api.github.com/users/CodeSandwich/orgs",
      "repos_url": "https://api.github.com/users/CodeSandwich/repos",
      "events_url": "https://api.github.com/users/CodeSandwich/events{/privacy}",
      "received_events_url": "https://api.github.com/users/CodeSandwich/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-09-21T14:31:10Z",
    "updated_at": "2020-09-21T14:31:10Z",
    "author_association": "NONE",
    "body": "`WeirdDeleteCostPartial.deleteWhole()` costs 21006 gas while `WeirdDeleteCostFull.deleteWhole` just 5194, it's almost 16K of difference.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/696154289/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/696172304",
    "html_url": "https://github.com/ethereum/solidity/issues/9846#issuecomment-696172304",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/9846",
    "id": 696172304,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY5NjE3MjMwNA==",
    "user": {
      "login": "chriseth",
      "id": 9073706,
      "node_id": "MDQ6VXNlcjkwNzM3MDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9073706?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chriseth",
      "html_url": "https://github.com/chriseth",
      "followers_url": "https://api.github.com/users/chriseth/followers",
      "following_url": "https://api.github.com/users/chriseth/following{/other_user}",
      "gists_url": "https://api.github.com/users/chriseth/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chriseth/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chriseth/subscriptions",
      "organizations_url": "https://api.github.com/users/chriseth/orgs",
      "repos_url": "https://api.github.com/users/chriseth/repos",
      "events_url": "https://api.github.com/users/chriseth/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chriseth/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-09-21T15:00:52Z",
    "updated_at": "2020-09-21T15:00:52Z",
    "author_association": "MEMBER",
    "body": "Did you activate the optimizer? I'm seeing 23078 / 1806 compared to 22266 / 994. Also please take the storage clearing refund into account - clearing storage that has been zero before has a different cost than clearing storage that was not zero before. The numbers here are with storage that was zero before, as in your example.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/696172304/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/696197162",
    "html_url": "https://github.com/ethereum/solidity/issues/9846#issuecomment-696197162",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/9846",
    "id": 696197162,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY5NjE5NzE2Mg==",
    "user": {
      "login": "CodeSandwich",
      "id": 26183680,
      "node_id": "MDQ6VXNlcjI2MTgzNjgw",
      "avatar_url": "https://avatars.githubusercontent.com/u/26183680?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/CodeSandwich",
      "html_url": "https://github.com/CodeSandwich",
      "followers_url": "https://api.github.com/users/CodeSandwich/followers",
      "following_url": "https://api.github.com/users/CodeSandwich/following{/other_user}",
      "gists_url": "https://api.github.com/users/CodeSandwich/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/CodeSandwich/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/CodeSandwich/subscriptions",
      "organizations_url": "https://api.github.com/users/CodeSandwich/orgs",
      "repos_url": "https://api.github.com/users/CodeSandwich/repos",
      "events_url": "https://api.github.com/users/CodeSandwich/events{/privacy}",
      "received_events_url": "https://api.github.com/users/CodeSandwich/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-09-21T15:37:28Z",
    "updated_at": "2020-09-21T15:37:28Z",
    "author_association": "NONE",
    "body": "Yes, these are numbers with optimizer enabled.\r\n\r\nCould you explain, in which cases you're getting 23078, 1806, 22266 and 994 gas costs?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/696197162/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/697267670",
    "html_url": "https://github.com/ethereum/solidity/issues/9846#issuecomment-697267670",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/9846",
    "id": 697267670,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY5NzI2NzY3MA==",
    "user": {
      "login": "chriseth",
      "id": 9073706,
      "node_id": "MDQ6VXNlcjkwNzM3MDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9073706?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chriseth",
      "html_url": "https://github.com/chriseth",
      "followers_url": "https://api.github.com/users/chriseth/followers",
      "following_url": "https://api.github.com/users/chriseth/following{/other_user}",
      "gists_url": "https://api.github.com/users/chriseth/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chriseth/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chriseth/subscriptions",
      "organizations_url": "https://api.github.com/users/chriseth/orgs",
      "repos_url": "https://api.github.com/users/chriseth/repos",
      "events_url": "https://api.github.com/users/chriseth/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chriseth/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-09-23T10:09:00Z",
    "updated_at": "2020-09-23T10:09:00Z",
    "author_association": "MEMBER",
    "body": "The larger numbers are for the transaction itself (i.e. including the tx and data cost), the smaller numbers just for the execution.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/697267670/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
