{
  "url": "https://api.github.com/repos/ethereum/solidity/issues/11669",
  "repository_url": "https://api.github.com/repos/ethereum/solidity",
  "labels_url": "https://api.github.com/repos/ethereum/solidity/issues/11669/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/solidity/issues/11669/comments",
  "events_url": "https://api.github.com/repos/ethereum/solidity/issues/11669/events",
  "html_url": "https://github.com/ethereum/solidity/issues/11669",
  "id": 945549661,
  "node_id": "MDU6SXNzdWU5NDU1NDk2NjE=",
  "number": 11669,
  "title": "Retain source location annotations across the optimizer",
  "user": {
    "login": "chriseth",
    "id": 9073706,
    "node_id": "MDQ6VXNlcjkwNzM3MDY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/9073706?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/chriseth",
    "html_url": "https://github.com/chriseth",
    "followers_url": "https://api.github.com/users/chriseth/followers",
    "following_url": "https://api.github.com/users/chriseth/following{/other_user}",
    "gists_url": "https://api.github.com/users/chriseth/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/chriseth/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/chriseth/subscriptions",
    "organizations_url": "https://api.github.com/users/chriseth/orgs",
    "repos_url": "https://api.github.com/users/chriseth/repos",
    "events_url": "https://api.github.com/users/chriseth/events{/privacy}",
    "received_events_url": "https://api.github.com/users/chriseth/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "christianparpart",
    "id": 56763,
    "node_id": "MDQ6VXNlcjU2NzYz",
    "avatar_url": "https://avatars.githubusercontent.com/u/56763?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/christianparpart",
    "html_url": "https://github.com/christianparpart",
    "followers_url": "https://api.github.com/users/christianparpart/followers",
    "following_url": "https://api.github.com/users/christianparpart/following{/other_user}",
    "gists_url": "https://api.github.com/users/christianparpart/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/christianparpart/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/christianparpart/subscriptions",
    "organizations_url": "https://api.github.com/users/christianparpart/orgs",
    "repos_url": "https://api.github.com/users/christianparpart/repos",
    "events_url": "https://api.github.com/users/christianparpart/events{/privacy}",
    "received_events_url": "https://api.github.com/users/christianparpart/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "christianparpart",
      "id": 56763,
      "node_id": "MDQ6VXNlcjU2NzYz",
      "avatar_url": "https://avatars.githubusercontent.com/u/56763?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/christianparpart",
      "html_url": "https://github.com/christianparpart",
      "followers_url": "https://api.github.com/users/christianparpart/followers",
      "following_url": "https://api.github.com/users/christianparpart/following{/other_user}",
      "gists_url": "https://api.github.com/users/christianparpart/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/christianparpart/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/christianparpart/subscriptions",
      "organizations_url": "https://api.github.com/users/christianparpart/orgs",
      "repos_url": "https://api.github.com/users/christianparpart/repos",
      "events_url": "https://api.github.com/users/christianparpart/events{/privacy}",
      "received_events_url": "https://api.github.com/users/christianparpart/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2021-07-15T16:13:39Z",
  "updated_at": "2021-08-04T10:50:09Z",
  "closed_at": "2021-08-04T10:50:09Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "When using `solc --experimental-via-ir --asm file.sol`, the source locations are wrong, even with all pending pull requests in that area merged. The problem is that the yul->evm codegen in CompilerStack uses the optimized IR even when the optimizer is switched off. Still, the optiimzed IR is not the same as the non-optimized IR in that case: In `IRGenerator::run`, the AssemblyStack is used to parse the non-optimized IR, create a Yul AST from it, perform no operations on it (because the optimizer is disabled) and print it again. This printing loses all annotation comments, so the solution is to re-print the annotations in the AsmPrinter.\r\n\r\nRequired changes:\r\n\r\n### Introduce struct `ObjectDebugData` in the `Object` class to include the source mappings.\r\n\r\nCurrently, the ObjectParser only stores the source index to source name mapping temporarily during parsing. It should just store it in the Object's debug data so it can be printed again.\r\n\r\n### Change AsmPrinter to print both `@use-src` and `@src`\r\n\r\n - `Object::toString` should be changed to print `@use-src` from the object's debug data\r\n - `AsmPrinter` should be changed to print the `@src` annotations (being passed in the source name to source number mapping from Object::toString).\r\n\r\nOf course, the AsmPrinter should only print the `@src` tag if it has changed since the last AST node.\r\nFor now, it is probably best to always use `/** ... */` instead of `///` because the logic about when to introduce a newline could be a bit tricky.\r\n",
  "closed_by": {
    "login": "Marenz",
    "id": 424752,
    "node_id": "MDQ6VXNlcjQyNDc1Mg==",
    "avatar_url": "https://avatars.githubusercontent.com/u/424752?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Marenz",
    "html_url": "https://github.com/Marenz",
    "followers_url": "https://api.github.com/users/Marenz/followers",
    "following_url": "https://api.github.com/users/Marenz/following{/other_user}",
    "gists_url": "https://api.github.com/users/Marenz/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Marenz/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Marenz/subscriptions",
    "organizations_url": "https://api.github.com/users/Marenz/orgs",
    "repos_url": "https://api.github.com/users/Marenz/repos",
    "events_url": "https://api.github.com/users/Marenz/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Marenz/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/11669/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/solidity/issues/11669/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/892556200",
    "html_url": "https://github.com/ethereum/solidity/issues/11669#issuecomment-892556200",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/11669",
    "id": 892556200,
    "node_id": "IC_kwDOAm_5kc41M1Oo",
    "user": {
      "login": "christianparpart",
      "id": 56763,
      "node_id": "MDQ6VXNlcjU2NzYz",
      "avatar_url": "https://avatars.githubusercontent.com/u/56763?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/christianparpart",
      "html_url": "https://github.com/christianparpart",
      "followers_url": "https://api.github.com/users/christianparpart/followers",
      "following_url": "https://api.github.com/users/christianparpart/following{/other_user}",
      "gists_url": "https://api.github.com/users/christianparpart/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/christianparpart/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/christianparpart/subscriptions",
      "organizations_url": "https://api.github.com/users/christianparpart/orgs",
      "repos_url": "https://api.github.com/users/christianparpart/repos",
      "events_url": "https://api.github.com/users/christianparpart/events{/privacy}",
      "received_events_url": "https://api.github.com/users/christianparpart/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-08-04T10:44:17Z",
    "updated_at": "2021-08-04T10:44:17Z",
    "author_association": "MEMBER",
    "body": "I think this is now all done and merged, right?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/892556200/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
