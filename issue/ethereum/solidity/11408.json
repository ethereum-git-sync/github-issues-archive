{
  "url": "https://api.github.com/repos/ethereum/solidity/issues/11408",
  "repository_url": "https://api.github.com/repos/ethereum/solidity",
  "labels_url": "https://api.github.com/repos/ethereum/solidity/issues/11408/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/solidity/issues/11408/comments",
  "events_url": "https://api.github.com/repos/ethereum/solidity/issues/11408/events",
  "html_url": "https://github.com/ethereum/solidity/issues/11408",
  "id": 894916658,
  "node_id": "MDU6SXNzdWU4OTQ5MTY2NTg=",
  "number": 11408,
  "title": "Stripping --base-path from CLI paths + CLI path normalization (path spec v3)",
  "user": {
    "login": "cameel",
    "id": 137030,
    "node_id": "MDQ6VXNlcjEzNzAzMA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/cameel",
    "html_url": "https://github.com/cameel",
    "followers_url": "https://api.github.com/users/cameel/followers",
    "following_url": "https://api.github.com/users/cameel/following{/other_user}",
    "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
    "organizations_url": "https://api.github.com/users/cameel/orgs",
    "repos_url": "https://api.github.com/users/cameel/repos",
    "events_url": "https://api.github.com/users/cameel/events{/privacy}",
    "received_events_url": "https://api.github.com/users/cameel/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "cameel",
    "id": 137030,
    "node_id": "MDQ6VXNlcjEzNzAzMA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/cameel",
    "html_url": "https://github.com/cameel",
    "followers_url": "https://api.github.com/users/cameel/followers",
    "following_url": "https://api.github.com/users/cameel/following{/other_user}",
    "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
    "organizations_url": "https://api.github.com/users/cameel/orgs",
    "repos_url": "https://api.github.com/users/cameel/repos",
    "events_url": "https://api.github.com/users/cameel/events{/privacy}",
    "received_events_url": "https://api.github.com/users/cameel/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "cameel",
      "id": 137030,
      "node_id": "MDQ6VXNlcjEzNzAzMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cameel",
      "html_url": "https://github.com/cameel",
      "followers_url": "https://api.github.com/users/cameel/followers",
      "following_url": "https://api.github.com/users/cameel/following{/other_user}",
      "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
      "organizations_url": "https://api.github.com/users/cameel/orgs",
      "repos_url": "https://api.github.com/users/cameel/repos",
      "events_url": "https://api.github.com/users/cameel/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cameel/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2021-05-19T01:58:43Z",
  "updated_at": "2021-08-27T19:51:06Z",
  "closed_at": "2021-08-27T19:51:05Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "Closes #4702.\r\nRelated to #9353.\r\nPart of a set of issues that replaces #11138.\r\n\r\n## Abstract\r\nCurrently the paths specified on the command line are used directly as source unit names in compiler's virtual filesystem. This means that the paths embedded in contract metadata (and as a consequence also the generated bytecode) can be different depending on where the compiler is invoked from and whether an absolute or a relative path was used. This may lead to problems with reproducing the same bytecode for verification. Another undesirable effect is that when the same file is used in an `import`, its source unit name may be different leading to it being seen by the compiler as a different file and being compiled again (#4702).\r\n\r\nMany users are not even aware of the distinction between CLI paths and source unit names (see #11263 for a detailed description of how paths/imports work currently) which makes it hard to understand and resolve the resulting issues.\r\n\r\nMy proposed solution is to always convert paths specified on the CLI to a canonical form and, if possible, make them relative to base path.\r\n\r\n## Motivation\r\nLet's assume we have `/tmp/contract.sol` with the following content:\r\n```solidity\r\nimport \"tokens/token.sol\"; // source unit name: tokens/token.sol\r\n```\r\n`/tmp/tokens/token.sol` contains:\r\n```solidity\r\ncontract Token {}\r\n```\r\nand we compile them with:\r\n```bash\r\ncd /tmp\r\nsolc --metadata contract.sol /tmp/tokens/token.sol tokens///token.sol # source unit names: /tmp/tokens/token.sol, tokens///token.sol\r\n```\r\n`token.sol` ends up in the virtual filesystem under three different source unit names even though all the paths refer to the same file in the underlying filesystem:\r\n```json\r\n======= /tmp/tokens/token.sol:Token =======\r\nMetadata:\r\n{\"compiler\":{\"version\":\"0.8.4+commit.c7e474f2\"},\"language\":\"Solidity\",\"output\":{\"abi\":[],\"devdoc\":{\"kind\":\"dev\",\"methods\":{},\"version\":1},\"userdoc\":{\"kind\":\"user\",\"methods\":{},\"version\":1}},\"settings\":{\"compilationTarget\":{\"/tmp/tokens/token.sol\":\"Token\"},\"evmVersion\":\"istanbul\",\"libraries\":{},\"metadata\":{\"bytecodeHash\":\"ipfs\"},\"optimizer\":{\"enabled\":false,\"runs\":200},\"remappings\":[]},\"sources\":{\"/tmp/tokens/token.sol\":{\"keccak256\":\"0x0ef316769f47a1402d4b77e0eee0e4b048f2928077bd178d3a0c32015b0ee9e9\",\"urls\":[\"bzz-raw://a4123fed04d2dccefceb39a66f625e7f3bad8f8c40def33580cfce2bafd395ad\",\"dweb:/ipfs/QmcngRtGbNaXjQc7PQU3qvMV3jg1MQjYKaZtGKzDxsZ2vb\"]}},\"version\":1}\r\n\r\n======= tokens///token.sol:Token =======\r\nMetadata:\r\n{\"compiler\":{\"version\":\"0.8.4+commit.c7e474f2\"},\"language\":\"Solidity\",\"output\":{\"abi\":[],\"devdoc\":{\"kind\":\"dev\",\"methods\":{},\"version\":1},\"userdoc\":{\"kind\":\"user\",\"methods\":{},\"version\":1}},\"settings\":{\"compilationTarget\":{\"tokens///token.sol\":\"Token\"},\"evmVersion\":\"istanbul\",\"libraries\":{},\"metadata\":{\"bytecodeHash\":\"ipfs\"},\"optimizer\":{\"enabled\":false,\"runs\":200},\"remappings\":[]},\"sources\":{\"tokens///token.sol\":{\"keccak256\":\"0x0ef316769f47a1402d4b77e0eee0e4b048f2928077bd178d3a0c32015b0ee9e9\",\"urls\":[\"bzz-raw://a4123fed04d2dccefceb39a66f625e7f3bad8f8c40def33580cfce2bafd395ad\",\"dweb:/ipfs/QmcngRtGbNaXjQc7PQU3qvMV3jg1MQjYKaZtGKzDxsZ2vb\"]}},\"version\":1}\r\n\r\n======= tokens/token.sol:Token =======\r\nMetadata:\r\n{\"compiler\":{\"version\":\"0.8.4+commit.c7e474f2\"},\"language\":\"Solidity\",\"output\":{\"abi\":[],\"devdoc\":{\"kind\":\"dev\",\"methods\":{},\"version\":1},\"userdoc\":{\"kind\":\"user\",\"methods\":{},\"version\":1}},\"settings\":{\"compilationTarget\":{\"tokens/token.sol\":\"Token\"},\"evmVersion\":\"istanbul\",\"libraries\":{},\"metadata\":{\"bytecodeHash\":\"ipfs\"},\"optimizer\":{\"enabled\":false,\"runs\":200},\"remappings\":[]},\"sources\":{\"tokens/token.sol\":{\"keccak256\":\"0x0ef316769f47a1402d4b77e0eee0e4b048f2928077bd178d3a0c32015b0ee9e9\",\"urls\":[\"bzz-raw://a4123fed04d2dccefceb39a66f625e7f3bad8f8c40def33580cfce2bafd395ad\",\"dweb:/ipfs/QmcngRtGbNaXjQc7PQU3qvMV3jg1MQjYKaZtGKzDxsZ2vb\"]}},\"version\":1}\r\n```\r\n\r\n## Specification\r\nPaths to files specified on the command line should be processed according to the following rules:\r\n1. Make the path canonical:\r\n    - Make it absolute if it's relative (treating as relative to the current working directory).\r\n    - Replace platform-specific path separators with `/`.\r\n    - Collapse `./` and `../` segments.\r\n    - Squash sequences of multiple consecutive slashes into a single slash.\r\n    - If the filesystem is case-insensitive, use the case the filesystem reports (rather than the exact case used on the command line).\r\n2. If the file is located inside the directory designated as `--base-path`, the path is made relative to that directory.\r\n3. Implement the same logic in [solcjs](https://github.com/ethereum/solc-js/blob/master/solcjs).\r\n\r\n## Backwards Compatibility\r\nThe change is fully backwards-compatible. It does not change semantics or break any contracts. It also affects only files given on the command line (`--standard-json` remains completely unaffected).\r\n\r\nAny CLI invocation that worked before will still work but now it may produce slightly different bytecode due to a change in metadata.\r\n",
  "closed_by": {
    "login": "cameel",
    "id": 137030,
    "node_id": "MDQ6VXNlcjEzNzAzMA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/cameel",
    "html_url": "https://github.com/cameel",
    "followers_url": "https://api.github.com/users/cameel/followers",
    "following_url": "https://api.github.com/users/cameel/following{/other_user}",
    "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
    "organizations_url": "https://api.github.com/users/cameel/orgs",
    "repos_url": "https://api.github.com/users/cameel/repos",
    "events_url": "https://api.github.com/users/cameel/events{/privacy}",
    "received_events_url": "https://api.github.com/users/cameel/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/11408/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/solidity/issues/11408/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/844888583",
    "html_url": "https://github.com/ethereum/solidity/issues/11408#issuecomment-844888583",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/11408",
    "id": 844888583,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg0NDg4ODU4Mw==",
    "user": {
      "login": "chriseth",
      "id": 9073706,
      "node_id": "MDQ6VXNlcjkwNzM3MDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9073706?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chriseth",
      "html_url": "https://github.com/chriseth",
      "followers_url": "https://api.github.com/users/chriseth/followers",
      "following_url": "https://api.github.com/users/chriseth/following{/other_user}",
      "gists_url": "https://api.github.com/users/chriseth/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chriseth/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chriseth/subscriptions",
      "organizations_url": "https://api.github.com/users/chriseth/orgs",
      "repos_url": "https://api.github.com/users/chriseth/repos",
      "events_url": "https://api.github.com/users/chriseth/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chriseth/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-05-20T09:05:16Z",
    "updated_at": "2021-05-20T09:05:16Z",
    "author_association": "MEMBER",
    "body": "Does this also include \"default --base-path to current directory\"? Otherwise, this would worsen the situation when you use `solc x.sol`.\r\n\r\nCan you also expand the specification to which logic is applied for the file load callback (or just explain how it behaves wrt base path currently)?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/844888583/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/845477748",
    "html_url": "https://github.com/ethereum/solidity/issues/11408#issuecomment-845477748",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/11408",
    "id": 845477748,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg0NTQ3Nzc0OA==",
    "user": {
      "login": "cameel",
      "id": 137030,
      "node_id": "MDQ6VXNlcjEzNzAzMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cameel",
      "html_url": "https://github.com/cameel",
      "followers_url": "https://api.github.com/users/cameel/followers",
      "following_url": "https://api.github.com/users/cameel/following{/other_user}",
      "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
      "organizations_url": "https://api.github.com/users/cameel/orgs",
      "repos_url": "https://api.github.com/users/cameel/repos",
      "events_url": "https://api.github.com/users/cameel/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cameel/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-05-20T21:07:53Z",
    "updated_at": "2021-05-26T11:47:30Z",
    "author_association": "MEMBER",
    "body": "> Does this also include \"default --base-path to current directory\"? Otherwise, this would worsen the situation when you use `solc x.sol`.\r\n\r\nGood point. I did not take that into account. The default for `--base-path` is an empty path and this proposal does not change that so nothing would be stripped from CLI paths by default. `solc x.sol` would unfortunately give you an absolute path in metadata.\r\n\r\nIn that case I think we should treat empty `--base-path` specially. I.e. when it's empty strip current working directory instead.\r\n\r\nA better solution in my opinion would be to change the default since the ability to use an empty path is just a weird loophole. But that would break importing from absolute paths even before #11410 so I'd go with the special case instead.\r\n\r\n> Can you also expand the specification to which logic is applied for the file load callback (or just explain how it behaves wrt base path currently)?\r\n\r\nCurrent behavior is very simple: just take the exact string you got on the CLI and use `boost::filesystem::path::generic_string()` on it. This simply converts backslashes to forward slashes but otherwise leaves the path unchanged.\r\n\r\nSo for example if you give `solc` any of these: `/project/test.sol`, `test.sol`, `./././..////test.sol`, you will end up with that exact string in the metadata. On the other hand if you use `C:\\project\\test.sol` on Windows, you'll get `C:/project/test.sol` in metadata.\r\n\r\nI have updated the spec section to mention the slash conversion.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/845477748/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/874321556",
    "html_url": "https://github.com/ethereum/solidity/issues/11408#issuecomment-874321556",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/11408",
    "id": 874321556,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg3NDMyMTU1Ng==",
    "user": {
      "login": "cameel",
      "id": 137030,
      "node_id": "MDQ6VXNlcjEzNzAzMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cameel",
      "html_url": "https://github.com/cameel",
      "followers_url": "https://api.github.com/users/cameel/followers",
      "following_url": "https://api.github.com/users/cameel/following{/other_user}",
      "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
      "organizations_url": "https://api.github.com/users/cameel/orgs",
      "repos_url": "https://api.github.com/users/cameel/repos",
      "events_url": "https://api.github.com/users/cameel/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cameel/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-07-05T20:45:49Z",
    "updated_at": "2021-07-05T20:45:49Z",
    "author_association": "MEMBER",
    "body": "The `solc` part of this issue is now mostly implemented in #11617 (without CLI tests) and #11545 (with CLI tests).\r\n\r\nThings that were not implemented or were implemented differently than specified here:\r\n- Extra normalization: on Windows drive letter is removed from the path if possible.\r\n- On case-sensitive case-preserving filesystems does **not** use the case from disk.\r\n    - I couldn't find any portable way to get the original case. I know how to detect that it differs using Boost though so I am going to propose issuing a warning for this instead (#11412).\r\n- It was not mentioned in the description but symlinks in base path and in source file paths should **not** be resolved. The PR upholds this with one exception: if the path to the current working directory contains symlinks, a version with resolved symlinks is used when converting a relative path to an absolute one.\r\n- UNC path are a source of a lot of corner cases and they are not portable anyway. I think we should just disallow them.\r\n\r\nOne downside of having this implemented without #11410 is that the normalization may result in absolute paths in cases where the user might not expect them and the user will likely not notice:\r\n- `solc ../contract.sol` will use the absolute path for `contract.sol`.\r\n- If the path to the current working directory contains a symlink, `solc --base-path=\"$PWD/a/b\" a/b/c.sol` might result in an absolute path or not, depending on whether the symlink in `$PWD` is resolved or not.\r\n    - Having a symlink in CWD is not uncommon. On macOS for example `/tmp` and `/var are a symlinks to `/private/tmp/` and `/private/var/`. #10059 suggests that user home directories in some cases might be symlinks too (they are not symlinks in our CI though).",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/874321556/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/907439399",
    "html_url": "https://github.com/ethereum/solidity/issues/11408#issuecomment-907439399",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/11408",
    "id": 907439399,
    "node_id": "IC_kwDOAm_5kc42Fm0n",
    "user": {
      "login": "cameel",
      "id": 137030,
      "node_id": "MDQ6VXNlcjEzNzAzMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cameel",
      "html_url": "https://github.com/cameel",
      "followers_url": "https://api.github.com/users/cameel/followers",
      "following_url": "https://api.github.com/users/cameel/following{/other_user}",
      "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
      "organizations_url": "https://api.github.com/users/cameel/orgs",
      "repos_url": "https://api.github.com/users/cameel/repos",
      "events_url": "https://api.github.com/users/cameel/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cameel/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-08-27T19:50:55Z",
    "updated_at": "2021-08-27T19:50:55Z",
    "author_association": "MEMBER",
    "body": "Implemented by #11545 and https://github.com/ethereum/solc-js/pull/533.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/907439399/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
