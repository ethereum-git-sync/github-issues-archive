{
  "url": "https://api.github.com/repos/ethereum/solidity/issues/13046",
  "repository_url": "https://api.github.com/repos/ethereum/solidity",
  "labels_url": "https://api.github.com/repos/ethereum/solidity/issues/13046/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/solidity/issues/13046/comments",
  "events_url": "https://api.github.com/repos/ethereum/solidity/issues/13046/events",
  "html_url": "https://github.com/ethereum/solidity/issues/13046",
  "id": 1243081161,
  "node_id": "I_kwDOAm_5kc5KF-nJ",
  "number": 13046,
  "title": "[Yul Optimizer] Consider moving statically sized memory allocations to static offsets while adjusting the ``memoryguard``",
  "user": {
    "login": "ekpyron",
    "id": 1347491,
    "node_id": "MDQ6VXNlcjEzNDc0OTE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1347491?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ekpyron",
    "html_url": "https://github.com/ekpyron",
    "followers_url": "https://api.github.com/users/ekpyron/followers",
    "following_url": "https://api.github.com/users/ekpyron/following{/other_user}",
    "gists_url": "https://api.github.com/users/ekpyron/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ekpyron/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ekpyron/subscriptions",
    "organizations_url": "https://api.github.com/users/ekpyron/orgs",
    "repos_url": "https://api.github.com/users/ekpyron/repos",
    "events_url": "https://api.github.com/users/ekpyron/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ekpyron/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1282209978,
      "node_id": "MDU6TGFiZWwxMjgyMjA5OTc4",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/optimizer",
      "name": "optimizer",
      "color": "d4c5f9",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2022-05-20T12:29:33Z",
  "updated_at": "2022-05-20T12:59:23Z",
  "closed_at": null,
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "```\r\n{\r\n  mstore(0x40, memoryguard(0x80))\r\n\r\n  switch shr(224, calldataload(0))\r\n  case 0x... {\r\n     let m := allocate(0x20)\r\n     let n := allocate(0x20)\r\n     ...\r\n  }\r\n  case 0x... {\r\n     let m := allocate(0x40)\r\n     ...\r\n  }\r\n  default {\r\n    revert(0,0)\r\n  }\r\n}\r\n```\r\nCould, in principle, realize that all non-reverting branches need 64 bytes of static memory, shift the memoryguard and transform to:\r\n\r\n```\r\n{\r\n  mstore(0x40, memoryguard(0xC0))\r\n\r\n  switch shr(224, calldataload(0))\r\n  case 0x... {\r\n     let m := 0x80\r\n     let n := 0xA0\r\n     ...\r\n  }\r\n  case 0x... {\r\n     let m := 0x80\r\n     ...\r\n  }\r\n  default {\r\n    revert(0,0)\r\n  }\r\n}\r\n```\r\n\r\nThe logic would ~~basically be the same as~~ be similar to the allocation of memory slots in the stack-to-memory process.\r\n\r\nHowever, there'd be some subtleties involved... e.g. we'd need to decide how to tradeoff between branches requiring more or less static memory (also considering whether we want to ignore reverting branches).\r\nAlso this would mean special handling for ``allocate`` and would benefit from having it as a builtin in an initial dialect or something similar...\r\n\r\nA huge advantage, though, would be that after such a transformation it would be much easier to reason about those allocations, since they'd have well-known static offsets.",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/13046/reactions",
    "total_count": 1,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 1
  },
  "timeline_url": "https://api.github.com/repos/ethereum/solidity/issues/13046/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1132860691",
    "html_url": "https://github.com/ethereum/solidity/issues/13046#issuecomment-1132860691",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13046",
    "id": 1132860691,
    "node_id": "IC_kwDOAm_5kc5DhhUT",
    "user": {
      "login": "ekpyron",
      "id": 1347491,
      "node_id": "MDQ6VXNlcjEzNDc0OTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1347491?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ekpyron",
      "html_url": "https://github.com/ekpyron",
      "followers_url": "https://api.github.com/users/ekpyron/followers",
      "following_url": "https://api.github.com/users/ekpyron/following{/other_user}",
      "gists_url": "https://api.github.com/users/ekpyron/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ekpyron/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ekpyron/subscriptions",
      "organizations_url": "https://api.github.com/users/ekpyron/orgs",
      "repos_url": "https://api.github.com/users/ekpyron/repos",
      "events_url": "https://api.github.com/users/ekpyron/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ekpyron/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-20T12:45:50Z",
    "updated_at": "2022-05-20T12:53:42Z",
    "author_association": "MEMBER",
    "body": "Thinking about it a bit more: this could be *similar* to what the stack limit evader does, but it's not entirely the same:\r\nSince the statically allocated memory chunks could be stored somewhere during loops, we'd basically need to treat loops similar to how the stack-to-memory process treats recursion. I.e. not do this for allocations in loops. Or ensure that the memory is only used locally within the loop.\r\n\r\nAnd also on function calls the logic would have to differ, since multiple calls to the same function in general may need to get distinct memory chunks. So yeah, this would need to rely on arguing that the allocated memory is only used function-locally...\r\n\r\nBut it might still be worthwhile, even if we have to restrict the cases in which this is allowed significantly at first.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1132860691/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1132869857",
    "html_url": "https://github.com/ethereum/solidity/issues/13046#issuecomment-1132869857",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13046",
    "id": 1132869857,
    "node_id": "IC_kwDOAm_5kc5Dhjjh",
    "user": {
      "login": "ekpyron",
      "id": 1347491,
      "node_id": "MDQ6VXNlcjEzNDc0OTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1347491?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ekpyron",
      "html_url": "https://github.com/ekpyron",
      "followers_url": "https://api.github.com/users/ekpyron/followers",
      "following_url": "https://api.github.com/users/ekpyron/following{/other_user}",
      "gists_url": "https://api.github.com/users/ekpyron/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ekpyron/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ekpyron/subscriptions",
      "organizations_url": "https://api.github.com/users/ekpyron/orgs",
      "repos_url": "https://api.github.com/users/ekpyron/repos",
      "events_url": "https://api.github.com/users/ekpyron/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ekpyron/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-20T12:56:05Z",
    "updated_at": "2022-05-20T12:58:40Z",
    "author_association": "MEMBER",
    "body": "So basically the issue will be to determine *which* allocations can safely be turned to static ones... which may lead back to full memory objects... but at least the rest, i.e. assigning distinct static offsets *for* such allocations, could probably be shared with the current stack-to-memory logic...",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1132869857/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1132871551",
    "html_url": "https://github.com/ethereum/solidity/issues/13046#issuecomment-1132871551",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13046",
    "id": 1132871551,
    "node_id": "IC_kwDOAm_5kc5Dhj9_",
    "user": {
      "login": "ekpyron",
      "id": 1347491,
      "node_id": "MDQ6VXNlcjEzNDc0OTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1347491?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ekpyron",
      "html_url": "https://github.com/ekpyron",
      "followers_url": "https://api.github.com/users/ekpyron/followers",
      "following_url": "https://api.github.com/users/ekpyron/following{/other_user}",
      "gists_url": "https://api.github.com/users/ekpyron/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ekpyron/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ekpyron/subscriptions",
      "organizations_url": "https://api.github.com/users/ekpyron/orgs",
      "repos_url": "https://api.github.com/users/ekpyron/repos",
      "events_url": "https://api.github.com/users/ekpyron/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ekpyron/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-20T12:58:01Z",
    "updated_at": "2022-05-20T12:58:01Z",
    "author_association": "MEMBER",
    "body": "Related to https://github.com/ethereum/solidity/issues/5107",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1132871551/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
