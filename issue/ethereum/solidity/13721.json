{
  "url": "https://api.github.com/repos/ethereum/solidity/issues/13721",
  "repository_url": "https://api.github.com/repos/ethereum/solidity",
  "labels_url": "https://api.github.com/repos/ethereum/solidity/issues/13721/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/solidity/issues/13721/comments",
  "events_url": "https://api.github.com/repos/ethereum/solidity/issues/13721/events",
  "html_url": "https://github.com/ethereum/solidity/issues/13721",
  "id": 1453405709,
  "node_id": "I_kwDOAm_5kc5WoTYN",
  "number": 13721,
  "title": "Remove Stack too Deep errors as blockers to via-IR",
  "user": {
    "login": "NunoFilipeSantos",
    "id": 2582498,
    "node_id": "MDQ6VXNlcjI1ODI0OTg=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2582498?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/NunoFilipeSantos",
    "html_url": "https://github.com/NunoFilipeSantos",
    "followers_url": "https://api.github.com/users/NunoFilipeSantos/followers",
    "following_url": "https://api.github.com/users/NunoFilipeSantos/following{/other_user}",
    "gists_url": "https://api.github.com/users/NunoFilipeSantos/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/NunoFilipeSantos/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/NunoFilipeSantos/subscriptions",
    "organizations_url": "https://api.github.com/users/NunoFilipeSantos/orgs",
    "repos_url": "https://api.github.com/users/NunoFilipeSantos/repos",
    "events_url": "https://api.github.com/users/NunoFilipeSantos/events{/privacy}",
    "received_events_url": "https://api.github.com/users/NunoFilipeSantos/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 4806670945,
      "node_id": "LA_kwDOAm_5kc8AAAABHn_6YQ",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/roadmap",
      "name": "roadmap",
      "color": "15B732",
      "default": false,
      "description": ""
    },
    {
      "id": 4828600698,
      "node_id": "LA_kwDOAm_5kc8AAAABH86Zeg",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/viair",
      "name": "viair",
      "color": "5999F7",
      "default": false,
      "description": ""
    },
    {
      "id": 4867045645,
      "node_id": "LA_kwDOAm_5kc8AAAABIhk5DQ",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/epic",
      "name": "epic",
      "color": "BE24FA",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": {
    "login": "r0qs",
    "id": 457348,
    "node_id": "MDQ6VXNlcjQ1NzM0OA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/457348?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/r0qs",
    "html_url": "https://github.com/r0qs",
    "followers_url": "https://api.github.com/users/r0qs/followers",
    "following_url": "https://api.github.com/users/r0qs/following{/other_user}",
    "gists_url": "https://api.github.com/users/r0qs/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/r0qs/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/r0qs/subscriptions",
    "organizations_url": "https://api.github.com/users/r0qs/orgs",
    "repos_url": "https://api.github.com/users/r0qs/repos",
    "events_url": "https://api.github.com/users/r0qs/events{/privacy}",
    "received_events_url": "https://api.github.com/users/r0qs/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "r0qs",
      "id": 457348,
      "node_id": "MDQ6VXNlcjQ1NzM0OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/457348?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/r0qs",
      "html_url": "https://github.com/r0qs",
      "followers_url": "https://api.github.com/users/r0qs/followers",
      "following_url": "https://api.github.com/users/r0qs/following{/other_user}",
      "gists_url": "https://api.github.com/users/r0qs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/r0qs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/r0qs/subscriptions",
      "organizations_url": "https://api.github.com/users/r0qs/orgs",
      "repos_url": "https://api.github.com/users/r0qs/repos",
      "events_url": "https://api.github.com/users/r0qs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/r0qs/received_events",
      "type": "User",
      "site_admin": false
    },
    {
      "login": "ekpyron",
      "id": 1347491,
      "node_id": "MDQ6VXNlcjEzNDc0OTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1347491?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ekpyron",
      "html_url": "https://github.com/ekpyron",
      "followers_url": "https://api.github.com/users/ekpyron/followers",
      "following_url": "https://api.github.com/users/ekpyron/following{/other_user}",
      "gists_url": "https://api.github.com/users/ekpyron/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ekpyron/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ekpyron/subscriptions",
      "organizations_url": "https://api.github.com/users/ekpyron/orgs",
      "repos_url": "https://api.github.com/users/ekpyron/repos",
      "events_url": "https://api.github.com/users/ekpyron/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ekpyron/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2022-11-17T14:03:29Z",
  "updated_at": "2023-07-06T10:55:08Z",
  "closed_at": null,
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "### What\r\n\r\nRemove Stack too Deep errors as blockers to via IR and making them less annoying to users.\r\n\r\n### Why\r\n\r\nCurrently, the via-IR compilation pipeline is not viable as default compilation mode for two reasons:\r\n- Without optimizer hardly any non-trivial project compiles due to stack-too-deep errors.\r\n- Even with optimizer, some more complex projects suffer from stack-too-deep errors.\r\n\r\n### How\r\n\r\nProducing better error messages in remaining error cases. (allowing devs to fix them more easily)\r\n\r\n### Tasks\r\n\r\n~Case 1: EOF has immediate swaps dups: use them.~\r\n\r\nCase 2 (otherwise):\r\n   - Rewrite the optimized evm code transform to act on Yul ASTs instead of CFGs resulting in more precise predictions of the effects of the stack-to-memory mover, resulting in the ability to more precisely move those variables that will avoid stack too deep errors.\r\n\r\nGeneral idea of the approach: The current stack layout generation algorithm attempts to find the best stack layout based on minimum gas cost by performing the shuffling of stack slots. The feeling is that we could improve the performance of the stack layout generation if we are able to determine the minimum stack layout prefix before shuffling, reducing the number of permutations, or even replacing the current shuffling step completely. \r\n\r\n- [x] Create a Dominator tree from the CFG.\r\n- [ ] Generate the stack layout prefix based on the dominator tree and perform the shuffling for the remaining slots if any.\r\n- [ ] Evaluate performance of the approach in term of compilation time and gas usage.\r\n- [ ] Improve stack to memory (we need to minimize stack to memory moves).\r\n- [ ] Ensure all codegen tests pass :)\r\n\r\n### Notes\r\n- Not happening: Case 1: EOF has immediate swaps dups: use them.\r\n- [The IR (aka new codegen via Yul) is something we started to work on around 2017. The work is progressing much better this year and hopefully, it can be released before 2022. We have already found a number of issues how the old codegen worked, and the IR works in these cases differently. This is basically a breaking change.](https://github.com/ethereum/solidity/issues/11690#issuecomment-886114117)\r\n\r\nIt would be foolish releasing 1.0.0 before the IR is released, is stable, and is the default.\r\n\r\n### Out of scope\r\n\r\n- Avoiding stack too deep errors:\r\n  -  under all circumstances: Like in recursive functions.\r\n  - in the presence of memory unsafe assembly \r\n\r\n---\r\n### Resources\r\n\r\n1. Design doc\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/13721/reactions",
    "total_count": 2,
    "+1": 2,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/solidity/issues/13721/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1341283217",
    "html_url": "https://github.com/ethereum/solidity/issues/13721#issuecomment-1341283217",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13721",
    "id": 1341283217,
    "node_id": "IC_kwDOAm_5kc5P8luR",
    "user": {
      "login": "cameel",
      "id": 137030,
      "node_id": "MDQ6VXNlcjEzNzAzMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cameel",
      "html_url": "https://github.com/cameel",
      "followers_url": "https://api.github.com/users/cameel/followers",
      "following_url": "https://api.github.com/users/cameel/following{/other_user}",
      "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
      "organizations_url": "https://api.github.com/users/cameel/orgs",
      "repos_url": "https://api.github.com/users/cameel/repos",
      "events_url": "https://api.github.com/users/cameel/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cameel/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-07T17:02:43Z",
    "updated_at": "2022-12-07T17:02:43Z",
    "author_association": "MEMBER",
    "body": "#12865 likely should also be considered a part of this. It does not cause \"stack too deep\" on its own but unnecessary unlinked references have similar impact on tools in terms of blocking via IR adoption.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1341283217/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1341308129",
    "html_url": "https://github.com/ethereum/solidity/issues/13721#issuecomment-1341308129",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13721",
    "id": 1341308129,
    "node_id": "IC_kwDOAm_5kc5P8rzh",
    "user": {
      "login": "ekpyron",
      "id": 1347491,
      "node_id": "MDQ6VXNlcjEzNDc0OTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1347491?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ekpyron",
      "html_url": "https://github.com/ekpyron",
      "followers_url": "https://api.github.com/users/ekpyron/followers",
      "following_url": "https://api.github.com/users/ekpyron/following{/other_user}",
      "gists_url": "https://api.github.com/users/ekpyron/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ekpyron/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ekpyron/subscriptions",
      "organizations_url": "https://api.github.com/users/ekpyron/orgs",
      "repos_url": "https://api.github.com/users/ekpyron/repos",
      "events_url": "https://api.github.com/users/ekpyron/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ekpyron/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-07T17:20:25Z",
    "updated_at": "2022-12-07T17:21:03Z",
    "author_association": "MEMBER",
    "body": "> #12865 likely should also be considered a part of this. It does not cause \"stack too deep\" on its own but unnecessary unlinked references have similar impact on tools in terms of blocking via IR adoption.\r\n\r\n1. We shouldn't cross-scope these things, so I categorically wouldn't consider this as a part here.\r\n2. We likely won't solve this issue here without optimizer anyways, and with optimizer the other one is a non-issue. So the main thing to consider here would be a minimal optimization sequence by default for via-IR, which we'll probably do, but yeah, this is off-topic here.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1341308129/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1341387640",
    "html_url": "https://github.com/ethereum/solidity/issues/13721#issuecomment-1341387640",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13721",
    "id": 1341387640,
    "node_id": "IC_kwDOAm_5kc5P8_N4",
    "user": {
      "login": "NunoFilipeSantos",
      "id": 2582498,
      "node_id": "MDQ6VXNlcjI1ODI0OTg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2582498?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/NunoFilipeSantos",
      "html_url": "https://github.com/NunoFilipeSantos",
      "followers_url": "https://api.github.com/users/NunoFilipeSantos/followers",
      "following_url": "https://api.github.com/users/NunoFilipeSantos/following{/other_user}",
      "gists_url": "https://api.github.com/users/NunoFilipeSantos/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/NunoFilipeSantos/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/NunoFilipeSantos/subscriptions",
      "organizations_url": "https://api.github.com/users/NunoFilipeSantos/orgs",
      "repos_url": "https://api.github.com/users/NunoFilipeSantos/repos",
      "events_url": "https://api.github.com/users/NunoFilipeSantos/events{/privacy}",
      "received_events_url": "https://api.github.com/users/NunoFilipeSantos/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-07T18:23:12Z",
    "updated_at": "2022-12-07T18:23:12Z",
    "author_association": "MEMBER",
    "body": "> > #12865 likely should also be considered a part of this. It does not cause \"stack too deep\" on its own but unnecessary unlinked references have similar impact on tools in terms of blocking via IR adoption.\r\n> \r\n> 1. We shouldn't cross-scope these things, so I categorically wouldn't consider this as a part here.\r\n> 2. We likely won't solve this issue here without optimizer anyways, and with optimizer the other one is a non-issue. So the main thing to consider here would be a minimal optimization sequence by default for via-IR, which we'll probably do, but yeah, this is off-topic here.\r\n\r\n1. Absolutely. If it's tangent, it shouldn't belong here.\r\n2. I'm in favor of heavily scoping down initially and seeing where we land in Q1, rather than expanding immensely and missing such a large goalposts (a full quarter).\r\n\r\nRemember that we don't plan for 100% of our time, meaning all the other day to day \"sidequests\" also take time.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1341387640/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
