{
  "url": "https://api.github.com/repos/ethereum/solidity/issues/11375",
  "repository_url": "https://api.github.com/repos/ethereum/solidity",
  "labels_url": "https://api.github.com/repos/ethereum/solidity/issues/11375/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/solidity/issues/11375/comments",
  "events_url": "https://api.github.com/repos/ethereum/solidity/issues/11375/events",
  "html_url": "https://github.com/ethereum/solidity/issues/11375",
  "id": 885001174,
  "node_id": "MDU6SXNzdWU4ODUwMDExNzQ=",
  "number": 11375,
  "title": "solc 0.7.1 - inconsistent bytecode created for identical contract input using standard-json compiler input",
  "user": {
    "login": "nventuro",
    "id": 2530770,
    "node_id": "MDQ6VXNlcjI1MzA3NzA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2530770?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/nventuro",
    "html_url": "https://github.com/nventuro",
    "followers_url": "https://api.github.com/users/nventuro/followers",
    "following_url": "https://api.github.com/users/nventuro/following{/other_user}",
    "gists_url": "https://api.github.com/users/nventuro/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/nventuro/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/nventuro/subscriptions",
    "organizations_url": "https://api.github.com/users/nventuro/orgs",
    "repos_url": "https://api.github.com/users/nventuro/repos",
    "events_url": "https://api.github.com/users/nventuro/events{/privacy}",
    "received_events_url": "https://api.github.com/users/nventuro/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 249074435,
      "node_id": "MDU6TGFiZWwyNDkwNzQ0MzU=",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/bug%20:bug:",
      "name": "bug :bug:",
      "color": "fc1313",
      "default": false,
      "description": ""
    },
    {
      "id": 455256446,
      "node_id": "MDU6TGFiZWw0NTUyNTY0NDY=",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/waiting%20for%20more%20input",
      "name": "waiting for more input",
      "color": "fef2c0",
      "default": false,
      "description": "Issues waiting for more input by the reporter"
    },
    {
      "id": 2376132438,
      "node_id": "MDU6TGFiZWwyMzc2MTMyNDM4",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/codegen%20error",
      "name": "codegen error",
      "color": "000000",
      "default": false,
      "description": "Compiler generates invalid code. Critical."
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "cameel",
    "id": 137030,
    "node_id": "MDQ6VXNlcjEzNzAzMA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/cameel",
    "html_url": "https://github.com/cameel",
    "followers_url": "https://api.github.com/users/cameel/followers",
    "following_url": "https://api.github.com/users/cameel/following{/other_user}",
    "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
    "organizations_url": "https://api.github.com/users/cameel/orgs",
    "repos_url": "https://api.github.com/users/cameel/repos",
    "events_url": "https://api.github.com/users/cameel/events{/privacy}",
    "received_events_url": "https://api.github.com/users/cameel/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "cameel",
      "id": 137030,
      "node_id": "MDQ6VXNlcjEzNzAzMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cameel",
      "html_url": "https://github.com/cameel",
      "followers_url": "https://api.github.com/users/cameel/followers",
      "following_url": "https://api.github.com/users/cameel/following{/other_user}",
      "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
      "organizations_url": "https://api.github.com/users/cameel/orgs",
      "repos_url": "https://api.github.com/users/cameel/repos",
      "events_url": "https://api.github.com/users/cameel/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cameel/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2021-05-10T20:04:36Z",
  "updated_at": "2021-12-16T21:25:47Z",
  "closed_at": "2021-12-16T21:25:47Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "This is essentially the same as https://github.com/ethereum/solidity/issues/9573 - I'm opening a new issue as that one is closed, and the underlying problem already identified. This issue is about this behavior persisting in solc 0.7.1 (as per @chriseth's request [here](https://github.com/ethereum/solidity/issues/9573#issuecomment-680212040)).\r\n\r\nI was planning on distributing contract source code for third party developers to compile locally when building integrations with our system, potentially adding logs, etc. to help debug. However, despite the compilation settings being the exact same (other than the files having different names due to the package name prefix), I observed the compilation output was different. \r\n\r\nCritically, as the original source code results in bytecode extremely close to the 24kB limit, this issue causes the compilation output to exceed this limit, making the end result non-deployable (at least not without overriding the code size limit). Typically, slight differences in bytecode, while undesirable, would be mostly not harmful, but this interaction with the 24kB limit causes severe problems.\r\n\r\nAttached I included the compilation input, from the Hardhat-based compilation process. `original` is the original compilation, and `library` the one where the original artifacts are imported as a library.\r\n\r\n[original.txt](https://github.com/ethereum/solidity/files/6454709/original.txt)\r\n[library.txt](https://github.com/ethereum/solidity/files/6454717/library.txt)\r\n",
  "closed_by": {
    "login": "cameel",
    "id": 137030,
    "node_id": "MDQ6VXNlcjEzNzAzMA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/cameel",
    "html_url": "https://github.com/cameel",
    "followers_url": "https://api.github.com/users/cameel/followers",
    "following_url": "https://api.github.com/users/cameel/following{/other_user}",
    "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
    "organizations_url": "https://api.github.com/users/cameel/orgs",
    "repos_url": "https://api.github.com/users/cameel/repos",
    "events_url": "https://api.github.com/users/cameel/events{/privacy}",
    "received_events_url": "https://api.github.com/users/cameel/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/11375/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/solidity/issues/11375/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/867777856",
    "html_url": "https://github.com/ethereum/solidity/issues/11375#issuecomment-867777856",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/11375",
    "id": 867777856,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg2Nzc3Nzg1Ng==",
    "user": {
      "login": "cameel",
      "id": 137030,
      "node_id": "MDQ6VXNlcjEzNzAzMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cameel",
      "html_url": "https://github.com/cameel",
      "followers_url": "https://api.github.com/users/cameel/followers",
      "following_url": "https://api.github.com/users/cameel/following{/other_user}",
      "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
      "organizations_url": "https://api.github.com/users/cameel/orgs",
      "repos_url": "https://api.github.com/users/cameel/repos",
      "events_url": "https://api.github.com/users/cameel/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cameel/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-06-24T16:25:15Z",
    "updated_at": "2021-06-24T16:25:15Z",
    "author_association": "MEMBER",
    "body": "@nventuro I tried to reproduce this and the only differences I found are due to paths in metadata. Note that one of the contracts is using `new` to deploy an instance of another contract and this means it has the bytecode of that other contract (including metadata) embedded in its own code. Due to this bytecode differs not only at the very end but also somewhere in the middle where the embedded code ends.\r\n\r\nIs that the difference you were seeing? I could not reproduce the different behavior regarding the code size limit warning (neither `original.txt` nor `library.txt` produces it on 0.7.1) so maybe I'm not seeing the same exact output you did.\r\n\r\nI checked only the `Vault` contract so it's also possible that I missed some differences in one of the other contracts.\r\n\r\n### Details\r\n#### Code size limit warning\r\n```bash\r\ncurl -OL https://github.com/ethereum/solidity/files/6454709/original.txt\r\ncurl -OL https://github.com/ethereum/solidity/files/6454717/library.txt\r\ncurl -OL https://binaries.soliditylang.org/linux-amd64/solc-linux-amd64-v0.7.1+commit.f4a555be\r\nchmod +x solc-linux-amd64-v0.7.1+commit.f4a555be\r\n\r\ncat original.txt | jq .input | ./solc-linux-amd64-v0.7.1+commit.f4a555be --standard-json | jq .errors\r\ncat library.txt | jq .input | ./solc-linux-amd64-v0.7.1+commit.f4a555be --standard-json | jq .errors\r\n```\r\n\r\nThe output I see is `null null`, which means that there are no errors or warnings. I tried it also on versions 0.7.2..0.7.6 and I do get the code size limit warning there but consistently for both inputs.\r\n\r\n#### Bytecode differences\r\nI compared the bytecode of the `Vault` contract between the two inputs:\r\n```bash\r\ncat original.txt |\r\n    jq .input |\r\n    ./solc-linux-amd64-v0.7.1+commit.f4a555be --standard-json |\r\n    jq '.contracts.\"contracts/vault/Vault.sol\".Vault.evm.bytecode.object' |\r\n    fold --width 80 > original-bytecode.json\r\n\r\ncat library.txt |\r\n    jq .input |\r\n    ./solc-linux-amd64-v0.7.1+commit.f4a555be --standard-json |\r\n    jq '.contracts.\"@balancer-labs/v2-core/contracts/vault/Vault.sol\".Vault.evm.bytecode.object' |\r\n    fold --width 80 > library-bytecode.json\r\n\r\ndiff --unified original-bytecode.json library-bytecode.json\r\n```\r\nI see two differences. One at the very end (clearly metadata) and one somewhere in the middle:\r\n```diff\r\n--- original-bytecode.json\r\n+++ library-bytecode.json\r\n@@ -630,7 +630,7 @@\r\n 081fd5b5060209081020190565b60005b83811015615f3f578181015183820152602001615f27565\r\n b83811115610e005750506000910152565b6003811061057e57fe5b6001600160a01b03811681146\r\n 1057e57600080fd5b801515811461057e57600080fd5b6003811061057e57600080fdfea26469706\r\n-673582212207407ed1b393a303bec41b2d2138ea9f191487da85ca87bb09c513e6bc8ef1bd464736\r\n+673582212205971f848ef1b21130755f833287121c5cff4f95bcc1a236b5f325019c39569a364736\r\n f6c6343000701003360c060405234801561001057600080fd5b50604051610be6380380610be6833\r\n 98101604081905261002f9161004d565b30608052600160005560601b6001600160601b03191660a\r\n 05261007b565b60006020828403121561005e578081fd5b81516001600160a01b038116811461007\r\n@@ -706,5 +706,5 @@\r\n 191600101610a7e565b50909695505050505050565b90815260200190565b9283526001600160a01\r\n b03918216602084015216604082015260600190565b60405181810167ffffffffffffffff8111828\r\n 2101715610aed57600080fd5b604052919050565b6001600160a01b038116811461047b57600080f\r\n-dfea2646970667358221220734348845c9fbcedea6792572efc730c04dbd48b23477ce93eb33a529\r\n-03f7e7c64736f6c63430007010033\"\r\n+dfea2646970667358221220a4e1090a31d2b72650b91f04b91c556c9f7e6cb316b675531d76124e2\r\n+83384aa64736f6c63430007010033\"\r\n```\r\n\r\nTo show that this is due to the metadata too we can set `settings.metadata.bytecodeHash` to `\"none\"` in the input and rerun:\r\n```bash\r\ncat original.txt | jq '.input * {settings: {metadata: {bytecodeHash: \"none\"}}}' > original-metadata-none.json\r\ncat library.txt | jq '.input * {settings: {metadata: {bytecodeHash: \"none\"}}}' > library-metadata-none.json\r\n\r\ncat original-metadata-none.json |\r\n    ./solc-linux-amd64-v0.7.1+commit.f4a555be --standard-json |\r\n    jq '.contracts.\"contracts/vault/Vault.sol\".Vault.evm.bytecode.object' |\r\n    fold --width 80 > original-metadata-none-bytecode.json\r\n\r\ncat library-metadata-none.json |\r\n    ./solc-linux-amd64-v0.7.1+commit.f4a555be --standard-json |\r\n    jq '.contracts.\"@balancer-labs/v2-core/contracts/vault/Vault.sol\".Vault.evm.bytecode.object' |\r\n    fold --width 80 > library-metadata-none-bytecode.json\r\n\r\ndiff --unified original-metadata-none-bytecode.json library-metadata-none-bytecode.json\r\n```\r\nHere for me the output is empty, meaning that there are no differences.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/867777856/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/867963458",
    "html_url": "https://github.com/ethereum/solidity/issues/11375#issuecomment-867963458",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/11375",
    "id": 867963458,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg2Nzk2MzQ1OA==",
    "user": {
      "login": "nventuro",
      "id": 2530770,
      "node_id": "MDQ6VXNlcjI1MzA3NzA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2530770?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nventuro",
      "html_url": "https://github.com/nventuro",
      "followers_url": "https://api.github.com/users/nventuro/followers",
      "following_url": "https://api.github.com/users/nventuro/following{/other_user}",
      "gists_url": "https://api.github.com/users/nventuro/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nventuro/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nventuro/subscriptions",
      "organizations_url": "https://api.github.com/users/nventuro/orgs",
      "repos_url": "https://api.github.com/users/nventuro/repos",
      "events_url": "https://api.github.com/users/nventuro/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nventuro/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-06-24T21:28:09Z",
    "updated_at": "2021-06-24T21:28:09Z",
    "author_association": "CONTRIBUTOR",
    "body": "Hey @cameel, thanks for the detailed analysis. Your comments about the metadata fields seem spot-on.\r\n\r\nUnfortunately I built these two examples quite a while ago, and don't really recall exactly the steps I had taken to arrive at those two files :/ I'll try to revert to that state to reproduce this locally and share more details, but it is possible I might fail.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/867963458/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/996205837",
    "html_url": "https://github.com/ethereum/solidity/issues/11375#issuecomment-996205837",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/11375",
    "id": 996205837,
    "node_id": "IC_kwDOAm_5kc47YOUN",
    "user": {
      "login": "cameel",
      "id": 137030,
      "node_id": "MDQ6VXNlcjEzNzAzMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cameel",
      "html_url": "https://github.com/cameel",
      "followers_url": "https://api.github.com/users/cameel/followers",
      "following_url": "https://api.github.com/users/cameel/following{/other_user}",
      "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
      "organizations_url": "https://api.github.com/users/cameel/orgs",
      "repos_url": "https://api.github.com/users/cameel/repos",
      "events_url": "https://api.github.com/users/cameel/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cameel/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-12-16T21:25:46Z",
    "updated_at": "2021-12-16T21:25:46Z",
    "author_association": "MEMBER",
    "body": "We have recently discovered a case where the bytecode is not reproducible with the same options unless you pass the same exact set of files to the compiler, even if the extra files are not actually used by your contract (see #12281 and #12415). Theoretically it could be what you saw but I only saw it happening on 0.6.12 and 0.7.0. I tested a few other versions, including 0.7.1 and they do not have this problem so I doubt it's this but I cannot exclude the possibility that you actually hit some other corner case that is reproducible on 0.7.1 after all.\r\n\r\nI don't think we can do anything about this unless we get the input to inspect. I'm going to close this but feel free to reopen if you manage to reproduce it again.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/996205837/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
