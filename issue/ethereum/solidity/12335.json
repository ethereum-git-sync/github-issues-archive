{
  "url": "https://api.github.com/repos/ethereum/solidity/issues/12335",
  "repository_url": "https://api.github.com/repos/ethereum/solidity",
  "labels_url": "https://api.github.com/repos/ethereum/solidity/issues/12335/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/solidity/issues/12335/comments",
  "events_url": "https://api.github.com/repos/ethereum/solidity/issues/12335/events",
  "html_url": "https://github.com/ethereum/solidity/issues/12335",
  "id": 1064602433,
  "node_id": "I_kwDOAm_5kc4_dItB",
  "number": 12335,
  "title": "Deallocation of memory for simple cases (e.g. keccak + abi.encode)",
  "user": {
    "login": "frangio",
    "id": 481465,
    "node_id": "MDQ6VXNlcjQ4MTQ2NQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/481465?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/frangio",
    "html_url": "https://github.com/frangio",
    "followers_url": "https://api.github.com/users/frangio/followers",
    "following_url": "https://api.github.com/users/frangio/following{/other_user}",
    "gists_url": "https://api.github.com/users/frangio/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/frangio/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/frangio/subscriptions",
    "organizations_url": "https://api.github.com/users/frangio/orgs",
    "repos_url": "https://api.github.com/users/frangio/repos",
    "events_url": "https://api.github.com/users/frangio/events{/privacy}",
    "received_events_url": "https://api.github.com/users/frangio/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1282209978,
      "node_id": "MDU6TGFiZWwxMjgyMjA5OTc4",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/optimizer",
      "name": "optimizer",
      "color": "d4c5f9",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 6,
  "created_at": "2021-11-26T15:24:25Z",
  "updated_at": "2022-08-17T13:48:47Z",
  "closed_at": null,
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "It's very easy to write code that makes wasteful use of memory so I think it's an important place to look for simple and common patterns amenable to optimization.\r\n\r\nOne such pattern is `keccak256(abi.encode(...))`. The result of encoding is put in memory and never deallocated, even though it's immediately used and there is no reference to it.\r\n\r\nI'm not familiar with the optimization pipeline (for either codegen system) so I don't know what's an appropriate implementation strategy. I see this particular pattern very often, essentialy any use of `keccak256` goes together with `abi.encode` or `abi.encodePacked`, so it's worth detecting it and making sure that the free memory pointer is either restored to its previous position before the `keccak256` function call, or never bumped to begin with.",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/12335/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/solidity/issues/12335/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/980105506",
    "html_url": "https://github.com/ethereum/solidity/issues/12335#issuecomment-980105506",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/12335",
    "id": 980105506,
    "node_id": "IC_kwDOAm_5kc46azki",
    "user": {
      "login": "cameel",
      "id": 137030,
      "node_id": "MDQ6VXNlcjEzNzAzMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cameel",
      "html_url": "https://github.com/cameel",
      "followers_url": "https://api.github.com/users/cameel/followers",
      "following_url": "https://api.github.com/users/cameel/following{/other_user}",
      "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
      "organizations_url": "https://api.github.com/users/cameel/orgs",
      "repos_url": "https://api.github.com/users/cameel/repos",
      "events_url": "https://api.github.com/users/cameel/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cameel/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-11-26T16:27:59Z",
    "updated_at": "2021-11-26T16:27:59Z",
    "author_association": "MEMBER",
    "body": "Thanks for a more detailed description. So it's a different optimization than the one I've been thinking of when I wrote https://github.com/ethereum/solidity/issues/12306#issuecomment-980043720. The PRs/issues I listed there are all about removing `mstore`s that can be proven to be redundant. Your case here is about memory allocation and reuse instead.\r\n\r\nTurns out we do have an issue about that (#5107) and there's already been some progress there. I have not been closely tracking its overall status so @chriseth could give a much better update but we already do have sthe allocation/deallocation functions mentioned there. I remember at least reviewing a PR that made the Yul codegen consistently use them internally.\r\n\r\nAlso, this optimization will only be available via the Yul optimizer.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/980105506/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/981805974",
    "html_url": "https://github.com/ethereum/solidity/issues/12335#issuecomment-981805974",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/12335",
    "id": 981805974,
    "node_id": "IC_kwDOAm_5kc46hSuW",
    "user": {
      "login": "chriseth",
      "id": 9073706,
      "node_id": "MDQ6VXNlcjkwNzM3MDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9073706?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chriseth",
      "html_url": "https://github.com/chriseth",
      "followers_url": "https://api.github.com/users/chriseth/followers",
      "following_url": "https://api.github.com/users/chriseth/following{/other_user}",
      "gists_url": "https://api.github.com/users/chriseth/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chriseth/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chriseth/subscriptions",
      "organizations_url": "https://api.github.com/users/chriseth/orgs",
      "repos_url": "https://api.github.com/users/chriseth/repos",
      "events_url": "https://api.github.com/users/chriseth/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chriseth/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-11-29T16:35:06Z",
    "updated_at": "2021-11-29T16:35:06Z",
    "author_association": "MEMBER",
    "body": "The attempts to do this on the yul level were not very fruitful so far, but I think we could improve that on the Solidity level, in that we do reference and lifetime tracking on memory objects.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/981805974/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/982071830",
    "html_url": "https://github.com/ethereum/solidity/issues/12335#issuecomment-982071830",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/12335",
    "id": 982071830,
    "node_id": "IC_kwDOAm_5kc46iToW",
    "user": {
      "login": "frangio",
      "id": 481465,
      "node_id": "MDQ6VXNlcjQ4MTQ2NQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/481465?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/frangio",
      "html_url": "https://github.com/frangio",
      "followers_url": "https://api.github.com/users/frangio/followers",
      "following_url": "https://api.github.com/users/frangio/following{/other_user}",
      "gists_url": "https://api.github.com/users/frangio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/frangio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/frangio/subscriptions",
      "organizations_url": "https://api.github.com/users/frangio/orgs",
      "repos_url": "https://api.github.com/users/frangio/repos",
      "events_url": "https://api.github.com/users/frangio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/frangio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-11-29T22:13:01Z",
    "updated_at": "2021-11-29T22:13:01Z",
    "author_association": "CONTRIBUTOR",
    "body": "If it can't be implemented in a generalized way, is it possible to do it specifically for expressions of the form `keccak256(abi.encode[Packed](...))`?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/982071830/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/991378614",
    "html_url": "https://github.com/ethereum/solidity/issues/12335#issuecomment-991378614",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/12335",
    "id": 991378614,
    "node_id": "IC_kwDOAm_5kc47Fzy2",
    "user": {
      "login": "cameel",
      "id": 137030,
      "node_id": "MDQ6VXNlcjEzNzAzMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cameel",
      "html_url": "https://github.com/cameel",
      "followers_url": "https://api.github.com/users/cameel/followers",
      "following_url": "https://api.github.com/users/cameel/following{/other_user}",
      "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
      "organizations_url": "https://api.github.com/users/cameel/orgs",
      "repos_url": "https://api.github.com/users/cameel/repos",
      "events_url": "https://api.github.com/users/cameel/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cameel/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-12-10T23:49:16Z",
    "updated_at": "2021-12-11T01:25:10Z",
    "author_association": "MEMBER",
    "body": "Some older issues about the same optimization: #4182, #9046.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/991378614/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/991379389",
    "html_url": "https://github.com/ethereum/solidity/issues/12335#issuecomment-991379389",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/12335",
    "id": 991379389,
    "node_id": "IC_kwDOAm_5kc47Fz-9",
    "user": {
      "login": "cameel",
      "id": 137030,
      "node_id": "MDQ6VXNlcjEzNzAzMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cameel",
      "html_url": "https://github.com/cameel",
      "followers_url": "https://api.github.com/users/cameel/followers",
      "following_url": "https://api.github.com/users/cameel/following{/other_user}",
      "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
      "organizations_url": "https://api.github.com/users/cameel/orgs",
      "repos_url": "https://api.github.com/users/cameel/repos",
      "events_url": "https://api.github.com/users/cameel/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cameel/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-12-10T23:51:40Z",
    "updated_at": "2021-12-10T23:51:40Z",
    "author_association": "MEMBER",
    "body": "@frangio It can be implemented in a generalized way, just not necessarily in the optimizer. We discussed this recently and the current idea is to try something like this: #12351.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/991379389/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/991803811",
    "html_url": "https://github.com/ethereum/solidity/issues/12335#issuecomment-991803811",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/12335",
    "id": 991803811,
    "node_id": "IC_kwDOAm_5kc47Hbmj",
    "user": {
      "login": "frangio",
      "id": 481465,
      "node_id": "MDQ6VXNlcjQ4MTQ2NQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/481465?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/frangio",
      "html_url": "https://github.com/frangio",
      "followers_url": "https://api.github.com/users/frangio/followers",
      "following_url": "https://api.github.com/users/frangio/following{/other_user}",
      "gists_url": "https://api.github.com/users/frangio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/frangio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/frangio/subscriptions",
      "organizations_url": "https://api.github.com/users/frangio/orgs",
      "repos_url": "https://api.github.com/users/frangio/repos",
      "events_url": "https://api.github.com/users/frangio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/frangio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-12-11T23:26:25Z",
    "updated_at": "2021-12-11T23:26:25Z",
    "author_association": "CONTRIBUTOR",
    "body": "That approach sounds great, thanks for thinking about it and following up!",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/991803811/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
