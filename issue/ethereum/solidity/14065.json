{
  "url": "https://api.github.com/repos/ethereum/solidity/issues/14065",
  "repository_url": "https://api.github.com/repos/ethereum/solidity",
  "labels_url": "https://api.github.com/repos/ethereum/solidity/issues/14065/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/solidity/issues/14065/comments",
  "events_url": "https://api.github.com/repos/ethereum/solidity/issues/14065/events",
  "html_url": "https://github.com/ethereum/solidity/issues/14065",
  "id": 1636071639,
  "node_id": "I_kwDOAm_5kc5hhHjX",
  "number": 14065,
  "title": "Expensive struct hashing.",
  "user": {
    "login": "drortirosh",
    "id": 40341007,
    "node_id": "MDQ6VXNlcjQwMzQxMDA3",
    "avatar_url": "https://avatars.githubusercontent.com/u/40341007?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/drortirosh",
    "html_url": "https://github.com/drortirosh",
    "followers_url": "https://api.github.com/users/drortirosh/followers",
    "following_url": "https://api.github.com/users/drortirosh/following{/other_user}",
    "gists_url": "https://api.github.com/users/drortirosh/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/drortirosh/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/drortirosh/subscriptions",
    "organizations_url": "https://api.github.com/users/drortirosh/orgs",
    "repos_url": "https://api.github.com/users/drortirosh/repos",
    "events_url": "https://api.github.com/users/drortirosh/events{/privacy}",
    "received_events_url": "https://api.github.com/users/drortirosh/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 4699440809,
      "node_id": "LA_kwDOAm_5kc8AAAABGBvGqQ",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/closed%20due%20inactivity",
      "name": "closed due inactivity",
      "color": "91535E",
      "default": false,
      "description": "The issue/PR was automatically closed due to inactivity."
    },
    {
      "id": 4699444681,
      "node_id": "LA_kwDOAm_5kc8AAAABGBvVyQ",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/stale",
      "name": "stale",
      "color": "BF4801",
      "default": false,
      "description": "The issue/PR was marked as stale because it has been open for too long."
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2023-03-22T15:59:20Z",
  "updated_at": "2023-06-28T12:05:11Z",
  "closed_at": "2023-06-28T12:05:11Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "I need to create a unique hash for a Struct.\r\nUsing `keccak256(abi.encode())` on all 10 fields costs **1210** gas\r\nAs a comparison, hashing directly `msg.data` (which contains all fields data but also includes lengths, abi offsets and methodsig) costs **143** gas\r\n\r\nI understand the compiler has some overheads (like validating the address range, and multiple keccak calls), but I don't think it warrants 8 times the gas price.\r\n\r\nRemix example (the given struct to encode is taken from [erc4337](https://github.com/eth-infinitism/account-abstraction/blob/develop/contracts/interfaces/UserOperation.sol#L20)\r\n```solidity\r\npragma solidity ^0.8.17;\r\n\r\n// SPDX-License-Identifier: GPL-3.0\r\nimport 'hardhat/console.sol';\r\n\r\ncontract Test {\r\n\r\n    struct UserOperation {\r\n        address sender;\r\n        uint256 nonce;\r\n        bytes initCode;\r\n        bytes callData;\r\n        uint256 callGasLimit;\r\n        uint256 verificationGasLimit;\r\n        uint256 preVerificationGas;\r\n        uint256 maxFeePerGas;\r\n        uint256 maxPriorityFeePerGas;\r\n        bytes paymasterAndData;\r\n        bytes signature;\r\n    }\r\n\r\n    function testhash(UserOperation calldata u) external view {\r\n\r\n        uint g = gasleft();\r\n        calldata_keccak256(msg.data);\r\n        uint g1 = gasleft();\r\n        internalHash(u);\r\n        uint g2 = gasleft();\r\n\r\n        console.log(\"keccak msg.data\", g-g1); // 143\r\n        console.log(\"keccak fields\", g1-g2); // 1210\r\n    }\r\n\r\n    function internalHash(UserOperation calldata u) internal pure returns (bytes32) {\r\n        address sender = u.sender;\r\n        uint nonce = u.nonce;\r\n        uint callGasLimit = u.callGasLimit;\r\n        uint verificationGasLimit = u.verificationGasLimit;\r\n        uint preVerificationGas = u.preVerificationGas;\r\n        uint maxFeePerGas = u.maxFeePerGas;\r\n        uint maxPriorityFeePerGas = u.maxPriorityFeePerGas;\r\n\r\n        return keccak256(abi.encode(\r\n            sender, nonce, \r\n            calldata_keccak256(u.initCode),\r\n            calldata_keccak256(u.callData),\r\n            callGasLimit, verificationGasLimit, preVerificationGas,\r\n            maxFeePerGas, maxPriorityFeePerGas,\r\n            calldata_keccak256(u.paymasterAndData) \r\n        ));\r\n    }\r\n\r\n    function run() public view {\r\n        UserOperation memory userOp = UserOperation(\r\n            address(this),\r\n            1,\r\n            \"initcode (if constructing a new account)\",\r\n            \"calldata (methodsig and params)\",\r\n            4, 5, 6, 7, 8,\r\n            \"paymaster and data info\",\r\n            \"\"\r\n        );\r\n        this.testhash(userOp);\r\n    }\r\n    \r\n    function calldata_keccak256(bytes calldata data) private pure returns (bytes32 ret) {\r\n        assembly {\r\n            let mem := mload(0x40)\r\n            let len := data.length\r\n            calldatacopy(mem, data.offset, len)\r\n            ret := keccak256(mem, len)\r\n        }\r\n    }\r\n\r\n}\r\n\r\ncontract Arun {\r\n    constructor() {\r\n        new Test().run();\r\n    }\r\n}\r\n```\r\n\r\nPartly-related issues:\r\n- #14056 \r\n-  #12104",
  "closed_by": {
    "login": "github-actions[bot]",
    "id": 41898282,
    "node_id": "MDM6Qm90NDE4OTgyODI=",
    "avatar_url": "https://avatars.githubusercontent.com/in/15368?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/github-actions%5Bbot%5D",
    "html_url": "https://github.com/apps/github-actions",
    "followers_url": "https://api.github.com/users/github-actions%5Bbot%5D/followers",
    "following_url": "https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}",
    "gists_url": "https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/github-actions%5Bbot%5D/subscriptions",
    "organizations_url": "https://api.github.com/users/github-actions%5Bbot%5D/orgs",
    "repos_url": "https://api.github.com/users/github-actions%5Bbot%5D/repos",
    "events_url": "https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}",
    "received_events_url": "https://api.github.com/users/github-actions%5Bbot%5D/received_events",
    "type": "Bot",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/14065/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/solidity/issues/14065/timeline",
  "performed_via_github_app": null,
  "state_reason": "not_planned"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1600711365",
    "html_url": "https://github.com/ethereum/solidity/issues/14065#issuecomment-1600711365",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/14065",
    "id": 1600711365,
    "node_id": "IC_kwDOAm_5kc5faOrF",
    "user": {
      "login": "github-actions[bot]",
      "id": 41898282,
      "node_id": "MDM6Qm90NDE4OTgyODI=",
      "avatar_url": "https://avatars.githubusercontent.com/in/15368?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/github-actions%5Bbot%5D",
      "html_url": "https://github.com/apps/github-actions",
      "followers_url": "https://api.github.com/users/github-actions%5Bbot%5D/followers",
      "following_url": "https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}",
      "gists_url": "https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/github-actions%5Bbot%5D/subscriptions",
      "organizations_url": "https://api.github.com/users/github-actions%5Bbot%5D/orgs",
      "repos_url": "https://api.github.com/users/github-actions%5Bbot%5D/repos",
      "events_url": "https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}",
      "received_events_url": "https://api.github.com/users/github-actions%5Bbot%5D/received_events",
      "type": "Bot",
      "site_admin": false
    },
    "created_at": "2023-06-21T12:04:43Z",
    "updated_at": "2023-06-21T12:04:43Z",
    "author_association": "NONE",
    "body": "This issue has been marked as stale due to inactivity for the last 90 days.\nIt will be automatically closed in 7 days.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1600711365/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1611280735",
    "html_url": "https://github.com/ethereum/solidity/issues/14065#issuecomment-1611280735",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/14065",
    "id": 1611280735,
    "node_id": "IC_kwDOAm_5kc5gCjFf",
    "user": {
      "login": "github-actions[bot]",
      "id": 41898282,
      "node_id": "MDM6Qm90NDE4OTgyODI=",
      "avatar_url": "https://avatars.githubusercontent.com/in/15368?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/github-actions%5Bbot%5D",
      "html_url": "https://github.com/apps/github-actions",
      "followers_url": "https://api.github.com/users/github-actions%5Bbot%5D/followers",
      "following_url": "https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}",
      "gists_url": "https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/github-actions%5Bbot%5D/subscriptions",
      "organizations_url": "https://api.github.com/users/github-actions%5Bbot%5D/orgs",
      "repos_url": "https://api.github.com/users/github-actions%5Bbot%5D/repos",
      "events_url": "https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}",
      "received_events_url": "https://api.github.com/users/github-actions%5Bbot%5D/received_events",
      "type": "Bot",
      "site_admin": false
    },
    "created_at": "2023-06-28T12:05:09Z",
    "updated_at": "2023-06-28T12:05:09Z",
    "author_association": "NONE",
    "body": "Hi everyone! This issue has been automatically closed due to inactivity.\nIf you think this issue is still relevant in the latest Solidity version and you have something to [contribute](https://docs.soliditylang.org/en/latest/contributing.html), feel free to reopen.\nHowever, unless the issue is a concrete proposal that can be implemented, we recommend starting a language discussion on the [forum](https://forum.soliditylang.org) instead.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1611280735/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
