{
  "url": "https://api.github.com/repos/ethereum/solidity/issues/3716",
  "repository_url": "https://api.github.com/repos/ethereum/solidity",
  "labels_url": "https://api.github.com/repos/ethereum/solidity/issues/3716/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/solidity/issues/3716/comments",
  "events_url": "https://api.github.com/repos/ethereum/solidity/issues/3716/events",
  "html_url": "https://github.com/ethereum/solidity/issues/3716",
  "id": 304680191,
  "node_id": "MDU6SXNzdWUzMDQ2ODAxOTE=",
  "number": 3716,
  "title": "Optimizer cannot delay writes to `length` when adding multiple elements",
  "user": {
    "login": "chriseth",
    "id": 9073706,
    "node_id": "MDQ6VXNlcjkwNzM3MDY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/9073706?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/chriseth",
    "html_url": "https://github.com/chriseth",
    "followers_url": "https://api.github.com/users/chriseth/followers",
    "following_url": "https://api.github.com/users/chriseth/following{/other_user}",
    "gists_url": "https://api.github.com/users/chriseth/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/chriseth/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/chriseth/subscriptions",
    "organizations_url": "https://api.github.com/users/chriseth/orgs",
    "repos_url": "https://api.github.com/users/chriseth/repos",
    "events_url": "https://api.github.com/users/chriseth/events{/privacy}",
    "received_events_url": "https://api.github.com/users/chriseth/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1282209978,
      "node_id": "MDU6TGFiZWwxMjgyMjA5OTc4",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/optimizer",
      "name": "optimizer",
      "color": "d4c5f9",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2018-03-13T09:10:27Z",
  "updated_at": "2019-03-20T17:04:45Z",
  "closed_at": null,
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "Code of the form\r\n```\r\nx.push(1);\r\nx.push(2);\r\nx.push(3);\r\n```\r\nhas 6 `sstore` instructions. It should be possible to remove the two intermediate `sstore`s that increment the length. This is currently not done, since the optimizer also takes into account the case where the data area of an array overlaps with the slot that stores the length. Because of that, it always has to re-fetch the length after the data has been stored.\r\n\r\nWe can 'fix' this by\r\n(1) just assuming that these areas never overlap.\r\n(2) introducing more complicated code that actually checks whether the slots coincide and only re-fetches the data in that case.",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/3716/reactions",
    "total_count": 1,
    "+1": 1,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/solidity/issues/3716/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/372598906",
    "html_url": "https://github.com/ethereum/solidity/issues/3716#issuecomment-372598906",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/3716",
    "id": 372598906,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM3MjU5ODkwNg==",
    "user": {
      "login": "chriseth",
      "id": 9073706,
      "node_id": "MDQ6VXNlcjkwNzM3MDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9073706?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chriseth",
      "html_url": "https://github.com/chriseth",
      "followers_url": "https://api.github.com/users/chriseth/followers",
      "following_url": "https://api.github.com/users/chriseth/following{/other_user}",
      "gists_url": "https://api.github.com/users/chriseth/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chriseth/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chriseth/subscriptions",
      "organizations_url": "https://api.github.com/users/chriseth/orgs",
      "repos_url": "https://api.github.com/users/chriseth/repos",
      "events_url": "https://api.github.com/users/chriseth/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chriseth/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-03-13T09:21:46Z",
    "updated_at": "2018-03-13T09:21:46Z",
    "author_association": "MEMBER",
    "body": "Some thoughts on how (2) might be done:\r\n\r\npush is roughly implemented in the following way:\r\n```\r\nfunction push(x, d)\r\n{\r\n  let length := sload(x)\r\n  let data := keccak256(x) // actually uses memory\r\n  sstore(x, add(length, 1))\r\n  sstore(add(data, length), d)\r\n}\r\n```\r\n\r\nThe inlined code for `x.push(1); x.push(2)` would be something like\r\n\r\n```\r\n{\r\n  let length1 := sload(x)\r\n  let data := keccak256(x)\r\n  sstore(x, add(length1, 1)) // this is what we want to remove\r\n  sstore(add(data, length1), 1)\r\n  let length2 := sload(x) // need to load again due to potential overlap\r\n  sstore(x, add(length2, 1))\r\n  sstore(add(data, length2), 2)\r\n}\r\n```\r\n\r\nThe version optimized according to (2) would be\r\n\r\n```\r\n{\r\n  let length1 := sload(x)\r\n  let data := keccak256(x)\r\n  let tmp := add(length1, 1) // we do not write to storage, but keep as temp data\r\n  sstore(add(data, length1), 1)\r\n  let length2 := tmp // we opportunisticly assume that x != data + length1\r\n  if eq(add(data, length1), x) { length2 := sload(x) } // If not, we perform the load\r\n  sstore(x, add(length2, 1))\r\n  sstore(add(data, length2), 2)\r\n}\r\n```\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/372598906/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
