{
  "url": "https://api.github.com/repos/ethereum/solidity/issues/14236",
  "repository_url": "https://api.github.com/repos/ethereum/solidity",
  "labels_url": "https://api.github.com/repos/ethereum/solidity/issues/14236/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/solidity/issues/14236/comments",
  "events_url": "https://api.github.com/repos/ethereum/solidity/issues/14236/events",
  "html_url": "https://github.com/ethereum/solidity/issues/14236",
  "id": 1713545809,
  "node_id": "I_kwDOAm_5kc5mIqJR",
  "number": 14236,
  "title": "[Stack to memory mover] Potential semantic divergence?",
  "user": {
    "login": "bshastry",
    "id": 2388185,
    "node_id": "MDQ6VXNlcjIzODgxODU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2388185?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/bshastry",
    "html_url": "https://github.com/bshastry",
    "followers_url": "https://api.github.com/users/bshastry/followers",
    "following_url": "https://api.github.com/users/bshastry/following{/other_user}",
    "gists_url": "https://api.github.com/users/bshastry/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/bshastry/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/bshastry/subscriptions",
    "organizations_url": "https://api.github.com/users/bshastry/orgs",
    "repos_url": "https://api.github.com/users/bshastry/repos",
    "events_url": "https://api.github.com/users/bshastry/events{/privacy}",
    "received_events_url": "https://api.github.com/users/bshastry/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 249074435,
      "node_id": "MDU6TGFiZWwyNDkwNzQ0MzU=",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/bug%20:bug:",
      "name": "bug :bug:",
      "color": "fc1313",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2023-05-17T09:57:35Z",
  "updated_at": "2023-05-17T17:49:53Z",
  "closed_at": "2023-05-17T17:49:53Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "```\r\n{\r\n   mstore(memoryguard(0x10000), 1)\r\n   sstore(mload(calldataload(0)), 1)\r\n   {\r\n       function foo_m_0(x_1) -> x_2, x_3, x_4, x_5\r\n       {\r\n           x_2 := call(call(0x2000000000000000000001, 0x200000000000000000001, 0x20000000000000000001, mod(keccak256(mod(0x2000000000000000001, 32768), mod(0x200000000000000001, 32768)), 32768), mod(0x20000000000000001, 32768), mod(0x2000000000000001, 32768), mod(0x200000000000001, 32768)), 0x20000000000001, 0x2000000000001, mod(\"objcodeblockstatementsstatements\", 32768), mod(0x200000000001, 32768), mod(0x20000000001, 32768), mod(0x2000000001, 32768))\r\n           let x_20, x_21, x_22\r\n       }\r\n       let x_23, x_24, x_25, x_26 := foo_m_0(calldataload(288))\r\n       sstore(32, x_23)\r\n       sstore(96, x_24)\r\n       sstore(160, x_25)\r\n       sstore(224, x_26)\r\n       mstore(mod(0x3ffffffffff, 65536), 0x3fffffffffff)\r\n       pop(0x3ffffffffffff)\r\n       for { let i_0 := 0 } lt(i_0, 0x60) { i_0 := add(i_0, 0x20) }\r\n       {\r\n           { }\r\n           let x_42, x_43, x_44, x_45 := foo_m_0(0x3fffffffffffffffffff)\r\n           let x_48, x_49, x_50, x_51\r\n           let x_53, x_54, x_55, x_56 := foo_m_0(x_45)\r\n           continue\r\n       }\r\n   }\r\n}\r\n```\r\n\r\nwhen run succeeds but when optimized and run fails with out of gas. The diff between optimized (+) and original is as follows\r\n\r\n```\r\n--- testf.yul\t2023-05-17 11:51:18.365225248 +0200\r\n+++ opt.yul\t2023-05-17 11:51:58.739124336 +0200\r\n@@ -1,26 +1,30 @@\r\n {\r\n-   mstore(memoryguard(0x10000), 1)\r\n-   sstore(mload(calldataload(0)), 1)\r\n    {\r\n-       function foo_m_0(x_1) -> x_2, x_3, x_4, x_5\r\n+       mstore(0x010000, 1)\r\n+       mstore(memoryguard(0x010060), mload(0x010000))\r\n+       sstore(mload(calldataload(0)), mload(0x010000))\r\n+       let _1 := and(\"objcodeblockstatementsstatements\", 32767)\r\n+       let _2 := 0x2000000000001\r\n+       let _3 := 0x20000000000001\r\n+       let _4 := and(keccak256(mload(0x010000), mload(0x010000)), 32767)\r\n+       let _5 := 0x20000000000000000001\r\n+       mstore(0x010040, 0x200000000000000000001)\r\n+       mstore(0x010020, 0x2000000000000000000001)\r\n+       let _6 := call(call(mload(0x010020), mload(0x010040), _5, _4, mload(0x010000), mload(0x010000), mload(0x010000)), _3, _2, _1, mload(0x010000), mload(0x010000), mload(0x010000))\r\n+       let _7 := 32\r\n+       sstore(_7, _6)\r\n+       let _8 := 96\r\n+       sstore(_8, 0)\r\n+       sstore(160, 0)\r\n+       sstore(224, 0)\r\n+       mstore(65535, 0x3fffffffffff)\r\n+       let i := 0\r\n+       for { } lt(i, _8) { i := add(i, _7) }\r\n        {\r\n-           x_2 := call(call(0x2000000000000000000001, 0x200000000000000000001, 0x20000000000000000001, mod(keccak256(mod(0x2000000000000000001, 32768), mod(0x200000000000000001, 32768)), 32768), mod(0x20000000000000001, 32768), mod(0x2000000000000001, 32768), mod(0x200000000000001, 32768)), 0x20000000000001, 0x2000000000001, mod(\"objcodeblockstatementsstatements\", 32768), mod(0x200000000001, 32768), mod(0x20000000001, 32768), mod(0x2000000001, 32768))\r\n-           let x_20, x_21, x_22\r\n-       }\r\n-       let x_23, x_24, x_25, x_26 := foo_m_0(calldataload(288))\r\n-       sstore(32, x_23)\r\n-       sstore(96, x_24)\r\n-       sstore(160, x_25)\r\n-       sstore(224, x_26)\r\n-       mstore(mod(0x3ffffffffff, 65536), 0x3fffffffffff)\r\n-       pop(0x3ffffffffffff)\r\n-       for { let i_0 := 0 } lt(i_0, 0x60) { i_0 := add(i_0, 0x20) }\r\n-       {\r\n-           { }\r\n-           let x_42, x_43, x_44, x_45 := foo_m_0(0x3fffffffffffffffffff)\r\n-           let x_48, x_49, x_50, x_51\r\n-           let x_53, x_54, x_55, x_56 := foo_m_0(x_45)\r\n+           pop(call(call(mload(0x010020), mload(0x010040), _5, and(keccak256(mload(0x010000), mload(0x010000)), 32767), mload(0x010000), mload(0x010000), mload(0x010000)), _3, _2, _1, mload(0x010000), mload(0x010000), mload(0x010000)))\r\n+           pop(call(call(mload(0x010020), mload(0x010040), _5, and(keccak256(mload(0x010000), mload(0x010000)), 32767), mload(0x010000), mload(0x010000), mload(0x010000)), _3, _2, _1, mload(0x010000), mload(0x010000), mload(0x010000)))\r\n            continue\r\n        }\r\n    }\r\n }\r\n+\r\n```",
  "closed_by": {
    "login": "bshastry",
    "id": 2388185,
    "node_id": "MDQ6VXNlcjIzODgxODU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2388185?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/bshastry",
    "html_url": "https://github.com/bshastry",
    "followers_url": "https://api.github.com/users/bshastry/followers",
    "following_url": "https://api.github.com/users/bshastry/following{/other_user}",
    "gists_url": "https://api.github.com/users/bshastry/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/bshastry/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/bshastry/subscriptions",
    "organizations_url": "https://api.github.com/users/bshastry/orgs",
    "repos_url": "https://api.github.com/users/bshastry/repos",
    "events_url": "https://api.github.com/users/bshastry/events{/privacy}",
    "received_events_url": "https://api.github.com/users/bshastry/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/14236/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/solidity/issues/14236/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1551125201",
    "html_url": "https://github.com/ethereum/solidity/issues/14236#issuecomment-1551125201",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/14236",
    "id": 1551125201,
    "node_id": "IC_kwDOAm_5kc5cdErR",
    "user": {
      "login": "bshastry",
      "id": 2388185,
      "node_id": "MDQ6VXNlcjIzODgxODU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2388185?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bshastry",
      "html_url": "https://github.com/bshastry",
      "followers_url": "https://api.github.com/users/bshastry/followers",
      "following_url": "https://api.github.com/users/bshastry/following{/other_user}",
      "gists_url": "https://api.github.com/users/bshastry/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bshastry/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bshastry/subscriptions",
      "organizations_url": "https://api.github.com/users/bshastry/orgs",
      "repos_url": "https://api.github.com/users/bshastry/repos",
      "events_url": "https://api.github.com/users/bshastry/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bshastry/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-17T10:15:43Z",
    "updated_at": "2023-05-17T10:15:43Z",
    "author_association": "MEMBER",
    "body": "The optimized code is the following\r\n\r\n```\r\n{\r\n   {\r\n       mstore(0x010000, 1)\r\n       mstore(memoryguard(0x010060), mload(0x010000))\r\n       sstore(mload(calldataload(0)), mload(0x010000))\r\n       let _1 := and(\"objcodeblockstatementsstatements\", 32767)\r\n       let _2 := 0x2000000000001\r\n       let _3 := 0x20000000000001\r\n       let _4 := and(keccak256(mload(0x010000), mload(0x010000)), 32767)\r\n       let _5 := 0x20000000000000000001\r\n       mstore(0x010040, 0x200000000000000000001)\r\n       mstore(0x010020, 0x2000000000000000000001)\r\n       let _6 := call(call(mload(0x010020), mload(0x010040), _5, _4, mload(0x010000), mload(0x010000), mload(0x010000)), _3, _2, _1, mload(0x010000), mload(0x010000), mload(0x010000))\r\n       let _7 := 32\r\n       sstore(_7, _6)\r\n       let _8 := 96\r\n       sstore(_8, 0)\r\n       sstore(160, 0)\r\n       sstore(224, 0)\r\n       mstore(65535, 0x3fffffffffff)\r\n       let i := 0\r\n       for { } lt(i, _8) { i := add(i, _7) }\r\n       {\r\n           pop(call(call(mload(0x010020), mload(0x010040), _5, and(keccak256(mload(0x010000), mload(0x010000)), 32767), mload(0x010000), mload(0x010000), mload(0x010000)), _3, _2, _1, mload(0x010000), mload(0x010000), mload(0x010000)))\r\n           pop(call(call(mload(0x010020), mload(0x010040), _5, and(keccak256(mload(0x010000), mload(0x010000)), 32767), mload(0x010000), mload(0x010000), mload(0x010000)), _3, _2, _1, mload(0x010000), mload(0x010000), mload(0x010000)))\r\n           continue\r\n       }\r\n   }\r\n}\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1551125201/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1551234040",
    "html_url": "https://github.com/ethereum/solidity/issues/14236#issuecomment-1551234040",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/14236",
    "id": 1551234040,
    "node_id": "IC_kwDOAm_5kc5cdfP4",
    "user": {
      "login": "bshastry",
      "id": 2388185,
      "node_id": "MDQ6VXNlcjIzODgxODU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2388185?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bshastry",
      "html_url": "https://github.com/bshastry",
      "followers_url": "https://api.github.com/users/bshastry/followers",
      "following_url": "https://api.github.com/users/bshastry/following{/other_user}",
      "gists_url": "https://api.github.com/users/bshastry/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bshastry/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bshastry/subscriptions",
      "organizations_url": "https://api.github.com/users/bshastry/orgs",
      "repos_url": "https://api.github.com/users/bshastry/repos",
      "events_url": "https://api.github.com/users/bshastry/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bshastry/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-17T11:37:38Z",
    "updated_at": "2023-05-17T11:37:38Z",
    "author_association": "MEMBER",
    "body": "Smaller repro\r\n\r\n```\r\n{               \r\n    mstore(memoryguard(0x10000), 1)\r\n    {\r\n        function foo_m_0(x_1) -> x_2 \r\n        {\r\n            x_2 := call(call(8, 80000, 0x80000, mod(keccak256(1, 1), 368), 1, 1, 1), 800001, 0x8000001, mod(\"oent\", 8), 1, 1, 1)\r\n        }\r\n        let x3 := foo_m_0(calldataload(88))\r\n        sstore(32, 23) \r\n        mstore(mod(0xffff, 65536), 0xffffffff)\r\n        for { let i_0 } lt(i_0, 6) { i_0 := add(i_0, 0x20) }\r\n        { let x_2 := foo_m_0(0) }\r\n    }   \r\n}\r\n```\r\n\r\nruns successfully, while optimised version below runs out of gas\r\n\r\n```\r\n{\r\n    {\r\n        mstore(0x010000, 1)\r\n        mstore(memoryguard(0x010060), mload(0x010000))\r\n        let _1 := and(\"oent\", 7)\r\n        let _2 := 0x8000001\r\n        let _3 := 800001\r\n        let _4 := mod(keccak256(mload(0x010000), mload(0x010000)), 368)\r\n        let _5 := 0x80000\r\n        mstore(0x010020, 80000)\r\n        mstore(0x010040, 8)\r\n        pop(call(call(mload(0x010040), mload(0x010020), _5, _4, mload(0x010000), mload(0x010000), mload(0x010000)), _3, _2, _1, mload(0x010000), mload(0x010000), mload(0x010000)))\r\n        let _6 := 32\r\n        sstore(_6, 23)\r\n        mstore(0xffff, 0xffffffff)\r\n        let i := 0\r\n        for { } lt(i, 6) { i := add(i, _6) }\r\n        {\r\n            pop(call(call(mload(0x010040), mload(0x010020), _5, mod(keccak256(mload(0x010000), mload(0x010000)), 368), mload(0x010000), mload(0x010000), mload(0x010000)), _3, _2, _1, mload(0x010000), mload(0x010000), mload(0x010000)))\r\n        }\r\n    }\r\n}\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1551234040/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1551821989",
    "html_url": "https://github.com/ethereum/solidity/issues/14236#issuecomment-1551821989",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/14236",
    "id": 1551821989,
    "node_id": "IC_kwDOAm_5kc5cfuyl",
    "user": {
      "login": "bshastry",
      "id": 2388185,
      "node_id": "MDQ6VXNlcjIzODgxODU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2388185?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bshastry",
      "html_url": "https://github.com/bshastry",
      "followers_url": "https://api.github.com/users/bshastry/followers",
      "following_url": "https://api.github.com/users/bshastry/following{/other_user}",
      "gists_url": "https://api.github.com/users/bshastry/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bshastry/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bshastry/subscriptions",
      "organizations_url": "https://api.github.com/users/bshastry/orgs",
      "repos_url": "https://api.github.com/users/bshastry/repos",
      "events_url": "https://api.github.com/users/bshastry/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bshastry/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-17T17:49:44Z",
    "updated_at": "2023-05-17T17:49:44Z",
    "author_association": "MEMBER",
    "body": "Closing because this is due to a bug in the fuzzer.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1551821989/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
