{
  "url": "https://api.github.com/repos/ethereum/solidity/issues/12865",
  "repository_url": "https://api.github.com/repos/ethereum/solidity",
  "labels_url": "https://api.github.com/repos/ethereum/solidity/issues/12865/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/solidity/issues/12865/comments",
  "events_url": "https://api.github.com/repos/ethereum/solidity/issues/12865/events",
  "html_url": "https://github.com/ethereum/solidity/issues/12865",
  "id": 1182694664,
  "node_id": "I_kwDOAm_5kc5Gfn0I",
  "number": 12865,
  "title": "Unoptimized IR generates `linkersymbol(\"...\")` for internal library calls",
  "user": {
    "login": "hrkrshnn",
    "id": 13174375,
    "node_id": "MDQ6VXNlcjEzMTc0Mzc1",
    "avatar_url": "https://avatars.githubusercontent.com/u/13174375?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/hrkrshnn",
    "html_url": "https://github.com/hrkrshnn",
    "followers_url": "https://api.github.com/users/hrkrshnn/followers",
    "following_url": "https://api.github.com/users/hrkrshnn/following{/other_user}",
    "gists_url": "https://api.github.com/users/hrkrshnn/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/hrkrshnn/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/hrkrshnn/subscriptions",
    "organizations_url": "https://api.github.com/users/hrkrshnn/orgs",
    "repos_url": "https://api.github.com/users/hrkrshnn/repos",
    "events_url": "https://api.github.com/users/hrkrshnn/events{/privacy}",
    "received_events_url": "https://api.github.com/users/hrkrshnn/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 249074435,
      "node_id": "MDU6TGFiZWwyNDkwNzQ0MzU=",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/bug%20:bug:",
      "name": "bug :bug:",
      "color": "fc1313",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2022-03-27T23:08:25Z",
  "updated_at": "2022-04-11T14:05:01Z",
  "closed_at": null,
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "```solidity\r\nlibrary Math {\r\n    function add(uint a, uint b) internal returns (uint c) {\r\n        c = a + b;\r\n    }\r\n}\r\ncontract C {\r\n    function f(uint a, uint b) public returns (uint c) {\r\n        c = Math.add(a, b);\r\n    }\r\n}\r\n```\r\n\r\nThe IR for the above generates `let expr_27_address := linkersymbol(\"<stdin>:Math\")`. The optimizer is able to optimize it away. However, the compiler shouldn't any code with `linkersymbol` when it's not needed, even in the unoptimized codegen.",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/12865/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/solidity/issues/12865/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1080493292",
    "html_url": "https://github.com/ethereum/solidity/issues/12865#issuecomment-1080493292",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/12865",
    "id": 1080493292,
    "node_id": "IC_kwDOAm_5kc5AZwTs",
    "user": {
      "login": "cameel",
      "id": 137030,
      "node_id": "MDQ6VXNlcjEzNzAzMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cameel",
      "html_url": "https://github.com/cameel",
      "followers_url": "https://api.github.com/users/cameel/followers",
      "following_url": "https://api.github.com/users/cameel/following{/other_user}",
      "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
      "organizations_url": "https://api.github.com/users/cameel/orgs",
      "repos_url": "https://api.github.com/users/cameel/repos",
      "events_url": "https://api.github.com/users/cameel/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cameel/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-03-28T10:47:25Z",
    "updated_at": "2022-03-28T10:47:25Z",
    "author_association": "MEMBER",
    "body": "Good point. I agree that we should avoid leaving these linker references in when the call is actually internal, even in unoptimized code. We don't want people to have to go through some dummy linking process when these references are unused.\r\n\r\nThis is not actually a bug though, it was done like this on purpose. At least there was no consideration of removing it at the codegen level when this was being implemented. The evaluation of the name into address and actual use of the address happen at different points in AST processing and this follows our general pattern of just creating an IR variable without checking if it's used or not and then using it (or not) in a another place, assuming that the optimizer will remove it if it's unused.\r\n\r\nThe way it's done currently, the codegen simply puts the library address in a variable whenever it encounters its name:\r\nhttps://github.com/ethereum/solidity/blob/c4909e99c1015233d6937d229058cde52615f246/libsolidity/codegen/ir/IRGeneratorForStatements.cpp#L2138-L2142\r\n\r\nIf it happens to be an external call, then `appendExternalFunctionCall()` called when visiting a `FunctionCall` may then use that variable:\r\nhttps://github.com/ethereum/solidity/blob/c4909e99c1015233d6937d229058cde52615f246/libsolidity/codegen/ir/IRGeneratorForStatements.cpp#L2580-L2581\r\n\r\nLooks like we'll have to complicate this mechanism a bit. Similar to the way that having to detect actual calls (rather than all uses of a function name) complicates collecting functions for internal dispatch.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1080493292/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1095095828",
    "html_url": "https://github.com/ethereum/solidity/issues/12865#issuecomment-1095095828",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/12865",
    "id": 1095095828,
    "node_id": "IC_kwDOAm_5kc5BRdYU",
    "user": {
      "login": "chriseth",
      "id": 9073706,
      "node_id": "MDQ6VXNlcjkwNzM3MDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9073706?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chriseth",
      "html_url": "https://github.com/chriseth",
      "followers_url": "https://api.github.com/users/chriseth/followers",
      "following_url": "https://api.github.com/users/chriseth/following{/other_user}",
      "gists_url": "https://api.github.com/users/chriseth/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chriseth/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chriseth/subscriptions",
      "organizations_url": "https://api.github.com/users/chriseth/orgs",
      "repos_url": "https://api.github.com/users/chriseth/repos",
      "events_url": "https://api.github.com/users/chriseth/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chriseth/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-04-11T14:05:00Z",
    "updated_at": "2022-04-11T14:05:00Z",
    "author_association": "MEMBER",
    "body": "It was done like this intentionally. We should not complicated code generation if a simple optimizer step can do the same trick. If people don't want to cope with the longer compilation time of the optimizer, we can offer a minimal optimizer sequence that takes care of it.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1095095828/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
