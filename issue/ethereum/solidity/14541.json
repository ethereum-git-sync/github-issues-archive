{
  "url": "https://api.github.com/repos/ethereum/solidity/issues/14541",
  "repository_url": "https://api.github.com/repos/ethereum/solidity",
  "labels_url": "https://api.github.com/repos/ethereum/solidity/issues/14541/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/solidity/issues/14541/comments",
  "events_url": "https://api.github.com/repos/ethereum/solidity/issues/14541/events",
  "html_url": "https://github.com/ethereum/solidity/issues/14541",
  "id": 1884141895,
  "node_id": "I_kwDOAm_5kc5wTblH",
  "number": 14541,
  "title": "Via-IR bytecode differences when explicitly requesting a file that would be pulled by an import",
  "user": {
    "login": "cameel",
    "id": 137030,
    "node_id": "MDQ6VXNlcjEzNzAzMA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/cameel",
    "html_url": "https://github.com/cameel",
    "followers_url": "https://api.github.com/users/cameel/followers",
    "following_url": "https://api.github.com/users/cameel/following{/other_user}",
    "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
    "organizations_url": "https://api.github.com/users/cameel/orgs",
    "repos_url": "https://api.github.com/users/cameel/repos",
    "events_url": "https://api.github.com/users/cameel/events{/privacy}",
    "received_events_url": "https://api.github.com/users/cameel/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 249074435,
      "node_id": "MDU6TGFiZWwyNDkwNzQ0MzU=",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/bug%20:bug:",
      "name": "bug :bug:",
      "color": "fc1313",
      "default": false,
      "description": ""
    },
    {
      "id": 4438003076,
      "node_id": "LA_kwDOAm_5kc8AAAABCIaNhA",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/medium%20effort",
      "name": "medium effort",
      "color": "ff7df7",
      "default": false,
      "description": "Default level of effort"
    },
    {
      "id": 4438155599,
      "node_id": "LA_kwDOAm_5kc8AAAABCIjhTw",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/medium%20impact",
      "name": "medium impact",
      "color": "314aff",
      "default": false,
      "description": "Default level of impact"
    },
    {
      "id": 4438488423,
      "node_id": "LA_kwDOAm_5kc8AAAABCI31Zw",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/must%20have",
      "name": "must have",
      "color": "ffa12a",
      "default": false,
      "description": "Something we consider an essential part of Solidity 1.0."
    },
    {
      "id": 4828600698,
      "node_id": "LA_kwDOAm_5kc8AAAABH86Zeg",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/viair",
      "name": "viair",
      "color": "5999F7",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": {
    "login": "r0qs",
    "id": 457348,
    "node_id": "MDQ6VXNlcjQ1NzM0OA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/457348?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/r0qs",
    "html_url": "https://github.com/r0qs",
    "followers_url": "https://api.github.com/users/r0qs/followers",
    "following_url": "https://api.github.com/users/r0qs/following{/other_user}",
    "gists_url": "https://api.github.com/users/r0qs/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/r0qs/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/r0qs/subscriptions",
    "organizations_url": "https://api.github.com/users/r0qs/orgs",
    "repos_url": "https://api.github.com/users/r0qs/repos",
    "events_url": "https://api.github.com/users/r0qs/events{/privacy}",
    "received_events_url": "https://api.github.com/users/r0qs/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "r0qs",
      "id": 457348,
      "node_id": "MDQ6VXNlcjQ1NzM0OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/457348?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/r0qs",
      "html_url": "https://github.com/r0qs",
      "followers_url": "https://api.github.com/users/r0qs/followers",
      "following_url": "https://api.github.com/users/r0qs/following{/other_user}",
      "gists_url": "https://api.github.com/users/r0qs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/r0qs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/r0qs/subscriptions",
      "organizations_url": "https://api.github.com/users/r0qs/orgs",
      "repos_url": "https://api.github.com/users/r0qs/repos",
      "events_url": "https://api.github.com/users/r0qs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/r0qs/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2023-09-06T14:29:20Z",
  "updated_at": "2023-09-11T14:22:53Z",
  "closed_at": null,
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "Originally reported in https://github.com/ethereum/solidity/issues/14494#issuecomment-1692358415.\r\n\r\n## Description\r\nExplicitly requesting compilation of a file that is already included via imports may in certain situations affect the order in which Yul functions are placed in the IR output, which causes bytecode differences. This is apparently due to different AST IDs assigned to those functions.\r\n\r\nThe problem manifests both with and without optimizer. Only the IR pipeline is affected.\r\n\r\n## Environment\r\n\r\n- Compiler version: 0.8.21\r\n\r\n## Steps to Reproduce\r\n```bash\r\nmkdir @\r\n\r\ncat <<=== > a.sol\r\n    import \"@/za.sol\";\r\n    import \"b.sol\";\r\n\r\n    contract A is B {\r\n        function a() public pure {\r\n            zb();\r\n        }\r\n    }\r\n===\r\n\r\ncat <<=== > b.sol\r\n    import \"@/zb.sol\";\r\n    import \"c.sol\";\r\n\r\n    abstract contract B is C {}\r\n===\r\n\r\ncat <<=== > c.sol\r\n    abstract contract C\r\n    {\r\n        function f() public pure {}\r\n\r\n        function c() public view returns (uint) {\r\n            try this.f() { return 0; }\r\n            catch {}\r\n        }\r\n    }\r\n===\r\n\r\ncat <<=== > @/za.sol\r\n    import \"@/zc.sol\";\r\n===\r\n\r\ncat <<=== > @/zb.sol\r\n    import \"@/zc.sol\";\r\n\r\n    function zb() pure {\r\n        zc();\r\n    }\r\n===\r\n\r\ncat <<=== > @/zc.sol\r\n    function zc() pure returns (bytes memory returndata) {\r\n        if (returndata.length == 0) {\r\n            return \"\";\r\n        }\r\n    }\r\n===\r\n\r\ndiff --color --unified \\\r\n    <(solc a.sol b.sol --bin --via-ir | grep '======= a.sol:A =======' --after-context=2 | fold --width 100) \\\r\n    <(solc a.sol       --bin --via-ir | grep '======= a.sol:A =======' --after-context=2 | fold --width 100)\r\n\r\ndiff --color --unified \\\r\n    <(solc a.sol b.sol --ir) \\\r\n    <(solc a.sol       --ir)\r\n```\r\n\r\nI could not go below 6 files or get rid of a subdirectory, though I suspect this is needed only due to the way it affects the import/compilation order and examples without it should be possible as well.\r\n\r\nThe import pattern goes like this:\r\n\r\n```\r\na──►za──►zc\r\n│         ▲\r\n▼         │\r\nb──►zb────┘\r\n│\r\n▼\r\nc\r\n```\r\n\r\nBut the pattern itself is not enough. The `try`/`catch` and all the other calls are necessary and must also be placed in specific files.",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/14541/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/solidity/issues/14541/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1708630445",
    "html_url": "https://github.com/ethereum/solidity/issues/14541#issuecomment-1708630445",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/14541",
    "id": 1708630445,
    "node_id": "IC_kwDOAm_5kc5l16Gt",
    "user": {
      "login": "cameel",
      "id": 137030,
      "node_id": "MDQ6VXNlcjEzNzAzMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cameel",
      "html_url": "https://github.com/cameel",
      "followers_url": "https://api.github.com/users/cameel/followers",
      "following_url": "https://api.github.com/users/cameel/following{/other_user}",
      "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
      "organizations_url": "https://api.github.com/users/cameel/orgs",
      "repos_url": "https://api.github.com/users/cameel/repos",
      "events_url": "https://api.github.com/users/cameel/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cameel/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-09-06T15:38:48Z",
    "updated_at": "2023-09-06T15:38:48Z",
    "author_association": "MEMBER",
    "body": "I think this issue is actually inherent in how we [process input files and imports](https://github.com/ethereum/solidity/blob/v0.8.21/libsolidity/interface/CompilerStack.cpp#L358-L393).\r\n\r\nThe way we do it currently is to take the files passed to the compiler initially (on the CLI or in Standard JSON) and iterate them in lexicographic order of their source unit names. We parse each file, and while doing this discover its imports and append them at the end of the list we're iterating. This means that an imported file may end up being processed earlier in that order if we include its name on the command line. This then affects AST IDs.\r\n\r\nI don't really see a way to solve it other than collecting all the files up front and ordering them before assigning IDs. We could do it by having a separate phase of import discovery, but this is complicated because it would still require some lightweight parsing. So we could instead use the idea mentioned on the call today - assigning new IDs somewhere between parsing and codegen.\r\n\r\nWhile at it, we could also order the files by content hash rather than source unit names to make the IDs independent of naming.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1708630445/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1710377695",
    "html_url": "https://github.com/ethereum/solidity/issues/14541#issuecomment-1710377695",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/14541",
    "id": 1710377695,
    "node_id": "IC_kwDOAm_5kc5l8krf",
    "user": {
      "login": "r0qs",
      "id": 457348,
      "node_id": "MDQ6VXNlcjQ1NzM0OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/457348?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/r0qs",
      "html_url": "https://github.com/r0qs",
      "followers_url": "https://api.github.com/users/r0qs/followers",
      "following_url": "https://api.github.com/users/r0qs/following{/other_user}",
      "gists_url": "https://api.github.com/users/r0qs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/r0qs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/r0qs/subscriptions",
      "organizations_url": "https://api.github.com/users/r0qs/orgs",
      "repos_url": "https://api.github.com/users/r0qs/repos",
      "events_url": "https://api.github.com/users/r0qs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/r0qs/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-09-07T15:38:34Z",
    "updated_at": "2023-09-11T14:22:53Z",
    "author_association": "MEMBER",
    "body": "I played a bit with the example and could simplify it a bit more, i.e. `zb` and the `try / catch` in `c` are unnecessary:\r\n\r\n```bash\r\ncompiler=${1:-solc}\r\n\r\nmkdir -p @\r\n\r\ncat <<=== > a.sol\r\n    import \"@/za.sol\";\r\n    import \"b.sol\";\r\n\r\n    contract A is B {\r\n        function a() public pure {\r\n            zc();\r\n        }\r\n    }\r\n===\r\n\r\ncat <<=== > b.sol\r\n    import \"c.sol\";\r\n\r\n    abstract contract B is C {}\r\n===\r\n\r\ncat <<=== > c.sol\r\n    abstract contract C\r\n    {\r\n        function c() public pure returns (uint) {\r\n            return 0;\r\n        }\r\n    }\r\n===\r\n\r\ncat <<=== > @/za.sol\r\n    import \"@/zc.sol\";\r\n===\r\n\r\ncat <<=== > @/zc.sol\r\n    function zc() pure returns (bytes memory returndata) {\r\n        if (returndata.length == 0) {\r\n            return \"\";\r\n        }\r\n    }\r\n===\r\n\r\ndiff --color --unified \\\r\n    <($compiler a.sol b.sol --bin --via-ir | grep '======= a.sol:A =======' --after-context=2 | fold --width 100) \\\r\n    <($compiler a.sol       --bin --via-ir | grep '======= a.sol:A =======' --after-context=2 | fold --width 100)\r\n\r\ndiff --color --unified \\\r\n    <($compiler a.sol b.sol --ir) \\\r\n    <($compiler a.sol       --ir)\r\n```\r\n\r\nSo the new import pattern is:\r\n```\r\na──►za──►zc\r\n│         \r\n▼         \r\nb\r\n│\r\n▼\r\nc\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1710377695/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
