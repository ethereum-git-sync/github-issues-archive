{
  "url": "https://api.github.com/repos/ethereum/solidity/issues/14018",
  "repository_url": "https://api.github.com/repos/ethereum/solidity",
  "labels_url": "https://api.github.com/repos/ethereum/solidity/issues/14018/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/solidity/issues/14018/comments",
  "events_url": "https://api.github.com/repos/ethereum/solidity/issues/14018/events",
  "html_url": "https://github.com/ethereum/solidity/issues/14018",
  "id": 1603340523,
  "node_id": "I_kwDOAm_5kc5fkQjr",
  "number": 14018,
  "title": "Data returned from staticcall does not contain first offset, for structs containing byte arrays",
  "user": {
    "login": "0xTycoon",
    "id": 27789784,
    "node_id": "MDQ6VXNlcjI3Nzg5Nzg0",
    "avatar_url": "https://avatars.githubusercontent.com/u/27789784?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/0xTycoon",
    "html_url": "https://github.com/0xTycoon",
    "followers_url": "https://api.github.com/users/0xTycoon/followers",
    "following_url": "https://api.github.com/users/0xTycoon/following{/other_user}",
    "gists_url": "https://api.github.com/users/0xTycoon/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/0xTycoon/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/0xTycoon/subscriptions",
    "organizations_url": "https://api.github.com/users/0xTycoon/orgs",
    "repos_url": "https://api.github.com/users/0xTycoon/repos",
    "events_url": "https://api.github.com/users/0xTycoon/events{/privacy}",
    "received_events_url": "https://api.github.com/users/0xTycoon/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2023-02-28T15:56:58Z",
  "updated_at": "2023-03-23T05:55:24Z",
  "closed_at": "2023-03-21T13:06:17Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nWe have a simple struct like so:\r\n\r\n```solidity\r\nstruct Blocker {\r\n        uint layer;\r\n        bytes dataA;\r\n        bytes dataB;\r\n    }\r\n```\r\n\r\nUsed in a mapping\r\n\r\n```solidity\r\n    mapping(bytes32 => Blocker) public blocks;\r\n```\r\n\r\nWhen accessing this mapping from another contract using staticcall, the call reverts, if `Blocker.layer > 0`\r\n\r\nUpon investigation, it was found that the first 32 bytes does not contain the offset. [See more details here](https://github.com/0xTycoon/punk-blocks/issues/1).\r\n\r\n## Environment\r\n\r\n- Compiler version: 0.8.19\r\n- Target EVM version (as per compiler settings): 0.8.19\r\n- Framework/IDE (e.g. Truffle or Remix): Hardhat, also deployed test case & on mainnet & getting same issue on mainnet\r\n- EVM execution environment / backend / blockchain client: geth\r\n- Operating system: linux\r\n- optimizations off or on\r\n\r\n## Steps to Reproduce\r\n\r\nNarrowed it down to the following test case.\r\n\r\nSee comment `Changing this 9 to a 0 will make doesntWork() return without error.` \r\n\r\nThere are detailed observations & a test deployed to mainnet, [described here](https://github.com/0xTycoon/punk-blocks/issues/1)\r\n\r\n```solidity\r\npragma solidity ^0.8.19;\r\n\r\ncontract Blocking {\r\n\r\n    uint public nextId;\r\n\r\n    struct Blocker {\r\n        uint layer;\r\n        bytes dataA;\r\n        bytes dataB;\r\n    }\r\n\r\n    mapping(bytes32 => Blocker) public blocks;\r\n\r\n    constructor() {\r\n        Blocker storage b = blocks[bytes32(hex\"9039da071f773e85254cbd0f99efa70230c4c11d63fce84323db9eca8e8ef283\")];\r\n        b = blocks[bytes32(hex\"1885fe71e225eade934ab7040d533bd49efc5d66e8f2d4b5aa42477ae9892ec9\")];\r\n        b.layer = 9;\r\n        b.dataA = hex\"89504e470d0a1a0a0000000d4948445200000018000000180806000000e0773df80000004b4944415478da6262a03118b560d482510b869a0577efde6d18\";\r\n        nextId++;\r\n        b = blocks[bytes32(hex\"1885fe71e225eade934ab7040d533bd49efc5d66e8f2d4b5aa42477ae9892ec9\")];\r\n        // Changing this 9 to a 0 will make doesntWork() return without error.\r\n        b.layer = 9;\r\n        b.dataB = hex\"89504e470d0a1a0a0000000d4948445200000018000000180806000000e0773df80000004b4944415478da6262a03118b560d482510b869a0577efde6d180da2116801cd010b057affe31067c4c921c5f063c78e6108ca4c4d60905b7a0bc55c465afb806134990eb80580000000ffff78ff0b44c51816510000000049454e44ae426082\";\r\n        nextId++;\r\n        b = blocks[bytes32(hex\"1bb61a688fea4953cb586baa1eadb220020829a1e284be38d2ea8fb996dd7286\")];\r\n        b.layer = 0;\r\n        b.dataA = hex\"89504e470d0a1a0a0000000d4948445200000018000000180403000000125920cb00000015504c5445000000000000713f1d8b532c5626007237094a120162eb383b0000000174524e530040e6d8660000004c4944415478da62a03160141414807384949414e112ca4a4a4a302946255c1c2115272517384731484914c61154c26380102e19b5343807c5390c42082d208b0419905c2d80c901040000ffff2f3c090f8ffce8ac0000000049454e44ae426082\";\r\n    }\r\n}\r\n\r\ncontract TestBlocking {\r\n    IPunkBlocks bl; // Blocking\r\n    constructor(address _b) {\r\n        bl = IPunkBlocks(_b);\r\n    }\r\n    function doesntWork() external view returns(IPunkBlocks.Block memory) {\r\n        // This works if you call the Blocking.blocks(bytes32) method directly via web3\r\n        // https://etherscan.io/address/0x58E90596C2065BEfD3060767736C829C18F3474c#readContract\r\n        // 0x1885.. is a valid key, it exists.\r\n        //  IPunkBlocks.Block memory test = pb.blocks(0x1885fe71e225eade934ab7040d533bd49efc5d66e8f2d4b5aa42477ae9892ec9);\r\n        address addr = address(bl);\r\n        (bool success, bytes memory retVal) = addr.staticcall(abi.encodeWithSignature(\"blocks(bytes32)\", bytes32(0x1885fe71e225eade934ab7040d533bd49efc5d66e8f2d4b5aa42477ae9892ec9)));\r\n        IPunkBlocks.Block memory blk = abi.decode(retVal, (IPunkBlocks.Block));\r\n        return blk;\r\n    }\r\n\r\n    function works() external view returns(IPunkBlocks.Block memory) {\r\n        address addr = address(bl);\r\n        (bool success, bytes memory retVal) = addr.staticcall(abi.encodeWithSignature(\"blocks(bytes32)\", bytes32(0x1BB61A688FEA4953CB586BAA1EADB220020829A1E284BE38D2EA8FB996DD7286)));\r\n        IPunkBlocks.Block memory blk = abi.decode(retVal, (IPunkBlocks.Block)); // reverts here\r\n        return blk;\r\n    }\r\n\r\n}\r\n\r\ninterface IPunkBlocks {\r\n    struct Block {\r\n        uint layer;\r\n        bytes dataA;\r\n        bytes dataB;\r\n    }\r\n    function blocks(bytes32) external view returns(Block memory);\r\n}\r\n```",
  "closed_by": {
    "login": "ekpyron",
    "id": 1347491,
    "node_id": "MDQ6VXNlcjEzNDc0OTE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1347491?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ekpyron",
    "html_url": "https://github.com/ekpyron",
    "followers_url": "https://api.github.com/users/ekpyron/followers",
    "following_url": "https://api.github.com/users/ekpyron/following{/other_user}",
    "gists_url": "https://api.github.com/users/ekpyron/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ekpyron/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ekpyron/subscriptions",
    "organizations_url": "https://api.github.com/users/ekpyron/orgs",
    "repos_url": "https://api.github.com/users/ekpyron/repos",
    "events_url": "https://api.github.com/users/ekpyron/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ekpyron/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/14018/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/solidity/issues/14018/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1449309089",
    "html_url": "https://github.com/ethereum/solidity/issues/14018#issuecomment-1449309089",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/14018",
    "id": 1449309089,
    "node_id": "IC_kwDOAm_5kc5WYrOh",
    "user": {
      "login": "0xTycoon",
      "id": 27789784,
      "node_id": "MDQ6VXNlcjI3Nzg5Nzg0",
      "avatar_url": "https://avatars.githubusercontent.com/u/27789784?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/0xTycoon",
      "html_url": "https://github.com/0xTycoon",
      "followers_url": "https://api.github.com/users/0xTycoon/followers",
      "following_url": "https://api.github.com/users/0xTycoon/following{/other_user}",
      "gists_url": "https://api.github.com/users/0xTycoon/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/0xTycoon/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/0xTycoon/subscriptions",
      "organizations_url": "https://api.github.com/users/0xTycoon/orgs",
      "repos_url": "https://api.github.com/users/0xTycoon/repos",
      "events_url": "https://api.github.com/users/0xTycoon/events{/privacy}",
      "received_events_url": "https://api.github.com/users/0xTycoon/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-01T04:10:22Z",
    "updated_at": "2023-03-01T04:15:17Z",
    "author_association": "NONE",
    "body": "fyi, Here is a workaround that fixes `doesntWork` \r\nIt resizes retVal one slot back and puts an offset value of 0x20 at the beginning.\r\n\r\n```solidity\r\nfunction doesntWork2() external view returns(IPunkBlocks.Block memory) {\r\n        // This works if you call the Blocking.blocks(bytes32) method directly via web3\r\n        // https://etherscan.io/address/0x58E90596C2065BEfD3060767736C829C18F3474c#readContract\r\n        // 0x1885.. is a valid key, it exists.\r\n        //  IPunkBlocks.Block memory test = pb.blocks(0x1885fe71e225eade934ab7040d533bd49efc5d66e8f2d4b5aa42477ae9892ec9);\r\n        address addr = address(bl);\r\n        (bool success, bytes memory retVal) = addr.staticcall(abi.encodeWithSignature(\"blocks(bytes32)\", bytes32(0x1885fe71e225eade934ab7040d533bd49efc5d66e8f2d4b5aa42477ae9892ec9)));\r\n        // bugfix, prefix to retVal an offset with a value of \"0x20\"\r\n        assembly {\r\n            let len := mload(retVal)\r\n            retVal := sub(retVal, 0x20)     // set a new start for retVal, going back 1 slot\r\n            mstore(retVal, add(len, 0x20))  // set the new length, 1 slot longer\r\n            mstore(add(retVal, 0x20), 0x20) // place an offset in first position\r\n        }\r\n        IPunkBlocks.Block memory blk = abi.decode(retVal, (IPunkBlocks.Block));\r\n        return blk;\r\n    }\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1449309089/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1477806119",
    "html_url": "https://github.com/ethereum/solidity/issues/14018#issuecomment-1477806119",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/14018",
    "id": 1477806119,
    "node_id": "IC_kwDOAm_5kc5YFYgn",
    "user": {
      "login": "ekpyron",
      "id": 1347491,
      "node_id": "MDQ6VXNlcjEzNDc0OTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1347491?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ekpyron",
      "html_url": "https://github.com/ekpyron",
      "followers_url": "https://api.github.com/users/ekpyron/followers",
      "following_url": "https://api.github.com/users/ekpyron/following{/other_user}",
      "gists_url": "https://api.github.com/users/ekpyron/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ekpyron/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ekpyron/subscriptions",
      "organizations_url": "https://api.github.com/users/ekpyron/orgs",
      "repos_url": "https://api.github.com/users/ekpyron/repos",
      "events_url": "https://api.github.com/users/ekpyron/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ekpyron/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-21T13:06:16Z",
    "updated_at": "2023-03-21T13:06:16Z",
    "author_association": "MEMBER",
    "body": "The autogenerated getters do *not* return structs, but the struct members as tuples, that's why you're not getting the encoding you're expecting. So this is not a bug, but weird, but expected behaviour.\r\n\r\nI.e. to be more precise, what you get as a return value of ``blocks(bytes32)``, is not `(IPunkBlocks.Block)`, but `(uint256,bytes,bytes)`, so you can't directly decode to a `IPinkBlocks.Block`, but only to a tuple.\r\n\r\nSo another workaround would be to not rely on the weird behaviour of automatically generated getters in these cases, but to define a manual one like\r\n```\r\n    function getBlocks(bytes32 a) external returns (IPunkBlocks.Block memory) { return blocks[a]; }\r\n```\r\n\r\nCalling that you'll get something you can properly decode directly to the struct type.\r\n\r\nThe fact that getters return tuples not structs in cases like this is for historic reasons back from times where returning structs was impossible. We will probably change this eventually, but it's a tricky breaking change.\r\n\r\nGiven that, this is not actually a bug in Solidity, so I'm closing this issue - but feel free to reopen it, if you think this is an issue after all despite the explanation above!",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1477806119/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1477812825",
    "html_url": "https://github.com/ethereum/solidity/issues/14018#issuecomment-1477812825",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/14018",
    "id": 1477812825,
    "node_id": "IC_kwDOAm_5kc5YFaJZ",
    "user": {
      "login": "ekpyron",
      "id": 1347491,
      "node_id": "MDQ6VXNlcjEzNDc0OTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1347491?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ekpyron",
      "html_url": "https://github.com/ekpyron",
      "followers_url": "https://api.github.com/users/ekpyron/followers",
      "following_url": "https://api.github.com/users/ekpyron/following{/other_user}",
      "gists_url": "https://api.github.com/users/ekpyron/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ekpyron/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ekpyron/subscriptions",
      "organizations_url": "https://api.github.com/users/ekpyron/orgs",
      "repos_url": "https://api.github.com/users/ekpyron/repos",
      "events_url": "https://api.github.com/users/ekpyron/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ekpyron/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-21T13:10:45Z",
    "updated_at": "2023-03-21T13:10:45Z",
    "author_association": "MEMBER",
    "body": "Maybe to make this a bit clearer still: you can also see this behaviour on high-level calls to the external getters:\r\n\r\nThis does *not* type-check:\r\n```\r\nBlocking bl;\r\nIPunkBlocks.Block memory blk = bl.blocks(0);\r\n```\r\n\r\nSince the return type is in fact a tuple, so only the following works:\r\n```\r\nBlocking bl;\r\n(uint a, bytes memory b, bytes memory c) = bl.blocks(0);\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1477812825/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 1,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1480640410",
    "html_url": "https://github.com/ethereum/solidity/issues/14018#issuecomment-1480640410",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/14018",
    "id": 1480640410,
    "node_id": "IC_kwDOAm_5kc5YQMea",
    "user": {
      "login": "0xTycoon",
      "id": 27789784,
      "node_id": "MDQ6VXNlcjI3Nzg5Nzg0",
      "avatar_url": "https://avatars.githubusercontent.com/u/27789784?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/0xTycoon",
      "html_url": "https://github.com/0xTycoon",
      "followers_url": "https://api.github.com/users/0xTycoon/followers",
      "following_url": "https://api.github.com/users/0xTycoon/following{/other_user}",
      "gists_url": "https://api.github.com/users/0xTycoon/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/0xTycoon/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/0xTycoon/subscriptions",
      "organizations_url": "https://api.github.com/users/0xTycoon/orgs",
      "repos_url": "https://api.github.com/users/0xTycoon/repos",
      "events_url": "https://api.github.com/users/0xTycoon/events{/privacy}",
      "received_events_url": "https://api.github.com/users/0xTycoon/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-23T05:55:23Z",
    "updated_at": "2023-03-23T05:55:23Z",
    "author_association": "NONE",
    "body": "Thanks, this is useful information.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1480640410/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
