{
  "url": "https://api.github.com/repos/ethereum/solidity/issues/6359",
  "repository_url": "https://api.github.com/repos/ethereum/solidity",
  "labels_url": "https://api.github.com/repos/ethereum/solidity/issues/6359/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/solidity/issues/6359/comments",
  "events_url": "https://api.github.com/repos/ethereum/solidity/issues/6359/events",
  "html_url": "https://github.com/ethereum/solidity/issues/6359",
  "id": 424830743,
  "node_id": "MDU6SXNzdWU0MjQ4MzA3NDM=",
  "number": 6359,
  "title": "Yul optimizer: Structural simplifier generates incorrect code while optimizing switch statement with no default statement",
  "user": {
    "login": "bshastry",
    "id": 2388185,
    "node_id": "MDQ6VXNlcjIzODgxODU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2388185?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/bshastry",
    "html_url": "https://github.com/bshastry",
    "followers_url": "https://api.github.com/users/bshastry/followers",
    "following_url": "https://api.github.com/users/bshastry/following{/other_user}",
    "gists_url": "https://api.github.com/users/bshastry/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/bshastry/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/bshastry/subscriptions",
    "organizations_url": "https://api.github.com/users/bshastry/orgs",
    "repos_url": "https://api.github.com/users/bshastry/repos",
    "events_url": "https://api.github.com/users/bshastry/events{/privacy}",
    "received_events_url": "https://api.github.com/users/bshastry/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 249074435,
      "node_id": "MDU6TGFiZWwyNDkwNzQ0MzU=",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/bug%20:bug:",
      "name": "bug :bug:",
      "color": "fc1313",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2019-03-25T10:39:37Z",
  "updated_at": "2019-03-25T13:01:00Z",
  "closed_at": "2019-03-25T13:01:00Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\n### Bug report\r\n        \r\nThe following code snippet\r\n```\r\n        {\r\n        foo(calldataload(0))\r\n        function foo(x)\r\n        {\r\n            switch x\r\n            case 0 {\r\n            }\r\n            case \"\" {\r\n                sstore(1, 1)\r\n            }\r\n        }\r\n    }\r\n```\r\n        \r\ntriggers an optimization bug.\r\n        \r\n        \r\n        \r\nTrace of unoptimized code\r\n        \r\n        Trace:\r\nMemory dump:\r\nStorage dump:\r\n\r\n        \r\nTrace of optimized code\r\n        \r\n        Trace:\r\n  SSTORE(1, 1)\r\nMemory dump:\r\nStorage dump:\r\n  0000000000000000000000000000000000000000000000000000000000000001: 0000000000000000000000000000000000000000000000000000000000000001\r\n\r\n### Notes\r\n\r\nThe bug happens because the following conditions are met\r\n  - Structural simplifier removes case statement with no body in switch statements without a default case statement\r\n  - It then replaces single case switch statement with an equivalent if statement\r\n\r\nThe problem is that the resulting if statement returns true because an empty string literal evaluates to zero.\r\n\r\nThe underlying problem seems to be supporting case literals of mixed types (string and uint) that are handled differently in switch statements and if statement (and possibly others).\r\n\r\n## Environment\r\n\r\n- Compiler version: latest develop\r\n- Target EVM version (as per compiler settings): Petersburg\r\n- Framework/IDE (e.g. Truffle or Remix): na\r\n- EVM execution environment / backend / blockchain client: na\r\n- Operating system: Ubuntu 18.04\r\n\r\n## Steps to Reproduce\r\n\r\nOne can step through the buggy transformation using the yulopti tool by passing the `t` option (Structural simplifier)\r\n\r\n```\r\n$ yulopti --input-file <code.yul>\r\n----------------------\r\n{\r\n  foo(calldataload(0))\r\n  function foo(x)\r\n  {\r\n    switch x\r\n      case 0 {}\r\n      case \"\" {\r\n        sstore(1, 1)\r\n      }\r\n  }\r\n}\r\n\r\n(q)quit/(f)flatten/(c)se/initialize var(d)ecls/(x)plit/(j)oin/(g)rouper/(h)oister/\r\n  (e)xpr inline/(i)nline/(s)implify/varname c(l)eaner/(u)nusedprune/ss(a) transform/\r\n  (r)edundant assign elim./re(m)aterializer/f(o)r-loop-pre-rewriter/\r\n  s(t)ructural simplifier/equi(v)alent function combiner/ssa re(V)erser/? \r\n  stack com(p)ressor? \r\nt\r\n t\r\n----------------------\r\n{\r\n    foo(calldataload(0))\r\n    function foo(x)\r\n    {\r\n        if eq(\"\", x)\r\n        {\r\n            sstore(1, 1)\r\n        }\r\n    }\r\n}\r\n```",
  "closed_by": {
    "login": "chriseth",
    "id": 9073706,
    "node_id": "MDQ6VXNlcjkwNzM3MDY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/9073706?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/chriseth",
    "html_url": "https://github.com/chriseth",
    "followers_url": "https://api.github.com/users/chriseth/followers",
    "following_url": "https://api.github.com/users/chriseth/following{/other_user}",
    "gists_url": "https://api.github.com/users/chriseth/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/chriseth/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/chriseth/subscriptions",
    "organizations_url": "https://api.github.com/users/chriseth/orgs",
    "repos_url": "https://api.github.com/users/chriseth/repos",
    "events_url": "https://api.github.com/users/chriseth/events{/privacy}",
    "received_events_url": "https://api.github.com/users/chriseth/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/6359/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/solidity/issues/6359/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/476141263",
    "html_url": "https://github.com/ethereum/solidity/issues/6359#issuecomment-476141263",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/6359",
    "id": 476141263,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ3NjE0MTI2Mw==",
    "user": {
      "login": "axic",
      "id": 20340,
      "node_id": "MDQ6VXNlcjIwMzQw",
      "avatar_url": "https://avatars.githubusercontent.com/u/20340?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/axic",
      "html_url": "https://github.com/axic",
      "followers_url": "https://api.github.com/users/axic/followers",
      "following_url": "https://api.github.com/users/axic/following{/other_user}",
      "gists_url": "https://api.github.com/users/axic/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/axic/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/axic/subscriptions",
      "organizations_url": "https://api.github.com/users/axic/orgs",
      "repos_url": "https://api.github.com/users/axic/repos",
      "events_url": "https://api.github.com/users/axic/events{/privacy}",
      "received_events_url": "https://api.github.com/users/axic/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-03-25T10:42:04Z",
    "updated_at": "2019-03-25T10:42:04Z",
    "author_association": "MEMBER",
    "body": "> The underlying problem seems to be supporting case literals of mixed types (string and uint) that are handled differently in switch statements and if statement (and possibly others).\r\n\r\nThey are not supposed to be mixed, but we do not have type validation implemented yet ðŸ˜¢ ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/476141263/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/476147969",
    "html_url": "https://github.com/ethereum/solidity/issues/6359#issuecomment-476147969",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/6359",
    "id": 476147969,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ3NjE0Nzk2OQ==",
    "user": {
      "login": "chriseth",
      "id": 9073706,
      "node_id": "MDQ6VXNlcjkwNzM3MDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9073706?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chriseth",
      "html_url": "https://github.com/chriseth",
      "followers_url": "https://api.github.com/users/chriseth/followers",
      "following_url": "https://api.github.com/users/chriseth/following{/other_user}",
      "gists_url": "https://api.github.com/users/chriseth/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chriseth/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chriseth/subscriptions",
      "organizations_url": "https://api.github.com/users/chriseth/orgs",
      "repos_url": "https://api.github.com/users/chriseth/repos",
      "events_url": "https://api.github.com/users/chriseth/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chriseth/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-03-25T11:01:16Z",
    "updated_at": "2019-03-25T11:01:16Z",
    "author_association": "MEMBER",
    "body": "Actually we can use `valueOfLiteral`",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/476147969/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
