{
  "url": "https://api.github.com/repos/ethereum/solidity/issues/7125",
  "repository_url": "https://api.github.com/repos/ethereum/solidity",
  "labels_url": "https://api.github.com/repos/ethereum/solidity/issues/7125/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/solidity/issues/7125/comments",
  "events_url": "https://api.github.com/repos/ethereum/solidity/issues/7125/events",
  "html_url": "https://github.com/ethereum/solidity/issues/7125",
  "id": 469647604,
  "node_id": "MDU6SXNzdWU0Njk2NDc2MDQ=",
  "number": 7125,
  "title": "[Testing] Discussion about test case checked in for msize optimization",
  "user": {
    "login": "bshastry",
    "id": 2388185,
    "node_id": "MDQ6VXNlcjIzODgxODU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2388185?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/bshastry",
    "html_url": "https://github.com/bshastry",
    "followers_url": "https://api.github.com/users/bshastry/followers",
    "following_url": "https://api.github.com/users/bshastry/following{/other_user}",
    "gists_url": "https://api.github.com/users/bshastry/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/bshastry/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/bshastry/subscriptions",
    "organizations_url": "https://api.github.com/users/bshastry/orgs",
    "repos_url": "https://api.github.com/users/bshastry/repos",
    "events_url": "https://api.github.com/users/bshastry/events{/privacy}",
    "received_events_url": "https://api.github.com/users/bshastry/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2019-07-18T08:53:02Z",
  "updated_at": "2019-07-18T18:12:12Z",
  "closed_at": "2019-07-18T18:12:12Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nThis issue discusses the test case checked in by PR #7106 \r\n\r\nhttps://github.com/ethereum/solidity/blob/a0a0a34a21072a61fc6e1732833fb18fc9bec0f8/test/libyul/yulOptimizerTests/stackCompressor/unusedPrunerWithMSize.yul#L1-L20\r\n\r\nThis test case does not demonstrate a difference in yul execution traces between unoptimized and optimized versions.\r\n\r\nReproduction:\r\n\r\n```\r\n$ cd solidity\r\n// One commit hash before the referenced PR was merged into develop\r\n$ git checkout dd031ed\r\n$ mkdir build && cd build\r\n$ cmake ..\r\n$ make solc yulrun\r\n```\r\n\r\nTrace of unoptimized test case is\r\n```\r\n$ yulrun --input-file <path_to_testcase>.yul\r\nTrace:\r\n  EXTCODECOPY(1, 32, 1, 1)\r\nMemory dump:\r\n     0: 0000000000000000000000000000000000000000000000000000000000000001\r\n    20: 6f00000000000000000000000000000000000000000000000000000000000000\r\nStorage dump:\r\n```\r\n\r\nLet's optimize the test case using solc\r\n```\r\n$ solc --strict-assembly --optimize <path_to_test_case>.yul\r\n...\r\n    code {\r\n        {\r\n            let _1 := pc()\r\n            let _2 := pc()\r\n            let _3 := pc()\r\n            let _4 := pc()\r\n            let _5 := pc()\r\n            pop(keccak256(1, 2))\r\n            let _6 := not(0)\r\n            mstore(lt(or(gt(1, or(or(gt(or(or(or(gt(or(gt(_6, _5), 1), \r\n_4), lt(or(1, add(_3, _6)), 1)), _2), 1), 1), gt(not(_1), 1)), 1)), 1),\r\n 1), 1)\r\n            extcodecopy(1, msize(), 1, 1)\r\n        }\r\n    }\r\n...\r\n```\r\n\r\nNow, let's trace the optimized yul code above.\r\n\r\n```\r\n$ yulrun --input-file <optimized_yul_code>.yul\r\nTrace:\r\n  EXTCODECOPY(1, 32, 1, 1)\r\nMemory dump:\r\n     0: 0000000000000000000000000000000000000000000000000000000000000001\r\n    20: 6f00000000000000000000000000000000000000000000000000000000000000\r\nStorage dump:\r\n```\r\n\r\nThe two traces match and hence the checked in test case passes on the unpatched version of UnunsedPruner.",
  "closed_by": {
    "login": "chriseth",
    "id": 9073706,
    "node_id": "MDQ6VXNlcjkwNzM3MDY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/9073706?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/chriseth",
    "html_url": "https://github.com/chriseth",
    "followers_url": "https://api.github.com/users/chriseth/followers",
    "following_url": "https://api.github.com/users/chriseth/following{/other_user}",
    "gists_url": "https://api.github.com/users/chriseth/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/chriseth/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/chriseth/subscriptions",
    "organizations_url": "https://api.github.com/users/chriseth/orgs",
    "repos_url": "https://api.github.com/users/chriseth/repos",
    "events_url": "https://api.github.com/users/chriseth/events{/privacy}",
    "received_events_url": "https://api.github.com/users/chriseth/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/7125/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/solidity/issues/7125/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/512750578",
    "html_url": "https://github.com/ethereum/solidity/issues/7125#issuecomment-512750578",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/7125",
    "id": 512750578,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUxMjc1MDU3OA==",
    "user": {
      "login": "chriseth",
      "id": 9073706,
      "node_id": "MDQ6VXNlcjkwNzM3MDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9073706?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chriseth",
      "html_url": "https://github.com/chriseth",
      "followers_url": "https://api.github.com/users/chriseth/followers",
      "following_url": "https://api.github.com/users/chriseth/following{/other_user}",
      "gists_url": "https://api.github.com/users/chriseth/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chriseth/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chriseth/subscriptions",
      "organizations_url": "https://api.github.com/users/chriseth/orgs",
      "repos_url": "https://api.github.com/users/chriseth/repos",
      "events_url": "https://api.github.com/users/chriseth/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chriseth/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-07-18T10:00:10Z",
    "updated_at": "2019-07-18T10:00:10Z",
    "author_association": "MEMBER",
    "body": "OK, I think I can explain this: If you run the full optimizer suite, it will inline the function before it runs the stack compressor. For the bug to be triggered, the `msize` instruction needs to be inside a function and the memory-size-modifying instruction needs to be outside of that function.\r\n\r\nThe test case, though, directly runs the stack compressor without first running the other steps. Because of that, the test fails without the fix.\r\n\r\nIf you want, I can still add the full test.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/512750578/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/512760039",
    "html_url": "https://github.com/ethereum/solidity/issues/7125#issuecomment-512760039",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/7125",
    "id": 512760039,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUxMjc2MDAzOQ==",
    "user": {
      "login": "bshastry",
      "id": 2388185,
      "node_id": "MDQ6VXNlcjIzODgxODU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2388185?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bshastry",
      "html_url": "https://github.com/bshastry",
      "followers_url": "https://api.github.com/users/bshastry/followers",
      "following_url": "https://api.github.com/users/bshastry/following{/other_user}",
      "gists_url": "https://api.github.com/users/bshastry/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bshastry/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bshastry/subscriptions",
      "organizations_url": "https://api.github.com/users/bshastry/orgs",
      "repos_url": "https://api.github.com/users/bshastry/repos",
      "events_url": "https://api.github.com/users/bshastry/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bshastry/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-07-18T10:29:28Z",
    "updated_at": "2019-07-18T10:29:28Z",
    "author_association": "MEMBER",
    "body": "Ah I see. Thanks for the clarification. It may still be nice to add the full test to `test/libyul/yulOptimizerTests/fullSuite` so that we catch potential regressions in the full suite.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/512760039/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
