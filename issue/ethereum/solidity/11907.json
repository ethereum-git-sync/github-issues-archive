{
  "url": "https://api.github.com/repos/ethereum/solidity/issues/11907",
  "repository_url": "https://api.github.com/repos/ethereum/solidity",
  "labels_url": "https://api.github.com/repos/ethereum/solidity/issues/11907/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/solidity/issues/11907/comments",
  "events_url": "https://api.github.com/repos/ethereum/solidity/issues/11907/events",
  "html_url": "https://github.com/ethereum/solidity/issues/11907",
  "id": 989829565,
  "node_id": "MDU6SXNzdWU5ODk4Mjk1NjU=",
  "number": 11907,
  "title": "Solve nondeterminism about AST IDs",
  "user": {
    "login": "chriseth",
    "id": 9073706,
    "node_id": "MDQ6VXNlcjkwNzM3MDY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/9073706?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/chriseth",
    "html_url": "https://github.com/chriseth",
    "followers_url": "https://api.github.com/users/chriseth/followers",
    "following_url": "https://api.github.com/users/chriseth/following{/other_user}",
    "gists_url": "https://api.github.com/users/chriseth/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/chriseth/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/chriseth/subscriptions",
    "organizations_url": "https://api.github.com/users/chriseth/orgs",
    "repos_url": "https://api.github.com/users/chriseth/repos",
    "events_url": "https://api.github.com/users/chriseth/events{/privacy}",
    "received_events_url": "https://api.github.com/users/chriseth/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 9,
  "created_at": "2021-09-07T10:20:17Z",
  "updated_at": "2021-09-08T17:53:34Z",
  "closed_at": "2021-09-08T17:53:34Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "The nondeterminism about AST IDs will always hurt us, and we should solve it once and for all.\r\n\r\nThe problem is that when you compile multiple unrelated files, the AST IDs get assigned uniquely for the whole compilation run.\r\nThis can result in different code depending on whether you compile a file in isolation or together with other files for the following reason:\r\n\r\nThese AST IDs are used in the code generator to create unique function names (for example for struct types in the ABI routines).\r\nWe are currently trying to strip the AST IDs as much as possible as long as the function names are still unique, but if this fails, it can happen that functions are sorted differently and thus the optimizer handles them in a different order or they are just laid out differently in the final code.\r\n\r\nProposals to overcome this problem:\r\n\r\nMake AST IDs two-dimensional where the first dimension depends on the file. This can be the file name or the hash of the file content.\r\n\r\nThe problem here is that these IDs get very long and also it is a breaking change. We can keep the current AST IDs for anything that is not related to code generation. The length could be dealt with by specially marking those AST IDs in function names and reducing their length in the NameSimplifier (we already do something like that there). The NameSimplifier could start with one pass where it just collects all prefixes and replaces them with unique and shorter identifiers (either prefixes or just newly created numbers starting from 1).\r\n\r\n",
  "closed_by": {
    "login": "chriseth",
    "id": 9073706,
    "node_id": "MDQ6VXNlcjkwNzM3MDY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/9073706?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/chriseth",
    "html_url": "https://github.com/chriseth",
    "followers_url": "https://api.github.com/users/chriseth/followers",
    "following_url": "https://api.github.com/users/chriseth/following{/other_user}",
    "gists_url": "https://api.github.com/users/chriseth/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/chriseth/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/chriseth/subscriptions",
    "organizations_url": "https://api.github.com/users/chriseth/orgs",
    "repos_url": "https://api.github.com/users/chriseth/repos",
    "events_url": "https://api.github.com/users/chriseth/events{/privacy}",
    "received_events_url": "https://api.github.com/users/chriseth/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/11907/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/solidity/issues/11907/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/914187071",
    "html_url": "https://github.com/ethereum/solidity/issues/11907#issuecomment-914187071",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/11907",
    "id": 914187071,
    "node_id": "IC_kwDOAm_5kc42fWM_",
    "user": {
      "login": "ekpyron",
      "id": 1347491,
      "node_id": "MDQ6VXNlcjEzNDc0OTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1347491?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ekpyron",
      "html_url": "https://github.com/ekpyron",
      "followers_url": "https://api.github.com/users/ekpyron/followers",
      "following_url": "https://api.github.com/users/ekpyron/following{/other_user}",
      "gists_url": "https://api.github.com/users/ekpyron/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ekpyron/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ekpyron/subscriptions",
      "organizations_url": "https://api.github.com/users/ekpyron/orgs",
      "repos_url": "https://api.github.com/users/ekpyron/repos",
      "events_url": "https://api.github.com/users/ekpyron/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ekpyron/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-09-07T10:26:27Z",
    "updated_at": "2021-09-07T10:28:01Z",
    "author_association": "MEMBER",
    "body": "We do generate code per-contract - can't we just have a mapping \"global ID -> contract-local ID\" that maps our current IDs to a new counter that is per-contract and increments based on codegen visit order, resp. first use in codegen? You considered that yourself earlier, not sure what made you drop the idea...\r\nEspecially, if we want to keep the current IDs for everything except codegen anyways.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/914187071/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/914188608",
    "html_url": "https://github.com/ethereum/solidity/issues/11907#issuecomment-914188608",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/11907",
    "id": 914188608,
    "node_id": "IC_kwDOAm_5kc42fWlA",
    "user": {
      "login": "chriseth",
      "id": 9073706,
      "node_id": "MDQ6VXNlcjkwNzM3MDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9073706?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chriseth",
      "html_url": "https://github.com/chriseth",
      "followers_url": "https://api.github.com/users/chriseth/followers",
      "following_url": "https://api.github.com/users/chriseth/following{/other_user}",
      "gists_url": "https://api.github.com/users/chriseth/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chriseth/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chriseth/subscriptions",
      "organizations_url": "https://api.github.com/users/chriseth/orgs",
      "repos_url": "https://api.github.com/users/chriseth/repos",
      "events_url": "https://api.github.com/users/chriseth/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chriseth/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-09-07T10:28:56Z",
    "updated_at": "2021-09-07T10:28:56Z",
    "author_association": "MEMBER",
    "body": "Yes, that is the other way to do it. I'm a bit uneasy about the codegen visit order, and it would require `Type::toString()` to have access to this translation table.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/914188608/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/914189438",
    "html_url": "https://github.com/ethereum/solidity/issues/11907#issuecomment-914189438",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/11907",
    "id": 914189438,
    "node_id": "IC_kwDOAm_5kc42fWx-",
    "user": {
      "login": "chriseth",
      "id": 9073706,
      "node_id": "MDQ6VXNlcjkwNzM3MDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9073706?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chriseth",
      "html_url": "https://github.com/chriseth",
      "followers_url": "https://api.github.com/users/chriseth/followers",
      "following_url": "https://api.github.com/users/chriseth/following{/other_user}",
      "gists_url": "https://api.github.com/users/chriseth/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chriseth/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chriseth/subscriptions",
      "organizations_url": "https://api.github.com/users/chriseth/orgs",
      "repos_url": "https://api.github.com/users/chriseth/repos",
      "events_url": "https://api.github.com/users/chriseth/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chriseth/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-09-07T10:30:14Z",
    "updated_at": "2021-09-07T10:30:14Z",
    "author_association": "MEMBER",
    "body": "Ah sorry, it's `Type::richIdentifier()`, and we could actually provide the mapping.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/914189438/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/914190146",
    "html_url": "https://github.com/ethereum/solidity/issues/11907#issuecomment-914190146",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/11907",
    "id": 914190146,
    "node_id": "IC_kwDOAm_5kc42fW9C",
    "user": {
      "login": "chriseth",
      "id": 9073706,
      "node_id": "MDQ6VXNlcjkwNzM3MDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9073706?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chriseth",
      "html_url": "https://github.com/chriseth",
      "followers_url": "https://api.github.com/users/chriseth/followers",
      "following_url": "https://api.github.com/users/chriseth/following{/other_user}",
      "gists_url": "https://api.github.com/users/chriseth/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chriseth/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chriseth/subscriptions",
      "organizations_url": "https://api.github.com/users/chriseth/orgs",
      "repos_url": "https://api.github.com/users/chriseth/repos",
      "events_url": "https://api.github.com/users/chriseth/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chriseth/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-09-07T10:31:22Z",
    "updated_at": "2021-09-07T10:31:22Z",
    "author_association": "MEMBER",
    "body": "In\r\n```\r\n\tstring functionName =\r\n\t\t\"abi_encode_\" +\r\n\t\t_from.identifier() +\r\n\t\t\"_to_\" +\r\n\t\tto.identifier() +\r\n\t\t_options.toFunctionNameSuffix();\r\n```\r\nThis might lead to `.identifier()` allocating a new ID, which means that the new ID will depend on the order in which this C++ expression is evaluated.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/914190146/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/914190539",
    "html_url": "https://github.com/ethereum/solidity/issues/11907#issuecomment-914190539",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/11907",
    "id": 914190539,
    "node_id": "IC_kwDOAm_5kc42fXDL",
    "user": {
      "login": "ekpyron",
      "id": 1347491,
      "node_id": "MDQ6VXNlcjEzNDc0OTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1347491?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ekpyron",
      "html_url": "https://github.com/ekpyron",
      "followers_url": "https://api.github.com/users/ekpyron/followers",
      "following_url": "https://api.github.com/users/ekpyron/following{/other_user}",
      "gists_url": "https://api.github.com/users/ekpyron/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ekpyron/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ekpyron/subscriptions",
      "organizations_url": "https://api.github.com/users/ekpyron/orgs",
      "repos_url": "https://api.github.com/users/ekpyron/repos",
      "events_url": "https://api.github.com/users/ekpyron/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ekpyron/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-09-07T10:32:01Z",
    "updated_at": "2021-09-07T10:32:01Z",
    "author_association": "MEMBER",
    "body": "It's not exactly beautiful to pass a mapping to ``richIdentifier``, but yeah, should work.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/914190539/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/914193283",
    "html_url": "https://github.com/ethereum/solidity/issues/11907#issuecomment-914193283",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/11907",
    "id": 914193283,
    "node_id": "IC_kwDOAm_5kc42fXuD",
    "user": {
      "login": "ekpyron",
      "id": 1347491,
      "node_id": "MDQ6VXNlcjEzNDc0OTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1347491?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ekpyron",
      "html_url": "https://github.com/ekpyron",
      "followers_url": "https://api.github.com/users/ekpyron/followers",
      "following_url": "https://api.github.com/users/ekpyron/following{/other_user}",
      "gists_url": "https://api.github.com/users/ekpyron/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ekpyron/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ekpyron/subscriptions",
      "organizations_url": "https://api.github.com/users/ekpyron/orgs",
      "repos_url": "https://api.github.com/users/ekpyron/repos",
      "events_url": "https://api.github.com/users/ekpyron/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ekpyron/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-09-07T10:36:38Z",
    "updated_at": "2021-09-07T10:36:38Z",
    "author_association": "MEMBER",
    "body": "> In\r\n> \r\n> ```\r\n> \tstring functionName =\r\n> \t\t\"abi_encode_\" +\r\n> \t\t_from.identifier() +\r\n> \t\t\"_to_\" +\r\n> \t\tto.identifier() +\r\n> \t\t_options.toFunctionNameSuffix();\r\n> ```\r\n> \r\n> This might lead to `.identifier()` allocating a new ID, which means that the new ID will depend on the order in which this C++ expression is evaluated.\r\n\r\nYeah, that indeed makes it extremely error-prone...",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/914193283/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/914429733",
    "html_url": "https://github.com/ethereum/solidity/issues/11907#issuecomment-914429733",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/11907",
    "id": 914429733,
    "node_id": "IC_kwDOAm_5kc42gRcl",
    "user": {
      "login": "chriseth",
      "id": 9073706,
      "node_id": "MDQ6VXNlcjkwNzM3MDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9073706?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chriseth",
      "html_url": "https://github.com/chriseth",
      "followers_url": "https://api.github.com/users/chriseth/followers",
      "following_url": "https://api.github.com/users/chriseth/following{/other_user}",
      "gists_url": "https://api.github.com/users/chriseth/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chriseth/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chriseth/subscriptions",
      "organizations_url": "https://api.github.com/users/chriseth/orgs",
      "repos_url": "https://api.github.com/users/chriseth/repos",
      "events_url": "https://api.github.com/users/chriseth/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chriseth/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-09-07T15:58:48Z",
    "updated_at": "2021-09-07T15:58:48Z",
    "author_association": "MEMBER",
    "body": "It turns out that it might be better to make (a) the sol -> yul code generator output code that only depends on solidity source order and (b) check that the yul (util) function generation is deterministic. This is done in https://github.com/ethereum/solidity/pull/11910",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/914429733/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/914448095",
    "html_url": "https://github.com/ethereum/solidity/issues/11907#issuecomment-914448095",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/11907",
    "id": 914448095,
    "node_id": "IC_kwDOAm_5kc42gV7f",
    "user": {
      "login": "axic",
      "id": 20340,
      "node_id": "MDQ6VXNlcjIwMzQw",
      "avatar_url": "https://avatars.githubusercontent.com/u/20340?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/axic",
      "html_url": "https://github.com/axic",
      "followers_url": "https://api.github.com/users/axic/followers",
      "following_url": "https://api.github.com/users/axic/following{/other_user}",
      "gists_url": "https://api.github.com/users/axic/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/axic/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/axic/subscriptions",
      "organizations_url": "https://api.github.com/users/axic/orgs",
      "repos_url": "https://api.github.com/users/axic/repos",
      "events_url": "https://api.github.com/users/axic/events{/privacy}",
      "received_events_url": "https://api.github.com/users/axic/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-09-07T16:23:34Z",
    "updated_at": "2021-09-07T16:23:34Z",
    "author_association": "MEMBER",
    "body": "> The problem here is that these IDs get very long and also it is a breaking change.\r\n\r\nWhy not take a truncated hash as the ID of the two-level ID?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/914448095/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/915447538",
    "html_url": "https://github.com/ethereum/solidity/issues/11907#issuecomment-915447538",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/11907",
    "id": 915447538,
    "node_id": "IC_kwDOAm_5kc42kJ7y",
    "user": {
      "login": "chriseth",
      "id": 9073706,
      "node_id": "MDQ6VXNlcjkwNzM3MDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9073706?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chriseth",
      "html_url": "https://github.com/chriseth",
      "followers_url": "https://api.github.com/users/chriseth/followers",
      "following_url": "https://api.github.com/users/chriseth/following{/other_user}",
      "gists_url": "https://api.github.com/users/chriseth/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chriseth/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chriseth/subscriptions",
      "organizations_url": "https://api.github.com/users/chriseth/orgs",
      "repos_url": "https://api.github.com/users/chriseth/repos",
      "events_url": "https://api.github.com/users/chriseth/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chriseth/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-09-08T17:53:34Z",
    "updated_at": "2021-09-08T17:53:34Z",
    "author_association": "MEMBER",
    "body": "Hopefully solved by not making anything depend on names at all.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/915447538/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
