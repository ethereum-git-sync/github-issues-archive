{
  "url": "https://api.github.com/repos/ethereum/solidity/issues/11411",
  "repository_url": "https://api.github.com/repos/ethereum/solidity",
  "labels_url": "https://api.github.com/repos/ethereum/solidity/issues/11411/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/solidity/issues/11411/comments",
  "events_url": "https://api.github.com/repos/ethereum/solidity/issues/11411/events",
  "html_url": "https://github.com/ethereum/solidity/issues/11411",
  "id": 894934636,
  "node_id": "MDU6SXNzdWU4OTQ5MzQ2MzY=",
  "number": 11411,
  "title": "Import path normalization (path spec v3)",
  "user": {
    "login": "cameel",
    "id": 137030,
    "node_id": "MDQ6VXNlcjEzNzAzMA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/cameel",
    "html_url": "https://github.com/cameel",
    "followers_url": "https://api.github.com/users/cameel/followers",
    "following_url": "https://api.github.com/users/cameel/following{/other_user}",
    "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
    "organizations_url": "https://api.github.com/users/cameel/orgs",
    "repos_url": "https://api.github.com/users/cameel/repos",
    "events_url": "https://api.github.com/users/cameel/events{/privacy}",
    "received_events_url": "https://api.github.com/users/cameel/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 467898404,
      "node_id": "MDU6TGFiZWw0Njc4OTg0MDQ=",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/breaking%20change%20:warning:",
      "name": "breaking change :warning:",
      "color": "b60205",
      "default": false,
      "description": ""
    },
    {
      "id": 4438006499,
      "node_id": "LA_kwDOAm_5kc8AAAABCIaa4w",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/low%20effort",
      "name": "low effort",
      "color": "ffb1fa",
      "default": false,
      "description": "There is not much implementation work to be done. The task is very easy or tiny."
    },
    {
      "id": 4438155599,
      "node_id": "LA_kwDOAm_5kc8AAAABCIjhTw",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/medium%20impact",
      "name": "medium impact",
      "color": "314aff",
      "default": false,
      "description": "Default level of impact"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2021-05-19T02:43:53Z",
  "updated_at": "2022-09-27T18:48:49Z",
  "closed_at": null,
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "Closes #5146.\r\nRelated to #2738.\r\nPart of a set of issues that replaces #11138.\r\n\r\n## Abstract\r\nCompiler's virtual filesystem currently makes very little assumptions about source unit names. Nearly anything is allowed and different names that would refer to the same file in the actual filesystem are considered different. This is not intuitive to users who mostly expect import paths to work like paths in their filesystem.\r\n\r\nThis proposal introduces some preprocessing for import paths to better match user expectations while still preserving the rule that different keys in the VFS always represent different source units. It also forbids non-normalized source unit names in the VFS because it will no longer be possible to have imports that match them.\r\n\r\nThe new rules do not apply to import paths that look like URLs since these may have wildly different semantics depending on the protocol.\r\n\r\n## Motivation\r\n### Same file being compiled multiple times\r\nOne of the problems caused by allowing non-normalized paths is the compiler loading and compiling the same file multiple times. At best it just wastes resources. At worst it can lead to hard to understand errors caused by the compiler seeing duplicate definitions.\r\n\r\n### Unintuitive results of normalization in corner cases\r\nAnother reason is getting rid of the weird corner cases related to relative imports. Relative imports (i.e. imports starting with `./` or `../`) are treated in a special way by the compiler. Unlike direct imports, relative imports undergo some minimal processing. The compiler takes the source unit name of the importing file, strips the number of path segments corresponding to the number of leading `../` segments in the import path, normalizes the **import path** and then combines the two. The source unit name of the **importing file** is **not** normalized. This ensures that relative imports work properly when the importing file is identified with a URL.\r\n\r\nFor example, assuming that you have a file with source unit name of `https://example.com/contract.sol`, containing:\r\n```solidity\r\nimport \"./token.sol\"; // source unit name: https://example.com/token.sol\r\n```\r\n\r\nIf the parent source unit name were to be normalized, the name would become `https:/example.com/token.sol` instead, which is not a valid URL.\r\n\r\nOn the other hand, this leads to surprising results in corner cases. For example `../` segments are treated as normal path segments and get canceled by ``../`` segments in the import path.\r\n\r\n`/project/./lib/contract.sol`:\r\n```solidity\r\nimport \"../util.sol\";       // source unit name: /project/./util.sol\r\nimport \"../../util.sol\";    // source unit name: /project/util.sol\r\nimport \"../../../util.sol\"; // source unit name: /util.sol\r\n```\r\n\r\n### URLs\r\nThe reason behind exempting URLs from this is that in some schemes `./` and `../` sequences might not represent path segments. We do not want to forbid such URLs but we also do not want to hard-code rules for each particular protocol into the compiler.\r\n\r\nFor this reason even after this change it will still be possible to run into the unintuitive normalization mentioned above with e.g. `file://` or `https://` URLs. `file://` urls are not really recommended though and with `https://` it's up to the server to interpret `../` - if it happens to be a part of the URL, it might not really represent going up in the directory hierarachy so the proposed normalization would not necessarily be desirable for such URLs anyway.\r\n\r\n## Specification\r\nWhen converting an import path that does not have a `protocol://` prefix (where `protocol` is an arbitrary URL protocol) into a source unit name:\r\n- Collapse any non-leading `./` and `../` segments.\r\n    - For relative imports this should be performed before replacing the leading `./` and `../` segments with the source unit name of the importing file.\r\n    - Report an error if not all the `../` segments can be collapsed. E.g. for `x/y/../../../contract.sol` or `../x/../../contract.sol`.\r\n- Squash every sequence of multiple consecutive slashes into a single slash.\r\n\r\nIn the virtual filesystem disallow source unit names that do not have a `protocol://` prefix and contain:\r\n- Any number of `./` or `../` segments.\r\n- Multiple consecutive slashes.\r\n\r\n## Backwards Compatibility\r\nThe change is not fully backwards-compatible:\r\n- `import \"a/../../b.sol\"` will be disallowed. Currently it's a valid import.\r\n- Any tools that rely on being able to use source unit names containing `./` and `../` segments or consecutive slashes outside of URLs in Standard JSON will need adjustment.\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/11411/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/solidity/issues/11411/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/844898555",
    "html_url": "https://github.com/ethereum/solidity/issues/11411#issuecomment-844898555",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/11411",
    "id": 844898555,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg0NDg5ODU1NQ==",
    "user": {
      "login": "chriseth",
      "id": 9073706,
      "node_id": "MDQ6VXNlcjkwNzM3MDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9073706?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chriseth",
      "html_url": "https://github.com/chriseth",
      "followers_url": "https://api.github.com/users/chriseth/followers",
      "following_url": "https://api.github.com/users/chriseth/following{/other_user}",
      "gists_url": "https://api.github.com/users/chriseth/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chriseth/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chriseth/subscriptions",
      "organizations_url": "https://api.github.com/users/chriseth/orgs",
      "repos_url": "https://api.github.com/users/chriseth/repos",
      "events_url": "https://api.github.com/users/chriseth/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chriseth/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-05-20T09:15:49Z",
    "updated_at": "2021-05-20T09:15:49Z",
    "author_association": "MEMBER",
    "body": "To be honest, I would prefer the simpler solution where it is just an error to have a non-leading `.` or `..` component inside an import path.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/844898555/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/848703865",
    "html_url": "https://github.com/ethereum/solidity/issues/11411#issuecomment-848703865",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/11411",
    "id": 848703865,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg0ODcwMzg2NQ==",
    "user": {
      "login": "cameel",
      "id": 137030,
      "node_id": "MDQ6VXNlcjEzNzAzMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cameel",
      "html_url": "https://github.com/cameel",
      "followers_url": "https://api.github.com/users/cameel/followers",
      "following_url": "https://api.github.com/users/cameel/following{/other_user}",
      "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
      "organizations_url": "https://api.github.com/users/cameel/orgs",
      "repos_url": "https://api.github.com/users/cameel/repos",
      "events_url": "https://api.github.com/users/cameel/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cameel/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-05-26T11:50:34Z",
    "updated_at": "2021-05-26T11:50:34Z",
    "author_association": "MEMBER",
    "body": "I'd be fine with that too but what about the other points?\r\n- Multiple slashes? I think we should either disallow or normalize them.\r\n- Leading `./` and `../` in the VFS? These create weird effects when you have relative imports and you can add them to the VFS only via Standard JSON anyway so it would not be a big loss in my opinion.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/848703865/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/849739697",
    "html_url": "https://github.com/ethereum/solidity/issues/11411#issuecomment-849739697",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/11411",
    "id": 849739697,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg0OTczOTY5Nw==",
    "user": {
      "login": "cameel",
      "id": 137030,
      "node_id": "MDQ6VXNlcjEzNzAzMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cameel",
      "html_url": "https://github.com/cameel",
      "followers_url": "https://api.github.com/users/cameel/followers",
      "following_url": "https://api.github.com/users/cameel/following{/other_user}",
      "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
      "organizations_url": "https://api.github.com/users/cameel/orgs",
      "repos_url": "https://api.github.com/users/cameel/repos",
      "events_url": "https://api.github.com/users/cameel/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cameel/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-05-27T15:42:56Z",
    "updated_at": "2021-05-27T15:42:56Z",
    "author_association": "MEMBER",
    "body": "We decided to put off work on this for now. We want to deal with #11408, #11409 and #11410 first and go back to this once that's done and working.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/849739697/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
