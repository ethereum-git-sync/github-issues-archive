{
  "url": "https://api.github.com/repos/ethereum/solidity/issues/11233",
  "repository_url": "https://api.github.com/repos/ethereum/solidity",
  "labels_url": "https://api.github.com/repos/ethereum/solidity/issues/11233/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/solidity/issues/11233/comments",
  "events_url": "https://api.github.com/repos/ethereum/solidity/issues/11233/events",
  "html_url": "https://github.com/ethereum/solidity/issues/11233",
  "id": 855104437,
  "node_id": "MDU6SXNzdWU4NTUxMDQ0Mzc=",
  "number": 11233,
  "title": "ICE in --ast-compact-json when --base-path affects an import path",
  "user": {
    "login": "cameel",
    "id": 137030,
    "node_id": "MDQ6VXNlcjEzNzAzMA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/cameel",
    "html_url": "https://github.com/cameel",
    "followers_url": "https://api.github.com/users/cameel/followers",
    "following_url": "https://api.github.com/users/cameel/following{/other_user}",
    "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
    "organizations_url": "https://api.github.com/users/cameel/orgs",
    "repos_url": "https://api.github.com/users/cameel/repos",
    "events_url": "https://api.github.com/users/cameel/events{/privacy}",
    "received_events_url": "https://api.github.com/users/cameel/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 249074435,
      "node_id": "MDU6TGFiZWwyNDkwNzQ0MzU=",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/bug%20:bug:",
      "name": "bug :bug:",
      "color": "fc1313",
      "default": false,
      "description": ""
    },
    {
      "id": 2376148917,
      "node_id": "MDU6TGFiZWwyMzc2MTQ4OTE3",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/should%20report%20better%20error",
      "name": "should report better error",
      "color": "53e0b5",
      "default": false,
      "description": "Error is just badly reported. Should be a proper type error - source is not fine."
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "cameel",
    "id": 137030,
    "node_id": "MDQ6VXNlcjEzNzAzMA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/cameel",
    "html_url": "https://github.com/cameel",
    "followers_url": "https://api.github.com/users/cameel/followers",
    "following_url": "https://api.github.com/users/cameel/following{/other_user}",
    "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
    "organizations_url": "https://api.github.com/users/cameel/orgs",
    "repos_url": "https://api.github.com/users/cameel/repos",
    "events_url": "https://api.github.com/users/cameel/events{/privacy}",
    "received_events_url": "https://api.github.com/users/cameel/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "cameel",
      "id": 137030,
      "node_id": "MDQ6VXNlcjEzNzAzMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cameel",
      "html_url": "https://github.com/cameel",
      "followers_url": "https://api.github.com/users/cameel/followers",
      "following_url": "https://api.github.com/users/cameel/following{/other_user}",
      "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
      "organizations_url": "https://api.github.com/users/cameel/orgs",
      "repos_url": "https://api.github.com/users/cameel/repos",
      "events_url": "https://api.github.com/users/cameel/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cameel/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2021-04-10T16:30:23Z",
  "updated_at": "2021-04-14T11:46:14Z",
  "closed_at": "2021-04-14T11:46:14Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "## Description\r\nWith `--ast-compact-json` the compiler apparently has trouble finding files when `--base-path` is used and crashes:\r\n\r\n``` bash\r\ncd /tmp\r\necho 'import \"contract2.sol\";' > contract1.sol\r\ntouch contract2.sol\r\n\r\nsolc contract1.sol --ast-compact-json --base-path /tmp\r\n```\r\n```\r\nException during output generation: /solidity/libsolidity/interface/CompilerStack.cpp(1416): Throw in function const solidity::frontend::CompilerStack::Source& solidity::frontend::CompilerStack::source(const string&) const\r\nDynamic exception type: boost::wrapexcept<solidity::langutil::CompilerError>\r\nstd::exception::what: Given source file not found.\r\n[solidity::util::tag_comment*] = Given source file not found.\r\n```\r\n\r\nInterestingly, as can be seen above, the crash happens despite the fact that `contract2.sol` should resolve to the same file with and without `--base-path /tmp`, since `/tmp` is the current working directory.\r\n\r\nRemoving `--base-path` option from the command resolves the problem.\r\n\r\n## Environment\r\n\r\n- Compiler version: 0.8.3\r\n- Operating system: Arch Linux",
  "closed_by": {
    "login": "christianparpart",
    "id": 56763,
    "node_id": "MDQ6VXNlcjU2NzYz",
    "avatar_url": "https://avatars.githubusercontent.com/u/56763?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/christianparpart",
    "html_url": "https://github.com/christianparpart",
    "followers_url": "https://api.github.com/users/christianparpart/followers",
    "following_url": "https://api.github.com/users/christianparpart/following{/other_user}",
    "gists_url": "https://api.github.com/users/christianparpart/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/christianparpart/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/christianparpart/subscriptions",
    "organizations_url": "https://api.github.com/users/christianparpart/orgs",
    "repos_url": "https://api.github.com/users/christianparpart/repos",
    "events_url": "https://api.github.com/users/christianparpart/events{/privacy}",
    "received_events_url": "https://api.github.com/users/christianparpart/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/11233/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/solidity/issues/11233/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/817174492",
    "html_url": "https://github.com/ethereum/solidity/issues/11233#issuecomment-817174492",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/11233",
    "id": 817174492,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgxNzE3NDQ5Mg==",
    "user": {
      "login": "cameel",
      "id": 137030,
      "node_id": "MDQ6VXNlcjEzNzAzMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cameel",
      "html_url": "https://github.com/cameel",
      "followers_url": "https://api.github.com/users/cameel/followers",
      "following_url": "https://api.github.com/users/cameel/following{/other_user}",
      "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
      "organizations_url": "https://api.github.com/users/cameel/orgs",
      "repos_url": "https://api.github.com/users/cameel/repos",
      "events_url": "https://api.github.com/users/cameel/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cameel/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-04-10T17:24:13Z",
    "updated_at": "2021-04-10T17:26:32Z",
    "author_association": "MEMBER",
    "body": "I just noticed that the same thing happens when using `file://` prefix in imports.\r\n\r\nLooking at the stack trace, the crash happens in `CommandLineInterface::handleAst()`, when it tries to get AST corresponding to a file that has been loaded by the compiler:\r\nhttps://github.com/ethereum/solidity/blob/124db22f04be119da2dd09153a4cf3ff68a511b5/solc/CommandLineInterface.cpp#L1714\r\n\r\nI think that the source of the problem is the fact that the [file loader callback](https://github.com/ethereum/solidity/blob/develop/libsolidity/interface/FileReader.cpp#L45-L95) associates the loaded source with a different name than `CompilerStack`. `CompilerStack` just directly uses the path from the import while the callback uses the actual filesystem path, with base path prepended and `file://` stripped:\r\nhttps://github.com/ethereum/solidity/blob/124db22f04be119da2dd09153a4cf3ff68a511b5/libsolidity/interface/FileReader.cpp#L54-L58\r\nhttps://github.com/ethereum/solidity/blob/124db22f04be119da2dd09153a4cf3ff68a511b5/libsolidity/interface/FileReader.cpp#L84\r\n\r\nWhen `handleAst()` then iterates over the loaded sources, this mismatch results in it trying to get an AST under a name not recognized by `CompilerStack`. This happens only for imported files because those specified explicitly on the CLI do not go through the callback and their names are identical in both places.\r\n\r\nI think that this bug can even result in the wrong AST being printed if there happens to already be some source under the wrong name.\r\n\r\nThe best solution is probably using the same name in both places, but I have an impression that this weird callback behavior is by design so changing it might break something else (and we don't have good test coverage for the CLI so breakage might go undetected).",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/817174492/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/817190292",
    "html_url": "https://github.com/ethereum/solidity/issues/11233#issuecomment-817190292",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/11233",
    "id": 817190292,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgxNzE5MDI5Mg==",
    "user": {
      "login": "cameel",
      "id": 137030,
      "node_id": "MDQ6VXNlcjEzNzAzMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cameel",
      "html_url": "https://github.com/cameel",
      "followers_url": "https://api.github.com/users/cameel/followers",
      "following_url": "https://api.github.com/users/cameel/following{/other_user}",
      "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
      "organizations_url": "https://api.github.com/users/cameel/orgs",
      "repos_url": "https://api.github.com/users/cameel/repos",
      "events_url": "https://api.github.com/users/cameel/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cameel/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-04-10T19:20:23Z",
    "updated_at": "2021-04-10T19:20:23Z",
    "author_association": "MEMBER",
    "body": "Same problem with `--combined-json`:\r\n```\r\ncd /tmp\r\necho 'import \"contract2.sol\";' > contract1.sol\r\ntouch contract2.sol\r\n\r\nsolc contract1.sol --combined-json ast --base-path /tmp\r\n```\r\n```\r\nException during output generation: /solidity/libsolidity/interface/CompilerStack.cpp(1416): Throw in function const solidity::frontend::CompilerStack::Source& solidity::frontend::CompilerStack::source(const string&) const\r\nDynamic exception type: boost::wrapexcept<solidity::langutil::CompilerError>\r\nstd::exception::what: Given source file not found.\r\n[solidity::util::tag_comment*] = Given source file not found.\r\n```\r\n\r\nI think this is the only other place that would be affected by the change (positively or negatively). I checked all uses of loaded source in `CommandLineInterface` and I think nothing will break if we switch to using source unit names as keys.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/817190292/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
