{
  "url": "https://api.github.com/repos/ethereum/solidity/issues/13713",
  "repository_url": "https://api.github.com/repos/ethereum/solidity",
  "labels_url": "https://api.github.com/repos/ethereum/solidity/issues/13713/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/solidity/issues/13713/comments",
  "events_url": "https://api.github.com/repos/ethereum/solidity/issues/13713/events",
  "html_url": "https://github.com/ethereum/solidity/issues/13713",
  "id": 1453129789,
  "node_id": "I_kwDOAm_5kc5WnQA9",
  "number": 13713,
  "title": "Cheap and efficient calldata access [discussion]",
  "user": {
    "login": "k06a",
    "id": 702124,
    "node_id": "MDQ6VXNlcjcwMjEyNA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/702124?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/k06a",
    "html_url": "https://github.com/k06a",
    "followers_url": "https://api.github.com/users/k06a/followers",
    "following_url": "https://api.github.com/users/k06a/following{/other_user}",
    "gists_url": "https://api.github.com/users/k06a/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/k06a/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/k06a/subscriptions",
    "organizations_url": "https://api.github.com/users/k06a/orgs",
    "repos_url": "https://api.github.com/users/k06a/repos",
    "events_url": "https://api.github.com/users/k06a/events{/privacy}",
    "received_events_url": "https://api.github.com/users/k06a/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 7,
  "created_at": "2022-11-17T10:51:05Z",
  "updated_at": "2022-11-29T17:43:13Z",
  "closed_at": "2022-11-29T17:43:12Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "We noticed that some calldata access cost hundreds of gas for almost no reason.\r\n\r\nFor example following 2 examples have 150 gas difference in cost:\r\n```solidity\r\nstruct Thing {\r\n    uint256 a;\r\n    address b;\r\n    uint256 c;\r\n}\r\n\r\nfunction getB(Thing calldata thing) external view returns(address) {\r\n    return thing.b;\r\n}\r\n```\r\n\r\n```solidity\r\nstruct Thing {\r\n    uint256 a;\r\n    uint256 b; // <= important\r\n    uint256 c;\r\n}\r\n\r\nfunction getB(Thing calldata thing) external view returns(address) {\r\n    return address(uint160(thing.b)); // 150 gas cheaper\r\n}\r\n```\r\n\r\n## Motivation\r\n\r\nThis would dramatically decrease cost of the transactions. If some calldata expected to be `address`, let's read those 20 bytes and **ignore** 12 high bytes, not **check it and maybe revert**.\r\n\r\n## Specification\r\n\r\nI am not sure Solidity compiler put so many checks of calldata size and check high bits are zeroed. I would expect this access to `thing.b` be compiled into the following assembly:\r\n```solidity\r\nshr(96, calldataload(48))\r\n```\r\n\r\nThis would make sure top bits are zeroed and will cost almost nothing.",
  "closed_by": {
    "login": "ekpyron",
    "id": 1347491,
    "node_id": "MDQ6VXNlcjEzNDc0OTE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1347491?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ekpyron",
    "html_url": "https://github.com/ekpyron",
    "followers_url": "https://api.github.com/users/ekpyron/followers",
    "following_url": "https://api.github.com/users/ekpyron/following{/other_user}",
    "gists_url": "https://api.github.com/users/ekpyron/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ekpyron/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ekpyron/subscriptions",
    "organizations_url": "https://api.github.com/users/ekpyron/orgs",
    "repos_url": "https://api.github.com/users/ekpyron/repos",
    "events_url": "https://api.github.com/users/ekpyron/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ekpyron/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/13713/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/solidity/issues/13713/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1318458220",
    "html_url": "https://github.com/ethereum/solidity/issues/13713#issuecomment-1318458220",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13713",
    "id": 1318458220,
    "node_id": "IC_kwDOAm_5kc5OlhNs",
    "user": {
      "login": "k06a",
      "id": 702124,
      "node_id": "MDQ6VXNlcjcwMjEyNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/702124?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/k06a",
      "html_url": "https://github.com/k06a",
      "followers_url": "https://api.github.com/users/k06a/followers",
      "following_url": "https://api.github.com/users/k06a/following{/other_user}",
      "gists_url": "https://api.github.com/users/k06a/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/k06a/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/k06a/subscriptions",
      "organizations_url": "https://api.github.com/users/k06a/orgs",
      "repos_url": "https://api.github.com/users/k06a/repos",
      "events_url": "https://api.github.com/users/k06a/events{/privacy}",
      "received_events_url": "https://api.github.com/users/k06a/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-11-17T10:58:06Z",
    "updated_at": "2022-11-17T10:58:06Z",
    "author_association": "NONE",
    "body": "1inch team recent invention makes every `address` struct field access 150 gas cheaper:\r\n```solidity\r\nlibrary CalldataLib {\r\n     type Address is uint256;\r\n\r\n     function get(Address account) internal pure returns (address) {\r\n         return address(uint160(Address.unwrap(account)));\r\n     }\r\n}\r\n\r\ncontract MyContract {\r\n    using CalldataLib for CalldataLib.Address;\r\n\r\n    struct Thing {\r\n        uint256 a;\r\n        CalldataLib.Address b; // <= wow\r\n        uint256 c;\r\n    }\r\n\r\n    function getB(Thing calldata thing) external view returns(address) {\r\n        return thing.b.get(); // 150 gas cheaper\r\n    }\r\n}\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1318458220/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1319878559",
    "html_url": "https://github.com/ethereum/solidity/issues/13713#issuecomment-1319878559",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13713",
    "id": 1319878559,
    "node_id": "IC_kwDOAm_5kc5Oq7-f",
    "user": {
      "login": "cameel",
      "id": 137030,
      "node_id": "MDQ6VXNlcjEzNzAzMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cameel",
      "html_url": "https://github.com/cameel",
      "followers_url": "https://api.github.com/users/cameel/followers",
      "following_url": "https://api.github.com/users/cameel/following{/other_user}",
      "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
      "organizations_url": "https://api.github.com/users/cameel/orgs",
      "repos_url": "https://api.github.com/users/cameel/repos",
      "events_url": "https://api.github.com/users/cameel/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cameel/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-11-18T11:28:54Z",
    "updated_at": "2022-11-18T11:31:43Z",
    "author_association": "MEMBER",
    "body": "Is this the gas difference with legacy or IR codegen?\r\n\r\nWith IR the generated optimized code looks like this:\r\n\r\n- `address`:\r\n    ```yul\r\n    let value := calldataload(36)\r\n    let _3 := and(value, sub(shl(160, 1), 1))\r\n    if iszero(eq(value, _3)) { revert(_2, _2) }\r\n    mstore(_1, _3)\r\n    ```\r\n- `uint256`\r\n    ```yul\r\n    mstore(_1, and(calldataload(36), sub(shl(160, 1), 1)))\r\n    ```\r\n\r\nSo basically, the `address` case has an extra `if` to check that the higher bits are not dirty. Other than that they're the same apart from having some extra intermediate variables.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1319878559/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1327887869",
    "html_url": "https://github.com/ethereum/solidity/issues/13713#issuecomment-1327887869",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13713",
    "id": 1327887869,
    "node_id": "IC_kwDOAm_5kc5PJfX9",
    "user": {
      "login": "k06a",
      "id": 702124,
      "node_id": "MDQ6VXNlcjcwMjEyNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/702124?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/k06a",
      "html_url": "https://github.com/k06a",
      "followers_url": "https://api.github.com/users/k06a/followers",
      "following_url": "https://api.github.com/users/k06a/following{/other_user}",
      "gists_url": "https://api.github.com/users/k06a/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/k06a/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/k06a/subscriptions",
      "organizations_url": "https://api.github.com/users/k06a/orgs",
      "repos_url": "https://api.github.com/users/k06a/repos",
      "events_url": "https://api.github.com/users/k06a/events{/privacy}",
      "received_events_url": "https://api.github.com/users/k06a/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-11-25T21:12:19Z",
    "updated_at": "2022-11-25T21:12:19Z",
    "author_association": "NONE",
    "body": "@cameel it seems it was legacy. IR codegen seems pretty much optimized for me.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1327887869/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1327891344",
    "html_url": "https://github.com/ethereum/solidity/issues/13713#issuecomment-1327891344",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13713",
    "id": 1327891344,
    "node_id": "IC_kwDOAm_5kc5PJgOQ",
    "user": {
      "login": "k06a",
      "id": 702124,
      "node_id": "MDQ6VXNlcjcwMjEyNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/702124?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/k06a",
      "html_url": "https://github.com/k06a",
      "followers_url": "https://api.github.com/users/k06a/followers",
      "following_url": "https://api.github.com/users/k06a/following{/other_user}",
      "gists_url": "https://api.github.com/users/k06a/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/k06a/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/k06a/subscriptions",
      "organizations_url": "https://api.github.com/users/k06a/orgs",
      "repos_url": "https://api.github.com/users/k06a/repos",
      "events_url": "https://api.github.com/users/k06a/events{/privacy}",
      "received_events_url": "https://api.github.com/users/k06a/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-11-25T21:23:08Z",
    "updated_at": "2022-11-25T21:23:29Z",
    "author_association": "NONE",
    "body": "@cameel is there any specific reason to not just ignore high bits of `address`? I thought smart contract should take care of data which was passed to it and can skip and ignore rest of the data.\r\n\r\nBTW `iszero(eq(a,b))` can be optimized to `xor(a,b)` or `sub(a,b)` if it is not part of more complex expression, where I should aim this kind of suggestion? Is there any kind of set of abstract optimization rules?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1327891344/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1327904731",
    "html_url": "https://github.com/ethereum/solidity/issues/13713#issuecomment-1327904731",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13713",
    "id": 1327904731,
    "node_id": "IC_kwDOAm_5kc5PJjfb",
    "user": {
      "login": "cameel",
      "id": 137030,
      "node_id": "MDQ6VXNlcjEzNzAzMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cameel",
      "html_url": "https://github.com/cameel",
      "followers_url": "https://api.github.com/users/cameel/followers",
      "following_url": "https://api.github.com/users/cameel/following{/other_user}",
      "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
      "organizations_url": "https://api.github.com/users/cameel/orgs",
      "repos_url": "https://api.github.com/users/cameel/repos",
      "events_url": "https://api.github.com/users/cameel/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cameel/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-11-25T21:59:42Z",
    "updated_at": "2022-11-25T21:59:42Z",
    "author_association": "MEMBER",
    "body": "> is there any specific reason to not just ignore high bits of address? I thought smart contract should take care of data which was passed to it and can skip and ignore rest of the data.\r\n\r\nAFAIK this was a part of a general push to make calldata validation more strict due to bugs/attacks. I remember for example [How to Find $10M Just by Reading the Blockchain](https://blog.golemproject.net/how-to-find-10m-just-by-reading-the-blockchain/), though this particular bug was not affected specifically by dirty bits.\r\n\r\nThe decision to do this was in #5844, though I don't see rationale there. Perhaps @chriseth or @axic can say more. \r\n\r\n> BTW `iszero(eq(a,b))` can be optimized to `xor(a,b)` or `sub(a,b)` if it is not part of more complex expression, where I should aim this kind of suggestion? Is there any kind of set of abstract optimization rules?\r\n\r\nThis is something that would probably go into [`RuleList.h`](https://github.com/ethereum/solidity/blob/develop/libevmasm/RuleList.h). Or the [peephole optimizer](https://github.com/ethereum/solidity/blob/develop/libevmasm/PeepholeOptimiser.cpp).",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1327904731/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1328924566",
    "html_url": "https://github.com/ethereum/solidity/issues/13713#issuecomment-1328924566",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13713",
    "id": 1328924566,
    "node_id": "IC_kwDOAm_5kc5PNceW",
    "user": {
      "login": "chriseth",
      "id": 9073706,
      "node_id": "MDQ6VXNlcjkwNzM3MDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9073706?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chriseth",
      "html_url": "https://github.com/chriseth",
      "followers_url": "https://api.github.com/users/chriseth/followers",
      "following_url": "https://api.github.com/users/chriseth/following{/other_user}",
      "gists_url": "https://api.github.com/users/chriseth/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chriseth/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chriseth/subscriptions",
      "organizations_url": "https://api.github.com/users/chriseth/orgs",
      "repos_url": "https://api.github.com/users/chriseth/repos",
      "events_url": "https://api.github.com/users/chriseth/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chriseth/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-11-28T11:30:09Z",
    "updated_at": "2022-11-28T11:30:09Z",
    "author_association": "MEMBER",
    "body": "The first focus for Solidity is correctness, gas is always second. If an address is encoded with higher order bits set, it is not an address, and that is what we are checking. People assume that the higher order bits are zero, not that they are ignored. You can for example use the hash of a set of arguments to a function to see if the function has already been called that way (for example if a voucher + address combination has already been used to claim something). If the compiler would just mask away the higher order bits, you could fool this mechanism.\r\n\r\nWe introduced user defined value types specifically to allow users to break out of these checks. The reasoning behind is that if you change the name of the type to explicitly state that the address is unchecked, it is visible to the user and auditor. I really like the example above, I would just not call the type `Address` but something like `SloppyAddress`. The same goes for overflow checks: With the hopefully soon available user defined operators, you can define your own integer type that has wrapping behaviour with arithmetic.\r\n\r\nConcerning the optimizer: `iszero(eq(x, y))` is already optimized in the peephole optimizer, but it might be a good idea to introduce a flag for rules in RuleList.h that state that the rule can only be applied if the result is treated by something like `if` or `iszero`. New issue: https://github.com/ethereum/solidity/issues/13750\r\nThanks for the suggestion!",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1328924566/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1331036641",
    "html_url": "https://github.com/ethereum/solidity/issues/13713#issuecomment-1331036641",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13713",
    "id": 1331036641,
    "node_id": "IC_kwDOAm_5kc5PVgHh",
    "user": {
      "login": "ekpyron",
      "id": 1347491,
      "node_id": "MDQ6VXNlcjEzNDc0OTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1347491?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ekpyron",
      "html_url": "https://github.com/ekpyron",
      "followers_url": "https://api.github.com/users/ekpyron/followers",
      "following_url": "https://api.github.com/users/ekpyron/following{/other_user}",
      "gists_url": "https://api.github.com/users/ekpyron/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ekpyron/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ekpyron/subscriptions",
      "organizations_url": "https://api.github.com/users/ekpyron/orgs",
      "repos_url": "https://api.github.com/users/ekpyron/repos",
      "events_url": "https://api.github.com/users/ekpyron/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ekpyron/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-11-29T17:43:12Z",
    "updated_at": "2022-11-29T17:43:12Z",
    "author_association": "MEMBER",
    "body": "@k06a I take it that the comments above explains the fact that the behaviour is very much intentional?\r\n\r\nIndependently of that, FYI, we're trying to move towards reserving github issues mainly for concrete discussions of implementations, resp. of items we have scheduled for implementation, while we'll be trying to move most discussion to the [Solidity forum](https://forum.soliditylang.org/).\r\n\r\nIn any case, I'm closing the issue given the explanations above - if you want to discuss this further, though, feel free to comment, reopen, or open a post in the forum.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1331036641/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
