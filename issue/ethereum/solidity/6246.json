{
  "url": "https://api.github.com/repos/ethereum/solidity/issues/6246",
  "repository_url": "https://api.github.com/repos/ethereum/solidity",
  "labels_url": "https://api.github.com/repos/ethereum/solidity/issues/6246/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/solidity/issues/6246/comments",
  "events_url": "https://api.github.com/repos/ethereum/solidity/issues/6246/events",
  "html_url": "https://github.com/ethereum/solidity/issues/6246",
  "id": 419897538,
  "node_id": "MDU6SXNzdWU0MTk4OTc1Mzg=",
  "number": 6246,
  "title": "u256 overflow in logical shift optimization rule leads to incorrect computation",
  "user": {
    "login": "bshastry",
    "id": 2388185,
    "node_id": "MDQ6VXNlcjIzODgxODU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2388185?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/bshastry",
    "html_url": "https://github.com/bshastry",
    "followers_url": "https://api.github.com/users/bshastry/followers",
    "following_url": "https://api.github.com/users/bshastry/following{/other_user}",
    "gists_url": "https://api.github.com/users/bshastry/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/bshastry/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/bshastry/subscriptions",
    "organizations_url": "https://api.github.com/users/bshastry/orgs",
    "repos_url": "https://api.github.com/users/bshastry/repos",
    "events_url": "https://api.github.com/users/bshastry/events{/privacy}",
    "received_events_url": "https://api.github.com/users/bshastry/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 249074435,
      "node_id": "MDU6TGFiZWwyNDkwNzQ0MzU=",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/bug%20:bug:",
      "name": "bug :bug:",
      "color": "fc1313",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "bshastry",
    "id": 2388185,
    "node_id": "MDQ6VXNlcjIzODgxODU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2388185?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/bshastry",
    "html_url": "https://github.com/bshastry",
    "followers_url": "https://api.github.com/users/bshastry/followers",
    "following_url": "https://api.github.com/users/bshastry/following{/other_user}",
    "gists_url": "https://api.github.com/users/bshastry/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/bshastry/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/bshastry/subscriptions",
    "organizations_url": "https://api.github.com/users/bshastry/orgs",
    "repos_url": "https://api.github.com/users/bshastry/repos",
    "events_url": "https://api.github.com/users/bshastry/events{/privacy}",
    "received_events_url": "https://api.github.com/users/bshastry/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "bshastry",
      "id": 2388185,
      "node_id": "MDQ6VXNlcjIzODgxODU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2388185?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bshastry",
      "html_url": "https://github.com/bshastry",
      "followers_url": "https://api.github.com/users/bshastry/followers",
      "following_url": "https://api.github.com/users/bshastry/following{/other_user}",
      "gists_url": "https://api.github.com/users/bshastry/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bshastry/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bshastry/subscriptions",
      "organizations_url": "https://api.github.com/users/bshastry/orgs",
      "repos_url": "https://api.github.com/users/bshastry/repos",
      "events_url": "https://api.github.com/users/bshastry/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bshastry/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2019-03-12T10:02:48Z",
  "updated_at": "2019-03-13T11:02:34Z",
  "closed_at": "2019-03-13T11:02:34Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\n(Found by LPM+libFuzzer: Minimized by hand)\r\n\r\nThe following code should reduce to `mstore(0,0)` instead it reduces to `mstore(0,2)`\r\n\r\n```\r\n{\r\n  foo(2)\r\n  function foo(x)\r\n  {\r\n    mstore(0, shl(1,shl(not(0),x)))\r\n  }\r\n}\r\n```\r\n\r\nI believe the problem lies in the following logical shift optimization rules\r\n\r\nhttps://github.com/ethereum/solidity/blob/4430fe6a546c05275e72630561737b21d913eaf0/libevmasm/RuleList.h#L348-L353\r\n\r\nwherein the following optimization happens\r\n  - SHR(B, SHR(A, X)) -> SHR(min(A+B, 256), X)\r\n\r\nHowever, for the corner cases that trigger a u256 overflow in the addition of `A` and `B` such as `B=1` and `A=not(0)`, `min(A+B, u256(256))` incorrectly reduces to `0`. When there's an overflow in the shift size, we'd want to shift by u256(256) instead.\r\n\r\nSubsequently `SHR(0, X)` correctly reduces to `X`.\r\n\r\nThis bug/reasoning applies for the logical shift left operator as well.\r\n\r\nThis bug was a bit tricky to minimize because a simpler program such as the following is correctly computed.\r\n\r\n```\r\n{mstore(0, shl(1,shl(not(0),2)))}\r\n```\r\n\r\nAlthough I can't pin-point the reason for this, I guess that the optimization steps applied before logical shift optimizations (within the expression simplifier) somehow ensure that the buggy shift optimization rule is not triggered.\r\n\r\nIntroduction of a function makes it non-trivial enough for the buggy shift optimization rule to kick in.\r\n\r\n### Potential fix\r\n\r\nIn logical shift optimization rule\r\n  - check for u256 overflow after addition of nested shift sizes\r\n  - in case of an overflow, do `std::max(A+B, u256(256))` where `A` and `B` are shift sizes\r\n  - else do `std::min(A+B, u256(256))`\r\n\r\n## Environment\r\n\r\n- Compiler version: latest develop\r\n- Target EVM version (as per compiler settings): petersburg\r\n- Framework/IDE (e.g. Truffle or Remix): n/a\r\n- EVM execution environment / backend / blockchain client: n/a\r\n- Operating system: n/a\r\n\r\n## Steps to Reproduce\r\n\r\nThe bug may be reproduced using `yulopti` using the `s` option (expression simplifier). The debug output is from the AST printer at the time expression simplifier is called first before and then after the buggy shift optimization rule has been applied.\r\n\r\n```\r\n$ ./test/tools/yulopti --input-file <code.yul>\r\n----------------------                                                                          \r\n{                                                                                               \r\n  foo(2)                                                                                        \r\n  function foo(x)                                                                               \r\n  {                                                                                             \r\n    mstore(0, shl(1,shl(not(0),x)))                                                             \r\n  }                                                                                             \r\n}                                                                                               \r\n                                                                                                \r\n(q)quit/(f)flatten/(c)se/initialize var(d)ecls/(x)plit/(j)oin/(g)rouper/(h)oister/              \r\n  (e)xpr inline/(i)nline/(s)implify/varname c(l)eaner/(u)nusedprune/ss(a) transform/            \r\n  (r)edundant assign elim./re(m)aterializer/f(o)r-loop-pre-rewriter/                            \r\n  s(t)ructural simplifier/equi(v)alent function combiner/ssa re(V)erser/?                       \r\n  stack com(p)ressor?\r\n s\r\nES AST\r\n{\r\n    foo(2)\r\n    function foo(x)\r\n    {\r\n        mstore(0, shl(1, shl(not(0), x)))\r\n    }\r\n}----------------------\r\n{\r\n    foo(2)\r\n    function foo(x)\r\n    {\r\n        mstore(0, x)\r\n    }\r\n}\r\n```",
  "closed_by": {
    "login": "chriseth",
    "id": 9073706,
    "node_id": "MDQ6VXNlcjkwNzM3MDY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/9073706?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/chriseth",
    "html_url": "https://github.com/chriseth",
    "followers_url": "https://api.github.com/users/chriseth/followers",
    "following_url": "https://api.github.com/users/chriseth/following{/other_user}",
    "gists_url": "https://api.github.com/users/chriseth/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/chriseth/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/chriseth/subscriptions",
    "organizations_url": "https://api.github.com/users/chriseth/orgs",
    "repos_url": "https://api.github.com/users/chriseth/repos",
    "events_url": "https://api.github.com/users/chriseth/events{/privacy}",
    "received_events_url": "https://api.github.com/users/chriseth/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/6246/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/solidity/issues/6246/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/471952660",
    "html_url": "https://github.com/ethereum/solidity/issues/6246#issuecomment-471952660",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/6246",
    "id": 471952660,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ3MTk1MjY2MA==",
    "user": {
      "login": "axic",
      "id": 20340,
      "node_id": "MDQ6VXNlcjIwMzQw",
      "avatar_url": "https://avatars.githubusercontent.com/u/20340?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/axic",
      "html_url": "https://github.com/axic",
      "followers_url": "https://api.github.com/users/axic/followers",
      "following_url": "https://api.github.com/users/axic/following{/other_user}",
      "gists_url": "https://api.github.com/users/axic/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/axic/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/axic/subscriptions",
      "organizations_url": "https://api.github.com/users/axic/orgs",
      "repos_url": "https://api.github.com/users/axic/repos",
      "events_url": "https://api.github.com/users/axic/events{/privacy}",
      "received_events_url": "https://api.github.com/users/axic/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-03-12T10:55:20Z",
    "updated_at": "2019-03-12T10:55:20Z",
    "author_association": "MEMBER",
    "body": "Ah finally got it, you surmise that addition of two `u256` can overflow. I think the fix is to do `bigint(A) + B`.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/471952660/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/471953028",
    "html_url": "https://github.com/ethereum/solidity/issues/6246#issuecomment-471953028",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/6246",
    "id": 471953028,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ3MTk1MzAyOA==",
    "user": {
      "login": "axic",
      "id": 20340,
      "node_id": "MDQ6VXNlcjIwMzQw",
      "avatar_url": "https://avatars.githubusercontent.com/u/20340?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/axic",
      "html_url": "https://github.com/axic",
      "followers_url": "https://api.github.com/users/axic/followers",
      "following_url": "https://api.github.com/users/axic/following{/other_user}",
      "gists_url": "https://api.github.com/users/axic/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/axic/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/axic/subscriptions",
      "organizations_url": "https://api.github.com/users/axic/orgs",
      "repos_url": "https://api.github.com/users/axic/repos",
      "events_url": "https://api.github.com/users/axic/events{/privacy}",
      "received_events_url": "https://api.github.com/users/axic/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-03-12T10:56:33Z",
    "updated_at": "2019-03-12T10:56:33Z",
    "author_association": "MEMBER",
    "body": "Unfortunately this is a buglist item 😢 ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/471953028/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/471953535",
    "html_url": "https://github.com/ethereum/solidity/issues/6246#issuecomment-471953535",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/6246",
    "id": 471953535,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ3MTk1MzUzNQ==",
    "user": {
      "login": "chriseth",
      "id": 9073706,
      "node_id": "MDQ6VXNlcjkwNzM3MDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9073706?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chriseth",
      "html_url": "https://github.com/chriseth",
      "followers_url": "https://api.github.com/users/chriseth/followers",
      "following_url": "https://api.github.com/users/chriseth/following{/other_user}",
      "gists_url": "https://api.github.com/users/chriseth/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chriseth/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chriseth/subscriptions",
      "organizations_url": "https://api.github.com/users/chriseth/orgs",
      "repos_url": "https://api.github.com/users/chriseth/repos",
      "events_url": "https://api.github.com/users/chriseth/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chriseth/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-03-12T10:58:11Z",
    "updated_at": "2019-03-12T10:58:11Z",
    "author_association": "MEMBER",
    "body": "Good that we plan to make another release before the breaking one :)",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/471953535/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
