{
  "url": "https://api.github.com/repos/ethereum/solidity/issues/13137",
  "repository_url": "https://api.github.com/repos/ethereum/solidity",
  "labels_url": "https://api.github.com/repos/ethereum/solidity/issues/13137/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/solidity/issues/13137/comments",
  "events_url": "https://api.github.com/repos/ethereum/solidity/issues/13137/events",
  "html_url": "https://github.com/ethereum/solidity/issues/13137",
  "id": 1270605405,
  "node_id": "I_kwDOAm_5kc5Lu-Zd",
  "number": 13137,
  "title": "Event and error selectors are not constants",
  "user": {
    "login": "cameel",
    "id": 137030,
    "node_id": "MDQ6VXNlcjEzNzAzMA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/cameel",
    "html_url": "https://github.com/cameel",
    "followers_url": "https://api.github.com/users/cameel/followers",
    "following_url": "https://api.github.com/users/cameel/following{/other_user}",
    "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
    "organizations_url": "https://api.github.com/users/cameel/orgs",
    "repos_url": "https://api.github.com/users/cameel/repos",
    "events_url": "https://api.github.com/users/cameel/events{/privacy}",
    "received_events_url": "https://api.github.com/users/cameel/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 249074435,
      "node_id": "MDU6TGFiZWwyNDkwNzQ0MzU=",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/bug%20:bug:",
      "name": "bug :bug:",
      "color": "fc1313",
      "default": false,
      "description": ""
    },
    {
      "id": 717596767,
      "node_id": "MDU6TGFiZWw3MTc1OTY3Njc=",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/good%20first%20issue",
      "name": "good first issue",
      "color": "006b75",
      "default": true,
      "description": ""
    },
    {
      "id": 785717317,
      "node_id": "MDU6TGFiZWw3ODU3MTczMTc=",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/language%20design%20:rage4:",
      "name": "language design :rage4:",
      "color": "9d76d3",
      "default": false,
      "description": "Any changes to the language, e.g. new features"
    },
    {
      "id": 1012614086,
      "node_id": "MDU6TGFiZWwxMDEyNjE0MDg2",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/medium%20difficulty",
      "name": "medium difficulty",
      "color": "7dcddb",
      "default": false,
      "description": ""
    },
    {
      "id": 4438006499,
      "node_id": "LA_kwDOAm_5kc8AAAABCIaa4w",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/low%20effort",
      "name": "low effort",
      "color": "ffb1fa",
      "default": false,
      "description": "There is not much implementation work to be done. The task is very easy or tiny."
    },
    {
      "id": 4438155599,
      "node_id": "LA_kwDOAm_5kc8AAAABCIjhTw",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/medium%20impact",
      "name": "medium impact",
      "color": "001dff",
      "default": false,
      "description": "Default level of impact"
    },
    {
      "id": 4438488423,
      "node_id": "LA_kwDOAm_5kc8AAAABCI31Zw",
      "url": "https://api.github.com/repos/ethereum/solidity/labels/must%20have",
      "name": "must have",
      "color": "ffa12a",
      "default": false,
      "description": "Something we consider an essential part of Solidity 1.0."
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2022-06-14T10:39:22Z",
  "updated_at": "2022-12-05T19:40:21Z",
  "closed_at": null,
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "## Description\r\nFunction selectors can be used to initialize constants while error and event selectors (recently introduced in #12921) are rejected as non-constant. I think that all of them should work the same way in that regard.\r\n\r\n## Steps to Reproduce\r\n\r\n```solidity\r\ncontract C {\r\n    event Ev();\r\n    error Er();\r\n    function f() external {}\r\n\r\n    bytes4 constant functionSelector = this.f.selector;  // OK\r\n    bytes4 constant errorSelector = Er.selector;         // Error: Initial value for constant variable has to be compile-time constant.\r\n    bytes32 constant eventSelector = Ev.selector;        // Error: Initial value for constant variable has to be compile-time constant.\r\n}\r\n```\r\n```\r\nError: Initial value for constant variable has to be compile-time constant.\r\n --> test.sol:7:37:\r\n  |\r\n7 |     bytes4 constant errorSelector = Er.selector;         // Error: Initial value for constant variable has to be compile-time constant.\r\n  |                                     ^^^^^^^^^^^\r\n\r\nError: Initial value for constant variable has to be compile-time constant.\r\n --> test.sol:8:38:\r\n  |\r\n8 |     bytes32 constant eventSelector = Ev.selector;        // Error: Initial value for constant variable has to be compile-time constant.\r\n  |                                      ^^^^^^^^^^^            \r\n```\r\n\r\nThe test passes without errors if you remove `constant` from the state variables.\r\n\r\n## Environment\r\n\r\n- Compiler version: 0.8.15 (`develop`)",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/13137/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/solidity/issues/13137/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1336123726",
    "html_url": "https://github.com/ethereum/solidity/issues/13137#issuecomment-1336123726",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13137",
    "id": 1336123726,
    "node_id": "IC_kwDOAm_5kc5Po6FO",
    "user": {
      "login": "jackson1129",
      "id": 86737088,
      "node_id": "MDQ6VXNlcjg2NzM3MDg4",
      "avatar_url": "https://avatars.githubusercontent.com/u/86737088?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jackson1129",
      "html_url": "https://github.com/jackson1129",
      "followers_url": "https://api.github.com/users/jackson1129/followers",
      "following_url": "https://api.github.com/users/jackson1129/following{/other_user}",
      "gists_url": "https://api.github.com/users/jackson1129/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jackson1129/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jackson1129/subscriptions",
      "organizations_url": "https://api.github.com/users/jackson1129/orgs",
      "repos_url": "https://api.github.com/users/jackson1129/repos",
      "events_url": "https://api.github.com/users/jackson1129/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jackson1129/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-03T09:40:16Z",
    "updated_at": "2022-12-03T09:40:16Z",
    "author_association": "NONE",
    "body": "Can you leave a source below to learn about this ?\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1336123726/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1338051885",
    "html_url": "https://github.com/ethereum/solidity/issues/13137#issuecomment-1338051885",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/13137",
    "id": 1338051885,
    "node_id": "IC_kwDOAm_5kc5PwQ0t",
    "user": {
      "login": "cameel",
      "id": 137030,
      "node_id": "MDQ6VXNlcjEzNzAzMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cameel",
      "html_url": "https://github.com/cameel",
      "followers_url": "https://api.github.com/users/cameel/followers",
      "following_url": "https://api.github.com/users/cameel/following{/other_user}",
      "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
      "organizations_url": "https://api.github.com/users/cameel/orgs",
      "repos_url": "https://api.github.com/users/cameel/repos",
      "events_url": "https://api.github.com/users/cameel/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cameel/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-05T19:39:14Z",
    "updated_at": "2022-12-05T19:40:21Z",
    "author_association": "MEMBER",
    "body": "@jackson1129 The best way to start with this issue would be to take a look at the AST produced for these expressionts. Take this snippet:\r\n```solidity\r\ncontract C {\r\n    event Ev();\r\n    error Er();\r\n    function f() external {}\r\n\r\n    function test() public {\r\n        this.f.selector;\r\n        Er.selector;\r\n        Ev.selector;\r\n    }\r\n}\r\n```\r\n\r\nNow look at the AST output (`solc test.sol --ast-compact-json --pretty-json --json-indent 4`). This shows you how the compiler takes apart each of these expressions. The annotation to look for is `isPure`. \r\n\r\nHere's the relevant bit for `this.f.selector`:\r\n```json\r\n\"id\": 15,\r\n\"isConstant\": false,\r\n\"isLValue\": false,\r\n\"isPure\": true,\r\n\"lValueRequested\": false,\r\n\"memberLocation\": \"119:8:0\",\r\n\"memberName\": \"selector\",\r\n\"nodeType\": \"MemberAccess\",\r\n```\r\nhere's `Er.selector`:\r\n```json\r\n\"id\": 19,\r\n\"isConstant\": false,\r\n\"isLValue\": false,\r\n\"isPure\": false,\r\n\"lValueRequested\": false,\r\n\"memberLocation\": \"140:8:0\",\r\n\"memberName\": \"selector\",\r\n\"nodeType\": \"MemberAccess\",\r\n```\r\nand `Ev.selector`\r\n```json\r\n\"id\": 23,\r\n\"isConstant\": false,\r\n\"isLValue\": false,\r\n\"isPure\": false,\r\n\"lValueRequested\": false,\r\n\"memberLocation\": \"161:8:0\",\r\n\"memberName\": \"selector\",\r\n\"nodeType\": \"MemberAccess\",\r\n```\r\n\r\nNote that the function get correctly marked with `isPure: true`, while the error and the event do not.\r\n\r\nThe code that sets `isPure` for the `selector` member is here: https://github.com/ethereum/solidity/blob/591df042115c6df190faa26a1fb87617f7772db3/libsolidity/analysis/TypeChecker.cpp#L3245-L3260\r\n\r\nThe issue is probably that it requires a function definition and events and errors do not have one (not 100% sure though, since they do have function types and do have declarations). You need to adjust the code so that error and event selectors get the right annotation too. While doing it please include tests to make sure things that should not get this annotation do not get it by mistake.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/1338051885/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
