{
  "url": "https://api.github.com/repos/ethereum/solidity/issues/7303",
  "repository_url": "https://api.github.com/repos/ethereum/solidity",
  "labels_url": "https://api.github.com/repos/ethereum/solidity/issues/7303/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/solidity/issues/7303/comments",
  "events_url": "https://api.github.com/repos/ethereum/solidity/issues/7303/events",
  "html_url": "https://github.com/ethereum/solidity/issues/7303",
  "id": 485382307,
  "node_id": "MDU6SXNzdWU0ODUzODIzMDc=",
  "number": 7303,
  "title": "Unable to handle a specific nested function-call",
  "user": {
    "login": "barakman",
    "id": 7003246,
    "node_id": "MDQ6VXNlcjcwMDMyNDY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/7003246?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/barakman",
    "html_url": "https://github.com/barakman",
    "followers_url": "https://api.github.com/users/barakman/followers",
    "following_url": "https://api.github.com/users/barakman/following{/other_user}",
    "gists_url": "https://api.github.com/users/barakman/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/barakman/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/barakman/subscriptions",
    "organizations_url": "https://api.github.com/users/barakman/orgs",
    "repos_url": "https://api.github.com/users/barakman/repos",
    "events_url": "https://api.github.com/users/barakman/events{/privacy}",
    "received_events_url": "https://api.github.com/users/barakman/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2019-08-26T18:41:04Z",
  "updated_at": "2019-09-09T14:38:50Z",
  "closed_at": "2019-08-28T15:51:39Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "## Description\r\n\r\nThe compiler seems to be unable to \"unwind\" a certain function-call combination, leading to a *Stack too deep* error, which:\r\n1. Can be resolved via a simple code-rearrangement\r\n2. Would be resolved by \"stack-oriented\" compilers designated for traditional platforms\r\n\r\nDue to each one of these reasons by itself, I believe that the Solidity compiler should be upgraded to resolve this problem as well.\r\n\r\n## Environment\r\n\r\n- Compiler version: 0.4.24\r\n- Compiler optimization: enabled with runs=200\r\n- Target EVM version: Ganache 6.5.1 if that's what you mean\r\n- Framework/IDE: Truffle 4.1.14\r\n- Operating system: Windows 10\r\n\r\n## Steps to Reproduce\r\n\r\nConsider the following contract:\r\n```\r\npragma solidity 0.4.24;\r\n\r\ncontract MyContract {\r\n    function func1(uint x1, uint x2, uint x3, uint x4, uint x5) private pure returns (uint) {\r\n        return x1 + x2 + x3 + x4 + x5;\r\n    }\r\n    function func2(uint x1, uint x2, uint x3, uint x4, uint x5, uint x6, uint x7) private pure returns (uint) {\r\n        return x1 + x2 + x3 + x4 + x5 + x6 + x7;\r\n    }\r\n    function func3(uint x1, uint x2, uint x3, uint x4, uint x5, uint x6, uint x7, uint x8, uint x9, uint x10) public payable returns (uint) {\r\n        return func2(x1, x2, x3, x4, x5, x6, func1(x2, x7, x8, x9, x10));\r\n    }\r\n}\r\n```\r\nA compilation error is emitted on `func3`:\r\n```\r\n/C/Users/.../MyContract.sol:11:52: CompilerError: Stack too deep, try removing local variables.\r\n        return func2(x1, x2, x3, x4, x5, x6, func1(x2, x7, x8, x9, x10));\r\n                                                   ^^\r\n```\r\nIn case it is not clear in the description above, those `^^` are pointing at the `x2` variable passed on the nested-call to `func1`.\r\n\r\nThis problem can easily be solved by \"unwinding\" the nested function-call:\r\n```\r\nfunction func3(uint x1, uint x2, uint x3, uint x4, uint x5, uint x6, uint x7, uint x8, uint x9, uint x10) public payable returns (uint) {\r\n    uint x = func1(x2, x7, x8, x9, x10);\r\n    return func2(x1, x2, x3, x4, x5, x6, x);\r\n}\r\n```\r\nMy conclusion is that the compiler should be able to do the same.\r\nIn fact, I don't quite see how the compiler ended up with this problem to begin with, as the inner function-call should be \"completely unwound\" before the outer function-call is dealt with. So at no point should the stack occupy more than 11 slots or so.\r\n\r\nOne point to notice is, that if I replace `func1(x2, ...)` with `func1(x6, ...)` in the original `func3`, then there is no issue with the stack. Though I'm guessing that this might be related to the fact that the nested function-call is now executed on consecutive stack-slots (`x6`, `x7`, `x8`, `x9`, `x10`), and so perhaps the compiler can optimize this specific scenario.\r\n\r\nThanks",
  "closed_by": {
    "login": "chriseth",
    "id": 9073706,
    "node_id": "MDQ6VXNlcjkwNzM3MDY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/9073706?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/chriseth",
    "html_url": "https://github.com/chriseth",
    "followers_url": "https://api.github.com/users/chriseth/followers",
    "following_url": "https://api.github.com/users/chriseth/following{/other_user}",
    "gists_url": "https://api.github.com/users/chriseth/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/chriseth/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/chriseth/subscriptions",
    "organizations_url": "https://api.github.com/users/chriseth/orgs",
    "repos_url": "https://api.github.com/users/chriseth/repos",
    "events_url": "https://api.github.com/users/chriseth/events{/privacy}",
    "received_events_url": "https://api.github.com/users/chriseth/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/7303/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/solidity/issues/7303/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/525806993",
    "html_url": "https://github.com/ethereum/solidity/issues/7303#issuecomment-525806993",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/7303",
    "id": 525806993,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUyNTgwNjk5Mw==",
    "user": {
      "login": "chriseth",
      "id": 9073706,
      "node_id": "MDQ6VXNlcjkwNzM3MDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9073706?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chriseth",
      "html_url": "https://github.com/chriseth",
      "followers_url": "https://api.github.com/users/chriseth/followers",
      "following_url": "https://api.github.com/users/chriseth/following{/other_user}",
      "gists_url": "https://api.github.com/users/chriseth/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chriseth/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chriseth/subscriptions",
      "organizations_url": "https://api.github.com/users/chriseth/orgs",
      "repos_url": "https://api.github.com/users/chriseth/repos",
      "events_url": "https://api.github.com/users/chriseth/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chriseth/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-08-28T15:51:39Z",
    "updated_at": "2019-08-28T15:51:39Z",
    "author_association": "MEMBER",
    "body": "This will be solved by the new code generator (I actually just verified that it does). The reason why it fails currently is because function arguments are evaluated from left to right and put on the stack like that. The current code generator is too low-level to perform optimizations like that.\r\n\r\nSorry for the inconvenience!",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/525806993/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/525836146",
    "html_url": "https://github.com/ethereum/solidity/issues/7303#issuecomment-525836146",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/7303",
    "id": 525836146,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUyNTgzNjE0Ng==",
    "user": {
      "login": "barakman",
      "id": 7003246,
      "node_id": "MDQ6VXNlcjcwMDMyNDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7003246?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/barakman",
      "html_url": "https://github.com/barakman",
      "followers_url": "https://api.github.com/users/barakman/followers",
      "following_url": "https://api.github.com/users/barakman/following{/other_user}",
      "gists_url": "https://api.github.com/users/barakman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/barakman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/barakman/subscriptions",
      "organizations_url": "https://api.github.com/users/barakman/orgs",
      "repos_url": "https://api.github.com/users/barakman/repos",
      "events_url": "https://api.github.com/users/barakman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/barakman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-08-28T17:09:05Z",
    "updated_at": "2019-08-28T17:09:05Z",
    "author_association": "NONE",
    "body": "@chriseth:\r\nThank you very much for your quick response.\r\nAny chance that this fix will also be applied on the 0.4 branch (version 0.4.27 I suppose)?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/525836146/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/529507258",
    "html_url": "https://github.com/ethereum/solidity/issues/7303#issuecomment-529507258",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/7303",
    "id": 529507258,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUyOTUwNzI1OA==",
    "user": {
      "login": "chriseth",
      "id": 9073706,
      "node_id": "MDQ6VXNlcjkwNzM3MDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9073706?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chriseth",
      "html_url": "https://github.com/chriseth",
      "followers_url": "https://api.github.com/users/chriseth/followers",
      "following_url": "https://api.github.com/users/chriseth/following{/other_user}",
      "gists_url": "https://api.github.com/users/chriseth/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chriseth/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chriseth/subscriptions",
      "organizations_url": "https://api.github.com/users/chriseth/orgs",
      "repos_url": "https://api.github.com/users/chriseth/repos",
      "events_url": "https://api.github.com/users/chriseth/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chriseth/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-09-09T14:38:50Z",
    "updated_at": "2019-09-09T14:38:50Z",
    "author_association": "MEMBER",
    "body": "@barakman sorry, but that won't happen.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/529507258/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
