{
  "url": "https://api.github.com/repos/ethereum/solidity/issues/281",
  "repository_url": "https://api.github.com/repos/ethereum/solidity",
  "labels_url": "https://api.github.com/repos/ethereum/solidity/issues/281/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/solidity/issues/281/comments",
  "events_url": "https://api.github.com/repos/ethereum/solidity/issues/281/events",
  "html_url": "https://github.com/ethereum/solidity/issues/281",
  "id": 120787951,
  "node_id": "MDU6SXNzdWUxMjA3ODc5NTE=",
  "number": 281,
  "title": "Bug: Deducting balance from wrong mapping.",
  "user": {
    "login": "simondlr",
    "id": 716965,
    "node_id": "MDQ6VXNlcjcxNjk2NQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/716965?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/simondlr",
    "html_url": "https://github.com/simondlr",
    "followers_url": "https://api.github.com/users/simondlr/followers",
    "following_url": "https://api.github.com/users/simondlr/following{/other_user}",
    "gists_url": "https://api.github.com/users/simondlr/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/simondlr/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/simondlr/subscriptions",
    "organizations_url": "https://api.github.com/users/simondlr/orgs",
    "repos_url": "https://api.github.com/users/simondlr/repos",
    "events_url": "https://api.github.com/users/simondlr/events{/privacy}",
    "received_events_url": "https://api.github.com/users/simondlr/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2015-12-07T14:41:19Z",
  "updated_at": "2016-01-20T18:20:13Z",
  "closed_at": "2016-01-20T18:20:13Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "I've been writing tests/code for the standard tokens and came across odd behaviour where essentially some code deducted a balance twice. After shuffling some of it around, commenting out code and so forth, it only managed to work if the a specific line was called AFTER an event. I threw out code to a basic version. Here is where it still occurs.\n\n```\ncontract Bug_Test {\n\n    event Fire(uint256 anything);\n\n    mapping (address => uint256) bal;\n    mapping (address => mapping (address => uint256)) allowed;\n\n    function Bug_Test() {\n        bal[msg.sender] = 10000;\n    }\n\n    function transferFrom(address _from, address _to, uint256 _value) returns (bool success) {\n        if (bal[_from] >= _value && allowed[_from][msg.sender] >= _value) {\n            bal[_to] += _value;\n            Fire(10);\n            bal[_from] -= _value;\n            allowed[_from][msg.sender] -= _value;\n            return true;\n        } else { return false; }\n    }\n\n    function approve(address _spender, uint256 _value) returns (bool success) {\n        allowed[msg.sender][_spender] += _value;\n        return true;\n    }\n\n    function balanceOf(address _owner) constant returns (uint256 balance) {\n        return bal[_owner];\n    }\n\n    function allowance(address _owner, address _spender) constant returns (uint256 remaining) {\n      return allowed[_owner][_spender];\n    }\n}\n```\n\nIf I comment out `Fire(10)` it causes the line `bal[_from] -= _value` to deduct `_value` from `allowed[_from][msg.sender]` & NOT from `bal`. Shuffling `bal[_from][msg.sender]` around, keeps causing this behaviour, except if it is after the event. It always deducts from `allowed` for some reason.\n\nI use EtherSim + EthereumJS for testing purposes. Here's the truffle test I used. It's extensive because I was debugging a lot of it.\n\n```\ncontract(\"Bug_Test\", function(accounts) {\n\n/*APPROVALS*/\n\n    it(\"should withdraw after approving an allowance\", function(done) {\n        var ctr = null;\n        Bug_Test.new(10000, {from: accounts[0]}).then(function(result) {\n            ctr = result;\n            return ctr.balanceOf.call(accounts[0]);\n        }).then(function (result) {\n            assert.strictEqual(result.c[0], 10000);\n            return ctr.approve(accounts[1], 100, {from: accounts[0]});\n        }).then(function (result) {\n            return ctr.balanceOf.call(accounts[2]);\n        }).then(function (result) {\n            assert.strictEqual(result.c[0], 0);\n            return ctr.allowance.call(accounts[0], accounts[1]);\n        }).then(function (result) {\n            assert.strictEqual(result.c[0], 100);\n            return ctr.transferFrom.call(accounts[0], accounts[2], 20, {from: accounts[1]});\n        }).then(function (result) {\n            console.log(result); //must be true\n            return ctr.transferFrom(accounts[0], accounts[2], 20, {from: accounts[1]});\n        }).then(function (result) {\n            return ctr.allowance.call(accounts[0], accounts[1]);\n        }).then(function (result) {\n            console.log(result);\n            assert.strictEqual(result.c[0], 80);\n            return ctr.balanceOf.call(accounts[2]);\n        }).then(function (result) {\n            console.log(result);\n            assert.strictEqual(result.c[0], 20);\n            return ctr.balanceOf.call(accounts[0]);\n        }).then(function (result) {\n            console.log(result);\n            assert.strictEqual(result.c[0], 9980);\n            done();\n        }).catch(done);\n    });\n});\n```\n\nI tried emulating it to a smaller flow.\n\nFor example, this worked:\n\n```\ncontract Bug_Test2 {\n\n    event Fire(uint256 anything);\n\n    mapping (uint256 => uint256) bal;\n    mapping (uint256 => mapping (uint256 => uint256)) allowed;\n\n    function Bug_Test2() {\n        bal[0] = 10000;\n        allowed[0][1] = 100;\n    }\n\n    function transferFrom(uint256 _value) returns (bool success) {\n        if (bal[0] >= _value && allowed[0][1] >= _value) {\n            bal[2] += _value;\n            bal[0] -= _value;\n            allowed[0][1] -= _value;\n            return true;\n        } else { return false; }\n    }\n\n    function balanceOf(uint256 _i) constant returns (uint256 balance) {\n        return bal[_i];\n    }\n\n    function allowance(uint256 _i, uint256 _j) constant returns (uint256 remaining) {\n      return allowed[_i][_j];\n    }\n}\n```\n\nNo complaints. Going to try various permutations to see if I can narrow down precisely what's causing the issue.\n",
  "closed_by": {
    "login": "chriseth",
    "id": 9073706,
    "node_id": "MDQ6VXNlcjkwNzM3MDY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/9073706?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/chriseth",
    "html_url": "https://github.com/chriseth",
    "followers_url": "https://api.github.com/users/chriseth/followers",
    "following_url": "https://api.github.com/users/chriseth/following{/other_user}",
    "gists_url": "https://api.github.com/users/chriseth/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/chriseth/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/chriseth/subscriptions",
    "organizations_url": "https://api.github.com/users/chriseth/orgs",
    "repos_url": "https://api.github.com/users/chriseth/repos",
    "events_url": "https://api.github.com/users/chriseth/events{/privacy}",
    "received_events_url": "https://api.github.com/users/chriseth/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/281/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/solidity/issues/281/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/170487793",
    "html_url": "https://github.com/ethereum/solidity/issues/281#issuecomment-170487793",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/281",
    "id": 170487793,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE3MDQ4Nzc5Mw==",
    "user": {
      "login": "chriseth",
      "id": 9073706,
      "node_id": "MDQ6VXNlcjkwNzM3MDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9073706?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chriseth",
      "html_url": "https://github.com/chriseth",
      "followers_url": "https://api.github.com/users/chriseth/followers",
      "following_url": "https://api.github.com/users/chriseth/following{/other_user}",
      "gists_url": "https://api.github.com/users/chriseth/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chriseth/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chriseth/subscriptions",
      "organizations_url": "https://api.github.com/users/chriseth/orgs",
      "repos_url": "https://api.github.com/users/chriseth/repos",
      "events_url": "https://api.github.com/users/chriseth/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chriseth/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-01-11T09:37:49Z",
    "updated_at": "2016-01-11T09:37:49Z",
    "author_association": "MEMBER",
    "body": "Did you find something here?\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/170487793/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/170490664",
    "html_url": "https://github.com/ethereum/solidity/issues/281#issuecomment-170490664",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/281",
    "id": 170490664,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE3MDQ5MDY2NA==",
    "user": {
      "login": "simondlr",
      "id": 716965,
      "node_id": "MDQ6VXNlcjcxNjk2NQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/716965?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/simondlr",
      "html_url": "https://github.com/simondlr",
      "followers_url": "https://api.github.com/users/simondlr/followers",
      "following_url": "https://api.github.com/users/simondlr/following{/other_user}",
      "gists_url": "https://api.github.com/users/simondlr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/simondlr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/simondlr/subscriptions",
      "organizations_url": "https://api.github.com/users/simondlr/orgs",
      "repos_url": "https://api.github.com/users/simondlr/repos",
      "events_url": "https://api.github.com/users/simondlr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/simondlr/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-01-11T09:48:25Z",
    "updated_at": "2016-01-11T09:48:25Z",
    "author_association": "NONE",
    "body": "@chriseth I haven't had time to do more debugging. It might be a VM or some optimizer issue (not in Solidity). But only been working with the ethereum-js VM. Need to test still in Go, C++ or Python compilers.\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/170490664/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/173311884",
    "html_url": "https://github.com/ethereum/solidity/issues/281#issuecomment-173311884",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/281",
    "id": 173311884,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE3MzMxMTg4NA==",
    "user": {
      "login": "CJentzsch",
      "id": 8452011,
      "node_id": "MDQ6VXNlcjg0NTIwMTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8452011?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/CJentzsch",
      "html_url": "https://github.com/CJentzsch",
      "followers_url": "https://api.github.com/users/CJentzsch/followers",
      "following_url": "https://api.github.com/users/CJentzsch/following{/other_user}",
      "gists_url": "https://api.github.com/users/CJentzsch/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/CJentzsch/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/CJentzsch/subscriptions",
      "organizations_url": "https://api.github.com/users/CJentzsch/orgs",
      "repos_url": "https://api.github.com/users/CJentzsch/repos",
      "events_url": "https://api.github.com/users/CJentzsch/events{/privacy}",
      "received_events_url": "https://api.github.com/users/CJentzsch/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-01-20T18:13:42Z",
    "updated_at": "2016-01-20T18:15:50Z",
    "author_association": "CONTRIBUTOR",
    "body": "@chriseth Is this the same as https://github.com/ethereum/solidity/issues/333 ? ( I guess so)\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/173311884/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/173313592",
    "html_url": "https://github.com/ethereum/solidity/issues/281#issuecomment-173313592",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/281",
    "id": 173313592,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE3MzMxMzU5Mg==",
    "user": {
      "login": "chriseth",
      "id": 9073706,
      "node_id": "MDQ6VXNlcjkwNzM3MDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9073706?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chriseth",
      "html_url": "https://github.com/chriseth",
      "followers_url": "https://api.github.com/users/chriseth/followers",
      "following_url": "https://api.github.com/users/chriseth/following{/other_user}",
      "gists_url": "https://api.github.com/users/chriseth/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chriseth/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chriseth/subscriptions",
      "organizations_url": "https://api.github.com/users/chriseth/orgs",
      "repos_url": "https://api.github.com/users/chriseth/repos",
      "events_url": "https://api.github.com/users/chriseth/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chriseth/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-01-20T18:19:41Z",
    "updated_at": "2016-01-20T18:20:12Z",
    "author_association": "MEMBER",
    "body": "Hopefully, yes. Closing this as it is very likely fixed.\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/173313592/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
