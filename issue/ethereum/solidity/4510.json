{
  "url": "https://api.github.com/repos/ethereum/solidity/issues/4510",
  "repository_url": "https://api.github.com/repos/ethereum/solidity",
  "labels_url": "https://api.github.com/repos/ethereum/solidity/issues/4510/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/solidity/issues/4510/comments",
  "events_url": "https://api.github.com/repos/ethereum/solidity/issues/4510/events",
  "html_url": "https://github.com/ethereum/solidity/issues/4510",
  "id": 341090826,
  "node_id": "MDU6SXNzdWUzNDEwOTA4MjY=",
  "number": 4510,
  "title": "Proxy library always throws",
  "user": {
    "login": "kyriediculous",
    "id": 22256858,
    "node_id": "MDQ6VXNlcjIyMjU2ODU4",
    "avatar_url": "https://avatars.githubusercontent.com/u/22256858?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/kyriediculous",
    "html_url": "https://github.com/kyriediculous",
    "followers_url": "https://api.github.com/users/kyriediculous/followers",
    "following_url": "https://api.github.com/users/kyriediculous/following{/other_user}",
    "gists_url": "https://api.github.com/users/kyriediculous/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/kyriediculous/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/kyriediculous/subscriptions",
    "organizations_url": "https://api.github.com/users/kyriediculous/orgs",
    "repos_url": "https://api.github.com/users/kyriediculous/repos",
    "events_url": "https://api.github.com/users/kyriediculous/events{/privacy}",
    "received_events_url": "https://api.github.com/users/kyriediculous/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2018-07-13T16:57:19Z",
  "updated_at": "2018-07-25T10:05:10Z",
  "closed_at": "2018-07-16T11:46:57Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "Hello. \r\n\r\nI'm writing a dApp using an upgradeable architecture which I call 'Registered proxy libraries'.\r\nSimply put it's a combination of proxy libraries and contract managers/registries. \r\n\r\nThis is how it works\r\nstorage-contract ---delegateCall() --> Proxy --delegateCall() --> Library \r\n\r\nIn this repository you will find multiple contracts following this architecture: https://github.com/kyriediculous/blockchain-programmable-incentives\r\n\r\nPeople.sol follows the exact same architecture as Timesheet.sol however the timesheet workflow does not work.\r\n\r\nWhenever a function is being called on my library through the proxy, the call reverts. This only the case for the timesheet workflow, the people workflow works like a charm. I'm completely confused as to why, as it is completely the same architecture. \r\n\r\nWhen I change the storage directly it all works (without going through the proxy to the library). When I just use the library and storage contracts in remix it works too. So there is some issue happening with delegating the calls.\r\n\r\nBy changing the storage i mean using\r\n\r\n```\r\n  function isAdmin(address _user) external view returns (bool) {\r\n    return  _timesheet.admins[_user];\r\n  }\r\n```\r\n\r\ninstead of \r\n```\r\n\r\n  function isAdmin(address _user) external view returns (bool) {\r\n    return  _timesheet.isAdmin(_user);\r\n  }\r\n```\r\n\r\nAny ideas? It seems like it's the revert statement in assembly (proxy) causing the issue but I have no idea as to why.. Thanks...\r\n\r\nShort version of the code where on isAdmin() remains as funtion as example\r\n\r\n```\r\nimesheet (STORAGE) \r\n\r\n    pragma solidity ^0.4.23;\r\n    \r\n    import '../interface/timesheet-interface.sol';\r\n    import '../registry/enabled.sol';\r\n    import '../util/Ownable.sol';\r\n    \r\n    contract Timesheet is Ownable, Enabled {\r\n      using TimesheetInterface for TimesheetInterface.Timesheets;\r\n      TimesheetInterface.Timesheets _timesheet;\r\n    \r\n      function isAdmin(address _user) external view returns (bool) {\r\n        return _timesheet.isAdmin(_user);\r\n      }\r\n    \r\n    }\r\n\r\nTimesheetInterface (INTERFACE)\r\n\r\n    pragma solidity ^0.4.23;\r\n    \r\n    library TimesheetInterface {\r\n      struct Period {\r\n        uint start;\r\n        uint end;\r\n        bool closed;\r\n        bool processed;\r\n      }\r\n    \r\n      struct Periods {\r\n        Period[] periods;\r\n      }\r\n    \r\n      struct Timesheets {\r\n        mapping (address => Periods) timesheet;\r\n        mapping (address => bool) admins;\r\n      }\r\n    \r\n     \r\n      function isAdmin(Timesheets storage _timesheet, address _user) external view returns (bool);\r\n    }\r\n\r\n\r\nTimesheetProxy (PROXY) \r\n\r\n    pragma solidity ^0.4.23;\r\n    /**\r\n     * @title Proxy\r\n     * @dev Gives the possibility to delegate any call to a foreign implementation.\r\n     */\r\n     import '../registry/contract-registry.sol';\r\n     import '../registry/enabled.sol';\r\n\r\n    contract TimesheetProxy is Enabled {\r\n      /**\r\n      * @dev Fallback function allowing to perform a delegatecall to the given implementation.\r\n      * This function will return whatever the implementation call returns\r\n      */\r\n      function () payable public {\r\n        ContractRegistry contractRegistry = ContractRegistry(CMC);\r\n        address _impl = contractRegistry.getLibrary(\"timesheet\");\r\n        require(_impl != address(0));\r\n    \r\n        assembly {\r\n          let ptr := mload(0x40)\r\n          calldatacopy(ptr, 0, calldatasize)\r\n          let result := delegatecall(gas, _impl, ptr, calldatasize, 0, 0)\r\n          let size := returndatasize\r\n          returndatacopy(ptr, 0, size)\r\n    \r\n          switch result\r\n          case 0 { revert(ptr, size) }\r\n          default { return(ptr, size) }\r\n        }\r\n      }\r\n    }\r\n\r\n\r\nTimesheetLib (LIBRARY)\r\n\r\n    pragma solidity ^0.4.23;\r\n    \r\n    import '../interface/timesheet-interface.sol';\r\n    \r\n    library TimesheetLib {\r\n      event logApprovePeriod(address indexed user, uint start, uint end, bool closed);\r\n    \r\n      function isAdmin(TimesheetInterface.Timesheets storage _timesheet, address _user) external view returns (bool) {\r\n        return _timesheet.admins[_user];\r\n      }\r\n    }\r\n```\r\n\r\nAlso on stackexchange: https://ethereum.stackexchange.com/questions/53328/proxy-contract-library-reverts-cant-find-out-why-bounty",
  "closed_by": {
    "login": "chriseth",
    "id": 9073706,
    "node_id": "MDQ6VXNlcjkwNzM3MDY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/9073706?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/chriseth",
    "html_url": "https://github.com/chriseth",
    "followers_url": "https://api.github.com/users/chriseth/followers",
    "following_url": "https://api.github.com/users/chriseth/following{/other_user}",
    "gists_url": "https://api.github.com/users/chriseth/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/chriseth/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/chriseth/subscriptions",
    "organizations_url": "https://api.github.com/users/chriseth/orgs",
    "repos_url": "https://api.github.com/users/chriseth/repos",
    "events_url": "https://api.github.com/users/chriseth/events{/privacy}",
    "received_events_url": "https://api.github.com/users/chriseth/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/4510/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/solidity/issues/4510/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/404899349",
    "html_url": "https://github.com/ethereum/solidity/issues/4510#issuecomment-404899349",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/4510",
    "id": 404899349,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQwNDg5OTM0OQ==",
    "user": {
      "login": "chriseth",
      "id": 9073706,
      "node_id": "MDQ6VXNlcjkwNzM3MDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9073706?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chriseth",
      "html_url": "https://github.com/chriseth",
      "followers_url": "https://api.github.com/users/chriseth/followers",
      "following_url": "https://api.github.com/users/chriseth/following{/other_user}",
      "gists_url": "https://api.github.com/users/chriseth/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chriseth/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chriseth/subscriptions",
      "organizations_url": "https://api.github.com/users/chriseth/orgs",
      "repos_url": "https://api.github.com/users/chriseth/repos",
      "events_url": "https://api.github.com/users/chriseth/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chriseth/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-07-13T17:25:31Z",
    "updated_at": "2018-07-13T17:25:31Z",
    "author_association": "MEMBER",
    "body": "Most of the time, such behaviour is caused by not using a byzantium EVM in the testnet. Where do you run your smart contracts?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/404899349/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/404910521",
    "html_url": "https://github.com/ethereum/solidity/issues/4510#issuecomment-404910521",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/4510",
    "id": 404910521,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQwNDkxMDUyMQ==",
    "user": {
      "login": "kyriediculous",
      "id": 22256858,
      "node_id": "MDQ6VXNlcjIyMjU2ODU4",
      "avatar_url": "https://avatars.githubusercontent.com/u/22256858?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/kyriediculous",
      "html_url": "https://github.com/kyriediculous",
      "followers_url": "https://api.github.com/users/kyriediculous/followers",
      "following_url": "https://api.github.com/users/kyriediculous/following{/other_user}",
      "gists_url": "https://api.github.com/users/kyriediculous/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/kyriediculous/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/kyriediculous/subscriptions",
      "organizations_url": "https://api.github.com/users/kyriediculous/orgs",
      "repos_url": "https://api.github.com/users/kyriediculous/repos",
      "events_url": "https://api.github.com/users/kyriediculous/events{/privacy}",
      "received_events_url": "https://api.github.com/users/kyriediculous/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-07-13T18:07:58Z",
    "updated_at": "2018-07-13T18:07:58Z",
    "author_association": "NONE",
    "body": "I was using ganache 1.1.0 but got the same results using Remix JS VM. I haven't tested with Eth-clique yet.\r\n\r\nIt works now all of a sudden, I did some minor tweaks nothing breaking.\r\n\r\nI went through my entry point contract now (which I did before too but didn't work either) and it seems to work.\r\n\r\nThanks for the always quick replies!",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/404910521/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/407517000",
    "html_url": "https://github.com/ethereum/solidity/issues/4510#issuecomment-407517000",
    "issue_url": "https://api.github.com/repos/ethereum/solidity/issues/4510",
    "id": 407517000,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQwNzUxNzAwMA==",
    "user": {
      "login": "kyriediculous",
      "id": 22256858,
      "node_id": "MDQ6VXNlcjIyMjU2ODU4",
      "avatar_url": "https://avatars.githubusercontent.com/u/22256858?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/kyriediculous",
      "html_url": "https://github.com/kyriediculous",
      "followers_url": "https://api.github.com/users/kyriediculous/followers",
      "following_url": "https://api.github.com/users/kyriediculous/following{/other_user}",
      "gists_url": "https://api.github.com/users/kyriediculous/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/kyriediculous/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/kyriediculous/subscriptions",
      "organizations_url": "https://api.github.com/users/kyriediculous/orgs",
      "repos_url": "https://api.github.com/users/kyriediculous/repos",
      "events_url": "https://api.github.com/users/kyriediculous/events{/privacy}",
      "received_events_url": "https://api.github.com/users/kyriediculous/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-07-24T19:02:15Z",
    "updated_at": "2018-07-25T10:05:10Z",
    "author_association": "NONE",
    "body": "Nevermind.. forgot to set the contract manager address. RIP 20 Hours of my life... ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/solidity/issues/comments/407517000/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
