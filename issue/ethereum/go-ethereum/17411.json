{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/17411",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/17411/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/17411/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/17411/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/17411",
  "id": 350954649,
  "node_id": "MDU6SXNzdWUzNTA5NTQ2NDk=",
  "number": 17411,
  "title": "Possible memory leak with bind.NewTransactor()?",
  "user": {
    "login": "qbetti",
    "id": 5297551,
    "node_id": "MDQ6VXNlcjUyOTc1NTE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5297551?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/qbetti",
    "html_url": "https://github.com/qbetti",
    "followers_url": "https://api.github.com/users/qbetti/followers",
    "following_url": "https://api.github.com/users/qbetti/following{/other_user}",
    "gists_url": "https://api.github.com/users/qbetti/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/qbetti/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/qbetti/subscriptions",
    "organizations_url": "https://api.github.com/users/qbetti/orgs",
    "repos_url": "https://api.github.com/users/qbetti/repos",
    "events_url": "https://api.github.com/users/qbetti/events{/privacy}",
    "received_events_url": "https://api.github.com/users/qbetti/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2018-08-15T20:27:30Z",
  "updated_at": "2018-08-16T13:42:10Z",
  "closed_at": "2018-08-16T09:31:21Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "Hi everyone,\r\n\r\nJust sharing this little observation about the retrieval of private key using package bind.\r\n\r\n#### System information\r\n\r\nOS & Version: Windows, 32 bits\r\nCommit hash : 6d1e292eefa70b5cb76cd03ff61fc6c4550d7c36\r\n\r\n#### Expected behaviour\r\nThe result of `bind.NewKeyedTransactor(privateKey)` and `bind.NewTransactor(wallet, \"passphrase\")` should be the same (right?).\r\n\r\n#### Actual behaviour\r\n`bind.NewTransactor(wallet, \"passphrase\")` seems to allocate a huge amount of **persisting (leaking?)** memory (~256MB)\r\n\r\n#### Steps to reproduce the behaviour\r\nI observed that the following code results in a quite huge and **persisting** memory consumption:\r\n\r\n    import (\r\n        \"github.com/ethereum/go-ethereum/accounts/abi/bind\"\r\n    )\r\n\r\n    const WALLET_PATH string = \"my/wallet/path\"\r\n    func main() {\r\n        data, _ := ioutil.ReadFile(WALLET_PATH)\r\n\r\n        auth, _ := bind.NewTransactor(strings.NewReader(string(data)), \"\")\r\n        _ = auth\r\n\r\n        log.Fatal(http.ListenAndServe(\":8080\", nil))  \r\n        // the program always uses 256MB of memory\r\n    }\r\n\r\nWhereas the following, even though it produces (I think) a pointer to an identical object, results in a few MB persisting memory consumption: \r\n\r\n    import (\r\n        \"github.com/ethereum/go-ethereum/accounts/abi/bind\"\r\n    )\r\n\r\n    func main() {\r\n        privateKey, err := crypto.HexToECDSA(\"cba2dc76e88397f87cfa4705917fea76c7017a7c2958582095236dd272b507fa\")\r\n\r\n        if err != nil {\r\n            log.Fatal(err)\r\n        }\r\n\r\n        auth := bind.NewKeyedTransactor(privateKey)\r\n        _ = auth\r\n\r\n        log.Fatal(http.ListenAndServe(\":8080\", nil))  \r\n        // the program uses a few MB of memory\r\n    }\r\n\r\nWhy is that? Once the private key has been generated, the memory consumption of these programs should be roughly the same, right?\r\n\r\nThank you for your answers!\r\n",
  "closed_by": {
    "login": "karalabe",
    "id": 129561,
    "node_id": "MDQ6VXNlcjEyOTU2MQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/karalabe",
    "html_url": "https://github.com/karalabe",
    "followers_url": "https://api.github.com/users/karalabe/followers",
    "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
    "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
    "organizations_url": "https://api.github.com/users/karalabe/orgs",
    "repos_url": "https://api.github.com/users/karalabe/repos",
    "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
    "received_events_url": "https://api.github.com/users/karalabe/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/17411/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/17411/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/413478483",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/17411#issuecomment-413478483",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/17411",
    "id": 413478483,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQxMzQ3ODQ4Mw==",
    "user": {
      "login": "karalabe",
      "id": 129561,
      "node_id": "MDQ6VXNlcjEyOTU2MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/karalabe",
      "html_url": "https://github.com/karalabe",
      "followers_url": "https://api.github.com/users/karalabe/followers",
      "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
      "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
      "organizations_url": "https://api.github.com/users/karalabe/orgs",
      "repos_url": "https://api.github.com/users/karalabe/repos",
      "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
      "received_events_url": "https://api.github.com/users/karalabe/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-08-16T09:10:14Z",
    "updated_at": "2018-08-16T09:10:54Z",
    "author_association": "MEMBER",
    "body": "The key files are encrypted with an algorithm called `scrypt`, which ensures that it takes a lot of effort to decrypt them, both computationally and memory consumption wise. A single decryption is targeted to take about 1 second on a modern machine and require 256MB of memory. This is the reason why accessing an encrypted private key will take a memory hit, but using the decryped key directly will not.\r\n\r\nAs to why the memory consumption persists, it's because Go's garbage collector holds on to allocated memory and will only return it to the system after some amount of time (2 or 5 minutes, not sure), to avoid constantly requesting/returning memory. If you wait about 5+ minutes, the memory consumption of the first program will drop down to the same level as the second one.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/413478483/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/413549675",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/17411#issuecomment-413549675",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/17411",
    "id": 413549675,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQxMzU0OTY3NQ==",
    "user": {
      "login": "qbetti",
      "id": 5297551,
      "node_id": "MDQ6VXNlcjUyOTc1NTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5297551?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/qbetti",
      "html_url": "https://github.com/qbetti",
      "followers_url": "https://api.github.com/users/qbetti/followers",
      "following_url": "https://api.github.com/users/qbetti/following{/other_user}",
      "gists_url": "https://api.github.com/users/qbetti/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/qbetti/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/qbetti/subscriptions",
      "organizations_url": "https://api.github.com/users/qbetti/orgs",
      "repos_url": "https://api.github.com/users/qbetti/repos",
      "events_url": "https://api.github.com/users/qbetti/events{/privacy}",
      "received_events_url": "https://api.github.com/users/qbetti/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-08-16T13:42:10Z",
    "updated_at": "2018-08-16T13:42:10Z",
    "author_association": "NONE",
    "body": "Your answer is very clear and much appreciated!\r\nThank you, sir!\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/413549675/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
