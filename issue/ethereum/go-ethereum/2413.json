{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2413",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2413/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2413/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2413/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/2413",
  "id": 145565594,
  "node_id": "MDU6SXNzdWUxNDU1NjU1OTQ=",
  "number": 2413,
  "title": "More efficient storage of headers/blocks",
  "user": {
    "login": "zsfelfoldi",
    "id": 9884311,
    "node_id": "MDQ6VXNlcjk4ODQzMTE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/9884311?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/zsfelfoldi",
    "html_url": "https://github.com/zsfelfoldi",
    "followers_url": "https://api.github.com/users/zsfelfoldi/followers",
    "following_url": "https://api.github.com/users/zsfelfoldi/following{/other_user}",
    "gists_url": "https://api.github.com/users/zsfelfoldi/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/zsfelfoldi/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/zsfelfoldi/subscriptions",
    "organizations_url": "https://api.github.com/users/zsfelfoldi/orgs",
    "repos_url": "https://api.github.com/users/zsfelfoldi/repos",
    "events_url": "https://api.github.com/users/zsfelfoldi/events{/privacy}",
    "received_events_url": "https://api.github.com/users/zsfelfoldi/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 72233652,
      "node_id": "MDU6TGFiZWw3MjIzMzY1Mg==",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/type:feature",
      "name": "type:feature",
      "color": "84b6eb",
      "default": false,
      "description": null
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/milestones/26",
    "html_url": "https://github.com/ethereum/go-ethereum/milestone/26",
    "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/milestones/26/labels",
    "id": 1593424,
    "node_id": "MDk6TWlsZXN0b25lMTU5MzQyNA==",
    "number": 26,
    "title": "1.5.0",
    "description": "",
    "creator": {
      "login": "karalabe",
      "id": 129561,
      "node_id": "MDQ6VXNlcjEyOTU2MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/karalabe",
      "html_url": "https://github.com/karalabe",
      "followers_url": "https://api.github.com/users/karalabe/followers",
      "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
      "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
      "organizations_url": "https://api.github.com/users/karalabe/orgs",
      "repos_url": "https://api.github.com/users/karalabe/repos",
      "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
      "received_events_url": "https://api.github.com/users/karalabe/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 0,
    "closed_issues": 74,
    "state": "closed",
    "created_at": "2016-02-19T15:55:33Z",
    "updated_at": "2019-02-19T11:15:37Z",
    "due_on": null,
    "closed_at": "2016-11-15T21:55:24Z"
  },
  "comments": 3,
  "created_at": "2016-04-04T02:08:10Z",
  "updated_at": "2016-11-15T16:58:56Z",
  "closed_at": "2016-11-15T16:58:56Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "Currently, headers are stored in chainDb with the key formatted as \"block-HASH-header\". This way they are scattered randomly within the \"block-\" key prefix range, which slows down database access of continous block number ranges significantly, which is a major limiting factor for the speed of header downloads, both on the request serving and the downloading side.\nInstead, we should use something like \"block-NUMBER-HASH-header\" where number is encoded as a big endian uint64. Canonical hashes could be stored on \"block-NUMBER-hash\" (so that they are interleaved with the actual data). Although we usually know the number of the block/header we're accessing, there are some exceptions when we only know the hash so the canonical assignments should be stored in both directions, block numbers being stored at \"blocknum-HASH\".\nThe same approach can be used for TDs, bodies and receipts too, although storing the bodies/receipts on separate key ranges (like \"body-NUMBER-HASH\" and \"receipt-NUMBER-HASH\") might be a good idea because we're downloading headers and bodies/receipts separately.\n",
  "closed_by": {
    "login": "fjl",
    "id": 6915,
    "node_id": "MDQ6VXNlcjY5MTU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6915?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/fjl",
    "html_url": "https://github.com/fjl",
    "followers_url": "https://api.github.com/users/fjl/followers",
    "following_url": "https://api.github.com/users/fjl/following{/other_user}",
    "gists_url": "https://api.github.com/users/fjl/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/fjl/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/fjl/subscriptions",
    "organizations_url": "https://api.github.com/users/fjl/orgs",
    "repos_url": "https://api.github.com/users/fjl/repos",
    "events_url": "https://api.github.com/users/fjl/events{/privacy}",
    "received_events_url": "https://api.github.com/users/fjl/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2413/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2413/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/205185243",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/2413#issuecomment-205185243",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2413",
    "id": 205185243,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIwNTE4NTI0Mw==",
    "user": {
      "login": "karalabe",
      "id": 129561,
      "node_id": "MDQ6VXNlcjEyOTU2MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/karalabe",
      "html_url": "https://github.com/karalabe",
      "followers_url": "https://api.github.com/users/karalabe/followers",
      "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
      "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
      "organizations_url": "https://api.github.com/users/karalabe/orgs",
      "repos_url": "https://api.github.com/users/karalabe/repos",
      "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
      "received_events_url": "https://api.github.com/users/karalabe/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-04-04T08:14:40Z",
    "updated_at": "2016-04-04T08:14:40Z",
    "author_association": "MEMBER",
    "body": "We can most definitely consider this, but I'm not sure it's that simple as you think it is.\n\nInternally our code mostly uses hashes for almost everything. Adding the block number into the keys would mean that we either have to resolve the numbers all the time, or pass the block number along with the hash when we do a lookup. The latter is imho the only workable solution but does increase code complexity a bit.\n\nAs you already mentioned, sometimes we do need hash->number lookups if we only have the hash, so storing individual mappings is also a must. Storing another set of keys at a completely different location may have a bigger impact than the gain.\n\nHowever, our current database bottleneck is compaction: when lower levels of the database gets filled p with semi random data and they need to be merged into higher levels. From this perspective, your suggestion is actually very good one: since our chain data is mostly ordered by block number, storing thme like that on disk would limit the scope of compaction in the database. We do need to update a different location (that is random still because of the hashes), but since the bulk of the data is in the sorted part and the random hash part are tiny (only a number mapping), perhaps the negative effects of the extra data/compaction is less than the positive effects on the content compaction.\n\nRegarding splitting the individual components to header- body- receipt-, I'm not sure about that since during normal operation we need the header, body and receipts at the same time for a block, it it might be worth to keep them close (in the same database block, so when one is retrieved all others are).\n\nAll in all I think we need a ton of benchmarks and whatnot to figure this one out, but it's an idea definitely worth investigating.\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/205185243/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/205205274",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/2413#issuecomment-205205274",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2413",
    "id": 205205274,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIwNTIwNTI3NA==",
    "user": {
      "login": "zsfelfoldi",
      "id": 9884311,
      "node_id": "MDQ6VXNlcjk4ODQzMTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9884311?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/zsfelfoldi",
      "html_url": "https://github.com/zsfelfoldi",
      "followers_url": "https://api.github.com/users/zsfelfoldi/followers",
      "following_url": "https://api.github.com/users/zsfelfoldi/following{/other_user}",
      "gists_url": "https://api.github.com/users/zsfelfoldi/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/zsfelfoldi/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/zsfelfoldi/subscriptions",
      "organizations_url": "https://api.github.com/users/zsfelfoldi/orgs",
      "repos_url": "https://api.github.com/users/zsfelfoldi/repos",
      "events_url": "https://api.github.com/users/zsfelfoldi/events{/privacy}",
      "received_events_url": "https://api.github.com/users/zsfelfoldi/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-04-04T09:11:02Z",
    "updated_at": "2016-04-04T09:14:59Z",
    "author_association": "MEMBER",
    "body": "@karalabe I didn't think that this is trivial either :) But I also don't think it's extremely hard since everything would remain accessible by hash. We could even keep the access functions with old semantics and add new ones which are more efficient for accessing a large number of consecutive block data. Those will mainly be used by the protocol handler serving download messages.\nThe only problem I see is the format of GetBlockBodies and GetReceipts messages because they only contain hashes. Maybe we could solve this without changing the message formats by caching hash->number associations because downloaders usually get bodies and receipts not long after headers. Maybe we don't even need new semantics for the db access, we could just automatically cache hash->number associations in GetCanonicalHash.\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/205205274/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/260699892",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/2413#issuecomment-260699892",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2413",
    "id": 260699892,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI2MDY5OTg5Mg==",
    "user": {
      "login": "fjl",
      "id": 6915,
      "node_id": "MDQ6VXNlcjY5MTU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6915?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjl",
      "html_url": "https://github.com/fjl",
      "followers_url": "https://api.github.com/users/fjl/followers",
      "following_url": "https://api.github.com/users/fjl/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjl/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjl/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjl/subscriptions",
      "organizations_url": "https://api.github.com/users/fjl/orgs",
      "repos_url": "https://api.github.com/users/fjl/repos",
      "events_url": "https://api.github.com/users/fjl/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjl/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-11-15T16:58:56Z",
    "updated_at": "2016-11-15T16:58:56Z",
    "author_association": "MEMBER",
    "body": "Fix released in 1.5.0.\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/260699892/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
