{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22492",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22492/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22492/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22492/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/22492",
  "id": 830492407,
  "node_id": "MDU6SXNzdWU4MzA0OTI0MDc=",
  "number": 22492,
  "title": "OOM Error Destroyed Previously Finished Snapshot",
  "user": {
    "login": "Propulsions",
    "id": 7483106,
    "node_id": "MDQ6VXNlcjc0ODMxMDY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/7483106?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Propulsions",
    "html_url": "https://github.com/Propulsions",
    "followers_url": "https://api.github.com/users/Propulsions/followers",
    "following_url": "https://api.github.com/users/Propulsions/following{/other_user}",
    "gists_url": "https://api.github.com/users/Propulsions/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Propulsions/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Propulsions/subscriptions",
    "organizations_url": "https://api.github.com/users/Propulsions/orgs",
    "repos_url": "https://api.github.com/users/Propulsions/repos",
    "events_url": "https://api.github.com/users/Propulsions/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Propulsions/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 268304226,
      "node_id": "MDU6TGFiZWwyNjgzMDQyMjY=",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/type:docs",
      "name": "type:docs",
      "color": "fef2c0",
      "default": false,
      "description": null
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2021-03-12T21:29:50Z",
  "updated_at": "2021-03-17T16:58:18Z",
  "closed_at": "2021-03-17T16:58:18Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "Good afternoon,\r\n\r\nThis morning my Geth process was terminated due to running out of memory.\r\n\r\nThis in turn resulted in the snapshot being completely destroyed and now the Geth process is rebuilding said snapshot anew. \r\n\r\nI'm not sure if this is a bug or not hence using the question format.\r\n\r\nHere are some logs from the occurrence: \r\n\r\n\r\n### Initial killing & restart of the process\r\n\r\n```\r\nMar 12 04:15:17 Out of memory: Killed process 95602 (mainnet_geth) total-vm:20687808kB, anon-rss:16443908kB, file-rss:0kB, shmem-rss:0kB, UID:1001\r\nMar 12 04:15:17 systemd[1]: mn_geth.service: Main process exited, code=killed, status=9/KILL\r\nMar 12 04:15:17 systemd[1]: mn_geth.service: Failed with result 'signal'.\r\nMar 12 04:16:17 systemd[1]: mn_geth.service: Service RestartSec=1min expired, scheduling restart.\r\nMar 12 04:16:17 systemd[1]: mn_geth.service: Scheduled restart job, restart counter is at 3.\r\nMar 12 04:16:17 systemd[1]: Stopped Ethereum Mainnet Go Client.\r\nMar 12 04:16:17 systemd[1]: Started Ethereum Mainnet Go Client.\r\n```\r\n\r\n### Initial logs of start up (note there is a time gap of ~3.5 hours) \r\n\r\n```\r\nMar 12 07:22:39 systemd[1]: Started Ethereum Mainnet Go Client.\r\nINFO [03-12|07:22:39.602] Starting Geth on Ethereum mainnet...\r\nINFO [03-12|07:22:40.558] Initialising Ethereum protocol           network=1 dbversion=8\r\nINFO [03-12|07:22:41.056] Loaded most recent local header          number=12021376 hash=\"e47b9c…859328\" td=21950673763029669596104 age=10h35m30s\r\nINFO [03-12|07:22:41.056] Loaded most recent local full block      number=0        hash=\"d4e567…cb8fa3\" td=17179869184             age=51y11mo1w\r\nINFO [03-12|07:22:41.056] Loaded most recent local fast block      number=12021376 hash=\"e47b9c…859328\" td=21950673763029669596104 age=10h35m30s\r\nINFO [03-12|07:22:41.056] Loaded last fast-sync pivot marker       number=12023349\r\nWARN [03-12|07:22:41.059] Enabling snapshot recovery               chainhead=0 diskbase=12022586\r\nWARN [03-12|07:22:41.066] Loaded snapshot journal                  diskroot=\"ab991a…769315\" diffs=unmatched\r\nWARN [03-12|07:22:41.066] Snapshot is not continuous with chain    snaproot=\"ab991a…769315\" chainroot=\"d7f897…0f0544\"\r\nINFO [03-12|07:22:41.066] Loaded local transaction journal         transactions=0 dropped=0\r\nINFO [03-12|07:22:41.067] Regenerated local transaction journal    transactions=0 accounts=0\r\nINFO [03-12|07:22:41.097] Allocated fast sync bloom                size=5.19GiB\r\n```\r\n\r\n### GETH synchronizes until at current block\r\n\r\n```\r\nINFO [03-12|07:59:29.315] Imported new state entries               count=1061 elapsed=8.029ms     processed=682754782 pending=0     trieretry=0>\r\nINFO [03-12|07:59:29.319] Imported new block receipts              count=1    elapsed=2.372ms     number=12024243 hash=\"62cba6…f37a2c\" age=22m2>\r\nINFO [03-12|07:59:29.319] Rebuilding state snapshot\r\nINFO [03-12|07:59:29.319] Committed new head block                 number=12024243 hash=\"62cba6…f37a2c\"\r\nINFO [03-12|07:59:29.378] Deallocated state bloom                  items=760608906 errorrate=0.000\r\n```\r\n\r\n### GETH purges the entire (already completed) snapshot\r\n\r\n```\r\nINFO [03-12|09:29:29.476] Wiper running, state snapshotting paused accounts=0 slots=0 storage=0.00B elapsed=1h30m0.157s\r\nINFO [03-12|07:59:32.352] Wiper running, state snapshotting paused accounts=0 slots=0 storage=0.00B elapsed=3.032s\r\nINFO [03-12|09:29:38.806] Compacted snapshot area in database      elapsed=42m20.011s\r\nINFO [03-12|09:29:38.806] Resuming state snapshot generation       root=\"2fa1b6…41bca1\" accounts=0 slots=0 storage=0.00B elapsed=\"6.732µs\"\r\n```\r\n\r\n### Normal operation (albeit building a brand new snapshot)\r\n\r\n```\r\nINFO [03-12|09:29:46.818] Generating state snapshot                root=\"2fa1b6…41bca1\" at=\"00060b…c282b6\" accounts=11271 slots=5715 storage=99>\r\nINFO [03-12|09:29:47.632] Aborting state snapshot generation       root=\"2fa1b6…41bca1\" at=\"0006c5…252edd\" accounts=12644 slots=6179 storage=1.>\r\nINFO [03-12|09:29:47.632] Resuming state snapshot generation       root=\"7fa798…06e1e5\" at=\"0006c5…252edd\" accounts=12644 slots=6179 storage=1.>\r\nINFO [03-12|09:29:47.645] Imported new chain segment               blocks=1       txs=203       mgas=12.483  elapsed=273.903ms    mgasps=45.576>\r\n```\r\n\r\nLet me know if any additional info is needed. ",
  "closed_by": {
    "login": "Propulsions",
    "id": 7483106,
    "node_id": "MDQ6VXNlcjc0ODMxMDY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/7483106?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Propulsions",
    "html_url": "https://github.com/Propulsions",
    "followers_url": "https://api.github.com/users/Propulsions/followers",
    "following_url": "https://api.github.com/users/Propulsions/following{/other_user}",
    "gists_url": "https://api.github.com/users/Propulsions/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Propulsions/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Propulsions/subscriptions",
    "organizations_url": "https://api.github.com/users/Propulsions/orgs",
    "repos_url": "https://api.github.com/users/Propulsions/repos",
    "events_url": "https://api.github.com/users/Propulsions/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Propulsions/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22492/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22492/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/800887931",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/22492#issuecomment-800887931",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22492",
    "id": 800887931,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwMDg4NzkzMQ==",
    "user": {
      "login": "karalabe",
      "id": 129561,
      "node_id": "MDQ6VXNlcjEyOTU2MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/karalabe",
      "html_url": "https://github.com/karalabe",
      "followers_url": "https://api.github.com/users/karalabe/followers",
      "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
      "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
      "organizations_url": "https://api.github.com/users/karalabe/orgs",
      "repos_url": "https://api.github.com/users/karalabe/repos",
      "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
      "received_events_url": "https://api.github.com/users/karalabe/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-17T08:15:21Z",
    "updated_at": "2021-03-17T08:15:21Z",
    "author_association": "MEMBER",
    "body": "If Geth crashes, it may or may not be able to recover the snapshot from an older version (depends on what snapshot was written to disk before and what state trie). If it cannot or some metadata is missing, Geth will wipe the old snapshot and regenerate from scratch. @rjl493456442 and @holiman are working on a snapshot healer that will be able to verify and only fix corrupted segments. That would also take a few hours, but a lot better than restart from 0. For now, it's a bit painful.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/800887931/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/801248438",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/22492#issuecomment-801248438",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22492",
    "id": 801248438,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwMTI0ODQzOA==",
    "user": {
      "login": "Propulsions",
      "id": 7483106,
      "node_id": "MDQ6VXNlcjc0ODMxMDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7483106?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Propulsions",
      "html_url": "https://github.com/Propulsions",
      "followers_url": "https://api.github.com/users/Propulsions/followers",
      "following_url": "https://api.github.com/users/Propulsions/following{/other_user}",
      "gists_url": "https://api.github.com/users/Propulsions/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Propulsions/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Propulsions/subscriptions",
      "organizations_url": "https://api.github.com/users/Propulsions/orgs",
      "repos_url": "https://api.github.com/users/Propulsions/repos",
      "events_url": "https://api.github.com/users/Propulsions/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Propulsions/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-17T16:58:18Z",
    "updated_at": "2021-03-17T16:58:18Z",
    "author_association": "NONE",
    "body": "Good to know, just wanted to bring to attention. \r\n\r\nAfter the second rebuild -- and not running of of memory -- everything is stable and working as expected.\r\n\r\nThanks!",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/801248438/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
