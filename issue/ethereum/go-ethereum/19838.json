{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19838",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19838/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19838/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19838/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/19838",
  "id": 468334685,
  "node_id": "MDU6SXNzdWU0NjgzMzQ2ODU=",
  "number": 19838,
  "title": "eth/downloader: peers dropped during sync after non-graceful restart",
  "user": {
    "login": "vdamle",
    "id": 5338861,
    "node_id": "MDQ6VXNlcjUzMzg4NjE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5338861?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/vdamle",
    "html_url": "https://github.com/vdamle",
    "followers_url": "https://api.github.com/users/vdamle/followers",
    "following_url": "https://api.github.com/users/vdamle/following{/other_user}",
    "gists_url": "https://api.github.com/users/vdamle/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/vdamle/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/vdamle/subscriptions",
    "organizations_url": "https://api.github.com/users/vdamle/orgs",
    "repos_url": "https://api.github.com/users/vdamle/repos",
    "events_url": "https://api.github.com/users/vdamle/events{/privacy}",
    "received_events_url": "https://api.github.com/users/vdamle/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/milestones/100",
    "html_url": "https://github.com/ethereum/go-ethereum/milestone/100",
    "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/milestones/100/labels",
    "id": 5283961,
    "node_id": "MDk6TWlsZXN0b25lNTI4Mzk2MQ==",
    "number": 100,
    "title": "1.9.14",
    "description": "",
    "creator": {
      "login": "adamschmideg",
      "id": 208822,
      "node_id": "MDQ6VXNlcjIwODgyMg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/208822?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/adamschmideg",
      "html_url": "https://github.com/adamschmideg",
      "followers_url": "https://api.github.com/users/adamschmideg/followers",
      "following_url": "https://api.github.com/users/adamschmideg/following{/other_user}",
      "gists_url": "https://api.github.com/users/adamschmideg/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/adamschmideg/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/adamschmideg/subscriptions",
      "organizations_url": "https://api.github.com/users/adamschmideg/orgs",
      "repos_url": "https://api.github.com/users/adamschmideg/repos",
      "events_url": "https://api.github.com/users/adamschmideg/events{/privacy}",
      "received_events_url": "https://api.github.com/users/adamschmideg/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 0,
    "closed_issues": 58,
    "state": "closed",
    "created_at": "2020-04-07T08:58:23Z",
    "updated_at": "2020-05-13T14:32:38Z",
    "due_on": null,
    "closed_at": "2020-05-13T14:32:38Z"
  },
  "comments": 4,
  "created_at": "2019-07-15T21:04:11Z",
  "updated_at": "2020-08-27T08:59:28Z",
  "closed_at": "2020-04-30T08:25:28Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "#### System information\r\n\r\nGeth version: `1.8.27-stable`\r\nOS & Version: Linux (running in docker/k8s)\r\nCommit hash : n/a\r\nDeployment info: `Private chain running Clique/POA`\r\n\r\n#### Expected behaviour\r\n\r\nGeth running in `--syncmode full --gcmode full` should sync blocks from peers without undergoing many disconnect/reconnect with peers\r\n\r\n#### Actual behaviour\r\n\r\nAfter a non-graceful shutdown of geth, we see that the node comes back up and detects a chain repair is required and starts syncing blocks:\r\n```\r\nWARN [07-15|20:24:20.549] Head state missing, repairing chain      number=2081 hash=6e6f16...e289b5\r\nINFO [07-15|20:24:20.731] Rewound blockchain to past state         number=78   hash=6399d6...fe7530\r\nINFO [07-15|20:24:20.732] Loaded most recent local header          number=2081 hash=6e6f16...e289b5 td=4044 age=5s\r\nINFO [07-15|20:24:20.732] Loaded most recent local full block      number=78   hash=6399d6...fe7530 td=118  age=2h47m\r\nINFO [07-15|20:24:20.732] Loaded most recent local fast block      number=2081 hash=6e6f16...e289b5 td=4044 age=5s\r\n```\r\nHowever, there are a large number of occurrences of:\r\n```\r\nDEBUG[07-15|20:24:25.421] Injected sidechain block                 number=2082 hash=395bb7...857978 diff=1       elapsed=150.22..s txs=0 gas=0 uncles=0 root=fab954...f27d40\r\nDEBUG[07-15|20:24:25.421] Injected sidechain block                 number=2083 hash=f744d6...2d2c0a diff=1       elapsed=28.389..s txs=0 gas=0 uncles=0 root=fab954...f27d40\r\nINFO [07-15|20:24:25.613] Importing sidechain segment              start=79 end=2083\r\nDEBUG[07-15|20:24:25.617] Trie cache stats after commit            misses=0 unloads=0\r\nDEBUG[07-15|20:24:25.617] Inserted new block                       number=79   hash=8f59ec...47d999 uncles=0 txs=1 gas=134093 elapsed=521.593..s root=96304f...2891cc\r\nDEBUG[07-15|20:24:25.617] Downloaded item processing failed        number=2083 hash=f744d6...2d2c0a err=\"block already known\"\r\nDEBUG[07-15|20:24:25.617] Synchronisation terminated               elapsed=256.19099ms\r\nWARN [07-15|20:24:25.617] Synchronisation failed, dropping peer    peer=c85f63d15a577220 err=\"retrieved hash chain is invalid\"\r\nDEBUG[07-15|20:24:25.617] Removing Ethereum peer                   peer=c85f63d15a577220\r\nDEBUG[07-15|20:24:25.617] Ethereum message handling failed         id=c85f63d15a577220 conn=staticdial err=EOF\r\nDEBUG[07-15|20:24:25.617] Removing p2p peer                        id=c85f63d15a577220 conn=staticdial duration=4.877s peers=2 req=false err=\"useless peer\"\r\n```\r\n..which results in peers getting continually dropped/re-added. On a peer, we see the following toggles in connection:\r\n\r\n```\r\nDEBUG[07-15|20:24:19.466] Removing Ethereum peer                   peer=5d0ba95fe7036068\r\nDEBUG[07-15|20:24:20.740] Ethereum peer connected                  id=5d0ba95fe7036068 conn=inbound    name=Geth/v1.8.27-stable/linux-amd64/go1.11.11\r\nDEBUG[07-15|20:24:25.617] Removing Ethereum peer                   peer=5d0ba95fe7036068\r\nDEBUG[07-15|20:24:49.470] Ethereum peer connected                  id=5d0ba95fe7036068 conn=staticdial name=Geth/v1.8.27-stable/linux-amd64/go1.11.11\r\nDEBUG[07-15|20:24:50.945] Removing Ethereum peer                   peer=5d0ba95fe7036068\r\nDEBUG[07-15|20:24:50.948] Ethereum peer connected                  id=5d0ba95fe7036068 conn=inbound    name=Geth/v1.8.27-stable/linux-amd64/go1.11.11\r\nDEBUG[07-15|20:25:05.026] Removing Ethereum peer                   peer=5d0ba95fe7036068\r\nDEBUG[07-15|20:25:19.477] Ethereum peer connected                  id=5d0ba95fe7036068 conn=staticdial name=Geth/v1.8.27-stable/linux-amd64/go1.11.11\r\nDEBUG[07-15|20:25:20.816] Removing Ethereum peer                   peer=5d0ba95fe7036068\r\nDEBUG[07-15|20:25:20.954] Ethereum peer connected                  id=5d0ba95fe7036068 conn=inbound    name=Geth/v1.8.27-stable/linux-amd64/go1.11.11\r\nDEBUG[07-15|20:25:30.816] Removing Ethereum peer                   peer=5d0ba95fe7036068\r\nDEBUG[07-15|20:25:49.512] Ethereum peer connected                  id=5d0ba95fe7036068 conn=staticdial name=Geth/v1.8.27-stable/linux-amd64/go1.11.11\r\nDEBUG[07-15|20:25:50.816] Removing Ethereum peer                   peer=5d0ba95fe7036068\r\nDEBUG[07-15|20:25:50.957] Ethereum peer connected                  id=5d0ba95fe7036068 conn=inbound    name=Geth/v1.8.27-stable/linux-amd64/go1.11.11\r\nDEBUG[07-15|20:26:05.115] Removing Ethereum peer                   peer=5d0ba95fe7036068\r\nDEBUG[07-15|20:26:19.517] Ethereum peer connected                  id=5d0ba95fe7036068 conn=staticdial name=Geth/v1.8.27-stable/linux-amd64/go1.11.11\r\nDEBUG[07-15|20:26:25.518] Removing Ethereum peer                   peer=5d0ba95fe7036068\r\nDEBUG[07-15|20:26:25.522] Ethereum peer connected                  id=5d0ba95fe7036068 conn=inbound    name=Geth/v1.8.27-stable/linux-amd64/go1.11.11\r\nDEBUG[07-15|20:26:30.815] Removing Ethereum peer                   peer=5d0ba95fe7036068\r\nDEBUG[07-15|20:26:49.614] Ethereum peer connected                  id=5d0ba95fe7036068 conn=staticdial name=Geth/v1.8.27-stable/linux-amd64/go1.11.11\r\nDEBUG[07-15|20:26:55.728] Removing Ethereum peer                   peer=5d0ba95fe7036068\r\nDEBUG[07-15|20:26:55.731] Ethereum peer connected                  id=5d0ba95fe7036068 conn=inbound    name=Geth/v1.8.27-stable/linux-amd64/go1.11.11\r\nDEBUG[07-15|20:27:00.814] Removing Ethereum peer                   peer=5d0ba95fe7036068\r\nDEBUG[07-15|20:27:19.714] Ethereum peer connected                  id=5d0ba95fe7036068 conn=staticdial name=Geth/v1.8.27-stable/linux-amd64/go1.11.11\r\nDEBUG[07-15|20:27:25.421] Removing Ethereum peer                   peer=5d0ba95fe7036068\r\nDEBUG[07-15|20:27:25.814] Ethereum peer connected                  id=5d0ba95fe7036068 conn=inbound    name=Geth/v1.8.27-stable/linux-amd64/go1.11.11\r\nDEBUG[07-15|20:27:30.812] Removing Ethereum peer                   peer=5d0ba95fe7036068\r\nDEBUG[07-15|20:27:49.720] Ethereum peer connected                  id=5d0ba95fe7036068 conn=staticdial name=Geth/v1.8.27-stable/linux-amd64/go1.11.11\r\n```\r\n\r\n The above log is from a chain with very low block height ~2k. This problem is more acute in chains with a large block height and the catch-up does not complete. \r\n\r\n#### Steps to reproduce the behaviour\r\n\r\n* Bring up a 3 or 4 node Geth chain with nodes running `1.8.27-stable` with `Clique/POA` \r\n* Kill one of the geth nodes in a non-graceful manner (so that geth is not able to process interrupt and shutdown cleanly)\r\n\r\n#### Backtrace\r\n\r\n````\r\n[backtrace]\r\n````\r\n\r\n[node-after-restart-geth.log](https://github.com/ethereum/go-ethereum/files/3394195/node-after-restart-geth.log)\r\n[neighbor-node-geth.log](https://github.com/ethereum/go-ethereum/files/3394196/neighbor-node-geth.log)\r\n",
  "closed_by": {
    "login": "adamschmideg",
    "id": 208822,
    "node_id": "MDQ6VXNlcjIwODgyMg==",
    "avatar_url": "https://avatars.githubusercontent.com/u/208822?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/adamschmideg",
    "html_url": "https://github.com/adamschmideg",
    "followers_url": "https://api.github.com/users/adamschmideg/followers",
    "following_url": "https://api.github.com/users/adamschmideg/following{/other_user}",
    "gists_url": "https://api.github.com/users/adamschmideg/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/adamschmideg/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/adamschmideg/subscriptions",
    "organizations_url": "https://api.github.com/users/adamschmideg/orgs",
    "repos_url": "https://api.github.com/users/adamschmideg/repos",
    "events_url": "https://api.github.com/users/adamschmideg/events{/privacy}",
    "received_events_url": "https://api.github.com/users/adamschmideg/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19838/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19838/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/511717594",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/19838#issuecomment-511717594",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19838",
    "id": 511717594,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUxMTcxNzU5NA==",
    "user": {
      "login": "fjl",
      "id": 6915,
      "node_id": "MDQ6VXNlcjY5MTU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6915?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjl",
      "html_url": "https://github.com/fjl",
      "followers_url": "https://api.github.com/users/fjl/followers",
      "following_url": "https://api.github.com/users/fjl/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjl/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjl/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjl/subscriptions",
      "organizations_url": "https://api.github.com/users/fjl/orgs",
      "repos_url": "https://api.github.com/users/fjl/repos",
      "events_url": "https://api.github.com/users/fjl/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjl/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-07-16T08:23:59Z",
    "updated_at": "2019-07-16T08:24:57Z",
    "author_association": "MEMBER",
    "body": "Root cause of the issue is probably this error: \r\n```\r\nDEBUG[07-15|20:24:25.617] Downloaded item processing failed        number=2083 hash=f744d6...2d2c0a err=\"block already known\"\r\n```\r\n\r\nIf the internal fast sync head is not updated on shutdown, blocks above the known head might already be in the database. eth/downloader should handle that better.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/511717594/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/512140216",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/19838#issuecomment-512140216",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19838",
    "id": 512140216,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUxMjE0MDIxNg==",
    "user": {
      "login": "karalabe",
      "id": 129561,
      "node_id": "MDQ6VXNlcjEyOTU2MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/karalabe",
      "html_url": "https://github.com/karalabe",
      "followers_url": "https://api.github.com/users/karalabe/followers",
      "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
      "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
      "organizations_url": "https://api.github.com/users/karalabe/orgs",
      "repos_url": "https://api.github.com/users/karalabe/repos",
      "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
      "received_events_url": "https://api.github.com/users/karalabe/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-07-17T07:37:28Z",
    "updated_at": "2019-07-17T07:37:28Z",
    "author_association": "MEMBER",
    "body": "As far as I know we've already fixed this a long time ago, please try with 1.9.0.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/512140216/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/512260212",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/19838#issuecomment-512260212",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19838",
    "id": 512260212,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUxMjI2MDIxMg==",
    "user": {
      "login": "vdamle",
      "id": 5338861,
      "node_id": "MDQ6VXNlcjUzMzg4NjE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5338861?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vdamle",
      "html_url": "https://github.com/vdamle",
      "followers_url": "https://api.github.com/users/vdamle/followers",
      "following_url": "https://api.github.com/users/vdamle/following{/other_user}",
      "gists_url": "https://api.github.com/users/vdamle/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vdamle/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vdamle/subscriptions",
      "organizations_url": "https://api.github.com/users/vdamle/orgs",
      "repos_url": "https://api.github.com/users/vdamle/repos",
      "events_url": "https://api.github.com/users/vdamle/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vdamle/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-07-17T13:43:20Z",
    "updated_at": "2019-07-17T13:43:20Z",
    "author_association": "CONTRIBUTOR",
    "body": "Thank you @karalabe . Pretty sure you are referring to https://github.com/ethereum/go-ethereum/pull/19544 . Unfortunately, we are not in a position to upgrade to 1.9 right away. I'm happy to try to patch relevant changes from that PR to the 1.8 branch. Can you please help review it?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/512260212/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/621690593",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/19838#issuecomment-621690593",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19838",
    "id": 621690593,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyMTY5MDU5Mw==",
    "user": {
      "login": "adamschmideg",
      "id": 208822,
      "node_id": "MDQ6VXNlcjIwODgyMg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/208822?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/adamschmideg",
      "html_url": "https://github.com/adamschmideg",
      "followers_url": "https://api.github.com/users/adamschmideg/followers",
      "following_url": "https://api.github.com/users/adamschmideg/following{/other_user}",
      "gists_url": "https://api.github.com/users/adamschmideg/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/adamschmideg/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/adamschmideg/subscriptions",
      "organizations_url": "https://api.github.com/users/adamschmideg/orgs",
      "repos_url": "https://api.github.com/users/adamschmideg/repos",
      "events_url": "https://api.github.com/users/adamschmideg/events{/privacy}",
      "received_events_url": "https://api.github.com/users/adamschmideg/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-04-30T08:25:28Z",
    "updated_at": "2020-04-30T08:25:28Z",
    "author_association": "MEMBER",
    "body": "It's fixed",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/621690593/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
