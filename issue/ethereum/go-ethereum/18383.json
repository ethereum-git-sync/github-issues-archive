{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18383",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18383/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18383/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18383/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/18383",
  "id": 395471081,
  "node_id": "MDU6SXNzdWUzOTU0NzEwODE=",
  "number": 18383,
  "title": "Can't get the correct balance of a token after I restart geth node within docker",
  "user": {
    "login": "wangjunbao2018",
    "id": 42427383,
    "node_id": "MDQ6VXNlcjQyNDI3Mzgz",
    "avatar_url": "https://avatars.githubusercontent.com/u/42427383?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/wangjunbao2018",
    "html_url": "https://github.com/wangjunbao2018",
    "followers_url": "https://api.github.com/users/wangjunbao2018/followers",
    "following_url": "https://api.github.com/users/wangjunbao2018/following{/other_user}",
    "gists_url": "https://api.github.com/users/wangjunbao2018/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/wangjunbao2018/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/wangjunbao2018/subscriptions",
    "organizations_url": "https://api.github.com/users/wangjunbao2018/orgs",
    "repos_url": "https://api.github.com/users/wangjunbao2018/repos",
    "events_url": "https://api.github.com/users/wangjunbao2018/events{/privacy}",
    "received_events_url": "https://api.github.com/users/wangjunbao2018/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 7,
  "created_at": "2019-01-03T06:43:16Z",
  "updated_at": "2020-07-08T09:48:31Z",
  "closed_at": "2019-01-04T07:38:24Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "Hi there,\r\n\r\nI use docker to build a private network, and then I  issue a token and I can get the balance correctly.  however,  after I stop it then restart the geth node, I can't get the right balance of the token I issued before.  but if I build the private network without docker, it works well.  What's the problem?  anyone know the reason? really thanks.\r\n\r\n\r\n#### System information\r\n\r\nGo version: go1.11.4\r\nGeth version: 1.9.0-unstable\r\nOS & Version: Windows/Linux/OSX\r\nDocker version : 18.06.0-ce\r\nDocker-compose version:  1.22.0   \r\n\r\n#### Expected behaviour\r\n\r\nAfter I restart the node by docker(run docker stop node &  docker start node), the balance should be equals that before I do like this. \r\n#### Actual behaviour\r\n\r\nActually, I got  `{\"jsonrpc\":\"2.0\",\"id\":0,\"result\":\"0x\"}` .\r\n\r\n\r\n#### Steps to reproduce the behaviour\r\n\r\n1. use docker-compose to build a private network\r\n  \r\n  ```\r\n  datadir=\"/root/.ethereum\"\r\n  \r\n   geth --identity \"testNode\" --rpc --rpcaddr \"0.0.0.0\" --rpcport \"8545\" --rpccorsdomain \"*\" --datadir \r\n  $datadir --port \"30303\" --nodiscover --rpcapi \"personal,db,eth,net,web3\" --networkid 100 init \r\n   genesis.json\r\n\r\n   geth --identity \"testNode\" --rpc --rpcaddr \"0.0.0.0\" --rpcport \"8545\" --rpccorsdomain \"*\" --datadir $datadir --port \"30303\" --nodiscover --rpcapi \"personal,db,eth,net,web3,admin,txpool,miner\" --networkid 100\r\n  ```\r\n\r\n2. issue a token and query the balance\r\n\r\n  I use Java code to issued a token, but any other way works well\r\n\r\n3.  restart geth node and query the balance \r\n\r\n  Then I run the command `docker stop miner & . docker start miner`.  when It works well, I query the balance , I got `{\"jsonrpc\":\"2.0\",\"id\":0,\"result\":\"0x\"}`.\r\n\r\n  Please notice that,  before I restart , I wait for a long time, and after it restarted, I still can get the transaction and transactionReceipt by the hash I issued the token, it looks the same as before.\r\n",
  "closed_by": {
    "login": "karalabe",
    "id": 129561,
    "node_id": "MDQ6VXNlcjEyOTU2MQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/karalabe",
    "html_url": "https://github.com/karalabe",
    "followers_url": "https://api.github.com/users/karalabe/followers",
    "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
    "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
    "organizations_url": "https://api.github.com/users/karalabe/orgs",
    "repos_url": "https://api.github.com/users/karalabe/repos",
    "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
    "received_events_url": "https://api.github.com/users/karalabe/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18383/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18383/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/451074774",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/18383#issuecomment-451074774",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18383",
    "id": 451074774,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ1MTA3NDc3NA==",
    "user": {
      "login": "karalabe",
      "id": 129561,
      "node_id": "MDQ6VXNlcjEyOTU2MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/karalabe",
      "html_url": "https://github.com/karalabe",
      "followers_url": "https://api.github.com/users/karalabe/followers",
      "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
      "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
      "organizations_url": "https://api.github.com/users/karalabe/orgs",
      "repos_url": "https://api.github.com/users/karalabe/repos",
      "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
      "received_events_url": "https://api.github.com/users/karalabe/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-01-03T07:55:50Z",
    "updated_at": "2019-01-03T07:55:50Z",
    "author_association": "MEMBER",
    "body": "Could you check the latest block before and after the restart (`eth.getBlock('latest')`)? I have a hunch that you're not terminating Geth gracefully, causing any state kept in memory only to be lost. The receipts are written to disk immediately however, so that might explain why you can still retrieve them.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/451074774/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/451124140",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/18383#issuecomment-451124140",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18383",
    "id": 451124140,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ1MTEyNDE0MA==",
    "user": {
      "login": "wangjunbao2018",
      "id": 42427383,
      "node_id": "MDQ6VXNlcjQyNDI3Mzgz",
      "avatar_url": "https://avatars.githubusercontent.com/u/42427383?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/wangjunbao2018",
      "html_url": "https://github.com/wangjunbao2018",
      "followers_url": "https://api.github.com/users/wangjunbao2018/followers",
      "following_url": "https://api.github.com/users/wangjunbao2018/following{/other_user}",
      "gists_url": "https://api.github.com/users/wangjunbao2018/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/wangjunbao2018/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/wangjunbao2018/subscriptions",
      "organizations_url": "https://api.github.com/users/wangjunbao2018/orgs",
      "repos_url": "https://api.github.com/users/wangjunbao2018/repos",
      "events_url": "https://api.github.com/users/wangjunbao2018/events{/privacy}",
      "received_events_url": "https://api.github.com/users/wangjunbao2018/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-01-03T12:00:06Z",
    "updated_at": "2019-01-03T12:02:14Z",
    "author_association": "NONE",
    "body": "> Could you check the latest block before and after the restart (`eth.getBlock('latest')`)? I have a hunch that you're not terminating Geth gracefully, causing any state kept in memory only to be lost. The receipts are written to disk immediately however, so that might explain why you can still retrieve them.\r\n\r\nThx. I was termininating it by CTRL + C.  Actually, I checked the latest block before and after I restart it. The block heights aren't the same.  It looks like this:\r\n\r\n![image](https://user-images.githubusercontent.com/42427383/50636363-bbae9980-0f90-11e9-8b5b-b0785ebb0cba.png)\r\n\r\nWhat's more,  I found that  after a while after I restart the node,  the height increases and when it's  greater than the block height I issued token, I can successfully get the balance again.  For this pic, before I restart , the height I got by `eth.getBlock('latest')` is  8147, but after restart, I got 6610.\r\n\r\nAnd though there are more than 1000 new block mined, if restart, It looks all the new blocks are missing. why is this happened?\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/451124140/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/451125546",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/18383#issuecomment-451125546",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18383",
    "id": 451125546,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ1MTEyNTU0Ng==",
    "user": {
      "login": "karalabe",
      "id": 129561,
      "node_id": "MDQ6VXNlcjEyOTU2MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/karalabe",
      "html_url": "https://github.com/karalabe",
      "followers_url": "https://api.github.com/users/karalabe/followers",
      "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
      "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
      "organizations_url": "https://api.github.com/users/karalabe/orgs",
      "repos_url": "https://api.github.com/users/karalabe/repos",
      "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
      "received_events_url": "https://api.github.com/users/karalabe/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-01-03T12:06:57Z",
    "updated_at": "2019-01-03T12:06:57Z",
    "author_association": "MEMBER",
    "body": "> I have a hunch that you're not terminating Geth gracefully, causing any state kept in memory only to be lost.\r\n\r\nPlease shut Geth down properly, don't kill it. Murdering it will cause any state only stored in memory to be lost.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/451125546/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/451371475",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/18383#issuecomment-451371475",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18383",
    "id": 451371475,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ1MTM3MTQ3NQ==",
    "user": {
      "login": "karalabe",
      "id": 129561,
      "node_id": "MDQ6VXNlcjEyOTU2MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/karalabe",
      "html_url": "https://github.com/karalabe",
      "followers_url": "https://api.github.com/users/karalabe/followers",
      "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
      "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
      "organizations_url": "https://api.github.com/users/karalabe/orgs",
      "repos_url": "https://api.github.com/users/karalabe/repos",
      "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
      "received_events_url": "https://api.github.com/users/karalabe/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-01-04T07:38:24Z",
    "updated_at": "2019-01-04T07:38:24Z",
    "author_association": "MEMBER",
    "body": "One more hint. If you are running Geth within docker, docker will only forward termination signals to process #1. Geth must run with PID 1 to support graceful shutdowns. We had to rework puppeth a while back for this exact reason, to ensure that signals propagate properly.\r\n\r\nIf you need to run multiple commands in your docker instance (i.e. a script), you can have the last command be geth, started via `exec`. This ensures that geth replaces the script (i.e. retians PID 1) and correctly receives interrupts.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/451371475/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/639537610",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/18383#issuecomment-639537610",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18383",
    "id": 639537610,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYzOTUzNzYxMA==",
    "user": {
      "login": "qzmer1104",
      "id": 5986361,
      "node_id": "MDQ6VXNlcjU5ODYzNjE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5986361?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/qzmer1104",
      "html_url": "https://github.com/qzmer1104",
      "followers_url": "https://api.github.com/users/qzmer1104/followers",
      "following_url": "https://api.github.com/users/qzmer1104/following{/other_user}",
      "gists_url": "https://api.github.com/users/qzmer1104/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/qzmer1104/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/qzmer1104/subscriptions",
      "organizations_url": "https://api.github.com/users/qzmer1104/orgs",
      "repos_url": "https://api.github.com/users/qzmer1104/repos",
      "events_url": "https://api.github.com/users/qzmer1104/events{/privacy}",
      "received_events_url": "https://api.github.com/users/qzmer1104/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-06-05T14:40:03Z",
    "updated_at": "2020-06-05T14:40:03Z",
    "author_association": "NONE",
    "body": "how to gracefully shutdown???",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/639537610/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/645403888",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/18383#issuecomment-645403888",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18383",
    "id": 645403888,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY0NTQwMzg4OA==",
    "user": {
      "login": "preston-evans98",
      "id": 32944016,
      "node_id": "MDQ6VXNlcjMyOTQ0MDE2",
      "avatar_url": "https://avatars.githubusercontent.com/u/32944016?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/preston-evans98",
      "html_url": "https://github.com/preston-evans98",
      "followers_url": "https://api.github.com/users/preston-evans98/followers",
      "following_url": "https://api.github.com/users/preston-evans98/following{/other_user}",
      "gists_url": "https://api.github.com/users/preston-evans98/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/preston-evans98/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/preston-evans98/subscriptions",
      "organizations_url": "https://api.github.com/users/preston-evans98/orgs",
      "repos_url": "https://api.github.com/users/preston-evans98/repos",
      "events_url": "https://api.github.com/users/preston-evans98/events{/privacy}",
      "received_events_url": "https://api.github.com/users/preston-evans98/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-06-17T14:20:26Z",
    "updated_at": "2020-06-17T14:20:26Z",
    "author_association": "NONE",
    "body": "> how to gracefully shutdown???\r\n\r\nGeth shuts down gracefully in response to a SIGINT or SIGTERM (see  #16131). If Geth is running on the host directly (not inside Docker) it's safe to shutdown with Ctrl-c.\r\n\r\nIf you're running Geth in a Docker container you need to either \r\n1. Make sure Geth has PID 1 **OR**\r\n1. Make sure that the process with PID 1 forwards SIGINT and SIGTERM **AND**\r\n1. Make sure that the process with PID 1 waits for Geth to terminate before terminating itself\r\n\r\nIf you do either 1 or both 2 and 3, then you can gracefully terminate Geth with `docker kill --signal=SIGINT {container_name}`",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/645403888/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/655413283",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/18383#issuecomment-655413283",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18383",
    "id": 655413283,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY1NTQxMzI4Mw==",
    "user": {
      "login": "qzmer1104",
      "id": 5986361,
      "node_id": "MDQ6VXNlcjU5ODYzNjE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5986361?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/qzmer1104",
      "html_url": "https://github.com/qzmer1104",
      "followers_url": "https://api.github.com/users/qzmer1104/followers",
      "following_url": "https://api.github.com/users/qzmer1104/following{/other_user}",
      "gists_url": "https://api.github.com/users/qzmer1104/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/qzmer1104/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/qzmer1104/subscriptions",
      "organizations_url": "https://api.github.com/users/qzmer1104/orgs",
      "repos_url": "https://api.github.com/users/qzmer1104/repos",
      "events_url": "https://api.github.com/users/qzmer1104/events{/privacy}",
      "received_events_url": "https://api.github.com/users/qzmer1104/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-07-08T09:45:49Z",
    "updated_at": "2020-07-08T09:48:31Z",
    "author_association": "NONE",
    "body": "> > how to gracefully shutdown???\r\n> \r\n> Geth shuts down gracefully in response to a SIGINT or SIGTERM (see #16131). If Geth is running on the host directly (not inside Docker) it's safe to shutdown with Ctrl-c.\r\n> \r\n> If you're running Geth in a Docker container you need to either\r\n> \r\n> 1. Make sure Geth has PID 1 **OR**\r\n> 2. Make sure that the process with PID 1 forwards SIGINT and SIGTERM **AND**\r\n> 3. Make sure that the process with PID 1 waits for Geth to terminate before terminating itself\r\n> \r\n> If you do either 1 or both 2 and 3, then you can gracefully terminate Geth with `docker kill --signal=SIGINT {container_name}`\r\n\r\nemmm, if not in docker。just centos 7\r\ntry kill -Hup \r\nand before it  I try kill -9 and then I lost about 2000 blocks……",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/655413283/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
