{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22509",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22509/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22509/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22509/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/22509",
  "id": 833145906,
  "node_id": "MDU6SXNzdWU4MzMxNDU5MDY=",
  "number": 22509,
  "title": "LES client consumes 100% of a CPU core when DNS discovery enabled",
  "user": {
    "login": "veox",
    "id": 3036030,
    "node_id": "MDQ6VXNlcjMwMzYwMzA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3036030?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/veox",
    "html_url": "https://github.com/veox",
    "followers_url": "https://api.github.com/users/veox/followers",
    "following_url": "https://api.github.com/users/veox/following{/other_user}",
    "gists_url": "https://api.github.com/users/veox/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/veox/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/veox/subscriptions",
    "organizations_url": "https://api.github.com/users/veox/orgs",
    "repos_url": "https://api.github.com/users/veox/repos",
    "events_url": "https://api.github.com/users/veox/events{/privacy}",
    "received_events_url": "https://api.github.com/users/veox/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 72233650,
      "node_id": "MDU6TGFiZWw3MjIzMzY1MA==",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/type:bug",
      "name": "type:bug",
      "color": "FF5E5E",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "fjl",
    "id": 6915,
    "node_id": "MDQ6VXNlcjY5MTU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6915?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/fjl",
    "html_url": "https://github.com/fjl",
    "followers_url": "https://api.github.com/users/fjl/followers",
    "following_url": "https://api.github.com/users/fjl/following{/other_user}",
    "gists_url": "https://api.github.com/users/fjl/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/fjl/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/fjl/subscriptions",
    "organizations_url": "https://api.github.com/users/fjl/orgs",
    "repos_url": "https://api.github.com/users/fjl/repos",
    "events_url": "https://api.github.com/users/fjl/events{/privacy}",
    "received_events_url": "https://api.github.com/users/fjl/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "fjl",
      "id": 6915,
      "node_id": "MDQ6VXNlcjY5MTU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6915?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjl",
      "html_url": "https://github.com/fjl",
      "followers_url": "https://api.github.com/users/fjl/followers",
      "following_url": "https://api.github.com/users/fjl/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjl/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjl/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjl/subscriptions",
      "organizations_url": "https://api.github.com/users/fjl/orgs",
      "repos_url": "https://api.github.com/users/fjl/repos",
      "events_url": "https://api.github.com/users/fjl/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjl/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2021-03-16T19:53:00Z",
  "updated_at": "2021-03-24T12:50:15Z",
  "closed_at": "2021-03-24T12:37:20Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "### System information\r\n\r\nGeth version: `geth version`\r\n\r\n```\r\nGeth\r\nVersion: 1.10.1-stable\r\nGit Commit: c2d2f4ed8f232bb11663a1b01a2e578aa22f24bd\r\nArchitecture: amd64\r\nGo Version: go1.16\r\nOperating System: linux\r\nGOPATH=\r\nGOROOT=go\r\n```\r\n\r\nOS & Version: Linux, Ubuntu 16.04.7 LTS (Xenial Xerus)\r\n\r\nCommit hash: N/A (installed through official PPA)\r\n\r\n### Expected behaviour\r\n\r\nSame as 1.9.x branch behaved - about 5% to 10% of a CPU consumed.\r\n\r\n### Actual behaviour\r\n\r\n100% of a core is consumed.\r\n\r\nNote that this is intentionally a low-resource VM, and it only has 1 core total.\r\n\r\n### Steps to reproduce the behaviour\r\n\r\nRun as:\r\n\r\n```\r\nnice ionice -c3 /usr/bin/geth --syncmode \"light\" --datadir /home/geth/.ethereum --cache 1024 --maxpeers 100\r\n```\r\n\r\nI'm actually doing this through a `systemd` unit, but the above is a succinct one-liner.\r\n\r\n### CPU profiling graph\r\n\r\n(Sorry for the PNG, github got picky about the SVG. :/)\r\n\r\n![karl-100cpu prof](https://user-images.githubusercontent.com/3036030/111369990-58f0d680-86a0-11eb-8930-d8e50276a998.png)\r\n\r\nThe \"culprit\" is `Now()->nanotime()`, and the code path leading through DNS discovery.\r\n\r\nIf I had to guess, the issue stems from there not being enough peers (LES servers) in the network - neither the default of 25, nor the desirable 100, so the path thrashes while looking for more. The buck stops at the clock because \"it's not time to check yet\".\r\n\r\nPossibly related based on title: issue #22306\r\n\r\n### Workaround\r\n\r\nCan confirm that disabling DNS discovery with\r\n\r\n`--discovery.dns \"\"`\r\n\r\nremoves the issue.\r\n\r\nCPU graph pre-upgrade (up to 19:50), after upgrade (19:50-21:30), after workaround (after 21:30):\r\n\r\n![image](https://user-images.githubusercontent.com/3036030/111370902-72465280-86a1-11eb-927c-bb6d667ff21d.png)\r\n",
  "closed_by": {
    "login": "karalabe",
    "id": 129561,
    "node_id": "MDQ6VXNlcjEyOTU2MQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/karalabe",
    "html_url": "https://github.com/karalabe",
    "followers_url": "https://api.github.com/users/karalabe/followers",
    "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
    "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
    "organizations_url": "https://api.github.com/users/karalabe/orgs",
    "repos_url": "https://api.github.com/users/karalabe/repos",
    "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
    "received_events_url": "https://api.github.com/users/karalabe/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22509/reactions",
    "total_count": 1,
    "+1": 1,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22509/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/801949490",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/22509#issuecomment-801949490",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22509",
    "id": 801949490,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwMTk0OTQ5MA==",
    "user": {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-18T13:56:32Z",
    "updated_at": "2021-03-18T13:56:32Z",
    "author_association": "MEMBER",
    "body": "Thanks for the very detailed report! ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/801949490/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/805744568",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/22509#issuecomment-805744568",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22509",
    "id": 805744568,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwNTc0NDU2OA==",
    "user": {
      "login": "fjl",
      "id": 6915,
      "node_id": "MDQ6VXNlcjY5MTU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6915?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjl",
      "html_url": "https://github.com/fjl",
      "followers_url": "https://api.github.com/users/fjl/followers",
      "following_url": "https://api.github.com/users/fjl/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjl/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjl/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjl/subscriptions",
      "organizations_url": "https://api.github.com/users/fjl/orgs",
      "repos_url": "https://api.github.com/users/fjl/repos",
      "events_url": "https://api.github.com/users/fjl/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjl/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-24T11:26:16Z",
    "updated_at": "2021-03-24T12:50:15Z",
    "author_association": "MEMBER",
    "body": "After some debugging, we now know why this happens:\r\n\r\nIn Geth v1.10, we changed the structure of the \"les\" ENR entry. As a result, the DHT crawler that creates the DNS lists \r\nno longer recognizes the les nodes (this is fixed in #22565). So at the moment, the les DNS list only contains non-upgraded nodes which are invalid according to the ForkID filter.\r\n\r\nWhen the light client searches for servers, it combines the results of the DHT search and DNS discovery iterator using FairMix. It filters the output of this combined stream of nodes according to the ForkID. \r\n\r\nThe DNS node iterator keeps previously resolved records in a LRU cache. Since the les node lists don't contain a lot of nodes, the whole list can be cached, and getting the next node does not incur any network-based delay. So the les discovery just keeps iterating the list of incompatible nodes over and over in a hot loop.\r\n\r\nI'm still unsure how to best fix this. It seems that the best fix would be to speed-limit the DNS iterator even when the response comes from the cache.\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/805744568/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 1,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
