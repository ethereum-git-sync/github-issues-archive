{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18960",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18960/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18960/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18960/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/18960",
  "id": 404152904,
  "node_id": "MDU6SXNzdWU0MDQxNTI5MDQ=",
  "number": 18960,
  "title": "Why block with txs interrupt the empty block",
  "user": {
    "login": "friends110110",
    "id": 3381671,
    "node_id": "MDQ6VXNlcjMzODE2NzE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3381671?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/friends110110",
    "html_url": "https://github.com/friends110110",
    "followers_url": "https://api.github.com/users/friends110110/followers",
    "following_url": "https://api.github.com/users/friends110110/following{/other_user}",
    "gists_url": "https://api.github.com/users/friends110110/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/friends110110/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/friends110110/subscriptions",
    "organizations_url": "https://api.github.com/users/friends110110/orgs",
    "repos_url": "https://api.github.com/users/friends110110/repos",
    "events_url": "https://api.github.com/users/friends110110/events{/privacy}",
    "received_events_url": "https://api.github.com/users/friends110110/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 7,
  "created_at": "2019-01-29T07:15:53Z",
  "updated_at": "2019-02-08T10:20:24Z",
  "closed_at": "2019-02-08T10:20:24Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "When I watch the file work.go ,the method commitNewWork, fragments \r\n```\r\nif !noempty {\r\n\t\t\t// Create an empty block based on temporary copied state for sealing in advance without waiting block\r\n\t\t\t// execution finished.\r\n\t\t\tw.commit(uncles, nil, false, tstart)\r\n\t\t}\r\n\r\n\t// Fill the block with all available pending transactions.\r\n\tpending, err := w.eth.TxPool().Pending()\r\n\tif err != nil {\r\n\t\tlog.Error(\"Failed to fetch pending transactions\", \"err\", err)\r\n\t\treturn\r\n\t}\r\n\t// Short circuit if there is no available pending transactions\r\n\tif len(pending) == 0 {\r\n\t\tw.updateSnapshot()\r\n\t\treturn\r\n\t}\r\n\t// Split the pending transactions into locals and remotes\r\n\tlocalTxs, remoteTxs := make(map[common.Address]types.Transactions), pending\r\n\tfor _, account := range w.eth.TxPool().Locals() {\r\n\t\tif txs := remoteTxs[account]; len(txs) > 0 {\r\n\t\t\tdelete(remoteTxs, account)\r\n\t\t\tlocalTxs[account] = txs\r\n\t\t}\r\n\t}\r\n\tif len(localTxs) > 0 {\r\n\t\ttxs := types.NewTransactionsByPriceAndNonce(w.current.signer, localTxs)\r\n\t\tif w.commitTransactions(txs, w.coinbase, interrupt) {\r\n\t\t\treturn\r\n\t\t}\r\n\t}\r\n\tif len(remoteTxs) > 0 {\r\n\t\ttxs := types.NewTransactionsByPriceAndNonce(w.current.signer, remoteTxs)\r\n\t\tif w.commitTransactions(txs, w.coinbase, interrupt) {\r\n\t\t\treturn\r\n\t\t}\r\n\t}\r\n\tw.commit(uncles, w.fullTaskHook, true, tstart)\r\n```\r\n\r\nWhy block with txs interrupt the empty block?\r\nin my opinion,  commit the block with txs first,  commit empty if no block with txs,\r\nso the code should be transfer to the **defer** , and the empty could not interrupt the block with txs when same block num .\r\n```\r\nemptyFun := func() {\r\n\t\tif !noempty {\r\n\t\t\t// Create an empty block based on temporary copied state for sealing in advance without waiting block\r\n\t\t\t// execution finished.\r\n\t\t\tw.commit(uncles, nil, false, tstart)\r\n\t\t}\r\n\t}\r\ndefer emptyFun()\r\n\r\n```\r\n",
  "closed_by": {
    "login": "karalabe",
    "id": 129561,
    "node_id": "MDQ6VXNlcjEyOTU2MQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/karalabe",
    "html_url": "https://github.com/karalabe",
    "followers_url": "https://api.github.com/users/karalabe/followers",
    "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
    "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
    "organizations_url": "https://api.github.com/users/karalabe/orgs",
    "repos_url": "https://api.github.com/users/karalabe/repos",
    "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
    "received_events_url": "https://api.github.com/users/karalabe/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18960/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18960/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/458820648",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/18960#issuecomment-458820648",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18960",
    "id": 458820648,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ1ODgyMDY0OA==",
    "user": {
      "login": "rjl493456442",
      "id": 5959481,
      "node_id": "MDQ6VXNlcjU5NTk0ODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5959481?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rjl493456442",
      "html_url": "https://github.com/rjl493456442",
      "followers_url": "https://api.github.com/users/rjl493456442/followers",
      "following_url": "https://api.github.com/users/rjl493456442/following{/other_user}",
      "gists_url": "https://api.github.com/users/rjl493456442/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rjl493456442/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rjl493456442/subscriptions",
      "organizations_url": "https://api.github.com/users/rjl493456442/orgs",
      "repos_url": "https://api.github.com/users/rjl493456442/repos",
      "events_url": "https://api.github.com/users/rjl493456442/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rjl493456442/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-01-30T05:49:54Z",
    "updated_at": "2019-01-30T05:50:52Z",
    "author_association": "MEMBER",
    "body": "I guess your question is: **Why is it necessary to submit an empty block first in commitNewWork?**\r\n\r\nIn order to submit a new mining work, geth has to (1) create empty block (2) fetch a batch of pending transactions from txpool and apply them. While the step(2) normally could take 100ms or 200ms in the mainnet. In order to save this part of time, we submit an empty block first and apply the pending transactions at the same time.\r\n\r\nIf miner finds a right nonce during this time(100ms or 200ms), the geth node will broadcast an empty block (the probability of this event is small, but it is also an optimized way to improve mining efficiency). Otherwise the geth node will swap the empty block with a full block and notify all miners to update the mining task.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/458820648/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/458823709",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/18960#issuecomment-458823709",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18960",
    "id": 458823709,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ1ODgyMzcwOQ==",
    "user": {
      "login": "friends110110",
      "id": 3381671,
      "node_id": "MDQ6VXNlcjMzODE2NzE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3381671?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/friends110110",
      "html_url": "https://github.com/friends110110",
      "followers_url": "https://api.github.com/users/friends110110/followers",
      "following_url": "https://api.github.com/users/friends110110/following{/other_user}",
      "gists_url": "https://api.github.com/users/friends110110/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/friends110110/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/friends110110/subscriptions",
      "organizations_url": "https://api.github.com/users/friends110110/orgs",
      "repos_url": "https://api.github.com/users/friends110110/repos",
      "events_url": "https://api.github.com/users/friends110110/events{/privacy}",
      "received_events_url": "https://api.github.com/users/friends110110/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-01-30T06:05:43Z",
    "updated_at": "2019-01-30T06:05:43Z",
    "author_association": "NONE",
    "body": "@rjl493456442 thank your, your main reason is save the time(100ms or 200ms) and keep the benefits. \r\nWhen we transform the consensus to pbft or others, if the empty block is generated and be broadcasted  in 10ms or less time, then the block with txs(100ms or 200ms) will never interrupt the empty block, so it will never consume the txs which in txpool pending ?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/458823709/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/458825134",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/18960#issuecomment-458825134",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18960",
    "id": 458825134,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ1ODgyNTEzNA==",
    "user": {
      "login": "rjl493456442",
      "id": 5959481,
      "node_id": "MDQ6VXNlcjU5NTk0ODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5959481?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rjl493456442",
      "html_url": "https://github.com/rjl493456442",
      "followers_url": "https://api.github.com/users/rjl493456442/followers",
      "following_url": "https://api.github.com/users/rjl493456442/following{/other_user}",
      "gists_url": "https://api.github.com/users/rjl493456442/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rjl493456442/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rjl493456442/subscriptions",
      "organizations_url": "https://api.github.com/users/rjl493456442/orgs",
      "repos_url": "https://api.github.com/users/rjl493456442/repos",
      "events_url": "https://api.github.com/users/rjl493456442/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rjl493456442/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-01-30T06:13:24Z",
    "updated_at": "2019-01-30T06:13:24Z",
    "author_association": "MEMBER",
    "body": "Yes. Once the geth node broadcasts the empty block, the local node will also receive a `NewHeadEvent` and drop the current full block(could be a semi-finished full block) silently.\r\n\r\nIf you want to customize the codebase, you can disable the empty block mechanism, it should be easy.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/458825134/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/458826721",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/18960#issuecomment-458826721",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18960",
    "id": 458826721,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ1ODgyNjcyMQ==",
    "user": {
      "login": "friends110110",
      "id": 3381671,
      "node_id": "MDQ6VXNlcjMzODE2NzE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3381671?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/friends110110",
      "html_url": "https://github.com/friends110110",
      "followers_url": "https://api.github.com/users/friends110110/followers",
      "following_url": "https://api.github.com/users/friends110110/following{/other_user}",
      "gists_url": "https://api.github.com/users/friends110110/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/friends110110/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/friends110110/subscriptions",
      "organizations_url": "https://api.github.com/users/friends110110/orgs",
      "repos_url": "https://api.github.com/users/friends110110/repos",
      "events_url": "https://api.github.com/users/friends110110/events{/privacy}",
      "received_events_url": "https://api.github.com/users/friends110110/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-01-30T06:22:01Z",
    "updated_at": "2019-01-30T06:22:01Z",
    "author_association": "NONE",
    "body": "@rjl493456442 it seems this fragment codes serve for pow consensus, because of more time to generate the block.  Some scenes could not fit. \r\nFor example, if the empty block has been broadcast when the block with txs too late to interrupt the previous, then consensus will generate the same block num which with txs, and broadcast it. So it will form hard divarication。",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/458826721/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/458827363",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/18960#issuecomment-458827363",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18960",
    "id": 458827363,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ1ODgyNzM2Mw==",
    "user": {
      "login": "rjl493456442",
      "id": 5959481,
      "node_id": "MDQ6VXNlcjU5NTk0ODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5959481?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rjl493456442",
      "html_url": "https://github.com/rjl493456442",
      "followers_url": "https://api.github.com/users/rjl493456442/followers",
      "following_url": "https://api.github.com/users/rjl493456442/following{/other_user}",
      "gists_url": "https://api.github.com/users/rjl493456442/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rjl493456442/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rjl493456442/subscriptions",
      "organizations_url": "https://api.github.com/users/rjl493456442/orgs",
      "repos_url": "https://api.github.com/users/rjl493456442/repos",
      "events_url": "https://api.github.com/users/rjl493456442/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rjl493456442/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-01-30T06:25:15Z",
    "updated_at": "2019-01-30T06:25:23Z",
    "author_association": "MEMBER",
    "body": "> then consensus will generate the same block num which with txs\r\n\r\nNo, the consensus engine will create a new one for mining with a higher block number.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/458827363/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/458828243",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/18960#issuecomment-458828243",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18960",
    "id": 458828243,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ1ODgyODI0Mw==",
    "user": {
      "login": "friends110110",
      "id": 3381671,
      "node_id": "MDQ6VXNlcjMzODE2NzE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3381671?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/friends110110",
      "html_url": "https://github.com/friends110110",
      "followers_url": "https://api.github.com/users/friends110110/followers",
      "following_url": "https://api.github.com/users/friends110110/following{/other_user}",
      "gists_url": "https://api.github.com/users/friends110110/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/friends110110/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/friends110110/subscriptions",
      "organizations_url": "https://api.github.com/users/friends110110/orgs",
      "repos_url": "https://api.github.com/users/friends110110/repos",
      "events_url": "https://api.github.com/users/friends110110/events{/privacy}",
      "received_events_url": "https://api.github.com/users/friends110110/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-01-30T06:29:58Z",
    "updated_at": "2019-01-30T06:29:58Z",
    "author_association": "NONE",
    "body": "You misunderstand.\r\nI means it broadcast the empty block, and trigger NewHeadEvent,. While at this time , the same block number with txs generate the block and send block to resultCh channel, it generate the same block number and broadcast before next block number interrupt it.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/458828243/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/458829776",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/18960#issuecomment-458829776",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18960",
    "id": 458829776,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ1ODgyOTc3Ng==",
    "user": {
      "login": "rjl493456442",
      "id": 5959481,
      "node_id": "MDQ6VXNlcjU5NTk0ODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5959481?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rjl493456442",
      "html_url": "https://github.com/rjl493456442",
      "followers_url": "https://api.github.com/users/rjl493456442/followers",
      "following_url": "https://api.github.com/users/rjl493456442/following{/other_user}",
      "gists_url": "https://api.github.com/users/rjl493456442/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rjl493456442/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rjl493456442/subscriptions",
      "organizations_url": "https://api.github.com/users/rjl493456442/orgs",
      "repos_url": "https://api.github.com/users/rjl493456442/repos",
      "events_url": "https://api.github.com/users/rjl493456442/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rjl493456442/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-01-30T06:38:03Z",
    "updated_at": "2019-01-30T06:38:03Z",
    "author_association": "MEMBER",
    "body": "Oh, I think you are talking about the **chain fork**.\r\n\r\nYes, in the ethereum, both of the consensus engine **ethash** and **clique** are not instant finalized. They are allowed to have several blocks with the same block height. Some blocks will become canonical blocks while the other will become uncle blocks.\r\n\r\nIf you are using some BFT based consensus algorithm, probably you have to do some changes. ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/458829776/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
