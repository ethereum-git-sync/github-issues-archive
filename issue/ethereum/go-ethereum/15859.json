{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/15859",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/15859/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/15859/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/15859/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/15859",
  "id": 287952233,
  "node_id": "MDU6SXNzdWUyODc5NTIyMzM=",
  "number": 15859,
  "title": "eth_estimateGas performance",
  "user": {
    "login": "ryanschneider",
    "id": 53520,
    "node_id": "MDQ6VXNlcjUzNTIw",
    "avatar_url": "https://avatars.githubusercontent.com/u/53520?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ryanschneider",
    "html_url": "https://github.com/ryanschneider",
    "followers_url": "https://api.github.com/users/ryanschneider/followers",
    "following_url": "https://api.github.com/users/ryanschneider/following{/other_user}",
    "gists_url": "https://api.github.com/users/ryanschneider/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ryanschneider/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ryanschneider/subscriptions",
    "organizations_url": "https://api.github.com/users/ryanschneider/orgs",
    "repos_url": "https://api.github.com/users/ryanschneider/repos",
    "events_url": "https://api.github.com/users/ryanschneider/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ryanschneider/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 856638432,
      "node_id": "MDU6TGFiZWw4NTY2Mzg0MzI=",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/status:inactive",
      "name": "status:inactive",
      "color": "ffffff",
      "default": false,
      "description": null
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 6,
  "created_at": "2018-01-11T22:52:05Z",
  "updated_at": "2019-05-25T21:47:16Z",
  "closed_at": "2019-05-25T21:47:16Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "\r\n#### System information\r\n\r\nGeth version: `1.8.0-unstable-56152b31` (also `1.7.3-stable-4bb3c89d`)\r\nOS & Version: Windows/Linux/OSX\r\nCommit hash : `56152b31ac251d1cc68fcddbdad159ba5234c415`\r\n\r\n#### Expected behaviour\r\n\r\n`eth_estimateGas` is more or less as performant as `eth_call`.\r\n\r\n#### Actual behaviour\r\n\r\n`eth_estimateGas` takes seconds or minutes to run.\r\n\r\n#### Steps to reproduce the behaviour\r\n\r\nI don't have a sure fire repro but have seen it happen if you make the call just a couple seconds after starting `geth`, or sometimes it takes hours before it gets into this state.\r\n\r\nHowever, during testing I noticed two things:\r\n\r\n- [EstimateGas](https://github.com/ethereum/go-ethereum/blob/master/internal/ethapi/api.go#L655) does a binary search instead of using the `gasUsed` returned from `doCall`.  Why?\r\n- It also uses `rpc.PendingBlockNumber`, with no option for a block param (see #2586)\r\n\r\nSo, *as a test* I switched to `rpc.LatestBlockNumber` in https://github.com/ryanschneider/go-ethereum/commit/7df8498240bbe9d1c655acabd0f7995cabc7bbc0, and was unable to reproduce the issue after throwing a lot of test traffic at it.\r\n\r\nI'd love to help track down the issue, but don't have clarity into why the binary search is used.  Also my current theory is that there is contention on the pending block, does that sounds like a reasonable place to look?\r\n\r\n#### Backtrace\r\n\r\nI'll get a `debug.stacks` output from either 1.7.3 or master here the next time I see the issue.",
  "closed_by": {
    "login": "stale[bot]",
    "id": 26384082,
    "node_id": "MDM6Qm90MjYzODQwODI=",
    "avatar_url": "https://avatars.githubusercontent.com/in/1724?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/stale%5Bbot%5D",
    "html_url": "https://github.com/apps/stale",
    "followers_url": "https://api.github.com/users/stale%5Bbot%5D/followers",
    "following_url": "https://api.github.com/users/stale%5Bbot%5D/following{/other_user}",
    "gists_url": "https://api.github.com/users/stale%5Bbot%5D/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/stale%5Bbot%5D/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/stale%5Bbot%5D/subscriptions",
    "organizations_url": "https://api.github.com/users/stale%5Bbot%5D/orgs",
    "repos_url": "https://api.github.com/users/stale%5Bbot%5D/repos",
    "events_url": "https://api.github.com/users/stale%5Bbot%5D/events{/privacy}",
    "received_events_url": "https://api.github.com/users/stale%5Bbot%5D/received_events",
    "type": "Bot",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/15859/reactions",
    "total_count": 6,
    "+1": 6,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/15859/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/357182826",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/15859#issuecomment-357182826",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/15859",
    "id": 357182826,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM1NzE4MjgyNg==",
    "user": {
      "login": "karalabe",
      "id": 129561,
      "node_id": "MDQ6VXNlcjEyOTU2MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/karalabe",
      "html_url": "https://github.com/karalabe",
      "followers_url": "https://api.github.com/users/karalabe/followers",
      "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
      "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
      "organizations_url": "https://api.github.com/users/karalabe/orgs",
      "repos_url": "https://api.github.com/users/karalabe/repos",
      "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
      "received_events_url": "https://api.github.com/users/karalabe/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-01-12T09:08:28Z",
    "updated_at": "2018-01-12T09:08:28Z",
    "author_association": "MEMBER",
    "body": "The binary search is needed due to funky gas dynamics and allowances in various EVM opcodes. For example, doing a CALL forwards 63/64 of the available gas to the called contract. Which means, even though the internal call might use N amount of gas, the opcode to be called actually requires (N/63*64). There's a similar issue with CALL stipends where a tiny amount of gas (1900) required by the opcode gets granted for free to the CALL, but won't get refunded if not used. This also makes the actual used amount and the required amount different.\r\n\r\nYour other measurement that the pending state is slow vs. the latest block is fast is an intriguing find! I'll need to take a closer look at that.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/357182826/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/357388704",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/15859#issuecomment-357388704",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/15859",
    "id": 357388704,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM1NzM4ODcwNA==",
    "user": {
      "login": "ryanschneider",
      "id": 53520,
      "node_id": "MDQ6VXNlcjUzNTIw",
      "avatar_url": "https://avatars.githubusercontent.com/u/53520?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanschneider",
      "html_url": "https://github.com/ryanschneider",
      "followers_url": "https://api.github.com/users/ryanschneider/followers",
      "following_url": "https://api.github.com/users/ryanschneider/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanschneider/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanschneider/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanschneider/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanschneider/orgs",
      "repos_url": "https://api.github.com/users/ryanschneider/repos",
      "events_url": "https://api.github.com/users/ryanschneider/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanschneider/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-01-13T00:06:16Z",
    "updated_at": "2018-01-13T00:06:16Z",
    "author_association": "CONTRIBUTOR",
    "body": "Thanks @karalabe , for what it's worth I changed some of our nodes to run w/ this commit (https://github.com/ryanschneider/go-ethereum/commit/8c95ba4465fab1f995b207162a7090c91be76bbf) that just patches `1.7.3` to use `latest` and our 95% percentile response time from `eth_estimateGas` went from 5 seconds to 300ms.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/357388704/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 1,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/357831518",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/15859#issuecomment-357831518",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/15859",
    "id": 357831518,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM1NzgzMTUxOA==",
    "user": {
      "login": "ryanschneider",
      "id": 53520,
      "node_id": "MDQ6VXNlcjUzNTIw",
      "avatar_url": "https://avatars.githubusercontent.com/u/53520?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanschneider",
      "html_url": "https://github.com/ryanschneider",
      "followers_url": "https://api.github.com/users/ryanschneider/followers",
      "following_url": "https://api.github.com/users/ryanschneider/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanschneider/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanschneider/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanschneider/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanschneider/orgs",
      "repos_url": "https://api.github.com/users/ryanschneider/repos",
      "events_url": "https://api.github.com/users/ryanschneider/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanschneider/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-01-16T01:58:34Z",
    "updated_at": "2018-01-16T01:58:34Z",
    "author_association": "CONTRIBUTOR",
    "body": "We need to collect more info, but we're seeing a similar level of slowness in `eth_getTransactionByHash` for txs that aren't mined yet, which hits the commented out part of the codepath here:\r\n\r\n https://github.com/ryanschneider/go-ethereum/blob/dc78cb610d530765844df0833775358d737c47de/internal/ethapi/api.go#L979\r\n\r\nSo that seems to further my thinking that we're seeing some major contention on the pending transactions.  Anything specific I can do to help debug?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/357831518/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/359183329",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/15859#issuecomment-359183329",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/15859",
    "id": 359183329,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM1OTE4MzMyOQ==",
    "user": {
      "login": "dovy",
      "id": 890963,
      "node_id": "MDQ6VXNlcjg5MDk2Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/890963?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dovy",
      "html_url": "https://github.com/dovy",
      "followers_url": "https://api.github.com/users/dovy/followers",
      "following_url": "https://api.github.com/users/dovy/following{/other_user}",
      "gists_url": "https://api.github.com/users/dovy/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dovy/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dovy/subscriptions",
      "organizations_url": "https://api.github.com/users/dovy/orgs",
      "repos_url": "https://api.github.com/users/dovy/repos",
      "events_url": "https://api.github.com/users/dovy/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dovy/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-01-20T16:26:06Z",
    "updated_at": "2018-01-20T16:26:06Z",
    "author_association": "NONE",
    "body": "So maybe I'm crazy, but why not just have a running process that updates the gas price with each transaction and then when someone asks for the gas price, the stored value is just returned? I know you're all trying to do this via the blockchain, but it seems like it's not ready for that. Wouldn't this be an appropriate and effective method to mitigate this deficiency?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/359183329/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/380942410",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/15859#issuecomment-380942410",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/15859",
    "id": 380942410,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM4MDk0MjQxMA==",
    "user": {
      "login": "ryanschneider",
      "id": 53520,
      "node_id": "MDQ6VXNlcjUzNTIw",
      "avatar_url": "https://avatars.githubusercontent.com/u/53520?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanschneider",
      "html_url": "https://github.com/ryanschneider",
      "followers_url": "https://api.github.com/users/ryanschneider/followers",
      "following_url": "https://api.github.com/users/ryanschneider/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanschneider/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanschneider/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanschneider/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanschneider/orgs",
      "repos_url": "https://api.github.com/users/ryanschneider/repos",
      "events_url": "https://api.github.com/users/ryanschneider/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanschneider/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-04-12T20:58:40Z",
    "updated_at": "2018-04-12T20:58:40Z",
    "author_association": "CONTRIBUTOR",
    "body": "> Your other measurement that the pending state is slow vs. the latest block is fast is an intriguing find! I'll need to take a closer look at that.\r\n\r\n@karalabe I think I've fixed this in #16497, if you could take a look it'd be greatly appreciated!",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/380942410/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/482889778",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/15859#issuecomment-482889778",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/15859",
    "id": 482889778,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ4Mjg4OTc3OA==",
    "user": {
      "login": "stale[bot]",
      "id": 26384082,
      "node_id": "MDM6Qm90MjYzODQwODI=",
      "avatar_url": "https://avatars.githubusercontent.com/in/1724?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/stale%5Bbot%5D",
      "html_url": "https://github.com/apps/stale",
      "followers_url": "https://api.github.com/users/stale%5Bbot%5D/followers",
      "following_url": "https://api.github.com/users/stale%5Bbot%5D/following{/other_user}",
      "gists_url": "https://api.github.com/users/stale%5Bbot%5D/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/stale%5Bbot%5D/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/stale%5Bbot%5D/subscriptions",
      "organizations_url": "https://api.github.com/users/stale%5Bbot%5D/orgs",
      "repos_url": "https://api.github.com/users/stale%5Bbot%5D/repos",
      "events_url": "https://api.github.com/users/stale%5Bbot%5D/events{/privacy}",
      "received_events_url": "https://api.github.com/users/stale%5Bbot%5D/received_events",
      "type": "Bot",
      "site_admin": false
    },
    "created_at": "2019-04-13T21:23:21Z",
    "updated_at": "2019-04-13T21:23:21Z",
    "author_association": "NONE",
    "body": "This issue has been automatically marked as stale because it has not had recent activity. It will be closed if no further activity occurs. Thank you for your contributions.\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/482889778/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
