{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19263",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19263/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19263/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19263/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/19263",
  "id": 420522534,
  "node_id": "MDU6SXNzdWU0MjA1MjI1MzQ=",
  "number": 19263,
  "title": "Backup/Restart Not working with Latest Truffle/Solidity on RHEL 7.6 nor on Ubuntu 16 or 18",
  "user": {
    "login": "ghassanius",
    "id": 25767691,
    "node_id": "MDQ6VXNlcjI1NzY3Njkx",
    "avatar_url": "https://avatars.githubusercontent.com/u/25767691?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ghassanius",
    "html_url": "https://github.com/ghassanius",
    "followers_url": "https://api.github.com/users/ghassanius/followers",
    "following_url": "https://api.github.com/users/ghassanius/following{/other_user}",
    "gists_url": "https://api.github.com/users/ghassanius/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ghassanius/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ghassanius/subscriptions",
    "organizations_url": "https://api.github.com/users/ghassanius/orgs",
    "repos_url": "https://api.github.com/users/ghassanius/repos",
    "events_url": "https://api.github.com/users/ghassanius/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ghassanius/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2019-03-13T14:13:58Z",
  "updated_at": "2019-03-26T12:10:33Z",
  "closed_at": "2019-03-26T12:10:32Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "#### System information\r\n\r\nGeth version: `geth version`\r\nGeth\r\nVersion: 1.9.0-unstable\r\nGit Commit: 3eff652a7b606f25d43bef6ccb998b8e306f8a75\r\nArchitecture: amd64\r\nProtocol Versions: [63 62]\r\nNetwork Id: 1\r\nGo Version: go1.11.5\r\nOperating System: linux\r\nGOPATH=\r\nGOROOT=/usr/local/go\r\n\r\nOS & Version: Windows/Linux/OSX\r\n   Static hostname: MonimoveRedhat\r\n         Icon name: computer-vm\r\n           Chassis: vm\r\n        Machine ID: 6ca77495007bXXXXXXX8f0e34d11\r\n           Boot ID: 12699d2ae8034XXXXXX95ab3a326c\r\n    Virtualization: microsoft\r\n  Operating System: Red Hat Enterprise Linux Server 7.6 (Maipo)\r\n       CPE OS Name: cpe:/o:redhat:enterprise_linux:7.6:GA:server\r\n            Kernel: Linux 3.10.0-957.5.1.el7.x86_64\r\n      Architecture: x86-64\r\n\r\nTruffle Version:\r\nTruffle v5.0.8 (core: 5.0.8)\r\nSolidity v0.5.0 (solc-js)\r\nNode v11.11.0\r\nWeb3.js v1.0.0-beta.37\r\n\r\n\r\nCommit hash : (if `develop`)\r\n\r\n#### Expected behaviour\r\n1- The data should be backedup and I should be able to find the information I previously added whenever I import/restore the old backup.\r\n![image](https://user-images.githubusercontent.com/25767691/54363249-3bcd3b80-4673-11e9-88f7-863606adfcbb.png)\r\n\r\n\r\n2- The getPastLog functions is working fine on the first day, and it should continue working fine in the next days.\r\n\r\n#### Actual behaviour\r\n1- The data is gone and no trace for any information previously added.\r\n![image](https://user-images.githubusercontent.com/25767691/54363269-48519400-4673-11e9-86f3-1f51962bcf2e.png)\r\n\r\n\r\n2- After a while (1 day) the getPastLogs function stops working and displays the below issue (fig.2) while all other APIs are working fine (happening only on RHEL 7.6).\r\n\r\n#### Steps to reproduce the behaviour for Issue 1\r\nI tried using:\r\n- admin.importChain(file) & admin.exportChain(file).\r\n- copy/pasting the whole directory of myDataDir\r\n\r\nAll of this used to work fine on older versions of web3, solidity and truffle. But to use the getPastLog function we needed to upgrade to the newest web3 which only works with the new solidity and truffle version. \r\n\r\nMy environment is a NodeJS application that communicates with the Blockchain and save information on it. When I save some through APIs, I'm able to see the data using Get requests. When I kill the process of geth and then relaunch it using \"geth --datadir ./myDataDir --rpc --targetgaslimit 18446744073709551615 --networkid 1441 console 2>> myEth.log\" I get a complete new blockchain as if it's new! Here are the full steps:\r\n\r\n\r\n```\r\nps -aux | grep geth\r\nsudo kill -9 xxxxx\r\npm2 stop NodeApp\r\npm2 delete NodeApp\r\ncd ProjectDirectory\r\ncd Blockchain\r\ntmux\r\ngeth --datadir ./myDataDir --rpc --targetgaslimit 18446744073709551615 --networkid 1441 console 2>> myEth.log\r\nminer.start()\r\npersonal.unlockAccount(personal.listAccounts[0], \"XxXXxXXXXXxxXXxXXXxXX\", 0)\r\nctrl b+d (to keep the session running in background)\r\n\r\ncd ../Solidity\r\nrm -r build/\r\nrm ../Nodejs/server/helpers/address.json\r\nmv address.json address.json_backup\r\n\r\nvi truffle.js (update the account address)\r\ntruffle deploy --network MyNetwork\r\ncp address.json ../Nodejs/server/helpers/address.json\r\nrm ../Nodejs/server/contracts/*\r\ncp -p build/contracts/* ../Nodejs/server/contracts/\r\ncd ../Nodejs/server\r\npm2 start server.js --log-date-format 'DD-MM HH:mm:ss.SSS'\r\n```\r\n\r\n#### Backtrace\r\nUBUNTU TESTING\r\n\r\nIf you don’t delete /build and didn’t replace address.json and used the same blockchain datadir\r\n\r\ntruffle deploy --network TestingNetwork\r\n\r\n![image](https://user-images.githubusercontent.com/25767691/54423718-fdd72280-4719-11e9-889d-e05d51bacb62.png)\r\n\r\nIf you delete /build and didnt replace address.json and used the same blockchain datadir\r\nrm -r build/\r\ntruffle deploy --network TestingNetwork\r\nrm ../Nodejs/server/contracts/*\r\ncp -p build/contracts/* ../Nodejs/server/contracts/\r\ncd ../Nodejs/server\r\npm2 start myNodeApp.js --log-date-format 'DD-MM HH:mm:ss.SSS'\r\npm2 logs\r\n\r\n![image](https://user-images.githubusercontent.com/25767691/54423733-0cbdd500-471a-11e9-9f75-2a64193e9773.png)\r\n\r\n\r\nIf you delete /build and replace address.json and used the same blockchain datadir\r\npm2 stop myNodeApp\r\npm2 delete myNodeApp\r\ncd ../../Solidity/\r\nrm -r build/\r\ntruffle deploy --network TestingNetwork\r\nrm ../Nodejs/server/contracts/*\r\ncp -p build/contracts/* ../Nodejs/server/contracts/\r\ncp address.json ../Nodejs/server/helpers/address.json\r\ncd ../Nodejs/server\r\npm2 start myNodeApp.js --log-date-format 'DD-MM HH:mm:ss.SSS'\r\npm2 logs\r\n\r\nThe data is gone (get API) AND the getPastLog API DOESN’T WORK!\r\n![image](https://user-images.githubusercontent.com/25767691/54423765-1ba48780-471a-11e9-88ac-0c7188283f3c.png)\r\n\r\n\r\nTo make getPastLog API work I need to Re-Initiate the blockchain (with a new --datadir) and repeat the process again (where all data is gone)\r\n\r\n![image](https://user-images.githubusercontent.com/25767691/54423795-2828e000-471a-11e9-9caa-007989de8449.png)\r\n",
  "closed_by": {
    "login": "karalabe",
    "id": 129561,
    "node_id": "MDQ6VXNlcjEyOTU2MQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/karalabe",
    "html_url": "https://github.com/karalabe",
    "followers_url": "https://api.github.com/users/karalabe/followers",
    "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
    "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
    "organizations_url": "https://api.github.com/users/karalabe/orgs",
    "repos_url": "https://api.github.com/users/karalabe/repos",
    "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
    "received_events_url": "https://api.github.com/users/karalabe/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19263/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19263/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/476597837",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/19263#issuecomment-476597837",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19263",
    "id": 476597837,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ3NjU5NzgzNw==",
    "user": {
      "login": "karalabe",
      "id": 129561,
      "node_id": "MDQ6VXNlcjEyOTU2MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/karalabe",
      "html_url": "https://github.com/karalabe",
      "followers_url": "https://api.github.com/users/karalabe/followers",
      "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
      "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
      "organizations_url": "https://api.github.com/users/karalabe/orgs",
      "repos_url": "https://api.github.com/users/karalabe/repos",
      "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
      "received_events_url": "https://api.github.com/users/karalabe/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-03-26T12:10:32Z",
    "updated_at": "2019-03-26T12:10:32Z",
    "author_association": "MEMBER",
    "body": "Geth stores most of the chain state in memory and garbage collects junk historical state in memory. Not writing out everything to disk is essential for reasonable performance.\r\n\r\nOf course, we need to push things to disk eventually, so Geth has 3 cases where state gets written to disk: 1) if the cache allowance is reached, older nodes are flushed to disk; 1) if a significant amount of time passed (1h worth of block crunching) to create a snapshot; 3) when you gracefully terminate Geth, anything in memory is flushed to disk.\r\n\r\nNow, in your case you did a `kill -9`, which essentially insta-murders Geth, taking everything it held in memory with it to the grave. So the next time you start Geth up, it reverts to the last state that was pushed to disk and syncs from there. If you have a single-node-private-network, there's no place to get the lost data back from.\r\n\r\nTL;DR Please make sure to always gracefully terminate Geth so it can push it's hot data out to disk.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/476597837/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
