{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28534",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28534/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28534/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28534/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/28534",
  "id": 1995514778,
  "node_id": "I_kwDOAOvK98528SOa",
  "number": 28534,
  "title": "Missing attestations after upgrading to v1.13.5",
  "user": {
    "login": "adamgall",
    "id": 706929,
    "node_id": "MDQ6VXNlcjcwNjkyOQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/706929?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/adamgall",
    "html_url": "https://github.com/adamgall",
    "followers_url": "https://api.github.com/users/adamgall/followers",
    "following_url": "https://api.github.com/users/adamgall/following{/other_user}",
    "gists_url": "https://api.github.com/users/adamgall/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/adamgall/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/adamgall/subscriptions",
    "organizations_url": "https://api.github.com/users/adamgall/orgs",
    "repos_url": "https://api.github.com/users/adamgall/repos",
    "events_url": "https://api.github.com/users/adamgall/events{/privacy}",
    "received_events_url": "https://api.github.com/users/adamgall/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 72233650,
      "node_id": "MDU6TGFiZWw3MjIzMzY1MA==",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/type:bug",
      "name": "type:bug",
      "color": "FF5E5E",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2023-11-15T20:28:03Z",
  "updated_at": "2023-11-16T04:59:13Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "#### System information\r\n\r\nGeth version:\r\n```\r\n$ geth --version\r\ngeth version 1.13.5-stable-916d6a44\r\n```\r\n\r\nCL client & version:\r\n```\r\n$ lighthouse --version\r\nLighthouse v4.5.0-441fc16\r\nBLS library: blst\r\nSHA256 hardware acceleration: true\r\nAllocator: jemalloc\r\nProfile: maxperf\r\nSpecs: mainnet (true), minimal (false), gnosis (false)\r\n```\r\n\r\nOS & Version:\r\n```\r\n$ uname -a\r\nLinux nuc 5.15.0-88-generic #98-Ubuntu SMP Mon Oct 2 15:18:56 UTC 2023 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n$ lsb_release -a\r\nNo LSB modules are available.\r\nDistributor ID: Ubuntu\r\nDescription:    Ubuntu 22.04.3 LTS\r\nRelease:        22.04\r\nCodename:       jammy\r\n```\r\n\r\n#### Expected behaviour\r\nTypical high-performant attestation behavior.\r\n\r\n#### Actual behaviour\r\nMuch higher than usual instances of:\r\n- missed attestations\r\n- attestations being included in late blocks\r\n- attestations not voting on the correct chain head\r\n\r\n#### Steps to reproduce the behaviour\r\nRun `geth` on version 1.13.5\r\n\r\n#### Startup command\r\n```\r\n[Unit]\r\nDescription=Geth Execution Client\r\nWants=network-online.target\r\nAfter=network-online.target\r\n\r\n[Service]\r\nUser=geth\r\nGroup=geth\r\n\r\nType=simple\r\nRestart=always\r\n\r\nExecStart=/usr/local/bin/geth \\\r\n        --datadir=/var/lib/geth \\\r\n        --port=30303 \\\r\n        --http=true \\\r\n        --http.port=8545 \\\r\n        --authrpc.jwtsecret=/var/lib/ethereum-shared/jwt-primary.hex \\\r\n        --authrpc.port=8551 \\\r\n        --db.engine=pebble \\\r\n        --state.scheme=path \\\r\n\r\n[Install]\r\nWantedBy=multi-user.target\r\n```\r\n\r\n#### Backtrace\r\n````\r\nINFO [11-15|20:15:36.780] Imported new potential chain segment     number=18,579,606 hash=dbab5c..37f2c0 blocks=1 txs=185 mgas=16.103 elapsed=150.738ms   mgasps=106.828 snapdiffs=5.99MiB triediffs=178.01MiB triedirty=12.25MiB\r\nINFO [11-15|20:15:36.910] Chain head was updated                   number=18,579,606 hash=dbab5c..37f2c0 root=29d20e..e2074f elapsed=2.483595ms\r\nINFO [11-15|20:15:49.853] Imported new potential chain segment     number=18,579,607 hash=f712d1..aa7e0a blocks=1 txs=137 mgas=15.814 elapsed=1.138s      mgasps=13.892  snapdiffs=6.04MiB triediffs=178.04MiB triedirty=12.82MiB\r\nINFO [11-15|20:15:49.992] Chain head was updated                   number=18,579,607 hash=f712d1..aa7e0a root=85bf19..16d40f elapsed=3.660048ms\r\nINFO [11-15|20:16:02.419] Imported new potential chain segment     number=18,579,608 hash=ecba4e..265465 blocks=1 txs=126 mgas=13.707 elapsed=1.984s      mgasps=6.905   snapdiffs=6.07MiB triediffs=177.81MiB triedirty=13.24MiB\r\nINFO [11-15|20:16:02.592] Chain head was updated                   number=18,579,608 hash=ecba4e..265465 root=0aadca..cab0b8 elapsed=3.509709ms\r\nINFO [11-15|20:16:16.972] Imported new potential chain segment     number=18,579,609 hash=d92259..820503 blocks=1 txs=214 mgas=22.833 elapsed=2.050s      mgasps=11.135  snapdiffs=6.11MiB triediffs=178.43MiB triedirty=13.67MiB\r\nINFO [11-15|20:16:17.131] Chain head was updated                   number=18,579,609 hash=d92259..820503 root=69fa1b..8cc8ed elapsed=3.917986ms\r\nINFO [11-15|20:16:26.642] Imported new potential chain segment     number=18,579,610 hash=66882a..6c500f blocks=1 txs=117 mgas=10.856 elapsed=2.011s      mgasps=5.397   snapdiffs=6.15MiB triediffs=178.37MiB triedirty=14.08MiB\r\nINFO [11-15|20:16:26.776] Chain head was updated                   number=18,579,610 hash=66882a..6c500f root=6c299b..ccd5ff elapsed=2.88514ms\r\nINFO [11-15|20:16:38.755] Imported new potential chain segment     number=18,579,611 hash=972d8c..06f8dd blocks=1 txs=141 mgas=10.532 elapsed=1.931s      mgasps=5.453   snapdiffs=6.18MiB triediffs=178.29MiB triedirty=14.47MiB\r\nINFO [11-15|20:16:38.947] Chain head was updated                   number=18,579,611 hash=972d8c..06f8dd root=fd3463..1c5048 elapsed=2.612727ms\r\nINFO [11-15|20:16:50.525] Imported new potential chain segment     number=18,579,612 hash=2f1817..fbc1b5 blocks=1 txs=188 mgas=13.286 elapsed=2.107s      mgasps=6.305   snapdiffs=6.22MiB triediffs=178.40MiB triedirty=15.02MiB\r\nINFO [11-15|20:16:50.663] Chain head was updated                   number=18,579,612 hash=2f1817..fbc1b5 root=bec5ce..3c5e22 elapsed=3.444437ms\r\nINFO [11-15|20:17:01.373] Imported new potential chain segment     number=18,579,613 hash=037f6b..9a1169 blocks=1 txs=135 mgas=11.636 elapsed=933.221ms   mgasps=12.469  snapdiffs=6.26MiB triediffs=178.21MiB triedirty=15.55MiB\r\nINFO [11-15|20:17:01.509] Chain head was updated                   number=18,579,613 hash=037f6b..9a1169 root=255985..95ccee elapsed=2.088793ms\r\nINFO [11-15|20:17:12.655] Imported new potential chain segment     number=18,579,614 hash=689b77..3533fa blocks=1 txs=216 mgas=16.396 elapsed=184.686ms   mgasps=88.777  snapdiffs=6.30MiB triediffs=178.65MiB triedirty=15.97MiB\r\nINFO [11-15|20:17:12.772] Chain head was updated                   number=18,579,614 hash=689b77..3533fa root=081983..580735 elapsed=3.296078ms\r\nINFO [11-15|20:17:25.151] Imported new potential chain segment     number=18,579,615 hash=0df623..47a13a blocks=1 txs=138 mgas=14.496 elapsed=189.998ms   mgasps=76.296  snapdiffs=6.34MiB triediffs=178.73MiB triedirty=16.38MiB\r\nINFO [11-15|20:17:25.285] Chain head was updated                   number=18,579,615 hash=0df623..47a13a root=6e09f5..49b456 elapsed=4.620928ms\r\nINFO [11-15|20:17:38.091] Imported new potential chain segment     number=18,579,616 hash=78bc61..c2c488 blocks=1 txs=206 mgas=18.955 elapsed=204.642ms   mgasps=92.626  snapdiffs=6.39MiB triediffs=179.20MiB triedirty=16.74MiB\r\nINFO [11-15|20:17:38.212] Chain head was updated                   number=18,579,616 hash=78bc61..c2c488 root=6ebe99..9df013 elapsed=2.753035ms\r\nINFO [11-15|20:17:51.712] Imported new potential chain segment     number=18,579,617 hash=2cf10c..a8c0a9 blocks=1 txs=145 mgas=14.961 elapsed=1.137s      mgasps=13.148  snapdiffs=6.43MiB triediffs=179.38MiB triedirty=17.16MiB\r\nINFO [11-15|20:17:51.861] Chain head was updated                   number=18,579,617 hash=2cf10c..a8c0a9 root=cbf2f6..079f30 elapsed=4.30093ms\r\nINFO [11-15|20:18:04.540] Imported new potential chain segment     number=18,579,618 hash=c4b4b0..dbc556 blocks=1 txs=152 mgas=23.963 elapsed=2.023s      mgasps=11.844  snapdiffs=6.47MiB triediffs=179.80MiB triedirty=17.44MiB\r\nINFO [11-15|20:18:04.670] Chain head was updated                   number=18,579,618 hash=c4b4b0..dbc556 root=4d75ec..b2f8e8 elapsed=5.809166ms\r\nINFO [11-15|20:18:14.677] Imported new potential chain segment     number=18,579,619 hash=915087..1d32d9 blocks=1 txs=149 mgas=14.145 elapsed=2.041s      mgasps=6.928   snapdiffs=6.50MiB triediffs=179.93MiB triedirty=17.81MiB\r\nINFO [11-15|20:18:14.792] Chain head was updated                   number=18,579,619 hash=915087..1d32d9 root=c87184..be711b elapsed=3.238122ms\r\nINFO [11-15|20:18:26.486] Imported new potential chain segment     number=18,579,620 hash=f14a75..03ced5 blocks=1 txs=254 mgas=15.461 elapsed=1.994s      mgasps=7.750   snapdiffs=6.54MiB triediffs=180.31MiB triedirty=18.14MiB\r\nINFO [11-15|20:18:26.602] Chain head was updated                   number=18,579,620 hash=f14a75..03ced5 root=ee9481..28f946 elapsed=3.521982ms\r\n\r\n````\r\n\r\nLooking at the logs, it seems like there are periods where the `elapsed` time on \"Imported new potential chain segment\" logs are on the order of seconds. These periods last for a few slots, then go back to \"normal\" processing times (on the order of 1-200ms) for a few slots, then repeat.\r\n\r\nI suspect that it's these periods of \"slow\" chain segmet processing times that are leading to poor attestation performance, but that's an assumption. That is the only difference I can see between the logs of 1.13.5, vs 1.13.4 (apart from no more \"Peer delivering stale transaction\" logs!)\r\n\r\nThis slow chain segment processing issue (assuming it's the culprit for poor attestation performance) was not occurring on my machine when running version 1.13.4.",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28534/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28534/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1813373671",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/28534#issuecomment-1813373671",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28534",
    "id": 1813373671,
    "node_id": "IC_kwDOAOvK985sFeLn",
    "user": {
      "login": "MariusVanDerWijden",
      "id": 16664698,
      "node_id": "MDQ6VXNlcjE2NjY0Njk4",
      "avatar_url": "https://avatars.githubusercontent.com/u/16664698?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MariusVanDerWijden",
      "html_url": "https://github.com/MariusVanDerWijden",
      "followers_url": "https://api.github.com/users/MariusVanDerWijden/followers",
      "following_url": "https://api.github.com/users/MariusVanDerWijden/following{/other_user}",
      "gists_url": "https://api.github.com/users/MariusVanDerWijden/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MariusVanDerWijden/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MariusVanDerWijden/subscriptions",
      "organizations_url": "https://api.github.com/users/MariusVanDerWijden/orgs",
      "repos_url": "https://api.github.com/users/MariusVanDerWijden/repos",
      "events_url": "https://api.github.com/users/MariusVanDerWijden/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MariusVanDerWijden/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-11-15T22:35:17Z",
    "updated_at": "2023-11-15T22:38:02Z",
    "author_association": "MEMBER",
    "body": "Thanks for reporting, could you try upping the log level for the trie `debug.vmodule(\"trie=5\")` in the console and post more logs? Do you have a dashboard by chance where we could see some more numbers? \r\n\r\nI think it might be the freezer fsync or the trie flush",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1813373671/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1813423180",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/28534#issuecomment-1813423180",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28534",
    "id": 1813423180,
    "node_id": "IC_kwDOAOvK985sFqRM",
    "user": {
      "login": "adamgall",
      "id": 706929,
      "node_id": "MDQ6VXNlcjcwNjkyOQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/706929?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/adamgall",
      "html_url": "https://github.com/adamgall",
      "followers_url": "https://api.github.com/users/adamgall/followers",
      "following_url": "https://api.github.com/users/adamgall/following{/other_user}",
      "gists_url": "https://api.github.com/users/adamgall/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/adamgall/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/adamgall/subscriptions",
      "organizations_url": "https://api.github.com/users/adamgall/orgs",
      "repos_url": "https://api.github.com/users/adamgall/repos",
      "events_url": "https://api.github.com/users/adamgall/events{/privacy}",
      "received_events_url": "https://api.github.com/users/adamgall/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-11-15T23:12:57Z",
    "updated_at": "2023-11-15T23:46:09Z",
    "author_association": "NONE",
    "body": "@MariusVanDerWijden I don't have a dashboard... if it's worthwhile, can you point me in a direction to set one up?\r\n\r\nAlso, I'm unsure how/where to use `debug.vmodule(\"trie=5\")`. Is this something I can do as a startup flag? I'm currently viewing logs via `journalctl`. Apologies for my noobness here.\r\n\r\nedit:\r\n\r\nAs per the `geth --help` output:\r\n\r\n```\r\n--log.vmodule value                                                    ($GETH_LOG_VMODULE)\r\n          Per-module verbosity: comma-separated list of <pattern>=<level> (e.g. eth/*=5,p2p=4)\r\n```\r\n\r\nI'm running `geth` via `systemd` with a `--log.vmodule trie=5` flag. It's not giving any more logs than normal, though. I made sure that other `log.vmodule` flags _did_ show more logs (`eth/*=6` immediately started spitting out a ton of logs I've never seen before). Are you sure that `trie=5` is right?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1813423180/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1813790757",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/28534#issuecomment-1813790757",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28534",
    "id": 1813790757,
    "node_id": "IC_kwDOAOvK985sHEAl",
    "user": {
      "login": "MariusVanDerWijden",
      "id": 16664698,
      "node_id": "MDQ6VXNlcjE2NjY0Njk4",
      "avatar_url": "https://avatars.githubusercontent.com/u/16664698?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MariusVanDerWijden",
      "html_url": "https://github.com/MariusVanDerWijden",
      "followers_url": "https://api.github.com/users/MariusVanDerWijden/followers",
      "following_url": "https://api.github.com/users/MariusVanDerWijden/following{/other_user}",
      "gists_url": "https://api.github.com/users/MariusVanDerWijden/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MariusVanDerWijden/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MariusVanDerWijden/subscriptions",
      "organizations_url": "https://api.github.com/users/MariusVanDerWijden/orgs",
      "repos_url": "https://api.github.com/users/MariusVanDerWijden/repos",
      "events_url": "https://api.github.com/users/MariusVanDerWijden/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MariusVanDerWijden/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-11-16T04:57:35Z",
    "updated_at": "2023-11-16T04:59:13Z",
    "author_association": "MEMBER",
    "body": "Ah maybe `\"trie/triedb/pathdb=5\"` or `\"trie/*=5\"`. You can connect a console to your running geth node, so you don't need to restart to change the flags with `geth attach ~/path/to/geth.ipc console`\r\n\r\nIt would be interesting to see if any `log.Debug(\"Pruned state history\", \"items\", pruned, \"tailid\", oldest)` show up ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1813790757/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
