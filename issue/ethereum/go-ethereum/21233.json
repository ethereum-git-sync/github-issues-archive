{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21233",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21233/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21233/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21233/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/21233",
  "id": 640576431,
  "node_id": "MDU6SXNzdWU2NDA1NzY0MzE=",
  "number": 21233,
  "title": "Storage locality",
  "user": {
    "login": "iliastsa",
    "id": 1656407,
    "node_id": "MDQ6VXNlcjE2NTY0MDc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1656407?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/iliastsa",
    "html_url": "https://github.com/iliastsa",
    "followers_url": "https://api.github.com/users/iliastsa/followers",
    "following_url": "https://api.github.com/users/iliastsa/following{/other_user}",
    "gists_url": "https://api.github.com/users/iliastsa/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/iliastsa/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/iliastsa/subscriptions",
    "organizations_url": "https://api.github.com/users/iliastsa/orgs",
    "repos_url": "https://api.github.com/users/iliastsa/repos",
    "events_url": "https://api.github.com/users/iliastsa/events{/privacy}",
    "received_events_url": "https://api.github.com/users/iliastsa/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1132689577,
      "node_id": "MDU6TGFiZWwxMTMyNjg5NTc3",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/status:triage",
      "name": "status:triage",
      "color": "6be514",
      "default": false,
      "description": ""
    },
    {
      "id": 2144913747,
      "node_id": "MDU6TGFiZWwyMTQ0OTEzNzQ3",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/type:improvement",
      "name": "type:improvement",
      "color": "c7ce4a",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2020-06-17T16:24:17Z",
  "updated_at": "2020-09-03T09:56:06Z",
  "closed_at": "2020-09-03T08:22:54Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "Hi everyone, lately I've been looking into geth sync performance together with @yanniss. I am reposting a message that @yanniss posted on Discord regarding some potential improvements on storage trie locallity:\r\n\r\n> Hi all. I'm trying to understand geth archive-sync performance and have been browsing the code for the past couple of days. Am I correct in that there's no locality in how trie data are stored in LevelDB? That is, different nodes of the storage trie of a single account are in no way stored close-by, just at random locations, due to hashed keys? (I see there is locality for account snapshots, but I think these are not used during initial syncing?) \r\n> \r\n> I'm guessing improving locality has been tried and there are space savings in the DB (i.e., single representation of distinct tries) that are more valuable than encoding parts of the same trie with prefix-related keys? Have the savings of tries sharing representations been quantified? (I may want to work on improving locality, if people can tell me what has been tried already.)",
  "closed_by": {
    "login": "holiman",
    "id": 142290,
    "node_id": "MDQ6VXNlcjE0MjI5MA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/holiman",
    "html_url": "https://github.com/holiman",
    "followers_url": "https://api.github.com/users/holiman/followers",
    "following_url": "https://api.github.com/users/holiman/following{/other_user}",
    "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
    "organizations_url": "https://api.github.com/users/holiman/orgs",
    "repos_url": "https://api.github.com/users/holiman/repos",
    "events_url": "https://api.github.com/users/holiman/events{/privacy}",
    "received_events_url": "https://api.github.com/users/holiman/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21233/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21233/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/646949035",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/21233#issuecomment-646949035",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21233",
    "id": 646949035,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY0Njk0OTAzNQ==",
    "user": {
      "login": "hmijail",
      "id": 4139546,
      "node_id": "MDQ6VXNlcjQxMzk1NDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4139546?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hmijail",
      "html_url": "https://github.com/hmijail",
      "followers_url": "https://api.github.com/users/hmijail/followers",
      "following_url": "https://api.github.com/users/hmijail/following{/other_user}",
      "gists_url": "https://api.github.com/users/hmijail/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hmijail/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hmijail/subscriptions",
      "organizations_url": "https://api.github.com/users/hmijail/orgs",
      "repos_url": "https://api.github.com/users/hmijail/repos",
      "events_url": "https://api.github.com/users/hmijail/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hmijail/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-06-20T06:13:19Z",
    "updated_at": "2020-06-20T06:13:19Z",
    "author_association": "NONE",
    "body": "I have also been thinking about experimenting with a trie using locality-preserving hashes and some smartish encoding to try to keep related nodes nearby - though surely then hash collisions would be an issue. So, I'd also love to know what has already been tried. ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/646949035/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/653115497",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/21233#issuecomment-653115497",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21233",
    "id": 653115497,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY1MzExNTQ5Nw==",
    "user": {
      "login": "AusIV",
      "id": 977954,
      "node_id": "MDQ6VXNlcjk3Nzk1NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/977954?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AusIV",
      "html_url": "https://github.com/AusIV",
      "followers_url": "https://api.github.com/users/AusIV/followers",
      "following_url": "https://api.github.com/users/AusIV/following{/other_user}",
      "gists_url": "https://api.github.com/users/AusIV/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AusIV/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AusIV/subscriptions",
      "organizations_url": "https://api.github.com/users/AusIV/orgs",
      "repos_url": "https://api.github.com/users/AusIV/repos",
      "events_url": "https://api.github.com/users/AusIV/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AusIV/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-07-02T16:47:58Z",
    "updated_at": "2020-07-02T16:47:58Z",
    "author_association": "CONTRIBUTOR",
    "body": "The way leveldb is structured there's really no feasible way to ensure node locality.\r\n\r\nLeveldb is not a great database for storing trie structures. Each node has to be stored by its hash, and looking up a node from its hash takes 4-7 disk reads depending on available RAM.\r\n\r\nI've outlined a data storage engine optimized for storing state tries [here](https://github.com/openrelayxyz/triedb/blob/master/docs/source/topic/design.rst), but I have no idea if I'll ever get around to actually building it. Even then I don't really worry about locality, so much as each trie node telling you exactly where in the file to go for the next node, rather than having to go back to an index to look up each node.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/653115497/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/686335867",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/21233#issuecomment-686335867",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21233",
    "id": 686335867,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY4NjMzNTg2Nw==",
    "user": {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-09-03T08:22:54Z",
    "updated_at": "2020-09-03T08:22:54Z",
    "author_association": "MEMBER",
    "body": "There's not much we can do to improve locality right now, we're pretty vested in the current storage-by-hash. The constraints might be lifted a bit when we start to use the snap protocol, giving us more freedom to experiment. ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/686335867/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/686383499",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/21233#issuecomment-686383499",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21233",
    "id": 686383499,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY4NjM4MzQ5OQ==",
    "user": {
      "login": "yanniss",
      "id": 4835915,
      "node_id": "MDQ6VXNlcjQ4MzU5MTU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4835915?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/yanniss",
      "html_url": "https://github.com/yanniss",
      "followers_url": "https://api.github.com/users/yanniss/followers",
      "following_url": "https://api.github.com/users/yanniss/following{/other_user}",
      "gists_url": "https://api.github.com/users/yanniss/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/yanniss/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/yanniss/subscriptions",
      "organizations_url": "https://api.github.com/users/yanniss/orgs",
      "repos_url": "https://api.github.com/users/yanniss/repos",
      "events_url": "https://api.github.com/users/yanniss/events{/privacy}",
      "received_events_url": "https://api.github.com/users/yanniss/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-09-03T09:56:06Z",
    "updated_at": "2020-09-03T09:56:06Z",
    "author_association": "NONE",
    "body": "Just wanted to say that this is still in our work queue and we are likely to re-open the issue in the next couple of months. We plan to implement a storage model that preserves locality, alongside a secondary index that offers the current access-by-node-hash required by `GetNodeData` and other current uses.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/686383499/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
