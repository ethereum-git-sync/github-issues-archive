{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/15447",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/15447/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/15447/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/15447/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/15447",
  "id": 272535177,
  "node_id": "MDU6SXNzdWUyNzI1MzUxNzc=",
  "number": 15447,
  "title": "Head announced to LES/1 clients is not always honoured",
  "user": {
    "login": "gsalgado",
    "id": 412274,
    "node_id": "MDQ6VXNlcjQxMjI3NA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/412274?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/gsalgado",
    "html_url": "https://github.com/gsalgado",
    "followers_url": "https://api.github.com/users/gsalgado/followers",
    "following_url": "https://api.github.com/users/gsalgado/following{/other_user}",
    "gists_url": "https://api.github.com/users/gsalgado/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/gsalgado/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/gsalgado/subscriptions",
    "organizations_url": "https://api.github.com/users/gsalgado/orgs",
    "repos_url": "https://api.github.com/users/gsalgado/repos",
    "events_url": "https://api.github.com/users/gsalgado/events{/privacy}",
    "received_events_url": "https://api.github.com/users/gsalgado/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 856638432,
      "node_id": "MDU6TGFiZWw4NTY2Mzg0MzI=",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/status:inactive",
      "name": "status:inactive",
      "color": "ffffff",
      "default": false,
      "description": null
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "zsfelfoldi",
    "id": 9884311,
    "node_id": "MDQ6VXNlcjk4ODQzMTE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/9884311?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/zsfelfoldi",
    "html_url": "https://github.com/zsfelfoldi",
    "followers_url": "https://api.github.com/users/zsfelfoldi/followers",
    "following_url": "https://api.github.com/users/zsfelfoldi/following{/other_user}",
    "gists_url": "https://api.github.com/users/zsfelfoldi/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/zsfelfoldi/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/zsfelfoldi/subscriptions",
    "organizations_url": "https://api.github.com/users/zsfelfoldi/orgs",
    "repos_url": "https://api.github.com/users/zsfelfoldi/repos",
    "events_url": "https://api.github.com/users/zsfelfoldi/events{/privacy}",
    "received_events_url": "https://api.github.com/users/zsfelfoldi/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "zsfelfoldi",
      "id": 9884311,
      "node_id": "MDQ6VXNlcjk4ODQzMTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9884311?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/zsfelfoldi",
      "html_url": "https://github.com/zsfelfoldi",
      "followers_url": "https://api.github.com/users/zsfelfoldi/followers",
      "following_url": "https://api.github.com/users/zsfelfoldi/following{/other_user}",
      "gists_url": "https://api.github.com/users/zsfelfoldi/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/zsfelfoldi/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/zsfelfoldi/subscriptions",
      "organizations_url": "https://api.github.com/users/zsfelfoldi/orgs",
      "repos_url": "https://api.github.com/users/zsfelfoldi/repos",
      "events_url": "https://api.github.com/users/zsfelfoldi/events{/privacy}",
      "received_events_url": "https://api.github.com/users/zsfelfoldi/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2017-11-09T11:44:47Z",
  "updated_at": "2018-12-04T08:27:45Z",
  "closed_at": "2018-12-04T08:27:45Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "I'm working on a (Python light-client implementation)[https://github.com/pipermerriam/py-evm/tree/master/evm/p2p] and I've been running it on mainnet for a while, but a few times I've seen geth nodes send LES/Announce messages indicating a new head with a given number/hash and then immediately contradict themselves by sending me a header with a different hash when I request the header with the just-announced number.\r\n\r\nBelow is a snippet from my client's logs, which shows what usually happens when a new head is announced. \r\n\r\nFirst we get the announce msg...\r\n> INFO: New LES/Announce by LESPeer <Node(0x3f1d@13.93.211.84)>; head_number==4515320, head_hash==0xc4d9346836173d85859afe919940d14fc3d22b607d530520636ba75ced3cf483, reorg_depth==0\r\n\r\n... then we fetch all headers from the previously announced one until the new one, which in this case is jut the new one.\r\n> INFO: fetched headers from 4515320 to 4515320\r\n\r\nAnd here we see the header has been persisted to our local DB.\r\n> INFO: Persisted header 0xc4d9346836173d85859afe919940d14fc3d22b607d530520636ba75ced3cf483\r\n> INFO: synced headers up to #4515320\r\n\r\nNow, a few times already I've seen peers announce a new head with a given hash, but when I ask for that header (by block number), it gives me a header with the same number but a different hash. Here's how it shows up on my logs:\r\n\r\n> INFO: New LES/Announce by LESPeer <Node(0x3f1d@13.93.211.84)>; head_number==4515321, head_hash==0x9b93741884e5ef475091ab1d2dc6763cce4bcf02975237d2952a7caf1f3c1173, reorg_depth==0\r\n> INFO: fetched headers from 4515321 to 4515321\r\n> INFO: Persisted header 0xd4dba96b6bcf6c127e1f4a9fd07a4bb7c0258edf817ede355cd8064f40f6044a\r\n> INFO: synced headers up to #4515321\r\n\r\nBasically, my client gets the announce msg, asks the peer for header #4515321, but then gets a header which is different from the announced one. Notice that the [announced head indeed became part of the canonical chain](https://etherscan.io/block/0x9b93741884e5ef475091ab1d2dc6763cce4bcf02975237d2952a7caf1f3c1173), whereas the one I was sent in response to the GetBlockHeaders was [added as an uncle two blocks later](https://etherscan.io/uncle/0xd4dba96b6bcf6c127e1f4a9fd07a4bb7c0258edf817ede355cd8064f40f6044a)\r\n\r\nIn this specific case, I got the same announce msg from the 3 peers I was connected to, and two of them exibited the behaviour above whereas the 3rd sent me an empty BlockHeaders msg in response to my GetBlockHeaders(4515321) msg.\r\n\r\nAfter that they announce block #4515322, with a reorg_depth of 0, so my client fetches only that since it should have its parent, but that's not really the case because what they gave me as block #4515321 is 0xd4dba9 and not 0x9b9374\r\n\r\n> INFO: New LES/Announce by LESPeer <Node(0x3f1d@13.93.211.84)>; head_number==4515322, head_hash==0x3c0ef1242eb852556c03a1f344bee009d550a6805047f37960d97b3fec593ebb, reorg_depth==0\r\n> INFO: fetched headers from 4515322 to 4515322\r\n\r\nThis is where my client crashes because it's never received header 0x9b9374, even though it asked for that (via block number) when it was announced as the new head.\r\n\r\nAs per my understanding of things, this behaviour should not be expected from geth, but maybe I'm missing something and this is something a light client should be able to handle?\r\n\r\nI'd be happy to dig further into geth's code to try and find the cause, if this behaviour is indeed incorrect.",
  "closed_by": {
    "login": "adamschmideg",
    "id": 208822,
    "node_id": "MDQ6VXNlcjIwODgyMg==",
    "avatar_url": "https://avatars.githubusercontent.com/u/208822?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/adamschmideg",
    "html_url": "https://github.com/adamschmideg",
    "followers_url": "https://api.github.com/users/adamschmideg/followers",
    "following_url": "https://api.github.com/users/adamschmideg/following{/other_user}",
    "gists_url": "https://api.github.com/users/adamschmideg/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/adamschmideg/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/adamschmideg/subscriptions",
    "organizations_url": "https://api.github.com/users/adamschmideg/orgs",
    "repos_url": "https://api.github.com/users/adamschmideg/repos",
    "events_url": "https://api.github.com/users/adamschmideg/events{/privacy}",
    "received_events_url": "https://api.github.com/users/adamschmideg/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/15447/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/15447/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/343532523",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/15447#issuecomment-343532523",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/15447",
    "id": 343532523,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM0MzUzMjUyMw==",
    "user": {
      "login": "karalabe",
      "id": 129561,
      "node_id": "MDQ6VXNlcjEyOTU2MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/karalabe",
      "html_url": "https://github.com/karalabe",
      "followers_url": "https://api.github.com/users/karalabe/followers",
      "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
      "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
      "organizations_url": "https://api.github.com/users/karalabe/orgs",
      "repos_url": "https://api.github.com/users/karalabe/repos",
      "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
      "received_events_url": "https://api.github.com/users/karalabe/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-11-10T17:15:44Z",
    "updated_at": "2017-11-10T17:15:44Z",
    "author_association": "MEMBER",
    "body": "Couldn't it happen that Geth receives a new block with number N, imports and announces it, but afterwards it also receives a new block with number N, but a larger TD, so it imports the new one. When you ask for the head, Geth already has the new one as the best, so it returns that.\r\n\r\nGenerally if you are interested in a specific header, you should always ask for it via its hash.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/343532523/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/343539679",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/15447#issuecomment-343539679",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/15447",
    "id": 343539679,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM0MzUzOTY3OQ==",
    "user": {
      "login": "gsalgado",
      "id": 412274,
      "node_id": "MDQ6VXNlcjQxMjI3NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/412274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gsalgado",
      "html_url": "https://github.com/gsalgado",
      "followers_url": "https://api.github.com/users/gsalgado/followers",
      "following_url": "https://api.github.com/users/gsalgado/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsalgado/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gsalgado/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsalgado/subscriptions",
      "organizations_url": "https://api.github.com/users/gsalgado/orgs",
      "repos_url": "https://api.github.com/users/gsalgado/repos",
      "events_url": "https://api.github.com/users/gsalgado/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gsalgado/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-11-10T17:45:11Z",
    "updated_at": "2017-11-10T17:45:11Z",
    "author_association": "MEMBER",
    "body": "In this specific case, though, both blocks have the same difficulty and parent, so AIUI, the same TD. Geth first announces [block 0x9b937 as head at height 4515321](https://etherscan.io/block/0x9b93741884e5ef475091ab1d2dc6763cce4bcf02975237d2952a7caf1f3c1173), then when I ask for the head at that point it gives me [a different one (0xd4dba)](https://etherscan.io/uncle/0xd4dba96b6bcf6c127e1f4a9fd07a4bb7c0258edf817ede355cd8064f40f6044a), but ultimately the next head ([4515322](https://etherscan.io/block/4515322)) builds on top of the originally announced one, which I never got. And in the announce msg for 4515322, reorg_depth was 0, so my client didn't ask for any headers prior to that when syncing\r\n\r\nI could look into changing my client to use the hash instead of block number in GetBlockHeader requests, but still this behaviour is surprising to me and may confuse other light client developers as well",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/343539679/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/344688194",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/15447#issuecomment-344688194",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/15447",
    "id": 344688194,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM0NDY4ODE5NA==",
    "user": {
      "login": "zsfelfoldi",
      "id": 9884311,
      "node_id": "MDQ6VXNlcjk4ODQzMTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9884311?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/zsfelfoldi",
      "html_url": "https://github.com/zsfelfoldi",
      "followers_url": "https://api.github.com/users/zsfelfoldi/followers",
      "following_url": "https://api.github.com/users/zsfelfoldi/following{/other_user}",
      "gists_url": "https://api.github.com/users/zsfelfoldi/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/zsfelfoldi/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/zsfelfoldi/subscriptions",
      "organizations_url": "https://api.github.com/users/zsfelfoldi/orgs",
      "repos_url": "https://api.github.com/users/zsfelfoldi/repos",
      "events_url": "https://api.github.com/users/zsfelfoldi/events{/privacy}",
      "received_events_url": "https://api.github.com/users/zsfelfoldi/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-11-15T18:42:06Z",
    "updated_at": "2017-11-15T18:42:06Z",
    "author_association": "MEMBER",
    "body": "It is surprising and I will check out if it might be some weird race issue. Still, when requesting headers by number you should always be prepared for reorgs. The above scenarios are theoretically possible even if everything works correctly. When fully synced and just requesting freshly announced headers, it is always best to request by hash.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/344688194/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/439501260",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/15447#issuecomment-439501260",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/15447",
    "id": 439501260,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQzOTUwMTI2MA==",
    "user": {
      "login": "stale[bot]",
      "id": 26384082,
      "node_id": "MDM6Qm90MjYzODQwODI=",
      "avatar_url": "https://avatars.githubusercontent.com/in/1724?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/stale%5Bbot%5D",
      "html_url": "https://github.com/apps/stale",
      "followers_url": "https://api.github.com/users/stale%5Bbot%5D/followers",
      "following_url": "https://api.github.com/users/stale%5Bbot%5D/following{/other_user}",
      "gists_url": "https://api.github.com/users/stale%5Bbot%5D/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/stale%5Bbot%5D/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/stale%5Bbot%5D/subscriptions",
      "organizations_url": "https://api.github.com/users/stale%5Bbot%5D/orgs",
      "repos_url": "https://api.github.com/users/stale%5Bbot%5D/repos",
      "events_url": "https://api.github.com/users/stale%5Bbot%5D/events{/privacy}",
      "received_events_url": "https://api.github.com/users/stale%5Bbot%5D/received_events",
      "type": "Bot",
      "site_admin": false
    },
    "created_at": "2018-11-16T19:29:31Z",
    "updated_at": "2018-11-16T19:29:31Z",
    "author_association": "NONE",
    "body": "This issue has been automatically marked as stale because it has not had recent activity. It will be closed if no further activity occurs. Thank you for your contributions.\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/439501260/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/444013134",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/15447#issuecomment-444013134",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/15447",
    "id": 444013134,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ0NDAxMzEzNA==",
    "user": {
      "login": "adamschmideg",
      "id": 208822,
      "node_id": "MDQ6VXNlcjIwODgyMg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/208822?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/adamschmideg",
      "html_url": "https://github.com/adamschmideg",
      "followers_url": "https://api.github.com/users/adamschmideg/followers",
      "following_url": "https://api.github.com/users/adamschmideg/following{/other_user}",
      "gists_url": "https://api.github.com/users/adamschmideg/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/adamschmideg/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/adamschmideg/subscriptions",
      "organizations_url": "https://api.github.com/users/adamschmideg/orgs",
      "repos_url": "https://api.github.com/users/adamschmideg/repos",
      "events_url": "https://api.github.com/users/adamschmideg/events{/privacy}",
      "received_events_url": "https://api.github.com/users/adamschmideg/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-12-04T08:27:45Z",
    "updated_at": "2018-12-04T08:27:45Z",
    "author_association": "MEMBER",
    "body": "@gsalgado If the issue persists, please, open a new ticket",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/444013134/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
