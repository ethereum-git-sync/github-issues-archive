{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18525",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18525/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18525/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18525/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/18525",
  "id": 403428975,
  "node_id": "MDU6SXNzdWU0MDM0Mjg5NzU=",
  "number": 18525,
  "title": "geth copydb panic",
  "user": {
    "login": "huangyg11",
    "id": 5545682,
    "node_id": "MDQ6VXNlcjU1NDU2ODI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5545682?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/huangyg11",
    "html_url": "https://github.com/huangyg11",
    "followers_url": "https://api.github.com/users/huangyg11/followers",
    "following_url": "https://api.github.com/users/huangyg11/following{/other_user}",
    "gists_url": "https://api.github.com/users/huangyg11/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/huangyg11/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/huangyg11/subscriptions",
    "organizations_url": "https://api.github.com/users/huangyg11/orgs",
    "repos_url": "https://api.github.com/users/huangyg11/repos",
    "events_url": "https://api.github.com/users/huangyg11/events{/privacy}",
    "received_events_url": "https://api.github.com/users/huangyg11/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2019-01-26T10:41:04Z",
  "updated_at": "2019-03-07T11:06:37Z",
  "closed_at": "2019-03-07T11:06:37Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "#### System information\r\n\r\nGeth version: 1.8.21-stable\r\nOS & Version: Linux\r\nCommit hash : 9dc5d1a915ac0e0bd8429d6ac41df50eec91de5f\r\n\r\n#### Expected behaviour\r\n\r\ncopy db start normally\r\n\r\n#### Actual behaviour\r\n\r\nthrow panic in line eth/downloader/statesync.go:313. \r\n\r\nI have debug it, and find `s.d.dropPeer` is nil. \r\n\r\nThere exists two problems\r\n- why dropPeer is nil\r\n- why will it timeout even copy db from local dir.\r\n\r\nI further trace it down, and find when copydb started, it get the head of number 7123380, while in geth console with command `eth.blocknumber`, I get 7123313. So when it want to fetch sate trie for block 7123380, it get a nil state, trigering the timeout case.\r\n\r\nAs a workround, I modify the function head in eth/downloader/fakepeer.go:47 to return a fix head, and now the copydb start without problem.\r\n\r\n```\r\nfunc (p *FakePeer) Head() (common.Hash, *big.Int) {\r\n\tbytes, _ := hexutil.Decode(\"0x0aa3dd35777cdffd591d18f6c54bd9910524d4353c13df49c639ca21ccc9881c\")\r\n\treturn common.BytesToHash(bytes), big.NewInt(int64(7123313))\r\n\r\n}\r\n```\r\n\r\n#### Backtrace\r\n\r\n````\r\nruntime error: invalid memory address or nil pointer dereference in line eth/downloader/statesync.go:313\r\n````\r\n",
  "closed_by": {
    "login": "karalabe",
    "id": 129561,
    "node_id": "MDQ6VXNlcjEyOTU2MQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/karalabe",
    "html_url": "https://github.com/karalabe",
    "followers_url": "https://api.github.com/users/karalabe/followers",
    "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
    "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
    "organizations_url": "https://api.github.com/users/karalabe/orgs",
    "repos_url": "https://api.github.com/users/karalabe/repos",
    "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
    "received_events_url": "https://api.github.com/users/karalabe/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18525/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18525/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/458033652",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/18525#issuecomment-458033652",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18525",
    "id": 458033652,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ1ODAzMzY1Mg==",
    "user": {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-01-28T08:14:45Z",
    "updated_at": "2019-01-28T08:14:45Z",
    "author_association": "MEMBER",
    "body": "Interesting. If you start geth regularly, or e.g. with `--maxpeers 0 --nodiscover`, could you provide the first few lines of log output, where it tells you about your sync progress? (latest block, latest full block etc)",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/458033652/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/458106331",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/18525#issuecomment-458106331",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18525",
    "id": 458106331,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ1ODEwNjMzMQ==",
    "user": {
      "login": "huangyg11",
      "id": 5545682,
      "node_id": "MDQ6VXNlcjU1NDU2ODI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5545682?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/huangyg11",
      "html_url": "https://github.com/huangyg11",
      "followers_url": "https://api.github.com/users/huangyg11/followers",
      "following_url": "https://api.github.com/users/huangyg11/following{/other_user}",
      "gists_url": "https://api.github.com/users/huangyg11/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/huangyg11/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/huangyg11/subscriptions",
      "organizations_url": "https://api.github.com/users/huangyg11/orgs",
      "repos_url": "https://api.github.com/users/huangyg11/repos",
      "events_url": "https://api.github.com/users/huangyg11/events{/privacy}",
      "received_events_url": "https://api.github.com/users/huangyg11/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-01-28T12:04:46Z",
    "updated_at": "2019-01-28T12:04:46Z",
    "author_association": "NONE",
    "body": "Unfortunately, I have synced the node to the latest block last night. And invoke copydb again, it works normally this time. Can't reproduce it with the chaindata dir changed.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/458106331/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/467351358",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/18525#issuecomment-467351358",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18525",
    "id": 467351358,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ2NzM1MTM1OA==",
    "user": {
      "login": "huangyg11",
      "id": 5545682,
      "node_id": "MDQ6VXNlcjU1NDU2ODI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5545682?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/huangyg11",
      "html_url": "https://github.com/huangyg11",
      "followers_url": "https://api.github.com/users/huangyg11/followers",
      "following_url": "https://api.github.com/users/huangyg11/following{/other_user}",
      "gists_url": "https://api.github.com/users/huangyg11/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/huangyg11/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/huangyg11/subscriptions",
      "organizations_url": "https://api.github.com/users/huangyg11/orgs",
      "repos_url": "https://api.github.com/users/huangyg11/repos",
      "events_url": "https://api.github.com/users/huangyg11/events{/privacy}",
      "received_events_url": "https://api.github.com/users/huangyg11/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-02-26T08:51:00Z",
    "updated_at": "2019-02-26T08:51:00Z",
    "author_association": "NONE",
    "body": "The problem appeared again.\r\n\r\n`geth --datadir=/data/new --maxpeers 0 --nodiscover console`\r\n\r\n> INFO [02-26|16:40:17.157] Maximum peer count                       ETH=0 LES=0 total=0\r\n> INFO [02-26|16:40:17.158] Starting peer-to-peer node               instance=Geth/v1.8.23-stable-c9427004/linux-amd64/go1.10.4\r\n> INFO [02-26|16:40:17.158] Allocated cache and file handles         database=/data/new/geth/chaindata cache=512 handles=32767\r\n> INFO [02-26|16:40:18.182] Initialised chain configuration          config=\"{ChainID: 1 Homestead: 1150000 DAO: 1920000 DAOSupport: true EIP150: 2463000 EIP155: 2675000 EIP158: 2675000 Byzantium: 4370000 Constantinople: 7280000  ConstantinopleFix: 7280000 Engine: ethash}\"\r\n> INFO [02-26|16:40:18.182] Disk storage enabled for ethash caches   dir=/data/new/geth/ethash count=3\r\n> INFO [02-26|16:40:18.182] Disk storage enabled for ethash DAGs     dir=/root/.ethash         count=2\r\n> INFO [02-26|16:40:18.182] Initialising Ethereum protocol           versions=\"[63 62]\" network=1\r\n> WARN [02-26|16:40:18.235] Head state missing, repairing chain      number=7264790 hash=dbcb9d…12762f\r\n> INFO [02-26|16:40:18.235] Rewound blockchain to past state         number=7264789 hash=da3b77…360516\r\n> INFO [02-26|16:40:18.235] Loaded most recent local header          number=7264790 hash=dbcb9d…12762f td=9249857915655605657403 age=1d2h39m\r\n> INFO [02-26|16:40:18.235] Loaded most recent local full block      number=7264789 hash=da3b77…360516 td=9249854846983481846690 age=1d2h40m\r\n> INFO [02-26|16:40:18.235] Loaded most recent local fast block      number=7264790 hash=dbcb9d…12762f td=9249857915655605657403 age=1d2h39m\r\n> INFO [02-26|16:40:18.236] Loaded local transaction journal         transactions=0 dropped=0\r\n> INFO [02-26|16:40:18.236] Regenerated local transaction journal    transactions=0 accounts=0\r\n> WARN [02-26|16:40:18.236] Blockchain not empty, fast sync disabled\r\n> INFO [02-26|16:40:18.250] New local node record                    seq=3 id=f92b899c67eb3fe3 ip=127.0.0.1 udp=0 tcp=30303\r\n> INFO [02-26|16:40:18.250] Started P2P networking                   \r\n> INFO [02-26|16:40:18.251] IPC endpoint opened                      url=/data/new/geth.ipc\r\n\r\nit says head state missing(7264790) and rewound to past state(7264789), but it seems not persist the rewounding result. So if i exit and run again, it output the same result(missing 7264790 and rewounding to 7264789  again).\r\n\r\nIf I run copy db in this state, the copydb think the local peer head is 7264790, and try to get the state(7264790) which is missing, triggering the nil exception\r\n\r\n\r\n`geth --datadir=/data/new2 --verbosity=5  copydb --cache=1024 /data/new/geth/chaindata/`\r\n\r\n> DEBUG[02-26|16:44:22.691] Sanitizing Go's GC trigger               percent=100\r\n> INFO [02-26|16:44:22.692] Maximum peer count                       ETH=25 LES=0 total=25\r\n> DEBUG[02-26|16:44:22.692] FS scan times                            list=38.963µs set=849ns diff=1.084µs\r\n> TRACE[02-26|16:44:22.692] Started watching keystore folder         path=/data/new2/keystore\r\n> INFO [02-26|16:44:22.693] Allocated cache and file handles         database=/data/new2/geth/chaindata cache=512 handles=32767\r\n> INFO [02-26|16:44:22.707] Disk storage enabled for ethash caches   dir=/data/new2/geth/ethash count=3\r\n> INFO [02-26|16:44:22.707] Disk storage enabled for ethash DAGs     dir=/root/.ethash          count=2\r\n> INFO [02-26|16:44:22.770] Loaded most recent local header          number=0 hash=d4e567…cb8fa3 td=17179869184 age=49y10mo1w\r\n> INFO [02-26|16:44:22.770] Loaded most recent local full block      number=0 hash=d4e567…cb8fa3 td=17179869184 age=49y10mo1w\r\n> INFO [02-26|16:44:22.770] Loaded most recent local fast block      number=0 hash=d4e567…cb8fa3 td=17179869184 age=49y10mo1w\r\n> INFO [02-26|16:44:22.770] Allocated cache and file handles         database=/data/new/geth/chaindata/ cache=1024 handles=256\r\n> DEBUG[02-26|16:44:22.770] Recalculated downloader QoS values       rtt=20s confidence=1.000 ttl=1m0s\r\n> TRACE[02-26|16:44:23.721] Registering sync peer                    peer=local\r\n> INFO [02-26|16:44:23.721] Block synchronisation started\r\n> DEBUG[02-26|16:44:23.721] Synchronising with the network           peer=local eth=63 head=dbcb9d…12762f td=9249857915655605657403 mode=fast\r\n> DEBUG[02-26|16:44:23.721] Retrieving remote chain height           peer=local\r\n> DEBUG[02-26|16:44:23.721] Remote head header identified            peer=local number=7264790 hash=dbcb9d…12762f\r\n> DEBUG[02-26|16:44:23.721] Looking for common ancestor              peer=local local=0 remote=7264790\r\n> TRACE[02-26|16:44:23.721] Span searching for common ancestor       peer=local count=12 from=7264613 skip=15\r\n> TRACE[02-26|16:44:23.722] Binary searching for common ancestor     peer=local start=0 end=7264790\r\n> DEBUG[02-26|16:44:23.725] Found common ancestor                    peer=local number=0       hash=000000…000000\r\n> DEBUG[02-26|16:44:23.725] Downloading block bodies                 origin=1\r\n> DEBUG[02-26|16:44:23.725] Downloading transaction receipts         origin=1\r\n> TRACE[02-26|16:44:23.725] Requesting new batch of data             peer=local type=state count=1\r\n> DEBUG[02-26|16:44:23.725] Directing header downloads               peer=local origin=1\r\n> TRACE[02-26|16:44:23.725] Received node data response              peer=local count=0  dropped=false timeout=true\r\n> WARN [02-26|16:44:23.726] Stalling state sync, dropping peer       peer=local\r\n> panic: runtime error: invalid memory address or nil pointer dereference\r\n> [signal SIGSEGV: segmentation violation code=0x1 addr=0x0 pc=0xa53b07]\r\n> \r\n> goroutine 40 [running]:\r\n> github.com/ethereum/go-ethereum/eth/downloader.(*stateSync).loop(0xc420316c40, 0x0, 0x0)\r\n>         /build/ethereum-fWxIHg/ethereum-1.8.23+build17682+xenial/build/_workspace/src/github.com/ethereum/go-ethereum/eth/downloader/statesync.go:313 +0x627\r\n> github.com/ethereum/go-ethereum/eth/downloader.(*stateSync).run(0xc420316c40)\r\n>         /build/ethereum-fWxIHg/ethereum-1.8.23+build17682+xenial/build/_workspace/src/github.com/ethereum/go-ethereum/eth/downloader/statesync.go:255 +0x2b\r\n> created by github.com/ethereum/go-ethereum/eth/downloader.(*Downloader).runStateSync\r\n>         /build/ethereum-fWxIHg/ethereum-1.8.23+build17682+xenial/build/_workspace/src/github.com/ethereum/go-ethereum/eth/downloader/statesync.go:106 +0x10c",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/467351358/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/467375744",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/18525#issuecomment-467375744",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18525",
    "id": 467375744,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ2NzM3NTc0NA==",
    "user": {
      "login": "huangyg11",
      "id": 5545682,
      "node_id": "MDQ6VXNlcjU1NDU2ODI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5545682?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/huangyg11",
      "html_url": "https://github.com/huangyg11",
      "followers_url": "https://api.github.com/users/huangyg11/followers",
      "following_url": "https://api.github.com/users/huangyg11/following{/other_user}",
      "gists_url": "https://api.github.com/users/huangyg11/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/huangyg11/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/huangyg11/subscriptions",
      "organizations_url": "https://api.github.com/users/huangyg11/orgs",
      "repos_url": "https://api.github.com/users/huangyg11/repos",
      "events_url": "https://api.github.com/users/huangyg11/events{/privacy}",
      "received_events_url": "https://api.github.com/users/huangyg11/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-02-26T10:01:22Z",
    "updated_at": "2019-02-26T10:01:22Z",
    "author_association": "NONE",
    "body": "my workround is tweak Head() in fakepeer.go to return fix header ( given by cmd arg ). \r\n\r\n`geth --datadir=/data/new2  copydb --cache=1024 /data/new/geth/chaindata/ 7264789`  works",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/467375744/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
