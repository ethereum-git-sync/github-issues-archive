{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/27300",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/27300/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/27300/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/27300/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/27300",
  "id": 1715762915,
  "node_id": "I_kwDOAOvK985mRHbj",
  "number": 27300,
  "title": "Missing Trie Node errors during upgrade from 1.11.5 to 1.11.6",
  "user": {
    "login": "quickchase",
    "id": 87909910,
    "node_id": "MDQ6VXNlcjg3OTA5OTEw",
    "avatar_url": "https://avatars.githubusercontent.com/u/87909910?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/quickchase",
    "html_url": "https://github.com/quickchase",
    "followers_url": "https://api.github.com/users/quickchase/followers",
    "following_url": "https://api.github.com/users/quickchase/following{/other_user}",
    "gists_url": "https://api.github.com/users/quickchase/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/quickchase/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/quickchase/subscriptions",
    "organizations_url": "https://api.github.com/users/quickchase/orgs",
    "repos_url": "https://api.github.com/users/quickchase/repos",
    "events_url": "https://api.github.com/users/quickchase/events{/privacy}",
    "received_events_url": "https://api.github.com/users/quickchase/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 72233650,
      "node_id": "MDU6TGFiZWw3MjIzMzY1MA==",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/type:bug",
      "name": "type:bug",
      "color": "FF5E5E",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2023-05-18T14:41:43Z",
  "updated_at": "2023-05-18T16:13:29Z",
  "closed_at": "2023-05-18T16:13:29Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "We have observed that during upgrades from 1.11.5 to 1.11.6 the nodes seem to incur some sort of state gap where, after they are restarted on the new version, they will start to throw `missing trie node` errors for requests to recent, but not latest, block numbers (i.e. 50-70 blocks behind the tip).\r\n\r\nI have never before experienced this issue when upgrading geth nodes, but during the rollout of the update for Goerli, Sepolia, and Mainnet we have seen this behavior for 1.11.6 across many many nodes in our infrastructure.\r\n\r\nThe nodes are still leveldb, if that helps.",
  "closed_by": {
    "login": "quickchase",
    "id": 87909910,
    "node_id": "MDQ6VXNlcjg3OTA5OTEw",
    "avatar_url": "https://avatars.githubusercontent.com/u/87909910?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/quickchase",
    "html_url": "https://github.com/quickchase",
    "followers_url": "https://api.github.com/users/quickchase/followers",
    "following_url": "https://api.github.com/users/quickchase/following{/other_user}",
    "gists_url": "https://api.github.com/users/quickchase/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/quickchase/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/quickchase/subscriptions",
    "organizations_url": "https://api.github.com/users/quickchase/orgs",
    "repos_url": "https://api.github.com/users/quickchase/repos",
    "events_url": "https://api.github.com/users/quickchase/events{/privacy}",
    "received_events_url": "https://api.github.com/users/quickchase/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/27300/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/27300/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1553263932",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/27300#issuecomment-1553263932",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/27300",
    "id": 1553263932,
    "node_id": "IC_kwDOAOvK985clO08",
    "user": {
      "login": "karalabe",
      "id": 129561,
      "node_id": "MDQ6VXNlcjEyOTU2MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/karalabe",
      "html_url": "https://github.com/karalabe",
      "followers_url": "https://api.github.com/users/karalabe/followers",
      "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
      "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
      "organizations_url": "https://api.github.com/users/karalabe/orgs",
      "repos_url": "https://api.github.com/users/karalabe/repos",
      "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
      "received_events_url": "https://api.github.com/users/karalabe/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-18T15:52:43Z",
    "updated_at": "2023-05-18T15:52:43Z",
    "author_association": "MEMBER",
    "body": "Hmmm, I'm unsure if this is an issue.\r\n\r\nGeth keeps trie nodes for the latest 128 blocks in RAM. On shutdown, three states are flushed (HEAD, HEAD-1 and HEAD-128), the rest discarded. On startup, you will as such not have the states for anything else apart from these 3. Then you start applying blocks on top, and will gradually end up having state for everything once you process 128 blocks.\r\n\r\nIf your update/restart lasts less than the time it takes to produce 128 blocks, then upon restart you will run the new blocks (say 80) leading to have the state for those, but for 80->128, you will have gaps until another 48 blocks are produced by the network.\r\n\r\nIs this perhaps what you are seeing?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1553263932/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1553291285",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/27300#issuecomment-1553291285",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/27300",
    "id": 1553291285,
    "node_id": "IC_kwDOAOvK985clVgV",
    "user": {
      "login": "quickchase",
      "id": 87909910,
      "node_id": "MDQ6VXNlcjg3OTA5OTEw",
      "avatar_url": "https://avatars.githubusercontent.com/u/87909910?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/quickchase",
      "html_url": "https://github.com/quickchase",
      "followers_url": "https://api.github.com/users/quickchase/followers",
      "following_url": "https://api.github.com/users/quickchase/following{/other_user}",
      "gists_url": "https://api.github.com/users/quickchase/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/quickchase/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/quickchase/subscriptions",
      "organizations_url": "https://api.github.com/users/quickchase/orgs",
      "repos_url": "https://api.github.com/users/quickchase/repos",
      "events_url": "https://api.github.com/users/quickchase/events{/privacy}",
      "received_events_url": "https://api.github.com/users/quickchase/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-18T16:13:29Z",
    "updated_at": "2023-05-18T16:13:29Z",
    "author_association": "NONE",
    "body": "Yeah, that sounds like it might be the problem we are facing here. Will have to think of a way to not serve traffic for ~128 blocks after startup.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1553291285/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
