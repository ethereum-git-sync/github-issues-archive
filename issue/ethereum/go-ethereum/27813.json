{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/27813",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/27813/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/27813/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/27813/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/27813",
  "id": 1828155462,
  "node_id": "I_kwDOAOvK985s93BG",
  "number": 27813,
  "title": "panic: pebble: batch too large: >= 4.0 G",
  "user": {
    "login": "muyinliu",
    "id": 3318872,
    "node_id": "MDQ6VXNlcjMzMTg4NzI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3318872?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/muyinliu",
    "html_url": "https://github.com/muyinliu",
    "followers_url": "https://api.github.com/users/muyinliu/followers",
    "following_url": "https://api.github.com/users/muyinliu/following{/other_user}",
    "gists_url": "https://api.github.com/users/muyinliu/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/muyinliu/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/muyinliu/subscriptions",
    "organizations_url": "https://api.github.com/users/muyinliu/orgs",
    "repos_url": "https://api.github.com/users/muyinliu/repos",
    "events_url": "https://api.github.com/users/muyinliu/events{/privacy}",
    "received_events_url": "https://api.github.com/users/muyinliu/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 72233650,
      "node_id": "MDU6TGFiZWw3MjIzMzY1MA==",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/type:bug",
      "name": "type:bug",
      "color": "FF5E5E",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2023-07-31T00:40:26Z",
  "updated_at": "2023-07-31T05:08:01Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "#### System information\r\n\r\nGeth version: 1.12.0-stable(build from source https://github.com/ethereum/go-ethereum/archive/refs/tags/v1.12.0.tar.gz with go1.19.11 linux/amd64)\r\nCL client & version: Prysm/v4.0.5/aa7d0df7ff5f74168bdaf93453c856f279ec1573. Built at: 2023-05-22 18:10:34+00:00\r\nOS & Version: Linux(Ubuntu 22.04.2 LTS)\r\n\r\n#### Expected behaviour\r\n\r\ninitial sync success\r\n\r\n#### Actual behaviour\r\n\r\nsync failed with error message: `panic: pebble: batch too large: >= 4.0 G`\r\n\r\n#### Steps to reproduce the behaviour\r\n\r\n```shell\r\n/usr/local/bin/geth --datadir /mnt/data/geth-ethereum --port 34303 --discovery.port 34303 --maxpeers 100 --cache 16000 --http --http.api eth,net,web3,admin,debug,txpool,personal --http.port 8445 --ws --ws.api eth,net,web3,admin,debug,txpool,personal --ws.port 8446 --authrpc.port 8451 --syncmode snap\r\n```\r\n\r\n#### Backtrace\r\n\r\n````\r\npanic: pebble: batch too large: >= 4.0 G\r\n\r\ngoroutine 651770 [running]:\r\ngithub.com/cockroachdb/pebble.(*Batch).grow(0x35dd1b567ceceea6?, 0xe344c46ded795670?)\r\n\tgithub.com/cockroachdb/pebble@v0.0.0-20230209160836-829675f94811/batch.go:1183 +0x129\r\ngithub.com/cockroachdb/pebble.(*Batch).prepareDeferredKeyValueRecord(0xc006adac80, 0x20, 0x25, 0x1)\r\n\tgithub.com/cockroachdb/pebble@v0.0.0-20230209160836-829675f94811/batch.go:480 +0x8d\r\ngithub.com/cockroachdb/pebble.(*Batch).SetDeferred(...)\r\n\tgithub.com/cockroachdb/pebble@v0.0.0-20230209160836-829675f94811/batch.go:576\r\ngithub.com/cockroachdb/pebble.(*Batch).Set(0xc006adac80?, {0xc024129240?, 0x20?, 0x59a200?}, {0xc01088c000?, 0x25?, 0x1c?}, 0x1c?)\r\n\tgithub.com/cockroachdb/pebble@v0.0.0-20230209160836-829675f94811/batch.go:558 +0x45\r\ngithub.com/ethereum/go-ethereum/ethdb/pebble.(*batch).Put(0xc00bdac678, {0xc024129240?, 0x20, 0xc01088c000?}, {0xc01088c000?, 0x25, 0x2060e20?})\r\n\tgithub.com/ethereum/go-ethereum/ethdb/pebble/pebble.go:514 +0x3b\r\ngithub.com/ethereum/go-ethereum/ethdb.HookedBatch.Put({{0x206a9a0?, 0xc00bdac678?}, 0xc04404bec0?, 0x0?}, {0xc024129240?, 0x20?, 0x20?}, {0xc01088c000, 0x25, 0x4000})\r\n\tgithub.com/ethereum/go-ethereum/ethdb/batch.go:65 +0xc6\r\ngithub.com/ethereum/go-ethereum/core/rawdb.WriteLegacyTrieNode({0x2060e20, 0xc01232dea0}, {0xb4, 0xfa, 0xde, 0x28, 0x9d, 0xbd, 0xa7, 0x67, ...}, ...)\r\n\tgithub.com/ethereum/go-ethereum/core/rawdb/accessors_trie.go:160 +0x99\r\ngithub.com/ethereum/go-ethereum/core/rawdb.WriteTrieNode({0x2060e20?, 0xc01232dea0?}, {0x15, 0x9e, 0x48, 0x90, 0xcd, 0xe4, 0x6d, 0x5c, ...}, ...)\r\n\tgithub.com/ethereum/go-ethereum/core/rawdb/accessors_trie.go:230 +0xa5\r\ngithub.com/ethereum/go-ethereum/eth/protocols/snap.(*Syncer).loadSyncStatus.func4({0x15, 0x9e, 0x48, 0x90, 0xcd, 0xe4, 0x6d, 0x5c, 0xad, 0xbf, ...}, ...)\r\n\tgithub.com/ethereum/go-ethereum/eth/protocols/snap/sync.go:752 +0x112\r\ngithub.com/ethereum/go-ethereum/trie.(*StackTrie).hashRec(0xc04fbf21c0, 0xc03f1fa960, {0xc02c1e17d8, 0x8, 0x8})\r\n\tgithub.com/ethereum/go-ethereum/trie/stacktrie.go:483 +0x725\r\ngithub.com/ethereum/go-ethereum/trie.(*StackTrie).hashRec(0xc04fbf28c0, 0xc03f1fa960, {0xc02c1e17d8, 0x7, 0x8})\r\n\tgithub.com/ethereum/go-ethereum/trie/stacktrie.go:429 +0x7f0\r\ngithub.com/ethereum/go-ethereum/trie.(*StackTrie).hash(0xc02c1e17d0?, {0xc02c1e17d8, 0x7, 0x8})\r\n\tgithub.com/ethereum/go-ethereum/trie/stacktrie.go:405 +0x99\r\ngithub.com/ethereum/go-ethereum/trie.(*StackTrie).insert(0xc04fbf2c40, {0xc011ef8c36, 0x3a, 0x3b}, {0xc006d54f48, 0x15, 0x15}, {0xc02c1e17d8, 0x6, 0x8})\r\n\tgithub.com/ethereum/go-ethereum/trie/stacktrie.go:257 +0xd25\r\ngithub.com/ethereum/go-ethereum/trie.(*StackTrie).insert(0xc04fbf2a80, {0xc011ef8c35, 0x3b, 0x3c}, {0xc006d54f48, 0x15, 0x15}, {0xc02c1e17d8, 0x5, 0x8})\r\n\tgithub.com/ethereum/go-ethereum/trie/stacktrie.go:267 +0xe6f\r\ngithub.com/ethereum/go-ethereum/trie.(*StackTrie).insert(0xc03f121340, {0xc011ef8c34, 0x3c, 0x3d}, {0xc006d54f48, 0x15, 0x15}, {0xc02c1e17d8, 0x4, 0x8})\r\n\tgithub.com/ethereum/go-ethereum/trie/stacktrie.go:267 +0xe6f\r\ngithub.com/ethereum/go-ethereum/trie.(*StackTrie).insert(0xc04b3c47e0, {0xc011ef8c33, 0x3d, 0x3e}, {0xc006d54f48, 0x15, 0x15}, {0xc02c1e17d8, 0x3, 0x8})\r\n\tgithub.com/ethereum/go-ethereum/trie/stacktrie.go:267 +0xe6f\r\ngithub.com/ethereum/go-ethereum/trie.(*StackTrie).insert(0xc04a3a6540, {0xc011ef8c32, 0x3e, 0x3f}, {0xc006d54f48, 0x15, 0x15}, {0xc02c1e17d8, 0x2, 0x8})\r\n\tgithub.com/ethereum/go-ethereum/trie/stacktrie.go:267 +0xe6f\r\ngithub.com/ethereum/go-ethereum/trie.(*StackTrie).insert(0xc04034fc00, {0xc011ef8c31, 0x3f, 0x40}, {0xc006d54f48, 0x15, 0x15}, {0xc02c1e17d8, 0x1, 0x8})\r\n\tgithub.com/ethereum/go-ethereum/trie/stacktrie.go:267 +0xe6f\r\ngithub.com/ethereum/go-ethereum/trie.(*StackTrie).insert(0xc0108ddce0, {0xc011ef8c30, 0x40, 0x41}, {0xc006d54f48, 0x15, 0x15}, {0x0, 0x0, 0x0})\r\n\tgithub.com/ethereum/go-ethereum/trie/stacktrie.go:282 +0x72e\r\ngithub.com/ethereum/go-ethereum/trie.(*StackTrie).Update(0x5c6de4cd90489e15?, {0xc036210da0, 0x20, 0x12ae5ed03e74cc10?}, {0xc006d54f48, 0x15, 0x15})\r\n\tgithub.com/ethereum/go-ethereum/trie/stacktrie.go:211 +0x11d\r\ngithub.com/ethereum/go-ethereum/eth/protocols/snap.(*Syncer).processStorageResponse(0xc000240900, 0xc0170c4500)\r\n\tgithub.com/ethereum/go-ethereum/eth/protocols/snap/sync.go:2089 +0x1499\r\ngithub.com/ethereum/go-ethereum/eth/protocols/snap.(*Syncer).Sync(0xc000240900, {0x46, 0xa6, 0xa0, 0x1e, 0x70, 0x84, 0xa2, 0x4c, 0x97, ...}, ...)\r\n\tgithub.com/ethereum/go-ethereum/eth/protocols/snap/sync.go:709 +0xe5f\r\ngithub.com/ethereum/go-ethereum/eth/downloader.(*stateSync).run(0xc016120a80)\r\n\tgithub.com/ethereum/go-ethereum/eth/downloader/statesync.go:107 +0x66\r\ncreated by github.com/ethereum/go-ethereum/eth/downloader.(*Downloader).runStateSync\r\n\tgithub.com/ethereum/go-ethereum/eth/downloader/statesync.go:63 +0x12a\r\n\r\nINFO [07-30|23:30:51.790] Starting Geth on Ethereum mainnet... \r\nINFO [07-30|23:30:51.793] Maximum peer count                       ETH=100 LES=0 total=100\r\nINFO [07-30|23:30:51.794] Smartcard socket not found, disabling    err=\"stat /run/pcscd/pcscd.comm: no such file or directory\"\r\nINFO [07-30|23:30:51.799] Set global gas cap                       cap=50,000,000\r\nINFO [07-30|23:30:51.799] Initializing the KZG library             backend=gokzg\r\nINFO [07-30|23:30:51.821] Allocated trie memory caches             clean=2.34GiB dirty=3.91GiB\r\nINFO [07-30|23:30:51.829] Using pebble as the backing database \r\nINFO [07-30|23:30:51.829] Allocated cache and file handles         database=/mnt/data/geth-ethereum/geth/chaindata cache=7.81GiB handles=262,144\r\nFatal: Failed to register the Ethereum service: pebble: inconsistent batch count: 458287021 vs 501152459\r\nINFO [07-30|23:30:52.975] Starting Geth on Ethereum mainnet... \r\nINFO [07-30|23:30:52.979] Maximum peer count                       ETH=100 LES=0 total=100\r\nINFO [07-30|23:30:52.979] Smartcard socket not found, disabling    err=\"stat /run/pcscd/pcscd.comm: no such file or directory\"\r\nINFO [07-30|23:30:52.981] Set global gas cap                       cap=50,000,000\r\nINFO [07-30|23:30:52.981] Initializing the KZG library             backend=gokzg\r\nINFO [07-30|23:30:52.999] Allocated trie memory caches             clean=2.34GiB dirty=3.91GiB\r\nINFO [07-30|23:30:53.006] Using pebble as the backing database \r\nINFO [07-30|23:30:53.007] Allocated cache and file handles         database=/mnt/data/geth-ethereum/geth/chaindata cache=7.81GiB handles=262,144\r\nFatal: Failed to register the Ethereum service: pebble: inconsistent batch count: 458287021 vs 501152459\r\n````\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/27813/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/27813/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1657607918",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/27813#issuecomment-1657607918",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/27813",
    "id": 1657607918,
    "node_id": "IC_kwDOAOvK985izRbu",
    "user": {
      "login": "karalabe",
      "id": 129561,
      "node_id": "MDQ6VXNlcjEyOTU2MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/karalabe",
      "html_url": "https://github.com/karalabe",
      "followers_url": "https://api.github.com/users/karalabe/followers",
      "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
      "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
      "organizations_url": "https://api.github.com/users/karalabe/orgs",
      "repos_url": "https://api.github.com/users/karalabe/repos",
      "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
      "received_events_url": "https://api.github.com/users/karalabe/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-31T05:08:01Z",
    "updated_at": "2023-07-31T05:08:01Z",
    "author_association": "MEMBER",
    "body": "Do you have some logs from before the crash? I'm curious how fast you're downloading data (state specifically) that you managed to hit such an error.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1657607918/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
