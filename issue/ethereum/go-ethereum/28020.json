{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28020",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28020/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28020/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28020/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/28020",
  "id": 1869340407,
  "node_id": "I_kwDOAOvK985va973",
  "number": 28020,
  "title": "Question about rewinding blockchain head block",
  "user": {
    "login": "nothingmin",
    "id": 67548026,
    "node_id": "MDQ6VXNlcjY3NTQ4MDI2",
    "avatar_url": "https://avatars.githubusercontent.com/u/67548026?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/nothingmin",
    "html_url": "https://github.com/nothingmin",
    "followers_url": "https://api.github.com/users/nothingmin/followers",
    "following_url": "https://api.github.com/users/nothingmin/following{/other_user}",
    "gists_url": "https://api.github.com/users/nothingmin/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/nothingmin/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/nothingmin/subscriptions",
    "organizations_url": "https://api.github.com/users/nothingmin/orgs",
    "repos_url": "https://api.github.com/users/nothingmin/repos",
    "events_url": "https://api.github.com/users/nothingmin/events{/privacy}",
    "received_events_url": "https://api.github.com/users/nothingmin/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 268304226,
      "node_id": "MDU6TGFiZWwyNjgzMDQyMjY=",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/type:docs",
      "name": "type:docs",
      "color": "fef2c0",
      "default": false,
      "description": null
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2023-08-28T09:07:51Z",
  "updated_at": "2023-08-29T03:30:52Z",
  "closed_at": "2023-08-29T02:57:58Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "On geth startup, geth rewind the blockchain until geth finds t**he head block that has corresponding state**.\r\n\r\n```\r\n// Rewind the fast block in a simpleton way to the target head\r\nif currentSnapBlock := bc.CurrentSnapBlock(); currentSnapBlock != nil && header.Number.Uint64() < currentSnapBlock.Number.Uint64() {\r\n\tnewHeadSnapBlock := bc.GetBlock(header.Hash(), header.Number.Uint64())\r\n\t// If either blocks reached nil, reset to the genesis state\r\n\tif newHeadSnapBlock == nil {\r\n\t\tnewHeadSnapBlock = bc.genesisBlock\r\n\t}\r\n\trawdb.WriteHeadFastBlockHash(db, newHeadSnapBlock.Hash())\r\n\r\n\t// Degrade the chain markers if they are explicitly reverted.\r\n\t// In theory we should update all in-memory markers in the\r\n\t// last step, however the direction of SetHead is from high\r\n\t// to low, so it's safe the update in-memory markers directly.\r\n\tbc.currentSnapBlock.Store(newHeadSnapBlock.Header())\r\n\theadFastBlockGauge.Update(int64(newHeadSnapBlock.NumberU64()))\r\n}\r\n```\r\n\r\nSo I thought that currentSnapBlock (which used in snapshot-sync) should be rewound too like head block does.\r\nHowever, geth **does not rewind currentSnapBlock**.\r\nI'm wondering why geth does not rewound the currentSnapBlock.\r\n\r\n",
  "closed_by": {
    "login": "rjl493456442",
    "id": 5959481,
    "node_id": "MDQ6VXNlcjU5NTk0ODE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5959481?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/rjl493456442",
    "html_url": "https://github.com/rjl493456442",
    "followers_url": "https://api.github.com/users/rjl493456442/followers",
    "following_url": "https://api.github.com/users/rjl493456442/following{/other_user}",
    "gists_url": "https://api.github.com/users/rjl493456442/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/rjl493456442/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rjl493456442/subscriptions",
    "organizations_url": "https://api.github.com/users/rjl493456442/orgs",
    "repos_url": "https://api.github.com/users/rjl493456442/repos",
    "events_url": "https://api.github.com/users/rjl493456442/events{/privacy}",
    "received_events_url": "https://api.github.com/users/rjl493456442/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28020/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28020/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1696694963",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/28020#issuecomment-1696694963",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28020",
    "id": 1696694963,
    "node_id": "IC_kwDOAOvK985lIYKz",
    "user": {
      "login": "rjl493456442",
      "id": 5959481,
      "node_id": "MDQ6VXNlcjU5NTk0ODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5959481?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rjl493456442",
      "html_url": "https://github.com/rjl493456442",
      "followers_url": "https://api.github.com/users/rjl493456442/followers",
      "following_url": "https://api.github.com/users/rjl493456442/following{/other_user}",
      "gists_url": "https://api.github.com/users/rjl493456442/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rjl493456442/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rjl493456442/subscriptions",
      "organizations_url": "https://api.github.com/users/rjl493456442/orgs",
      "repos_url": "https://api.github.com/users/rjl493456442/repos",
      "events_url": "https://api.github.com/users/rjl493456442/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rjl493456442/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-08-29T02:57:58Z",
    "updated_at": "2023-08-29T02:57:58Z",
    "author_association": "MEMBER",
    "body": "The term \"currentSnapBlock\" refers to a specific block within the chain, complete with various components like associated receipts. However, it's important to note that the presence of the \"currentSnapBlock\" doesn't necessarily imply the existence of the corresponding state.\r\n\r\nThe objective of chain rewinding is to locate a block in the chain that possesses an associated state that is present. Once such a block is identified, the rewinding procedure retags that block as \"HEAD BLOCK\". This action effectively rewinds the state of the chain to a prior point.\r\n\r\nIt's worth highlighting that during this rewinding process, the segments of the chain above the \"HEAD BLOCK\" are retained. As a result, there is no reason to change the \"HEAD SNAP BLOCK\" flag.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1696694963/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1696702366",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/28020#issuecomment-1696702366",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28020",
    "id": 1696702366,
    "node_id": "IC_kwDOAOvK985lIZ-e",
    "user": {
      "login": "nothingmin",
      "id": 67548026,
      "node_id": "MDQ6VXNlcjY3NTQ4MDI2",
      "avatar_url": "https://avatars.githubusercontent.com/u/67548026?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nothingmin",
      "html_url": "https://github.com/nothingmin",
      "followers_url": "https://api.github.com/users/nothingmin/followers",
      "following_url": "https://api.github.com/users/nothingmin/following{/other_user}",
      "gists_url": "https://api.github.com/users/nothingmin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nothingmin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nothingmin/subscriptions",
      "organizations_url": "https://api.github.com/users/nothingmin/orgs",
      "repos_url": "https://api.github.com/users/nothingmin/repos",
      "events_url": "https://api.github.com/users/nothingmin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nothingmin/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-08-29T03:09:30Z",
    "updated_at": "2023-08-29T03:09:30Z",
    "author_association": "NONE",
    "body": "To double check, if \"currentSnapBlock\" is set to specific block you already have components like transactions, block and receipts. Is that mean you can regenerate state for the height?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1696702366/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1696707806",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/28020#issuecomment-1696707806",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28020",
    "id": 1696707806,
    "node_id": "IC_kwDOAOvK985lIbTe",
    "user": {
      "login": "rjl493456442",
      "id": 5959481,
      "node_id": "MDQ6VXNlcjU5NTk0ODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5959481?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rjl493456442",
      "html_url": "https://github.com/rjl493456442",
      "followers_url": "https://api.github.com/users/rjl493456442/followers",
      "following_url": "https://api.github.com/users/rjl493456442/following{/other_user}",
      "gists_url": "https://api.github.com/users/rjl493456442/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rjl493456442/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rjl493456442/subscriptions",
      "organizations_url": "https://api.github.com/users/rjl493456442/orgs",
      "repos_url": "https://api.github.com/users/rjl493456442/repos",
      "events_url": "https://api.github.com/users/rjl493456442/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rjl493456442/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-08-29T03:18:31Z",
    "updated_at": "2023-08-29T03:18:31Z",
    "author_association": "MEMBER",
    "body": "> Is that mean you can regenerate state for the height?\r\n\r\nTheoretically yes, you can rewind the chain to *below* this height and re-execute the blocks afterwards, so that you will get the state.\r\n\r\nIn practice, the cost for regenerating the state for a specific block is very high. Archive node is recommended in case the state availability is expected.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1696707806/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1696714925",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/28020#issuecomment-1696714925",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28020",
    "id": 1696714925,
    "node_id": "IC_kwDOAOvK985lIdCt",
    "user": {
      "login": "nothingmin",
      "id": 67548026,
      "node_id": "MDQ6VXNlcjY3NTQ4MDI2",
      "avatar_url": "https://avatars.githubusercontent.com/u/67548026?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nothingmin",
      "html_url": "https://github.com/nothingmin",
      "followers_url": "https://api.github.com/users/nothingmin/followers",
      "following_url": "https://api.github.com/users/nothingmin/following{/other_user}",
      "gists_url": "https://api.github.com/users/nothingmin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nothingmin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nothingmin/subscriptions",
      "organizations_url": "https://api.github.com/users/nothingmin/orgs",
      "repos_url": "https://api.github.com/users/nothingmin/repos",
      "events_url": "https://api.github.com/users/nothingmin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nothingmin/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-08-29T03:30:52Z",
    "updated_at": "2023-08-29T03:30:52Z",
    "author_association": "NONE",
    "body": "Beside Archive node, should I get sync from another node to get the latest state?\r\n\r\nActually, My problem happened in private network, one of my node can not sync from another nodes since its currentSnapBlock is same with another nodes(so that tdd is same with another nodes). \r\nIt was not a serious problem since It resolved when the other nodes generates block for higher height.\r\nI was just wondering whether is is intended or not\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1696714925/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
