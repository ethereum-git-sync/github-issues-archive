{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/26131",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/26131/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/26131/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/26131/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/26131",
  "id": 1439125310,
  "node_id": "I_kwDOAOvK985Vx08-",
  "number": 26131,
  "title": "Geth fails to shutdown in 90s, is killed by systemd",
  "user": {
    "login": "dankrad",
    "id": 6130607,
    "node_id": "MDQ6VXNlcjYxMzA2MDc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6130607?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/dankrad",
    "html_url": "https://github.com/dankrad",
    "followers_url": "https://api.github.com/users/dankrad/followers",
    "following_url": "https://api.github.com/users/dankrad/following{/other_user}",
    "gists_url": "https://api.github.com/users/dankrad/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/dankrad/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/dankrad/subscriptions",
    "organizations_url": "https://api.github.com/users/dankrad/orgs",
    "repos_url": "https://api.github.com/users/dankrad/repos",
    "events_url": "https://api.github.com/users/dankrad/events{/privacy}",
    "received_events_url": "https://api.github.com/users/dankrad/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 72233650,
      "node_id": "MDU6TGFiZWw3MjIzMzY1MA==",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/type:bug",
      "name": "type:bug",
      "color": "FF5E5E",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2022-11-07T23:03:16Z",
  "updated_at": "2023-01-04T09:44:30Z",
  "closed_at": null,
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "#### System information\r\n\r\nGeth version: 1.10.23\r\nCL client & version: lighthouse@3.1.0-aa022f4\r\nOS & Version: Linux (ubuntu 20.04)\r\n\r\n#### Expected behaviour\r\n\r\nShould shutdown within 90s and write snapshot\r\n\r\n#### Actual behaviour\r\n\r\nFrom the logs, it looks like it just \"forgot\" about the shutdown and started looking for peers again. It was killed after 90s by systemd, after which it detected an unclean shutdown and started re-syncing the last 10 days.\r\n\r\n#### Steps to reproduce the behaviour\r\n\r\n???\r\n\r\n#### Backtrace\r\n\r\n````\r\nNov 07 23:18:00 kettenbruch geth[22593]: INFO [11-07|23:18:00.595] Imported new potential chain segment     blocks=1  txs=124   mgas=12.250  elapsed=70.809ms     mgasps=173.005  number=15,921,081 hash=76ac75..9fef22 dirty=255.09MiB\r\nNov 07 23:18:00 kettenbruch geth[22593]: INFO [11-07|23:18:00.722] Chain head was updated                   number=15,921,081 hash=76ac75..9fef22 root=2fe12a..97ffd5 elapsed=9.338835ms\r\nNov 07 23:18:00 kettenbruch geth[22593]: INFO [11-07|23:18:00.726] Unindexed transactions                   blocks=1  txs=135   tail=13,571,082 elapsed=4.025ms\r\nNov 07 23:18:05 kettenbruch systemd[1]: Stopping geth.service...\r\nNov 07 23:18:06 kettenbruch geth[22593]: INFO [11-07|23:18:06.002] Got interrupt, shutting down...\r\nNov 07 23:18:06 kettenbruch geth[22593]: WARN [11-07|23:18:06.139] HTTP server graceful shutdown timed out\r\nNov 07 23:18:06 kettenbruch geth[22593]: INFO [11-07|23:18:06.139] HTTP server stopped                      endpoint=178.63.1.154:41314\r\nNov 07 23:18:06 kettenbruch geth[22593]: INFO [11-07|23:18:06.150] IPC endpoint closed                      url=/home/ethereum/ssd/geth-datadir/geth.ipc\r\nNov 07 23:18:16 kettenbruch geth[22593]: INFO [11-07|23:18:16.338] Looking for peers                        peercount=2  tried=149 static=0\r\nNov 07 23:18:26 kettenbruch geth[22593]: INFO [11-07|23:18:26.340] Looking for peers                        peercount=1  tried=170 static=0\r\nNov 07 23:18:32 kettenbruch geth[22593]: WARN [11-07|23:18:32.125] Beacon client online, but no consensus updates received in a while. Please fix your beacon client to follow the chain!\r\nNov 07 23:18:36 kettenbruch geth[22593]: INFO [11-07|23:18:36.393] Looking for peers                        peercount=2  tried=166 static=0\r\nNov 07 23:18:46 kettenbruch geth[22593]: INFO [11-07|23:18:46.622] Looking for peers                        peercount=2  tried=153 static=0\r\nNov 07 23:18:54 kettenbruch geth[22593]: WARN [11-07|23:18:54.333] Snapshot extension registration failed   peer=ef7c914b err=\"peer connected on snap without compatible eth support\"\r\nNov 07 23:18:56 kettenbruch geth[22593]: INFO [11-07|23:18:56.622] Looking for peers                        peercount=1  tried=125 static=0\r\nNov 07 23:19:06 kettenbruch geth[22593]: INFO [11-07|23:19:06.644] Looking for peers                        peercount=2  tried=170 static=0\r\nNov 07 23:19:14 kettenbruch geth[22593]: WARN [11-07|23:19:14.676] Snapshot extension registration failed   peer=43ba740c err=\"peer connected on snap without compatible eth support\"\r\nNov 07 23:19:16 kettenbruch geth[22593]: INFO [11-07|23:19:16.665] Looking for peers                        peercount=1  tried=136 static=0\r\nNov 07 23:19:24 kettenbruch geth[22593]: WARN [11-07|23:19:24.421] Snapshot extension registration failed   peer=43ba740c err=\"peer connected on snap without compatible eth support\"\r\nNov 07 23:19:26 kettenbruch geth[22593]: INFO [11-07|23:19:26.723] Looking for peers                        peercount=1  tried=95  static=0\r\nNov 07 23:19:29 kettenbruch geth[22593]: WARN [11-07|23:19:29.139] Snapshot extension registration failed   peer=ce89f279 err=\"peer connected on snap without compatible eth support\"\r\nNov 07 23:19:36 kettenbruch systemd[1]: geth.service: State 'stop-sigterm' timed out. Killing.\r\nNov 07 23:19:36 kettenbruch systemd[1]: geth.service: Killing process 22593 (geth) with signal SIGKILL.\r\nNov 07 23:19:36 kettenbruch systemd[1]: geth.service: Main process exited, code=killed, status=9/KILL\r\nNov 07 23:19:36 kettenbruch systemd[1]: geth.service: Failed with result 'timeout'.\r\nNov 07 23:19:36 kettenbruch systemd[1]: Stopped geth.service.\r\nNov 07 23:19:36 kettenbruch systemd[1]: Started geth.service.\r\n````\r\n\r\nWhen submitting logs: please submit them as text and not screenshots.\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/26131/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/26131/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1308389559",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/26131#issuecomment-1308389559",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/26131",
    "id": 1308389559,
    "node_id": "IC_kwDOAOvK985N_HC3",
    "user": {
      "login": "YurGa777",
      "id": 75600058,
      "node_id": "MDQ6VXNlcjc1NjAwMDU4",
      "avatar_url": "https://avatars.githubusercontent.com/u/75600058?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/YurGa777",
      "html_url": "https://github.com/YurGa777",
      "followers_url": "https://api.github.com/users/YurGa777/followers",
      "following_url": "https://api.github.com/users/YurGa777/following{/other_user}",
      "gists_url": "https://api.github.com/users/YurGa777/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/YurGa777/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/YurGa777/subscriptions",
      "organizations_url": "https://api.github.com/users/YurGa777/orgs",
      "repos_url": "https://api.github.com/users/YurGa777/repos",
      "events_url": "https://api.github.com/users/YurGa777/events{/privacy}",
      "received_events_url": "https://api.github.com/users/YurGa777/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-11-09T08:30:50Z",
    "updated_at": "2022-11-09T08:30:50Z",
    "author_association": "NONE",
    "body": "I have the same issue",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1308389559/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1311541313",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/26131#issuecomment-1311541313",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/26131",
    "id": 1311541313,
    "node_id": "IC_kwDOAOvK985OLIhB",
    "user": {
      "login": "yorickdowne",
      "id": 71337066,
      "node_id": "MDQ6VXNlcjcxMzM3MDY2",
      "avatar_url": "https://avatars.githubusercontent.com/u/71337066?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/yorickdowne",
      "html_url": "https://github.com/yorickdowne",
      "followers_url": "https://api.github.com/users/yorickdowne/followers",
      "following_url": "https://api.github.com/users/yorickdowne/following{/other_user}",
      "gists_url": "https://api.github.com/users/yorickdowne/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/yorickdowne/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/yorickdowne/subscriptions",
      "organizations_url": "https://api.github.com/users/yorickdowne/orgs",
      "repos_url": "https://api.github.com/users/yorickdowne/repos",
      "events_url": "https://api.github.com/users/yorickdowne/events{/privacy}",
      "received_events_url": "https://api.github.com/users/yorickdowne/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-11-11T10:52:30Z",
    "updated_at": "2022-11-11T10:52:30Z",
    "author_association": "NONE",
    "body": "This isn’t a bug, it’s slow storage. Give it more time to shut down. See https://gist.github.com/yorickdowne/27d4a96174562377d86e4df5d8de654f\r\n\r\nThe longer Geth has been running, the longer it takes to shut down. Disk speed and cache size also come into it.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1311541313/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1311592212",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/26131#issuecomment-1311592212",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/26131",
    "id": 1311592212,
    "node_id": "IC_kwDOAOvK985OLU8U",
    "user": {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-11-11T11:41:30Z",
    "updated_at": "2022-11-11T11:42:11Z",
    "author_association": "MEMBER",
    "body": "There might, or might not be a bug here. Usually, geth shuts down within `90s`, however a 2-3 minutes is a safer choice. \r\nFrom time to time, we have experienced shutdown-hangs, and once we do, we try to fix them asap, because those are pretty nasty. As far as I know, there's no such bug in 1.10.23, so for now I'll assume it's just a case of \"it took longer than 90s\"\r\n\r\n> it looks like it just \"forgot\" about the shutdown and started looking for peers again\r\n\r\nWell, it doesn't. It's just different processes. \r\n\r\nBoth @dankrad and @YurGa777: if you can repro this (with _long_ timeout), it would be super-great if you can make the final-kill signal be a `SIGTRAP` or `SIGQUIT` -- because then we get the stacktrace, which is precisely what we need in order to figure out where it got stuck in the shutdown process. ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1311592212/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1370698802",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/26131#issuecomment-1370698802",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/26131",
    "id": 1370698802,
    "node_id": "IC_kwDOAOvK985RszQy",
    "user": {
      "login": "antondlr",
      "id": 55993670,
      "node_id": "MDQ6VXNlcjU1OTkzNjcw",
      "avatar_url": "https://avatars.githubusercontent.com/u/55993670?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/antondlr",
      "html_url": "https://github.com/antondlr",
      "followers_url": "https://api.github.com/users/antondlr/followers",
      "following_url": "https://api.github.com/users/antondlr/following{/other_user}",
      "gists_url": "https://api.github.com/users/antondlr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/antondlr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/antondlr/subscriptions",
      "organizations_url": "https://api.github.com/users/antondlr/orgs",
      "repos_url": "https://api.github.com/users/antondlr/repos",
      "events_url": "https://api.github.com/users/antondlr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/antondlr/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-01-04T09:44:30Z",
    "updated_at": "2023-01-04T09:44:30Z",
    "author_association": "NONE",
    "body": "I can attest that there's definitely something going on here, not just storage speed related. \r\nIn my case I didn't see systemd kill it since I run containers which were -as far as systemd is concerned- properly stopped (finishing in ~20s). \r\n\r\nThis is on a fresh node w/ v1.10.26 which would unclean-shutdown every time (9 times out of 9 restarts/reboots). \r\nDowngraded to v1.10.24, then v1.10.25, now back on v1.10.26 and the issue seems to be miraculously gone.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1370698802/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
