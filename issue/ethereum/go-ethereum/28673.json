{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28673",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28673/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28673/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28673/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/28673",
  "id": 2038444969,
  "node_id": "I_kwDOAOvK9855gDOp",
  "number": 28673,
  "title": "bug: history.transactions flag not honored during resync (keeping ancients)",
  "user": {
    "login": "ryanschneider",
    "id": 53520,
    "node_id": "MDQ6VXNlcjUzNTIw",
    "avatar_url": "https://avatars.githubusercontent.com/u/53520?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ryanschneider",
    "html_url": "https://github.com/ryanschneider",
    "followers_url": "https://api.github.com/users/ryanschneider/followers",
    "following_url": "https://api.github.com/users/ryanschneider/following{/other_user}",
    "gists_url": "https://api.github.com/users/ryanschneider/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ryanschneider/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ryanschneider/subscriptions",
    "organizations_url": "https://api.github.com/users/ryanschneider/orgs",
    "repos_url": "https://api.github.com/users/ryanschneider/repos",
    "events_url": "https://api.github.com/users/ryanschneider/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ryanschneider/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 72233650,
      "node_id": "MDU6TGFiZWw3MjIzMzY1MA==",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/type:bug",
      "name": "type:bug",
      "color": "FF5E5E",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": {
    "login": "rjl493456442",
    "id": 5959481,
    "node_id": "MDQ6VXNlcjU5NTk0ODE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5959481?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/rjl493456442",
    "html_url": "https://github.com/rjl493456442",
    "followers_url": "https://api.github.com/users/rjl493456442/followers",
    "following_url": "https://api.github.com/users/rjl493456442/following{/other_user}",
    "gists_url": "https://api.github.com/users/rjl493456442/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/rjl493456442/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rjl493456442/subscriptions",
    "organizations_url": "https://api.github.com/users/rjl493456442/orgs",
    "repos_url": "https://api.github.com/users/rjl493456442/repos",
    "events_url": "https://api.github.com/users/rjl493456442/events{/privacy}",
    "received_events_url": "https://api.github.com/users/rjl493456442/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "rjl493456442",
      "id": 5959481,
      "node_id": "MDQ6VXNlcjU5NTk0ODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5959481?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rjl493456442",
      "html_url": "https://github.com/rjl493456442",
      "followers_url": "https://api.github.com/users/rjl493456442/followers",
      "following_url": "https://api.github.com/users/rjl493456442/following{/other_user}",
      "gists_url": "https://api.github.com/users/rjl493456442/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rjl493456442/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rjl493456442/subscriptions",
      "organizations_url": "https://api.github.com/users/rjl493456442/orgs",
      "repos_url": "https://api.github.com/users/rjl493456442/repos",
      "events_url": "https://api.github.com/users/rjl493456442/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rjl493456442/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2023-12-12T19:45:49Z",
  "updated_at": "2023-12-15T18:41:53Z",
  "closed_at": null,
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "#### System information\r\n\r\nGeth version: `1.13.5`\r\nCL client & version: `teku v23.11.0`\r\nOS & Version: Linux\r\n\r\n#### Expected behaviour\r\n\r\nAfter using `geth removedb` (and choosing `n` on deleting ancients) and restarting, the node should resync and honor the value of `--history.transactions 0`.\r\n\r\n#### Actual behaviour\r\n\r\nAfter using `geth removedb` (and choosing `n` on deleting ancients) and restarting, the node resyncs but seems to only index \"recent\" transactions.\r\n\r\n#### Steps to reproduce the behaviour\r\n\r\n- Sync a node to head (I've tested reproduced on both 1.13.5 and 1.13.1 using both leveldb and pebble/PBSS)\r\n  - relevant arguments: \r\n\r\n```\r\n/usr/bin/geth --mainnet --syncmode full --db.engine=leveldb --history.transactions 0 --snapshot=true --datadir /mnt/local/ethereum\r\n```\r\n\r\n- Stop the node\r\n- Run `geth removedb`\r\n- Choose `y` for deleting full node state, `n` for ancients as shown below:\r\n\r\n```\r\n$ sudo -u geth geth removedb --db.engine=leveldb --datadir /mnt/local/ethereum\r\nINFO [12-12|00:26:24.953] Maximum peer count                       ETH=50 LES=0 total=50\r\nINFO [12-12|00:26:24.955] Smartcard socket not found, disabling    err=\"stat /run/pcscd/pcscd.comm: no such file or directory\"\r\nINFO [12-12|00:26:24.956] Using leveldb as db engine\r\nINFO [12-12|00:26:24.958] Global gas cap set to 10x block gas limit\r\nINFO [12-12|00:26:24.959] Initializing the KZG library             backend=gokzg\r\nRemove full node state database (/mnt/local/ethereum/geth/chaindata)? [y/n] y\r\nRemove full node state database (/mnt/local/ethereum/geth/chaindata)? [y/n] y\r\nINFO [12-12|00:26:57.218] Database successfully deleted            path=/mnt/local/ethereum/geth/chaindata elapsed=26.749s\r\nRemove full node ancient database (/mnt/local/ethereum/geth/chaindata/ancient)? [y/n] n\r\nRemove full node ancient database (/mnt/local/ethereum/geth/chaindata/ancient)? [y/n] n\r\nINFO [12-12|00:27:06.826] Database deletion skipped                path=/mnt/local/ethereum/geth/chaindata/ancient\r\nINFO [12-12|00:27:06.827] Light node database missing              path=/mnt/local/ethereum/geth/lightchaindata\r\n```\r\n\r\n- Restart the node\r\n- Wait \"overnight\" while node resyncs\r\n- Eventually Node is synced to head\r\n- Try retrieving an older tx, e.g.: https://etherscan.io/tx/0xa243c78518ea5b6ebdccb61f54f3f87f44e84b7c028560386196e6bc77de37dd\r\n\r\n```\r\n$ sudo geth attach /mnt/local/ethereum/geth.ipc\r\nWelcome to the Geth JavaScript console!\r\n\r\ninstance: Geth/v1.13.5-omnibus-62a11504/linux-amd64/go1.21.4\r\nat block: 18771040 (Tue Dec 12 2023 15:36:59 GMT+0000 (UTC))\r\n datadir: /mnt/local/ethereum\r\n modules: admin:1.0 debug:1.0 engine:1.0 eth:1.0 miner:1.0 net:1.0 rpc:1.0 txpool:1.0 web3:1.0\r\n\r\nTo exit, press ctrl-d or type exit\r\n> eth.getTransaction(\"0xa243c78518ea5b6ebdccb61f54f3f87f44e84b7c028560386196e6bc77de37dd\")\r\nnull\r\n```\r\n\r\nFurthermore, I scanned the logs for `Indexing transactions` and never had any hits, so as far as I can tell `rawdb.indexTransactions` never runs.\r\n\r\nI'm trying again now w/o using the ancients, and it _seems_ to be working, but I won't know for certain until it fully syncs again.\r\n\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28673/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28673/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1855084052",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/28673#issuecomment-1855084052",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28673",
    "id": 1855084052,
    "node_id": "IC_kwDOAOvK985uklYU",
    "user": {
      "login": "rjl493456442",
      "id": 5959481,
      "node_id": "MDQ6VXNlcjU5NTk0ODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5959481?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rjl493456442",
      "html_url": "https://github.com/rjl493456442",
      "followers_url": "https://api.github.com/users/rjl493456442/followers",
      "following_url": "https://api.github.com/users/rjl493456442/following{/other_user}",
      "gists_url": "https://api.github.com/users/rjl493456442/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rjl493456442/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rjl493456442/subscriptions",
      "organizations_url": "https://api.github.com/users/rjl493456442/orgs",
      "repos_url": "https://api.github.com/users/rjl493456442/repos",
      "events_url": "https://api.github.com/users/rjl493456442/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rjl493456442/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-12-14T03:48:38Z",
    "updated_at": "2023-12-14T03:48:38Z",
    "author_association": "MEMBER",
    "body": "Are you sure your node is synced? \r\n\r\nYou are running full sync on mainnet and it can take roughly 2 weeks. You are retrieving a transaction in block [16164065](https://etherscan.io/block/16164065), my gut feeling is this transaction is not indexed yet.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1855084052/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1855184536",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/28673#issuecomment-1855184536",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28673",
    "id": 1855184536,
    "node_id": "IC_kwDOAOvK985uk96Y",
    "user": {
      "login": "ryanschneider",
      "id": 53520,
      "node_id": "MDQ6VXNlcjUzNTIw",
      "avatar_url": "https://avatars.githubusercontent.com/u/53520?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanschneider",
      "html_url": "https://github.com/ryanschneider",
      "followers_url": "https://api.github.com/users/ryanschneider/followers",
      "following_url": "https://api.github.com/users/ryanschneider/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanschneider/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanschneider/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanschneider/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanschneider/orgs",
      "repos_url": "https://api.github.com/users/ryanschneider/repos",
      "events_url": "https://api.github.com/users/ryanschneider/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanschneider/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-12-14T05:49:56Z",
    "updated_at": "2023-12-14T05:49:56Z",
    "author_association": "CONTRIBUTOR",
    "body": "Oops sorry the node was using snap sync, I copied the sync mode from the\r\nwrong server.  The machine was definitely synced to head and passing all\r\nour health checks.\r\n\r\nOn Wed, Dec 13, 2023 at 7:48 PM rjl493456442 ***@***.***>\r\nwrote:\r\n\r\n> Are you sure your node is synced?\r\n>\r\n> You are running full sync on mainnet and it can take roughly 2 weeks. You\r\n> are retrieving a transaction in block 16164065\r\n> <https://etherscan.io/block/16164065>, my gut feeling is this transaction\r\n> is not indexed yet.\r\n>\r\n> —\r\n> Reply to this email directly, view it on GitHub\r\n> <https://github.com/ethereum/go-ethereum/issues/28673#issuecomment-1855084052>,\r\n> or unsubscribe\r\n> <https://github.com/notifications/unsubscribe-auth/AAANCEATWD37LYF7SFERQRDYJJZKHAVCNFSM6AAAAABASAOMEWVHI2DSMVQWIX3LMV43OSLTON2WKQ3PNVWWK3TUHMYTQNJVGA4DIMBVGI>\r\n> .\r\n> You are receiving this because you authored the thread.Message ID:\r\n> ***@***.***>\r\n>\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1855184536/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1855350447",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/28673#issuecomment-1855350447",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28673",
    "id": 1855350447,
    "node_id": "IC_kwDOAOvK985ulmav",
    "user": {
      "login": "rjl493456442",
      "id": 5959481,
      "node_id": "MDQ6VXNlcjU5NTk0ODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5959481?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rjl493456442",
      "html_url": "https://github.com/rjl493456442",
      "followers_url": "https://api.github.com/users/rjl493456442/followers",
      "following_url": "https://api.github.com/users/rjl493456442/following{/other_user}",
      "gists_url": "https://api.github.com/users/rjl493456442/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rjl493456442/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rjl493456442/subscriptions",
      "organizations_url": "https://api.github.com/users/rjl493456442/orgs",
      "repos_url": "https://api.github.com/users/rjl493456442/repos",
      "events_url": "https://api.github.com/users/rjl493456442/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rjl493456442/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-12-14T07:55:27Z",
    "updated_at": "2023-12-14T07:55:27Z",
    "author_association": "MEMBER",
    "body": "Can you provide the command for relaunching geth node?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1855350447/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1856497268",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/28673#issuecomment-1856497268",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28673",
    "id": 1856497268,
    "node_id": "IC_kwDOAOvK985up-Z0",
    "user": {
      "login": "ryanschneider",
      "id": 53520,
      "node_id": "MDQ6VXNlcjUzNTIw",
      "avatar_url": "https://avatars.githubusercontent.com/u/53520?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanschneider",
      "html_url": "https://github.com/ryanschneider",
      "followers_url": "https://api.github.com/users/ryanschneider/followers",
      "following_url": "https://api.github.com/users/ryanschneider/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanschneider/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanschneider/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanschneider/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanschneider/orgs",
      "repos_url": "https://api.github.com/users/ryanschneider/repos",
      "events_url": "https://api.github.com/users/ryanschneider/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanschneider/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-12-14T19:58:43Z",
    "updated_at": "2023-12-14T19:58:43Z",
    "author_association": "CONTRIBUTOR",
    "body": "```\r\n/usr/bin/geth --mainnet --syncmode snap --db.engine=leveldb  --pprof --cache 4096 --cache.blocklogs 1024 --rpc.gascap 500000000 --rpc.txfeecap 0 --history.transactions 0 --rpc.allow-unprotected-txs --snapshot=true --datadir /mnt/local/ethereum\r\n```\r\n\r\n(I removed a bunch of unrelated `--http` `--txpool` and `--ws` arguments for clarity)\r\n\r\nI did confirm that the txs _are_ indexed correctly with the above arguments if I fully delete the `ancients`, even though interestingly I never see the log line containing `Indexing transactions`.\r\n\r\nI'll try reproducing on holesky or sepolia or somewhere faster to iterate on, but I think what's happening is that when the `ancients` already exist they are reused but `rawdb.WriteTxLookupEntriesByBlock(..)` is never called, I see it called in directly in `writeAncients` and indirectly in `indexTransactions` but I don't think it's called in the routine that \"reimports\" the ancients when the state db is blown away but the ancients db is kept.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1856497268/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1858332284",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/28673#issuecomment-1858332284",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28673",
    "id": 1858332284,
    "node_id": "IC_kwDOAOvK985uw-Z8",
    "user": {
      "login": "ryanschneider",
      "id": 53520,
      "node_id": "MDQ6VXNlcjUzNTIw",
      "avatar_url": "https://avatars.githubusercontent.com/u/53520?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanschneider",
      "html_url": "https://github.com/ryanschneider",
      "followers_url": "https://api.github.com/users/ryanschneider/followers",
      "following_url": "https://api.github.com/users/ryanschneider/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanschneider/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanschneider/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanschneider/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanschneider/orgs",
      "repos_url": "https://api.github.com/users/ryanschneider/repos",
      "events_url": "https://api.github.com/users/ryanschneider/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanschneider/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-12-15T18:41:51Z",
    "updated_at": "2023-12-15T18:41:51Z",
    "author_association": "CONTRIBUTOR",
    "body": "Ok, I have a clean reproduction, I ended up stick w/ mainnet so it took a bit longer.\r\n\r\n- Node synced to head and confirmed healthy on all fronts.\r\n- Node was shutdown, then `geth removedb --datadir /mnt/local/ethereum` (choosing `y` for state and `n` for ancients)\r\n- Confirmed that the only contents of `/mnt/local/ethereum/geth/chaindata` was a ~600GB `/mnt/local/ethereum/geth/chaindata/ancient` directory.\r\n- Node was restarted w/ these arguments:\r\n\r\n```\r\n/usr/bin/geth --mainnet --syncmode snap --db.engine=leveldb  --pprof --cache 4096 --cache.blocklogs 1024 --rpc.gascap 500000000 --rpc.txfeecap 0 --txlookuplimit 0 --rpc.allow-unprotected-txs --snapshot=true --datadir /mnt/local/ethereum --authrpc.jwtsecret /mnt/local/ethereum/engine-jwt.key\r\n```\r\n\r\n- Confirmed that DB was reinitialized by the freezer and then snap sync was started:\r\n\r\n```\r\nDec 15 00:50:51 ip-10-0-68-166 geth[14941]: INFO [12-15|00:50:51.551] Initializing database from freezer       total=18,697,685 number=400,000 hash=1e77d8..38ba14 elapsed=1.014s\r\nDec 15 00:50:54 ip-10-0-68-166 systemd[1]: Started Geth.\r\nDec 15 00:50:59 ip-10-0-68-166 geth[14941]: INFO [12-15|00:50:59.822] Initializing database from freezer       total=18,697,685 number=2,300,000 hash=a71398..42f9fd elapsed=9.286s\r\nDec 15 00:51:08 ip-10-0-68-166 geth[14941]: INFO [12-15|00:51:08.250] Initializing database from freezer       total=18,697,685 number=3,900,000 hash=cfe6ce..495e75 elapsed=17.714s\r\nDec 15 00:51:16 ip-10-0-68-166 geth[14941]: INFO [12-15|00:51:16.822] Initializing database from freezer       total=18,697,685 number=5,400,000 hash=9c7aa1..e4791a elapsed=26.286s\r\nDec 15 00:51:25 ip-10-0-68-166 geth[14941]: INFO [12-15|00:51:25.084] Initializing database from freezer       total=18,697,685 number=6,700,000 hash=c8b204..2054e6 elapsed=34.548s\r\nDec 15 00:51:33 ip-10-0-68-166 geth[14941]: INFO [12-15|00:51:33.102] Initializing database from freezer       total=18,697,685 number=7,900,000 hash=a33485..67a32b elapsed=42.565s\r\nDec 15 00:51:41 ip-10-0-68-166 geth[14941]: INFO [12-15|00:51:41.525] Initializing database from freezer       total=18,697,685 number=9,200,000 hash=e21d53..d6fcc8 elapsed=50.989s\r\nDec 15 00:51:50 ip-10-0-68-166 geth[14941]: INFO [12-15|00:51:50.041] Initializing database from freezer       total=18,697,685 number=10,700,000 hash=0b96ac..31a4f0 elapsed=59.505s\r\nDec 15 00:51:58 ip-10-0-68-166 geth[14941]: INFO [12-15|00:51:58.248] Initializing database from freezer       total=18,697,685 number=12,800,000 hash=bc1378..af7735 elapsed=1m7.712s\r\nDec 15 00:52:06 ip-10-0-68-166 geth[14941]: INFO [12-15|00:52:06.361] Initializing database from freezer       total=18,697,685 number=14,500,000 hash=e31116..7c416a elapsed=1m15.825s\r\nDec 15 00:52:14 ip-10-0-68-166 geth[14941]: INFO [12-15|00:52:14.543] Initializing database from freezer       total=18,697,685 number=16,000,000 hash=6f377d..c6bb16 elapsed=1m24.007s\r\nDec 15 00:52:22 ip-10-0-68-166 geth[14941]: INFO [12-15|00:52:22.992] Initializing database from freezer       total=18,697,685 number=17,500,000 hash=bee1c9..3ab51c elapsed=1m32.455s\r\nDec 15 00:52:30 ip-10-0-68-166 geth[14941]: INFO [12-15|00:52:30.233] Initialized database from freezer        blocks=18,697,685 elapsed=1m39.697s\r\nDec 15 00:52:30 ip-10-0-68-166 geth[14941]: INFO [12-15|00:52:30.248] Loaded most recent local header          number=18,697,684 hash=17ebeb..03313f td=58,750,003,716,598,352,816,469 age=1w5d15h\r\nDec 15 00:52:30 ip-10-0-68-166 geth[14941]: INFO [12-15|00:52:30.248] Loaded most recent local block           number=0          hash=d4e567..cb8fa3 td=17,179,869,184                 age=54y8mo3w\r\nDec 15 00:52:30 ip-10-0-68-166 geth[14941]: INFO [12-15|00:52:30.248] Loaded most recent local snap block      number=18,697,684 hash=17ebeb..03313f td=58,750,003,716,598,352,816,469 age=1w5d15h\r\nDec 15 00:52:30 ip-10-0-68-166 geth[14941]: WARN [12-15|00:52:30.248] Failed to load snapshot                  err=\"missing or corrupted snapshot\"\r\nDec 15 00:52:30 ip-10-0-68-166 geth[14941]: INFO [12-15|00:52:30.248] Rebuilding state snapshot\r\nDec 15 00:52:30 ip-10-0-68-166 geth[14941]: INFO [12-15|00:52:30.249] Resuming state snapshot generation       root=d7f897..0f0544 accounts=0 slots=0 storage=0.00B dangling=0 elapsed=\"361.921µs\"\r\nDec 15 00:52:30 ip-10-0-68-166 geth[14941]: INFO [12-15|00:52:30.249] Upgrading chain index                    type=bloombits percentage=0\r\nDec 15 00:52:30 ip-10-0-68-166 geth[14941]: INFO [12-15|00:52:30.249] Initialized transaction indexer          limit=0\r\nDec 15 00:52:30 ip-10-0-68-166 geth[14941]: INFO [12-15|00:52:30.258] Enabled snap sync                        head=0 hash=d4e567..cb8fa3\r\n```\r\n\r\n- About 9h later state was downloaded and state healing began:\r\n\r\n```\r\nDec 15 09:17:55 ip-10-0-68-166 geth[14941]: INFO [12-15|09:17:55.005] Syncing: state download in progress      synced=99.98%  state=275.44GiB accounts=233,508,198@53.04GiB slots=1,071,866,568@21>\r\nDec 15 09:17:59 ip-10-0-68-166 geth[14941]: INFO [12-15|09:17:59.232] Syncing: state download in progress      synced=100.00% state=275.46GiB accounts=233,549,717@53.05GiB slots=1,071,915,553@21>\r\nDec 15 09:18:01 ip-10-0-68-166 geth[14941]: INFO [12-15|09:18:01.362] Forkchoice requested sync to new head    number=18,790,575 hash=8d36ad..9827b7 finalized=unknown\r\nDec 15 09:18:02 ip-10-0-68-166 geth[14941]: INFO [12-15|09:18:02.669] Syncing: chain download in progress      synced=100.00% chain=628.35GiB headers=18,790,575@8.62GiB bodies=18,790,495@450.57G>\r\nDec 15 09:18:07 ip-10-0-68-166 geth[14941]: INFO [12-15|09:18:07.232] Syncing: state healing in progress       accounts=1077@58.13KiB        slots=362@27.87KiB            codes=2@15.26KiB\r\n```\r\n\r\n- After about 12m of healing the snapshot generation began:\r\n\r\n```\r\nDec 15 09:30:19 ip-10-0-68-166 geth[14941]: INFO [12-15|09:30:19.831] Syncing: state healing in progress       accounts=141,330@7.52MiB      slots=224,370@17.01MiB        codes=143@963.27KiB    >\r\nDec 15 09:30:19 ip-10-0-68-166 geth[14941]: INFO [12-15|09:30:19.838] Rebuilding state snapshot\r\nDec 15 09:30:19 ip-10-0-68-166 geth[14941]: INFO [12-15|09:30:19.839] Committed new head block                 number=18,790,553 hash=c0a786..5035f6\r\nDec 15 09:30:19 ip-10-0-68-166 geth[14941]: INFO [12-15|09:30:19.840] Resuming state snapshot generation       root=958dc2..2e1f8d accounts=0                    slots=0                       sto>\r\nDec 15 09:30:24 ip-10-0-68-166 geth[14941]: INFO [12-15|09:30:24.147] Aborting state snapshot generation       root=958dc2..2e1f8d in=00136c..b383b6 at=b3d790..ef76f8 accounts=67552             >\r\nDec 15 09:30:24 ip-10-0-68-166 geth[14941]: INFO [12-15|09:30:24.147] Resuming state snapshot generation       root=206cb1..f5cff8 in=00136c..b383b6 at=b3d790..ef76f8 accounts=67552\r\n```\r\n\r\n- 4.5h or so later state generation completed:\r\n\r\n```\r\nDec 15 14:05:56 ip-10-0-68-166 geth[14941]: INFO [12-15|14:05:56.266] Generating state snapshot                root=18b9c5..3990ca in=ffeb92..4e53dc at=77c257..647c7b accounts=228,095,011       >\r\nDec 15 14:06:02 ip-10-0-68-166 geth[14941]: INFO [12-15|14:06:02.853] Generated state snapshot                 accounts=228,166,328          slots=1,088,101,530           storage=88.79GiB   dang>\r\nDec 15 14:06:12 ip-10-0-68-166 geth[14941]: INFO [12-15|14:06:12.458] Imported new potential chain segment     number=18,792,002 hash=c22b63..7c6a62 blocks=1          txs=385  mgas=23.005  elaps>\r\n```\r\n\r\n- And the node has been in a steady state of importing new head blocks as they come ever since:\r\n\r\n```\r\nDec 15 18:14:23 ip-10-0-68-166 geth[14941]: INFO [12-15|18:14:23.799] Chain head was updated                   number=18,793,230 hash=3dda92..c05bde root=ad252a..1da984 elapsed=2.754502ms\r\nDec 15 18:14:36 ip-10-0-68-166 geth[14941]: INFO [12-15|18:14:36.903] Imported new potential chain segment     number=18,793,231 hash=4f46ea..335c05 blocks=1          txs=227  mgas=19.133  elaps>\r\n```\r\n\r\nHowever, older transactions are _not_ available, e.g. this one from block [500002](https://etherscan.io/block/500002): https://etherscan.io/tx/0x45215aa0da9b7597d233d96b6f7c4ac311edaba77a99ecc6471c59663554914f\r\n\r\n```\r\n> eth.getTransaction(\"0x45215aa0da9b7597d233d96b6f7c4ac311edaba77a99ecc6471c59663554914f\")\r\nnull\r\n```\r\n\r\n- Going back to the initial logs, we saw:\r\n\r\n```\r\nDec 15 00:52:30 ip-10-0-68-166 geth[14941]: INFO [12-15|00:52:30.248] Loaded most recent local header          number=18,697,684 hash=17ebeb..03313f td=58,750,003,716,598,352,816,469 age=1w5d15h\r\nDec 15 00:52:30 ip-10-0-68-166 geth[14941]: INFO [12-15|00:52:30.248] Loaded most recent local block           number=0          hash=d4e567..cb8fa3 td=17,179,869,184                 age=54y8mo3w\r\nDec 15 00:52:30 ip-10-0-68-166 geth[14941]: INFO [12-15|00:52:30.248] Loaded most recent local snap block      number=18,697,684 hash=17ebeb..03313f td=58,750,003,716,598,352,816,469 age=1w5d15h\r\n```\r\n\r\n- So, I'm curious if block `18,697,684` ends up being the cutoff for what is and isn't indexed.  This is the first tx in block [18697684](https://etherscan.io/block/18697684): https://etherscan.io/tx/0x306c2c4b43a5628a2f9118cef14dea22a587de9fc12660b323e174b702039f86\r\n\r\n- And sure enough:\r\n\r\n```\r\n> eth.getTransaction(\"0x306c2c4b43a5628a2f9118cef14dea22a587de9fc12660b323e174b702039f86\")\r\nnull\r\n```\r\n\r\n- So let's try a tx in block [18697685](https://etherscan.io/block/18697685): https://etherscan.io/tx/0x61871bd101372d11e1d3f5c427fb4327db3472cbed19931b774f56c50431162f\r\n\r\n```\r\n> eth.getTransaction(\"0x61871bd101372d11e1d3f5c427fb4327db3472cbed19931b774f56c50431162f\")\r\n{\r\n  accessList: [],\r\n  blockHash: \"0xac41987349c41061d557b0c98063c0bd61979a3aa34a34bdd76ea0e3ef359965\",\r\n  blockNumber: 18697685,\r\n  chainId: \"0x1\",\r\n  from: \"0x5741d02852bfb7a05416a4ef412968ec2b88fcae\",\r\n  gas: 21000,\r\n  gasPrice: 47132796261,\r\n  hash: \"0x61871bd101372d11e1d3f5c427fb4327db3472cbed19931b774f56c50431162f\",\r\n  input: \"0x\",\r\n  maxFeePerGas: 48000000000,\r\n  maxPriorityFeePerGas: 40000000,\r\n  nonce: 9,\r\n  r: \"0x384caf10d5a27756f41745ac03446ea2451577f14ccb2ec099dd59ff1208d8fc\",\r\n  s: \"0x6dfede1dd40787658cc930235b48fa10d32cfcfc4298aeb511e2972c310328d3\",\r\n  to: \"0xf52605c7b778563a5a9144ef4dc53b57463ca2c7\",\r\n  transactionIndex: 210,\r\n  type: \"0x2\",\r\n  v: \"0x0\",\r\n  value: 25015950000000000,\r\n  yParity: \"0x0\"\r\n}\r\n```\r\n\r\nI think this makes it pretty evident that _something_ is going wrong w/ the freezer tx indexing logic.  I looked at the code, and couldn't find anything obvious, but here's the code I followed:\r\n\r\n- First off, when resyncing from ancients, `InitDatabaseFromFreezer` is called from `NewBlockChain` here: https://github.com/ethereum/go-ethereum/blob/master/core/blockchain.go#L330-L335\r\n- This in turn calls `WriteHeadHeaderHash`\r\n- Later in `NewBlockChain` we call `maintainTxIndex` here: https://github.com/ethereum/go-ethereum/blob/master/core/blockchain.go#L471\r\n\r\nSo, now we are in `maintainTxIndex` in another go routine, and the `log.Info` at it's start is called:\r\n\r\n```\r\nDec 15 00:52:30 ip-10-0-68-166 geth[14941]: INFO [12-15|00:52:30.249] Initialized transaction indexer          limit=0\r\n```\r\n\r\n- `maintainTxIndex` should be spawning a `indexBlocks` routine to index the txs, but I never see `Indexing transactions` in the logs.\r\n- nor do any `indexingBlocks` goroutines show up in `pprof` goroutine lists on http://localhost:6060/debug/pprof/goroutine?debug=1, but `maintainTxIndex` does:\r\n\r\n```\r\n1 @ 0x452fce 0x463525 0xd5186d 0x4866a1\r\n#\t0xd5186c\tgithub.com/ethereum/go-ethereum/core.(*BlockChain).maintainTxIndex+0x36c\tgithub.com/ethereum/go-ethereum/core/blockchain.go:2504\r\n```\r\n\r\nAlso note that:\r\n\r\n```\r\n> debug.dbGet(\"TransactionIndexTail\")\r\n\"0x0000000000000000\"\r\n```\r\n\r\nSo `rawdb.ReadTxIndexTail` should return `0` (I also checked this value while the snap sync was ongoing and it was `0` then as well, so something called `WriteTxIndexTail(0)` pretty early on in the process.\r\n \r\n\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1858332284/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
