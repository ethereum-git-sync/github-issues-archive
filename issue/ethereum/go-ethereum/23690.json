{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/23690",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/23690/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/23690/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/23690/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/23690",
  "id": 1019723935,
  "node_id": "I_kwDOAOvK9848x8Cf",
  "number": 23690,
  "title": "Memory leak on txpool priced urgent list",
  "user": {
    "login": "ferranbt",
    "id": 30872539,
    "node_id": "MDQ6VXNlcjMwODcyNTM5",
    "avatar_url": "https://avatars.githubusercontent.com/u/30872539?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ferranbt",
    "html_url": "https://github.com/ferranbt",
    "followers_url": "https://api.github.com/users/ferranbt/followers",
    "following_url": "https://api.github.com/users/ferranbt/following{/other_user}",
    "gists_url": "https://api.github.com/users/ferranbt/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ferranbt/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ferranbt/subscriptions",
    "organizations_url": "https://api.github.com/users/ferranbt/orgs",
    "repos_url": "https://api.github.com/users/ferranbt/repos",
    "events_url": "https://api.github.com/users/ferranbt/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ferranbt/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 72233650,
      "node_id": "MDU6TGFiZWw3MjIzMzY1MA==",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/type:bug",
      "name": "type:bug",
      "color": "FF5E5E",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "rjl493456442",
    "id": 5959481,
    "node_id": "MDQ6VXNlcjU5NTk0ODE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5959481?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/rjl493456442",
    "html_url": "https://github.com/rjl493456442",
    "followers_url": "https://api.github.com/users/rjl493456442/followers",
    "following_url": "https://api.github.com/users/rjl493456442/following{/other_user}",
    "gists_url": "https://api.github.com/users/rjl493456442/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/rjl493456442/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rjl493456442/subscriptions",
    "organizations_url": "https://api.github.com/users/rjl493456442/orgs",
    "repos_url": "https://api.github.com/users/rjl493456442/repos",
    "events_url": "https://api.github.com/users/rjl493456442/events{/privacy}",
    "received_events_url": "https://api.github.com/users/rjl493456442/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "rjl493456442",
      "id": 5959481,
      "node_id": "MDQ6VXNlcjU5NTk0ODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5959481?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rjl493456442",
      "html_url": "https://github.com/rjl493456442",
      "followers_url": "https://api.github.com/users/rjl493456442/followers",
      "following_url": "https://api.github.com/users/rjl493456442/following{/other_user}",
      "gists_url": "https://api.github.com/users/rjl493456442/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rjl493456442/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rjl493456442/subscriptions",
      "organizations_url": "https://api.github.com/users/rjl493456442/orgs",
      "repos_url": "https://api.github.com/users/rjl493456442/repos",
      "events_url": "https://api.github.com/users/rjl493456442/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rjl493456442/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2021-10-07T07:45:08Z",
  "updated_at": "2021-11-03T13:01:53Z",
  "closed_at": "2021-11-03T13:01:53Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "#### System information\r\n\r\nThis behaviour was found on Polygon PoS (upstream v1.10.8) but I think it also affects Go-ethereum, London fork **is not** enabled yet in our chain.\r\n\r\n#### Expected behaviour\r\n\r\nSome nodes on the Polygon PoS network have been having OOM crashes lately since the London changes were upstreamed. On pprof we found out that much of the allocated memory was on transactions.\r\n\r\n![image](https://user-images.githubusercontent.com/30872539/136337294-f466ab0c-6fa3-4fb7-9dd6-c68a10ccc5e9.png)\r\n\r\nWe though that the issue was either on:\r\n- Transaction pool.\r\n- Broadcast announcer.\r\n\r\nThis error was not reproducible and it would take at least a day to show up on the metrics. Some nodes even reported more than 100Gb of RAM because of this.\r\n\r\nOn the txpool we could not find any out of place metrics till we added (#23691) and we found this:\r\n\r\n![image](https://user-images.githubusercontent.com/30872539/136338275-f13b7d3b-7f59-4130-9c5e-4dd640292335.png)\r\n\r\nAt some point, the size of the urgent list in the transaction pool starts to grow non-stop at the same time as the memory, this happens until the node runs out of memory (note that there are millions of transactions in the urgent list!). Besides, in the chart we can see that there are no more \"reheap\" metrics being emitted, which makes sense since that indicates that the urgent list is being cleaned.\r\n\r\nIn this node the max txpool size was on the 100k and all the transactions were inserted on the pool with the normal peer to peer gossip protocol.\r\n\r\nIMHO, the problem is that under certain unknown circumstances, the txpool gets stuck and keeps adding new transactions into the urgent list without cleaning the old ones, this is, the Reheap method is not called anymore (no more reheap metrics).\r\n\r\nHowever, if the London fork **is** enabled as in the Ethereum mainnet network, SetBaseFee is called periodically [here](https://github.com/ethereum/go-ethereum/blob/067084fedab1d50e224e40e6442a7740fc53611a/core/tx_pool.go#L1183) and the urgent list is cleaned automatically, that is why the Ethereum mainnet has not seen this issue so far. But, if London fork **is not** enabled as in Polygon PoS, this does not happen. We found a solution [here](https://github.com/maticnetwork/bor/pull/201) by calling Reheap if London is not enabled and we have not seen the problem so far.\r\n\r\nThough I do not think there is a need for immediate action since we found a workaround (we can PR it if you guys want it) and the Ethereum mainnet will not likely find it on production I think it is good to keep in mind that there might be a memory leak on the priced list if not used correctly.",
  "closed_by": {
    "login": "MariusVanDerWijden",
    "id": 16664698,
    "node_id": "MDQ6VXNlcjE2NjY0Njk4",
    "avatar_url": "https://avatars.githubusercontent.com/u/16664698?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/MariusVanDerWijden",
    "html_url": "https://github.com/MariusVanDerWijden",
    "followers_url": "https://api.github.com/users/MariusVanDerWijden/followers",
    "following_url": "https://api.github.com/users/MariusVanDerWijden/following{/other_user}",
    "gists_url": "https://api.github.com/users/MariusVanDerWijden/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/MariusVanDerWijden/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/MariusVanDerWijden/subscriptions",
    "organizations_url": "https://api.github.com/users/MariusVanDerWijden/orgs",
    "repos_url": "https://api.github.com/users/MariusVanDerWijden/repos",
    "events_url": "https://api.github.com/users/MariusVanDerWijden/events{/privacy}",
    "received_events_url": "https://api.github.com/users/MariusVanDerWijden/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/23690/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/23690/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/937885654",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/23690#issuecomment-937885654",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/23690",
    "id": 937885654,
    "node_id": "IC_kwDOAOvK98435v_W",
    "user": {
      "login": "bassoy",
      "id": 3994021,
      "node_id": "MDQ6VXNlcjM5OTQwMjE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3994021?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bassoy",
      "html_url": "https://github.com/bassoy",
      "followers_url": "https://api.github.com/users/bassoy/followers",
      "following_url": "https://api.github.com/users/bassoy/following{/other_user}",
      "gists_url": "https://api.github.com/users/bassoy/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bassoy/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bassoy/subscriptions",
      "organizations_url": "https://api.github.com/users/bassoy/orgs",
      "repos_url": "https://api.github.com/users/bassoy/repos",
      "events_url": "https://api.github.com/users/bassoy/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bassoy/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-10-07T15:08:59Z",
    "updated_at": "2021-10-07T15:17:17Z",
    "author_association": "NONE",
    "body": "Seems that this issue is related or equal to this one https://github.com/ethereum/go-ethereum/issues/23195 and specifically https://github.com/ethereum/go-ethereum/issues/23195#issuecomment-882775865 and https://github.com/ethereum/go-ethereum/issues/23195#issuecomment-901994604.\r\n\r\nThis would mean that it is also relevant for the Ethereum mainnet. Would be good to clarify.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/937885654/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/938052338",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/23690#issuecomment-938052338",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/23690",
    "id": 938052338,
    "node_id": "IC_kwDOAOvK98436Yry",
    "user": {
      "login": "ferranbt",
      "id": 30872539,
      "node_id": "MDQ6VXNlcjMwODcyNTM5",
      "avatar_url": "https://avatars.githubusercontent.com/u/30872539?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ferranbt",
      "html_url": "https://github.com/ferranbt",
      "followers_url": "https://api.github.com/users/ferranbt/followers",
      "following_url": "https://api.github.com/users/ferranbt/following{/other_user}",
      "gists_url": "https://api.github.com/users/ferranbt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ferranbt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ferranbt/subscriptions",
      "organizations_url": "https://api.github.com/users/ferranbt/orgs",
      "repos_url": "https://api.github.com/users/ferranbt/repos",
      "events_url": "https://api.github.com/users/ferranbt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ferranbt/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-10-07T18:34:16Z",
    "updated_at": "2021-10-07T18:47:23Z",
    "author_association": "CONTRIBUTOR",
    "body": "Hi! I just found out that this might affect the Ethereum mainnet too. If the node gets stuck syncing in the same block (if there is a bad block for example), the reorg code is never called and neither the Reheap. We are seeing that at least in Polygon PoS after our fix too.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/938052338/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/946072435",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/23690#issuecomment-946072435",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/23690",
    "id": 946072435,
    "node_id": "IC_kwDOAOvK9844Y-tz",
    "user": {
      "login": "bassoy",
      "id": 3994021,
      "node_id": "MDQ6VXNlcjM5OTQwMjE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3994021?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bassoy",
      "html_url": "https://github.com/bassoy",
      "followers_url": "https://api.github.com/users/bassoy/followers",
      "following_url": "https://api.github.com/users/bassoy/following{/other_user}",
      "gists_url": "https://api.github.com/users/bassoy/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bassoy/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bassoy/subscriptions",
      "organizations_url": "https://api.github.com/users/bassoy/orgs",
      "repos_url": "https://api.github.com/users/bassoy/repos",
      "events_url": "https://api.github.com/users/bassoy/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bassoy/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-10-18T19:01:23Z",
    "updated_at": "2021-10-18T19:01:23Z",
    "author_association": "NONE",
    "body": "Is there any update on this issue?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/946072435/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/948691386",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/23690#issuecomment-948691386",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/23690",
    "id": 948691386,
    "node_id": "IC_kwDOAOvK9844i-G6",
    "user": {
      "login": "MariusVanDerWijden",
      "id": 16664698,
      "node_id": "MDQ6VXNlcjE2NjY0Njk4",
      "avatar_url": "https://avatars.githubusercontent.com/u/16664698?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MariusVanDerWijden",
      "html_url": "https://github.com/MariusVanDerWijden",
      "followers_url": "https://api.github.com/users/MariusVanDerWijden/followers",
      "following_url": "https://api.github.com/users/MariusVanDerWijden/following{/other_user}",
      "gists_url": "https://api.github.com/users/MariusVanDerWijden/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MariusVanDerWijden/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MariusVanDerWijden/subscriptions",
      "organizations_url": "https://api.github.com/users/MariusVanDerWijden/orgs",
      "repos_url": "https://api.github.com/users/MariusVanDerWijden/repos",
      "events_url": "https://api.github.com/users/MariusVanDerWijden/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MariusVanDerWijden/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-10-21T14:45:39Z",
    "updated_at": "2021-10-21T14:48:19Z",
    "author_association": "MEMBER",
    "body": "It might have already been fixed by this: https://github.com/ethereum/go-ethereum/commit/067084fedab1d50e224e40e6442a7740fc53611a\r\nI can not replicate it whatsoever\r\n\r\nThe adding to urgent and updating stales are in line at all times for me. Even when I modify some code to make the stales go negative for a while, they will eventually catch up and perform the reheap",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/948691386/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/958973401",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/23690#issuecomment-958973401",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/23690",
    "id": 958973401,
    "node_id": "IC_kwDOAOvK9845KMXZ",
    "user": {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-11-03T12:13:49Z",
    "updated_at": "2021-11-03T12:13:49Z",
    "author_association": "MEMBER",
    "body": "Since we've failed to repro, and believe it's already fixed, I'm closing this. Feel free to reopen (or open a new one) if the issue persists. ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/958973401/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
