{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21087",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21087/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21087/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21087/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/21087",
  "id": 618554570,
  "node_id": "MDU6SXNzdWU2MTg1NTQ1NzA=",
  "number": 21087,
  "title": "Unclean (or extremely slow) shutdown",
  "user": {
    "login": "holiman",
    "id": 142290,
    "node_id": "MDQ6VXNlcjE0MjI5MA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/holiman",
    "html_url": "https://github.com/holiman",
    "followers_url": "https://api.github.com/users/holiman/followers",
    "following_url": "https://api.github.com/users/holiman/following{/other_user}",
    "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
    "organizations_url": "https://api.github.com/users/holiman/orgs",
    "repos_url": "https://api.github.com/users/holiman/repos",
    "events_url": "https://api.github.com/users/holiman/events{/privacy}",
    "received_events_url": "https://api.github.com/users/holiman/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2020-05-14T21:45:00Z",
  "updated_at": "2020-05-26T19:37:38Z",
  "closed_at": "2020-05-26T19:37:38Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "When the shutdown sequence was redesigned, a regression was introduced. \r\n\r\nThe new shutdown mechanism is designed to \"close from bottom up\", with the pretty sensible idea to stop the peering, stop the downloader and 'starve' the upper protocols. However, while we're waiting for the downloader goroutines to exit, there's a dependency to a upper layer which causes problems. \r\n\r\nWhen a node is catching up, the downloader delivers blocks in batches of `2048` to it. And therefore, the processfullsyncContent goroutine cannot exit until the blockchain has slogged through maybe  `2000` blocks, which can take 400s (for 200ms blocks) and up to several thousand seconds.  \r\n\r\nI guess this worked fine when we just shut down the blockchain. \r\n\r\nSome logs from a very very slow bootnode (5 second block times): \r\n```\r\nMay 14 23:22:44 bootnode-aws-us-east-1-001 geth INFO [05-14|21:22:44.837] Got interrupt, shutting down...\r\nMay 14 23:22:44 bootnode-aws-us-east-1-001 geth INFO [05-14|21:22:44.838] IPC endpoint closed url=/root/.ethereum/geth.ipc\r\nMay 14 23:22:44 bootnode-aws-us-east-1-001 geth INFO [05-14|21:22:44.838] Stopping protocol manager\r\nMay 14 23:22:44 bootnode-aws-us-east-1-001 geth INFO [05-14|21:22:44.838] protocol manager tx sync loop exiting\r\nMay 14 23:22:44 bootnode-aws-us-east-1-001 geth INFO [05-14|21:22:44.838] chainsyncer received quit signal\r\nMay 14 23:22:44 bootnode-aws-us-east-1-001 geth INFO [05-14|21:22:44.838] protocol manager, minedBroadcastLoop loop exiting\r\nMay 14 23:22:44 bootnode-aws-us-east-1-001 geth INFO [05-14|21:22:44.838] protocol manager, txBroadcastLoop loop exiting\r\nMay 14 23:22:44 bootnode-aws-us-east-1-001 geth INFO [05-14|21:22:44.838] chainsyncer terminating downloader\r\nMay 14 23:22:44 bootnode-aws-us-east-1-001 geth INFO [05-14|21:22:44.838] Downloader closed quitCh\r\nMay 14 23:22:44 bootnode-aws-us-east-1-001 geth INFO [05-14|21:22:44.838] Downloader calling 'cancel'\r\nMay 14 23:22:44 bootnode-aws-us-east-1-001 geth INFO [05-14|21:22:44.838] Downloader waiting for wg\r\nMay 14 23:22:44 bootnode-aws-us-east-1-001 geth INFO [05-14|21:22:44.838] processHeaders terminated\r\nMay 14 23:22:46 bootnode-aws-us-east-1-001 geth INFO [05-14|21:22:46.960] Imported new chain segment blocks=7 txs=856 mgas=69.874 elapsed=8.265s mgasps=8.453 number=10061486 hash=\"e74420…29ee1b\" remaining=1369 age=19h20m42s dirty=342.14MiB\r\nMay 14 23:22:55 bootnode-aws-us-east-1-001 geth INFO [05-14|21:22:55.471] Imported new chain segment blocks=8 txs=1318 mgas=79.745 elapsed=8.511s mgasps=9.370 number=10061494 hash=\"1d559a…fb4408\" remaining=1361 age=19h19m16s dirty=346.22MiB\r\nMay 14 23:23:05 bootnode-aws-us-east-1-001 geth INFO [05-14|21:23:05.025] Imported new chain segment blocks=7 txs=884 mgas=59.867 elapsed=9.554s mgasps=6.266 number=10061501 hash=\"2b8893…a3cc81\" remaining=1354 age=19h18m42s dirty=349.41MiB\r\nMay 14 23:23:14 bootnode-aws-us-east-1-001 geth INFO [05-14|21:23:14.000] Imported new chain segment blocks=11 txs=1543 mgas=79.728 elapsed=8.975s mgasps=8.883 number=10061512 hash=\"48bca9…a8556b\" remaining=1343 age=19h15m58s dirty=348.86MiB\r\nMay 14 23:23:24 bootnode-aws-us-east-1-001 geth INFO [05-14|21:23:24.823] Imported new chain segment blocks=7 txs=1019 mgas=69.732 elapsed=10.822s mgasps=6.443 number=10061519 hash=\"77b36c…2021fd\" remaining=1336 age=19h14m37s dirty=351.87MiB\r\nMay 14 23:23:34 bootnode-aws-us-east-1-001 geth INFO [05-14|21:23:34.028] Imported new chain segment blocks=7 txs=912 mgas=59.887 elapsed=9.204s mgasps=6.506 number=10061526 hash=\"8abf42…b5bcd5\" remaining=1329 age=19h12m42s dirty=353.18MiB\r\n```\r\n\r\nAs you can see, with some added logs, the block importer has `remaining=1329` in the current batch which was delivered from the downloader. And not until all of those have been processed does the downloader get a chance to check the quitCh, exit, and complete the waitgroup that we're waiting for. \r\n\r\nPotential fixes: \r\n- Adapt the batch size, let downloader 'tune' the size so the task completes in ~10 seconds, \r\n- Give the downloader a time limit to terminate, but proceed anyway with other shutdown tasks if it fails. \r\n- Pass some channel or context from downloader into the blockchan (ugh)\r\n\r\n\r\nRelated: https://github.com/ethereum/go-ethereum/issues/20975 ",
  "closed_by": {
    "login": "fjl",
    "id": 6915,
    "node_id": "MDQ6VXNlcjY5MTU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6915?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/fjl",
    "html_url": "https://github.com/fjl",
    "followers_url": "https://api.github.com/users/fjl/followers",
    "following_url": "https://api.github.com/users/fjl/following{/other_user}",
    "gists_url": "https://api.github.com/users/fjl/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/fjl/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/fjl/subscriptions",
    "organizations_url": "https://api.github.com/users/fjl/orgs",
    "repos_url": "https://api.github.com/users/fjl/repos",
    "events_url": "https://api.github.com/users/fjl/events{/privacy}",
    "received_events_url": "https://api.github.com/users/fjl/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21087/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21087/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/629364612",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/21087#issuecomment-629364612",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21087",
    "id": 629364612,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyOTM2NDYxMg==",
    "user": {
      "login": "turboboost55",
      "id": 7891737,
      "node_id": "MDQ6VXNlcjc4OTE3Mzc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7891737?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/turboboost55",
      "html_url": "https://github.com/turboboost55",
      "followers_url": "https://api.github.com/users/turboboost55/followers",
      "following_url": "https://api.github.com/users/turboboost55/following{/other_user}",
      "gists_url": "https://api.github.com/users/turboboost55/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/turboboost55/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/turboboost55/subscriptions",
      "organizations_url": "https://api.github.com/users/turboboost55/orgs",
      "repos_url": "https://api.github.com/users/turboboost55/repos",
      "events_url": "https://api.github.com/users/turboboost55/events{/privacy}",
      "received_events_url": "https://api.github.com/users/turboboost55/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-15T16:47:05Z",
    "updated_at": "2020-05-15T16:47:05Z",
    "author_association": "NONE",
    "body": "I've seen this twice the last few days.  Tried to shutdown geth while it was \"catching up\" (the node had been turned off for a few hours).  It took about 20 minutes to shutdown.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/629364612/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
