{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20727",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20727/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20727/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20727/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/20727",
  "id": 572175446,
  "node_id": "MDU6SXNzdWU1NzIxNzU0NDY=",
  "number": 20727,
  "title": "Check existing account balance when replacing with new one?",
  "user": {
    "login": "02p01r",
    "id": 47611208,
    "node_id": "MDQ6VXNlcjQ3NjExMjA4",
    "avatar_url": "https://avatars.githubusercontent.com/u/47611208?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/02p01r",
    "html_url": "https://github.com/02p01r",
    "followers_url": "https://api.github.com/users/02p01r/followers",
    "following_url": "https://api.github.com/users/02p01r/following{/other_user}",
    "gists_url": "https://api.github.com/users/02p01r/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/02p01r/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/02p01r/subscriptions",
    "organizations_url": "https://api.github.com/users/02p01r/orgs",
    "repos_url": "https://api.github.com/users/02p01r/repos",
    "events_url": "https://api.github.com/users/02p01r/events{/privacy}",
    "received_events_url": "https://api.github.com/users/02p01r/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2020-02-27T15:55:25Z",
  "updated_at": "2020-06-10T20:38:10Z",
  "closed_at": "2020-03-19T08:53:06Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "I omitted the template cause it's not really suitable for this post, hope you understand.\r\n\r\nShouldn't you check here whether the balance is zero?\r\nhttps://github.com/ethereum/go-ethereum/blob/f891fd98754b49b351e3a289578bf3072c3e8c8a/core/vm/evm.go#L397\r\n\r\nIf there is a collision, you'll not erase the balance, but you'll reset nonce to 1 and put the code into someone else's account, more precisely, human-managed account that has never transacted and only received incoming transfers.\r\n",
  "closed_by": {
    "login": "holiman",
    "id": 142290,
    "node_id": "MDQ6VXNlcjE0MjI5MA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/holiman",
    "html_url": "https://github.com/holiman",
    "followers_url": "https://api.github.com/users/holiman/followers",
    "following_url": "https://api.github.com/users/holiman/following{/other_user}",
    "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
    "organizations_url": "https://api.github.com/users/holiman/orgs",
    "repos_url": "https://api.github.com/users/holiman/repos",
    "events_url": "https://api.github.com/users/holiman/events{/privacy}",
    "received_events_url": "https://api.github.com/users/holiman/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20727/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20727/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/601036656",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/20727#issuecomment-601036656",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20727",
    "id": 601036656,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYwMTAzNjY1Ng==",
    "user": {
      "login": "adamschmideg",
      "id": 208822,
      "node_id": "MDQ6VXNlcjIwODgyMg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/208822?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/adamschmideg",
      "html_url": "https://github.com/adamschmideg",
      "followers_url": "https://api.github.com/users/adamschmideg/followers",
      "following_url": "https://api.github.com/users/adamschmideg/following{/other_user}",
      "gists_url": "https://api.github.com/users/adamschmideg/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/adamschmideg/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/adamschmideg/subscriptions",
      "organizations_url": "https://api.github.com/users/adamschmideg/orgs",
      "repos_url": "https://api.github.com/users/adamschmideg/repos",
      "events_url": "https://api.github.com/users/adamschmideg/events{/privacy}",
      "received_events_url": "https://api.github.com/users/adamschmideg/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-03-19T07:51:56Z",
    "updated_at": "2020-03-19T07:51:56Z",
    "author_association": "MEMBER",
    "body": "Can you write a snippet that produces a collision with misplaced account balances? That would help us proceed.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/601036656/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/601060506",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/20727#issuecomment-601060506",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20727",
    "id": 601060506,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYwMTA2MDUwNg==",
    "user": {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-03-19T08:53:05Z",
    "updated_at": "2020-03-19T08:53:05Z",
    "author_association": "MEMBER",
    "body": "\r\nSome background \r\nSee https://github.com/ethereum/EIPs/blob/master/EIPS/eip-1014.md#clarifications . \r\n\r\n> \r\n> This EIP makes collisions possible. The behaviour at collisions is specified by EIP 684:\r\n> \r\n>     If a contract creation is attempted, due to either a creation transaction or the CREATE (or future CREATE2) opcode, and the destination address already has either nonzero nonce, or nonempty code, then the creation throws immediately, with exactly the same behavior as would arise if the first byte in the init code were an invalid opcode. This applies retroactively starting from genesis.\r\n> \r\n> Specifically, if nonce or code is nonzero, then the create-operation fails.\r\n> \r\n> With EIP 161\r\n> \r\n>     Account creation transactions and the CREATE operation SHALL, prior to the execution of the initialisation code, increment the nonce over and above its normal starting value by one\r\n> \r\n> This means that if a contract is created in a transaction, the nonce is immediately non-zero, with the side-effect that a collision within the same transaction will always fail -- even if it's carried out from the init_code itself.\r\n> \r\n> It should also be noted that SELFDESTRUCT has no immediate effect on nonce or code, thus a contract cannot be destroyed and recreated within one transaction.\r\n\r\n\r\nSo here's the relevant code\r\n```golang\r\n\t// Ensure there's no existing contract already at the designated address\r\n\tcontractHash := evm.StateDB.GetCodeHash(address)\r\n\tif evm.StateDB.GetNonce(address) != 0 || (contractHash != (common.Hash{}) && contractHash != emptyCodeHash) {\r\n\t\treturn nil, common.Address{}, 0, ErrContractAddressCollision\r\n\t}\r\n```\r\n\r\n- Nonce is non-zero (either an active end-user-account or a non-destructed contract )\r\n- _OR_ code is non-empty (so a non-destructed contract) \r\n\r\nThen it's a collision, and we error out. As per `684`. \r\n\r\nSo from this point, we know nonce is zero. And it may be the case that someone added some funds to a yet-to-be-deployed contract. In that case, we need to set the nonce, per `EIP 161` and set the code, but obviously allow it to keep the balance. \r\n\r\nThis is not a human-managed account, because that would require a hash collision between addresses generated by `CREATE`/`CREATE2` and a private key. \r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/601060506/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
