{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/23254",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/23254/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/23254/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/23254/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/23254",
  "id": 951236815,
  "node_id": "MDU6SXNzdWU5NTEyMzY4MTU=",
  "number": 23254,
  "title": "Low disk space corrupts ancient directory",
  "user": {
    "login": "mohamedmansour",
    "id": 68524,
    "node_id": "MDQ6VXNlcjY4NTI0",
    "avatar_url": "https://avatars.githubusercontent.com/u/68524?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mohamedmansour",
    "html_url": "https://github.com/mohamedmansour",
    "followers_url": "https://api.github.com/users/mohamedmansour/followers",
    "following_url": "https://api.github.com/users/mohamedmansour/following{/other_user}",
    "gists_url": "https://api.github.com/users/mohamedmansour/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mohamedmansour/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mohamedmansour/subscriptions",
    "organizations_url": "https://api.github.com/users/mohamedmansour/orgs",
    "repos_url": "https://api.github.com/users/mohamedmansour/repos",
    "events_url": "https://api.github.com/users/mohamedmansour/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mohamedmansour/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 72233650,
      "node_id": "MDU6TGFiZWw3MjIzMzY1MA==",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/type:bug",
      "name": "type:bug",
      "color": "FF5E5E",
      "default": false,
      "description": ""
    },
    {
      "id": 1132754722,
      "node_id": "MDU6TGFiZWwxMTMyNzU0NzIy",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/need:more-information",
      "name": "need:more-information",
      "color": "db6fa3",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 6,
  "created_at": "2021-07-23T04:20:37Z",
  "updated_at": "2021-11-27T09:08:22Z",
  "closed_at": "2021-11-27T08:40:47Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "Geth version: 1.10.6\r\nOS & Version: Linux\r\n\r\n#### Expected behaviour\r\nIt should recover after restart\r\n\r\n#### Actual behaviour\r\nIt crashes critical error\r\n```\r\nCRIT [07-23|02:45:58.042] Failed to write block data to ancient store err=\"the append operation is out-order\"\r\n```\r\n\r\n#### Steps to reproduce the behaviour\r\nRun this docker command:\r\n```\r\ndocker run -p 8576:8546 -p 8577:8545 -p 30603:30303 --name=geth-mainnet -dti -v /mnt/data/geth:/freezerdata -v /data/geth:/data ethereum-node --datadir=/data/mainnet --datadir.ancient=/freezerdata/mainnet --mainnet --port=3030 --http --http.addr=\"0.0.0.0\" --http.port=8545 --http.api=\"net,web3,eth,debug\" --http.corsdomain=\"*\"  --ws --ws.addr=\"0.0.0.0\" --ws.port=8546 --ws.api=\"net,web3,eth,debug\" --ws.origins=\"*\" --maxpeers=100\r\n```\r\nWhere `datadir` = /mnt/data/geth (150GB space, NVME), and `datadir.ancient` = /data/geth (500GB space, HDD), let it run and fill up datadir, it will fail:\r\n\r\n```\r\nERROR[07-22|17:34:13.403] Low disk space. Gracefully shutting down Geth to prevent database corruption. available=0.00B\r\nINFO [07-22|17:34:13.404] Got interrupt, shutting down...\r\nINFO [07-22|17:34:13.409] HTTP server stopped                      endpoint=[::]:8545\r\nINFO [07-22|17:34:13.411] HTTP server stopped                      endpoint=[::]:8546\r\nINFO [07-22|17:34:13.412] IPC endpoint closed                      url=/data/mainnet/geth.ipc\r\nWARN [07-22|17:34:13.426] Rewinding blockchain                     target=11,183,442\r\nINFO [07-22|17:34:14.142] Loaded most recent local header          number=11,183,442 hash=34736a..9c582c td=18,457,827,358,137,404,225,216 age=8mo3w7h\r\nINFO [07-22|17:34:14.143] Loaded most recent local full block      number=0          hash=d4e567..cb8fa3 td=17,179,869,184                 age=52y3mo2w\r\nINFO [07-22|17:34:14.143] Loaded most recent local fast block      number=11,149,178 hash=68a1b8..0cdce3 td=18,342,756,590,897,755,809,750 age=8mo3w5d\r\nINFO [07-22|17:34:14.143] Loaded last fast-sync pivot marker       number=12,877,447\r\nWARN [07-22|17:34:14.143] Rolled back chain segment                header=11185491->11183442 fast=11149178->11149178 block=0->0 reason=\"syncing canceled (requested)\"\r\nINFO [07-22|17:34:14.150] Imported new block receipts              count=89   elapsed=986.177ms number=11,149,267 hash=2c7533..c7ab96 age=8mo3w5d    size=7.47MiB\r\nINFO [07-22|17:34:14.530] State heal in progress                   accounts=58585@2.81MiB    slots=173,062@13.17MiB codes=42@325.91KiB nodes=801,653@207.50MiB pending=67554\r\nWARN [07-22|17:34:14.539] Synchronisation failed, retrying         err=\"content processing canceled (requested)\"\r\nINFO [07-22|17:34:14.541] Ethereum protocol stopped\r\nINFO [07-22|17:34:14.541] Transaction pool stopped\r\nERROR[07-22|17:34:14.542] Failed to journal state snapshot         err=\"snapshot [0xd7f8974fb5ac78d9ac099b9ad5018bedc2ce0a72dad1827a1709da30580f0544] missing\"\r\nINFO [07-22|17:34:14.543] Writing clean trie cache to disk         path=/data/mainnet/geth/triecache threads=4\r\nINFO [07-22|17:34:14.580] Persisted the clean trie cache           path=/data/mainnet/geth/triecache elapsed=37.285ms\r\nINFO [07-22|17:34:14.581] Blockchain stopped\r\n```\r\n\r\nShutdown the VM, and resize the main `/data/geth` to 300GB,  reboot, let it run then CRIT error:\r\n```\r\nCRIT [07-23|02:45:58.042] Failed to write block data to ancient store err=\"the append operation is out-order\"\r\n```\r\n\r\n/mnt/data/geth/mainnet\r\n```\r\n/mnt/data/geth/mainnet# ls\r\nFLOCK             bodies.0007.cdat  bodies.0015.cdat  bodies.0023.cdat  bodies.0031.cdat  bodies.0039.cdat  bodies.0047.cdat  bodies.0055.cdat  hashes.ridx         receipts.0003.cdat  receipts.0011.cdat  receipts.0019.cdat  receipts.0027.cdat\r\nbodies.0000.cdat  bodies.0008.cdat  bodies.0016.cdat  bodies.0024.cdat  bodies.0032.cdat  bodies.0040.cdat  bodies.0048.cdat  bodies.0056.cdat  headers.0000.cdat   receipts.0004.cdat  receipts.0012.cdat  receipts.0020.cdat  receipts.cidx\r\nbodies.0001.cdat  bodies.0009.cdat  bodies.0017.cdat  bodies.0025.cdat  bodies.0033.cdat  bodies.0041.cdat  bodies.0049.cdat  bodies.0057.cdat  headers.0001.cdat   receipts.0005.cdat  receipts.0013.cdat  receipts.0021.cdat\r\nbodies.0002.cdat  bodies.0010.cdat  bodies.0018.cdat  bodies.0026.cdat  bodies.0034.cdat  bodies.0042.cdat  bodies.0050.cdat  bodies.0058.cdat  headers.0002.cdat   receipts.0006.cdat  receipts.0014.cdat  receipts.0022.cdat\r\nbodies.0003.cdat  bodies.0011.cdat  bodies.0019.cdat  bodies.0027.cdat  bodies.0035.cdat  bodies.0043.cdat  bodies.0051.cdat  bodies.cidx       headers.cidx        receipts.0007.cdat  receipts.0015.cdat  receipts.0023.cdat\r\nbodies.0004.cdat  bodies.0012.cdat  bodies.0020.cdat  bodies.0028.cdat  bodies.0036.cdat  bodies.0044.cdat  bodies.0052.cdat  diffs.0000.rdat   receipts.0000.cdat  receipts.0008.cdat  receipts.0016.cdat  receipts.0024.cdat\r\nbodies.0005.cdat  bodies.0013.cdat  bodies.0021.cdat  bodies.0029.cdat  bodies.0037.cdat  bodies.0045.cdat  bodies.0053.cdat  diffs.ridx        receipts.0001.cdat  receipts.0009.cdat  receipts.0017.cdat  receipts.0025.cdat\r\nbodies.0006.cdat  bodies.0014.cdat  bodies.0022.cdat  bodies.0030.cdat  bodies.0038.cdat  bodies.0046.cdat  bodies.0054.cdat  hashes.0000.rdat  receipts.0002.cdat  receipts.0010.cdat  receipts.0018.cdat  receipts.0026.cdat\r\n```",
  "closed_by": {
    "login": "no-response[bot]",
    "id": 32965360,
    "node_id": "MDM6Qm90MzI5NjUzNjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/26350515?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/no-response%5Bbot%5D",
    "html_url": "https://github.com/apps/no-response",
    "followers_url": "https://api.github.com/users/no-response%5Bbot%5D/followers",
    "following_url": "https://api.github.com/users/no-response%5Bbot%5D/following{/other_user}",
    "gists_url": "https://api.github.com/users/no-response%5Bbot%5D/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/no-response%5Bbot%5D/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/no-response%5Bbot%5D/subscriptions",
    "organizations_url": "https://api.github.com/users/no-response%5Bbot%5D/orgs",
    "repos_url": "https://api.github.com/users/no-response%5Bbot%5D/repos",
    "events_url": "https://api.github.com/users/no-response%5Bbot%5D/events{/privacy}",
    "received_events_url": "https://api.github.com/users/no-response%5Bbot%5D/received_events",
    "type": "Bot",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/23254/reactions",
    "total_count": 1,
    "+1": 1,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/23254/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/885440848",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/23254#issuecomment-885440848",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/23254",
    "id": 885440848,
    "node_id": "IC_kwDOAOvK9840xsFQ",
    "user": {
      "login": "rjl493456442",
      "id": 5959481,
      "node_id": "MDQ6VXNlcjU5NTk0ODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5959481?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rjl493456442",
      "html_url": "https://github.com/rjl493456442",
      "followers_url": "https://api.github.com/users/rjl493456442/followers",
      "following_url": "https://api.github.com/users/rjl493456442/following{/other_user}",
      "gists_url": "https://api.github.com/users/rjl493456442/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rjl493456442/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rjl493456442/subscriptions",
      "organizations_url": "https://api.github.com/users/rjl493456442/orgs",
      "repos_url": "https://api.github.com/users/rjl493456442/repos",
      "events_url": "https://api.github.com/users/rjl493456442/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rjl493456442/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-07-23T07:00:26Z",
    "updated_at": "2021-07-23T07:00:26Z",
    "author_association": "MEMBER",
    "body": "Can you add these diff, recompile the Geth and run again? \r\n\r\n```go\r\ndiff --git a/core/rawdb/freezer.go b/core/rawdb/freezer.go\r\nindex ff8919b59..6b64909ec 100644\r\n--- a/core/rawdb/freezer.go\r\n+++ b/core/rawdb/freezer.go\r\n@@ -205,7 +205,7 @@ func (f *freezer) AppendAncient(number uint64, hash, header, body, receipts, td\r\n        }\r\n        // Ensure the binary blobs we are appending is continuous with freezer.\r\n        if atomic.LoadUint64(&f.frozen) != number {\r\n-               return errOutOrderInsertion\r\n+               return fmt.Errorf(\"%w %d - %d\", errOutOrderInsertion, atomic.LoadUint64(&f.frozen), number)\r\n        }\r\n        // Rollback all inserted data if any insertion below failed to ensure\r\n        // the tables won't out of sync.\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/885440848/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/885540641",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/23254#issuecomment-885540641",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/23254",
    "id": 885540641,
    "node_id": "IC_kwDOAOvK9840yEch",
    "user": {
      "login": "mohamedmansour",
      "id": 68524,
      "node_id": "MDQ6VXNlcjY4NTI0",
      "avatar_url": "https://avatars.githubusercontent.com/u/68524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mohamedmansour",
      "html_url": "https://github.com/mohamedmansour",
      "followers_url": "https://api.github.com/users/mohamedmansour/followers",
      "following_url": "https://api.github.com/users/mohamedmansour/following{/other_user}",
      "gists_url": "https://api.github.com/users/mohamedmansour/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mohamedmansour/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mohamedmansour/subscriptions",
      "organizations_url": "https://api.github.com/users/mohamedmansour/orgs",
      "repos_url": "https://api.github.com/users/mohamedmansour/repos",
      "events_url": "https://api.github.com/users/mohamedmansour/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mohamedmansour/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-07-23T10:16:48Z",
    "updated_at": "2021-07-23T10:16:48Z",
    "author_association": "MEMBER",
    "body": "@rjl493456442  ok updated that and will see if it fails again, I already increased the VM size to one tier more. I am doing this for watchtheburn.com (trying to sync)",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/885540641/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/886135604",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/23254#issuecomment-886135604",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/23254",
    "id": 886135604,
    "node_id": "IC_kwDOAOvK98400Vs0",
    "user": {
      "login": "XWJACK",
      "id": 15156226,
      "node_id": "MDQ6VXNlcjE1MTU2MjI2",
      "avatar_url": "https://avatars.githubusercontent.com/u/15156226?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/XWJACK",
      "html_url": "https://github.com/XWJACK",
      "followers_url": "https://api.github.com/users/XWJACK/followers",
      "following_url": "https://api.github.com/users/XWJACK/following{/other_user}",
      "gists_url": "https://api.github.com/users/XWJACK/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/XWJACK/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/XWJACK/subscriptions",
      "organizations_url": "https://api.github.com/users/XWJACK/orgs",
      "repos_url": "https://api.github.com/users/XWJACK/repos",
      "events_url": "https://api.github.com/users/XWJACK/events{/privacy}",
      "received_events_url": "https://api.github.com/users/XWJACK/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-07-25T02:01:54Z",
    "updated_at": "2021-07-25T02:01:54Z",
    "author_association": "CONTRIBUTOR",
    "body": "Try to add the following parameters\r\n\r\n```\r\n--datadir.minfreedisk value         Minimum free disk space in MB, once reached triggers auto shut down (default = --cache.gc converted to MB, 0 = disabled)\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/886135604/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/953593292",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/23254#issuecomment-953593292",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/23254",
    "id": 953593292,
    "node_id": "IC_kwDOAOvK98441q3M",
    "user": {
      "login": "ligi",
      "id": 111600,
      "node_id": "MDQ6VXNlcjExMTYwMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/111600?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ligi",
      "html_url": "https://github.com/ligi",
      "followers_url": "https://api.github.com/users/ligi/followers",
      "following_url": "https://api.github.com/users/ligi/following{/other_user}",
      "gists_url": "https://api.github.com/users/ligi/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ligi/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ligi/subscriptions",
      "organizations_url": "https://api.github.com/users/ligi/orgs",
      "repos_url": "https://api.github.com/users/ligi/repos",
      "events_url": "https://api.github.com/users/ligi/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ligi/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-10-28T07:56:21Z",
    "updated_at": "2021-10-28T07:56:21Z",
    "author_association": "MEMBER",
    "body": "Did you experience the problem again?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/953593292/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/980525637",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/23254#issuecomment-980525637",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/23254",
    "id": 980525637,
    "node_id": "IC_kwDOAOvK9846caJF",
    "user": {
      "login": "no-response[bot]",
      "id": 32965360,
      "node_id": "MDM6Qm90MzI5NjUzNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/26350515?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/no-response%5Bbot%5D",
      "html_url": "https://github.com/apps/no-response",
      "followers_url": "https://api.github.com/users/no-response%5Bbot%5D/followers",
      "following_url": "https://api.github.com/users/no-response%5Bbot%5D/following{/other_user}",
      "gists_url": "https://api.github.com/users/no-response%5Bbot%5D/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/no-response%5Bbot%5D/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/no-response%5Bbot%5D/subscriptions",
      "organizations_url": "https://api.github.com/users/no-response%5Bbot%5D/orgs",
      "repos_url": "https://api.github.com/users/no-response%5Bbot%5D/repos",
      "events_url": "https://api.github.com/users/no-response%5Bbot%5D/events{/privacy}",
      "received_events_url": "https://api.github.com/users/no-response%5Bbot%5D/received_events",
      "type": "Bot",
      "site_admin": false
    },
    "created_at": "2021-11-27T08:40:46Z",
    "updated_at": "2021-11-27T08:40:46Z",
    "author_association": "NONE",
    "body": "This issue has been automatically closed because there has been no response to our request for more information from the original author. With only the information that is currently in the issue, we don't have enough information to take action. Please reach out if you have more relevant information or answers to our questions so that we can investigate further.\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/980525637/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
