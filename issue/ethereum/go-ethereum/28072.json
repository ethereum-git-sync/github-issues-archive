{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28072",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28072/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28072/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28072/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/28072",
  "id": 1885300279,
  "node_id": "I_kwDOAOvK985wX2Y3",
  "number": 28072,
  "title": "Fail to redeploy contracts in some cases",
  "user": {
    "login": "YanhuiJessica",
    "id": 52900008,
    "node_id": "MDQ6VXNlcjUyOTAwMDA4",
    "avatar_url": "https://avatars.githubusercontent.com/u/52900008?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/YanhuiJessica",
    "html_url": "https://github.com/YanhuiJessica",
    "followers_url": "https://api.github.com/users/YanhuiJessica/followers",
    "following_url": "https://api.github.com/users/YanhuiJessica/following{/other_user}",
    "gists_url": "https://api.github.com/users/YanhuiJessica/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/YanhuiJessica/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/YanhuiJessica/subscriptions",
    "organizations_url": "https://api.github.com/users/YanhuiJessica/orgs",
    "repos_url": "https://api.github.com/users/YanhuiJessica/repos",
    "events_url": "https://api.github.com/users/YanhuiJessica/events{/privacy}",
    "received_events_url": "https://api.github.com/users/YanhuiJessica/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 72233650,
      "node_id": "MDU6TGFiZWw3MjIzMzY1MA==",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/type:bug",
      "name": "type:bug",
      "color": "FF5E5E",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2023-09-07T07:41:34Z",
  "updated_at": "2023-09-11T08:26:30Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "#### System information\r\n\r\nGeth version: `1.13.0-unstable-2e02c1ff`\r\nOS & Version: `ethereum/client-go:latest`\r\n\r\nThe environment is based on [DownUnderCTF/eth-challenge-infra](https://github.com/DownUnderCTF/eth-challenge-infra/tree/main/geth), but `ethereum/client-go:v1.11.5` is changed to `ethereum/client-go:latest`\r\n\r\nBelow code is following [Deploy Different Contracts at the Same Address](https://solidity-by-example.org/hacks/deploy-different-contracts-same-address/).\r\n\r\n```js\r\npragma solidity 0.8.19;\r\n\r\ncontract DeployerDeployer {\r\n    event Log(address addr);\r\n\r\n    function deploy1() external {\r\n        bytes32 salt = keccak256(abi.encode(uint(123)));\r\n        address addr = address(new Deployer1{salt: salt}());\r\n        emit Log(addr);\r\n    }\r\n\r\n    function deploy2() external {\r\n        bytes32 salt = keccak256(abi.encode(uint(123)));\r\n        address addr = address(new Deployer2{salt: salt}());\r\n        emit Log(addr);\r\n    }\r\n}\r\n\r\ncontract Deployer1 {\r\n    event Log(address addr);\r\n\r\n    function deploy(bytes memory bytecode) external {\r\n        address addr;\r\n        assembly {\r\n            addr := create(0, add(bytecode, 0x20), mload(bytecode))\r\n        }\r\n        emit Log(addr);\r\n    }\r\n\r\n    function kill() external {\r\n        selfdestruct(payable(address(0)));\r\n    }\r\n}\r\n\r\ncontract Deployer2 {\r\n    function deploy(bytes memory bytecode) external {\r\n        address addr;\r\n        assembly {\r\n            addr := create(0, add(bytecode, 0x20), mload(bytecode))\r\n        }\r\n        require(addr != address(0));\r\n    }\r\n\r\n    function kill() external {\r\n        selfdestruct(payable(address(0)));\r\n    }\r\n}\r\n```\r\n\r\n#### Expected behaviour\r\n\r\nIt's expected to deploy different contracts at the same address whether using `Deployer1` or `Deployer2`.\r\n\r\n#### Actual behaviour\r\n\r\n`Deployer1` fails to redeploy contracts in some cases.\r\n\r\n#### Steps to reproduce the behaviour\r\n\r\n- Deploy `DeployerDeployer`\r\n\r\n**Deployer1**\r\n\r\n- `DeployerDeployer.deploy1()`\r\n- `Deployer1.deploy(hex\"6002600c600039600d6000f330ff\")` deploy a 13-bytes contract with SELFDESTRUCT\r\n- Destruct the contract deployed by Deployer1 and call `Deployer1.kill()`\r\n- `Deployer1.deploy(hex\"6002600d6000396105396000f330ff\")` deploy a 1337-bytes contract with SELFDESTRUCT\r\n  - The address in the event `Log` is `address(0)`, indicating that the deployment failed\r\n\r\n**Deployer2**\r\n\r\n- `DeployerDeployer.deploy2()`\r\n- `Deployer2.deploy(hex\"6002600c600039600d6000f330ff\")` deploy a 13-bytes contract with SELFDESTRUCT\r\n- Destruct the contract deployed by Deployer2 and call `Deployer2.kill()`\r\n- `Deployer2.deploy(hex\"6002600d6000396105396000f330ff\")` deploy a 1337-bytes contract with SELFDESTRUCT\r\n  - There is a require statement to check if the deployment fails\r\n  - The contract can be successfully deployed",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28072/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28072/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1709686288",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/28072#issuecomment-1709686288",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28072",
    "id": 1709686288,
    "node_id": "IC_kwDOAOvK985l574Q",
    "user": {
      "login": "MariusVanDerWijden",
      "id": 16664698,
      "node_id": "MDQ6VXNlcjE2NjY0Njk4",
      "avatar_url": "https://avatars.githubusercontent.com/u/16664698?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MariusVanDerWijden",
      "html_url": "https://github.com/MariusVanDerWijden",
      "followers_url": "https://api.github.com/users/MariusVanDerWijden/followers",
      "following_url": "https://api.github.com/users/MariusVanDerWijden/following{/other_user}",
      "gists_url": "https://api.github.com/users/MariusVanDerWijden/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MariusVanDerWijden/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MariusVanDerWijden/subscriptions",
      "organizations_url": "https://api.github.com/users/MariusVanDerWijden/orgs",
      "repos_url": "https://api.github.com/users/MariusVanDerWijden/repos",
      "events_url": "https://api.github.com/users/MariusVanDerWijden/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MariusVanDerWijden/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-09-07T08:17:25Z",
    "updated_at": "2023-09-07T08:17:25Z",
    "author_association": "MEMBER",
    "body": "This looks like its probably not an issue of geth.\r\nWe would need the actual error message that the deployment fails with to understand whats going on",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1709686288/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1709773896",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/28072#issuecomment-1709773896",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28072",
    "id": 1709773896,
    "node_id": "IC_kwDOAOvK985l6RRI",
    "user": {
      "login": "YanhuiJessica",
      "id": 52900008,
      "node_id": "MDQ6VXNlcjUyOTAwMDA4",
      "avatar_url": "https://avatars.githubusercontent.com/u/52900008?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/YanhuiJessica",
      "html_url": "https://github.com/YanhuiJessica",
      "followers_url": "https://api.github.com/users/YanhuiJessica/followers",
      "following_url": "https://api.github.com/users/YanhuiJessica/following{/other_user}",
      "gists_url": "https://api.github.com/users/YanhuiJessica/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/YanhuiJessica/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/YanhuiJessica/subscriptions",
      "organizations_url": "https://api.github.com/users/YanhuiJessica/orgs",
      "repos_url": "https://api.github.com/users/YanhuiJessica/repos",
      "events_url": "https://api.github.com/users/YanhuiJessica/events{/privacy}",
      "received_events_url": "https://api.github.com/users/YanhuiJessica/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-09-07T09:06:09Z",
    "updated_at": "2023-09-07T11:08:06Z",
    "author_association": "NONE",
    "body": "I tried Remix VM (Shanghai) and ganache v7.8.0, both can redeploy the 1337-byte contract successfully via `Deploy1.deploy()`. And the [bytecode](https://www.evm.codes/playground?fork=shanghai&unit=Wei&callData=0x007743600000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000f6002600d6000396105396000f330ff0000000000000000000000000000000000&codeType=Bytecode&code='uWl234Wnr10ZvLJ3~rRZtRuekcW627743C4r3aZW6341c0e1b514r56Zmvr54JW3u3EUr4fKUo1cyruyTmr5era8yTmt8n1hVktf0X7fb8aTd6d8ca1be30bfec34d8f97e55f0f0fd9eeb7fb46eQ0516363d4cfe1ad6il1r9cKUoa6yl1WKQUanwHF16Pmtl1XUyvvvvtCf19N6p7f4e487b71ggggggTt52u41J52u24tfdmq29GEii10M17nq48Zq47BWljqmrc2yXq67ssq20yKXHMnq87Zq86BqUGXhEpsiV37tVV0njqbfqbaYq6cyq51yXDn2hEYYYk11nqdbZqdardbOqe6YD5q9dyL939jsN2oQZo02rd6OiRo13Ysh8Cqac_hsYQ12no32Zo31rccOtskR67Si11noLZo4frd1Oo5cYD5kqee_Fs16ptoUso65ypoa0io85ys525wHhskXobbtVkYo97y92I56fea2646970667Rs21220P0d4Qd88613w99d6b87RT7065de9u7a148fe6fb0469997c79aQ0fab264736f6c6343xi3T33'~610zPPPPy56mxT0w0LvtWfdmu60t6xD2r~0q~1pXKXyo~2n15m5blu405k01j25wLHi81hu20gxxx_yI92IHZ57Y84X9wW80V83U90T00SzzR35Q03PffOymNCfVk1M67Ss11L50K91Ju04I9nwHytGsre0yF73SSzEikDs8Cu1Brf1O%01BCDEFGHIJKLMNOPQRSTUVWXYZ_ghijklmnopqrstuvwxyz~_) seems fine.\r\n\r\nSince `create()` does not throw an error, the transaction is successful. I checked geth log, nothing interesting. Where can I find more detailed logs?\r\n\r\n```bash\r\n# 0x36f16693020DdFc3d63c129f708C0591681a2BC9 Deploy1 address\r\n$ cast send --private-key $PRIVATE_KEY --legacy 0x36f16693020DdFc3d63c129f708C0591681a2BC9 \"deploy(bytes)\" 0x6002600d6000396105396000f330ff\r\n\r\nblockHash               0xe802f5dd5083375305960f86f57831092541dbe61f6b5af251f72eab85468412\r\nblockNumber             385\r\ncontractAddress         \r\ncumulativeGasUsed       134676\r\neffectiveGasPrice       1000000000\r\ngasUsed                 134676\r\nlogs                    [{\"address\":\"0x36f16693020ddfc3d63c129f708c0591681a2bc9\",\"topics\":[\"0xb8a00d6d8ca1be30bfec34d8f97e55f0f0fd9eeb7fb46e030516363d4cfe1ad6\"],\"data\":\"0x0000000000000000000000000000000000000000000000000000000000000000\",\"blockHash\":\"0xe802f5dd5083375305960f86f57831092541dbe61f6b5af251f72eab85468412\",\"blockNumber\":\"0x181\",\"transactionHash\":\"0x1d68851a5b004a982013bfd9770183ca0cdaf5e25ac0400ac0402f86e4c11e6f\",\"transactionIndex\":\"0x0\",\"logIndex\":\"0x0\",\"removed\":false}]\r\nlogsBloom               0x00000000000000001000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000080000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\nroot                    \r\nstatus                  1\r\ntransactionHash         0x1d68851a5b004a982013bfd9770183ca0cdaf5e25ac0400ac0402f86e4c11e6f\r\ntransactionIndex        0\r\ntype                    0\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1709773896/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1713296420",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/28072#issuecomment-1713296420",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28072",
    "id": 1713296420,
    "node_id": "IC_kwDOAOvK985mHtQk",
    "user": {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-09-11T07:10:54Z",
    "updated_at": "2023-09-11T07:10:54Z",
    "author_association": "MEMBER",
    "body": "You can check the execution step by step using geth's tracing output, e.g `debug_standardTraceBlockToFile`, and using tools like https://github.com/holiman/goevmlab#traceview to step through and analyze what happens. ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1713296420/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1713409358",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/28072#issuecomment-1713409358",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28072",
    "id": 1713409358,
    "node_id": "IC_kwDOAOvK985mII1O",
    "user": {
      "login": "YanhuiJessica",
      "id": 52900008,
      "node_id": "MDQ6VXNlcjUyOTAwMDA4",
      "avatar_url": "https://avatars.githubusercontent.com/u/52900008?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/YanhuiJessica",
      "html_url": "https://github.com/YanhuiJessica",
      "followers_url": "https://api.github.com/users/YanhuiJessica/followers",
      "following_url": "https://api.github.com/users/YanhuiJessica/following{/other_user}",
      "gists_url": "https://api.github.com/users/YanhuiJessica/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/YanhuiJessica/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/YanhuiJessica/subscriptions",
      "organizations_url": "https://api.github.com/users/YanhuiJessica/orgs",
      "repos_url": "https://api.github.com/users/YanhuiJessica/repos",
      "events_url": "https://api.github.com/users/YanhuiJessica/events{/privacy}",
      "received_events_url": "https://api.github.com/users/YanhuiJessica/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-09-11T08:26:30Z",
    "updated_at": "2023-09-11T08:26:30Z",
    "author_association": "NONE",
    "body": "In the redeployment of deploy1, the CREATE opcode returns `0x0` while the creation works in the redeployment of deploy2.\r\n**Deploy1**\r\n```\r\n{\"pc\":107,\"op\":240,\"gas\":\"0x1b600\",\"gasCost\":\"0x7d00\",\"memSize\":224,\"stack\":[\"0x774360\",\"0x54\",\"0x80\",\"0x0\",\"0xf\",\"0xa0\",\"0x0\"],\"depth\":1,\"refund\":0,\"opName\":\"CREATE\"}\r\n{\"pc\":108,\"op\":144,\"gas\":\"0x4e4\",\"gasCost\":\"0x3\",\"memSize\":224,\"stack\":[\"0x774360\",\"0x54\",\"0x80\",\"0x0\",\"0x0\"],\"depth\":1,\"refund\":0,\"opName\":\"SWAP1\"}\r\n```\r\n[deploy1_deploy.log](https://github.com/ethereum/go-ethereum/files/12573809/deploy1_deploy.log)\r\n[deploy1_redeploy.log](https://github.com/ethereum/go-ethereum/files/12573806/deploy1_redeploy.log)\r\n**Deploy2**\r\n```js\r\n{\"pc\":107,\"op\":240,\"gas\":\"0x4a2b4\",\"gasCost\":\"0x7d00\",\"memSize\":224,\"stack\":[\"0x774360\",\"0x54\",\"0x80\",\"0x0\",\"0xf\",\"0xa0\",\"0x0\"],\"depth\":1,\"refund\":0,\"opName\":\"CREATE\"}\r\n{\"pc\":108,\"op\":144,\"gas\":\"0x1096\",\"gasCost\":\"0x3\",\"memSize\":224,\"stack\":[\"0x774360\",\"0x54\",\"0x80\",\"0x0\",\"0xbd587abaae95e03c4695c29470fcd8625b72dbcf\"],\"depth\":1,\"refund\":0,\"opName\":\"SWAP1\"}\r\n```\r\n[deploy2_deploy.log](https://github.com/ethereum/go-ethereum/files/12573808/deploy2_deploy.log)\r\n[deploy2_redeploy.log](https://github.com/ethereum/go-ethereum/files/12573807/deploy2_redeploy.log)",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1713409358/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
