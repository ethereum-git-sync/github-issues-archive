{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/17606",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/17606/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/17606/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/17606/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/17606",
  "id": 358148327,
  "node_id": "MDU6SXNzdWUzNTgxNDgzMjc=",
  "number": 17606,
  "title": "Nonce reuse when balance too low to send transaction",
  "user": {
    "login": "FreekPaans",
    "id": 3660777,
    "node_id": "MDQ6VXNlcjM2NjA3Nzc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3660777?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/FreekPaans",
    "html_url": "https://github.com/FreekPaans",
    "followers_url": "https://api.github.com/users/FreekPaans/followers",
    "following_url": "https://api.github.com/users/FreekPaans/following{/other_user}",
    "gists_url": "https://api.github.com/users/FreekPaans/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/FreekPaans/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/FreekPaans/subscriptions",
    "organizations_url": "https://api.github.com/users/FreekPaans/orgs",
    "repos_url": "https://api.github.com/users/FreekPaans/repos",
    "events_url": "https://api.github.com/users/FreekPaans/events{/privacy}",
    "received_events_url": "https://api.github.com/users/FreekPaans/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2018-09-07T17:21:36Z",
  "updated_at": "2018-09-10T14:50:35Z",
  "closed_at": "2018-09-10T14:50:35Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "Not sure if this is actually a bug/problem/undesired, but ran into it and didn't find it documented anywhere.\r\n\r\nWhen you send 2 transactions that sum to an amount that you don't have the balance for, but you do have the balance for the individual transaction, geth will accept both transactions.\r\n\r\nExample:\r\n\r\nBalance 1 eth\r\nTx1: send 0.6eth\r\nTx2: send 0.6eth\r\n\r\nGeth will accept both transactions, but drop the Tx2 when the first transaction is mined. Any new transaction you'll send will use the nonce for Tx2.\r\n\r\nI've traced this down to `txPool.validateTx` using the `currentState` to check the balance. Using `pendingState` would probably solve this. But not sure if this is by design or not. Either way, the fact that this happens is logged at `TRACE` in `txPool.demoteUnexecutables`: `log.Trace(\"Removed unpayable pending transaction\", \"hash\", hash)`. It might be better to log this at a higher level since it seems kind of important.\r\n\r\n#### System information\r\n\r\nGeth version: 1.8.3 (seen on other versions as well, checked code on 1.8.15)\r\nOS & Version: Ubuntu 16.04\r\n\r\n#### Expected behaviour\r\n\r\nNot sure.\r\n\r\n#### Actual behaviour\r\n\r\nBoth are accepted.\r\n",
  "closed_by": {
    "login": "FreekPaans",
    "id": 3660777,
    "node_id": "MDQ6VXNlcjM2NjA3Nzc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3660777?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/FreekPaans",
    "html_url": "https://github.com/FreekPaans",
    "followers_url": "https://api.github.com/users/FreekPaans/followers",
    "following_url": "https://api.github.com/users/FreekPaans/following{/other_user}",
    "gists_url": "https://api.github.com/users/FreekPaans/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/FreekPaans/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/FreekPaans/subscriptions",
    "organizations_url": "https://api.github.com/users/FreekPaans/orgs",
    "repos_url": "https://api.github.com/users/FreekPaans/repos",
    "events_url": "https://api.github.com/users/FreekPaans/events{/privacy}",
    "received_events_url": "https://api.github.com/users/FreekPaans/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/17606/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/17606/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/419872570",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/17606#issuecomment-419872570",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/17606",
    "id": 419872570,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQxOTg3MjU3MA==",
    "user": {
      "login": "karalabe",
      "id": 129561,
      "node_id": "MDQ6VXNlcjEyOTU2MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/karalabe",
      "html_url": "https://github.com/karalabe",
      "followers_url": "https://api.github.com/users/karalabe/followers",
      "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
      "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
      "organizations_url": "https://api.github.com/users/karalabe/orgs",
      "repos_url": "https://api.github.com/users/karalabe/repos",
      "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
      "received_events_url": "https://api.github.com/users/karalabe/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-09-10T10:55:15Z",
    "updated_at": "2018-09-10T10:55:15Z",
    "author_association": "MEMBER",
    "body": "This is working as intended. There's no way to know how much your balance will be after some number of transaction executions, so we can only take into consideration your current balance (yes, we could try to track some virtual balances, but there's an awful lot of things that could go wrong to the point where currently it's not worth the pain).\r\n\r\nAs for removing transactions that fail some preconditions, that happens all the time. Raising it to info or warning level would just flood all people's logs with superfluous messages. We perhaps could do if for local accounts though, since the user might be more interested in those.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/419872570/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/419941341",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/17606#issuecomment-419941341",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/17606",
    "id": 419941341,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQxOTk0MTM0MQ==",
    "user": {
      "login": "FreekPaans",
      "id": 3660777,
      "node_id": "MDQ6VXNlcjM2NjA3Nzc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3660777?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/FreekPaans",
      "html_url": "https://github.com/FreekPaans",
      "followers_url": "https://api.github.com/users/FreekPaans/followers",
      "following_url": "https://api.github.com/users/FreekPaans/following{/other_user}",
      "gists_url": "https://api.github.com/users/FreekPaans/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/FreekPaans/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/FreekPaans/subscriptions",
      "organizations_url": "https://api.github.com/users/FreekPaans/orgs",
      "repos_url": "https://api.github.com/users/FreekPaans/repos",
      "events_url": "https://api.github.com/users/FreekPaans/events{/privacy}",
      "received_events_url": "https://api.github.com/users/FreekPaans/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-09-10T14:50:35Z",
    "updated_at": "2018-09-10T14:50:35Z",
    "author_association": "NONE",
    "body": "@karalabe fair enough. Local accounts being logged a bit higher seems like a good idea. Guess this issue can be closed.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/419941341/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
