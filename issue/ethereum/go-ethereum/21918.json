{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21918",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21918/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21918/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21918/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/21918",
  "id": 752938930,
  "node_id": "MDU6SXNzdWU3NTI5Mzg5MzA=",
  "number": 21918,
  "title": "Geth loosing 2d history on every restart (docker)",
  "user": {
    "login": "mgcrea",
    "id": 108273,
    "node_id": "MDQ6VXNlcjEwODI3Mw==",
    "avatar_url": "https://avatars.githubusercontent.com/u/108273?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mgcrea",
    "html_url": "https://github.com/mgcrea",
    "followers_url": "https://api.github.com/users/mgcrea/followers",
    "following_url": "https://api.github.com/users/mgcrea/following{/other_user}",
    "gists_url": "https://api.github.com/users/mgcrea/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mgcrea/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mgcrea/subscriptions",
    "organizations_url": "https://api.github.com/users/mgcrea/orgs",
    "repos_url": "https://api.github.com/users/mgcrea/repos",
    "events_url": "https://api.github.com/users/mgcrea/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mgcrea/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 72233650,
      "node_id": "MDU6TGFiZWw3MjIzMzY1MA==",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/type:bug",
      "name": "type:bug",
      "color": "FF5E5E",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2020-11-29T15:18:25Z",
  "updated_at": "2022-08-08T09:25:11Z",
  "closed_at": "2020-11-29T16:46:47Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "Not sure if this is normal/expected or if I have something badly configured somewhere but loosing 2 whole days of history on every restart seems a bit extreme!\r\n\r\n#### System information\r\n\r\nGeth version: `Geth/v1.9.24-stable-cc05b050/linux-amd64/go1.15.5`\r\nOS & Version:  `Ubuntu Docker`\r\n\r\nCompose file:\r\n\r\n```yaml\r\nversion: \"2.3\"\r\nservices:\r\n  geth:\r\n    image: ethereum/client-go:stable\r\n    restart: always\r\n    container_name: geth\r\n    hostname: geth\r\n    environment:\r\n      - TZ=$TZ\r\n    ports:\r\n      - \"30303:30303\"\r\n    expose:\r\n      - \"8545\"\r\n      - \"8546\"\r\n      - \"6060\"\r\n      - \"8080\"\r\n    volumes:\r\n      - \"./volumes/geth:/root/.ethereum\"\r\n    command:\r\n      - --nousb\r\n      - --http\r\n      - --http.addr=0.0.0.0\r\n      - --http.port=8545\r\n      - --http.vhosts=*\r\n      - --ws\r\n      - --ws.addr=0.0.0.0\r\n      - --ws.port=8546\r\n      - --ws.origins=\"*\"\r\n      - --metrics\r\n      - --metrics.addr=0.0.0.0\r\n      - --metrics.port=6060\r\n      - --pprof\r\n      - --pprof.addr=0.0.0.0\r\n      - --pprof.port=8080\r\n```\r\n\r\n#### Expected behaviour\r\n\r\n`docker-compose restart` should not have to resync 2 days of history\r\n\r\n#### Actual behaviour\r\n\r\nEvery container restart seem to drop the last two days of history.\r\n\r\n#### Steps to reproduce the behaviour\r\n\r\n```\r\ndocker-compose restart\r\n```\r\n\r\n#### Backtrace\r\n\r\n````\r\ngeth    | INFO [11-29|14:54:17.308] Deep froze chain segment                 blocks=6    elapsed=25.519ms  number=11264285 hash=\"22c72d…a39a65\"\r\ngeth    | INFO [11-29|14:54:20.735] Imported new chain segment               blocks=1    txs=197  mgas=12.490  elapsed=531.815ms mgasps=23.486  number=11354286 hash=\"ad6960…4bfd8b\" dirty=1022.30MiB\r\ngeth    | INFO [11-29|14:54:21.326] Imported new chain segment               blocks=1    txs=105  mgas=12.487  elapsed=215.925ms mgasps=57.829  number=11354287 hash=\"fb77be…81ae2f\" dirty=1022.10MiB\r\ngeth    | INFO [11-29|14:54:52.092] Imported new chain segment               blocks=1    txs=212  mgas=12.485  elapsed=529.137ms mgasps=23.594  number=11354288 hash=\"9ade1f…2b82a8\" dirty=1022.42MiB\r\ngeth    | INFO [11-29|14:55:00.460] Imported new chain segment               blocks=1    txs=153  mgas=12.469  elapsed=808.680ms mgasps=15.419  number=11354289 hash=\"d32b79…b07818\" dirty=1022.39MiB\r\ngeth    | INFO [11-29|14:55:01.278] Downloader queue stats                   receiptTasks=0 blockTasks=0 itemSize=32.82KiB throttle=1998\r\ngeth    | INFO [11-29|14:55:01.409] Imported new chain segment               blocks=1    txs=101  mgas=12.483  elapsed=942.835ms mgasps=13.240  number=11354290 hash=\"467ea7…bbd3cd\" dirty=1022.39MiB\r\ngeth    | INFO [11-29|14:55:17.325] Deep froze chain segment                 blocks=5    elapsed=16.554ms  number=11264290 hash=\"3e074d…8b5d97\"\r\ngeth    | INFO [11-29|14:55:45.211] Imported new chain segment               blocks=1    txs=209  mgas=12.450  elapsed=191.345ms mgasps=65.067  number=11354291 hash=\"013739…4a69dc\" dirty=1022.42MiB\r\ngeth    | INFO [11-29|14:56:17.621] Imported new chain segment               blocks=1    txs=204  mgas=12.473  elapsed=162.549ms mgasps=76.734  number=11354292 hash=\"41673c…daf0d3\" dirty=1022.41MiB\r\ngeth    | INFO [11-29|14:56:31.823] Imported new chain segment               blocks=1    txs=217  mgas=12.445  elapsed=422.572ms mgasps=29.450  number=11354293 hash=\"9ea70a…d095ac\" dirty=1022.58MiB\r\ngeth    | INFO [11-29|14:57:04.584] Got interrupt, shutting down... \r\ngeth    | INFO [11-29|14:57:05.085] HTTP server stopped                      endpoint=[::]:8545\r\ngeth    | INFO [11-29|14:57:05.586] HTTP server stopped                      endpoint=[::]:8546\r\ngeth    | INFO [11-29|14:57:05.586] IPC endpoint closed                      url=/root/.ethereum/geth.ipc\r\ngeth    | INFO [11-29|14:57:05.687] Ethereum protocol stopped \r\ngeth    | INFO [11-29|14:57:05.688] Transaction pool stopped \r\ngeth    | INFO [11-29|14:57:05.688] Writing cached state to disk             block=11354293 hash=\"9ea70a…d095ac\" root=\"028cd6…269591\"\r\ngeth    | INFO [11-29|14:57:16.282] Starting pprof server                    addr=http://0.0.0.0:8080/debug/pprof\r\ngeth    | INFO [11-29|14:57:16.282] Starting Geth on Ethereum mainnet... \r\ngeth    | INFO [11-29|14:57:16.282] Bumping default cache on mainnet         provided=1024 updated=4096\r\ngeth    | INFO [11-29|14:57:16.283] Enabling metrics collection \r\ngeth    | INFO [11-29|14:57:16.285] Enabling stand-alone metrics HTTP endpoint address=0.0.0.0:6060\r\ngeth    | INFO [11-29|14:57:16.285] Starting metrics server                  addr=http://0.0.0.0:6060/debug/metrics\r\ngeth    | INFO [11-29|14:57:16.286] Maximum peer count                       ETH=50 LES=0 total=50\r\ngeth    | INFO [11-29|14:57:16.286] Smartcard socket not found, disabling    err=\"stat /run/pcscd/pcscd.comm: no such file or directory\"\r\ngeth    | INFO [11-29|14:57:16.286] Set global gas cap                       cap=25000000\r\ngeth    | INFO [11-29|14:57:16.287] Allocated trie memory caches             clean=1023.00MiB dirty=1024.00MiB\r\ngeth    | INFO [11-29|14:57:16.287] Allocated cache and file handles         database=/root/.ethereum/geth/chaindata cache=2.00GiB handles=524288\r\ngeth    | INFO [11-29|14:57:24.956] Opened ancient database                  database=/root/.ethereum/geth/chaindata/ancient\r\ngeth    | INFO [11-29|14:57:25.009] Deep froze chain segment                 blocks=3 elapsed=19.845ms number=11264293 hash=\"cd6f2b…41ac09\"\r\ngeth    | INFO [11-29|14:57:25.017] Initialised chain configuration          config=\"{ChainID: 1 Homestead: 1150000 DAO: 1920000 DAOSupport: true EIP150: 2463000 EIP155: 2675000 EIP158: 2675000 Byzantium: 4370000 Constantinople: 7280000 Petersburg: 7280000 Istanbul: 9069000, Muir Glacier: 9200000, YOLO v2: <nil>, Engine: ethash}\"\r\ngeth    | INFO [11-29|14:57:25.017] Disk storage enabled for ethash caches   dir=/root/.ethereum/geth/ethash count=3\r\ngeth    | INFO [11-29|14:57:25.017] Disk storage enabled for ethash DAGs     dir=/root/.ethash               count=2\r\ngeth    | INFO [11-29|14:57:25.019] Initialising Ethereum protocol           versions=\"[65 64 63]\" network=1 dbversion=8\r\ngeth    | INFO [11-29|14:57:29.485] Loaded most recent local header          number=11354293 hash=\"9ea70a…d095ac\" td=19044345389350901666652 age=1m12s\r\ngeth    | INFO [11-29|14:57:29.485] Loaded most recent local full block      number=11354293 hash=\"9ea70a…d095ac\" td=19044345389350901666652 age=1m12s\r\ngeth    | INFO [11-29|14:57:29.485] Loaded most recent local fast block      number=11354293 hash=\"9ea70a…d095ac\" td=19044345389350901666652 age=1m12s\r\ngeth    | INFO [11-29|14:57:29.486] Loaded last fast-sync pivot marker       number=11340588\r\ngeth    | WARN [11-29|14:57:29.489] Head state missing, repairing            number=11354293 hash=\"9ea70a…d095ac\"\r\ngeth    | INFO [11-29|14:57:48.615] Loaded most recent local header          number=11354293 hash=\"9ea70a…d095ac\" td=19044345389350901666652 age=1m31s\r\ngeth    | INFO [11-29|14:57:48.615] Loaded most recent local full block      number=11341107 hash=\"4a9cbc…26dbf9\" td=18997946999609831568983 age=2d20m49s\r\ngeth    | INFO [11-29|14:57:48.615] Loaded most recent local fast block      number=11354293 hash=\"9ea70a…d095ac\" td=19044345389350901666652 age=1m31s\r\ngeth    | INFO [11-29|14:57:48.615] Loaded last fast-sync pivot marker       number=11340588\r\ngeth    | INFO [11-29|14:57:48.620] Loaded local transaction journal         transactions=0 dropped=0\r\ngeth    | INFO [11-29|14:57:48.622] Regenerated local transaction journal    transactions=0 accounts=0\r\ngeth    | WARN [11-29|14:57:48.623] Switch sync mode from fast sync to full sync \r\ngeth    | INFO [11-29|14:57:48.624] Starting peer-to-peer node               instance=Geth/v1.9.24-stable-cc05b050/linux-amd64/go1.15.5\r\ngeth    | INFO [11-29|14:57:48.766] New local node record                    seq=26 id=aa4e3101998a4053 ip=127.0.0.1 udp=30303 tcp=30303\r\ngeth    | INFO [11-29|14:57:48.767] Started P2P networking                   self=enode://4d4df4a1e3de41faa9c7e0d94071f4b823279783a5c5c55c0b70ddc67a4f152de15e0a8a42725186a3579cd8e91144c7d5590dd33f9b425da255f1ec358339e2@127.0.0.1:30303\r\ngeth    | INFO [11-29|14:57:48.767] IPC endpoint opened                      url=/root/.ethereum/geth.ipc\r\ngeth    | INFO [11-29|14:57:48.768] HTTP server started                      endpoint=[::]:8545 cors= vhosts=*\r\ngeth    | INFO [11-29|14:57:48.768] WebSocket enabled                        url=ws://[::]:8546\r\ngeth    | INFO [11-29|14:57:58.766] New local node record                    seq=27 id=aa4e3101998a4053 ip=86.195.xxx.yyy udp=30303 tcp=30303\r\ngeth    | INFO [11-29|14:57:59.108] Looking for peers                        peercount=0 tried=43 static=0\r\ngeth    | INFO [11-29|14:58:09.156] Looking for peers                        peercount=2 tried=44 static=0\r\ngeth    | INFO [11-29|14:58:19.190] Looking for peers                        peercount=1 tried=44 static=0\r\ngeth    | INFO [11-29|14:58:29.240] Looking for peers                        peercount=0 tried=38 static=0\r\ngeth    | INFO [11-29|14:58:33.486] Block synchronisation started \r\ngeth    | INFO [11-29|14:58:39.442] Looking for peers                        peercount=1 tried=16 static=0\r\ngeth    | INFO [11-29|14:58:49.693] Looking for peers                        peercount=1 tried=45 static=0\r\ngeth    | INFO [11-29|14:58:52.973] Downloader queue stats                   receiptTasks=0 blockTasks=16 itemSize=5.89KiB throttle=8192\r\ngeth    | INFO [11-29|14:58:54.507] Importing heavy sidechain segment        blocks=1765 start=11341108 end=11342872\r\ngeth    | WARN [11-29|14:59:00.585] Served eth_coinbase                      conn=127.0.0.1:46842 reqid=3 t=\"25.462µs\" err=\"etherbase must be explicitly specified\"\r\ngeth    | INFO [11-29|14:59:02.670] Imported new chain segment               blocks=3    txs=519 mgas=37.409 elapsed=8.161s   mgasps=4.584 number=11341110 hash=\"816a3f…96913c\" age=2d21m21s dirty=4.78MiB\r\ngeth    | INFO [11-29|14:59:11.112] Imported new chain segment               blocks=6    txs=1110 mgas=74.878 elapsed=8.442s   mgasps=8.870 number=11341116 hash=\"e2165c…1cee12\" age=2d19m10s dirty=15.40MiB\r\n````\r\n",
  "closed_by": {
    "login": "mgcrea",
    "id": 108273,
    "node_id": "MDQ6VXNlcjEwODI3Mw==",
    "avatar_url": "https://avatars.githubusercontent.com/u/108273?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mgcrea",
    "html_url": "https://github.com/mgcrea",
    "followers_url": "https://api.github.com/users/mgcrea/followers",
    "following_url": "https://api.github.com/users/mgcrea/following{/other_user}",
    "gists_url": "https://api.github.com/users/mgcrea/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mgcrea/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mgcrea/subscriptions",
    "organizations_url": "https://api.github.com/users/mgcrea/orgs",
    "repos_url": "https://api.github.com/users/mgcrea/repos",
    "events_url": "https://api.github.com/users/mgcrea/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mgcrea/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21918/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21918/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/735422560",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/21918#issuecomment-735422560",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21918",
    "id": 735422560,
    "node_id": "MDEyOklzc3VlQ29tbWVudDczNTQyMjU2MA==",
    "user": {
      "login": "mgcrea",
      "id": 108273,
      "node_id": "MDQ6VXNlcjEwODI3Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/108273?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mgcrea",
      "html_url": "https://github.com/mgcrea",
      "followers_url": "https://api.github.com/users/mgcrea/followers",
      "following_url": "https://api.github.com/users/mgcrea/following{/other_user}",
      "gists_url": "https://api.github.com/users/mgcrea/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mgcrea/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mgcrea/subscriptions",
      "organizations_url": "https://api.github.com/users/mgcrea/orgs",
      "repos_url": "https://api.github.com/users/mgcrea/repos",
      "events_url": "https://api.github.com/users/mgcrea/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mgcrea/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-11-29T16:46:47Z",
    "updated_at": "2020-11-29T16:46:47Z",
    "author_association": "NONE",
    "body": "The fix is to add `stop_grace_period` to 60s as docker default 10s shutdown time is too short for a proper shutdown. Should probably be documented (if it isn't).",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/735422560/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1207881533",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/21918#issuecomment-1207881533",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21918",
    "id": 1207881533,
    "node_id": "IC_kwDOAOvK985H_s89",
    "user": {
      "login": "jurosh",
      "id": 1630137,
      "node_id": "MDQ6VXNlcjE2MzAxMzc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1630137?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jurosh",
      "html_url": "https://github.com/jurosh",
      "followers_url": "https://api.github.com/users/jurosh/followers",
      "following_url": "https://api.github.com/users/jurosh/following{/other_user}",
      "gists_url": "https://api.github.com/users/jurosh/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jurosh/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jurosh/subscriptions",
      "organizations_url": "https://api.github.com/users/jurosh/orgs",
      "repos_url": "https://api.github.com/users/jurosh/repos",
      "events_url": "https://api.github.com/users/jurosh/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jurosh/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-08T09:25:10Z",
    "updated_at": "2022-08-08T09:25:10Z",
    "author_association": "NONE",
    "body": "Oh this should be really documented somewhere. In docker run it's parameter `--stop-timeout 60`",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1207881533/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
