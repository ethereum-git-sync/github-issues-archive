{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/23066",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/23066/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/23066/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/23066/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/23066",
  "id": 924599221,
  "node_id": "MDU6SXNzdWU5MjQ1OTkyMjE=",
  "number": 23066,
  "title": "accept4: too many open files; retrying in 1s",
  "user": {
    "login": "tomw1808",
    "id": 485781,
    "node_id": "MDQ6VXNlcjQ4NTc4MQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/485781?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tomw1808",
    "html_url": "https://github.com/tomw1808",
    "followers_url": "https://api.github.com/users/tomw1808/followers",
    "following_url": "https://api.github.com/users/tomw1808/following{/other_user}",
    "gists_url": "https://api.github.com/users/tomw1808/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tomw1808/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tomw1808/subscriptions",
    "organizations_url": "https://api.github.com/users/tomw1808/orgs",
    "repos_url": "https://api.github.com/users/tomw1808/repos",
    "events_url": "https://api.github.com/users/tomw1808/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tomw1808/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 72233650,
      "node_id": "MDU6TGFiZWw3MjIzMzY1MA==",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/type:bug",
      "name": "type:bug",
      "color": "FF5E5E",
      "default": false,
      "description": ""
    },
    {
      "id": 1132689577,
      "node_id": "MDU6TGFiZWwxMTMyNjg5NTc3",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/status:triage",
      "name": "status:triage",
      "color": "6be514",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2021-06-18T06:50:26Z",
  "updated_at": "2021-06-24T08:42:13Z",
  "closed_at": "2021-06-24T08:42:13Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "#### System information\r\n\r\nGeth version: `instance=Geth/v1.10.4-stable-aa637fd3/linux-amd64/go1.16.5`\r\nOS & Version: Linux\r\n\r\nRunning it on AWS in an ECS environment behind a private VPC for about 3 months with only one other problem which was resolved. Docker Image: `ethereum/client-go:stable`\r\n\r\n#### Expected behaviour\r\n\r\nIt just syncs and \"just works\"\r\n\r\n#### Actual behaviour\r\n\r\nIt crashed hard yesterday with \"too many open files\", which let us to increase the ulimit to soft:hard 9000:15000 based on https://github.com/ethereum/go-ethereum/issues/16006. This temporarily solved the issue.\r\n\r\nGeth was having an unclean shutdown, rolled back the chain about 5000 blocks and restarted (snap?) sync. It said ETA about 5h. Today in the morning it wasn't finished, instead it threw other errors which seem to be low level go errors?!\r\n\r\nAny help would be appreciated.\r\n\r\n#### ECS Starting Pararmeters\r\n\r\nCommand [\"--syncmode\",\"snap\",\"--http\",\"--http.addr\",\"0.0.0.0\",\"--ws\",\"--ws.addr\",\"0.0.0.0\",\"--http.corsdomain\",\"*\",\"--ws.origins\",\"*\",\"--gcmode\",\"archive\"]\r\n\r\n\r\n#### Logs excerpt\r\n\r\n````\r\n←[36mecs/geth-mainchain/4acc6789b6b04f2e9560e3095cafbec1←[0m 2021/06/18 06:06:11 http: Accept error: accept tcp [::]:8546: accept4: too many open files; retrying in 5ms\r\n←[32m2021-06-18T06:06:11.502000+00:00←[0m ←[36mecs/geth-mainchain/4acc6789b6b04f2e9560e3095cafbec1←[0m 2021/06/18 06:06:11 http: Accept error: accept tcp [::]:8546: accept4: too many open files; retrying in 10ms\r\n←[32m2021-06-18T06:06:11.920000+00:00←[0m ←[36mecs/geth-mainchain/4acc6789b6b04f2e9560e3095cafbec1←[0m ERROR[06-18|06:06:11.919] Unhandled trie error: missing trie node 12462565b2d68a68f030ffefb473e86f5383369905b1d1e4788ccfe7cfbbde40 (path )\r\n←[32m2021-06-18T06:06:19.070000+00:00←[0m ←[36mecs/geth-mainchain/4acc6789b6b04f2e9560e3095cafbec1←[0m ERROR[06-18|06:06:19.069]\r\n←[32m2021-06-18T06:06:19.070000+00:00←[0m ←[36mecs/geth-mainchain/4acc6789b6b04f2e9560e3095cafbec1←[0m ########## BAD BLOCK #########\r\n←[32m2021-06-18T06:06:19.070000+00:00←[0m ←[36mecs/geth-mainchain/4acc6789b6b04f2e9560e3095cafbec1←[0m Chain config: {ChainID: 1 Homestead: 1150000 DAO: 1920000 DAOSupport: true EIP150: 2463000 EIP155: 2675000 EIP158: 2675000 Byzantium: 4370000 Constantinople: 7280000 Petersburg: 7280000 Istanbul: 9069000, Muir Glacier: 9200000, Berlin: 12244000, London: <nil>, Engine: ethash}\r\n←[32m2021-06-18T06:06:19.070000+00:00←[0m ←[36mecs/geth-mainchain/4acc6789b6b04f2e9560e3095cafbec1←[0m Number: 12655542\r\n←[32m2021-06-18T06:06:19.070000+00:00←[0m ←[36mecs/geth-mainchain/4acc6789b6b04f2e9560e3095cafbec1←[0m Hash: 0x733f0e084a6e25d78de39c8f8ddef389ce049cc948a6c37acaec3f4ce1331e70\r\n←[32m2021-06-18T06:06:19.070000+00:00←[0m ←[36mecs/geth-mainchain/4acc6789b6b04f2e9560e3095cafbec1←[0m   0: cumulative: 101972 gas: 101972 contract: 0x0000000000000000000000000000000000000000 status: 1 tx: 0xb5fd1a27615eba982e80818029246c3d9f8de65782316faa07da68f1cdff48fe logs: [0xc1c8d24dc0 0xc1c8d24f20 0xc16104bce0 0xc0fffec370 0xc0fffed4a0] bloom: 00200000010000000000000080000000000000000000003000010000000000000000000000000020000000000000000002000000080000000000000000000000000000000000000000000008000000200000000000000000000000008000000000000000002000000000000000000000000000000000000000000010000000000c000000000000000040000000000000000000010000000800000040000000000000000000000000000000000000000000000000000000000000000000000000000000820000080000020000000000000000000000000a1000000000000020000000200000000000000000000000000000000000000000400000000000000000 state:\r\n←[32m2021-06-18T06:06:19.070000+00:00←[0m ←[36mecs/geth-mainchain/4acc6789b6b04f2e9560e3095cafbec1←[0m   1: cumulative: 248142 gas: 146170 contract: 0x0000000000000000000000000000000000000000 status: 1 tx: 0x5306a574f4122d4c6daa9e7c37ca60fd41a6231b418b270a80431526422844ed logs: [0xc17f0c6a50 0xc17f0c6c60 0xc17f0c6e70 0xc17f0c7290 0xc17f0c74a0 0xc17f0c7810 0xc17f0c7970 0xc17f0c7ad0] bloom: 002000000000000000000000800000000000000000004010000000000000000000000800000000200000000000000000020000000800200000000000000000000800000000000008000000080000002000000800004000000000000000000000000000000220000000000000000088000000000000080400000000900008000008000000000000000000000000000000000000000000000800000040000000008000000000000000000000000000000000000000000000000000000000000000000400820000080000020000001000000000000000000a1000000002000020000000200000000000000000000000000000000000004000010000000000000000 state:\r\n←[32m2021-06-18T06:06:19.070000+00:00←[0m ←[36mecs/geth-mainchain/4acc6789b6b04f2e9560e3095cafbec1←[0m   2: cumulative: 439643 gas: 191501 contract: 0x0000000000000\r\n\r\n←[32m2021-06-18T06:06:19.070000+00:00←[0m ←[36mecs/geth-mainchain/4acc6789b6b04f2e9560e3095cafbec1←[0m   101: cumulative: 5137223 gas: 239587 contract: 0x0000000000000000000000000000000000000000 status: 1 tx: 0x20ca1b77ea6869f8900e8dd71611bb5dfe538076d73ee2e59522420c423fd917 logs: [0xc1de5178c0 0xc1de517970 0xc1de517a20 0xc1de517ad0 0xc1de517b80 0xc1de517c30 0xc1de517ce0 0xc1de517d90 0xc1de517e40 0xc1de517ef0 0xc1309ce0b0 0xc1309ce630 0xc1309ce790 0xc1309cf970] bloom: 00200000000000000000000080000000000000008000000000010000000000000008000000000000000000000000000002000000080000000002000000200000000004000000000000000008000000200000000000400000000001080000000000000000000000000000004000000000000000000000040000020010000000000000000001000000004000000000000000000001000000080000004000000000020000000000000000000000000000000000000000020408000000000000000000005002000000000000000000080040000000000000005200000002000020800010200000000000004000000000000000000000000000000000000000000000 state:\r\n\r\n//SNIPPED SOME LOGS\r\n\r\n[32m2021-06-18T06:25:51.675000+00:00←[0m ←[36mecs/geth-mainchain/4acc6789b6b04f2e9560e3095cafbec1←[0m INFO [06-18|06:25:51.674] Writing clean trie cache to disk         path=/root/.ethereum/geth/triecache threads=1\r\n←[32m2021-06-18T06:25:51.681000+00:00←[0m ←[36mecs/geth-mainchain/4acc6789b6b04f2e9560e3095cafbec1←[0m ERROR[06-18|06:25:51.681] Failed to persist clean trie cache       error=\"cannot save cache data to temporary dir \\\"/root/.ethereum/geth/fastcache.tmp.104977984\\\": cannot create \\\"/root/.ethereum/geth/fastcache.tmp.104977984/metadata.bin\\\": open /root/.ethereum/geth/fastcache.tmp.104977984/metadata.bin: too many open files\"\r\n←[32m2021-06-18T06:31:20.913000+00:00←[0m ←[36mecs/geth-mainchain/4acc6789b6b04f2e9560e3095cafbec1←[0m 2021/06/18 06:31:20 http: Accept error: accept tcp [::]:8546: accept4: too many open files; retrying in 1s\r\n←[32m2021-06-18T06:31:21.917000+00:00←[0m ←[36mecs/geth-mainchain/4acc6789b6b04f2e9560e3095cafbec1←[0m 2021/06/18 06:31:21 http: Accept error: accept tcp [::]:8546: accept4: too many open files; retrying in 1s\r\n````\r\n\r\nAfter restarting the container it now does _something_, but it really shouldn't take that long - anything I can do to speed it up:\r\n\r\n```\r\n←[32m2021-06-18T06:52:21.888000+00:00←[0m ←[36mecs/geth-mainchain/c7dbd32ac8c34a7f8a0b317cd632b83b←[0m INFO [06-18|06:52:21.887] Generating state snapshot                root=3da8f9..8b91e8 at=09d940..66d779 accounts=5,330,579 slots=18,093,668 storage=1.64GiB elapsed=17m46.468s eta=30h35m12.187s\r\n←[32m2021-06-18T06:52:25.453000+00:00←[0m ←[36mecs/geth-mainchain/c7dbd32ac8c34a7f8a0b317cd632b83b←[0m INFO [06-18|06:52:25.453] Indexing transactions                    blocks=49974 txs=6,877,307 tail=10,255,568 total=10,305,542 elapsed=16m54.930s\r\n←[32m2021-06-18T06:52:29.909000+00:00←[0m ←[36mecs/geth-mainchain/c7dbd32ac8c34a7f8a0b317cd632b83b←[0m INFO [06-18|06:52:29.909] Generating state snapshot                root=3da8f9..8b91e8 in=09da61..76a66e at=8a355a..c57a75 accounts=5,332,994 slots=18,104,198 storage=1.64GiB elapsed=17m54.489s eta=30h45m33.706s\r\n←[32m2021-06-18T06:52:37.923000+00:00←[0m ←[36mecs/geth-mainchain/c7dbd32ac8c34a7f8a0b317cd632b83b←[0m INFO [06-18|06:52:37.923] Generating state snapshot                root=3da8f9..8b91e8 in=09db51..f35da1 at=0abe2d..4d2802 accounts=5,334,977 slots=18,117,785 storage=1.64GiB elapsed=18m2.504s  eta=30h56m27.212s\r\n←[32m2021-06-18T06:52:45.991000+00:00←[0m ←[36mecs/geth-mainchain/c7dbd32ac8c34a7f8a0b317cd632b83b←[0m INFO [06-18|06:52:45.990] Generating state snapshot                root=3da8f9..8b91e8 in=09db51..f35da1 at=74785d..7d9c40 accounts=5,334,977 slots=18,166,937 storage=1.64GiB elapsed=18m10.570s eta=31h10m17.184s\r\n←[32m2021-06-18T06:52:54.185000+00:00←[0m ←[36mecs/geth-mainchain/c7dbd32ac8c34a7f8a0b317cd632b83b←[0m INFO [06-18|06:52:54.184] Generating state snapshot                root=3da8f9..8b91e8 in=09db51..f35da1 at=efca1f..21f81a accounts=5,334,977 slots=18,224,281 storage=1.64GiB elapsed=18m18.765s eta=31h24m20.43s\r\n←[32m2021-06-18T06:53:02.185000+00:00←[0m ←[36mecs/geth-mainchain/c7dbd32ac8c34a7f8a0b317cd632b83b←[0m INFO [06-18|06:53:02.184] Generating state snapshot                root=3da8f9..8b91e8 at=09dd47..b1d94c accounts=5,339,133 slots=18,236,294 storage=1.65GiB elapsed=18m26.765s eta=31h31m56.728s\r\n←[32m2021-06-18T06:53:10.205000+00:00←[0m ←[36mecs/geth-mainchain/c7dbd32ac8c34a7f8a0b317cd632b83b←[0m INFO [06-18|06:53:10.205] Generating state snapshot                root=3da8f9..8b91e8 at=09df92..403235 accounts=5,343,891 slots=18,237,731 storage=1.65GiB elapsed=18m34.785s eta=31h38m29.586s\r\n←[32m2021-06-18T06:53:18.321000+00:00←[0m ←[36mecs/geth-mainchain/c7dbd32ac8c34a7f8a0b317cd632b83b←[0m INFO [06-18|06:53:18.320] Generating state snapshot                root=3da8f9..8b91e8 at=09e184..c9fd3c accounts=5,347,988 slots=18,238,658 storage=1.65GiB elapsed=18m42.901s eta=31h46m14.571s\r\n←[32m2021-06-18T06:53:26.335000+00:00←[0m ←[36mecs/geth-mainchain/c7dbd32ac8c34a7f8a0b317cd632b83b←[0m INFO [06-18|06:53:26.335] Generating state snapshot                root=3da8f9..8b91e8 at=09e309..da666e accounts=5,351,151 slots=18,240,108 storage=1.65GiB elapsed=18m50.915s eta=31h55m5.933s\r\n←[32m2021-06-18T06:53:34.362000+00:00←[0m ←[36mecs/geth-mainchain/c7dbd32ac8c34a7f8a0b317cd632b83b←[0m INFO [06-18|06:53:34.362] Generating state snapshot                root=3da8f9..8b91e8 at=09e5e1..4deef3 accounts=5,357,269 slots=18,241,810 storage=1.65GiB elapsed=18m58.942s eta=31h59m48.13s\r\n←[32m2021-06-18T06:53:42.421000+00:00←[0m ←[36mecs/geth-mainchain/c7dbd32ac8c34a7f8a0b317cd632b83b←[0m INFO [06-18|06:53:42.421] Generating state snapshot                root=3da8f9..8b91e8 at=09e8b9..716923 accounts=5,363,344 slots=18,245,807 storage=1.65GiB elapsed=19m7.002s  eta=32h4m30.524s\r\n←[32m2021-06-18T06:53:50.483000+00:00←[0m ←[36mecs/geth-mainchain/c7dbd32ac8c34a7f8a0b317cd632b83b←[0m INFO [06-18|06:53:50.482] Generating state snapshot                root=3da8f9..8b91e8 in=09ea9c..3207ba at=6a0aac..c26a40 accounts=5,367,280 slots=18,251,020 storage=1.65GiB elapsed=19m15.063s eta=32h12m9.401s\r\n←[32m2021-06-18T06:53:58.911000+00:00←[0m ←[36mecs/geth-mainchain/c7dbd32ac8c34a7f8a0b317cd632b83b←[0m INFO [06-18|06:53:58.911] Generating state snapshot                root=3da8f9..8b91e8 in=09ecdf..0c88ab at=290dec..f3e563 accounts=5,372,161 slots=18,258,926 storage=1.65GiB elapsed=19m23.491s eta=32h19m11.772s\r\n←[32m2021-06-18T06:54:07.396000+00:00←[0m ←[36mecs/geth-mainchain/c7dbd32ac8c34a7f8a0b317cd632b83b←[0m INFO [06-18|06:54:07.396] Generating state snapshot                root=3da8f9..8b91e8 at=09eeb3..0712a7 accounts=5,376,015 slots=18,261,007 storage=1.65GiB elapsed=19m31.977s eta=32h27m37.417s\r\n←[32m2021-06-18T06:54:15.627000+00:00←[0m ←[36mecs/geth-mainchain/c7dbd32ac8c34a7f8a0b317cd632b83b←[0m INFO [06-18|06:54:15.627] Generating state snapshot                root=3da8f9..8b91e8 at=09f0b6..ddabdc accounts=5,380,241 slots=18,264,768 storage=1.65GiB elapsed=19m40.208s eta=32h35m1.118s\r\n←[32m2021-06-18T06:54:23.778000+00:00←[0m ←[36mecs/geth-mainchain/c7dbd32ac8c34a7f8a0b317cd632b83b←[0m INFO [06-18|06:54:23.777] Generating state snapshot                root=3da8f9..8b91e8 at=09f2e7..3e7419 accounts=5,384,849 slots=18,267,833 storage=1.65GiB elapsed=19m48.358s eta=32h41m40.146s\r\n←[32m2021-06-18T06:54:32.614000+00:00←[0m ←[36mecs/geth-mainchain/c7dbd32ac8c34a7f8a0b317cd632b83b←[0m INFO [06-18|06:54:32.614] Generating state snapshot                root=3da8f9..8b91e8 at=09f4a6..001fcb accounts=5,388,563 slots=18,268,789 storage=1.65GiB elapsed=19m57.194s eta=32h50m47.736s\r\n←[32m2021-06-18T06:54:40.733000+00:00←[0m ←[36mecs/geth-mainchain/c7dbd32ac8c34a7f8a0b317cd632b83b←[0m INFO [06-18|06:54:40.733] Generating state snapshot                root=3da8f9..8b91e8 at=09f608..4e142b accounts=5,391,378 slots=18,269,430 storage=1.65GiB elapsed=20m5.314s  eta=32h59m49.546s\r\n←[32m2021-06-18T06:54:48.810000+00:00←[0m ←[36mecs/geth-mainchain/c7dbd32ac8c34a7f8a0b317cd632b83b←[0m INFO [06-18|06:54:48.810] Generating state snapshot                root=3da8f9..8b91e8 at=09f7c1..72f0b5 accounts=5,394,964 slots=18,272,034 storage=1.65GiB elapsed=20m13.391s eta=33h7m40.292s\r\n←[32m2021-06-18T06:54:57.046000+00:00←[0m ←[36mecs/geth-mainchain/c7dbd32ac8c34a7f8a0b317cd632b83b←[0m INFO [06-18|06:54:57.046] Generating state snapshot                root=3da8f9..8b91e8 at=09f8e7..945046 accounts=5,397,335 slots=18,272,548 storage=1.65GiB elapsed=20m21.626s eta=33h17m33.018s\r\n←[32m2021-06-18T06:55:05.594000+00:00←[0m ←[36mecs/geth-mainchain/c7dbd32ac8c34a7f8a0b317cd632b83b←[0m INFO [06-18|06:55:05.593] Generating state snapshot                root=3da8f9..8b91e8 at=09fa8a..d98e76 accounts=5,400,724 slots=18,274,004 storage=1.65GiB elapsed=20m30.174s eta=33h26m21.542s\r\n←[32m2021-06-18T06:55:13.599000+00:00←[0m ←[36mecs/geth-mainchain/c7dbd32ac8c34a7f8a0b317cd632b83b←[0m INFO [06-18|06:55:13.599] Generating state snapshot                root=3da8f9..8b91e8 at=09fcb9..7bf141 accounts=5,405,458 slots=18,275,554 storage=1.65GiB elapsed=20m38.180s eta=33h32m31.087s\r\n←[32m2021-06-18T06:55:21.775000+00:00←[0m ←[36mecs/geth-mainchain/c7dbd32ac8c34a7f8a0b317cd632b83b←[0m INFO [06-18|06:55:21.774] Generating state snapshot                root=3da8f9..8b91e8 at=09fea7..e46c65 accounts=5,409,553 slots=18,280,905 storage=1.65GiB elapsed=20m46.355s eta=33h39m42.783s\r\n←[32m2021-06-18T06:55:29.834000+00:00←[0m ←[36mecs/geth-mainchain/c7dbd32ac8c34a7f8a0b317cd632b83b←[0m INFO [06-18|06:55:29.833] Generating state snapshot                root=3da8f9..8b91e8 at=0a00b5..3718f9 accounts=5,413,904 slots=18,283,985 storage=1.65GiB elapsed=20m54.414s eta=33h46m16.672s\r\n←[32m2021-06-18T06:55:38.245000+00:00←[0m ←[36mecs/geth-mainchain/c7dbd32ac8c34a7f8a0b317cd632b83b←[0m INFO [06-18|06:55:38.243] Generating state snapshot                root=3da8f9..8b91e8 at=0a01c4..6c670c accounts=5,416,209 slots=18,284,526 storage=1.65GiB elapsed=21m2.824s  eta=33h56m30.379s\r\n←[32m2021-06-18T06:55:46.293000+00:00←[0m ←[36mecs/geth-mainchain/c7dbd32ac8c34a7f8a0b317cd632b83b←[0m INFO [06-18|06:55:46.293] Generating state snapshot                root=3da8f9..8b91e8 at=0a031b..62399c accounts=5,419,024 slots=18,285,221 storage=1.65GiB elapsed=21m10.873s eta=34h5m14.253s\r\n←[32m2021-06-18T06:55:54.392000+00:00←[0m ←[36mecs/geth-mainchain/c7dbd32ac8c34a7f8a0b317cd632b83b←[0m INFO [06-18|06:55:54.392] Generating state snapshot                root=3da8f9..8b91e8 at=0a047b..b707ab accounts=5,421,968 slots=18,286,073 storage=1.65GiB elapsed=21m18.972s eta=34h13m53.282s\r\n←[32m2021-06-18T06:56:02.394000+00:00←[0m ←[36mecs/geth-mainchain/c7dbd32ac8c34a7f8a0b317cd632b83b←[0m INFO [06-18|06:56:02.394] Generating state snapshot                root=3da8f9..8b91e8 at=0a05c8..9e50a6 accounts=5,424,688 slots=18,286,861 storage=1.65GiB elapsed=21m26.974s eta=34h22m35.612s\r\n←[32m2021-06-18T06:56:09.308000+00:00←[0m ←[36mecs/geth-mainchain/c7dbd32ac8c34a7f8a0b317cd632b83b←[0m INFO [06-18|06:56:09.308] Indexing transactions                    blocks=50212 txs=6,911,485 tail=10,255,330 total=10,305,542 elapsed=20m38.786s\r\n←[32m2021-06-18T06:56:10.764000+00:00←[0m ←[36mecs/geth-mainchain/c7dbd32ac8c34a7f8a0b317cd632b83b←[0m INFO [06-18|06:56:10.763] Generating state snapshot                root=3da8f9..8b91e8 at=0a0757..a0d049 accounts=5,427,985 slots=18,288,885 storage=1.65GiB elapsed=21m35.344s eta=34h31m1.615s\r\n←[32m2021-06-18T06:56:19.003000+00:00←[0m ←[36mecs/geth-mainchain/c7dbd32ac8c34a7f8a0b317cd632b83b←[0m INFO [06-18|06:56:19.001] Generating state snapshot                root=3da8f9..8b91e8 in=0a08d4..597a14 at=290dec..f3e563 accounts=5,431,057 slots=18,289,608 storage=1.65GiB elapsed=21m43.582s eta=34h39m25.812s\r\n←[32m2021-06-18T06:56:28.104000+00:00←[0m ←[36mecs/geth-mainchain/c7dbd32ac8c34a7f8a0b317cd632b83b←[0m INFO [06-18|06:56:28.104] Generating state snapshot                root=3da8f9..8b91e8 at=0a0b7a..736ff1 accounts=5,436,560 slots=18,299,747 storage=1.65GiB elapsed=21m52.685s eta=34h45m28.306s\r\n←[32m2021-06-18T06:56:36.897000+00:00←[0m ←[36mecs/geth-mainchain/c7dbd32ac8c34a7f8a0b317cd632b83b←[0m INFO [06-18|06:56:36.897] Generating state snapshot                root=3da8f9..8b91e8 in=0a0c83..cad358 at=73e1b6..f94b43 accounts=5,438,726 slots=18,324,500 storage=1.66GiB elapsed=22m1.477s  eta=34h56m6.96s\r\n←[32m2021-06-18T06:56:45.005000+00:00←[0m ←[36mecs/geth-mainchain/c7dbd32ac8c34a7f8a0b317cd632b83b←[0m INFO [06-18|06:56:45.005] Generating state snapshot                root=3da8f9..8b91e8 in=0a0cc9..feb3e4 at=ef6e55..cebf5c accounts=5,439,289 slots=18,391,334 storage=1.66GiB elapsed=22m9.586s  eta=35h8m6.171s\r\n←[32m2021-06-18T06:56:53.019000+00:00←[0m ←[36mecs/geth-mainchain/c7dbd32ac8c34a7f8a0b317cd632b83b←[0m INFO [06-18|06:56:53.018] Generating state snapshot                root=3da8f9..8b91e8 in=0a0d9b..42a4e1 at=f7f58b..647786 accounts=5,441,043 slots=18,405,763 storage=1.66GiB elapsed=22m17.599s eta=35h18m9.231s\r\n←[32m2021-06-18T06:57:01.077000+00:00←[0m ←[36mecs/geth-mainchain/c7dbd32ac8c34a7f8a0b317cd632b83b←[0m INFO [06-18|06:57:01.077] Generating state snapshot                root=3da8f9..8b91e8 at=0a0f91..1888f5 accounts=5,445,264 slots=18,410,605 storage=1.66GiB elapsed=22m25.657s eta=35h24m34.011s\r\n←[32m2021-06-18T06:57:09.279000+00:00←[0m ←[36mecs/geth-mainchain/c7dbd32ac8c34a7f8a0b317cd632b83b←[0m INFO [06-18|06:57:09.279] Generating state snapshot                root=3da8f9..8b91e8 at=0a11cc..c201dd accounts=5,450,001 slots=18,413,677 storage=1.66GiB elapsed=22m33.834s eta=35h30m14.924s\r\n←[32m2021-06-18T06:57:17.917000+00:00←[0m ←[36mecs/geth-mainchain/c7dbd32ac8c34a7f8a0b317cd632b83b←[0m INFO [06-18|06:57:17.917] Generating state snapshot                root=3da8f9..8b91e8 at=0a13ce..2b4d9c accounts=5,454,223 slots=18,414,816 storage=1.66GiB elapsed=22m42.498s eta=35h37m22.245s\r\n←[32m2021-06-18T06:57:26.010000+00:00←[0m ←[36mecs/geth-mainchain/c7dbd32ac8c34a7f8a0b317cd632b83b←[0m INFO [06-18|06:57:26.010] Generating state snapshot                root=3da8f9..8b91e8 in=0a1555..ffa4a3 at=290dec..f3e563 accounts=5,457,295 slots=18,423,085 storage=1.66GiB elapsed=22m50.591s eta=35h45m7.089s\r\n←[32m2021-06-18T06:57:34.026000+00:00←[0m ←[36mecs/geth-mainchain/c7dbd32ac8c34a7f8a0b317cd632b83b←[0m INFO [06-18|06:57:34.026] Generating state snapshot                root=3da8f9..8b91e8 at=0a174c..5dd138 accounts=5,461,390 slots=18,424,360 storage=1.66GiB elapsed=22m58.606s eta=35h51m17.769s\r\n←[32m2021-06-18T06:57:42.031000+00:00←[0m ←[36mecs/geth-mainchain/c7dbd32ac8c34a7f8a0b317cd632b83b←[0m INFO [06-18|06:57:42.031] Generating state snapshot                root=3da8f9..8b91e8 in=0a17f5..8da0a9 at=b5f298..4e3520 accounts=5,462,776 slots=18,433,074 storage=1.66GiB elapsed=23m6.612s  eta=36h1m38.583s\r\n←[32m2021-06-18T06:57:50.051000+00:00←[0m ←[36mecs/geth-mainchain/c7dbd32ac8c34a7f8a0b317cd632b83b←[0m INFO [06-18|06:57:50.050] Generating state snapshot                root=3da8f9..8b91e8 at=0a1a04..3f75da accounts=5,467,022 slots=18,438,082 storage=1.66GiB elapsed=23m14.631s eta=36h7m26.305s\r\n←[32m2021-06-18T06:57:58.087000+00:00←[0m ←[36mecs/geth-mainchain/c7dbd32ac8c34a7f8a0b317cd632b83b←[0m INFO [06-18|06:57:58.087] Generating state snapshot                root=3da8f9..8b91e8 in=0a1b3d..450100 at=290dec..f3e563 accounts=5,469,582 slots=18,438,636 storage=1.67GiB elapsed=23m22.667s eta=36h15m57.147s\r\n←[32m2021-06-18T06:58:06.249000+00:00←[0m ←[36mecs/geth-mainchain/c7dbd32ac8c34a7f8a0b317cd632b83b←[0m INFO [06-18|06:58:06.249] Generating state snapshot                root=3da8f9..8b91e8 at=0a1ccb..fdbede accounts=5,472,783 slots=18,439,279 storage=1.67GiB elapsed=23m30.829s eta=36h23m32.098s\r\n←[32m2021-06-18T06:58:14.263000+00:00←[0m ←[36mecs/geth-mainchain/c7dbd32ac8c34a7f8a0b317cd632b83b←[0m INFO [06-18|06:58:14.262] Generating state snapshot                root=3da8f9..8b91e8 in=0a1f1b..e79b90 at=290dec..f3e563 accounts=5,477,774 slots=18,444,361 storage=1.67GiB elapsed=23m38.842s eta=36h28m23.22s\r\n←[32m2021-06-18T06:58:22.284000+00:00←[0m ←[36mecs/geth-mainchain/c7dbd32ac8c34a7f8a0b317cd632b83b←[0m INFO [06-18|06:58:22.283] Generating state snapshot                root=3da8f9..8b91e8 at=0a200f..bbd77e accounts=5,479,822 slots=18,459,478 storage=1.67GiB elapsed=23m46.864s eta=36h37m38.979s\r\n←[32m2021-06-18T06:58:30.516000+00:00←[0m ←[36mecs/geth-mainchain/c7dbd32ac8c34a7f8a0b317cd632b83b←[0m INFO [06-18|06:58:30.516] Generating state snapshot                root=3da8f9..8b91e8 at=0a217d..25b21e accounts=5,482,828 slots=18,460,475 storage=1.67GiB elapsed=23m55.096s eta=36h45m39.095s\r\n←[32m2021-06-18T06:58:38.533000+00:00←[0m ←[36mecs/geth-mainchain/c7dbd32ac8c34a7f8a0b317cd632b83b←[0m INFO [06-18|06:58:38.533] Generating state snapshot                root=3da8f9..8b91e8 in=0a22db..b8fed9 at=290dec..f3e563 accounts=5,485,776 slots=18,467,323 storage=1.67GiB elapsed=24m3.114s  eta=36h53m29.497s\r\n←[32m2021-06-18T06:58:40.263000+00:00←[0m ←[36mecs/geth-mainchain/c7dbd32ac8c34a7f8a0b317cd632b83b←[0m WARN [06-18|06:58:40.263] Served eth_coinbase                      reqid=3 t=\"94.092µs\" err=\"etherbase must be explicitly specified\"\r\n←[32m2021-06-18T06:58:46.533000+00:00←[0m ←[36mecs/geth-mainchain/c7dbd32ac8c34a7f8a0b317cd632b83b←[0m INFO [06-18|06:58:46.533] Generating state snapshot                root=3da8f9..8b91e8 at=0a248b..2f6b9b accounts=5,489,404 slots=18,468,985 storage=1.67GiB elapsed=24m11.114s eta=37h0m13.765s\r\n←[32m2021-06-18T06:58:54.603000+00:00←[0m ←[36mecs/geth-mainchain/c7dbd32ac8c34a7f8a0b317cd632b83b←[0m INFO [06-18|06:58:54.603] Generating state snapshot                root=3da8f9..8b91e8 in=0a2603..fd9bdb at=290dec..f3e563 accounts=5,492,438 slots=18,470,467 storage=1.67GiB elapsed=24m19.183s eta=37h7m44.362s\r\n```\r\n\r\nWhen submitting logs: please submit them as text and not screenshots.",
  "closed_by": {
    "login": "karalabe",
    "id": 129561,
    "node_id": "MDQ6VXNlcjEyOTU2MQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/karalabe",
    "html_url": "https://github.com/karalabe",
    "followers_url": "https://api.github.com/users/karalabe/followers",
    "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
    "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
    "organizations_url": "https://api.github.com/users/karalabe/orgs",
    "repos_url": "https://api.github.com/users/karalabe/repos",
    "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
    "received_events_url": "https://api.github.com/users/karalabe/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/23066/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/23066/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/864860093",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/23066#issuecomment-864860093",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/23066",
    "id": 864860093,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg2NDg2MDA5Mw==",
    "user": {
      "login": "karalabe",
      "id": 129561,
      "node_id": "MDQ6VXNlcjEyOTU2MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/karalabe",
      "html_url": "https://github.com/karalabe",
      "followers_url": "https://api.github.com/users/karalabe/followers",
      "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
      "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
      "organizations_url": "https://api.github.com/users/karalabe/orgs",
      "repos_url": "https://api.github.com/users/karalabe/repos",
      "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
      "received_events_url": "https://api.github.com/users/karalabe/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-06-21T08:58:02Z",
    "updated_at": "2021-06-21T08:58:02Z",
    "author_association": "MEMBER",
    "body": "It seems you are hitting Geth with a lot of external HTTP requests, all creating a new TCP socket. Eventually the OS starts refusing to give you more (old sockets take 2 minutes to be torn down, TCP spec, unrelated to us). The problem is that both network connections and open files count against the same number of \"file descriptors\", and the network may end up consuming enough to starve the database. That's when all hell breaks loose as the db will start erroring.\r\n\r\nThere are a few things you need to do:\r\n\r\n- If you are using Geth via RPC, ensure that you reuse TCP connections so you don't create a lot of OS junk.\r\n- Limiting the number of file descriptors is kind of a legacy thing from the time when many many users shared the same Linux machine. In that case, it was important to ensure neither can starve the others. Nowadays for example Ubuntu defaults to 500.000 descriptors as the limit. My guess is that in your case, it's also completely fine to just set the limits sky high instead of your 15000.\r\n- Snapshot generation is unfortunately very slow if you haven't had it generated until now. Snap sync is the default from 1.10.4 onwards, so if you were to do a fresh sync (keeping the `ancient` folder), you'd probably get up and running faster as that also keeps the snapshots it pulls from the network and only fix it instead of regenerating from zero.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/864860093/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/864868508",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/23066#issuecomment-864868508",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/23066",
    "id": 864868508,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg2NDg2ODUwOA==",
    "user": {
      "login": "tomw1808",
      "id": 485781,
      "node_id": "MDQ6VXNlcjQ4NTc4MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/485781?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tomw1808",
      "html_url": "https://github.com/tomw1808",
      "followers_url": "https://api.github.com/users/tomw1808/followers",
      "following_url": "https://api.github.com/users/tomw1808/following{/other_user}",
      "gists_url": "https://api.github.com/users/tomw1808/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tomw1808/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tomw1808/subscriptions",
      "organizations_url": "https://api.github.com/users/tomw1808/orgs",
      "repos_url": "https://api.github.com/users/tomw1808/repos",
      "events_url": "https://api.github.com/users/tomw1808/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tomw1808/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-06-21T09:08:54Z",
    "updated_at": "2021-06-21T09:08:54Z",
    "author_association": "NONE",
    "body": "Thanks @karalabe that's very helpful to understand what happens behind the scenes.\r\n\r\nThere is actually not a lot of traffic going via this geth instance. It's two event listeners via WebSockets, the connection stays open. It is also a few connections via the HTTP rpc, mostly loading some data when customers are doing something on the frontend. We're talking lower 4 digits of connections in 24 hours (probably 2-3k). It is _possible_ that there was a spike and it was just an unfortunate chain of events, nevertheless, after ~100h of repairing and re-syncing we're back up and running. \r\n\r\nI wasn't aware of the TCP specs, thanks for that hint. \r\nI will also further up the ulimit to 100k - just in case.\r\n\r\nBtw: I started a brand new snap sync on an xlarge instance, it was finished _syncing_ in ~12 hours _BUT_ it went into \"state healing\" afterwards which took another 30h to complete. It didn't give any ETA anymore at that point, it had no errors, no nothing, `eth.blocknumber` stayed 0, `eth.syncing` barely updated, it just didn't finish until then. That was on a t3.xlarge instance on AWS.\r\n\r\nI think you can safely close this ticket, it might stays as a good reminder for others running into the same problems.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/864868508/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/867454732",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/23066#issuecomment-867454732",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/23066",
    "id": 867454732,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg2NzQ1NDczMg==",
    "user": {
      "login": "karalabe",
      "id": 129561,
      "node_id": "MDQ6VXNlcjEyOTU2MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/karalabe",
      "html_url": "https://github.com/karalabe",
      "followers_url": "https://api.github.com/users/karalabe/followers",
      "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
      "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
      "organizations_url": "https://api.github.com/users/karalabe/orgs",
      "repos_url": "https://api.github.com/users/karalabe/repos",
      "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
      "received_events_url": "https://api.github.com/users/karalabe/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-06-24T08:42:13Z",
    "updated_at": "2021-06-24T08:42:13Z",
    "author_association": "MEMBER",
    "body": "Hmm, state healing depends on how fast you managed to sync (the slower, the more faults to heal). 30h seems quite excessive. Did you attack an NVMe SSD or something similar to your machine. AFAIK the stock EBS volumes are quite slow on the IOPs side, which we do heavily rely on.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/867454732/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
