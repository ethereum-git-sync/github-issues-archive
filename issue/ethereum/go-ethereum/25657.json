{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/25657",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/25657/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/25657/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/25657/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/25657",
  "id": 1358124637,
  "node_id": "I_kwDOAOvK985Q81Zd",
  "number": 25657,
  "title": "state.(*cachingDB).CopyTrie encounter panic: unknown trie type <nil>",
  "user": {
    "login": "darren",
    "id": 12817,
    "node_id": "MDQ6VXNlcjEyODE3",
    "avatar_url": "https://avatars.githubusercontent.com/u/12817?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/darren",
    "html_url": "https://github.com/darren",
    "followers_url": "https://api.github.com/users/darren/followers",
    "following_url": "https://api.github.com/users/darren/following{/other_user}",
    "gists_url": "https://api.github.com/users/darren/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/darren/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/darren/subscriptions",
    "organizations_url": "https://api.github.com/users/darren/orgs",
    "repos_url": "https://api.github.com/users/darren/repos",
    "events_url": "https://api.github.com/users/darren/events{/privacy}",
    "received_events_url": "https://api.github.com/users/darren/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 72233650,
      "node_id": "MDU6TGFiZWw3MjIzMzY1MA==",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/type:bug",
      "name": "type:bug",
      "color": "FF5E5E",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2022-09-01T01:34:15Z",
  "updated_at": "2022-09-02T06:41:48Z",
  "closed_at": "2022-09-02T06:41:48Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "#### System information\r\n\r\nGeth\r\nVersion: 1.11.0-unstable\r\nGit Commit: d10c28030944d1c32febba3f45ae8c175ab34063\r\nGit Commit Date: 20220831\r\nArchitecture: amd64\r\nGo Version: go1.19\r\nOperating System: linux\r\n\r\n\r\n#### Expected behaviour\r\nshould not panic\r\n\r\n#### Actual behaviour\r\npanics\r\n\r\n#### Steps to reproduce the behaviour\r\n1. `geth --cache 8000 --http --http.api eth,net,engine,admin --authrpc.jwtsecret /tmp/jwts`\r\n2. `prysm.sh  beacon-chain --http-web3provider=http://localhost:8551 --mainnet --jwt-secret=/tmp/jwts`\r\n\r\nAfter this panic, restart the node can not sync any more due to \r\n```` Error: invalid merkle root (remote: 7cc7e88cb15e7431fd61cdc8742decc9d1909dde5ff7e3e50a96006e07e1b954 local: 9168df37cb64cde9b78d788b0aa3973f6330a42c0a962de64ec2d4f9a8968f43)\r\n##############################\r\n \r\nERROR[09-01|09:31:15.483] Failed to retrieve beacon bounds for bad block reporting err=\"beacon sync not yet started\"\r\nWARN [09-01|09:31:15.483] Synchronisation failed, dropping peer    peer=774017fcc3478b6527634b31b07b524a36f8e8a17afa9658260001f7622ce623 err=\"retrieved hash chain is invalid: invalid merkle root (remote: 7cc7e88cb15e7431fd61cdc8742decc9d1909dde5ff7e3e50a96006e07e1b954 local: 9168df37cb64cde9b78d788b0aa3973f6330a42c0a962de64ec2d4f9a8968f43)\"\r\n````\r\n\r\n#### Backtrace\r\n\r\n````\r\nINFO [08-31|23:09:56.106] Writing clean trie cache to disk         path=/home/darren/.ethereum/geth/triecache threads=1\r\nINFO [08-31|23:09:56.108] Regenerated local transaction journal    transactions=0 accounts=0\r\nINFO [08-31|23:09:57.822] Persisted the clean trie cache           path=/home/darren/.ethereum/geth/triecache elapsed=1.715s\r\nINFO [08-31|23:10:01.500] Imported new chain segment               blocks=1  txs=142  mgas=9.783   elapsed=126.382ms   mgasps=77.406  number=15,447,306 hash=dd5b11..f60c45 dirty=1.20GiB\r\nINFO [08-31|23:10:01.529] Unindexed transactions                   blocks=1  txs=119  tail=13,097,307 elapsed=27.225ms\r\nINFO [08-31|23:10:05.960] Imported new chain segment               blocks=1  txs=199  mgas=16.917  elapsed=172.884ms   mgasps=97.854  number=15,447,307 hash=7e8bdd..172e5b dirty=1.20GiB\r\nINFO [08-31|23:10:05.963] Unindexed transactions                   blocks=1  txs=98   tail=13,097,308 elapsed=2.536ms\r\nINFO [08-31|23:10:22.154] Imported new chain segment               blocks=1  txs=126  mgas=12.818  elapsed=106.381ms   mgasps=120.487 number=15,447,308 hash=a2c716..92b181 dirty=1.20GiB\r\nINFO [08-31|23:10:22.156] Unindexed transactions                   blocks=1  txs=82   tail=13,097,309 elapsed=1.620ms\r\nWARN [08-31|23:10:48.614] Trie prefetcher failed opening trie      root=f5a1d3..658db4 err=\"missing trie node f5a1d3d1a4a78d9ebc35976f56fa6eb998e509062018fdb48cd4968e87658db4 (owner 4921d0f888dd702cdb6067f0b62c93322db732d50df0ccbcfba9efe8a9a84983) (path ) <nil>\"\r\nWARN [08-31|23:10:48.614] Trie prefetcher failed opening trie      root=ed62f7..652246 err=\"missing trie node ed62f7aefd169cd03ff7a3ffd3c76ab64827fdb78d34f3e436fd39e5a2652246 (owner 05411a03c890840e8be0034e02cb7a1a877583e9b4d3eebf6cc4725948f48b5c) (path ) <nil>\"\r\nINFO [08-31|23:11:02.073] Imported new chain segment               blocks=1  txs=339  mgas=30.020  elapsed=193.029ms   mgasps=155.520 number=15,447,309 hash=40e021..a72094 dirty=1.20GiB\r\nINFO [08-31|23:11:02.074] Unindexed transactions                   blocks=1  txs=48   tail=13,097,310 elapsed=1.171ms\r\nWARN [08-31|23:11:02.177] Trie prefetcher failed opening trie      root=ed62f7..652246 err=\"missing trie node ed62f7aefd169cd03ff7a3ffd3c76ab64827fdb78d34f3e436fd39e5a2652246 (owner 05411a03c890840e8be0034e02cb7a1a877583e9b4d3eebf6cc4725948f48b5c) (path ) <nil>\"\r\nWARN [08-31|23:11:02.177] Trie prefetcher failed opening trie      root=f5a1d3..658db4 err=\"missing trie node f5a1d3d1a4a78d9ebc35976f56fa6eb998e509062018fdb48cd4968e87658db4 (owner 4921d0f888dd702cdb6067f0b62c93322db732d50df0ccbcfba9efe8a9a84983) (path ) <nil>\"\r\npanic: unknown trie type <nil>\r\n\r\ngoroutine 170 [running]:\r\ngithub.com/ethereum/go-ethereum/core/state.(*cachingDB).CopyTrie(0xc0df0e2f38?, {0x0?, 0x0?})\r\n        github.com/ethereum/go-ethereum/core/state/database.go:168 +0x153\r\ngithub.com/ethereum/go-ethereum/core/state.(*triePrefetcher).copy(0xc14bf135f0)\r\n        github.com/ethereum/go-ethereum/core/state/trie_prefetcher.go:129 +0x3c9\r\ngithub.com/ethereum/go-ethereum/core/state.(*StateDB).Copy(0xc0fec5bd40)\r\n        github.com/ethereum/go-ethereum/core/state/statedb.go:714 +0xeb2\r\ngithub.com/ethereum/go-ethereum/miner.(*worker).updateSnapshot(0xc0096a18c0, 0xc1adc40a00)\r\n        github.com/ethereum/go-ethereum/miner/worker.go:822 +0x3b9\r\ngithub.com/ethereum/go-ethereum/miner.(*worker).commit(0xc1e39f4dc0?, 0x0?, 0x17dbb00?, 0x0?, {0x8?, 0xffffffffffffffff?, 0x2248500?})\r\n        github.com/ethereum/go-ethereum/miner/worker.go:1165 +0xf9\r\ngithub.com/ethereum/go-ethereum/miner.(*worker).commitWork(0xc0096a18c0, 0xc0df0e3b7c?, 0x0, 0x630f7a06)\r\n        github.com/ethereum/go-ethereum/miner/worker.go:1123 +0x279\r\ngithub.com/ethereum/go-ethereum/miner.(*worker).mainLoop(0xc0096a18c0)\r\n        github.com/ethereum/go-ethereum/miner/worker.go:534 +0x85e\r\ncreated by github.com/ethereum/go-ethereum/miner.newWorker\r\n        github.com/ethereum/go-ethereum/miner/worker.go:293 +0x776\r\n````",
  "closed_by": {
    "login": "darren",
    "id": 12817,
    "node_id": "MDQ6VXNlcjEyODE3",
    "avatar_url": "https://avatars.githubusercontent.com/u/12817?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/darren",
    "html_url": "https://github.com/darren",
    "followers_url": "https://api.github.com/users/darren/followers",
    "following_url": "https://api.github.com/users/darren/following{/other_user}",
    "gists_url": "https://api.github.com/users/darren/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/darren/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/darren/subscriptions",
    "organizations_url": "https://api.github.com/users/darren/orgs",
    "repos_url": "https://api.github.com/users/darren/repos",
    "events_url": "https://api.github.com/users/darren/events{/privacy}",
    "received_events_url": "https://api.github.com/users/darren/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/25657/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/25657/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1233635452",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/25657#issuecomment-1233635452",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/25657",
    "id": 1233635452,
    "node_id": "IC_kwDOAOvK985Jh8h8",
    "user": {
      "login": "rjl493456442",
      "id": 5959481,
      "node_id": "MDQ6VXNlcjU5NTk0ODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5959481?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rjl493456442",
      "html_url": "https://github.com/rjl493456442",
      "followers_url": "https://api.github.com/users/rjl493456442/followers",
      "following_url": "https://api.github.com/users/rjl493456442/following{/other_user}",
      "gists_url": "https://api.github.com/users/rjl493456442/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rjl493456442/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rjl493456442/subscriptions",
      "organizations_url": "https://api.github.com/users/rjl493456442/orgs",
      "repos_url": "https://api.github.com/users/rjl493456442/repos",
      "events_url": "https://api.github.com/users/rjl493456442/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rjl493456442/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-01T01:45:23Z",
    "updated_at": "2022-09-01T01:45:23Z",
    "author_association": "MEMBER",
    "body": "You ran the 1.10.22 previously right? You have to set the head back to the point you upgraded to 1.10.22 and re-import the chain in between. We had a regression in 1.10.22 which will lose some data.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1233635452/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1235128156",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/25657#issuecomment-1235128156",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/25657",
    "id": 1235128156,
    "node_id": "IC_kwDOAOvK985Jno9c",
    "user": {
      "login": "darren",
      "id": 12817,
      "node_id": "MDQ6VXNlcjEyODE3",
      "avatar_url": "https://avatars.githubusercontent.com/u/12817?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/darren",
      "html_url": "https://github.com/darren",
      "followers_url": "https://api.github.com/users/darren/followers",
      "following_url": "https://api.github.com/users/darren/following{/other_user}",
      "gists_url": "https://api.github.com/users/darren/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/darren/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/darren/subscriptions",
      "organizations_url": "https://api.github.com/users/darren/orgs",
      "repos_url": "https://api.github.com/users/darren/repos",
      "events_url": "https://api.github.com/users/darren/events{/privacy}",
      "received_events_url": "https://api.github.com/users/darren/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-02T06:41:48Z",
    "updated_at": "2022-09-02T06:41:48Z",
    "author_association": "NONE",
    "body": "@rjl493456442 \r\n\r\nIt seems that you have fixed the original panic in #25575, so I am going to close this.\r\n\r\n> You ran the 1.10.22 previously right? \r\n\r\nNo I am running on the dev branch, not the stable channel. tried debug.setHead  serveral times, still got \r\n\r\n```\r\nERROR[09-02|14:38:42.796] Failed to retrieve beacon bounds for bad block reporting err=\"beacon sync not yet started\"\r\nWARN [09-02|14:38:42.797] Synchronisation failed, dropping peer    peer=d5c94cfcfe2358133274d9a3c6d9e4bc766f0c1355c05565185e89ecb1e7f6c2 err=\"retrieved hash chain is invalid: invalid merkle root (remote: 7cc7e88cb15e7431fd61cdc8742decc9d1909dde5ff7e3e50a96006e07e1b954 local: 9168df37cb64cde9b78d788b0aa3973f6330a42c0a962de64ec2d4f9a8968f43)\"\r\nWARN [09-02|14:38:42.797] Synchronisation failed, retrying         err=\"peer is unknown or unhealthy\"\r\nINFO [09-02|14:40:14.216] New local node record                    seq=1,655,740,187,340 id=2210dd52ea14560d ip=123.122.163.59  udp=30303 tcp=30303\r\n```\r\n```\r\nGeth\r\nVersion: 1.11.0-unstable\r\nGit Commit: 511bf8f18801520bf4e0c7e4d098a17d0665bc89\r\nGit Commit Date: 20220901\r\nArchitecture: amd64\r\nGo Version: go1.19\r\nOperating System: linux\r\nGOPATH=\r\nGOROOT=\r\n```\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1235128156/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
