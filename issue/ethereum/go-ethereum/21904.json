{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21904",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21904/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21904/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21904/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/21904",
  "id": 750755119,
  "node_id": "MDU6SXNzdWU3NTA3NTUxMTk=",
  "number": 21904,
  "title": "reduce memory rusage during test runs",
  "user": {
    "login": "holiman",
    "id": 142290,
    "node_id": "MDQ6VXNlcjE0MjI5MA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/holiman",
    "html_url": "https://github.com/holiman",
    "followers_url": "https://api.github.com/users/holiman/followers",
    "following_url": "https://api.github.com/users/holiman/following{/other_user}",
    "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
    "organizations_url": "https://api.github.com/users/holiman/orgs",
    "repos_url": "https://api.github.com/users/holiman/repos",
    "events_url": "https://api.github.com/users/holiman/events{/privacy}",
    "received_events_url": "https://api.github.com/users/holiman/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 400866729,
      "node_id": "MDU6TGFiZWw0MDA4NjY3Mjk=",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/type:tech-debt",
      "name": "type:tech-debt",
      "color": "fbca04",
      "default": false,
      "description": ""
    },
    {
      "id": 2144913747,
      "node_id": "MDU6TGFiZWwyMTQ0OTEzNzQ3",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/type:improvement",
      "name": "type:improvement",
      "color": "c7ce4a",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2020-11-25T11:56:04Z",
  "updated_at": "2021-10-25T20:32:04Z",
  "closed_at": "2021-10-25T20:32:04Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "It would be neat to reduce the memory usage when running tests, making it run smoother on both CI and when running on your laptop. \r\n\r\nHere's an allocation chart of running all tests in the `les` folder, I'll add some other parts later. I think there are a lot of low-hanging fruits to pick, e.g. like https://github.com/ethereum/go-ethereum/pull/21882#issuecomment-733541580. \r\n![profile001](https://user-images.githubusercontent.com/142290/100224767-89f4a200-2f1d-11eb-9b62-5de0eabe1cd2.png)\r\n ",
  "closed_by": {
    "login": "holiman",
    "id": 142290,
    "node_id": "MDQ6VXNlcjE0MjI5MA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/holiman",
    "html_url": "https://github.com/holiman",
    "followers_url": "https://api.github.com/users/holiman/followers",
    "following_url": "https://api.github.com/users/holiman/following{/other_user}",
    "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
    "organizations_url": "https://api.github.com/users/holiman/orgs",
    "repos_url": "https://api.github.com/users/holiman/repos",
    "events_url": "https://api.github.com/users/holiman/events{/privacy}",
    "received_events_url": "https://api.github.com/users/holiman/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21904/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21904/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/733694714",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/21904#issuecomment-733694714",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21904",
    "id": 733694714,
    "node_id": "MDEyOklzc3VlQ29tbWVudDczMzY5NDcxNA==",
    "user": {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-11-25T13:05:21Z",
    "updated_at": "2020-11-25T13:23:26Z",
    "author_association": "MEMBER",
    "body": "core package\r\n```\r\n      flat  flat%   sum%        cum   cum%\r\n    1.59GB 19.52% 19.52%     1.60GB 19.58%  github.com/syndtr/goleveldb/leveldb/memdb.New\r\n    1.47GB 18.03% 37.56%     1.47GB 18.03%  github.com/steakknife/bloomfilter.newBits (inline)\r\n    1.30GB 15.88% 53.44%     2.32GB 28.39%  github.com/VictoriaMetrics/fastcache.New\r\n    1.02GB 12.50% 65.95%     1.02GB 12.50%  github.com/VictoriaMetrics/fastcache.(*bucket).Init\r\n    0.75GB  9.22% 75.16%     0.75GB  9.22%  github.com/ethereum/go-ethereum/ethdb/memorydb.(*Database).NewIterato\r\n```\r\n\r\n![profile001](https://user-images.githubusercontent.com/142290/100231307-1fe0fa80-2f27-11eb-9c1e-98b1ecbf30ce.png)\r\n\r\n\r\n`1.30GB 15.88% 53.44%     2.32GB 28.39%  github.com/VictoriaMetrics/fastcache.New` -- this seems to be from the codeCache (64Mb)  that gets created when creating a state database:\r\n\r\n```golang\r\nfunc NewDatabaseWithConfig(db ethdb.Database, config *trie.Config) Database {\r\n\tcsc, _ := lru.New(codeSizeCacheSize)\r\n\treturn &cachingDB{\r\n\t\tdb:            trie.NewDatabaseWithConfig(db, config),\r\n\t\tcodeSizeCache: csc,\r\n\t\tcodeCache:     fastcache.New(codeCacheSize),\r\n```\r\n\r\nMight be that we don't even need such a cache for the tests, or if we do, maybe 16K is sufficient (EDIT: apparently 32Mb is the minimum cache capacity for fastcache)",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/733694714/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/733696670",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/21904#issuecomment-733696670",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21904",
    "id": 733696670,
    "node_id": "MDEyOklzc3VlQ29tbWVudDczMzY5NjY3MA==",
    "user": {
      "login": "MariusVanDerWijden",
      "id": 16664698,
      "node_id": "MDQ6VXNlcjE2NjY0Njk4",
      "avatar_url": "https://avatars.githubusercontent.com/u/16664698?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MariusVanDerWijden",
      "html_url": "https://github.com/MariusVanDerWijden",
      "followers_url": "https://api.github.com/users/MariusVanDerWijden/followers",
      "following_url": "https://api.github.com/users/MariusVanDerWijden/following{/other_user}",
      "gists_url": "https://api.github.com/users/MariusVanDerWijden/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MariusVanDerWijden/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MariusVanDerWijden/subscriptions",
      "organizations_url": "https://api.github.com/users/MariusVanDerWijden/orgs",
      "repos_url": "https://api.github.com/users/MariusVanDerWijden/repos",
      "events_url": "https://api.github.com/users/MariusVanDerWijden/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MariusVanDerWijden/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-11-25T13:09:09Z",
    "updated_at": "2020-11-25T13:09:09Z",
    "author_association": "MEMBER",
    "body": "@holiman you seem to have a good setup running, could you test `accounts/abi/bind` for me? I think there's probably a lot to improve there",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/733696670/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/733697367",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/21904#issuecomment-733697367",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21904",
    "id": 733697367,
    "node_id": "MDEyOklzc3VlQ29tbWVudDczMzY5NzM2Nw==",
    "user": {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-11-25T13:10:32Z",
    "updated_at": "2020-11-25T13:11:08Z",
    "author_association": "MEMBER",
    "body": "`accounts/abi/bind` package (pretty low on memory consumption already)\r\n\r\n```\r\n      flat  flat%   sum%        cum   cum%\r\n 2069.73kB 11.41% 11.41%  2069.73kB 11.41%  bytes.makeSlice\r\n    1634kB  9.01% 20.43%  2146.02kB 11.84%  github.com/VictoriaMetrics/fastcache.New\r\n 1536.14kB  8.47% 28.90%  1536.14kB  8.47%  text/template/parse.(*Tree).newPipeline\r\n 1056.33kB  5.83% 34.72%  1056.33kB  5.83%  regexp.(*bitState).reset\r\n 1030.18kB  5.68% 40.40%  1030.18kB  5.68%  go/printer.(*printer).writeString\r\n 1024.11kB  5.65% 46.05%  1024.11kB  5.65%  regexp/syntax.(*parser).newRegexp\r\n 1024.06kB  5.65% 51.70%  1024.06kB  5.65%  text/template/parse.(*Tree).newText\r\n  561.50kB  3.10% 54.80%   561.50kB  3.10%  golang.org/x/net/html.init\r\n  516.01kB  2.85% 57.64%  2052.48kB 11.32%  go/printer.(*printer).nodeSize\r\n```\r\n![profile001](https://user-images.githubusercontent.com/142290/100231935-f70d3500-2f27-11eb-8da9-5d424cf7fee3.png)\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/733697367/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/741811518",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/21904#issuecomment-741811518",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21904",
    "id": 741811518,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc0MTgxMTUxOA==",
    "user": {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-12-09T14:35:04Z",
    "updated_at": "2020-12-09T14:35:04Z",
    "author_association": "MEMBER",
    "body": "Btw, here are the top 25 slowest tests on appveyor:\r\n\r\n\r\nTest | Time\r\n-- | --\r\ngithub.com/ethereum/go-ethereum/tests | 213.115\r\ngithub.com/ethereum/go-ethereum/eth/downloader | 175.823\r\ngithub.com/ethereum/go-ethereum/trie | 128.769\r\ngithub.com/ethereum/go-ethereum/p2p/discover | 96.552\r\ngithub.com/ethereum/go-ethereum/les | 69.651\r\ngithub.com/ethereum/go-ethereum/core | 69.284\r\ngithub.com/ethereum/go-ethereum/eth | 51.893\r\ngithub.com/ethereum/go-ethereum/accounts/keystore | 21.879\r\ngithub.com/ethereum/go-ethereum/node | 16.591\r\ngithub.com/ethereum/go-ethereum/internal/guide | 16.445\r\ngithub.com/ethereum/go-ethereum/consensus/ethash | 14.975\r\ngithub.com/ethereum/go-ethereum/core/bloombits | 13.242\r\ngithub.com/ethereum/go-ethereum/les/flowcontrol | 12.15\r\ngithub.com/ethereum/go-ethereum/core/state | 11.868\r\ngithub.com/ethereum/go-ethereum/eth/fetcher | 11.732\r\ngithub.com/ethereum/go-ethereum/rpc | 10.654\r\ngithub.com/ethereum/go-ethereum/cmd/geth | 9.891\r\ngithub.com/ethereum/go-ethereum/miner | 9.577\r\ngithub.com/ethereum/go-ethereum/p2p/discv5 | 8.888\r\ngithub.com/ethereum/go-ethereum/metrics | 6.25\r\ngithub.com/ethereum/go-ethereum/crypto/bls12381 | 5.756\r\ngithub.com/ethereum/go-ethereum/signer/core | 4.472\r\ngithub.com/ethereum/go-ethereum/core/state/snapshot | 3.696\r\ngithub.com/ethereum/go-ethereum/signer/fourbyte | 3.651\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/741811518/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/951300105",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/21904#issuecomment-951300105",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21904",
    "id": 951300105,
    "node_id": "IC_kwDOAOvK9844s7AJ",
    "user": {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-10-25T20:32:04Z",
    "updated_at": "2021-10-25T20:32:04Z",
    "author_association": "MEMBER",
    "body": "This is pretty stale now, closing",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/951300105/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
