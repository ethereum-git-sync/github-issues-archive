{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/16717",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/16717/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/16717/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/16717/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/16717",
  "id": 321635242,
  "node_id": "MDU6SXNzdWUzMjE2MzUyNDI=",
  "number": 16717,
  "title": "A lot of time is spent determining the size of the pending/queued transaction pool",
  "user": {
    "login": "veox",
    "id": 3036030,
    "node_id": "MDQ6VXNlcjMwMzYwMzA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3036030?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/veox",
    "html_url": "https://github.com/veox",
    "followers_url": "https://api.github.com/users/veox/followers",
    "following_url": "https://api.github.com/users/veox/following{/other_user}",
    "gists_url": "https://api.github.com/users/veox/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/veox/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/veox/subscriptions",
    "organizations_url": "https://api.github.com/users/veox/orgs",
    "repos_url": "https://api.github.com/users/veox/repos",
    "events_url": "https://api.github.com/users/veox/events{/privacy}",
    "received_events_url": "https://api.github.com/users/veox/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 9,
  "created_at": "2018-05-09T16:14:19Z",
  "updated_at": "2020-09-10T09:11:03Z",
  "closed_at": "2020-09-10T09:11:03Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "EDIT: Original title: **A lot of time is spent determining the length of txSortedMap**\r\n\r\n#### System information\r\n\r\nGeth version:  `Geth/v1.8.7-stable-66432f38/linux-amd64/go1.10`\r\nOS & Version: Ubuntu 16.04.4 LTS (Xenial Xerus)\r\n\r\n#### Background\r\n\r\nI've tried to do txpool analysis, retaining as much of it as possible (e.g. having 32768 slots). My assumption was that this would mostly require copious amounts of memory, but it seemed to increase CPU load, too.\r\n\r\nI've dropped the count down to 8192 and ran some profiling. (See link at the very bottom.)\r\n\r\n#### Possible optimisation?..\r\n\r\nIn `core/tx_pool.go`, [`TxPool promoteExecutables()`](https://github.com/ethereum/go-ethereum/blob/v1.8.7/core/tx_pool.go#L909) has a lot of nested loops that iterate over various lists of transactions.\r\n\r\nCalls are made to [`txSortedMap`'s `Len()`](https://github.com/ethereum/go-ethereum/blob/v1.8.7/core/tx_list.go#L196) (comes from `core/tx_list.go`); it seems that the structure does not have a specific field for this, so the determination is made on-the-fly.\r\n\r\nIn my tests, 5-10% of a \"production\" node's time is spent determining the length of these maps. This would seem to be true for most any `txpool` settings, unless severely restricting `txpool.pricelimit`.\r\n\r\n(BTW, the default for that is 1 wei, which also contributes to the issue: the txpool is pretty much guaranteed to be immediately filled up by \"default policy\" peers, and remain in a constant state of churn from then on.)\r\n\r\nSince this probably can't be avoided, perhaps it can be optimised for?..\r\n\r\n#### Steps to reproduce the behaviour\r\n\r\nRun `geth` something like:\r\n\r\n``` sh\r\n/usr/bin/geth --metrics \\\r\n    --datadir /home/geth/.ethereum \\\r\n    --cache 3072 \\ \r\n    --txpool.pricelimit 31337000 --txpool.accountslots 4 --txpool.globalslots 8192 --txpool.accountqueue 4 \\\r\n    --lightserv 50 --lightpeers 1000 --maxpeers 1025\r\n```\r\n\r\nIn `console`:\r\n\r\n``` js\r\ndebug.cpuProfile('/home/geth/fiddled.prof', 3600)\r\n```\r\n\r\nGenerate SVG:\r\n\r\n``` sh\r\ngo tool pprof fiddled.prof\r\n(pprof) svg > fiddled.svg\r\n```\r\n\r\n#### CPU profiling graph\r\n\r\nhttps://veox.pw/dump/fiddled.svg\r\n\r\nNote: this was intentionally timed to a window with little DB flushing.\r\n\r\n-----\r\n\r\nCc: @AlexeyAkhunov - not sure if you're mostly interested is sync optimisation, or runtime also.\r\n",
  "closed_by": {
    "login": "holiman",
    "id": 142290,
    "node_id": "MDQ6VXNlcjE0MjI5MA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/holiman",
    "html_url": "https://github.com/holiman",
    "followers_url": "https://api.github.com/users/holiman/followers",
    "following_url": "https://api.github.com/users/holiman/following{/other_user}",
    "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
    "organizations_url": "https://api.github.com/users/holiman/orgs",
    "repos_url": "https://api.github.com/users/holiman/repos",
    "events_url": "https://api.github.com/users/holiman/events{/privacy}",
    "received_events_url": "https://api.github.com/users/holiman/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/16717/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/16717/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/387798863",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/16717#issuecomment-387798863",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/16717",
    "id": 387798863,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM4Nzc5ODg2Mw==",
    "user": {
      "login": "AlexeyAkhunov",
      "id": 13686139,
      "node_id": "MDQ6VXNlcjEzNjg2MTM5",
      "avatar_url": "https://avatars.githubusercontent.com/u/13686139?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AlexeyAkhunov",
      "html_url": "https://github.com/AlexeyAkhunov",
      "followers_url": "https://api.github.com/users/AlexeyAkhunov/followers",
      "following_url": "https://api.github.com/users/AlexeyAkhunov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AlexeyAkhunov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AlexeyAkhunov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AlexeyAkhunov/subscriptions",
      "organizations_url": "https://api.github.com/users/AlexeyAkhunov/orgs",
      "repos_url": "https://api.github.com/users/AlexeyAkhunov/repos",
      "events_url": "https://api.github.com/users/AlexeyAkhunov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AlexeyAkhunov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-05-09T16:34:01Z",
    "updated_at": "2018-05-09T16:34:01Z",
    "author_association": "CONTRIBUTOR",
    "body": "Looks like Len() function is getting called quite a lot on the elements of pool.pending. It looks like pool.pending is not mutated inside the promoteExecutables(), so a simple assignment to a variable should do the job.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/387798863/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 1,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/387875292",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/16717#issuecomment-387875292",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/16717",
    "id": 387875292,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM4Nzg3NTI5Mg==",
    "user": {
      "login": "ryanschneider",
      "id": 53520,
      "node_id": "MDQ6VXNlcjUzNTIw",
      "avatar_url": "https://avatars.githubusercontent.com/u/53520?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanschneider",
      "html_url": "https://github.com/ryanschneider",
      "followers_url": "https://api.github.com/users/ryanschneider/followers",
      "following_url": "https://api.github.com/users/ryanschneider/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanschneider/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanschneider/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanschneider/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanschneider/orgs",
      "repos_url": "https://api.github.com/users/ryanschneider/repos",
      "events_url": "https://api.github.com/users/ryanschneider/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanschneider/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-05-09T21:04:44Z",
    "updated_at": "2018-05-09T21:04:44Z",
    "author_association": "CONTRIBUTOR",
    "body": "This seems odd: `txSortedMap.Len` is just a wrapper around `len(m.items)`, which appears to be just a value lookup on h.count in the golang runtime:\r\n\r\nhttps://golang.org/src/runtime/hashmap.go#L1232\r\n\r\nMy guess is its actually the number of operations done on pool.pending rather than the actual `Len` calls themselves.\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/387875292/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 1,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/388091213",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/16717#issuecomment-388091213",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/16717",
    "id": 388091213,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM4ODA5MTIxMw==",
    "user": {
      "login": "veox",
      "id": 3036030,
      "node_id": "MDQ6VXNlcjMwMzYwMzA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3036030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/veox",
      "html_url": "https://github.com/veox",
      "followers_url": "https://api.github.com/users/veox/followers",
      "following_url": "https://api.github.com/users/veox/following{/other_user}",
      "gists_url": "https://api.github.com/users/veox/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/veox/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/veox/subscriptions",
      "organizations_url": "https://api.github.com/users/veox/orgs",
      "repos_url": "https://api.github.com/users/veox/repos",
      "events_url": "https://api.github.com/users/veox/events{/privacy}",
      "received_events_url": "https://api.github.com/users/veox/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-05-10T15:35:37Z",
    "updated_at": "2018-05-29T10:41:55Z",
    "author_association": "CONTRIBUTOR",
    "body": "Done a bit of debug-print digging, most invocations are indeed done when estabilishing the `pending` map's ~~length~~ depth - [here](https://github.com/ethereum/go-ethereum/blob/v1.8.7/core/tx_pool.go#L962):\r\n\r\n``` go\r\nfor _, list := range pool.pending {\r\n    pending += uint64(list.Len())\r\n}\r\n```\r\n\r\n`pool.pending` [is a hash map](https://github.com/ethereum/go-ethereum/blob/v1.8.7/core/tx_pool.go#L203):\r\n\r\n``` go\r\npending map[common.Address]*txList\r\n```\r\n\r\nto `txList`s of _likely different_ sizes.\r\n\r\nPerhaps it is `pool.pending` that could benefit from a `pool.pendingcount`?..\r\n\r\n-----\r\n\r\nEDIT: This section seems related to PR #16720, which _might_ have made it obsolete.\r\n\r\nThe profiling graph doesn't show this, but the `addTxs` -> `addTxsLocked` -> `promoteExecutables` call path gets hit a lot passing in accounts one-by-one, although [this passage](https://github.com/ethereum/go-ethereum/blob/v1.8.7/core/tx_pool.go#L826) in `addTxsLocked` suggests that's not the ~~expected~~ only supported mode of operation:\r\n\r\n``` go\r\naddrs := make([]common.Address, 0, len(dirty))\r\nfor addr := range dirty {\r\n\taddrs = append(addrs, addr)\r\n}\r\npool.promoteExecutables(addrs)\r\n```\r\n\r\nIn other words, `addTxsLocked` receives a `txs` argument that often has just _one_ account - although the function is capable of processing lists of transactions from _many_ accounts.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/388091213/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/388142992",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/16717#issuecomment-388142992",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/16717",
    "id": 388142992,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM4ODE0Mjk5Mg==",
    "user": {
      "login": "veox",
      "id": 3036030,
      "node_id": "MDQ6VXNlcjMwMzYwMzA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3036030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/veox",
      "html_url": "https://github.com/veox",
      "followers_url": "https://api.github.com/users/veox/followers",
      "following_url": "https://api.github.com/users/veox/following{/other_user}",
      "gists_url": "https://api.github.com/users/veox/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/veox/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/veox/subscriptions",
      "organizations_url": "https://api.github.com/users/veox/orgs",
      "repos_url": "https://api.github.com/users/veox/repos",
      "events_url": "https://api.github.com/users/veox/events{/privacy}",
      "received_events_url": "https://api.github.com/users/veox/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-05-10T18:30:00Z",
    "updated_at": "2018-05-10T18:30:00Z",
    "author_association": "CONTRIBUTOR",
    "body": "P.S. Although in current network conditions this manifests mostly with `pool.pending`, it is likely that with an enormous txpool it would be visible instead with `pool.queue`.\r\n\r\nThe crux of the issue is that these are \"hash maps of (non-homogenous) lists\", and their size is determined by iterating over the elements.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/388142992/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/497291001",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/16717#issuecomment-497291001",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/16717",
    "id": 497291001,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ5NzI5MTAwMQ==",
    "user": {
      "login": "stale[bot]",
      "id": 26384082,
      "node_id": "MDM6Qm90MjYzODQwODI=",
      "avatar_url": "https://avatars.githubusercontent.com/in/1724?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/stale%5Bbot%5D",
      "html_url": "https://github.com/apps/stale",
      "followers_url": "https://api.github.com/users/stale%5Bbot%5D/followers",
      "following_url": "https://api.github.com/users/stale%5Bbot%5D/following{/other_user}",
      "gists_url": "https://api.github.com/users/stale%5Bbot%5D/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/stale%5Bbot%5D/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/stale%5Bbot%5D/subscriptions",
      "organizations_url": "https://api.github.com/users/stale%5Bbot%5D/orgs",
      "repos_url": "https://api.github.com/users/stale%5Bbot%5D/repos",
      "events_url": "https://api.github.com/users/stale%5Bbot%5D/events{/privacy}",
      "received_events_url": "https://api.github.com/users/stale%5Bbot%5D/received_events",
      "type": "Bot",
      "site_admin": false
    },
    "created_at": "2019-05-30T10:55:57Z",
    "updated_at": "2019-05-30T10:55:57Z",
    "author_association": "NONE",
    "body": "This issue has been automatically marked as stale because it has not had recent activity. It will be closed if no further activity occurs. Thank you for your contributions.\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/497291001/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/497417034",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/16717#issuecomment-497417034",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/16717",
    "id": 497417034,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ5NzQxNzAzNA==",
    "user": {
      "login": "veox",
      "id": 3036030,
      "node_id": "MDQ6VXNlcjMwMzYwMzA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3036030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/veox",
      "html_url": "https://github.com/veox",
      "followers_url": "https://api.github.com/users/veox/followers",
      "following_url": "https://api.github.com/users/veox/following{/other_user}",
      "gists_url": "https://api.github.com/users/veox/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/veox/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/veox/subscriptions",
      "organizations_url": "https://api.github.com/users/veox/orgs",
      "repos_url": "https://api.github.com/users/veox/repos",
      "events_url": "https://api.github.com/users/veox/events{/privacy}",
      "received_events_url": "https://api.github.com/users/veox/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-05-30T17:40:12Z",
    "updated_at": "2019-06-01T18:57:32Z",
    "author_association": "CONTRIBUTOR",
    "body": "AFAIK nothing has changed between v1.8.7 and v1.8.27: [`pool.pending` is still iterated over](https://github.com/ethereum/go-ethereum/blob/v1.8.27/core/tx_pool.go#L1004), and it's [still a hash map keyed by `common.address`](https://github.com/ethereum/go-ethereum/blob/v1.8.27/core/tx_pool.go#L224), - with various-length lists as values.\r\n\r\nI haven't run profiling on v1.8.27, but would guess the inefficiency is still present.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/497417034/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/551006367",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/16717#issuecomment-551006367",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/16717",
    "id": 551006367,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU1MTAwNjM2Nw==",
    "user": {
      "login": "karalabe",
      "id": 129561,
      "node_id": "MDQ6VXNlcjEyOTU2MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/karalabe",
      "html_url": "https://github.com/karalabe",
      "followers_url": "https://api.github.com/users/karalabe/followers",
      "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
      "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
      "organizations_url": "https://api.github.com/users/karalabe/orgs",
      "repos_url": "https://api.github.com/users/karalabe/repos",
      "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
      "received_events_url": "https://api.github.com/users/karalabe/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-11-07T09:53:39Z",
    "updated_at": "2019-11-07T09:53:39Z",
    "author_association": "MEMBER",
    "body": "The 1.9 release family changed the way transactions are shuffled within the bool from a synchronous one after every insert to an async one that runs in the background. This means that if there's high churn, the shuffling (and inherently the iterating) will run much much rarer. Could you perhaps try if a latest release still exhibits this behavior? My initial guess would be that it does not.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/551006367/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/554356140",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/16717#issuecomment-554356140",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/16717",
    "id": 554356140,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU1NDM1NjE0MA==",
    "user": {
      "login": "veox",
      "id": 3036030,
      "node_id": "MDQ6VXNlcjMwMzYwMzA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3036030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/veox",
      "html_url": "https://github.com/veox",
      "followers_url": "https://api.github.com/users/veox/followers",
      "following_url": "https://api.github.com/users/veox/following{/other_user}",
      "gists_url": "https://api.github.com/users/veox/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/veox/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/veox/subscriptions",
      "organizations_url": "https://api.github.com/users/veox/orgs",
      "repos_url": "https://api.github.com/users/veox/repos",
      "events_url": "https://api.github.com/users/veox/events{/privacy}",
      "received_events_url": "https://api.github.com/users/veox/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-11-15T13:21:10Z",
    "updated_at": "2019-11-18T15:10:40Z",
    "author_association": "CONTRIBUTOR",
    "body": "I'm not able to replicate the experiment completely (the machine has been \"beefed up\" resource-wise). Below is with `geth` v1.9.6.\r\n\r\nHowever, the situation seems to have gotten \"worse\". Running:\r\n\r\n```\r\n/usr/bin/geth --nousb --datadir /home/geth/.ethereum \\\r\n    --v5disc --cache 6144 \\\r\n    --txpool.pricelimit 31337000 --txpool.globalslots 8192 \\\r\n    --txpool.accountslots 4 --txpool.accountqueue 4 \\\r\n    --ethstats \"veox-geth-lightserv:$ETHSTATS_SECRET@ethstats.net\" \\\r\n    --light.serve 100 --light.maxpeers 475 --maxpeers 500 \\\r\n    --metrics\r\n```\r\n\r\nNotice the inclusion of `ethstats`, which constantly queries the size of txpool. `txpool.pricelimit` is same as in original experiment, so as to guarantee constant churn.\r\n\r\n**Profiling graph:** https://veox.pw/dump/fiddled-v1.9.6.svg\r\n\r\nIt's now at 18.93% (another round shows 19.20%, another one 18.00%). Most likely an indicator of how everything else improved...\r\n\r\n-----\r\n\r\nI still see no solution for this other than to have a `len` counter on `txSortedMap`, incrementing it as transactions are added, decrementing it as they are removed.\r\n\r\nBut that is patently unfriendly to multi-processing, and I don't know the proper `golang` approach. :(",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/554356140/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/690101825",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/16717#issuecomment-690101825",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/16717",
    "id": 690101825,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY5MDEwMTgyNQ==",
    "user": {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-09-10T09:11:03Z",
    "updated_at": "2020-09-10T09:11:03Z",
    "author_association": "MEMBER",
    "body": "We've made a lot of improvements lately: \r\n\r\n- https://github.com/ethereum/go-ethereum/pull/21232\r\n- https://github.com/ethereum/go-ethereum/pull/21358\r\n\r\nI believe this is mostly fixed now, so closing. Please open a new ticket if this problem still is present",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/690101825/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
