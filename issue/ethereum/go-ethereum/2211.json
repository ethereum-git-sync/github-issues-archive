{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2211",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2211/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2211/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2211/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/2211",
  "id": 133427654,
  "node_id": "MDU6SXNzdWUxMzM0Mjc2NTQ=",
  "number": 2211,
  "title": "core: writeHeader very rare crash",
  "user": {
    "login": "karalabe",
    "id": 129561,
    "node_id": "MDQ6VXNlcjEyOTU2MQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/karalabe",
    "html_url": "https://github.com/karalabe",
    "followers_url": "https://api.github.com/users/karalabe/followers",
    "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
    "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
    "organizations_url": "https://api.github.com/users/karalabe/orgs",
    "repos_url": "https://api.github.com/users/karalabe/repos",
    "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
    "received_events_url": "https://api.github.com/users/karalabe/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 72233650,
      "node_id": "MDU6TGFiZWw3MjIzMzY1MA==",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/type:bug",
      "name": "type:bug",
      "color": "FF5E5E",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/milestones/20",
    "html_url": "https://github.com/ethereum/go-ethereum/milestone/20",
    "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/milestones/20/labels",
    "id": 1299388,
    "node_id": "MDk6TWlsZXN0b25lMTI5OTM4OA==",
    "number": 20,
    "title": "1.4.0",
    "description": "",
    "creator": {
      "login": "obscuren",
      "id": 6264126,
      "node_id": "MDQ6VXNlcjYyNjQxMjY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6264126?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/obscuren",
      "html_url": "https://github.com/obscuren",
      "followers_url": "https://api.github.com/users/obscuren/followers",
      "following_url": "https://api.github.com/users/obscuren/following{/other_user}",
      "gists_url": "https://api.github.com/users/obscuren/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/obscuren/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/obscuren/subscriptions",
      "organizations_url": "https://api.github.com/users/obscuren/orgs",
      "repos_url": "https://api.github.com/users/obscuren/repos",
      "events_url": "https://api.github.com/users/obscuren/events{/privacy}",
      "received_events_url": "https://api.github.com/users/obscuren/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 0,
    "closed_issues": 141,
    "state": "closed",
    "created_at": "2015-09-10T13:53:50Z",
    "updated_at": "2016-08-17T20:07:24Z",
    "due_on": null,
    "closed_at": "2016-05-10T10:44:41Z"
  },
  "comments": 3,
  "created_at": "2016-02-13T12:18:16Z",
  "updated_at": "2016-05-10T09:57:43Z",
  "closed_at": "2016-05-10T09:57:39Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "This is a crash I noticed once and we got another report a few days ago. We only have a short crash log but it hopefully is enough to track down the issue. My bet is a rare race condition but don't know for sure yet.\n\nhttps://gist.github.com/biafra23/50eb7b3689b6d43782fd\n",
  "closed_by": {
    "login": "obscuren",
    "id": 6264126,
    "node_id": "MDQ6VXNlcjYyNjQxMjY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6264126?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/obscuren",
    "html_url": "https://github.com/obscuren",
    "followers_url": "https://api.github.com/users/obscuren/followers",
    "following_url": "https://api.github.com/users/obscuren/following{/other_user}",
    "gists_url": "https://api.github.com/users/obscuren/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/obscuren/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/obscuren/subscriptions",
    "organizations_url": "https://api.github.com/users/obscuren/orgs",
    "repos_url": "https://api.github.com/users/obscuren/repos",
    "events_url": "https://api.github.com/users/obscuren/events{/privacy}",
    "received_events_url": "https://api.github.com/users/obscuren/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2211/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2211/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/184147945",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/2211#issuecomment-184147945",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2211",
    "id": 184147945,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE4NDE0Nzk0NQ==",
    "user": {
      "login": "karalabe",
      "id": 129561,
      "node_id": "MDQ6VXNlcjEyOTU2MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/karalabe",
      "html_url": "https://github.com/karalabe",
      "followers_url": "https://api.github.com/users/karalabe/followers",
      "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
      "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
      "organizations_url": "https://api.github.com/users/karalabe/orgs",
      "repos_url": "https://api.github.com/users/karalabe/repos",
      "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
      "received_events_url": "https://api.github.com/users/karalabe/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-02-15T10:17:33Z",
    "updated_at": "2016-02-15T10:17:33Z",
    "author_association": "MEMBER",
    "body": "I think this issue is caused by a simultaneous header insertion and a rollback during fast sync. Seems that rollback doesn't correctly lock the chain while doing the database deletes.\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/184147945/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/184232543",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/2211#issuecomment-184232543",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2211",
    "id": 184232543,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE4NDIzMjU0Mw==",
    "user": {
      "login": "karalabe",
      "id": 129561,
      "node_id": "MDQ6VXNlcjEyOTU2MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/karalabe",
      "html_url": "https://github.com/karalabe",
      "followers_url": "https://api.github.com/users/karalabe/followers",
      "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
      "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
      "organizations_url": "https://api.github.com/users/karalabe/orgs",
      "repos_url": "https://api.github.com/users/karalabe/repos",
      "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
      "received_events_url": "https://api.github.com/users/karalabe/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-02-15T14:36:21Z",
    "updated_at": "2016-02-15T14:36:21Z",
    "author_association": "MEMBER",
    "body": "No, the locks seems to be fine.\n\nThe strange thing I see is this line: https://gist.github.com/biafra23/50eb7b3689b6d43782fd#file-geth-crash-L1. When rolling back some failed stuff, the headers aren't rolled back, only the fast blocks in the above log. This is I think a bug in the downloader which is caused by this line: https://github.com/ethereum/go-ethereum/blob/develop/eth/downloader/downloader.go#L1208. When the insertion of a batch of headers partially succeeds, but fails before writing all, the rollback is called before pushing the succeeded headers into the rollback list. This causes them not to be rolled back.\n\nAlthough this is definitely a bug, it should not cause this issue. I still need to investigate why header insertion fails mid batch, as it really shouldn't (all the POWs are validated before inserting anything) + if all the parents were inserted previously there's no further failure point that I see. Also the next sync iteration should start from the rolled back fast block, not the non-rolled back header, so again I don't see how it would hit a nil panic. It seems as if a header is missing from the database, yet all checks for its presence point otherwise.\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/184232543/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/194411626",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/2211#issuecomment-194411626",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2211",
    "id": 194411626,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE5NDQxMTYyNg==",
    "user": {
      "login": "karalabe",
      "id": 129561,
      "node_id": "MDQ6VXNlcjEyOTU2MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/karalabe",
      "html_url": "https://github.com/karalabe",
      "followers_url": "https://api.github.com/users/karalabe/followers",
      "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
      "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
      "organizations_url": "https://api.github.com/users/karalabe/orgs",
      "repos_url": "https://api.github.com/users/karalabe/repos",
      "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
      "received_events_url": "https://api.github.com/users/karalabe/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-03-09T17:24:00Z",
    "updated_at": "2016-03-09T17:24:00Z",
    "author_association": "MEMBER",
    "body": "Not fixed, can still repro using the new concurrent fast sync code.\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/194411626/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
