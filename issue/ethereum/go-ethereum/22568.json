{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22568",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22568/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22568/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22568/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/22568",
  "id": 840142051,
  "node_id": "MDU6SXNzdWU4NDAxNDIwNTE=",
  "number": 22568,
  "title": "Ropsten almost syncs with snap, then stops",
  "user": {
    "login": "jakubgs",
    "id": 2212681,
    "node_id": "MDQ6VXNlcjIyMTI2ODE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2212681?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jakubgs",
    "html_url": "https://github.com/jakubgs",
    "followers_url": "https://api.github.com/users/jakubgs/followers",
    "following_url": "https://api.github.com/users/jakubgs/following{/other_user}",
    "gists_url": "https://api.github.com/users/jakubgs/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jakubgs/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jakubgs/subscriptions",
    "organizations_url": "https://api.github.com/users/jakubgs/orgs",
    "repos_url": "https://api.github.com/users/jakubgs/repos",
    "events_url": "https://api.github.com/users/jakubgs/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jakubgs/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 72233650,
      "node_id": "MDU6TGFiZWw3MjIzMzY1MA==",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/type:bug",
      "name": "type:bug",
      "color": "FF5E5E",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 13,
  "created_at": "2021-03-24T20:32:08Z",
  "updated_at": "2021-03-25T18:14:51Z",
  "closed_at": "2021-03-25T18:14:51Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "#### System information\r\n\r\nGeth version: `1.10.1`\r\nOS & Version: Ubuntu 20.04.1\r\n\r\n#### Expected behaviour\r\nI expect Ropsten testnet to sync with snap sync mode.\r\n\r\n#### Actual behaviour\r\nThe sync goes very well for a few hours:\r\n\r\n![image](https://user-images.githubusercontent.com/2212681/112378491-4cdfc700-8ce7-11eb-892b-6d1d5264c951.png)\r\n\r\nBut once it reaches block `0x971baa` it just stops syncing:\r\n\r\n![image](https://user-images.githubusercontent.com/2212681/112378622-6da81c80-8ce7-11eb-878b-49e2ec9f67af.png)\r\n\r\nThe `highestBlock` keeps going up, while the `currentBlock` is stuck on `0x971baa`:\r\n```\r\n > rpc.sh eth_syncing | jq -c '{ current: .result.currentBlock, highest: .result.highestBlock }'\r\n{\"current\":\"0x971baa\",\"highest\":\"0x971c04\"}\r\n > rpc.sh eth_syncing | jq -c '{ current: .result.currentBlock, highest: .result.highestBlock }'\r\n{\"current\":\"0x971baa\",\"highest\":\"0x971c05\"}\r\n > rpc.sh eth_syncing | jq -c '{ current: .result.currentBlock, highest: .result.highestBlock }'\r\n{\"current\":\"0x971baa\",\"highest\":\"0x971c06\"}\r\n```\r\n\r\n#### Steps to reproduce the behaviour\r\nHere are my flags:\r\n```\r\n--ropsten\r\n--v5disc\r\n--syncmode=snap\r\n--light.serve=90\r\n--metrics\r\n--nousb\r\n--verbosity=3\r\n--maxpeers=50\r\n--maxpendpeers=30\r\n--port=30303\r\n--nat=extip:1.2.3.4\r\n--bootnodes=\"enode://6332792c4a00e3e4ee0926ed89e0d27ef985424d97b6a45bf0f23e51f0dcb5e66b875777506458aea7af6f9e4ffb69f43f3778ee73c81ed9d34c51c4b16b0b0f@52.232.243.152:30303,enode://94c15d1b9e2fe7ce56e458b9a3b672ef11894ddedd0c6f247e0f1d3487f52b66208fb4aeb8179fce6e3a749ea93ed147c37976d67af557508d199d9594c35f09@192.81.208.223:30303\"\r\n```",
  "closed_by": {
    "login": "jakubgs",
    "id": 2212681,
    "node_id": "MDQ6VXNlcjIyMTI2ODE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2212681?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jakubgs",
    "html_url": "https://github.com/jakubgs",
    "followers_url": "https://api.github.com/users/jakubgs/followers",
    "following_url": "https://api.github.com/users/jakubgs/following{/other_user}",
    "gists_url": "https://api.github.com/users/jakubgs/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jakubgs/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jakubgs/subscriptions",
    "organizations_url": "https://api.github.com/users/jakubgs/orgs",
    "repos_url": "https://api.github.com/users/jakubgs/repos",
    "events_url": "https://api.github.com/users/jakubgs/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jakubgs/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22568/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22568/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/806168611",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/22568#issuecomment-806168611",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22568",
    "id": 806168611,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwNjE2ODYxMQ==",
    "user": {
      "login": "jakubgs",
      "id": 2212681,
      "node_id": "MDQ6VXNlcjIyMTI2ODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2212681?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jakubgs",
      "html_url": "https://github.com/jakubgs",
      "followers_url": "https://api.github.com/users/jakubgs/followers",
      "following_url": "https://api.github.com/users/jakubgs/following{/other_user}",
      "gists_url": "https://api.github.com/users/jakubgs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jakubgs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jakubgs/subscriptions",
      "organizations_url": "https://api.github.com/users/jakubgs/orgs",
      "repos_url": "https://api.github.com/users/jakubgs/repos",
      "events_url": "https://api.github.com/users/jakubgs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jakubgs/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-24T20:33:52Z",
    "updated_at": "2021-03-24T20:33:52Z",
    "author_association": "NONE",
    "body": "Actually, I just saw it roll back a bunch of syncing progress:\r\n```\r\nLooking for peers                        peercount=1 tried=6  static=0\r\nLoaded most recent local header          number=9901059 hash=\"cb087e…5e04b4\" td=33005760556867404 age=9h55m42s\r\nLoaded most recent local full block      number=0       hash=\"419410…ca4a2d\" td=1048576           age=51y11mo2w\r\nLoaded most recent local fast block      number=9901059 hash=\"cb087e…5e04b4\" td=33005760556867404 age=9h55m42s\r\nLoaded last fast-sync pivot marker       number=9903017\r\nRolled back chain segment                header=9903109->9901059 fast=9903043->9901059 block=0->0 reason=\"syncing canceled (requested)\"\r\nSynchronisation failed, dropping peer    peer=89c07745507f7c00041ced1abbb55e2f4e34f7e5561a5e093353b06e33102aae err=\"no peers available or all tried for download\"\r\nEthereum peer removal failed             peer=89c07745 err=\"peer not registered\"\r\nLooking for peers                        peercount=0 tried=6  static=0\r\n```\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/806168611/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/806169228",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/22568#issuecomment-806169228",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22568",
    "id": 806169228,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwNjE2OTIyOA==",
    "user": {
      "login": "jakubgs",
      "id": 2212681,
      "node_id": "MDQ6VXNlcjIyMTI2ODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2212681?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jakubgs",
      "html_url": "https://github.com/jakubgs",
      "followers_url": "https://api.github.com/users/jakubgs/followers",
      "following_url": "https://api.github.com/users/jakubgs/following{/other_user}",
      "gists_url": "https://api.github.com/users/jakubgs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jakubgs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jakubgs/subscriptions",
      "organizations_url": "https://api.github.com/users/jakubgs/orgs",
      "repos_url": "https://api.github.com/users/jakubgs/repos",
      "events_url": "https://api.github.com/users/jakubgs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jakubgs/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-24T20:35:00Z",
    "updated_at": "2021-03-24T20:37:00Z",
    "author_association": "NONE",
    "body": "What I also don't get is how is the `currentBlock` and `highestBlock` difference so small, while in the logs the sync progress appears as just 27.56%:\r\n```\r\nState sync in progress        synced=27.56% state=11.63GiB   accounts=9986472@1.67GiB    slots=54464448@7.57GiB   codes=533123@2.39GiB    eta=19h14m52.098s\r\nState sync in progress        synced=27.56% state=11.64GiB   accounts=9986472@1.67GiB    slots=54501680@7.57GiB   codes=533123@2.39GiB    eta=19h15m26.794s\r\n```\r\nAnd as far as I can tell the size just keeps growing without making progress.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/806169228/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/806171730",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/22568#issuecomment-806171730",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22568",
    "id": 806171730,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwNjE3MTczMA==",
    "user": {
      "login": "jakubgs",
      "id": 2212681,
      "node_id": "MDQ6VXNlcjIyMTI2ODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2212681?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jakubgs",
      "html_url": "https://github.com/jakubgs",
      "followers_url": "https://api.github.com/users/jakubgs/followers",
      "following_url": "https://api.github.com/users/jakubgs/following{/other_user}",
      "gists_url": "https://api.github.com/users/jakubgs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jakubgs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jakubgs/subscriptions",
      "organizations_url": "https://api.github.com/users/jakubgs/orgs",
      "repos_url": "https://api.github.com/users/jakubgs/repos",
      "events_url": "https://api.github.com/users/jakubgs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jakubgs/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-24T20:39:35Z",
    "updated_at": "2021-03-24T20:39:35Z",
    "author_association": "NONE",
    "body": "I might add this is my third attempt at syncing Ropsten with snap. The previous time my progress past certain point looked like this:\r\n\r\n![image](https://user-images.githubusercontent.com/2212681/112380181-608c2d00-8ce9-11eb-8999-21e3178eef46.png)\r\n\r\nWhich is... interesting.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/806171730/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/806174027",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/22568#issuecomment-806174027",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22568",
    "id": 806174027,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwNjE3NDAyNw==",
    "user": {
      "login": "jakubgs",
      "id": 2212681,
      "node_id": "MDQ6VXNlcjIyMTI2ODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2212681?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jakubgs",
      "html_url": "https://github.com/jakubgs",
      "followers_url": "https://api.github.com/users/jakubgs/followers",
      "following_url": "https://api.github.com/users/jakubgs/following{/other_user}",
      "gists_url": "https://api.github.com/users/jakubgs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jakubgs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jakubgs/subscriptions",
      "organizations_url": "https://api.github.com/users/jakubgs/orgs",
      "repos_url": "https://api.github.com/users/jakubgs/repos",
      "events_url": "https://api.github.com/users/jakubgs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jakubgs/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-24T20:43:36Z",
    "updated_at": "2021-03-24T20:44:52Z",
    "author_association": "NONE",
    "body": "Not sure if this is the same issue as described in https://github.com/ethereum/go-ethereum/issues/22555.\r\nAlso https://github.com/ethereum/go-ethereum/issues/22497 might be related or the same issue.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/806174027/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/806175608",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/22568#issuecomment-806175608",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22568",
    "id": 806175608,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwNjE3NTYwOA==",
    "user": {
      "login": "jakubgs",
      "id": 2212681,
      "node_id": "MDQ6VXNlcjIyMTI2ODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2212681?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jakubgs",
      "html_url": "https://github.com/jakubgs",
      "followers_url": "https://api.github.com/users/jakubgs/followers",
      "following_url": "https://api.github.com/users/jakubgs/following{/other_user}",
      "gists_url": "https://api.github.com/users/jakubgs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jakubgs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jakubgs/subscriptions",
      "organizations_url": "https://api.github.com/users/jakubgs/orgs",
      "repos_url": "https://api.github.com/users/jakubgs/repos",
      "events_url": "https://api.github.com/users/jakubgs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jakubgs/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-24T20:46:30Z",
    "updated_at": "2021-03-24T20:46:30Z",
    "author_association": "NONE",
    "body": "I will attempt to use `--snapshot=false` as suggested in https://github.com/ethereum/go-ethereum/issues/22497#issuecomment-801734631 and see what happens tomorrow.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/806175608/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/806445959",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/22568#issuecomment-806445959",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22568",
    "id": 806445959,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwNjQ0NTk1OQ==",
    "user": {
      "login": "jakubgs",
      "id": 2212681,
      "node_id": "MDQ6VXNlcjIyMTI2ODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2212681?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jakubgs",
      "html_url": "https://github.com/jakubgs",
      "followers_url": "https://api.github.com/users/jakubgs/followers",
      "following_url": "https://api.github.com/users/jakubgs/following{/other_user}",
      "gists_url": "https://api.github.com/users/jakubgs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jakubgs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jakubgs/subscriptions",
      "organizations_url": "https://api.github.com/users/jakubgs/orgs",
      "repos_url": "https://api.github.com/users/jakubgs/repos",
      "events_url": "https://api.github.com/users/jakubgs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jakubgs/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-25T07:59:05Z",
    "updated_at": "2021-03-25T07:59:05Z",
    "author_association": "NONE",
    "body": "Same thing, synced \"nicely\" for the first ~6 hours:\r\n\r\n![image](https://user-images.githubusercontent.com/2212681/112438021-e939b600-8d47-11eb-9bab-caa3f4696ed2.png)\r\n\r\nBut then after it reached 80 blocks left to sync at 03:16:00 it stopped syncing:\r\n\r\n![image](https://user-images.githubusercontent.com/2212681/112438312-0b333880-8d48-11eb-814f-b1b285b084d2.png)\r\n\r\nThis is the same result as I achieved in my previous attempt: https://github.com/ethereum/go-ethereum/issues/22568#issuecomment-806171730\r\n\r\nSeems like `--snapshot=false` did nothing.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/806445959/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/806468853",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/22568#issuecomment-806468853",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22568",
    "id": 806468853,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwNjQ2ODg1Mw==",
    "user": {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-25T08:40:03Z",
    "updated_at": "2021-03-25T08:40:03Z",
    "author_association": "MEMBER",
    "body": "Syncing Ethereum is a pain point for many people, so I'll try to detail what's happening behind the scenes so there might be a bit less confusion.\r\n\r\nThe current default mode of sync for Geth is called fast sync. Instead of starting from the genesis block and reprocessing all the transactions that ever occurred (which could take weeks), fast sync downloads the blocks, and only verifies the associated proof-of-works. Downloading all the blocks is a straightforward and fast procedure and will relatively quickly reassemble the entire chain.\r\n\r\nMany people falsely assume that because they have the blocks, they are in sync. Unfortunately this is not the case, since no transaction was executed, so we do not have any account state available (ie. balances, nonces, smart contract code and data). These need to be downloaded separately and cross checked with the latest blocks. This phase is called the state trie download and it actually runs concurrently with the block downloads; alas it take a lot longer nowadays than downloading the blocks.\r\n\r\nSo, what's the state trie? In the Ethereum mainnet, there are a [ton of accounts already](https://etherscan.io/chart/address), which track the balance, nonce, etc of each user/contract. The accounts themselves are however insufficient to run a node, they need to be cryptographically linked to each block so that nodes can actually verify that the account's are not tampered with. This cryptographic linking is done by creating a tree data structure above the accounts, each level aggregating the layer below it into an ever smaller layer, until you reach the single root. This gigantic data structure containing all the accounts and the intermediate cryptographic proofs is called the state trie.\r\n\r\nOk, so why does this pose a problem? This trie data structure is an intricate interlink of hundreds of millions of tiny cryptographic proofs (trie nodes). To truly have a synchronized node, you need to download all the account data, as well as all the tiny cryptographic proofs to verify that noone in the network is trying to cheat you. This itself is already a crazy number of data items. The part where it gets even messier is that this data is constantly morphing: at every block (15s), about 1000 nodes are deleted from this trie and about 2000 new ones are added. This means your node needs to synchronize a dataset that is changing 200 times per second. The worst part is that while you are synchronizing, the network is moving forward, and state that you begun to download might disappear while you're downloading, so your node needs to constantly follow the network while trying to gather all the recent data. But until you actually do gather all the data, your local node is not usable since it cannot cryptographically prove anything about any accounts.\r\n\r\nIf you see that you are 64 blocks behind mainnet, you aren't yet synchronized, not even close. You are just done with the block download phase and still running the state downloads. You can see this yourself via the seemingly endless `Imported state entries [...]` stream of logs. You'll need to wait that out too before your node comes truly online.\r\n\r\n---\r\n\r\n**Q: The node just hangs on importing state enties?!**\r\n\r\nA: The node doesn't hang, it just doesn't know how large the state trie is in advance so it keeps on going and going and going until it discovers and downloads the entire thing.\r\n\r\nThe reason is that a block in Ethereum only contains the state root, a single hash of the root node. When the node begins synchronizing, it knows about exactly 1 node and tries to download it. That node, can refer up to 16 new nodes, so in the next step, we'll know about 16 new nodes and try to download those. As we go along the download, most of the nodes will reference new ones that we didn't know about until then. This is why you might be tempted to think it's stuck on the same numbers. It is not, rather it's discovering and downloading the trie as it goes along.\r\n\r\n**Q: I'm stuck at 64 blocks behind mainnet?!**\r\n\r\nA: As explained above, you are not stuck, just finished with the block download phase, waiting for the state download phase to complete too. This latter phase nowadays take a lot longer than just getting the blocks.\r\n\r\n**Q: Why does downloading the state take so long, I have good bandwidth?**\r\n\r\nA: State sync is mostly limited by disk IO, not bandwidth.\r\n\r\nThe state trie in Ethereum contains hundreds of millions of nodes, most of which take the form of a single hash referencing up to 16 other hashes. This is a horrible way to store data on a disk, because there's almost no structure in it, just random numbers referencing even more random numbers. This makes any underlying database weep, as it cannot optimize storing and looking up the data in any meaningful way.\r\n\r\nNot only is storing the data very suboptimal, but due to the 200 modification / second and pruning of past data, we cannot even download it is a properly pre-processed way to make it import faster without the underlying database shuffling it around too much. The end result is that even a fast sync nowadays incurs a huge disk IO cost, which is too much for a mechanical hard drive.\r\n\r\n**Q: Wait, so I can't run a full node on an HDD?**\r\n\r\nA: Unfortunately not. Doing a fast sync on an HDD will take more time than you're willing to wait with the current data schema. Even if you do wait it out, an HDD will not be able to keep up with the read/write requirements of transaction processing on mainnet.\r\n\r\nYou however should be able to run a light client on an HDD with minimal impact on system resources. If you wish to run a full node however, an SSD is your only option.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/806468853/reactions",
      "total_count": 2,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 1,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/806469877",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/22568#issuecomment-806469877",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22568",
    "id": 806469877,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwNjQ2OTg3Nw==",
    "user": {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-25T08:41:45Z",
    "updated_at": "2021-03-25T08:41:45Z",
    "author_association": "MEMBER",
    "body": "The text above is a bottled response, but the effect you're seeing of \"I'm close to the head, then it goes away\" the same for snap sync. The blocks are downloaded, but the state (in the form of snapshot portions) are still being downloaded. The jagged edges ae from occasional pivot movements, when we refocus on the stateroot for a newer block, because the old block got too old. ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/806469877/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/806470454",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/22568#issuecomment-806470454",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22568",
    "id": 806470454,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwNjQ3MDQ1NA==",
    "user": {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-25T08:42:41Z",
    "updated_at": "2021-03-25T08:42:41Z",
    "author_association": "MEMBER",
    "body": "```\r\nState sync in progress        synced=27.56% state=11.63GiB   accounts=9986472@1.67GiB    slots=54464448@7.57GiB   codes=533123@2.39GiB    eta=19h14m52.098s\r\nState sync in progress        synced=27.56% state=11.64GiB   accounts=9986472@1.67GiB    slots=54501680@7.57GiB   codes=533123@2.39GiB    eta=19h15m26.794s\r\n\r\n```\r\nYou were doing progress there^ See the slot-count, it was increasing. ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/806470454/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/806474428",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/22568#issuecomment-806474428",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22568",
    "id": 806474428,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwNjQ3NDQyOA==",
    "user": {
      "login": "jakubgs",
      "id": 2212681,
      "node_id": "MDQ6VXNlcjIyMTI2ODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2212681?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jakubgs",
      "html_url": "https://github.com/jakubgs",
      "followers_url": "https://api.github.com/users/jakubgs/followers",
      "following_url": "https://api.github.com/users/jakubgs/following{/other_user}",
      "gists_url": "https://api.github.com/users/jakubgs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jakubgs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jakubgs/subscriptions",
      "organizations_url": "https://api.github.com/users/jakubgs/orgs",
      "repos_url": "https://api.github.com/users/jakubgs/repos",
      "events_url": "https://api.github.com/users/jakubgs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jakubgs/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-25T08:49:43Z",
    "updated_at": "2021-03-25T08:49:43Z",
    "author_association": "NONE",
    "body": "Thanks for the detailed explanation. Truth be told the writeup you did in https://github.com/ethereum/go-ethereum/issues/22568#issuecomment-806468853 should probably be put somewhere in https://github.com/ethereum/go-ethereum/wiki. It explains well how the sync process works. Or even better, somewhere in https://geth.ethereum.org/docs/.\r\n\r\nAppreciate the explanation. I'll let it go for longer and see what happens.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/806474428/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/806487489",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/22568#issuecomment-806487489",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22568",
    "id": 806487489,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwNjQ4NzQ4OQ==",
    "user": {
      "login": "jakubgs",
      "id": 2212681,
      "node_id": "MDQ6VXNlcjIyMTI2ODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2212681?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jakubgs",
      "html_url": "https://github.com/jakubgs",
      "followers_url": "https://api.github.com/users/jakubgs/followers",
      "following_url": "https://api.github.com/users/jakubgs/following{/other_user}",
      "gists_url": "https://api.github.com/users/jakubgs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jakubgs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jakubgs/subscriptions",
      "organizations_url": "https://api.github.com/users/jakubgs/orgs",
      "repos_url": "https://api.github.com/users/jakubgs/repos",
      "events_url": "https://api.github.com/users/jakubgs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jakubgs/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-25T09:11:27Z",
    "updated_at": "2021-03-25T09:11:27Z",
    "author_association": "NONE",
    "body": "I see there are no metrics for snap sync progress:\r\n```\r\n > curl -s 'localhost:6060/debug/metrics/prometheus' | grep progress\r\n > curl -s 'localhost:6060/debug/metrics/prometheus' | grep sync    \r\n# TYPE rpc_duration_eth_syncing_success_count counter\r\nrpc_duration_eth_syncing_success_count 33\r\n# TYPE rpc_duration_eth_syncing_success summary\r\nrpc_duration_eth_syncing_success {quantile=\"0.5\"} 53690\r\nrpc_duration_eth_syncing_success {quantile=\"0.75\"} 57922.5\r\nrpc_duration_eth_syncing_success {quantile=\"0.95\"} 97423.8999999999\r\nrpc_duration_eth_syncing_success {quantile=\"0.99\"} 119686\r\nrpc_duration_eth_syncing_success {quantile=\"0.999\"} 119686\r\nrpc_duration_eth_syncing_success {quantile=\"0.9999\"} 119686\r\n```\r\nIs there maybe an RPC call that can give me the current snap sync progress?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/806487489/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/806488214",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/22568#issuecomment-806488214",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22568",
    "id": 806488214,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwNjQ4ODIxNA==",
    "user": {
      "login": "jakubgs",
      "id": 2212681,
      "node_id": "MDQ6VXNlcjIyMTI2ODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2212681?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jakubgs",
      "html_url": "https://github.com/jakubgs",
      "followers_url": "https://api.github.com/users/jakubgs/followers",
      "following_url": "https://api.github.com/users/jakubgs/following{/other_user}",
      "gists_url": "https://api.github.com/users/jakubgs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jakubgs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jakubgs/subscriptions",
      "organizations_url": "https://api.github.com/users/jakubgs/orgs",
      "repos_url": "https://api.github.com/users/jakubgs/repos",
      "events_url": "https://api.github.com/users/jakubgs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jakubgs/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-25T09:12:35Z",
    "updated_at": "2021-03-25T09:12:35Z",
    "author_association": "NONE",
    "body": "The only call I know about is `eth_syncing`:\r\n```\r\n > rpc.sh eth_syncing\r\n{\r\n  \"jsonrpc\": \"2.0\",\r\n  \"id\": 1,\r\n  \"result\": {\r\n    \"currentBlock\": \"0x971e94\",\r\n    \"highestBlock\": \"0x971ee5\",\r\n    \"knownStates\": \"0x0\",\r\n    \"pulledStates\": \"0x0\",\r\n    \"startingBlock\": \"0x9716ce\"\r\n  }\r\n}\r\n```\r\nBut the `knownStates` and `pulledStates` appears to show nothing.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/806488214/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/807217902",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/22568#issuecomment-807217902",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22568",
    "id": 807217902,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwNzIxNzkwMg==",
    "user": {
      "login": "jakubgs",
      "id": 2212681,
      "node_id": "MDQ6VXNlcjIyMTI2ODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2212681?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jakubgs",
      "html_url": "https://github.com/jakubgs",
      "followers_url": "https://api.github.com/users/jakubgs/followers",
      "following_url": "https://api.github.com/users/jakubgs/following{/other_user}",
      "gists_url": "https://api.github.com/users/jakubgs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jakubgs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jakubgs/subscriptions",
      "organizations_url": "https://api.github.com/users/jakubgs/orgs",
      "repos_url": "https://api.github.com/users/jakubgs/repos",
      "events_url": "https://api.github.com/users/jakubgs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jakubgs/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-25T18:14:51Z",
    "updated_at": "2021-03-25T18:14:51Z",
    "author_association": "NONE",
    "body": "Okay, looks like the full snap sync took almost 24 hours and take up about ~100 GB:\r\n\r\n![image](https://user-images.githubusercontent.com/2212681/112522322-c639f100-8d9d-11eb-89f2-975603d73dc6.png)\r\n\r\nThe initial block sync does most of the job in the first ~7 hours, after that the state trie sync took ~17 hours.\r\n\r\nThough I'd really like to see the progress indicators in the `eth_syncing` RPC call and/or via the metrics endpoint.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/807217902/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
