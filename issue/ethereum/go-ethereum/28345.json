{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28345",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28345/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28345/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28345/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/28345",
  "id": 1943898255,
  "node_id": "I_kwDOAOvK985z3YiP",
  "number": 28345,
  "title": "Parameter for a threshold value of peers removed that are delivering stale transaction or generally misbehave",
  "user": {
    "login": "drozdse1",
    "id": 3651703,
    "node_id": "MDQ6VXNlcjM2NTE3MDM=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3651703?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/drozdse1",
    "html_url": "https://github.com/drozdse1",
    "followers_url": "https://api.github.com/users/drozdse1/followers",
    "following_url": "https://api.github.com/users/drozdse1/following{/other_user}",
    "gists_url": "https://api.github.com/users/drozdse1/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/drozdse1/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/drozdse1/subscriptions",
    "organizations_url": "https://api.github.com/users/drozdse1/orgs",
    "repos_url": "https://api.github.com/users/drozdse1/repos",
    "events_url": "https://api.github.com/users/drozdse1/events{/privacy}",
    "received_events_url": "https://api.github.com/users/drozdse1/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 72233652,
      "node_id": "MDU6TGFiZWw3MjIzMzY1Mg==",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/type:feature",
      "name": "type:feature",
      "color": "84b6eb",
      "default": false,
      "description": null
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2023-10-15T13:53:07Z",
  "updated_at": "2023-10-17T12:50:25Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "# Rationale\r\n\r\nAfter updating my client I see often the following entries in my Geth log file:\r\n\r\n```\r\nWARN [10-15|13:31:24.568] Peer delivering stale transactions       peer=5cfee384dfdda5892f9d64f651ead855f8e0fb11e80b39a13274d47d2fb719a9 rejected=41\r\nWARN [10-15|13:31:24.789] Peer delivering stale transactions       peer=5cfee384dfdda5892f9d64f651ead855f8e0fb11e80b39a13274d47d2fb719a9 rejected=65\r\n\r\n...\r\n\r\nWARN [10-15|13:31:32.312] Peer delivering stale transactions       peer=536a69c3ffea7e8201c15b170996b3f305a830cbd2f65dcfb135de0cb96d75fc rejected=128\r\nWARN [10-15|13:31:33.006] Peer delivering stale transactions       peer=a4851bd6344c4b770a0a720e6b7d21ced3681d11d07ab91b3396766fa2fe6713 rejected=128\r\n```\r\n\r\nFor now I removing the causing peer manually through the console:\r\n\r\n`admin.removePeer()`\r\n\r\n# Implementation\r\n\r\nIt would be very helpful if there could be a parameter to specify the maximal number of misbehaviours per peer and if this is exceeded, the corresponding peer is automatically removed or blocked for a specific period.\r\n\r\nThe misbehaviour could, of course, be related to other typical problems that lead to other warnings in the log file or are generally a danger to the stability of the Geth application.",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28345/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28345/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1763946191",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/28345#issuecomment-1763946191",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28345",
    "id": 1763946191,
    "node_id": "IC_kwDOAOvK985pI67P",
    "user": {
      "login": "drozdse1",
      "id": 3651703,
      "node_id": "MDQ6VXNlcjM2NTE3MDM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3651703?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/drozdse1",
      "html_url": "https://github.com/drozdse1",
      "followers_url": "https://api.github.com/users/drozdse1/followers",
      "following_url": "https://api.github.com/users/drozdse1/following{/other_user}",
      "gists_url": "https://api.github.com/users/drozdse1/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/drozdse1/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/drozdse1/subscriptions",
      "organizations_url": "https://api.github.com/users/drozdse1/orgs",
      "repos_url": "https://api.github.com/users/drozdse1/repos",
      "events_url": "https://api.github.com/users/drozdse1/events{/privacy}",
      "received_events_url": "https://api.github.com/users/drozdse1/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-10-16T08:06:46Z",
    "updated_at": "2023-10-16T08:16:22Z",
    "author_association": "NONE",
    "body": "I have created bash script which is doing something similar as requested.\r\n\r\n```\r\n#!/bin/bash\r\n\r\ncontainer_name=\"eth-docker-execution-1\"\r\ndesired_event_pattern=\"Peer delivering stale transactions\"\r\nthreshold=20  # Number of consecutive occurrences\r\n\r\ndeclare -A peer_counts\r\n\r\n# Function to perform the action\r\nperform_action() {\r\n  local peer_id=\"$1\"\r\n  local count=${peer_counts[$peer_id]}\r\n  echo \"Performing action for peer ID: $peer_id since '$desired_event_pattern' occurred $count times consecutively.\"\r\n\r\n  # Add your action here, such as notification commands or script execution.\r\n  # Execute the docker exec command to remove the peer\r\n  docker exec -t \"$container_name\" geth attach --datadir /var/lib/goethereum --exec \"admin.removePeer(admin.peers.find((item) => item.id == '$peer_id').enode)\"\r\n\r\n  peer_counts[\"$peer_id\"]=0  # Reset the counter for this peer\r\n}\r\n\r\n# Monitor the Docker container logs\r\ndocker logs \"$container_name\" 2>&1 -f --since 1m | while read line\r\ndo\r\n  if [[ \"$line\" =~ $desired_event_pattern ]]; then\r\n    # Extract the peer ID from the log message\r\n    peer_id=$(echo \"$line\" | grep -oP 'peer=\\K[^ ]+')\r\n    echo \"Peer ID: $peer_id\"\r\n\r\n    if [ -z \"${peer_counts[$peer_id]}\" ]; then\r\n      peer_counts[\"$peer_id\"]=1\r\n    else\r\n      ((peer_counts[\"$peer_id\"]++))\r\n    fi\r\n\r\n    if [ \"${peer_counts[$peer_id]}\" -ge \"$threshold\" ]; then\r\n      perform_action \"$peer_id\"\r\n      peer_counts[\"$peer_id\"]=0  # Reset the counter for this peer\r\n    fi\r\n  else\r\n    # When the event pattern is not found, decrease the counter for all observed peer IDs.\r\n    # The regular INFO logs for newly created blocks serve as a natural clock to decrease the counter again.\r\n    for observed_peer_id in \"${!peer_counts[@]}\"; do\r\n      if [ -n \"${peer_counts[$observed_peer_id]}\" ]; then\r\n        ((peer_counts[\"$observed_peer_id\"]--))\r\n        if [ \"${peer_counts[$observed_peer_id]}\" -le 0 ]; then\r\n          unset peer_counts[\"$observed_peer_id\"]  # Remove peer ID from observation if count reaches or goes below 0\r\n        fi\r\n      fi\r\n    done\r\n  fi\r\ndone\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1763946191/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1765328145",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/28345#issuecomment-1765328145",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28345",
    "id": 1765328145,
    "node_id": "IC_kwDOAOvK985pOMUR",
    "user": {
      "login": "lightclient",
      "id": 14004106,
      "node_id": "MDQ6VXNlcjE0MDA0MTA2",
      "avatar_url": "https://avatars.githubusercontent.com/u/14004106?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/lightclient",
      "html_url": "https://github.com/lightclient",
      "followers_url": "https://api.github.com/users/lightclient/followers",
      "following_url": "https://api.github.com/users/lightclient/following{/other_user}",
      "gists_url": "https://api.github.com/users/lightclient/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/lightclient/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/lightclient/subscriptions",
      "organizations_url": "https://api.github.com/users/lightclient/orgs",
      "repos_url": "https://api.github.com/users/lightclient/repos",
      "events_url": "https://api.github.com/users/lightclient/events{/privacy}",
      "received_events_url": "https://api.github.com/users/lightclient/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-10-16T21:46:19Z",
    "updated_at": "2023-10-16T21:46:19Z",
    "author_association": "MEMBER",
    "body": "I think an issue with disconnecting from a peer who is delivering stale transactions is that they may not be stale yet to them if they are behind the chain for any reason and disconnecting could exasperate the problem. Sleeping a bit before engaging the peer further seems appropriate.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1765328145/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1765893810",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/28345#issuecomment-1765893810",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28345",
    "id": 1765893810,
    "node_id": "IC_kwDOAOvK985pQWay",
    "user": {
      "login": "SjonHortensius",
      "id": 1684987,
      "node_id": "MDQ6VXNlcjE2ODQ5ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1684987?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/SjonHortensius",
      "html_url": "https://github.com/SjonHortensius",
      "followers_url": "https://api.github.com/users/SjonHortensius/followers",
      "following_url": "https://api.github.com/users/SjonHortensius/following{/other_user}",
      "gists_url": "https://api.github.com/users/SjonHortensius/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/SjonHortensius/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/SjonHortensius/subscriptions",
      "organizations_url": "https://api.github.com/users/SjonHortensius/orgs",
      "repos_url": "https://api.github.com/users/SjonHortensius/repos",
      "events_url": "https://api.github.com/users/SjonHortensius/events{/privacy}",
      "received_events_url": "https://api.github.com/users/SjonHortensius/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-10-17T08:10:46Z",
    "updated_at": "2023-10-17T08:10:46Z",
    "author_association": "CONTRIBUTOR",
    "body": "I have similar issues. I see ~15K/hour _Peer delivering stale transactions_ supposed warnings - (but I'm not able to fix anything) and ~25K/hour _Announced transaction size mismatch_ messages\r\n\r\nI realize this is triggered by external factors but it seems excessive for something I cannot control",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1765893810/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1766304849",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/28345#issuecomment-1766304849",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28345",
    "id": 1766304849,
    "node_id": "IC_kwDOAOvK985pR6xR",
    "user": {
      "login": "lightclient",
      "id": 14004106,
      "node_id": "MDQ6VXNlcjE0MDA0MTA2",
      "avatar_url": "https://avatars.githubusercontent.com/u/14004106?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/lightclient",
      "html_url": "https://github.com/lightclient",
      "followers_url": "https://api.github.com/users/lightclient/followers",
      "following_url": "https://api.github.com/users/lightclient/following{/other_user}",
      "gists_url": "https://api.github.com/users/lightclient/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/lightclient/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/lightclient/subscriptions",
      "organizations_url": "https://api.github.com/users/lightclient/orgs",
      "repos_url": "https://api.github.com/users/lightclient/repos",
      "events_url": "https://api.github.com/users/lightclient/events{/privacy}",
      "received_events_url": "https://api.github.com/users/lightclient/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-10-17T12:20:43Z",
    "updated_at": "2023-10-17T12:20:43Z",
    "author_association": "MEMBER",
    "body": "@SjonHortensius thanks for the report. The log level is a slightly different issue than modifying the actual handling of the peer. I think downgrading the error could make sense.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1766304849/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1766355318",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/28345#issuecomment-1766355318",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28345",
    "id": 1766355318,
    "node_id": "IC_kwDOAOvK985pSHF2",
    "user": {
      "login": "karalabe",
      "id": 129561,
      "node_id": "MDQ6VXNlcjEyOTU2MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/karalabe",
      "html_url": "https://github.com/karalabe",
      "followers_url": "https://api.github.com/users/karalabe/followers",
      "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
      "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
      "organizations_url": "https://api.github.com/users/karalabe/orgs",
      "repos_url": "https://api.github.com/users/karalabe/repos",
      "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
      "received_events_url": "https://api.github.com/users/karalabe/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-10-17T12:50:25Z",
    "updated_at": "2023-10-17T12:50:25Z",
    "author_association": "MEMBER",
    "body": "@SjonHortensius @lightclient The announces tx issue has been \"fixed\" on latest release.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1766355318/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
