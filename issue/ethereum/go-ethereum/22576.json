{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22576",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22576/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22576/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22576/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/22576",
  "id": 841298828,
  "node_id": "MDU6SXNzdWU4NDEyOTg4Mjg=",
  "number": 22576,
  "title": "Getting events twice or more when subscribing using Watchxxxx methods",
  "user": {
    "login": "hhio618",
    "id": 1272158,
    "node_id": "MDQ6VXNlcjEyNzIxNTg=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1272158?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/hhio618",
    "html_url": "https://github.com/hhio618",
    "followers_url": "https://api.github.com/users/hhio618/followers",
    "following_url": "https://api.github.com/users/hhio618/following{/other_user}",
    "gists_url": "https://api.github.com/users/hhio618/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/hhio618/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/hhio618/subscriptions",
    "organizations_url": "https://api.github.com/users/hhio618/orgs",
    "repos_url": "https://api.github.com/users/hhio618/repos",
    "events_url": "https://api.github.com/users/hhio618/events{/privacy}",
    "received_events_url": "https://api.github.com/users/hhio618/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 72233650,
      "node_id": "MDU6TGFiZWw3MjIzMzY1MA==",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/type:bug",
      "name": "type:bug",
      "color": "FF5E5E",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2021-03-25T20:51:47Z",
  "updated_at": "2021-03-28T18:07:28Z",
  "closed_at": "2021-03-28T18:07:28Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "#### System information\r\nGeth version: `1.10.1-stable`\r\nOS & Version: GNU/Linux\r\n\r\n#### Expected behaviour\r\nNot getting same NewChallenge event twice or more!\r\n\r\n#### Actual behaviour\r\nWhen subscribing to [Tellor oracle](https://rinkeby.etherscan.io/address/0x88df592f8eb5d7bd38bfef7deb0fbc02cf3778a0) events, sometimes we received same NewChallenge event twice or more even if there is no duplicate event in the oracle.\r\n\r\n#### Steps to reproduce the behaviour\r\nSnippet to reproduce:\r\n```\r\npackage main\r\n\r\nimport (\r\n\t\"bytes\"\r\n\t\"fmt\"\r\n\t\"log\"\r\n\t\"time\"\r\n\r\n\t\"github.com/ethereum/go-ethereum/accounts/abi/bind\"\r\n\t\"github.com/ethereum/go-ethereum/common\"\r\n\t\"github.com/ethereum/go-ethereum/ethclient\"\r\n\t\"github.com/ethereum/go-ethereum/event\"\r\n\t\"github.com/pkg/errors\"\r\n\t\"github.com/tellor-io/telliot/pkg/contracts/tellor\"\r\n)\r\n\r\nfunc main() {\r\n\tclient, err := ethclient.Dial(\"...........\")\r\n\tif err != nil {\r\n\t\tlog.Fatal(err)\r\n\t}\r\n\r\n\t// Subscribe and wait until the context cancellation event.\r\n\tvar sink chan *tellor.ITellorNewChallenge\r\n\tvar sub event.Subscription\r\n\tvar challenge *tellor.ITellorNewChallenge\r\n\tfor {\r\n\t\tselect {\r\n\t\tcase err := <-sub.Err():\r\n\t\t\tif err != nil {\r\n\t\t\t\tfmt.Printf(\"subscription error: %v\", err)\r\n\t\t\t}\r\n\t\t\t// Trying to resubscribe until it succeeds.\r\n\t\t\tfor {\r\n\t\t\t\tsink, sub, err = getNewChallengeChannel(client)\r\n\t\t\t\tif err != nil {\r\n\t\t\t\t\tfmt.Printf(\"re-subscribing to NewChallenge events failed\")\r\n\t\t\t\t\ttime.Sleep(1 * time.Second)\r\n\t\t\t\t\tcontinue\r\n\t\t\t\t}\r\n\t\t\t\tbreak\r\n\t\t\t}\r\n\t\t\tfmt.Println(\"re-subscribed to NewChallenge events\")\r\n\t\tcase newChallenge := <-sink:\r\n\t\t\tif challenge != nil && bytes.Equal(challenge.CurrentChallenge[:], newChallenge.CurrentChallenge[:]) {\r\n\t\t\t\tfmt.Printf(\"same challenge received twice\")\r\n\t\t\t}\r\n                        challenge = newChallenge\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunc getNewChallengeChannel(client *ethclient.Client) (chan *tellor.ITellorNewChallenge, event.Subscription, error) {\r\n\tsink := make(chan *tellor.ITellorNewChallenge)\r\n\tvar tellorFilterer *tellor.ITellorFilterer\r\n\ttellorFilterer, err := tellor.NewITellorFilterer(common.HexToAddress(\"0x88df592f8eb5d7bd38bfef7deb0fbc02cf3778a0\"), client)\r\n\tif err != nil {\r\n\t\treturn nil, nil, errors.Wrap(err, \"getting ITellorFilterer instance\")\r\n\t}\r\n\tsub, err := tellorFilterer.WatchNewChallenge(&bind.WatchOpts{}, sink, nil)\r\n\tif err != nil {\r\n\t\treturn nil, nil, errors.Wrap(err, \"getting NewChallenge channel\")\r\n\t}\r\n\treturn sink, sub, nil\r\n}\r\n```\r\ncc @krasi-georgiev",
  "closed_by": {
    "login": "hhio618",
    "id": 1272158,
    "node_id": "MDQ6VXNlcjEyNzIxNTg=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1272158?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/hhio618",
    "html_url": "https://github.com/hhio618",
    "followers_url": "https://api.github.com/users/hhio618/followers",
    "following_url": "https://api.github.com/users/hhio618/following{/other_user}",
    "gists_url": "https://api.github.com/users/hhio618/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/hhio618/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/hhio618/subscriptions",
    "organizations_url": "https://api.github.com/users/hhio618/orgs",
    "repos_url": "https://api.github.com/users/hhio618/repos",
    "events_url": "https://api.github.com/users/hhio618/events{/privacy}",
    "received_events_url": "https://api.github.com/users/hhio618/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22576/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22576/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/808245238",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/22576#issuecomment-808245238",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22576",
    "id": 808245238,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwODI0NTIzOA==",
    "user": {
      "login": "MariusVanDerWijden",
      "id": 16664698,
      "node_id": "MDQ6VXNlcjE2NjY0Njk4",
      "avatar_url": "https://avatars.githubusercontent.com/u/16664698?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MariusVanDerWijden",
      "html_url": "https://github.com/MariusVanDerWijden",
      "followers_url": "https://api.github.com/users/MariusVanDerWijden/followers",
      "following_url": "https://api.github.com/users/MariusVanDerWijden/following{/other_user}",
      "gists_url": "https://api.github.com/users/MariusVanDerWijden/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MariusVanDerWijden/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MariusVanDerWijden/subscriptions",
      "organizations_url": "https://api.github.com/users/MariusVanDerWijden/orgs",
      "repos_url": "https://api.github.com/users/MariusVanDerWijden/repos",
      "events_url": "https://api.github.com/users/MariusVanDerWijden/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MariusVanDerWijden/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-26T14:03:19Z",
    "updated_at": "2021-03-26T14:03:19Z",
    "author_association": "MEMBER",
    "body": "The problem with events  is that in the case of a reorg, two events can be fired. \r\nE.g. if the transaction is included in a block, which later gets reorged and the transaction is included again in the next block.\r\nThen two events are (rightfully so) fired. It is up to the user to deduplicate these events as we can't really un-send the event once we pushed it out. To be safe, you need to wait for multiple blocks anyway until you can be sure that the event happened. \r\nIf you experience multiple events even if no reorg happened, then something is wrong on our side that we need to fix.\r\nCan you check if the multiple events coincide with reorgs?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/808245238/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/808264555",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/22576#issuecomment-808264555",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22576",
    "id": 808264555,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwODI2NDU1NQ==",
    "user": {
      "login": "krasi-georgiev",
      "id": 8903888,
      "node_id": "MDQ6VXNlcjg5MDM4ODg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8903888?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/krasi-georgiev",
      "html_url": "https://github.com/krasi-georgiev",
      "followers_url": "https://api.github.com/users/krasi-georgiev/followers",
      "following_url": "https://api.github.com/users/krasi-georgiev/following{/other_user}",
      "gists_url": "https://api.github.com/users/krasi-georgiev/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/krasi-georgiev/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/krasi-georgiev/subscriptions",
      "organizations_url": "https://api.github.com/users/krasi-georgiev/orgs",
      "repos_url": "https://api.github.com/users/krasi-georgiev/repos",
      "events_url": "https://api.github.com/users/krasi-georgiev/events{/privacy}",
      "received_events_url": "https://api.github.com/users/krasi-georgiev/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-26T14:29:56Z",
    "updated_at": "2021-03-26T14:30:25Z",
    "author_association": "NONE",
    "body": "Waiting for multiple blocks sound like a reasonable solution. \r\n\r\nCould you give an example code to do that?\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/808264555/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/808819132",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/22576#issuecomment-808819132",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22576",
    "id": 808819132,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwODgxOTEzMg==",
    "user": {
      "login": "krasi-georgiev",
      "id": 8903888,
      "node_id": "MDQ6VXNlcjg5MDM4ODg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8903888?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/krasi-georgiev",
      "html_url": "https://github.com/krasi-georgiev",
      "followers_url": "https://api.github.com/users/krasi-georgiev/followers",
      "following_url": "https://api.github.com/users/krasi-georgiev/following{/other_user}",
      "gists_url": "https://api.github.com/users/krasi-georgiev/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/krasi-georgiev/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/krasi-georgiev/subscriptions",
      "organizations_url": "https://api.github.com/users/krasi-georgiev/orgs",
      "repos_url": "https://api.github.com/users/krasi-georgiev/repos",
      "events_url": "https://api.github.com/users/krasi-georgiev/events{/privacy}",
      "received_events_url": "https://api.github.com/users/krasi-georgiev/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-27T23:51:45Z",
    "updated_at": "2021-03-27T23:51:45Z",
    "author_association": "NONE",
    "body": "I did a bit more reading and testing and can confirm that this is due to reorg.\r\nAdded some code to use the event only when the tx that emitted the event is confirmed and it all now looks great.\r\n\r\n@hhio618 you can close it.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/808819132/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/808934421",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/22576#issuecomment-808934421",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22576",
    "id": 808934421,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwODkzNDQyMQ==",
    "user": {
      "login": "hhio618",
      "id": 1272158,
      "node_id": "MDQ6VXNlcjEyNzIxNTg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1272158?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hhio618",
      "html_url": "https://github.com/hhio618",
      "followers_url": "https://api.github.com/users/hhio618/followers",
      "following_url": "https://api.github.com/users/hhio618/following{/other_user}",
      "gists_url": "https://api.github.com/users/hhio618/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hhio618/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hhio618/subscriptions",
      "organizations_url": "https://api.github.com/users/hhio618/orgs",
      "repos_url": "https://api.github.com/users/hhio618/repos",
      "events_url": "https://api.github.com/users/hhio618/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hhio618/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-28T18:07:19Z",
    "updated_at": "2021-03-28T18:07:19Z",
    "author_association": "NONE",
    "body": "Thanks @MariusVanDerWijden @krasi-georgiev.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/808934421/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
