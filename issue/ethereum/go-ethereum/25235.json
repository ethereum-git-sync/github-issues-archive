{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/25235",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/25235/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/25235/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/25235/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/25235",
  "id": 1293359962,
  "node_id": "I_kwDOAOvK985NFxta",
  "number": 25235,
  "title": "Light client can't get state for older block",
  "user": {
    "login": "s1na",
    "id": 1591639,
    "node_id": "MDQ6VXNlcjE1OTE2Mzk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1591639?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/s1na",
    "html_url": "https://github.com/s1na",
    "followers_url": "https://api.github.com/users/s1na/followers",
    "following_url": "https://api.github.com/users/s1na/following{/other_user}",
    "gists_url": "https://api.github.com/users/s1na/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/s1na/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/s1na/subscriptions",
    "organizations_url": "https://api.github.com/users/s1na/orgs",
    "repos_url": "https://api.github.com/users/s1na/repos",
    "events_url": "https://api.github.com/users/s1na/events{/privacy}",
    "received_events_url": "https://api.github.com/users/s1na/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 72233650,
      "node_id": "MDU6TGFiZWw3MjIzMzY1MA==",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/type:bug",
      "name": "type:bug",
      "color": "FF5E5E",
      "default": false,
      "description": ""
    },
    {
      "id": 841716348,
      "node_id": "MDU6TGFiZWw4NDE3MTYzNDg=",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/area:les",
      "name": "area:les",
      "color": "c2e0c6",
      "default": false,
      "description": null
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2022-07-04T16:18:37Z",
  "updated_at": "2022-07-18T01:40:06Z",
  "closed_at": null,
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "I have a light server and a light client running at the same time which are peered up to one-another (and nothing else). The light client cannot get the state from an older block even tho the server has that state available. See console logs:\r\n\r\nServer:\r\n\r\n```console\r\n> eth.blockNumber\r\n15045810\r\n> debug.getAccessibleState(eth.blockNumber-2, eth.blockNumber)\r\n15045809\r\n> debug.getAccessibleState(eth.blockNumber-1280, eth.blockNumber)\r\n15045683\r\n> debug.getAccessibleState(eth.blockNumber-12800, eth.blockNumber)\r\n15035214\r\n> eth.getTransactionCount('0xEA674fdDe714fd979de3EdF0F56AA9716B898ec8', web3.toHex(15035214))\r\n43582525\r\n```\r\n\r\nClient:\r\n\r\n```console\r\n> eth.getTransactionCount('0xEA674fdDe714fd979de3EdF0F56AA9716B898ec8', web3.toHex(15045809))\r\n43615173\r\n> eth.getTransactionCount('0xEA674fdDe714fd979de3EdF0F56AA9716B898ec8', web3.toHex(15045683))\r\n43614896\r\n> eth.getTransactionCount('0xEA674fdDe714fd979de3EdF0F56AA9716B898ec8', web3.toHex(15035214))\r\nError: getDeleteStateObject (ea674fdde714fd979de3edf0f56aa9716b898ec8) error: no suitable peers available\r\n        at web3.js:6365:37(47)\r\n        at send (web3.js:5099:62(35))\r\n        at <eval>:1:24(9)\r\n```\r\n\r\nSomething I noticed is the older state goes through the HelperTrie:\r\n\r\n```console\r\nDEBUG[07-04|14:14:23.612] Requesting CHT                           id=17b99695e530823c conn=dyndial cht=458 block=14,996,201\r\nDEBUG[07-04|14:14:23.612] Fetching batch of HelperTrie proofs      id=17b99695e530823c conn=dyndial count=1\r\nTRACE[07-04|14:14:23.613] Light Ethereum message arrived           id=17b99695e530823c conn=dyndial code=18 bytes=3495\r\nTRACE[07-04|14:14:23.613] Received helper trie proof response      id=17b99695e530823c conn=dyndial\r\nDEBUG[07-04|14:14:23.613] Validating CHT                           cht=458 block=14,996,201\r\nWARN [07-04|14:14:26.614] Served eth_getTransactionCount           reqid=66 duration=3.002109651s err=\"getDeleteStateObject (ea674fdde714fd979de3edf0f56aa9716b898ec8) erro\r\nr: no suitable peers available\"\r\n```\r\n\r\nWhereas the recent state requests:\r\n\r\n```console\r\nDEBUG[07-04|16:00:51.439] Requesting trie proof                    id=17b99695e530823c conn=dyndial root=d41b85..6a060f key=\"[89 231 68 154 172 237 104 59 60 168 130 105 1\r\n6 24 46 102 68 79 22 218 87 93 151 81 178 138 89 244 78 112 208 177]\"\r\nDEBUG[07-04|16:00:51.439] Fetching batch of proofs                 id=17b99695e530823c conn=dyndial count=1\r\nTRACE[07-04|16:00:51.441] Light Ethereum message arrived           id=17b99695e530823c conn=dyndial code=16 bytes=3637\r\nTRACE[07-04|16:00:51.441] Received les/2 proofs response           id=17b99695e530823c conn=dyndial\r\nDEBUG[07-04|16:00:51.441] Validating trie proof                    root=d41b85..6a060f key=\"[89 231 68 154 172 237 104 59 60 168 130 105 16 24 46 102 68 79 22 218 87 93 15\r\n1 81 178 138 89 244 78 112 208 177]\"\r\n```",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/25235/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/25235/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1174563614",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/25235#issuecomment-1174563614",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/25235",
    "id": 1174563614,
    "node_id": "IC_kwDOAOvK985GAmse",
    "user": {
      "login": "rjl493456442",
      "id": 5959481,
      "node_id": "MDQ6VXNlcjU5NTk0ODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5959481?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rjl493456442",
      "html_url": "https://github.com/rjl493456442",
      "followers_url": "https://api.github.com/users/rjl493456442/followers",
      "following_url": "https://api.github.com/users/rjl493456442/following{/other_user}",
      "gists_url": "https://api.github.com/users/rjl493456442/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rjl493456442/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rjl493456442/subscriptions",
      "organizations_url": "https://api.github.com/users/rjl493456442/orgs",
      "repos_url": "https://api.github.com/users/rjl493456442/repos",
      "events_url": "https://api.github.com/users/rjl493456442/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rjl493456442/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-05T03:27:14Z",
    "updated_at": "2022-07-05T03:27:14Z",
    "author_association": "MEMBER",
    "body": "In this request \r\n\r\n```\r\n> eth.getTransactionCount('0xEA674fdDe714fd979de3EdF0F56AA9716B898ec8', web3.toHex(15035214))\r\n43582525\r\n```\r\n\r\nBlock `15035214` should be requested(because it's pruned). However from the log, it said \r\n```\r\nDEBUG[07-04|14:14:23.613] Validating CHT                           cht=458 block=14,996,201\r\n```\r\n\r\nI guess logs are not matched?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1174563614/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1176509638",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/25235#issuecomment-1176509638",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/25235",
    "id": 1176509638,
    "node_id": "IC_kwDOAOvK985GIBzG",
    "user": {
      "login": "s1na",
      "id": 1591639,
      "node_id": "MDQ6VXNlcjE1OTE2Mzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1591639?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/s1na",
      "html_url": "https://github.com/s1na",
      "followers_url": "https://api.github.com/users/s1na/followers",
      "following_url": "https://api.github.com/users/s1na/following{/other_user}",
      "gists_url": "https://api.github.com/users/s1na/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/s1na/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/s1na/subscriptions",
      "organizations_url": "https://api.github.com/users/s1na/orgs",
      "repos_url": "https://api.github.com/users/s1na/repos",
      "events_url": "https://api.github.com/users/s1na/events{/privacy}",
      "received_events_url": "https://api.github.com/users/s1na/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-06T17:48:58Z",
    "updated_at": "2022-07-06T17:48:58Z",
    "author_association": "MEMBER",
    "body": "@rjl493456442 yeah I tried again and I'm not getting those helper trie logs again, it was probably a mistake on my part. I just get\r\n\r\n```\r\nWARN [07-06|17:45:36.915] Served eth_getTransactionCount           reqid=80 duration=3.00169405s err=\"getDeleteStateObject (ea674fdde714fd979de3edf0f56aa9716b898ec8) error: no suitable peers available\"\r\n```\r\n\r\neven with `--vmodule p2p=5,les=5,light=5`.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1176509638/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1176968705",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/25235#issuecomment-1176968705",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/25235",
    "id": 1176968705,
    "node_id": "IC_kwDOAOvK985GJx4B",
    "user": {
      "login": "rjl493456442",
      "id": 5959481,
      "node_id": "MDQ6VXNlcjU5NTk0ODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5959481?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rjl493456442",
      "html_url": "https://github.com/rjl493456442",
      "followers_url": "https://api.github.com/users/rjl493456442/followers",
      "following_url": "https://api.github.com/users/rjl493456442/following{/other_user}",
      "gists_url": "https://api.github.com/users/rjl493456442/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rjl493456442/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rjl493456442/subscriptions",
      "organizations_url": "https://api.github.com/users/rjl493456442/orgs",
      "repos_url": "https://api.github.com/users/rjl493456442/repos",
      "events_url": "https://api.github.com/users/rjl493456442/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rjl493456442/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-07T02:21:27Z",
    "updated_at": "2022-07-07T02:21:27Z",
    "author_association": "MEMBER",
    "body": "```go\r\n// Refuse to search stale state data in the database since looking for\r\n// a non-exist key is kind of expensive.\r\nlocal := bc.CurrentHeader().Number.Uint64()\r\nif !backend.ArchiveMode() && header.Number.Uint64()+core.TriesInMemory <= local {\r\n\tp.Log().Debug(\"Reject stale trie request\", \"number\", header.Number.Uint64(), \"head\", local)\r\n\tp.bumpInvalid()\r\n\tcontinue\r\n}\r\nroot = header.Root\r\n```\r\n\r\nSo In LES Server, it will only serve the latest 128 states, even it has the historic state available locally.\r\nThis explains why you get this error.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1176968705/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 1
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1177271009",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/25235#issuecomment-1177271009",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/25235",
    "id": 1177271009,
    "node_id": "IC_kwDOAOvK985GK7rh",
    "user": {
      "login": "fjl",
      "id": 6915,
      "node_id": "MDQ6VXNlcjY5MTU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6915?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjl",
      "html_url": "https://github.com/fjl",
      "followers_url": "https://api.github.com/users/fjl/followers",
      "following_url": "https://api.github.com/users/fjl/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjl/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjl/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjl/subscriptions",
      "organizations_url": "https://api.github.com/users/fjl/orgs",
      "repos_url": "https://api.github.com/users/fjl/repos",
      "events_url": "https://api.github.com/users/fjl/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjl/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-07T08:51:44Z",
    "updated_at": "2022-07-07T08:51:44Z",
    "author_association": "MEMBER",
    "body": "I think we could create an option that disables this check in LES server.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1177271009/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
