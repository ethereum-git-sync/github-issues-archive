{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18437",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18437/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18437/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18437/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/18437",
  "id": 398490357,
  "node_id": "MDU6SXNzdWUzOTg0OTAzNTc=",
  "number": 18437,
  "title": "light: submitting tx to light client connected to single light server causes disconnection",
  "user": {
    "login": "flgh",
    "id": 33400822,
    "node_id": "MDQ6VXNlcjMzNDAwODIy",
    "avatar_url": "https://avatars.githubusercontent.com/u/33400822?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/flgh",
    "html_url": "https://github.com/flgh",
    "followers_url": "https://api.github.com/users/flgh/followers",
    "following_url": "https://api.github.com/users/flgh/following{/other_user}",
    "gists_url": "https://api.github.com/users/flgh/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/flgh/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/flgh/subscriptions",
    "organizations_url": "https://api.github.com/users/flgh/orgs",
    "repos_url": "https://api.github.com/users/flgh/repos",
    "events_url": "https://api.github.com/users/flgh/events{/privacy}",
    "received_events_url": "https://api.github.com/users/flgh/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2019-01-11T23:35:47Z",
  "updated_at": "2019-06-19T18:48:20Z",
  "closed_at": "2019-06-19T18:48:20Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "#### System information\r\nGeth\r\nVersion: 1.8.20-stable\r\nGit Commit: 24d727b6d6e2c0cde222fa12155c4a6db5caaf2e\r\nArchitecture: amd64\r\nProtocol Versions: [63 62]\r\nNetwork Id: 1\r\nGo Version: go1.10.2\r\nOperating System: linux\r\nGOPATH=\r\nGOROOT=/usr/local/go\r\n\r\n2 clients: 1 full node connected to mainnet, light client connected only to the full node.\r\nSame geth version on the light and full.\r\n\r\n#### Expected behaviour\r\nSubmitted transactions are propagated from the light client to the full node.\r\n\r\n#### Actual behaviour\r\nTransactions are not always propagated from the light client to the full node, when it fails, it looks like every time the light client reconnects to the full node it downloads the headers and then is disconnected when trying to submit the pending tx (empty admin.peers, tx pending in txpool.status on the light client)\r\n\r\nEvery time the light client reconnects, the following message is printed on the console of the full node and the client is disconnected:\r\nERROR[01-11|17:35:57.760] Request came too early                   id=xxx conn=trusted-inbound recharge=1.714s\r\nERROR[01-11|17:36:03.014] Request came too early                   id=xxx conn=trusted-inbound recharge=2.859s\r\n\r\nA restart of the light client and resubmit of the tx gets it through, but submiting a new tx some time after, the same disconnection an \"Request came too early\" behavior is observed on the full node, prompting another restart of the light client.\r\n\r\n#### Steps to reproduce the behaviour\r\nRunning a light node (--nodiscover --netrestrict xxx.xx.xxx.xx/32 --maxpeers 1 --port 30305 --syncmode light) connected to a full node (--lightserv 8 --lightpeers 18 --maxpeers 48), so only one peer on the light client.\r\n\r\nSend some tx from an account on the light client.\r\n\r\n####\r\n\"Request came too early\" message is also triggered from some \r\nother publicly connected light clients.\r\n",
  "closed_by": {
    "login": "holiman",
    "id": 142290,
    "node_id": "MDQ6VXNlcjE0MjI5MA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/holiman",
    "html_url": "https://github.com/holiman",
    "followers_url": "https://api.github.com/users/holiman/followers",
    "following_url": "https://api.github.com/users/holiman/following{/other_user}",
    "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
    "organizations_url": "https://api.github.com/users/holiman/orgs",
    "repos_url": "https://api.github.com/users/holiman/repos",
    "events_url": "https://api.github.com/users/holiman/events{/privacy}",
    "received_events_url": "https://api.github.com/users/holiman/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18437/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18437/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/454084652",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/18437#issuecomment-454084652",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18437",
    "id": 454084652,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ1NDA4NDY1Mg==",
    "user": {
      "login": "veox",
      "id": 3036030,
      "node_id": "MDQ6VXNlcjMwMzYwMzA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3036030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/veox",
      "html_url": "https://github.com/veox",
      "followers_url": "https://api.github.com/users/veox/followers",
      "following_url": "https://api.github.com/users/veox/following{/other_user}",
      "gists_url": "https://api.github.com/users/veox/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/veox/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/veox/subscriptions",
      "organizations_url": "https://api.github.com/users/veox/orgs",
      "repos_url": "https://api.github.com/users/veox/repos",
      "events_url": "https://api.github.com/users/veox/events{/privacy}",
      "received_events_url": "https://api.github.com/users/veox/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-01-14T17:13:53Z",
    "updated_at": "2019-01-14T17:13:53Z",
    "author_association": "CONTRIBUTOR",
    "body": "Error comes from here:\r\n\r\nhttps://github.com/ethereum/go-ethereum/blob/30cd5c18549f645002aedb4c00e5bab683cb0835/les/handler.go#L344-L353\r\n\r\nHow big are the transactions you're submitting?..",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/454084652/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/454085821",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/18437#issuecomment-454085821",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18437",
    "id": 454085821,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ1NDA4NTgyMQ==",
    "user": {
      "login": "flgh",
      "id": 33400822,
      "node_id": "MDQ6VXNlcjMzNDAwODIy",
      "avatar_url": "https://avatars.githubusercontent.com/u/33400822?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/flgh",
      "html_url": "https://github.com/flgh",
      "followers_url": "https://api.github.com/users/flgh/followers",
      "following_url": "https://api.github.com/users/flgh/following{/other_user}",
      "gists_url": "https://api.github.com/users/flgh/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/flgh/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/flgh/subscriptions",
      "organizations_url": "https://api.github.com/users/flgh/orgs",
      "repos_url": "https://api.github.com/users/flgh/repos",
      "events_url": "https://api.github.com/users/flgh/events{/privacy}",
      "received_events_url": "https://api.github.com/users/flgh/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-01-14T17:17:11Z",
    "updated_at": "2019-01-14T17:17:11Z",
    "author_association": "NONE",
    "body": "About 1 out of 3 sent tx triggers the disconnection, \r\n\r\ndetailed logs from the full node:\r\nDEBUG[01-13|03:18:09.712] Announcing block to peers                number=7057027 hash=cc5afcâ€¦a8be26 td=8697255149581654484737 reorg=0\r\nERROR[01-13|03:18:09.876] Request came too early                   id=xxx conn=trusted-inbound recharge=135.876ms\r\nDEBUG[01-13|03:18:09.876] Light Ethereum message handling failed   id=xxx conn=trusted-inbound err=\"Request rejected - \"\r\nDEBUG[01-13|03:18:09.888] Removing p2p peer                        id=xxx conn=trusted-inbound duration=15h7m25.186s peers=46 req=false err=\"useless peer\"\r\nDEBUG[01-13|03:18:09.890] Adding p2p peer                          name=Geth/v1.8.20-stable-...                                                   addr=yyy:42612  peers=47\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/454085821/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/454088970",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/18437#issuecomment-454088970",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18437",
    "id": 454088970,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ1NDA4ODk3MA==",
    "user": {
      "login": "flgh",
      "id": 33400822,
      "node_id": "MDQ6VXNlcjMzNDAwODIy",
      "avatar_url": "https://avatars.githubusercontent.com/u/33400822?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/flgh",
      "html_url": "https://github.com/flgh",
      "followers_url": "https://api.github.com/users/flgh/followers",
      "following_url": "https://api.github.com/users/flgh/following{/other_user}",
      "gists_url": "https://api.github.com/users/flgh/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/flgh/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/flgh/subscriptions",
      "organizations_url": "https://api.github.com/users/flgh/orgs",
      "repos_url": "https://api.github.com/users/flgh/repos",
      "events_url": "https://api.github.com/users/flgh/events{/privacy}",
      "received_events_url": "https://api.github.com/users/flgh/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-01-14T17:26:00Z",
    "updated_at": "2019-01-14T17:26:00Z",
    "author_association": "NONE",
    "body": "@veox\r\n\r\nThese are pretty simple tx submitted (either value transfers or ERC-20 token transfers (136 bytes in data field) ) with json-rpc:\r\neth_estimateGas of the data followed by personal_sendTransaction\r\n\r\nOnce the tx is in the txpool of the light node, every reconnection of the light node triggers an immediate disconnection after headers have been downloaded.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/454088970/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/503683752",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/18437#issuecomment-503683752",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18437",
    "id": 503683752,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUwMzY4Mzc1Mg==",
    "user": {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-06-19T18:48:20Z",
    "updated_at": "2019-06-19T18:48:20Z",
    "author_association": "MEMBER",
    "body": "This now seems fixed. The `request came too early` is now within `accept` (not `reject`, called e.g. here:https://github.com/ethereum/go-ethereum/blob/master/les/handler.go#L1048 . If it returns false, it will not disconnect the client, just ignore the message. \r\ncc @zsfelfoldi am I correct ? ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/503683752/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
