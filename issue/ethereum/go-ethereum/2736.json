{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2736",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2736/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2736/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2736/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/2736",
  "id": 162275721,
  "node_id": "MDU6SXNzdWUxNjIyNzU3MjE=",
  "number": 2736,
  "title": "Does Geth guarantee consistent snapshot of state in a RPC batch?",
  "user": {
    "login": "alexhanh",
    "id": 386490,
    "node_id": "MDQ6VXNlcjM4NjQ5MA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/386490?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/alexhanh",
    "html_url": "https://github.com/alexhanh",
    "followers_url": "https://api.github.com/users/alexhanh/followers",
    "following_url": "https://api.github.com/users/alexhanh/following{/other_user}",
    "gists_url": "https://api.github.com/users/alexhanh/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/alexhanh/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/alexhanh/subscriptions",
    "organizations_url": "https://api.github.com/users/alexhanh/orgs",
    "repos_url": "https://api.github.com/users/alexhanh/repos",
    "events_url": "https://api.github.com/users/alexhanh/events{/privacy}",
    "received_events_url": "https://api.github.com/users/alexhanh/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2016-06-25T10:51:51Z",
  "updated_at": "2016-08-05T21:26:19Z",
  "closed_at": "2016-08-05T21:26:19Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "#### System information\n\nGeth version: `1.4.7-stable-667a386d`\nOS & Version: OSX\n#### Expected behaviour\n\nUsing `sendRawTransaction` reliably requires computing the proper nonce. This requires knowing previous transaction count of the from address, as well as checking pending **and** queued transactions of the from address.\n\nAFAIK, this means that we need to call `getTransactionCount(tx.from)` _and_ `txpool_content` to compute the final nonce (`nonce = tx_count + pending_count + queued_count`). \n\nSince we need to use two calls, it's possible the state gets mutated in between the calls and thus we compute the wrong nonce:\n\nBatched RPC call of [getTransactionCount, txpool_content] ---> Geth\n1. `getTransactionCount(tx.from)` returns 0\n2. (... Geth processes a block and clears the txpool, and now previous step would return 1 ...) \n3. `txpool_content` is now empty and returns 0 pending/queued transactions. Application computes the final nonce of `tx_count (0) + tx_pool_count (0) = 0` and the tx gets rejected (the nonce should have been 1).\n\nIf the state isn't guaranteed (which is what I suspect, since it would seem silly to halt all processing because of RPC calls), then how on earth are we able to consistently produce the proper nonce?\n#### Actual behaviour\n\nUnknown.\n",
  "closed_by": {
    "login": "fjl",
    "id": 6915,
    "node_id": "MDQ6VXNlcjY5MTU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6915?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/fjl",
    "html_url": "https://github.com/fjl",
    "followers_url": "https://api.github.com/users/fjl/followers",
    "following_url": "https://api.github.com/users/fjl/following{/other_user}",
    "gists_url": "https://api.github.com/users/fjl/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/fjl/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/fjl/subscriptions",
    "organizations_url": "https://api.github.com/users/fjl/orgs",
    "repos_url": "https://api.github.com/users/fjl/repos",
    "events_url": "https://api.github.com/users/fjl/events{/privacy}",
    "received_events_url": "https://api.github.com/users/fjl/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2736/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2736/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/229376047",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/2736#issuecomment-229376047",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2736",
    "id": 229376047,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIyOTM3NjA0Nw==",
    "user": {
      "login": "bas-vk",
      "id": 4280775,
      "node_id": "MDQ6VXNlcjQyODA3NzU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4280775?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bas-vk",
      "html_url": "https://github.com/bas-vk",
      "followers_url": "https://api.github.com/users/bas-vk/followers",
      "following_url": "https://api.github.com/users/bas-vk/following{/other_user}",
      "gists_url": "https://api.github.com/users/bas-vk/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bas-vk/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bas-vk/subscriptions",
      "organizations_url": "https://api.github.com/users/bas-vk/orgs",
      "repos_url": "https://api.github.com/users/bas-vk/repos",
      "events_url": "https://api.github.com/users/bas-vk/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bas-vk/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-06-29T14:37:15Z",
    "updated_at": "2016-06-29T14:37:27Z",
    "author_association": "MEMBER",
    "body": "This is indeed a hard problem. In theory the node cannot give you all required information to determine the correct nonce since it might not have all pending/queued transactions in its transaction pool. Batched RPC calls are just an optimization to reduce the number of separate RPC calls. Your assumption is correct. The requests are still executed one by one and and affected by state changes.\n\n@Arachnid, if I recall it correct you did some work on adding Ethereum support for trezor. Maybe you can share your thoughts?\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/229376047/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/235802525",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/2736#issuecomment-235802525",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2736",
    "id": 235802525,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIzNTgwMjUyNQ==",
    "user": {
      "login": "drewshaver",
      "id": 11730814,
      "node_id": "MDQ6VXNlcjExNzMwODE0",
      "avatar_url": "https://avatars.githubusercontent.com/u/11730814?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/drewshaver",
      "html_url": "https://github.com/drewshaver",
      "followers_url": "https://api.github.com/users/drewshaver/followers",
      "following_url": "https://api.github.com/users/drewshaver/following{/other_user}",
      "gists_url": "https://api.github.com/users/drewshaver/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/drewshaver/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/drewshaver/subscriptions",
      "organizations_url": "https://api.github.com/users/drewshaver/orgs",
      "repos_url": "https://api.github.com/users/drewshaver/repos",
      "events_url": "https://api.github.com/users/drewshaver/events{/privacy}",
      "received_events_url": "https://api.github.com/users/drewshaver/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-07-28T05:10:57Z",
    "updated_at": "2016-07-28T05:10:57Z",
    "author_association": "NONE",
    "body": "It seems to me the most straightforward approach would be calling `getTransactionCount(addr, 'pending')`. Which is supported according to the json-rpc docs. But it does not seem to be actually working for me, or this [other person from stack overflow](http://ethereum.stackexchange.com/questions/6496/gettransactioncount-with-pending-not-working).\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/235802525/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/235873408",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/2736#issuecomment-235873408",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2736",
    "id": 235873408,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIzNTg3MzQwOA==",
    "user": {
      "login": "Arachnid",
      "id": 17865,
      "node_id": "MDQ6VXNlcjE3ODY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/17865?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Arachnid",
      "html_url": "https://github.com/Arachnid",
      "followers_url": "https://api.github.com/users/Arachnid/followers",
      "following_url": "https://api.github.com/users/Arachnid/following{/other_user}",
      "gists_url": "https://api.github.com/users/Arachnid/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Arachnid/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Arachnid/subscriptions",
      "organizations_url": "https://api.github.com/users/Arachnid/orgs",
      "repos_url": "https://api.github.com/users/Arachnid/repos",
      "events_url": "https://api.github.com/users/Arachnid/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Arachnid/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-07-28T11:51:48Z",
    "updated_at": "2016-07-28T11:51:48Z",
    "author_association": "MEMBER",
    "body": "Trezor support was naive, and just fetches the transaction count, on the theory that you're not going to be signing transactions by hand that fast. :)\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/235873408/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/237970096",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/2736#issuecomment-237970096",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2736",
    "id": 237970096,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIzNzk3MDA5Ng==",
    "user": {
      "login": "fjl",
      "id": 6915,
      "node_id": "MDQ6VXNlcjY5MTU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6915?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjl",
      "html_url": "https://github.com/fjl",
      "followers_url": "https://api.github.com/users/fjl/followers",
      "following_url": "https://api.github.com/users/fjl/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjl/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjl/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjl/subscriptions",
      "organizations_url": "https://api.github.com/users/fjl/orgs",
      "repos_url": "https://api.github.com/users/fjl/repos",
      "events_url": "https://api.github.com/users/fjl/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjl/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-08-05T21:26:19Z",
    "updated_at": "2016-08-05T21:26:19Z",
    "author_association": "MEMBER",
    "body": "The correct way is indeed to use `getTransactionCount(addr, 'pending')`. I'm closing this now because #2880 tracks the issue with that call.\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/237970096/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
