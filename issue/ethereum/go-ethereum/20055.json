{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20055",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20055/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20055/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20055/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/20055",
  "id": 492499962,
  "node_id": "MDU6SXNzdWU0OTI0OTk5NjI=",
  "number": 20055,
  "title": "Integrate discover v5 with RLPx",
  "user": {
    "login": "WinstonPrivacy",
    "id": 36650369,
    "node_id": "MDQ6VXNlcjM2NjUwMzY5",
    "avatar_url": "https://avatars.githubusercontent.com/u/36650369?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/WinstonPrivacy",
    "html_url": "https://github.com/WinstonPrivacy",
    "followers_url": "https://api.github.com/users/WinstonPrivacy/followers",
    "following_url": "https://api.github.com/users/WinstonPrivacy/following{/other_user}",
    "gists_url": "https://api.github.com/users/WinstonPrivacy/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/WinstonPrivacy/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/WinstonPrivacy/subscriptions",
    "organizations_url": "https://api.github.com/users/WinstonPrivacy/orgs",
    "repos_url": "https://api.github.com/users/WinstonPrivacy/repos",
    "events_url": "https://api.github.com/users/WinstonPrivacy/events{/privacy}",
    "received_events_url": "https://api.github.com/users/WinstonPrivacy/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2019-09-11T22:38:53Z",
  "updated_at": "2020-08-27T08:59:31Z",
  "closed_at": "2020-05-28T08:51:40Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "#### System information\r\n\r\nGeth version: N/A\r\nOS & Version: Linux\r\nCommit hash : \r\n\r\n#### Expected behaviour\r\n\r\nNodes connecting via Discover v5 protocol should trigger RLPx communication (runPeer()).\r\n\r\n#### Actual behaviour\r\n\r\nNodes negotiate a connection and move to \"Known\" state but never trigger RLPx. This is from a test project which works as expected using discv4.\r\n\r\n\r\n#### Steps to reproduce the behaviour\r\n\r\nThis is a private project but the code is straightforward. We create two nodes and bootstrap one to the other. Tracing through the logging output, we have discovered that the nodes successfully negotiate the PING/PONG handshake and both move to the known state and wait indefinitely. A p2p Server is running and it sits in the run() loop, continuing to execute discovery lookup tasks but never receives a message on the srv.checkpointAddPeer channel, so it never triggers the runPeer() function.\r\n\r\n```\r\n\t\tcase c := <-srv.checkpointAddPeer:\r\n\t\t\t// At this point the connection is past the protocol handshake.\r\n\t\t\t// Its capabilities are known and the remote identity is verified.\r\n\t\t\terr := srv.addPeerChecks(peers, inboundCount, c)\r\n```\r\n\r\nThis same project works fine if discv4 is used.\r\n\r\n",
  "closed_by": {
    "login": "fjl",
    "id": 6915,
    "node_id": "MDQ6VXNlcjY5MTU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6915?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/fjl",
    "html_url": "https://github.com/fjl",
    "followers_url": "https://api.github.com/users/fjl/followers",
    "following_url": "https://api.github.com/users/fjl/following{/other_user}",
    "gists_url": "https://api.github.com/users/fjl/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/fjl/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/fjl/subscriptions",
    "organizations_url": "https://api.github.com/users/fjl/orgs",
    "repos_url": "https://api.github.com/users/fjl/repos",
    "events_url": "https://api.github.com/users/fjl/events{/privacy}",
    "received_events_url": "https://api.github.com/users/fjl/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20055/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20055/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/531274365",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/20055#issuecomment-531274365",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20055",
    "id": 531274365,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUzMTI3NDM2NQ==",
    "user": {
      "login": "WinstonPrivacy",
      "id": 36650369,
      "node_id": "MDQ6VXNlcjM2NjUwMzY5",
      "avatar_url": "https://avatars.githubusercontent.com/u/36650369?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/WinstonPrivacy",
      "html_url": "https://github.com/WinstonPrivacy",
      "followers_url": "https://api.github.com/users/WinstonPrivacy/followers",
      "following_url": "https://api.github.com/users/WinstonPrivacy/following{/other_user}",
      "gists_url": "https://api.github.com/users/WinstonPrivacy/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/WinstonPrivacy/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/WinstonPrivacy/subscriptions",
      "organizations_url": "https://api.github.com/users/WinstonPrivacy/orgs",
      "repos_url": "https://api.github.com/users/WinstonPrivacy/repos",
      "events_url": "https://api.github.com/users/WinstonPrivacy/events{/privacy}",
      "received_events_url": "https://api.github.com/users/WinstonPrivacy/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-09-13T15:05:29Z",
    "updated_at": "2019-09-13T15:05:29Z",
    "author_association": "NONE",
    "body": "Digging deeper into this, it appears that discv5 is in a very incomplete state overall. Was wondering if someone could comment to provide more background?\r\n\r\nThe things that initially jump out at me are partial implementation of the discoverTable interface, lack of thread safety (mutexes around table buckets), and no ENR support in discv4 Node struct.\r\n\r\nIf these were added, it seems like it might be straightforward to send the discv5 table into newDialState. That would provide a path (maybe a completely working one) for discv5 to replace v4.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/531274365/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/635210049",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/20055#issuecomment-635210049",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20055",
    "id": 635210049,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYzNTIxMDA0OQ==",
    "user": {
      "login": "fjl",
      "id": 6915,
      "node_id": "MDQ6VXNlcjY5MTU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6915?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjl",
      "html_url": "https://github.com/fjl",
      "followers_url": "https://api.github.com/users/fjl/followers",
      "following_url": "https://api.github.com/users/fjl/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjl/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjl/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjl/subscriptions",
      "organizations_url": "https://api.github.com/users/fjl/orgs",
      "repos_url": "https://api.github.com/users/fjl/repos",
      "events_url": "https://api.github.com/users/fjl/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjl/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-28T08:51:40Z",
    "updated_at": "2020-05-28T08:51:40Z",
    "author_association": "MEMBER",
    "body": "Closing this because things have changed a lot since this was opened. p2p/discv5 is officially deprecated and will be removed soon. We are working on the final version of discovery v5, with ENR support. The p2p dial infrastructure is now pluggable, providing ways to integrate other discovery mechanisms.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/635210049/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
