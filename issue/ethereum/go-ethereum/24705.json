{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/24705",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/24705/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/24705/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/24705/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/24705",
  "id": 1206118052,
  "node_id": "I_kwDOAOvK985H4-ak",
  "number": 24705,
  "title": "PoA network, blockchain no longer grows due to soft forking with the same td",
  "user": {
    "login": "fenghaoming",
    "id": 26361852,
    "node_id": "MDQ6VXNlcjI2MzYxODUy",
    "avatar_url": "https://avatars.githubusercontent.com/u/26361852?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/fenghaoming",
    "html_url": "https://github.com/fenghaoming",
    "followers_url": "https://api.github.com/users/fenghaoming/followers",
    "following_url": "https://api.github.com/users/fenghaoming/following{/other_user}",
    "gists_url": "https://api.github.com/users/fenghaoming/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/fenghaoming/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/fenghaoming/subscriptions",
    "organizations_url": "https://api.github.com/users/fenghaoming/orgs",
    "repos_url": "https://api.github.com/users/fenghaoming/repos",
    "events_url": "https://api.github.com/users/fenghaoming/events{/privacy}",
    "received_events_url": "https://api.github.com/users/fenghaoming/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 72233650,
      "node_id": "MDU6TGFiZWw3MjIzMzY1MA==",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/type:bug",
      "name": "type:bug",
      "color": "FF5E5E",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2022-04-16T13:57:14Z",
  "updated_at": "2022-05-12T08:45:30Z",
  "closed_at": "2022-05-12T08:45:30Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "Imagine the following scenario: there are 4 signers in POA Clique network: node0, node1, node2, node3\t\t\t\r\n\t\t\t\r\nTheir clique.getSnapshot() as follow:\t\t\t\r\n\r\n<html xmlns:v=\"urn:schemas-microsoft-com:vml\" xmlns:o=\"urn:schemas-microsoft-com:office:office\" xmlns:x=\"urn:schemas-microsoft-com:office:excel\" xmlns=\"http://www.w3.org/TR/REC-html40\">\r\n<head>\r\n\r\n<meta name=Generator content=\"Microsoft Excel\">\r\n<!--[if !mso]>\r\n<style>\r\nv\\:* {behavior:url(#default#VML);}\r\no\\:* {behavior:url(#default#VML);}\r\nx\\:* {behavior:url(#default#VML);}\r\n.shape {behavior:url(#default#VML);}\r\n</style>\r\n<![endif]-->\r\n<style>\r\n<!--.font0\r\n\t{color:#000000;\r\n\tfont-size:11.0pt;\r\n\tfont-family:宋体;\r\n\tfont-weight:400;\r\n\tfont-style:normal;\r\n\ttext-decoration:none;}\r\nbr\r\n\t{mso-data-placement:same-cell;}\r\ntd\r\n\t{padding-top:1px;\r\n\tpadding-left:1px;\r\n\tpadding-right:1px;\r\n\tmso-ignore:padding;\r\n\tcolor:#000000;\r\n\tfont-size:11.0pt;\r\n\tfont-weight:400;\r\n\tfont-style:normal;\r\n\ttext-decoration:none;\r\n\tfont-family:宋体;\r\n\tmso-generic-font-family:auto;\r\n\tmso-font-charset:134;\r\n\tmso-number-format:General;\r\n\tborder:none;\r\n\tmso-background-source:auto;\r\n\tmso-pattern:auto;\r\n\ttext-align:general;\r\n\tvertical-align:middle;\r\n\twhite-space:nowrap;\r\n\tmso-rotate:0;\r\n\tmso-protection:locked visible;}\r\n.et3\r\n\t{mso-generic-font-family:auto;\r\n\tmso-font-charset:134;\r\n\ttext-align:center;}\r\n-->\r\n</style>\r\n</head>\r\n<body>\r\n<!--StartFragment-->\r\n\r\n\r\nblock |   | node0 |   |   |   | node1 |   |   |   | node2 |   |   |   | node3 |   |  \r\n-- | -- | -- | -- | -- | -- | -- | -- | -- | -- | -- | -- | -- | -- | -- | -- | --\r\nnumber |   | signer | difficulty | td |   | signer | difficulty | td |   | signer | difficulty | td |   | signer | difficulty | td\r\n101 |   | node1 | 2 | 200 |   | node1 | 2 | 200 |   | node1 | 2 | 200 |   | node1 | 2 | 200\r\n102 |   | node3 | 1 | 201 |   | node2 | 2 | 202 |   | node2 | 2 | 202 |   | node3 | 1 | 201\r\n103 |   | node0 | 1 | 202 |   | - | - | - |   | - | - | - |   | node0 | 1 | 202\r\n\r\n\r\n<!--EndFragment-->\r\n</body>\r\n\r\n</html>\r\n\r\n\r\nSoft forks occur, node0 and node3 are stuck at block 103, node1 and node2 are stuck at block 102. Bath forks have the same TD (node2 is the in-turn signer at block 102), causing the blockchain to no longer grow.",
  "closed_by": {
    "login": "holiman",
    "id": 142290,
    "node_id": "MDQ6VXNlcjE0MjI5MA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/holiman",
    "html_url": "https://github.com/holiman",
    "followers_url": "https://api.github.com/users/holiman/followers",
    "following_url": "https://api.github.com/users/holiman/following{/other_user}",
    "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
    "organizations_url": "https://api.github.com/users/holiman/orgs",
    "repos_url": "https://api.github.com/users/holiman/repos",
    "events_url": "https://api.github.com/users/holiman/events{/privacy}",
    "received_events_url": "https://api.github.com/users/holiman/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/24705/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/24705/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1100685309",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/24705#issuecomment-1100685309",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/24705",
    "id": 1100685309,
    "node_id": "IC_kwDOAOvK985Bmx_9",
    "user": {
      "login": "fenghaoming",
      "id": 26361852,
      "node_id": "MDQ6VXNlcjI2MzYxODUy",
      "avatar_url": "https://avatars.githubusercontent.com/u/26361852?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fenghaoming",
      "html_url": "https://github.com/fenghaoming",
      "followers_url": "https://api.github.com/users/fenghaoming/followers",
      "following_url": "https://api.github.com/users/fenghaoming/following{/other_user}",
      "gists_url": "https://api.github.com/users/fenghaoming/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fenghaoming/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fenghaoming/subscriptions",
      "organizations_url": "https://api.github.com/users/fenghaoming/orgs",
      "repos_url": "https://api.github.com/users/fenghaoming/repos",
      "events_url": "https://api.github.com/users/fenghaoming/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fenghaoming/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-04-16T15:09:07Z",
    "updated_at": "2022-04-16T15:33:01Z",
    "author_association": "NONE",
    "body": "In my opinion, the reason for the above problem is that the in-turn difficulty is not big enough to make the out-turn branch chain able to break the POA restriction that \"the same signer must be separated by (n/2)+1 to produce the next block\".\r\nSo I think maybe it is possible to rewrite the function in consensus\\clique\\clique.go as:\r\n\r\n```\r\nfunc calcDifficulty(snap *Snapshot, signer common.Address) *big.Int {\r\n\tif snap.inturn(snap.Number+1, signer) {\r\n\t\t//return new(big.Int).Set(diffInTurn)\r\n\t\treturn big.NewInt(int64(len(snap.signers())/2 + 1)) // (n/2)+1\r\n\t}\r\n\treturn new(big.Int).Set(diffNoTurn)\r\n}\r\n```\r\n\r\nAssuming that there are currently n signers, all nodes in the network are still consistent at height H,\r\nWe classify these nodes into 3 categories:\r\n A: (n/2)+1 signers that has not recently generated blocks before height H.\r\nB: the next node that serves as an in-turn node.\r\nC: the remaining nodes that have generated blocks before height H (n/2-1 if n is odd and n/2-2 if n is even).\r\n\r\nIn the worst case, there are two branch chains after H. The first branch chain is generated by the signers of class A, and the second branch chain is generated by the node of class B. Both of them have the same TD.\r\nAnd class C nodes are synchronized to the second branch chain, so they will not produce blocks on the first branch chain.\r\nBut On the second branch chain there is no block producing by class C because there is still no (n/2)+1 height apart.\r\n\r\nHowever, since class A signers are sufficiently spaced on the first branch chain, only class A signers can keep the first branch chain growing. And then the second branch chain will merge into the first branch chain.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1100685309/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1101221210",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/24705#issuecomment-1101221210",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/24705",
    "id": 1101221210,
    "node_id": "IC_kwDOAOvK985Bo01a",
    "user": {
      "login": "fenghaoming",
      "id": 26361852,
      "node_id": "MDQ6VXNlcjI2MzYxODUy",
      "avatar_url": "https://avatars.githubusercontent.com/u/26361852?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fenghaoming",
      "html_url": "https://github.com/fenghaoming",
      "followers_url": "https://api.github.com/users/fenghaoming/followers",
      "following_url": "https://api.github.com/users/fenghaoming/following{/other_user}",
      "gists_url": "https://api.github.com/users/fenghaoming/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fenghaoming/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fenghaoming/subscriptions",
      "organizations_url": "https://api.github.com/users/fenghaoming/orgs",
      "repos_url": "https://api.github.com/users/fenghaoming/repos",
      "events_url": "https://api.github.com/users/fenghaoming/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fenghaoming/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-04-18T08:36:44Z",
    "updated_at": "2022-04-18T08:36:44Z",
    "author_association": "NONE",
    "body": "Another way I've come up with to solve this problem is to take a closer look at the size of the hash when TD is the same.\r\n\r\n\r\n```\r\n// nextSyncOp determines whether sync is required at this time.\r\nfunc (cs *chainSyncer) nextSyncOp() *chainSyncOp {\r\n\r\n...........................................\r\n\r\n\tmode, ourTD, ourHead := cs.modeAndLocalHead()\r\n\r\n\top := peerToSyncOp(mode, peer)\r\n\tif op.td.Cmp(ourTD) < 0 {\r\n\t\treturn nil // We're in sync.\r\n\t} else if op.td.Cmp(ourTD) == 0 {\r\n\t\todd := ourTD.Mod(ourTD, new(big.Int).SetUint64(2)).Uint64()\r\n\t\tif odd == 0 && op.head.Big().Cmp(ourHead.Hash().Big()) < 0 ||\r\n\t\t\todd == 1 && op.head.Big().Cmp(ourHead.Hash().Big()) > 0 {\r\n\t\t\treturn nil\r\n\t\t}\r\n\t}\r\n\treturn op\r\n}\r\n```\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1101221210/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1109583412",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/24705#issuecomment-1109583412",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/24705",
    "id": 1109583412,
    "node_id": "IC_kwDOAOvK985CIuY0",
    "user": {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-04-26T09:43:36Z",
    "updated_at": "2022-04-26T09:43:36Z",
    "author_association": "MEMBER",
    "body": "It's a known fact that Clique may deadlock. A more comprehensive proposal to solve these things is here: https://eips.ethereum.org/EIPS/eip-3436  . I think implementing EIP 3436 would be a good idea ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1109583412/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
