{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20456",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20456/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20456/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20456/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/20456",
  "id": 537343019,
  "node_id": "MDU6SXNzdWU1MzczNDMwMTk=",
  "number": 20456,
  "title": "The logic of findAncestor is not correct and effective",
  "user": {
    "login": "Nanyan",
    "id": 1623062,
    "node_id": "MDQ6VXNlcjE2MjMwNjI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1623062?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Nanyan",
    "html_url": "https://github.com/Nanyan",
    "followers_url": "https://api.github.com/users/Nanyan/followers",
    "following_url": "https://api.github.com/users/Nanyan/following{/other_user}",
    "gists_url": "https://api.github.com/users/Nanyan/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Nanyan/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Nanyan/subscriptions",
    "organizations_url": "https://api.github.com/users/Nanyan/orgs",
    "repos_url": "https://api.github.com/users/Nanyan/repos",
    "events_url": "https://api.github.com/users/Nanyan/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Nanyan/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2019-12-13T04:31:41Z",
  "updated_at": "2019-12-14T10:40:32Z",
  "closed_at": "2019-12-13T13:23:59Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "Hi there,\r\n\r\nI found that the logic of `findAncestor` in eth/downloader/downloader.go may be incorrect and(or) inefficient.\r\n\r\n#### Source\r\n\r\nGeth version: branch `master`, up to latest commit [f51cf57](https://github.com/ethereum/go-ethereum/commit/f51cf573b5c602914d22f5a31c58378c5aa17ffd)\r\n\r\n#### Description\r\n\r\nThink about a bundle of numbers from testcase: \r\n```go\r\nfunc TestRemoteHeaderRequestSpan(t *testing.T) {\r\n\ttestCases := []struct {\r\n\t\tremoteHeight uint64\r\n\t\tlocalHeight  uint64\r\n\t\texpected     []int\r\n\t}{\r\n\t\t// Remote is way higher. We should ask for the remote head and go backwards\r\n\t\t{1500, 1000,\r\n\t\t\t[]int{1323, 1339, 1355, 1371, 1387, 1403, 1419, 1435, 1451, 1467, 1483, 1499},\r\n\t\t},\r\n......\r\n```\r\n\r\nThen, since the `localHeight` is `1000`, then how can the blocks `1323`,`1339`,... be exist in the local chain? \r\n\r\nIt's impossible for the block `1323` or `1339` etc. be a common ancestor of the local chain and the remote chain.\r\n",
  "closed_by": {
    "login": "holiman",
    "id": 142290,
    "node_id": "MDQ6VXNlcjE0MjI5MA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/holiman",
    "html_url": "https://github.com/holiman",
    "followers_url": "https://api.github.com/users/holiman/followers",
    "following_url": "https://api.github.com/users/holiman/following{/other_user}",
    "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
    "organizations_url": "https://api.github.com/users/holiman/orgs",
    "repos_url": "https://api.github.com/users/holiman/repos",
    "events_url": "https://api.github.com/users/holiman/events{/privacy}",
    "received_events_url": "https://api.github.com/users/holiman/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20456/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20456/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/565439720",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/20456#issuecomment-565439720",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20456",
    "id": 565439720,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU2NTQzOTcyMA==",
    "user": {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-12-13T13:23:59Z",
    "updated_at": "2019-12-13T13:23:59Z",
    "author_association": "MEMBER",
    "body": "It's actually neither incorrect nor inefficient, but rather incorrectly named. \r\nWhat the downloader does is not find the common ancestor, but tries to find the latest block that is also available locally. \r\n\r\n This changed after a testnet screwup; in the presence of very long (but invalid) sidechains, this is what happened: \r\n\r\n1. Downloader peers with remote peer on bad chain. Self at `N`, other at `M`.  Common ancestor `n`.\r\n2. Downloader detects that peer has longer chain. Downloads blocks `n+1` up to `M`. \r\n3. Blockchain crunches through blocks, detects that `n+k` is a bad block. Rejects it all. \r\n4. Go to 1\r\n\r\nSo instead of continually downloading the sidechain and try to import it, the logic was changed. The semantics became \"find the most recent block that we have locally\", instead of \"find the most recent block that is part of the canonical chain, and that we have locally\". ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/565439720/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/565705732",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/20456#issuecomment-565705732",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20456",
    "id": 565705732,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU2NTcwNTczMg==",
    "user": {
      "login": "Nanyan",
      "id": 1623062,
      "node_id": "MDQ6VXNlcjE2MjMwNjI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1623062?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Nanyan",
      "html_url": "https://github.com/Nanyan",
      "followers_url": "https://api.github.com/users/Nanyan/followers",
      "following_url": "https://api.github.com/users/Nanyan/following{/other_user}",
      "gists_url": "https://api.github.com/users/Nanyan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Nanyan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Nanyan/subscriptions",
      "organizations_url": "https://api.github.com/users/Nanyan/orgs",
      "repos_url": "https://api.github.com/users/Nanyan/repos",
      "events_url": "https://api.github.com/users/Nanyan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Nanyan/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-12-14T10:40:32Z",
    "updated_at": "2019-12-14T10:40:32Z",
    "author_association": "NONE",
    "body": "Thanks for your explanation. It's a very subtle mechanism.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/565705732/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
