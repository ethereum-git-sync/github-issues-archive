{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18373",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18373/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18373/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18373/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/18373",
  "id": 394787204,
  "node_id": "MDU6SXNzdWUzOTQ3ODcyMDQ=",
  "number": 18373,
  "title": "RocksDB opens too many files on osx Mojave",
  "user": {
    "login": "kzaher",
    "id": 1641148,
    "node_id": "MDQ6VXNlcjE2NDExNDg=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1641148?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/kzaher",
    "html_url": "https://github.com/kzaher",
    "followers_url": "https://api.github.com/users/kzaher/followers",
    "following_url": "https://api.github.com/users/kzaher/following{/other_user}",
    "gists_url": "https://api.github.com/users/kzaher/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/kzaher/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/kzaher/subscriptions",
    "organizations_url": "https://api.github.com/users/kzaher/orgs",
    "repos_url": "https://api.github.com/users/kzaher/repos",
    "events_url": "https://api.github.com/users/kzaher/events{/privacy}",
    "received_events_url": "https://api.github.com/users/kzaher/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "rjl493456442",
    "id": 5959481,
    "node_id": "MDQ6VXNlcjU5NTk0ODE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5959481?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/rjl493456442",
    "html_url": "https://github.com/rjl493456442",
    "followers_url": "https://api.github.com/users/rjl493456442/followers",
    "following_url": "https://api.github.com/users/rjl493456442/following{/other_user}",
    "gists_url": "https://api.github.com/users/rjl493456442/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/rjl493456442/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rjl493456442/subscriptions",
    "organizations_url": "https://api.github.com/users/rjl493456442/orgs",
    "repos_url": "https://api.github.com/users/rjl493456442/repos",
    "events_url": "https://api.github.com/users/rjl493456442/events{/privacy}",
    "received_events_url": "https://api.github.com/users/rjl493456442/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "rjl493456442",
      "id": 5959481,
      "node_id": "MDQ6VXNlcjU5NTk0ODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5959481?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rjl493456442",
      "html_url": "https://github.com/rjl493456442",
      "followers_url": "https://api.github.com/users/rjl493456442/followers",
      "following_url": "https://api.github.com/users/rjl493456442/following{/other_user}",
      "gists_url": "https://api.github.com/users/rjl493456442/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rjl493456442/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rjl493456442/subscriptions",
      "organizations_url": "https://api.github.com/users/rjl493456442/orgs",
      "repos_url": "https://api.github.com/users/rjl493456442/repos",
      "events_url": "https://api.github.com/users/rjl493456442/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rjl493456442/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2018-12-29T11:19:42Z",
  "updated_at": "2019-05-03T19:53:29Z",
  "closed_at": "2019-05-03T07:15:11Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "#### System information\r\n\r\nGeth version:\r\nVersion: 1.8.20-stable\r\nArchitecture: amd64\r\nProtocol Versions: [63 62]\r\nNetwork Id: 1\r\nGo Version: go1.11.4\r\nOperating System: darwin\r\nGOPATH=/Users/kzaher/go\r\nGOROOT=/usr/local/Cellar/go/1.11.4/libexec\r\n\r\nOS & Version: OSX Mojave 10.14.2 (18C54)\r\nCommit hash : v1.8.20 24d727b6d6e2c0cde222fa12155c4a6db5caaf2e\r\n\r\n#### Expected behaviour\r\n\r\nFor it to sync properly.\r\n\r\n#### Actual behaviour\r\n\r\nIf fails with \"too many open files\".\r\n\r\n#### Steps to reproduce the behaviour\r\n\r\n1. run:\r\n`geth --cache=4096 --maxpeers=100 --syncmode \"fast\" --rpcapi personal,web3,eth,net --datadir /Volumes/evo/ethereum/chains/main`\r\n\r\n2. wait for 11 hours.\r\n\r\n#### Backtrace\r\n\r\nThis is command output, should be clear enough.\r\n\r\n````\r\nINFO [12-29|12:15:14.184] Imported new block headers               count=1    elapsed=4.398ms   number=6973582 hash=1f96be…af99f3\r\nINFO [12-29|12:15:14.216] Imported new state entries               count=934  elapsed=7.075ms   processed=162791880 pending=82093  retry=0   duplicate=4482 unexpected=12643\r\nINFO [12-29|12:15:14.335] Imported new state entries               count=1273 elapsed=6.678ms   processed=162793153 pending=83594  retry=0   duplicate=4482 unexpected=12643\r\nINFO [12-29|12:15:14.452] Imported new state entries               count=1284 elapsed=7.463ms   processed=162794437 pending=84692  retry=0   duplicate=4482 unexpected=12643\r\nINFO [12-29|12:15:14.562] Imported new state entries               count=1120 elapsed=5.119ms   processed=162795557 pending=86125  retry=0   duplicate=4482 unexpected=12643\r\nINFO [12-29|12:15:14.655] Imported new state entries               count=1321 elapsed=7.131ms   processed=162796878 pending=86894  retry=0   duplicate=4482 unexpected=12643\r\nINFO [12-29|12:15:14.728] Imported new state entries               count=1152 elapsed=8.927ms   processed=162798030 pending=87199  retry=0   duplicate=4482 unexpected=12643\r\nINFO [12-29|12:15:14.811] Imported new state entries               count=941  elapsed=5.444ms   processed=162798971 pending=87836  retry=29  duplicate=4482 unexpected=12643\r\nINFO [12-29|12:15:14.907] Imported new state entries               count=1152 elapsed=6.657ms   processed=162800123 pending=89210  retry=0   duplicate=4482 unexpected=12643\r\nWARN [12-29|12:15:14.954] Rolled back headers                      count=5    header=6973582->6973577 fast=6973514->6973514 block=0->0\r\nWARN [12-29|12:15:14.954] Synchronisation failed, retrying         err=\"DB write error: open /Volumes/evo/ethereum/chains/main/geth/chaindata: too many open files\"\r\nWARN [12-29|12:15:18.644] Ancestor below allowance                 peer=e6f0d2b93d0d107f number=6883514 hash=000000…000000 allowance=6883514\r\nWARN [12-29|12:15:18.644] Synchronisation failed, dropping peer    peer=e6f0d2b93d0d107f err=\"retrieved ancestor is invalid\"\r\nWARN [12-29|12:15:25.708] Ancestor below allowance                 peer=b90884cd400ea40b number=6883514 hash=000000…000000 allowance=6883514\r\nWARN [12-29|12:15:25.708] Synchronisation failed, dropping peer    peer=b90884cd400ea40b err=\"retrieved ancestor is invalid\"\r\n````\r\n\r\nLevel DB is holding a bunch of files open.\r\n\r\nRunning `lsof -n -c geth` displays that rocks db is holding a bunch of files open.\r\n\r\n```\r\ngeth    32897 kzaher *787r     REG               50,3   2136771     286750 /Volumes/evo/ethereum/chains/main/geth/chaindata/617605.ldb\r\ngeth    32897 kzaher *788r     REG               50,3   2135242     286734 /Volumes/evo/ethereum/chains/main/geth/chaindata/617589.ldb\r\ngeth    32897 kzaher *789r     REG               50,3   2138953     286687 /Volumes/evo/ethereum/chains/main/geth/chaindata/617542.ldb\r\ngeth    32897 kzaher *790r     REG               50,3   2148590     176194 /Volumes/evo/ethereum/chains/main/geth/chaindata/421286.ldb\r\n```\r\n\r\n`lsof -n -c geth | wc -l` > `24392`\r\n\r\nMy disk is writing constantly ~100MB/s. There is probably additional write amplification on filesystem level. Not to mention rocks db compacting. This is wearing out my SSD significantly.\r\n\r\nIs rocks db really the optimal database for this use case? Isn't there anything more efficient? I can increase the file limit temporarily with ` sudo sysctl -w kern.maxfilesperproc=70000`, but this is tearing my computer apart.",
  "closed_by": {
    "login": "holiman",
    "id": 142290,
    "node_id": "MDQ6VXNlcjE0MjI5MA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/holiman",
    "html_url": "https://github.com/holiman",
    "followers_url": "https://api.github.com/users/holiman/followers",
    "following_url": "https://api.github.com/users/holiman/following{/other_user}",
    "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
    "organizations_url": "https://api.github.com/users/holiman/orgs",
    "repos_url": "https://api.github.com/users/holiman/repos",
    "events_url": "https://api.github.com/users/holiman/events{/privacy}",
    "received_events_url": "https://api.github.com/users/holiman/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18373/reactions",
    "total_count": 1,
    "+1": 1,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18373/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/487899238",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/18373#issuecomment-487899238",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18373",
    "id": 487899238,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ4Nzg5OTIzOA==",
    "user": {
      "login": "AyushyaChitransh",
      "id": 13914634,
      "node_id": "MDQ6VXNlcjEzOTE0NjM0",
      "avatar_url": "https://avatars.githubusercontent.com/u/13914634?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AyushyaChitransh",
      "html_url": "https://github.com/AyushyaChitransh",
      "followers_url": "https://api.github.com/users/AyushyaChitransh/followers",
      "following_url": "https://api.github.com/users/AyushyaChitransh/following{/other_user}",
      "gists_url": "https://api.github.com/users/AyushyaChitransh/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AyushyaChitransh/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AyushyaChitransh/subscriptions",
      "organizations_url": "https://api.github.com/users/AyushyaChitransh/orgs",
      "repos_url": "https://api.github.com/users/AyushyaChitransh/repos",
      "events_url": "https://api.github.com/users/AyushyaChitransh/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AyushyaChitransh/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-04-30T10:16:58Z",
    "updated_at": "2019-04-30T10:16:58Z",
    "author_association": "CONTRIBUTOR",
    "body": "Am I reading it correct that you are referring to rocksdb here? Or was it a typo and you intended to say leveldb?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/487899238/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/488104305",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/18373#issuecomment-488104305",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18373",
    "id": 488104305,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ4ODEwNDMwNQ==",
    "user": {
      "login": "kzaher",
      "id": 1641148,
      "node_id": "MDQ6VXNlcjE2NDExNDg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1641148?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/kzaher",
      "html_url": "https://github.com/kzaher",
      "followers_url": "https://api.github.com/users/kzaher/followers",
      "following_url": "https://api.github.com/users/kzaher/following{/other_user}",
      "gists_url": "https://api.github.com/users/kzaher/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/kzaher/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/kzaher/subscriptions",
      "organizations_url": "https://api.github.com/users/kzaher/orgs",
      "repos_url": "https://api.github.com/users/kzaher/repos",
      "events_url": "https://api.github.com/users/kzaher/events{/privacy}",
      "received_events_url": "https://api.github.com/users/kzaher/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-04-30T20:32:11Z",
    "updated_at": "2019-04-30T20:32:11Z",
    "author_association": "NONE",
    "body": "@AyushyaChitransh RocksDB is based on LevelDB as far as I can tell. I'm not sure which flavor is geth using right now. Why does it matter?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/488104305/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/488978627",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/18373#issuecomment-488978627",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18373",
    "id": 488978627,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ4ODk3ODYyNw==",
    "user": {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-05-03T07:15:11Z",
    "updated_at": "2019-05-03T07:15:11Z",
    "author_association": "MEMBER",
    "body": "Go-ethereum uses leveldb, not Rocksdb. Geth queries the operating system for the allowance, and makes sure to stay below that. Decreasing the number of files allowed could be done, but it would only mean more processing time, since files needs to be closed and opened. \r\n\r\nSo, this is not a 'bug' -- it would be it if allocated _more_ files than it was actually given, and threw errors when running out of filehandles. \r\n\r\nIf we actually wanted to lower the number of files used by leveldb, we could increase the leveldb file size. However, every attempt we have done at that degrades performance; since doing so increases the compaction overhead. \r\n\r\nIt might be that certain filesystems have a built-in overhead for large number of files, specifically windows-users on NTFS have sometimes reported that. \r\nIn 1.9, we will switch to using an `ancient` storage for old data (blocks, headers, receipts etc) that will cut the leveldb data size roughly in half, which should greatly improve the situation for all platforms. \r\n\r\nI'll close this for now, since it's not really a 'bug' and not really actionable. Please reopen if you have something more concrete. ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/488978627/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/488979170",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/18373#issuecomment-488979170",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18373",
    "id": 488979170,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ4ODk3OTE3MA==",
    "user": {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-05-03T07:16:35Z",
    "updated_at": "2019-05-03T07:16:35Z",
    "author_association": "MEMBER",
    "body": "Edit to add: during the fast-sync phase where both headers, bodies, receipts and state is downloaded, geth _is_ extremely write-intense. It will go down once the data is downloaded. ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/488979170/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/489219976",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/18373#issuecomment-489219976",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/18373",
    "id": 489219976,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ4OTIxOTk3Ng==",
    "user": {
      "login": "kzaher",
      "id": 1641148,
      "node_id": "MDQ6VXNlcjE2NDExNDg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1641148?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/kzaher",
      "html_url": "https://github.com/kzaher",
      "followers_url": "https://api.github.com/users/kzaher/followers",
      "following_url": "https://api.github.com/users/kzaher/following{/other_user}",
      "gists_url": "https://api.github.com/users/kzaher/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/kzaher/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/kzaher/subscriptions",
      "organizations_url": "https://api.github.com/users/kzaher/orgs",
      "repos_url": "https://api.github.com/users/kzaher/repos",
      "events_url": "https://api.github.com/users/kzaher/events{/privacy}",
      "received_events_url": "https://api.github.com/users/kzaher/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-05-03T19:53:23Z",
    "updated_at": "2019-05-03T19:53:29Z",
    "author_association": "NONE",
    "body": "I really appreciate your work on geth, and please don't consider this as trolling, but for some reason geth behaves much worse then Ethereum Parity client for me. The initial fast sync time is almost an order of magnitude lower and hardware utilization much better.\r\n\r\nAgain, I'm not saying this to troll you guys, I would really want to use your client since it's de facto standard, compatibility with the ecosystem is better and if something goes south this will probably be the reference behavior.\r\n\r\nI appreciate the 1.9.0 release and all of the improvements that were done there, but for some reason it seems like it's excruciatingly slower and almost kills my hardware.\r\n\r\nThis issue was reported almost half a year ago, so excuse me for not remembering the exact details, but when closing the client for a day it took almost half an hour to catch up for a single day and it usually queried the disk multiple a couple of hundred MB/s.\r\n\r\nI've tried this on multiple computers, multiple SSDs, still the same.\r\n\r\nAre there at least some settings where I can tradeoff memory for speed and disk utilization?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/489219976/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
