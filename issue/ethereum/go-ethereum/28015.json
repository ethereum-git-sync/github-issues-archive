{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28015",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28015/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28015/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28015/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/28015",
  "id": 1868575307,
  "node_id": "I_kwDOAOvK985vYDJL",
  "number": 28015,
  "title": "30s lagspike after `Persisted trie from memory database`",
  "user": {
    "login": "etan-status",
    "id": 89844309,
    "node_id": "MDQ6VXNlcjg5ODQ0MzA5",
    "avatar_url": "https://avatars.githubusercontent.com/u/89844309?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/etan-status",
    "html_url": "https://github.com/etan-status",
    "followers_url": "https://api.github.com/users/etan-status/followers",
    "following_url": "https://api.github.com/users/etan-status/following{/other_user}",
    "gists_url": "https://api.github.com/users/etan-status/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/etan-status/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/etan-status/subscriptions",
    "organizations_url": "https://api.github.com/users/etan-status/orgs",
    "repos_url": "https://api.github.com/users/etan-status/repos",
    "events_url": "https://api.github.com/users/etan-status/events{/privacy}",
    "received_events_url": "https://api.github.com/users/etan-status/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 72233650,
      "node_id": "MDU6TGFiZWw3MjIzMzY1MA==",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/type:bug",
      "name": "type:bug",
      "color": "FF5E5E",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2023-08-27T17:43:07Z",
  "updated_at": "2023-08-30T07:50:24Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "Every couple days, there is `Persisted trie from memory database` from Geth, and after that comes a crazy lagspike >30s spanning several slots.\r\n\r\n⚠️ During this lagspike, attached beacon node validator duties cannot be reliably performed, as the beacon node relies on EL (Geth) to determine whether a block is valid.\r\n\r\nNote that the spec defines an 8s timeout to both `engine_newPayload` and `engine_forkchoiceUpdated`: https://github.com/ethereum/execution-apis/blob/main/src/engine/shanghai.md#engine_newpayloadv2\r\n\r\nIt would be great if Geth would reply with `SYNCING / ACCEPTED` in case the timeout is about to be reached, instead of replying with nothing. This way, the BN knows what's going on instead of degrading the EL connection.\r\n\r\nEven better would be if Geth could still process `engine_newPayload` and `engine_forkchoiceUpdated` messages during this persist operation. As in, process them far enough to issue a final validity verdict. Or, obviously fixing the lag spike altogether :-)\r\n\r\n```\r\nrocketpool_eth1        | DEBUG[08-23|03:24:58.578] Served eth_syncing                       conn=172.18.0.3:45478 reqid=78090  duration=\"92.747µs\"\r\nrocketpool_eth1        | DEBUG[08-23|03:24:58.580] Served eth_getBlockByNumber              conn=172.18.0.3:45478 reqid=78091  duration=\"313.533µs\"\r\nrocketpool_eth1        | DEBUG[08-23|03:24:59.406] Served eth_getBlockByNumber              conn=172.18.0.5:35040 reqid=142469 duration=\"760.936µs\"\r\nrocketpool_eth1        | INFO [08-23|03:25:00.792] Persisted trie from memory database      nodes=14,979,155 size=3.65GiB time=2m39.181582629s gcnodes=69,672,895 gcsize=26.10GiB gctime=10m2.499724637s livenodes=422,719 livesize=152.62MiB\r\nrocketpool_eth1        | INFO [08-23|03:25:00.792] Imported new potential chain segment     number=17,974,704 hash=708dda..a6a0fe blocks=1 txs=340 mgas=29.650 elapsed=35.021s      mgasps=0.847   dirty=194.91MiB\r\nrocketpool_eth1        | DEBUG[08-23|03:25:00.792] Served engine_newPayloadV2               conn=172.18.0.5:34896 reqid=142461 duration=35.03378824s\r\nrocketpool_eth1        | INFO [08-23|03:25:00.822] Chain head was updated                   number=17,974,704 hash=708dda..a6a0fe root=51c8e9..e06d7e elapsed=29.994708ms\r\nrocketpool_eth1        | DEBUG[08-23|03:25:00.823] Served engine_forkchoiceUpdatedV2        conn=172.18.0.5:34914 reqid=142463 duration=26.49394218s\r\nrocketpool_eth1        | WARN [08-23|03:25:00.824] Forkchoice requested unknown head        hash=a90265..533878\r\nrocketpool_eth1        | DEBUG[08-23|03:25:00.824] Served engine_forkchoiceUpdatedV2        conn=172.18.0.5:35000 reqid=142467 duration=10.012106712s\r\nrocketpool_eth1        | INFO [08-23|03:25:01.035] Imported new potential chain segment     number=17,974,705 hash=a90265..533878 blocks=1 txs=134 mgas=13.443 elapsed=211.658ms    mgasps=63.514  dirty=195.87MiB\r\nrocketpool_eth1        | DEBUG[08-23|03:25:01.035] Served engine_newPayloadV2               conn=172.18.0.5:34954 reqid=142464 duration=18.604207122s\r\nrocketpool_eth1        | INFO [08-23|03:25:01.317] Imported new potential chain segment     number=17,974,706 hash=22b056..a2c717 blocks=1 txs=128 mgas=12.818 elapsed=271.097ms    mgasps=47.284  dirty=196.85MiB\r\nrocketpool_eth1        | DEBUG[08-23|03:25:01.317] Served engine_newPayloadV2               conn=172.18.0.5:35024 reqid=142468 duration=2.474562299s\r\nrocketpool_eth1        | INFO [08-23|03:25:01.891] Extend chain                             add=2 number=17,974,706 hash=22b056..a2c717\r\nrocketpool_eth1        | INFO [08-23|03:25:01.922] Chain head was updated                   number=17,974,706 hash=22b056..a2c717 root=58a9a0..842221 elapsed=31.173883ms\r\nrocketpool_eth1        | DEBUG[08-23|03:25:01.923] Served engine_forkchoiceUpdatedV2        conn=172.18.0.5:35046 reqid=142470 duration=34.686905ms\r\nrocketpool_eth1        | INFO [08-23|03:25:02.261] Imported new potential chain segment     number=17,974,707 hash=4a5745..f78aea blocks=1 txs=109 mgas=11.774 elapsed=143.834ms    mgasps=81.861  dirty=197.63MiB\r\nrocketpool_eth1        | DEBUG[08-23|03:25:02.261] Served engine_newPayloadV2               conn=172.18.0.5:35048 reqid=142471 duration=154.582618ms\r\nrocketpool_eth1        | INFO [08-23|03:25:02.885] Chain head was updated                   number=17,974,707 hash=4a5745..f78aea root=9f7e75..e871cf elapsed=14.687322ms\r\nrocketpool_eth1        | DEBUG[08-23|03:25:02.885] Served engine_forkchoiceUpdatedV2        conn=172.18.0.5:35052 reqid=142472 duration=18.510668ms\r\n```\r\n\r\n```\r\nrocketpool_eth1        | DEBUG[08-26|20:04:09.947] Served eth_call                          conn=172.18.0.3:56666 reqid=131651 duration=\"638.148µs\"\r\nrocketpool_eth1        | DEBUG[08-26|20:04:14.648] Served eth_getBlockByNumber              conn=172.18.0.5:46502 reqid=34950  duration=\"793.31µs\"\r\nrocketpool_eth1        | DEBUG[08-26|20:04:16.949] Served engine_exchangeTransitionConfigurationV1 conn=172.18.0.5:46510 reqid=34951  duration=\"185.494µs\"\r\nrocketpool_eth1        | DEBUG[08-26|20:04:19.948] Served eth_getBlockByNumber              conn=172.18.0.3:56666 reqid=131652 duration=\"539.86µs\"\r\nrocketpool_eth1        | INFO [08-26|20:04:22.343] Persisted trie from memory database      nodes=15,522,470 size=3.77GiB time=2m41.777937169s gcnodes=73,094,369 gcsize=27.43GiB gctime=10m44.159144046s livenodes=437,477 livesize=158.12MiB\r\nrocketpool_eth1        | INFO [08-26|20:04:22.343] Imported new potential chain segment     number=18,001,105 hash=5c33e5..2b8433 blocks=1 txs=121 mgas=15.993 elapsed=32.698s      mgasps=0.489   dirty=201.88MiB\r\nrocketpool_eth1        | DEBUG[08-26|20:04:22.344] Served engine_newPayloadV2               conn=172.18.0.5:46316 reqid=34945  duration=32.720688896s\r\nrocketpool_eth1        | INFO [08-26|20:04:22.360] Chain head was updated                   number=18,001,105 hash=5c33e5..2b8433 root=9a9eb3..d29892 elapsed=16.840341ms\r\nrocketpool_eth1        | DEBUG[08-26|20:04:22.361] Served engine_forkchoiceUpdatedV2        conn=172.18.0.5:46374 reqid=34946  duration=24.281695782s\r\nrocketpool_eth1        | WARN [08-26|20:04:22.362] Forkchoice requested unknown head        hash=73fd7c..2ba967\r\nrocketpool_eth1        | DEBUG[08-26|20:04:22.362] Served engine_forkchoiceUpdatedV2        conn=172.18.0.5:46500 reqid=34949  duration=7.739647994s\r\nrocketpool_eth1        | INFO [08-26|20:04:22.643] Imported new potential chain segment     number=18,001,106 hash=73fd7c..2ba967 blocks=1 txs=154 mgas=22.393 elapsed=282.763ms    mgasps=79.195  dirty=203.69MiB\r\nrocketpool_eth1        | DEBUG[08-26|20:04:22.644] Served engine_newPayloadV2               conn=172.18.0.5:46424 reqid=34948  duration=16.461765452s\r\nrocketpool_eth1        | INFO [08-26|20:04:22.802] Imported new potential chain segment     number=18,001,107 hash=19a72c..6ceeac blocks=1 txs=113 mgas=9.892  elapsed=155.892ms    mgasps=63.457  dirty=204.38MiB\r\nrocketpool_eth1        | DEBUG[08-26|20:04:22.803] Served engine_newPayloadV2               conn=172.18.0.5:46520 reqid=34952  duration=366.493227ms\r\nrocketpool_eth1        | INFO [08-26|20:04:23.270] Extend chain                             add=2 number=18,001,107 hash=19a72c..6ceeac\r\nrocketpool_eth1        | INFO [08-26|20:04:23.283] Chain head was updated                   number=18,001,107 hash=19a72c..6ceeac root=af5147..21c9b1 elapsed=13.26957ms\r\nrocketpool_eth1        | DEBUG[08-26|20:04:23.283] Served engine_forkchoiceUpdatedV2        conn=172.18.0.5:46532 reqid=34953  duration=16.74526ms\r\n```\r\n\r\n#### System information\r\n\r\nGeth version: `ethereum/client-go:v1.12.2`\r\nCL client & version: e.g. `statusim/nimbus-eth2:multiarch-v23.7.0`\r\nOS & Version: Linux\r\nHardware: Rock 5B 16GB RAM (Rocketpool setup with Docker)\r\n\r\n#### Expected behaviour\r\n\r\n- `engine_forkchoiceUpdated` and `engine_newPayload` should always be answered within the 8s spec defined timeout.\r\n- Maintenance tasks should not lead to multi-slot lagspikes as it interferes with validator duties.\r\n\r\n#### Actual behaviour\r\n\r\n- 30s processing times for `engine_forkchoiceUpdated` and `engine_newPayload` after `Persisted trie from memory database`.\r\n\r\n\r\n#### Steps to reproduce the behaviour\r\n\r\n- Run Geth :-)\r\n- `--log.vmodule rpc=5` to see RPC response times. The `Imported new potential chain segment` log's `elapsed` also reflects the lagspike though.",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28015/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28015/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1694724624",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/28015#issuecomment-1694724624",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28015",
    "id": 1694724624,
    "node_id": "IC_kwDOAOvK985lA3IQ",
    "user": {
      "login": "etan-status",
      "id": 89844309,
      "node_id": "MDQ6VXNlcjg5ODQ0MzA5",
      "avatar_url": "https://avatars.githubusercontent.com/u/89844309?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/etan-status",
      "html_url": "https://github.com/etan-status",
      "followers_url": "https://api.github.com/users/etan-status/followers",
      "following_url": "https://api.github.com/users/etan-status/following{/other_user}",
      "gists_url": "https://api.github.com/users/etan-status/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/etan-status/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/etan-status/subscriptions",
      "organizations_url": "https://api.github.com/users/etan-status/orgs",
      "repos_url": "https://api.github.com/users/etan-status/repos",
      "events_url": "https://api.github.com/users/etan-status/events{/privacy}",
      "received_events_url": "https://api.github.com/users/etan-status/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-08-27T17:49:12Z",
    "updated_at": "2023-08-27T17:49:12Z",
    "author_association": "NONE",
    "body": "Also, this is on LevelDB. If resyncing can improve this, would be great to know as well.\r\n\r\n```\r\nrocketpool_eth1        | INFO [08-19|14:20:02.232] Starting pprof server                    addr=http://127.0.0.1:6060/debug/pprof\r\nrocketpool_eth1        | INFO [08-19|14:20:02.247] Starting Geth on Ethereum mainnet... \r\nrocketpool_eth1        | INFO [08-19|14:20:02.251] Maximum peer count                       ETH=25 LES=0 total=25\r\nrocketpool_eth1        | INFO [08-19|14:20:02.252] Smartcard socket not found, disabling    err=\"stat /run/pcscd/pcscd.comm: no such file or directory\"\r\nrocketpool_eth1        | INFO [08-19|14:20:02.256] Set global gas cap                       cap=50,000,000\r\nrocketpool_eth1        | INFO [08-19|14:20:02.257] Initializing the KZG library             backend=gokzg\r\nrocketpool_eth1        | INFO [08-19|14:20:02.437] Allocated trie memory caches             clean=614.00MiB dirty=1024.00MiB\r\nrocketpool_eth1        | INFO [08-19|14:20:02.860] Using leveldb as the backing database \r\nrocketpool_eth1        | INFO [08-19|14:20:02.860] Allocated cache and file handles         database=/ethclient/geth/geth/chaindata cache=2.00GiB handles=524,288\r\nrocketpool_eth1        | INFO [08-19|14:20:06.185] Using LevelDB as the backing database \r\nrocketpool_eth1        | INFO [08-19|14:20:06.295] Opened ancient database                  database=/ethclient/geth/geth/chaindata/ancient/chain readonly=false\r\nrocketpool_eth1        | INFO [08-19|14:20:07.181] Initialising Ethereum protocol           network=1 dbversion=8\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1694724624/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1698669512",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/28015#issuecomment-1698669512",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28015",
    "id": 1698669512,
    "node_id": "IC_kwDOAOvK985lP6PI",
    "user": {
      "login": "karalabe",
      "id": 129561,
      "node_id": "MDQ6VXNlcjEyOTU2MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/karalabe",
      "html_url": "https://github.com/karalabe",
      "followers_url": "https://api.github.com/users/karalabe/followers",
      "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
      "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
      "organizations_url": "https://api.github.com/users/karalabe/orgs",
      "repos_url": "https://api.github.com/users/karalabe/repos",
      "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
      "received_events_url": "https://api.github.com/users/karalabe/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-08-30T07:50:24Z",
    "updated_at": "2023-08-30T07:50:24Z",
    "author_association": "MEMBER",
    "body": "I'm a bit reluctant to go too deeply into this issue because it might not really be relevant short-/mid term. Pebble is generally more performant than LevelDB, so we definitely recommend running with that. Our new path-based scheme is also a lot more performant and does less disk overheads (i.e. it doesn't have the entire trie persisting mechanism at all).\r\n\r\nIf you can afford it, my recommendation would be to try running the master branch with `--state.scheme=path` and `--db.engine=pebble` (default if you don't explicitly request leveldb). You'll need a resync to switch from hash scheme to path scheme since the database layout is completely swapped out, but you can keep your ancient's folder, so you should only need to download the state, not the chain history.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1698669512/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
