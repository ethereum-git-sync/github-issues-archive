{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21902",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21902/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21902/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21902/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/21902",
  "id": 750649453,
  "node_id": "MDU6SXNzdWU3NTA2NDk0NTM=",
  "number": 21902,
  "title": "After crash, Head state missing, repairing - age=1d17h26m",
  "user": {
    "login": "SjonHortensius",
    "id": 1684987,
    "node_id": "MDQ6VXNlcjE2ODQ5ODc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1684987?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/SjonHortensius",
    "html_url": "https://github.com/SjonHortensius",
    "followers_url": "https://api.github.com/users/SjonHortensius/followers",
    "following_url": "https://api.github.com/users/SjonHortensius/following{/other_user}",
    "gists_url": "https://api.github.com/users/SjonHortensius/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/SjonHortensius/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/SjonHortensius/subscriptions",
    "organizations_url": "https://api.github.com/users/SjonHortensius/orgs",
    "repos_url": "https://api.github.com/users/SjonHortensius/repos",
    "events_url": "https://api.github.com/users/SjonHortensius/events{/privacy}",
    "received_events_url": "https://api.github.com/users/SjonHortensius/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 72233650,
      "node_id": "MDU6TGFiZWw3MjIzMzY1MA==",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/type:bug",
      "name": "type:bug",
      "color": "FF5E5E",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2020-11-25T09:31:33Z",
  "updated_at": "2020-11-26T09:09:14Z",
  "closed_at": "2020-11-26T09:09:14Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "#### System information\r\n\r\nGeth version: `1.9.24`\r\nOS & Version: Linux\r\n\r\n#### Expected behaviour\r\n\r\nWhile some regression is expected, repairing the Head state should not revert the state more than ~ an hour.\r\n\r\n#### Actual behaviour\r\n\r\nAfter killing my geth process forcefully, the head state was missing and repaired. However, while the chain was fully up-to-date it was 'repaired' to a state of almost two days ago, meaning I had to resync two days of txs again. Why?\r\n\r\n#### Steps to reproduce the behaviour\r\n\r\nForcefully kill geth, observe repair of head.\r\n\r\n#### Backtrace\r\n\r\n````\r\nLoaded most recent local header          number=11326453 hash=\"5d8615…cdb31d\" td=18945964326052332637063 age=59s\r\nLoaded most recent local full block      number=11326453 hash=\"5d8615…cdb31d\" td=18945964326052332637063 age=59s\r\nLoaded most recent local fast block      number=11326453 hash=\"5d8615…cdb31d\" td=18945964326052332637063 age=59s\r\nLoaded last fast-sync pivot marker       number=10772021\r\nHead state missing, repairing            number=11326453 hash=\"5d8615…cdb31d\"\r\nLoaded most recent local header          number=11326453 hash=\"5d8615…cdb31d\" td=18945964326052332637063 age=1m29s\r\nLoaded most recent local full block      number=11315145 hash=\"7f47a8…be41c7\" td=18906307610258064779456 age=1d17h26m\r\nLoaded most recent local fast block      number=11326453 hash=\"5d8615…cdb31d\" td=18945964326052332637063 age=1m29s\r\n````\r\n",
  "closed_by": {
    "login": "SjonHortensius",
    "id": 1684987,
    "node_id": "MDQ6VXNlcjE2ODQ5ODc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1684987?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/SjonHortensius",
    "html_url": "https://github.com/SjonHortensius",
    "followers_url": "https://api.github.com/users/SjonHortensius/followers",
    "following_url": "https://api.github.com/users/SjonHortensius/following{/other_user}",
    "gists_url": "https://api.github.com/users/SjonHortensius/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/SjonHortensius/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/SjonHortensius/subscriptions",
    "organizations_url": "https://api.github.com/users/SjonHortensius/orgs",
    "repos_url": "https://api.github.com/users/SjonHortensius/repos",
    "events_url": "https://api.github.com/users/SjonHortensius/events{/privacy}",
    "received_events_url": "https://api.github.com/users/SjonHortensius/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21902/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21902/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/734098849",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/21902#issuecomment-734098849",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21902",
    "id": 734098849,
    "node_id": "MDEyOklzc3VlQ29tbWVudDczNDA5ODg0OQ==",
    "user": {
      "login": "rjl493456442",
      "id": 5959481,
      "node_id": "MDQ6VXNlcjU5NTk0ODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5959481?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rjl493456442",
      "html_url": "https://github.com/rjl493456442",
      "followers_url": "https://api.github.com/users/rjl493456442/followers",
      "following_url": "https://api.github.com/users/rjl493456442/following{/other_user}",
      "gists_url": "https://api.github.com/users/rjl493456442/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rjl493456442/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rjl493456442/subscriptions",
      "organizations_url": "https://api.github.com/users/rjl493456442/orgs",
      "repos_url": "https://api.github.com/users/rjl493456442/repos",
      "events_url": "https://api.github.com/users/rjl493456442/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rjl493456442/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-11-26T06:19:17Z",
    "updated_at": "2020-11-26T06:21:50Z",
    "author_association": "MEMBER",
    "body": "It's the expected behavior. During the normal block processing, Geth won't flush out the state change every block. Instead, it tries to GC in the memory in order to limit the state size growth in the disk.\r\n\r\nBut Geth will periodically flush the state change if:\r\n- The cumulative \"evm execution time\" is more than the configured value(it's 1 hour by default)\r\n- The accumulated memory usage beyond the limitation.\r\n\r\nSo that during the repairing we think one hour is totally acceptable. But you can change this value if you think it's too long. The downside is the data size growth.\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/734098849/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/734135091",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/21902#issuecomment-734135091",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21902",
    "id": 734135091,
    "node_id": "MDEyOklzc3VlQ29tbWVudDczNDEzNTA5MQ==",
    "user": {
      "login": "SjonHortensius",
      "id": 1684987,
      "node_id": "MDQ6VXNlcjE2ODQ5ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1684987?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/SjonHortensius",
      "html_url": "https://github.com/SjonHortensius",
      "followers_url": "https://api.github.com/users/SjonHortensius/followers",
      "following_url": "https://api.github.com/users/SjonHortensius/following{/other_user}",
      "gists_url": "https://api.github.com/users/SjonHortensius/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/SjonHortensius/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/SjonHortensius/subscriptions",
      "organizations_url": "https://api.github.com/users/SjonHortensius/orgs",
      "repos_url": "https://api.github.com/users/SjonHortensius/repos",
      "events_url": "https://api.github.com/users/SjonHortensius/events{/privacy}",
      "received_events_url": "https://api.github.com/users/SjonHortensius/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-11-26T07:51:56Z",
    "updated_at": "2020-11-26T07:51:56Z",
    "author_association": "CONTRIBUTOR",
    "body": "@rjl493456442 that's actually pretty clever, thanks for the reply. I agree 1 hour of syncing is acceptable, I didn't realize that metric was already being used. For the sake of completeness, can you confirm you are referring to the `TrieCleanCacheRejournal` aka `--cache.trie.rejournal` setting?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/734135091/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/734138510",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/21902#issuecomment-734138510",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21902",
    "id": 734138510,
    "node_id": "MDEyOklzc3VlQ29tbWVudDczNDEzODUxMA==",
    "user": {
      "login": "rjl493456442",
      "id": 5959481,
      "node_id": "MDQ6VXNlcjU5NTk0ODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5959481?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rjl493456442",
      "html_url": "https://github.com/rjl493456442",
      "followers_url": "https://api.github.com/users/rjl493456442/followers",
      "following_url": "https://api.github.com/users/rjl493456442/following{/other_user}",
      "gists_url": "https://api.github.com/users/rjl493456442/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rjl493456442/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rjl493456442/subscriptions",
      "organizations_url": "https://api.github.com/users/rjl493456442/orgs",
      "repos_url": "https://api.github.com/users/rjl493456442/repos",
      "events_url": "https://api.github.com/users/rjl493456442/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rjl493456442/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-11-26T08:00:09Z",
    "updated_at": "2020-11-26T08:00:09Z",
    "author_association": "MEMBER",
    "body": "If I remember correctly, the interval can only be changed via config file.\r\n\r\n\r\n```shell\r\n[Eth]\r\nTrieCleanCacheRejournal = 3600000000000\r\n```\r\n\r\nYou can firstly dump out the config file via `geth dumpconfig > config.toml`, then start with the modified config",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/734138510/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/734138962",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/21902#issuecomment-734138962",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21902",
    "id": 734138962,
    "node_id": "MDEyOklzc3VlQ29tbWVudDczNDEzODk2Mg==",
    "user": {
      "login": "rjl493456442",
      "id": 5959481,
      "node_id": "MDQ6VXNlcjU5NTk0ODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5959481?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rjl493456442",
      "html_url": "https://github.com/rjl493456442",
      "followers_url": "https://api.github.com/users/rjl493456442/followers",
      "following_url": "https://api.github.com/users/rjl493456442/following{/other_user}",
      "gists_url": "https://api.github.com/users/rjl493456442/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rjl493456442/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rjl493456442/subscriptions",
      "organizations_url": "https://api.github.com/users/rjl493456442/orgs",
      "repos_url": "https://api.github.com/users/rjl493456442/repos",
      "events_url": "https://api.github.com/users/rjl493456442/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rjl493456442/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-11-26T08:01:16Z",
    "updated_at": "2020-11-26T08:01:16Z",
    "author_association": "MEMBER",
    "body": "Btw, the order for applying the configs is: \r\n\r\n- First load the default config\r\n- Apply the config in the config file if it's specified\r\n- Apply the config from the CLI flags\r\n\r\nSo you can still apply the other configs via CLI flags but only change this interval in config file.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/734138962/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/734171920",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/21902#issuecomment-734171920",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21902",
    "id": 734171920,
    "node_id": "MDEyOklzc3VlQ29tbWVudDczNDE3MTkyMA==",
    "user": {
      "login": "SjonHortensius",
      "id": 1684987,
      "node_id": "MDQ6VXNlcjE2ODQ5ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1684987?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/SjonHortensius",
      "html_url": "https://github.com/SjonHortensius",
      "followers_url": "https://api.github.com/users/SjonHortensius/followers",
      "following_url": "https://api.github.com/users/SjonHortensius/following{/other_user}",
      "gists_url": "https://api.github.com/users/SjonHortensius/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/SjonHortensius/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/SjonHortensius/subscriptions",
      "organizations_url": "https://api.github.com/users/SjonHortensius/orgs",
      "repos_url": "https://api.github.com/users/SjonHortensius/repos",
      "events_url": "https://api.github.com/users/SjonHortensius/events{/privacy}",
      "received_events_url": "https://api.github.com/users/SjonHortensius/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-11-26T09:09:14Z",
    "updated_at": "2020-11-26T09:09:14Z",
    "author_association": "CONTRIBUTOR",
    "body": "thanks for verifying :+1: ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/734171920/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
