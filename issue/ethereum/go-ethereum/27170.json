{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/27170",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/27170/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/27170/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/27170/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/27170",
  "id": 1684446639,
  "node_id": "I_kwDOAOvK985kZp2v",
  "number": 27170,
  "title": "bloombits: protect field access with lock to avoid possible data race",
  "user": {
    "login": "yanke-xu",
    "id": 50892490,
    "node_id": "MDQ6VXNlcjUwODkyNDkw",
    "avatar_url": "https://avatars.githubusercontent.com/u/50892490?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/yanke-xu",
    "html_url": "https://github.com/yanke-xu",
    "followers_url": "https://api.github.com/users/yanke-xu/followers",
    "following_url": "https://api.github.com/users/yanke-xu/following{/other_user}",
    "gists_url": "https://api.github.com/users/yanke-xu/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/yanke-xu/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/yanke-xu/subscriptions",
    "organizations_url": "https://api.github.com/users/yanke-xu/orgs",
    "repos_url": "https://api.github.com/users/yanke-xu/repos",
    "events_url": "https://api.github.com/users/yanke-xu/events{/privacy}",
    "received_events_url": "https://api.github.com/users/yanke-xu/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 72233650,
      "node_id": "MDU6TGFiZWw3MjIzMzY1MA==",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/type:bug",
      "name": "type:bug",
      "color": "FF5E5E",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2023-04-26T07:35:30Z",
  "updated_at": "2023-04-26T13:20:34Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "#### System information\r\n\r\nGeth version: `V1.11.6`\r\nOS & Version: `Ubuntu 20.04`\r\n\r\n#### Expected behaviour\r\nNo data race\r\n\r\n#### Actual behaviour\r\nData race\r\n\r\n#### Steps to reproduce the behaviour\r\nManually check the related code\r\n\r\n#### Backtrace\r\nA data race is found by code analysis, and backtrace is described in detatil.  \r\n`res.cached` is read/write in bloombits/scheduler.go; it is write and protected by s.lock.Lock() in func deliver(); it is read without a Lock, which is in func scheduleDeliveries() on L164.\r\nA data race may happen when scheduleDeliveries() and other func like deliver() are called in parallel.\r\nThe fix is to protect the access to `res.cached` and save the result to a local variable.\r\n\r\n**write on res.cached:** \r\nhttps://github.com/ethereum/go-ethereum/blob/f8aa62353666a6368fb3f1a378bd0a82d1542052/core/bloombits/scheduler.go#L177\r\n````\r\n    testScheduler()\r\n->  deliver()\r\n->  res.cached = data[i]  \r\n````\r\n\r\n**read on res.cached:**\r\nhttps://github.com/ethereum/go-ethereum/blob/f8aa62353666a6368fb3f1a378bd0a82d1542052/core/bloombits/scheduler.go#L164\r\n```\r\n    testScheduler()\r\n->  run()\r\n->  scheduleDeliveries()\r\n->  done <- res.cached\r\n```\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/27170/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/27170/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1523412277",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/27170#issuecomment-1523412277",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/27170",
    "id": 1523412277,
    "node_id": "IC_kwDOAOvK985azW01",
    "user": {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-26T13:20:34Z",
    "updated_at": "2023-04-26T13:20:34Z",
    "author_association": "MEMBER",
    "body": "Before the **read on res.cached** happens, there's this select: \r\n```golang\r\n\t\t\tselect {\r\n\t\t\tcase <-quit:\r\n\t\t\t\treturn\r\n\t\t\tcase <-res.done:\r\n\t\t\t}\r\n```\r\nWhich means that the read won't happen unless `res.done` has been closed.\r\nThe **write on res.cached** happens here: \r\n```golang\r\n\tfor i, section := range sections {\r\n\t\tif res := s.responses[section]; res != nil && res.cached == nil { // Avoid non-requests and double deliveries\r\n\t\t\tres.cached = data[i]\r\n\t\t\tclose(res.done)\r\n\t\t}\r\n\t}\r\n```\r\nMeaning, it sets the `res.cached`, and after that's done, it closes `res.done`, thus releasing the potential waiting reader.\r\nSo it seems to me that it's handled already. Since things like this is difficult to reason about with confidence, it would be even better if you can trigger a race via testing, and `go test -run <thetest> -race`. ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1523412277/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
