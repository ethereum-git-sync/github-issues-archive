{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22430",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22430/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22430/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22430/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/22430",
  "id": 822024388,
  "node_id": "MDU6SXNzdWU4MjIwMjQzODg=",
  "number": 22430,
  "title": "Feature - better snapshot eta estimation",
  "user": {
    "login": "yorickdowne",
    "id": 71337066,
    "node_id": "MDQ6VXNlcjcxMzM3MDY2",
    "avatar_url": "https://avatars.githubusercontent.com/u/71337066?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/yorickdowne",
    "html_url": "https://github.com/yorickdowne",
    "followers_url": "https://api.github.com/users/yorickdowne/followers",
    "following_url": "https://api.github.com/users/yorickdowne/following{/other_user}",
    "gists_url": "https://api.github.com/users/yorickdowne/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/yorickdowne/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/yorickdowne/subscriptions",
    "organizations_url": "https://api.github.com/users/yorickdowne/orgs",
    "repos_url": "https://api.github.com/users/yorickdowne/repos",
    "events_url": "https://api.github.com/users/yorickdowne/events{/privacy}",
    "received_events_url": "https://api.github.com/users/yorickdowne/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 72233652,
      "node_id": "MDU6TGFiZWw3MjIzMzY1Mg==",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/type:feature",
      "name": "type:feature",
      "color": "84b6eb",
      "default": false,
      "description": null
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2021-03-04T11:06:48Z",
  "updated_at": "2021-03-25T08:56:10Z",
  "closed_at": "2021-03-25T08:56:09Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "# Rationale\r\n\r\nCurrent snapshot eta is wildly off in the early stages. On a barebones server with 28,9k read / 9.6k write IOPS, it estimated just over 2000 hours after 4.5h of snapshot generation, then settled down to an estimate of 135h after around 10h. On a low-performing VPS with 3k read / 1k write IOPS, early estimation was over 3150h after 7h of snapshot generation, and ~400h after around 12h.\r\n\r\nA better snapshot eta would calm user nerves ... it's also entirely cosmetic.\r\n",
  "closed_by": {
    "login": "holiman",
    "id": 142290,
    "node_id": "MDQ6VXNlcjE0MjI5MA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/holiman",
    "html_url": "https://github.com/holiman",
    "followers_url": "https://api.github.com/users/holiman/followers",
    "following_url": "https://api.github.com/users/holiman/following{/other_user}",
    "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
    "organizations_url": "https://api.github.com/users/holiman/orgs",
    "repos_url": "https://api.github.com/users/holiman/repos",
    "events_url": "https://api.github.com/users/holiman/events{/privacy}",
    "received_events_url": "https://api.github.com/users/holiman/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22430/reactions",
    "total_count": 1,
    "+1": 1,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22430/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/791317137",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/22430#issuecomment-791317137",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22430",
    "id": 791317137,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc5MTMxNzEzNw==",
    "user": {
      "login": "MariusVanDerWijden",
      "id": 16664698,
      "node_id": "MDQ6VXNlcjE2NjY0Njk4",
      "avatar_url": "https://avatars.githubusercontent.com/u/16664698?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MariusVanDerWijden",
      "html_url": "https://github.com/MariusVanDerWijden",
      "followers_url": "https://api.github.com/users/MariusVanDerWijden/followers",
      "following_url": "https://api.github.com/users/MariusVanDerWijden/following{/other_user}",
      "gists_url": "https://api.github.com/users/MariusVanDerWijden/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MariusVanDerWijden/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MariusVanDerWijden/subscriptions",
      "organizations_url": "https://api.github.com/users/MariusVanDerWijden/orgs",
      "repos_url": "https://api.github.com/users/MariusVanDerWijden/repos",
      "events_url": "https://api.github.com/users/MariusVanDerWijden/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MariusVanDerWijden/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-05T10:07:36Z",
    "updated_at": "2021-03-05T10:07:36Z",
    "author_association": "MEMBER",
    "body": "(I misread your question first, so there's a bonus chapter about snap sync now :D )\r\n\r\n### snap generation\r\nThe current algorithm for snap generation estimation is the following:\r\n- Calculate how many keys have been generated (`done = currentKey - start`)\r\n- Estimate how many need to be generated (`left = maxUint64 - currentKey`)\r\n- Calculate speed (`done / elapsedTime`) \r\n- Estimate time needed to generate (`left / speed`)\r\n\r\nThe problem here is that we estimate the items left as if all items up to maxUint64 have to be generated. This is not the case since some of these keys are empty. Thus the estimation incurs a large error margin in the beginning. Maybe it would be better to estimate it as follows:\r\n- Calculate how many accounts have been generated (`gs.accounts`)\r\n- Calculate how much many keys have been generated (`done = currentKey - start`)\r\n- Calculate how many percent of the keyspace was filled (`fillPercentage = gs.accounts / done)\r\n- Estimate how many items need to be generated `left = (maxUint64 - currentKey) * fillPercentage`)\r\n- Calculate speed (`done / elapsedTime`) \r\n- Estimate time needed to generate (`left / speed`)\r\n\r\n### snap sync\r\nThe current algorithm for snap sync estimation is the following:\r\n- Calculate how many accounts need to be synced (`accountGaps`)\r\n- Calculate how many accounts are synced (`accountFills = allaccounts - accountGaps`)\r\n- Estimate the number of bytes needed to sync all remaining accounts (`(syncedBytes * allAccounts) / accountFills`) \r\n- Estimate the time needed to sync all remaining accounts (`(elapsed / syncedBytes) * estimatedBytes`)\r\n\r\nI think the problem is that in the beginning the amount of accounts that are not synced is huge, most of these accounts are empty, but we don't know that yet.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/791317137/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/796014115",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/22430#issuecomment-796014115",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22430",
    "id": 796014115,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc5NjAxNDExNQ==",
    "user": {
      "login": "yorickdowne",
      "id": 71337066,
      "node_id": "MDQ6VXNlcjcxMzM3MDY2",
      "avatar_url": "https://avatars.githubusercontent.com/u/71337066?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/yorickdowne",
      "html_url": "https://github.com/yorickdowne",
      "followers_url": "https://api.github.com/users/yorickdowne/followers",
      "following_url": "https://api.github.com/users/yorickdowne/following{/other_user}",
      "gists_url": "https://api.github.com/users/yorickdowne/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/yorickdowne/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/yorickdowne/subscriptions",
      "organizations_url": "https://api.github.com/users/yorickdowne/orgs",
      "repos_url": "https://api.github.com/users/yorickdowne/repos",
      "events_url": "https://api.github.com/users/yorickdowne/events{/privacy}",
      "received_events_url": "https://api.github.com/users/yorickdowne/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-10T20:07:35Z",
    "updated_at": "2021-03-10T20:11:30Z",
    "author_association": "NONE",
    "body": "Time travel :)\r\n\r\n`State sync in progress                   synced=99.56% state=79.48GiB   accounts=122779736@22.27GiB slots=405199341@55.44GiB codes=363044@1.77GiB    eta=-9.464s`",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/796014115/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/796624491",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/22430#issuecomment-796624491",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22430",
    "id": 796624491,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc5NjYyNDQ5MQ==",
    "user": {
      "login": "karalabe",
      "id": 129561,
      "node_id": "MDQ6VXNlcjEyOTU2MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/karalabe",
      "html_url": "https://github.com/karalabe",
      "followers_url": "https://api.github.com/users/karalabe/followers",
      "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
      "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
      "organizations_url": "https://api.github.com/users/karalabe/orgs",
      "repos_url": "https://api.github.com/users/karalabe/repos",
      "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
      "received_events_url": "https://api.github.com/users/karalabe/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-11T10:11:39Z",
    "updated_at": "2021-03-11T10:11:39Z",
    "author_association": "MEMBER",
    "body": "There's not much we can do wrt better estimation. We don't know in advance how large the state is, so we just start iterating it and see how large it is. If there's a huge contract at the beginning, the generator will think that the state is super saturated and will estimate a large number. Then later when it goes through lots of small contracts, it corrects the guess. It tries to make the best guess, but the more data, the better the guess.\r\n\r\nThat time travel is a similar fluke :D ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/796624491/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/796897560",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/22430#issuecomment-796897560",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22430",
    "id": 796897560,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc5Njg5NzU2MA==",
    "user": {
      "login": "s1na",
      "id": 1591639,
      "node_id": "MDQ6VXNlcjE1OTE2Mzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1591639?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/s1na",
      "html_url": "https://github.com/s1na",
      "followers_url": "https://api.github.com/users/s1na/followers",
      "following_url": "https://api.github.com/users/s1na/following{/other_user}",
      "gists_url": "https://api.github.com/users/s1na/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/s1na/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/s1na/subscriptions",
      "organizations_url": "https://api.github.com/users/s1na/orgs",
      "repos_url": "https://api.github.com/users/s1na/repos",
      "events_url": "https://api.github.com/users/s1na/events{/privacy}",
      "received_events_url": "https://api.github.com/users/s1na/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-11T17:12:18Z",
    "updated_at": "2021-03-11T17:12:18Z",
    "author_association": "MEMBER",
    "body": "@karalabe is there any state statistics we can hardcode as checkpoints (kinda like chts) which can be used for better eta estimation? maybe like total number of nodes/leaves. Not sure worthwhile the complexity for a once-off process though.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/796897560/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/806478246",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/22430#issuecomment-806478246",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22430",
    "id": 806478246,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwNjQ3ODI0Ng==",
    "user": {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-25T08:56:09Z",
    "updated_at": "2021-03-25T08:56:09Z",
    "author_association": "MEMBER",
    "body": "Closing this, the estimator eventually settles on a reasonable guess, not much else we can do. Hardcoding some numbers is just a never-ending game. ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/806478246/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
