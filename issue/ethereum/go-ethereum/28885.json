{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28885",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28885/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28885/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28885/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/28885",
  "id": 2103069559,
  "node_id": "I_kwDOAOvK9859Wkt3",
  "number": 28885,
  "title": "Transaction lookup using eth_getTransactionReceipt returns the wrong information after reorg",
  "user": {
    "login": "tobidae-cb",
    "id": 107199804,
    "node_id": "U_kgDOBmO9PA",
    "avatar_url": "https://avatars.githubusercontent.com/u/107199804?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tobidae-cb",
    "html_url": "https://github.com/tobidae-cb",
    "followers_url": "https://api.github.com/users/tobidae-cb/followers",
    "following_url": "https://api.github.com/users/tobidae-cb/following{/other_user}",
    "gists_url": "https://api.github.com/users/tobidae-cb/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tobidae-cb/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tobidae-cb/subscriptions",
    "organizations_url": "https://api.github.com/users/tobidae-cb/orgs",
    "repos_url": "https://api.github.com/users/tobidae-cb/repos",
    "events_url": "https://api.github.com/users/tobidae-cb/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tobidae-cb/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 72233650,
      "node_id": "MDU6TGFiZWw3MjIzMzY1MA==",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/type:bug",
      "name": "type:bug",
      "color": "FF5E5E",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2024-01-26T23:51:02Z",
  "updated_at": "2024-01-27T20:39:55Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "#### System information\r\n\r\nGeth version: `Geth/v1.13.11-stable-8f7eb9cc/linux-amd64/go1.20.7`\r\nCL client & version: `lighthouse@v4.6.0`\r\nOS & Version: Linux\r\n\r\n#### Expected behaviour\r\n`eth_getTransactionReceipt` returns the right receipt information including block hash, number, e.t.c. Even when a reorg occurs on that block and the transaction is mined in another block.\r\n\r\n#### Actual behaviour\r\n`eth_getTransactionReceipt` sometimes returns the receipt with information from the reorg'd block. This causes our internal systems to fail. This is especially observed in the sepolia/holesky testnets since 1.13.11 is required for the upcoming hardfork.\r\n\r\n#### Steps to reproduce the behaviour\r\n1. Upgrade to 1.13.11 stable version along with lighthouse 4.6.0\r\n2. Run an archival node with the settings below (although it can possibly happen in full nodes)\r\n\r\n```\r\nexec /app/geth \\\r\n    --networkid \"17000\" \\\r\n    --syncmode=\"full\" \\\r\n    --gcmode=\"archival\" \\\r\n    --snapshot=\"true\" \\\r\n    --rpc.txfeecap=0 \\\r\n    --rpc.batch-request-limit 100000 \\\r\n    --rpc.batch-response-max-size 500000000 \\\r\n    --http \\\r\n    --http.addr 0.0.0.0 \\\r\n    --http.vhosts=* \\\r\n    --http.api=\"engine,eth,web3,net,debug,txpool\" \\\r\n    --http.corsdomain=* \\\r\n    --authrpc.addr 0.0.0.0 \\\r\n    --authrpc.vhosts=* \\\r\n    --cache \"16384\" \\\r\n    --state.scheme hash\r\n```\r\n\r\n3. When a reorg occurs there's a probability that the cache for eth_getTransactionReceipt stores the wrong receipt information so any subsequent calls to get a receipt returns the wrong information. When querying the block using the hash or number, the right details are contained there\r\n\r\n#### Backtrace\r\nLogs that had reorg\r\n````\r\n# Specific transaction with observed behavior\r\ncurl -X POST -H \"Content-Type: application/json\" --data '{\"method\":\"eth_getTransactionReceipt\",\"params\":[\"0x36057fedd64685fb69ba23f9d49cbf7b1c0039659d24adaf2b60274b716ef012\"],\"id\":0,\"jsonrpc\":\"2.0\"}' http://localhost:8545 | jq\r\n\r\n# Actual Result\r\n{\r\n  \"jsonrpc\": \"2.0\",\r\n  \"id\": 0,\r\n  \"result\": {\r\n    \"blockHash\": \"0xa0056303bb52371aa38b7996f031a9d10bc8dd1d78ce921b5047abb47334ad7a\",\r\n    \"blockNumber\": \"0xc78e8\",\r\n    \"contractAddress\": null,\r\n    \"cumulativeGasUsed\": \"0x1c7bac2\",\r\n    \"effectiveGasPrice\": \"0x3b9aca00\",\r\n    \"from\": \"0x9146a7ece7054c39f2d27dfc45efa8fa8e1d1323\",\r\n    \"gasUsed\": \"0xfaa5e\",\r\n    \"logs\": [],\r\n    \"logsBloom\": \"0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\",\r\n    \"status\": \"0x1\",\r\n    \"to\": \"0x3f5dfd1522a84394390382a9801616bd530a9655\",\r\n    \"transactionHash\": \"0x36057fedd64685fb69ba23f9d49cbf7b1c0039659d24adaf2b60274b716ef012\",\r\n    \"transactionIndex\": \"0x2d\",\r\n    \"type\": \"0x2\"\r\n  }\r\n}\r\n\r\n\r\n# Expected result\r\n{\r\n  \"jsonrpc\": \"2.0\",\r\n  \"id\": 0,\r\n  \"result\": {\r\n    \"blockHash\": \"0x046495e9e416d899e933c21cd0539aad3d90f6888bd46007246456189c482299\",\r\n    \"blockNumber\": \"0xc78e9\",\r\n    \"contractAddress\": null,\r\n    \"cumulativeGasUsed\": \"0xffe36\",\r\n    \"effectiveGasPrice\": \"0x3b9aca00\",\r\n    \"from\": \"0x9146a7ece7054c39f2d27dfc45efa8fa8e1d1323\",\r\n    \"gasUsed\": \"0xfaa5e\",\r\n    \"logs\": [],\r\n    \"logsBloom\": \"0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\",\r\n    \"status\": \"0x1\",\r\n    \"to\": \"0x3f5dfd1522a84394390382a9801616bd530a9655\",\r\n    \"transactionHash\": \"0x36057fedd64685fb69ba23f9d49cbf7b1c0039659d24adaf2b60274b716ef012\",\r\n    \"transactionIndex\": \"0x1\",\r\n    \"type\": \"0x2\"\r\n  }\r\n}\r\n\r\n\r\n# Logs from problematic deployment\r\nFor prod ethereum-0 archival holesky\r\nethereum-0 geth INFO [01-26|22:08:21.009] Chain head was updated                   number=817,384 hash=a00563..34ad7a root=51418b..2f5c82 elapsed=4.17309ms\r\nethereum-0 geth INFO [01-26|22:08:28.259] Imported new potential chain segment     number=817,384 hash=319dbf..fec640 blocks=1 txs=55 mgas=29.916 elapsed=128.272ms   mgasps=233.222 snapdiffs=1.35MiB triedirty=0.00B\r\nethereum-0 geth INFO [01-26|22:08:29.254] Imported new potential chain segment     number=817,385 hash=046495..482299 blocks=1 txs=33 mgas=29.944 elapsed=135.098ms   mgasps=221.645 snapdiffs=1.35MiB triedirty=0.00B\r\nethereum-0 geth INFO [01-26|22:08:31.895] Chain reorg detected                     number=817,383 hash=2bd818..756b40 drop=1 dropfrom=a00563..34ad7a add=2 addfrom=046495..482299\r\nethereum-0 geth INFO [01-26|22:08:31.904] Chain head was updated                   number=817,385 hash=046495..482299 root=c7fbc7..da6141 elapsed=9.360949ms\r\nethereum-0 geth INFO [01-26|22:08:38.883] Imported new potential chain segment     number=817,386 hash=6b13b0..95ed30 blocks=1 txs=23 mgas=9.466  elapsed=43.761ms    mgasps=216.302 snapdiffs=1.35MiB triedirty=0.00B\r\nethereum-0 geth INFO [01-26|22:08:39.176] Chain head was updated                   number=817,386 hash=6b13b0..95ed30 root=b1f284..f364cd elapsed=4.695815ms\r\n\r\n# Logs from expected behavior\r\nethereum-0 geth INFO [01-26|22:07:39.776] Imported new potential chain segment     number=817,383 hash=2bd818..756b40 blocks=1    txs=0       mgas=0.000    elapsed=3.333ms     mgasps=0.000   snapdiffs=3.18MiB    triedirty=0.00B\r\nethereum-0 geth INFO [01-26|22:07:40.072] Chain head was updated                   number=817,383 hash=2bd818..756b40 root=c0724c..aab761 elapsed=\"815.439Âµs\"\r\nethereum-0 geth INFO [01-26|22:08:14.904] Imported new potential chain segment     number=817,384 hash=a00563..34ad7a blocks=1    txs=49      mgas=29.998   elapsed=146.869ms   mgasps=204.250 snapdiffs=3.18MiB    triedirty=0.00B\r\nethereum-0 geth INFO [01-26|22:08:20.822] Chain head was updated                   number=817,384 hash=a00563..34ad7a root=51418b..2f5c82 elapsed=3.650328ms\r\nethereum-0 geth INFO [01-26|22:08:23.798] Imported new potential chain segment     number=817,384 hash=319dbf..fec640 blocks=1    txs=55      mgas=29.916   elapsed=122.690ms   mgasps=243.832 snapdiffs=3.19MiB    triedirty=0.00B\r\nethereum-0 geth INFO [01-26|22:08:24.836] Imported new potential chain segment     number=817,385 hash=046495..482299 blocks=1    txs=33      mgas=29.944   elapsed=120.422ms   mgasps=248.658 snapdiffs=3.19MiB    triedirty=0.00B\r\nethereum-0 geth INFO [01-26|22:08:26.823] Chain reorg detected                     number=817,383 hash=2bd818..756b40 drop=1 dropfrom=a00563..34ad7a add=1 addfrom=319dbf..fec640\r\nethereum-0 geth INFO [01-26|22:08:26.829] Chain head was updated                   number=817,384 hash=319dbf..fec640 root=aa8a16..a2261d elapsed=6.317064ms\r\nethereum-0 geth INFO [01-26|22:08:27.667] Chain head was updated                   number=817,385 hash=046495..482299 root=c7fbc7..da6141 elapsed=4.855725ms\r\nethereum-0 geth INFO [01-26|22:08:38.878] Imported new potential chain segment     number=817,386 hash=6b13b0..95ed30 blocks=1    txs=23      mgas=9.466    elapsed=39.822ms    mgasps=237.699 snapdiffs=3.19MiB    triedirty=0.00B\r\nethereum-0 geth INFO [01-26|22:08:39.170] Chain head was updated                   number=817,386 hash=6b13b0..95ed30 root=b1f284..f364cd elapsed=1.247488ms\r\nethereum-0 geth INFO [01-26|22:08:49.142] Imported new potential chain segment     number=817,387 hash=a6dd16..dbda80 blocks=1    txs=38      mgas=28.078   elapsed=109.512ms   mgasps=256.391 snapdiffs=3.19MiB    triedirty=0.00B\r\nethereum-0 geth INFO [01-26|22:08:49.440] Chain head was updated                   number=817,387 hash=a6dd16..dbda80 root=b8bece..4073f3 elapsed=1.507894ms\r\nethereum-0 geth INFO [01-26|22:09:02.154] Regenerated local transaction journal    transactions=0 accounts=0\r\n````\r\n\r\nWhen submitting logs: please submit them as text and not screenshots.\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28885/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28885/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1912840470",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/28885#issuecomment-1912840470",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28885",
    "id": 1912840470,
    "node_id": "IC_kwDOAOvK985yA6EW",
    "user": {
      "login": "tobidae-cb",
      "id": 107199804,
      "node_id": "U_kgDOBmO9PA",
      "avatar_url": "https://avatars.githubusercontent.com/u/107199804?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tobidae-cb",
      "html_url": "https://github.com/tobidae-cb",
      "followers_url": "https://api.github.com/users/tobidae-cb/followers",
      "following_url": "https://api.github.com/users/tobidae-cb/following{/other_user}",
      "gists_url": "https://api.github.com/users/tobidae-cb/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tobidae-cb/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tobidae-cb/subscriptions",
      "organizations_url": "https://api.github.com/users/tobidae-cb/orgs",
      "repos_url": "https://api.github.com/users/tobidae-cb/repos",
      "events_url": "https://api.github.com/users/tobidae-cb/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tobidae-cb/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2024-01-26T23:51:42Z",
    "updated_at": "2024-01-26T23:51:42Z",
    "author_association": "NONE",
    "body": "Possibly related bug introduction - https://github.com/ethereum/go-ethereum/pull/28703\r\n\r\nPossible fix - https://github.com/ethereum/go-ethereum/pull/28865",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1912840470/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1912885455",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/28885#issuecomment-1912885455",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28885",
    "id": 1912885455,
    "node_id": "IC_kwDOAOvK985yBFDP",
    "user": {
      "login": "lightclient",
      "id": 14004106,
      "node_id": "MDQ6VXNlcjE0MDA0MTA2",
      "avatar_url": "https://avatars.githubusercontent.com/u/14004106?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/lightclient",
      "html_url": "https://github.com/lightclient",
      "followers_url": "https://api.github.com/users/lightclient/followers",
      "following_url": "https://api.github.com/users/lightclient/following{/other_user}",
      "gists_url": "https://api.github.com/users/lightclient/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/lightclient/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/lightclient/subscriptions",
      "organizations_url": "https://api.github.com/users/lightclient/orgs",
      "repos_url": "https://api.github.com/users/lightclient/repos",
      "events_url": "https://api.github.com/users/lightclient/events{/privacy}",
      "received_events_url": "https://api.github.com/users/lightclient/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2024-01-27T01:00:43Z",
    "updated_at": "2024-01-27T01:00:43Z",
    "author_association": "MEMBER",
    "body": "Thanks for filing this. I think you are correct and we'll try to get that PR merged in.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1912885455/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
