{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/17159",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/17159/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/17159/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/17159/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/17159",
  "id": 340079908,
  "node_id": "MDU6SXNzdWUzNDAwNzk5MDg=",
  "number": 17159,
  "title": "Pending block includes transactions by sum of transaction gas limit. Possible network DoS.",
  "user": {
    "login": "fastchain",
    "id": 13186708,
    "node_id": "MDQ6VXNlcjEzMTg2NzA4",
    "avatar_url": "https://avatars.githubusercontent.com/u/13186708?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/fastchain",
    "html_url": "https://github.com/fastchain",
    "followers_url": "https://api.github.com/users/fastchain/followers",
    "following_url": "https://api.github.com/users/fastchain/following{/other_user}",
    "gists_url": "https://api.github.com/users/fastchain/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/fastchain/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/fastchain/subscriptions",
    "organizations_url": "https://api.github.com/users/fastchain/orgs",
    "repos_url": "https://api.github.com/users/fastchain/repos",
    "events_url": "https://api.github.com/users/fastchain/events{/privacy}",
    "received_events_url": "https://api.github.com/users/fastchain/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2018-07-11T03:36:05Z",
  "updated_at": "2018-07-11T13:36:37Z",
  "closed_at": "2018-07-11T08:26:57Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "#### System information\r\n\r\nGeth version: v1.8.3-stable\r\nOS & Version: linux-amd64\r\nCommit hash : 329ac18e\r\nBanner: Geth/v1.8.3-stable-329ac18e/linux-amd64/go1.10\r\n\r\n#### Expected behaviour\r\nPending block should include transactions  by sum of actual spent gas.\r\n\r\n#### Actual behaviour\r\nPending block includes  transactions  by sum of transactions gas limit.\r\n\r\n#### Steps to reproduce the behaviour\r\n1. Init new chain with\r\n```\r\n{\r\n    \"config\": {\r\n        \"chainId\": 88658,\r\n        \"homesteadBlock\": 0,\r\n        \"eip155Block\": 0,\r\n        \"eip158Block\": 0\r\n    },\r\n    \"coinbase\" : \"0x0000000000000000000000000000000000000000\",\r\n    \"difficulty\" : \"0x1\",\r\n    \"extraData\" : \"0x00\",\r\n    \"gasLimit\" : \"0x47e7c5\",\r\n    \"nonce\" : \"0x0000000000000042\",\r\n    \"mixhash\" : \"0x0000000000000000000000000000000000000000000000000000000000000000\",\r\n    \"parentHash\" : \"0x0000000000000000000000000000000000000000000000000000000000000000\",\r\n    \"timestamp\" : \"0x00\",\r\n    \"alloc\" : {\r\n        \"0xcc89924c686db81e592329e86a06339995362931\": {\"balance\": \"888888888888888888888888\"}\r\n    }\r\n}\r\n\r\n```\r\n\r\n1. Send siqence of transactions with maximum possible (according to block limit) gas.\r\n```\r\n\r\nimport json\r\nimport web3\r\nimport time\r\nfrom web3 import Web3, HTTPProvider, TestRPCProvider, IPCProvider\r\n\r\n\r\nweb3 = Web3(HTTPProvider('http://localhost:40000'))\r\n\r\nprint(web3.personal.unlockAccount(web3.eth.coinbase, ''))\r\nprint(web3.eth.blockNumber)\r\nwhile True:\r\n    time.sleep(1)\r\n    print(web3.eth.sendTransaction({'to':  Web3.toChecksumAddress('0xe778cf0902521dd08162c3e614718a4b4b19542d'), 'from': web3.eth.coinbase, 'value': 1,'gas':4712388}))\r\n\r\n#4712388 -- block gas limit\r\n\r\n```\r\n2. Wait until transactions will be mined\r\n3. v1.8.3-stable mines only one transaction per block disregard how much gas actually spent\r\n\r\n#### DoS Attack scenario\r\n\r\nMalicious actor can create sequince of transactions with  gas limit equal to block gas limit each, so no other transactions will be included into pending block from the pool. Since actual gas consumption for ether transfer is low, this attack costs almost nothing.\r\n\r\n\r\n#### Trace\r\n\r\n```\r\nINFO [07-11|05:29:58] Submitted transaction                    fullhash=0xe4dc8ed35c62aee6e2c411f2a1bbaff8c5c7a73cc0e5e4f0feb049908745eda1 recipient=0xE778CF0902521Dd08162C3e614718a4b4b19542d\r\nINFO [07-11|05:30:00] Submitted transaction                    fullhash=0xf3bbd062b9315f8c77fac086077984c59e6822aa5ae77acd24509701f448b5d8 recipient=0xE778CF0902521Dd08162C3e614718a4b4b19542d\r\nINFO [07-11|05:30:01] Submitted transaction                    fullhash=0xab29d1bc6f328ede1f9a1197a86da5928c6cae4f150aa7be7931e2fe2efea24b recipient=0xE778CF0902521Dd08162C3e614718a4b4b19542d\r\nINFO [07-11|05:30:03] Submitted transaction                    fullhash=0x5a3f99727605abb86014c13ff15b6653235526b0f8dd2912f75ca46e96d25c26 recipient=0xE778CF0902521Dd08162C3e614718a4b4b19542d\r\nINFO [07-11|05:30:04] Submitted transaction                    fullhash=0xb42f3bd646e11526a68cc4bf5ef9aaea9a1e425fa6005047198a9899b59a394a recipient=0xE778CF0902521Dd08162C3e614718a4b4b19542d\r\nINFO [07-11|05:30:06] Submitted transaction                    fullhash=0xabeb3ddb5337cd52cfdbf090eb28657ff0ac2b1a59cd6004dd94b1c3ecba4039 recipient=0xE778CF0902521Dd08162C3e614718a4b4b19542d\r\nINFO [07-11|05:30:07] Successfully sealed new block            number=295709 hash=047ff8â€¦42b042\r\nINFO [07-11|05:30:07] ðŸ”— block reached canonical chain          number=295704 hash=c1a583â€¦126861\r\nINFO [07-11|05:30:07] ðŸ”¨ mined potential block                  number=295709 hash=047ff8â€¦42b042\r\nINFO [07-11|05:30:07] Commit new mining work                   number=295710 txs=1 uncles=0 elapsed=284.088Âµs\r\nINFO [07-11|05:30:07] Submitted transaction                    fullhash=0x4181f7fec0beeb185119fe23251430cbfca6515165140f06d1bbf1f2f4da3769 recipient=0xE778CF0902521Dd08162C3e614718a4b4b19542d\r\nINFO [07-11|05:30:08] Successfully sealed new block            number=295710 hash=d1c77eâ€¦bea301\r\nINFO [07-11|05:30:08] ðŸ”— block reached canonical chain          number=295705 hash=94a366â€¦4026e6\r\nINFO [07-11|05:30:08] ðŸ”¨ mined potential block                  number=295710 hash=d1c77eâ€¦bea301\r\nINFO [07-11|05:30:08] Commit new mining work                   number=295711 txs=1 uncles=0 elapsed=176.021Âµs\r\nINFO [07-11|05:30:09] Submitted transaction                    fullhash=0x868dd337834ffb2667dd6c010bfd9a4bbe38ea1349fbd9e0ca5df07346bb8228 recipient=0xE778CF0902521Dd08162C3e614718a4b4b19542d\r\nINFO [07-11|05:30:10] Submitted transaction                    fullhash=0x88fc983a2c0754f92715118f3838b95d1ca73b9fc7672825eefa6cdba1c6d168 recipient=0xE778CF0902521Dd08162C3e614718a4b4b19542d\r\nINFO [07-11|05:30:12] Submitted transaction                    fullhash=0x31147a9f6211dac7a99ba2f521b7f142a5368a373192789ea943cec1d8da408d recipient=0xE778CF0902521Dd08162C3e614718a4b4b19542d\r\nINFO [07-11|05:30:13] Submitted transaction                    fullhash=0x7a9c897fdea1d747e8b0afbec50cec73f604c554f64ea563c83dab567b787d65 recipient=0xE778CF0902521Dd08162C3e614718a4b4b19542d\r\nINFO [07-11|05:30:15] Submitted transaction                    fullhash=0xdaf37c1f8c9548e072f5d4b99ac2b3280b932937fff553a19534eba1ca6c2693 recipient=0xE778CF0902521Dd08162C3e614718a4b4b19542d\r\nINFO [07-11|05:30:16] Successfully sealed new block            number=295711 hash=fe5034â€¦4ea454\r\nINFO [07-11|05:30:16] ðŸ”— block reached canonical chain          number=295706 hash=a2cf5câ€¦c178cf\r\nINFO [07-11|05:30:16] ðŸ”¨ mined potential block                  number=295711 hash=fe5034â€¦4ea454\r\nINFO [07-11|05:30:16] Commit new mining work                   number=295712 txs=1 uncles=0 elapsed=261.808Âµs\r\nINFO [07-11|05:30:17] Submitted transaction                    fullhash=0x82c6e849c5b32d08c7462dfad566ea7ac918ec645afafb302fe29c10f954b51b recipient=0xE778CF0902521Dd08162C3e614718a4b4b19542d\r\nINFO [07-11|05:30:18] Submitted transaction                    fullhash=0x1b394526d32fe84796b0ed1d5a2444e53171cf5c7920854ccfb7ad38c8fb19e2 recipient=0xE778CF0902521Dd08162C3e614718a4b4b19542d\r\nINFO [07-11|05:30:20] Submitted transaction                    fullhash=0x5dc9ed2694edc925020a2f67fe08e30143dbf339e271f8651e61e02e0fc0b445 recipient=0xE778CF0902521Dd08162C3e614718a4b4b19542d\r\nINFO [07-11|05:30:21] Submitted transaction                    fullhash=0x321c23b254820e4a8b390ec18967866327c046cdb3a2809601a7da39683e61c3 recipient=0xE778CF0902521Dd08162C3e614718a4b4b19542d\r\nINFO [07-11|05:30:23] Submitted transaction                    fullhash=0x14efaac9f3c3b30abe7b3d6580842c29cc8f06ce8b05e699d23664329293c004 recipient=0xE778CF0902521Dd08162C3e614718a4b4b19542d\r\nINFO [07-11|05:30:24] Submitted transaction                    fullhash=0x01faf3b02dc67e94d65a2bf38cc7d0a855d630a805cc6cc396092b63a792efde recipient=0xE778CF0902521Dd08162C3e614718a4b4b19542d\r\nINFO [07-11|05:30:26] Submitted transaction                    fullhash=0x31cfd7adce9ffd01fef1ef91e3ff0e49ab6554d19a3a694d1b818a967468e00c recipient=0xE778CF0902521Dd08162C3e614718a4b4b19542d\r\nINFO [07-11|05:30:27] Submitted transaction                    fullhash=0xc256539e8b4118259225813544df4fd69c2838d26ce63689f9579036e3095ba6 recipient=0xE778CF0902521Dd08162C3e614718a4b4b19542d\r\nINFO [07-11|05:30:29] Submitted transaction                    fullhash=0xe035b61b8430e128652cd1c32f1745302b1488cb983cb2bae9836bab276187c8 recipient=0xE778CF0902521Dd08162C3e614718a4b4b19542d\r\nINFO [07-11|05:30:30] Submitted transaction                    fullhash=0xc60074bff00ee1f40ce53550c9ba89ea721352245430ff74afed9fbe25a193bc recipient=0xE778CF0902521Dd08162C3e614718a4b4b19542d\r\nINFO [07-11|05:30:32] Submitted transaction                    fullhash=0x90c6d82e8fec268b8f91a67f02320db183a7d0c71c0b6386fdecefe49ae40782 recipient=0xE778CF0902521Dd08162C3e614718a4b4b19542d\r\nINFO [07-11|05:30:33] Successfully sealed new block            number=295712 hash=b43c36â€¦e728b7\r\nINFO [07-11|05:30:33] ðŸ”— block reached canonical chain          number=295707 hash=3f2c86â€¦8dd164\r\nINFO [07-11|05:30:33] ðŸ”¨ mined potential block                  number=295712 hash=b43c36â€¦e728b7\r\nINFO [07-11|05:30:33] Commit new mining work                   number=295713 txs=1 uncles=0 elapsed=335.136Âµs\r\n```\r\nas you may see, there is only one transaction per block",
  "closed_by": {
    "login": "karalabe",
    "id": 129561,
    "node_id": "MDQ6VXNlcjEyOTU2MQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/karalabe",
    "html_url": "https://github.com/karalabe",
    "followers_url": "https://api.github.com/users/karalabe/followers",
    "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
    "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
    "organizations_url": "https://api.github.com/users/karalabe/orgs",
    "repos_url": "https://api.github.com/users/karalabe/repos",
    "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
    "received_events_url": "https://api.github.com/users/karalabe/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/17159/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/17159/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/404087523",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/17159#issuecomment-404087523",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/17159",
    "id": 404087523,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQwNDA4NzUyMw==",
    "user": {
      "login": "karalabe",
      "id": 129561,
      "node_id": "MDQ6VXNlcjEyOTU2MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/karalabe",
      "html_url": "https://github.com/karalabe",
      "followers_url": "https://api.github.com/users/karalabe/followers",
      "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
      "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
      "organizations_url": "https://api.github.com/users/karalabe/orgs",
      "repos_url": "https://api.github.com/users/karalabe/repos",
      "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
      "received_events_url": "https://api.github.com/users/karalabe/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-07-11T08:26:57Z",
    "updated_at": "2018-07-11T08:26:57Z",
    "author_association": "MEMBER",
    "body": "This is actually working as intended. When the miner is including transactions, it needs to make sure that the transaction actually fits inside without wasting time executing it.\r\n\r\nIn your case, it takes the first transaction, sees that the block contains enough gas to cover the requested amount and runs the transaction. After that, the block has less gas available than what the next transaction requested, so it cannot safely include it.\r\n\r\nThe transaction may consume less gas than requested, but the miner cannot know that without actually executing it. But if we execute it and it consumes all the gas, that's wasted resources because we cannot include it.\r\n\r\nAs such, the only safe inclusion logic is to make sure the block contains enough gas to cover the transaction in the worst case of execution (consuming all the requested gas). If there is still space left in the block, further transactions will be attempted to be included, but only those which surely fit.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/404087523/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/404171864",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/17159#issuecomment-404171864",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/17159",
    "id": 404171864,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQwNDE3MTg2NA==",
    "user": {
      "login": "fastchain",
      "id": 13186708,
      "node_id": "MDQ6VXNlcjEzMTg2NzA4",
      "avatar_url": "https://avatars.githubusercontent.com/u/13186708?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fastchain",
      "html_url": "https://github.com/fastchain",
      "followers_url": "https://api.github.com/users/fastchain/followers",
      "following_url": "https://api.github.com/users/fastchain/following{/other_user}",
      "gists_url": "https://api.github.com/users/fastchain/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fastchain/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fastchain/subscriptions",
      "organizations_url": "https://api.github.com/users/fastchain/orgs",
      "repos_url": "https://api.github.com/users/fastchain/repos",
      "events_url": "https://api.github.com/users/fastchain/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fastchain/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-07-11T13:36:37Z",
    "updated_at": "2018-07-11T13:36:37Z",
    "author_association": "NONE",
    "body": "@karalabe  thank you very much for reply!\r\n\r\nI'm a bit confused. I've just tested the same scenario in main net and it looks like, there is no such issue, since both transactions  (and many others) were added to the same block successfull:\r\n\r\nhttps://etherscan.io/tx/0x06c6d6d55d16a4c33c5cf595ec00e60825ad3737106fd858a62a0f94a513336b\r\nhttps://etherscan.io/tx/0x90ad11b0ff639d738426823f1c2e75277296c9a1ff1c203a33b0c7b8f1cd95f0\r\n\r\nDo you have any ideas how do mainchain miners overcome this issue?\r\n\r\nThank you.\r\n\r\n\r\n  ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/404171864/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
