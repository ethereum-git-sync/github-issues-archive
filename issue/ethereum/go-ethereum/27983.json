{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/27983",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/27983/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/27983/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/27983/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/27983",
  "id": 1862994621,
  "node_id": "I_kwDOAOvK985vCwq9",
  "number": 27983,
  "title": "\"Unexpected trie node in disk\" with path-based storage",
  "user": {
    "login": "JustinDrake",
    "id": 731743,
    "node_id": "MDQ6VXNlcjczMTc0Mw==",
    "avatar_url": "https://avatars.githubusercontent.com/u/731743?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/JustinDrake",
    "html_url": "https://github.com/JustinDrake",
    "followers_url": "https://api.github.com/users/JustinDrake/followers",
    "following_url": "https://api.github.com/users/JustinDrake/following{/other_user}",
    "gists_url": "https://api.github.com/users/JustinDrake/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/JustinDrake/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/JustinDrake/subscriptions",
    "organizations_url": "https://api.github.com/users/JustinDrake/orgs",
    "repos_url": "https://api.github.com/users/JustinDrake/repos",
    "events_url": "https://api.github.com/users/JustinDrake/events{/privacy}",
    "received_events_url": "https://api.github.com/users/JustinDrake/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 72233650,
      "node_id": "MDU6TGFiZWw3MjIzMzY1MA==",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/type:bug",
      "name": "type:bug",
      "color": "FF5E5E",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 6,
  "created_at": "2023-08-23T09:59:06Z",
  "updated_at": "2023-11-21T02:48:14Z",
  "closed_at": null,
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "I'm running `geth version 1.13.0-unstable-5976e584-20230818` with `state.scheme=path` on a Mac and getting some \"Unexpected trie node in disk\" errors. Steps I used:\r\n\r\n1) started a fresh checkpoint sync with Lighthouse v4.3.0\r\n2) ran `geth removedb` and deleted the `chaindata` folder\r\n3) ran `geth state.scheme=path`\r\n4) shut down Lighthouse with checkpoint sync flags\r\n5) restarted Lighthouse without checkpoint sync flags\r\n\r\n![photo_2023-08-23_10-39-32](https://github.com/ethereum/go-ethereum/assets/731743/41a765a8-ec64-47d8-b804-b6df5a1df03f)\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/27983/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/27983/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1689730182",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/27983#issuecomment-1689730182",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/27983",
    "id": 1689730182,
    "node_id": "IC_kwDOAOvK985ktzyG",
    "user": {
      "login": "karalabe",
      "id": 129561,
      "node_id": "MDQ6VXNlcjEyOTU2MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/karalabe",
      "html_url": "https://github.com/karalabe",
      "followers_url": "https://api.github.com/users/karalabe/followers",
      "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
      "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
      "organizations_url": "https://api.github.com/users/karalabe/orgs",
      "repos_url": "https://api.github.com/users/karalabe/repos",
      "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
      "received_events_url": "https://api.github.com/users/karalabe/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-08-23T10:43:29Z",
    "updated_at": "2023-08-23T10:43:29Z",
    "author_association": "MEMBER",
    "body": "Just a note, the above screenshot has a node whilst it is still span syncing (heal phase) where the state trie is not yet fuly assembled. Justing confirmed that once sync completed, the error messages disappeared.\r\n\r\nInterestingly, Lighthouse should not be querying anything in checkpoint syncmode, but perhaps the root of the annyoing logs is the restart of lighthouse in normal mode before Geth finished syncing. We should try to repro that and see if it does some weird RPC calls and why we're serving them instead of just ignoring the unservable calls (missing root node).",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1689730182/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1818965551",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/27983#issuecomment-1818965551",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/27983",
    "id": 1818965551,
    "node_id": "IC_kwDOAOvK985sazYv",
    "user": {
      "login": "molaughlen",
      "id": 5364527,
      "node_id": "MDQ6VXNlcjUzNjQ1Mjc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5364527?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/molaughlen",
      "html_url": "https://github.com/molaughlen",
      "followers_url": "https://api.github.com/users/molaughlen/followers",
      "following_url": "https://api.github.com/users/molaughlen/following{/other_user}",
      "gists_url": "https://api.github.com/users/molaughlen/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/molaughlen/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/molaughlen/subscriptions",
      "organizations_url": "https://api.github.com/users/molaughlen/orgs",
      "repos_url": "https://api.github.com/users/molaughlen/repos",
      "events_url": "https://api.github.com/users/molaughlen/events{/privacy}",
      "received_events_url": "https://api.github.com/users/molaughlen/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-11-20T12:22:14Z",
    "updated_at": "2023-11-20T12:30:04Z",
    "author_association": "NONE",
    "body": "I'm seeing this after upgrading geth, removing and rebuilding the DB.  Lighthouse is the consensus client.\r\n\r\nCLI args: --syncmode snap --state.scheme path\r\n\r\ngeth finished sync'ing but this error has remained for the past 96 hours.\r\n\r\n```\r\n   slots=659,803,107             storage=50.89GiB   dangling=0 elapsed=74h34m12.257s eta=131h14m44.871s\r\nNov 20 12:21:00 ip-10-0-0-11.ec2.internal geth[18425]: INFO [11-20|12:21:00.346] Imported new potential chain segment     number=18,612,963 hash=296aab..f8682a blocks=1  txs=143   mgas=11.844 elapsed=264.770ms     mgasps=44.731  snapdiffs=320.09KiB triediffs=183.38MiB triedirty=56.53MiB\r\nNov 20 12:21:00 ip-10-0-0-11.ec2.internal geth[18425]: ERROR[11-20|12:21:00.401] Unexpected trie node in disk             owner=5cc0a4..667982 path=\"[12 5 9 3 7]\"             expect=8b09b1..e87152 got=99f9a0..b9f78f\r\nNov 20 12:21:00 ip-10-0-0-11.ec2.internal geth[18425]: ERROR[11-20|12:21:00.401] State snapshotter failed to iterate trie err=nil\r\nNov 20 12:21:00 ip-10-0-0-11.ec2.internal geth[18425]: INFO [11-20|12:21:00.948] Chain head was updated                   number=18,612,963 hash=296aab..f8682a root=6b5095..844674 elapsed=19.059446ms\r\nNov 20 12:21:13 ip-10-0-0-11.ec2.internal geth[18425]: INFO [11-20|12:21:13.817] Resuming state snapshot generation       root=88a2ed..86827b in=5cc0a4..667982 at=c528e6..3f228f accounts=81,827,943           slots=659,806,109             storage=50.89GiB   dangling=0 elapsed=74h34m25.752s eta=131h15m8.623s\r\nNov 20 12:21:13 ip-10-0-0-11.ec2.internal geth[18425]: INFO [11-20|12:21:13.864] Imported new potential chain segment     number=18,612,964 hash=16504b..a6a093 blocks=1  txs=256   mgas=20.011 elapsed=761.573ms     mgasps=26.276  snapdiffs=324.66KiB triediffs=183.94MiB triedirty=56.80MiB\r\nNov 20 12:21:13 ip-10-0-0-11.ec2.internal geth[18425]: ERROR[11-20|12:21:13.992] Unexpected trie node in disk             owner=5cc0a4..667982 path=\"[12 5 9 3 7]\"             expect=8b09b1..e87152 got=99f9a0..b9f78f\r\nNov 20 12:21:13 ip-10-0-0-11.ec2.internal geth[18425]: ERROR[11-20|12:21:13.992] State snapshotter failed to iterate trie err=nil\r\nNov 20 12:21:14 ip-10-0-0-11.ec2.internal geth[18425]: INFO [11-20|12:21:14.244] Chain head was updated                   number=18,612,964 hash=16504b..a6a093 root=35526f..7fe483 elapsed=24.553583ms\r\nNov 20 12:21:24 ip-10-0-0-11.ec2.internal geth[18425]: INFO [11-20|12:21:24.636] Resuming state snapshot generation       root=6cbb62..60d860 in=5cc0a4..667982 at=c528e6..3f228f accounts=81,827,943           slots=659,809,111             storage=50.89GiB   dangling=0 elapsed=74h34m36.571s eta=131h15m27.664s\r\nNov 20 12:21:24 ip-10-0-0-11.ec2.internal geth[18425]: INFO [11-20|12:21:24.665] Imported new potential chain segment     number=18,612,965 hash=833fba..22f170 blocks=1  txs=125   mgas=8.195  elapsed=173.435ms     mgasps=47.249  snapdiffs=335.19KiB triediffs=183.77MiB triedirty=57.10MiB\r\nNov 20 12:21:24 ip-10-0-0-11.ec2.internal geth[18425]: ERROR[11-20|12:21:24.728] Unexpected trie node in disk             owner=5cc0a4..667982 path=\"[12 5 9 3 7]\"             expect=8b09b1..e87152 got=99f9a0..b9f78f\r\nNov 20 12:21:24 ip-10-0-0-11.ec2.internal geth[18425]: ERROR[11-20|12:21:24.728] State snapshotter failed to iterate trie err=nil\r\nNov 20 12:21:24 ip-10-0-0-11.ec2.internal geth[18425]: INFO [11-20|12:21:24.930] Chain head was updated                   number=18,612,965 hash=833fba..22f170 root=b0587e..adf841 elapsed=4.411775ms\r\nNov 20 12:21:37 ip-10-0-0-11.ec2.internal geth[18425]: INFO [11-20|12:21:37.758] Resuming state snapshot generation       root=771977..09f7db in=5cc0a4..667982 at=c528e6..3f228f accounts=81,827,943   \r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1818965551/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1819002340",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/27983#issuecomment-1819002340",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/27983",
    "id": 1819002340,
    "node_id": "IC_kwDOAOvK985sa8Xk",
    "user": {
      "login": "rjl493456442",
      "id": 5959481,
      "node_id": "MDQ6VXNlcjU5NTk0ODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5959481?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rjl493456442",
      "html_url": "https://github.com/rjl493456442",
      "followers_url": "https://api.github.com/users/rjl493456442/followers",
      "following_url": "https://api.github.com/users/rjl493456442/following{/other_user}",
      "gists_url": "https://api.github.com/users/rjl493456442/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rjl493456442/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rjl493456442/subscriptions",
      "organizations_url": "https://api.github.com/users/rjl493456442/orgs",
      "repos_url": "https://api.github.com/users/rjl493456442/repos",
      "events_url": "https://api.github.com/users/rjl493456442/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rjl493456442/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-11-20T12:47:23Z",
    "updated_at": "2023-11-20T12:53:45Z",
    "author_association": "MEMBER",
    "body": "What's the geth version you are using? What's the original geth version you used?\r\n\r\n> I'm seeing this after upgrading geth, removing and rebuilding the DB\r\n\r\nDid you upgrade geth in the middle of snap sync? Or you delete the entire geth database and sync from scratch?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1819002340/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1819041489",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/27983#issuecomment-1819041489",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/27983",
    "id": 1819041489,
    "node_id": "IC_kwDOAOvK985sbF7R",
    "user": {
      "login": "rjl493456442",
      "id": 5959481,
      "node_id": "MDQ6VXNlcjU5NTk0ODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5959481?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rjl493456442",
      "html_url": "https://github.com/rjl493456442",
      "followers_url": "https://api.github.com/users/rjl493456442/followers",
      "following_url": "https://api.github.com/users/rjl493456442/following{/other_user}",
      "gists_url": "https://api.github.com/users/rjl493456442/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rjl493456442/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rjl493456442/subscriptions",
      "organizations_url": "https://api.github.com/users/rjl493456442/orgs",
      "repos_url": "https://api.github.com/users/rjl493456442/repos",
      "events_url": "https://api.github.com/users/rjl493456442/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rjl493456442/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-11-20T13:12:56Z",
    "updated_at": "2023-11-20T13:13:07Z",
    "author_association": "MEMBER",
    "body": "Do you have the log during the sync? Please attach it if possible.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1819041489/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1819687782",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/27983#issuecomment-1819687782",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/27983",
    "id": 1819687782,
    "node_id": "IC_kwDOAOvK985sdjtm",
    "user": {
      "login": "molaughlen",
      "id": 5364527,
      "node_id": "MDQ6VXNlcjUzNjQ1Mjc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5364527?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/molaughlen",
      "html_url": "https://github.com/molaughlen",
      "followers_url": "https://api.github.com/users/molaughlen/followers",
      "following_url": "https://api.github.com/users/molaughlen/following{/other_user}",
      "gists_url": "https://api.github.com/users/molaughlen/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/molaughlen/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/molaughlen/subscriptions",
      "organizations_url": "https://api.github.com/users/molaughlen/orgs",
      "repos_url": "https://api.github.com/users/molaughlen/repos",
      "events_url": "https://api.github.com/users/molaughlen/events{/privacy}",
      "received_events_url": "https://api.github.com/users/molaughlen/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-11-20T19:41:20Z",
    "updated_at": "2023-11-20T20:06:09Z",
    "author_association": "NONE",
    "body": "I was on geth 1.10.23 which kept getting out of sync/requiring a restart.  I purged the DB (rm -rf data-dir) before I started the new version geth 1.13.5.  This error doesn't appear to be affecting the validators/beacon.\r\n\r\nI've attached the log output 10 minutes before the error appeared in the log until the first instance(s).\r\n\r\n[geth-unexpected-trie-2023-11-17.txt](https://github.com/ethereum/go-ethereum/files/13418942/geth-unexpected-trie-2023-11-17.txt)\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1819687782/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1820081948",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/27983#issuecomment-1820081948",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/27983",
    "id": 1820081948,
    "node_id": "IC_kwDOAOvK985sfD8c",
    "user": {
      "login": "rjl493456442",
      "id": 5959481,
      "node_id": "MDQ6VXNlcjU5NTk0ODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5959481?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rjl493456442",
      "html_url": "https://github.com/rjl493456442",
      "followers_url": "https://api.github.com/users/rjl493456442/followers",
      "following_url": "https://api.github.com/users/rjl493456442/following{/other_user}",
      "gists_url": "https://api.github.com/users/rjl493456442/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rjl493456442/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rjl493456442/subscriptions",
      "organizations_url": "https://api.github.com/users/rjl493456442/orgs",
      "repos_url": "https://api.github.com/users/rjl493456442/repos",
      "events_url": "https://api.github.com/users/rjl493456442/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rjl493456442/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-11-21T01:47:04Z",
    "updated_at": "2023-11-21T02:48:14Z",
    "author_association": "MEMBER",
    "body": "Do you have the full log for sync? \r\n\r\n> This error doesn't appear to be affecting the validators/beacon.\r\n\r\nUnfortunately your state is corrupted because of a \"unsuccessful\" state sync. The node can still operate without printing any other error if because the corrupted state is not touched yet. The only way to fix it is resync the node(of course, you can still keep the ancient which is correct)\r\n\r\nBut I would appreciate if you can run this [branch](https://github.com/ethereum/go-ethereum/pull/28560) [EDIT, it's merged into master branch now] on top of your **existent** datadir just to dump more information for debugging.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1820081948/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
