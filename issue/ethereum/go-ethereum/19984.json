{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19984",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19984/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19984/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19984/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/19984",
  "id": 482340625,
  "node_id": "MDU6SXNzdWU0ODIzNDA2MjU=",
  "number": 19984,
  "title": "geth-V1.9.0 always occurs \"replacement transaction underpriced\" use eth_sendTransaction without a given nonce,  but not occur v1.8.0 or previous",
  "user": {
    "login": "shangmacun",
    "id": 5226358,
    "node_id": "MDQ6VXNlcjUyMjYzNTg=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5226358?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/shangmacun",
    "html_url": "https://github.com/shangmacun",
    "followers_url": "https://api.github.com/users/shangmacun/followers",
    "following_url": "https://api.github.com/users/shangmacun/following{/other_user}",
    "gists_url": "https://api.github.com/users/shangmacun/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/shangmacun/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/shangmacun/subscriptions",
    "organizations_url": "https://api.github.com/users/shangmacun/orgs",
    "repos_url": "https://api.github.com/users/shangmacun/repos",
    "events_url": "https://api.github.com/users/shangmacun/events{/privacy}",
    "received_events_url": "https://api.github.com/users/shangmacun/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1132754722,
      "node_id": "MDU6TGFiZWwxMTMyNzU0NzIy",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/need:more-information",
      "name": "need:more-information",
      "color": "db6fa3",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2019-08-19T14:19:33Z",
  "updated_at": "2019-11-13T13:49:43Z",
  "closed_at": "2019-11-13T13:49:43Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "when batch send txs in  geth-V1.9.0 always occurs \"replacement transaction underpriced\" use eth_sendTransaction without a given nonce, but not occur v1.8.0 or previous",
  "closed_by": {
    "login": "no-response[bot]",
    "id": 32965360,
    "node_id": "MDM6Qm90MzI5NjUzNjA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/26350515?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/no-response%5Bbot%5D",
    "html_url": "https://github.com/apps/no-response",
    "followers_url": "https://api.github.com/users/no-response%5Bbot%5D/followers",
    "following_url": "https://api.github.com/users/no-response%5Bbot%5D/following{/other_user}",
    "gists_url": "https://api.github.com/users/no-response%5Bbot%5D/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/no-response%5Bbot%5D/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/no-response%5Bbot%5D/subscriptions",
    "organizations_url": "https://api.github.com/users/no-response%5Bbot%5D/orgs",
    "repos_url": "https://api.github.com/users/no-response%5Bbot%5D/repos",
    "events_url": "https://api.github.com/users/no-response%5Bbot%5D/events{/privacy}",
    "received_events_url": "https://api.github.com/users/no-response%5Bbot%5D/received_events",
    "type": "Bot",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19984/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19984/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/541664317",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/19984#issuecomment-541664317",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19984",
    "id": 541664317,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU0MTY2NDMxNw==",
    "user": {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-10-14T13:02:36Z",
    "updated_at": "2019-10-14T13:02:36Z",
    "author_association": "MEMBER",
    "body": "How do you 'batch send' ? There's no built-in functionality for that, so it all depends on how it's done. My guess is you rely on geth to provide nonce, and doing that erroneously leads to problems, since geth will answer with the next nonce based on what's already in the tx pool, and may thus supply the same nonce to two separate transactions, causing them to be 'same', and thus one being seen as replacement.  ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/541664317/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/543087209",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/19984#issuecomment-543087209",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19984",
    "id": 543087209,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU0MzA4NzIwOQ==",
    "user": {
      "login": "prd-fox",
      "id": 31221824,
      "node_id": "MDQ6VXNlcjMxMjIxODI0",
      "avatar_url": "https://avatars.githubusercontent.com/u/31221824?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/prd-fox",
      "html_url": "https://github.com/prd-fox",
      "followers_url": "https://api.github.com/users/prd-fox/followers",
      "following_url": "https://api.github.com/users/prd-fox/following{/other_user}",
      "gists_url": "https://api.github.com/users/prd-fox/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/prd-fox/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/prd-fox/subscriptions",
      "organizations_url": "https://api.github.com/users/prd-fox/orgs",
      "repos_url": "https://api.github.com/users/prd-fox/repos",
      "events_url": "https://api.github.com/users/prd-fox/events{/privacy}",
      "received_events_url": "https://api.github.com/users/prd-fox/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-10-17T09:21:49Z",
    "updated_at": "2019-10-17T09:23:24Z",
    "author_association": "NONE",
    "body": "Hi,\r\n\r\nI have noticed this as well, and you are correct in that it happens when you rely on geth to provide the nonces.\r\nIt only happens when transactions are submitted at the same time as a block is imported, and so during the txpool reorg, both dirty accounts and the reset request are present. The issue then resolves itself upon the next block import.\r\nI have only used clique, and see it happen most often when a chain reorg occurs.\r\n\r\nIt's been a few days since I looked at it - I'll check again to see if the txpool noncer is returning the latest transaction nonce for the account (so one short), or it is returning an even older nonce.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/543087209/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/543088702",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/19984#issuecomment-543088702",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19984",
    "id": 543088702,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU0MzA4ODcwMg==",
    "user": {
      "login": "prd-fox",
      "id": 31221824,
      "node_id": "MDQ6VXNlcjMxMjIxODI0",
      "avatar_url": "https://avatars.githubusercontent.com/u/31221824?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/prd-fox",
      "html_url": "https://github.com/prd-fox",
      "followers_url": "https://api.github.com/users/prd-fox/followers",
      "following_url": "https://api.github.com/users/prd-fox/following{/other_user}",
      "gists_url": "https://api.github.com/users/prd-fox/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/prd-fox/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/prd-fox/subscriptions",
      "organizations_url": "https://api.github.com/users/prd-fox/orgs",
      "repos_url": "https://api.github.com/users/prd-fox/repos",
      "events_url": "https://api.github.com/users/prd-fox/events{/privacy}",
      "received_events_url": "https://api.github.com/users/prd-fox/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-10-17T09:25:49Z",
    "updated_at": "2019-10-17T09:25:49Z",
    "author_association": "NONE",
    "body": "Also, through the course of debugging, I found this diff fixes the issue, although it far too heavy.\r\n\r\n```\r\nIndex: core/tx_pool.go\r\nIDEA additional info:\r\nSubsystem: com.intellij.openapi.diff.impl.patch.CharsetEP\r\n<+>UTF-8\r\n===================================================================\r\n--- core/tx_pool.go (revision a73f3f45183a347864a1c941930d6f26c6f06ac2)\r\n+++ core/tx_pool.go (date 1571061817768)\r\n@@ -241,6 +241,8 @@\r\n    reorgDoneCh     chan chan struct{}\r\n    reorgShutdownCh chan struct{}  // requests shutdown of scheduleReorgLoop\r\n    wg              sync.WaitGroup // tracks loop, scheduleReorgLoop\r\n+\r\n+   mu2          sync.RWMutex\r\n }\r\n \r\n type txpoolResetRequest struct {\r\n@@ -903,9 +905,14 @@\r\n // requestPromoteExecutables requests a pool reset to the new head block.\r\n // The returned channel is closed when the reset has occurred.\r\n func (pool *TxPool) requestReset(oldHead *types.Header, newHead *types.Header) chan struct{} {\r\n+   pool.mu2.Lock()\r\n+   defer pool.mu2.Unlock()\r\n+\r\n    select {\r\n    case pool.reqResetCh <- &txpoolResetRequest{oldHead, newHead}:\r\n-       return <-pool.reorgDoneCh\r\n+       channel := <-pool.reorgDoneCh\r\n+       <- channel\r\n+       return channel\r\n    case <-pool.reorgShutdownCh:\r\n        return pool.reorgShutdownCh\r\n    }\r\n@@ -914,6 +921,9 @@\r\n // requestPromoteExecutables requests transaction promotion checks for the given addresses.\r\n // The returned channel is closed when the promotion checks have occurred.\r\n func (pool *TxPool) requestPromoteExecutables(set *accountSet) chan struct{} {\r\n+   pool.mu2.Lock()\r\n+   defer pool.mu2.Unlock()\r\n+\r\n    select {\r\n    case pool.reqPromoteCh <- set:\r\n        return <-pool.reorgDoneCh\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/543088702/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/553412014",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/19984#issuecomment-553412014",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19984",
    "id": 553412014,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU1MzQxMjAxNA==",
    "user": {
      "login": "no-response[bot]",
      "id": 32965360,
      "node_id": "MDM6Qm90MzI5NjUzNjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/26350515?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/no-response%5Bbot%5D",
      "html_url": "https://github.com/apps/no-response",
      "followers_url": "https://api.github.com/users/no-response%5Bbot%5D/followers",
      "following_url": "https://api.github.com/users/no-response%5Bbot%5D/following{/other_user}",
      "gists_url": "https://api.github.com/users/no-response%5Bbot%5D/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/no-response%5Bbot%5D/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/no-response%5Bbot%5D/subscriptions",
      "organizations_url": "https://api.github.com/users/no-response%5Bbot%5D/orgs",
      "repos_url": "https://api.github.com/users/no-response%5Bbot%5D/repos",
      "events_url": "https://api.github.com/users/no-response%5Bbot%5D/events{/privacy}",
      "received_events_url": "https://api.github.com/users/no-response%5Bbot%5D/received_events",
      "type": "Bot",
      "site_admin": false
    },
    "created_at": "2019-11-13T13:49:42Z",
    "updated_at": "2019-11-13T13:49:42Z",
    "author_association": "NONE",
    "body": "This issue has been automatically closed because there has been no response to our request for more information from the original author. With only the information that is currently in the issue, we don't have enough information to take action. Please reach out if you have more relevant information or answers to our questions so that we can investigate further.\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/553412014/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
