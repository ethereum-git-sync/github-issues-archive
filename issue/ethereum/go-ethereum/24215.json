{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/24215",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/24215/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/24215/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/24215/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/24215",
  "id": 1096931142,
  "node_id": "I_kwDOAOvK985BYddG",
  "number": 24215,
  "title": "Any way to repair state data when `missing trie node` happend",
  "user": {
    "login": "louisliu2048",
    "id": 35095310,
    "node_id": "MDQ6VXNlcjM1MDk1MzEw",
    "avatar_url": "https://avatars.githubusercontent.com/u/35095310?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/louisliu2048",
    "html_url": "https://github.com/louisliu2048",
    "followers_url": "https://api.github.com/users/louisliu2048/followers",
    "following_url": "https://api.github.com/users/louisliu2048/following{/other_user}",
    "gists_url": "https://api.github.com/users/louisliu2048/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/louisliu2048/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/louisliu2048/subscriptions",
    "organizations_url": "https://api.github.com/users/louisliu2048/orgs",
    "repos_url": "https://api.github.com/users/louisliu2048/repos",
    "events_url": "https://api.github.com/users/louisliu2048/events{/privacy}",
    "received_events_url": "https://api.github.com/users/louisliu2048/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 268304226,
      "node_id": "MDU6TGFiZWwyNjgzMDQyMjY=",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/type:docs",
      "name": "type:docs",
      "color": "fef2c0",
      "default": false,
      "description": null
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2022-01-08T13:42:04Z",
  "updated_at": "2022-01-17T01:18:37Z",
  "closed_at": "2022-01-17T01:18:37Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "Our team uses a modified go-ethereum to build a private chain, run our own application. Everything was ok until last week, one node's disk(archive node) was full and that node crashed. When we clean up the data of other applications and restart the node again, we occurs a `missing trie node` error . After querying on the Internet, we know that the database of trie may be broken. Therefore, we intend to re-execute some blocks to repair the trie database.\r\nWe select a state that is more than 10,000 blocks earlier than the node collapse (we modified the code of go-ethereum, and think that the data at that height is no problem) as the starting state, and re-execute the subsequent blocks from that point. \r\nHowever, we found a problem. When we finished executing the height N, we were able to obtain the damaged trie node data through the function `db.OpenStorageTrie`, and successfully completed the `so.trie.Commit` commit operation in the Commit stage, also updated the relevant root hash. However, when the height is N+1, when we try to get tire node data through `db.OpenStorageTrie` with the latest updated root hash, there is still a `missing trie node` error, which confuses us.\r\nWe would like to know if there is an official way to fix the state data by re-executing the block. Is our repair method correct and what needs to be improved.",
  "closed_by": {
    "login": "louisliu2048",
    "id": 35095310,
    "node_id": "MDQ6VXNlcjM1MDk1MzEw",
    "avatar_url": "https://avatars.githubusercontent.com/u/35095310?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/louisliu2048",
    "html_url": "https://github.com/louisliu2048",
    "followers_url": "https://api.github.com/users/louisliu2048/followers",
    "following_url": "https://api.github.com/users/louisliu2048/following{/other_user}",
    "gists_url": "https://api.github.com/users/louisliu2048/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/louisliu2048/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/louisliu2048/subscriptions",
    "organizations_url": "https://api.github.com/users/louisliu2048/orgs",
    "repos_url": "https://api.github.com/users/louisliu2048/repos",
    "events_url": "https://api.github.com/users/louisliu2048/events{/privacy}",
    "received_events_url": "https://api.github.com/users/louisliu2048/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/24215/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/24215/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1008640557",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/24215#issuecomment-1008640557",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/24215",
    "id": 1008640557,
    "node_id": "IC_kwDOAOvK9848HqIt",
    "user": {
      "login": "karalabe",
      "id": 129561,
      "node_id": "MDQ6VXNlcjEyOTU2MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/karalabe",
      "html_url": "https://github.com/karalabe",
      "followers_url": "https://api.github.com/users/karalabe/followers",
      "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
      "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
      "organizations_url": "https://api.github.com/users/karalabe/orgs",
      "repos_url": "https://api.github.com/users/karalabe/repos",
      "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
      "received_events_url": "https://api.github.com/users/karalabe/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-01-10T08:31:44Z",
    "updated_at": "2022-01-10T08:31:44Z",
    "author_association": "MEMBER",
    "body": "It's a bit hard to see what you're doing or how correct it is. Geth by default has a memory caching/pruning layer above the disk database. (trie.Database). During block processing, the references are added and removed to the roots explicitly that trigger various GC operations. Archive nodes are special cased to do flushes intertwined with these operations. (core/blockchain.go).\r\n\r\nYou'll need to make sure that your recovery mechanism also takes the trie GC into account. Comitting the trie will only have it end up in this memory layer, you'll need to flush this to disk (in case of an archive node) to persist it across blocks. Also make sure you respect the referencing/dereferencing of the roots to avoid a mismatch and a later failure due to that.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1008640557/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1014044324",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/24215#issuecomment-1014044324",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/24215",
    "id": 1014044324,
    "node_id": "IC_kwDOAOvK9848cRak",
    "user": {
      "login": "louisliu2048",
      "id": 35095310,
      "node_id": "MDQ6VXNlcjM1MDk1MzEw",
      "avatar_url": "https://avatars.githubusercontent.com/u/35095310?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/louisliu2048",
      "html_url": "https://github.com/louisliu2048",
      "followers_url": "https://api.github.com/users/louisliu2048/followers",
      "following_url": "https://api.github.com/users/louisliu2048/following{/other_user}",
      "gists_url": "https://api.github.com/users/louisliu2048/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/louisliu2048/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/louisliu2048/subscriptions",
      "organizations_url": "https://api.github.com/users/louisliu2048/orgs",
      "repos_url": "https://api.github.com/users/louisliu2048/repos",
      "events_url": "https://api.github.com/users/louisliu2048/events{/privacy}",
      "received_events_url": "https://api.github.com/users/louisliu2048/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-01-17T01:18:37Z",
    "updated_at": "2022-01-17T01:18:37Z",
    "author_association": "NONE",
    "body": "> It's a bit hard to see what you're doing or how correct it is. Geth by default has a memory caching/pruning layer above the disk database. (trie.Database). During block processing, the references are added and removed to the roots explicitly that trigger various GC operations. Archive nodes are special cased to do flushes intertwined with these operations. (core/blockchain.go).\r\n> \r\n> You'll need to make sure that your recovery mechanism also takes the trie GC into account. Comitting the trie will only have it end up in this memory layer, you'll need to flush this to disk (in case of an archive node) to persist it across blocks. Also make sure you respect the referencing/dereferencing of the roots to avoid a mismatch and a later failure due to that.\r\n\r\nThx, we have found the root cause: miss use of `ethcmn.TrimLeftZeroes` function at `trie.TryUpdate`, which will lead to probabilistic data inconsistency",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1014044324/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
