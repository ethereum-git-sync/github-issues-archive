{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19447",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19447/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19447/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19447/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/19447",
  "id": 431973049,
  "node_id": "MDU6SXNzdWU0MzE5NzMwNDk=",
  "number": 19447,
  "title": "Head state missing after clean shutdown",
  "user": {
    "login": "jleeh",
    "id": 10528926,
    "node_id": "MDQ6VXNlcjEwNTI4OTI2",
    "avatar_url": "https://avatars.githubusercontent.com/u/10528926?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jleeh",
    "html_url": "https://github.com/jleeh",
    "followers_url": "https://api.github.com/users/jleeh/followers",
    "following_url": "https://api.github.com/users/jleeh/following{/other_user}",
    "gists_url": "https://api.github.com/users/jleeh/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jleeh/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jleeh/subscriptions",
    "organizations_url": "https://api.github.com/users/jleeh/orgs",
    "repos_url": "https://api.github.com/users/jleeh/repos",
    "events_url": "https://api.github.com/users/jleeh/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jleeh/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 202012689,
      "node_id": "MDU6TGFiZWwyMDIwMTI2ODk=",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/area:core",
      "name": "area:core",
      "color": "fbca04",
      "default": false,
      "description": null
    },
    {
      "id": 1141538240,
      "node_id": "MDU6TGFiZWwxMTQxNTM4MjQw",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/need:documentation",
      "name": "need:documentation",
      "color": "b4fcae",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2019-04-11T11:32:17Z",
  "updated_at": "2019-06-11T08:57:58Z",
  "closed_at": "2019-06-11T08:57:28Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "#### System information\r\n\r\nGeth version: `Geth/v1.9.0-unstable-ba90a4aa/linux-amd64/go1.11.5`\r\nOS & Version: Linux\r\n\r\n#### Expected behaviour\r\nOn clean shutdown and the instance is templated, when Geth is then started back up on a fresh instance which is from the previous snapshot, the head state shouldn't be missing and sync should be started from where it last was.\r\n\r\n#### Actual behaviour\r\nOn clean shutdown and after the instance is templated and a new one is span up, Geth reports that the head state is missing and rolls back a week worth of blocks (Rinkeby):\r\n```\r\nINFO [04-11|10:37:02.573] Maximum peer count                       ETH=25 LES=0 total=25\r\nINFO [04-11|10:37:02.579] Starting peer-to-peer node               instance=Geth/v1.9.0-unstable-ba90a4aa/linux-amd64/go1.11.5\r\nINFO [04-11|10:37:02.579] Allocated trie memory caches             clean=512.00MiB dirty=512.00MiB\r\nINFO [04-11|10:37:02.579] Allocated cache and file handles         database=/geth/.ethereum/geth/chaindata cache=1024.00MiB handles=2048\r\nINFO [04-11|10:37:05.941] Persisted trie from memory database      nodes=355 size=50.69KiB time=1.141464ms gcnodes=0 gcsize=0.00B gctime=0s livenodes=1 livesize=0.00B\r\nINFO [04-11|10:37:05.943] Initialised chain configuration          config=\"{ChainID: 4 Homestead: 1 DAO: <nil> DAOSupport: true EIP150: 2 EIP155: 3 EIP158: 3 Byzantium: 1035301 Constantinople: 3660663  ConstantinopleFix: 9999999 Engine: clique}\"\r\nINFO [04-11|10:37:05.944] Initialising Ethereum protocol           versions=\"[63 62]\" network=4\r\nWARN [04-11|10:37:06.008] Head state missing, repairing chain      number=4186240 hash=c5ea58…5aff4b\r\nINFO [04-11|10:39:32.192] Rewound blockchain to past state         number=4121410 hash=fc261e…95c6e6\r\nINFO [04-11|10:39:32.193] Loaded most recent local header          number=4186240 hash=c5ea58…5aff4b td=7706000 age=15h36m34s\r\nINFO [04-11|10:39:32.193] Loaded most recent local full block      number=4121410 hash=fc261e…95c6e6 td=7590922 age=1w4d21h\r\nINFO [04-11|10:39:32.193] Loaded most recent local fast block      number=4186240 hash=c5ea58…5aff4b td=7706000 age=15h36m34s\r\nINFO [04-11|10:39:32.194] Loaded local transaction journal         transactions=0 dropped=0\r\nINFO [04-11|10:39:32.194] Regenerated local transaction journal    transactions=0 accounts=0\r\nWARN [04-11|10:39:32.194] Blockchain not empty, fast sync disabled\r\nINFO [04-11|10:39:32.429] New local node record                    seq=31 id=40e1179a5096a18c ip=127.0.0.1 udp=30303 tcp=30303\r\nINFO [04-11|10:39:32.432] IPC endpoint opened                      url=/geth/.ethereum/geth.ipc\r\nINFO [04-11|10:39:32.433] HTTP endpoint opened                     url=http://0.0.0.0:8545      cors= vhosts=*\r\nINFO [04-11|10:39:32.434] WebSocket endpoint opened                url=ws://[::]:8546\r\n```\r\n\r\nTo give the logs of the instance being templated, while syncing and then on shutdown:\r\n```\r\namazon-ebs: INFO [04-10|19:01:07.585] Imported new chain segment blocks=395 txs=3124 mgas=1136.896 elapsed=8.011s mgasps=141.901 number=4185983 hash=2a9b21…f32be8 age=1h2m24s dirty=501.84MiB\r\namazon-ebs: Node is still syncing\r\namazon-ebs: Waiting for geth to sync, sleeping 2min...\r\namazon-ebs: INFO [04-10|19:01:15.510] Imported new chain segment blocks=244 txs=1893 mgas=464.878 elapsed=7.925s mgasps=58.659 number=4186227 hash=1409f6…4562fe age=1m32s dirty=502.61MiB\r\namazon-ebs: INFO [04-10|19:01:15.644] Imported new chain segment blocks=3 txs=35 mgas=9.147 elapsed=130.808ms mgasps=69.929 number=4186230 hash=c6acee…1395c3 dirty=502.72MiB\r\namazon-ebs: INFO [04-10|19:01:15.857] Imported new chain segment blocks=3 txs=31 mgas=17.094 elapsed=198.552ms mgasps=86.091 number=4186233 hash=750888…24c09b dirty=502.75MiB\r\namazon-ebs: INFO [04-10|19:01:29.290] Imported new chain segment blocks=1 txs=5 mgas=0.728 elapsed=16.309ms mgasps=44.630 number=4186234 hash=1cedbe…0633b3 dirty=502.70MiB\r\namazon-ebs: INFO [04-10|19:01:44.279] Imported new chain segment blocks=1 txs=10 mgas=1.347 elapsed=17.617ms mgasps=76.451 number=4186235 hash=a8f7dd…9d96ae dirty=502.74MiB\r\namazon-ebs: INFO [04-10|19:01:59.276] Imported new chain segment blocks=1 txs=11 mgas=0.924 elapsed=15.840ms mgasps=58.354 number=4186236 hash=d077a7…44a3e7 dirty=502.75MiB\r\namazon-ebs: INFO [04-10|19:01:59.289] Imported new chain segment blocks=1 txs=11 mgas=0.924 elapsed=13.237ms mgasps=69.832 number=4186236 hash=ec5fb5…d187d7 dirty=502.75MiB\r\namazon-ebs: INFO [04-10|19:02:14.264] Imported new chain segment blocks=1 txs=12 mgas=3.594 elapsed=15.996ms mgasps=224.661 number=4186237 hash=2b82db…e47acb dirty=502.80MiB\r\namazon-ebs: INFO [04-10|19:02:29.425] Imported new chain segment blocks=1 txs=6 mgas=1.166 elapsed=16.370ms mgasps=71.219 number=4186238 hash=884c85…f06c31 dirty=502.80MiB\r\namazon-ebs: INFO [04-10|19:02:44.335] Imported new chain segment blocks=1 txs=7 mgas=1.147 elapsed=15.922ms mgasps=72.019 number=4186239 hash=79b5f2…7d9f3a dirty=502.82MiB\r\namazon-ebs: INFO [04-10|19:02:59.434] Imported new chain segment blocks=1 txs=13 mgas=1.323 elapsed=24.282ms mgasps=54.495 number=4186240 hash=c5ea58…5aff4b dirty=502.84MiB\r\namazon-ebs: INFO [04-10|19:02:59.608] Imported new chain segment blocks=1 txs=13 mgas=1.323 elapsed=21.259ms mgasps=62.245 number=4186240 hash=a6b059…2ace6f dirty=502.85MiB\r\namazon-ebs: Etherscan: 4186240\r\namazon-ebs: Geth: 4186240\r\namazon-ebs: Geth is synced\r\namazon-ebs: INFO [04-10|19:03:10.390] Got interrupt, shutting down...\r\namazon-ebs: INFO [04-10|19:03:10.392] WebSocket endpoint closed url=ws://0.0.0.0:8546\r\namazon-ebs: INFO [04-10|19:03:10.394] HTTP endpoint closed url=http://0.0.0.0:8545\r\namazon-ebs: INFO [04-10|19:03:10.395] IPC endpoint closed url=/geth/.ethereum/geth.ipc\r\namazon-ebs: INFO [04-10|19:03:10.396] Writing cached state to disk block=4186240 hash=c5ea58…5aff4b root=b8646a…a8bd19\r\namazon-ebs: geth-sync\r\namazon-ebs: geth-sync\r\n==> amazon-ebs: Stopping the source instance...\r\namazon-ebs: Stopping instance, attempt 1\r\n==> amazon-ebs: Waiting for the instance to stop...\r\n```\r\n\r\n#### Steps to reproduce the behaviour\r\n\r\n1. Sync a Geth instance to the latest height then stop it\r\n2. Wait for a few hours\r\n3. Re-sync that instance to the latest height\r\n4. Create a snapshot of the geth folder\r\n5. Create a new Geth instance from the snapshot\r\n",
  "closed_by": {
    "login": "karalabe",
    "id": 129561,
    "node_id": "MDQ6VXNlcjEyOTU2MQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/karalabe",
    "html_url": "https://github.com/karalabe",
    "followers_url": "https://api.github.com/users/karalabe/followers",
    "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
    "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
    "organizations_url": "https://api.github.com/users/karalabe/orgs",
    "repos_url": "https://api.github.com/users/karalabe/repos",
    "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
    "received_events_url": "https://api.github.com/users/karalabe/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19447/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19447/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/498981090",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/19447#issuecomment-498981090",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19447",
    "id": 498981090,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ5ODk4MTA5MA==",
    "user": {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-06-05T08:03:11Z",
    "updated_at": "2019-06-05T08:03:11Z",
    "author_association": "MEMBER",
    "body": "Is this running via docker by any chance? Docker by default uses a timeout of `10s`, which is insufficient for geth to properly close. I recommend using `60s` instead ` docker stop --timeout 60 geth`",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/498981090/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/499833382",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/19447#issuecomment-499833382",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19447",
    "id": 499833382,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ5OTgzMzM4Mg==",
    "user": {
      "login": "adamschmideg",
      "id": 208822,
      "node_id": "MDQ6VXNlcjIwODgyMg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/208822?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/adamschmideg",
      "html_url": "https://github.com/adamschmideg",
      "followers_url": "https://api.github.com/users/adamschmideg/followers",
      "following_url": "https://api.github.com/users/adamschmideg/following{/other_user}",
      "gists_url": "https://api.github.com/users/adamschmideg/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/adamschmideg/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/adamschmideg/subscriptions",
      "organizations_url": "https://api.github.com/users/adamschmideg/orgs",
      "repos_url": "https://api.github.com/users/adamschmideg/repos",
      "events_url": "https://api.github.com/users/adamschmideg/events{/privacy}",
      "received_events_url": "https://api.github.com/users/adamschmideg/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-06-07T10:16:03Z",
    "updated_at": "2019-06-07T10:16:03Z",
    "author_association": "MEMBER",
    "body": "I wonder if it's documented how to run geth via docker.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/499833382/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/500752123",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/19447#issuecomment-500752123",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19447",
    "id": 500752123,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUwMDc1MjEyMw==",
    "user": {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-06-11T08:57:58Z",
    "updated_at": "2019-06-11T08:57:58Z",
    "author_association": "MEMBER",
    "body": "The last lines of the geth logs are:\r\n\r\n```\r\namazon-ebs: INFO [04-10|19:03:10.395] IPC endpoint closed url=/geth/.ethereum/geth.ipc\r\namazon-ebs: INFO [04-10|19:03:10.396] Writing cached state to disk block=4186240 hash=c5ea58…5aff4b root=b8646a…a8bd19\r\n```\r\n\r\nThis should be followed by a notice that the state was successfully written. Since it isn't, this was not a clean shutdown",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/500752123/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
