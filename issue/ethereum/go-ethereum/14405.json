{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/14405",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/14405/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/14405/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/14405/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/14405",
  "id": 225689359,
  "node_id": "MDU6SXNzdWUyMjU2ODkzNTk=",
  "number": 14405,
  "title": "Transactions not added to the pool when making repeated calls to sendRawTransaction from the same account",
  "user": {
    "login": "fabio-muramatsu",
    "id": 14302074,
    "node_id": "MDQ6VXNlcjE0MzAyMDc0",
    "avatar_url": "https://avatars.githubusercontent.com/u/14302074?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/fabio-muramatsu",
    "html_url": "https://github.com/fabio-muramatsu",
    "followers_url": "https://api.github.com/users/fabio-muramatsu/followers",
    "following_url": "https://api.github.com/users/fabio-muramatsu/following{/other_user}",
    "gists_url": "https://api.github.com/users/fabio-muramatsu/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/fabio-muramatsu/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/fabio-muramatsu/subscriptions",
    "organizations_url": "https://api.github.com/users/fabio-muramatsu/orgs",
    "repos_url": "https://api.github.com/users/fabio-muramatsu/repos",
    "events_url": "https://api.github.com/users/fabio-muramatsu/events{/privacy}",
    "received_events_url": "https://api.github.com/users/fabio-muramatsu/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 6,
  "created_at": "2017-05-02T13:07:31Z",
  "updated_at": "2017-05-30T15:50:56Z",
  "closed_at": "2017-05-03T09:28:36Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "#### System information\r\n\r\nGeth version: 1.6.0-stable\r\nOS & Version: Arch Linux\r\n\r\n#### Issue description\r\n\r\nI'm sending multiple transactions using `sendRawTransaction` calls asynchronously, but some of them seem to be dropped by geth and are not added to the transaction pool. I thought my issue was related to #14375, but in my tests, I define the transaction nonces manually before sending them to geth.\r\n\r\n#### Expected behaviour\r\n\r\nAll transactions are received by geth and added to the transaction pool as pending transactions.\r\n\r\n#### Actual behaviour\r\n\r\nAll transactions are received by geth (they are logged in geth's console), but some of them are not added to the transaction pool. No error messages are displayed.\r\n\r\n#### Steps to reproduce the behaviour\r\n\r\nI've uploaded sample scripts in [this repository](https://github.com/fabio-muramatsu/geth-issue-demo).\r\n",
  "closed_by": {
    "login": "holiman",
    "id": 142290,
    "node_id": "MDQ6VXNlcjE0MjI5MA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/holiman",
    "html_url": "https://github.com/holiman",
    "followers_url": "https://api.github.com/users/holiman/followers",
    "following_url": "https://api.github.com/users/holiman/following{/other_user}",
    "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
    "organizations_url": "https://api.github.com/users/holiman/orgs",
    "repos_url": "https://api.github.com/users/holiman/repos",
    "events_url": "https://api.github.com/users/holiman/events{/privacy}",
    "received_events_url": "https://api.github.com/users/holiman/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/14405/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/14405/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/298863029",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/14405#issuecomment-298863029",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/14405",
    "id": 298863029,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI5ODg2MzAyOQ==",
    "user": {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-05-03T09:28:36Z",
    "updated_at": "2017-05-03T09:28:36Z",
    "author_association": "MEMBER",
    "body": "I experimented a bit with this, by running it `sync`, and adding the transactions in reverse, starting at `nonce=100`. After sending _all_ except the `0`: this is the result: \r\n\r\n```\r\n> txpool.status\r\n{\r\n  pending: 0,\r\n  queued: 64\r\n}\r\n```\r\nSo apparently, it caps the `queued` at 64. \r\nAdding the final one, results in all of them being shoved over to `pending`: \r\n\r\n```\r\n> txpool.status\r\n{\r\n  pending: 65,\r\n  queued: 0\r\n}\r\n```\r\n\r\nAnd [indeed](https://github.com/ethereum/go-ethereum/blob/master/core/tx_pool.go#L52): \r\n\r\n```\r\n\tmaxQueuedPerAccount  = uint64(64)    // Max limit of queued transactions per address\r\n``` \r\n\r\nSo what's happening is that since you're throwing all txs in no particular order, most of them will wind up in `queued` instead of pending. (They only get to pending if they're includable: no nonce-gaps allowed in pending, whereas they're allowed in `queued`). \r\n\r\nAnd queued will start evicting the higher-nonces transactions after there's already 64 of them in there. \r\n\r\nSo it's basically expected behaviour. In this case, I can't see any performance gain in sending async over sync (even if we 'fix' this isuse, you're just shuffling work from the js-side over to the geth-side). Transactions are inherently sequential, what you can benefit from is paralellising signing.\r\n\r\nHowever, if you really want to use this approach, you need to batch it in sizes below `64`. I tested a few times running `async` with 50 instead of 100 transactions, and the result was that no transactions were lost. ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/298863029/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/298942940",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/14405#issuecomment-298942940",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/14405",
    "id": 298942940,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI5ODk0Mjk0MA==",
    "user": {
      "login": "fabio-muramatsu",
      "id": 14302074,
      "node_id": "MDQ6VXNlcjE0MzAyMDc0",
      "avatar_url": "https://avatars.githubusercontent.com/u/14302074?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fabio-muramatsu",
      "html_url": "https://github.com/fabio-muramatsu",
      "followers_url": "https://api.github.com/users/fabio-muramatsu/followers",
      "following_url": "https://api.github.com/users/fabio-muramatsu/following{/other_user}",
      "gists_url": "https://api.github.com/users/fabio-muramatsu/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fabio-muramatsu/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fabio-muramatsu/subscriptions",
      "organizations_url": "https://api.github.com/users/fabio-muramatsu/orgs",
      "repos_url": "https://api.github.com/users/fabio-muramatsu/repos",
      "events_url": "https://api.github.com/users/fabio-muramatsu/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fabio-muramatsu/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-05-03T15:17:30Z",
    "updated_at": "2017-05-03T15:25:28Z",
    "author_association": "NONE",
    "body": "Thank you for your response. Actually, I was using asynchronous calls because, at least using web3js in Node.js, the rate at which geth receives transactions is much higher than the synchronous version. Maybe the overhead in waiting for the RPC response before making the next call may explain this.\r\n\r\nNonetheless, I was making quick tests here and found another weird behavior here. Could you take a look into this to see if I'm making a mistake? If it is a bug, I can open a new issue here. The problem is very simple: I sent 50 transactions asynchronously to geth using `sendRawTransaction`, and all of them were added to the transaction pool, as expected. However, calling `getTransactionCount` using the `pending` argument returns an arbitrary value.\r\n\r\n```\r\n> txpool.status\r\n{\r\n  pending: 50,\r\n  queued: 0\r\n}\r\n> Object.keys(txpool.content.pending[\"0x722bbc43bb665a5570640b0a56af48364eaba495\"]).length\r\n50\r\n> eth.getTransactionCount(\"0x722bbc43bb665a5570640b0a56af48364eaba495\", \"pending\")\r\n2\r\n> eth.getTransactionCount(\"0x722bbc43bb665a5570640b0a56af48364eaba495\")\r\n0\r\n```\r\n\r\nThis issue does not seem to happen if I send the transactions synchronously. Is this expected behavior? I was trying to call this function to derive the correct nonce for future transactions.\r\n\r\nThank you again for your help.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/298942940/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/298953222",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/14405#issuecomment-298953222",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/14405",
    "id": 298953222,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI5ODk1MzIyMg==",
    "user": {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-05-03T15:51:32Z",
    "updated_at": "2017-05-03T15:53:47Z",
    "author_association": "MEMBER",
    "body": "``` \r\n> txpool.status\r\n{\r\n  pending: 50,\r\n  queued: 0\r\n}\r\n```\r\n`txpool.status` returns the number of entries (in total) in the transaction pools `pending` and `queued`, respectively. `50` is correct. \r\n\r\n```\r\nObject.keys(txpool.content.pending[\"0x722bbc43bb665a5570640b0a56af48364eaba495\"]).length\r\n50\r\n```\r\nAlso correct. \r\n\r\n```\r\n> eth.getTransactionCount(\"0x722bbc43bb665a5570640b0a56af48364eaba495\")\r\n0\r\n```\r\nNow, this can be a cause of confusion. `eth.getTransactionCount` should really be called `getNonce`. This call asks \"what is the nonce for `0x722...`, at the latest block\" . So none of it's transactions are executed in any block yet, it's still at `0`. \r\n\r\n```\r\n> eth.getTransactionCount(\"0x722bbc43bb665a5570640b0a56af48364eaba495\", \"pending\")\r\n2\r\n```\r\nThis is _almost_ the same as above, but the question that we're asking is \"what's the nonce of `0x722...` in the `pending` block\". \r\n\r\nGeth cobbles together a `pending` block, and if you're mining, that's what it's trying to mine. That pending block is updated at certain events, e.g. to include uncles or new transactions. In this particular case, the `pending` block contains two of your transactions. If you would mine a block, my guess is that the next block after that would contain the other 48 transactions. \r\n\r\nSo, TLDR; there's a difference between the `pending`-pool and the `pending` block. ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/298953222/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/298973457",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/14405#issuecomment-298973457",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/14405",
    "id": 298973457,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI5ODk3MzQ1Nw==",
    "user": {
      "login": "fabio-muramatsu",
      "id": 14302074,
      "node_id": "MDQ6VXNlcjE0MzAyMDc0",
      "avatar_url": "https://avatars.githubusercontent.com/u/14302074?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fabio-muramatsu",
      "html_url": "https://github.com/fabio-muramatsu",
      "followers_url": "https://api.github.com/users/fabio-muramatsu/followers",
      "following_url": "https://api.github.com/users/fabio-muramatsu/following{/other_user}",
      "gists_url": "https://api.github.com/users/fabio-muramatsu/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fabio-muramatsu/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fabio-muramatsu/subscriptions",
      "organizations_url": "https://api.github.com/users/fabio-muramatsu/orgs",
      "repos_url": "https://api.github.com/users/fabio-muramatsu/repos",
      "events_url": "https://api.github.com/users/fabio-muramatsu/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fabio-muramatsu/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-05-03T17:05:16Z",
    "updated_at": "2017-05-03T17:19:23Z",
    "author_association": "NONE",
    "body": "Thank you for the explanation. I thought `getTransactionCount` looked on the transaction pool because of the discussion in [this issue](https://github.com/ethereum/go-ethereum/issues/2880), but now I realized it is still open. Do you know whether this change is still planned? This would be important to determine the nonce to use if there are still pending transactions in the pool, as I can't access txpool through web3js.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/298973457/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/299400784",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/14405#issuecomment-299400784",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/14405",
    "id": 299400784,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI5OTQwMDc4NA==",
    "user": {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-05-05T07:32:34Z",
    "updated_at": "2017-05-05T07:32:34Z",
    "author_association": "MEMBER",
    "body": "I guess we'll have to ping @fjl about that. ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/299400784/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/304922753",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/14405#issuecomment-304922753",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/14405",
    "id": 304922753,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMwNDkyMjc1Mw==",
    "user": {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-05-30T15:50:56Z",
    "updated_at": "2017-05-30T15:50:56Z",
    "author_association": "MEMBER",
    "body": "This issue has been resolved as of https://github.com/ethereum/go-ethereum/pull/14523 . \r\nRunning with `--txpool.accountqueue 200` , here's my status after batching in 101 transactions in the wrong order: \r\n```text\r\n\r\n> txpool.status\r\n{\r\n  pending: 101,\r\n  queued: 0\r\n}\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/304922753/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
