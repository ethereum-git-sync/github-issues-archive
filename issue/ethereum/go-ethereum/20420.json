{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20420",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20420/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20420/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20420/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/20420",
  "id": 531881380,
  "node_id": "MDU6SXNzdWU1MzE4ODEzODA=",
  "number": 20420,
  "title": "rawdb: Race condition in freezer table",
  "user": {
    "login": "MariusVanDerWijden",
    "id": 16664698,
    "node_id": "MDQ6VXNlcjE2NjY0Njk4",
    "avatar_url": "https://avatars.githubusercontent.com/u/16664698?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/MariusVanDerWijden",
    "html_url": "https://github.com/MariusVanDerWijden",
    "followers_url": "https://api.github.com/users/MariusVanDerWijden/followers",
    "following_url": "https://api.github.com/users/MariusVanDerWijden/following{/other_user}",
    "gists_url": "https://api.github.com/users/MariusVanDerWijden/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/MariusVanDerWijden/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/MariusVanDerWijden/subscriptions",
    "organizations_url": "https://api.github.com/users/MariusVanDerWijden/orgs",
    "repos_url": "https://api.github.com/users/MariusVanDerWijden/repos",
    "events_url": "https://api.github.com/users/MariusVanDerWijden/events{/privacy}",
    "received_events_url": "https://api.github.com/users/MariusVanDerWijden/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2019-12-03T10:28:30Z",
  "updated_at": "2020-04-14T15:13:48Z",
  "closed_at": "2020-04-14T15:13:48Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "Hi I noticed a race condition between \r\n`func (t *freezerTable) Retrieve(item uint64) ([]byte, error) {` and \r\n`func (t *freezerTable) Close() error {`\r\nbecause retrieve does not lock the rlock at the beginning. \r\nWe could use the same methodology as in https://github.com/ethereum/go-ethereum/blob/c2d65d34d5c6f27b8d1a52280964023a3eefd66e/core/rawdb/freezer_table.go#L459\r\nHowever I think since close isn't called often we could just not acquire the second lock as it would impact every retrieve calls performance. \r\nIf you guys agree, please put a wontfix label and close the issue!\r\n\r\n<details><summary>Stack trace</summary>\r\n<p>\r\n\r\n```\r\n==================\r\nWARNING: DATA RACE\r\nWrite at 0x00c0005b3420 by goroutine 47:\r\n  github.com/ethereum/go-ethereum/core/rawdb.(*freezerTable).Close()\r\n      /home/asdf/go/src/github.com/ethereum/go-ethereum/core/rawdb/freezer_table.go:402 +0x3ec\r\n  github.com/ethereum/go-ethereum/core/rawdb.(*freezer).Close()\r\n      /home/asdf/go/src/github.com/ethereum/go-ethereum/core/rawdb/freezer.go:131 +0x153\r\n  github.com/ethereum/go-ethereum/core/rawdb.(*freezerdb).Close()\r\n      /home/asdf/go/src/github.com/ethereum/go-ethereum/core/rawdb/database.go:47 +0xc5\r\n  github.com/ethereum/go-ethereum/eth.(*Ethereum).Stop()\r\n      /home/asdf/go/src/github.com/ethereum/go-ethereum/eth/backend.go:561 +0x182\r\n  github.com/ethereum/go-ethereum/node.(*Node).Stop()\r\n      /home/asdf/go/src/github.com/ethereum/go-ethereum/node/node.go:447 +0x307\r\n  github.com/ethereum/go-ethereum/node.(*Node).Close()\r\n      /home/asdf/go/src/github.com/ethereum/go-ethereum/node/node.go:131 +0x50\r\n  github.com/ethereum/go-ethereum/console.(*tester).Close()\r\n      /home/asdf/go/src/github.com/ethereum/go-ethereum/console/console_test.go:155 +0xe5\r\n  github.com/ethereum/go-ethereum/console.TestEvaluate()\r\n      /home/asdf/go/src/github.com/ethereum/go-ethereum/console/console_test.go:197 +0x152\r\n  github.com/syndtr/goleveldb/leveldb/storage.(*fileStorage).List()\r\n      /home/asdf/go/pkg/mod/github.com/syndtr/goleveldb@v1.0.1-0.20190923125748-758128399b1d/leveldb/storage/file_storage.go:458 +0x2c4\r\n  fmt.Fscanf()\r\n      /snap/go/4762/src/fmt/scan.go:143 +0xcf\r\n  github.com/syndtr/goleveldb/leveldb/storage.fsParseName()\r\n      /snap/go/4762/src/fmt/scan.go:114 +0x192\r\n  github.com/syndtr/goleveldb/leveldb/storage.(*fileStorage).List()\r\n      /home/asdf/go/pkg/mod/github.com/syndtr/goleveldb@v1.0.1-0.20190923125748-758128399b1d/leveldb/storage/file_storage.go:458 +0x2c4\r\n  github.com/syndtr/goleveldb/leveldb.(*DB).checkAndCleanFiles()\r\n      /home/asdf/go/pkg/mod/github.com/syndtr/goleveldb@v1.0.1-0.20190923125748-758128399b1d/leveldb/db_util.go:52 +0x2f8\r\n  github.com/syndtr/goleveldb/leveldb.openDB()\r\n      /home/asdf/go/pkg/mod/github.com/syndtr/goleveldb@v1.0.1-0.20190923125748-758128399b1d/leveldb/db.go:136 +0x9f0\r\n  fmt.(*ss).doScanf()\r\n      /snap/go/4762/src/fmt/scan.go:1217 +0x382\r\n  fmt.Fscanf()\r\n      /snap/go/4762/src/fmt/scan.go:143 +0xcf\r\n  github.com/syndtr/goleveldb/leveldb/storage.fsParseName()\r\n      /snap/go/4762/src/fmt/scan.go:114 +0x192\r\n  github.com/syndtr/goleveldb/leveldb/storage.(*fileStorage).List()\r\n      /home/asdf/go/pkg/mod/github.com/syndtr/goleveldb@v1.0.1-0.20190923125748-758128399b1d/leveldb/storage/file_storage.go:458 +0x2c4\r\n  fmt.Fscanf()\r\n      /snap/go/4762/src/fmt/scan.go:143 +0xcf\r\n  github.com/syndtr/goleveldb/leveldb/storage.fsParseName()\r\n      /snap/go/4762/src/fmt/scan.go:114 +0x192\r\n  github.com/syndtr/goleveldb/leveldb/storage.(*fileStorage).List()\r\n      /home/asdf/go/pkg/mod/github.com/syndtr/goleveldb@v1.0.1-0.20190923125748-758128399b1d/leveldb/storage/file_storage.go:458 +0x2c4\r\n  fmt.Fscanf()\r\n      /snap/go/4762/src/fmt/scan.go:143 +0xcf\r\n  github.com/syndtr/goleveldb/leveldb/storage.fsParseName()\r\n      /snap/go/4762/src/fmt/scan.go:114 +0x192\r\n  github.com/syndtr/goleveldb/leveldb/storage.(*fileStorage).List()\r\n      /home/asdf/go/pkg/mod/github.com/syndtr/goleveldb@v1.0.1-0.20190923125748-758128399b1d/leveldb/storage/file_storage.go:458 +0x2c4\r\n  fmt.Fscanf()\r\n      /snap/go/4762/src/fmt/scan.go:143 +0xcf\r\n  github.com/syndtr/goleveldb/leveldb/storage.fsParseName()\r\n      /snap/go/4762/src/fmt/scan.go:114 +0x192\r\n  github.com/syndtr/goleveldb/leveldb/storage.(*fileStorage).List()\r\n      /home/asdf/go/pkg/mod/github.com/syndtr/goleveldb@v1.0.1-0.20190923125748-758128399b1d/leveldb/storage/file_storage.go:458 +0x2c4\r\n  github.com/syndtr/goleveldb/leveldb.(*DB).recoverJournal()\r\n      /home/asdf/go/pkg/mod/github.com/syndtr/goleveldb@v1.0.1-0.20190923125748-758128399b1d/leveldb/db.go:482 +0xc5\r\n  github.com/syndtr/goleveldb/leveldb.openDB()\r\n      /home/asdf/go/pkg/mod/github.com/syndtr/goleveldb@v1.0.1-0.20190923125748-758128399b1d/leveldb/db.go:131 +0x9cc\r\n  github.com/syndtr/goleveldb/leveldb.Open()\r\n      /home/asdf/go/pkg/mod/github.com/syndtr/goleveldb@v1.0.1-0.20190923125748-758128399b1d/leveldb/db.go:203 +0x1d3\r\n  fmt.Fscanf()\r\n      /snap/go/4762/src/fmt/scan.go:143 +0xcf\r\n  github.com/syndtr/goleveldb/leveldb/storage.fsParseName()\r\n      /snap/go/4762/src/fmt/scan.go:114 +0x192\r\n  github.com/syndtr/goleveldb/leveldb/storage.(*fileStorage).List()\r\n      /home/asdf/go/pkg/mod/github.com/syndtr/goleveldb@v1.0.1-0.20190923125748-758128399b1d/leveldb/storage/file_storage.go:458 +0x2c4\r\n  github.com/syndtr/goleveldb/leveldb.(*session).recover.func1()\r\n      /home/asdf/go/pkg/mod/github.com/syndtr/goleveldb@v1.0.1-0.20190923125748-758128399b1d/leveldb/session.go:134 +0xf4\r\n  github.com/syndtr/goleveldb/leveldb.(*session).recover()\r\n      /home/asdf/go/pkg/mod/github.com/syndtr/goleveldb@v1.0.1-0.20190923125748-758128399b1d/leveldb/session.go:142 +0x1938\r\n  github.com/syndtr/goleveldb/leveldb.Open()\r\n      /home/asdf/go/pkg/mod/github.com/syndtr/goleveldb@v1.0.1-0.20190923125748-758128399b1d/leveldb/db.go:189 +0xf8\r\n  github.com/syndtr/goleveldb/leveldb.OpenFile()\r\n      /home/asdf/go/pkg/mod/github.com/syndtr/goleveldb@v1.0.1-0.20190923125748-758128399b1d/leveldb/db.go:225 +0xa5\r\n  github.com/ethereum/go-ethereum/p2p/enode.newPersistentDB()\r\n      /home/asdf/go/src/github.com/ethereum/go-ethereum/p2p/enode/nodedb.go:95 +0xd2\r\n  github.com/ethereum/go-ethereum/p2p/enode.OpenDB()\r\n      /home/asdf/go/src/github.com/ethereum/go-ethereum/p2p/enode/nodedb.go:79 +0x9a\r\n  github.com/ethereum/go-ethereum/p2p.(*Server).setupLocalNode()\r\n      /home/asdf/go/src/github.com/ethereum/go-ethereum/p2p/server.go:498 +0x561\r\n  github.com/ethereum/go-ethereum/p2p.(*Server).Start()\r\n      /home/asdf/go/src/github.com/ethereum/go-ethereum/p2p/server.go:469 +0x744\r\n  github.com/ethereum/go-ethereum/node.(*Node).Start()\r\n      /home/asdf/go/src/github.com/ethereum/go-ethereum/node/node.go:220 +0xeb4\r\n  github.com/syndtr/goleveldb/leveldb/storage.fsParseName()\r\n      /snap/go/4762/src/fmt/scan.go:114 +0x192\r\n  github.com/syndtr/goleveldb/leveldb/storage.(*fileStorage).List()\r\n      /home/asdf/go/pkg/mod/github.com/syndtr/goleveldb@v1.0.1-0.20190923125748-758128399b1d/leveldb/storage/file_storage.go:458 +0x2c4\r\n  fmt.Fscanf()\r\n      /snap/go/4762/src/fmt/scan.go:143 +0xcf\r\n  github.com/syndtr/goleveldb/leveldb/storage.fsParseName()\r\n      /snap/go/4762/src/fmt/scan.go:114 +0x192\r\n  github.com/syndtr/goleveldb/leveldb/storage.(*fileStorage).List()\r\n      /home/asdf/go/pkg/mod/github.com/syndtr/goleveldb@v1.0.1-0.20190923125748-758128399b1d/leveldb/storage/file_storage.go:458 +0x2c4\r\n  github.com/syndtr/goleveldb/leveldb.(*DB).checkAndCleanFiles()\r\n      /home/asdf/go/pkg/mod/github.com/syndtr/goleveldb@v1.0.1-0.20190923125748-758128399b1d/leveldb/db_util.go:52 +0x2f8\r\n  github.com/syndtr/goleveldb/leveldb.openDB()\r\n      /home/asdf/go/pkg/mod/github.com/syndtr/goleveldb@v1.0.1-0.20190923125748-758128399b1d/leveldb/db.go:136 +0x9f0\r\n  fmt.(*ss).doScanf()\r\n      /snap/go/4762/src/fmt/scan.go:1217 +0x382\r\n  fmt.Fscanf()\r\n      /snap/go/4762/src/fmt/scan.go:143 +0xcf\r\n  github.com/syndtr/goleveldb/leveldb/storage.fsParseName()\r\n      /snap/go/4762/src/fmt/scan.go:114 +0x192\r\n  github.com/syndtr/goleveldb/leveldb/storage.(*fileStorage).List()\r\n      /home/asdf/go/pkg/mod/github.com/syndtr/goleveldb@v1.0.1-0.20190923125748-758128399b1d/leveldb/storage/file_storage.go:458 +0x2c4\r\n  fmt.Fscanf()\r\n      /snap/go/4762/src/fmt/scan.go:143 +0xcf\r\n  github.com/syndtr/goleveldb/leveldb/storage.fsParseName()\r\n      /snap/go/4762/src/fmt/scan.go:114 +0x192\r\n  github.com/syndtr/goleveldb/leveldb/storage.(*fileStorage).List()\r\n      /home/asdf/go/pkg/mod/github.com/syndtr/goleveldb@v1.0.1-0.20190923125748-758128399b1d/leveldb/storage/file_storage.go:458 +0x2c4\r\n  fmt.Fscanf()\r\n      /snap/go/4762/src/fmt/scan.go:143 +0xcf\r\n  github.com/syndtr/goleveldb/leveldb/storage.fsParseName()\r\n      /snap/go/4762/src/fmt/scan.go:114 +0x192\r\n  github.com/syndtr/goleveldb/leveldb/storage.(*fileStorage).List()\r\n      /home/asdf/go/pkg/mod/github.com/syndtr/goleveldb@v1.0.1-0.20190923125748-758128399b1d/leveldb/storage/file_storage.go:458 +0x2c4\r\n  fmt.Fscanf()\r\n      /snap/go/4762/src/fmt/scan.go:143 +0xcf\r\n  github.com/syndtr/goleveldb/leveldb/storage.fsParseName()\r\n      /snap/go/4762/src/fmt/scan.go:114 +0x192\r\n  github.com/syndtr/goleveldb/leveldb/storage.(*fileStorage).List()\r\n      /home/asdf/go/pkg/mod/github.com/syndtr/goleveldb@v1.0.1-0.20190923125748-758128399b1d/leveldb/storage/file_storage.go:458 +0x2c4\r\n  github.com/syndtr/goleveldb/leveldb.(*DB).recoverJournal()\r\n      /home/asdf/go/pkg/mod/github.com/syndtr/goleveldb@v1.0.1-0.20190923125748-758128399b1d/leveldb/db.go:482 +0xc5\r\n  github.com/syndtr/goleveldb/leveldb.openDB()\r\n      /home/asdf/go/pkg/mod/github.com/syndtr/goleveldb@v1.0.1-0.20190923125748-758128399b1d/leveldb/db.go:131 +0x9cc\r\n  github.com/syndtr/goleveldb/leveldb.Open()\r\n      /home/asdf/go/pkg/mod/github.com/syndtr/goleveldb@v1.0.1-0.20190923125748-758128399b1d/leveldb/db.go:203 +0x1d3\r\n  fmt.Fscanf()\r\n      /snap/go/4762/src/fmt/scan.go:143 +0xcf\r\n  github.com/syndtr/goleveldb/leveldb/storage.fsParseName()\r\n      /snap/go/4762/src/fmt/scan.go:114 +0x192\r\n  github.com/syndtr/goleveldb/leveldb/storage.(*fileStorage).List()\r\n      /home/asdf/go/pkg/mod/github.com/syndtr/goleveldb@v1.0.1-0.20190923125748-758128399b1d/leveldb/storage/file_storage.go:458 +0x2c4\r\n  github.com/syndtr/goleveldb/leveldb.(*session).recover.func1()\r\n      /home/asdf/go/pkg/mod/github.com/syndtr/goleveldb@v1.0.1-0.20190923125748-758128399b1d/leveldb/session.go:134 +0xf4\r\n  github.com/syndtr/goleveldb/leveldb.(*session).recover()\r\n      /home/asdf/go/pkg/mod/github.com/syndtr/goleveldb@v1.0.1-0.20190923125748-758128399b1d/leveldb/session.go:142 +0x1938\r\n  github.com/syndtr/goleveldb/leveldb.Open()\r\n      /home/asdf/go/pkg/mod/github.com/syndtr/goleveldb@v1.0.1-0.20190923125748-758128399b1d/leveldb/db.go:189 +0xf8\r\n  github.com/syndtr/goleveldb/leveldb.OpenFile()\r\n      /home/asdf/go/pkg/mod/github.com/syndtr/goleveldb@v1.0.1-0.20190923125748-758128399b1d/leveldb/db.go:225 +0xa5\r\n  github.com/ethereum/go-ethereum/ethdb/leveldb.New()\r\n      /home/asdf/go/src/github.com/ethereum/go-ethereum/ethdb/leveldb/leveldb.go:98 +0x3be\r\n  github.com/ethereum/go-ethereum/core/rawdb.NewLevelDBDatabaseWithFreezer()\r\n      /home/asdf/go/src/github.com/ethereum/go-ethereum/core/rawdb/database.go:210 +0x83\r\n  github.com/ethereum/go-ethereum/node.(*ServiceContext).OpenDatabaseWithFreezer()\r\n      /home/asdf/go/src/github.com/ethereum/go-ethereum/node/service.go:68 +0x319\r\n  github.com/ethereum/go-ethereum/eth.New()\r\n      /home/asdf/go/src/github.com/ethereum/go-ethereum/eth/backend.go:134 +0x432\r\n  github.com/ethereum/go-ethereum/console.newTester.func1()\r\n      /home/asdf/go/src/github.com/ethereum/go-ethereum/console/console_test.go:111 +0x4f\r\n  github.com/ethereum/go-ethereum/node.(*Node).Start()\r\n      /home/asdf/go/src/github.com/ethereum/go-ethereum/node/node.go:206 +0x73d\r\n  github.com/ethereum/go-ethereum/console.newTester()\r\n      /home/asdf/go/src/github.com/ethereum/go-ethereum/console/console_test.go:115 +0x503\r\n  github.com/ethereum/go-ethereum/console.TestEvaluate()\r\n      /home/asdf/go/src/github.com/ethereum/go-ethereum/console/console_test.go:190 +0x59\r\n  testing.tRunner()\r\n      /snap/go/4762/src/testing/testing.go:909 +0x199\r\n\r\nPrevious read at 0x00c0005b3420 by goroutine 156:\r\n  github.com/ethereum/go-ethereum/core/rawdb.(*freezerTable).Retrieve()\r\n      /home/asdf/go/src/github.com/ethereum/go-ethereum/core/rawdb/freezer_table.go:545 +0x6e3\r\n  github.com/ethereum/go-ethereum/core/rawdb.(*freezer).Ancient()\r\n      /home/asdf/go/src/github.com/ethereum/go-ethereum/core/rawdb/freezer.go:156 +0xb4\r\n  github.com/ethereum/go-ethereum/core/rawdb.(*freezerdb).Ancient()\r\n      <autogenerated>:1 +0x98\r\n  github.com/ethereum/go-ethereum/core/rawdb.ReadHeaderRLP()\r\n      /home/asdf/go/src/github.com/ethereum/go-ethereum/core/rawdb/accessors_chain.go:184 +0x1a5\r\n  github.com/ethereum/go-ethereum/core/rawdb.ReadHeader()\r\n      /home/asdf/go/src/github.com/ethereum/go-ethereum/core/rawdb/accessors_chain.go:203 +0xa1\r\n  github.com/ethereum/go-ethereum/core/rawdb.ReadBlock()\r\n      /home/asdf/go/src/github.com/ethereum/go-ethereum/core/rawdb/accessors_chain.go:470 +0xa1\r\n  github.com/ethereum/go-ethereum/core.(*BlockChain).GetBlock()\r\n      /home/asdf/go/src/github.com/ethereum/go-ethereum/core/blockchain.go:728 +0x1ac\r\n  github.com/ethereum/go-ethereum/core.(*BlockChain).GetBlocksFromHash()\r\n      /home/asdf/go/src/github.com/ethereum/go-ethereum/core/blockchain.go:781 +0x22a\r\n  github.com/ethereum/go-ethereum/miner.(*worker).makeCurrent()\r\n      /home/asdf/go/src/github.com/ethereum/go-ethereum/miner/worker.go:638 +0x4f1\r\n  github.com/ethereum/go-ethereum/miner.(*worker).commitNewWork()\r\n      /home/asdf/go/src/github.com/ethereum/go-ethereum/miner/worker.go:883 +0x7a8\r\n  github.com/ethereum/go-ethereum/miner.(*worker).mainLoop()\r\n      /home/asdf/go/src/github.com/ethereum/go-ethereum/miner/worker.go:408 +0x1403\r\n\r\nGoroutine 47 (running) created at:\r\n  testing.(*T).Run()\r\n      /snap/go/4762/src/testing/testing.go:960 +0x651\r\n  testing.runTests.func1()\r\n      /snap/go/4762/src/testing/testing.go:1202 +0xa6\r\n  testing.tRunner()\r\n      /snap/go/4762/src/testing/testing.go:909 +0x199\r\n  testing.runTests()\r\n      /snap/go/4762/src/testing/testing.go:1200 +0x521\r\n  testing.(*M).Run()\r\n      /snap/go/4762/src/testing/testing.go:1117 +0x2ff\r\n  main.main()\r\n      _testmain.go:58 +0x223\r\n\r\nGoroutine 156 (finished) created at:\r\n  github.com/ethereum/go-ethereum/miner.newWorker()\r\n      /home/asdf/go/src/github.com/ethereum/go-ethereum/miner/worker.go:216 +0x9e8\r\n  github.com/ethereum/go-ethereum/miner.New()\r\n      /home/asdf/go/src/github.com/ethereum/go-ethereum/miner/miner.go:75 +0xbd\r\n  github.com/ethereum/go-ethereum/eth.New()\r\n      /home/asdf/go/src/github.com/ethereum/go-ethereum/eth/backend.go:213 +0x1719\r\n  github.com/syndtr/goleveldb/leveldb/storage.(*fileStorage).List()\r\n      /home/asdf/go/pkg/mod/github.com/syndtr/goleveldb@v1.0.1-0.20190923125748-758128399b1d/leveldb/storage/file_storage.go:458 +0x2c4\r\n  fmt.Fscanf()\r\n      /snap/go/4762/src/fmt/scan.go:143 +0xcf\r\n  github.com/syndtr/goleveldb/leveldb/storage.fsParseName()\r\n      /snap/go/4762/src/fmt/scan.go:114 +0x192\r\n  github.com/syndtr/goleveldb/leveldb/storage.(*fileStorage).List()\r\n      /home/asdf/go/pkg/mod/github.com/syndtr/goleveldb@v1.0.1-0.20190923125748-758128399b1d/leveldb/storage/file_storage.go:458 +0x2c4\r\n  fmt.Fscanf()\r\n      /snap/go/4762/src/fmt/scan.go:143 +0xcf\r\n  github.com/syndtr/goleveldb/leveldb/storage.fsParseName()\r\n      /snap/go/4762/src/fmt/scan.go:114 +0x192\r\n  github.com/syndtr/goleveldb/leveldb/storage.(*fileStorage).List()\r\n      /home/asdf/go/pkg/mod/github.com/syndtr/goleveldb@v1.0.1-0.20190923125748-758128399b1d/leveldb/storage/file_storage.go:458 +0x2c4\r\n  github.com/syndtr/goleveldb/leveldb.(*DB).checkAndCleanFiles()\r\n      /home/asdf/go/pkg/mod/github.com/syndtr/goleveldb@v1.0.1-0.20190923125748-758128399b1d/leveldb/db_util.go:52 +0x2f8\r\n  github.com/syndtr/goleveldb/leveldb.openDB()\r\n      /home/asdf/go/pkg/mod/github.com/syndtr/goleveldb@v1.0.1-0.20190923125748-758128399b1d/leveldb/db.go:136 +0x9f0\r\n  fmt.(*ss).doScanf()\r\n      /snap/go/4762/src/fmt/scan.go:1217 +0x382\r\n  fmt.Fscanf()\r\n      /snap/go/4762/src/fmt/scan.go:143 +0xcf\r\n  github.com/syndtr/goleveldb/leveldb/storage.fsParseName()\r\n      /snap/go/4762/src/fmt/scan.go:114 +0x192\r\n  github.com/syndtr/goleveldb/leveldb/storage.(*fileStorage).List()\r\n      /home/asdf/go/pkg/mod/github.com/syndtr/goleveldb@v1.0.1-0.20190923125748-758128399b1d/leveldb/storage/file_storage.go:458 +0x2c4\r\n  fmt.Fscanf()\r\n      /snap/go/4762/src/fmt/scan.go:143 +0xcf\r\n  github.com/syndtr/goleveldb/leveldb/storage.fsParseName()\r\n      /snap/go/4762/src/fmt/scan.go:114 +0x192\r\n  github.com/syndtr/goleveldb/leveldb/storage.(*fileStorage).List()\r\n      /home/asdf/go/pkg/mod/github.com/syndtr/goleveldb@v1.0.1-0.20190923125748-758128399b1d/leveldb/storage/file_storage.go:458 +0x2c4\r\n  fmt.Fscanf()\r\n      /snap/go/4762/src/fmt/scan.go:143 +0xcf\r\n  github.com/syndtr/goleveldb/leveldb/storage.fsParseName()\r\n      /snap/go/4762/src/fmt/scan.go:114 +0x192\r\n  github.com/syndtr/goleveldb/leveldb/storage.(*fileStorage).List()\r\n      /home/asdf/go/pkg/mod/github.com/syndtr/goleveldb@v1.0.1-0.20190923125748-758128399b1d/leveldb/storage/file_storage.go:458 +0x2c4\r\n  fmt.Fscanf()\r\n      /snap/go/4762/src/fmt/scan.go:143 +0xcf\r\n  github.com/syndtr/goleveldb/leveldb/storage.fsParseName()\r\n      /snap/go/4762/src/fmt/scan.go:114 +0x192\r\n  github.com/syndtr/goleveldb/leveldb/storage.(*fileStorage).List()\r\n      /home/asdf/go/pkg/mod/github.com/syndtr/goleveldb@v1.0.1-0.20190923125748-758128399b1d/leveldb/storage/file_storage.go:458 +0x2c4\r\n  github.com/syndtr/goleveldb/leveldb.(*DB).recoverJournal()\r\n      /home/asdf/go/pkg/mod/github.com/syndtr/goleveldb@v1.0.1-0.20190923125748-758128399b1d/leveldb/db.go:482 +0xc5\r\n  github.com/syndtr/goleveldb/leveldb.openDB()\r\n      /home/asdf/go/pkg/mod/github.com/syndtr/goleveldb@v1.0.1-0.20190923125748-758128399b1d/leveldb/db.go:131 +0x9cc\r\n  github.com/syndtr/goleveldb/leveldb.Open()\r\n      /home/asdf/go/pkg/mod/github.com/syndtr/goleveldb@v1.0.1-0.20190923125748-758128399b1d/leveldb/db.go:203 +0x1d3\r\n  fmt.Fscanf()\r\n      /snap/go/4762/src/fmt/scan.go:143 +0xcf\r\n  github.com/syndtr/goleveldb/leveldb/storage.fsParseName()\r\n      /snap/go/4762/src/fmt/scan.go:114 +0x192\r\n  github.com/syndtr/goleveldb/leveldb/storage.(*fileStorage).List()\r\n      /home/asdf/go/pkg/mod/github.com/syndtr/goleveldb@v1.0.1-0.20190923125748-758128399b1d/leveldb/storage/file_storage.go:458 +0x2c4\r\n  github.com/syndtr/goleveldb/leveldb.(*session).recover.func1()\r\n      /home/asdf/go/pkg/mod/github.com/syndtr/goleveldb@v1.0.1-0.20190923125748-758128399b1d/leveldb/session.go:134 +0xf4\r\n  github.com/syndtr/goleveldb/leveldb.(*session).recover()\r\n      /home/asdf/go/pkg/mod/github.com/syndtr/goleveldb@v1.0.1-0.20190923125748-758128399b1d/leveldb/session.go:142 +0x1938\r\n  github.com/syndtr/goleveldb/leveldb.Open()\r\n      /home/asdf/go/pkg/mod/github.com/syndtr/goleveldb@v1.0.1-0.20190923125748-758128399b1d/leveldb/db.go:189 +0xf8\r\n  github.com/syndtr/goleveldb/leveldb.OpenFile()\r\n      /home/asdf/go/pkg/mod/github.com/syndtr/goleveldb@v1.0.1-0.20190923125748-758128399b1d/leveldb/db.go:225 +0xa5\r\n  github.com/ethereum/go-ethereum/ethdb/leveldb.New()\r\n      /home/asdf/go/src/github.com/ethereum/go-ethereum/ethdb/leveldb/leveldb.go:98 +0x3be\r\n  github.com/ethereum/go-ethereum/core/rawdb.NewLevelDBDatabaseWithFreezer()\r\n      /home/asdf/go/src/github.com/ethereum/go-ethereum/core/rawdb/database.go:210 +0x83\r\n  github.com/ethereum/go-ethereum/node.(*ServiceContext).OpenDatabaseWithFreezer()\r\n      /home/asdf/go/src/github.com/ethereum/go-ethereum/node/service.go:68 +0x319\r\n  github.com/ethereum/go-ethereum/eth.New()\r\n      /home/asdf/go/src/github.com/ethereum/go-ethereum/eth/backend.go:134 +0x432\r\n  github.com/ethereum/go-ethereum/console.newTester.func1()\r\n      /home/asdf/go/src/github.com/ethereum/go-ethereum/console/console_test.go:111 +0x4f\r\n  github.com/ethereum/go-ethereum/node.(*Node).Start()\r\n      /home/asdf/go/src/github.com/ethereum/go-ethereum/node/node.go:206 +0x73d\r\n  github.com/ethereum/go-ethereum/console.newTester()\r\n      /home/asdf/go/src/github.com/ethereum/go-ethereum/console/console_test.go:115 +0x503\r\n  github.com/ethereum/go-ethereum/console.TestEvaluate()\r\n      /home/asdf/go/src/github.com/ethereum/go-ethereum/console/console_test.go:190 +0x59\r\n  testing.tRunner()\r\n      /snap/go/4762/src/testing/testing.go:909 +0x199\r\n==================\r\n--- FAIL: TestEvaluate (0.69s)\r\n    testing.go:853: race detected during execution of test\r\nFAIL\r\n```\r\n\r\n</p>\r\n</details>\r\n\r\n\r\n\r\n",
  "closed_by": {
    "login": "karalabe",
    "id": 129561,
    "node_id": "MDQ6VXNlcjEyOTU2MQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/karalabe",
    "html_url": "https://github.com/karalabe",
    "followers_url": "https://api.github.com/users/karalabe/followers",
    "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
    "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
    "organizations_url": "https://api.github.com/users/karalabe/orgs",
    "repos_url": "https://api.github.com/users/karalabe/repos",
    "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
    "received_events_url": "https://api.github.com/users/karalabe/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20420/reactions",
    "total_count": 1,
    "+1": 1,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20420/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/601085164",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/20420#issuecomment-601085164",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20420",
    "id": 601085164,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYwMTA4NTE2NA==",
    "user": {
      "login": "mvdan",
      "id": 3576549,
      "node_id": "MDQ6VXNlcjM1NzY1NDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3576549?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mvdan",
      "html_url": "https://github.com/mvdan",
      "followers_url": "https://api.github.com/users/mvdan/followers",
      "following_url": "https://api.github.com/users/mvdan/following{/other_user}",
      "gists_url": "https://api.github.com/users/mvdan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mvdan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mvdan/subscriptions",
      "organizations_url": "https://api.github.com/users/mvdan/orgs",
      "repos_url": "https://api.github.com/users/mvdan/repos",
      "events_url": "https://api.github.com/users/mvdan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mvdan/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-03-19T09:46:43Z",
    "updated_at": "2020-03-19T09:46:43Z",
    "author_association": "NONE",
    "body": "I've encountered the very same issue when using https://godoc.org/github.com/ethereum/go-ethereum/node#Node.Stop on a node that was started earlier via https://godoc.org/github.com/ethereum/go-ethereum/node#Node.Start. The race detector trace looks almost exactly the same, involving `freezerTable.Close`.\r\n\r\n@karalabe would a patch here be welcome? Any tips or thoughts?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/601085164/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/601107755",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/20420#issuecomment-601107755",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20420",
    "id": 601107755,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYwMTEwNzc1NQ==",
    "user": {
      "login": "karalabe",
      "id": 129561,
      "node_id": "MDQ6VXNlcjEyOTU2MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/karalabe",
      "html_url": "https://github.com/karalabe",
      "followers_url": "https://api.github.com/users/karalabe/followers",
      "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
      "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
      "organizations_url": "https://api.github.com/users/karalabe/orgs",
      "repos_url": "https://api.github.com/users/karalabe/repos",
      "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
      "received_events_url": "https://api.github.com/users/karalabe/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-03-19T10:37:19Z",
    "updated_at": "2020-03-19T10:37:19Z",
    "author_association": "MEMBER",
    "body": "@mvdan Patches are always welcome :)\r\n\r\nThe issue definitely is that `head` and `index` are accessed *out-of-lock* in `Retrieve`, which `Close` modifies. I think it's reasonable to move this lock https://github.com/ethereum/go-ethereum/blob/master/core/rawdb/freezer_table.go#L556 up to the head of the function. Just make sure all error paths then properly unlock it.\r\n\r\nWe could try to be even more optimal by doing the atomic checks first and only then checking the `head` and `index` existence, but honestly that seems super overkill. The general case is that we are trying to access existing data so we will realistically (almost) never hit out of bound cases that could avoid the locking.\r\n\r\nJust to make sure I didn't miss anything, cc @holiman ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/601107755/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
