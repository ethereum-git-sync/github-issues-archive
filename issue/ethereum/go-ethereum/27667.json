{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/27667",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/27667/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/27667/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/27667/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/27667",
  "id": 1792909200,
  "node_id": "I_kwDOAOvK985q3Z-Q",
  "number": 27667,
  "title": "Private PoA network sync fails when trying to sync from block zero.",
  "user": {
    "login": "jakub-freebit",
    "id": 49676311,
    "node_id": "MDQ6VXNlcjQ5Njc2MzEx",
    "avatar_url": "https://avatars.githubusercontent.com/u/49676311?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jakub-freebit",
    "html_url": "https://github.com/jakub-freebit",
    "followers_url": "https://api.github.com/users/jakub-freebit/followers",
    "following_url": "https://api.github.com/users/jakub-freebit/following{/other_user}",
    "gists_url": "https://api.github.com/users/jakub-freebit/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jakub-freebit/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jakub-freebit/subscriptions",
    "organizations_url": "https://api.github.com/users/jakub-freebit/orgs",
    "repos_url": "https://api.github.com/users/jakub-freebit/repos",
    "events_url": "https://api.github.com/users/jakub-freebit/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jakub-freebit/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 72233650,
      "node_id": "MDU6TGFiZWw3MjIzMzY1MA==",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/type:bug",
      "name": "type:bug",
      "color": "FF5E5E",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2023-07-07T06:43:28Z",
  "updated_at": "2023-10-17T02:40:30Z",
  "closed_at": null,
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "Please note that I am using a geth fork with a modified Clique consensus, however the code around sync, downloader, etc. is unchanged. The base geth version v1.10.26 I am using is quite old. If required, I will try to rebase to the latest version if this might solve the issue. I will be very grateful for any help or hints on how to solve this issue.\r\n\r\n#### System information\r\n\r\nGeth version: Geth/v1.10.26-stable-f05c9b7d/darwin-amd64/go1.20.3\r\nCL client & version: none (pre-merge private PoA network)\r\nOS & Version: Linux (Ubuntu 20.04.4 LTS) & macOs Monterey 12.6.4 (21G526)\r\n\r\n#### Background\r\n\r\nI am operating three private PoA networks running on a geth fork with a slightly modified Clique consensus.\r\n\r\n1.  Local testnet on my Mac (3 nodes)\r\n2. Testnet (~200 nodes)\r\n3. Mainnet (~3000 nodes)\r\n\r\nRecently I have noticed that new nodes on both Testnet (2) and Mainnet (3) started failing to sync (both full and snap sync) when syncing from block zero.\r\nThe problem does not occur when trying to sync the blockchain data from the local testnet (1).\r\nSyncing up to the head starting from a recent block works OK on all networks.\r\nI exported the blockchain data from both Testnet (2) and Mainnet (3), imported them into a new local testnet (2 nodes) on my Mac and was able to reproduce the problem.\r\n\r\n#### Expected behaviour\r\n\r\nFresh sync (both full and snap) completes successfully.\r\n\r\n#### Actual behaviour\r\n\r\nGeth fails at the beginning of a fresh sync (both full and snap) with the following errors.\r\n\r\nTestnet blockchain data:\r\n```\r\n(...)\r\nDEBUG[07-07|12:44:54.269] Fetching batch of headers                id=ef23378316092d8f conn=trusted-staticdial count=192 fromnum=193   skip=0   reverse=false\r\nTRACE[07-07|12:44:54.270] Skeleton filling not accepted            peer=ef23378316092d8f from=193\r\nDEBUG[07-07|12:44:54.270] Failed to deliver retrieved headers      peer=ef233783         err=\"delivery not accepted\"\r\n(...)\r\nDEBUG[07-07|12:44:54.373] Fetching batch of headers                id=ef23378316092d8f conn=trusted-staticdial count=192 fromnum=6145  skip=0   reverse=false\r\nTRACE[07-07|12:44:54.373] Skeleton filling not accepted            peer=ef23378316092d8f from=6145\r\nDEBUG[07-07|12:44:54.373] Failed to deliver retrieved headers      peer=ef233783         err=\"delivery not accepted\"\r\n(...)\r\nDEBUG[07-07|12:44:54.560] Skeleton fill failed                     err=\"no peers available or all tried for download\"\r\nDEBUG[07-07|12:44:54.560] Skeleton chain invalid                   peer=ef233783         err=\"no peers available or all tried for download\"\r\nDEBUG[07-07|12:44:54.560] Header download terminated               peer=ef233783\r\nDEBUG[07-07|12:44:54.561] Block body download terminated           err=\"syncing canceled (requested)\"\r\nDEBUG[07-07|12:44:54.561] Receipt download terminated              err=\"syncing canceled (requested)\"\r\nDEBUG[07-07|12:44:54.636] Synchronisation terminated               elapsed=381.552ms\r\nWARN [07-07|12:44:54.636] Synchronisation failed, dropping peer    peer=ef23378316092d8f85540b7b17a32d5fa791018ba748ea9e663bab26b2496822 err=\"retrieved hash chain is invalid: no peers available or all tried for download\"\r\n(...)\r\n```\r\n\r\nMainnet blockchain data:\r\n```\r\n(...)\r\nDEBUG[07-07|12:54:16.867] Fetching batch of headers                id=ef23378316092d8f conn=trusted-staticdial count=192 fromnum=193     skip=0   reverse=false\r\nTRACE[07-07|12:54:16.867] Skeleton filling not accepted            peer=ef23378316092d8f from=193\r\nDEBUG[07-07|12:54:16.867] Failed to deliver retrieved headers      peer=ef233783         err=\"delivery not accepted\"\r\n(...)\r\nDEBUG[07-07|12:54:17.123] Skeleton fill failed                     err=\"no peers available or all tried for download\"\r\nDEBUG[07-07|12:54:17.123] Skeleton chain invalid                   peer=ef233783         err=\"no peers available or all tried for download\"\r\nDEBUG[07-07|12:54:17.123] Header download terminated               peer=ef233783\r\nDEBUG[07-07|12:54:17.123] Block body download terminated           err=\"syncing canceled (requested)\"\r\nDEBUG[07-07|12:54:17.123] Receipt download terminated              err=\"syncing canceled (requested)\"\r\nDEBUG[07-07|12:54:17.175] Synchronisation terminated               elapsed=321.873ms\r\nWARN [07-07|12:54:17.175] Synchronisation failed, dropping peer    peer=ef23378316092d8f85540b7b17a32d5fa791018ba748ea9e663bab26b2496822 err=\"retrieved hash chain is invalid: no peers available or all tried for download\"\r\n(...)\r\n```\r\n\r\nLocal testnet blockchain data syncs successfully:\r\n```\r\n(...)\r\nDEBUG[07-07|14:24:18.635] Fetching batch of headers                id=ef23378316092d8f conn=trusted-staticdial count=192 fromnum=193     skip=0   reverse=false\r\nTRACE[07-07|14:24:18.637] Pre-scheduled new headers                peer=ef23378316092d8f count=192 from=193\r\nTRACE[07-07|14:24:18.637] Delivered new batch of headers           peer=ef233783         count=192 accepted=192\r\n(...)\r\nDEBUG[07-07|14:24:18.685] Fetching batch of headers                id=ef23378316092d8f conn=trusted-staticdial count=192 fromnum=6145    skip=0   reverse=false\r\nTRACE[07-07|14:24:18.687] Pre-scheduled new headers                peer=ef23378316092d8f count=192 from=6145\r\nTRACE[07-07|14:24:18.687] Delivered new batch of headers           peer=ef233783         count=192 accepted=192\r\n(...)\r\nDEBUG[07-07|14:28:22.399] Inserting downloaded chain               items=2    firstnum=470,749 firsthash=d9cd1c..128ee4 lastnum=470,750 lasthash=639be6..56b593\r\nDEBUG[07-07|14:28:22.399] No more headers available                peer=ef233783\r\nDEBUG[07-07|14:28:22.400] Header download terminated               peer=ef233783\r\nDEBUG[07-07|14:28:22.400] Block body download terminated           err=nil\r\nDEBUG[07-07|14:28:22.400] Receipt download terminated              err=nil\r\nINFO [07-07|14:28:22.401] Imported new chain segment               blocks=2    txs=0       mgas=0.000    elapsed=1.587ms     mgasps=0.000   number=470,750 hash=639be6..56b593 age=1w3d1h     dirty=218.47KiB\r\nDEBUG[07-07|14:28:22.401] Synchronisation terminated               elapsed=4m3.786s\r\nTRACE[07-07|14:28:22.403] Announced block                          hash=639be6..56b593 recipients=1 duration=2562047h47m16.854s\r\nTRACE[07-07|14:28:22.403] Announced block                          id=ef23378316092d8f conn=trusted-staticdial number=470,750 hash=639be6..56b593\r\n(...)\r\n```\r\n\r\n#### Steps to reproduce the behaviour\r\n\r\nBelow are the steps I follow to reproduce the problem with a two node network on my Mac.\r\n\r\n1. Init the first node (the node that has the full blockchain data)\r\n`geth --datadir ./node1 init genesis.json`\r\n\r\n2. Init the second node (the node that tries to full sync from block zero)\r\n`geth --datadir ./node2 init genesis.json`\r\n\r\n3. Import the blockchain data into the first node from a file\r\n`geth --datadir ./node1 import tnet-blockchain-99498.backup`\r\nThe import completes successfully so I assume this is not a problem of corrupted blockchain data (bad blocks, etc.)\r\n\r\n4. Run the first node\r\n`geth --datadir ./node1 --networkid 116111110106 --syncmode \"full\" --port 30314 --nat \"extip:127.0.0.1\" --authrpc.port \"8602\" --nodiscover --verbosity 3 --vmodule=eth=5,p2p=5,downloader=5`\r\n\r\n5. Run the second node\r\n`geth --datadir ./node2 --networkid 116111110106 --syncmode \"full\" --port 30316 --nat \"extip:127.0.0.1\" --authrpc.port \"8603\"  --nodiscover --verbosity 3 --vmodule=eth=5,p2p=5,downloader=5`\r\n(I am using static-nodes.json/trusted-nodes.json for node discovery)\r\n\r\nIf in step 3 I import the blockchain data from the original local testnet that was running on my Mac, the full sync completes successfully. If instead I import the blockchain data from either the Testnet or Mainnet, the full sync fails at block 193 (and at block 6145 for the Testnet data).\r\n\r\nI found out that I can make the node sync successfully by bootstraping the sync process with some initial blockchain data. If I import the first 6228 Testnet blocks from a file, or the first 280 blocks for Mainnet, into node2 the full sync will complete successfully.\r\n\r\n#### Backtrace\r\n\r\n1. Init the first node (the node that has the full blockchain data)\r\n[step1_init_node1_log.txt](https://github.com/ethereum/go-ethereum/files/11975416/step1_init_node1_log.txt)\r\n\r\n2. Init the second node (the node that tries to full sync from block zero)\r\n[step2_init_node2_log.txt](https://github.com/ethereum/go-ethereum/files/11975412/step2_init_node2_log.txt)\r\n\r\n3. Import the blockchain data into the first node from a file\r\n[step3_import_node1_log.txt](https://github.com/ethereum/go-ethereum/files/11975413/step3_import_node1_log.txt)\r\n\r\n4. Run the first node\r\n[step4_run_node1_log.txt](https://github.com/ethereum/go-ethereum/files/11975414/step4_run_node1_log.txt)\r\n\r\n5. Run the second node: full sync fails\r\n[step5_sync_node2_log.txt](https://github.com/ethereum/go-ethereum/files/11975415/step5_sync_node2_log.txt)\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/27667/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/27667/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1624922653",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/27667#issuecomment-1624922653",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/27667",
    "id": 1624922653,
    "node_id": "IC_kwDOAOvK985g2lod",
    "user": {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-07T07:43:29Z",
    "updated_at": "2023-07-07T07:43:29Z",
    "author_association": "MEMBER",
    "body": "We can't really offer much help with so old code, and particularly not when it's also modified. It is a huge timesink to investigate problems that might already be solved on master.\r\n\r\nI'm a bit surprised that you don't see more reasons why the deliveries were not accepted. Perhaps expand `--vmodule=eth=5,p2p=5,downloader=5` to also include `core` at high verbosity, in case there's an error from core/vm that you are not seeing? ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1624922653/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1625098218",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/27667#issuecomment-1625098218",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/27667",
    "id": 1625098218,
    "node_id": "IC_kwDOAOvK985g3Qfq",
    "user": {
      "login": "jakub-freebit",
      "id": 49676311,
      "node_id": "MDQ6VXNlcjQ5Njc2MzEx",
      "avatar_url": "https://avatars.githubusercontent.com/u/49676311?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jakub-freebit",
      "html_url": "https://github.com/jakub-freebit",
      "followers_url": "https://api.github.com/users/jakub-freebit/followers",
      "following_url": "https://api.github.com/users/jakub-freebit/following{/other_user}",
      "gists_url": "https://api.github.com/users/jakub-freebit/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jakub-freebit/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jakub-freebit/subscriptions",
      "organizations_url": "https://api.github.com/users/jakub-freebit/orgs",
      "repos_url": "https://api.github.com/users/jakub-freebit/repos",
      "events_url": "https://api.github.com/users/jakub-freebit/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jakub-freebit/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-07T09:05:21Z",
    "updated_at": "2023-07-07T09:05:21Z",
    "author_association": "CONTRIBUTOR",
    "body": "Thank you for your reply.\r\nI have added `core=5` to `--vmodule`, and tried `--verbosity 5`. Unfortunately no new errors showed up.\r\nI will start rebasing to a newer version of geth and see if I can reproduce this issue.\r\n\r\n```\r\n(...)\r\nINFO [07-07|17:55:19.094] Block synchronisation started \r\nDEBUG[07-07|17:55:19.095] Synchronising with the network           peer=ef23378316092d8f85540b7b17a32d5fa791018ba748ea9e663bab26b2496822 eth=67 head=1d3db9..8448a7 td=22,503,861 mode=full\r\nDEBUG[07-07|17:55:19.095] Retrieving remote chain head             peer=ef233783\r\nDEBUG[07-07|17:55:19.095] Fetching batch of headers                id=ef23378316092d8f conn=trusted-staticdial count=1   fromhash=1d3db9..8448a7 skip=63 reverse=true\r\nDEBUG[07-07|17:55:19.097] Remote head identified, no pivot         peer=ef233783 number=99498 hash=1d3db9..8448a7\r\nDEBUG[07-07|17:55:19.097] Looking for common ancestor              peer=ef233783 local=0 remote=99498\r\nTRACE[07-07|17:55:19.097] Span searching for common ancestor       peer=ef233783 count=12  from=99321 skip=15\r\nDEBUG[07-07|17:55:19.097] Fetching batch of headers                id=ef23378316092d8f conn=trusted-staticdial count=12  fromnum=99321 skip=15 reverse=false\r\nTRACE[07-07|17:55:19.098] Binary searching for common ancestor     peer=ef233783 start=0 end=99498\r\nDEBUG[07-07|17:55:19.098] Fetching batch of headers                id=ef23378316092d8f conn=trusted-staticdial count=1   fromnum=49749 skip=0  reverse=false\r\nDEBUG[07-07|17:55:19.099] Fetching batch of headers                id=ef23378316092d8f conn=trusted-staticdial count=1   fromnum=24874 skip=0  reverse=false\r\nDEBUG[07-07|17:55:19.099] Fetching batch of headers                id=ef23378316092d8f conn=trusted-staticdial count=1   fromnum=12437 skip=0  reverse=false\r\nDEBUG[07-07|17:55:19.099] Fetching batch of headers                id=ef23378316092d8f conn=trusted-staticdial count=1   fromnum=6218  skip=0  reverse=false\r\nDEBUG[07-07|17:55:19.100] Fetching batch of headers                id=ef23378316092d8f conn=trusted-staticdial count=1   fromnum=3109  skip=0  reverse=false\r\nDEBUG[07-07|17:55:19.100] Fetching batch of headers                id=ef23378316092d8f conn=trusted-staticdial count=1   fromnum=1554  skip=0  reverse=false\r\nDEBUG[07-07|17:55:19.100] Fetching batch of headers                id=ef23378316092d8f conn=trusted-staticdial count=1   fromnum=777   skip=0  reverse=false\r\nDEBUG[07-07|17:55:19.101] Fetching batch of headers                id=ef23378316092d8f conn=trusted-staticdial count=1   fromnum=388   skip=0  reverse=false\r\nDEBUG[07-07|17:55:19.101] Fetching batch of headers                id=ef23378316092d8f conn=trusted-staticdial count=1   fromnum=194   skip=0  reverse=false\r\nDEBUG[07-07|17:55:19.101] Fetching batch of headers                id=ef23378316092d8f conn=trusted-staticdial count=1   fromnum=97    skip=0  reverse=false\r\nDEBUG[07-07|17:55:19.101] Fetching batch of headers                id=ef23378316092d8f conn=trusted-staticdial count=1   fromnum=48    skip=0  reverse=false\r\nDEBUG[07-07|17:55:19.101] Fetching batch of headers                id=ef23378316092d8f conn=trusted-staticdial count=1   fromnum=24    skip=0  reverse=false\r\nDEBUG[07-07|17:55:19.102] Fetching batch of headers                id=ef23378316092d8f conn=trusted-staticdial count=1   fromnum=12    skip=0  reverse=false\r\nDEBUG[07-07|17:55:19.102] Fetching batch of headers                id=ef23378316092d8f conn=trusted-staticdial count=1   fromnum=6     skip=0  reverse=false\r\nDEBUG[07-07|17:55:19.102] Fetching batch of headers                id=ef23378316092d8f conn=trusted-staticdial count=1   fromnum=3     skip=0  reverse=false\r\nDEBUG[07-07|17:55:19.102] Fetching batch of headers                id=ef23378316092d8f conn=trusted-staticdial count=1   fromnum=1     skip=0  reverse=false\r\nDEBUG[07-07|17:55:19.102] Found common ancestor                    peer=ef233783 number=0     hash=000000..000000\r\nDEBUG[07-07|17:55:19.102] Downloading receipts                     origin=1\r\nDEBUG[07-07|17:55:19.102] Directing header downloads               peer=ef233783 origin=1\r\nDEBUG[07-07|17:55:19.102] Downloading block bodies                 origin=1\r\nTRACE[07-07|17:55:19.103] Fetching skeleton headers                peer=ef233783 count=192 from=1\r\nDEBUG[07-07|17:55:19.103] Fetching batch of headers                id=ef23378316092d8f conn=trusted-staticdial count=128 fromnum=192   skip=191 reverse=false\r\nDEBUG[07-07|17:55:19.106] Filling up skeleton                      from=1\r\nTRACE[07-07|17:55:19.107] Requesting new batch of headers          peer=ef233783 from=1\r\nDEBUG[07-07|17:55:19.107] Fetching batch of headers                id=ef23378316092d8f conn=trusted-staticdial count=192 fromnum=1     skip=0   reverse=false\r\nTRACE[07-07|17:55:19.109] Pre-scheduled new headers                peer=ef23378316092d8f count=192 from=1\r\nTRACE[07-07|17:55:19.109] Delivered new batch of headers           peer=ef233783         count=192 accepted=192\r\nTRACE[07-07|17:55:19.110] Requesting new batch of headers          peer=ef233783         from=193\r\nDEBUG[07-07|17:55:19.110] Fetching batch of headers                id=ef23378316092d8f conn=trusted-staticdial count=192 fromnum=193   skip=0   reverse=false\r\nTRACE[07-07|17:55:19.110] Requesting new batch of bodies           peer=ef233783         count=1   from=8\r\nDEBUG[07-07|17:55:19.110] Fetching batch of block bodies           id=ef23378316092d8f conn=trusted-staticdial count=1\r\nINFO [07-07|17:55:19.110] Downloader queue stats                   receiptTasks=0 blockTasks=184 itemSize=321.89B throttle=8192\r\nDEBUG[07-07|17:55:19.110] Inserting downloaded chain               items=7 firstnum=1 firsthash=8d4864..eb9087 lastnum=7 lasthash=11a1a1..78f44e\r\nTRACE[07-07|17:55:19.110] Skeleton filling not accepted            peer=ef23378316092d8f from=193\r\nDEBUG[07-07|17:55:19.110] Failed to deliver retrieved headers      peer=ef233783         err=\"delivery not accepted\"\r\nTRACE[07-07|17:55:19.110] Requesting new batch of headers          peer=ef233783         from=385\r\nDEBUG[07-07|17:55:19.110] Fetching batch of headers                id=ef23378316092d8f conn=trusted-staticdial count=192 fromnum=385   skip=0   reverse=false\r\nTRACE[07-07|17:55:19.110] Delivered new batch of bodies            peer=ef233783         count=1   accepted=1\r\nDEBUG[07-07|17:55:19.111] Inserted new block                       number=1     hash=8d4864..eb9087 uncles=0 txs=0 gas=0 elapsed=\"607.175µs\" root=809a84..ccdfa6\r\nDEBUG[07-07|17:55:19.111] Inserted new block                       number=2     hash=4c89b6..c08b02 uncles=0 txs=0 gas=0 elapsed=\"287.911µs\" root=7aad3f..f94031\r\nTRACE[07-07|17:55:19.111] Requesting new batch of bodies           peer=ef233783         count=128 from=9\r\nDEBUG[07-07|17:55:19.111] Inserted new block                       number=3     hash=051ca6..75c5ca uncles=0 txs=0 gas=0 elapsed=\"261.909µs\" root=f0f8c2..1c8f69\r\nDEBUG[07-07|17:55:19.112] Fetching batch of block bodies           id=ef23378316092d8f conn=trusted-staticdial count=128\r\nDEBUG[07-07|17:55:19.112] Inserted new block                       number=4     hash=d4d00b..dec850 uncles=0 txs=0 gas=0 elapsed=\"277.223µs\" root=257125..85b264\r\nTRACE[07-07|17:55:19.112] Delivered new batch of headers           peer=ef233783         count=192 accepted=192\r\nTRACE[07-07|17:55:19.112] Requesting new batch of headers          peer=ef233783         from=577\r\n(...)\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1625098218/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1765565008",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/27667#issuecomment-1765565008",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/27667",
    "id": 1765565008,
    "node_id": "IC_kwDOAOvK985pPGJQ",
    "user": {
      "login": "jakub-freebit",
      "id": 49676311,
      "node_id": "MDQ6VXNlcjQ5Njc2MzEx",
      "avatar_url": "https://avatars.githubusercontent.com/u/49676311?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jakub-freebit",
      "html_url": "https://github.com/jakub-freebit",
      "followers_url": "https://api.github.com/users/jakub-freebit/followers",
      "following_url": "https://api.github.com/users/jakub-freebit/following{/other_user}",
      "gists_url": "https://api.github.com/users/jakub-freebit/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jakub-freebit/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jakub-freebit/subscriptions",
      "organizations_url": "https://api.github.com/users/jakub-freebit/orgs",
      "repos_url": "https://api.github.com/users/jakub-freebit/repos",
      "events_url": "https://api.github.com/users/jakub-freebit/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jakub-freebit/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-10-17T02:40:30Z",
    "updated_at": "2023-10-17T02:40:30Z",
    "author_association": "CONTRIBUTOR",
    "body": "A quick update on the progress:\r\n- Finished rebasing to v1.11.0 and can still reproduce the problem.\r\n- No new logs appeared that could help me locate the cause.\r\n\r\nI added some logging of my own and found out that the cause for the deliveries not being accepted is that, instead of a batch of 192 headers, only 1 header is downloaded in the batch starting `from=193` (both Mainnet and Testnet) and the batch starting `from=6145` (Testnet only).\r\n\r\nAfter changing the donwloader's `MaxHeaderFetch` param from 192 to 1 (and setting `MaxCount = 1` in [downloader.go:760](https://github.com/ethereum/go-ethereum/blob/18b641b0643fc56d1fe5b90d3c7a5ecbf981add4/eth/downloader/downloader.go#L760), and commenting out the stalling peer check in [downloader.go:1097](https://github.com/ethereum/go-ethereum/blob/18b641b0643fc56d1fe5b90d3c7a5ecbf981add4/eth/downloader/downloader.go#L1097)), I was able to sync successfully on both networks.\r\n\r\nObviously this is not a solution to the problem, merely a clue.\r\nI will try rebasing to v1.11.6 next and continue the investigation.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1765565008/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
