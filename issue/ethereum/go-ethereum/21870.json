{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21870",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21870/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21870/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21870/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/21870",
  "id": 745826235,
  "node_id": "MDU6SXNzdWU3NDU4MjYyMzU=",
  "number": 21870,
  "title": "Cannot close geth, cannot start it again after panic-exit",
  "user": {
    "login": "Maigre",
    "id": 702145,
    "node_id": "MDQ6VXNlcjcwMjE0NQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/702145?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Maigre",
    "html_url": "https://github.com/Maigre",
    "followers_url": "https://api.github.com/users/Maigre/followers",
    "following_url": "https://api.github.com/users/Maigre/following{/other_user}",
    "gists_url": "https://api.github.com/users/Maigre/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Maigre/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Maigre/subscriptions",
    "organizations_url": "https://api.github.com/users/Maigre/orgs",
    "repos_url": "https://api.github.com/users/Maigre/repos",
    "events_url": "https://api.github.com/users/Maigre/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Maigre/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2020-11-18T16:49:05Z",
  "updated_at": "2020-11-20T23:25:30Z",
  "closed_at": "2020-11-19T02:01:21Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "Hi there,\r\n\r\n#### System information\r\n\r\nGeth\r\nVersion: 1.9.24-stable\r\nGit Commit: cc05b050df5f88e80bb26aaf6d2f339c49c2d702\r\nArchitecture: amd64\r\nProtocol Versions: [65 64 63]\r\nGo Version: go1.15.5\r\nOperating System: linux\r\nGOPATH=\r\nGOROOT=go\r\n\r\n#### Expected behaviour\r\n\r\nSyncing (default fast mode)\r\nCTRL-c -> exit\r\nRestart -> resume sync\r\n\r\n#### Actual behaviour\r\n\r\nSyncing (default fast mode)\r\nCTRL-c -> hangs -> have to ctrl-c 10 times to panic-exit\r\nRestart -> Hangs and do not resume sync\r\n\r\n#### Steps to reproduce the behaviour\r\n\r\ngeth --http --datadir=./eth1   -> sync\r\nCTRL-c (x10)                       -> fails to shutdown gracefully \r\ngeth --http --datadir=./eth1   -> hangs\r\n\r\n#### Backtrace\r\n\r\non first ctrl-c:\r\n````\r\nINFO [11-18|16:43:55.913] Imported new state entries               count=2215 elapsed=183.797ms   processed=19043417 pending=45154 trieretry=49  coderetry=0 duplicate=862 unexpected=3871\r\nINFO [11-18|16:43:56.231] Imported new state entries               count=2707 elapsed=258.626ms   processed=19046124 pending=42141 trieretry=56  coderetry=0 duplicate=862 unexpected=3871\r\nINFO [11-18|16:43:56.700] Imported new state entries               count=2178 elapsed=225.179ms   processed=19048302 pending=40720 trieretry=49  coderetry=0 duplicate=862 unexpected=3871\r\nINFO [11-18|16:43:57.197] Imported new state entries               count=1872 elapsed=148.347ms   processed=19050174 pending=41108 trieretry=6   coderetry=0 duplicate=862 unexpected=3871\r\n^CINFO [11-18|16:43:57.329] Got interrupt, shutting down... \r\nINFO [11-18|16:43:57.473] Imported new state entries               count=590  elapsed=22.709ms    processed=19050764 pending=44413 trieretry=122 coderetry=0 duplicate=862 unexpected=3871\r\nINFO [11-18|16:43:57.663] Imported new state entries               count=886  elapsed=103.856ms   processed=19051650 pending=46345 trieretry=21  coderetry=0 duplicate=862 unexpected=3871\r\nINFO [11-18|16:43:57.833] HTTP server stopped                      endpoint=127.0.0.1:8545\r\nINFO [11-18|16:43:57.883] IPC endpoint closed                      url=/media/mgr/data/Ethereum/mainnet/eth1/geth.ipc\r\nWARN [11-18|16:43:57.911] Invalid header encountered               number=59125    hash=\"6bec12…3f3758\" parent=\"727811…729ef7\" err=aborted\r\nWARN [11-18|16:43:57.927] Rewinding blockchain                     target=56148\r\nINFO [11-18|16:43:57.934] Deallocated fast sync bloom              items=19045460 errorrate=0.000\r\nWARN [11-18|16:43:58.005] Truncating freezer table                 database=/media/mgr/data/Ethereum/mainnet/eth1/geth/chaindata/ancient table=hashes items=25641    limit=25279\r\nINFO [11-18|16:43:58.006] Imported new state entries               count=1079 elapsed=80.294ms    processed=19052729 pending=47533 trieretry=1   coderetry=0 duplicate=862 unexpected=3871\r\nWARN [11-18|16:43:58.055] Truncating freezer table                 database=/media/mgr/data/Ethereum/mainnet/eth1/geth/chaindata/ancient table=bodies items=25641    limit=25279\r\nWARN [11-18|16:43:58.108] Truncating freezer table                 database=/media/mgr/data/Ethereum/mainnet/eth1/geth/chaindata/ancient table=receipts items=25641    limit=25279\r\nWARN [11-18|16:43:58.155] Truncating freezer table                 database=/media/mgr/data/Ethereum/mainnet/eth1/geth/chaindata/ancient table=diffs    items=25641    limit=25279\r\nWARN [11-18|16:43:58.208] Truncating freezer table                 database=/media/mgr/data/Ethereum/mainnet/eth1/geth/chaindata/ancient table=headers  items=25641    limit=25279\r\nINFO [11-18|16:43:58.260] Rewind ancient data                      number=25278\r\nINFO [11-18|16:43:58.282] Imported new state entries               count=1017 elapsed=99.168ms    processed=19053746 pending=47107 trieretry=0   coderetry=0 duplicate=862 unexpected=3871\r\nINFO [11-18|16:44:43.160] Loaded most recent local header          number=56148    hash=\"ab466e…4aebeb\" td=58051336767032090 age=5y4mo1w\r\nINFO [11-18|16:44:43.160] Loaded most recent local full block      number=0        hash=\"d4e567…cb8fa3\" td=17179869184       age=51y7mo2w\r\nINFO [11-18|16:44:43.160] Loaded most recent local fast block      number=25278    hash=\"103b90…3b254a\" td=16079323365212412 age=5y4mo2w\r\nINFO [11-18|16:44:43.160] Loaded last fast-sync pivot marker       number=11282546\r\nWARN [11-18|16:44:43.160] Rolled back chain segment                header=59124->56148 fast=25278->25278 block=0->0 reason=aborted\r\nWARN [11-18|16:44:43.161] Synchronisation failed, retrying         err=\"content processing canceled (requested)\"\r\nINFO [11-18|16:44:43.162] Ethereum protocol stopped \r\nINFO [11-18|16:44:43.173] Transaction pool stopped \r\nINFO [11-18|16:44:43.174] Writing clean trie cache to disk         path=/media/mgr/data/Ethereum/mainnet/eth1/geth/triecache threads=4\r\nINFO [11-18|16:44:43.917] Persisted the clean trie cache           path=/media/mgr/data/Ethereum/mainnet/eth1/geth/triecache elapsed=742.681ms\r\nINFO [11-18|16:44:43.917] Blockchain stopped \r\nINFO [11-18|16:44:53.231] Looking for peers                        peercount=0 tried=79 static=0\r\nINFO [11-18|16:45:03.494] Looking for peers                        peercount=0 tried=44 static=0\r\nINFO [11-18|16:45:13.497] Looking for peers                        peercount=0 tried=45 static=0\r\nINFO [11-18|16:45:23.523] Looking for peers                        peercount=0 tried=59 static=0\r\nINFO [11-18|16:45:33.541] Looking for peers                        peercount=0 tried=51 static=0\r\nINFO [11-18|16:45:43.612] Looking for peers                        peercount=0 tried=56 static=0\r\nINFO [11-18|16:45:53.807] Looking for peers                        peercount=0 tried=39 static=0\r\nINFO [11-18|16:46:03.830] Looking for peers                        peercount=0 tried=59 static=0\r\nINFO [11-18|16:46:13.865] Looking for peers                        peercount=0 tried=60 static=0\r\nINFO [11-18|16:46:24.088] Looking for peers                        peercount=0 tried=43 static=0\r\nINFO [11-18|16:46:34.109] Looking for peers                        peercount=0 tried=43 static=0\r\nINFO [11-18|16:46:44.165] Looking for peers                        peercount=0 tried=66 static=0\r\nINFO [11-18|16:46:54.321] Looking for peers                        peercount=0 tried=58 static=0\r\nINFO [11-18|16:47:04.364] Looking for peers                        peercount=0 tried=57 static=0\r\nINFO [11-18|16:47:14.422] Looking for peers                        peercount=0 tried=46 static=0\r\nINFO [11-18|16:47:24.491] Looking for peers                        peercount=0 tried=45 static=0\r\nINFO [11-18|16:47:34.522] Looking for peers                        peercount=0 tried=62 static=0\r\nINFO [11-18|16:47:44.602] Looking for peers                        peercount=0 tried=54 static=0\r\nINFO [11-18|16:47:54.614] Looking for peers                        peercount=0 tried=56 static=0\r\nINFO [11-18|16:48:04.629] Looking for peers                        peercount=0 tried=57 static=0\r\nINFO [11-18|16:48:14.669] Looking for peers                        peercount=0 tried=57 static=0\r\n....\r\n````\r\nthen multiple ctrl-c: \r\n[LOG](https://pastebin.com/kfTDYHJ0)\r\n\r\n\r\nThen on restart :\r\n````\r\nINFO [11-18|16:51:16.968] Starting Geth on Ethereum mainnet... \r\nINFO [11-18|16:51:16.969] Bumping default cache on mainnet         provided=1024 updated=4096\r\nINFO [11-18|16:51:16.972] Maximum peer count                       ETH=50 LES=0 total=50\r\nINFO [11-18|16:51:16.972] Smartcard socket not found, disabling    err=\"stat /run/pcscd/pcscd.comm: no such file or directory\"\r\nINFO [11-18|16:51:17.397] Set global gas cap                       cap=25000000\r\nINFO [11-18|16:51:17.397] Allocated trie memory caches             clean=1023.00MiB dirty=1024.00MiB\r\nINFO [11-18|16:51:17.420] Allocated cache and file handles         database=/media/mgr/data/Ethereum/mainnet/eth1/geth/chaindata cache=2.00GiB handles=524288\r\nINFO [11-18|17:28:12.409] Opened ancient database                  database=/media/mgr/data/Ethereum/mainnet/eth1/geth/chaindata/ancient\r\nFatal: Failed to register the Ethereum service: ancient chain segments already extracted, please set --datadir.ancient to the correct path\r\n````\r\n\r\nAs you can see in the log time it did hang 40 min before logging **Opened ancient database**\r\nDuring this period geth/chaindata/LOG was throwing something like:\r\n[LOG](https://pastebin.com/skm2D7NC)\r\n\r\nAnd then the Fatal exit.\r\nNow when i start again it Fatal-exit directly. \r\n\r\nMy ancient directory is in the proper place, but its size is 30 bytes which is not very big i guess..\r\nIt seems that after the panic exit, and starting back, it emptied the ancient data trying to restore it i guess..\r\n\r\nAny idea ?\r\nThanks !",
  "closed_by": {
    "login": "ligi",
    "id": 111600,
    "node_id": "MDQ6VXNlcjExMTYwMA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/111600?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ligi",
    "html_url": "https://github.com/ligi",
    "followers_url": "https://api.github.com/users/ligi/followers",
    "following_url": "https://api.github.com/users/ligi/following{/other_user}",
    "gists_url": "https://api.github.com/users/ligi/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ligi/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ligi/subscriptions",
    "organizations_url": "https://api.github.com/users/ligi/orgs",
    "repos_url": "https://api.github.com/users/ligi/repos",
    "events_url": "https://api.github.com/users/ligi/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ligi/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21870/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21870/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/729989224",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/21870#issuecomment-729989224",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21870",
    "id": 729989224,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcyOTk4OTIyNA==",
    "user": {
      "login": "Maigre",
      "id": 702145,
      "node_id": "MDQ6VXNlcjcwMjE0NQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/702145?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Maigre",
      "html_url": "https://github.com/Maigre",
      "followers_url": "https://api.github.com/users/Maigre/followers",
      "following_url": "https://api.github.com/users/Maigre/following{/other_user}",
      "gists_url": "https://api.github.com/users/Maigre/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Maigre/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Maigre/subscriptions",
      "organizations_url": "https://api.github.com/users/Maigre/orgs",
      "repos_url": "https://api.github.com/users/Maigre/repos",
      "events_url": "https://api.github.com/users/Maigre/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Maigre/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-11-18T22:11:57Z",
    "updated_at": "2020-11-18T22:11:57Z",
    "author_association": "NONE",
    "body": "Ok it seems that it was related to the use of a relative --datadir path.\r\nI was using a script to **cd** into my working directory and run **geth --datadir=./eth1**\r\nTurned it in absolute path and the problem seems gone now.\r\nFinger crossed :) ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/729989224/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/730075843",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/21870#issuecomment-730075843",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21870",
    "id": 730075843,
    "node_id": "MDEyOklzc3VlQ29tbWVudDczMDA3NTg0Mw==",
    "user": {
      "login": "ligi",
      "id": 111600,
      "node_id": "MDQ6VXNlcjExMTYwMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/111600?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ligi",
      "html_url": "https://github.com/ligi",
      "followers_url": "https://api.github.com/users/ligi/followers",
      "following_url": "https://api.github.com/users/ligi/following{/other_user}",
      "gists_url": "https://api.github.com/users/ligi/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ligi/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ligi/subscriptions",
      "organizations_url": "https://api.github.com/users/ligi/orgs",
      "repos_url": "https://api.github.com/users/ligi/repos",
      "events_url": "https://api.github.com/users/ligi/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ligi/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-11-19T02:01:21Z",
    "updated_at": "2020-11-19T02:01:21Z",
    "author_association": "MEMBER",
    "body": "Great - closing the issue then. Please reopen in case the datadir was not your problem",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/730075843/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/731380184",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/21870#issuecomment-731380184",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/21870",
    "id": 731380184,
    "node_id": "MDEyOklzc3VlQ29tbWVudDczMTM4MDE4NA==",
    "user": {
      "login": "wbt",
      "id": 563406,
      "node_id": "MDQ6VXNlcjU2MzQwNg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/563406?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/wbt",
      "html_url": "https://github.com/wbt",
      "followers_url": "https://api.github.com/users/wbt/followers",
      "following_url": "https://api.github.com/users/wbt/following{/other_user}",
      "gists_url": "https://api.github.com/users/wbt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/wbt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/wbt/subscriptions",
      "organizations_url": "https://api.github.com/users/wbt/orgs",
      "repos_url": "https://api.github.com/users/wbt/repos",
      "events_url": "https://api.github.com/users/wbt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/wbt/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-11-20T20:01:54Z",
    "updated_at": "2020-11-20T23:25:30Z",
    "author_association": "CONTRIBUTOR",
    "body": "I encountered this issue or something quite similar using an absolute path, in geth 1.9.24.  (I have all the same system information as OP.)\r\n\r\nThe dataDir had been copied from a node running geth 1.8; it hung for 9 minutes 10 seconds just before logging \"Opened ancient database\" which I assume was because of the format change.\r\n\r\nLog lines alternated between \"Looking for peers\" and \"Upgrading chain index type=bloombits percentage=0\" with a few more of the former; then after 9 of the latter those stopped completely and it was just \"looking for peers\" every 10 seconds or so. \r\n\r\nThe repeating \"Looking for peers\" every 10 seconds or so **continued for minutes beyond** a SIGINT marked with \"Got interrupt, shutting down...\" It even continued after \"Already shutting down, interrupt more to panic. times=9\" \r\n\r\nAfter proceeding through to a panic, it produced a lot of logs which were similar to OP's first set, differing in some details like: \r\n\r\n- the routine identifier and minute **numbers** after \"goroutine\"\r\n- Some hex numbers which look like nonzero absolute memory addresses, e.g. in the 4th line after panic I had a value other than 0xc0000a4dd0\r\n- Different routines were identified in paragraphs 5 and 6 following panic; I had github.com/rjeczalik/notify.(*inotify).send instead of github.com/ethereum/go-ethereum/core.(*txSenderCacher).cache; some of the other routines farther down the list also differed or were at least in a different order\r\n\r\nThe node was started up with syncmode 'full' and datadir specified with an absolute path. --datadir.ancient is/was not specified. \r\n\r\nRestarting that node later on, I did get past \"Opened ancient database\" (with no notable hang before this line); it proceeded to start up networking and alternate log lines between \"Looking for peers\" and \"Upgrading chain index\" with the former being only very slightly more common.  \r\n\r\nAfter an interrupt (logged with \"Got interrupt, shutting down...\") I saw \"Ethereum protocol stopped\" then another \"Looking for peers\" then \"Transaction pool stopped\" then \"Writing clean trie cache to disk\" then \"Persisted the clean trie cache\" then \"Blockchain stopped\" and then many more \"Looking for peers\" lines, about every 10 seconds for minutes before and after \" Already shutting down, interrupt more to panic. times=9.\"\r\n\r\nI think there is some issue with the shutdown not being handled properly.  It should not have continued looking for peers for minutes after catching the interrupt.\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/731380184/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
