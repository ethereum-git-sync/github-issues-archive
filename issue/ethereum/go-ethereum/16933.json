{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/16933",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/16933/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/16933/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/16933/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/16933",
  "id": 330786304,
  "node_id": "MDU6SXNzdWUzMzA3ODYzMDQ=",
  "number": 16933,
  "title": "Geth halts on \"fatal error: concurrent map iteration and map write\"",
  "user": {
    "login": "epheph",
    "id": 361654,
    "node_id": "MDQ6VXNlcjM2MTY1NA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/361654?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/epheph",
    "html_url": "https://github.com/epheph",
    "followers_url": "https://api.github.com/users/epheph/followers",
    "following_url": "https://api.github.com/users/epheph/following{/other_user}",
    "gists_url": "https://api.github.com/users/epheph/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/epheph/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/epheph/subscriptions",
    "organizations_url": "https://api.github.com/users/epheph/orgs",
    "repos_url": "https://api.github.com/users/epheph/repos",
    "events_url": "https://api.github.com/users/epheph/events{/privacy}",
    "received_events_url": "https://api.github.com/users/epheph/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 9,
  "created_at": "2018-06-08T20:04:01Z",
  "updated_at": "2019-01-29T09:55:16Z",
  "closed_at": "2018-11-27T09:47:01Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "#### System information\r\n\r\nGeth version: `1.8.10-stable`\r\nOS & Version: Linux\r\nUsing hub.docker.com provided image\r\n\r\n#### Expected behaviour\r\nDuring our deployment process of \"canned\" (example) data, where we submit many transactions concurrently, I expect the transactions to be mined without halting geth. We submit a few hundred TX, in batches, and use a 1 second block time. None of these transactions are direct contract deployments, but contracts are deployed as a result of these transactions.\r\n\r\n#### Actual behaviour\r\nAbout 50% of the time, judging from my own experience, geth locks up due to \"fatal error: concurrent map iteration and map write\". Running the process over and over again, I can eventually get the deploy to succeed.\r\n\r\n#### Steps to reproduce the behaviour\r\nI have not been able to narrow down exactly the nature of this issue, only that it occurs while processing a large number of transactions. If you'd like to try it yourself, you can try our (docker-based) deployment process.\r\n\r\n1.) Clone https://github.com/AugurProject/augur.js\r\n2.) `npm install`\r\n3.) `npm run docker:build`\r\n\r\nThe image it is based on, `augurproject/dev-node-geth` is just a `FROM ethereum/client-go:v1.8.10` with a custom genesis block and entrypoint.\r\n\r\n#### Backtrace\r\n\r\n````\r\nfatal error: concurrent map iteration and map write\r\n\r\ngoroutine 12736 [running]:\r\nruntime.throw(0xf32989, 0x26)\r\n\t/usr/local/go/src/runtime/panic.go:616 +0x81 fp=0xc4258ffa40 sp=0xc4258ffa20 pc=0x43f681\r\nruntime.mapiternext(0xc4258ffdc8)\r\n\t/usr/local/go/src/runtime/hashmap.go:747 +0x55c fp=0xc4258ffad0 sp=0xc4258ffa40 pc=0x41d33c\r\ngithub.com/ethereum/go-ethereum/core/state.(*StateDB).Copy(0xc429d2a000, 0x0)\r\n\t/go-ethereum/build/_workspace/src/github.com/ethereum/go-ethereum/core/state/statedb.go:486 +0x53a fp=0xc4258ffe98 sp=0xc4258ffad0 pc=0x705c2a\r\ngithub.com/ethereum/go-ethereum/miner.(*worker).pending(0xc42022c9a0, 0x0, 0x0)\r\n\t/go-ethereum/build/_workspace/src/github.com/ethereum/go-ethereum/miner/worker.go:188 +0x125 fp=0xc4258ffed0 sp=0xc4258ffe98 pc=0xa21095\r\ngithub.com/ethereum/go-ethereum/miner.(*Miner).Pending(0xc4200aaf50, 0xc7bddcaeffb, 0xc43940725c)\r\n\t/go-ethereum/build/_workspace/src/github.com/ethereum/go-ethereum/miner/miner.go:167 +0x2f fp=0xc4258ffef8 sp=0xc4258ffed0 pc=0xa1e6bf\r\ngithub.com/ethereum/go-ethereum/eth.(*EthAPIBackend).StateAndHeaderByNumber(0xc420388b80, 0x109bfc0, 0xc420439400, 0xfffffffffffffffe, 0x1ae7c20, 0x20, 0x2a0, 0xa8926)\r\n\t/go-ethereum/build/_workspace/src/github.com/ethereum/go-ethereum/eth/api_backend.go:88 +0x12e fp=0xc4258fff58 sp=0xc4258ffef8 pc=0xa83a1e\r\ngithub.com/ethereum/go-ethereum/internal/ethapi.(*PublicBlockChainAPI).doCall(0xc420388c20, 0x109bfc0, 0xc420439400, 0xd5e16b8e19a43d91, 0xcf767060da4e4f5, 0xeb30540b, 0xc426478f00, 0xb064e, 0x0, 0x0, ...)\r\n\t/go-ethereum/build/_workspace/src/github.com/ethereum/go-ethereum/internal/ethapi/api.go:619 +0x146 fp=0xc425902a90 sp=0xc4258fff58 pc=0xa3a9c6\r\ngithub.com/ethereum/go-ethereum/internal/ethapi.(*PublicBlockChainAPI).EstimateGas.func1(0xb064e, 0x109bf01)\r\n\t/go-ethereum/build/_workspace/src/github.com/ethereum/go-ethereum/internal/ethapi/api.go:710 +0xbe fp=0xc4259053a0 sp=0xc425902a90 pc=0xa43c6e\r\ngithub.com/ethereum/go-ethereum/internal/ethapi.(*PublicBlockChainAPI).EstimateGas(0xc420388c20, 0x109bfc0, 0xc420439400, 0xd5e16b8e19a43d91, 0xcf767060da4e4f5, 0xeb30540b, 0xc426478f00, 0xb064e, 0x0, 0x0, ...)\r\n\t/go-ethereum/build/_workspace/src/github.com/ethereum/go-ethereum/internal/ethapi/api.go:719 +0xe5 fp=0xc425905430 sp=0xc4259053a0 pc=0xa3b3c5\r\nruntime.call256(0xc420626a50, 0xc420450618, 0xc420b26e70, 0x98000000b0)\r\n\t/usr/local/go/src/runtime/asm_amd64.s:576 +0x55 fp=0xc425905540 sp=0xc425905430 pc=0x46c7e5\r\nreflect.Value.call(0xc420206800, 0xc420450618, 0x13, 0xf0ec0d, 0x4, 0xc4234d52c0, 0x3, 0x4, 0x1, 0xc4234d52c0, ...)\r\n\t/usr/local/go/src/reflect/value.go:447 +0x969 fp=0xc425905800 sp=0xc425905540 pc=0x4c9f19\r\nreflect.Value.Call(0xc420206800, 0xc420450618, 0x13, 0xc4234d52c0, 0x3, 0x4, 0x1, 0x1, 0x1)\r\n\t/usr/local/go/src/reflect/value.go:308 +0xa4 fp=0xc425905868 sp=0xc425905800 pc=0x4c9494\r\ngithub.com/ethereum/go-ethereum/rpc.(*Server).handle(0xc4201b7d20, 0x109bfc0, 0xc420439400, 0x10a1200, 0xc4205aa050, 0xc4234d5260, 0xc4205aa110, 0x0, 0xdc07c0)\r\n\t/go-ethereum/build/_workspace/src/github.com/ethereum/go-ethereum/rpc/server.go:312 +0x676 fp=0xc4259059e0 sp=0xc425905868 pc=0x819506\r\ngithub.com/ethereum/go-ethereum/rpc.(*Server).exec(0xc4201b7d20, 0x109bfc0, 0xc420439400, 0x10a1200, 0xc4205aa050, 0xc4234d5260)\r\n\t/go-ethereum/build/_workspace/src/github.com/ethereum/go-ethereum/rpc/server.go:334 +0x1a6 fp=0xc425905a50 sp=0xc4259059e0 pc=0x81a026\r\ngithub.com/ethereum/go-ethereum/rpc.(*Server).serveRequest(0xc4201b7d20, 0x109c080, 0xc4206349f0, 0x10a1200, 0xc4205aa050, 0xf17901, 0x1, 0x0, 0x0)\r\n\t/go-ethereum/build/_workspace/src/github.com/ethereum/go-ethereum/rpc/server.go:195 +0x39c fp=0xc425905b80 sp=0xc425905a50 pc=0x81825c\r\ngithub.com/ethereum/go-ethereum/rpc.(*Server).ServeSingleRequest(0xc4201b7d20, 0x109c080, 0xc4206349f0, 0x10a1200, 0xc4205aa050, 0x1)\r\n\t/go-ethereum/build/_workspace/src/github.com/ethereum/go-ethereum/rpc/server.go:226 +0x65 fp=0xc425905bd8 sp=0xc425905b80 pc=0x818a15\r\ngithub.com/ethereum/go-ethereum/rpc.(*Server).ServeHTTP(0xc4201b7d20, 0x109aac0, 0xc425175ce0, 0xc420244d00)\r\n\t/go-ethereum/build/_workspace/src/github.com/ethereum/go-ethereum/rpc/http.go:194 +0x413 fp=0xc425905c78 sp=0xc425905bd8 pc=0x812923\r\ngithub.com/ethereum/go-ethereum/vendor/github.com/rs/cors.(*Cors).Handler.func1(0x109aac0, 0xc425175ce0, 0xc420244d00)\r\n\t/go-ethereum/build/_workspace/src/github.com/ethereum/go-ethereum/vendor/github.com/rs/cors/cors.go:190 +0xfe fp=0xc425905cd0 sp=0xc425905c78 pc=0x7fee6e\r\nnet/http.HandlerFunc.ServeHTTP(0xc420224d00, 0x109aac0, 0xc425175ce0, 0xc420244d00)\r\n\t/usr/local/go/src/net/http/server.go:1947 +0x44 fp=0xc425905cf8 sp=0xc425905cd0 pc=0x7d3484\r\ngithub.com/ethereum/go-ethereum/rpc.(*virtualHostHandler).ServeHTTP(0xc420224d20, 0x109aac0, 0xc425175ce0, 0xc420244d00)\r\n\t/go-ethereum/build/_workspace/src/github.com/ethereum/go-ethereum/rpc/http.go:258 +0x1c5 fp=0xc425905d58 sp=0xc425905cf8 pc=0x813135\r\nnet/http.serverHandler.ServeHTTP(0xc42021c340, 0x109aac0, 0xc425175ce0, 0xc420244d00)\r\n\t/usr/local/go/src/net/http/server.go:2694 +0xbc fp=0xc425905d88 sp=0xc425905d58 pc=0x7d634c\r\nnet/http.(*conn).serve(0xc427574280, 0x109bfc0, 0xc4299eff40)\r\n\t/usr/local/go/src/net/http/server.go:1830 +0x651 fp=0xc425905fc8 sp=0xc425905d88 pc=0x7d24a1\r\nruntime.goexit()\r\n\t/usr/local/go/src/runtime/asm_amd64.s:2361 +0x1 fp=0xc425905fd0 sp=0xc425905fc8 pc=0x46ede1\r\ncreated by net/http.(*Server).Serve\r\n\t/usr/local/go/src/net/http/server.go:2795 +0x27b\r\n\r\ngoroutine 1 [chan receive, 1 minutes]:\r\ngithub.com/ethereum/go-ethereum/node.(*Node).Wait(0xc420030780)\r\n\t/go-ethereum/build/_workspace/src/github.com/ethereum/go-ethereum/node/node.go:464 +0x7f\r\nmain.geth(0xc42022c160, 0xf9e818, 0xb2d05e00)\r\n\t/go-ethereum/build/_workspace/src/github.com/ethereum/go-ethereum/cmd/geth/main.go:218 +0x51\r\ngithub.com/ethereum/go-ethereum/vendor/gopkg.in/urfave/cli%2ev1.HandleAction(0xd93760, 0xf9fd28, 0xc42022c160, 0xc42022c160, 0xc4204f3f48)\r\n\t/go-ethereum/build/_workspace/src/github.com/ethereum/go-ethereum/vendor/gopkg.in/urfave/cli.v1/app.go:490 +0xc8\r\ngithub.com/ethereum/go-ethereum/vendor/gopkg.in/urfave/cli%2ev1.(*App).Run(0xc420218340, 0xc420030280, 0x25, 0x28, 0x0, 0x0)\r\n\t/go-ethereum/build/_workspace/src/github.com/ethereum/go-ethereum/vendor/gopkg.in/urfave/cli.v1/app.go:264 +0x5ee\r\nmain.main()\r\n\t/go-ethereum/build/_workspace/src/github.com/ethereum/go-ethereum/cmd/geth/main.go:206 +0x55\r\n\r\ngoroutine 6 [chan receive, 1 minutes]:\r\ngithub.com/ethereum/go-ethereum/vendor/github.com/rjeczalik/notify.(*nonrecursiveTree).dispatch(0xc4200801e0, 0xc420080120)\r\n\t/go-ethereum/build/_workspace/src/github.com/ethereum/go-ethereum/vendor/github.com/rjeczalik/notify/tree_nonrecursive.go:36 +0xb6\r\ncreated by github.com/ethereum/go-ethereum/vendor/github.com/rjeczalik/notify.newNonrecursiveTree\r\n\t/go-ethereum/build/_workspace/src/github.com/ethereum/go-ethereum/vendor/github.com/rjeczalik/notify/tree_nonrecursive.go:29 +0xf2\r\n\r\ngoroutine 7 [chan receive, 1 minutes]:\r\ngithub.com/ethereum/go-ethereum/vendor/github.com/rjeczalik/notify.(*nonrecursiveTree).internal(0xc4200801e0, 0xc420080180)\r\n\t/go-ethereum/build/_workspace/src/github.com/ethereum/go-ethereum/vendor/github.com/rjeczalik/notify/tree_nonrecursive.go:81 +0x7b\r\ncreated by github.com/ethereum/go-ethereum/vendor/github.com/rjeczalik/notify.newNonrecursiveTree\r\n\t/go-ethereum/build/_workspace/src/github.com/ethereum/go-ethereum/vendor/github.com/rjeczalik/notify/tree_nonrecursive.go:30 +0x11e\r\n\r\ngoroutine 8 [syscall, 1 minutes]:\r\nos/signal.signal_recv(0x0)\r\n\t/usr/local/go/src/runtime/sigqueue.go:139 +0xa6\r\nos/signal.loop()\r\n\t/usr/local/go/src/os/signal/signal_unix.go:22 +0x22\r\ncreated by os/signal.init.0\r\n\t/usr/local/go/src/os/signal/signal_unix.go:28 +0x41\r\n\r\ngoroutine 14 [select, 1 minutes]:\r\ngithub.com/ethereum/go-ethereum/accounts/keystore.(*watcher).loop(0xc4202d3b60)\r\n\t/go-ethereum/build/_workspace/src/github.com/ethereum/go-ethereum/accounts/keystore/watch.go:94 +0x4a0\r\ncreated by github.com/ethereum/go-ethereum/accounts/keystore.(*watcher).start\r\n\t/go-ethereum/build/_workspace/src/github.com/ethereum/go-ethereum/accounts/keystore/watch.go:52 +0x5d\r\n\r\ngoroutine 37 [syscall, 1 minutes]:\r\nsyscall.Syscall6(0xe8, 0x6, 0xc4204dbf6c, 0x1, 0xffffffffffffffff, 0x0, 0x0, 0x0, 0xd79f40, 0x1087380)\r\n\t/usr/local/go/src/syscall/asm_linux_amd64.s:44 +0x5\r\ngithub.com/ethereum/go-ethereum/vendor/golang.org/x/sys/unix.EpollWait(0x6, 0xc4204dbf6c, 0x1, 0x1, 0xffffffffffffffff, 0x0, 0x0, 0x0)\r\n\t/go-ethereum/build/_workspace/src/github.com/ethereum/go-ethereum/vendor/golang.org/x/sys/unix/zsyscall_linux_amd64.go:1529 +0x7a\r\ngithub.com/ethereum/go-ethereum/vendor/github.com/rjeczalik/notify.(*inotify).loop(0xc4200f2000, 0xc420248000)\r\n\t/go-ethereum/build/_workspace/src/github.com/ethereum/go-ethereum/vendor/github.com/rjeczalik/notify/watcher_inotify.go:194 +0x8b\r\ncreated by github.com/ethereum/go-ethereum/vendor/github.com/rjeczalik/notify.(*inotify).lazyinit\r\n\t/go-ethereum/build/_workspace/src/github.com/ethereum/go-ethereum/vendor/github.com/rjeczalik/notify/watcher_inotify.go:134 +0x128\r\n\r\ngoroutine 38 [chan receive, 1 minutes]:\r\ngithub.com/ethereum/go-ethereum/vendor/github.com/rjeczalik/notify.(*inotify).send(0xc4200f2000, 0xc420248000)\r\n\t/go-ethereum/build/_workspace/src/github.com/ethereum/go-ethereum/vendor/github.com/rjeczalik/notify/watcher_inotify.go:254 +0xae\r\ncreated by github.com/ethereum/go-ethereum/vendor/github.com/rjeczalik/notify.(*inotify).lazyinit\r\n\t/go-ethereum/build/_workspace/src/github.com/ethereum/go-ethereum/vendor/github.com/rjeczalik/notify/watcher_inotify.go:137 +0x17b\r\n\r\ngoroutine 39 [chan receive, 1 minutes]:\r\ngithub.com/ethereum/go-ethereum/vendor/github.com/rjeczalik/notify.(*inotify).send(0xc4200f2000, 0xc420248000)\r\n\t/go-ethereum/build/_workspace/src/github.com/ethereum/go-ethereum/vendor/github.com/rjeczalik/notify/watcher_inotify.go:254 +0xae\r\ncreated by github.com/ethereum/go-ethereum/vendor/github.com/rjeczalik/notify.(*inotify).lazyinit\r\n\t/go-ethereum/build/_workspace/src/github.com/ethereum/go-ethereum/vendor/github.com/rjeczalik/notify/watcher_inotify.go:137 +0x17b\r\n\r\ngoroutine 15 [select]:\r\ngithub.com/ethereum/go-ethereum/accounts/keystore.(*KeyStore).updater(0xc4200be0f0)\r\n\t/go-ethereum/build/_workspace/src/github.com/ethereum/go-ethereum/accounts/keystore/keystore.go:203 +0xf0\r\ncreated by github.com/ethereum/go-ethereum/accounts/keystore.(*KeyStore).Subscribe\r\n\t/go-ethereum/build/_workspace/src/github.com/ethereum/go-ethereum/accounts/keystore/keystore.go:190 +0x122\r\n\r\ngoroutine 16 [sleep]:\r\ntime.Sleep(0x3b9aca00)\r\n\t/usr/local/go/src/runtime/time.go:102 +0x166\r\ngithub.com/ethereum/go-ethereum/accounts/usbwallet.(*Hub).updater(0xc4203a4a00)\r\n\t/go-ethereum/build/_workspace/src/github.com/ethereum/go-ethereum/accounts/usbwallet/hub.go:224 +0x3e\r\ncreated by github.com/ethereum/go-ethereum/accounts/usbwallet.(*Hub).Subscribe\r\n\t/go-ethereum/build/_workspace/src/github.com/ethereum/go-ethereum/accounts/usbwallet/hub.go:213 +0x122\r\n\r\ngoroutine 50 [sleep]:\r\ntime.Sleep(0x3b9aca00)\r\n\t/usr/local/go/src/runtime/time.go:102 +0x166\r\ngithub.com/ethereum/go-ethereum/accounts/usbwallet.(*Hub).updater(0xc4203a4b40)\r\n\t/go-ethereum/build/_workspace/src/github.com/ethereum/go-ethereum/accounts/usbwallet/hub.go:224 +0x3e\r\ncreated by github.com/ethereum/go-ethereum/accounts/usbwallet.(*Hub).Subscribe\r\n\t/go-ethereum/build/_workspace/src/github.com/ethereum/go-ethereum/accounts/usbwallet/hub.go:213 +0x122\r\n\r\ngoroutine 51 [select, 1 minutes]:\r\ngithub.com/ethereum/go-ethereum/accounts.(*Manager).update(0xc42023d110)\r\n\t/go-ethereum/build/_workspace/src/github.com/ethereum/go-ethereum/accounts/manager.go:95 +0x1c6\r\ncreated by github.com/ethereum/go-ethereum/accounts.NewManager\r\n\t/go-ethereum/build/_workspace/src/github.com/ethereum/go-ethereum/accounts/manager.go:68 +0x54c\r\n\r\ngoroutine 52 [select]:\r\ngithub.com/ethereum/go-ethereum/vendor/github.com/syndtr/goleveldb/leveldb/util.(*BufferPool).drain(0xc42035a620)\r\n\t/go-ethereum/build/_workspace/src/github.com/ethereum/go-ethereum/vendor/github.com/syndtr/goleveldb/leveldb/util/buffer_pool.go:206 +0x152\r\ncreated by github.com/ethereum/go-ethereum/vendor/github.com/syndtr/goleveldb/leveldb/util.NewBufferPool\r\n\t/go-ethereum/build/_workspace/src/github.com/ethereum/go-ethereum/vendor/github.com/syndtr/goleveldb/leveldb/util/buffer_pool.go:237 +0x171\r\n\r\ngoroutine 41 [select, 1 minutes]:\r\ngithub.com/ethereum/go-ethereum/vendor/github.com/syndtr/goleveldb/leveldb.(*DB).compactionError(0xc420218820)\r\n\t/go-ethereum/build/_workspace/src/github.com/ethereum/go-ethereum/vendor/github.com/syndtr/goleveldb/leveldb/db_compaction.go:90 +0xff\r\ncreated by github.com/ethereum/go-ethereum/vendor/github.com/syndtr/goleveldb/leveldb.openDB\r\n\t/go-ethereum/build/_workspace/src/github.com/ethereum/go-ethereum/vendor/github.com/syndtr/goleveldb/leveldb/db.go:142 +0x49d\r\n\r\ngoroutine 42 [select]:\r\ngithub.com/ethereum/go-ethereum/vendor/github.com/syndtr/goleveldb/leveldb.(*DB).mpoolDrain(0xc420218820)\r\n\t/go-ethereum/build/_workspace/src/github.com/ethereum/go-ethereum/vendor/github.com/syndtr/goleveldb/leveldb/db_state.go:101 +0x127\r\ncreated by github.com/ethereum/go-ethereum/vendor/github.com/syndtr/goleveldb/leveldb.openDB\r\n\t/go-ethereum/build/_workspace/src/github.com/ethereum/go-ethereum/vendor/github.com/syndtr/goleveldb/leveldb/db.go:143 +0x4bf\r\n\r\ngoroutine 43 [select, 1 minutes]:\r\ngithub.com/ethereum/go-ethereum/vendor/github.com/syndtr/goleveldb/leveldb.(*DB).tCompaction(0xc420218820)\r\n\t/go-ethereum/build/_workspace/src/github.com/ethereum/go-ethereum/vendor/github.com/syndtr/goleveldb/leveldb/db_compaction.go:804 +0x277\r\ncreated by github.com/ethereum/go-ethereum/vendor/github.com/syndtr/goleveldb/leveldb.openDB\r\n\t/go-ethereum/build/_workspace/src/github.com/ethereum/go-ethereum/vendor/github.com/syndtr/goleveldb/leveldb/db.go:149 +0x627\r\n\r\ngoroutine 44 [select, 1 minutes]:\r\ngithub.com/ethereum/go-ethereum/vendor/github.com/syndtr/goleveldb/leveldb.(*DB).mCompaction(0xc420218820)\r\n\t/go-ethereum/build/_workspace/src/github.com/ethereum/go-ethereum/vendor/github.com/syndtr/goleveldb/leveldb/db_compaction.go:751 +0x15d\r\ncreated by github.com/ethereum/go-ethereum/vendor/github.com/syndtr/goleveldb/leveldb.openDB\r\n\t/go-ethereum/build/_workspace/src/github.com/ethereum/go-ethereum/vendor/github.com/syndtr/goleveldb/leveldb/db.go:150 +0x649\r\n````\r\n",
  "closed_by": {
    "login": "holiman",
    "id": 142290,
    "node_id": "MDQ6VXNlcjE0MjI5MA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/holiman",
    "html_url": "https://github.com/holiman",
    "followers_url": "https://api.github.com/users/holiman/followers",
    "following_url": "https://api.github.com/users/holiman/following{/other_user}",
    "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
    "organizations_url": "https://api.github.com/users/holiman/orgs",
    "repos_url": "https://api.github.com/users/holiman/repos",
    "events_url": "https://api.github.com/users/holiman/events{/privacy}",
    "received_events_url": "https://api.github.com/users/holiman/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/16933/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/16933/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/396292942",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/16933#issuecomment-396292942",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/16933",
    "id": 396292942,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM5NjI5Mjk0Mg==",
    "user": {
      "login": "AlexeyAkhunov",
      "id": 13686139,
      "node_id": "MDQ6VXNlcjEzNjg2MTM5",
      "avatar_url": "https://avatars.githubusercontent.com/u/13686139?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AlexeyAkhunov",
      "html_url": "https://github.com/AlexeyAkhunov",
      "followers_url": "https://api.github.com/users/AlexeyAkhunov/followers",
      "following_url": "https://api.github.com/users/AlexeyAkhunov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AlexeyAkhunov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AlexeyAkhunov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AlexeyAkhunov/subscriptions",
      "organizations_url": "https://api.github.com/users/AlexeyAkhunov/orgs",
      "repos_url": "https://api.github.com/users/AlexeyAkhunov/repos",
      "events_url": "https://api.github.com/users/AlexeyAkhunov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AlexeyAkhunov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-06-11T15:54:16Z",
    "updated_at": "2018-06-11T15:54:16Z",
    "author_association": "CONTRIBUTOR",
    "body": "I can see that StateDB.Copy() is happening under the lock, but none other methods use that lock. Ideally, we should have a Read-Write lock to cover all internal data of StateDB",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/396292942/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/396364343",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/16933#issuecomment-396364343",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/16933",
    "id": 396364343,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM5NjM2NDM0Mw==",
    "user": {
      "login": "AlexeyAkhunov",
      "id": 13686139,
      "node_id": "MDQ6VXNlcjEzNjg2MTM5",
      "avatar_url": "https://avatars.githubusercontent.com/u/13686139?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AlexeyAkhunov",
      "html_url": "https://github.com/AlexeyAkhunov",
      "followers_url": "https://api.github.com/users/AlexeyAkhunov/followers",
      "following_url": "https://api.github.com/users/AlexeyAkhunov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AlexeyAkhunov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AlexeyAkhunov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AlexeyAkhunov/subscriptions",
      "organizations_url": "https://api.github.com/users/AlexeyAkhunov/orgs",
      "repos_url": "https://api.github.com/users/AlexeyAkhunov/repos",
      "events_url": "https://api.github.com/users/AlexeyAkhunov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AlexeyAkhunov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-06-11T19:48:54Z",
    "updated_at": "2018-06-11T19:48:54Z",
    "author_association": "CONTRIBUTOR",
    "body": "Ok, I think I figured out where this race is coming from. Here: https://github.com/ethereum/go-ethereum/blob/v1.8.10/miner/worker.go#L499 the \"work\", containing pointer to the \"current.state\" gets pushed to the channel for the agents to process.\r\n\r\nAgent processes it (finds nonce), wraps it into a \"Result\" and puts it into the \"recv\" channel. Here we read it from \"recv\" channel: https://github.com/ethereum/go-ethereum/blob/v1.8.10/miner/worker.go#L301.\r\n\r\nNext, we call \"WriteBlockWithState\" here, passing the same state: https://github.com/ethereum/go-ethereum/blob/v1.8.10/miner/worker.go#L320.\r\n\r\nInside WriteBlockWithState, we call state.Commit here: https://github.com/ethereum/go-ethereum/blob/v1.8.10/core/blockchain.go#L902, which mutates the state. When it happens, we are not holding the \"currentMu\" lock, which means the call to \"pending\" can proceed concurrently",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/396364343/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/396385254",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/16933#issuecomment-396385254",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/16933",
    "id": 396385254,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM5NjM4NTI1NA==",
    "user": {
      "login": "AlexeyAkhunov",
      "id": 13686139,
      "node_id": "MDQ6VXNlcjEzNjg2MTM5",
      "avatar_url": "https://avatars.githubusercontent.com/u/13686139?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AlexeyAkhunov",
      "html_url": "https://github.com/AlexeyAkhunov",
      "followers_url": "https://api.github.com/users/AlexeyAkhunov/followers",
      "following_url": "https://api.github.com/users/AlexeyAkhunov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AlexeyAkhunov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AlexeyAkhunov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AlexeyAkhunov/subscriptions",
      "organizations_url": "https://api.github.com/users/AlexeyAkhunov/orgs",
      "repos_url": "https://api.github.com/users/AlexeyAkhunov/repos",
      "events_url": "https://api.github.com/users/AlexeyAkhunov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AlexeyAkhunov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-06-11T20:59:02Z",
    "updated_at": "2018-06-11T20:59:02Z",
    "author_association": "CONTRIBUTOR",
    "body": "@epheph Could you experiment and surround the line https://github.com/ethereum/go-ethereum/blob/v1.8.10/miner/worker.go#L320 with \"self.currentMu.Lock()\" and \"self.currentMu.UnLock()\", to check if this is really the cause - looks like you can reproduce it quite frequently. If you confirm it, we can make a PR with the fix. Thank you very much!",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/396385254/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/396390295",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/16933#issuecomment-396390295",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/16933",
    "id": 396390295,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM5NjM5MDI5NQ==",
    "user": {
      "login": "epheph",
      "id": 361654,
      "node_id": "MDQ6VXNlcjM2MTY1NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/361654?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/epheph",
      "html_url": "https://github.com/epheph",
      "followers_url": "https://api.github.com/users/epheph/followers",
      "following_url": "https://api.github.com/users/epheph/following{/other_user}",
      "gists_url": "https://api.github.com/users/epheph/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/epheph/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/epheph/subscriptions",
      "organizations_url": "https://api.github.com/users/epheph/orgs",
      "repos_url": "https://api.github.com/users/epheph/repos",
      "events_url": "https://api.github.com/users/epheph/events{/privacy}",
      "received_events_url": "https://api.github.com/users/epheph/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-06-11T21:17:26Z",
    "updated_at": "2018-06-11T21:17:26Z",
    "author_association": "NONE",
    "body": "@AlexeyAkhunov thanks for the research and explanation! I'll give that modification a try",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/396390295/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/396701417",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/16933#issuecomment-396701417",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/16933",
    "id": 396701417,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM5NjcwMTQxNw==",
    "user": {
      "login": "epheph",
      "id": 361654,
      "node_id": "MDQ6VXNlcjM2MTY1NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/361654?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/epheph",
      "html_url": "https://github.com/epheph",
      "followers_url": "https://api.github.com/users/epheph/followers",
      "following_url": "https://api.github.com/users/epheph/following{/other_user}",
      "gists_url": "https://api.github.com/users/epheph/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/epheph/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/epheph/subscriptions",
      "organizations_url": "https://api.github.com/users/epheph/orgs",
      "repos_url": "https://api.github.com/users/epheph/repos",
      "events_url": "https://api.github.com/users/epheph/events{/privacy}",
      "received_events_url": "https://api.github.com/users/epheph/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-06-12T19:12:02Z",
    "updated_at": "2018-06-12T19:12:02Z",
    "author_association": "NONE",
    "body": "@AlexeyAkhunov Alright, i'm 12 deploys in with that new code and haven't received the error, and without it, i received it on the 4th try. It's sporadic, but those results look very promising. The \"Unlock\" method has a lower L.\r\n\r\nThanks for taking a look at this!",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/396701417/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/396705383",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/16933#issuecomment-396705383",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/16933",
    "id": 396705383,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM5NjcwNTM4Mw==",
    "user": {
      "login": "AlexeyAkhunov",
      "id": 13686139,
      "node_id": "MDQ6VXNlcjEzNjg2MTM5",
      "avatar_url": "https://avatars.githubusercontent.com/u/13686139?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AlexeyAkhunov",
      "html_url": "https://github.com/AlexeyAkhunov",
      "followers_url": "https://api.github.com/users/AlexeyAkhunov/followers",
      "following_url": "https://api.github.com/users/AlexeyAkhunov/following{/other_user}",
      "gists_url": "https://api.github.com/users/AlexeyAkhunov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AlexeyAkhunov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AlexeyAkhunov/subscriptions",
      "organizations_url": "https://api.github.com/users/AlexeyAkhunov/orgs",
      "repos_url": "https://api.github.com/users/AlexeyAkhunov/repos",
      "events_url": "https://api.github.com/users/AlexeyAkhunov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AlexeyAkhunov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-06-12T19:26:41Z",
    "updated_at": "2018-06-12T19:26:41Z",
    "author_association": "CONTRIBUTOR",
    "body": "@epheph Thanks for testing - I will prepare the PR in the next couple of days. Yes, \"Unlock\" has lower L :)",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/396705383/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/399078366",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/16933#issuecomment-399078366",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/16933",
    "id": 399078366,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM5OTA3ODM2Ng==",
    "user": {
      "login": "liangzhiyang",
      "id": 13274315,
      "node_id": "MDQ6VXNlcjEzMjc0MzE1",
      "avatar_url": "https://avatars.githubusercontent.com/u/13274315?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/liangzhiyang",
      "html_url": "https://github.com/liangzhiyang",
      "followers_url": "https://api.github.com/users/liangzhiyang/followers",
      "following_url": "https://api.github.com/users/liangzhiyang/following{/other_user}",
      "gists_url": "https://api.github.com/users/liangzhiyang/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/liangzhiyang/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/liangzhiyang/subscriptions",
      "organizations_url": "https://api.github.com/users/liangzhiyang/orgs",
      "repos_url": "https://api.github.com/users/liangzhiyang/repos",
      "events_url": "https://api.github.com/users/liangzhiyang/events{/privacy}",
      "received_events_url": "https://api.github.com/users/liangzhiyang/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-06-21T11:57:37Z",
    "updated_at": "2018-06-21T11:57:58Z",
    "author_association": "NONE",
    "body": "@AlexeyAkhunov \r\nyes  ,you are right ~\r\ni also cause this problem , and   what i think  is the same as you \r\n\r\nO(∩_∩)O~~",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/399078366/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/400974511",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/16933#issuecomment-400974511",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/16933",
    "id": 400974511,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQwMDk3NDUxMQ==",
    "user": {
      "login": "shal",
      "id": 15674738,
      "node_id": "MDQ6VXNlcjE1Njc0NzM4",
      "avatar_url": "https://avatars.githubusercontent.com/u/15674738?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/shal",
      "html_url": "https://github.com/shal",
      "followers_url": "https://api.github.com/users/shal/followers",
      "following_url": "https://api.github.com/users/shal/following{/other_user}",
      "gists_url": "https://api.github.com/users/shal/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/shal/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/shal/subscriptions",
      "organizations_url": "https://api.github.com/users/shal/orgs",
      "repos_url": "https://api.github.com/users/shal/repos",
      "events_url": "https://api.github.com/users/shal/events{/privacy}",
      "received_events_url": "https://api.github.com/users/shal/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-06-28T09:33:35Z",
    "updated_at": "2018-06-28T09:33:35Z",
    "author_association": "NONE",
    "body": "Same here!\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/400974511/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/441994427",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/16933#issuecomment-441994427",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/16933",
    "id": 441994427,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ0MTk5NDQyNw==",
    "user": {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-11-27T09:47:01Z",
    "updated_at": "2018-11-27T09:47:01Z",
    "author_association": "MEMBER",
    "body": "This appears to be closed, according to the merge-history",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/441994427/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
