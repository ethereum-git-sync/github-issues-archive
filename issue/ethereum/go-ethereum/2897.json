{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2897",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2897/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2897/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2897/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/2897",
  "id": 170066374,
  "node_id": "MDU6SXNzdWUxNzAwNjYzNzQ=",
  "number": 2897,
  "title": "pending transactions not applied until after a ChainHeadEvent",
  "user": {
    "login": "cdetrio",
    "id": 997681,
    "node_id": "MDQ6VXNlcjk5NzY4MQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/997681?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/cdetrio",
    "html_url": "https://github.com/cdetrio",
    "followers_url": "https://api.github.com/users/cdetrio/followers",
    "following_url": "https://api.github.com/users/cdetrio/following{/other_user}",
    "gists_url": "https://api.github.com/users/cdetrio/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/cdetrio/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/cdetrio/subscriptions",
    "organizations_url": "https://api.github.com/users/cdetrio/orgs",
    "repos_url": "https://api.github.com/users/cdetrio/repos",
    "events_url": "https://api.github.com/users/cdetrio/events{/privacy}",
    "received_events_url": "https://api.github.com/users/cdetrio/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 856638432,
      "node_id": "MDU6TGFiZWw4NTY2Mzg0MzI=",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/status:inactive",
      "name": "status:inactive",
      "color": "ffffff",
      "default": false,
      "description": null
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2016-08-09T02:09:49Z",
  "updated_at": "2018-04-16T16:37:36Z",
  "closed_at": "2018-04-16T16:37:36Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "#### System information\n\nVersion: 1.5.0-unstable-4f4e1026\n#### Expected behaviour\n\nA pending transaction should be applied immediately, and included in the first block mined after the transaction is received.\n#### Actual behaviour\n\nPending transactions are not applied immediately. After a tx is added to the pending pool, an empty block must be mined first. After an empty block is mined, pending transactions are then included in the second block.\n\nlog from [worker.go with debug prints](https://gist.github.com/cdetrio/20ff720929e1c599ef0aeed8c872ce72):\n\n```\nI0808 20:59:28.111320 internal/ethapi/api.go:1127] Tx(0x9e1155b6553fd108349cec30b0bd004772638718ef1713549245659076b86abe) to: 0x38683b0002f98ad0d8d0f00cc77ebdc48fc0de9e\n### ^^ tx recieved!\nworker.go case core.TxPreEvent. self.mining:\n(int32) 1\nI0808 20:59:55.967272 miner/worker.go:348] ðŸ”¨  Mined block (#9693 / c8915e7d). Wait 5 blocks for confirmation\n### ^^ empty block mined! 27 seconds after tx was received..\nworker.go wait(). just mined a block, calling commitNewWork.\nworker.go case core.ChainHeadEvent. invoking commitNewWork\n### ^^ tx only applied after a new block was mined\nworker.go commitNewWork() called. invoking work.commitTransactions() with transactions:\n(types.Transactions) (len=1 cap=1) {\n (*types.Transaction)(0xc839f7ab40)(\n    TX(9e1155b6553fd108349cec30b0bd004772638718ef1713549245659076b86abe)\n    Contract: false\n    From:     e9a4690662e26219d11315fe8389b40263a9abc3\n    To:       38683b0002f98ad0d8d0f00cc77ebdc48fc0de9e\n    Nonce:    104\n    GasPrice: 20000000000\n    GasLimit  90000\n    Value:    0\n    Data:     0xf8a8fd6d\n    V:        0x1c\n    R:        0xcbf2fb79f27f5d0fcf1e404cc4f0ba5bcab7106a198416c7cdde0d336120aa04\n    S:        0x1a6913b86ecb5b36bd233e386e93463049ddb9efd88b0eebbe0b20f0ab39efa1\n    Hex:      f869688504a817c80083015f909438683b0002f98ad0d8d0f00cc77ebdc48fc0de9e8084f8a8fd6d1ca0cbf2fb79f27f5d0fcf1e404cc4f0ba5bcab7106a198416c7cdde0d336120aa04a01a6913b86ecb5b36bd233e386e93463049ddb9efd88b0eebbe0b20f0ab39efa1\n)\n}\nI0808 20:59:55.968991 miner/worker.go:586] commit new work on block 9694 with 1 txs & 0 uncles. Took 1.66634ms\nworker.go commitNewWork() called. invoking work.commitTransactions() with transactions:\n(types.Transactions) (len=1 cap=1) {\n (*types.Transaction)(0xc839f7ab40)(\n    TX(9e1155b6553fd108349cec30b0bd004772638718ef1713549245659076b86abe)\n    Contract: false\n    From:     e9a4690662e26219d11315fe8389b40263a9abc3\n    To:       38683b0002f98ad0d8d0f00cc77ebdc48fc0de9e\n    Nonce:    104\n    GasPrice: 20000000000\n    GasLimit  90000\n    Value:    0\n    Data:     0xf8a8fd6d\n    V:        0x1c\n    R:        0xcbf2fb79f27f5d0fcf1e404cc4f0ba5bcab7106a198416c7cdde0d336120aa04\n    S:        0x1a6913b86ecb5b36bd233e386e93463049ddb9efd88b0eebbe0b20f0ab39efa1\n    Hex:      f869688504a817c80083015f909438683b0002f98ad0d8d0f00cc77ebdc48fc0de9e8084f8a8fd6d1ca0cbf2fb79f27f5d0fcf1e404cc4f0ba5bcab7106a198416c7cdde0d336120aa04a01a6913b86ecb5b36bd233e386e93463049ddb9efd88b0eebbe0b20f0ab39efa1\n)\n}\nI0808 20:59:55.969940 miner/worker.go:586] commit new work on block 9694 with 1 txs & 0 uncles. Took 913.702Âµs\nworker.go case core.ChainHeadEvent. invoking commitNewWork\nI0808 21:00:02.982379 miner/worker.go:348] ðŸ”¨  Mined block (#9694 / b38d8723). Wait 5 blocks for confirmation\n### ^^ tx included in the second mined block\nworker.go wait(). just mined a block, calling commitNewWork.\n```\n#### Steps to reproduce the behaviour\n\n`./go-ethereum/build/bin/geth --datadir \"./local_testchain_data\" --unlock \"0xe9a4690662e26219d11315fe8389b40263a9abc3\" --password \"pass.conf\" --rpc --rpccorsdomain \"*\" --networkid 1100 -maxpeers 0 --mine --minerthreads 1`\n\nThen send a tx, watch when the tx is included in the pending pool (`eth.pendingTransactions` in the geth console), and that an empty block is mined first, before the pending tx is included in the second block.\n",
  "closed_by": {
    "login": "stale[bot]",
    "id": 26384082,
    "node_id": "MDM6Qm90MjYzODQwODI=",
    "avatar_url": "https://avatars.githubusercontent.com/in/1724?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/stale%5Bbot%5D",
    "html_url": "https://github.com/apps/stale",
    "followers_url": "https://api.github.com/users/stale%5Bbot%5D/followers",
    "following_url": "https://api.github.com/users/stale%5Bbot%5D/following{/other_user}",
    "gists_url": "https://api.github.com/users/stale%5Bbot%5D/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/stale%5Bbot%5D/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/stale%5Bbot%5D/subscriptions",
    "organizations_url": "https://api.github.com/users/stale%5Bbot%5D/orgs",
    "repos_url": "https://api.github.com/users/stale%5Bbot%5D/repos",
    "events_url": "https://api.github.com/users/stale%5Bbot%5D/events{/privacy}",
    "received_events_url": "https://api.github.com/users/stale%5Bbot%5D/received_events",
    "type": "Bot",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2897/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2897/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/238494439",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/2897#issuecomment-238494439",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2897",
    "id": 238494439,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIzODQ5NDQzOQ==",
    "user": {
      "login": "karalabe",
      "id": 129561,
      "node_id": "MDQ6VXNlcjEyOTU2MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/karalabe",
      "html_url": "https://github.com/karalabe",
      "followers_url": "https://api.github.com/users/karalabe/followers",
      "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
      "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
      "organizations_url": "https://api.github.com/users/karalabe/orgs",
      "repos_url": "https://api.github.com/users/karalabe/repos",
      "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
      "received_events_url": "https://api.github.com/users/karalabe/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-08-09T08:58:41Z",
    "updated_at": "2016-08-09T08:59:22Z",
    "author_association": "MEMBER",
    "body": "I think this works as intended.\n\nIf a node is mining it will first collect all the executable transactions, and then start working on the PoW for those (if there are no transactions pending currently, it start working on an empty block's PoW). When already in this hashing phase it does not incorporate new transactions.\n\nIf it were to add every inbound transaction all the time, it would constantly need to stop the PoW hashing, generate a new block and restart the hashing. This would be quite a performance hit, especially if remote miners are connected which would need to poll or be notified of the update.\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/238494439/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/238542857",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/2897#issuecomment-238542857",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2897",
    "id": 238542857,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIzODU0Mjg1Nw==",
    "user": {
      "login": "cdetrio",
      "id": 997681,
      "node_id": "MDQ6VXNlcjk5NzY4MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/997681?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cdetrio",
      "html_url": "https://github.com/cdetrio",
      "followers_url": "https://api.github.com/users/cdetrio/followers",
      "following_url": "https://api.github.com/users/cdetrio/following{/other_user}",
      "gists_url": "https://api.github.com/users/cdetrio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cdetrio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cdetrio/subscriptions",
      "organizations_url": "https://api.github.com/users/cdetrio/orgs",
      "repos_url": "https://api.github.com/users/cdetrio/repos",
      "events_url": "https://api.github.com/users/cdetrio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cdetrio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-08-09T12:51:35Z",
    "updated_at": "2016-08-09T12:51:35Z",
    "author_association": "MEMBER",
    "body": "The PoW hashing should continue in parallel to block updates. If the pending block isn't updated until a new block is found (i.e. a `ChainHeadEvent`), then it adds ~15s of confirmation time to all transactions. If the overhead of pushing an updated block to workers is really a performance factor, then the updates could be throttled to once every X seconds.\n\nIt looks like this might also be the reason for the \"uncle propagation\" problem [described here](https://bitslog.wordpress.com/2016/04/28/uncle-mining-an-ethereum-consensus-protocol-flaw/):\n\n> Propagating a block takes 2 seconds in Ethereum. Therefore miners should be including the uncle immediately in the following block. There must be a problem in Ethereum clients related to uncle propagation) [...]\n\nThat could be explained by `ChainSideEvent` only adding an uncle to the `possibleUncles` list, but not updating the pending block.\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/238542857/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/238703670",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/2897#issuecomment-238703670",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2897",
    "id": 238703670,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIzODcwMzY3MA==",
    "user": {
      "login": "fjl",
      "id": 6915,
      "node_id": "MDQ6VXNlcjY5MTU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6915?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjl",
      "html_url": "https://github.com/fjl",
      "followers_url": "https://api.github.com/users/fjl/followers",
      "following_url": "https://api.github.com/users/fjl/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjl/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjl/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjl/subscriptions",
      "organizations_url": "https://api.github.com/users/fjl/orgs",
      "repos_url": "https://api.github.com/users/fjl/repos",
      "events_url": "https://api.github.com/users/fjl/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjl/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-08-09T21:52:25Z",
    "updated_at": "2016-08-09T21:52:33Z",
    "author_association": "MEMBER",
    "body": "@cdetrio is right, it makes sense to construct the pending block continuously even while mining.\n[This line](https://github.com/ethereum/go-ethereum/blob/5f55d95aea433ef97c48ae927835d833772350de/miner/worker.go#L237) prevents it at the moment, but the change would be bigger than just removing the condition. The worker would need to change to maintain a 'next' Work in addition to the 'current' Work it keeps now.\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/238703670/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/238769056",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/2897#issuecomment-238769056",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2897",
    "id": 238769056,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIzODc2OTA1Ng==",
    "user": {
      "login": "karalabe",
      "id": 129561,
      "node_id": "MDQ6VXNlcjEyOTU2MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/karalabe",
      "html_url": "https://github.com/karalabe",
      "followers_url": "https://api.github.com/users/karalabe/followers",
      "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
      "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
      "organizations_url": "https://api.github.com/users/karalabe/orgs",
      "repos_url": "https://api.github.com/users/karalabe/repos",
      "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
      "received_events_url": "https://api.github.com/users/karalabe/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-08-10T05:25:21Z",
    "updated_at": "2016-08-10T05:25:21Z",
    "author_association": "MEMBER",
    "body": "As far as I understood it, the request was not to maintain the \"next\" work,\nbut to constantly update the \"current\" one. Maybe I misunderstood?\nOn Aug 10, 2016 00:52, \"Felix Lange\" notifications@github.com wrote:\n\n> @cdetrio https://github.com/cdetrio is right, it makes sense to\n> construct the pending block continuously even while mining.\n> This line\n> https://github.com/ethereum/go-ethereum/blob/5f55d95aea433ef97c48ae927835d833772350de/miner/worker.go#L237\n> prevents it\n> at the moment, but the change would be bigger than just removing the\n> condition. The worker would need to change to maintain a 'next' Work in\n> addition to the 'current' Work it keeps now.\n> \n> â€”\n> You are receiving this because you commented.\n> Reply to this email directly, view it on GitHub\n> https://github.com/ethereum/go-ethereum/issues/2897#issuecomment-238703670,\n> or mute the thread\n> https://github.com/notifications/unsubscribe-auth/AAH6GS6DfnQB7WPkNHW8VFYiP1_F-uaeks5qePaogaJpZM4JfplC\n> .\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/238769056/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/370461413",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/2897#issuecomment-370461413",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/2897",
    "id": 370461413,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM3MDQ2MTQxMw==",
    "user": {
      "login": "stale[bot]",
      "id": 26384082,
      "node_id": "MDM6Qm90MjYzODQwODI=",
      "avatar_url": "https://avatars.githubusercontent.com/in/1724?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/stale%5Bbot%5D",
      "html_url": "https://github.com/apps/stale",
      "followers_url": "https://api.github.com/users/stale%5Bbot%5D/followers",
      "following_url": "https://api.github.com/users/stale%5Bbot%5D/following{/other_user}",
      "gists_url": "https://api.github.com/users/stale%5Bbot%5D/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/stale%5Bbot%5D/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/stale%5Bbot%5D/subscriptions",
      "organizations_url": "https://api.github.com/users/stale%5Bbot%5D/orgs",
      "repos_url": "https://api.github.com/users/stale%5Bbot%5D/repos",
      "events_url": "https://api.github.com/users/stale%5Bbot%5D/events{/privacy}",
      "received_events_url": "https://api.github.com/users/stale%5Bbot%5D/received_events",
      "type": "Bot",
      "site_admin": false
    },
    "created_at": "2018-03-05T15:44:31Z",
    "updated_at": "2018-03-05T15:44:31Z",
    "author_association": "NONE",
    "body": "This issue has been automatically marked as stale because it has not had recent activity. It will be closed if no further activity occurs. Thank you for your contributions.\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/370461413/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
