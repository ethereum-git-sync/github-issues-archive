{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/26288",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/26288/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/26288/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/26288/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/26288",
  "id": 1472308542,
  "node_id": "I_kwDOAOvK985XwaU-",
  "number": 26288,
  "title": "`evm.depth` can reach 1025",
  "user": {
    "login": "lightsing",
    "id": 15951701,
    "node_id": "MDQ6VXNlcjE1OTUxNzAx",
    "avatar_url": "https://avatars.githubusercontent.com/u/15951701?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/lightsing",
    "html_url": "https://github.com/lightsing",
    "followers_url": "https://api.github.com/users/lightsing/followers",
    "following_url": "https://api.github.com/users/lightsing/following{/other_user}",
    "gists_url": "https://api.github.com/users/lightsing/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/lightsing/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/lightsing/subscriptions",
    "organizations_url": "https://api.github.com/users/lightsing/orgs",
    "repos_url": "https://api.github.com/users/lightsing/repos",
    "events_url": "https://api.github.com/users/lightsing/events{/privacy}",
    "received_events_url": "https://api.github.com/users/lightsing/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 72233650,
      "node_id": "MDU6TGFiZWw3MjIzMzY1MA==",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/type:bug",
      "name": "type:bug",
      "color": "FF5E5E",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2022-12-02T04:46:47Z",
  "updated_at": "2022-12-02T13:27:53Z",
  "closed_at": "2022-12-02T11:18:49Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "#### System information\r\n\r\nGeth version: N/A\r\nCL client & version: N/A\r\nOS & Version: ALL\r\nCommit hash : c1aa1db69e74c71f251fc83cf7c120b4d0222728\r\n\r\n#### Expected behaviour\r\n\r\nmaxium possible depth is 1024\r\n\r\n#### Actual behaviour\r\n\r\nmaxium possible depth is 1025\r\n\r\n#### Steps to reproduce the behaviour\r\n\r\n```\r\nPUSH32 0x7f602060006000376000600060206000600060003561ffff5a03f10000000000\r\nPUSH1 0x0\r\nMSTORE\r\nPUSH32 0x0060005260206000F30000000000000000000000000000000000000000000000\r\nPUSH1 0x20\r\nMSTORE\r\nPUSH1 0x40\r\nPUSH1 0x0\r\nPUSH1 0x0\r\nCREATE\r\nDUP1\r\nPUSH1 0x40\r\nMSTORE\r\nPUSH1 0x0 // retSize\r\nPUSH1 0x0 // retOffset\r\nPUSH1 0x20 // argSize\r\nPUSH1 0x40 // argOffset\r\nPUSH1 0x0 // Value\r\nDUP6\r\nPUSH2 0xFF\r\nGAS\r\nSUB\r\nCALL\r\n```\r\n\r\n#### Backtrace\r\n\r\n[trace.json.gz](https://github.com/ethereum/go-ethereum/files/10138141/trace.json.gz)\r\n\r\n#### Reason\r\n\r\n1. depth check pass when `evm.depth == 1024`\r\n    https://github.com/ethereum/go-ethereum/blob/c1aa1db69e74c71f251fc83cf7c120b4d0222728/core/vm/evm.go#L170\r\n2. subcontext starts\r\n    https://github.com/ethereum/go-ethereum/blob/c1aa1db69e74c71f251fc83cf7c120b4d0222728/core/vm/evm.go#L228\r\n3. depth increase and now `evm.depth == 1025`\r\n    https://github.com/ethereum/go-ethereum/blob/c1aa1db69e74c71f251fc83cf7c120b4d0222728/core/vm/interpreter.go#L114\r\n4. subsequent call attempt will now fail since `evm.depth > int(params.CallCreateDepth)`\r\n\r\n#### Suggest Fix\r\n\r\nChange `evm.depth > int(params.CallCreateDepth)` to `evm.depth >= int(params.CallCreateDepth)`",
  "closed_by": {
    "login": "holiman",
    "id": 142290,
    "node_id": "MDQ6VXNlcjE0MjI5MA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/holiman",
    "html_url": "https://github.com/holiman",
    "followers_url": "https://api.github.com/users/holiman/followers",
    "following_url": "https://api.github.com/users/holiman/following{/other_user}",
    "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
    "organizations_url": "https://api.github.com/users/holiman/orgs",
    "repos_url": "https://api.github.com/users/holiman/repos",
    "events_url": "https://api.github.com/users/holiman/events{/privacy}",
    "received_events_url": "https://api.github.com/users/holiman/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/26288/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/26288/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1335097888",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/26288#issuecomment-1335097888",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/26288",
    "id": 1335097888,
    "node_id": "IC_kwDOAOvK985Pk_og",
    "user": {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-02T11:18:49Z",
    "updated_at": "2022-12-02T11:18:49Z",
    "author_association": "MEMBER",
    "body": "See https://github.com/ethereum/go-ethereum/pull/26289#issuecomment-1335097463",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1335097888/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1335183777",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/26288#issuecomment-1335183777",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/26288",
    "id": 1335183777,
    "node_id": "IC_kwDOAOvK985PlUmh",
    "user": {
      "login": "DreamWuGit",
      "id": 16850793,
      "node_id": "MDQ6VXNlcjE2ODUwNzkz",
      "avatar_url": "https://avatars.githubusercontent.com/u/16850793?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/DreamWuGit",
      "html_url": "https://github.com/DreamWuGit",
      "followers_url": "https://api.github.com/users/DreamWuGit/followers",
      "following_url": "https://api.github.com/users/DreamWuGit/following{/other_user}",
      "gists_url": "https://api.github.com/users/DreamWuGit/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/DreamWuGit/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/DreamWuGit/subscriptions",
      "organizations_url": "https://api.github.com/users/DreamWuGit/orgs",
      "repos_url": "https://api.github.com/users/DreamWuGit/repos",
      "events_url": "https://api.github.com/users/DreamWuGit/events{/privacy}",
      "received_events_url": "https://api.github.com/users/DreamWuGit/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-02T12:51:42Z",
    "updated_at": "2022-12-02T13:27:53Z",
    "author_association": "NONE",
    "body": "@holiman  it can reach the 1025 but not revert, for call in 1025 depth , just push zero result to the stack and resume run others' remaining op codes util completeã€‚ if 1025 depth bytecodes don't contain call op code, it will run as normal to complete.   you can refer to geth trace file [trace.json.gz](https://github.com/ethereum/go-ethereum/files/10138141/trace.json.gz) attached to this issue \r\n```\r\n{\r\n        \"pc\": 25,\r\n        \"op\": \"CALL\",\r\n        \"gas\": 991802549,\r\n        \"gas_cost\": 976305636,\r\n        \"refund\": 0,\r\n        \"depth\": 1025,\r\n        \"error\": null,\r\n        \"stack\": [\r\n            \"0\",\r\n            \"0\",\r\n            \"20\",\r\n            \"0\",\r\n            \"0\",\r\n            \"ed59714e286e0058f3160cc1bc7506e6f06add3c\",\r\n            \"3b1cb4b9\"\r\n        ],\r\n        \"memory\": \"000000000000000000000000ed59714e286e0058f3160cc1bc7506e6f06add3c\",\r\n        \"storage\": {}\r\n    },\r\n    {\r\n        \"pc\": 26,\r\n        \"op\": \"STOP\",\r\n        \"gas\": 991802449,\r\n        \"gas_cost\": 0,\r\n        \"refund\": 0,\r\n        \"depth\": 1025,\r\n        \"error\": null,\r\n        \"stack\": [\r\n            \"0\"\r\n        ],\r\n        \"memory\": \"000000000000000000000000ed59714e286e0058f3160cc1bc7506e6f06add3c\",\r\n        \"storage\": {}\r\n    },\r\n```\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1335183777/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
