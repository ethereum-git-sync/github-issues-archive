{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22839",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22839/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22839/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22839/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/22839",
  "id": 878778393,
  "node_id": "MDU6SXNzdWU4Nzg3NzgzOTM=",
  "number": 22839,
  "title": "After upgrade to 1.10.3 import of new chain segment takes 30 seconds while generating snapshot",
  "user": {
    "login": "farmer69420",
    "id": 74717373,
    "node_id": "MDQ6VXNlcjc0NzE3Mzcz",
    "avatar_url": "https://avatars.githubusercontent.com/u/74717373?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/farmer69420",
    "html_url": "https://github.com/farmer69420",
    "followers_url": "https://api.github.com/users/farmer69420/followers",
    "following_url": "https://api.github.com/users/farmer69420/following{/other_user}",
    "gists_url": "https://api.github.com/users/farmer69420/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/farmer69420/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/farmer69420/subscriptions",
    "organizations_url": "https://api.github.com/users/farmer69420/orgs",
    "repos_url": "https://api.github.com/users/farmer69420/repos",
    "events_url": "https://api.github.com/users/farmer69420/events{/privacy}",
    "received_events_url": "https://api.github.com/users/farmer69420/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 72233650,
      "node_id": "MDU6TGFiZWw3MjIzMzY1MA==",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/type:bug",
      "name": "type:bug",
      "color": "FF5E5E",
      "default": false,
      "description": ""
    },
    {
      "id": 1132689577,
      "node_id": "MDU6TGFiZWwxMTMyNjg5NTc3",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/status:triage",
      "name": "status:triage",
      "color": "6be514",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2021-05-07T10:56:44Z",
  "updated_at": "2022-07-26T13:07:45Z",
  "closed_at": "2022-07-26T13:07:44Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "#### System information\r\n\r\nGeth version: `1.10.3`\r\nOS & Version: Linux\r\n\r\n#### Expected behaviour\r\nNode keep in sync while generating snapshot.\r\n\r\n#### Actual behaviour\r\nNode is falling behind while generating snapshot. Import of new chain segment takes around 30 seconds. It took around 1 sec before upgrade.\r\n\r\n#### Steps to reproduce the behaviour\r\n- clean shutdown of synced archive node version 1.10.2, that was halfway through snapshot generation\r\n- upgrade to 1.10.3\r\n\r\n#### Backtrace\r\nbefore upgrade\r\n````\r\nMay 06 20:59:53 ethnode geth[112378]: INFO [05-06|20:59:53.424] Aborting state snapshot generation       root=\"d82904…03c5ca\" in=\"940916…91232a\" at=\"62174c…b0a268\" accounts=68158719 slots=227258352 storage=19.39GiB   elapsed=620h53m21.392s eta=452h49m25.934s\r\nMay 06 20:59:53 ethnode geth[112378]: INFO [05-06|20:59:53.446] Resuming state snapshot generation       root=\"484609…3a7ac9\" in=\"940916…91232a\" at=\"62174c…b0a268\" accounts=68158719 slots=227258352 storage=19.39GiB   elapsed=620h53m21.414s eta=452h49m25.95s\r\nMay 06 20:59:53 ethnode geth[112378]: INFO [05-06|20:59:53.486] Imported new chain segment               blocks=1   txs=151  mgas=14.947  elapsed=563.071ms      mgasps=26.546  number=12383048 hash=\"98b7be…29c07e\" dirty=0.00B\r\nMay 06 20:59:54 ethnode geth[112378]: INFO [05-06|20:59:54.606] Aborting state snapshot generation       root=\"484609…3a7ac9\" in=\"940916…91232a\" at=\"62236f…41af96\" accounts=68158719 slots=227258434 storage=19.39GiB   elapsed=620h53m22.573s eta=452h49m26.795s\r\nMay 06 20:59:54 ethnode geth[112378]: INFO [05-06|20:59:54.681] Resuming state snapshot generation       root=\"16cdec…b92306\" in=\"940916…91232a\" at=\"62236f…41af96\" accounts=68158719 slots=227258434 storage=19.39GiB   elapsed=620h53m22.649s eta=452h49m26.851s\r\nMay 06 20:59:54 ethnode geth[112378]: INFO [05-06|20:59:54.724] Imported new chain segment               blocks=1   txs=163  mgas=14.173  elapsed=1.228s         mgasps=11.537  number=12383049 hash=\"331541…a28a81\" dirty=0.00B\r\nMay 06 20:59:56 ethnode geth[112378]: INFO [05-06|20:59:56.816] HTTP server stopped                      endpoint=172.31.26.205:8545\r\nMay 06 20:59:56 ethnode geth[112378]: INFO [05-06|20:59:56.829] IPC endpoint closed                      url=/ethereum/datadir/geth.ipc\r\nMay 06 20:59:56 ethnode geth[112378]: INFO [05-06|20:59:56.861] Ethereum protocol stopped\r\nMay 06 20:59:56 ethnode geth[112378]: INFO [05-06|20:59:56.868] Transaction pool stopped\r\nMay 06 20:59:56 ethnode geth[112378]: INFO [05-06|20:59:56.899] Aborting state snapshot generation       root=\"16cdec…b92306\" in=\"940916…91232a\" at=\"623a9a…fcefe0\" accounts=68158719 slots=227258585 storage=19.39GiB   elapsed=620h53m24.867s eta=452h49m28.468s\r\nMay 06 20:59:56 ethnode geth[112378]: INFO [05-06|20:59:56.899] Journalling in-progress snapshot         root=\"16cdec…b92306\" in=\"940916…91232a\" at=\"623a9a…fcefe0\" accounts=68158719 slots=227258585 storage=19.39GiB   elapsed=620h53m24.867s eta=452h49m28.468s\r\nMay 06 20:59:56 ethnode geth[112378]: INFO [05-06|20:59:56.906] Writing clean trie cache to disk         path=/ethereum/datadir/geth/triecache threads=8\r\nMay 06 21:00:06 ethnode geth[112378]: INFO [05-06|21:00:06.268] Persisted the clean trie cache           path=/ethereum/datadir/geth/triecache elapsed=9.362s\r\nMay 06 21:00:06 ethnode geth[112378]: INFO [05-06|21:00:06.268] Blockchain stopped\r\nMay 06 21:00:07 ethnode geth[112378]: INFO [05-06|21:00:07.522] Looking for peers                        peercount=1  tried=49 static=0\r\nMay 06 21:00:10 ethnode systemd[1]: geth.service: Succeeded.\r\nMay 06 21:00:10 ethnode systemd[1]: Stopped Ethereum go client.\r\n\r\n````\r\n\r\nafter upgrade (it was restarted again to increase resources)\r\n`````\r\nMay 07 10:44:06 ethnode geth[1685]: INFO [05-07|10:44:06.200] Imported new chain segment               blocks=1 txs=484 mgas=14.951 elapsed=30.210s      mgasps=0.495 number=12,384,356 hash=5ebf6a..ce82cb age=8h43m56s dirty=0.00B\r\nMay 07 10:44:36 ethnode geth[1685]: INFO [05-07|10:44:36.088] Aborting state snapshot generation       root=4ff6f0..781f35 at=940916..91232a accounts=68,158,719 slots=227,575,308 storage=19.41GiB elapsed=2h13m47.171s\r\nMay 07 10:44:36 ethnode geth[1685]: INFO [05-07|10:44:36.092] Resuming state snapshot generation       root=868682..1e18aa at=940916..91232a accounts=68,158,719 slots=227,575,308 storage=19.41GiB elapsed=2h13m47.176s\r\nMay 07 10:44:36 ethnode geth[1685]: INFO [05-07|10:44:36.150] Imported new chain segment               blocks=1 txs=494 mgas=14.952 elapsed=29.950s      mgasps=0.499 number=12,384,357 hash=8cc98a..5183c6 age=8h43m53s dirty=0.00B\r\nMay 07 10:44:39 ethnode geth[1685]: INFO [05-07|10:44:39.725] Deep froze chain segment                 blocks=2 elapsed=19.229ms     number=12,294,357 hash=c93cd6..dbf0e9\r\nMay 07 10:45:06 ethnode geth[1685]: INFO [05-07|10:45:06.028] Aborting state snapshot generation       root=868682..1e18aa at=940916..91232a accounts=68,158,719 slots=227,575,308 storage=19.41GiB elapsed=2h14m17.112s\r\nMay 07 10:45:06 ethnode geth[1685]: INFO [05-07|10:45:06.044] Resuming state snapshot generation       root=a6baa1..592394 at=940916..91232a accounts=68,158,719 slots=227,575,308 storage=19.41GiB elapsed=2h14m17.127s\r\nMay 07 10:45:06 ethnode geth[1685]: INFO [05-07|10:45:06.101] Imported new chain segment               blocks=1 txs=241 mgas=14.959 elapsed=29.950s      mgasps=0.499 number=12,384,358 hash=583074..199800 age=8h44m16s dirty=0.00B\r\n`````\r\n\r\nWe also noticed weird reported reading behaviour. Geth is reporting huge storage reading, but we don't see it on OS level.\r\ngeth:\r\n![image](https://user-images.githubusercontent.com/74717373/117439662-681f3280-af33-11eb-866f-0fb0a58051c6.png)\r\nos:\r\n![image](https://user-images.githubusercontent.com/74717373/117439799-969d0d80-af33-11eb-8e2e-d4925b7ff0a4.png)\r\n\r\nEDIT: with `--snapshot=false` is node performace as expected\r\n",
  "closed_by": {
    "login": "karalabe",
    "id": 129561,
    "node_id": "MDQ6VXNlcjEyOTU2MQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/karalabe",
    "html_url": "https://github.com/karalabe",
    "followers_url": "https://api.github.com/users/karalabe/followers",
    "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
    "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
    "organizations_url": "https://api.github.com/users/karalabe/orgs",
    "repos_url": "https://api.github.com/users/karalabe/repos",
    "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
    "received_events_url": "https://api.github.com/users/karalabe/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22839/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22839/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/836993983",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/22839#issuecomment-836993983",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22839",
    "id": 836993983,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgzNjk5Mzk4Mw==",
    "user": {
      "login": "nebojsa94",
      "id": 15905908,
      "node_id": "MDQ6VXNlcjE1OTA1OTA4",
      "avatar_url": "https://avatars.githubusercontent.com/u/15905908?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nebojsa94",
      "html_url": "https://github.com/nebojsa94",
      "followers_url": "https://api.github.com/users/nebojsa94/followers",
      "following_url": "https://api.github.com/users/nebojsa94/following{/other_user}",
      "gists_url": "https://api.github.com/users/nebojsa94/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nebojsa94/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nebojsa94/subscriptions",
      "organizations_url": "https://api.github.com/users/nebojsa94/orgs",
      "repos_url": "https://api.github.com/users/nebojsa94/repos",
      "events_url": "https://api.github.com/users/nebojsa94/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nebojsa94/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-05-10T17:17:39Z",
    "updated_at": "2021-05-10T17:17:39Z",
    "author_association": "CONTRIBUTOR",
    "body": "Running into the same issue :/\r\n\r\nNote that this will still occur around the same location even when the snapshot starts from scratch.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/836993983/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/839440616",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/22839#issuecomment-839440616",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22839",
    "id": 839440616,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgzOTQ0MDYxNg==",
    "user": {
      "login": "karalabe",
      "id": 129561,
      "node_id": "MDQ6VXNlcjEyOTU2MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/karalabe",
      "html_url": "https://github.com/karalabe",
      "followers_url": "https://api.github.com/users/karalabe/followers",
      "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
      "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
      "organizations_url": "https://api.github.com/users/karalabe/orgs",
      "repos_url": "https://api.github.com/users/karalabe/repos",
      "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
      "received_events_url": "https://api.github.com/users/karalabe/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-05-12T05:08:21Z",
    "updated_at": "2021-05-12T05:08:21Z",
    "author_association": "MEMBER",
    "body": "Generating the snapshot for a node that didn't have it yet unfortunately is super slow. Full syncing would implicitly have the snapshots from block imports, and snap syncing would have most of it from the network and only need a fixup round. Fast sync (deprecated soon) or an old node will take a hit while it's generating unfortunately. I don't see a way around and unsure if there's anything to fix it given that it's a temporary state.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/839440616/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/839492940",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/22839#issuecomment-839492940",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22839",
    "id": 839492940,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgzOTQ5Mjk0MA==",
    "user": {
      "login": "nebojsa94",
      "id": 15905908,
      "node_id": "MDQ6VXNlcjE1OTA1OTA4",
      "avatar_url": "https://avatars.githubusercontent.com/u/15905908?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nebojsa94",
      "html_url": "https://github.com/nebojsa94",
      "followers_url": "https://api.github.com/users/nebojsa94/followers",
      "following_url": "https://api.github.com/users/nebojsa94/following{/other_user}",
      "gists_url": "https://api.github.com/users/nebojsa94/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nebojsa94/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nebojsa94/subscriptions",
      "organizations_url": "https://api.github.com/users/nebojsa94/orgs",
      "repos_url": "https://api.github.com/users/nebojsa94/repos",
      "events_url": "https://api.github.com/users/nebojsa94/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nebojsa94/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-05-12T06:22:38Z",
    "updated_at": "2021-05-12T06:22:38Z",
    "author_association": "CONTRIBUTOR",
    "body": "That makes sense, but why does it slow down the import so much? Nodes are going out sync on very beefy machines when snapshots are enabled. which is by default. Btw, the speed of snapshotting on 1.10.3 is like 20x faster than 1.10.1, but it gets stuck where version 1.10.1 stopped previous snapshotting even when it starts from scratch on the new version. Could it be that snapshot resuming is somehow not compatible between 1.10.3 and 1.10.[0-2]?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/839492940/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/840392570",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/22839#issuecomment-840392570",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22839",
    "id": 840392570,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg0MDM5MjU3MA==",
    "user": {
      "login": "farmer69420",
      "id": 74717373,
      "node_id": "MDQ6VXNlcjc0NzE3Mzcz",
      "avatar_url": "https://avatars.githubusercontent.com/u/74717373?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/farmer69420",
      "html_url": "https://github.com/farmer69420",
      "followers_url": "https://api.github.com/users/farmer69420/followers",
      "following_url": "https://api.github.com/users/farmer69420/following{/other_user}",
      "gists_url": "https://api.github.com/users/farmer69420/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/farmer69420/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/farmer69420/subscriptions",
      "organizations_url": "https://api.github.com/users/farmer69420/orgs",
      "repos_url": "https://api.github.com/users/farmer69420/repos",
      "events_url": "https://api.github.com/users/farmer69420/events{/privacy}",
      "received_events_url": "https://api.github.com/users/farmer69420/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-05-13T08:02:06Z",
    "updated_at": "2021-05-13T08:32:52Z",
    "author_association": "NONE",
    "body": "We experience the same. Geth gets almost stuck on not completed snapshot resumed from previous version. Is it possible to drop snapshot generated by previous version and start generating it again on version 1.10.3?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/840392570/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1195460829",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/22839#issuecomment-1195460829",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22839",
    "id": 1195460829,
    "node_id": "IC_kwDOAOvK985HQUjd",
    "user": {
      "login": "karalabe",
      "id": 129561,
      "node_id": "MDQ6VXNlcjEyOTU2MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/karalabe",
      "html_url": "https://github.com/karalabe",
      "followers_url": "https://api.github.com/users/karalabe/followers",
      "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
      "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
      "organizations_url": "https://api.github.com/users/karalabe/orgs",
      "repos_url": "https://api.github.com/users/karalabe/repos",
      "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
      "received_events_url": "https://api.github.com/users/karalabe/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-26T13:07:44Z",
    "updated_at": "2022-07-26T13:07:44Z",
    "author_association": "MEMBER",
    "body": "There are a number of ways out of this situation (slow snapshot generation on an old archive node):\r\n\r\n1. Disable snapshots via `--snapshot=false`. This is easy, but will stop working eventually as we'll drop the flag at some point.\r\n2. Wait snapshot generation out. This is super slow since iterating an archive node is insane, but does eventually get there.\r\n3. Resync an entire archive node form 0. This will maintain the snapshot in lockstep with sync.\r\n4. Sync another node via snap sync, export the snapshot data from it `geth db export snapshot dump.gz` and then import it on another node `geth db import dump.gz`. On startup, your archive node should regenerate the snapshot using the imported \"old\" data, which ideally is almost exactly what you need. Disclaimer: I haven't tried it on a mainnet archive node, so I can't 100% guarantee it will go without hiccups.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1195460829/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
