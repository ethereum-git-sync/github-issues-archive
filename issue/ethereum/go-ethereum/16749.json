{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/16749",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/16749/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/16749/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/16749/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/16749",
  "id": 324097208,
  "node_id": "MDU6SXNzdWUzMjQwOTcyMDg=",
  "number": 16749,
  "title": "Error \"Dangling trie nodes after full cleanup\" and crash during shutting down",
  "user": {
    "login": "chfast",
    "id": 573380,
    "node_id": "MDQ6VXNlcjU3MzM4MA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/573380?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/chfast",
    "html_url": "https://github.com/chfast",
    "followers_url": "https://api.github.com/users/chfast/followers",
    "following_url": "https://api.github.com/users/chfast/following{/other_user}",
    "gists_url": "https://api.github.com/users/chfast/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/chfast/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/chfast/subscriptions",
    "organizations_url": "https://api.github.com/users/chfast/orgs",
    "repos_url": "https://api.github.com/users/chfast/repos",
    "events_url": "https://api.github.com/users/chfast/events{/privacy}",
    "received_events_url": "https://api.github.com/users/chfast/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2018-05-17T16:27:59Z",
  "updated_at": "2019-01-29T09:55:15Z",
  "closed_at": "2018-12-11T09:55:55Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "#### System information\r\n\r\nVersion: 1.8.8-stable\r\nGit Commit: 2688dab48c9b8ae71b8d95c7678817eaa17f2b53\r\nArchitecture: amd64\r\nProtocol Versions: [63 62]\r\nNetwork Id: 1\r\nGo Version: go1.10.1\r\nOperating System: linux\r\n\r\n#### Steps to reproduce the behaviour\r\n```\r\ngeth --lightserv 10\r\n```\r\n\r\n#### Backtrace\r\n\r\nFull log attached.\r\n\r\n```\r\n^CINFO [05-17|18:16:35] Got interrupt, shutting down...\r\nINFO [05-17|18:16:35] IPC endpoint closed                      endpoint=/home/chfast/.ethereum/geth.ipc\r\nINFO [05-17|18:16:35] Writing cached state to disk             block=5630135 hash=e34615…023d3a root=4875bb…5f0b17\r\nINFO [05-17|18:16:40] Persisted trie from memory database      nodes=630415 size=180.92mB time=4.617355567s gcnodes=1158624 gcsize=499.64mB gctime=4.061997519s livenodes=200750 livesize=85.29mB\r\nINFO [05-17|18:16:40] Writing cached state to disk             block=5630134 hash=629a9b…0ed691 root=b64fb9…3605b5\r\nINFO [05-17|18:16:40] Persisted trie from memory database      nodes=1319   size=532.87kB time=17.621581ms  gcnodes=0       gcsize=0.00B    gctime=0s           livenodes=199431 livesize=84.75mB\r\nINFO [05-17|18:16:40] Writing cached state to disk             block=5630008 hash=20fc82…71a357 root=a9ad74…4bb9ec\r\nINFO [05-17|18:16:41] Persisted trie from memory database      nodes=59368  size=23.33mB  time=1.029860796s gcnodes=0       gcsize=0.00B    gctime=0s           livenodes=140063 livesize=61.42mB\r\nERROR[05-17|18:16:42] Dangling trie nodes after full cleanup\r\nINFO [05-17|18:16:42] Blockchain manager stopped\r\nINFO [05-17|18:16:42] Stopping Ethereum protocol\r\nINFO [05-17|18:16:42] Ethereum protocol stopped\r\nINFO [05-17|18:16:42] Stopping light Ethereum protocol\r\nfatal error: sync: unlock of unlocked mutex\r\n\r\ngoroutine 3283334 [running]:\r\nruntime.throw(0xf2ab35, 0x1e)\r\n\t/home/travis/.gimme/versions/go1.10.1.linux.amd64/src/runtime/panic.go:616 +0x81 fp=0xc4e5f0c170 sp=0xc4e5f0c150 pc=0x440c81\r\nsync.throw(0xf2ab35, 0x1e)\r\n\t/home/travis/.gimme/versions/go1.10.1.linux.amd64/src/runtime/panic.go:605 +0x35 fp=0xc4e5f0c190 sp=0xc4e5f0c170 pc=0x440bf5\r\nsync.(*Mutex).Unlock(0xc42d2a4640)\r\n\t/home/travis/.gimme/versions/go1.10.1.linux.amd64/src/sync/mutex.go:184 +0xc2 fp=0xc4e5f0c1b8 sp=0xc4e5f0c190 pc=0x487062\r\nruntime.call32(0x0, 0xfa0330, 0xc457a2c0f0, 0x800000008)\r\n\t/home/travis/.gimme/versions/go1.10.1.linux.amd64/src/runtime/asm_amd64.s:573 +0x3b fp=0xc4e5f0c1e8 sp=0xc4e5f0c1b8 pc=0x46dc1b\r\npanic(0xdd5280, 0x108dd10)\r\n\t/home/travis/.gimme/versions/go1.10.1.linux.amd64/src/runtime/panic.go:502 +0x229 fp=0xc4e5f0c288 sp=0xc4e5f0c1e8 pc=0x440649\r\nruntime.chansend(0xc431d98de0, 0xc4e5f0c378, 0xc45438d301, 0xab3f6b, 0xffffffffffffffff)\r\n\t/home/travis/.gimme/versions/go1.10.1.linux.amd64/src/runtime/chan.go:245 +0x583 fp=0xc4e5f0c310 sp=0xc4e5f0c288 pc=0x419783\r\nruntime.chansend1(0xc431d98de0, 0xc4e5f0c378)\r\n\t/home/travis/.gimme/versions/go1.10.1.linux.amd64/src/runtime/chan.go:125 +0x35 fp=0xc4e5f0c348 sp=0xc4e5f0c310 pc=0x4191f5\r\ngithub.com/ethereum/go-ethereum/les/flowcontrol.(*ClientManager).accept(0xc42d2a4640, 0xc42b2929c0, 0x22f022129e31b, 0xc4e5f0c400)\r\n\t/home/travis/gopath/src/github.com/ethereum/go-ethereum/les/flowcontrol/manager.go:195 +0x1eb fp=0xc4e5f0c390 sp=0xc4e5f0c348 pc=0xab3f6b\r\ngithub.com/ethereum/go-ethereum/les/flowcontrol.(*ClientNode).AcceptRequest(0xc441a6d6b0, 0x0, 0x0)\r\n\t/home/travis/gopath/src/github.com/ethereum/go-ethereum/les/flowcontrol/control.go:75 +0xe3 fp=0xc4e5f0c3c8 sp=0xc4e5f0c390 pc=0xab2ca3\r\ngithub.com/ethereum/go-ethereum/les.(*ProtocolManager).handleMsg.func1(0x1, 0x20, 0x108fc00)\r\n\t/home/travis/gopath/src/github.com/ethereum/go-ethereum/les/handler.go:351 +0x75 fp=0xc4e5f0c440 sp=0xc4e5f0c3c8 pc=0xae0af5\r\ngithub.com/ethereum/go-ethereum/les.(*ProtocolManager).handleMsg(0xc4202602d0, 0xc441f63680, 0x0, 0x0)\r\n\t/home/travis/gopath/src/github.com/ethereum/go-ethereum/les/handler.go:524 +0x1289 fp=0xc4e5f0dc68 sp=0xc4e5f0c440 pc=0xac0509\r\ngithub.com/ethereum/go-ethereum/les.(*ProtocolManager).handle(0xc4202602d0, 0xc441f63680, 0x0, 0x0)\r\n\t/home/travis/gopath/src/github.com/ethereum/go-ethereum/les/handler.go:327 +0x727 fp=0xc4e5f0ddf8 sp=0xc4e5f0dc68 pc=0xabef87\r\ngithub.com/ethereum/go-ethereum/les.NewProtocolManager.func1(0xc484d11b60, 0x1093e00, 0xc4225a6cb0, 0x0, 0x0)\r\n\t/home/travis/gopath/src/github.com/ethereum/go-ethereum/les/handler.go:175 +0x23b fp=0xc4e5f0df00 sp=0xc4e5f0ddf8 pc=0xae04ab\r\ngithub.com/ethereum/go-ethereum/p2p.(*Peer).startProtocols.func1(0xc4225a6cb0, 0xc484d11b60, 0x1093e00, 0xc4225a6cb0)\r\n\t/home/travis/gopath/src/github.com/ethereum/go-ethereum/p2p/peer.go:348 +0x66 fp=0xc4e5f0dfc0 sp=0xc4e5f0df00 pc=0x985ce6\r\nruntime.goexit()\r\n\t/home/travis/.gimme/versions/go1.10.1.linux.amd64/src/runtime/asm_amd64.s:2361 +0x1 fp=0xc4e5f0dfc8 sp=0xc4e5f0dfc0 pc=0x4703e1\r\ncreated by github.com/ethereum/go-ethereum/p2p.(*Peer).startProtocols\r\n\t/home/travis/gopath/src/github.com/ethereum/go-ethereum/p2p/peer.go:347 +0x201\r\n```\r\n[geth.log](https://github.com/ethereum/go-ethereum/files/2014013/geth.log)\r\n",
  "closed_by": {
    "login": "adamschmideg",
    "id": 208822,
    "node_id": "MDQ6VXNlcjIwODgyMg==",
    "avatar_url": "https://avatars.githubusercontent.com/u/208822?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/adamschmideg",
    "html_url": "https://github.com/adamschmideg",
    "followers_url": "https://api.github.com/users/adamschmideg/followers",
    "following_url": "https://api.github.com/users/adamschmideg/following{/other_user}",
    "gists_url": "https://api.github.com/users/adamschmideg/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/adamschmideg/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/adamschmideg/subscriptions",
    "organizations_url": "https://api.github.com/users/adamschmideg/orgs",
    "repos_url": "https://api.github.com/users/adamschmideg/repos",
    "events_url": "https://api.github.com/users/adamschmideg/events{/privacy}",
    "received_events_url": "https://api.github.com/users/adamschmideg/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/16749/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/16749/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/394099577",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/16749#issuecomment-394099577",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/16749",
    "id": 394099577,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM5NDA5OTU3Nw==",
    "user": {
      "login": "upers",
      "id": 12727242,
      "node_id": "MDQ6VXNlcjEyNzI3MjQy",
      "avatar_url": "https://avatars.githubusercontent.com/u/12727242?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/upers",
      "html_url": "https://github.com/upers",
      "followers_url": "https://api.github.com/users/upers/followers",
      "following_url": "https://api.github.com/users/upers/following{/other_user}",
      "gists_url": "https://api.github.com/users/upers/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/upers/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/upers/subscriptions",
      "organizations_url": "https://api.github.com/users/upers/orgs",
      "repos_url": "https://api.github.com/users/upers/repos",
      "events_url": "https://api.github.com/users/upers/events{/privacy}",
      "received_events_url": "https://api.github.com/users/upers/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-06-02T16:30:51Z",
    "updated_at": "2018-11-27T09:59:55Z",
    "author_association": "NONE",
    "body": "I have same problem in my private POA net.\r\nI got error:\r\n```\r\n---------------------------------ERROR--------------------------------------\r\nError: invalid merkle root\r\n########## BAD BLOCK #########\r\nChain config: {ChainID: 452 Homestead: 1 DAO: <nil> DAOSupport: false EIP150: 2 EIP155: 3 EIP158: 3 Byzantium: 4 Constantinople: <nil> Engine: clique}\r\n\r\nNumber: 1626771\r\nHash: 0x53e5c4ded722ddbe00dbd8c153aa3b64741d15b5d731f5ffe745b2e1bca2d259\r\n----------------------------------------------------------------------------------------\r\n```\r\nI fixed this by restarting all nodes and adding peers manually through the get.ipc.\r\n\r\nBut in 10 hours  all my nodes stopped synchronizing and accordingly ceased to create blocks.\r\nMessage from log: \"ERROR[06-01|17:58:24] Dangling trie nodes after full cleanup.\"\r\nI can not clean the block because there is valuable information there.\r\nI tried restart nodes and added peers manually, it didn't work.\r\n\r\nAnd there no error messages in log, only: \"Signed recently, must wait for others.\"\r\nGeth version: 1.8.3-stable.\r\nGo version: go1.10.1\r\nOS: ubuntu 16.04\r\nGenesis file:\r\n```\r\n{\r\n  \"config\": {\r\n    \"chainId\": 452,\r\n    \"homesteadBlock\": 1,\r\n    \"eip150Block\": 2,\r\n    \"eip150Hash\": \"0x0000000000000000000000000000000000000000000000000000000000000000\",\r\n    \"eip155Block\": 3,\r\n    \"eip158Block\": 3,\r\n    \"byzantiumBlock\": 4,\r\n    \"clique\": {\r\n      \"period\": 3,\r\n      \"epoch\": 30000\r\n    }\r\n  },\r\n  \"nonce\": \"0x0\",\r\n  \"timestamp\": \"0x5ac632c4\",\r\n  \"extraData\": \"0x00000000000000000000000000000000000000000000000000000000000000002368c95eb9ea3578a20d6887ccb40773499b93d5c67be939661d2559acfb059fc1737a2ceaaed4ae0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\",\r\n  \"gasLimit\": \"0x47b760\",\r\n  \"difficulty\": \"0x1\",\r\n  \"mixHash\": \"0x0000000000000000000000000000000000000000000000000000000000000000\",\r\n  \"coinbase\": \"0x0000000000000000000000000000000000000000\",\r\n  \"alloc\": {\r\n    \"2368c95eb9ea3578a20d6887ccb40773499b93d5\": {\r\n      \"balance\": \"0x200000000000000000000000000000000000000000000000000000000000000\"\r\n    },\r\n    \"c67be939661d2559acfb059fc1737a2ceaaed4ae\": {\r\n      \"balance\": \"0x200000000000000000000000000000000000000000000000000000000000000\"\r\n    }\r\n  },\r\n  \"number\": \"0x0\",\r\n  \"gasUsed\": \"0x0\",\r\n  \"parentHash\": \"0x0000000000000000000000000000000000000000000000000000000000000000\"\r\n}\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/394099577/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/446140929",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/16749#issuecomment-446140929",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/16749",
    "id": 446140929,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ0NjE0MDkyOQ==",
    "user": {
      "login": "adamschmideg",
      "id": 208822,
      "node_id": "MDQ6VXNlcjIwODgyMg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/208822?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/adamschmideg",
      "html_url": "https://github.com/adamschmideg",
      "followers_url": "https://api.github.com/users/adamschmideg/followers",
      "following_url": "https://api.github.com/users/adamschmideg/following{/other_user}",
      "gists_url": "https://api.github.com/users/adamschmideg/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/adamschmideg/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/adamschmideg/subscriptions",
      "organizations_url": "https://api.github.com/users/adamschmideg/orgs",
      "repos_url": "https://api.github.com/users/adamschmideg/repos",
      "events_url": "https://api.github.com/users/adamschmideg/events{/privacy}",
      "received_events_url": "https://api.github.com/users/adamschmideg/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-12-11T09:55:55Z",
    "updated_at": "2018-12-11T09:55:55Z",
    "author_association": "MEMBER",
    "body": "This issue seems to describe three different problems. If the problem persists, please open a separate issue.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/446140929/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
