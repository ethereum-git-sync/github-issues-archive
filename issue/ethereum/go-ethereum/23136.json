{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/23136",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/23136/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/23136/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/23136/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/23136",
  "id": 934067851,
  "node_id": "MDU6SXNzdWU5MzQwNjc4NTE=",
  "number": 23136,
  "title": "New snapshot syncing mode is slower in 1.10.4 than old method in 1.10.3",
  "user": {
    "login": "begetan",
    "id": 17225934,
    "node_id": "MDQ6VXNlcjE3MjI1OTM0",
    "avatar_url": "https://avatars.githubusercontent.com/u/17225934?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/begetan",
    "html_url": "https://github.com/begetan",
    "followers_url": "https://api.github.com/users/begetan/followers",
    "following_url": "https://api.github.com/users/begetan/following{/other_user}",
    "gists_url": "https://api.github.com/users/begetan/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/begetan/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/begetan/subscriptions",
    "organizations_url": "https://api.github.com/users/begetan/orgs",
    "repos_url": "https://api.github.com/users/begetan/repos",
    "events_url": "https://api.github.com/users/begetan/events{/privacy}",
    "received_events_url": "https://api.github.com/users/begetan/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 72233650,
      "node_id": "MDU6TGFiZWw3MjIzMzY1MA==",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/type:bug",
      "name": "type:bug",
      "color": "FF5E5E",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 7,
  "created_at": "2021-06-30T19:45:10Z",
  "updated_at": "2021-07-13T15:42:38Z",
  "closed_at": "2021-07-13T15:42:38Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "#### System information\r\n\r\nGeth version: `Geth version 1.10.4`\r\nOS & Version: Linux Ubuntu 20.04 LTS\r\nAWS c5 instance with x86_x64 CPU comparing with a1/c6g instance with arm64 CPU \r\n\r\n#### Expected behaviour\r\nSnapshot syncing is enabled by default. We expect that it should be faster than regular sync in comparable machine types.\r\n\r\n#### Actual behaviour\r\n1. For x86 CPU it took \r\n- 11 hours for the full sync\r\n- 5 hours for \"Rebuilding state snapshot\"\r\n\r\n2. For Arm64 it took  \r\n- 30 hours for the full sync\r\n- 7 hrs for \"Rebuilding state snapshot\"\r\n\r\n#### Steps to reproduce the behaviour\r\nRun 1.10.4 and check logs\r\n\r\n#### Logs\r\nLog timeline is in the below post",
  "closed_by": {
    "login": "begetan",
    "id": 17225934,
    "node_id": "MDQ6VXNlcjE3MjI1OTM0",
    "avatar_url": "https://avatars.githubusercontent.com/u/17225934?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/begetan",
    "html_url": "https://github.com/begetan",
    "followers_url": "https://api.github.com/users/begetan/followers",
    "following_url": "https://api.github.com/users/begetan/following{/other_user}",
    "gists_url": "https://api.github.com/users/begetan/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/begetan/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/begetan/subscriptions",
    "organizations_url": "https://api.github.com/users/begetan/orgs",
    "repos_url": "https://api.github.com/users/begetan/repos",
    "events_url": "https://api.github.com/users/begetan/events{/privacy}",
    "received_events_url": "https://api.github.com/users/begetan/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/23136/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/23136/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/871730523",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/23136#issuecomment-871730523",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/23136",
    "id": 871730523,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg3MTczMDUyMw==",
    "user": {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-06-30T21:11:40Z",
    "updated_at": "2021-06-30T21:11:40Z",
    "author_association": "MEMBER",
    "body": "The speed of a sync depends on several factors, and comparing only two runs is not really worthwhile. It seems your first run took 23 hours, the second 36. While I agree that's a substantial difference, we ourselves run (snap) syncs quite regularly for benchmarking, and we have not seen any regressions recently. \r\n\r\n(I'd like to close this bug, but I'll leave it open a bit longer on the off-chance that there actually is a regression which we haven't noticed)",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/871730523/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/871993186",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/23136#issuecomment-871993186",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/23136",
    "id": 871993186,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg3MTk5MzE4Ng==",
    "user": {
      "login": "karalabe",
      "id": 129561,
      "node_id": "MDQ6VXNlcjEyOTU2MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/karalabe",
      "html_url": "https://github.com/karalabe",
      "followers_url": "https://api.github.com/users/karalabe/followers",
      "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
      "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
      "organizations_url": "https://api.github.com/users/karalabe/orgs",
      "repos_url": "https://api.github.com/users/karalabe/repos",
      "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
      "received_events_url": "https://api.github.com/users/karalabe/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-07-01T07:20:59Z",
    "updated_at": "2021-07-01T07:20:59Z",
    "author_association": "MEMBER",
    "body": "What kind of disk are you using, what's your IOPs? Can you share full logs, otherwise it's shooting in the dark?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/871993186/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/872094153",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/23136#issuecomment-872094153",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/23136",
    "id": 872094153,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg3MjA5NDE1Mw==",
    "user": {
      "login": "begetan",
      "id": 17225934,
      "node_id": "MDQ6VXNlcjE3MjI1OTM0",
      "avatar_url": "https://avatars.githubusercontent.com/u/17225934?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/begetan",
      "html_url": "https://github.com/begetan",
      "followers_url": "https://api.github.com/users/begetan/followers",
      "following_url": "https://api.github.com/users/begetan/following{/other_user}",
      "gists_url": "https://api.github.com/users/begetan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/begetan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/begetan/subscriptions",
      "organizations_url": "https://api.github.com/users/begetan/orgs",
      "repos_url": "https://api.github.com/users/begetan/repos",
      "events_url": "https://api.github.com/users/begetan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/begetan/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-07-01T09:42:45Z",
    "updated_at": "2021-07-01T09:42:45Z",
    "author_association": "NONE",
    "body": "I am using AWS EBS volume 1000GB with 3000 IOPS and 125MBs throughput. CPU has 4 Core, RAM 8GB.\r\nGeth `Run with --cache=3072` \r\n\r\nThe main question here why after snapshot sync completion it started to regenerate snapshot as for regular sync? Is it expected behaviour or I missed some details about this kind of syncing?\r\n\r\nI also wonder what does **State heal** means? This stage is much longer than the previous ordinary state syncing and looks like it does the same work.\r\n\r\nI saw a lot of benchmarks of snapshot syncing comparing to old syncing on top machines, but I try to understand the performance of low-end servers. I suppose that snapshot syncing should increase performance on slow machines especially with low throughput discs because of less disk I/O operations.  ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/872094153/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/874671655",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/23136#issuecomment-874671655",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/23136",
    "id": 874671655,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg3NDY3MTY1NQ==",
    "user": {
      "login": "begetan",
      "id": 17225934,
      "node_id": "MDQ6VXNlcjE3MjI1OTM0",
      "avatar_url": "https://avatars.githubusercontent.com/u/17225934?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/begetan",
      "html_url": "https://github.com/begetan",
      "followers_url": "https://api.github.com/users/begetan/followers",
      "following_url": "https://api.github.com/users/begetan/following{/other_user}",
      "gists_url": "https://api.github.com/users/begetan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/begetan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/begetan/subscriptions",
      "organizations_url": "https://api.github.com/users/begetan/orgs",
      "repos_url": "https://api.github.com/users/begetan/repos",
      "events_url": "https://api.github.com/users/begetan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/begetan/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-07-06T11:11:54Z",
    "updated_at": "2021-07-08T12:58:38Z",
    "author_association": "NONE",
    "body": "I've completed more tests on different machines and can confirm that slow sync is the issue only for the ARM platform.\r\nIt's weird because a synced ARM node is working well in terms of CPU and memory consumption comparing intel machines.\r\n\r\nHere is the comparison of similar intel and arm machines. Unfortunately, I haven't done a test for top-level Amazon C6 platform. So it might be really an issue of the Amazon a1 types\r\n\r\nc5.xlarge  4 core, 8GB RAM, EBS Volume 1000GB with 3000 IOPS \r\n\r\n```Jul 5 13:31:00 Start \r\nJul  5 19:19:16 State sync in progress: Last (5h 48m from start)\r\n Jul  5 19:19:30 State heal in progress: First \r\n Jul  5 23:12:24 Disabling direct-ancient mode \r\n Jul  5 23:55:16 Rebuilding state snapshot\r\nJul  5 23:58:47 Upgrading chain index 0% \r\nJul  6 00:17:09 Upgrading chain index 99% (10h 38m) \r\nJul  6 05:02:48 Resuming state snapshot generation: Last (+ 5h 7m)\r\n```\r\n  Full sync is about 11h + 5h for creating a new state snapshot. It's actually better than the old way of syncing.\r\n\r\na1.xlarge 4 core, 8GB RAM, EBS Volume 1000GB with 3000 IOPS\r\n\r\n```Jun 29 10:46:00 Start \r\nJun 29 22:59:43 State sync in progress: Last (12h 13m from start) \r\nJun 29 22:59:53 State heal in progress: First\r\nJun 30 06:29:31 Disabling direct-ancient mode\r\nJun 30 16:30:35 Rebuilding state snapshot\r\nJun 30 16:32:31 Upgrading chain index 0% \r\nJun 30 17:06:56 Upgrading chain index 99% (30h 20m from start)\r\nJul  1 00:00:13 Resuming state snapshot generation: last ( +7h 28 min)\r\n``` \r\nc6.xlarge 4 core (Graviton 2th gen), 8GB RAM, EBS Volume 1000GB with 3000 IOPS\r\n\r\n```\r\nJul  7 16:06:46 Start\r\nJul  7 22:49:43 State sync in progress: Last (6h 43m from start)\r\nJul  7 22:49:52 State heal in progress: First\r\nJul  8 00:52:57 Disabling direct-ancient mode\r\nJul  8 03:42:42 Rebuilding state snapshot (will be paused for 1h 30m) \r\nJul  8 03:45:53 Upgrading chain index: 0%\r\nJul  8 04:06:35 Upgrading chain index: 99% (12h from start)\r\n Jul  8 11:30:42 Resuming state snapshot generation ( + 6h 18 min)\r\n```\r\n\r\nI was surprised that even with snapshot sync a node starts the process of snapshot regeneration after a full sync. Although it is much faster now for both x86_64 and arm64 than in previous versions of Geth.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/874671655/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/875054393",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/23136#issuecomment-875054393",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/23136",
    "id": 875054393,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg3NTA1NDM5Mw==",
    "user": {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-07-06T20:19:23Z",
    "updated_at": "2021-07-06T20:19:23Z",
    "author_association": "MEMBER",
    "body": "@begetan thanks for the stats! \r\n\r\nThere's a direct relation between the time of the state-sync, and the time of the heal. \r\nIf the state-sync finishes in `2N hours` instead of `N hours`, that means the data will be \"twice as stale\". And if the state is more stale, then there will be more healing to do. \r\n\r\nTo add to that, whatever (network? IO? cpu?) it was that made the first phase (state sync) slow, will _also_ slow down the second phase. So there's this kind of double-combo-effect on the second phase (state heal).",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/875054393/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/876427809",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/23136#issuecomment-876427809",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/23136",
    "id": 876427809,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg3NjQyNzgwOQ==",
    "user": {
      "login": "begetan",
      "id": 17225934,
      "node_id": "MDQ6VXNlcjE3MjI1OTM0",
      "avatar_url": "https://avatars.githubusercontent.com/u/17225934?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/begetan",
      "html_url": "https://github.com/begetan",
      "followers_url": "https://api.github.com/users/begetan/followers",
      "following_url": "https://api.github.com/users/begetan/following{/other_user}",
      "gists_url": "https://api.github.com/users/begetan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/begetan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/begetan/subscriptions",
      "organizations_url": "https://api.github.com/users/begetan/orgs",
      "repos_url": "https://api.github.com/users/begetan/repos",
      "events_url": "https://api.github.com/users/begetan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/begetan/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-07-08T13:12:23Z",
    "updated_at": "2021-07-08T13:12:23Z",
    "author_association": "NONE",
    "body": "I've updated stats with AWS c6 second-generation ARM instance. It's pretty the same both for the initial sync ~ 12h vs 11h and snapshot generation.\r\n\r\n@holiman\r\nMy conclusion about snapshot sync based on your explanation: It requires powerful enough minimal CPU otherwise, the initial sync time may rise non proportionally higher.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/876427809/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/879197837",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/23136#issuecomment-879197837",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/23136",
    "id": 879197837,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg3OTE5NzgzNw==",
    "user": {
      "login": "begetan",
      "id": 17225934,
      "node_id": "MDQ6VXNlcjE3MjI1OTM0",
      "avatar_url": "https://avatars.githubusercontent.com/u/17225934?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/begetan",
      "html_url": "https://github.com/begetan",
      "followers_url": "https://api.github.com/users/begetan/followers",
      "following_url": "https://api.github.com/users/begetan/following{/other_user}",
      "gists_url": "https://api.github.com/users/begetan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/begetan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/begetan/subscriptions",
      "organizations_url": "https://api.github.com/users/begetan/orgs",
      "repos_url": "https://api.github.com/users/begetan/repos",
      "events_url": "https://api.github.com/users/begetan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/begetan/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-07-13T15:42:38Z",
    "updated_at": "2021-07-13T15:42:38Z",
    "author_association": "NONE",
    "body": "I ran tests with the disabled snapshot sync option for the mentioned machine types. It looks like the old snapshot sync method takes more time for version 1.10.4 than the new snapshot methods.\r\n\r\nUnfortunately, the constant growth of the blockchain data increasing sync time permanently, but this is not related to the new sync method. It does improve sync time.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/879197837/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
