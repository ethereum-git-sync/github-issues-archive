{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20614",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20614/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20614/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20614/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/20614",
  "id": 558797851,
  "node_id": "MDU6SXNzdWU1NTg3OTc4NTE=",
  "number": 20614,
  "title": "PoA miner panic when importing blocks",
  "user": {
    "login": "csokun",
    "id": 29750,
    "node_id": "MDQ6VXNlcjI5NzUw",
    "avatar_url": "https://avatars.githubusercontent.com/u/29750?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/csokun",
    "html_url": "https://github.com/csokun",
    "followers_url": "https://api.github.com/users/csokun/followers",
    "following_url": "https://api.github.com/users/csokun/following{/other_user}",
    "gists_url": "https://api.github.com/users/csokun/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/csokun/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/csokun/subscriptions",
    "organizations_url": "https://api.github.com/users/csokun/orgs",
    "repos_url": "https://api.github.com/users/csokun/repos",
    "events_url": "https://api.github.com/users/csokun/events{/privacy}",
    "received_events_url": "https://api.github.com/users/csokun/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2020-02-03T01:49:12Z",
  "updated_at": "2020-03-18T13:08:20Z",
  "closed_at": "2020-03-18T13:08:20Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "I have set up a private PoA network with 4 validators running on Kubernetes (stateless). The network is up and running for weeks without any hiccup. I decided to restart one of a validator and it can't recover from this outage.\r\n\r\n## System information\r\n\r\nGeth version: `v1.9.9`\r\nOS & Version: Linux\r\nCommit hash : \r\n\r\n#### Expected behaviour\r\nA validator run on Kubernetes (stateless) should be able to restart, import current blocks and join the network.\r\n\r\n#### Actual behaviour\r\n\r\nThe validator node restarted and started syncing blocks and then it panic.\r\n\r\n#### Steps to reproduce the behaviour\r\n````\r\ngeth --nousb \\\r\n   --synmode 'fast' \\\r\n   --unlock '0x.......' \\\r\n   --password password_file.txt \\\r\n   --mine \\\r\n    --miner.gasprice 1 \\\r\n    --miner.threads 2 \\\r\n    --miner.gastarget 1000000000 \\\r\n    --miner.gaslimit 1000000000 \\\r\n   --networkid ...\r\n````\r\n\r\n#### Backtrace\r\n\r\n````\r\npanic: runtime error: invalid memory address or nil pointer dereference\r\n[signal SIGSEGV: segmentation violation code=0x1 addr=0x0 pc=0x530bce]\r\n\r\ngoroutine 70 [running]:\r\nmath/big.(*Int).Cmp(0xc001397958, 0x0, 0x49c6be13f88c3fb)\r\n        /usr/local/go/src/math/big/int.go:326 +0x2e\r\ngithub.com/ethereum/go-ethereum/eth.(*ProtocolManager).handleMsg(0xc000236d20, 0xc0005ca000, 0x0, 0x0)\r\n        /go-ethereum/eth/handler.go:722 +0xd35\r\ngithub.com/ethereum/go-ethereum/eth.(*ProtocolManager).handle(0xc000236d20, 0xc0005ca000, 0x0, 0x0)\r\n        /go-ethereum/eth/handler.go:359 +0x864\r\ngithub.com/ethereum/go-ethereum/eth.(*ProtocolManager).makeProtocol.func1(0xc0005bc060, 0x13ec3a0, 0xc000110dc0, 0x0, 0x0)\r\n        /go-ethereum/eth/handler.go:211 +0x1ee\r\ngithub.com/ethereum/go-ethereum/p2p.(*Peer).startProtocols.func1(0xc000110dc0, 0xc0005bc060, 0x13ec3a0, 0xc000110dc0)\r\n        /go-ethereum/p2p/peer.go:367 +0x66\r\ncreated by github.com/ethereum/go-ethereum/p2p.(*Peer).startProtocols\r\n        /go-ethereum/p2p/peer.go:366 +0x203\r\n````\r\n",
  "closed_by": {
    "login": "karalabe",
    "id": 129561,
    "node_id": "MDQ6VXNlcjEyOTU2MQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/karalabe",
    "html_url": "https://github.com/karalabe",
    "followers_url": "https://api.github.com/users/karalabe/followers",
    "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
    "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
    "organizations_url": "https://api.github.com/users/karalabe/orgs",
    "repos_url": "https://api.github.com/users/karalabe/repos",
    "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
    "received_events_url": "https://api.github.com/users/karalabe/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20614/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20614/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/581278664",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/20614#issuecomment-581278664",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20614",
    "id": 581278664,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU4MTI3ODY2NA==",
    "user": {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-02-03T07:41:26Z",
    "updated_at": "2020-02-03T07:41:26Z",
    "author_association": "MEMBER",
    "body": "This issue could happen after an unclean shutdown (crash), but should be fixed by https://github.com/ethereum/go-ethereum/pull/20287 - which makes sure that we write blockchain data in an atomic way, and should prevent these types of corruptions where we have e.g. the blocks and state but are missing the total difficulty. That PR is included in `1.9.10`. \r\n\r\nNote, though, updating to `1.9.10` will not solve the issue for you -- I would suspect that your best bet is to do a `debug.setHead(...)` to rewind the chaiin a bit, maybe a couple of hundred blocks, until you get to a point where you have the complete data. You might even have to go back a few thousand blocks -- I can't say really :( \r\n\r\n\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/581278664/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/600593762",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/20614#issuecomment-600593762",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20614",
    "id": 600593762,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYwMDU5Mzc2Mg==",
    "user": {
      "login": "karalabe",
      "id": 129561,
      "node_id": "MDQ6VXNlcjEyOTU2MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/karalabe",
      "html_url": "https://github.com/karalabe",
      "followers_url": "https://api.github.com/users/karalabe/followers",
      "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
      "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
      "organizations_url": "https://api.github.com/users/karalabe/orgs",
      "repos_url": "https://api.github.com/users/karalabe/repos",
      "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
      "received_events_url": "https://api.github.com/users/karalabe/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-03-18T12:28:23Z",
    "updated_at": "2020-03-18T12:28:23Z",
    "author_association": "MEMBER",
    "body": "We've just figured out that this is actually a legit bug. Fixing now.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/600593762/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/600593985",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/20614#issuecomment-600593985",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/20614",
    "id": 600593985,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYwMDU5Mzk4NQ==",
    "user": {
      "login": "karalabe",
      "id": 129561,
      "node_id": "MDQ6VXNlcjEyOTU2MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/karalabe",
      "html_url": "https://github.com/karalabe",
      "followers_url": "https://api.github.com/users/karalabe/followers",
      "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
      "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
      "organizations_url": "https://api.github.com/users/karalabe/orgs",
      "repos_url": "https://api.github.com/users/karalabe/repos",
      "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
      "received_events_url": "https://api.github.com/users/karalabe/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-03-18T12:29:02Z",
    "updated_at": "2020-03-18T12:29:02Z",
    "author_association": "MEMBER",
    "body": "https://github.com/ethereum/go-ethereum/issues/20770",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/600593985/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
