{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/16859",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/16859/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/16859/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/16859/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/16859",
  "id": 328538780,
  "node_id": "MDU6SXNzdWUzMjg1Mzg3ODA=",
  "number": 16859,
  "title": "Memory Leak Still Present in TxPool as of 1.8.10",
  "user": {
    "login": "mykolasmith",
    "id": 1483054,
    "node_id": "MDQ6VXNlcjE0ODMwNTQ=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1483054?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mykolasmith",
    "html_url": "https://github.com/mykolasmith",
    "followers_url": "https://api.github.com/users/mykolasmith/followers",
    "following_url": "https://api.github.com/users/mykolasmith/following{/other_user}",
    "gists_url": "https://api.github.com/users/mykolasmith/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mykolasmith/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mykolasmith/subscriptions",
    "organizations_url": "https://api.github.com/users/mykolasmith/orgs",
    "repos_url": "https://api.github.com/users/mykolasmith/repos",
    "events_url": "https://api.github.com/users/mykolasmith/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mykolasmith/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2018-06-01T14:20:07Z",
  "updated_at": "2018-06-06T16:31:54Z",
  "closed_at": "2018-06-05T22:52:58Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "Hi all,\r\n\r\nI know there's been quite a bit of [discussion](https://github.com/ethereum/go-ethereum/issues/16728) on this topic already, and a lot of work has gone into improving performance around the TxPool with recent releases. However, we are still seeing the issue, albeit over a longer time period now. Whereas previously we were running OOM after ~3 hours, our Geth node(s) running the recent 1.8.10 release have displayed similar characteristics over a bit longer time period (~15 hours).\r\n\r\n<img width=\"691\" alt=\"screen shot 2018-06-01 at 9 58 32 am\" src=\"https://user-images.githubusercontent.com/1483054/40844589-5dc207a2-6582-11e8-8360-5a581a54f2aa.png\">\r\n\r\nThis graph shows memory usage. The first downward spike is when we restarted the server after updating to 1.8.10. The most recent downward spike is the process falling over due to OOM.\r\n\r\nIt might be worth noting that we are running Geth as a data provider for contract data, transaction confirmations, wallet balances, etc. for a DAPP communicating with the Ethereum network. This means we (and our users) are constantly querying the JSON RPC API. Not sure if this helps at all, but it's definitely receiving generous throughput on that side of things. Also worth noting that we have private geth nodes in an isolated environment that receive no such traffic that are not afflicted by the memory leak!\r\n\r\nI've attached a dump of our geth logs. As you can see, there appears to be a ton of sleeping/dead goroutines.\r\n[geth-logs.txt](https://github.com/ethereum/go-ethereum/files/2062996/geth-logs.txt)\r\n\r\nLet me know if there's any other information I can provide. Thanks for all the awesome work you guys do!",
  "closed_by": {
    "login": "mykolasmith",
    "id": 1483054,
    "node_id": "MDQ6VXNlcjE0ODMwNTQ=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1483054?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mykolasmith",
    "html_url": "https://github.com/mykolasmith",
    "followers_url": "https://api.github.com/users/mykolasmith/followers",
    "following_url": "https://api.github.com/users/mykolasmith/following{/other_user}",
    "gists_url": "https://api.github.com/users/mykolasmith/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mykolasmith/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mykolasmith/subscriptions",
    "organizations_url": "https://api.github.com/users/mykolasmith/orgs",
    "repos_url": "https://api.github.com/users/mykolasmith/repos",
    "events_url": "https://api.github.com/users/mykolasmith/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mykolasmith/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/16859/reactions",
    "total_count": 1,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 1,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/16859/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/394011803",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/16859#issuecomment-394011803",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/16859",
    "id": 394011803,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM5NDAxMTgwMw==",
    "user": {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-06-01T21:19:01Z",
    "updated_at": "2018-06-01T21:19:01Z",
    "author_association": "MEMBER",
    "body": "Thanks for providing good logs, I took a quick peak and it's obviously blocked goroutines. Finding the cause for the blockage will require a deeper look, but we're on it. ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/394011803/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/394025300",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/16859#issuecomment-394025300",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/16859",
    "id": 394025300,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM5NDAyNTMwMA==",
    "user": {
      "login": "mykolasmith",
      "id": 1483054,
      "node_id": "MDQ6VXNlcjE0ODMwNTQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1483054?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mykolasmith",
      "html_url": "https://github.com/mykolasmith",
      "followers_url": "https://api.github.com/users/mykolasmith/followers",
      "following_url": "https://api.github.com/users/mykolasmith/following{/other_user}",
      "gists_url": "https://api.github.com/users/mykolasmith/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mykolasmith/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mykolasmith/subscriptions",
      "organizations_url": "https://api.github.com/users/mykolasmith/orgs",
      "repos_url": "https://api.github.com/users/mykolasmith/repos",
      "events_url": "https://api.github.com/users/mykolasmith/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mykolasmith/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-06-01T22:24:54Z",
    "updated_at": "2018-06-01T22:24:54Z",
    "author_association": "NONE",
    "body": "Also FWIW, I dropped the max peers on our nodes from 256 to 50 and memory usage has barely crept up over the last 4 hours. Wasn't sure whether the issue is related to peer communication or RPC calls, but this seems to indicate the former.\r\n\r\n![screen shot 2018-06-01 at 6 23 11 pm](https://user-images.githubusercontent.com/1483054/40865911-ebe680a8-65c8-11e8-8030-a1422914ccde.png)",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/394025300/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/394044544",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/16859#issuecomment-394044544",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/16859",
    "id": 394044544,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM5NDA0NDU0NA==",
    "user": {
      "login": "ryanschneider",
      "id": 53520,
      "node_id": "MDQ6VXNlcjUzNTIw",
      "avatar_url": "https://avatars.githubusercontent.com/u/53520?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanschneider",
      "html_url": "https://github.com/ryanschneider",
      "followers_url": "https://api.github.com/users/ryanschneider/followers",
      "following_url": "https://api.github.com/users/ryanschneider/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanschneider/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanschneider/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanschneider/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanschneider/orgs",
      "repos_url": "https://api.github.com/users/ryanschneider/repos",
      "events_url": "https://api.github.com/users/ryanschneider/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanschneider/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-06-02T00:59:56Z",
    "updated_at": "2018-06-02T00:59:56Z",
    "author_association": "CONTRIBUTOR",
    "body": "The large number of hung goroutines in `promoteExecutables` trying to call `Feed.Send` have been discussed in this PR:\r\n\r\nhttps://github.com/ethereum/go-ethereum/pull/16673\r\n\r\nHowever, there's also a fair amount of goroutines like this:\r\n\r\n```\r\n goroutine 23412 [IO wait, 1023 minutes]:\r\n internal/poll.runtime_pollWait(0x7f4f1c032058, 0x72, 0xc47ec71a68)\r\n         /usr/local/go/src/runtime/netpoll.go:173 +0x57\r\n internal/poll.(*pollDesc).wait(0xc4976ffa18, 0x72, 0xffffffffffffff00, 0x10935c0, 0x1799ca8)\r\n         /usr/local/go/src/internal/poll/fd_poll_runtime.go:85 +0x9b\r\n internal/poll.(*pollDesc).waitRead(0xc4976ffa18, 0xc49e16c000, 0x1000, 0x1000)\r\n         /usr/local/go/src/internal/poll/fd_poll_runtime.go:90 +0x3d\r\n internal/poll.(*FD).Read(0xc4976ffa00, 0xc49e16c000, 0x1000, 0x1000, 0x0, 0x0, 0x0)\r\n         /usr/local/go/src/internal/poll/fd_unix.go:157 +0x17d\r\n net.(*netFD).Read(0xc4976ffa00, 0xc49e16c000, 0x1000, 0x1000, 0xc47ec71b78, 0x7cde0a, 0xc460ed5268)\r\n         /usr/local/go/src/net/fd_unix.go:202 +0x4f\r\n net.(*conn).Read(0xc49251e520, 0xc49e16c000, 0x1000, 0x1000, 0x0, 0x0, 0x0)\r\n         /usr/local/go/src/net/net.go:176 +0x6a\r\n net/http.(*connReader).Read(0xc460ed5260, 0xc49e16c000, 0x1000, 0x1000, 0x0, 0x0, 0x0)\r\n         /usr/local/go/src/net/http/server.go:764 +0xf8\r\n bufio.(*Reader).fill(0xc48095d5c0)\r\n         /usr/local/go/src/bufio/bufio.go:100 +0x11e\r\n bufio.(*Reader).Peek(0xc48095d5c0, 0x4, 0x0, 0x0, 0x0, 0x0, 0xc47ec71ce0)\r\n         /usr/local/go/src/bufio/bufio.go:132 +0x3a\r\n net/http.(*conn).readRequest(0xc4aacefe00, 0x109c6e0, 0xc433117b40, 0x0, 0x0, 0x0)\r\n         /usr/local/go/src/net/http/server.go:941 +0xb5f\r\n net/http.(*conn).serve(0xc4aacefe00, 0x109c6e0, 0xc433117b40)\r\n         /usr/local/go/src/net/http/server.go:1768 +0x4dc\r\n created by net/http.(*Server).Serve\r\n         /usr/local/go/src/net/http/server.go:2795 +0x27b\r\n```\r\n\r\nI think the issue is that the HTTP server (presumably the RPC server in `rpc/http.go`) isn't setting `Read|Write|IdleTimeout` values:\r\n\r\nhttps://github.com/ethereum/go-ethereum/blob/2ad511ce0912194e9f30010f01fc338c585f8634/rpc/http.go#L168\r\n\r\nSee [this page](https://blog.cloudflare.com/exposing-go-on-the-internet/) for a good description of those values (and why they are important).",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/394044544/reactions",
      "total_count": 4,
      "+1": 3,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 1,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/394885643",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/16859#issuecomment-394885643",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/16859",
    "id": 394885643,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM5NDg4NTY0Mw==",
    "user": {
      "login": "mykolasmith",
      "id": 1483054,
      "node_id": "MDQ6VXNlcjE0ODMwNTQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1483054?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mykolasmith",
      "html_url": "https://github.com/mykolasmith",
      "followers_url": "https://api.github.com/users/mykolasmith/followers",
      "following_url": "https://api.github.com/users/mykolasmith/following{/other_user}",
      "gists_url": "https://api.github.com/users/mykolasmith/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mykolasmith/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mykolasmith/subscriptions",
      "organizations_url": "https://api.github.com/users/mykolasmith/orgs",
      "repos_url": "https://api.github.com/users/mykolasmith/repos",
      "events_url": "https://api.github.com/users/mykolasmith/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mykolasmith/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-06-05T22:52:58Z",
    "updated_at": "2018-06-05T22:52:58Z",
    "author_association": "NONE",
    "body": "Looks fixed as of https://github.com/ethereum/go-ethereum/pull/16880",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/394885643/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/395132252",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/16859#issuecomment-395132252",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/16859",
    "id": 395132252,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM5NTEzMjI1Mg==",
    "user": {
      "login": "ryanschneider",
      "id": 53520,
      "node_id": "MDQ6VXNlcjUzNTIw",
      "avatar_url": "https://avatars.githubusercontent.com/u/53520?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanschneider",
      "html_url": "https://github.com/ryanschneider",
      "followers_url": "https://api.github.com/users/ryanschneider/followers",
      "following_url": "https://api.github.com/users/ryanschneider/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanschneider/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanschneider/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanschneider/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanschneider/orgs",
      "repos_url": "https://api.github.com/users/ryanschneider/repos",
      "events_url": "https://api.github.com/users/ryanschneider/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanschneider/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-06-06T16:31:54Z",
    "updated_at": "2018-06-06T16:31:54Z",
    "author_association": "CONTRIBUTOR",
    "body": "FWIW #16880 fixes the slow connections, but not the large number of `promoteExecutable` goroutines in your dump.  I think it's fine to keep this closed though.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/395132252/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
