{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/269",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/269/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/269/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/269/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/269",
  "id": 55148929,
  "node_id": "MDU6SXNzdWU1NTE0ODkyOQ==",
  "number": 269,
  "title": "crypto.Sign panics for some inputs",
  "user": {
    "login": "fjl",
    "id": 6915,
    "node_id": "MDQ6VXNlcjY5MTU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6915?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/fjl",
    "html_url": "https://github.com/fjl",
    "followers_url": "https://api.github.com/users/fjl/followers",
    "following_url": "https://api.github.com/users/fjl/following{/other_user}",
    "gists_url": "https://api.github.com/users/fjl/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/fjl/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/fjl/subscriptions",
    "organizations_url": "https://api.github.com/users/fjl/orgs",
    "repos_url": "https://api.github.com/users/fjl/repos",
    "events_url": "https://api.github.com/users/fjl/events{/privacy}",
    "received_events_url": "https://api.github.com/users/fjl/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2015-01-22T12:44:31Z",
  "updated_at": "2015-01-22T19:59:33Z",
  "closed_at": "2015-01-22T19:58:57Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "There are two problems, both of which are [related to this change](https://github.com/obscuren/secp256k1-go/commit/7a58ba75df031897c4cb94bb3b7792959fc06c22#diff-6aebad42932d2e784d6882a9ac024599L106). Note that the change is not mentioned in the commit message.\n\nOne problem is that package crypto uses `privateKey.D.Bytes()` to marshal the private key. The value returned by `Bytes` will not have length 32 in all cases because `math/big` returns the minimum number of bytes required to hold the number. \n\nI think we should pad the key with zeroes.\n\nThe other problem is that the data being signed cannot be larger than 32 bytes, because\n`nonce` would be accessed with an index > 31.\nIf it is smaller than 32 bytes, the remaining bytes of the nonce will be the rest of the private key.\n\nThe parameter for the data is called `hash` in package crypto. I think we should document that the value\nfor this parameter must have length 32 **and check that it does in the Sign function**.\n\nCrash:\n\n``` text\nPanic at i=534.\nKey: (len=31) [139 238 11 176 202 152 178 4 145 65 239 166 32 93 76 229 172 233 51 179 54 143 168 210 31 183 235 209 38 188 56]\nruntime error: index out of range\ngoroutine 1 [running]:\nmain.funcÂ·001()\n    /Users/fjl/develop/eth/src/github.com/ethereum/go-ethereum/ktest.go:31 +0x3d2\ngithub.com/obscuren/secp256k1-go.Sign(0xc20809deb8, 0x20, 0x20, 0xc20801fc01, 0x1f, 0x1f, 0x0, 0x0, 0x0, 0x0, ...)\n    /Users/fjl/develop/eth/src/github.com/obscuren/secp256k1-go/secp256.go:130 +0x492\ngithub.com/ethereum/go-ethereum/crypto.Sign(0xc20809deb8, 0x20, 0x20, 0xc208097770, 0x0, 0x0, 0x0, 0x0, 0x0)\n    /Users/fjl/develop/eth/src/github.com/ethereum/go-ethereum/crypto/crypto.go:108 +0xc0\nmain.main()\n    /Users/fjl/develop/eth/src/github.com/ethereum/go-ethereum/ktest.go:42 +0x306\nexit status 1\n```\n\nRepro tool:\n\n``` go\nimport (\n    \"crypto/ecdsa\"\n    \"crypto/rand\"\n    \"fmt\"\n    \"os\"\n    \"runtime\"\n\n    \"github.com/ethereum/go-ethereum/crypto\"\n)\n\nfunc main() {\n    var (\n        hash = make([]byte, 32)\n        k    *ecdsa.PrivateKey\n        i    int\n        err  error\n    )\n    defer func() {\n        if err := recover(); err != nil {\n            fmt.Printf(\"Panic at i=%d.\\n\", i)\n            if k != nil {\n                enc := k.D.Bytes() // this is what package crypto does to marshal the key\n                fmt.Printf(\"Key: (len=%d) %v\\n\", len(enc), enc)\n            }\n            fmt.Println(err)\n            sb := make([]byte, 1000)\n            fmt.Print(string(sb[:runtime.Stack(sb, false)]))\n            os.Exit(1)\n        }\n    }()\n\n    for ; i < 10000; i++ {\n        k, err = ecdsa.GenerateKey(crypto.S256(), rand.Reader)\n        if err != nil {\n            fmt.Println(\"cannot generate key:\", err)\n            os.Exit(1)\n        }\n        crypto.Sign(hash, k)\n    }\n}\n```\n",
  "closed_by": {
    "login": "obscuren",
    "id": 6264126,
    "node_id": "MDQ6VXNlcjYyNjQxMjY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6264126?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/obscuren",
    "html_url": "https://github.com/obscuren",
    "followers_url": "https://api.github.com/users/obscuren/followers",
    "following_url": "https://api.github.com/users/obscuren/following{/other_user}",
    "gists_url": "https://api.github.com/users/obscuren/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/obscuren/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/obscuren/subscriptions",
    "organizations_url": "https://api.github.com/users/obscuren/orgs",
    "repos_url": "https://api.github.com/users/obscuren/repos",
    "events_url": "https://api.github.com/users/obscuren/events{/privacy}",
    "received_events_url": "https://api.github.com/users/obscuren/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/269/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/269/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/71056276",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/269#issuecomment-71056276",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/269",
    "id": 71056276,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcxMDU2Mjc2",
    "user": {
      "login": "obscuren",
      "id": 6264126,
      "node_id": "MDQ6VXNlcjYyNjQxMjY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6264126?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/obscuren",
      "html_url": "https://github.com/obscuren",
      "followers_url": "https://api.github.com/users/obscuren/followers",
      "following_url": "https://api.github.com/users/obscuren/following{/other_user}",
      "gists_url": "https://api.github.com/users/obscuren/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/obscuren/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/obscuren/subscriptions",
      "organizations_url": "https://api.github.com/users/obscuren/orgs",
      "repos_url": "https://api.github.com/users/obscuren/repos",
      "events_url": "https://api.github.com/users/obscuren/events{/privacy}",
      "received_events_url": "https://api.github.com/users/obscuren/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2015-01-22T17:06:19Z",
    "updated_at": "2015-01-22T17:08:22Z",
    "author_association": "MEMBER",
    "body": "Input hashes for secp256k1 are _always_ 32 bytes. No more no less. It's required by secp it self. To be more specific, the input is expected to be the 32 l hash of more complex data (in our case, for transactions, the hash of the tx). The reason why it remained `unspecified` is because signing is pretty specific by itself for transactions. A transaction's `Hash` is computed using `sha3` which is always 32 bytes. \n\nI'll put a length check in sign.\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/71056276/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/71087762",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/269#issuecomment-71087762",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/269",
    "id": 71087762,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcxMDg3NzYy",
    "user": {
      "login": "obscuren",
      "id": 6264126,
      "node_id": "MDQ6VXNlcjYyNjQxMjY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6264126?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/obscuren",
      "html_url": "https://github.com/obscuren",
      "followers_url": "https://api.github.com/users/obscuren/followers",
      "following_url": "https://api.github.com/users/obscuren/following{/other_user}",
      "gists_url": "https://api.github.com/users/obscuren/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/obscuren/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/obscuren/subscriptions",
      "organizations_url": "https://api.github.com/users/obscuren/orgs",
      "repos_url": "https://api.github.com/users/obscuren/repos",
      "events_url": "https://api.github.com/users/obscuren/events{/privacy}",
      "received_events_url": "https://api.github.com/users/obscuren/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2015-01-22T19:59:33Z",
    "updated_at": "2015-01-22T19:59:33Z",
    "author_association": "MEMBER",
    "body": "https://github.com/ethereum/go-ethereum/commit/0dfe5113709d2981ef2ec8885d831a38cf2e4f91\nhttps://github.com/ethereum/go-ethereum/commit/d4cc2d3503ce7497ef0cb39456a332b25e0999b9\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/71087762/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
