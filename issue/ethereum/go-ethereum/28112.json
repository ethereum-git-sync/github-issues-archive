{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28112",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28112/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28112/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28112/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/28112",
  "id": 1895069763,
  "node_id": "I_kwDOAOvK985w9HhD",
  "number": 28112,
  "title": "Inferring database scheme via `readonly` fails for an empty `ancient` database",
  "user": {
    "login": "maoueh",
    "id": 123014,
    "node_id": "MDQ6VXNlcjEyMzAxNA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/123014?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/maoueh",
    "html_url": "https://github.com/maoueh",
    "followers_url": "https://api.github.com/users/maoueh/followers",
    "following_url": "https://api.github.com/users/maoueh/following{/other_user}",
    "gists_url": "https://api.github.com/users/maoueh/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/maoueh/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/maoueh/subscriptions",
    "organizations_url": "https://api.github.com/users/maoueh/orgs",
    "repos_url": "https://api.github.com/users/maoueh/repos",
    "events_url": "https://api.github.com/users/maoueh/events{/privacy}",
    "received_events_url": "https://api.github.com/users/maoueh/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 72233650,
      "node_id": "MDU6TGFiZWw3MjIzMzY1MA==",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/type:bug",
      "name": "type:bug",
      "color": "FF5E5E",
      "default": false,
      "description": ""
    },
    {
      "id": 1132689577,
      "node_id": "MDU6TGFiZWwxMTMyNjg5NTc3",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/status:triage",
      "name": "status:triage",
      "color": "6be514",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2023-09-13T18:48:45Z",
  "updated_at": "2023-09-14T02:04:02Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "#### System information\r\n\r\nGeth version: `geth version 1.13.0`\r\nCL client & version: Not important\r\nOS & Version: OSX\r\nCommit hash: 8d38b1fe62950e8675795abf63b7c978415ab7ba\r\n\r\n#### Expected behaviour\r\n\r\nNo crash\r\n\r\n#### Actual behaviour\r\n\r\nCrash with:\r\n\r\n```\r\nINFO [09-13|14:27:01.772] Maximum peer count                       ETH=50 LES=0 total=50\r\nINFO [09-13|14:27:01.776] Using leveldb as the backing database\r\nINFO [09-13|14:27:01.776] Allocated cache and file handles         database=/app/geth/chaindata cache=512.00MiB handles=5120 readonly=true\r\nINFO [09-13|14:27:01.778] Using LevelDB as the backing database\r\nChain metadata\r\n  databaseVersion: <nil>\r\n  headBlockHash: 0xc5902001cfab2bfb6cbfb5e752ab11be44af47d50dbd777a02f7098c169e780b\r\n  headFastBlockHash: 0xc5902001cfab2bfb6cbfb5e752ab11be44af47d50dbd777a02f7098c169e780b\r\n  headHeaderHash: 0xc5902001cfab2bfb6cbfb5e752ab11be44af47d50dbd777a02f7098c169e780b\r\n  lastPivotNumber: <nil>\r\n  len(snapshotSyncStatus): 0 bytes\r\n  snapshotDisabled: false\r\n  snapshotJournal: 0 bytes\r\n  snapshotRecoveryNumber: <nil>\r\n  snapshotRoot: 0x0000000000000000000000000000000000000000000000000000000000000000\r\n  txIndexTail: <nil>\r\n  fastTxLookupLimit: <nil>\r\n\r\nFatal: Could not open database: open /app/geth/chaindata/ancient/chain/headers.cidx: no such file or directory\r\n```\r\n\r\n#### Steps to reproduce the behaviour\r\n\r\nRight now I have a data dir that looks like this:\r\n\r\n```\r\n├── LOCK\r\n├── chaindata\r\n│   ├── 000001.log\r\n│   ├── CURRENT\r\n│   ├── LOCK\r\n│   ├── LOG\r\n│   ├── MANIFEST-000000\r\n│   └── ancient\r\n│       └── chain\r\n│           └── FLOCK\r\n├── lightchaindata\r\n│   ├── 000001.log\r\n│   ├── CURRENT\r\n│   ├── LOCK\r\n│   ├── LOG\r\n│   └── MANIFEST-000000\r\n└── nodekey\r\n```\r\n\r\nNote that my `ancient` folder contains no tables, only `FLOCK`. On bootstrap of `geth`, there is the inference of the database scheme, which is done in `readonly` mode:\r\n\r\n```go\r\n\t// Parse state scheme, abort the process if it's not compatible.\r\n\tchaindb := tryMakeReadOnlyDatabase(ctx, stack)\r\n```\r\n\r\nThis will reach a some point the `newTable` inside `freezer_table.go` file which does this when `read-only`:\r\n\r\n```\r\n\t\t// Will fail if table index file or meta file is not existent\r\n\t\tindex, err = openFreezerFileForReadOnly(filepath.Join(path, idxName))\r\n\t\tif err != nil {\r\n\t\t\treturn nil, err\r\n\t\t}\r\n\t\tmeta, err = openFreezerFileForReadOnly(filepath.Join(path, fmt.Sprintf(\"%s.meta\", name)))\r\n\t\tif err != nil {\r\n\t\t\treturn nil, err\r\n\t\t}\r\n```\r\n\r\nSo it crashes there because the ancient tables do not exists.\r\n\r\nI must admit this geth's data dir was created a long time ago using I think `geth 1.9.23`. Not sure if it's normal that I have no ancient tables but I think it's actually valid. The write mode simply creates files if they do not exist, so I think it might be possible to have such case where no ancient tables is present.\r\n\r\nNot sure if there is an easy fix here, if the ancient is not required to infer the scheme, maybe it could be refactored to only deal with the \"current\" data set and leave ancient out of the equation.\r\n\r\nAnother thing could be to update `newTable` in `freezer_table.go`to better deal with inexistent tables in readonly mode. The `Freezer.tables` map could then have no tables (or less tables). I'm not sure of the implications of such thing.",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28112/reactions",
    "total_count": 1,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 1,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28112/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1718162816",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/28112#issuecomment-1718162816",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28112",
    "id": 1718162816,
    "node_id": "IC_kwDOAOvK985maRWA",
    "user": {
      "login": "maoueh",
      "id": 123014,
      "node_id": "MDQ6VXNlcjEyMzAxNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/123014?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/maoueh",
      "html_url": "https://github.com/maoueh",
      "followers_url": "https://api.github.com/users/maoueh/followers",
      "following_url": "https://api.github.com/users/maoueh/following{/other_user}",
      "gists_url": "https://api.github.com/users/maoueh/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/maoueh/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/maoueh/subscriptions",
      "organizations_url": "https://api.github.com/users/maoueh/orgs",
      "repos_url": "https://api.github.com/users/maoueh/repos",
      "events_url": "https://api.github.com/users/maoueh/events{/privacy}",
      "received_events_url": "https://api.github.com/users/maoueh/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-09-13T19:01:27Z",
    "updated_at": "2023-09-13T19:02:22Z",
    "author_association": "NONE",
    "body": "I've workaround for now adding the missing tables manually to my \"cached\" data dir. Just tested `geth init` also and it produces those ancient tables, so might not warrant a fix actually.\r\n\r\nI'll let you guys decide, feel free to close if it's a won't fix. I now think this issue affects almost no one. ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1718162816/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 1,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1718167558",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/28112#issuecomment-1718167558",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28112",
    "id": 1718167558,
    "node_id": "IC_kwDOAOvK985maSgG",
    "user": {
      "login": "maoueh",
      "id": 123014,
      "node_id": "MDQ6VXNlcjEyMzAxNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/123014?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/maoueh",
      "html_url": "https://github.com/maoueh",
      "followers_url": "https://api.github.com/users/maoueh/followers",
      "following_url": "https://api.github.com/users/maoueh/following{/other_user}",
      "gists_url": "https://api.github.com/users/maoueh/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/maoueh/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/maoueh/subscriptions",
      "organizations_url": "https://api.github.com/users/maoueh/orgs",
      "repos_url": "https://api.github.com/users/maoueh/repos",
      "events_url": "https://api.github.com/users/maoueh/events{/privacy}",
      "received_events_url": "https://api.github.com/users/maoueh/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-09-13T19:05:20Z",
    "updated_at": "2023-09-13T19:05:20Z",
    "author_association": "NONE",
    "body": "This would actually happen also if someone deletes its `ancient` folder, not sure if this is common or not.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1718167558/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 1,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1718171167",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/28112#issuecomment-1718171167",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28112",
    "id": 1718171167,
    "node_id": "IC_kwDOAOvK985maTYf",
    "user": {
      "login": "maoueh",
      "id": 123014,
      "node_id": "MDQ6VXNlcjEyMzAxNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/123014?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/maoueh",
      "html_url": "https://github.com/maoueh",
      "followers_url": "https://api.github.com/users/maoueh/followers",
      "following_url": "https://api.github.com/users/maoueh/following{/other_user}",
      "gists_url": "https://api.github.com/users/maoueh/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/maoueh/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/maoueh/subscriptions",
      "organizations_url": "https://api.github.com/users/maoueh/orgs",
      "repos_url": "https://api.github.com/users/maoueh/repos",
      "events_url": "https://api.github.com/users/maoueh/events{/privacy}",
      "received_events_url": "https://api.github.com/users/maoueh/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-09-13T19:08:19Z",
    "updated_at": "2023-09-13T19:08:19Z",
    "author_association": "NONE",
    "body": "Also to add more info, if any expected files is missing, it will lead to such error. I had another test case where the ancient had tables but was missing a few `xxx.meta` files, it led to the same issue.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1718171167/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 1,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1718635261",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/28112#issuecomment-1718635261",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/28112",
    "id": 1718635261,
    "node_id": "IC_kwDOAOvK985mcEr9",
    "user": {
      "login": "rjl493456442",
      "id": 5959481,
      "node_id": "MDQ6VXNlcjU5NTk0ODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5959481?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rjl493456442",
      "html_url": "https://github.com/rjl493456442",
      "followers_url": "https://api.github.com/users/rjl493456442/followers",
      "following_url": "https://api.github.com/users/rjl493456442/following{/other_user}",
      "gists_url": "https://api.github.com/users/rjl493456442/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rjl493456442/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rjl493456442/subscriptions",
      "organizations_url": "https://api.github.com/users/rjl493456442/orgs",
      "repos_url": "https://api.github.com/users/rjl493456442/repos",
      "events_url": "https://api.github.com/users/rjl493456442/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rjl493456442/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-09-14T02:03:54Z",
    "updated_at": "2023-09-14T02:03:54Z",
    "author_association": "MEMBER",
    "body": "I can reproduce this issue, and it's quite an unusual scenario where the database is considered to exist while the 'ancient' data is missing.\r\n\r\nIn fact, if someone unintentionally deletes the 'ancient' folder, it can make geth inoperable in most cases due to an incomplete chain segment, even without this specific database error. The only exception is if the 'ancient' folder was originally empty, in which case deleting it wouldn't result in the loss of any chain segments. So, it raises the question of whether it's worthwhile to address this particular case.\"\r\n\r\nWill discuss with team",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1718635261/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
