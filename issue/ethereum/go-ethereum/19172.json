{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19172",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19172/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19172/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19172/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/19172",
  "id": 414647596,
  "node_id": "MDU6SXNzdWU0MTQ2NDc1OTY=",
  "number": 19172,
  "title": "bug: --datadir doesn't respect alternate chain dir organization",
  "user": {
    "login": "whilei",
    "id": 10228550,
    "node_id": "MDQ6VXNlcjEwMjI4NTUw",
    "avatar_url": "https://avatars.githubusercontent.com/u/10228550?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/whilei",
    "html_url": "https://github.com/whilei",
    "followers_url": "https://api.github.com/users/whilei/followers",
    "following_url": "https://api.github.com/users/whilei/following{/other_user}",
    "gists_url": "https://api.github.com/users/whilei/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/whilei/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/whilei/subscriptions",
    "organizations_url": "https://api.github.com/users/whilei/orgs",
    "repos_url": "https://api.github.com/users/whilei/repos",
    "events_url": "https://api.github.com/users/whilei/events{/privacy}",
    "received_events_url": "https://api.github.com/users/whilei/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 6,
  "created_at": "2019-02-26T14:44:44Z",
  "updated_at": "2020-08-27T09:10:40Z",
  "closed_at": "2020-04-16T08:39:34Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "#### OS and program version info\r\n\r\n- OS: Linux 4.17.4-041704-generic GNU/Linux\r\n- Current working directory: /home/ia/go/src/github.com/ethereum/go-ethereum\r\n- Git commit: 6d652ce1b7efe38f1f8ca8c60b1627e35ac4e0bd\r\n- `./build/bin/geth version`:\r\n\r\n```\r\nGeth\r\nVersion: 1.9.0-unstable\r\nArchitecture: amd64\r\nProtocol Versions: [63 62]\r\nNetwork Id: 1\r\nGo Version: go1.11.5\r\nOperating System: linux\r\nGOPATH=/home/ia/go\r\nGOROOT=/home/ia/go1.11.5.linux-amd64/go\r\n```\r\n\r\n\r\n#### Reproduce\r\n\r\n##### Setup\r\n\r\n```\r\n+ [[ -f ./build/bin/geth ]]\r\n+ mv ./build/bin/geth ./build/bin/geth.bak\r\n+ make\r\nbuild/env.sh go run build/ci.go install ./cmd/geth\r\n>>> /home/ia/go1.11.5.linux-amd64/go/bin/go install -v ./cmd/geth\r\nDone building.\r\nRun \"/home/ia/go/src/github.com/ethereum/go-ethereum/build/bin/geth\" to launch geth.\r\n\r\n```\r\n\r\n##### Run\r\n\r\n```\r\n+ ./build/bin/geth --rinkeby --port 30333 --exec 'admin.datadir;' console\r\n\"/home/ia/.ethereum/rinkeby\"\r\n+ tree -L 2 /home/ia/.ethereum\r\n/home/ia/.ethereum\r\n└── rinkeby\r\n    ├── geth\r\n    ├── history\r\n    └── keystore\r\n\r\n3 directories, 1 file\r\n+ ./build/bin/geth --rinkeby --datadir ./foo --port 30333 --exec 'admin.datadir;' console\r\n\"/home/ia/go/src/github.com/ethereum/go-ethereum/foo\"\r\n+ tree -L 2 ./foo\r\n./foo\r\n├── geth\r\n│   ├── chaindata\r\n│   ├── LOCK\r\n│   ├── nodekey\r\n│   ├── nodes\r\n│   └── transactions.rlp\r\n├── keystore\r\n└── rinkeby\r\n    └── history\r\n\r\n5 directories, 4 files\r\n\r\n```\r\n\r\n##### Teardown\r\n\r\n```\r\n++ [[ -f ./build/bin/geth.bak ]]\r\n++ mv ./build/bin/geth.bak ./build/bin/geth\r\n++ rm -rf ./foo\r\n```\r\n\r\n#### Actual result\r\n```\r\n+ ./build/bin/geth --rinkeby --datadir ./foo --port 30333 --exec 'admin.datadir;' console\r\n\"/home/ia/go/src/github.com/ethereum/go-ethereum/foo\"\r\n```\r\n\r\n#### Expected result\r\n\r\n```\r\n+ ./build/bin/geth --rinkeby --datadir ./foo --port 30333 --exec 'admin.datadir;' console\r\n\"/home/ia/go/src/github.com/ethereum/go-ethereum/foo/rinkeby\"\r\n```\r\n",
  "closed_by": {
    "login": "holiman",
    "id": 142290,
    "node_id": "MDQ6VXNlcjE0MjI5MA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/holiman",
    "html_url": "https://github.com/holiman",
    "followers_url": "https://api.github.com/users/holiman/followers",
    "following_url": "https://api.github.com/users/holiman/following{/other_user}",
    "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
    "organizations_url": "https://api.github.com/users/holiman/orgs",
    "repos_url": "https://api.github.com/users/holiman/repos",
    "events_url": "https://api.github.com/users/holiman/events{/privacy}",
    "received_events_url": "https://api.github.com/users/holiman/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19172/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19172/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/467833277",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/19172#issuecomment-467833277",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19172",
    "id": 467833277,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ2NzgzMzI3Nw==",
    "user": {
      "login": "fjl",
      "id": 6915,
      "node_id": "MDQ6VXNlcjY5MTU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6915?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjl",
      "html_url": "https://github.com/fjl",
      "followers_url": "https://api.github.com/users/fjl/followers",
      "following_url": "https://api.github.com/users/fjl/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjl/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjl/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjl/subscriptions",
      "organizations_url": "https://api.github.com/users/fjl/orgs",
      "repos_url": "https://api.github.com/users/fjl/repos",
      "events_url": "https://api.github.com/users/fjl/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjl/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-02-27T11:51:40Z",
    "updated_at": "2019-02-27T11:51:40Z",
    "author_association": "MEMBER",
    "body": "The behavior you're seeing is intentional, but I can understand why it may seem confusing. Let me explain how we ended up with this:\r\n\r\nIf you are using `--datadir`, geth will place any files in `<datadir>/geth`. If you are using multiple chains, it is best to use a separate data directory for each chain.\r\n\r\nIf you are not using `--datadir`, a default location is chosen based on the chain flags and the operating system. At some point in git history, we chose to make the default directory for non-mainnet chains a subdirectory of the mainnet location. That was a silly idea, but we've been using this scheme for a long time and nobody ever complained about it.\r\n\r\nUnsure what to do now. We could fix it, for OCD's sake, by choosing a default location outside of the mainnet datadir for non-mainnet chains. Some amount of backwards-compatibility code would be required because people who aren't using `--datadir` expect geth to find their keystore and block database if they previously synced it.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/467833277/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/468079980",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/19172#issuecomment-468079980",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19172",
    "id": 468079980,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ2ODA3OTk4MA==",
    "user": {
      "login": "whilei",
      "id": 10228550,
      "node_id": "MDQ6VXNlcjEwMjI4NTUw",
      "avatar_url": "https://avatars.githubusercontent.com/u/10228550?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/whilei",
      "html_url": "https://github.com/whilei",
      "followers_url": "https://api.github.com/users/whilei/followers",
      "following_url": "https://api.github.com/users/whilei/following{/other_user}",
      "gists_url": "https://api.github.com/users/whilei/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/whilei/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/whilei/subscriptions",
      "organizations_url": "https://api.github.com/users/whilei/orgs",
      "repos_url": "https://api.github.com/users/whilei/repos",
      "events_url": "https://api.github.com/users/whilei/events{/privacy}",
      "received_events_url": "https://api.github.com/users/whilei/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-02-28T00:00:18Z",
    "updated_at": "2019-03-07T14:25:04Z",
    "author_association": "NONE",
    "body": "Gotcha, thanks for the background. \r\n\r\nSo if I'm understanding correctly, the \"weird\" part of the behavior is actually that `~/.ethereum/rinkeby` is the default, instead of, say, `~/.rinkeby`. Although with respect, I'm not sure I would call the issue/fix OCD-driven, since the meaning of 'datadir' ~can~ does change arbitrarily and without documentation, which for a user-facing flag that's second from the top of in the list of\r\n\r\n```\r\nETHEREUM OPTIONS:                                                                                               \r\n  --config value                  TOML configuration file                                              \r\n  --datadir \"/home/ia/.ethereum\"  Data directory for the databases and keystore                 \r\n  --keystore                      Directory for the keystore (default = inside the datadir)\r\n```\r\n\r\nseems like an important thing to have predictable and consistent. Agreed that backwards compatibility is important to keep, but as I've suggested, 'forwards compatibility' is important too; I found this bug because I nearly nuked 200gb of  full archive sync thinking that it was somehow scrap development data because it wasn't where I expected it to be.\r\n\r\nI agree that nested `<datadir>/<chaindatadir>` is awkward. It seems there are two paths toward a solve:\r\n\r\n1. alt chains get their own datadir by default, eg. `~/.rinkeby`\r\n2. alt chains get consistent nesting in `--datadir`, whether that value is default or not\r\n\r\nBoth options will need some, probably comparable amount, of backwards-friendly migration logic.\r\n\r\nJust for sake of a touchpoint w/r/t backwards datadir compat, here's a place where this kind of logic is handled in the code for earlier \"datadir migrations\". https://github.com/ethereum/go-ethereum/blob/master/node/config.go#L319-L331\r\n\r\n---\r\n\r\nThere's a small further nitpick noticeable here with the console `history` files, too:\r\n\r\n```\r\n./foo\r\n├── geth\r\n│   ├── chaindata\r\n│   ├── LOCK\r\n│   ├── nodekey\r\n│   ├── nodes\r\n│   └── transactions.rlp\r\n├── keystore\r\n└── rinkeby\r\n    └── history\r\n```\r\n\r\nto be consistent (even against the \"unexpected\" custom datadir/chaindir behavior) I think it should be:\r\n\r\n```\r\n./foo\r\n├── geth\r\n│   ├── chaindata\r\n│   ├── LOCK\r\n│   ├── nodekey\r\n│   ├── nodes\r\n│   └── transactions.rlp\r\n│   └── history\r\n├── keystore\r\n    \r\n```\r\n\r\nMaybe this is worth spinning off into its own issue?\r\n\r\n\r\n\r\n\r\n   ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/468079980/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/470174310",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/19172#issuecomment-470174310",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19172",
    "id": 470174310,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ3MDE3NDMxMA==",
    "user": {
      "login": "fjl",
      "id": 6915,
      "node_id": "MDQ6VXNlcjY5MTU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6915?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjl",
      "html_url": "https://github.com/fjl",
      "followers_url": "https://api.github.com/users/fjl/followers",
      "following_url": "https://api.github.com/users/fjl/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjl/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjl/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjl/subscriptions",
      "organizations_url": "https://api.github.com/users/fjl/orgs",
      "repos_url": "https://api.github.com/users/fjl/repos",
      "events_url": "https://api.github.com/users/fjl/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjl/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-03-06T16:24:37Z",
    "updated_at": "2019-03-06T16:24:37Z",
    "author_association": "MEMBER",
    "body": "Yes, you're right, the geth history file belongs in the geth directory. I think the best way forward would be to define alternative locations outside the regular datadir for chain flags, e.g.\r\n\r\n- `~/.ethereum-rinkeby` on linux and bsds\r\n- `~/Library/Ethereum-rinkeby` on darwin\r\n- `%LOCALAPPDATA%\\Ethereum-rinkeby` on windows",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/470174310/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/470546979",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/19172#issuecomment-470546979",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19172",
    "id": 470546979,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ3MDU0Njk3OQ==",
    "user": {
      "login": "whilei",
      "id": 10228550,
      "node_id": "MDQ6VXNlcjEwMjI4NTUw",
      "avatar_url": "https://avatars.githubusercontent.com/u/10228550?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/whilei",
      "html_url": "https://github.com/whilei",
      "followers_url": "https://api.github.com/users/whilei/followers",
      "following_url": "https://api.github.com/users/whilei/following{/other_user}",
      "gists_url": "https://api.github.com/users/whilei/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/whilei/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/whilei/subscriptions",
      "organizations_url": "https://api.github.com/users/whilei/orgs",
      "repos_url": "https://api.github.com/users/whilei/repos",
      "events_url": "https://api.github.com/users/whilei/events{/privacy}",
      "received_events_url": "https://api.github.com/users/whilei/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-03-07T14:30:06Z",
    "updated_at": "2019-03-07T14:30:06Z",
    "author_association": "NONE",
    "body": "That's fine with me. \r\n\r\nAs referenced above, it appears that using \"old resource paths\" are [handled like this](https://github.com/ethereum/go-ethereum/blob/master/node/config.go#L328):\r\n\r\n```go\r\nc.warnOnce(&c.oldGethResourceWarning, \"Using deprecated resource file %s, please move this file to the 'geth' subdirectory of datadir.\", oldpath)\r\n```\r\n\r\nWill a log warning again be sufficient for this change? ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/470546979/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/596096267",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/19172#issuecomment-596096267",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19172",
    "id": 596096267,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU5NjA5NjI2Nw==",
    "user": {
      "login": "stale[bot]",
      "id": 26384082,
      "node_id": "MDM6Qm90MjYzODQwODI=",
      "avatar_url": "https://avatars.githubusercontent.com/in/1724?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/stale%5Bbot%5D",
      "html_url": "https://github.com/apps/stale",
      "followers_url": "https://api.github.com/users/stale%5Bbot%5D/followers",
      "following_url": "https://api.github.com/users/stale%5Bbot%5D/following{/other_user}",
      "gists_url": "https://api.github.com/users/stale%5Bbot%5D/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/stale%5Bbot%5D/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/stale%5Bbot%5D/subscriptions",
      "organizations_url": "https://api.github.com/users/stale%5Bbot%5D/orgs",
      "repos_url": "https://api.github.com/users/stale%5Bbot%5D/repos",
      "events_url": "https://api.github.com/users/stale%5Bbot%5D/events{/privacy}",
      "received_events_url": "https://api.github.com/users/stale%5Bbot%5D/received_events",
      "type": "Bot",
      "site_admin": false
    },
    "created_at": "2020-03-07T14:51:14Z",
    "updated_at": "2020-03-07T14:51:14Z",
    "author_association": "NONE",
    "body": "This issue has been automatically marked as stale because it has not had recent activity. It will be closed if no further activity occurs. Thank you for your contributions.\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/596096267/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/614502968",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/19172#issuecomment-614502968",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19172",
    "id": 614502968,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYxNDUwMjk2OA==",
    "user": {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-04-16T08:39:34Z",
    "updated_at": "2020-04-16T08:39:34Z",
    "author_association": "MEMBER",
    "body": "The datadir is, nowadays, an implicit API surface, and various tools may depend on the organization of where data is stored. If we change that now, it might cause problems for a lot of users, so we decided to just leave it as is, since the added value of changing it is not deemed worth the problems it may cause. ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/614502968/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
