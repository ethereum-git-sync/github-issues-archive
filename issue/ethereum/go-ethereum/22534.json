{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22534",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22534/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22534/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22534/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/22534",
  "id": 835795341,
  "node_id": "MDU6SXNzdWU4MzU3OTUzNDE=",
  "number": 22534,
  "title": "Snap sync leads to corrupted state",
  "user": {
    "login": "holiman",
    "id": 142290,
    "node_id": "MDQ6VXNlcjE0MjI5MA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/holiman",
    "html_url": "https://github.com/holiman",
    "followers_url": "https://api.github.com/users/holiman/followers",
    "following_url": "https://api.github.com/users/holiman/following{/other_user}",
    "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
    "organizations_url": "https://api.github.com/users/holiman/orgs",
    "repos_url": "https://api.github.com/users/holiman/repos",
    "events_url": "https://api.github.com/users/holiman/events{/privacy}",
    "received_events_url": "https://api.github.com/users/holiman/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 72233650,
      "node_id": "MDU6TGFiZWw3MjIzMzY1MA==",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/type:bug",
      "name": "type:bug",
      "color": "FF5E5E",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2021-03-19T10:14:49Z",
  "updated_at": "2021-03-25T08:44:31Z",
  "closed_at": "2021-03-25T08:44:30Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "This was against `Geth/v1.10.0-unstable-8f03e3b1-20210220/linux-amd64/go1.16`. I have the full logs, with TRACE on some portions of it. \r\n\r\nWe've seen this on @MariusVanDerWijden 's node aswell, and something similar recently happened on one of the benchmarkers. \r\n\r\nInteresting parts of the logs: \r\n\r\nTerminates snapshot sync cycle, pending is `0`:\r\n```\r\nTRACE[02-22|19:10:36.935] Delivering set of healing trienodes      peer=a751eb04         reqid=3279015607415421165 trienodes=1   bytes=39.00B\r\nDEBUG[02-22|19:10:36.935] Persisted set of healing data            type=trienodes               bytes=6.21KiB\r\nDEBUG[02-22|19:10:36.935] Terminating snapshot sync cycle          root=\"56b98f…549127\"\r\nINFO [02-22|19:10:36.935] State heal in progress                   nodes=2428543@714.77MiB codes=16@79.94KiB       pending=0\r\nTRACE[02-22|19:10:36.935] State sync spinning down                 active=0 finished=0\r\nTRACE[02-22|19:10:36.945] Peer throughput measurements updated     peer=ca5d01b0         hps=2603.508  bps=308.852 rps=155.252 sps=0.000 miss=0 rtt=127.002199ms\r\n```\r\nIt then continues downloading headers/bodies for another five minutes, and then it decides that snapshot sync is already completed:\r\n```\r\nDEBUG[02-22|19:16:09.248] Inserting fast-sync blocks               items=15       firstnum=11908300 firsthash=\"4ff1bc…43c652\" lastnumn=11908314 lasthash=\"8bd984…7f4ce4\"\r\nINFO [02-22|19:16:09.274] Imported new block receipts              count=15      elapsed=26.263ms    number=11908314 hash=\"8bd984…7f4ce4\" age=20m30s     size=1.44MiB\r\nTRACE[02-22|19:16:09.274] State sync starting                      root=\"56b98f…549127\"\r\nDEBUG[02-22|19:16:09.274] Snapshot sync already completed \r\nTRACE[02-22|19:16:09.274] State sync spinning down                 active=0 finished=0\r\nDEBUG[02-22|19:16:09.274] Committing fast sync pivot as new head   number=11908315 hash=\"b8473c…b87bf0\"\r\nINFO [02-22|19:16:09.276] Imported new block receipts              count=1       elapsed=1.639ms     number=11908315 hash=\"b8473c…b87bf0\" age=20m9s      size=113.69KiB\r\nINFO [02-22|19:16:09.279] Rebuilding state snapshot \r\nINFO [02-22|19:16:09.281] Committed new head block                 number=11908315 hash=\"b8473c…b87bf0\"\r\nINFO [02-22|19:16:09.282] Wiper running, state snapshotting paused accounts=0                  slots=0                  storage=0.00B elapsed=\"934.583µs\"\r\nINFO [02-22|19:16:09.380] Deallocated state bloom                  items=762715723 errorrate=0.001\r\nDEBUG[02-22|19:16:09.380] Inserting downloaded chain               items=3         firstnum=11908316 firsthash=\"e33586…12d149\" lastnum=11908318 lasthash=\"32db31…17e4ba\"\r\nTRACE[02-22|19:16:09.955] Fetching full headers                    peer=ca5d01b0         count=192     from=11908406\r\nTRACE[02-22|19:16:09.987] Scheduling new headers                   peer=ca5d01b0         count=1       from=11908406\r\nTRACE[02-22|19:16:09.987] Fetching full headers                    peer=ca5d01b0         count=192     from=11908407\r\nTRACE[02-22|19:16:10.020] All headers delayed, waiting             peer=ca5d01b0\r\nINFO [02-22|19:16:11.303] Deleted state snapshot leftovers         kind=accounts wiped=8893 elapsed=2.022s\r\nINFO [02-22|19:16:12.214] Imported new chain segment               blocks=3 txs=671 mgas=37.249 elapsed=2.811s      mgasps=13.248 number=11908318 hash=\"32db31…17e4ba\" age=19m27s     dirty=5.14MiB\r\nINFO [02-22|19:16:12.216] Upgrading chain index                    type=bloombits               percentage=40\r\nINFO [02-22|19:16:12.216] Imported new block headers               count=1       elapsed=2.228s      number=11908406 hash=\"0209a1…11a442\"\r\nDEBUG[02-22|19:16:12.216] Inserting downloaded chain               items=87        firstnum=11908319 firsthash=\"398748…54d37f\" lastnum=11908405 lasthash=\"445a39…8a8e14\"\r\nINFO [02-22|19:16:12.957] Deleted state snapshot leftovers         kind=storage  wiped=0    elapsed=1.653s\r\nINFO [02-22|19:16:12.957] Compacting snapshot account area  \r\n\r\n```\r\nAnd it starts generating the snapshot. However, after another `9` minutes, it finally reports `Snap sync complete` -- by which time the generator has already been at work for a while. \r\n \r\n```\r\nINFO [02-22|19:25:02.688] Aborting state snapshot generation       root=\"69e485…8c7900\" in=\"0042a5…807326\" at=\"f3be76…5f8c01\" accounts=121217             slots=843141             storage=65.73MiB  elapsed=8m29.614s   eta=139h3m27.721s\r\nINFO [02-22|19:25:02.694] Resuming state snapshot generation       root=\"8e11f0…0ff2f1\" in=\"0042a5…807326\" at=\"f3be76…5f8c01\" accounts=121217             slots=843141             storage=65.73MiB  elapsed=8m29.620s   eta=139h3m33.615s\r\nINFO [02-22|19:25:04.076] Aborting state snapshot generation       root=\"8e11f0…0ff2f1\" in=\"0042a5…807326\" at=\"f580c0…17d51a\" accounts=121217             slots=848398             storage=66.10MiB  elapsed=8m31.002s   eta=139h26m11.189s\r\nINFO [02-22|19:25:04.081] Imported new chain segment               blocks=2      txs=334      mgas=24.995 elapsed=3.502s      mgasps=7.136  number=11908448 hash=\"80804a…25bf8e\" age=2m38s      dirty=217.28MiB\r\nINFO [02-22|19:25:04.081] Downloader queue stats                   receiptTasks=0     blockTasks=0     itemSize=206.21KiB throttle=318\r\nDEBUG[02-22|19:25:04.081] Synchronisation terminated               elapsed=1h56m27.889s\r\nINFO [02-22|19:25:04.081] Fast sync complete, auto disabling \r\nINFO [02-22|19:25:04.082] Snap sync complete, auto disabling \r\nINFO [02-22|19:25:04.083] Resuming state snapshot generation       root=\"b9ebf5…555f64\" in=\"0042a5…807326\" at=\"f580c0…17d51a\" accounts=121217             slots=848398             storage=66.10MiB  elapsed=8m31.008s    eta=139h26m17.083s\r\nDEBUG[02-22|19:25:04.112] Synchronising with the network           peer=7166e5a694a38132a01eacc075f77c54f5d4051195aa166fc3b1562f6988d278 eth=65 head=\"6e3021…164c43\" td=21344725780625395672749 mode=full\r\nDEBUG[02-22|19:25:04.112] Retrieving remote chain head             peer=7166e5a6\r\nDEBUG[02-22|19:25:04.137] Remote head identified, no pivot         peer=7166e5a6         number=11908459 hash=\"6e3021…164c43\"\r\nDEBUG[02-22|19:25:04.137] Looking for common ancestor              peer=7166e5a6         local=11908448 remote=11908459\r\n```\r\n\r\nAnd eventually\r\n```\r\nINFO [02-24|05:54:56.134] Generating state snapshot                root=\"01ecf5…29122c\" at=\"f9fe47…b2aa84\" accounts=116658241          slots=386540660          storage=32.90GiB   elapsed=34h38m23.060s eta=49m56.31s\r\nERROR[02-24|05:54:59.299] Generator failed to access storage trie  root=\"01ecf5…29122c\" account=\"fa03dd…fe0ce8\" stroot=\"0e72a1…351856\" err=\"missing trie node 0e72a13c4752aa80f72dd27b1c859a78c6b90d8df0a898c131b9b2253b351856 (path )\"\r\n\r\n```",
  "closed_by": {
    "login": "holiman",
    "id": 142290,
    "node_id": "MDQ6VXNlcjE0MjI5MA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/holiman",
    "html_url": "https://github.com/holiman",
    "followers_url": "https://api.github.com/users/holiman/followers",
    "following_url": "https://api.github.com/users/holiman/following{/other_user}",
    "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
    "organizations_url": "https://api.github.com/users/holiman/orgs",
    "repos_url": "https://api.github.com/users/holiman/repos",
    "events_url": "https://api.github.com/users/holiman/events{/privacy}",
    "received_events_url": "https://api.github.com/users/holiman/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22534/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22534/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/802732907",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/22534#issuecomment-802732907",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22534",
    "id": 802732907,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwMjczMjkwNw==",
    "user": {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-19T10:45:34Z",
    "updated_at": "2021-03-19T10:45:34Z",
    "author_association": "MEMBER",
    "body": "This problem seem to be more prone to happen when the node is totally clean, i.e, also has do download bodies. This causes the snap-part of the sync to complete _before_ the block-part, and that seems to sometimes trigger this behaviour. ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/802732907/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/802795841",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/22534#issuecomment-802795841",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22534",
    "id": 802795841,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwMjc5NTg0MQ==",
    "user": {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-19T12:22:51Z",
    "updated_at": "2021-03-19T12:22:51Z",
    "author_association": "MEMBER",
    "body": "On `bench03`\r\n\r\nhttps://my.papertrailapp.com/systems/5646602342/events?q=program%3Ageth&focus=1309285025577111555&selected=1309285025577111555\r\n```\r\n[03-18|19:18:17.895] Rebuilding state snapshot\r\n[03-18|19:18:17.898] Committed new head block number=12064387 hash=\"ac8b02…72635d\r\n```\r\n\r\nhttps://my.papertrailapp.com/systems/5646602342/events?q=program%3Ageth&focus=1309285820703903747&selected=1309285820703903747\r\n\r\n```\r\n[03-18|19:21:27.471] Snap sync complete, auto disabling\r\n```\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/802795841/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/803861395",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/22534#issuecomment-803861395",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22534",
    "id": 803861395,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwMzg2MTM5NQ==",
    "user": {
      "login": "rjl493456442",
      "id": 5959481,
      "node_id": "MDQ6VXNlcjU5NTk0ODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5959481?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rjl493456442",
      "html_url": "https://github.com/rjl493456442",
      "followers_url": "https://api.github.com/users/rjl493456442/followers",
      "following_url": "https://api.github.com/users/rjl493456442/following{/other_user}",
      "gists_url": "https://api.github.com/users/rjl493456442/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rjl493456442/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rjl493456442/subscriptions",
      "organizations_url": "https://api.github.com/users/rjl493456442/orgs",
      "repos_url": "https://api.github.com/users/rjl493456442/repos",
      "events_url": "https://api.github.com/users/rjl493456442/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rjl493456442/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-22T08:18:35Z",
    "updated_at": "2021-03-22T08:18:35Z",
    "author_association": "MEMBER",
    "body": "Looks like it's the expected behavior. \r\n\r\n1. the state sync is done(by snap sync), the pivot point state is committed so that the background generator starts to run\r\n2. the chain sync is still not finished, so that it keeps syncing for a while\r\n3. the pivot point won't be changed if it's committed\r\n4. after several minutes, the chain sync is eventually finished, so that it reports `Snap sync complete, auto disabling`\r\n\r\n\r\nIn theory, it can be wrong in this case. The generation target is the pivot point trie and all the updates of the following blocks will be handled by `diffToDisk` function.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/803861395/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/803889486",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/22534#issuecomment-803889486",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22534",
    "id": 803889486,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwMzg4OTQ4Ng==",
    "user": {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-22T09:01:23Z",
    "updated_at": "2021-03-22T09:01:23Z",
    "author_association": "MEMBER",
    "body": "What kicks it off is that the pivot is committed, but the downloader has another chunk of blocks `afterP`. Once the pivot is committed, the `afterP` blocks are imported \"normally\". This kicks off the generator. which starts wiping.\r\n\r\nBut the downloader doesn't exit until after importing the `afterP` blocks, and only then does the external caller say \"Fast sync complete\". \r\n\r\nBut I don't see anything important that we actually do around \"Fast sync complete\" that is very important, other than log the message. So I still don't see why this would lead to data corruption. ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/803889486/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/806471467",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/22534#issuecomment-806471467",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22534",
    "id": 806471467,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwNjQ3MTQ2Nw==",
    "user": {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-25T08:44:30Z",
    "updated_at": "2021-03-25T08:44:30Z",
    "author_association": "MEMBER",
    "body": "As far as we know, this is solved by #22553 ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/806471467/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
