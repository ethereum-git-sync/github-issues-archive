{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22799",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22799/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22799/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22799/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/22799",
  "id": 874421070,
  "node_id": "MDU6SXNzdWU4NzQ0MjEwNzA=",
  "number": 22799,
  "title": "clique: multiple out-of-turn blocks at same time despite random wiggleTime",
  "user": {
    "login": "thorstenhirsch",
    "id": 619741,
    "node_id": "MDQ6VXNlcjYxOTc0MQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/619741?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/thorstenhirsch",
    "html_url": "https://github.com/thorstenhirsch",
    "followers_url": "https://api.github.com/users/thorstenhirsch/followers",
    "following_url": "https://api.github.com/users/thorstenhirsch/following{/other_user}",
    "gists_url": "https://api.github.com/users/thorstenhirsch/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/thorstenhirsch/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/thorstenhirsch/subscriptions",
    "organizations_url": "https://api.github.com/users/thorstenhirsch/orgs",
    "repos_url": "https://api.github.com/users/thorstenhirsch/repos",
    "events_url": "https://api.github.com/users/thorstenhirsch/events{/privacy}",
    "received_events_url": "https://api.github.com/users/thorstenhirsch/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 72233650,
      "node_id": "MDU6TGFiZWw3MjIzMzY1MA==",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/type:bug",
      "name": "type:bug",
      "color": "FF5E5E",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2021-05-03T09:54:21Z",
  "updated_at": "2022-06-12T14:50:31Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "#### System information\r\n\r\nGeth version:\r\n```\r\nVersion: 1.9.25-stable\r\nGit Commit: e7872729012a4871397307b12cc3f4772ffcbec6\r\nGit Commit Date: 20201211\r\nArchitecture: amd64\r\nProtocol Versions: [65 64 63]\r\nGo Version: go1.15.6\r\nOperating System: linux\r\nGOPATH=\r\nGOROOT=go\r\n```\r\n\r\nOS & Version: RHEL 7.9\r\n\r\n#### Expected behaviour\r\n\r\nIn case of a persistent network problem or downtime of a sealer node the out-of-turn signing requests solve the problem of a stalled network and every sealer waiting for the missing sealer. After a \"wiggle\" time the other sealers start sealing a new block. Now in order to not have all sealers do the out-of-turn signing at the same time there's a randomized delay:\r\n```go\r\nwiggle := time.Duration(len(snap.Signers)/2+1) * wiggleTime\r\ndelay += time.Duration(rand.Int63n(int64(wiggle)))\r\n```\r\n\r\n#### Actual behaviour\r\n\r\nUnfortunately the randomization doesn't lead to a reliable spread of the delay between the nodes. When out-of-turn signing requests happen often, there are also many \"collisions\" between the out-of-turn blocks, because different nodes calculate more or less the same delay.\r\n\r\n#### Steps to reproduce the behaviour\r\n\r\nLet's assume we have 4 sealers in our network with a block time of 5s and 1 of the sealers is not reachable, then we have out-of-turn signing requests every 20s:\r\n\r\n```\r\nTRACE[05-03|10:40:46.039] Out-of-turn signing requested            wiggle=1.5s\r\nTRACE[05-03|10:41:06.541] Out-of-turn signing requested            wiggle=1.5s\r\nTRACE[05-03|10:41:26.034] Out-of-turn signing requested            wiggle=1.5s\r\nTRACE[05-03|10:41:46.019] Out-of-turn signing requested            wiggle=1.5s\r\nTRACE[05-03|10:42:06.024] Out-of-turn signing requested            wiggle=1.5s\r\nTRACE[05-03|10:42:26.024] Out-of-turn signing requested            wiggle=1.5s\r\nTRACE[05-03|10:42:46.034] Out-of-turn signing requested            wiggle=1.5s\r\nTRACE[05-03|10:43:06.039] Out-of-turn signing requested            wiggle=1.5s\r\nTRACE[05-03|10:43:26.024] Out-of-turn signing requested            wiggle=1.5s\r\nTRACE[05-03|10:43:46.040] Out-of-turn signing requested            wiggle=1.5s\r\nTRACE[05-03|10:44:06.024] Out-of-turn signing requested            wiggle=1.5s\r\nTRACE[05-03|10:44:26.024] Out-of-turn signing requested            wiggle=1.5s\r\nTRACE[05-03|10:44:46.035] Out-of-turn signing requested            wiggle=1.5s\r\nTRACE[05-03|10:45:06.525] Out-of-turn signing requested            wiggle=1.5s\r\n```\r\nWe can expect that `wiggle=1.5s` leads to a difference of less than 0.1s in the delays on the 3 nodes for every 5th attempt (not sure if my mental calculation is correct, but I'm pretty sure that it happens pretty often).\r\n\r\n#### Suggestion\r\n\r\nMaybe we can use the position of each sealer in the `snap.Signers` array to get a reliably different delay between the nodes. However we also have to make sure that the 1st sealer in the array doesn't always get the minimum delay in which case it would always be the same node who seals the out-of-turn signing requests. Maybe also do a `blockNumber % (number-of-sealers + 1)` or something alike.",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22799/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22799/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/833317859",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/22799#issuecomment-833317859",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22799",
    "id": 833317859,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgzMzMxNzg1OQ==",
    "user": {
      "login": "thorstenhirsch",
      "id": 619741,
      "node_id": "MDQ6VXNlcjYxOTc0MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/619741?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/thorstenhirsch",
      "html_url": "https://github.com/thorstenhirsch",
      "followers_url": "https://api.github.com/users/thorstenhirsch/followers",
      "following_url": "https://api.github.com/users/thorstenhirsch/following{/other_user}",
      "gists_url": "https://api.github.com/users/thorstenhirsch/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/thorstenhirsch/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/thorstenhirsch/subscriptions",
      "organizations_url": "https://api.github.com/users/thorstenhirsch/orgs",
      "repos_url": "https://api.github.com/users/thorstenhirsch/repos",
      "events_url": "https://api.github.com/users/thorstenhirsch/events{/privacy}",
      "received_events_url": "https://api.github.com/users/thorstenhirsch/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-05-06T08:00:48Z",
    "updated_at": "2021-05-06T08:02:20Z",
    "author_association": "NONE",
    "body": "In the meantime we've out-voted one sealer, so there are three left. Now all sealers have direct connections to each other, but the Out-of-turn signing requests still happen after every round (which is now every 15s):\r\n```\r\nTRACE[05-06|09:55:44.024] Out-of-turn signing requested            wiggle=1s\r\nTRACE[05-06|09:55:44.526] Out-of-turn signing requested            wiggle=1s\r\nTRACE[05-06|09:55:59.518] Out-of-turn signing requested            wiggle=1s\r\nTRACE[05-06|09:56:14.519] Out-of-turn signing requested            wiggle=1s\r\nTRACE[05-06|09:56:29.531] Out-of-turn signing requested            wiggle=1s\r\n```\r\nP.S.: I don't know why there are two Out-of-turn signing requests within 500ms. Might be another issue.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/833317859/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
