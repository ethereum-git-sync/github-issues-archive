{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/27237",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/27237/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/27237/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/27237/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/27237",
  "id": 1703266500,
  "node_id": "I_kwDOAOvK985lhcjE",
  "number": 27237,
  "title": "Crash on shutdown",
  "user": {
    "login": "holiman",
    "id": 142290,
    "node_id": "MDQ6VXNlcjE0MjI5MA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/holiman",
    "html_url": "https://github.com/holiman",
    "followers_url": "https://api.github.com/users/holiman/followers",
    "following_url": "https://api.github.com/users/holiman/following{/other_user}",
    "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
    "organizations_url": "https://api.github.com/users/holiman/orgs",
    "repos_url": "https://api.github.com/users/holiman/repos",
    "events_url": "https://api.github.com/users/holiman/events{/privacy}",
    "received_events_url": "https://api.github.com/users/holiman/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 72233650,
      "node_id": "MDU6TGFiZWw3MjIzMzY1MA==",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/type:bug",
      "name": "type:bug",
      "color": "FF5E5E",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2023-05-10T07:08:22Z",
  "updated_at": "2023-05-19T12:36:23Z",
  "closed_at": "2023-05-19T12:36:23Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "Seen on a benchmarker during shutdown:\r\n```\r\nINFO [05-10|05:39:10.603] Writing clean trie cache to disk path=/datadir/geth/geth/triecache threads=16\r\nINFO [05-10|05:39:10.825] Persisted the clean trie cache path=/datadir/geth/geth/triecache elapsed=221.964ms\r\nINFO [05-10|05:39:10.825] Blockchain stopped\r\npanic: pebble: closed\r\ngoroutine 179923979 [running]:\r\ngithub.com/cockroachdb/pebble.(*DB).getInternal(0xc000600000?, {0xc04bd1a060?, 0x0?, 0xc0124e8618?}, 0x40cb8a?, 0x413304?)\r\ngithub.com/cockroachdb/pebble@v0.0.0-20230209160836-829675f94811/db.go:518 +0x445\r\ngithub.com/cockroachdb/pebble.(*DB).Get(...)\r\ngithub.com/cockroachdb/pebble@v0.0.0-20230209160836-829675f94811/db.go:501\r\ngithub.com/ethereum/go-ethereum/ethdb/pebble.(*Database).Get(0x0?, {0xc04bd1a060?, 0xc0124e8678?, 0x5ae62c?})\r\ngithub.com/ethereum/go-ethereum/ethdb/pebble/pebble.go:253 +0x2b\r\ngithub.com/ethereum/go-ethereum/core/rawdb.ReadLegacyTrieNode({0x7fd576b0b5e0, 0xc0008462d0}, {0x58, 0xca, 0xbd, 0x5c, 0x84, 0xe9, 0x19, 0x29, ...})\r\ngithub.com/ethereum/go-ethereum/core/rawdb/accessors_trie.go:145 +0x59\r\ngithub.com/ethereum/go-ethereum/trie.(*Database).Node(0xc0004fe4e0, {0x58, 0xca, 0xbd, 0x5c, 0x84, 0xe9, 0x19, 0x29, 0xaf, ...})\r\ngithub.com/ethereum/go-ethereum/trie/database.go:222 +0x196\r\ngithub.com/ethereum/go-ethereum/trie.(*hashReader).Node(0x40?, {0xd, 0xb4, 0x9b, 0x2f, 0xec, 0x5a, 0x0, 0x61, 0xf2, ...}, ...)\r\ngithub.com/ethereum/go-ethereum/trie/database.go:669 +0x2f\r\ngithub.com/ethereum/go-ethereum/trie.(*trieReader).node(0xc02c46a380, {0xc0479caca0, 0x3, 0x8}, {0x58, 0xca, 0xbd, 0x5c, 0x84, 0xe9, ...})\r\ngithub.com/ethereum/go-ethereum/trie/trie_reader.go:76 +0xe7\r\ngithub.com/ethereum/go-ethereum/trie.(*Trie).Prove(0xc01446dd60, {0xc0329fdde0, 0x20, 0xc0124e8aa8?}, 0x0, {0x7fd55bdbfb28, 0xc0236d01b0})\r\ngithub.com/ethereum/go-ethereum/trie/proof.go:67 +0x6b3\r\ngithub.com/ethereum/go-ethereum/core/state/snapshot.(*diskLayer).proveRange(0xc02400eab0, 0xc00f19ab90, 0xc013babda0, {0xc00b561860, 0x21, 0x30}, {0x1918bc1, 0x7}, {0xc0278007c0, 0x20, ...}, ...)\r\ngithub.com/ethereum/go-ethereum/core/state/snapshot/generate.go:270 +0xe3b\r\n```\r\nSo the generator is running, and we shut down the blockchain (and thus the db too). I tried modifying `db get` so that it closes the db before doing the `Get`. \r\nWith leveldb: \r\n```\r\n$  go run ./cmd/geth --datadir /tmp/ldb db get 0x0102\r\nINFO [05-10|09:04:06.770] Maximum peer count                       ETH=50 LES=0 total=50\r\nINFO [05-10|09:04:06.783] Set global gas cap                       cap=50,000,000\r\nINFO [05-10|09:04:06.784] Using leveldb as the backing database \r\nINFO [05-10|09:04:06.784] Allocated cache and file handles         database=/tmp/ldb/geth/chaindata cache=512.00MiB handles=262,144 readonly=true\r\nINFO [05-10|09:04:06.790] Using LevelDB as the backing database \r\nINFO [05-10|09:04:06.790] Opened ancient database                  database=/tmp/ldb/geth/chaindata/ancient/chain readonly=true\r\nINFO [05-10|09:04:06.790] Get operation failed                     key=0x0102 error=\"leveldb: closed\"\r\nleveldb: closed\r\nexit status 1\r\n```\r\nWIth pebble: \r\n```\r\n$  go run ./cmd/geth --datadir /tmp/foo db get 0x0102\r\nINFO [05-10|09:03:35.661] Maximum peer count                       ETH=50 LES=0 total=50\r\nINFO [05-10|09:03:35.671] Set global gas cap                       cap=50,000,000\r\nINFO [05-10|09:03:35.671] Using pebble as the backing database \r\nINFO [05-10|09:03:35.671] Allocated cache and file handles         database=/tmp/foo/geth/chaindata cache=512.00MiB handles=262,144\r\nINFO [05-10|09:03:35.673] Opened ancient database                  database=/tmp/foo/geth/chaindata/ancient/chain readonly=true\r\npanic: pebble: closed\r\n\r\ngoroutine 1 [running]:\r\ngithub.com/cockroachdb/pebble.(*DB).getInternal(0xc0000e27c8?, {0xc000737a40?, 0xc000154898?, 0xbb36ca?}, 0xc0000e26e0?, 0xc000154930?)\r\n        /home/user/go/pkg/mod/github.com/cockroachdb/pebble@v0.0.0-20230209160836-829675f94811/db.go:518 +0x445\r\n```\r\nSo we previously were fine: doing a get on closed db returned an error, and we can handle that. Pebble throws a `panic` instead, which, although it cannot cause corruption of \"main\" database, it's obviously not great. \r\n",
  "closed_by": {
    "login": "holiman",
    "id": 142290,
    "node_id": "MDQ6VXNlcjE0MjI5MA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/holiman",
    "html_url": "https://github.com/holiman",
    "followers_url": "https://api.github.com/users/holiman/followers",
    "following_url": "https://api.github.com/users/holiman/following{/other_user}",
    "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
    "organizations_url": "https://api.github.com/users/holiman/orgs",
    "repos_url": "https://api.github.com/users/holiman/repos",
    "events_url": "https://api.github.com/users/holiman/events{/privacy}",
    "received_events_url": "https://api.github.com/users/holiman/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/27237/reactions",
    "total_count": 1,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 1
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/27237/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1541476614",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/27237#issuecomment-1541476614",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/27237",
    "id": 1541476614,
    "node_id": "IC_kwDOAOvK985b4REG",
    "user": {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-10T07:17:13Z",
    "updated_at": "2023-05-10T07:17:13Z",
    "author_association": "MEMBER",
    "body": "It is kind of hard to work around this. \r\n\r\nThe naive way would be to just check `db.IsClosed` as the first thing in `func (d *Database) Get(key []byte) ([]byte, error)`, but that is racy, and there's no `IsClosed` method exposed. \r\n\r\nThe more robust approach is to fix the `generate` procedure to use a different shutdown-signal (other than \"oh the db errors out\"), and wait for that during blockchain shutdown. I actually think the existing method of \"run until it errors due to closed db\" is pretty elegant, and anything else we can come up with will be more complex. \r\n\r\nThe third approach would be to check if upstream would be amenable to changing the behaviour. ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1541476614/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1541479109",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/27237#issuecomment-1541479109",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/27237",
    "id": 1541479109,
    "node_id": "IC_kwDOAOvK985b4RrF",
    "user": {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-10T07:19:08Z",
    "updated_at": "2023-05-10T07:19:08Z",
    "author_association": "MEMBER",
    "body": "https://github.com/cockroachdb/pebble/issues/998\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1541479109/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1541524141",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/27237#issuecomment-1541524141",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/27237",
    "id": 1541524141,
    "node_id": "IC_kwDOAOvK985b4cqt",
    "user": {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-10T07:55:51Z",
    "updated_at": "2023-05-10T07:55:51Z",
    "author_association": "MEMBER",
    "body": "> It is kind of hard to work around this.\r\n\r\nOk, it wasn't that hard: https://github.com/ethereum/go-ethereum/pull/27238, I forgot that we already have a centralized accessor. Might have a bit of overhead though. ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1541524141/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
