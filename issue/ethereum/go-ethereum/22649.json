{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22649",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22649/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22649/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22649/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/22649",
  "id": 855291657,
  "node_id": "MDU6SXNzdWU4NTUyOTE2NTc=",
  "number": 22649,
  "title": "Incorrect gas cost passed to tracer for EIP-2929 calls with cold account accesses",
  "user": {
    "login": "adietrichs",
    "id": 10457348,
    "node_id": "MDQ6VXNlcjEwNDU3MzQ4",
    "avatar_url": "https://avatars.githubusercontent.com/u/10457348?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/adietrichs",
    "html_url": "https://github.com/adietrichs",
    "followers_url": "https://api.github.com/users/adietrichs/followers",
    "following_url": "https://api.github.com/users/adietrichs/following{/other_user}",
    "gists_url": "https://api.github.com/users/adietrichs/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/adietrichs/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/adietrichs/subscriptions",
    "organizations_url": "https://api.github.com/users/adietrichs/orgs",
    "repos_url": "https://api.github.com/users/adietrichs/repos",
    "events_url": "https://api.github.com/users/adietrichs/events{/privacy}",
    "received_events_url": "https://api.github.com/users/adietrichs/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 72233650,
      "node_id": "MDU6TGFiZWw3MjIzMzY1MA==",
      "url": "https://api.github.com/repos/ethereum/go-ethereum/labels/type:bug",
      "name": "type:bug",
      "color": "FF5E5E",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2021-04-11T12:14:00Z",
  "updated_at": "2021-04-27T11:21:41Z",
  "closed_at": "2021-04-27T11:21:41Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "#### System information\r\nCommit hash : anything past https://github.com/ethereum/go-ethereum/commit/6487c002f6b47e08cb9814f16712c6789b313a97 that introduced EIP-2929 support\r\n\r\n#### Expected behaviour\r\nWith [EIP-2929](https://github.com/ethereum/EIPs/blob/d679d09f7aa4c8aac78830bdee2436eea7d561ad/EIPS/eip-2929.md) enabled, the dynamic cost of all call types includes an optional `COLD_ACCOUNT_ACCESS_COST`. This cost, if charged, should also be part of the total opcode gas cost passed to the tracer and exposed e.g. via `debug_traceTransaction`.\r\n\r\n#### Actual behaviour\r\nWhile properly charged, the `COLD_ACCOUNT_ACCESS_COST` is never part of the gas cost reported to the tracer.\r\n\r\n#### Explanation\r\nhttps://github.com/ethereum/go-ethereum/commit/6487c002f6b47e08cb9814f16712c6789b313a97 added the new `core/vm/operations_acl.go` file for EIP-2929 gas logic. Dynamic gas cost calculation for all call types is wrapped in [operations_acl.go#L176](https://github.com/ethereum/go-ethereum/blob/9c653ff6625df1ff0f6c6612958b2a1da0021e40/core/vm/operations_acl.go#L176):\r\n```\r\nfunc makeCallVariantGasCallEIP2929(oldCalculator gasFunc) gasFunc {\r\n\treturn func(evm *EVM, contract *Contract, stack *Stack, mem *Memory, memorySize uint64) (uint64, error) {\r\n\t\taddr := common.Address(stack.Back(1).Bytes20())\r\n\t\tif !evm.StateDB.AddressInAccessList(addr) {\r\n\t\t\tevm.StateDB.AddAddressToAccessList(addr)\r\n\t\t\tif !contract.UseGas(ColdAccountAccessCostEIP2929 - WarmStorageReadCostEIP2929) {\r\n\t\t\t\treturn 0, ErrOutOfGas\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn oldCalculator(evm, contract, stack, mem, memorySize)\r\n\t}\r\n}\r\n```\r\nThe issue is that the `ColdAccountAccessCostEIP2929` is charged directly, instead of being passed to the outside together with the rest of the dynamic gas, to be charged there and passed to the tracer. While this is necessary to properly calculate the available call gas in the inner `gasFunc`, it causes the incorrect gas reporting to the tracer at [interpreter.go#L278](https://github.com/ethereum/go-ethereum/blob/9c653ff6625df1ff0f6c6612958b2a1da0021e40/core/vm/interpreter.go#L278).\r\n",
  "closed_by": {
    "login": "holiman",
    "id": 142290,
    "node_id": "MDQ6VXNlcjE0MjI5MA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/holiman",
    "html_url": "https://github.com/holiman",
    "followers_url": "https://api.github.com/users/holiman/followers",
    "following_url": "https://api.github.com/users/holiman/following{/other_user}",
    "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
    "organizations_url": "https://api.github.com/users/holiman/orgs",
    "repos_url": "https://api.github.com/users/holiman/repos",
    "events_url": "https://api.github.com/users/holiman/events{/privacy}",
    "received_events_url": "https://api.github.com/users/holiman/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22649/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22649/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/817298135",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/22649#issuecomment-817298135",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22649",
    "id": 817298135,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgxNzI5ODEzNQ==",
    "user": {
      "login": "adietrichs",
      "id": 10457348,
      "node_id": "MDQ6VXNlcjEwNDU3MzQ4",
      "avatar_url": "https://avatars.githubusercontent.com/u/10457348?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/adietrichs",
      "html_url": "https://github.com/adietrichs",
      "followers_url": "https://api.github.com/users/adietrichs/followers",
      "following_url": "https://api.github.com/users/adietrichs/following{/other_user}",
      "gists_url": "https://api.github.com/users/adietrichs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/adietrichs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/adietrichs/subscriptions",
      "organizations_url": "https://api.github.com/users/adietrichs/orgs",
      "repos_url": "https://api.github.com/users/adietrichs/repos",
      "events_url": "https://api.github.com/users/adietrichs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/adietrichs/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-04-11T12:17:20Z",
    "updated_at": "2021-04-12T00:36:02Z",
    "author_association": "MEMBER",
    "body": "I will see if I can create a PR later today with a proposed fix that keeps the existing `makeCallVariantGasCallEIP2929` wrapper structure.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/817298135/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/820232024",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/22649#issuecomment-820232024",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22649",
    "id": 820232024,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgyMDIzMjAyNA==",
    "user": {
      "login": "ligi",
      "id": 111600,
      "node_id": "MDQ6VXNlcjExMTYwMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/111600?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ligi",
      "html_url": "https://github.com/ligi",
      "followers_url": "https://api.github.com/users/ligi/followers",
      "following_url": "https://api.github.com/users/ligi/following{/other_user}",
      "gists_url": "https://api.github.com/users/ligi/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ligi/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ligi/subscriptions",
      "organizations_url": "https://api.github.com/users/ligi/orgs",
      "repos_url": "https://api.github.com/users/ligi/repos",
      "events_url": "https://api.github.com/users/ligi/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ligi/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-04-15T08:31:29Z",
    "updated_at": "2021-04-15T08:31:29Z",
    "author_association": "MEMBER",
    "body": "Thanks for the great detailed issue! We would very much like to see the PR you make later today.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/820232024/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/820767915",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/22649#issuecomment-820767915",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22649",
    "id": 820767915,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgyMDc2NzkxNQ==",
    "user": {
      "login": "adietrichs",
      "id": 10457348,
      "node_id": "MDQ6VXNlcjEwNDU3MzQ4",
      "avatar_url": "https://avatars.githubusercontent.com/u/10457348?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/adietrichs",
      "html_url": "https://github.com/adietrichs",
      "followers_url": "https://api.github.com/users/adietrichs/followers",
      "following_url": "https://api.github.com/users/adietrichs/following{/other_user}",
      "gists_url": "https://api.github.com/users/adietrichs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/adietrichs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/adietrichs/subscriptions",
      "organizations_url": "https://api.github.com/users/adietrichs/orgs",
      "repos_url": "https://api.github.com/users/adietrichs/repos",
      "events_url": "https://api.github.com/users/adietrichs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/adietrichs/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-04-15T22:28:53Z",
    "updated_at": "2021-04-15T22:28:53Z",
    "author_association": "MEMBER",
    "body": "> later today\r\n\r\nTurns out that was indeed optimistic. I created #22680 now though, which is the best minimal fix I could come up with.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/820767915/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/823066637",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/22649#issuecomment-823066637",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22649",
    "id": 823066637,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgyMzA2NjYzNw==",
    "user": {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-04-20T08:00:03Z",
    "updated_at": "2021-04-20T08:00:03Z",
    "author_association": "MEMBER",
    "body": "I wanted to push some changes to this PR, but you seem to have disabled maintainer-push on your fork. I might open a new PR and cherry-pick your commit, if that's ok? \r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/823066637/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/823370335",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/22649#issuecomment-823370335",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/22649",
    "id": 823370335,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgyMzM3MDMzNQ==",
    "user": {
      "login": "adietrichs",
      "id": 10457348,
      "node_id": "MDQ6VXNlcjEwNDU3MzQ4",
      "avatar_url": "https://avatars.githubusercontent.com/u/10457348?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/adietrichs",
      "html_url": "https://github.com/adietrichs",
      "followers_url": "https://api.github.com/users/adietrichs/followers",
      "following_url": "https://api.github.com/users/adietrichs/following{/other_user}",
      "gists_url": "https://api.github.com/users/adietrichs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/adietrichs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/adietrichs/subscriptions",
      "organizations_url": "https://api.github.com/users/adietrichs/orgs",
      "repos_url": "https://api.github.com/users/adietrichs/repos",
      "events_url": "https://api.github.com/users/adietrichs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/adietrichs/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-04-20T15:31:47Z",
    "updated_at": "2021-04-20T15:31:47Z",
    "author_association": "MEMBER",
    "body": "Ah, wasn't aware we had disabled maintainer-push. New PR is fine with me, will close the other one then.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/823370335/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
