{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19965",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19965/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19965/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19965/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/19965",
  "id": 480941105,
  "node_id": "MDU6SXNzdWU0ODA5NDExMDU=",
  "number": 19965,
  "title": "concurrent map access panic on rinkeby signer shutdown",
  "user": {
    "login": "ryanschneider",
    "id": 53520,
    "node_id": "MDQ6VXNlcjUzNTIw",
    "avatar_url": "https://avatars.githubusercontent.com/u/53520?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ryanschneider",
    "html_url": "https://github.com/ryanschneider",
    "followers_url": "https://api.github.com/users/ryanschneider/followers",
    "following_url": "https://api.github.com/users/ryanschneider/following{/other_user}",
    "gists_url": "https://api.github.com/users/ryanschneider/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ryanschneider/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ryanschneider/subscriptions",
    "organizations_url": "https://api.github.com/users/ryanschneider/orgs",
    "repos_url": "https://api.github.com/users/ryanschneider/repos",
    "events_url": "https://api.github.com/users/ryanschneider/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ryanschneider/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "holiman",
    "id": 142290,
    "node_id": "MDQ6VXNlcjE0MjI5MA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/holiman",
    "html_url": "https://github.com/holiman",
    "followers_url": "https://api.github.com/users/holiman/followers",
    "following_url": "https://api.github.com/users/holiman/following{/other_user}",
    "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
    "organizations_url": "https://api.github.com/users/holiman/orgs",
    "repos_url": "https://api.github.com/users/holiman/repos",
    "events_url": "https://api.github.com/users/holiman/events{/privacy}",
    "received_events_url": "https://api.github.com/users/holiman/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "holiman",
      "id": 142290,
      "node_id": "MDQ6VXNlcjE0MjI5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/142290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holiman",
      "html_url": "https://github.com/holiman",
      "followers_url": "https://api.github.com/users/holiman/followers",
      "following_url": "https://api.github.com/users/holiman/following{/other_user}",
      "gists_url": "https://api.github.com/users/holiman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holiman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holiman/subscriptions",
      "organizations_url": "https://api.github.com/users/holiman/orgs",
      "repos_url": "https://api.github.com/users/holiman/repos",
      "events_url": "https://api.github.com/users/holiman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holiman/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2019-08-15T00:13:24Z",
  "updated_at": "2021-10-08T16:36:58Z",
  "closed_at": "2021-10-08T16:36:58Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "I was updating our rinkeby signer to latest master, and hit a concurrent map read/write panic when shutting down the previous binary.\r\n\r\n#### System information\r\n\r\nGeth version: `geth-1.9.2-unstable-e46a01d5-20190801`\r\nOS & Version: Linux\r\nCommit hash : e46a01d5\r\n\r\n#### Expected behaviour\r\n\r\nGeth should stop w/o panicking.\r\n\r\n#### Actual behaviour\r\n\r\nWhen doing our bi-weekly update of our rinkeby signer to the latest master, the previous binary panicked on shutdown:\r\n\r\n```\r\nAug 14 23:43:18 ip-10-0-22-38 geth[13503]: fatal error: concurrent map read and map write\r\nAug 14 23:43:18 ip-10-0-22-38 geth[13503]: goroutine 157983496 [running]:\r\nAug 14 23:43:18 ip-10-0-22-38 geth[13503]: runtime.throw(0x1151601, 0x21)\r\nAug 14 23:43:18 ip-10-0-22-38 geth[13503]:         /usr/local/go/src/runtime/panic.go:617 +0x72 fp=0xc111cd9590 sp=0xc111cd9560 pc=0x4430d2\r\nAug 14 23:43:18 ip-10-0-22-38 geth[13503]: runtime.mapaccess2(0xfb4560, 0xc0001f4750, 0xc111cd9678, 0x246e9e0, 0xc038350400)\r\nAug 14 23:43:18 ip-10-0-22-38 geth[13503]:         /usr/local/go/src/runtime/map.go:472 +0x272 fp=0xc111cd95d8 sp=0xc111cd9590 pc=0x4234c2\r\nAug 14 23:43:18 ip-10-0-22-38 geth[13503]: github.com/ethereum/go-ethereum/trie.(*Database).commit(0xc00020eb00, 0xed8e1e9ffe9cdb37, 0xb8ef5fc4abc3ef69, 0xfa66c2eb2e4a6be0, 0x16b7df03cead0450, 0x13e0960, 0xc0087354c0, 0xc048492988, 0x0, 0x0)\r\n```\r\n\r\nFull log attached below.\r\n\r\n#### Steps to reproduce the behaviour\r\n\r\nShutdown a node running commit e46a01d5.  Not sure if it needs to be a Clique signer or not.\r\n\r\n#### Backtrace\r\n\r\nAttached.\r\n\r\n[geth-1.9.2-unstable-e46a01d5-20190801-panic.log](https://github.com/ethereum/go-ethereum/files/3503818/geth-1.9.2-unstable-e46a01d5-20190801-panic.log)",
  "closed_by": {
    "login": "fjl",
    "id": 6915,
    "node_id": "MDQ6VXNlcjY5MTU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6915?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/fjl",
    "html_url": "https://github.com/fjl",
    "followers_url": "https://api.github.com/users/fjl/followers",
    "following_url": "https://api.github.com/users/fjl/following{/other_user}",
    "gists_url": "https://api.github.com/users/fjl/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/fjl/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/fjl/subscriptions",
    "organizations_url": "https://api.github.com/users/fjl/orgs",
    "repos_url": "https://api.github.com/users/fjl/repos",
    "events_url": "https://api.github.com/users/fjl/events{/privacy}",
    "received_events_url": "https://api.github.com/users/fjl/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19965/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19965/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/521622783",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/19965#issuecomment-521622783",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19965",
    "id": 521622783,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUyMTYyMjc4Mw==",
    "user": {
      "login": "karalabe",
      "id": 129561,
      "node_id": "MDQ6VXNlcjEyOTU2MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/karalabe",
      "html_url": "https://github.com/karalabe",
      "followers_url": "https://api.github.com/users/karalabe/followers",
      "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
      "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
      "organizations_url": "https://api.github.com/users/karalabe/orgs",
      "repos_url": "https://api.github.com/users/karalabe/repos",
      "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
      "received_events_url": "https://api.github.com/users/karalabe/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-08-15T12:25:03Z",
    "updated_at": "2019-08-15T12:25:03Z",
    "author_association": "MEMBER",
    "body": "Based on the logs the error seems to be a rare race where Geth is shut down exactly when the miner found a block and is updating it's new state (hey, congrats, you managed to hit a 10ms window :D). The issue seems to be that the miner calls a block insertion on the chain, but this is not synchronized with chain termination, so the miner-insert changes the trie and concurrently the shutdown started flushing the trie.\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/521622783/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/542812194",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/19965#issuecomment-542812194",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19965",
    "id": 542812194,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU0MjgxMjE5NA==",
    "user": {
      "login": "ryanschneider",
      "id": 53520,
      "node_id": "MDQ6VXNlcjUzNTIw",
      "avatar_url": "https://avatars.githubusercontent.com/u/53520?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanschneider",
      "html_url": "https://github.com/ryanschneider",
      "followers_url": "https://api.github.com/users/ryanschneider/followers",
      "following_url": "https://api.github.com/users/ryanschneider/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanschneider/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanschneider/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanschneider/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanschneider/orgs",
      "repos_url": "https://api.github.com/users/ryanschneider/repos",
      "events_url": "https://api.github.com/users/ryanschneider/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanschneider/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-10-16T17:39:06Z",
    "updated_at": "2019-10-16T17:39:06Z",
    "author_association": "CONTRIBUTOR",
    "body": "FWIW this seems to happen just about every time we update our rinkeby signer, still occurring with `1.9.7-unstable-73003659-20191016`:\r\n\r\n```\r\nOct 16 17:30:05 ip-10-0-22-38 geth[11685]: fatal error: concurrent map read and map write\r\nOct 16 17:30:05 ip-10-0-22-38 geth[11685]: goroutine 143027533 [running]:\r\nOct 16 17:30:05 ip-10-0-22-38 geth[11685]: runtime.throw(0x116a0b3, 0x21)\r\nOct 16 17:30:05 ip-10-0-22-38 geth[11685]:         /usr/local/go/src/runtime/panic.go:617 +0x72 fp=0xc010702d20 sp=0xc010702cf0 pc=0x4430d2\r\nOct 16 17:30:05 ip-10-0-22-38 geth[11685]: runtime.mapaccess2(0xfca4c0, 0xc001245a10, 0xc010702e08, 0x20, 0xc0017e33e0)\r\nOct 16 17:30:05 ip-10-0-22-38 geth[11685]:         /usr/local/go/src/runtime/map.go:472 +0x272 fp=0xc010702d68 sp=0xc010702d20 pc=0x4234c2\r\nOct 16 17:30:05 ip-10-0-22-38 geth[11685]: github.com/ethereum/go-ethereum/trie.(*Database).commit(0xc001a12000, 0xfc67f6f8c03cea2d, 0x3d07dfe47caf6436, 0xf470f8c86e41cd34, 0x35bc637f908b2def, 0x1407d60,\r\nOct 16 17:30:05 ip-10-0-22-38 geth[11685]:         /ext-go/1/src/github.com/ethereum/go-ethereum/trie/database.go:774 +0xa8 fp=0xc010702e58 sp=0xc010702d68 pc=0x6a0238\r\nOct 16 17:30:05 ip-10-0-22-38 geth[11685]: github.com/ethereum/go-ethereum/trie.(*Database).commit(0xc001a12000, 0x50bc5297dfefe6b5, 0x7f2c69053d6f7ad3, 0xd907ee1462f67932, 0xa5641a809ddc18a9, 0x1407d60,\r\nOct 16 17:30:05 ip-10-0-22-38 geth[11685]:         /ext-go/1/src/github.com/ethereum/go-ethereum/trie/database.go:779 +0x184 fp=0xc010702f48 sp=0xc010702e58 pc=0x6a0314\r\nOct 16 17:30:05 ip-10-0-22-38 geth[11685]: github.com/ethereum/go-ethereum/trie.(*Database).commit(0xc001a12000, 0xa4a0503ccb6d82cc, 0x530c3b981d395b78, 0x372d23aebb08b36f, 0x9d6ea4ca33525342, 0x1407d60,\r\nOct 16 17:30:05 ip-10-0-22-38 geth[11685]:         /ext-go/1/src/github.com/ethereum/go-ethereum/trie/database.go:779 +0x184 fp=0xc010703038 sp=0xc010702f48 pc=0x6a0314\r\nOct 16 17:30:05 ip-10-0-22-38 geth[11685]: github.com/ethereum/go-ethereum/trie.(*Database).commit(0xc001a12000, 0xc6f2d0acac044c9e, 0xbab0718a5b29e00e, 0x4c09416e02ceebcc, 0xaaa85dafecf5c8fe, 0x1407d60,\r\nOct 16 17:30:05 ip-10-0-22-38 geth[11685]:         /ext-go/1/src/github.com/ethereum/go-ethereum/trie/database.go:779 +0x184 fp=0xc010703128 sp=0xc010703038 pc=0x6a0314\r\n```\r\n\r\nAs I mentioned in #20175 we're still building w/ go 1.12 since I haven't figured out how to cross-compile w/ go 1.13, maybe this issue is unique to the older toolchain?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/542812194/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/542814310",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/19965#issuecomment-542814310",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19965",
    "id": 542814310,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU0MjgxNDMxMA==",
    "user": {
      "login": "ryanschneider",
      "id": 53520,
      "node_id": "MDQ6VXNlcjUzNTIw",
      "avatar_url": "https://avatars.githubusercontent.com/u/53520?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanschneider",
      "html_url": "https://github.com/ryanschneider",
      "followers_url": "https://api.github.com/users/ryanschneider/followers",
      "following_url": "https://api.github.com/users/ryanschneider/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanschneider/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanschneider/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanschneider/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanschneider/orgs",
      "repos_url": "https://api.github.com/users/ryanschneider/repos",
      "events_url": "https://api.github.com/users/ryanschneider/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanschneider/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-10-16T17:44:09Z",
    "updated_at": "2019-10-16T17:44:09Z",
    "author_association": "CONTRIBUTOR",
    "body": "Also note that when this happens, the signer ends up ~200,000 blocks behind head, presumably because flushing leveldb fails and thus we end up at a older leveldb revision on startup.\r\n\r\n<img width=\"1440\" alt=\"image\" src=\"https://user-images.githubusercontent.com/53520/66944325-ceff9280-f001-11e9-8977-b2b81ce0e071.png\">\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/542814310/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/577383068",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/19965#issuecomment-577383068",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19965",
    "id": 577383068,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU3NzM4MzA2OA==",
    "user": {
      "login": "shazow",
      "id": 6292,
      "node_id": "MDQ6VXNlcjYyOTI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6292?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/shazow",
      "html_url": "https://github.com/shazow",
      "followers_url": "https://api.github.com/users/shazow/followers",
      "following_url": "https://api.github.com/users/shazow/following{/other_user}",
      "gists_url": "https://api.github.com/users/shazow/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/shazow/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/shazow/subscriptions",
      "organizations_url": "https://api.github.com/users/shazow/orgs",
      "repos_url": "https://api.github.com/users/shazow/repos",
      "events_url": "https://api.github.com/users/shazow/events{/privacy}",
      "received_events_url": "https://api.github.com/users/shazow/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-01-22T21:00:13Z",
    "updated_at": "2020-01-22T21:00:13Z",
    "author_association": "CONTRIBUTOR",
    "body": "Also reproduced on\r\n\r\n```\r\nVersion: 1.9.10-unstable\r\nGit Commit: a67fe48b43bfaa750d264bab54c1ea1a15c2a8f7\r\nGit Commit Date: 20191220\r\nArchitecture: amd64\r\nProtocol Versions: [64 63]\r\nGo Version: go1.13.4\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/577383068/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/802148965",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/19965#issuecomment-802148965",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/19965",
    "id": 802148965,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwMjE0ODk2NQ==",
    "user": {
      "login": "ryanschneider",
      "id": 53520,
      "node_id": "MDQ6VXNlcjUzNTIw",
      "avatar_url": "https://avatars.githubusercontent.com/u/53520?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanschneider",
      "html_url": "https://github.com/ryanschneider",
      "followers_url": "https://api.github.com/users/ryanschneider/followers",
      "following_url": "https://api.github.com/users/ryanschneider/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanschneider/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanschneider/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanschneider/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanschneider/orgs",
      "repos_url": "https://api.github.com/users/ryanschneider/repos",
      "events_url": "https://api.github.com/users/ryanschneider/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanschneider/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-18T17:32:27Z",
    "updated_at": "2021-03-18T17:32:27Z",
    "author_association": "CONTRIBUTOR",
    "body": "This is still happening on 1.10.x as of `Geth/v1.10.1-unstable-dab90e4d-20210304/linux-amd64/go1.16` here's the latest incident logs: \r\n\r\nhttps://gist.github.com/ryanschneider/0afc3cdd07f273316c0056d7bb0640a2",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/802148965/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
