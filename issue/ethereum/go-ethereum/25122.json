{
  "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/25122",
  "repository_url": "https://api.github.com/repos/ethereum/go-ethereum",
  "labels_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/25122/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/25122/comments",
  "events_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/25122/events",
  "html_url": "https://github.com/ethereum/go-ethereum/issues/25122",
  "id": 1275157386,
  "node_id": "I_kwDOAOvK985MAVuK",
  "number": 25122,
  "title": "leveldb filesystem structure with no subdirectories will become a problem over time",
  "user": {
    "login": "c0deright",
    "id": 20477825,
    "node_id": "MDQ6VXNlcjIwNDc3ODI1",
    "avatar_url": "https://avatars.githubusercontent.com/u/20477825?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/c0deright",
    "html_url": "https://github.com/c0deright",
    "followers_url": "https://api.github.com/users/c0deright/followers",
    "following_url": "https://api.github.com/users/c0deright/following{/other_user}",
    "gists_url": "https://api.github.com/users/c0deright/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/c0deright/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/c0deright/subscriptions",
    "organizations_url": "https://api.github.com/users/c0deright/orgs",
    "repos_url": "https://api.github.com/users/c0deright/repos",
    "events_url": "https://api.github.com/users/c0deright/events{/privacy}",
    "received_events_url": "https://api.github.com/users/c0deright/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2022-06-17T15:19:21Z",
  "updated_at": "2022-11-19T18:19:54Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "geth uses leveldb to store the blockchain in `$datadir/geth/chaindata`.\r\n\r\nRight now I'm running geth with `--syncmode full` and geth is at block 4,834,322 (last block right now: 14,979,825). With appr. 32% synced so far the directory `$datadir/geth/chaindata` has ~76,000 files in it:\r\n\r\n```bash\r\nfind /data/geth/chaindata/ -mindepth 1 -maxdepth 1 -type f | wc -l\r\n76470\r\n```\r\n\r\nMost of these leveldb files are only 2.1MB in size.\r\n\r\nWith ever increasing inodes in the directory `chaindata` it will become a problem for some filesystems to even list the contents of that directory. It would be much more useful to use a directory structure that places files in one or two level deep directories so there won't be a single directory with a million small files one day.\r\n\r\nBitcoin Core for example stores raw block data in files of size ~128MB and then uses leveldb to store an index only.\r\n\r\nRunning geth with `--gcmode archive` most definately will render the `chaindata` directory unmanageable (think of backups, rsync, ...). Each process that openes the directory to read the directory structure will take ages.",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/25122/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/25122/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1158983622",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/25122#issuecomment-1158983622",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/25122",
    "id": 1158983622,
    "node_id": "IC_kwDOAOvK985FFK_G",
    "user": {
      "login": "c0deright",
      "id": 20477825,
      "node_id": "MDQ6VXNlcjIwNDc3ODI1",
      "avatar_url": "https://avatars.githubusercontent.com/u/20477825?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/c0deright",
      "html_url": "https://github.com/c0deright",
      "followers_url": "https://api.github.com/users/c0deright/followers",
      "following_url": "https://api.github.com/users/c0deright/following{/other_user}",
      "gists_url": "https://api.github.com/users/c0deright/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/c0deright/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/c0deright/subscriptions",
      "organizations_url": "https://api.github.com/users/c0deright/orgs",
      "repos_url": "https://api.github.com/users/c0deright/repos",
      "events_url": "https://api.github.com/users/c0deright/events{/privacy}",
      "received_events_url": "https://api.github.com/users/c0deright/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-06-17T15:26:31Z",
    "updated_at": "2022-06-17T15:26:31Z",
    "author_association": "NONE",
    "body": "```bash\r\necho 3 > /proc/sys/vm/drop_caches\r\ntime ls -l /data/geth/geth/chaindata >/dev/null\r\n\r\nreal    0m2.248s\r\nuser    0m0.229s\r\nsys     0m0.622s\r\n```\r\n\r\nover 2.2 seconds to generate the directory listing for a little over 70.000 files on an AWS EBS volume (SSD backed).",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1158983622/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1160077606",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/25122#issuecomment-1160077606",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/25122",
    "id": 1160077606,
    "node_id": "IC_kwDOAOvK985FJWEm",
    "user": {
      "login": "karalabe",
      "id": 129561,
      "node_id": "MDQ6VXNlcjEyOTU2MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/129561?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/karalabe",
      "html_url": "https://github.com/karalabe",
      "followers_url": "https://api.github.com/users/karalabe/followers",
      "following_url": "https://api.github.com/users/karalabe/following{/other_user}",
      "gists_url": "https://api.github.com/users/karalabe/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/karalabe/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/karalabe/subscriptions",
      "organizations_url": "https://api.github.com/users/karalabe/orgs",
      "repos_url": "https://api.github.com/users/karalabe/repos",
      "events_url": "https://api.github.com/users/karalabe/events{/privacy}",
      "received_events_url": "https://api.github.com/users/karalabe/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-06-20T07:29:38Z",
    "updated_at": "2022-06-20T07:29:38Z",
    "author_association": "MEMBER",
    "body": "We're aware of this issue.\r\n\r\nUsing files larger than 2MB blows up disk IO as compaction becomes exponentially heavier. Would have been nice to split the files across multiple folders in leveldb, but it does not support that and I'm not confident enough about starting to implement a new storage engine, especially as the upstream project doesn't really accept contributions any more.\r\n\r\nWe're currently in progress of experimenting with Pebble, aiming to switch over to that fully eventually. I'm unsure if that supports nested dbs, but it might make more sense to try and get it into that. Raising the level sizes still causes insane writes in Pebble too.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1160077606/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1320939590",
    "html_url": "https://github.com/ethereum/go-ethereum/issues/25122#issuecomment-1320939590",
    "issue_url": "https://api.github.com/repos/ethereum/go-ethereum/issues/25122",
    "id": 1320939590,
    "node_id": "IC_kwDOAOvK985Ou_BG",
    "user": {
      "login": "Abuzik",
      "id": 20861156,
      "node_id": "MDQ6VXNlcjIwODYxMTU2",
      "avatar_url": "https://avatars.githubusercontent.com/u/20861156?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Abuzik",
      "html_url": "https://github.com/Abuzik",
      "followers_url": "https://api.github.com/users/Abuzik/followers",
      "following_url": "https://api.github.com/users/Abuzik/following{/other_user}",
      "gists_url": "https://api.github.com/users/Abuzik/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Abuzik/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Abuzik/subscriptions",
      "organizations_url": "https://api.github.com/users/Abuzik/orgs",
      "repos_url": "https://api.github.com/users/Abuzik/repos",
      "events_url": "https://api.github.com/users/Abuzik/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Abuzik/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-11-19T18:19:54Z",
    "updated_at": "2022-11-19T18:19:54Z",
    "author_association": "NONE",
    "body": "> We're aware of this issue.\r\n> \r\n> Using files larger than 2MB blows up disk IO as compaction becomes exponentially heavier. Would have been nice to split the files across multiple folders in leveldb, but it does not support that and I'm not confident enough about starting to implement a new storage engine, especially as the upstream project doesn't really accept contributions any more.\r\n> \r\n> We're currently in progress of experimenting with Pebble, aiming to switch over to that fully eventually. I'm unsure if that supports nested dbs, but it might make more sense to try and get it into that. Raising the level sizes still causes insane writes in Pebble too.\r\n\r\nAnd the real updates from DBs which are leveldb-based - in rocksDB only. At least they've added column families...",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/go-ethereum/issues/comments/1320939590/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
