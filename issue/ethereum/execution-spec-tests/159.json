{
  "url": "https://api.github.com/repos/ethereum/execution-spec-tests/issues/159",
  "repository_url": "https://api.github.com/repos/ethereum/execution-spec-tests",
  "labels_url": "https://api.github.com/repos/ethereum/execution-spec-tests/issues/159/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/execution-spec-tests/issues/159/comments",
  "events_url": "https://api.github.com/repos/ethereum/execution-spec-tests/issues/159/events",
  "html_url": "https://github.com/ethereum/execution-spec-tests/issues/159",
  "id": 1769379371,
  "node_id": "I_kwDOIQGLK85pdpYr",
  "number": 159,
  "title": "Fixtures missing from JSON when using pytest-xdist",
  "user": {
    "login": "danceratopz",
    "id": 91727015,
    "node_id": "U_kgDOBXekpw",
    "avatar_url": "https://avatars.githubusercontent.com/u/91727015?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/danceratopz",
    "html_url": "https://github.com/danceratopz",
    "followers_url": "https://api.github.com/users/danceratopz/followers",
    "following_url": "https://api.github.com/users/danceratopz/following{/other_user}",
    "gists_url": "https://api.github.com/users/danceratopz/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/danceratopz/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/danceratopz/subscriptions",
    "organizations_url": "https://api.github.com/users/danceratopz/orgs",
    "repos_url": "https://api.github.com/users/danceratopz/repos",
    "events_url": "https://api.github.com/users/danceratopz/events{/privacy}",
    "received_events_url": "https://api.github.com/users/danceratopz/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2023-06-22T10:15:59Z",
  "updated_at": "2023-06-23T16:26:33Z",
  "closed_at": "2023-06-23T16:26:33Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "The `pytest-xdist` allows concurrent execution of test cases. If we enable xdist when running pytest for test cases, certain fixtures are not written to file even though the same amount of tests are reported to be executed from python.\r\n\r\nTo reproduce:\r\n```console\r\nrm -rf fixtures-without-xdist fixtures-with-xdist\r\nfill -v --output=fixtures-without-xdist\r\nfill -v -n auto --output=fixtures-with-xdist\r\nack -c \"0\\d\\d-fork=\" fixtures-without-xdist/ | awk -F: '{ total += $2 } END { print total }'\r\n# -> 134\r\nack -c \"0\\d\\d-fork=\" fixtures-with-xdist/ | awk -F: '{ total += $2 } END { print total }'\r\n# -> 35\r\n```\r\nAdditionally, we should make the fork+test ordering and naming deterministic within fixtures. The top-level fork+test entries in the JSON fixtures are not deterministically ordered by fork+test. The goal would be to generate fixtures that are identical to those generated without using the xdist plugin.\r\n\r\nOriginally spotted by @spencer-tb!",
  "closed_by": {
    "login": "marioevz",
    "id": 11726710,
    "node_id": "MDQ6VXNlcjExNzI2NzEw",
    "avatar_url": "https://avatars.githubusercontent.com/u/11726710?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/marioevz",
    "html_url": "https://github.com/marioevz",
    "followers_url": "https://api.github.com/users/marioevz/followers",
    "following_url": "https://api.github.com/users/marioevz/following{/other_user}",
    "gists_url": "https://api.github.com/users/marioevz/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/marioevz/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/marioevz/subscriptions",
    "organizations_url": "https://api.github.com/users/marioevz/orgs",
    "repos_url": "https://api.github.com/users/marioevz/repos",
    "events_url": "https://api.github.com/users/marioevz/events{/privacy}",
    "received_events_url": "https://api.github.com/users/marioevz/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/execution-spec-tests/issues/159/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/execution-spec-tests/issues/159/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/execution-spec-tests/issues/comments/1604250000",
    "html_url": "https://github.com/ethereum/execution-spec-tests/issues/159#issuecomment-1604250000",
    "issue_url": "https://api.github.com/repos/ethereum/execution-spec-tests/issues/159",
    "id": 1604250000,
    "node_id": "IC_kwDOIQGLK85fnumQ",
    "user": {
      "login": "danceratopz",
      "id": 91727015,
      "node_id": "U_kgDOBXekpw",
      "avatar_url": "https://avatars.githubusercontent.com/u/91727015?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/danceratopz",
      "html_url": "https://github.com/danceratopz",
      "followers_url": "https://api.github.com/users/danceratopz/followers",
      "following_url": "https://api.github.com/users/danceratopz/following{/other_user}",
      "gists_url": "https://api.github.com/users/danceratopz/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/danceratopz/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/danceratopz/subscriptions",
      "organizations_url": "https://api.github.com/users/danceratopz/orgs",
      "repos_url": "https://api.github.com/users/danceratopz/repos",
      "events_url": "https://api.github.com/users/danceratopz/events{/privacy}",
      "received_events_url": "https://api.github.com/users/danceratopz/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-06-23T12:59:25Z",
    "updated_at": "2023-06-23T12:59:56Z",
    "author_association": "MEMBER",
    "body": "When python-xdist is enabled, each worker performs collection and sends the results back to the controller. Then the controller sends indices corresponding to a collected test id to the worker to execute the test. Fixtures, even session-scoped fixtures are executed in the pytest execution on each worker and the data is not joined automatically on the controller by default. In our case, the FixtureCollector is doing its job only for the subset of tests that get executed on each worker.\r\n\r\nA nice partial and quick solution is to execute pytest-xdist using `--dist loadscipe` which seems sufficient for our current needs. I.e.,\r\n```console\r\nfill -n auto --dist loadscope\r\n```\r\nwhere the `--dist` flag:\r\n```console\r\n--dist=distmode       set mode for distributing tests to exec environments.\r\n<-- snip -->\r\n                        loadscope: load balance by sending pending groups of tests in the same scope to any available environment.\r\n```\r\nThis ensures that all parametrizations of a test are executed on the same xdist worker, instead of being distributed equally across workers. In particular, this means that all the fixtures for one test case are executed on one work and the FixtureCollector will collect all the parametrized cases for this test and write them correctly to file, as for the `-n 0` case.\r\n\r\nThis has the consequence that running single test cases with xdist won't receive any speed-up, as they'll only use one worker. In this case, however, run time is probably not very critical. \r\n\r\nBenchmark on 4c402abcac4d13efde9f2a67f9a70363088d70a5 with 4844 tests on a laptop with 16 cores:\r\n- `fill --until Cancun -n 0` - 112 seconds.\r\n- `fill --until Cancun -n auto --dist loadscope` - 35 seconds.\r\n- `fill --until Cancun -n auto` - 23 seconds.\r\n\r\nThe disparity between the 2 xdist runs seems to come from the fact that without limiting the distribution via `loadscope`, xdist does a better load balancing across workers, whereas with `loadscope` the load balancing is limited to the granularity of the test scopes used. This should become less relevant as the number of test cases increases.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/execution-spec-tests/issues/comments/1604250000/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
