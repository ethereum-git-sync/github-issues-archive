{
  "url": "https://api.github.com/repos/ethereum/execution-spec-tests/issues/343",
  "repository_url": "https://api.github.com/repos/ethereum/execution-spec-tests",
  "labels_url": "https://api.github.com/repos/ethereum/execution-spec-tests/issues/343/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/execution-spec-tests/issues/343/comments",
  "events_url": "https://api.github.com/repos/ethereum/execution-spec-tests/issues/343/events",
  "html_url": "https://github.com/ethereum/execution-spec-tests/issues/343",
  "id": 1982044310,
  "node_id": "I_kwDOIQGLK852I5iW",
  "number": 343,
  "title": "Zero `max_fee_per_blob_gas` test is ineffective",
  "user": {
    "login": "marioevz",
    "id": 11726710,
    "node_id": "MDQ6VXNlcjExNzI2NzEw",
    "avatar_url": "https://avatars.githubusercontent.com/u/11726710?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/marioevz",
    "html_url": "https://github.com/marioevz",
    "followers_url": "https://api.github.com/users/marioevz/followers",
    "following_url": "https://api.github.com/users/marioevz/following{/other_user}",
    "gists_url": "https://api.github.com/users/marioevz/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/marioevz/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/marioevz/subscriptions",
    "organizations_url": "https://api.github.com/users/marioevz/orgs",
    "repos_url": "https://api.github.com/users/marioevz/repos",
    "events_url": "https://api.github.com/users/marioevz/events{/privacy}",
    "received_events_url": "https://api.github.com/users/marioevz/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 4688377237,
      "node_id": "LA_kwDOIQGLK88AAAABF3L1lQ",
      "url": "https://api.github.com/repos/ethereum/execution-spec-tests/labels/type:bug",
      "name": "type:bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 6008521943,
      "node_id": "LA_kwDOIQGLK88AAAABZiLE1w",
      "url": "https://api.github.com/repos/ethereum/execution-spec-tests/labels/scope:tests",
      "name": "scope:tests",
      "color": "A5D897",
      "default": false,
      "description": "Scope: Test cases"
    },
    {
      "id": 6008698715,
      "node_id": "LA_kwDOIQGLK88AAAABZiV3Ww",
      "url": "https://api.github.com/repos/ethereum/execution-spec-tests/labels/scope:fw",
      "name": "scope:fw",
      "color": "30EAF1",
      "default": false,
      "description": "Scope: Framework (evm|tools|forks|pytest)"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2023-11-07T19:09:55Z",
  "updated_at": "2024-01-10T18:19:13Z",
  "closed_at": "2024-01-10T18:19:13Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "Test [test_invalid_tx_max_fee_per_blob_gas](https://github.com/ethereum/execution-spec-tests/blob/14a629d085b97c0c2e87d5e6ef37916a1ec58930/tests/cancun/eip4844_blobs/test_blob_txs.py#L520C5-L520C41) is passing even when there is an issue in the verification logic as in this commit here: https://github.com/ethereum/go-ethereum/pull/28470/commits/5f39342a76ed32059bf340a8679d6f56fef9d4d9\r\n\r\nThe reason is that the state root included in the test is not the same as the one calculated by geth with the faulty verification logic, because the transaction is executed, and t8n, when there is an invalid transaction in the list of transactions, simply skips the execution and outputs an state root as if the transaction was never executed, but this will almost never be the case if there is a faulty verification, and therefore the block will be still rejected, and the test will pass and won't detect the issue.\r\n\r\nThere are multiple things that we can do to improve this:\r\n- Better check the error that the client returns when the blockchain test is executed, and verify that the client detected the invalid transaction\r\n- Include the test type `TransactionTest` in `execution-spec-tests` for this kind of tests, and also `StateTest`\r\n\r\n\r\n",
  "closed_by": {
    "login": "marioevz",
    "id": 11726710,
    "node_id": "MDQ6VXNlcjExNzI2NzEw",
    "avatar_url": "https://avatars.githubusercontent.com/u/11726710?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/marioevz",
    "html_url": "https://github.com/marioevz",
    "followers_url": "https://api.github.com/users/marioevz/followers",
    "following_url": "https://api.github.com/users/marioevz/following{/other_user}",
    "gists_url": "https://api.github.com/users/marioevz/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/marioevz/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/marioevz/subscriptions",
    "organizations_url": "https://api.github.com/users/marioevz/orgs",
    "repos_url": "https://api.github.com/users/marioevz/repos",
    "events_url": "https://api.github.com/users/marioevz/events{/privacy}",
    "received_events_url": "https://api.github.com/users/marioevz/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/execution-spec-tests/issues/343/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/execution-spec-tests/issues/343/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/execution-spec-tests/issues/comments/1799766178",
    "html_url": "https://github.com/ethereum/execution-spec-tests/issues/343#issuecomment-1799766178",
    "issue_url": "https://api.github.com/repos/ethereum/execution-spec-tests/issues/343",
    "id": 1799766178,
    "node_id": "IC_kwDOIQGLK85rRkCi",
    "user": {
      "login": "marioevz",
      "id": 11726710,
      "node_id": "MDQ6VXNlcjExNzI2NzEw",
      "avatar_url": "https://avatars.githubusercontent.com/u/11726710?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/marioevz",
      "html_url": "https://github.com/marioevz",
      "followers_url": "https://api.github.com/users/marioevz/followers",
      "following_url": "https://api.github.com/users/marioevz/following{/other_user}",
      "gists_url": "https://api.github.com/users/marioevz/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/marioevz/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/marioevz/subscriptions",
      "organizations_url": "https://api.github.com/users/marioevz/orgs",
      "repos_url": "https://api.github.com/users/marioevz/repos",
      "events_url": "https://api.github.com/users/marioevz/events{/privacy}",
      "received_events_url": "https://api.github.com/users/marioevz/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-11-07T19:32:39Z",
    "updated_at": "2023-11-07T19:32:39Z",
    "author_association": "MEMBER",
    "body": "PR where this issue was highlighted: https://github.com/ethereum/go-ethereum/pull/28470",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/execution-spec-tests/issues/comments/1799766178/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/execution-spec-tests/issues/comments/1801925647",
    "html_url": "https://github.com/ethereum/execution-spec-tests/issues/343#issuecomment-1801925647",
    "issue_url": "https://api.github.com/repos/ethereum/execution-spec-tests/issues/343",
    "id": 1801925647,
    "node_id": "IC_kwDOIQGLK85rZzQP",
    "user": {
      "login": "danceratopz",
      "id": 91727015,
      "node_id": "U_kgDOBXekpw",
      "avatar_url": "https://avatars.githubusercontent.com/u/91727015?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/danceratopz",
      "html_url": "https://github.com/danceratopz",
      "followers_url": "https://api.github.com/users/danceratopz/followers",
      "following_url": "https://api.github.com/users/danceratopz/following{/other_user}",
      "gists_url": "https://api.github.com/users/danceratopz/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/danceratopz/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/danceratopz/subscriptions",
      "organizations_url": "https://api.github.com/users/danceratopz/orgs",
      "repos_url": "https://api.github.com/users/danceratopz/repos",
      "events_url": "https://api.github.com/users/danceratopz/events{/privacy}",
      "received_events_url": "https://api.github.com/users/danceratopz/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-11-08T13:47:50Z",
    "updated_at": "2023-11-08T13:47:50Z",
    "author_association": "MEMBER",
    "body": "> * Better check the error that the client returns when the blockchain test is executed, and verify that the client detected the invalid transaction\r\n\r\nThis check could be performed either in:\r\n1. `blocktest` directly, or\r\n2.  In a wrapper to blockest (like `consume`?) that inspects the fixture for expected exception behavior and checks that this matches the log/stderr output from `evm blocktest`.\r\n\r\nOption 1. is perhaps achievable, but could be tricky, as it requires re-ordering the test execution logic by checking exceptions, if specified in the test, before checking state/transaction roots. This may be out of the question, as some checks which happen within the EVM itself can't simply be re-ordered. \r\n\r\nAdding 2. could be a helpful check that gives us more confidence in our tests and assures us that we're not seeing false positives. However, it seems a poor approach to depend on this entirely if the `blocktest` command can't detect fails directly and requires external tooling.\r\n\r\n> * Include the test type `TransactionTest` in `execution-spec-tests` for this kind of tests, and also `StateTest`\r\n\r\nThis seems to be the approach to focus on for invalid txs as we don't need the additional data and checks.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/execution-spec-tests/issues/comments/1801925647/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/execution-spec-tests/issues/comments/1841858437",
    "html_url": "https://github.com/ethereum/execution-spec-tests/issues/343#issuecomment-1841858437",
    "issue_url": "https://api.github.com/repos/ethereum/execution-spec-tests/issues/343",
    "id": 1841858437,
    "node_id": "IC_kwDOIQGLK85tyIeF",
    "user": {
      "login": "marioevz",
      "id": 11726710,
      "node_id": "MDQ6VXNlcjExNzI2NzEw",
      "avatar_url": "https://avatars.githubusercontent.com/u/11726710?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/marioevz",
      "html_url": "https://github.com/marioevz",
      "followers_url": "https://api.github.com/users/marioevz/followers",
      "following_url": "https://api.github.com/users/marioevz/following{/other_user}",
      "gists_url": "https://api.github.com/users/marioevz/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/marioevz/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/marioevz/subscriptions",
      "organizations_url": "https://api.github.com/users/marioevz/orgs",
      "repos_url": "https://api.github.com/users/marioevz/repos",
      "events_url": "https://api.github.com/users/marioevz/events{/privacy}",
      "received_events_url": "https://api.github.com/users/marioevz/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-12-06T00:10:40Z",
    "updated_at": "2023-12-06T00:10:40Z",
    "author_association": "MEMBER",
    "body": "Running the corrected fixture against faulty-geth and fixed-geth yields an unexpected result (I expected to only see the state root mismatch):\r\n\r\n> Fixed geth:\r\n```\r\n########## BAD BLOCK #########\r\nBlock: 1 (0x10f6e56581d45416420f2e4b4604fbc843d48d0fde3b48d972d0631975c05c85)\r\nError: could not apply tx 0 [0x1fa8a76ca36772db403565286e21b752256abfe3fae514e5ab368f705a8910e1]: max fee per blob gas less than block blob gas fee: address 0xa94f5374Fce5edBC8E2a8697C15331677e6EbF0B blobGasFeeCap: 0, blobBaseFee: 1\r\n```\r\n\r\n> Faulty geth:\r\n```\r\n########## BAD BLOCK #########\r\nBlock: 1 (0x10f6e56581d45416420f2e4b4604fbc843d48d0fde3b48d972d0631975c05c85)\r\nError: invalid gas used (remote: 0 local: 21000)\r\n```\r\n\r\nWhat's happening here is that, since t8n was not able to execute the transaction, it did not \"correctly\" populate the following fields:\r\n- The state root is incorrect\r\n- The tx root hash is incorrect\r\n- The block gas used is incorrect\r\n- The receipt hash is incorrect\r\n\r\nThe tx root we can calculate ourselves, but the other three I think it would be very difficult for us to calculate, plus, we can have multiple combinations of these values, depending on how the faulty client executes the faulty block.\r\n\r\nI think the core distinction we need to make in the invalid blocks is, instead of only checking the stateroot, was the client able to execute all transactions or not.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/execution-spec-tests/issues/comments/1841858437/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
