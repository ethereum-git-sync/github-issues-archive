{
  "url": "https://api.github.com/repos/ethereum/yellowpaper/issues/819",
  "repository_url": "https://api.github.com/repos/ethereum/yellowpaper",
  "labels_url": "https://api.github.com/repos/ethereum/yellowpaper/issues/819/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/yellowpaper/issues/819/comments",
  "events_url": "https://api.github.com/repos/ethereum/yellowpaper/issues/819/events",
  "html_url": "https://github.com/ethereum/yellowpaper/issues/819",
  "id": 1027636035,
  "node_id": "I_kwDOARgQGs49QHtD",
  "number": 819,
  "title": "bloom filter has incorrect semantics",
  "user": {
    "login": "hacker-DOM",
    "id": 18601956,
    "node_id": "MDQ6VXNlcjE4NjAxOTU2",
    "avatar_url": "https://avatars.githubusercontent.com/u/18601956?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/hacker-DOM",
    "html_url": "https://github.com/hacker-DOM",
    "followers_url": "https://api.github.com/users/hacker-DOM/followers",
    "following_url": "https://api.github.com/users/hacker-DOM/following{/other_user}",
    "gists_url": "https://api.github.com/users/hacker-DOM/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/hacker-DOM/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/hacker-DOM/subscriptions",
    "organizations_url": "https://api.github.com/users/hacker-DOM/orgs",
    "repos_url": "https://api.github.com/users/hacker-DOM/repos",
    "events_url": "https://api.github.com/users/hacker-DOM/events{/privacy}",
    "received_events_url": "https://api.github.com/users/hacker-DOM/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 0,
  "created_at": "2021-10-15T17:08:17Z",
  "updated_at": "2021-11-02T11:25:07Z",
  "closed_at": "2021-11-02T11:25:07Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "### Notation\r\nThe bloom filter function (BFF) `M` is defined as the bit-wise OR of a set of elements run through the `M_{3:2048}` function:\r\n\r\n<img src=\"https://i.imgur.com/n9Thp21.png\" alt=\"drawing\" width=\"400\"/>\r\n\r\nI'll call the former the `combined BFF` and the latter a `single BFF`.\r\n\r\n### Background\r\nThe single BFF is defined as follows:\r\n\r\n<img src=\"https://i.imgur.com/KxVcEgU.png\" alt=\"drawing\" width=\"400\"/>\r\n\r\nIn plain English, it amounts to returning a bit sequence of length 2048 with up to 3 bits set to 1.\r\n\r\n### Description\r\nI believe the `m` function is defined differently than in most implementations.\r\n\r\n**Let's have a look at K-EVM**\r\n\r\nOn one of last lines of https://github.com/kframework/evm-semantics/blob/master/evm.md#block-processing, we have:\r\n\r\n```k\r\nrule setBloomFilterBits(HASH) => (1 <<Int getBloomFilterBit(HASH, 0)) |Int (1 <<Int getBloomFilterBit(HASH, 2)) |Int (1 <<Int getBloomFilterBit(HASH, 4))\r\n\r\nrule getBloomFilterBit(X, I) => #asInteger(X [ I .. 2 ]) %Int 2048\r\n```\r\n\r\nThis implementation will set bits counting from the least-significant bit. E.g. if the first byte of the hash is `0x00`, then only the least-significant bit will be set. (Note that this implementation *may* be subject to a [different issue](https://github.com/kframework/evm-semantics/issues/1144).)\r\n\r\n**Let's have a look at eth-bloom, which is used in [`py-evm`](https://github.com/ethereum/py-evm/blob/21759ee681315f7099b14893b6ac6d1a5e659bc0/setup.py#L9)**\r\n\r\nThe function [`chunk_to_bloom_bits`](https://github.com/ethereum/eth-bloom/blob/03378183fa3afefff0f366f1a8e9a31d56363b28/eth_bloom/bloom.py#L20-L22) is defined as such:\r\n\r\n```python3\r\ndef chunk_to_bloom_bits(chunk: bytes) -> int:\r\n    high, low = bytearray(chunk)\r\n    return 1 << ((low + (high << 8)) & 2047)\r\n```\r\n\r\nThis implementation is the same as K.\r\n\r\n**Yellow Paper**\r\n\r\nIn the yellow paper however, `\\mathcal{B}` counts from most-significant bits. Not only is this implied by a lack of specification thereof, it is also evident from further uses of this function:\r\n\r\n- https://github.com/ethereum/yellowpaper/blob/6ef60627498bb63bf74b7ffb7a9d2ad207745afa/Paper.tex#L742\r\n- https://github.com/ethereum/yellowpaper/blob/6ef60627498bb63bf74b7ffb7a9d2ad207745afa/Paper.tex#L1834\r\n- https://github.com/ethereum/yellowpaper/blob/6ef60627498bb63bf74b7ffb7a9d2ad207745afa/Paper.tex#L1866\r\n\r\nAs a result, if the first byte of the hash is `0x00`, the most-significant bit will be set. This is at odds with at least two implementations, which activate the least-significant bit in such a case.\r\n\r\n### Recommendation\r\nChange the semantics of the `m(x, i)` function to be a complement of 2047. This will have the same effect as counting from least-significant bits, and so ensure correct semantics.",
  "closed_by": {
    "login": "yperbasis",
    "id": 34320705,
    "node_id": "MDQ6VXNlcjM0MzIwNzA1",
    "avatar_url": "https://avatars.githubusercontent.com/u/34320705?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/yperbasis",
    "html_url": "https://github.com/yperbasis",
    "followers_url": "https://api.github.com/users/yperbasis/followers",
    "following_url": "https://api.github.com/users/yperbasis/following{/other_user}",
    "gists_url": "https://api.github.com/users/yperbasis/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/yperbasis/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/yperbasis/subscriptions",
    "organizations_url": "https://api.github.com/users/yperbasis/orgs",
    "repos_url": "https://api.github.com/users/yperbasis/repos",
    "events_url": "https://api.github.com/users/yperbasis/events{/privacy}",
    "received_events_url": "https://api.github.com/users/yperbasis/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/yellowpaper/issues/819/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/yellowpaper/issues/819/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[

]
