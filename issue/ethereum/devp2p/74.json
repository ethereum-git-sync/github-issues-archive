{
  "url": "https://api.github.com/repos/ethereum/devp2p/issues/74",
  "repository_url": "https://api.github.com/repos/ethereum/devp2p",
  "labels_url": "https://api.github.com/repos/ethereum/devp2p/issues/74/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/devp2p/issues/74/comments",
  "events_url": "https://api.github.com/repos/ethereum/devp2p/issues/74/events",
  "html_url": "https://github.com/ethereum/devp2p/issues/74",
  "id": 426093088,
  "node_id": "MDU6SXNzdWU0MjYwOTMwODg=",
  "number": 74,
  "title": "LES: Server load management proposal - detail ",
  "user": {
    "login": "FrankSzendzielarz",
    "id": 33515470,
    "node_id": "MDQ6VXNlcjMzNTE1NDcw",
    "avatar_url": "https://avatars.githubusercontent.com/u/33515470?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/FrankSzendzielarz",
    "html_url": "https://github.com/FrankSzendzielarz",
    "followers_url": "https://api.github.com/users/FrankSzendzielarz/followers",
    "following_url": "https://api.github.com/users/FrankSzendzielarz/following{/other_user}",
    "gists_url": "https://api.github.com/users/FrankSzendzielarz/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/FrankSzendzielarz/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/FrankSzendzielarz/subscriptions",
    "organizations_url": "https://api.github.com/users/FrankSzendzielarz/orgs",
    "repos_url": "https://api.github.com/users/FrankSzendzielarz/repos",
    "events_url": "https://api.github.com/users/FrankSzendzielarz/events{/privacy}",
    "received_events_url": "https://api.github.com/users/FrankSzendzielarz/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1272598186,
      "node_id": "MDU6TGFiZWwxMjcyNTk4MTg2",
      "url": "https://api.github.com/repos/ethereum/devp2p/labels/proposal",
      "name": "proposal",
      "color": "bffc9f",
      "default": false,
      "description": "Ideas and proposals related to devp2p"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2019-03-27T17:30:30Z",
  "updated_at": "2020-10-07T19:13:26Z",
  "closed_at": null,
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "Ref #66 - this adds detail to that general proposal. It is about defining common cross-platform data structures for both **_hints_** and _**configs**_\r\n\r\n# Load Management - Policies and protocol\r\n\r\n## Requirements\r\n\r\n* General goal :\r\n  * have the server side load management policy in a common format for all types of client implementation - make this an 'ethereum-scoped' format\r\n  * this format or structure would be common to both server side config, rpc admin calls, and messages sent to clients as hints about the server policy\r\n  * get initial general agreement through discussion here before moving it to EIP\r\n  * apply this to various protocols or aspects of protocols: fast-sync, swarm, whisper\r\n  * allow parts of the server side policy to be requested by clients as 'hints' , so clients can proactively manage the load they incur and avoid server policing\r\n  * avoid unexpected terminations of connections, replace this with frozen connections that respond with 'hints' eg: overloaded, and/or warnings that eviction rules are being approached\r\n  * allow for different types of client, such as paid, free, premium, etc..\r\n\r\n* Throttling rules:\r\n  * Rate-limit ([token bucket rate limiter](https://en.wikipedia.org/wiki/Token_bucket)) \r\n    * Allow for burst control eg: a rolling limit of 10 requests per second\r\n  * Quota-limit (fixed time period limiter - eg: per hour, day, month)\r\n    * Allow for subscription-like costs or server-wide limits\r\n  * Multiple options for rule scope\r\n    * Per IP:Port\r\n    * Per Node ID\r\n    * For server\r\n    * Perâ€¦.?\r\n  * Multiple limit units\r\n    * Request count\r\n    * Accumulated message 'weight'\r\n    * ..?\r\n  * API request message *types* may have an absolute id and corresponding 'weight'. Eg: cap/version/message id : N. The 'weight' is determined by the server admin or indirectly via an automated process governed by the server admin. The 'weight' is akin to the SQL Azure concept DTU, which tries to be a general measure of load, taking into account memory usage, IO and compute.\r\n* Hints and Warnings\r\n  * The general protocol (*devp2p*) could allow clients to get parts of the throttling and eviction rules as hint messages. These could be supplied on request (initially, or polling for dynamic updates) and optionally on handshake. Which parts would be up to the server.\r\n    * The message format would be common to all implementations because the payload would be parts of the common throttling/eviction rules spec.\r\n    * Reply messages from the server can contain additional hint payload, such as :\r\n      * Per client rate limiter status (token bucket depletion)\r\n      * ..?\r\n    * When a client exceeds the server policies that apply to it, *devp2p* response messages may include:\r\n      * Rate limit exceeded (equivalent of http 429)\r\n      * Quota exceeded\r\n      * Server temporarily unavailable (equivalent of http 503) - server capacity exceeded due to temporary degradation of resources for the server\r\n* Eviction rules\r\n  * Allow admins to specify under what conditions a client can be evicted:\r\n    * Ignoring too many rate or quota warnings\r\n    * Blowing a rate limiter (0 warnings), as per current LES policy (discouraged)\r\n      * ?\r\n  * These are part of the policy common structure, used as both server config and message to client as a server policy hint\r\n\r\n## Data Model\r\n\r\nOn the basis of the above requirements, I would like to propose a data structure that would be common across Ethereum implementations, used to describe the capacity and eviction policies, both as part of server-side configurations, such as configuration files and administative APIs, and also as message body fragments sent to clients as [*hints*](https://github.com/ethereum/devp2p/issues/70).\r\n\r\n### Example Json\r\n\r\nThe following example expresses a number of capacity management rules. These would be given to servers to govern the devp2p capabilities, and passed to clients as hints.\r\n\r\nTo reiterate and clarify: a rate limiter is a token bucket (leaky bucket) limiter aimed at capping burst demand; a quota limiter is aimed at capping overall bandwidth over an absolute unit of time, eg: megabytes per calendar day. \r\n\r\nFor rate limiters the 'period' describes the refresh rate. So if a rate limiter is 10 calls per 60s, then every 60s the 10 calls will be refreshed (gradually or incrementally, depends on implementation). For quota limiters, every absolute period of time once and once only at the start of the period the limit will be refreshed.\r\n\r\nAll the following is at this stage fairly rough and intended as a starting point for further refinement.\r\n\r\nThis example below conveys the following information:\r\n* There is one policy for LES\r\n* The server treats clients as being one of 4 types: free, paid, greylist, banned. Info on the client status should be in some hint or metadata message (TBD)\r\n* The server enforces a number of rate limiters:\r\n  * 10 calls per 60s for free and paid nodes by Node ID\r\n  * 624 total call weight for 60s for free and paid nodes by Node ID\r\n  * 100 cals per 60s by IP\r\n  * etc\r\n* The server enforces a number of quota limiters:\r\n  * 1000 calls or 9000 message-weight (whichever first) per calendar day in server timezone for free clients\r\n  * ten times as much for paid\r\n* There are some eviction rates and quotas, as numbers of violations per...\r\n* The server specifies message weights. The default value is 0.\r\n\r\nThis would be provided to the server, and the server could also offer clients this in a hint message format.\r\n\r\n~~~~json\r\n{\r\n    \"capability-policies\":[\r\n        {\r\n            \"capability\":\"les\",\r\n            \"clients\": [\r\n                \"free\",\r\n                \"paid\",\r\n                \"greylist\",\r\n                \"banned\"\r\n            ],\r\n            \"rate-limiters\":[\r\n                {\r\n                    \"calls\": 10,\r\n                    \"period\": 60,\r\n                    \"for\" : [\"free\",\"paid\"],\r\n                    \"per\" : \"NodeID\"\r\n                },\r\n                {\r\n                    \"weight\": 624,\r\n                    \"period\": 60,\r\n                    \"for\" : [\"free\",\"paid\"],\r\n                    \"per\" : \"NodeID\"\r\n                },\r\n                {\r\n                    \"calls\": 100,\r\n                    \"period\": 60,\r\n                    \"for\" : [\"free\",\"paid\"],\r\n                    \"per\" : \"IP\"\r\n                },\r\n                {\r\n                    \"calls\": 10000,\r\n                    \"period\": 1,\r\n                    \"for\" : [\"server\"]\r\n                },\r\n                {\r\n                    \"calls\":1,\r\n                    \"period\":60,\r\n                    \"for\" : [\"greylist\"],\r\n                    \"per\" : \"NodeID\"\r\n                },\r\n                {\r\n                    \"calls\":0,\r\n                    \"period\":1,\r\n                    \"for\" : [\"banned\"],\r\n                    \"per\" : \"NodeID\"\r\n                }\r\n            ],\r\n            \"quota-limiters\" :[\r\n                {\r\n                    \"calls\": 1000,\r\n                    \"weight\": 9000,\r\n                    \"periodunit\": \"day\",\r\n                    \"period\":1,\r\n                    \"for\" : [\"free\"],\r\n                    \"per\" : \"NodeID\"\r\n                },\r\n                {\r\n                    \"calls\": 100000,\r\n                    \"weight\": 900000,\r\n                    \"periodunit\": \"month\",\r\n                    \"period\":1,\r\n                    \"for\" : [\"paid\"],\r\n                    \"per\" : \"NodeID\"\r\n                }\r\n            ],\r\n            \"eviction-violation-rates\":{\r\n                \"violations\":10,\r\n                \"period\":10\r\n            },\r\n            \"eviction-violation-quotas\":{\r\n                \"violation\":100,\r\n                \"period\":1,\r\n                \"periodunit\":\"day\"\r\n            },\r\n            \"message-weights\": [\r\n                {\r\n                    \"message\": \"les/1/getblockheaders\",\r\n                    \"weight\": 12\r\n                },\r\n                {\r\n                    \"message\": \"les/1/getblockbodies\",\r\n                    \"weight\": 62\r\n                },\r\n            ]\r\n        }\r\n\r\n    ]\r\n}\r\n~~~~\r\n\r\n### Json Schema\r\n~~~~json\r\n{\r\n  \"$schema\": \"http://json-schema.org/draft-04/schema#\",\r\n  \"type\": \"object\",\r\n  \"properties\": {\r\n    \"capability-policies\": {\r\n      \"type\": \"array\",\r\n      \"items\": [\r\n        {\r\n          \"type\": \"object\",\r\n          \"properties\": {\r\n            \"capability\": {\r\n              \"type\": \"string\"\r\n            },\r\n            \"clients\": {\r\n              \"type\": \"array\",\r\n              \"items\": [\r\n                {\r\n                  \"type\": \"string\"\r\n                },\r\n                {\r\n                  \"type\": \"string\"\r\n                },\r\n                {\r\n                  \"type\": \"string\"\r\n                },\r\n                {\r\n                  \"type\": \"string\"\r\n                }\r\n              ]\r\n            },\r\n            \"rate-limiters\": {\r\n              \"type\": \"array\",\r\n              \"items\": [\r\n                {\r\n                  \"type\": \"object\",\r\n                  \"properties\": {\r\n                    \"calls\": {\r\n                      \"type\": \"integer\"\r\n                    },\r\n                    \"period\": {\r\n                      \"type\": \"integer\"\r\n                    },\r\n                    \"for\": {\r\n                      \"type\": \"array\",\r\n                      \"items\": [\r\n                        {\r\n                          \"type\": \"string\"\r\n                        },\r\n                        {\r\n                          \"type\": \"string\"\r\n                        }\r\n                      ]\r\n                    },\r\n                    \"per\": {\r\n                      \"type\": \"string\"\r\n                    }\r\n                  },\r\n                  \"required\": [\r\n                    \"calls\",\r\n                    \"period\",\r\n                    \"for\",\r\n                    \"per\"\r\n                  ]\r\n                },\r\n                {\r\n                  \"type\": \"object\",\r\n                  \"properties\": {\r\n                    \"weight\": {\r\n                      \"type\": \"integer\"\r\n                    },\r\n                    \"period\": {\r\n                      \"type\": \"integer\"\r\n                    },\r\n                    \"for\": {\r\n                      \"type\": \"array\",\r\n                      \"items\": [\r\n                        {\r\n                          \"type\": \"string\"\r\n                        },\r\n                        {\r\n                          \"type\": \"string\"\r\n                        }\r\n                      ]\r\n                    },\r\n                    \"per\": {\r\n                      \"type\": \"string\"\r\n                    }\r\n                  },\r\n                  \"required\": [\r\n                    \"weight\",\r\n                    \"period\",\r\n                    \"for\",\r\n                    \"per\"\r\n                  ]\r\n                },\r\n                {\r\n                  \"type\": \"object\",\r\n                  \"properties\": {\r\n                    \"calls\": {\r\n                      \"type\": \"integer\"\r\n                    },\r\n                    \"period\": {\r\n                      \"type\": \"integer\"\r\n                    },\r\n                    \"for\": {\r\n                      \"type\": \"array\",\r\n                      \"items\": [\r\n                        {\r\n                          \"type\": \"string\"\r\n                        },\r\n                        {\r\n                          \"type\": \"string\"\r\n                        }\r\n                      ]\r\n                    },\r\n                    \"per\": {\r\n                      \"type\": \"string\"\r\n                    }\r\n                  },\r\n                  \"required\": [\r\n                    \"calls\",\r\n                    \"period\",\r\n                    \"for\",\r\n                    \"per\"\r\n                  ]\r\n                },\r\n                {\r\n                  \"type\": \"object\",\r\n                  \"properties\": {\r\n                    \"calls\": {\r\n                      \"type\": \"integer\"\r\n                    },\r\n                    \"period\": {\r\n                      \"type\": \"integer\"\r\n                    },\r\n                    \"for\": {\r\n                      \"type\": \"array\",\r\n                      \"items\": [\r\n                        {\r\n                          \"type\": \"string\"\r\n                        }\r\n                      ]\r\n                    }\r\n                  },\r\n                  \"required\": [\r\n                    \"calls\",\r\n                    \"period\",\r\n                    \"for\"\r\n                  ]\r\n                },\r\n                {\r\n                  \"type\": \"object\",\r\n                  \"properties\": {\r\n                    \"calls\": {\r\n                      \"type\": \"integer\"\r\n                    },\r\n                    \"period\": {\r\n                      \"type\": \"integer\"\r\n                    },\r\n                    \"for\": {\r\n                      \"type\": \"array\",\r\n                      \"items\": [\r\n                        {\r\n                          \"type\": \"string\"\r\n                        }\r\n                      ]\r\n                    },\r\n                    \"per\": {\r\n                      \"type\": \"string\"\r\n                    }\r\n                  },\r\n                  \"required\": [\r\n                    \"calls\",\r\n                    \"period\",\r\n                    \"for\",\r\n                    \"per\"\r\n                  ]\r\n                },\r\n                {\r\n                  \"type\": \"object\",\r\n                  \"properties\": {\r\n                    \"calls\": {\r\n                      \"type\": \"integer\"\r\n                    },\r\n                    \"period\": {\r\n                      \"type\": \"integer\"\r\n                    },\r\n                    \"for\": {\r\n                      \"type\": \"array\",\r\n                      \"items\": [\r\n                        {\r\n                          \"type\": \"string\"\r\n                        }\r\n                      ]\r\n                    },\r\n                    \"per\": {\r\n                      \"type\": \"string\"\r\n                    }\r\n                  },\r\n                  \"required\": [\r\n                    \"calls\",\r\n                    \"period\",\r\n                    \"for\",\r\n                    \"per\"\r\n                  ]\r\n                }\r\n              ]\r\n            },\r\n            \"quota-limiters\": {\r\n              \"type\": \"array\",\r\n              \"items\": [\r\n                {\r\n                  \"type\": \"object\",\r\n                  \"properties\": {\r\n                    \"calls\": {\r\n                      \"type\": \"integer\"\r\n                    },\r\n                    \"weight\": {\r\n                      \"type\": \"integer\"\r\n                    },\r\n                    \"periodunit\": {\r\n                      \"type\": \"string\"\r\n                    },\r\n                    \"period\": {\r\n                      \"type\": \"integer\"\r\n                    },\r\n                    \"for\": {\r\n                      \"type\": \"array\",\r\n                      \"items\": [\r\n                        {\r\n                          \"type\": \"string\"\r\n                        }\r\n                      ]\r\n                    },\r\n                    \"per\": {\r\n                      \"type\": \"string\"\r\n                    }\r\n                  },\r\n                  \"required\": [\r\n                    \"calls\",\r\n                    \"weight\",\r\n                    \"periodunit\",\r\n                    \"period\",\r\n                    \"for\",\r\n                    \"per\"\r\n                  ]\r\n                },\r\n                {\r\n                  \"type\": \"object\",\r\n                  \"properties\": {\r\n                    \"calls\": {\r\n                      \"type\": \"integer\"\r\n                    },\r\n                    \"weight\": {\r\n                      \"type\": \"integer\"\r\n                    },\r\n                    \"periodunit\": {\r\n                      \"type\": \"string\"\r\n                    },\r\n                    \"period\": {\r\n                      \"type\": \"integer\"\r\n                    },\r\n                    \"for\": {\r\n                      \"type\": \"array\",\r\n                      \"items\": [\r\n                        {\r\n                          \"type\": \"string\"\r\n                        }\r\n                      ]\r\n                    },\r\n                    \"per\": {\r\n                      \"type\": \"string\"\r\n                    }\r\n                  },\r\n                  \"required\": [\r\n                    \"calls\",\r\n                    \"weight\",\r\n                    \"periodunit\",\r\n                    \"period\",\r\n                    \"for\",\r\n                    \"per\"\r\n                  ]\r\n                }\r\n              ]\r\n            },\r\n            \"eviction-violation-rates\": {\r\n              \"type\": \"object\",\r\n              \"properties\": {\r\n                \"violations\": {\r\n                  \"type\": \"integer\"\r\n                },\r\n                \"period\": {\r\n                  \"type\": \"integer\"\r\n                }\r\n              },\r\n              \"required\": [\r\n                \"violations\",\r\n                \"period\"\r\n              ]\r\n            },\r\n            \"eviction-violation-quotas\": {\r\n              \"type\": \"object\",\r\n              \"properties\": {\r\n                \"violation\": {\r\n                  \"type\": \"integer\"\r\n                },\r\n                \"period\": {\r\n                  \"type\": \"integer\"\r\n                },\r\n                \"periodunit\": {\r\n                  \"type\": \"string\"\r\n                }\r\n              },\r\n              \"required\": [\r\n                \"violation\",\r\n                \"period\",\r\n                \"periodunit\"\r\n              ]\r\n            },\r\n            \"message-weights\": {\r\n              \"type\": \"array\",\r\n              \"items\": [\r\n                {\r\n                  \"type\": \"object\",\r\n                  \"properties\": {\r\n                    \"message\": {\r\n                      \"type\": \"string\"\r\n                    },\r\n                    \"weight\": {\r\n                      \"type\": \"integer\"\r\n                    }\r\n                  },\r\n                  \"required\": [\r\n                    \"message\",\r\n                    \"weight\"\r\n                  ]\r\n                },\r\n                {\r\n                  \"type\": \"object\",\r\n                  \"properties\": {\r\n                    \"message\": {\r\n                      \"type\": \"string\"\r\n                    },\r\n                    \"weight\": {\r\n                      \"type\": \"integer\"\r\n                    }\r\n                  },\r\n                  \"required\": [\r\n                    \"message\",\r\n                    \"weight\"\r\n                  ]\r\n                }\r\n              ]\r\n            }\r\n          },\r\n          \"required\": [\r\n            \"capability\",\r\n            \"clients\",\r\n            \"rate-limiters\",\r\n            \"quota-limiters\",\r\n            \"eviction-violation-rates\",\r\n            \"eviction-violation-quotas\",\r\n            \"message-weights\"\r\n          ]\r\n        }\r\n      ]\r\n    }\r\n  },\r\n  \"required\": [\r\n    \"capability-policies\"\r\n  ]\r\n}\r\n~~~~",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/devp2p/issues/74/reactions",
    "total_count": 1,
    "+1": 1,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/devp2p/issues/74/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ethereum/devp2p/issues/comments/478632357",
    "html_url": "https://github.com/ethereum/devp2p/issues/74#issuecomment-478632357",
    "issue_url": "https://api.github.com/repos/ethereum/devp2p/issues/74",
    "id": 478632357,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ3ODYzMjM1Nw==",
    "user": {
      "login": "FrankSzendzielarz",
      "id": 33515470,
      "node_id": "MDQ6VXNlcjMzNTE1NDcw",
      "avatar_url": "https://avatars.githubusercontent.com/u/33515470?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/FrankSzendzielarz",
      "html_url": "https://github.com/FrankSzendzielarz",
      "followers_url": "https://api.github.com/users/FrankSzendzielarz/followers",
      "following_url": "https://api.github.com/users/FrankSzendzielarz/following{/other_user}",
      "gists_url": "https://api.github.com/users/FrankSzendzielarz/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/FrankSzendzielarz/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/FrankSzendzielarz/subscriptions",
      "organizations_url": "https://api.github.com/users/FrankSzendzielarz/orgs",
      "repos_url": "https://api.github.com/users/FrankSzendzielarz/repos",
      "events_url": "https://api.github.com/users/FrankSzendzielarz/events{/privacy}",
      "received_events_url": "https://api.github.com/users/FrankSzendzielarz/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-04-01T15:41:48Z",
    "updated_at": "2019-04-01T15:41:48Z",
    "author_association": "MEMBER",
    "body": "TODO: Add burstiness depth to the rate limiter args.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/devp2p/issues/comments/478632357/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
