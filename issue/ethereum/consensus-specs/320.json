{
  "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/320",
  "repository_url": "https://api.github.com/repos/ethereum/consensus-specs",
  "labels_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/320/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/320/comments",
  "events_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/320/events",
  "html_url": "https://github.com/ethereum/consensus-specs/issues/320",
  "id": 391032309,
  "node_id": "MDU6SXNzdWUzOTEwMzIzMDk=",
  "number": 320,
  "title": "BLS signature verification requires double hashing message.",
  "user": {
    "login": "cheatfate",
    "id": 5955411,
    "node_id": "MDQ6VXNlcjU5NTU0MTE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5955411?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/cheatfate",
    "html_url": "https://github.com/cheatfate",
    "followers_url": "https://api.github.com/users/cheatfate/followers",
    "following_url": "https://api.github.com/users/cheatfate/following{/other_user}",
    "gists_url": "https://api.github.com/users/cheatfate/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/cheatfate/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/cheatfate/subscriptions",
    "organizations_url": "https://api.github.com/users/cheatfate/orgs",
    "repos_url": "https://api.github.com/users/cheatfate/repos",
    "events_url": "https://api.github.com/users/cheatfate/events{/privacy}",
    "received_events_url": "https://api.github.com/users/cheatfate/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1063043868,
      "node_id": "MDU6TGFiZWwxMDYzMDQzODY4",
      "url": "https://api.github.com/repos/ethereum/consensus-specs/labels/general:enhancement",
      "name": "general:enhancement",
      "color": "086788",
      "default": false,
      "description": "New feature or request"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2018-12-14T09:31:47Z",
  "updated_at": "2019-01-10T18:27:55Z",
  "closed_at": "2019-01-10T18:27:55Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "BLS signature verification requires double hashing message.\r\n\r\nIn current version of [BLS signature verification](https://github.com/ethereum/eth2.0-specs/blob/master/specs/bls_verify.md#hash_to_g2) present such lines:\r\n\r\n\r\n```python\r\n  x_re = int.from_bytes(hash(bytes8(domain) + b'\\x01' + message), 'big')\r\n  x_im = int.from_bytes(hash(bytes8(domain) + b'\\x02' + message), 'big')\r\n```\r\n\r\nIn such case `message` hashing performs 2x times, this can be ineffective, because\r\nmessage can be big in size or data gathering process for `message` can be cpu intensive task.\r\n\r\nThis is pseudo-code for current hashing method:\r\n\r\n```nim\r\nvar ctx1, ctx2: keccak256\r\nctx1.init()\r\nctx1.update(bytes(domain))\r\nctx2 = ctx1\r\nctx1.update(bytes(0x01))\r\nctx1.update(message)\r\nvar xre = ctx1.finish()\r\nctx2.update(bytes(0x02))\r\nctx2.update(message)\r\nvar xi = ctx2.finish()\r\n```\r\n\r\nAs you can see only `domain` field hashing can be cached and optimized, and `hash(message)` must be performed twice for both `xre` and `xi`.\r\n\r\nIf you change current hashing method to:\r\n\r\n```python\r\n  x_re = int.from_bytes(hash(message + bytes8(domain) + b'\\x01'), 'big')\r\n  x_im = int.from_bytes(hash(message + bytes8(domain) + b'\\x02'), 'big')\r\n```\r\n\r\nPseudo code will looks like this:\r\n\r\n```nim\r\nvar ctx1, ctx2: keccak256\r\nctx1.init()\r\nctx1.update(message)\r\nctx1.update(bytes(domain))\r\nctx2 = ctx1\r\nctx1.update(bytes(0x01))\r\nvar xre = ctx1.finish()\r\nctx2.update(bytes(0x02))\r\nvar xi = ctx2.finish()\r\n```\r\n\r\nAs you can see not only `domain` argument cached, but `message` too.\r\nSo `hash(message)` operation performed only once.\r\n\r\nBut if you dont like scheme above, here is one more:\r\n\r\n```python\r\n  x_re = int.from_bytes(hash(bytes8(domain) + b'\\x01' + hash(message)), 'big')\r\n  x_im = int.from_bytes(hash(bytes8(domain) + b'\\x02' + hash(message)), 'big')\r\n```\r\n\r\nIn such way you can perform `hash(message)` only one time too.\r\n\r\nPseudo code will looks like this:\r\n\r\n```nim\r\nvar ctx1, ctx2: keccak256\r\nctx1.init()\r\nctx1.update(message)\r\nvar msgdigest = ctx1.finish()\r\nctx1.init()\r\nctx1.update(bytes(domain))\r\nctx2 = ctx1\r\nctx1.update(bytes(0x01))\r\nctx1.update(msgdigest)\r\nvar xre = ctx1.finish()\r\nctx2.update(bytes(0x02))\r\nctx2.update(msgdigest)\r\nvar xi = ctx2.finish()\r\n```\r\n",
  "closed_by": {
    "login": "djrtwo",
    "id": 1433595,
    "node_id": "MDQ6VXNlcjE0MzM1OTU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1433595?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/djrtwo",
    "html_url": "https://github.com/djrtwo",
    "followers_url": "https://api.github.com/users/djrtwo/followers",
    "following_url": "https://api.github.com/users/djrtwo/following{/other_user}",
    "gists_url": "https://api.github.com/users/djrtwo/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/djrtwo/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/djrtwo/subscriptions",
    "organizations_url": "https://api.github.com/users/djrtwo/orgs",
    "repos_url": "https://api.github.com/users/djrtwo/repos",
    "events_url": "https://api.github.com/users/djrtwo/events{/privacy}",
    "received_events_url": "https://api.github.com/users/djrtwo/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/320/reactions",
    "total_count": 2,
    "+1": 2,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/320/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/449651479",
    "html_url": "https://github.com/ethereum/consensus-specs/issues/320#issuecomment-449651479",
    "issue_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/320",
    "id": 449651479,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ0OTY1MTQ3OQ==",
    "user": {
      "login": "vbuterin",
      "id": 2230894,
      "node_id": "MDQ6VXNlcjIyMzA4OTQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2230894?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vbuterin",
      "html_url": "https://github.com/vbuterin",
      "followers_url": "https://api.github.com/users/vbuterin/followers",
      "following_url": "https://api.github.com/users/vbuterin/following{/other_user}",
      "gists_url": "https://api.github.com/users/vbuterin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vbuterin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vbuterin/subscriptions",
      "organizations_url": "https://api.github.com/users/vbuterin/orgs",
      "repos_url": "https://api.github.com/users/vbuterin/repos",
      "events_url": "https://api.github.com/users/vbuterin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vbuterin/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-12-23T17:19:43Z",
    "updated_at": "2018-12-23T17:20:20Z",
    "author_association": "MEMBER",
    "body": "Not sure the tiny efficiency gains that we would get are worth it to fiddle around too much; hashing is relatively speaking a tiny portion of the BLS hash-to-G2 method's costs; the elliptic curve multiplication in G2 to put the point in the right subgroup is far larger.\r\n\r\nAlso, isn't the block size for keccak much bigger than 41 bytes anyway, so it doesnt' really matter what order the different parts of the hash input are in?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/449651479/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/452956534",
    "html_url": "https://github.com/ethereum/consensus-specs/issues/320#issuecomment-452956534",
    "issue_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/320",
    "id": 452956534,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ1Mjk1NjUzNA==",
    "user": {
      "login": "cheatfate",
      "id": 5955411,
      "node_id": "MDQ6VXNlcjU5NTU0MTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5955411?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cheatfate",
      "html_url": "https://github.com/cheatfate",
      "followers_url": "https://api.github.com/users/cheatfate/followers",
      "following_url": "https://api.github.com/users/cheatfate/following{/other_user}",
      "gists_url": "https://api.github.com/users/cheatfate/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cheatfate/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cheatfate/subscriptions",
      "organizations_url": "https://api.github.com/users/cheatfate/orgs",
      "repos_url": "https://api.github.com/users/cheatfate/repos",
      "events_url": "https://api.github.com/users/cheatfate/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cheatfate/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-01-10T03:21:02Z",
    "updated_at": "2019-01-10T03:21:02Z",
    "author_association": "NONE",
    "body": "Keccak's block size is 200 octets (bytes).\r\nOf course `hash-to-G2` is much more expensive, but why we need to perform hashing on data twice if we can perform it only once?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/452956534/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
