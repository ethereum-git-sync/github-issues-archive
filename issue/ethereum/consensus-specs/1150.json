{
  "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1150",
  "repository_url": "https://api.github.com/repos/ethereum/consensus-specs",
  "labels_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1150/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1150/comments",
  "events_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1150/events",
  "html_url": "https://github.com/ethereum/consensus-specs/issues/1150",
  "id": 453787129,
  "node_id": "MDU6SXNzdWU0NTM3ODcxMjk=",
  "number": 1150,
  "title": "Gas consumption of different part of the `deposit` function call",
  "user": {
    "login": "NIC619",
    "id": 17670147,
    "node_id": "MDQ6VXNlcjE3NjcwMTQ3",
    "avatar_url": "https://avatars.githubusercontent.com/u/17670147?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/NIC619",
    "html_url": "https://github.com/NIC619",
    "followers_url": "https://api.github.com/users/NIC619/followers",
    "following_url": "https://api.github.com/users/NIC619/following{/other_user}",
    "gists_url": "https://api.github.com/users/NIC619/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/NIC619/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/NIC619/subscriptions",
    "organizations_url": "https://api.github.com/users/NIC619/orgs",
    "repos_url": "https://api.github.com/users/NIC619/repos",
    "events_url": "https://api.github.com/users/NIC619/events{/privacy}",
    "received_events_url": "https://api.github.com/users/NIC619/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1324892187,
      "node_id": "MDU6TGFiZWwxMzI0ODkyMTg3",
      "url": "https://api.github.com/repos/ethereum/consensus-specs/labels/scope:deposit%20contract",
      "name": "scope:deposit contract",
      "color": "005CAF",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 6,
  "created_at": "2019-02-27T02:51:55Z",
  "updated_at": "2019-06-30T14:57:47Z",
  "closed_at": "2019-06-30T14:57:46Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": " Below are cumulative gas consumption of each part of `deposit` function call, starting from the beginning of the function:\r\n\r\n- latest update: 2019/06/16, contract version: https://github.com/ethereum/eth2.0-specs/blob/193b628fb4fb7c3ef08cf160a9bbafade61a839e/deposit_contract/contracts/validator_registration.v.py\r\n`# Compiler version: vyper==0.1.0b9`\r\n```python\r\ndef deposit(pubkey: bytes[PUBKEY_LENGTH],\r\n            withdrawal_credentials: bytes[WITHDRAWAL_CREDENTIALS_LENGTH],\r\n            signature: bytes[SIGNATURE_LENGTH]):\r\n    # Avoid overflowing the Merkle tree (and prevent edge case in computing `self.branch`)\r\n    assert self.deposit_count < MAX_DEPOSIT_COUNT\r\n\r\n    # Validate deposit data\r\n    deposit_amount: uint256 = msg.value / as_wei_value(1, \"gwei\")\r\n    assert deposit_amount >= MIN_DEPOSIT_AMOUNT\r\n    assert len(pubkey) == PUBKEY_LENGTH\r\n    assert len(withdrawal_credentials) == WITHDRAWAL_CREDENTIALS_LENGTH\r\n    assert len(signature) == SIGNATURE_LENGTH\r\n\r\n    # cumulative gas consumption so far: ≈35304\r\n    # NOTE: including basic transaction cost: 21000 + 68*176(assuming all non zero bytes inputs) = 32968\r\n```\r\n```python\r\n    # Emit `Deposit` log\r\n    amount: bytes[8] = self.to_little_endian_64(deposit_amount)\r\n\r\n    # cumulative gas consumption so far: ≈42583\r\n    # NOTE: one `to_little_endian_64()` call consumes ≈6500 gas\r\n```\r\n```python\r\n   log.Deposit(pubkey, withdrawal_credentials, amount, signature, self.to_little_endian_64(self.deposit_count))\r\n\r\n    # cumulative gas consumption so far: ≈67161\r\n    # NOTE: one `to_little_endian_64()` call consumes ≈6500 gas\r\n```\r\n```python\r\n    # Compute `DepositData` root\r\n    zero_bytes32: bytes32 = 0x0000000000000000000000000000000000000000000000000000000000000000\r\n    pubkey_root: bytes32 = sha256(concat(pubkey, slice(zero_bytes32, start=0, len=64 - PUBKEY_LENGTH)))\r\n\r\n    # cumulative gas consumption so far: ≈70434\r\n\r\n    signature_root: bytes32 = sha256(concat(\r\n        sha256(slice(signature, start=0, len=64)),\r\n        sha256(concat(slice(signature, start=64, len=SIGNATURE_LENGTH - 64), zero_bytes32)),\r\n    ))\r\n\r\n    # cumulative gas consumption so far: ≈75661\r\n\r\n    node: bytes32 = sha256(concat(\r\n        sha256(concat(pubkey_root, withdrawal_credentials)),\r\n        sha256(concat(amount, slice(zero_bytes32, start=0, len=32 - AMOUNT_LENGTH), signature_root)),\r\n    ))\r\n\r\n    # cumulative gas consumption so far: ≈81622\r\n```\r\n```python\r\n   # Add `DepositData` root to Merkle tree (update a single `branch` node)\r\n    self.deposit_count += 1\r\n\r\n    # cumulative gas consumption so far: ≈87271\r\n    # NOTE: `self.deposit_count += 1` consumes 5000 gas (except for the first deposit which consumes 20000 gas)\r\n```\r\n```python\r\n    size: uint256 = self.deposit_count\r\n\r\n    # cumulative gas consumption so far: ≈87486\r\n```\r\n```python\r\n   for height in range(DEPOSIT_CONTRACT_TREE_DEPTH):\r\n        if bitwise_and(size, 1) == 1:  # More gas efficient than `size % 2 == 1`\r\n            self.branch[height] = node\r\n            # NOTE: `self.branch[height] = node` consumes 5000 gas or 20000 gas\r\n            # depends on if `self.branch[height]` has been updated before\r\n            break\r\n        node = sha256(concat(self.branch[height], node))\r\n        # NOTE: `node = sha256(concat(self.branch[height], node))`` consumes ≈1200 gas\r\n        size /= 2\r\n        # NOTE: `size /= 2` consumes ≈40 gas\r\n\r\n       # cumulative gas consumption so far: ≈92651 and up (extra 15000 gas if `self.branch[height]` hasn't been updated before\r\n       # and extra ≈1200 gas for each iteration in the loop\r\n```\r\n```",
  "closed_by": {
    "login": "JustinDrake",
    "id": 731743,
    "node_id": "MDQ6VXNlcjczMTc0Mw==",
    "avatar_url": "https://avatars.githubusercontent.com/u/731743?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/JustinDrake",
    "html_url": "https://github.com/JustinDrake",
    "followers_url": "https://api.github.com/users/JustinDrake/followers",
    "following_url": "https://api.github.com/users/JustinDrake/following{/other_user}",
    "gists_url": "https://api.github.com/users/JustinDrake/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/JustinDrake/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/JustinDrake/subscriptions",
    "organizations_url": "https://api.github.com/users/JustinDrake/orgs",
    "repos_url": "https://api.github.com/users/JustinDrake/repos",
    "events_url": "https://api.github.com/users/JustinDrake/events{/privacy}",
    "received_events_url": "https://api.github.com/users/JustinDrake/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1150/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1150/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/500241973",
    "html_url": "https://github.com/ethereum/consensus-specs/issues/1150#issuecomment-500241973",
    "issue_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1150",
    "id": 500241973,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUwMDI0MTk3Mw==",
    "user": {
      "login": "JustinDrake",
      "id": 731743,
      "node_id": "MDQ6VXNlcjczMTc0Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/731743?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/JustinDrake",
      "html_url": "https://github.com/JustinDrake",
      "followers_url": "https://api.github.com/users/JustinDrake/followers",
      "following_url": "https://api.github.com/users/JustinDrake/following{/other_user}",
      "gists_url": "https://api.github.com/users/JustinDrake/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/JustinDrake/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/JustinDrake/subscriptions",
      "organizations_url": "https://api.github.com/users/JustinDrake/orgs",
      "repos_url": "https://api.github.com/users/JustinDrake/repos",
      "events_url": "https://api.github.com/users/JustinDrake/events{/privacy}",
      "received_events_url": "https://api.github.com/users/JustinDrake/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-06-09T20:19:58Z",
    "updated_at": "2019-06-09T20:19:58Z",
    "author_association": "MEMBER",
    "body": "@NIC619: This kind of gas analysis is helpful :) Would you mind updating the analysis using the code in #1152?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/500241973/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/500389520",
    "html_url": "https://github.com/ethereum/consensus-specs/issues/1150#issuecomment-500389520",
    "issue_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1150",
    "id": 500389520,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUwMDM4OTUyMA==",
    "user": {
      "login": "NIC619",
      "id": 17670147,
      "node_id": "MDQ6VXNlcjE3NjcwMTQ3",
      "avatar_url": "https://avatars.githubusercontent.com/u/17670147?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/NIC619",
      "html_url": "https://github.com/NIC619",
      "followers_url": "https://api.github.com/users/NIC619/followers",
      "following_url": "https://api.github.com/users/NIC619/following{/other_user}",
      "gists_url": "https://api.github.com/users/NIC619/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/NIC619/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/NIC619/subscriptions",
      "organizations_url": "https://api.github.com/users/NIC619/orgs",
      "repos_url": "https://api.github.com/users/NIC619/repos",
      "events_url": "https://api.github.com/users/NIC619/events{/privacy}",
      "received_events_url": "https://api.github.com/users/NIC619/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-06-10T11:52:08Z",
    "updated_at": "2019-06-10T11:52:08Z",
    "author_association": "MEMBER",
    "body": "Will do!",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/500389520/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/502398721",
    "html_url": "https://github.com/ethereum/consensus-specs/issues/1150#issuecomment-502398721",
    "issue_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1150",
    "id": 502398721,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUwMjM5ODcyMQ==",
    "user": {
      "login": "JustinDrake",
      "id": 731743,
      "node_id": "MDQ6VXNlcjczMTc0Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/731743?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/JustinDrake",
      "html_url": "https://github.com/JustinDrake",
      "followers_url": "https://api.github.com/users/JustinDrake/followers",
      "following_url": "https://api.github.com/users/JustinDrake/following{/other_user}",
      "gists_url": "https://api.github.com/users/JustinDrake/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/JustinDrake/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/JustinDrake/subscriptions",
      "organizations_url": "https://api.github.com/users/JustinDrake/orgs",
      "repos_url": "https://api.github.com/users/JustinDrake/repos",
      "events_url": "https://api.github.com/users/JustinDrake/events{/privacy}",
      "received_events_url": "https://api.github.com/users/JustinDrake/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-06-15T20:54:15Z",
    "updated_at": "2019-06-15T20:54:15Z",
    "author_association": "MEMBER",
    "body": "I advertised gas golfing on Twitter https://twitter.com/drakefjustin/status/1139989022577758211",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/502398721/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/502498378",
    "html_url": "https://github.com/ethereum/consensus-specs/issues/1150#issuecomment-502498378",
    "issue_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1150",
    "id": 502498378,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUwMjQ5ODM3OA==",
    "user": {
      "login": "NIC619",
      "id": 17670147,
      "node_id": "MDQ6VXNlcjE3NjcwMTQ3",
      "avatar_url": "https://avatars.githubusercontent.com/u/17670147?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/NIC619",
      "html_url": "https://github.com/NIC619",
      "followers_url": "https://api.github.com/users/NIC619/followers",
      "following_url": "https://api.github.com/users/NIC619/following{/other_user}",
      "gists_url": "https://api.github.com/users/NIC619/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/NIC619/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/NIC619/subscriptions",
      "organizations_url": "https://api.github.com/users/NIC619/orgs",
      "repos_url": "https://api.github.com/users/NIC619/repos",
      "events_url": "https://api.github.com/users/NIC619/events{/privacy}",
      "received_events_url": "https://api.github.com/users/NIC619/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-06-17T00:22:22Z",
    "updated_at": "2019-06-17T00:22:22Z",
    "author_association": "MEMBER",
    "body": "updated!",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/502498378/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/505690403",
    "html_url": "https://github.com/ethereum/consensus-specs/issues/1150#issuecomment-505690403",
    "issue_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1150",
    "id": 505690403,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUwNTY5MDQwMw==",
    "user": {
      "login": "jacqueswww",
      "id": 6917456,
      "node_id": "MDQ6VXNlcjY5MTc0NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6917456?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jacqueswww",
      "html_url": "https://github.com/jacqueswww",
      "followers_url": "https://api.github.com/users/jacqueswww/followers",
      "following_url": "https://api.github.com/users/jacqueswww/following{/other_user}",
      "gists_url": "https://api.github.com/users/jacqueswww/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jacqueswww/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jacqueswww/subscriptions",
      "organizations_url": "https://api.github.com/users/jacqueswww/orgs",
      "repos_url": "https://api.github.com/users/jacqueswww/repos",
      "events_url": "https://api.github.com/users/jacqueswww/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jacqueswww/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-06-26T02:20:02Z",
    "updated_at": "2019-06-26T02:20:02Z",
    "author_association": "MEMBER",
    "body": "Curious to see what the gas improvements are with https://github.com/ethereum/vyper/pull/1499",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/505690403/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/507043022",
    "html_url": "https://github.com/ethereum/consensus-specs/issues/1150#issuecomment-507043022",
    "issue_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1150",
    "id": 507043022,
    "node_id": "MDEyOklzc3VlQ29tbWVudDUwNzA0MzAyMg==",
    "user": {
      "login": "JustinDrake",
      "id": 731743,
      "node_id": "MDQ6VXNlcjczMTc0Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/731743?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/JustinDrake",
      "html_url": "https://github.com/JustinDrake",
      "followers_url": "https://api.github.com/users/JustinDrake/followers",
      "following_url": "https://api.github.com/users/JustinDrake/following{/other_user}",
      "gists_url": "https://api.github.com/users/JustinDrake/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/JustinDrake/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/JustinDrake/subscriptions",
      "organizations_url": "https://api.github.com/users/JustinDrake/orgs",
      "repos_url": "https://api.github.com/users/JustinDrake/repos",
      "events_url": "https://api.github.com/users/JustinDrake/events{/privacy}",
      "received_events_url": "https://api.github.com/users/JustinDrake/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-06-30T14:57:46Z",
    "updated_at": "2019-06-30T14:57:46Z",
    "author_association": "MEMBER",
    "body": "Thanks @NIC619, very clear breakdown. Looks like there isn't much fat.\r\n\r\nOnly two gas improvements were suggested from the golfing bounties:\r\n\r\n1) https://twitter.com/nicksdjohnson/status/1140018871513993216\r\n2) https://twitter.com/jadler0/status/1140422368323678209\r\n\r\nBoth seem minor enough to not bother impeding formal verification.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/507043022/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
