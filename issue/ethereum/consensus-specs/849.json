{
  "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/849",
  "repository_url": "https://api.github.com/repos/ethereum/consensus-specs",
  "labels_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/849/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/849/comments",
  "events_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/849/events",
  "html_url": "https://github.com/ethereum/consensus-specs/issues/849",
  "id": 426299861,
  "node_id": "MDU6SXNzdWU0MjYyOTk4NjE=",
  "number": 849,
  "title": "Negative justified epoch on first epoch transition",
  "user": {
    "login": "arnetheduck",
    "id": 1382986,
    "node_id": "MDQ6VXNlcjEzODI5ODY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1382986?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/arnetheduck",
    "html_url": "https://github.com/arnetheduck",
    "followers_url": "https://api.github.com/users/arnetheduck/followers",
    "following_url": "https://api.github.com/users/arnetheduck/following{/other_user}",
    "gists_url": "https://api.github.com/users/arnetheduck/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/arnetheduck/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/arnetheduck/subscriptions",
    "organizations_url": "https://api.github.com/users/arnetheduck/orgs",
    "repos_url": "https://api.github.com/users/arnetheduck/repos",
    "events_url": "https://api.github.com/users/arnetheduck/events{/privacy}",
    "received_events_url": "https://api.github.com/users/arnetheduck/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2019-03-28T05:02:21Z",
  "updated_at": "2019-04-18T02:39:01Z",
  "closed_at": "2019-04-18T02:39:00Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "This logic looks a bit fishy:\r\n\r\n```\r\n    if previous_boundary_attesting_balance * 3 >= get_previous_total_balance(state) * 2:\r\n        new_justified_epoch = get_current_epoch(state) - 1\r\n        state.justification_bitfield |= 2\r\n...\r\n\r\ndef get_previous_total_balance(state: BeaconState) -> Gwei:\r\n    return get_total_balance(state, get_active_validator_indices(state.validator_registry, get_previous_epoch(state)))\r\n\r\n```\r\n\r\nbasically, during the first epoch transition, `get_previous_epoch`, if we weren't using the ugly integers, would be `-1` (because `state.slot` is updated after epoch processing). in particular, it means that there are no active validators because their activation epoch is set to `GENESIS_EPOCH`, and therefore the total attesting balance is 0. \r\n\r\nAs a consequence, `state.current_justified_epoch` is set to `-1` - before the genesis epoch. ",
  "closed_by": {
    "login": "djrtwo",
    "id": 1433595,
    "node_id": "MDQ6VXNlcjE0MzM1OTU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1433595?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/djrtwo",
    "html_url": "https://github.com/djrtwo",
    "followers_url": "https://api.github.com/users/djrtwo/followers",
    "following_url": "https://api.github.com/users/djrtwo/following{/other_user}",
    "gists_url": "https://api.github.com/users/djrtwo/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/djrtwo/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/djrtwo/subscriptions",
    "organizations_url": "https://api.github.com/users/djrtwo/orgs",
    "repos_url": "https://api.github.com/users/djrtwo/repos",
    "events_url": "https://api.github.com/users/djrtwo/events{/privacy}",
    "received_events_url": "https://api.github.com/users/djrtwo/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/849/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/849/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/477588077",
    "html_url": "https://github.com/ethereum/consensus-specs/issues/849#issuecomment-477588077",
    "issue_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/849",
    "id": 477588077,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ3NzU4ODA3Nw==",
    "user": {
      "login": "arnetheduck",
      "id": 1382986,
      "node_id": "MDQ6VXNlcjEzODI5ODY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1382986?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/arnetheduck",
      "html_url": "https://github.com/arnetheduck",
      "followers_url": "https://api.github.com/users/arnetheduck/followers",
      "following_url": "https://api.github.com/users/arnetheduck/following{/other_user}",
      "gists_url": "https://api.github.com/users/arnetheduck/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/arnetheduck/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/arnetheduck/subscriptions",
      "organizations_url": "https://api.github.com/users/arnetheduck/orgs",
      "repos_url": "https://api.github.com/users/arnetheduck/repos",
      "events_url": "https://api.github.com/users/arnetheduck/events{/privacy}",
      "received_events_url": "https://api.github.com/users/arnetheduck/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-03-28T13:10:46Z",
    "updated_at": "2019-03-28T13:10:46Z",
    "author_association": "CONTRIBUTOR",
    "body": "Some more flavor:\r\n\r\n@mkalinin noted that the next section resets the justified slot to 0:\r\n```\r\n    if current_boundary_attesting_balance * 3 >= get_current_total_balance(state) * 2:\r\n        new_justified_epoch = get_current_epoch(state)\r\n        state.justification_bitfield |= 1\r\n```\r\n\r\nHowever, this is true only iff there are enough attestations - we're using `get_current_total_balance` in this check which is not affected by the underflow - also, during the first epoch, there are naturally fewer attestations around because of `MIN_ATTESTATION_INCLUSION_DELAY` so the practical threshold is actually higher than 2/3's to enter here.\r\n\r\na temporary fix we're using is to saturate `get_previous_epoch` - but it has only received minimal testing:\r\n```\r\nreturn max(GENESIS_EPOCH, epoch - 1)\r\n```\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/477588077/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/484298800",
    "html_url": "https://github.com/ethereum/consensus-specs/issues/849#issuecomment-484298800",
    "issue_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/849",
    "id": 484298800,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ4NDI5ODgwMA==",
    "user": {
      "login": "djrtwo",
      "id": 1433595,
      "node_id": "MDQ6VXNlcjE0MzM1OTU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1433595?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/djrtwo",
      "html_url": "https://github.com/djrtwo",
      "followers_url": "https://api.github.com/users/djrtwo/followers",
      "following_url": "https://api.github.com/users/djrtwo/following{/other_user}",
      "gists_url": "https://api.github.com/users/djrtwo/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/djrtwo/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/djrtwo/subscriptions",
      "organizations_url": "https://api.github.com/users/djrtwo/orgs",
      "repos_url": "https://api.github.com/users/djrtwo/repos",
      "events_url": "https://api.github.com/users/djrtwo/events{/privacy}",
      "received_events_url": "https://api.github.com/users/djrtwo/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-04-17T23:29:21Z",
    "updated_at": "2019-04-17T23:29:21Z",
    "author_association": "MEMBER",
    "body": "This is addressed in #896 by blocking `update_justification_and_finalization` on the first 2 epochs. prevents `-1` and resetting to `0`\r\n\r\nWill close then that PR is merged",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/484298800/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/484333912",
    "html_url": "https://github.com/ethereum/consensus-specs/issues/849#issuecomment-484333912",
    "issue_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/849",
    "id": 484333912,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ4NDMzMzkxMg==",
    "user": {
      "login": "djrtwo",
      "id": 1433595,
      "node_id": "MDQ6VXNlcjE0MzM1OTU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1433595?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/djrtwo",
      "html_url": "https://github.com/djrtwo",
      "followers_url": "https://api.github.com/users/djrtwo/followers",
      "following_url": "https://api.github.com/users/djrtwo/following{/other_user}",
      "gists_url": "https://api.github.com/users/djrtwo/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/djrtwo/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/djrtwo/subscriptions",
      "organizations_url": "https://api.github.com/users/djrtwo/orgs",
      "repos_url": "https://api.github.com/users/djrtwo/repos",
      "events_url": "https://api.github.com/users/djrtwo/events{/privacy}",
      "received_events_url": "https://api.github.com/users/djrtwo/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-04-18T02:39:00Z",
    "updated_at": "2019-04-18T02:39:00Z",
    "author_association": "MEMBER",
    "body": "closed via #896 ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/484333912/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
