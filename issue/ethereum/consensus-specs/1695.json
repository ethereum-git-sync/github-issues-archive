{
  "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1695",
  "repository_url": "https://api.github.com/repos/ethereum/consensus-specs",
  "labels_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1695/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1695/comments",
  "events_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1695/events",
  "html_url": "https://github.com/ethereum/consensus-specs/issues/1695",
  "id": 590046583,
  "node_id": "MDU6SXNzdWU1OTAwNDY1ODM=",
  "number": 1695,
  "title": "Bug in get_next_power_of_2",
  "user": {
    "login": "franck44",
    "id": 14901362,
    "node_id": "MDQ6VXNlcjE0OTAxMzYy",
    "avatar_url": "https://avatars.githubusercontent.com/u/14901362?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/franck44",
    "html_url": "https://github.com/franck44",
    "followers_url": "https://api.github.com/users/franck44/followers",
    "following_url": "https://api.github.com/users/franck44/following{/other_user}",
    "gists_url": "https://api.github.com/users/franck44/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/franck44/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/franck44/subscriptions",
    "organizations_url": "https://api.github.com/users/franck44/orgs",
    "repos_url": "https://api.github.com/users/franck44/repos",
    "events_url": "https://api.github.com/users/franck44/events{/privacy}",
    "received_events_url": "https://api.github.com/users/franck44/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1725628406,
      "node_id": "MDU6TGFiZWwxNzI1NjI4NDA2",
      "url": "https://api.github.com/repos/ethereum/consensus-specs/labels/phase0",
      "name": "phase0",
      "color": "c2e0c6",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2020-03-30T07:06:47Z",
  "updated_at": "2020-06-17T20:47:21Z",
  "closed_at": "2020-06-17T20:47:21Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "The [simple-serialise](https://github.com/ethereum/eth2.0-specs/blob/dev/ssz/simple-serialize.md) (Merkleisation section) reads:\r\n\r\n> next_pow_of_two(i): get the next power of 2 of i, if not already a power of 2, with 0 mapping to 1. Examples: 0->1, 1->1, 2->2, 3->4, 4->4, 6->8, 9->16\r\n\r\nIn the [merkle proofs](https://github.com/ethereum/eth2.0-specs/blob/dev/ssz/merkle-proofs.md), helpers are defined by:\r\n\r\n```\r\ndef get_next_power_of_two(x: int) -> int:\r\n    \"\"\"\r\n    Get next power of 2 >= the input.\r\n    \"\"\"\r\n    if x <= 2:\r\n        return x\r\n    else:\r\n        return 2 * get_next_power_of_two((x + 1) // 2)\r\n\r\ndef get_previous_power_of_two(x: int) -> int:\r\n    \"\"\"\r\n    Get the previous power of 2 >= the input.\r\n    \"\"\"\r\n    if x <= 2:\r\n        return x\r\n    else:\r\n        return 2 * get_previous_power_of_two(x // 2)\r\n```\r\nUnfortunately, the first one is buggy (e.g. for 0 it returns 0 which is not a power of 2 and is different to what the simple-serialise specs reads.)\r\nHere is a fix, proved correct with Dafny (the fact that it computes the next power of 2 of a given natural number requires more lemmas, not included in this post):\r\n```\r\nfunction get_next_power_of_two(n : int) : int \r\n    requires n >= 0\r\n    ensures get_next_power_of_two(n) >= 1\r\n{\r\n    if n <= 1 then 1\r\n    else 2 * get_next_power_of_two( (n + 1) / 2)\r\n}\r\n```\r\n\r\nThe second one ` get_previous_power_of_two` is not clearly defined. \r\nAnyway it seems buggy as well as it returns 0 for 0 which is not a power of 2.\r\nWhat is the previous power of 2 >= input? Is it the power of 2, say k, such that 2^k < input <= 2^{k+1}?\r\nIs it the largest power of 2 that is strictly smaller than the input? If yes, we also have a (provably) correct version of it.\r\n\r\n  ",
  "closed_by": {
    "login": "protolambda",
    "id": 19571989,
    "node_id": "MDQ6VXNlcjE5NTcxOTg5",
    "avatar_url": "https://avatars.githubusercontent.com/u/19571989?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/protolambda",
    "html_url": "https://github.com/protolambda",
    "followers_url": "https://api.github.com/users/protolambda/followers",
    "following_url": "https://api.github.com/users/protolambda/following{/other_user}",
    "gists_url": "https://api.github.com/users/protolambda/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/protolambda/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/protolambda/subscriptions",
    "organizations_url": "https://api.github.com/users/protolambda/orgs",
    "repos_url": "https://api.github.com/users/protolambda/repos",
    "events_url": "https://api.github.com/users/protolambda/events{/privacy}",
    "received_events_url": "https://api.github.com/users/protolambda/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1695/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1695/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/608131062",
    "html_url": "https://github.com/ethereum/consensus-specs/issues/1695#issuecomment-608131062",
    "issue_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1695",
    "id": 608131062,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYwODEzMTA2Mg==",
    "user": {
      "login": "protolambda",
      "id": 19571989,
      "node_id": "MDQ6VXNlcjE5NTcxOTg5",
      "avatar_url": "https://avatars.githubusercontent.com/u/19571989?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/protolambda",
      "html_url": "https://github.com/protolambda",
      "followers_url": "https://api.github.com/users/protolambda/followers",
      "following_url": "https://api.github.com/users/protolambda/following{/other_user}",
      "gists_url": "https://api.github.com/users/protolambda/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/protolambda/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/protolambda/subscriptions",
      "organizations_url": "https://api.github.com/users/protolambda/orgs",
      "repos_url": "https://api.github.com/users/protolambda/repos",
      "events_url": "https://api.github.com/users/protolambda/events{/privacy}",
      "received_events_url": "https://api.github.com/users/protolambda/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-04-02T22:47:44Z",
    "updated_at": "2020-04-02T22:47:44Z",
    "author_association": "MEMBER",
    "body": "The naming is pretty terrible here (different names for two very similar functions). And then for the incorrect one: in one place (`get_generalized_index`) it indeed should return 1 (but it will never be called with 0, so it does not matter), and in the other (`merkle_tree`) it should be 0 (no extra padding necessary, although a tree with 0 leaves is quite strange, maybe padding of 1 is fine as default there). And then it does not seem to be used anywhere else in the specs.\r\n\r\nI'm not opposed to changing it to handle the `0 -> 1` properly, and unifying the names. That said, the `ssz` folder is planned to move out, to be replaced with that ssz draft repo once that is updated, and then we won't have this buggy function anymore.\r\n\r\nThanks for documenting this, I think I'll prioritize bringing the draft up to date and online so we won't have these issues anymore. :+1: \r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/608131062/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/608148200",
    "html_url": "https://github.com/ethereum/consensus-specs/issues/1695#issuecomment-608148200",
    "issue_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1695",
    "id": 608148200,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYwODE0ODIwMA==",
    "user": {
      "login": "franck44",
      "id": 14901362,
      "node_id": "MDQ6VXNlcjE0OTAxMzYy",
      "avatar_url": "https://avatars.githubusercontent.com/u/14901362?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/franck44",
      "html_url": "https://github.com/franck44",
      "followers_url": "https://api.github.com/users/franck44/followers",
      "following_url": "https://api.github.com/users/franck44/following{/other_user}",
      "gists_url": "https://api.github.com/users/franck44/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/franck44/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/franck44/subscriptions",
      "organizations_url": "https://api.github.com/users/franck44/orgs",
      "repos_url": "https://api.github.com/users/franck44/repos",
      "events_url": "https://api.github.com/users/franck44/events{/privacy}",
      "received_events_url": "https://api.github.com/users/franck44/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-04-02T23:38:41Z",
    "updated_at": "2020-04-02T23:50:57Z",
    "author_association": "NONE",
    "body": "Thanks for that. \r\nIt is probably safer to document it and even it is not called with 0 now, it may happen in the future.\r\nBut overall, what is the mathematical spec of these functions?\r\n\r\nThis is what we have in our Dafny code at the moment:\r\n```\r\n /** Get the next power of two.\r\n     *\r\n     *  @param  n   A positive integer. \r\n     *  @return     The smallest power of 2 that is larger than n.\r\n     */\r\n    function get_next_power_of_two(n : nat) : nat \r\n    requires true // n is a nat which is an int >=0 so pre-condition is true.\r\n    ensures get_next_power_of_two(n) >= 1\r\n    ensures get_next_power_of_two(n) >= n  // result should be >= n\r\n    ensures n >= 1 ==> (get_next_power_of_two(n) / 2) < n // previous power of two should be < n\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/608148200/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/610151527",
    "html_url": "https://github.com/ethereum/consensus-specs/issues/1695#issuecomment-610151527",
    "issue_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1695",
    "id": 610151527,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYxMDE1MTUyNw==",
    "user": {
      "login": "franck44",
      "id": 14901362,
      "node_id": "MDQ6VXNlcjE0OTAxMzYy",
      "avatar_url": "https://avatars.githubusercontent.com/u/14901362?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/franck44",
      "html_url": "https://github.com/franck44",
      "followers_url": "https://api.github.com/users/franck44/followers",
      "following_url": "https://api.github.com/users/franck44/following{/other_user}",
      "gists_url": "https://api.github.com/users/franck44/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/franck44/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/franck44/subscriptions",
      "organizations_url": "https://api.github.com/users/franck44/orgs",
      "repos_url": "https://api.github.com/users/franck44/repos",
      "events_url": "https://api.github.com/users/franck44/events{/privacy}",
      "received_events_url": "https://api.github.com/users/franck44/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-04-07T03:22:44Z",
    "updated_at": "2020-04-07T03:22:44Z",
    "author_association": "NONE",
    "body": "@protolambda We have opened our repository on formal verification of Eth2.0 using Dafny.\r\nHere are [power_of_2 spec and proofs](https://github.com/PegaSysEng/eth2.0-dafny/blob/d3a3e8b799e2a4b8bac12ec5ccc9ef6123842f53/src/dafny/utils/MathHelpers.dfy)",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/610151527/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/645616040",
    "html_url": "https://github.com/ethereum/consensus-specs/issues/1695#issuecomment-645616040",
    "issue_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1695",
    "id": 645616040,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY0NTYxNjA0MA==",
    "user": {
      "login": "protolambda",
      "id": 19571989,
      "node_id": "MDQ6VXNlcjE5NTcxOTg5",
      "avatar_url": "https://avatars.githubusercontent.com/u/19571989?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/protolambda",
      "html_url": "https://github.com/protolambda",
      "followers_url": "https://api.github.com/users/protolambda/followers",
      "following_url": "https://api.github.com/users/protolambda/following{/other_user}",
      "gists_url": "https://api.github.com/users/protolambda/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/protolambda/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/protolambda/subscriptions",
      "organizations_url": "https://api.github.com/users/protolambda/orgs",
      "repos_url": "https://api.github.com/users/protolambda/repos",
      "events_url": "https://api.github.com/users/protolambda/events{/privacy}",
      "received_events_url": "https://api.github.com/users/protolambda/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-06-17T20:47:21Z",
    "updated_at": "2020-06-17T20:47:21Z",
    "author_association": "MEMBER",
    "body": "See #1907, the code is not used anywhere really, but I made an illustrative fix, while we figure out #1901.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/645616040/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
