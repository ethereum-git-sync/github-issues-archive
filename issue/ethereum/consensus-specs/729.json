{
  "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/729",
  "repository_url": "https://api.github.com/repos/ethereum/consensus-specs",
  "labels_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/729/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/729/comments",
  "events_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/729/events",
  "html_url": "https://github.com/ethereum/consensus-specs/issues/729",
  "id": 418182896,
  "node_id": "MDU6SXNzdWU0MTgxODI4OTY=",
  "number": 729,
  "title": "Harmonize description of crosslink and persistent committee selection",
  "user": {
    "login": "vbuterin",
    "id": 2230894,
    "node_id": "MDQ6VXNlcjIyMzA4OTQ=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2230894?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/vbuterin",
    "html_url": "https://github.com/vbuterin",
    "followers_url": "https://api.github.com/users/vbuterin/followers",
    "following_url": "https://api.github.com/users/vbuterin/following{/other_user}",
    "gists_url": "https://api.github.com/users/vbuterin/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/vbuterin/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/vbuterin/subscriptions",
    "organizations_url": "https://api.github.com/users/vbuterin/orgs",
    "repos_url": "https://api.github.com/users/vbuterin/repos",
    "events_url": "https://api.github.com/users/vbuterin/events{/privacy}",
    "received_events_url": "https://api.github.com/users/vbuterin/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1244734333,
      "node_id": "MDU6TGFiZWwxMjQ0NzM0MzMz",
      "url": "https://api.github.com/repos/ethereum/consensus-specs/labels/general:presentation",
      "name": "general:presentation",
      "color": "2EA9DF",
      "default": false,
      "description": "Presentation (as opposed to content)"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2019-03-07T08:22:55Z",
  "updated_at": "2019-03-28T23:03:10Z",
  "closed_at": "2019-03-28T23:03:10Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "Both phase 0 and phase 1 have code for committee selection that seems to be doing a fundamentally almost identical task, but where code is arguably needlessly duplicated.\r\n\r\nThe two use different patterns to express what is ultimately the same logic. In crosslink committee selection (phase 0), the logic is in `get_shuffling` which is used exactly once:\r\n\r\n```python\r\n    shuffling = get_shuffling(\r\n        seed,\r\n        state.validator_registry,\r\n        shuffling_epoch,\r\n    )\r\n    offset = slot % SLOTS_PER_EPOCH\r\n    committees_per_slot = committees_per_epoch // SLOTS_PER_EPOCH\r\n    slot_start_shard = (shuffling_start_shard + committees_per_slot * offset) % SHARD_COUNT\r\n\r\n    return [\r\n        (\r\n            shuffling[committees_per_slot * offset + i],\r\n            (slot_start_shard + i) % SHARD_COUNT,\r\n        )\r\n        for i in range(committees_per_slot)\r\n    ]\r\n```\r\n\r\nIn persistent committee selection (phase 1), the core function is instead `get_shuffled_committee`, which returns only a single committee instead of a split of the entire validator set.\r\n\r\nOne way to harmonize the two by having functions as follows (note that this is a non-substantive change; it is purely a change in presentation):\r\n\r\n```python\r\ndef get_shuffled_committee(validator_indices: [int],\r\n                           seed: Bytes32,\r\n                           index: int,\r\n                           total_committees: int) -> List[ValidatorIndex]:\r\n    \"\"\"\r\n    Return shuffled committee.\r\n    \"\"\"\r\n    validator_indices = get_active_validator_indices(state.validator_registry, committee_start_epoch)\r\n    start_offset = get_split_offset(len(validator_indices), total_committees, index)\r\n    end_offset = get_split_offset(len(validator_indices), total_committees, index + 1)\r\n    return [\r\n        validator_indices[get_permuted_index(i, len(validator_indices), seed)]\r\n        for i in range(start_offset, end_offset)\r\n    ]\r\n```\r\n\r\nIn phase 0, we now replace the code with:\r\n\r\n```\r\n    indices = get_active_validator_indices(state.validator_registry, shuffling_epoch)\r\n    committee_count = get_epoch_committee_count(len(indices))\r\n    committees_per_slot = committee_count // EPOCH_LENGTH\r\n    return [\r\n        (\r\n            get_shuffled_committee(indices, seed, committees_per_slot * offset + i, committee_count)\r\n            (slot_start_shard + i) % SHARD_COUNT,\r\n        )\r\n        for i in range(committees_per_slot)\r\n    ]\r\n```\r\n\r\nIn phase 1, we now replace the code with:\r\n\r\n```python\r\ndef get_persistent_shuffled_committee(state: BeaconState,\r\n                                     shard: Shard,\r\n                                     committee_start_epoch: Epoch) -> List[ValidatorIndex]:\r\n    seed = generate_seed(state, committee_start_epoch)\r\n    return get_shuffled_committee(state.validator_registry, seed, shard, SHARD_COUNT)\r\n```\r\n\r\nThis also allows us to remove the `split` function, as with the removal of `get_shuffling` we no longer use it.",
  "closed_by": {
    "login": "JustinDrake",
    "id": 731743,
    "node_id": "MDQ6VXNlcjczMTc0Mw==",
    "avatar_url": "https://avatars.githubusercontent.com/u/731743?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/JustinDrake",
    "html_url": "https://github.com/JustinDrake",
    "followers_url": "https://api.github.com/users/JustinDrake/followers",
    "following_url": "https://api.github.com/users/JustinDrake/following{/other_user}",
    "gists_url": "https://api.github.com/users/JustinDrake/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/JustinDrake/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/JustinDrake/subscriptions",
    "organizations_url": "https://api.github.com/users/JustinDrake/orgs",
    "repos_url": "https://api.github.com/users/JustinDrake/repos",
    "events_url": "https://api.github.com/users/JustinDrake/events{/privacy}",
    "received_events_url": "https://api.github.com/users/JustinDrake/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/729/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/729/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/477802270",
    "html_url": "https://github.com/ethereum/consensus-specs/issues/729#issuecomment-477802270",
    "issue_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/729",
    "id": 477802270,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ3NzgwMjI3MA==",
    "user": {
      "login": "JustinDrake",
      "id": 731743,
      "node_id": "MDQ6VXNlcjczMTc0Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/731743?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/JustinDrake",
      "html_url": "https://github.com/JustinDrake",
      "followers_url": "https://api.github.com/users/JustinDrake/followers",
      "following_url": "https://api.github.com/users/JustinDrake/following{/other_user}",
      "gists_url": "https://api.github.com/users/JustinDrake/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/JustinDrake/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/JustinDrake/subscriptions",
      "organizations_url": "https://api.github.com/users/JustinDrake/orgs",
      "repos_url": "https://api.github.com/users/JustinDrake/repos",
      "events_url": "https://api.github.com/users/JustinDrake/events{/privacy}",
      "received_events_url": "https://api.github.com/users/JustinDrake/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-03-28T23:03:10Z",
    "updated_at": "2019-03-28T23:03:10Z",
    "author_association": "MEMBER",
    "body": "Addressed in #776 I believe :)",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/477802270/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
