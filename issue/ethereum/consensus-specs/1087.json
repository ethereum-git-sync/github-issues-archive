{
  "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1087",
  "repository_url": "https://api.github.com/repos/ethereum/consensus-specs",
  "labels_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1087/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1087/comments",
  "events_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1087/events",
  "html_url": "https://github.com/ethereum/consensus-specs/issues/1087",
  "id": 444861083,
  "node_id": "MDU6SXNzdWU0NDQ4NjEwODM=",
  "number": 1087,
  "title": "SSZ SOS: use endOffset instead of offset",
  "user": {
    "login": "Nashatyrev",
    "id": 8173857,
    "node_id": "MDQ6VXNlcjgxNzM4NTc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/8173857?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Nashatyrev",
    "html_url": "https://github.com/Nashatyrev",
    "followers_url": "https://api.github.com/users/Nashatyrev/followers",
    "following_url": "https://api.github.com/users/Nashatyrev/following{/other_user}",
    "gists_url": "https://api.github.com/users/Nashatyrev/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Nashatyrev/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Nashatyrev/subscriptions",
    "organizations_url": "https://api.github.com/users/Nashatyrev/orgs",
    "repos_url": "https://api.github.com/users/Nashatyrev/repos",
    "events_url": "https://api.github.com/users/Nashatyrev/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Nashatyrev/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1170174610,
      "node_id": "MDU6TGFiZWwxMTcwMTc0NjEw",
      "url": "https://api.github.com/repos/ethereum/consensus-specs/labels/scope:SSZ",
      "name": "scope:SSZ",
      "color": "77428D",
      "default": false,
      "description": "Simple Serialize"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 8,
  "created_at": "2019-05-16T09:53:20Z",
  "updated_at": "2019-06-28T13:41:52Z",
  "closed_at": "2019-05-24T16:08:46Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "### The problem\r\nThe total SSZ message size can be determined only from external source like byte array size or size prefix and thus SSZ messages can't be simply streamed without envelope. \r\nFrom the other side we have excess information: offset of the first variable-size element - the `fixed_parts` size is statically known\r\n\r\n### Proposal\r\nFor every variable-size element put its `endOffset` (instead of start `offset`), i.e. starting byte offset of the next variable-size element. The last `endOffset` in this case would be the total message size.\r\n\r\nFrom my perspective this modification doesn't have any significant drawbacks comparing to the current scheme. Though may look slightly counterintuitive\r\n\r\n@pipermerriam what do you think?  ",
  "closed_by": {
    "login": "Nashatyrev",
    "id": 8173857,
    "node_id": "MDQ6VXNlcjgxNzM4NTc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/8173857?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Nashatyrev",
    "html_url": "https://github.com/Nashatyrev",
    "followers_url": "https://api.github.com/users/Nashatyrev/followers",
    "following_url": "https://api.github.com/users/Nashatyrev/following{/other_user}",
    "gists_url": "https://api.github.com/users/Nashatyrev/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Nashatyrev/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Nashatyrev/subscriptions",
    "organizations_url": "https://api.github.com/users/Nashatyrev/orgs",
    "repos_url": "https://api.github.com/users/Nashatyrev/repos",
    "events_url": "https://api.github.com/users/Nashatyrev/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Nashatyrev/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1087/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1087/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/493001490",
    "html_url": "https://github.com/ethereum/consensus-specs/issues/1087#issuecomment-493001490",
    "issue_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1087",
    "id": 493001490,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ5MzAwMTQ5MA==",
    "user": {
      "login": "Nashatyrev",
      "id": 8173857,
      "node_id": "MDQ6VXNlcjgxNzM4NTc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8173857?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Nashatyrev",
      "html_url": "https://github.com/Nashatyrev",
      "followers_url": "https://api.github.com/users/Nashatyrev/followers",
      "following_url": "https://api.github.com/users/Nashatyrev/following{/other_user}",
      "gists_url": "https://api.github.com/users/Nashatyrev/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Nashatyrev/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Nashatyrev/subscriptions",
      "organizations_url": "https://api.github.com/users/Nashatyrev/orgs",
      "repos_url": "https://api.github.com/users/Nashatyrev/repos",
      "events_url": "https://api.github.com/users/Nashatyrev/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Nashatyrev/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-05-16T09:54:46Z",
    "updated_at": "2019-05-16T09:54:46Z",
    "author_association": "MEMBER",
    "body": "If that sounds good I would be happy to cook a PR",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/493001490/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/494372247",
    "html_url": "https://github.com/ethereum/consensus-specs/issues/1087#issuecomment-494372247",
    "issue_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1087",
    "id": 494372247,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ5NDM3MjI0Nw==",
    "user": {
      "login": "pipermerriam",
      "id": 824194,
      "node_id": "MDQ6VXNlcjgyNDE5NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/824194?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pipermerriam",
      "html_url": "https://github.com/pipermerriam",
      "followers_url": "https://api.github.com/users/pipermerriam/followers",
      "following_url": "https://api.github.com/users/pipermerriam/following{/other_user}",
      "gists_url": "https://api.github.com/users/pipermerriam/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pipermerriam/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pipermerriam/subscriptions",
      "organizations_url": "https://api.github.com/users/pipermerriam/orgs",
      "repos_url": "https://api.github.com/users/pipermerriam/repos",
      "events_url": "https://api.github.com/users/pipermerriam/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pipermerriam/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-05-21T12:35:04Z",
    "updated_at": "2019-05-21T12:35:59Z",
    "author_association": "MEMBER",
    "body": "I *think* this works and is an improvement.  Probably good to give it a spin in `py-ssz` or another implementation to validate there isn't an edge case that isn't obvious which would make this non-viable.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/494372247/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/494728248",
    "html_url": "https://github.com/ethereum/consensus-specs/issues/1087#issuecomment-494728248",
    "issue_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1087",
    "id": 494728248,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ5NDcyODI0OA==",
    "user": {
      "login": "Nashatyrev",
      "id": 8173857,
      "node_id": "MDQ6VXNlcjgxNzM4NTc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8173857?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Nashatyrev",
      "html_url": "https://github.com/Nashatyrev",
      "followers_url": "https://api.github.com/users/Nashatyrev/followers",
      "following_url": "https://api.github.com/users/Nashatyrev/following{/other_user}",
      "gists_url": "https://api.github.com/users/Nashatyrev/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Nashatyrev/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Nashatyrev/subscriptions",
      "organizations_url": "https://api.github.com/users/Nashatyrev/orgs",
      "repos_url": "https://api.github.com/users/Nashatyrev/repos",
      "events_url": "https://api.github.com/users/Nashatyrev/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Nashatyrev/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-05-22T09:33:13Z",
    "updated_at": "2019-05-22T09:33:13Z",
    "author_association": "MEMBER",
    "body": "Cool! Then will make a poc on our Harmony Java client and get back with spec PR ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/494728248/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/495691579",
    "html_url": "https://github.com/ethereum/consensus-specs/issues/1087#issuecomment-495691579",
    "issue_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1087",
    "id": 495691579,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ5NTY5MTU3OQ==",
    "user": {
      "login": "Nashatyrev",
      "id": 8173857,
      "node_id": "MDQ6VXNlcjgxNzM4NTc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8173857?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Nashatyrev",
      "html_url": "https://github.com/Nashatyrev",
      "followers_url": "https://api.github.com/users/Nashatyrev/followers",
      "following_url": "https://api.github.com/users/Nashatyrev/following{/other_user}",
      "gists_url": "https://api.github.com/users/Nashatyrev/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Nashatyrev/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Nashatyrev/subscriptions",
      "organizations_url": "https://api.github.com/users/Nashatyrev/orgs",
      "repos_url": "https://api.github.com/users/Nashatyrev/repos",
      "events_url": "https://api.github.com/users/Nashatyrev/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Nashatyrev/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-05-24T16:08:46Z",
    "updated_at": "2019-05-24T16:08:46Z",
    "author_association": "MEMBER",
    "body": "> the fixed_parts size is statically known\r\n\r\nUps, that was wrong assumption. Doesn’t work for list with variable-size elements",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/495691579/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/495888109",
    "html_url": "https://github.com/ethereum/consensus-specs/issues/1087#issuecomment-495888109",
    "issue_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1087",
    "id": 495888109,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ5NTg4ODEwOQ==",
    "user": {
      "login": "dankrad",
      "id": 6130607,
      "node_id": "MDQ6VXNlcjYxMzA2MDc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6130607?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dankrad",
      "html_url": "https://github.com/dankrad",
      "followers_url": "https://api.github.com/users/dankrad/followers",
      "following_url": "https://api.github.com/users/dankrad/following{/other_user}",
      "gists_url": "https://api.github.com/users/dankrad/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dankrad/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dankrad/subscriptions",
      "organizations_url": "https://api.github.com/users/dankrad/orgs",
      "repos_url": "https://api.github.com/users/dankrad/repos",
      "events_url": "https://api.github.com/users/dankrad/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dankrad/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-05-25T08:42:27Z",
    "updated_at": "2019-05-25T08:42:27Z",
    "author_association": "MEMBER",
    "body": "> Ups, that was wrong assumption. Doesn’t work for list with variable-size elements\r\n\r\nI think you misread that:\r\n```\r\nWe recursively define \"variable-size\" types to be lists and unions and all types that contain a variable-size type.\r\n```\r\nSo a vector containing a variable-size element will also be variable-size itself and be in the variable_parts.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/495888109/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/495889816",
    "html_url": "https://github.com/ethereum/consensus-specs/issues/1087#issuecomment-495889816",
    "issue_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1087",
    "id": 495889816,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ5NTg4OTgxNg==",
    "user": {
      "login": "pipermerriam",
      "id": 824194,
      "node_id": "MDQ6VXNlcjgyNDE5NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/824194?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pipermerriam",
      "html_url": "https://github.com/pipermerriam",
      "followers_url": "https://api.github.com/users/pipermerriam/followers",
      "following_url": "https://api.github.com/users/pipermerriam/following{/other_user}",
      "gists_url": "https://api.github.com/users/pipermerriam/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pipermerriam/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pipermerriam/subscriptions",
      "organizations_url": "https://api.github.com/users/pipermerriam/orgs",
      "repos_url": "https://api.github.com/users/pipermerriam/repos",
      "events_url": "https://api.github.com/users/pipermerriam/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pipermerriam/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-05-25T08:55:30Z",
    "updated_at": "2019-05-25T08:55:30Z",
    "author_association": "MEMBER",
    "body": "I think what @Nashatyrev was trying to say is that this approach proved non-viable due to lists of variable size elements.  The reason is:\r\n\r\nWhen you have a string of bytes that you know represents a list of variable size elements, the only thing you know is that the first 4 bytes are the first offset.  So, you read that.\r\n\r\nIn the current model where offsets denote the beginning of the variable size element, this first offset also defines the boundary between the two sections of SOS data.  By moving the offset to point to the end, the result is that you can no longer learn where that boundary is, and thus, it becomes impossible to decode such lists.\r\n\r\nWe **could** accommodate this via some special case, like including an extra offset for lists of dynamic size elements that denotes where this dividing point is, but I'm not very excited about that, and unless someone really wants to try and make a case for it being worth it....",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/495889816/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/495890428",
    "html_url": "https://github.com/ethereum/consensus-specs/issues/1087#issuecomment-495890428",
    "issue_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1087",
    "id": 495890428,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ5NTg5MDQyOA==",
    "user": {
      "login": "dankrad",
      "id": 6130607,
      "node_id": "MDQ6VXNlcjYxMzA2MDc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6130607?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dankrad",
      "html_url": "https://github.com/dankrad",
      "followers_url": "https://api.github.com/users/dankrad/followers",
      "following_url": "https://api.github.com/users/dankrad/following{/other_user}",
      "gists_url": "https://api.github.com/users/dankrad/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dankrad/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dankrad/subscriptions",
      "organizations_url": "https://api.github.com/users/dankrad/orgs",
      "repos_url": "https://api.github.com/users/dankrad/repos",
      "events_url": "https://api.github.com/users/dankrad/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dankrad/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-05-25T09:00:19Z",
    "updated_at": "2019-05-25T09:00:19Z",
    "author_association": "MEMBER",
    "body": "Ah, agree that we would need a special case for lists. What would make sense is if we treat the offset list itself as one of the variable-size elements in this case, and add an end offset.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/495890428/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/497139106",
    "html_url": "https://github.com/ethereum/consensus-specs/issues/1087#issuecomment-497139106",
    "issue_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1087",
    "id": 497139106,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ5NzEzOTEwNg==",
    "user": {
      "login": "protolambda",
      "id": 19571989,
      "node_id": "MDQ6VXNlcjE5NTcxOTg5",
      "avatar_url": "https://avatars.githubusercontent.com/u/19571989?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/protolambda",
      "html_url": "https://github.com/protolambda",
      "followers_url": "https://api.github.com/users/protolambda/followers",
      "following_url": "https://api.github.com/users/protolambda/following{/other_user}",
      "gists_url": "https://api.github.com/users/protolambda/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/protolambda/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/protolambda/subscriptions",
      "organizations_url": "https://api.github.com/users/protolambda/orgs",
      "repos_url": "https://api.github.com/users/protolambda/repos",
      "events_url": "https://api.github.com/users/protolambda/events{/privacy}",
      "received_events_url": "https://api.github.com/users/protolambda/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-05-29T23:01:14Z",
    "updated_at": "2019-06-28T13:41:52Z",
    "author_association": "MEMBER",
    "body": "To do zero extra allocations when decoding a list of variable-size elements, I:\r\n1. read the first offset\r\n2. use that to compute the count of items, or amount of offsets really (`length = offset / bytes_per_offset`)\r\n3. I can then initialize a slice that will hold the values (I know the memory size of the type of the elements I'm decoding into, e.g. a slice as element is just a slice-header, and I can allocate the exact memory for it).\r\n4. After that, check the offsets I just read in between decoding the variable-size elements one by one\r\n5. Until I handled the last offset.\r\n\r\n\r\nChanging to end-offsets would break that nice efficiency, and I'd have to grow (i.e. unnecessary allocations!) the list as I read end-offsets until I hit an offset that matches the end of the scope.\r\n\r\nA simple quality of life change would be to just start with the length of the list, as 4 bytes, and then do end-offsets. Then you can allocate the list of items ahead of time, and using this length, you can identify the last end-offset when you get there in your stream, without relying on the context (envelope) telling you where the end is.\r\n\r\nThat is just 4 bytes per list, and gets you clean list initialization + careless streaming of any SSZ object (no envelope). ~~I think that's worth it~~ Edit: not worth it. But I'm fine with status quo.\r\n\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/497139106/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
