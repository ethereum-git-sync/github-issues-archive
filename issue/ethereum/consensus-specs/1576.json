{
  "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1576",
  "repository_url": "https://api.github.com/repos/ethereum/consensus-specs",
  "labels_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1576/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1576/comments",
  "events_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1576/events",
  "html_url": "https://github.com/ethereum/consensus-specs/issues/1576",
  "id": 551360876,
  "node_id": "MDU6SXNzdWU1NTEzNjA4NzY=",
  "number": 1576,
  "title": "[BLS - hash_to_curve] Implicit null-byte terminated strings should be explicitly spec-ed",
  "user": {
    "login": "mratsim",
    "id": 22738317,
    "node_id": "MDQ6VXNlcjIyNzM4MzE3",
    "avatar_url": "https://avatars.githubusercontent.com/u/22738317?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mratsim",
    "html_url": "https://github.com/mratsim",
    "followers_url": "https://api.github.com/users/mratsim/followers",
    "following_url": "https://api.github.com/users/mratsim/following{/other_user}",
    "gists_url": "https://api.github.com/users/mratsim/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mratsim/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mratsim/subscriptions",
    "organizations_url": "https://api.github.com/users/mratsim/orgs",
    "repos_url": "https://api.github.com/users/mratsim/repos",
    "events_url": "https://api.github.com/users/mratsim/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mratsim/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2020-01-17T11:25:09Z",
  "updated_at": "2020-01-17T13:19:33Z",
  "closed_at": "2020-01-17T13:19:33Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "I started implementing the new hashToG2 draft and I'm currently facing the following issue:\r\n\r\n### Reference\r\n\r\n- IETF Standard Draft: https://tools.ietf.org/html/draft-irtf-cfrg-hash-to-curve-04\r\n  - Formated HTML version: https://cfrg.github.io/draft-irtf-cfrg-hash-to-curve/draft-irtf-cfrg-hash-to-curve.html\r\n- IETF Implementation: https://github.com/cfrg/draft-irtf-cfrg-hash-to-curve\r\n  - The following can be used as a test vector generator (Python 2 only :/):\r\n    https://github.com/cfrg/draft-irtf-cfrg-hash-to-curve/blob/6cf7fa97/poc/suite_bls12381g2.sage\r\n- Ethereum Foundation implementation: https://github.com/ethereum/py_ecc\r\n  - Specific PR: https://github.com/ethereum/py_ecc/pull/83/files\r\n\r\n### Context\r\n\r\nI'm concerned about:\r\n- the definition of a `string`\r\n- the definition of a `bit-string`\r\n- the definition of an `octet-string`\r\n\r\nThe hash_to_curve spec doesn't explain the expected representation of a string.\r\nIn particular whether strings, bit-strings, octet-strings are **null-terminated or not**\r\n\r\nRelated: the draft links to the I2OSP and OS2IP (integer to octet string primitive / octet-string to integer primitive) as defined in [RFC 8017 - PKCS#1](https://tools.ietf.org/html/rfc8017#section-4) which in eth2-specs term are integer->bigEndian and bigEndian->Integer conversion.\r\n\r\nIn the current Py-ECC implementation (cc @CarlBeek) a [null byte is appended to the message before running HKDF](https://github.com/ethereum/py_ecc/blob/043b562e734480e1d657fccde91be12a33cbdc4e/py_ecc/bls/hash_to_curve.py#L50)\r\n```python\r\ndef hash_to_base_FQ2(message: bytes, ctr: int, DST: bytes) -> FQ2:\r\n    \"\"\"\r\n    Hash To Base for FQ2\r\n    Convert a message to a point in the finite field as defined here:\r\n    https://tools.ietf.org/html/draft-irtf-cfrg-hash-to-curve-05#section-5\r\n    \"\"\"\r\n    m_prime = hkdf_extract(DST, message + b'\\x00')\r\n    info_pfx = b'H2C' + bytes([ctr])\r\n    e = []\r\n\r\n    #  for i in (1, ..., m), where m is the extension degree of FQ2\r\n    for i in range(1, 3):\r\n        info = info_pfx + bytes([i])\r\n        t = hkdf_expand(m_prime, info, HASH_TO_G2_L)\r\n        e.append(big_endian_to_int(t))\r\n\r\n    return FQ2(e)\r\n```\r\nThe new int_to_bytes in the test-suite of #1575 now also ends the byte string by a null byte: https://github.com/ethereum/eth2.0-specs/blob/2a0f68076995fe9915f8df8b58bc5f6273bc9942/tests/generators/bls/main.py#L33-L37\r\n\r\nThis also appears in the [reference implementation in Sage](https://github.com/cfrg/draft-irtf-cfrg-hash-to-curve/blob/6cf7fa9742e2f85f5ee6454861afd462e38d4230/poc/hash_to_base.py#L59-L67).\r\n```python\r\ndef hash_to_base(msg, ctr, dst, modulus, degree, blen, hash_fn):\r\n    rets = [None] * degree\r\n    msg_prime = hkdf_extract(dst, msg + '\\x00', hash_fn)\r\n    info_pfx = 'H2C' + I2OSP(ctr, 1)\r\n    for i in range(0, degree):\r\n        info = info_pfx + I2OSP(i + 1, 1)\r\n        t = hkdf_expand(msg_prime, info, blen, hash_fn)\r\n        rets[i] = OS2IP(t) % modulus\r\n    return rets\r\n```\r\n\r\n### Representation of the message and the dst (Domain-Separation Tag)\r\n\r\nIt seems clear that the message should be null-terminated even though not specified in the IETF draft.\r\nIt is unclear if the domain-separation tag needs to be null-terminated. For testing Py-ECC sets it to the string `\"BLS_SIG_BLS12381G2-SHA256-SSWU-RO_POP_\"`\r\n\r\n### Representation of `bytes`\r\n\r\nThe `int_to_bytes` change in the test suite in #1575 ~has the potential to change all SSZ / hashTreeRoot tests. This could be a major headache to trace that change to a seemingly innocuous function.~.\r\nEdit: the change is BLS-only at the moment and not in a common file imported by all tests.\r\n\r\nFurthermore, if there are 2 types of string, the \"natural\" and the \"null-terminated\" we might need another type in the spec.\r\n\r\n### Performance\r\n\r\nFor languages that represent a string as a pointer + length to a buffer instead of a pointer + \"until null-byte\", requiring a null-terminated string means an extra allocation before hashing. This might have a non-negligeable cost.",
  "closed_by": {
    "login": "mratsim",
    "id": 22738317,
    "node_id": "MDQ6VXNlcjIyNzM4MzE3",
    "avatar_url": "https://avatars.githubusercontent.com/u/22738317?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mratsim",
    "html_url": "https://github.com/mratsim",
    "followers_url": "https://api.github.com/users/mratsim/followers",
    "following_url": "https://api.github.com/users/mratsim/following{/other_user}",
    "gists_url": "https://api.github.com/users/mratsim/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mratsim/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mratsim/subscriptions",
    "organizations_url": "https://api.github.com/users/mratsim/orgs",
    "repos_url": "https://api.github.com/users/mratsim/repos",
    "events_url": "https://api.github.com/users/mratsim/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mratsim/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1576/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1576/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/575594322",
    "html_url": "https://github.com/ethereum/consensus-specs/issues/1576#issuecomment-575594322",
    "issue_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1576",
    "id": 575594322,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU3NTU5NDMyMg==",
    "user": {
      "login": "mratsim",
      "id": 22738317,
      "node_id": "MDQ6VXNlcjIyNzM4MzE3",
      "avatar_url": "https://avatars.githubusercontent.com/u/22738317?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mratsim",
      "html_url": "https://github.com/mratsim",
      "followers_url": "https://api.github.com/users/mratsim/followers",
      "following_url": "https://api.github.com/users/mratsim/following{/other_user}",
      "gists_url": "https://api.github.com/users/mratsim/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mratsim/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mratsim/subscriptions",
      "organizations_url": "https://api.github.com/users/mratsim/orgs",
      "repos_url": "https://api.github.com/users/mratsim/repos",
      "events_url": "https://api.github.com/users/mratsim/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mratsim/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-01-17T11:44:44Z",
    "updated_at": "2020-01-17T11:44:44Z",
    "author_association": "CONTRIBUTOR",
    "body": "Raised upstream: https://github.com/cfrg/draft-irtf-cfrg-hash-to-curve/issues/200",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/575594322/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/575594488",
    "html_url": "https://github.com/ethereum/consensus-specs/issues/1576#issuecomment-575594488",
    "issue_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1576",
    "id": 575594488,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU3NTU5NDQ4OA==",
    "user": {
      "login": "benjaminion",
      "id": 20796281,
      "node_id": "MDQ6VXNlcjIwNzk2Mjgx",
      "avatar_url": "https://avatars.githubusercontent.com/u/20796281?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/benjaminion",
      "html_url": "https://github.com/benjaminion",
      "followers_url": "https://api.github.com/users/benjaminion/followers",
      "following_url": "https://api.github.com/users/benjaminion/following{/other_user}",
      "gists_url": "https://api.github.com/users/benjaminion/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/benjaminion/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/benjaminion/subscriptions",
      "organizations_url": "https://api.github.com/users/benjaminion/orgs",
      "repos_url": "https://api.github.com/users/benjaminion/repos",
      "events_url": "https://api.github.com/users/benjaminion/events{/privacy}",
      "received_events_url": "https://api.github.com/users/benjaminion/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-01-17T11:45:20Z",
    "updated_at": "2020-01-17T12:08:17Z",
    "author_association": "CONTRIBUTOR",
    "body": "Aiui, hash-to-curve deals only in octet strings, that is a list of bytes, and they are not null-terminated. (Strings may be null terminated, depending on your language, but octet strings are not.)\r\n\r\nThe appending of zero bytes is a red-herring. In `hash_to_base()` I believe it is just used to avoid having any zero-length messages.  In the test generator `int_to_bytes()`, they are just padding to size (note that it can prepend multiple zero bytes).\r\n\r\nThe standard says that the DST is an octet string, so no terminating zero byte is added.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/575594488/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/575603853",
    "html_url": "https://github.com/ethereum/consensus-specs/issues/1576#issuecomment-575603853",
    "issue_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1576",
    "id": 575603853,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU3NTYwMzg1Mw==",
    "user": {
      "login": "benjaminion",
      "id": 20796281,
      "node_id": "MDQ6VXNlcjIwNzk2Mjgx",
      "avatar_url": "https://avatars.githubusercontent.com/u/20796281?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/benjaminion",
      "html_url": "https://github.com/benjaminion",
      "followers_url": "https://api.github.com/users/benjaminion/followers",
      "following_url": "https://api.github.com/users/benjaminion/following{/other_user}",
      "gists_url": "https://api.github.com/users/benjaminion/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/benjaminion/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/benjaminion/subscriptions",
      "organizations_url": "https://api.github.com/users/benjaminion/orgs",
      "repos_url": "https://api.github.com/users/benjaminion/repos",
      "events_url": "https://api.github.com/users/benjaminion/events{/privacy}",
      "received_events_url": "https://api.github.com/users/benjaminion/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-01-17T12:17:25Z",
    "updated_at": "2020-01-17T12:17:25Z",
    "author_association": "CONTRIBUTOR",
    "body": "See [Section 5.1](https://tools.ietf.org/html/draft-irtf-cfrg-hash-to-curve-05#section-5.1)\r\n\r\n>   Finally, hash_to_base appends one zero byte to msg in the invocation\r\n>   of HKDF-Extract.  This ensures that the use of HKDF in hash_to_base\r\n>   is indifferentiable from a random oracle...\r\n\r\n(I agree that this could be more clearly stated in the implementation of `hash_to_base()` shown in the standard, and that the interchangeable use of string, octet string and bit string is not great.)",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/575603853/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/575613066",
    "html_url": "https://github.com/ethereum/consensus-specs/issues/1576#issuecomment-575613066",
    "issue_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1576",
    "id": 575613066,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU3NTYxMzA2Ng==",
    "user": {
      "login": "mratsim",
      "id": 22738317,
      "node_id": "MDQ6VXNlcjIyNzM4MzE3",
      "avatar_url": "https://avatars.githubusercontent.com/u/22738317?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mratsim",
      "html_url": "https://github.com/mratsim",
      "followers_url": "https://api.github.com/users/mratsim/followers",
      "following_url": "https://api.github.com/users/mratsim/following{/other_user}",
      "gists_url": "https://api.github.com/users/mratsim/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mratsim/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mratsim/subscriptions",
      "organizations_url": "https://api.github.com/users/mratsim/orgs",
      "repos_url": "https://api.github.com/users/mratsim/repos",
      "events_url": "https://api.github.com/users/mratsim/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mratsim/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-01-17T12:49:41Z",
    "updated_at": "2020-01-17T12:49:41Z",
    "author_association": "CONTRIBUTOR",
    "body": "Excellent catch, I think the implementation section of the spec is just missing that part.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/575613066/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/575622543",
    "html_url": "https://github.com/ethereum/consensus-specs/issues/1576#issuecomment-575622543",
    "issue_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/1576",
    "id": 575622543,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU3NTYyMjU0Mw==",
    "user": {
      "login": "mratsim",
      "id": 22738317,
      "node_id": "MDQ6VXNlcjIyNzM4MzE3",
      "avatar_url": "https://avatars.githubusercontent.com/u/22738317?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mratsim",
      "html_url": "https://github.com/mratsim",
      "followers_url": "https://api.github.com/users/mratsim/followers",
      "following_url": "https://api.github.com/users/mratsim/following{/other_user}",
      "gists_url": "https://api.github.com/users/mratsim/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mratsim/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mratsim/subscriptions",
      "organizations_url": "https://api.github.com/users/mratsim/orgs",
      "repos_url": "https://api.github.com/users/mratsim/repos",
      "events_url": "https://api.github.com/users/mratsim/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mratsim/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-01-17T13:19:33Z",
    "updated_at": "2020-01-17T13:19:33Z",
    "author_association": "CONTRIBUTOR",
    "body": "Closing as only IETF draft clarification is needed.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/575622543/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
