{
  "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/2543",
  "repository_url": "https://api.github.com/repos/ethereum/consensus-specs",
  "labels_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/2543/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/2543/comments",
  "events_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/2543/events",
  "html_url": "https://github.com/ethereum/consensus-specs/issues/2543",
  "id": 961744123,
  "node_id": "MDU6SXNzdWU5NjE3NDQxMjM=",
  "number": 2543,
  "title": "Optimize hashing cost in altair block processing",
  "user": {
    "login": "dapplion",
    "id": 35266934,
    "node_id": "MDQ6VXNlcjM1MjY2OTM0",
    "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/dapplion",
    "html_url": "https://github.com/dapplion",
    "followers_url": "https://api.github.com/users/dapplion/followers",
    "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
    "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
    "organizations_url": "https://api.github.com/users/dapplion/orgs",
    "repos_url": "https://api.github.com/users/dapplion/repos",
    "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
    "received_events_url": "https://api.github.com/users/dapplion/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1063043868,
      "node_id": "MDU6TGFiZWwxMDYzMDQzODY4",
      "url": "https://api.github.com/repos/ethereum/consensus-specs/labels/general:enhancement",
      "name": "general:enhancement",
      "color": "086788",
      "default": false,
      "description": "New feature or request"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2021-08-05T11:51:23Z",
  "updated_at": "2021-09-17T09:42:08Z",
  "closed_at": "2021-09-17T09:42:08Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "*Originally posted in https://discord.com/channels/595666850260713488/595701173944713277/872768356703432774*\r\n\r\nVery late for altair design but we are experiencing a bit of performance issues compared to phase0 regarding hashing of state.balances.\r\n\r\nDuring altair block processing state.balances changes due to:\r\n- every slot for all indexes in the sync committee. 512 random edits\r\n- every slot once for the block proposer on attestation processing. 1 random edit\r\n- on each slashing. Very rare event on main networks.\r\n- on a valid deposit. Infrequent event, if multiple all are contiguous edits\r\n\r\nThe first item is new in altair and requires significant hashing that wasn't previously required in phase0 block processing.\r\n\r\nAccording to numerical tests for a network with 200_000 validators and a committee size of 512, we have to compute ~4000 hashes every slot (source to compute it https://gist.github.com/dapplion/1d354becbd65f9db1b213a8ebe7653d7). Re-hashing the entire tree costs about 100000 hashes. So, through the epoch then we'll have to compute 4000*32 = 128000, so a bit more than rehashing the entire tree. In phase0 with regular network conditions, state.balances may only change when validators join are or slashed, both rare events.\r\n\r\nA potential solution is to add a key to the state `state.syncCommitteeBalanceDeltas` with Gwei and max size 512, to be latter added into balances at the epoch transition, that would be 256 hashes per slot. `1 - 256 / 4000 = 93.6%` reduction in hashing in the state.balances sub tree. The trade-off cost would be extra 4096 bytes added to the state.",
  "closed_by": {
    "login": "dapplion",
    "id": 35266934,
    "node_id": "MDQ6VXNlcjM1MjY2OTM0",
    "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/dapplion",
    "html_url": "https://github.com/dapplion",
    "followers_url": "https://api.github.com/users/dapplion/followers",
    "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
    "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
    "organizations_url": "https://api.github.com/users/dapplion/orgs",
    "repos_url": "https://api.github.com/users/dapplion/repos",
    "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
    "received_events_url": "https://api.github.com/users/dapplion/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/2543/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/2543/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/921659423",
    "html_url": "https://github.com/ethereum/consensus-specs/issues/2543#issuecomment-921659423",
    "issue_url": "https://api.github.com/repos/ethereum/consensus-specs/issues/2543",
    "id": 921659423,
    "node_id": "IC_kwDOCOoGbc4272gf",
    "user": {
      "login": "dapplion",
      "id": 35266934,
      "node_id": "MDQ6VXNlcjM1MjY2OTM0",
      "avatar_url": "https://avatars.githubusercontent.com/u/35266934?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dapplion",
      "html_url": "https://github.com/dapplion",
      "followers_url": "https://api.github.com/users/dapplion/followers",
      "following_url": "https://api.github.com/users/dapplion/following{/other_user}",
      "gists_url": "https://api.github.com/users/dapplion/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dapplion/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dapplion/subscriptions",
      "organizations_url": "https://api.github.com/users/dapplion/orgs",
      "repos_url": "https://api.github.com/users/dapplion/repos",
      "events_url": "https://api.github.com/users/dapplion/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dapplion/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-09-17T09:42:08Z",
    "updated_at": "2021-09-17T09:42:08Z",
    "author_association": "CONTRIBUTOR",
    "body": "External discussion agreed that this change is not worth its costs",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/consensus-specs/issues/comments/921659423/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
