{
  "url": "https://api.github.com/repos/ethereum/tests/issues/714",
  "repository_url": "https://api.github.com/repos/ethereum/tests",
  "labels_url": "https://api.github.com/repos/ethereum/tests/issues/714/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/tests/issues/714/comments",
  "events_url": "https://api.github.com/repos/ethereum/tests/issues/714/events",
  "html_url": "https://github.com/ethereum/tests/issues/714",
  "id": 655785580,
  "node_id": "MDU6SXNzdWU2NTU3ODU1ODA=",
  "number": 714,
  "title": "EIP-150 tests with wrong stateRoot?",
  "user": {
    "login": "jochem-brouwer",
    "id": 29359032,
    "node_id": "MDQ6VXNlcjI5MzU5MDMy",
    "avatar_url": "https://avatars.githubusercontent.com/u/29359032?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jochem-brouwer",
    "html_url": "https://github.com/jochem-brouwer",
    "followers_url": "https://api.github.com/users/jochem-brouwer/followers",
    "following_url": "https://api.github.com/users/jochem-brouwer/following{/other_user}",
    "gists_url": "https://api.github.com/users/jochem-brouwer/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jochem-brouwer/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jochem-brouwer/subscriptions",
    "organizations_url": "https://api.github.com/users/jochem-brouwer/orgs",
    "repos_url": "https://api.github.com/users/jochem-brouwer/repos",
    "events_url": "https://api.github.com/users/jochem-brouwer/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jochem-brouwer/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2020-07-13T11:45:15Z",
  "updated_at": "2020-07-15T07:39:43Z",
  "closed_at": "2020-07-13T17:38:09Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "Hey there - we are [implementing Tangerine Whistle (EIP-150)](https://github.com/ethereumjs/ethereumjs-vm/pull/807) and I cannot get [this specific](https://github.com/ethereum/tests/blob/84b071cd3747b8fec6918f04430660eecf951aa2/LegacyTests/Constantinople/GeneralStateTests/stSystemOperationsTest/doubleSelfdestructTest.json) test to work. I do not understand why.\r\n\r\nI'm assuming here that the `hash` field should be the expected `stateRoot` . \r\n\r\nIn the test, note that the transaction has a `gasPrice` of 0 -> hence gas pricing will not change the stateRoot whatsoever, so we do not care about this pricing.\r\n\r\nHere's my reasoning:\r\n\r\nThe test has a contract (`0x095e7baea6a6c7c4c2dfeb977efac326af552d87`) which calls itself. The first call selfdestructs to `0x02` and then it selfdestructs to `0x01`. \r\n\r\nThe touched accounts are thus `0x01` and `0x02`. In `EIP-158` (Spurious Dragon) will remove account `0x01` from the trie, since it is `DEAD` (it does exist in the trie, but has zero balance, zero code and zero nonce). However, in Tangerine Whistle, it will stay. This should be the sole difference between Tangerine Whistle and Spurious Dragon.\r\n\r\nWhy then does Frontier/Homestead have a different state root? Well, this is because the `CALL` itself goes Out-Of-Gas in this hard fork. If you inspect the deployed code at the contract, you see that `GAS` gets forwarded to the `CALL`. Pre-TF this semantic was `GAS - 20`, since `CALL` used 20 gas. TF changed this; if you forward more than the available gas, instead of going OOG, you forward all the remaining gas. Hence, in Frontier/Homestead, the entire transaction goes OOG and thus no selfdestruct happened. \r\n\r\nI want to note that in my tests, the EIP-158 test passes, but the EIP-150 tests does not pass. I think either the test is wrong somehow or my analysis is wrong and I'd love to get some help here.\r\n\r\nFor completeness, this is the EIP-150 state dump I'd expect:\r\n\r\n```\r\n0000000000000000000000000000000000000001 exists in trie? true\r\nnonce\r\nbalance\r\nstateRoot 56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421\r\ncodeHash c5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470\r\n0000000000000000000000000000000000000002 exists in trie? true\r\nnonce\r\nbalance 0de0b6b3a76586a0\r\nstateRoot 56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421\r\ncodeHash c5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470\r\na94f5374fce5edbc8e2a8697c15331677e6ebf0b exists in trie? true\r\nnonce 01\r\nbalance 0de0b6b3a7627960\r\nstateRoot 56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421\r\ncodeHash c5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470\r\n095e7baea6a6c7c4c2dfeb977efac326af552d87 exists in trie? true\r\nnonce\r\nbalance\r\nstateRoot 56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421\r\ncodeHash c5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470\r\n```\r\n\r\nHere non-defined values are empty buffers, i.e. they are 0.\r\n\r\nThis is the state root I'm getting: `cf78ad0da35b6779d038ce6cd5d32e8eac81090b1f6a1d4430d6047dc2ce7e5c`, while `c5ac5551ef0c7f49c4a25c02c117046045adf7ba7cc672f91d5a1d2ea3a5837d` is expected.\r\n\r\nLinked issue: [Issue 431](https://github.com/ethereum/tests/issues/431).\r\n\r\nAs a final note, I find it weird that in these LegacyTests the gasPrice is set to 0; you'd like to reflect the gas cost changes of these forks in the stateRoot I'd imagine.",
  "closed_by": {
    "login": "jochem-brouwer",
    "id": 29359032,
    "node_id": "MDQ6VXNlcjI5MzU5MDMy",
    "avatar_url": "https://avatars.githubusercontent.com/u/29359032?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jochem-brouwer",
    "html_url": "https://github.com/jochem-brouwer",
    "followers_url": "https://api.github.com/users/jochem-brouwer/followers",
    "following_url": "https://api.github.com/users/jochem-brouwer/following{/other_user}",
    "gists_url": "https://api.github.com/users/jochem-brouwer/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jochem-brouwer/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jochem-brouwer/subscriptions",
    "organizations_url": "https://api.github.com/users/jochem-brouwer/orgs",
    "repos_url": "https://api.github.com/users/jochem-brouwer/repos",
    "events_url": "https://api.github.com/users/jochem-brouwer/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jochem-brouwer/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/tests/issues/714/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/tests/issues/714/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum/tests/issues/comments/657695194",
    "html_url": "https://github.com/ethereum/tests/issues/714#issuecomment-657695194",
    "issue_url": "https://api.github.com/repos/ethereum/tests/issues/714",
    "id": 657695194,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY1NzY5NTE5NA==",
    "user": {
      "login": "jochem-brouwer",
      "id": 29359032,
      "node_id": "MDQ6VXNlcjI5MzU5MDMy",
      "avatar_url": "https://avatars.githubusercontent.com/u/29359032?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jochem-brouwer",
      "html_url": "https://github.com/jochem-brouwer",
      "followers_url": "https://api.github.com/users/jochem-brouwer/followers",
      "following_url": "https://api.github.com/users/jochem-brouwer/following{/other_user}",
      "gists_url": "https://api.github.com/users/jochem-brouwer/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jochem-brouwer/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jochem-brouwer/subscriptions",
      "organizations_url": "https://api.github.com/users/jochem-brouwer/orgs",
      "repos_url": "https://api.github.com/users/jochem-brouwer/repos",
      "events_url": "https://api.github.com/users/jochem-brouwer/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jochem-brouwer/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-07-13T17:38:09Z",
    "updated_at": "2020-07-13T17:38:09Z",
    "author_association": "MEMBER",
    "body": "The issue is resolved; the problem was that our VM did not put an empty coinbase account in the Trie. After Tangerine Whistle, this is not a problem, as it would be cleaned up when removing empty \"touched\" accounts. An empty coinbase account in this case should exist, because the test suite expects that the miner account gets touched and all gas fee get put into this account - in this case, these fees are 0, and thus by Spurious Dragon this account is removed.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/tests/issues/comments/657695194/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/tests/issues/comments/658601866",
    "html_url": "https://github.com/ethereum/tests/issues/714#issuecomment-658601866",
    "issue_url": "https://api.github.com/repos/ethereum/tests/issues/714",
    "id": 658601866,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY1ODYwMTg2Ng==",
    "user": {
      "login": "holgerd77",
      "id": 931137,
      "node_id": "MDQ6VXNlcjkzMTEzNw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/931137?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/holgerd77",
      "html_url": "https://github.com/holgerd77",
      "followers_url": "https://api.github.com/users/holgerd77/followers",
      "following_url": "https://api.github.com/users/holgerd77/following{/other_user}",
      "gists_url": "https://api.github.com/users/holgerd77/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/holgerd77/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/holgerd77/subscriptions",
      "organizations_url": "https://api.github.com/users/holgerd77/orgs",
      "repos_url": "https://api.github.com/users/holgerd77/repos",
      "events_url": "https://api.github.com/users/holgerd77/events{/privacy}",
      "received_events_url": "https://api.github.com/users/holgerd77/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-07-15T07:39:43Z",
    "updated_at": "2020-07-15T07:39:43Z",
    "author_association": "MEMBER",
    "body": "Will just state the name of the test here in case someone with similar problems does a repo-wide search:\r\n`doubleSelfdestructTest`",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/tests/issues/comments/658601866/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
