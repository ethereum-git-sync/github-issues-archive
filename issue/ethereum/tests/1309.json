{
  "url": "https://api.github.com/repos/ethereum/tests/issues/1309",
  "repository_url": "https://api.github.com/repos/ethereum/tests",
  "labels_url": "https://api.github.com/repos/ethereum/tests/issues/1309/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum/tests/issues/1309/comments",
  "events_url": "https://api.github.com/repos/ethereum/tests/issues/1309/events",
  "html_url": "https://github.com/ethereum/tests/issues/1309",
  "id": 1949513846,
  "node_id": "I_kwDOAO0i5850Mzh2",
  "number": 1309,
  "title": "precompile identification tests affected by solc optimisations",
  "user": {
    "login": "winsvega",
    "id": 4492341,
    "node_id": "MDQ6VXNlcjQ0OTIzNDE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4492341?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/winsvega",
    "html_url": "https://github.com/winsvega",
    "followers_url": "https://api.github.com/users/winsvega/followers",
    "following_url": "https://api.github.com/users/winsvega/following{/other_user}",
    "gists_url": "https://api.github.com/users/winsvega/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/winsvega/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/winsvega/subscriptions",
    "organizations_url": "https://api.github.com/users/winsvega/orgs",
    "repos_url": "https://api.github.com/users/winsvega/repos",
    "events_url": "https://api.github.com/users/winsvega/events{/privacy}",
    "received_events_url": "https://api.github.com/users/winsvega/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": {
    "login": "qbzzt",
    "id": 12722969,
    "node_id": "MDQ6VXNlcjEyNzIyOTY5",
    "avatar_url": "https://avatars.githubusercontent.com/u/12722969?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/qbzzt",
    "html_url": "https://github.com/qbzzt",
    "followers_url": "https://api.github.com/users/qbzzt/followers",
    "following_url": "https://api.github.com/users/qbzzt/following{/other_user}",
    "gists_url": "https://api.github.com/users/qbzzt/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/qbzzt/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/qbzzt/subscriptions",
    "organizations_url": "https://api.github.com/users/qbzzt/orgs",
    "repos_url": "https://api.github.com/users/qbzzt/repos",
    "events_url": "https://api.github.com/users/qbzzt/events{/privacy}",
    "received_events_url": "https://api.github.com/users/qbzzt/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "qbzzt",
      "id": 12722969,
      "node_id": "MDQ6VXNlcjEyNzIyOTY5",
      "avatar_url": "https://avatars.githubusercontent.com/u/12722969?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/qbzzt",
      "html_url": "https://github.com/qbzzt",
      "followers_url": "https://api.github.com/users/qbzzt/followers",
      "following_url": "https://api.github.com/users/qbzzt/following{/other_user}",
      "gists_url": "https://api.github.com/users/qbzzt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/qbzzt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/qbzzt/subscriptions",
      "organizations_url": "https://api.github.com/users/qbzzt/orgs",
      "repos_url": "https://api.github.com/users/qbzzt/repos",
      "events_url": "https://api.github.com/users/qbzzt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/qbzzt/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2023-10-18T11:26:43Z",
  "updated_at": "2023-10-24T01:14:03Z",
  "closed_at": null,
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "this tests logic is affected by solc disable optimisations\r\nwhich should not happen. need to check whats going on. \r\nleaving it with optimisation = on for now \r\n\r\n```\r\ninfo: (GeneralStateTests/stPreCompiledContracts/precompsEIP2929, fork: Berlin, TrInfo: d: 2, g: 0, v: 0, TrData: `:label yes :abi f(uint,uint) 0x101157 0xf..`)\r\ninfo: (GeneralStateTests/stPreCompiledContracts/precompsEIP2929Cancun, fork: Cancun, TrInfo: d: 2, g: 0, v: 0, TrData: `:label yes :abi f(uint,uint) 0x101157 0xf..`)\r\n```",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ethereum/tests/issues/1309/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum/tests/issues/1309/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ethereum/tests/issues/comments/1774207234",
    "html_url": "https://github.com/ethereum/tests/issues/1309#issuecomment-1774207234",
    "issue_url": "https://api.github.com/repos/ethereum/tests/issues/1309",
    "id": 1774207234,
    "node_id": "IC_kwDOAO0i585pwEEC",
    "user": {
      "login": "qbzzt",
      "id": 12722969,
      "node_id": "MDQ6VXNlcjEyNzIyOTY5",
      "avatar_url": "https://avatars.githubusercontent.com/u/12722969?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/qbzzt",
      "html_url": "https://github.com/qbzzt",
      "followers_url": "https://api.github.com/users/qbzzt/followers",
      "following_url": "https://api.github.com/users/qbzzt/following{/other_user}",
      "gists_url": "https://api.github.com/users/qbzzt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/qbzzt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/qbzzt/subscriptions",
      "organizations_url": "https://api.github.com/users/qbzzt/orgs",
      "repos_url": "https://api.github.com/users/qbzzt/repos",
      "events_url": "https://api.github.com/users/qbzzt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/qbzzt/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-10-22T21:43:44Z",
    "updated_at": "2023-10-22T21:59:49Z",
    "author_association": "MEMBER",
    "body": "```\r\n              gas0 := gas()\r\n              pop(call(0x100000, addrTest, zero, zero, zero, zero, zero))\r\n              gas1 := gas()\r\n              pop(call(0x100000, addrTest, zero, zero, zero, zero, zero))\r\n              gas2 := gas()\r\n```\r\n\r\n\r\nI found the problem. The actual call being measured doesn't change, but the setup for it (the part that pushes the parameters) does. Specifically, the setup for both the first call and the second call is done before the `gas1=gas()` line. This is perfectly valid (the stack is prepared for the cal), but it's a problem for us.\r\n\r\n\r\n\r\nHere is the offending part in the trace:\r\n```\r\n48-1            GAS         2     31564  39947068    2:[101157,0,]\r\n\r\n\r\n49-1          SWAP1         3     31566  39947066    3:[101157,0,2618b3a,]\r\n50-1           DUP1         3     31569  39947063    3:[101157,2618b3a,0,]\r\n51-1           DUP1         3     31572  39947060    4:[101157,2618b3a,0,0,]\r\n52-1           DUP1         3     31575  39947057    5:[101157,2618b3a,0,0,0,]\r\n53-1           DUP1         3     31578  39947054    6:[101157,2618b3a,0,0,0,0,]\r\n54-1           DUP1         3     31581  39947051    7:[101157,2618b3a,0,0,0,0,0,]\r\n55-1           DUP8         3     31584  39947048    8:[101157,2618b3a,0,0,0,0,0,0,]\r\n56-1          PUSH3         3     31587  39947045    9:[101157,2618b3a,0,0,0,0,0,0,101157>\r\n57-1           CALL   1048676     31590  39947042   10:[101157,2618b3a,0,0,0,0,0,0,101157>\r\n             ^[[33mSUBCALL: 0x101\r\n     58-2          PUSH1         3  38930056   1048576\r\n     59-2          PUSH1         3  38930059   1048573    1:[3,]\r\n     60-2         MSTORE         6  38930062   1048570    2:[3,0,]\r\n             ^[[33m          MSTORE [0x0] = 0x3^[[0m\r\n     61-2           STOP         0  38930068   1048564\r\n62-1            POP         2     31702  39946930    4:[101157,2618b3a,0,1,]\r\n63-1           DUP1         3     31704  39946928    3:[101157,2618b3a,0,]\r\n64-1           DUP1         3     31707  39946925    4:[101157,2618b3a,0,0,]\r\n65-1           DUP1         3     31710  39946922    5:[101157,2618b3a,0,0,0,]\r\n66-1           DUP1         3     31713  39946919    6:[101157,2618b3a,0,0,0,0,]\r\n67-1            GAS         2     31716  39946916    7:[101157,2618b3a,0,0,0,0,0,]\r\n\r\n\r\n68-1          SWAP7         3     31718  39946914    8:[101157,2618b3a,0,0,0,0,0,2618aa2,]\r\n69-1          PUSH3         3     31721  39946911    8:[2618aa2,2618b3a,0,0,0,0,0,101157,]\r\n70-1           CALL   1048676     31724  39946908    9:[2618aa2,2618b3a,0,0,0,0,0,101157,>\r\n             ^[[33mSUBCALL: 0x101157^[[0m\r\n     71-2          PUSH1         3  38930056   1048576             \r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/tests/issues/comments/1774207234/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum/tests/issues/comments/1776307905",
    "html_url": "https://github.com/ethereum/tests/issues/1309#issuecomment-1776307905",
    "issue_url": "https://api.github.com/repos/ethereum/tests/issues/1309",
    "id": 1776307905,
    "node_id": "IC_kwDOAO0i585p4E7B",
    "user": {
      "login": "qbzzt",
      "id": 12722969,
      "node_id": "MDQ6VXNlcjEyNzIyOTY5",
      "avatar_url": "https://avatars.githubusercontent.com/u/12722969?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/qbzzt",
      "html_url": "https://github.com/qbzzt",
      "followers_url": "https://api.github.com/users/qbzzt/followers",
      "following_url": "https://api.github.com/users/qbzzt/following{/other_user}",
      "gists_url": "https://api.github.com/users/qbzzt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/qbzzt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/qbzzt/subscriptions",
      "organizations_url": "https://api.github.com/users/qbzzt/orgs",
      "repos_url": "https://api.github.com/users/qbzzt/repos",
      "events_url": "https://api.github.com/users/qbzzt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/qbzzt/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-10-24T01:14:03Z",
    "updated_at": "2023-10-24T01:14:03Z",
    "author_association": "MEMBER",
    "body": "Solved in principle. If I use `verbatim` for the call, nothing the optimizer does affects it.\r\n\r\nIt's ugly, and if I were writing the test now I'd use LLL, but using properly documented `verbatim` is easier than rewriting the whole thing.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum/tests/issues/comments/1776307905/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
