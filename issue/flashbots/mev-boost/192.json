{
  "url": "https://api.github.com/repos/flashbots/mev-boost/issues/192",
  "repository_url": "https://api.github.com/repos/flashbots/mev-boost",
  "labels_url": "https://api.github.com/repos/flashbots/mev-boost/issues/192/labels{/name}",
  "comments_url": "https://api.github.com/repos/flashbots/mev-boost/issues/192/comments",
  "events_url": "https://api.github.com/repos/flashbots/mev-boost/issues/192/events",
  "html_url": "https://github.com/flashbots/mev-boost/issues/192",
  "id": 1296222902,
  "node_id": "I_kwDOGZSKs85NQsq2",
  "number": 192,
  "title": "Race condition in `run-mergemock-integration` rule",
  "user": {
    "login": "jtraglia",
    "id": 95511699,
    "node_id": "U_kgDOBbFkkw",
    "avatar_url": "https://avatars.githubusercontent.com/u/95511699?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jtraglia",
    "html_url": "https://github.com/jtraglia",
    "followers_url": "https://api.github.com/users/jtraglia/followers",
    "following_url": "https://api.github.com/users/jtraglia/following{/other_user}",
    "gists_url": "https://api.github.com/users/jtraglia/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jtraglia/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jtraglia/subscriptions",
    "organizations_url": "https://api.github.com/users/jtraglia/orgs",
    "repos_url": "https://api.github.com/users/jtraglia/repos",
    "events_url": "https://api.github.com/users/jtraglia/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jtraglia/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2022-07-06T18:38:08Z",
  "updated_at": "2022-07-07T07:11:27Z",
  "closed_at": "2022-07-07T07:11:27Z",
  "author_association": "COLLABORATOR",
  "active_lock_reason": null,
  "body": "When running `run-mergemock-integration` I encountered the following problem:\r\n\r\n```\r\n$ make run-mergemock-integration\r\ngo build -ldflags \"-X main.version=v0.7.0-3-ga56d019\" -v -o mev-boost ./cmd/mev-boost\r\nmake -j3 run-boost-with-relay run-mergemock-consensus run-mergemock-relay\r\n./mev-boost -mainnet -relays http://0x821961b64d99b997c934c22b4fd6109790acf00f7969322c4e9dbf1ca278c333148284c01c5ef551a1536ddd14b178b9@127.0.0.1:28545\r\ncd ../mergemock && ./mergemock consensus --slot-time=4s --engine http://127.0.0.1:8551 --builder http://127.0.0.1:18550 --slot-bound 10\r\ncd ../mergemock && ./mergemock relay --listen-addr 127.0.0.1:28545 --secret-key 1e64a14cb06073c2d7c8b0b891e5dc3dc719b86e5bf4c131ddbaa115f09f8f52\r\nINFO   [2022-07-06T13:27:31-05:00] Loaded JWT secret                             val=\"7dfa23a55b89bd21eb408c59854a01b6105b8856a537cb41668281d6ea03a57d\"\r\nINFO   [2022-07-06T13:27:31-05:00] Loaded JWT secret                             val=\"7dfa23a55b89bd21eb408c59854a01b6105b8856a537cb41668281d6ea03a57d\"\r\nINFO   [2022-07-06T13:27:31-05:00] Persisted trie from memory database           fields.time=\"4.792Âµs\" gcnodes=\"0\" gcsize=\"0.00 B\" gctime=\"0s\" livenodes=\"1\" livesize=\"0.00 B\" nodes=\"1\" size=\"151.00 B\"\r\nINFO   [2022-07-06T13:27:31-05:00] Loaded most recent local header               age=\"53y3mo1w\" hash=\"0xa0513a503d5bd6e89a144c3268e5b7e9da9dbf63df125a360e3950a7d0d67131\" number=\"0\" td=\"17179869184\"\r\nINFO   [2022-07-06T13:27:31-05:00] Loaded most recent local full block           age=\"53y3mo1w\" hash=\"0xa0513a503d5bd6e89a144c3268e5b7e9da9dbf63df125a360e3950a7d0d67131\" number=\"0\" td=\"17179869184\"\r\nINFO   [2022-07-06T13:27:31-05:00] Loaded most recent local fast block           age=\"53y3mo1w\" hash=\"0xa0513a503d5bd6e89a144c3268e5b7e9da9dbf63df125a360e3950a7d0d67131\" number=\"0\" td=\"17179869184\"\r\nWARNING[2022-07-06T13:27:31-05:00] Failed to load snapshot, regenerating         err=\"missing or corrupted snapshot\"\r\nINFO   [2022-07-06T13:27:31-05:00] Rebuilding state snapshot\r\nINFO   [2022-07-06T13:27:31-05:00] Resuming state snapshot generation            accounts=\"0\" elapsed=\"86.709Âµs\" root=\"0xca3149fa9e37db08d1cd49c9061db1002ef1cd58db2210f2115c8c989b2bdf45\" slots=\"0\" storage=\"0.00 B\"\r\nINFO   [2022-07-06T13:27:31-05:00] Generated state snapshot                      accounts=\"1\" elapsed=\"173.125Âµs\" slots=\"0\" storage=\"50.00 B\"\r\nINFO   [2022-07-06T13:27:31-05:00] Engine started                                listenAddr=\"127.0.0.1:8551\"\r\nINFO   [2022-07-06T13:27:31-05:00] Relay started                                 listenAddr=\"127.0.0.1:28545\"\r\nPost \"http://127.0.0.1:18550/eth/v1/builder/validators\": dial tcp 127.0.0.1:18550: connect: connection refused\r\nmake[1]: *** [run-mergemock-consensus] Error 1\r\nmake[1]: *** Waiting for unfinished jobs....\r\nINFO[2022-07-06T13:27:31-05:00] mev-boost v0.7.0-3-ga56d019                   module=cmd/mev-boost\r\nINFO[2022-07-06T13:27:31-05:00] Using genesis fork version: 0x00000000        module=cmd/mev-boost\r\nINFO[2022-07-06T13:27:31-05:00] using 1 relays                                module=cmd/mev-boost relays=\"[{http://127.0.0.1:28545 0x821961b64d99b997c934c22b4fd6109790acf00f7969322c4e9dbf1ca278c333148284c01c5ef551a1536ddd14b178b9 http://0x821961b64d99b997c934c22b4fd6109790acf00f7969322c4e9dbf1ca278c333148284c01c5ef551a1536ddd14b178b9@127.0.0.1:28545}]\"\r\nINFO[2022-07-06T13:27:31-05:00] listening on localhost:18550                  module=cmd/mev-boost\r\n```\r\n\r\nThis happened because `run-mergemock-consensus` executed before `run-boost-with-relay` could bring up the relay. More specifically, this happened because these rules are executed in parallel using make \"jobs\". I believe this should be changed.\r\n\r\nhttps://github.com/flashbots/mev-boost/blob/64edd7c250db67831be0fb86aebcf81a85dd4332/Makefile#L63-L64\r\n\r\nIn order to get this test to work, I needed to run these three commands separately.",
  "closed_by": {
    "login": "metachris",
    "id": 116939,
    "node_id": "MDQ6VXNlcjExNjkzOQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/116939?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/metachris",
    "html_url": "https://github.com/metachris",
    "followers_url": "https://api.github.com/users/metachris/followers",
    "following_url": "https://api.github.com/users/metachris/following{/other_user}",
    "gists_url": "https://api.github.com/users/metachris/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/metachris/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/metachris/subscriptions",
    "organizations_url": "https://api.github.com/users/metachris/orgs",
    "repos_url": "https://api.github.com/users/metachris/repos",
    "events_url": "https://api.github.com/users/metachris/events{/privacy}",
    "received_events_url": "https://api.github.com/users/metachris/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/flashbots/mev-boost/issues/192/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/flashbots/mev-boost/issues/192/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/flashbots/mev-boost/issues/comments/1176594139",
    "html_url": "https://github.com/flashbots/mev-boost/issues/192#issuecomment-1176594139",
    "issue_url": "https://api.github.com/repos/flashbots/mev-boost/issues/192",
    "id": 1176594139,
    "node_id": "IC_kwDOGZSKs85GIWbb",
    "user": {
      "login": "metachris",
      "id": 116939,
      "node_id": "MDQ6VXNlcjExNjkzOQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/116939?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/metachris",
      "html_url": "https://github.com/metachris",
      "followers_url": "https://api.github.com/users/metachris/followers",
      "following_url": "https://api.github.com/users/metachris/following{/other_user}",
      "gists_url": "https://api.github.com/users/metachris/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/metachris/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/metachris/subscriptions",
      "organizations_url": "https://api.github.com/users/metachris/orgs",
      "repos_url": "https://api.github.com/users/metachris/repos",
      "events_url": "https://api.github.com/users/metachris/events{/privacy}",
      "received_events_url": "https://api.github.com/users/metachris/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-06T19:26:15Z",
    "updated_at": "2022-07-06T19:26:15Z",
    "author_association": "COLLABORATOR",
    "body": "Good find! the `-j3` is a quick hack by @jparyani to run these in parallel :) Happy to update to a better setup. Any recommendation? Plan B could be to just background the steps and have a quick sleep in between them ðŸ¤” ",
    "reactions": {
      "url": "https://api.github.com/repos/flashbots/mev-boost/issues/comments/1176594139/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/flashbots/mev-boost/issues/comments/1176630211",
    "html_url": "https://github.com/flashbots/mev-boost/issues/192#issuecomment-1176630211",
    "issue_url": "https://api.github.com/repos/flashbots/mev-boost/issues/192",
    "id": 1176630211,
    "node_id": "IC_kwDOGZSKs85GIfPD",
    "user": {
      "login": "jtraglia",
      "id": 95511699,
      "node_id": "U_kgDOBbFkkw",
      "avatar_url": "https://avatars.githubusercontent.com/u/95511699?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jtraglia",
      "html_url": "https://github.com/jtraglia",
      "followers_url": "https://api.github.com/users/jtraglia/followers",
      "following_url": "https://api.github.com/users/jtraglia/following{/other_user}",
      "gists_url": "https://api.github.com/users/jtraglia/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jtraglia/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jtraglia/subscriptions",
      "organizations_url": "https://api.github.com/users/jtraglia/orgs",
      "repos_url": "https://api.github.com/users/jtraglia/repos",
      "events_url": "https://api.github.com/users/jtraglia/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jtraglia/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-06T19:48:28Z",
    "updated_at": "2022-07-06T19:48:28Z",
    "author_association": "COLLABORATOR",
    "body": "@metachris Yes, I have some ideas. I'm working on a PR now. Will post soon.",
    "reactions": {
      "url": "https://api.github.com/repos/flashbots/mev-boost/issues/comments/1176630211/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
