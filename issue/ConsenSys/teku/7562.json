{
  "url": "https://api.github.com/repos/Consensys/teku/issues/7562",
  "repository_url": "https://api.github.com/repos/Consensys/teku",
  "labels_url": "https://api.github.com/repos/Consensys/teku/issues/7562/labels{/name}",
  "comments_url": "https://api.github.com/repos/Consensys/teku/issues/7562/comments",
  "events_url": "https://api.github.com/repos/Consensys/teku/issues/7562/events",
  "html_url": "https://github.com/Consensys/teku/issues/7562",
  "id": 1919946081,
  "node_id": "I_kwDOCM9I9M5ycA1h",
  "number": 7562,
  "title": "`/eth/v1/validator/duties/attester/{epoch}` takes too long",
  "user": {
    "login": "mcdee",
    "id": 511384,
    "node_id": "MDQ6VXNlcjUxMTM4NA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/511384?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mcdee",
    "html_url": "https://github.com/mcdee",
    "followers_url": "https://api.github.com/users/mcdee/followers",
    "following_url": "https://api.github.com/users/mcdee/following{/other_user}",
    "gists_url": "https://api.github.com/users/mcdee/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mcdee/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mcdee/subscriptions",
    "organizations_url": "https://api.github.com/users/mcdee/orgs",
    "repos_url": "https://api.github.com/users/mcdee/repos",
    "events_url": "https://api.github.com/users/mcdee/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mcdee/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1271198478,
      "node_id": "MDU6TGFiZWwxMjcxMTk4NDc4",
      "url": "https://api.github.com/repos/Consensys/teku/labels/performance%20%F0%9F%9A%80",
      "name": "performance ðŸš€",
      "color": "ffcce3",
      "default": false,
      "description": "Improves performance without changing functionality"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": {
    "login": "rolfyone",
    "id": 2967240,
    "node_id": "MDQ6VXNlcjI5NjcyNDA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2967240?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/rolfyone",
    "html_url": "https://github.com/rolfyone",
    "followers_url": "https://api.github.com/users/rolfyone/followers",
    "following_url": "https://api.github.com/users/rolfyone/following{/other_user}",
    "gists_url": "https://api.github.com/users/rolfyone/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/rolfyone/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rolfyone/subscriptions",
    "organizations_url": "https://api.github.com/users/rolfyone/orgs",
    "repos_url": "https://api.github.com/users/rolfyone/repos",
    "events_url": "https://api.github.com/users/rolfyone/events{/privacy}",
    "received_events_url": "https://api.github.com/users/rolfyone/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "rolfyone",
      "id": 2967240,
      "node_id": "MDQ6VXNlcjI5NjcyNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2967240?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rolfyone",
      "html_url": "https://github.com/rolfyone",
      "followers_url": "https://api.github.com/users/rolfyone/followers",
      "following_url": "https://api.github.com/users/rolfyone/following{/other_user}",
      "gists_url": "https://api.github.com/users/rolfyone/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rolfyone/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rolfyone/subscriptions",
      "organizations_url": "https://api.github.com/users/rolfyone/orgs",
      "repos_url": "https://api.github.com/users/rolfyone/repos",
      "events_url": "https://api.github.com/users/rolfyone/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rolfyone/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2023-09-29T21:50:09Z",
  "updated_at": "2023-10-03T00:08:54Z",
  "closed_at": null,
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "### Description\r\n\r\nRunning the above endpoint with 50,000 validators takes nearly 1 minute to return.  On other beacon nodes it takes ~1 second.\r\n\r\n### Steps to Reproduce (Bug)\r\n\r\nRun the above endpoint for the current epoch, submitting a body containing 50,000 indices.\r\n\r\n**Expected behavior:** return the data in a reasonable timeframe (~1s).\r\n \r\n**Actual behavior:** takes around 1 minute to respond, which loses the ability to attest for slots early in the epoch.\r\n\r\n**Frequency:** Always, with this number of validators.\r\n\r\n### Versions (Add all that apply)\r\n* Software version: teku/v23.9.1/linux-x86_64/-privatebuild-openjdk64bitservervm-java-17\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/Consensys/teku/issues/7562/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/Consensys/teku/issues/7562/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/Consensys/teku/issues/comments/1743940822",
    "html_url": "https://github.com/Consensys/teku/issues/7562#issuecomment-1743940822",
    "issue_url": "https://api.github.com/repos/Consensys/teku/issues/7562",
    "id": 1743940822,
    "node_id": "IC_kwDOCM9I9M5n8mzW",
    "user": {
      "login": "rolfyone",
      "id": 2967240,
      "node_id": "MDQ6VXNlcjI5NjcyNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2967240?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rolfyone",
      "html_url": "https://github.com/rolfyone",
      "followers_url": "https://api.github.com/users/rolfyone/followers",
      "following_url": "https://api.github.com/users/rolfyone/following{/other_user}",
      "gists_url": "https://api.github.com/users/rolfyone/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rolfyone/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rolfyone/subscriptions",
      "organizations_url": "https://api.github.com/users/rolfyone/orgs",
      "repos_url": "https://api.github.com/users/rolfyone/repos",
      "events_url": "https://api.github.com/users/rolfyone/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rolfyone/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-10-03T00:00:37Z",
    "updated_at": "2023-10-03T00:00:37Z",
    "author_association": "CONTRIBUTOR",
    "body": "Just trying to replicate this...\nI generated a file that was basically \n```\n[\"100\", \"101\"..., \"50100\"]\n```\nand sent that with a little test script:\n```\n#!/usr/bin/bash\n\nif [ -z \"$1\" ]; then exit 1; fi\n\ncurl -X POST \\\n\t-v --trace-time \\\n\t-w \"@curl-format.txt\" \\\n\thttp://localhost:5051/eth/v1/validator/duties/attester/$1 \\\n -H 'accept: application/json' \\\n  -H 'Content-Type: application/json' \\\n  -d @body.json \\\n  -o out.json\n```\ncurl-format was just: \n```\n     time_namelookup:  %{time_namelookup}s\\n\n        time_connect:  %{time_connect}s\\n\n     time_appconnect:  %{time_appconnect}s\\n\n    time_pretransfer:  %{time_pretransfer}s\\n\n       time_redirect:  %{time_redirect}s\\n\n  time_starttransfer:  %{time_starttransfer}s\\n\n         Speed_upload: %{speed_upload}\\n\n                     ----------\\n\n          time_total:  %{time_total}s\\n\n```\nI was mostly concerned where the time was going...\n\ntrace-time shows:\n```\n./test.sh 232986\nNote: Unnecessary use of -X or --request, POST is already inferred.\n23:48:09.888907 *   Trying 127.0.0.1:5051...\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     023:48:09.889409 * Connected to localhost (127.0.0.1) port 5051 (#0)\n23:48:09.889475 > POST /eth/v1/validator/duties/attester/232986 HTTP/1.1\n23:48:09.889475 > Host: localhost:5051\n23:48:09.889475 > User-Agent: curl/7.81.0\n23:48:09.889475 > accept: application/json\n23:48:09.889475 > Content-Type: application/json\n23:48:09.889475 > Content-Length: 439200\n23:48:09.889475 >\n23:48:09.889735 } [65536 bytes data]\n23:48:09.889922 * We are completely uploaded and fine\n100  428k    0     0  100  428k      0  28860  0:00:15  0:00:15 --:--:--     023:48:25.130074 * Mark bundle as not supporting multiuse\n23:48:25.130116 < HTTP/1.1 200 OK\n23:48:25.130137 < Date: Mon, 02 Oct 2023 23:48:09 GMT\n23:48:25.130156 < Content-Type: application/json\n23:48:25.130175 < Transfer-Encoding: chunked\n23:48:25.130192 < Server: Jetty(11.0.15)\n23:48:25.130211 <\n23:48:25.130229 { [32774 bytes data]\n100 8617k    0 8188k  100  428k   534k  28678  0:00:15  0:00:15 --:--:-- 1996k\n23:48:25.203686 * Connection #0 to host localhost left intact\n     time_namelookup:  0.000017s\n        time_connect:  0.000540s\n     time_appconnect:  0.000000s\n    time_pretransfer:  0.000798s\n       time_redirect:  0.000000s\n  time_starttransfer:  0.000800s\n         Speed_upload: 28678\n                     ----------\n          time_total:  15.314750s\n```\n\nbasically most of the 15 seconds were taken receiving data, so that'll be something to do with how we're constructing the response...\n\n15 seconds is still way too long, but just spelling out how i measured.\n\nI'll try to replicate this in a better way so that i can profile and see what's going on.",
    "reactions": {
      "url": "https://api.github.com/repos/Consensys/teku/issues/comments/1743940822/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
