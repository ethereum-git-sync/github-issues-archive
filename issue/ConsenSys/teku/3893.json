{
  "url": "https://api.github.com/repos/ConsenSys/teku/issues/3893",
  "repository_url": "https://api.github.com/repos/ConsenSys/teku",
  "labels_url": "https://api.github.com/repos/ConsenSys/teku/issues/3893/labels{/name}",
  "comments_url": "https://api.github.com/repos/ConsenSys/teku/issues/3893/comments",
  "events_url": "https://api.github.com/repos/ConsenSys/teku/issues/3893/events",
  "html_url": "https://github.com/ConsenSys/teku/issues/3893",
  "id": 863824752,
  "node_id": "MDU6SXNzdWU4NjM4MjQ3NTI=",
  "number": 3893,
  "title": "Failure to open database after Teku upgrade",
  "user": {
    "login": "benjaminion",
    "id": 20796281,
    "node_id": "MDQ6VXNlcjIwNzk2Mjgx",
    "avatar_url": "https://avatars.githubusercontent.com/u/20796281?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/benjaminion",
    "html_url": "https://github.com/benjaminion",
    "followers_url": "https://api.github.com/users/benjaminion/followers",
    "following_url": "https://api.github.com/users/benjaminion/following{/other_user}",
    "gists_url": "https://api.github.com/users/benjaminion/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/benjaminion/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/benjaminion/subscriptions",
    "organizations_url": "https://api.github.com/users/benjaminion/orgs",
    "repos_url": "https://api.github.com/users/benjaminion/repos",
    "events_url": "https://api.github.com/users/benjaminion/events{/privacy}",
    "received_events_url": "https://api.github.com/users/benjaminion/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "ajsutton",
    "id": 72675,
    "node_id": "MDQ6VXNlcjcyNjc1",
    "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ajsutton",
    "html_url": "https://github.com/ajsutton",
    "followers_url": "https://api.github.com/users/ajsutton/followers",
    "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
    "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
    "organizations_url": "https://api.github.com/users/ajsutton/orgs",
    "repos_url": "https://api.github.com/users/ajsutton/repos",
    "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ajsutton/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2021-04-21T12:41:16Z",
  "updated_at": "2021-05-19T01:39:51Z",
  "closed_at": "2021-05-19T01:39:51Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "Report from `stefa2k#3917` on Discord:\r\n\r\n> got an issue when updating from 21.3.2 to 21.4.0.\r\n\r\nI've requested the full version info: I believe that we have made some changes to the DB columns, but I don't think they are in a release yet. Note the `RocksDBException: You have to open all column families. Column families not opened:` message.\r\n\r\n```\r\nbeacon_1         | 11:32:25.770 INFO  - Beacon data directory set to: /opt/teku/data/beacon\r\nbeacon_1         | 11:32:27.758 FATAL - Failed to open database at path: /opt/teku/data/beacon/archive\r\nbeacon_1         | tech.pegasys.teku.storage.server.DatabaseStorageException: Failed to open database at path: /opt/teku/data/beacon/archive\r\nbeacon_1         |      at tech.pegasys.teku.storage.server.DatabaseStorageException.unrecoverable(DatabaseStorageException.java:31) ~[teku-storage-21.4.0.jar:21.4.0]\r\nbeacon_1         |      at tech.pegasys.teku.storage.server.rocksdb.RocksDbExceptionUtil.wrapException(RocksDbExceptionUtil.java:23) ~[teku-storage-21.4.0.jar:21.4.0]\r\nbeacon_1         |      at tech.pegasys.teku.storage.server.rocksdb.core.RocksDbInstanceFactory.create(RocksDbInstanceFactory.java:110) ~[teku-storage-21.4.0.jar:21.4.0]\r\nbeacon_1         |      at tech.pegasys.teku.storage.server.rocksdb.RocksDbDatabase.createV4(RocksDbDatabase.java:130) ~[teku-storage-21.4.0.jar:21.4.0]\r\nbeacon_1         |      at tech.pegasys.teku.storage.server.VersionedDatabaseFactory.createV5Database(VersionedDatabaseFactory.java:242) ~[teku-storage-21.4.0.jar:21.4.0]\r\nbeacon_1         |      at tech.pegasys.teku.storage.server.VersionedDatabaseFactory.createDatabase(VersionedDatabaseFactory.java:151) ~[teku-storage-21.4.0.jar:21.4.0]\r\nbeacon_1         |      at tech.pegasys.teku.services.chainstorage.StorageService.lambda$doStart$0(StorageService.java:62) ~[teku-services-chainstorage-21.4.0.jar:21.4.0]\r\nbeacon_1         |      at tech.pegasys.teku.infrastructure.async.SafeFuture.fromRunnable(SafeFuture.java:151) ~[teku-infrastructure-async-21.4.0.jar:21.4.0]\r\nbeacon_1         |      at tech.pegasys.teku.services.chainstorage.StorageService.doStart(StorageService.java:49) ~[teku-services-chainstorage-21.4.0.jar:21.4.0]\r\nbeacon_1         |      at tech.pegasys.teku.service.serviceutils.Service.start(Service.java:33) ~[teku-services-serviceutils-21.4.0.jar:21.4.0]\r\nbeacon_1         |      at tech.pegasys.teku.services.ServiceController.doStart(ServiceController.java:29) ~[teku-21.4.0.jar:21.4.0]\r\nbeacon_1         |      at tech.pegasys.teku.service.serviceutils.Service.start(Service.java:33) ~[teku-services-serviceutils-21.4.0.jar:21.4.0]\r\nbeacon_1         |      at tech.pegasys.teku.AbstractNode.start(AbstractNode.java:83) ~[teku-21.4.0.jar:21.4.0]\r\nbeacon_1         |      at tech.pegasys.teku.Teku.start(Teku.java:46) ~[teku-21.4.0.jar:21.4.0]\r\nbeacon_1         |      at tech.pegasys.teku.cli.BeaconNodeCommand.call(BeaconNodeCommand.java:282) [teku-21.4.0.jar:21.4.0]\r\nbeacon_1         |      at tech.pegasys.teku.cli.BeaconNodeCommand.call(BeaconNodeCommand.java:71) [teku-21.4.0.jar:21.4.0]\r\nbeacon_1         |      at picocli.CommandLine.executeUserObject(CommandLine.java:1933) [picocli-4.4.0.jar:4.4.0]\r\nbeacon_1         |      at picocli.CommandLine.access$1100(CommandLine.java:145) [picocli-4.4.0.jar:4.4.0]\r\nbeacon_1         |      at picocli.CommandLine$RunLast.executeUserObjectOfLastSubcommandWithSameParent(CommandLine.java:2332) [picocli-4.4.0.jar:4.4.0]\r\nbeacon_1         |      at picocli.CommandLine$RunLast.handle(CommandLine.java:2326) [picocli-4.4.0.jar:4.4.0]\r\nbeacon_1         |      at picocli.CommandLine$RunLast.handle(CommandLine.java:2291) [picocli-4.4.0.jar:4.4.0]\r\nbeacon_1         |      at picocli.CommandLine$AbstractParseResultHandler.execute(CommandLine.java:2159) [picocli-4.4.0.jar:4.4.0]\r\nbeacon_1         |      at picocli.CommandLine.execute(CommandLine.java:2058) [picocli-4.4.0.jar:4.4.0]\r\nbeacon_1         |      at tech.pegasys.teku.cli.BeaconNodeCommand.parse(BeaconNodeCommand.java:231) [teku-21.4.0.jar:21.4.0]\r\nbeacon_1         |      at tech.pegasys.teku.Teku.main(Teku.java:32) [teku-21.4.0.jar:21.4.0]\r\nbeacon_1         | Caused by: org.rocksdb.RocksDBException: You have to open all column families. Column families not opened: \r\nbeacon_1         |      at org.rocksdb.TransactionDB.open(Native Method) ~[rocksdbjni-6.11.4.jar:?]\r\nbeacon_1         |      at org.rocksdb.TransactionDB.open(TransactionDB.java:90) ~[rocksdbjni-6.11.4.jar:?]\r\nbeacon_1         |      at tech.pegasys.teku.storage.server.rocksdb.core.RocksDbInstanceFactory.create(RocksDbInstanceFactory.java:83) ~[teku-storage-21.4.0.jar:21.4.0]\r\nbeacon_1         |      ... 22 more\r\nbeacon_1         | Failed to open database at path: /opt/teku/data/beacon/archive\r\n```\r\n\r\n> after deleting the data it starts up correctly and syncs",
  "closed_by": {
    "login": "ajsutton",
    "id": 72675,
    "node_id": "MDQ6VXNlcjcyNjc1",
    "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ajsutton",
    "html_url": "https://github.com/ajsutton",
    "followers_url": "https://api.github.com/users/ajsutton/followers",
    "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
    "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
    "organizations_url": "https://api.github.com/users/ajsutton/orgs",
    "repos_url": "https://api.github.com/users/ajsutton/repos",
    "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ajsutton/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/3893/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ConsenSys/teku/issues/3893/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/827208671",
    "html_url": "https://github.com/ConsenSys/teku/issues/3893#issuecomment-827208671",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/3893",
    "id": 827208671,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgyNzIwODY3MQ==",
    "user": {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-04-26T23:39:30Z",
    "updated_at": "2021-04-26T23:39:30Z",
    "author_association": "CONTRIBUTOR",
    "body": "I've tested this locally and can't reproduce it going between those two versions.  The error message indicates that a RocksDB column had previously been used on the stored database but was no longer being specified.  Adding new columns is allowed, but removing them is not backwards compatible.\n\nThere was a new column added in 21.4.0 and another new column added in 21.4.1 but none were removed.  Both those changes were in the archive database which is what's failing to open so it seems likely that somehow a newer version of Teku opened the database which created the additional columns though the user doesn't believe a `develop` version was used on that server.  In any case the latest teku release includes all the new columns so should work with the database if it's still available.\n\nI'm not sure there's much more we can do to investigate unless we can get a copy of the db and its still failing to open with 21.4.1.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/827208671/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/827374317",
    "html_url": "https://github.com/ConsenSys/teku/issues/3893#issuecomment-827374317",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/3893",
    "id": 827374317,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgyNzM3NDMxNw==",
    "user": {
      "login": "stefa2k",
      "id": 54934211,
      "node_id": "MDQ6VXNlcjU0OTM0MjEx",
      "avatar_url": "https://avatars.githubusercontent.com/u/54934211?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/stefa2k",
      "html_url": "https://github.com/stefa2k",
      "followers_url": "https://api.github.com/users/stefa2k/followers",
      "following_url": "https://api.github.com/users/stefa2k/following{/other_user}",
      "gists_url": "https://api.github.com/users/stefa2k/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/stefa2k/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/stefa2k/subscriptions",
      "organizations_url": "https://api.github.com/users/stefa2k/orgs",
      "repos_url": "https://api.github.com/users/stefa2k/repos",
      "events_url": "https://api.github.com/users/stefa2k/events{/privacy}",
      "received_events_url": "https://api.github.com/users/stefa2k/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-04-27T07:16:42Z",
    "updated_at": "2021-04-27T07:16:42Z",
    "author_association": "NONE",
    "body": "Unfortunately I can't provide a db, because it was a prater testnet setup I just deleted the files and carried on to test our software. I can say for sure that it were these versions, but I can't rule out that we originally already migrated multiple times from older versions to newer versions and then to `21.3.2` (never going back in time but making upgrades multiple times). What exact versions we used exactly I can't say, we usually use all the releases and update and test as soon as you guys release a new one.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/827374317/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/843680008",
    "html_url": "https://github.com/ConsenSys/teku/issues/3893#issuecomment-843680008",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/3893",
    "id": 843680008,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg0MzY4MDAwOA==",
    "user": {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-05-19T01:39:51Z",
    "updated_at": "2021-05-19T01:39:51Z",
    "author_association": "CONTRIBUTOR",
    "body": "Going to close this one as we don't have any further information to go on.  Thanks for taking the time to report it though - we've finished the database changes now anyway but if this does occur again being able to get a copy of the database would definitely be very useful.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/843680008/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
