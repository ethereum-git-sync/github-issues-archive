{
  "url": "https://api.github.com/repos/ConsenSys/teku/issues/4025",
  "repository_url": "https://api.github.com/repos/ConsenSys/teku",
  "labels_url": "https://api.github.com/repos/ConsenSys/teku/issues/4025/labels{/name}",
  "comments_url": "https://api.github.com/repos/ConsenSys/teku/issues/4025/comments",
  "events_url": "https://api.github.com/repos/ConsenSys/teku/issues/4025/events",
  "html_url": "https://github.com/ConsenSys/teku/issues/4025",
  "id": 899505045,
  "node_id": "MDU6SXNzdWU4OTk1MDUwNDU=",
  "number": 4025,
  "title": "Incorrect BLS key validation",
  "user": {
    "login": "dnkolegov",
    "id": 6521369,
    "node_id": "MDQ6VXNlcjY1MjEzNjk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6521369?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/dnkolegov",
    "html_url": "https://github.com/dnkolegov",
    "followers_url": "https://api.github.com/users/dnkolegov/followers",
    "following_url": "https://api.github.com/users/dnkolegov/following{/other_user}",
    "gists_url": "https://api.github.com/users/dnkolegov/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/dnkolegov/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/dnkolegov/subscriptions",
    "organizations_url": "https://api.github.com/users/dnkolegov/orgs",
    "repos_url": "https://api.github.com/users/dnkolegov/repos",
    "events_url": "https://api.github.com/users/dnkolegov/events{/privacy}",
    "received_events_url": "https://api.github.com/users/dnkolegov/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 6,
  "created_at": "2021-05-24T09:55:28Z",
  "updated_at": "2021-05-25T11:33:11Z",
  "closed_at": "2021-05-25T11:33:11Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "<!-- Have you done the following? -->\r\n<!--   * read the Code of Conduct? By filing an Issue, you are expected to -->  \r\n<!--     comply with it, including treating everyone with respect: -->\r\n<!--     https://github.com/ConsenSys/teku/blob/master/CODE-OF-CONDUCT.md -->\r\n<!--   * Reproduced the issue in the latest version of the software -->\r\n<!--   * Read the debugging wiki: https://github.com/ConsenSys/teku/wiki/debugging -->\r\n<!--   * Duplicate Issue check:  https://github.com/search?q=+is%3Aissue+repo%3AConsenSys/Teku -->\r\n<!-- Note:  Not all sections will apply to all issue types. -->\r\n\r\n### Description\r\nPublic key validation must check group membership and that the key is not the point at infinity.\r\nAt the same time:\r\n- BLST-backed implementation [checks](https://github.com/ConsenSys/teku/blob/master/bls/src/main/java/tech/pegasys/teku/bls/impl/blst/BlstPublicKey.java#L84) group membership only\r\n- MIKULI-backed implementation [doesn't validate](https://github.com/ConsenSys/teku/blob/master/bls/src/main/java/tech/pegasys/teku/bls/impl/mikuli/MikuliPublicKey.java#L106) the key at all\r\n\r\n### Acceptance Criteria\r\n* All algorithms that operate on public keys require first validating those keys\r\n* It should include group membership and infinity checks, as per https://tools.ietf.org/html/draft-irtf-cfrg-bls-signature-04#section-2.5.\r\n",
  "closed_by": {
    "login": "benjaminion",
    "id": 20796281,
    "node_id": "MDQ6VXNlcjIwNzk2Mjgx",
    "avatar_url": "https://avatars.githubusercontent.com/u/20796281?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/benjaminion",
    "html_url": "https://github.com/benjaminion",
    "followers_url": "https://api.github.com/users/benjaminion/followers",
    "following_url": "https://api.github.com/users/benjaminion/following{/other_user}",
    "gists_url": "https://api.github.com/users/benjaminion/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/benjaminion/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/benjaminion/subscriptions",
    "organizations_url": "https://api.github.com/users/benjaminion/orgs",
    "repos_url": "https://api.github.com/users/benjaminion/repos",
    "events_url": "https://api.github.com/users/benjaminion/events{/privacy}",
    "received_events_url": "https://api.github.com/users/benjaminion/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/4025/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ConsenSys/teku/issues/4025/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/846957053",
    "html_url": "https://github.com/ConsenSys/teku/issues/4025#issuecomment-846957053",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/4025",
    "id": 846957053,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg0Njk1NzA1Mw==",
    "user": {
      "login": "benjaminion",
      "id": 20796281,
      "node_id": "MDQ6VXNlcjIwNzk2Mjgx",
      "avatar_url": "https://avatars.githubusercontent.com/u/20796281?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/benjaminion",
      "html_url": "https://github.com/benjaminion",
      "followers_url": "https://api.github.com/users/benjaminion/followers",
      "following_url": "https://api.github.com/users/benjaminion/following{/other_user}",
      "gists_url": "https://api.github.com/users/benjaminion/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/benjaminion/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/benjaminion/subscriptions",
      "organizations_url": "https://api.github.com/users/benjaminion/orgs",
      "repos_url": "https://api.github.com/users/benjaminion/repos",
      "events_url": "https://api.github.com/users/benjaminion/events{/privacy}",
      "received_events_url": "https://api.github.com/users/benjaminion/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-05-24T10:47:37Z",
    "updated_at": "2021-05-24T10:47:37Z",
    "author_association": "CONTRIBUTOR",
    "body": "Thank you for raising this.\r\n\r\nThe Mikuli implementation performs the [group membership](https://github.com/ConsenSys/teku/blob/master/bls/src/main/java/tech/pegasys/teku/bls/impl/mikuli/G1Point.java#L88) and [infinity](https://github.com/ConsenSys/teku/blob/master/bls/src/main/java/tech/pegasys/teku/bls/impl/mikuli/G1Point.java#L84) checks on deserialisation of the public key. This is fine within the context of the Teku client, as all potentially hostile public keys are received in serialised form. The Mikuli approach differs from the current Blst implementation, which used to rely on checking group membership at deserialisation but no longer does, due to a change in the Blst library.\r\n\r\nWe have been looking at modifying this to make the group membership checks consistent across implementations and cache the results, which would make this more obvious.\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/846957053/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/846983866",
    "html_url": "https://github.com/ConsenSys/teku/issues/4025#issuecomment-846983866",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/4025",
    "id": 846983866,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg0Njk4Mzg2Ng==",
    "user": {
      "login": "dnkolegov",
      "id": 6521369,
      "node_id": "MDQ6VXNlcjY1MjEzNjk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6521369?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dnkolegov",
      "html_url": "https://github.com/dnkolegov",
      "followers_url": "https://api.github.com/users/dnkolegov/followers",
      "following_url": "https://api.github.com/users/dnkolegov/following{/other_user}",
      "gists_url": "https://api.github.com/users/dnkolegov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dnkolegov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dnkolegov/subscriptions",
      "organizations_url": "https://api.github.com/users/dnkolegov/orgs",
      "repos_url": "https://api.github.com/users/dnkolegov/repos",
      "events_url": "https://api.github.com/users/dnkolegov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dnkolegov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-05-24T11:36:46Z",
    "updated_at": "2021-05-24T11:36:46Z",
    "author_association": "NONE",
    "body": "Thanks for the response.\r\n\r\nWhat about this BLST [check](https://github.com/ConsenSys/teku/blob/master/bls/src/main/java/tech/pegasys/teku/bls/impl/blst/BlstPublicKey.java#L84)?\r\nYou didn't mention that.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/846983866/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/847001132",
    "html_url": "https://github.com/ConsenSys/teku/issues/4025#issuecomment-847001132",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/4025",
    "id": 847001132,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg0NzAwMTEzMg==",
    "user": {
      "login": "benjaminion",
      "id": 20796281,
      "node_id": "MDQ6VXNlcjIwNzk2Mjgx",
      "avatar_url": "https://avatars.githubusercontent.com/u/20796281?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/benjaminion",
      "html_url": "https://github.com/benjaminion",
      "followers_url": "https://api.github.com/users/benjaminion/followers",
      "following_url": "https://api.github.com/users/benjaminion/following{/other_user}",
      "gists_url": "https://api.github.com/users/benjaminion/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/benjaminion/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/benjaminion/subscriptions",
      "organizations_url": "https://api.github.com/users/benjaminion/orgs",
      "repos_url": "https://api.github.com/users/benjaminion/repos",
      "events_url": "https://api.github.com/users/benjaminion/events{/privacy}",
      "received_events_url": "https://api.github.com/users/benjaminion/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-05-24T12:12:29Z",
    "updated_at": "2021-05-24T12:16:13Z",
    "author_association": "CONTRIBUTOR",
    "body": "To summarise everything:\r\n\r\n### Mikuli\r\n\r\nGroup membership and infinity test are always performed during deserialisation, so we can't have an invalid key in the system. These tests are _not_ repeated when the public keys are used (aggregation or verification). The same is true for G2 signature points.\r\n\r\n### Blst\r\n\r\nGroup membership tests are _not_ performed during deserialisation (with an exception for the special case  [0, +/-2]) during normal control flow. These checks are performed in the Blst library when the public keys are used (aggregation or verification). The same is true for signatures.\r\n\r\nThe `BlstPublicKey.forceValidation()` method you highlight is not actually used in most cases. It allows for group membership to be checked during deserialisation when desired, outside the normal control flow (e.g. while reading validator key files locally or dealing with slashing protection files). It's a no-op for Mikuli since group membership is always checked during deserialisation.\r\n\r\n### Future\r\n\r\nAt some point soon we plan to make these two approaches consistent, and cache group membership so that we can be sure that the test is only ever done once per public key, and only for public keys that actually get used.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/847001132/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/847072552",
    "html_url": "https://github.com/ConsenSys/teku/issues/4025#issuecomment-847072552",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/4025",
    "id": 847072552,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg0NzA3MjU1Mg==",
    "user": {
      "login": "dnkolegov",
      "id": 6521369,
      "node_id": "MDQ6VXNlcjY1MjEzNjk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6521369?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dnkolegov",
      "html_url": "https://github.com/dnkolegov",
      "followers_url": "https://api.github.com/users/dnkolegov/followers",
      "following_url": "https://api.github.com/users/dnkolegov/following{/other_user}",
      "gists_url": "https://api.github.com/users/dnkolegov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dnkolegov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dnkolegov/subscriptions",
      "organizations_url": "https://api.github.com/users/dnkolegov/orgs",
      "repos_url": "https://api.github.com/users/dnkolegov/repos",
      "events_url": "https://api.github.com/users/dnkolegov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dnkolegov/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-05-24T14:15:13Z",
    "updated_at": "2021-05-24T14:15:13Z",
    "author_association": "NONE",
    "body": "Thank you.\r\n\r\nIt should be noted that BLST developers suggest that \"The expectation is the application will deserialize/uncompress an object and call KeyValidate if that object is a previously unvalidated public key. The deserialize interface is agnostic to the\r\nhigher level object type.\" Source: [link](https://research.nccgroup.com/wp-content/uploads/2021/01/NCC_Group_EthereumFoundation_ETHF002_Report_2021-01-20_v1.0.pdf), page 37.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/847072552/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/847088944",
    "html_url": "https://github.com/ConsenSys/teku/issues/4025#issuecomment-847088944",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/4025",
    "id": 847088944,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg0NzA4ODk0NA==",
    "user": {
      "login": "benjaminion",
      "id": 20796281,
      "node_id": "MDQ6VXNlcjIwNzk2Mjgx",
      "avatar_url": "https://avatars.githubusercontent.com/u/20796281?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/benjaminion",
      "html_url": "https://github.com/benjaminion",
      "followers_url": "https://api.github.com/users/benjaminion/followers",
      "following_url": "https://api.github.com/users/benjaminion/following{/other_user}",
      "gists_url": "https://api.github.com/users/benjaminion/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/benjaminion/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/benjaminion/subscriptions",
      "organizations_url": "https://api.github.com/users/benjaminion/orgs",
      "repos_url": "https://api.github.com/users/benjaminion/repos",
      "events_url": "https://api.github.com/users/benjaminion/events{/privacy}",
      "received_events_url": "https://api.github.com/users/benjaminion/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-05-24T14:41:41Z",
    "updated_at": "2021-05-24T14:41:41Z",
    "author_association": "CONTRIBUTOR",
    "body": "Noted. However the `KeyValidate` method is not available in the Java (or C) bindings of _blst_.\r\n\r\nInstead, the Java bindings apply the group check explicitly at the points where public keys are used. For example [here](https://github.com/supranational/blst/blob/master/bindings/blst.hpp#L163).\r\n\r\nBlst's handling of the point at infinity has changed over time, so we test for it explicitly in the application for consistency. For example [here](https://github.com/ConsenSys/teku/blob/master/bls/src/main/java/tech/pegasys/teku/bls/impl/blst/BlstSignature.java#L123).\r\n\r\nAs mentioned, we are planning to make things more consistent across the two implementations at some point.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/847088944/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/847792402",
    "html_url": "https://github.com/ConsenSys/teku/issues/4025#issuecomment-847792402",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/4025",
    "id": 847792402,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg0Nzc5MjQwMg==",
    "user": {
      "login": "benjaminion",
      "id": 20796281,
      "node_id": "MDQ6VXNlcjIwNzk2Mjgx",
      "avatar_url": "https://avatars.githubusercontent.com/u/20796281?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/benjaminion",
      "html_url": "https://github.com/benjaminion",
      "followers_url": "https://api.github.com/users/benjaminion/followers",
      "following_url": "https://api.github.com/users/benjaminion/following{/other_user}",
      "gists_url": "https://api.github.com/users/benjaminion/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/benjaminion/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/benjaminion/subscriptions",
      "organizations_url": "https://api.github.com/users/benjaminion/orgs",
      "repos_url": "https://api.github.com/users/benjaminion/repos",
      "events_url": "https://api.github.com/users/benjaminion/events{/privacy}",
      "received_events_url": "https://api.github.com/users/benjaminion/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-05-25T11:33:11Z",
    "updated_at": "2021-05-25T11:33:11Z",
    "author_association": "CONTRIBUTOR",
    "body": "Closing for now as I believe that Teku is correctly checking for the point at infinity and for group membership, even if not in the most obvious or optimal way.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/847792402/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
