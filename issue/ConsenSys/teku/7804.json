{
  "url": "https://api.github.com/repos/Consensys/teku/issues/7804",
  "repository_url": "https://api.github.com/repos/Consensys/teku",
  "labels_url": "https://api.github.com/repos/Consensys/teku/issues/7804/labels{/name}",
  "comments_url": "https://api.github.com/repos/Consensys/teku/issues/7804/comments",
  "events_url": "https://api.github.com/repos/Consensys/teku/issues/7804/events",
  "html_url": "https://github.com/Consensys/teku/issues/7804",
  "id": 2032117410,
  "node_id": "I_kwDOCM9I9M55H6ai",
  "number": 7804,
  "title": "fork choice spec test seems not fully handling future attestation",
  "user": {
    "login": "hcnam",
    "id": 43805697,
    "node_id": "MDQ6VXNlcjQzODA1Njk3",
    "avatar_url": "https://avatars.githubusercontent.com/u/43805697?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/hcnam",
    "html_url": "https://github.com/hcnam",
    "followers_url": "https://api.github.com/users/hcnam/followers",
    "following_url": "https://api.github.com/users/hcnam/following{/other_user}",
    "gists_url": "https://api.github.com/users/hcnam/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/hcnam/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/hcnam/subscriptions",
    "organizations_url": "https://api.github.com/users/hcnam/orgs",
    "repos_url": "https://api.github.com/users/hcnam/repos",
    "events_url": "https://api.github.com/users/hcnam/events{/privacy}",
    "received_events_url": "https://api.github.com/users/hcnam/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 0,
  "created_at": "2023-12-08T07:51:04Z",
  "updated_at": "2023-12-08T07:51:04Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "<!-- \r\nBy filing an Issue, you are expected to comply with the Code of Conduct, \r\nincluding treating everyone with respect:\r\nhttps://github.com/Consensys/teku/blob/master/CODE-OF-CONDUCT.md\r\n\r\nNot all sections will apply to all issue types.\r\n-->\r\n\r\n### Description\r\nThis issue stems from insufficient future attestation handling in Teku spec test. In Teku, it has an attestation scheduling so the future slot attestations can be deferred until their slot in the past. However, Teku's spec test environment does not fully support future attestations, i.e., it cannot defer attestations more than one slot. Teku assigns one of the two states for incoming future slot attestation. The first state is `DEFER_FOR_FORK_CHOICE`, indicating that the attestation should be handled in the next slot. The other state is `SAVED_FOR_FUTURE`, which is used to save attestations that should be handled after several slots in the future. Teku's fork-choice testing environment supports `DEFER_FOR_FORK_CHOICE` state attestations but not `SAVED_FOR_FUTURE` state attestations. This results in test cases with attestations attesting the future after the one slot failing in Teku tester. See scenario below.\r\n\r\n### Steps to Reproduce\r\nScenario\r\nAssumption: No attestation except Attestation X and Y, or B and C has same vote.\r\nSteps:\r\n```\r\n N      N+1     N+2     N+3  \r\n[A]  –  [B]  –  [ ]  –  [ ] \r\n     \\  [ ]  –  [C]  –  [ ] \r\n \r\nSlot N   : Block A\r\nSlot N+1 : Block B (parent: A)\r\nSlot N+2 : Block C (parent also A)\r\n           Receive Attestation_0 from validator X of slot N+4 (attesting block B)\r\nSlot N+4 : Check head\r\n```\r\nExpect: head is B due to Teku can handle deferred attestation (later ignored)\r\nResult: Teku decide with tie-break rule\r\n\r\nReference: [deferredAttestations](https://github.com/Consensys/teku/blob/8b618b03842ffe866769d9a5192746018290ed18/ethereum/statetransition/src/main/java/tech/pegasys/teku/statetransition/forkchoice/ForkChoice.java#L211C21-L211C21), [futureAttestations](https://github.com/Consensys/teku/blob/e89031eca692b4a4b4df84fa4ae32bae07b491d8/ethereum/statetransition/src/main/java/tech/pegasys/teku/statetransition/attestation/AttestationManager.java#L247C19-L247C37)\r\n\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/Consensys/teku/issues/7804/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/Consensys/teku/issues/7804/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[

]
