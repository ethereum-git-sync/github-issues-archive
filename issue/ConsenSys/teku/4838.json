{
  "url": "https://api.github.com/repos/ConsenSys/teku/issues/4838",
  "repository_url": "https://api.github.com/repos/ConsenSys/teku",
  "labels_url": "https://api.github.com/repos/ConsenSys/teku/issues/4838/labels{/name}",
  "comments_url": "https://api.github.com/repos/ConsenSys/teku/issues/4838/comments",
  "events_url": "https://api.github.com/repos/ConsenSys/teku/issues/4838/events",
  "html_url": "https://github.com/ConsenSys/teku/issues/4838",
  "id": 1094394511,
  "node_id": "I_kwDOCM9I9M5BOyKP",
  "number": 4838,
  "title": "Sync contribution not getting included and validator penalised frequently on a small custom network",
  "user": {
    "login": "jimmygchen",
    "id": 742762,
    "node_id": "MDQ6VXNlcjc0Mjc2Mg==",
    "avatar_url": "https://avatars.githubusercontent.com/u/742762?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jimmygchen",
    "html_url": "https://github.com/jimmygchen",
    "followers_url": "https://api.github.com/users/jimmygchen/followers",
    "following_url": "https://api.github.com/users/jimmygchen/following{/other_user}",
    "gists_url": "https://api.github.com/users/jimmygchen/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jimmygchen/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jimmygchen/subscriptions",
    "organizations_url": "https://api.github.com/users/jimmygchen/orgs",
    "repos_url": "https://api.github.com/users/jimmygchen/repos",
    "events_url": "https://api.github.com/users/jimmygchen/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jimmygchen/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2022-01-05T14:12:32Z",
  "updated_at": "2022-01-05T17:40:27Z",
  "closed_at": "2022-01-05T17:40:26Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "### Description\r\n\r\nI am running Teku v22.1.0 (Beacon + VC) on a small custom network and noticed that the validator get penalised quite frequently (reduced balance every few seconds). \r\n\r\nI had the same issue in v21.12.2 and was seeing the following error frequently\r\n> 2022-01-05 03:32:27.017 ERROR - Validator   *** Failed to produce sync_contribution  Slot: 7276 Validator: 8e5ecfc\r\njava.lang.IllegalArgumentException: Invalid contribution and proofs: ;Rejecting proof with signature 0xb1bd2a1641ec276785365ca53115a275967dc4f3313ea2c74e504f5e8450b792004faada3529e5ea62fe95f7681937e7090b01670e61d70914d34145fcdd50aadd33c10e92b8e36c9f3ecf159465b198da583be3137fe2f81a4676a84d79997a because batch signature check failed\r\n\r\n@benjaminion mentioned that it may be related to this: https://github.com/ConsenSys/teku/pull/4807\r\n\r\nAfter upgrading to v22.1.0, I'm no longer getting the sync contribution error but the performance summary indicates poor sync committee performance:\r\n\r\n> teku_node_1 | 2022-01-05 11:36:38.347 INFO - Attestation performance: epoch 147, expected 1, produced 1, included 1 (100%), distance 8 / 8.00 / 8, correct target 1 (100%), correct head 1 (100%)\r\nteku_node_1 | 2022-01-05 11:36:38.348 INFO - Block performance: epoch 148, expected 6, produced 6, included 6 (100%)\r\nteku_node_1 | 2022-01-05 11:36:38.349 INFO - Sync committee performance: epoch 148, expected 16384, produced 16384, correct 16384, included 640 (4%)\r\n\r\nCould someone please tell me what are the possible causes of low rate of sync contribution inclusion (4%)? I am also able to reproduce this locally on a single node network in docker. \r\n\r\ni noticed that there are 512 validators in the sync committee list, and lots of duplicate on my small network when I curl the API\r\n> curl -s http://localhost:5051/eth/v1/beacon/states/head/sync_committees\r\n\r\nI wonder if this is causing the failed sync contribution, I will try reducing the SYNC_COMMITTEE_SIZE locally to see if it resolves the issue.\r\n\r\nMany thanks!\r\n\r\n### Steps to Reproduce (Bug)\r\n1. Run Teku (consensys/teku:22.1.0) with the chain config included at the bottom of the description \r\n2. Make deposit on an eth1 network to activate the beacon chain\r\n3. Once genesis is generated, this error appears in logs quite frequently\r\n\r\n**Expected behavior:**\r\n* Produced sync contributions should be included the majority of the time \r\n \r\n**Actual behavior:** [What actually happens]\r\n* Produced sync contributions not included most of the time (4% included), and validator balance is getting penalised\r\n\r\n**Frequency:** [What percentage of the time does it occur?]\r\nconstantly, included rate range from (4% to 7%)\r\n\r\n### Versions (Add all that apply)\r\n* Software version: v22.1.0\r\n* Java version: openjdk 17.0.1 2021-10-19 \r\n* OS Name & Version: MacOS 12.0.1\r\n* Kernel Version: Darwin 21.1.0 Darwin Kernel Version 21.1.0: Wed Oct 13 17:33:23 PDT 2021; root:xnu-8019.41.5~1/RELEASE_X86_64 x86_64\r\n* Docker Version: 20.10.11\r\n\r\n### Additional Information\r\nChain config YAML:\r\n```\r\n# Extends the mainnet preset\r\nPRESET_BASE: 'mainnet'\r\n\r\nCONFIG_NAME: \"local-test\"\r\n\r\n# Genesis\r\n# ---------------------------------------------------------------\r\n# [customized]\r\nMIN_GENESIS_ACTIVE_VALIDATOR_COUNT: 1\r\n# 2021-11-18T17:32\r\nMIN_GENESIS_TIME: 1637256717\r\n# Same as prater for testing deposits using deposits CLI\r\nGENESIS_FORK_VERSION: 0x00001020\r\n# [customized] Faster to spin up testnets, but does not give validator reasonable warning time for genesis\r\nGENESIS_DELAY: 30\r\n\r\n\r\n# Forking\r\n# ---------------------------------------------------------------\r\n# Some forks are disabled for now:\r\n#  - These may be re-assigned to another fork-version later\r\n#  - Temporarily set to max uint64 value: 2**64 - 1\r\n\r\n# Altair\r\nALTAIR_FORK_VERSION: 0x00001020\r\nALTAIR_FORK_EPOCH: 0\r\n# Merge\r\nMERGE_FORK_VERSION: 0x02001020\r\nMERGE_FORK_EPOCH: 18446744073709551615\r\n# Sharding\r\nSHARDING_FORK_VERSION: 0x03001020\r\nSHARDING_FORK_EPOCH: 18446744073709551615\r\n\r\n# Merge Transition\r\n# ---------------------------------------------------------------\r\n# TBD, 2**256-2**10 is a placeholder\r\nTERMINAL_TOTAL_DIFFICULTY: 115792089237316195423570985008687907853269984665640564039457584007913129638912\r\n# 0\r\nTERMINAL_BLOCK_HASH: 0x0000000000000000000000000000000000000000000000000000000000000000\r\n# FAR_FUTURE_EPOCH\r\nTERMINAL_BLOCK_HASH_ACTIVATION_EPOCH: 18446744073709551615\r\n\r\n# Time parameters\r\n# ---------------------------------------------------------------\r\n# [customized] Faster for testing purposes\r\nSECONDS_PER_SLOT: 6\r\n# 14 (estimate from Eth1 mainnet)\r\nSECONDS_PER_ETH1_BLOCK: 14\r\n# 2**8 (= 256) epochs ~27 hours\r\nMIN_VALIDATOR_WITHDRAWABILITY_DELAY: 256\r\n# [customized] higher frequency of committee turnover and faster time to acceptable voluntary exit\r\nSHARD_COMMITTEE_PERIOD: 64\r\n# [customized] process deposits more quickly, but insecure\r\nETH1_FOLLOW_DISTANCE: 16\r\n\r\n\r\n# Validator cycle\r\n# ---------------------------------------------------------------\r\n# 2**2 (= 4)\r\nINACTIVITY_SCORE_BIAS: 4\r\n# 2**4 (= 16)\r\nINACTIVITY_SCORE_RECOVERY_RATE: 16\r\n# 2**4 * 10**9 (= 16,000,000,000) Gwei\r\nEJECTION_BALANCE: 16000000000\r\n# 2**2 (= 4)\r\nMIN_PER_EPOCH_CHURN_LIMIT: 4\r\n# 2**16 (= 65,536)\r\nCHURN_LIMIT_QUOTIENT: 32\r\n\r\n\r\n# Deposit contract\r\n# ---------------------------------------------------------------\r\n# Ethereum Goerli testnet\r\nDEPOSIT_CHAIN_ID: 5\r\nDEPOSIT_NETWORK_ID: 5\r\n# Prater test deposit contract on Goerli Testnet\r\nDEPOSIT_CONTRACT_ADDRESS: 0x42699A7612A82f1d9C36148af9C77354759b210b\r\n```",
  "closed_by": {
    "login": "jimmygchen",
    "id": 742762,
    "node_id": "MDQ6VXNlcjc0Mjc2Mg==",
    "avatar_url": "https://avatars.githubusercontent.com/u/742762?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jimmygchen",
    "html_url": "https://github.com/jimmygchen",
    "followers_url": "https://api.github.com/users/jimmygchen/followers",
    "following_url": "https://api.github.com/users/jimmygchen/following{/other_user}",
    "gists_url": "https://api.github.com/users/jimmygchen/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jimmygchen/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jimmygchen/subscriptions",
    "organizations_url": "https://api.github.com/users/jimmygchen/orgs",
    "repos_url": "https://api.github.com/users/jimmygchen/repos",
    "events_url": "https://api.github.com/users/jimmygchen/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jimmygchen/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/4838/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ConsenSys/teku/issues/4838/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1005731078",
    "html_url": "https://github.com/ConsenSys/teku/issues/4838#issuecomment-1005731078",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/4838",
    "id": 1005731078,
    "node_id": "IC_kwDOCM9I9M478j0G",
    "user": {
      "login": "jimmygchen",
      "id": 742762,
      "node_id": "MDQ6VXNlcjc0Mjc2Mg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/742762?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jimmygchen",
      "html_url": "https://github.com/jimmygchen",
      "followers_url": "https://api.github.com/users/jimmygchen/followers",
      "following_url": "https://api.github.com/users/jimmygchen/following{/other_user}",
      "gists_url": "https://api.github.com/users/jimmygchen/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jimmygchen/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jimmygchen/subscriptions",
      "organizations_url": "https://api.github.com/users/jimmygchen/orgs",
      "repos_url": "https://api.github.com/users/jimmygchen/repos",
      "events_url": "https://api.github.com/users/jimmygchen/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jimmygchen/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-01-05T14:26:39Z",
    "updated_at": "2022-01-05T14:26:39Z",
    "author_association": "CONTRIBUTOR",
    "body": "The issue is probably with using the mainnet preset on a small network - perhaps the minimal preset is more suited for this. But I opted for mainnet earlier because I wanted to be able to run different clients on this network, but some doesn't support the minimal config without rebuilding the binary.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1005731078/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1005936402",
    "html_url": "https://github.com/ConsenSys/teku/issues/4838#issuecomment-1005936402",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/4838",
    "id": 1005936402,
    "node_id": "IC_kwDOCM9I9M479V8S",
    "user": {
      "login": "jimmygchen",
      "id": 742762,
      "node_id": "MDQ6VXNlcjc0Mjc2Mg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/742762?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jimmygchen",
      "html_url": "https://github.com/jimmygchen",
      "followers_url": "https://api.github.com/users/jimmygchen/followers",
      "following_url": "https://api.github.com/users/jimmygchen/following{/other_user}",
      "gists_url": "https://api.github.com/users/jimmygchen/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jimmygchen/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jimmygchen/subscriptions",
      "organizations_url": "https://api.github.com/users/jimmygchen/orgs",
      "repos_url": "https://api.github.com/users/jimmygchen/repos",
      "events_url": "https://api.github.com/users/jimmygchen/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jimmygchen/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-01-05T17:40:26Z",
    "updated_at": "2022-01-05T17:40:26Z",
    "author_association": "CONTRIBUTOR",
    "body": "Error is gone now using the 'swift' preset with a smaller sync committee size (32) - thanks @benjaminion !\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1005936402/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
