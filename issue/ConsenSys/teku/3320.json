{
  "url": "https://api.github.com/repos/ConsenSys/teku/issues/3320",
  "repository_url": "https://api.github.com/repos/ConsenSys/teku",
  "labels_url": "https://api.github.com/repos/ConsenSys/teku/issues/3320/labels{/name}",
  "comments_url": "https://api.github.com/repos/ConsenSys/teku/issues/3320/comments",
  "events_url": "https://api.github.com/repos/ConsenSys/teku/issues/3320/events",
  "html_url": "https://github.com/ConsenSys/teku/issues/3320",
  "id": 751506891,
  "node_id": "MDU6SXNzdWU3NTE1MDY4OTE=",
  "number": 3320,
  "title": "Optimization: RocksDbHotDao.addVotes consumes ~30% of long sync performance",
  "user": {
    "login": "Nashatyrev",
    "id": 8173857,
    "node_id": "MDQ6VXNlcjgxNzM4NTc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/8173857?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Nashatyrev",
    "html_url": "https://github.com/Nashatyrev",
    "followers_url": "https://api.github.com/users/Nashatyrev/followers",
    "following_url": "https://api.github.com/users/Nashatyrev/following{/other_user}",
    "gists_url": "https://api.github.com/users/Nashatyrev/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Nashatyrev/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Nashatyrev/subscriptions",
    "organizations_url": "https://api.github.com/users/Nashatyrev/orgs",
    "repos_url": "https://api.github.com/users/Nashatyrev/repos",
    "events_url": "https://api.github.com/users/Nashatyrev/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Nashatyrev/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1168202341,
      "node_id": "MDU6TGFiZWwxMTY4MjAyMzQx",
      "url": "https://api.github.com/repos/ConsenSys/teku/labels/blocked%20by%20research%20%F0%9F%91%A9%E2%80%8D%F0%9F%8F%AB",
      "name": "blocked by research üë©‚Äçüè´",
      "color": "039fc6",
      "default": false,
      "description": "This issue or pull request is blocked by incomplete spec"
    },
    {
      "id": 1271198478,
      "node_id": "MDU6TGFiZWwxMjcxMTk4NDc4",
      "url": "https://api.github.com/repos/ConsenSys/teku/labels/performance%20%F0%9F%9A%80",
      "name": "performance üöÄ",
      "color": "ffcce3",
      "default": false,
      "description": "Improves performance without changing functionality"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 8,
  "created_at": "2020-11-26T11:14:58Z",
  "updated_at": "2021-08-02T22:33:02Z",
  "closed_at": "2021-08-02T22:33:01Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "\r\n### Description\r\n\r\n![–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ](https://user-images.githubusercontent.com/8173857/100344347-b8dc4800-2ff1-11eb-8efb-a6e6921624fa.png)\r\n\r\nEvery individual vote is stored to DB which seems sub-optimal. Likely it would be more optimal to keep in-memory map and save/load it as a solid \r\n",
  "closed_by": {
    "login": "ajsutton",
    "id": 72675,
    "node_id": "MDQ6VXNlcjcyNjc1",
    "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ajsutton",
    "html_url": "https://github.com/ajsutton",
    "followers_url": "https://api.github.com/users/ajsutton/followers",
    "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
    "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
    "organizations_url": "https://api.github.com/users/ajsutton/orgs",
    "repos_url": "https://api.github.com/users/ajsutton/repos",
    "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ajsutton/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/3320/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ConsenSys/teku/issues/3320/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/752761338",
    "html_url": "https://github.com/ConsenSys/teku/issues/3320#issuecomment-752761338",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/3320",
    "id": 752761338,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc1Mjc2MTMzOA==",
    "user": {
      "login": "rolfyone",
      "id": 2967240,
      "node_id": "MDQ6VXNlcjI5NjcyNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2967240?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rolfyone",
      "html_url": "https://github.com/rolfyone",
      "followers_url": "https://api.github.com/users/rolfyone/followers",
      "following_url": "https://api.github.com/users/rolfyone/following{/other_user}",
      "gists_url": "https://api.github.com/users/rolfyone/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rolfyone/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rolfyone/subscriptions",
      "organizations_url": "https://api.github.com/users/rolfyone/orgs",
      "repos_url": "https://api.github.com/users/rolfyone/repos",
      "events_url": "https://api.github.com/users/rolfyone/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rolfyone/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-12-30T21:17:44Z",
    "updated_at": "2020-12-30T21:17:44Z",
    "author_association": "CONTRIBUTOR",
    "body": "PR #3427 takes a chunk out of the numbers, but its an incremental improvement - doesn't change the overall design just puts in a custom serializer so that none of the decision points in the generic serializer are required.\n\nThe improvement is fairly decent for both deserialize and serialize, added a benchmark test and outputs in the PR mentioned above. I won't close this ticket, but it's worth noting that there's been reasonable improvements.\n\nOver long sync, I was previously seeing addVotes as roughly 54% of the 'doUpdate' time, and after the change it's down to about 39%.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/752761338/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/754964664",
    "html_url": "https://github.com/ConsenSys/teku/issues/3320#issuecomment-754964664",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/3320",
    "id": 754964664,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc1NDk2NDY2NA==",
    "user": {
      "login": "cemozerr",
      "id": 16581242,
      "node_id": "MDQ6VXNlcjE2NTgxMjQy",
      "avatar_url": "https://avatars.githubusercontent.com/u/16581242?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cemozerr",
      "html_url": "https://github.com/cemozerr",
      "followers_url": "https://api.github.com/users/cemozerr/followers",
      "following_url": "https://api.github.com/users/cemozerr/following{/other_user}",
      "gists_url": "https://api.github.com/users/cemozerr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cemozerr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cemozerr/subscriptions",
      "organizations_url": "https://api.github.com/users/cemozerr/orgs",
      "repos_url": "https://api.github.com/users/cemozerr/repos",
      "events_url": "https://api.github.com/users/cemozerr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cemozerr/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-01-05T23:32:02Z",
    "updated_at": "2021-01-06T01:17:11Z",
    "author_association": "CONTRIBUTOR",
    "body": "I synced the latest master to mainnet for 10 minutes from the genesis block and used the Java Flight Recorder to generate the flame graph below and `addVotes` function was nowhere visible. \n\nThis might not be an issue anymore, but the difference in our results are so stark that @rolfyone it might be a good idea for you to re-run the profiler \n\n![Screen Shot 2021-01-05 at 6.27.39 PM.png](https://images.zenhubusercontent.com/5e8a67e476d894cf9836956c/6f523099-4cdf-462c-9c1f-ea14e395dc75)",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/754964664/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/758344456",
    "html_url": "https://github.com/ConsenSys/teku/issues/3320#issuecomment-758344456",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/3320",
    "id": 758344456,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc1ODM0NDQ1Ng==",
    "user": {
      "login": "rolfyone",
      "id": 2967240,
      "node_id": "MDQ6VXNlcjI5NjcyNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2967240?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rolfyone",
      "html_url": "https://github.com/rolfyone",
      "followers_url": "https://api.github.com/users/rolfyone/followers",
      "following_url": "https://api.github.com/users/rolfyone/following{/other_user}",
      "gists_url": "https://api.github.com/users/rolfyone/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rolfyone/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rolfyone/subscriptions",
      "organizations_url": "https://api.github.com/users/rolfyone/orgs",
      "repos_url": "https://api.github.com/users/rolfyone/repos",
      "events_url": "https://api.github.com/users/rolfyone/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rolfyone/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-01-12T02:03:29Z",
    "updated_at": "2021-01-12T02:03:29Z",
    "author_association": "CONTRIBUTOR",
    "body": "![Screen Shot 2021-01-12 at 11.55.53 am.png](https://images.zenhubusercontent.com/5e45dddb5e32e495879572b3/a3632583-b24d-42a9-8bb0-4d72db663eb3)\n\nso it's reporting 36% of the update time now during a long sync of pyrmont...",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/758344456/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/805663375",
    "html_url": "https://github.com/ConsenSys/teku/issues/3320#issuecomment-805663375",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/3320",
    "id": 805663375,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwNTY2MzM3NQ==",
    "user": {
      "login": "Nashatyrev",
      "id": 8173857,
      "node_id": "MDQ6VXNlcjgxNzM4NTc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8173857?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Nashatyrev",
      "html_url": "https://github.com/Nashatyrev",
      "followers_url": "https://api.github.com/users/Nashatyrev/followers",
      "following_url": "https://api.github.com/users/Nashatyrev/following{/other_user}",
      "gists_url": "https://api.github.com/users/Nashatyrev/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Nashatyrev/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Nashatyrev/subscriptions",
      "organizations_url": "https://api.github.com/users/Nashatyrev/orgs",
      "repos_url": "https://api.github.com/users/Nashatyrev/repos",
      "events_url": "https://api.github.com/users/Nashatyrev/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Nashatyrev/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-24T09:59:57Z",
    "updated_at": "2021-03-24T09:59:57Z",
    "author_association": "CONTRIBUTOR",
    "body": "During long sync on `Prater` `storeVotes` takes roughly 40% of overall sync process (excluding BLS verification in `ForkJoinPool`):\r\n![–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ](https://user-images.githubusercontent.com/8173857/112291004-cdc7a000-8ca0-11eb-8d2d-d9b0668fe1ed.png)\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/805663375/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/805910461",
    "html_url": "https://github.com/ConsenSys/teku/issues/3320#issuecomment-805910461",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/3320",
    "id": 805910461,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwNTkxMDQ2MQ==",
    "user": {
      "login": "Nashatyrev",
      "id": 8173857,
      "node_id": "MDQ6VXNlcjgxNzM4NTc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8173857?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Nashatyrev",
      "html_url": "https://github.com/Nashatyrev",
      "followers_url": "https://api.github.com/users/Nashatyrev/followers",
      "following_url": "https://api.github.com/users/Nashatyrev/following{/other_user}",
      "gists_url": "https://api.github.com/users/Nashatyrev/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Nashatyrev/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Nashatyrev/subscriptions",
      "organizations_url": "https://api.github.com/users/Nashatyrev/orgs",
      "repos_url": "https://api.github.com/users/Nashatyrev/repos",
      "events_url": "https://api.github.com/users/Nashatyrev/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Nashatyrev/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-24T15:14:12Z",
    "updated_at": "2021-03-24T15:14:12Z",
    "author_association": "CONTRIBUTOR",
    "body": "Potential idea to optimize this: \r\n- keep the full `Map` in memory\r\n- sequentially write updates in a single serialized `Map`. I bet it should be much faster than writing individual entries\r\n- prune old updates \r\n- On start incrementally restore the memory map\r\n\r\nDo you think this makes sense?",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/805910461/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/805944000",
    "html_url": "https://github.com/ConsenSys/teku/issues/3320#issuecomment-805944000",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/3320",
    "id": 805944000,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwNTk0NDAwMA==",
    "user": {
      "login": "Nashatyrev",
      "id": 8173857,
      "node_id": "MDQ6VXNlcjgxNzM4NTc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8173857?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Nashatyrev",
      "html_url": "https://github.com/Nashatyrev",
      "followers_url": "https://api.github.com/users/Nashatyrev/followers",
      "following_url": "https://api.github.com/users/Nashatyrev/following{/other_user}",
      "gists_url": "https://api.github.com/users/Nashatyrev/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Nashatyrev/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Nashatyrev/subscriptions",
      "organizations_url": "https://api.github.com/users/Nashatyrev/orgs",
      "repos_url": "https://api.github.com/users/Nashatyrev/repos",
      "events_url": "https://api.github.com/users/Nashatyrev/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Nashatyrev/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-24T15:54:09Z",
    "updated_at": "2021-03-24T15:54:09Z",
    "author_association": "CONTRIBUTOR",
    "body": "Also do we really need updating votes during long sync until some distance behind head slot? ",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/805944000/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/806217669",
    "html_url": "https://github.com/ConsenSys/teku/issues/3320#issuecomment-806217669",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/3320",
    "id": 806217669,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwNjIxNzY2OQ==",
    "user": {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-24T22:10:05Z",
    "updated_at": "2021-03-24T22:10:05Z",
    "author_association": "CONTRIBUTOR",
    "body": "Actually when syncing finalized blocks we could skip processing the attestations entirely for fork choice (no vote or protoarray updates).  The block processing would still process them to do the justify/finalize updates but we could skip all of fork choice.\r\n\r\nThe catch is that currently the block import process doesn't know it's importing what should be a finalized block because from it's point of view it isn't yet finalized.  We'd have to pass a hint down from the sync system.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/806217669/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/891377913",
    "html_url": "https://github.com/ConsenSys/teku/issues/3320#issuecomment-891377913",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/3320",
    "id": 891377913,
    "node_id": "IC_kwDOCM9I9M41IVj5",
    "user": {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-08-02T22:33:01Z",
    "updated_at": "2021-08-02T22:33:01Z",
    "author_association": "CONTRIBUTOR",
    "body": "Going to close this one out as we're not using RocksDB anymore and so much has changed in terms of performance profile that while changing the way we store votes may still be a worthwhile optimisation we should ensure we're guided by up to date profiling in deciding what to focus on first.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/891377913/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
