{
  "url": "https://api.github.com/repos/Consensys/teku/issues/7673",
  "repository_url": "https://api.github.com/repos/Consensys/teku",
  "labels_url": "https://api.github.com/repos/Consensys/teku/issues/7673/labels{/name}",
  "comments_url": "https://api.github.com/repos/Consensys/teku/issues/7673/comments",
  "events_url": "https://api.github.com/repos/Consensys/teku/issues/7673/events",
  "html_url": "https://github.com/Consensys/teku/issues/7673",
  "id": 1981363546,
  "node_id": "I_kwDOCM9I9M52GTVa",
  "number": 7673,
  "title": "Teku rest api timeouts when requesting validator state",
  "user": {
    "login": "mortimr",
    "id": 17824082,
    "node_id": "MDQ6VXNlcjE3ODI0MDgy",
    "avatar_url": "https://avatars.githubusercontent.com/u/17824082?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mortimr",
    "html_url": "https://github.com/mortimr",
    "followers_url": "https://api.github.com/users/mortimr/followers",
    "following_url": "https://api.github.com/users/mortimr/following{/other_user}",
    "gists_url": "https://api.github.com/users/mortimr/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mortimr/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mortimr/subscriptions",
    "organizations_url": "https://api.github.com/users/mortimr/orgs",
    "repos_url": "https://api.github.com/users/mortimr/repos",
    "events_url": "https://api.github.com/users/mortimr/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mortimr/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2023-11-07T13:27:18Z",
  "updated_at": "2023-11-22T06:38:00Z",
  "closed_at": "2023-11-22T06:37:58Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Description\r\nCurrently calling the `/eth/v1/beacon/states/${SLOT}/validators` endpoint on the rest api, getting either a closed connection or a 404 for some slots that are just a few epochs in the past.\r\n\r\nPerformed when head slot was `6904629`\r\n\r\n```\r\ncurl http://localhost:5051/eth/v1/beacon/states/6904550/validators\r\n\r\ncurl: (56) Recv failure: Connection reset by peer\r\n```\r\n\r\n```\r\ncurl http://localhost:5051/eth/v1/beacon/states/6904500/validators\r\n\r\ncurl: (56) Recv failure: Connection reset by peer\r\n```\r\n\r\neven `head` will sometimes fail.\r\n\r\nIs there a configuration (apart from archive) that I might be missing ?\r\n",
  "closed_by": {
    "login": "rolfyone",
    "id": 2967240,
    "node_id": "MDQ6VXNlcjI5NjcyNDA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2967240?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/rolfyone",
    "html_url": "https://github.com/rolfyone",
    "followers_url": "https://api.github.com/users/rolfyone/followers",
    "following_url": "https://api.github.com/users/rolfyone/following{/other_user}",
    "gists_url": "https://api.github.com/users/rolfyone/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/rolfyone/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rolfyone/subscriptions",
    "organizations_url": "https://api.github.com/users/rolfyone/orgs",
    "repos_url": "https://api.github.com/users/rolfyone/repos",
    "events_url": "https://api.github.com/users/rolfyone/events{/privacy}",
    "received_events_url": "https://api.github.com/users/rolfyone/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/Consensys/teku/issues/7673/reactions",
    "total_count": 1,
    "+1": 1,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/Consensys/teku/issues/7673/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/Consensys/teku/issues/comments/1807310370",
    "html_url": "https://github.com/Consensys/teku/issues/7673#issuecomment-1807310370",
    "issue_url": "https://api.github.com/repos/Consensys/teku/issues/7673",
    "id": 1807310370,
    "node_id": "IC_kwDOCM9I9M5ruV4i",
    "user": {
      "login": "rolfyone",
      "id": 2967240,
      "node_id": "MDQ6VXNlcjI5NjcyNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2967240?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rolfyone",
      "html_url": "https://github.com/rolfyone",
      "followers_url": "https://api.github.com/users/rolfyone/followers",
      "following_url": "https://api.github.com/users/rolfyone/following{/other_user}",
      "gists_url": "https://api.github.com/users/rolfyone/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rolfyone/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rolfyone/subscriptions",
      "organizations_url": "https://api.github.com/users/rolfyone/orgs",
      "repos_url": "https://api.github.com/users/rolfyone/repos",
      "events_url": "https://api.github.com/users/rolfyone/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rolfyone/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-11-13T00:42:24Z",
    "updated_at": "2023-11-13T00:43:52Z",
    "author_association": "CONTRIBUTOR",
    "body": "Hey thanks for raising this. A couple of initial comments and questions...\n\nI'm assuming you're not in archive mode, given the 404 reference. Basically if you're not in archive mode, anything before the finalized state will be a 404, because we don't have those state to build validator data from.\n\nSo if finalized is slot 3200, and you select 3199 for example, then you're going to receive a 404.\n\nRegarding timeout, you'll probably find a subsequent query with the same parameters will work, becuase by then it'll have rebuilt state so it can get down to business.  If you're doing this kind of query often, you could consider increasing the state cache (which will require more memory), using `--Xstore-state-cache-size` which has defaulted to 8 since about June.  If you increase this to around 96, you'll basically have all states in memory and never need to rebuild states for these queries.\n\nThe other thing that can definitely help is requesting only the validators which you need information on, as the list is very large now.\n\nIn terms of questions\n - what teku version are you using?\n - how much heap are you running with (-Xmx)\n - are you seeing 'Completed regeneration of state' messages while you're running these validator queries?\n - Am I correct in my assertion that you're not using archive mode? If you are using archive mode, are you querying states from earlier than when your database is storing? (before you initialised, its possible to rebuild states from earlier but its not default behavior)\n - what network are you running on? is it a validating node? (more because I won't ask you to test things on a validating node unless we really need to)\n\nHopefully this is a start...\n",
    "reactions": {
      "url": "https://api.github.com/repos/Consensys/teku/issues/comments/1807310370/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/Consensys/teku/issues/comments/1817986255",
    "html_url": "https://github.com/Consensys/teku/issues/7673#issuecomment-1817986255",
    "issue_url": "https://api.github.com/repos/Consensys/teku/issues/7673",
    "id": 1817986255,
    "node_id": "IC_kwDOCM9I9M5sXETP",
    "user": {
      "login": "rolfyone",
      "id": 2967240,
      "node_id": "MDQ6VXNlcjI5NjcyNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2967240?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rolfyone",
      "html_url": "https://github.com/rolfyone",
      "followers_url": "https://api.github.com/users/rolfyone/followers",
      "following_url": "https://api.github.com/users/rolfyone/following{/other_user}",
      "gists_url": "https://api.github.com/users/rolfyone/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rolfyone/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rolfyone/subscriptions",
      "organizations_url": "https://api.github.com/users/rolfyone/orgs",
      "repos_url": "https://api.github.com/users/rolfyone/repos",
      "events_url": "https://api.github.com/users/rolfyone/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rolfyone/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-11-19T21:41:14Z",
    "updated_at": "2023-11-19T21:41:14Z",
    "author_association": "CONTRIBUTOR",
    "body": "@mortimr did this help at all?",
    "reactions": {
      "url": "https://api.github.com/repos/Consensys/teku/issues/comments/1817986255/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/Consensys/teku/issues/comments/1822194677",
    "html_url": "https://github.com/Consensys/teku/issues/7673#issuecomment-1822194677",
    "issue_url": "https://api.github.com/repos/Consensys/teku/issues/7673",
    "id": 1822194677,
    "node_id": "IC_kwDOCM9I9M5snHv1",
    "user": {
      "login": "rolfyone",
      "id": 2967240,
      "node_id": "MDQ6VXNlcjI5NjcyNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2967240?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rolfyone",
      "html_url": "https://github.com/rolfyone",
      "followers_url": "https://api.github.com/users/rolfyone/followers",
      "following_url": "https://api.github.com/users/rolfyone/following{/other_user}",
      "gists_url": "https://api.github.com/users/rolfyone/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rolfyone/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rolfyone/subscriptions",
      "organizations_url": "https://api.github.com/users/rolfyone/orgs",
      "repos_url": "https://api.github.com/users/rolfyone/repos",
      "events_url": "https://api.github.com/users/rolfyone/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rolfyone/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-11-22T06:37:58Z",
    "updated_at": "2023-11-22T06:37:58Z",
    "author_association": "CONTRIBUTOR",
    "body": "Without further information, assuming that the information above has helped, feel free to re-open if there's more.",
    "reactions": {
      "url": "https://api.github.com/repos/Consensys/teku/issues/comments/1822194677/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
