{
  "url": "https://api.github.com/repos/ConsenSys/teku/issues/2860",
  "repository_url": "https://api.github.com/repos/ConsenSys/teku",
  "labels_url": "https://api.github.com/repos/ConsenSys/teku/issues/2860/labels{/name}",
  "comments_url": "https://api.github.com/repos/ConsenSys/teku/issues/2860/comments",
  "events_url": "https://api.github.com/repos/ConsenSys/teku/issues/2860/events",
  "html_url": "https://github.com/ConsenSys/teku/issues/2860",
  "id": 710087282,
  "node_id": "MDU6SXNzdWU3MTAwODcyODI=",
  "number": 2860,
  "title": "signing spikes",
  "user": {
    "login": "tzapu",
    "id": 2983312,
    "node_id": "MDQ6VXNlcjI5ODMzMTI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2983312?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tzapu",
    "html_url": "https://github.com/tzapu",
    "followers_url": "https://api.github.com/users/tzapu/followers",
    "following_url": "https://api.github.com/users/tzapu/following{/other_user}",
    "gists_url": "https://api.github.com/users/tzapu/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tzapu/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tzapu/subscriptions",
    "organizations_url": "https://api.github.com/users/tzapu/orgs",
    "repos_url": "https://api.github.com/users/tzapu/repos",
    "events_url": "https://api.github.com/users/tzapu/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tzapu/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1048919131,
      "node_id": "MDU6TGFiZWwxMDQ4OTE5MTMx",
      "url": "https://api.github.com/repos/ConsenSys/teku/labels/enhancement%20%F0%9F%95%B5%EF%B8%8F%E2%80%8D%E2%99%80%EF%B8%8F",
      "name": "enhancement üïµÔ∏è‚Äç‚ôÄÔ∏è",
      "color": "a2eeef",
      "default": false,
      "description": "New feature or request"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "rolfyone",
    "id": 2967240,
    "node_id": "MDQ6VXNlcjI5NjcyNDA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2967240?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/rolfyone",
    "html_url": "https://github.com/rolfyone",
    "followers_url": "https://api.github.com/users/rolfyone/followers",
    "following_url": "https://api.github.com/users/rolfyone/following{/other_user}",
    "gists_url": "https://api.github.com/users/rolfyone/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/rolfyone/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rolfyone/subscriptions",
    "organizations_url": "https://api.github.com/users/rolfyone/orgs",
    "repos_url": "https://api.github.com/users/rolfyone/repos",
    "events_url": "https://api.github.com/users/rolfyone/events{/privacy}",
    "received_events_url": "https://api.github.com/users/rolfyone/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "rolfyone",
      "id": 2967240,
      "node_id": "MDQ6VXNlcjI5NjcyNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2967240?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rolfyone",
      "html_url": "https://github.com/rolfyone",
      "followers_url": "https://api.github.com/users/rolfyone/followers",
      "following_url": "https://api.github.com/users/rolfyone/following{/other_user}",
      "gists_url": "https://api.github.com/users/rolfyone/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rolfyone/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rolfyone/subscriptions",
      "organizations_url": "https://api.github.com/users/rolfyone/orgs",
      "repos_url": "https://api.github.com/users/rolfyone/repos",
      "events_url": "https://api.github.com/users/rolfyone/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rolfyone/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2020-09-28T09:09:17Z",
  "updated_at": "2020-12-10T05:56:26Z",
  "closed_at": "2020-12-10T05:56:26Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "# Description\r\nNoticed there is a large spike of signings at the start of each epoch, I assume to find out which slot a validator needs to aggregate.\r\n\r\n![image (3)](https://user-images.githubusercontent.com/2983312/94412829-f43dd000-0182-11eb-86f6-8e7377e0740f.png)\r\n\r\n**Expected behavior:** [What you expect to happen]\r\nIt would be ideal if these signing requests could be spread over a lengthier amount of time, maybe only for nodes that know will be subscribed to all subnets. Not having spikes like that could potentially make or break the usage of hardware signers, which are not that great in the performance department (currently), on top of that, less network congestion at once (for remote signers) = less timeouts under heavier loads\r\n\r\n**Frequency:** [What percentage of the time does it occur?]\r\nevery epoch\r\n",
  "closed_by": {
    "login": "rolfyone",
    "id": 2967240,
    "node_id": "MDQ6VXNlcjI5NjcyNDA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2967240?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/rolfyone",
    "html_url": "https://github.com/rolfyone",
    "followers_url": "https://api.github.com/users/rolfyone/followers",
    "following_url": "https://api.github.com/users/rolfyone/following{/other_user}",
    "gists_url": "https://api.github.com/users/rolfyone/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/rolfyone/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rolfyone/subscriptions",
    "organizations_url": "https://api.github.com/users/rolfyone/orgs",
    "repos_url": "https://api.github.com/users/rolfyone/repos",
    "events_url": "https://api.github.com/users/rolfyone/events{/privacy}",
    "received_events_url": "https://api.github.com/users/rolfyone/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/2860/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ConsenSys/teku/issues/2860/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/704206211",
    "html_url": "https://github.com/ConsenSys/teku/issues/2860#issuecomment-704206211",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/2860",
    "id": 704206211,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcwNDIwNjIxMQ==",
    "user": {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-10-06T11:28:47Z",
    "updated_at": "2020-10-06T11:28:47Z",
    "author_association": "CONTRIBUTOR",
    "body": "So my original idea to smooth out these spikes was to sign the slot number an epoch ahead of when we can calculate duties, but that doesn't actually work out because we don't yet know which slot each validator will be assigned from the epoch so instead of signing one slot number per validator we'd have to sign every slot number in the epoch with every validator (32x more signatures).  While we'd spread them out, 32x more work is probably not a good trade off.\n\nSo I can see two options that would work:\n1. Assume we want to subscribe to the attestation subnet we'll aggregate 1 epoch ahead, which is the minimum we currently have.  Instead of performing all signatures to determine if we're aggregating as soon as duties are calculated (strart of epoch) we only sign the duties for the first slot, then each slot we do the signing to check the aggregators one epoch ahead. So slot 32 we check which validators aggregate slot 64, slot 33 we check which validators aggregate slot 65 etc.  This is the same number of signatures, smoothed out with peaks 32x lower, but still spiking each slot.\n\n2. Batch the validators into groups based on the epoch's they attest similar to above, but instead of waiting for each slot to progress, check the first batch and once it's complete, immediately check the next etc. This doesn't smooth out the signing as much but still limits the rate at which signing occurs so there's only ever one slots worth of validators in-flight at a time.\n\nWith the current setup if you had `n` validators, at the start of each epoch you'd get a spike of `n` signing requests.\nWith option 1 at the start of each slot you'd get a spike of `n / 32`\nWith option 2 at the start of the epoch you'd get 32 spikes of `n / 32` signing requests one after the other.  But we could also have a cap on the number of signing requests put into each batch so reduce the size of the spike arbitrarily at the cost of delaying the determination of what we're aggregating slightly.\n\nI think I'd actually lean towards option 2 as being the most scalable if we had a configurable limit on the maximum size of batches used. While its sustained load, it's a lot more configurable and I suspect makes for a much more self-contained change in Teku.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/704206211/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/704225521",
    "html_url": "https://github.com/ConsenSys/teku/issues/2860#issuecomment-704225521",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/2860",
    "id": 704225521,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcwNDIyNTUyMQ==",
    "user": {
      "login": "tzapu",
      "id": 2983312,
      "node_id": "MDQ6VXNlcjI5ODMzMTI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2983312?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tzapu",
      "html_url": "https://github.com/tzapu",
      "followers_url": "https://api.github.com/users/tzapu/followers",
      "following_url": "https://api.github.com/users/tzapu/following{/other_user}",
      "gists_url": "https://api.github.com/users/tzapu/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tzapu/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tzapu/subscriptions",
      "organizations_url": "https://api.github.com/users/tzapu/orgs",
      "repos_url": "https://api.github.com/users/tzapu/repos",
      "events_url": "https://api.github.com/users/tzapu/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tzapu/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-10-06T12:10:19Z",
    "updated_at": "2020-10-06T12:16:49Z",
    "author_association": "NONE",
    "body": "i'm good with whatever option you see as a best fit that would limit the huge spike, don t have a preference for 1 or 2, the max number of requests in flight at one instant seems to be at most the same",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/704225521/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
