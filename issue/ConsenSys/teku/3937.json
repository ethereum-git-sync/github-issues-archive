{
  "url": "https://api.github.com/repos/ConsenSys/teku/issues/3937",
  "repository_url": "https://api.github.com/repos/ConsenSys/teku",
  "labels_url": "https://api.github.com/repos/ConsenSys/teku/issues/3937/labels{/name}",
  "comments_url": "https://api.github.com/repos/ConsenSys/teku/issues/3937/comments",
  "events_url": "https://api.github.com/repos/ConsenSys/teku/issues/3937/events",
  "html_url": "https://github.com/ConsenSys/teku/issues/3937",
  "id": 876878086,
  "node_id": "MDU6SXNzdWU4NzY4NzgwODY=",
  "number": 3937,
  "title": "Teku with initial state on Prater needs to reorg initially",
  "user": {
    "login": "yorickdowne",
    "id": 71337066,
    "node_id": "MDQ6VXNlcjcxMzM3MDY2",
    "avatar_url": "https://avatars.githubusercontent.com/u/71337066?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/yorickdowne",
    "html_url": "https://github.com/yorickdowne",
    "followers_url": "https://api.github.com/users/yorickdowne/followers",
    "following_url": "https://api.github.com/users/yorickdowne/following{/other_user}",
    "gists_url": "https://api.github.com/users/yorickdowne/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/yorickdowne/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/yorickdowne/subscriptions",
    "organizations_url": "https://api.github.com/users/yorickdowne/orgs",
    "repos_url": "https://api.github.com/users/yorickdowne/repos",
    "events_url": "https://api.github.com/users/yorickdowne/events{/privacy}",
    "received_events_url": "https://api.github.com/users/yorickdowne/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2021-05-05T21:41:33Z",
  "updated_at": "2021-05-05T22:46:07Z",
  "closed_at": "2021-05-05T22:11:53Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Description\r\n\r\nThis may not be a Teku issue, it might be an issue with the Prater state Infura delivered. It may also not be an issue at all.\r\n\r\nWith a fresh Teku getting state from Infura on Prater, Teku was on a fork and had to reorg blocks a few times before it started following the beacon chain.\r\n\r\n```\r\nbeacon_1                   | 21:32:08.198 INFO  - Loading initial state from https://eth2-beacon-prater.infura.io/eth/v1/debug/beacon/states/finalized\r\nbeacon_1                   | 21:32:08.820 INFO  - Loaded 2 Validators: b53146a, 98139b0\r\nbeacon_1                   | 21:32:13.286 INFO  - Loaded initial state at epoch 9743 (state root = 0x230da703f36b163bada2c321b5e801a52df19c7b4a3248109ae923d0de0b052c, block root = 0xb25aec8e97be59336cdf96c8844bf4ceacd9b352dec0b97a678a39dc3083de7d, block slot = 311776).  Please ensure that the supplied initial state corresponds to the latest finalized block as of the start of epoch 9743 (slot 311776).\r\nbeacon_1                   | 21:32:13.859 INFO  - Generated new p2p private key and storing in: generated-node-key\r\nbeacon_1                   | 21:32:14.175 INFO  - PreGenesis Local ENR: enr:-KG4QA_UjoHmq1UW7nwvu7y0jVSds4NXEtE0ZSxo_Cfldki2c7uUWkI6ny8xVDRRvOTYp4bRtmiRGkQ_GvYa3H7igTIChGV0aDKQ5L6TkwAAECD__________4JpZIJ2NIJpcITAqFADiXNlY3AyNTZrMaECOhbAYIBJvDawCkLa8vZatW30cfztcrzLlVqN_kc9efODdGNwgiMog3VkcIIjKA\r\nbeacon_1                   | 21:32:14.183 INFO  - Using multipeer sync\r\nbeacon_1                   | 21:32:14.235 INFO  - rest-api-enabled is false, not starting rest api.\r\nbeacon_1                   | 21:32:14.430 INFO  - Starting libp2p network...\r\nbeacon_1                   | 21:32:14.520 INFO  - Listening for connections on: /ip4/192.168.80.3/tcp/9000/p2p/16Uiu2HAkyLRkLVGodyHTWNELiTdCS7aWwEwKBFJQ8Sygw46jaW1x\r\nbeacon_1                   | 21:32:14.524 INFO  - Starting discovery server on UDP port 9000\r\nbeacon_1                   | 21:32:14.553 INFO  - UDP discovery client started\r\nbeacon_1                   | 21:32:14.561 INFO  - Begin historical sync of blocks prior to slot 311776\r\nbeacon_1                   | 21:32:14.589 INFO  - Scheduler DefaultQuartzScheduler_$_NON_CLUSTERED started.\r\nbeacon_1                   | 21:32:14.778 INFO  - Local ENR: enr:-KG4QNIfH1rJzmTDmeJ7chwKXY4Ail_33RXXZhJ3PTzXI8KXW_LLc3any4g6GK6t_BARkZgnkn4cpbu5jGritJFMKhcDhGV0aDKQed8EKAAAECD__________4JpZIJ2NIJpcITAqFADiXNlY3AyNTZrMaECOhbAYIBJvDawCkLa8vZatW30cfztcrzLlVqN_kc9efODdGNwgiMog3VkcIIjKA\r\nbeacon_1                   | 21:32:14.786 INFO  - Starting eth2 gossip\r\nbeacon_1                   | 21:32:14.912 INFO  - Successfully loaded deposits up to Eth1 block 4738682\r\nbeacon_1                   | 21:32:16.095 INFO  - Sync Event  *** Current slot: 311861, Head slot: 311776, Connected peers: 1\r\nbeacon_1                   | 21:32:24.841 INFO  - Sync Event  *** Current slot: 311862, Head slot: 311795, Connected peers: 1\r\nbeacon_1                   | 21:32:36.509 INFO  - Sync Event  *** Current slot: 311863, Head slot: 311827, Connected peers: 1\r\nbeacon_1                   | 21:32:52.611 INFO  - Slot Event  *** Slot: 311864, Block:    ... empty, Epoch: 9745, Finalized checkpoint: 9743, Finalized root: b25aec..de7d, Peers: 1\r\nbeacon_1                   | 21:33:04.174 INFO  - Slot Event  *** Slot: 311865, Block:    ... empty, Epoch: 9745, Finalized checkpoint: 9743, Finalized root: b25aec..de7d, Peers: 1\r\nbeacon_1                   | 21:33:16.172 INFO  - Slot Event  *** Slot: 311866, Block:    ... empty, Epoch: 9745, Finalized checkpoint: 9743, Finalized root: b25aec..de7d, Peers: 1\r\nbeacon_1                   | 21:33:28.279 INFO  - Slot Event  *** Slot: 311867, Block:    ... empty, Epoch: 9745, Finalized checkpoint: 9743, Finalized root: b25aec..de7d, Peers: 1\r\nbeacon_1                   | 21:33:40.295 INFO  - Slot Event  *** Slot: 311868, Block:    ... empty, Epoch: 9745, Finalized checkpoint: 9743, Finalized root: b25aec..de7d, Peers: 1\r\nbeacon_1                   | 21:33:52.167 INFO  - Slot Event  *** Slot: 311869, Block:    ... empty, Epoch: 9745, Finalized checkpoint: 9743, Finalized root: b25aec..de7d, Peers: 1\r\nbeacon_1                   | 21:34:04.166 INFO  - Slot Event  *** Slot: 311870, Block:    ... empty, Epoch: 9745, Finalized checkpoint: 9743, Finalized root: b25aec..de7d, Peers: 1\r\nbeacon_1                   | 21:34:15.514 WARN  - Unable to retrieve status for validator b53146a.\r\nbeacon_1                   | 21:34:15.514 INFO  - Validator 98139b0 status is active_ongoing.\r\nbeacon_1                   | 21:34:15.538 INFO  - Validator   *** Published attestation  Count: 1, Slot: 311867, Root: ca733b..9df0\r\nbeacon_1                   | 21:34:16.192 INFO  - Slot Event  *** Slot: 311871, Block:    ... empty, Epoch: 9745, Finalized checkpoint: 9743, Finalized root: b25aec..de7d, Peers: 1\r\nbeacon_1                   | 21:34:24.090 INFO  - Epoch Event *** Epoch: 9746, Justified checkpoint: 9744, Finalized checkpoint: 9743, Finalized root: b25aec..de7d\r\nbeacon_1                   | 21:34:24.091 INFO  - Updating number of persistent subnet subscriptions from 0 to 1\r\nbeacon_1                   | 21:34:28.180 INFO  - Slot Event  *** Slot: 311872, Block:    ... empty, Epoch: 9746, Finalized checkpoint: 9743, Finalized root: b25aec..de7d, Peers: 1\r\nbeacon_1                   | 21:34:40.180 INFO  - Slot Event  *** Slot: 311873, Block:    ... empty, Epoch: 9746, Finalized checkpoint: 9743, Finalized root: b25aec..de7d, Peers: 1\r\nbeacon_1                   | 21:34:52.182 INFO  - Slot Event  *** Slot: 311874, Block:    ... empty, Epoch: 9746, Finalized checkpoint: 9743, Finalized root: b25aec..de7d, Peers: 2\r\nbeacon_1                   | 21:34:53.044 INFO  - Chain reorg at slot 311874 from ca733b..9df0 to 9f5090..5a0c. Common ancestor at slot 311861\r\nbeacon_1                   | 21:34:53.653 INFO  - Chain reorg at slot 311874 from 9f5090..5a0c to f652c4..719e. Common ancestor at slot 311862\r\nbeacon_1                   | 21:34:54.118 INFO  - Chain reorg at slot 311874 from f652c4..719e to 654015..979f. Common ancestor at slot 311863\r\nbeacon_1                   | 21:34:54.804 INFO  - Chain reorg at slot 311874 from 654015..979f to ccfffc..9c48. Common ancestor at slot 311864\r\nbeacon_1                   | 21:34:55.544 INFO  - Chain reorg at slot 311874 from ccfffc..9c48 to 4e18e1..1cea. Common ancestor at slot 311865\r\nbeacon_1                   | 21:34:56.209 INFO  - Chain reorg at slot 311874 from 4e18e1..1cea to e04eca..5199. Common ancestor at slot 311866\r\nbeacon_1                   | 21:34:56.639 INFO  - Chain reorg at slot 311874 from e04eca..5199 to 929a38..2844. Common ancestor at slot 311867\r\nbeacon_1                   | 21:34:57.108 INFO  - Chain reorg at slot 311874 from 929a38..2844 to cae54c..be02. Common ancestor at slot 311868\r\nbeacon_1                   | 21:34:57.648 INFO  - Chain reorg at slot 311874 from cae54c..be02 to ecbf8e..3731. Common ancestor at slot 311869\r\nbeacon_1                   | 21:34:58.958 INFO  - Chain reorg at slot 311874 from ecbf8e..3731 to 47b927..8c4d. Common ancestor at slot 311870\r\nbeacon_1                   | 21:35:00.667 INFO  - Chain reorg at slot 311874 from 47b927..8c4d to 586c2b..8872. Common ancestor at slot 311871\r\nbeacon_1                   | 21:35:01.268 INFO  - Chain reorg at slot 311874 from 586c2b..8872 to 8e9252..2457. Common ancestor at slot 311872\r\nbeacon_1                   | 21:35:01.503 INFO  - Chain reorg at slot 311874 from 8e9252..2457 to ba7398..eade. Common ancestor at slot 311873\r\nbeacon_1                   | 21:35:04.496 INFO  - Slot Event  *** Slot: 311875, Block:    ... empty, Epoch: 9746, Finalized checkpoint: 9744, Finalized root: 6ff364..4c42, Peers: 2\r\nbeacon_1                   | 21:35:16.183 INFO  - Slot Event  *** Slot: 311876, Block:    ... empty, Epoch: 9746, Finalized checkpoint: 9744, Finalized root: 6ff364..4c42, Peers: 2\r\nbeacon_1                   | 21:35:28.154 INFO  - Slot Event  *** Slot: 311877, Block:    ... empty, Epoch: 9746, Finalized checkpoint: 9744, Finalized root: 6ff364..4c42, Peers: 1\r\nbeacon_1                   | 21:35:28.169 INFO  - Validator   *** Published attestation  Count: 1, Slot: 311877, Root: ba7398..eade\r\nbeacon_1                   | 21:35:40.154 INFO  - Slot Event  *** Slot: 311878, Block:    ... empty, Epoch: 9746, Finalized checkpoint: 9744, Finalized root: 6ff364..4c42, Peers: 1\r\nbeacon_1                   | 21:35:52.159 INFO  - Slot Event  *** Slot: 311879, Block:    ... empty, Epoch: 9746, Finalized checkpoint: 9744, Finalized root: 6ff364..4c42, Peers: 1\r\nbeacon_1                   | 21:36:03.521 INFO  - Chain reorg at slot 311879 from ba7398..eade to fcf057..dd1f. Common ancestor at slot 311874\r\nbeacon_1                   | 21:36:03.892 INFO  - Chain reorg at slot 311879 from fcf057..dd1f to 2ee150..1c00. Common ancestor at slot 311875\r\nbeacon_1                   | 21:36:04.158 INFO  - Chain reorg at slot 311879 from 2ee150..1c00 to 6e3c6c..5e8d. Common ancestor at slot 311876\r\nbeacon_1                   | 21:36:04.311 INFO  - Slot Event  *** Slot: 311880, Block:    ... empty, Epoch: 9746, Finalized checkpoint: 9744, Finalized root: 6ff364..4c42, Peers: 2\r\nbeacon_1                   | 21:36:04.775 INFO  - Chain reorg at slot 311880 from 6e3c6c..5e8d to 17bd3c..830b. Common ancestor at slot 311877\r\nbeacon_1                   | 21:36:05.192 INFO  - Chain reorg at slot 311880 from 17bd3c..830b to 413e83..1c48. Common ancestor at slot 311878\r\nbeacon_1                   | 21:36:05.590 INFO  - Chain reorg at slot 311880 from 413e83..1c48 to 9eea96..dc40. Common ancestor at slot 311879\r\nbeacon_1                   | 21:36:16.211 INFO  - Slot Event  *** Slot: 311881, Block: 9d6a42..e29d, Epoch: 9746, Finalized checkpoint: 9744, Finalized root: 6ff364..4c42, Peers: 2\r\nbeacon_1                   | 21:36:28.235 INFO  - Slot Event  *** Slot: 311882, Block: 07ec0b..078e, Epoch: 9746, Finalized checkpoint: 9744, Finalized root: 6ff364..4c42, Peers: 10\r\nbeacon_1                   | 21:36:40.207 INFO  - Slot Event  *** Slot: 311883, Block: a3ea1e..05d9, Epoch: 9746, Finalized checkpoint: 9744, Finalized root: 6ff364..4c42, Peers: 11\r\nbeacon_1                   | 21:36:52.222 INFO  - Slot Event  *** Slot: 311884, Block: 622b47..4552, Epoch: 9746, Finalized checkpoint: 9744, Finalized root: 6ff364..4c42, Peers: 11\r\nbeacon_1                   | 21:37:04.184 INFO  - Slot Event  *** Slot: 311885, Block: 042328..5986, Epoch: 9746, Finalized checkpoint: 9744, Finalized root: 6ff364..4c42, Peers: 15\r\n```\r\n\r\n### Versions (Add all that apply)\r\n* Software version: teku/v21.4.1/linux-x86_64/oracle_openjdk-java-15\r\n* OS Name & Version: Ubuntu 20.04\r\n",
  "closed_by": {
    "login": "yorickdowne",
    "id": 71337066,
    "node_id": "MDQ6VXNlcjcxMzM3MDY2",
    "avatar_url": "https://avatars.githubusercontent.com/u/71337066?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/yorickdowne",
    "html_url": "https://github.com/yorickdowne",
    "followers_url": "https://api.github.com/users/yorickdowne/followers",
    "following_url": "https://api.github.com/users/yorickdowne/following{/other_user}",
    "gists_url": "https://api.github.com/users/yorickdowne/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/yorickdowne/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/yorickdowne/subscriptions",
    "organizations_url": "https://api.github.com/users/yorickdowne/orgs",
    "repos_url": "https://api.github.com/users/yorickdowne/repos",
    "events_url": "https://api.github.com/users/yorickdowne/events{/privacy}",
    "received_events_url": "https://api.github.com/users/yorickdowne/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/3937/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ConsenSys/teku/issues/3937/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/833081062",
    "html_url": "https://github.com/ConsenSys/teku/issues/3937#issuecomment-833081062",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/3937",
    "id": 833081062,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgzMzA4MTA2Mg==",
    "user": {
      "login": "yorickdowne",
      "id": 71337066,
      "node_id": "MDQ6VXNlcjcxMzM3MDY2",
      "avatar_url": "https://avatars.githubusercontent.com/u/71337066?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/yorickdowne",
      "html_url": "https://github.com/yorickdowne",
      "followers_url": "https://api.github.com/users/yorickdowne/followers",
      "following_url": "https://api.github.com/users/yorickdowne/following{/other_user}",
      "gists_url": "https://api.github.com/users/yorickdowne/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/yorickdowne/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/yorickdowne/subscriptions",
      "organizations_url": "https://api.github.com/users/yorickdowne/orgs",
      "repos_url": "https://api.github.com/users/yorickdowne/repos",
      "events_url": "https://api.github.com/users/yorickdowne/events{/privacy}",
      "received_events_url": "https://api.github.com/users/yorickdowne/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-05-05T22:11:53Z",
    "updated_at": "2021-05-05T22:11:53Z",
    "author_association": "NONE",
    "body": "Not an issue with Teku, there are a few odd Prater peers out there. When peering picks up, Teku reorgs and gets back to the main chain. Closing.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/833081062/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/833097585",
    "html_url": "https://github.com/ConsenSys/teku/issues/3937#issuecomment-833097585",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/3937",
    "id": 833097585,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgzMzA5NzU4NQ==",
    "user": {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-05-05T22:46:07Z",
    "updated_at": "2021-05-05T22:46:07Z",
    "author_association": "CONTRIBUTOR",
    "body": "From what I can see all the reorg messages there are actually just empty slots being filled with blocks. https://www.symphonious.net/2020/07/06/exploring-ethereum-2-the-curious-case-of-the-invisible-fork/ explains all the background of why Teku treats this as a reorg.  Since it's starting from the latest finalized state, it still has to sync the non-finalised part of the chain.\r\n\r\nWhen Teku is in sync mode (ie it knows it's a long way behind) it suppresses all these reorg events because there's no point, but when it's close to being in sync it can't be sure if there are more blocks to sync or if there's just empty slots.  In this case it seems to have dropped out of sync mode a bit sooner than is ideal and so wound up logging a reorg event for each of the last few blocks it imported.  You can see that as it switched from `Sync Event` to `Slot Event`.  I suspect what happened is that one peer it first had either wasn't in sync or wound up not gossiping blocks to us for some reason. So we caught up to head but weren't yet getting a good view of the new blocks being gossiped. It then took a little while to go back and request the blocks we missed from gossip as you have to request them one at a time walking back up the chain.  Once we got them they got imported (causing the spate of reorg events). Things settle down once we get a few more peers and start receiving gossip reliably.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/833097585/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
