{
  "url": "https://api.github.com/repos/ConsenSys/teku/issues/2492",
  "repository_url": "https://api.github.com/repos/ConsenSys/teku",
  "labels_url": "https://api.github.com/repos/ConsenSys/teku/issues/2492/labels{/name}",
  "comments_url": "https://api.github.com/repos/ConsenSys/teku/issues/2492/comments",
  "events_url": "https://api.github.com/repos/ConsenSys/teku/issues/2492/events",
  "html_url": "https://github.com/ConsenSys/teku/issues/2492",
  "id": 670722663,
  "node_id": "MDU6SXNzdWU2NzA3MjI2NjM=",
  "number": 2492,
  "title": "High memory usage when ingesting scrypt-based keystores",
  "user": {
    "login": "benjaminion",
    "id": 20796281,
    "node_id": "MDQ6VXNlcjIwNzk2Mjgx",
    "avatar_url": "https://avatars.githubusercontent.com/u/20796281?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/benjaminion",
    "html_url": "https://github.com/benjaminion",
    "followers_url": "https://api.github.com/users/benjaminion/followers",
    "following_url": "https://api.github.com/users/benjaminion/following{/other_user}",
    "gists_url": "https://api.github.com/users/benjaminion/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/benjaminion/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/benjaminion/subscriptions",
    "organizations_url": "https://api.github.com/users/benjaminion/orgs",
    "repos_url": "https://api.github.com/users/benjaminion/repos",
    "events_url": "https://api.github.com/users/benjaminion/events{/privacy}",
    "received_events_url": "https://api.github.com/users/benjaminion/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "rolfyone",
    "id": 2967240,
    "node_id": "MDQ6VXNlcjI5NjcyNDA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2967240?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/rolfyone",
    "html_url": "https://github.com/rolfyone",
    "followers_url": "https://api.github.com/users/rolfyone/followers",
    "following_url": "https://api.github.com/users/rolfyone/following{/other_user}",
    "gists_url": "https://api.github.com/users/rolfyone/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/rolfyone/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rolfyone/subscriptions",
    "organizations_url": "https://api.github.com/users/rolfyone/orgs",
    "repos_url": "https://api.github.com/users/rolfyone/repos",
    "events_url": "https://api.github.com/users/rolfyone/events{/privacy}",
    "received_events_url": "https://api.github.com/users/rolfyone/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "rolfyone",
      "id": 2967240,
      "node_id": "MDQ6VXNlcjI5NjcyNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2967240?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rolfyone",
      "html_url": "https://github.com/rolfyone",
      "followers_url": "https://api.github.com/users/rolfyone/followers",
      "following_url": "https://api.github.com/users/rolfyone/following{/other_user}",
      "gists_url": "https://api.github.com/users/rolfyone/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rolfyone/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rolfyone/subscriptions",
      "organizations_url": "https://api.github.com/users/rolfyone/orgs",
      "repos_url": "https://api.github.com/users/rolfyone/repos",
      "events_url": "https://api.github.com/users/rolfyone/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rolfyone/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2020-08-01T10:01:23Z",
  "updated_at": "2020-08-06T20:15:07Z",
  "closed_at": "2020-08-06T20:15:07Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "Tl;dr: implement a flag to limit the parallelism when decrypting keystores (edit: better idea below).\r\n\r\nWhen loading scrypt-based keystores there is a trade-off in time and memory: scrypt is both slow and memory-intensive.\r\n\r\nPR #2437 improved keystore loading times by decrypting keystores in parallel. However, this can require large amounts of initial heap space - much more than we need for normal running. It would be good to be able to start with lower heap requirements: maybe a flag to set the max parallelism.\r\n\r\nAn experiment on my test system. I inserted an exit after loading validators in the `initializeValidators()` method and tested how much heap was needed to load the full set without an out of heap error. Heap size set by `-XmxNNNNm`.\r\n\r\n| # keystores | MB heap required |\r\n| ---| --- |\r\n| 0 | 15 |\r\n| 1 | 400 |\r\n| 2 | 600 |\r\n| 3 | 900 |\r\n| 4 | 1200 |\r\n| 5 | 1500 |\r\n| 6 | 1800 |\r\n| 7 | 2100 |\r\n| 8 | 2400 |\r\n| >8 | 2400 |\r\n\r\nThe heap requirement tops out at 2400mb, which I assume indicates that the JVM is using 8-way parallelism on this system (it is an 8 processor linux VM).\r\n\r\nNote that this does _not_ occur with pbkdf2 based keystores. I can load 64 of those in 19mb of heap. (It is also instant.)",
  "closed_by": {
    "login": "rolfyone",
    "id": 2967240,
    "node_id": "MDQ6VXNlcjI5NjcyNDA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2967240?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/rolfyone",
    "html_url": "https://github.com/rolfyone",
    "followers_url": "https://api.github.com/users/rolfyone/followers",
    "following_url": "https://api.github.com/users/rolfyone/following{/other_user}",
    "gists_url": "https://api.github.com/users/rolfyone/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/rolfyone/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rolfyone/subscriptions",
    "organizations_url": "https://api.github.com/users/rolfyone/orgs",
    "repos_url": "https://api.github.com/users/rolfyone/repos",
    "events_url": "https://api.github.com/users/rolfyone/events{/privacy}",
    "received_events_url": "https://api.github.com/users/rolfyone/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/2492/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ConsenSys/teku/issues/2492/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/667511401",
    "html_url": "https://github.com/ConsenSys/teku/issues/2492#issuecomment-667511401",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/2492",
    "id": 667511401,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY2NzUxMTQwMQ==",
    "user": {
      "login": "benjaminion",
      "id": 20796281,
      "node_id": "MDQ6VXNlcjIwNzk2Mjgx",
      "avatar_url": "https://avatars.githubusercontent.com/u/20796281?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/benjaminion",
      "html_url": "https://github.com/benjaminion",
      "followers_url": "https://api.github.com/users/benjaminion/followers",
      "following_url": "https://api.github.com/users/benjaminion/following{/other_user}",
      "gists_url": "https://api.github.com/users/benjaminion/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/benjaminion/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/benjaminion/subscriptions",
      "organizations_url": "https://api.github.com/users/benjaminion/orgs",
      "repos_url": "https://api.github.com/users/benjaminion/repos",
      "events_url": "https://api.github.com/users/benjaminion/events{/privacy}",
      "received_events_url": "https://api.github.com/users/benjaminion/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-08-01T10:40:45Z",
    "updated_at": "2020-08-01T10:40:45Z",
    "author_association": "CONTRIBUTOR",
    "body": "Rather than increasing the number of config options and the resulting documentation, maintenance, and support headache...\r\n\r\nIf Java can see its own max heap size, we can calculate the optimal parallelism given the available memory. Basically this many threads: `(Xmx - margin) / sizeof(scrypt data)`, where `margin` is either the current heap usage (after triggering a GC?) or some known amount of overhead memory we need at this point.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/667511401/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
