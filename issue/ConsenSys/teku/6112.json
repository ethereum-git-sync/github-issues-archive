{
  "url": "https://api.github.com/repos/Consensys/teku/issues/6112",
  "repository_url": "https://api.github.com/repos/Consensys/teku",
  "labels_url": "https://api.github.com/repos/Consensys/teku/issues/6112/labels{/name}",
  "comments_url": "https://api.github.com/repos/Consensys/teku/issues/6112/comments",
  "events_url": "https://api.github.com/repos/Consensys/teku/issues/6112/events",
  "html_url": "https://github.com/Consensys/teku/issues/6112",
  "id": 1347216759,
  "node_id": "I_kwDOCM9I9M5QTOV3",
  "number": 6112,
  "title": "BNs load balancing for optimal DoS protection (Sentry node continuation)",
  "user": {
    "login": "lucassaldanha",
    "id": 1766440,
    "node_id": "MDQ6VXNlcjE3NjY0NDA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1766440?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/lucassaldanha",
    "html_url": "https://github.com/lucassaldanha",
    "followers_url": "https://api.github.com/users/lucassaldanha/followers",
    "following_url": "https://api.github.com/users/lucassaldanha/following{/other_user}",
    "gists_url": "https://api.github.com/users/lucassaldanha/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/lucassaldanha/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/lucassaldanha/subscriptions",
    "organizations_url": "https://api.github.com/users/lucassaldanha/orgs",
    "repos_url": "https://api.github.com/users/lucassaldanha/repos",
    "events_url": "https://api.github.com/users/lucassaldanha/events{/privacy}",
    "received_events_url": "https://api.github.com/users/lucassaldanha/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1048919131,
      "node_id": "MDU6TGFiZWwxMDQ4OTE5MTMx",
      "url": "https://api.github.com/repos/Consensys/teku/labels/enhancement%20%F0%9F%95%B5%EF%B8%8F%E2%80%8D%E2%99%80%EF%B8%8F",
      "name": "enhancement üïµÔ∏è‚Äç‚ôÄÔ∏è",
      "color": "a2eeef",
      "default": false,
      "description": "New feature or request"
    },
    {
      "id": 1271198478,
      "node_id": "MDU6TGFiZWwxMjcxMTk4NDc4",
      "url": "https://api.github.com/repos/Consensys/teku/labels/performance%20%F0%9F%9A%80",
      "name": "performance üöÄ",
      "color": "ffcce3",
      "default": false,
      "description": "Improves performance without changing functionality"
    },
    {
      "id": 1846421702,
      "node_id": "MDU6TGFiZWwxODQ2NDIxNzAy",
      "url": "https://api.github.com/repos/Consensys/teku/labels/Epic",
      "name": "Epic",
      "color": "3E4B9E",
      "default": false,
      "description": null
    },
    {
      "id": 5730319360,
      "node_id": "LA_kwDOCM9I9M8AAAABVY28AA",
      "url": "https://api.github.com/repos/Consensys/teku/labels/bn-failovers",
      "name": "bn-failovers",
      "color": "41173A",
      "default": false,
      "description": "Changes regarding failover functionality"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": {
    "login": "mehdi-aouadi",
    "id": 1208687,
    "node_id": "MDQ6VXNlcjEyMDg2ODc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1208687?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mehdi-aouadi",
    "html_url": "https://github.com/mehdi-aouadi",
    "followers_url": "https://api.github.com/users/mehdi-aouadi/followers",
    "following_url": "https://api.github.com/users/mehdi-aouadi/following{/other_user}",
    "gists_url": "https://api.github.com/users/mehdi-aouadi/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mehdi-aouadi/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mehdi-aouadi/subscriptions",
    "organizations_url": "https://api.github.com/users/mehdi-aouadi/orgs",
    "repos_url": "https://api.github.com/users/mehdi-aouadi/repos",
    "events_url": "https://api.github.com/users/mehdi-aouadi/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mehdi-aouadi/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "mehdi-aouadi",
      "id": 1208687,
      "node_id": "MDQ6VXNlcjEyMDg2ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1208687?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mehdi-aouadi",
      "html_url": "https://github.com/mehdi-aouadi",
      "followers_url": "https://api.github.com/users/mehdi-aouadi/followers",
      "following_url": "https://api.github.com/users/mehdi-aouadi/following{/other_user}",
      "gists_url": "https://api.github.com/users/mehdi-aouadi/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mehdi-aouadi/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mehdi-aouadi/subscriptions",
      "organizations_url": "https://api.github.com/users/mehdi-aouadi/orgs",
      "repos_url": "https://api.github.com/users/mehdi-aouadi/repos",
      "events_url": "https://api.github.com/users/mehdi-aouadi/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mehdi-aouadi/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2022-08-23T02:00:33Z",
  "updated_at": "2023-12-05T17:58:14Z",
  "closed_at": null,
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "To **reduce the bandwidth and CPU requirements** for beacon nodes in a large staking service and **provide optimal DoS protection**, we should be able to delegate which beacon node to use for specific tasks:\r\n- Attestations subnets subscriptions\r\n- Calculating duties and creating blocks and attestations\r\n- Publishing blocks\r\n\r\nThis is a continuation of the [Sentry Beacon Nodes](https://docs.teku.consensys.io/how-to/use-sentry-nodes#configure-sentry-nodes)\r\n\r\nThe VC requests could be spread across different BNs (2 or 3) based on a configuration file. Two different approches are possible:\r\n1- Endpoint centric approach. 3 nodes example:\r\n```\r\n{\r\n    \"beacon_nodes\": [\r\n        {\r\n            \"url\": \"http://nodeA:5051\", // Source of truth node\r\n            \"calculate_duties\": true,\r\n            \"create_blocks\": true,\r\n            \"publish_blocks\": false,\r\n            \"create_attestations\": true,\r\n            \"publish_attestations\": false,\r\n            \"create_aggregates\": false,\r\n            \"attestation_subnets\": {\r\n                \"start\": 0,\r\n                \"count\": 32\r\n            },\r\n            \"sync_committee_subnets\": {\r\n                \"start\": 0,\r\n                \"count\": 32\r\n            }\r\n        },\r\n        {\r\n            \"url\": \"http://nodeB:5051\", // Attestation node\r\n            \"calculate_duties\": false,\r\n            \"create_blocks\": false,\r\n            \"publish_blocks\": false,\r\n            \"create_attestations\": false,\r\n            \"publish_attestations\": true,\r\n            \"create_aggregates\": true,\r\n            \"attestation_subnets\": {\r\n                \"start\": 32,\r\n                \"count\": 32\r\n            },\r\n            \"sync_committee_subnets\": {\r\n                \"start\": 32,\r\n                \"count\": 32\r\n            }\r\n        },\r\n        {\r\n            \"url\": \"http://nodeB:5051\", // Block node\r\n            \"calculate_duties\": false,\r\n            \"create_blocks\": false,\r\n            \"publish_blocks\": true,\r\n            \"create_attestations\": false,\r\n            \"publish_attestations\": false,\r\n            \"create_aggregates\": false\r\n        }\r\n    ]\r\n}\r\n```\r\n2- role centric config/ 3 nodes example:\r\n```\r\n{\r\n    \"beacon_nodes\": {\r\n        \"duties_provider\": {\r\n            \"endpoints\": [\r\n                \"http://nodeA:5051\"\r\n            ],\r\n        },\r\n        \"block_publisher\": {\r\n            \"endpoints\": [\r\n                \"http://nodeB:5051\"\r\n            ],\r\n            \"mode\": \"priority\"\r\n        },\r\n        \"attestation_publisher\": {\r\n            \"endpoints\": [\r\n                \"http://nodeC:5051\"\r\n            ],\r\n            \"mode\": \"priority\"\r\n        },\r\n    }\r\n}\r\n```\r\nThe node tasks modes could be:\r\n- priority: first suitable and online node found in the list\r\n- random: randomly select one suitable node (select another if on fail)\r\n- broadcast: publish to all suitable nodes\r\n\r\n**The current sentry node mode allows to implement some of this load balancing but not as finely as initially suggested.**\r\nThe not yet implemented features are:\r\n- Subnet subscriptions attribution\r\n- BN modes: priority, random or broadcast\r\n- Configuration error handling\r\n- Offline nodes handling\r\n\r\nMore info here: https://hackmd.io/0jhD6wEzQLWnE3huXLkjgg#Minimize-Subnet-Subscriptions",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/Consensys/teku/issues/6112/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/Consensys/teku/issues/6112/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/Consensys/teku/issues/comments/1840952658",
    "html_url": "https://github.com/Consensys/teku/issues/6112#issuecomment-1840952658",
    "issue_url": "https://api.github.com/repos/Consensys/teku/issues/6112",
    "id": 1840952658,
    "node_id": "IC_kwDOCM9I9M5turVS",
    "user": {
      "login": "mehdi-aouadi",
      "id": 1208687,
      "node_id": "MDQ6VXNlcjEyMDg2ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1208687?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mehdi-aouadi",
      "html_url": "https://github.com/mehdi-aouadi",
      "followers_url": "https://api.github.com/users/mehdi-aouadi/followers",
      "following_url": "https://api.github.com/users/mehdi-aouadi/following{/other_user}",
      "gists_url": "https://api.github.com/users/mehdi-aouadi/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mehdi-aouadi/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mehdi-aouadi/subscriptions",
      "organizations_url": "https://api.github.com/users/mehdi-aouadi/orgs",
      "repos_url": "https://api.github.com/users/mehdi-aouadi/repos",
      "events_url": "https://api.github.com/users/mehdi-aouadi/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mehdi-aouadi/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-12-05T14:54:02Z",
    "updated_at": "2023-12-05T17:58:14Z",
    "author_association": "CONTRIBUTOR",
    "body": "Turned out this issue is broader than expected. To start I converted it to an Epic and here is why:\r\n- [The subnets subscription revamp](https://github.com/Consensys/teku/pull/7341) solves a part of what is suggested only. The BN subscribes to 2 persistent subnets only now and to others according to the VC assigned attestation aggregation duties (running more than 64 validators could end u making the BN connecting to all subnets though). The proposed solution is to make the user able to assign specific subnet ranges to specific BNs.\r\n- What is suggested doesn't concern the attestations subnets handling only but also how the VC requests are handled by the BNs in general (the attestations subnets being what triggered this reflection). The proposed solution is to make it possible, using a configuration file, to assign tasks to specific BNs (`calculate_duties`, `create_blocks`, `publish_blocks`, `create_attestations`, `publish_attestations`, `create_aggregates`...). This is already provided by the sentry nodes mode but not as finely. More details can be found in [this note](https://hackmd.io/0jhD6wEzQLWnE3huXLkjgg#Minimize-Subnet-Subscriptions)\r\n- The suggested changes will probably affect how the BNs failover mechanism is currently implemented\r\n- The feature requires to update the sentry nodes configurations files to add more granularity",
    "reactions": {
      "url": "https://api.github.com/repos/Consensys/teku/issues/comments/1840952658/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
