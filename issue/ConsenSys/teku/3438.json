{
  "url": "https://api.github.com/repos/ConsenSys/teku/issues/3438",
  "repository_url": "https://api.github.com/repos/ConsenSys/teku",
  "labels_url": "https://api.github.com/repos/ConsenSys/teku/issues/3438/labels{/name}",
  "comments_url": "https://api.github.com/repos/ConsenSys/teku/issues/3438/comments",
  "events_url": "https://api.github.com/repos/ConsenSys/teku/issues/3438/events",
  "html_url": "https://github.com/ConsenSys/teku/issues/3438",
  "id": 781062670,
  "node_id": "MDU6SXNzdWU3ODEwNjI2NzA=",
  "number": 3438,
  "title": "Lock file on keys not properly erroring",
  "user": {
    "login": "PatrickAlphaC",
    "id": 54278053,
    "node_id": "MDQ6VXNlcjU0Mjc4MDUz",
    "avatar_url": "https://avatars.githubusercontent.com/u/54278053?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/PatrickAlphaC",
    "html_url": "https://github.com/PatrickAlphaC",
    "followers_url": "https://api.github.com/users/PatrickAlphaC/followers",
    "following_url": "https://api.github.com/users/PatrickAlphaC/following{/other_user}",
    "gists_url": "https://api.github.com/users/PatrickAlphaC/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/PatrickAlphaC/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/PatrickAlphaC/subscriptions",
    "organizations_url": "https://api.github.com/users/PatrickAlphaC/orgs",
    "repos_url": "https://api.github.com/users/PatrickAlphaC/repos",
    "events_url": "https://api.github.com/users/PatrickAlphaC/events{/privacy}",
    "received_events_url": "https://api.github.com/users/PatrickAlphaC/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "rolfyone",
    "id": 2967240,
    "node_id": "MDQ6VXNlcjI5NjcyNDA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2967240?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/rolfyone",
    "html_url": "https://github.com/rolfyone",
    "followers_url": "https://api.github.com/users/rolfyone/followers",
    "following_url": "https://api.github.com/users/rolfyone/following{/other_user}",
    "gists_url": "https://api.github.com/users/rolfyone/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/rolfyone/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rolfyone/subscriptions",
    "organizations_url": "https://api.github.com/users/rolfyone/orgs",
    "repos_url": "https://api.github.com/users/rolfyone/repos",
    "events_url": "https://api.github.com/users/rolfyone/events{/privacy}",
    "received_events_url": "https://api.github.com/users/rolfyone/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "rolfyone",
      "id": 2967240,
      "node_id": "MDQ6VXNlcjI5NjcyNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2967240?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rolfyone",
      "html_url": "https://github.com/rolfyone",
      "followers_url": "https://api.github.com/users/rolfyone/followers",
      "following_url": "https://api.github.com/users/rolfyone/following{/other_user}",
      "gists_url": "https://api.github.com/users/rolfyone/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rolfyone/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rolfyone/subscriptions",
      "organizations_url": "https://api.github.com/users/rolfyone/orgs",
      "repos_url": "https://api.github.com/users/rolfyone/repos",
      "events_url": "https://api.github.com/users/rolfyone/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rolfyone/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2021-01-07T06:19:47Z",
  "updated_at": "2021-01-11T08:06:30Z",
  "closed_at": "2021-01-11T08:06:30Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "<!-- Have you done the following? -->\r\n\r\n### Description\r\nWhen a lock file is left on a validator key (maybe the box crashes before teku has a chance to remove the lock files), the node will not properly identify this, but instead hang around and be confused. \r\n\r\n### Acceptance Criteria\r\n* When a validator key has a lock file on it, set an error message saying so and exit. \r\n\r\n### Steps to Reproduce (Bug)\r\n1. Add lockfiles to validator keys \r\nie: keystore-m_2425245-3453453.json.lock\r\n2. Start teku node\r\n3. Hang. If you set the logging to `--logging debug` you'll see the error. \r\n\r\n**Expected behavior:** [What you expect to happen]\r\nTeku prints an error mentioning the locks and exits\r\n\r\n**Actual behavior:** [What actually happens]\r\n```\r\n2021-01-07 00:43:01.813-05:00 | validator-async-0 | ERROR | ValidatorClientService | Unable to initialize validators\r\ntech.pegasys.teku.util.config.InvalidConfigurationException: Keystore file /var/lib/teku/validator_keys/keystore-m_1111_1111_1_0_0-11111111.json.lock already in use.\r\n        at tech.pegasys.teku.validator.client.loader.KeystoreLocker.keystoreInUseException(KeystoreLocker.java:84) ~[teku-validator-client-20.12.1.jar:20.12.1]\r\n        at tech.pegasys.teku.validator.client.loader.KeystoreLocker.attemptReplaceStaleLockFile(KeystoreLocker.java:67) ~[teku-validator-client-20.12.1.jar:20.12.1]\r\n        at tech.pegasys.teku.validator.client.loader.KeystoreLocker.lockKeystore(KeystoreLocker.java:42) ~[teku-validator-client-20.12.1.jar:20.12.1]\r\n        at tech.pegasys.teku.validator.client.loader.KeystoresValidatorKeyProvider.loadBLSPrivateKey(KeystoresValidatorKeyProvider.java:110) ~[teku-validator-client-20.12.1.jar:20.12.1]\r\n        at tech.pegasys.teku.validator.client.loader.KeystoresValidatorKeyProvider.lambda$loadValidatorKeys$0(KeystoresValidatorKeyProvider.java:78) ~[teku-validator-client-20.12.1.jar:20.12.1]\r\n        at java.util.concurrent.FutureTask.run(FutureTask.java:264) ~[?:?]\r\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) [?:?]\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) [?:?]\r\n        at java.lang.Thread.run(Thread.java:834) [?:?]\r\n2021-01-07 00:43:01.821-05:00 | main | INFO  | SimpleThreadPool | Job execution threads will use class loader of thread: main\r\n```\r\nAnd proceeds to hang around and be confused. \r\n\r\n**Frequency:** [What percentage of the time does it occur?]\r\n100%\r\n\r\n### Versions (Add all that apply)\r\n* Software version: [`teku --version`]\r\nteku/v20.12.1/linux-x86_64/-ubuntu-openjdk64bitservervm-java-11\r\n* Java version: [`java -version`]\r\nopenjdk 11.0.9.1 2020-11-04\r\nOpenJDK Runtime Environment (build 11.0.9.1+1-Ubuntu-0ubuntu1.20.04)\r\nOpenJDK 64-Bit Server VM (build 11.0.9.1+1-Ubuntu-0ubuntu1.20.04, mixed mode, sharing)\r\n* OS Name & Version: [`cat /etc/*release`]\r\nUbuntu 20.04.1 LTS\r\n* Kernel Version: [`uname -a`]\r\nLinux mainnet-eth-2-box 5.4.0-59-generic #65-Ubuntu SMP Thu Dec 10 12:01:51 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n### Additional Information\r\n\r\nTemporary work around is to manually delete the lockfiles in the validators key folder and restart your node. Works fine after that. ",
  "closed_by": {
    "login": "rolfyone",
    "id": 2967240,
    "node_id": "MDQ6VXNlcjI5NjcyNDA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2967240?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/rolfyone",
    "html_url": "https://github.com/rolfyone",
    "followers_url": "https://api.github.com/users/rolfyone/followers",
    "following_url": "https://api.github.com/users/rolfyone/following{/other_user}",
    "gists_url": "https://api.github.com/users/rolfyone/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/rolfyone/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rolfyone/subscriptions",
    "organizations_url": "https://api.github.com/users/rolfyone/orgs",
    "repos_url": "https://api.github.com/users/rolfyone/repos",
    "events_url": "https://api.github.com/users/rolfyone/events{/privacy}",
    "received_events_url": "https://api.github.com/users/rolfyone/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/3438/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ConsenSys/teku/issues/3438/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/755912253",
    "html_url": "https://github.com/ConsenSys/teku/issues/3438#issuecomment-755912253",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/3438",
    "id": 755912253,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc1NTkxMjI1Mw==",
    "user": {
      "login": "PatrickAlphaC",
      "id": 54278053,
      "node_id": "MDQ6VXNlcjU0Mjc4MDUz",
      "avatar_url": "https://avatars.githubusercontent.com/u/54278053?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/PatrickAlphaC",
      "html_url": "https://github.com/PatrickAlphaC",
      "followers_url": "https://api.github.com/users/PatrickAlphaC/followers",
      "following_url": "https://api.github.com/users/PatrickAlphaC/following{/other_user}",
      "gists_url": "https://api.github.com/users/PatrickAlphaC/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/PatrickAlphaC/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/PatrickAlphaC/subscriptions",
      "organizations_url": "https://api.github.com/users/PatrickAlphaC/orgs",
      "repos_url": "https://api.github.com/users/PatrickAlphaC/repos",
      "events_url": "https://api.github.com/users/PatrickAlphaC/events{/privacy}",
      "received_events_url": "https://api.github.com/users/PatrickAlphaC/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-01-07T06:20:19Z",
    "updated_at": "2021-01-07T06:20:19Z",
    "author_association": "NONE",
    "body": "Thanks to @ajsutton for helping me out with this issue!",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/755912253/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/755912839",
    "html_url": "https://github.com/ConsenSys/teku/issues/3438#issuecomment-755912839",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/3438",
    "id": 755912839,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc1NTkxMjgzOQ==",
    "user": {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-01-07T06:21:49Z",
    "updated_at": "2021-01-07T06:21:49Z",
    "author_association": "CONTRIBUTOR",
    "body": "I suspect this was broken when we moved to loading validator keys asynchronously.  That's been a very beneficial change so would be good to keep it but need to work out how to get Teku to exit and print the error message right at the end of output if it fails.  If the error is further up the output its really easy to miss it.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/755912839/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
