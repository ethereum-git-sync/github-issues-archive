{
  "url": "https://api.github.com/repos/ConsenSys/teku/issues/6088",
  "repository_url": "https://api.github.com/repos/ConsenSys/teku",
  "labels_url": "https://api.github.com/repos/ConsenSys/teku/issues/6088/labels{/name}",
  "comments_url": "https://api.github.com/repos/ConsenSys/teku/issues/6088/comments",
  "events_url": "https://api.github.com/repos/ConsenSys/teku/issues/6088/events",
  "html_url": "https://github.com/ConsenSys/teku/issues/6088",
  "id": 1342007894,
  "node_id": "I_kwDOCM9I9M5P_WpW",
  "number": 6088,
  "title": "AbstractRouter internal error on message null from peer null",
  "user": {
    "login": "fab-10",
    "id": 91944855,
    "node_id": "U_kgDOBXr3lw",
    "avatar_url": "https://avatars.githubusercontent.com/u/91944855?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/fab-10",
    "html_url": "https://github.com/fab-10",
    "followers_url": "https://api.github.com/users/fab-10/followers",
    "following_url": "https://api.github.com/users/fab-10/following{/other_user}",
    "gists_url": "https://api.github.com/users/fab-10/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/fab-10/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/fab-10/subscriptions",
    "organizations_url": "https://api.github.com/users/fab-10/orgs",
    "repos_url": "https://api.github.com/users/fab-10/repos",
    "events_url": "https://api.github.com/users/fab-10/events{/privacy}",
    "received_events_url": "https://api.github.com/users/fab-10/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2022-08-17T16:22:21Z",
  "updated_at": "2022-08-26T00:10:04Z",
  "closed_at": "2022-08-26T00:10:04Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "<!-- \r\nBy filing an Issue, you are expected to comply with the Code of Conduct, \r\nincluding treating everyone with respect:\r\nhttps://github.com/ConsenSys/teku/blob/master/CODE-OF-CONDUCT.md\r\n\r\nNot all sections will apply to all issue types.\r\n-->\r\n\r\n### Description\r\nSince the update to Teku 22.8.0 yesterday, I have seen a couple of these errors `AbstractRouter internal error on message null from peer null`, never seen before, stack trace:\r\n\r\n```\r\n io.libp2p.core.InternalErrorException: [peerHandler] not initialized yet\r\n\tat io.libp2p.etc.util.P2PService$StreamHandler.getPeerHandler(P2PService.kt:106)\r\n\tat io.libp2p.etc.util.P2PService.streamDisconnected(P2PService.kt:169)\r\n\tat io.libp2p.etc.util.P2PService$StreamHandler$channelUnregistered$1.invoke(P2PService.kt:92)\r\n\tat io.libp2p.etc.util.P2PService$StreamHandler$channelUnregistered$1.invoke(P2PService.kt:90)\r\n\tat io.libp2p.etc.util.P2PService.runOnEventThread$lambda-0(P2PService.kt:234)\r\n\tat java.base/java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:539)\r\n\tat java.base/java.util.concurrent.FutureTask.run(FutureTask.java:264)\r\n\tat java.base/java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:304)\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1136)\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:635)\r\n\tat java.base/java.lang.Thread.run(Thread.java:833)\r\n```\r\n\r\n### Steps to Reproduce (Bug)\r\nRun Teku 22.8.0, it is not deterministic, it happened twice in a day\r\n\r\n**Expected behavior:** [What you expect to happen]\r\n\r\n**Actual behavior:** [What actually happens]\r\n\r\n**Frequency:** [How regularly does it occur?]\r\nit happened twice in a day\r\n\r\n### Versions (Add all that apply)\r\n* Software version: 22.8.0\r\n* Java version: Java17\r\n",
  "closed_by": {
    "login": "ajsutton",
    "id": 72675,
    "node_id": "MDQ6VXNlcjcyNjc1",
    "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ajsutton",
    "html_url": "https://github.com/ajsutton",
    "followers_url": "https://api.github.com/users/ajsutton/followers",
    "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
    "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
    "organizations_url": "https://api.github.com/users/ajsutton/orgs",
    "repos_url": "https://api.github.com/users/ajsutton/repos",
    "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ajsutton/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/6088/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ConsenSys/teku/issues/6088/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1218634196",
    "html_url": "https://github.com/ConsenSys/teku/issues/6088#issuecomment-1218634196",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/6088",
    "id": 1218634196,
    "node_id": "IC_kwDOCM9I9M5IouHU",
    "user": {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-17T23:22:57Z",
    "updated_at": "2022-08-17T23:22:57Z",
    "author_association": "CONTRIBUTOR",
    "body": "Thanks, we'll look into this. FYI @Nashatyrev though you don't necessarily have to look into it. :)",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1218634196/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1219528692",
    "html_url": "https://github.com/ConsenSys/teku/issues/6088#issuecomment-1219528692",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/6088",
    "id": 1219528692,
    "node_id": "IC_kwDOCM9I9M5IsIf0",
    "user": {
      "login": "Nashatyrev",
      "id": 8173857,
      "node_id": "MDQ6VXNlcjgxNzM4NTc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8173857?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Nashatyrev",
      "html_url": "https://github.com/Nashatyrev",
      "followers_url": "https://api.github.com/users/Nashatyrev/followers",
      "following_url": "https://api.github.com/users/Nashatyrev/following{/other_user}",
      "gists_url": "https://api.github.com/users/Nashatyrev/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Nashatyrev/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Nashatyrev/subscriptions",
      "organizations_url": "https://api.github.com/users/Nashatyrev/orgs",
      "repos_url": "https://api.github.com/users/Nashatyrev/repos",
      "events_url": "https://api.github.com/users/Nashatyrev/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Nashatyrev/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-18T13:58:30Z",
    "updated_at": "2022-08-18T13:58:30Z",
    "author_association": "CONTRIBUTOR",
    "body": "Yep, the same on my side after the update ",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1219528692/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1220038632",
    "html_url": "https://github.com/ConsenSys/teku/issues/6088#issuecomment-1220038632",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/6088",
    "id": 1220038632,
    "node_id": "IC_kwDOCM9I9M5IuE_o",
    "user": {
      "login": "jimmygchen",
      "id": 742762,
      "node_id": "MDQ6VXNlcjc0Mjc2Mg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/742762?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jimmygchen",
      "html_url": "https://github.com/jimmygchen",
      "followers_url": "https://api.github.com/users/jimmygchen/followers",
      "following_url": "https://api.github.com/users/jimmygchen/following{/other_user}",
      "gists_url": "https://api.github.com/users/jimmygchen/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jimmygchen/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jimmygchen/subscriptions",
      "organizations_url": "https://api.github.com/users/jimmygchen/orgs",
      "repos_url": "https://api.github.com/users/jimmygchen/repos",
      "events_url": "https://api.github.com/users/jimmygchen/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jimmygchen/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-18T22:29:22Z",
    "updated_at": "2022-08-19T01:37:49Z",
    "author_association": "CONTRIBUTOR",
    "body": "Running into the same issue as well, got a bit curious and was wondering if it has anything to do with this recent change in [jvm-libp2p](https://github.com/libp2p/jvm-libp2p):\r\n\r\n\r\n`P2PService.kt`\r\n![image](https://user-images.githubusercontent.com/742762/185505423-cc94afcc-fba1-4278-bc58-baa722b8dbd2.png)\r\n\r\n\r\nI'm not familiar with the code but it looks like `stream.getPeerHandler` is called even when steam is closed on initialization, which would always throw due to `peerHandler` not being set, as documented here:\r\n![image](https://user-images.githubusercontent.com/742762/185505896-b303666b-c5dd-4a7a-ab85-e185c36d2710.png)\r\n\r\n\r\nI've raised a PR here, but not sure how to reproduce and test - may need some feedback from someone familiar with the code base:\r\nhttps://github.com/libp2p/jvm-libp2p/pull/254\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1220038632/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1220878585",
    "html_url": "https://github.com/ConsenSys/teku/issues/6088#issuecomment-1220878585",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/6088",
    "id": 1220878585,
    "node_id": "IC_kwDOCM9I9M5IxSD5",
    "user": {
      "login": "Nashatyrev",
      "id": 8173857,
      "node_id": "MDQ6VXNlcjgxNzM4NTc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8173857?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Nashatyrev",
      "html_url": "https://github.com/Nashatyrev",
      "followers_url": "https://api.github.com/users/Nashatyrev/followers",
      "following_url": "https://api.github.com/users/Nashatyrev/following{/other_user}",
      "gists_url": "https://api.github.com/users/Nashatyrev/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Nashatyrev/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Nashatyrev/subscriptions",
      "organizations_url": "https://api.github.com/users/Nashatyrev/orgs",
      "repos_url": "https://api.github.com/users/Nashatyrev/repos",
      "events_url": "https://api.github.com/users/Nashatyrev/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Nashatyrev/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-19T16:40:33Z",
    "updated_at": "2022-08-19T16:40:33Z",
    "author_association": "CONTRIBUTOR",
    "body": "The WARN has gone when running with merged https://github.com/libp2p/jvm-libp2p/pull/254, thanks @jimmygchen !\r\nSo the issue could be closed when the next libp2p version integrated",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1220878585/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 1,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
