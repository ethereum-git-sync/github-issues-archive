{
  "url": "https://api.github.com/repos/Consensys/teku/issues/7814",
  "repository_url": "https://api.github.com/repos/Consensys/teku",
  "labels_url": "https://api.github.com/repos/Consensys/teku/issues/7814/labels{/name}",
  "comments_url": "https://api.github.com/repos/Consensys/teku/issues/7814/comments",
  "events_url": "https://api.github.com/repos/Consensys/teku/issues/7814/events",
  "html_url": "https://github.com/Consensys/teku/issues/7814",
  "id": 2036729662,
  "node_id": "I_kwDOCM9I9M55Zgc-",
  "number": 7814,
  "title": "`/eth/v1/validator/attestation_data` taking a long time to respond",
  "user": {
    "login": "mcdee",
    "id": 511384,
    "node_id": "MDQ6VXNlcjUxMTM4NA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/511384?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mcdee",
    "html_url": "https://github.com/mcdee",
    "followers_url": "https://api.github.com/users/mcdee/followers",
    "following_url": "https://api.github.com/users/mcdee/following{/other_user}",
    "gists_url": "https://api.github.com/users/mcdee/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mcdee/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mcdee/subscriptions",
    "organizations_url": "https://api.github.com/users/mcdee/orgs",
    "repos_url": "https://api.github.com/users/mcdee/repos",
    "events_url": "https://api.github.com/users/mcdee/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mcdee/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1048919129,
      "node_id": "MDU6TGFiZWwxMDQ4OTE5MTI5",
      "url": "https://api.github.com/repos/Consensys/teku/labels/bug%20%F0%9F%90%9E",
      "name": "bug ðŸž",
      "color": "dd6c94",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 1271198478,
      "node_id": "MDU6TGFiZWwxMjcxMTk4NDc4",
      "url": "https://api.github.com/repos/Consensys/teku/labels/performance%20%F0%9F%9A%80",
      "name": "performance ðŸš€",
      "color": "ffcce3",
      "default": false,
      "description": "Improves performance without changing functionality"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2023-12-11T23:53:04Z",
  "updated_at": "2023-12-18T20:46:54Z",
  "closed_at": null,
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "### Description\r\n\r\nTeku takes significantly longer to respond to a request for attestation data made on `/eth/v1/validator/attestation_data` than other beacon nodes.\r\n\r\nA recent example on mainnet showing the time taken to receive attestation data from four different beacon nodes:\r\n\r\n![screenshot_2023-12-11-234627](https://github.com/Consensys/teku/assets/511384/84ac1ba7-fc40-4690-8694-2f7a22f9d7f6)\r\n\r\nThe calls to lighthouse, nimbus and prysm took a few milliseconds, whereas teku took 1-2 orders of magnitude longer.  Given that the attestation data should come directly from head state, this seems like a long time to have to wait for the data.\r\n\r\n**Frequency:** [How regularly does it occur?]\r\n\r\nEvery slot.\r\n\r\n### Versions (Add all that apply)\r\n\r\nteku/v23.10.0/linux-x86_64/-privatebuild-openjdk64bitservervm-java-17",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/Consensys/teku/issues/7814/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/Consensys/teku/issues/7814/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/Consensys/teku/issues/comments/1851105323",
    "html_url": "https://github.com/Consensys/teku/issues/7814#issuecomment-1851105323",
    "issue_url": "https://api.github.com/repos/Consensys/teku/issues/7814",
    "id": 1851105323,
    "node_id": "IC_kwDOCM9I9M5uVaAr",
    "user": {
      "login": "rolfyone",
      "id": 2967240,
      "node_id": "MDQ6VXNlcjI5NjcyNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2967240?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rolfyone",
      "html_url": "https://github.com/rolfyone",
      "followers_url": "https://api.github.com/users/rolfyone/followers",
      "following_url": "https://api.github.com/users/rolfyone/following{/other_user}",
      "gists_url": "https://api.github.com/users/rolfyone/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rolfyone/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rolfyone/subscriptions",
      "organizations_url": "https://api.github.com/users/rolfyone/orgs",
      "repos_url": "https://api.github.com/users/rolfyone/repos",
      "events_url": "https://api.github.com/users/rolfyone/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rolfyone/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-12-12T00:20:34Z",
    "updated_at": "2023-12-12T00:20:34Z",
    "author_association": "CONTRIBUTOR",
    "body": "It's a non trivial process currently because we're making sure fork choice is correct etc, and getting a signed block and state also, but we can run some profiling etc and see if there's improvements.\n\nIs there a specific time vouch is calling for attestation_data? presumably just some time after block arrival... It'd just be helpful if theres specific context that we should investigate.",
    "reactions": {
      "url": "https://api.github.com/repos/Consensys/teku/issues/comments/1851105323/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/Consensys/teku/issues/comments/1851142088",
    "html_url": "https://github.com/Consensys/teku/issues/7814#issuecomment-1851142088",
    "issue_url": "https://api.github.com/repos/Consensys/teku/issues/7814",
    "id": 1851142088,
    "node_id": "IC_kwDOCM9I9M5uVi_I",
    "user": {
      "login": "rolfyone",
      "id": 2967240,
      "node_id": "MDQ6VXNlcjI5NjcyNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2967240?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rolfyone",
      "html_url": "https://github.com/rolfyone",
      "followers_url": "https://api.github.com/users/rolfyone/followers",
      "following_url": "https://api.github.com/users/rolfyone/following{/other_user}",
      "gists_url": "https://api.github.com/users/rolfyone/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rolfyone/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rolfyone/subscriptions",
      "organizations_url": "https://api.github.com/users/rolfyone/orgs",
      "repos_url": "https://api.github.com/users/rolfyone/repos",
      "events_url": "https://api.github.com/users/rolfyone/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rolfyone/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-12-12T01:06:53Z",
    "updated_at": "2023-12-12T01:06:53Z",
    "author_association": "CONTRIBUTOR",
    "body": "I've been able to replicate this if ForkChoice hasn't run already on a block.\nBasically if Im running this query and the block hasn't been imported yet, or fully integrated i guess, then it'll get of the order of 120-160ms to generate attestation data.\nOnce that if i call around 4 seconds once the block has completed (or after seeing the slot line with a block if watching logging), Im getting about 3-8ms...\nI'd expect given that you're consistently seeing this every slot that you might be calling before the block has been imported so it's missing head?",
    "reactions": {
      "url": "https://api.github.com/repos/Consensys/teku/issues/comments/1851142088/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/Consensys/teku/issues/comments/1858944416",
    "html_url": "https://github.com/Consensys/teku/issues/7814#issuecomment-1858944416",
    "issue_url": "https://api.github.com/repos/Consensys/teku/issues/7814",
    "id": 1858944416,
    "node_id": "IC_kwDOCM9I9M5uzT2g",
    "user": {
      "login": "mcdee",
      "id": 511384,
      "node_id": "MDQ6VXNlcjUxMTM4NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/511384?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mcdee",
      "html_url": "https://github.com/mcdee",
      "followers_url": "https://api.github.com/users/mcdee/followers",
      "following_url": "https://api.github.com/users/mcdee/following{/other_user}",
      "gists_url": "https://api.github.com/users/mcdee/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mcdee/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mcdee/subscriptions",
      "organizations_url": "https://api.github.com/users/mcdee/orgs",
      "repos_url": "https://api.github.com/users/mcdee/repos",
      "events_url": "https://api.github.com/users/mcdee/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mcdee/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-12-16T22:31:04Z",
    "updated_at": "2023-12-16T22:31:04Z",
    "author_association": "CONTRIBUTOR",
    "body": "> I'd expect given that you're consistently seeing this every slot that you might be calling before the block has been imported so it's missing head?\r\n\r\nThat's certainly plausible, although there seems to be something missing in this timeline.  We listen to all active beacon nodes for a `head` event.  When we see one, we wait 200ms to allow import on other beacon nodes that may take longer to complete importing the block, and then kick off the attestation process.  From what you say, this should be enough time for the import to complete unless we're seeing large discrepancies on block delivery time.",
    "reactions": {
      "url": "https://api.github.com/repos/Consensys/teku/issues/comments/1858944416/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/Consensys/teku/issues/comments/1861599606",
    "html_url": "https://github.com/Consensys/teku/issues/7814#issuecomment-1861599606",
    "issue_url": "https://api.github.com/repos/Consensys/teku/issues/7814",
    "id": 1861599606,
    "node_id": "IC_kwDOCM9I9M5u9cF2",
    "user": {
      "login": "rolfyone",
      "id": 2967240,
      "node_id": "MDQ6VXNlcjI5NjcyNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2967240?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rolfyone",
      "html_url": "https://github.com/rolfyone",
      "followers_url": "https://api.github.com/users/rolfyone/followers",
      "following_url": "https://api.github.com/users/rolfyone/following{/other_user}",
      "gists_url": "https://api.github.com/users/rolfyone/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rolfyone/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rolfyone/subscriptions",
      "organizations_url": "https://api.github.com/users/rolfyone/orgs",
      "repos_url": "https://api.github.com/users/rolfyone/repos",
      "events_url": "https://api.github.com/users/rolfyone/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rolfyone/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-12-18T20:46:54Z",
    "updated_at": "2023-12-18T20:46:54Z",
    "author_association": "CONTRIBUTOR",
    "body": "Hrm ok, so it'll be doing FcU prior to producing the first attestation still. There's possibly some improvements that would help, will add this to the backlog to consider...\r\n\r\nRe. timings as a workaround, could consider reducing the timeout on teku (if that's easy).\r\n\r\nBasically, we run FcU on block import, and if that has just been done, then another FcU is redundant, so doing it twice in a row is needless overhead. \r\n\r\nIf a block is missed, then the FcU won't have been done, and in that situation it's important that it has been executed correctly still.\r\n\r\nHistorically we automatically promoted the first block without FcU and that was problematic, but flowing on from that we've got a further tweak to attestation production where by we can clean up this FcU if it's already been executed, so i'll mark this as a bug stemming from the fact that we could have removed this when we changed block processing.",
    "reactions": {
      "url": "https://api.github.com/repos/Consensys/teku/issues/comments/1861599606/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
