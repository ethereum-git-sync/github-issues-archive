{
  "url": "https://api.github.com/repos/Consensys/teku/issues/7854",
  "repository_url": "https://api.github.com/repos/Consensys/teku",
  "labels_url": "https://api.github.com/repos/Consensys/teku/issues/7854/labels{/name}",
  "comments_url": "https://api.github.com/repos/Consensys/teku/issues/7854/comments",
  "events_url": "https://api.github.com/repos/Consensys/teku/issues/7854/events",
  "html_url": "https://github.com/Consensys/teku/issues/7854",
  "id": 2060923175,
  "node_id": "I_kwDOCM9I9M561zEn",
  "number": 7854,
  "title": "Teku 23.12.0 crashes on stop after ~2 weeks of uptime",
  "user": {
    "login": "daichuanwu21",
    "id": 109904112,
    "node_id": "U_kgDOBo0A8A",
    "avatar_url": "https://avatars.githubusercontent.com/u/109904112?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/daichuanwu21",
    "html_url": "https://github.com/daichuanwu21",
    "followers_url": "https://api.github.com/users/daichuanwu21/followers",
    "following_url": "https://api.github.com/users/daichuanwu21/following{/other_user}",
    "gists_url": "https://api.github.com/users/daichuanwu21/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/daichuanwu21/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/daichuanwu21/subscriptions",
    "organizations_url": "https://api.github.com/users/daichuanwu21/orgs",
    "repos_url": "https://api.github.com/users/daichuanwu21/repos",
    "events_url": "https://api.github.com/users/daichuanwu21/events{/privacy}",
    "received_events_url": "https://api.github.com/users/daichuanwu21/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 0,
  "created_at": "2023-12-31T03:17:36Z",
  "updated_at": "2023-12-31T03:17:36Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Description\r\nStopping the Teku client version 23.12.0 after more than 1 week of uptime can sometimes result in a coredump.\r\n\r\n```\r\nDec 31 12:20:51 server teku[791]: 2023-12-31 12:20:51.217 WARN  - Late Block Import *** Block: 1b2655b70cc030e8e62a50203882741e7b1d7daf1d55ce6182f5f145ac74181e (8097102) proposer 431381 arrival 1987ms, gossip_validation +7ms, pre-state_retrieved +3ms, processed +196ms, execution_payload_result_received +1877ms, begin_importing +137ms, transaction_prepared +0ms, transaction_committed +0ms, completed +10ms\r\nDec 31 12:21:03 server teku[791]: 2023-12-31 12:21:03.145 INFO  - Slot Event  *** Slot: 8097103, Block: a4a8715df7cfacd086b6f21e52b2a52e6984e8809a6cf0cd36aebf26aa87aa81, Justified: 253033, Finalized: 253032, Peers: 256\r\nDec 31 12:21:15 server teku[791]: 2023-12-31 12:21:15.157 INFO  - Slot Event  *** Slot: 8097104, Block: 744c2562569360b62032578980cde7c17257774b3d5e0c1e006612fcab3e3fde, Justified: 253033, Finalized: 253032, Peers: 257\r\nDec 31 12:21:15 server teku[791]: 2023-12-31 12:21:15.161 INFO  - Validator   *** Published attestation        Count: 2, Slot: 8097104, Root: 744c2562569360b62032578980cde7c17257774b3d5e0c1e006612fcab3e3fde\r\nDec 31 12:21:27 server teku[791]: 2023-12-31 12:21:27.137 INFO  - Slot Event  *** Slot: 8097105, Block: ed73685be227fb9e3e04d6e4f278bc7f4e49018900624241dc1b714d24fc6a70, Justified: 253033, Finalized: 253032, Peers: 256\r\nDec 31 12:21:36 server systemd[1]: Stopping Teku Consensus Layer Client service...\r\nDec 31 12:21:36 server teku[791]: Teku is shutting down\r\nDec 31 12:21:36 server teku[791]: 2023-12-31 12:21:36.649 INFO  - Stopping Javalin ...\r\nDec 31 12:21:36 server teku[791]: 2023-12-31 12:21:36.661 INFO  - Stopped Server@4d629976{STOPPING}[11.0.17,sto=0]\r\nDec 31 12:21:36 server teku[791]: #\r\nDec 31 12:21:36 server teku[791]: # A fatal error has been detected by the Java Runtime Environment:\r\nDec 31 12:21:36 server teku[791]: #\r\nDec 31 12:21:36 server teku[791]: #  SIGSEGV (0xb) at pc=0x00007fcd450ec2dc, pid=791, tid=1361266\r\nDec 31 12:21:36 server teku[791]: #\r\nDec 31 12:21:36 server teku[791]: # JRE version: OpenJDK Runtime Environment Zulu17.46+19-CA (17.0.9+8) (build 17.0.9+8-LTS)\r\nDec 31 12:21:36 server teku[791]: # Java VM: OpenJDK 64-Bit Server VM Zulu17.46+19-CA (17.0.9+8-LTS, mixed mode, sharing, tiered, compressed oops, compressed class ptrs, g1 gc, linux-amd64)\r\nDec 31 12:21:36 server teku[791]: # Problematic frame:\r\nDec 31 12:21:36 server teku[791]: # C  [libleveldbjni.so+0x502dc]\r\nDec 31 12:21:36 server teku[791]: #\r\nDec 31 12:21:36 server teku[791]: # Core dump will be written. Default location: Core dumps may be processed with \"/usr/lib/systemd/systemd-coredump %P %u %g %s %t %c %h\" (or dumping to //core.791)\r\nDec 31 12:21:36 server teku[791]: #\r\nDec 31 12:21:36 server teku[791]: # An error report file with more information is saved as:\r\nDec 31 12:21:36 server teku[791]: # /var/opt/ethereum/teku/hs_err_pidteku.log\r\nDec 31 12:21:36 server teku[791]: 2023-12-31 12:21:36.778 INFO  - Stopped ServerConnector@312a2402{HTTP/1.1, (http/1.1)}{127.0.0.1:5051}\r\nDec 31 12:21:36 server teku[791]: 2023-12-31 12:21:36.831 INFO  - Stopped i.j.j.@463669fb{/,null,STOPPED}\r\nDec 31 12:21:36 server teku[791]: #\r\nDec 31 12:21:36 server teku[791]: # If you would like to submit a bug report, please visit:\r\nDec 31 12:21:36 server teku[791]: #   http://www.azul.com/support/\r\nDec 31 12:21:36 server teku[791]: # The crash happened outside the Java Virtual Machine in native code.\r\nDec 31 12:21:36 server teku[791]: # See problematic frame for where to report the bug.\r\nDec 31 12:21:36 server teku[791]: #\r\nDec 31 12:21:36 server systemd-coredump[1361301]: Process 791 (java) of user 980 dumped core.\r\nDec 31 12:21:37 server systemd[1]: teku.service: Main process exited, code=dumped, status=6/ABRT\r\nDec 31 12:21:37 server systemd[1]: teku.service: Failed with result 'core-dump'.\r\nDec 31 12:21:37 server systemd[1]: Stopped Teku Consensus Layer Client service.\r\nDec 31 12:21:37 server systemd[1]: teku.service: Consumed 2w 4d 9h 35min 26.261s CPU time.\r\n```\r\n\r\nThe uptime for Teku in this case was actually 2w 3d 22h 47min 39.514s, a little lower than the consumed CPU time systemd is reporting in the logs.\r\n\r\nSince it seems like a database issue, I've checked the SMART logs on my SSD and found that it claims to have had no read failures so far. Just in case its worth mentioning, the underlying filesystem Teku is running on is XFS, and my kernel version is `5.14.0-362.13.1.el9_3.x86_64`.\r\n\r\n### Steps to Reproduce (Bug)\r\nI am running the Teku client through systemd with 5G of memory allocated. I've also configured it to use jemalloc 5.2.1 through LD_PRELOAD.\r\n\r\n**Expected behavior:**\r\nTeku shuts down without reporting any errors or crashing.\r\n\r\n**Actual behavior:**\r\nTeku crashes complaining about what appears to be an issue with the database library.\r\n\r\n**Frequency:**\r\nVery rare. I've never seen Teku crash like this on shutdown through 6 months of upgrades.\r\n\r\n### Versions (Add all that apply)\r\n* Software version: `teku/v23.12.0/linux-x86_64/zulu-java-17`\r\n* Java version:\r\n```\r\nopenjdk 17.0.9 2023-10-17 LTS\r\nOpenJDK Runtime Environment Zulu17.46+19-CA (build 17.0.9+8-LTS)\r\nOpenJDK 64-Bit Server VM Zulu17.46+19-CA (build 17.0.9+8-LTS, mixed mode, sharing)\r\n```\r\n* OS Name & Version:\r\n```\r\nNAME=\"Red Hat Enterprise Linux\"\r\nVERSION=\"9.3 (Plow)\"\r\nID=\"rhel\"\r\nID_LIKE=\"fedora\"\r\nVERSION_ID=\"9.3\"\r\nPLATFORM_ID=\"platform:el9\"\r\nPRETTY_NAME=\"Red Hat Enterprise Linux 9.3 (Plow)\"\r\nANSI_COLOR=\"0;31\"\r\nLOGO=\"fedora-logo-icon\"\r\nCPE_NAME=\"cpe:/o:redhat:enterprise_linux:9::baseos\"\r\nHOME_URL=\"https://www.redhat.com/\"\r\nDOCUMENTATION_URL=\"https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9\"\r\nBUG_REPORT_URL=\"https://bugzilla.redhat.com/\"\r\n\r\nREDHAT_BUGZILLA_PRODUCT=\"Red Hat Enterprise Linux 9\"\r\nREDHAT_BUGZILLA_PRODUCT_VERSION=9.3\r\nREDHAT_SUPPORT_PRODUCT=\"Red Hat Enterprise Linux\"\r\nREDHAT_SUPPORT_PRODUCT_VERSION=\"9.3\"\r\nRed Hat Enterprise Linux release 9.3 (Plow)\r\nRed Hat Enterprise Linux release 9.3 (Plow)\r\n```\r\n* Docker Version: N/A\r\n* Bare metal (my own hardware)\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/Consensys/teku/issues/7854/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/Consensys/teku/issues/7854/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[

]
