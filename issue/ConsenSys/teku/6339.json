{
  "url": "https://api.github.com/repos/ConsenSys/teku/issues/6339",
  "repository_url": "https://api.github.com/repos/ConsenSys/teku",
  "labels_url": "https://api.github.com/repos/ConsenSys/teku/issues/6339/labels{/name}",
  "comments_url": "https://api.github.com/repos/ConsenSys/teku/issues/6339/comments",
  "events_url": "https://api.github.com/repos/ConsenSys/teku/issues/6339/events",
  "html_url": "https://github.com/ConsenSys/teku/issues/6339",
  "id": 1422602901,
  "node_id": "I_kwDOCM9I9M5UyzKV",
  "number": 6339,
  "title": "Could not find latest valid execution payload hash (0x0..0) in the non-finalized chain. Optimistic sync may have finalized an invalid transition block.",
  "user": {
    "login": "q9f",
    "id": 58883403,
    "node_id": "MDQ6VXNlcjU4ODgzNDAz",
    "avatar_url": "https://avatars.githubusercontent.com/u/58883403?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/q9f",
    "html_url": "https://github.com/q9f",
    "followers_url": "https://api.github.com/users/q9f/followers",
    "following_url": "https://api.github.com/users/q9f/following{/other_user}",
    "gists_url": "https://api.github.com/users/q9f/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/q9f/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/q9f/subscriptions",
    "organizations_url": "https://api.github.com/users/q9f/orgs",
    "repos_url": "https://api.github.com/users/q9f/repos",
    "events_url": "https://api.github.com/users/q9f/events{/privacy}",
    "received_events_url": "https://api.github.com/users/q9f/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2022-10-25T14:53:07Z",
  "updated_at": "2022-10-27T12:08:29Z",
  "closed_at": "2022-10-27T12:08:28Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "My Prater sync using Teku is stuck in a loop. Might be this: #6069\r\n\r\n### Description\r\n\r\nI get the following error for every slot on Prater at a rate of circa 10+ per second:\r\n\r\n```\r\n2022-10-25 16:48:18.241 WARN  - Payload for block root 0x9af371058b6ffb37568523396a059950268d5442e7a21b0422745e781536c749 was invalid\r\n2022-10-25 16:48:18.241 ERROR - Could not find latest valid execution payload hash (0x0000000000000000000000000000000000000000000000000000000000000000) in the non-finalized chain. Optimistic sync may have finalized an invalid transition bl\r\nock.                                                                                                                                                                                                                                           \r\n2022-10-25 16:48:18.242 ERROR - PLEASE FIX OR REPORT | Unexpected exception thrown for forkchoice-async-0                                                                                                                                      \r\njava.util.concurrent.CompletionException: java.lang.IllegalStateException: Cannot change node validity from VALID to INVALID\r\nat java.util.concurrent.CompletableFuture.encodeThrowable(CompletableFuture.java:314) ~[?:?]\r\nat java.util.concurrent.CompletableFuture.completeThrowable(CompletableFuture.java:319) ~[?:?]                                                                                                                                                 \r\nat java.util.concurrent.CompletableFuture.uniHandle(CompletableFuture.java:932) ~[?:?]                                                                                                                                                         at java.util.concurrent.CompletableFuture$UniHandle.tryFire(CompletableFuture.java:907) ~[?:?]\r\nat java.util.concurrent.CompletableFuture$Completion.run(CompletableFuture.java:478) ~[?:?]              \r\nat tech.pegasys.teku.infrastructure.async.eventthread.AsyncRunnerEventThread.lambda$asSupplier$2(AsyncRunnerEventThread.java:139) ~[teku-infrastructure-async-22.9.1.jar:22.9.1]\r\nat tech.pegasys.teku.infrastructure.async.eventthread.AsyncRunnerEventThread.recordEventThreadIdAndExecute(AsyncRunnerEventThread.java:130) ~[teku-infrastructure-async-22.9.1.jar:22.9.1]\r\nat tech.pegasys.teku.infrastructure.async.eventthread.AsyncRunnerEventThread.lambda$doExecute$1(AsyncRunnerEventThread.java:113) ~[teku-infrastructure-async-22.9.1.jar:22.9.1]\r\nat tech.pegasys.teku.infrastructure.async.SafeFuture.of(SafeFuture.java:81) ~[teku-infrastructure-async-22.9.1.jar:22.9.1]\r\nat tech.pegasys.teku.infrastructure.async.AsyncRunner.lambda$runAsync$2(AsyncRunner.java:47) ~[teku-infrastructure-async-22.9.1.jar:22.9.1]\r\nat tech.pegasys.teku.infrastructure.async.SafeFuture.of(SafeFuture.java:73) ~[teku-infrastructure-async-22.9.1.jar:22.9.1]\r\nat tech.pegasys.teku.infrastructure.async.ScheduledExecutorAsyncRunner.lambda$createRunnableForAction$1(ScheduledExecutorAsyncRunner.java:119) ~[teku-infrastructure-async-22.9.1.jar:22.9.1]\r\nat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) ~[?:?]                                                                                                                                                      \r\nat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) ~[?:?]                                                                                                                                                      \r\nat java.lang.Thread.run(Thread.java:829) ~[?:?]                                                                                                                                                                                                \r\nCaused by: java.lang.IllegalStateException: Cannot change node validity from VALID to INVALID                                                                                                                                                  \r\nat com.google.common.base.Preconditions.checkState(Preconditions.java:821) ~[guava-31.1-jre.jar:?]                                                                                                                                             \r\nat tech.pegasys.teku.storage.protoarray.ProtoNode.setValidationStatus(ProtoNode.java:181) ~[teku-storage-22.9.1.jar:22.9.1]                                                                  \r\nat tech.pegasys.teku.storage.protoarray.ProtoArray.markNodeInvalid(ProtoArray.java:346) ~[teku-storage-22.9.1.jar:22.9.1]\r\nat tech.pegasys.teku.storage.protoarray.ProtoArray.markNodeInvalid(ProtoArray.java:293) ~[teku-storage-22.9.1.jar:22.9.1]\r\nat tech.pegasys.teku.storage.protoarray.ForkChoiceStrategy.onExecutionPayloadResult(ForkChoiceStrategy.java:556) ~[teku-storage-22.9.1.jar:22.9.1]\r\nat tech.pegasys.teku.statetransition.forkchoice.ForkChoice.lambda$onExecutionPayloadResult$15(ForkChoice.java:445) ~[teku-ethereum-statetransition-22.9.1.jar:22.9.1]\r\nat tech.pegasys.teku.infrastructure.async.SafeFuture.lambda$finishAsync$29(SafeFuture.java:372) ~[teku-infrastructure-async-22.9.1.jar:22.9.1]\r\nat java.util.concurrent.CompletableFuture.uniHandle(CompletableFuture.java:930) ~[?:?]                                                                                                                                                         \r\n... 12 more                                         \r\n```\r\n\r\nRecording: https://asciinema.org/a/qbxF81SbzscEsDxRvCGFl3IB9\r\n\r\n### Steps to Reproduce (Bug)\r\n\r\n1. Do a fresh, full sync of the Prater beacon chain.\r\n2. Unsure what happens, but get stuck in this loop: `Payload for block root 0x.. was invalid`\r\n\r\nConfig:\r\n\r\n```bash\r\nteku \\\r\n--network=\"goerli\" \\\r\n--data-path=\"/home/user/.local/share/teku\" \\\r\n--ee-endpoint=\"http://127.0.0.1:8550\" \\\r\n--ee-jwt-secret-file=\"/home/user/.ethereum/jwtsecret.hex\" \\\r\n--eth1-endpoint=\"http://127.0.0.1:8545\" \\\r\n--rest-api-enabled=true \\\r\n--validators-graffiti=\"Goerli Wezen @q9f Teku\" \\\r\n--validators-proposer-default-fee-recipient=\"0xe0a2Bd4258D2768837BAa26A28fE71Dc079f84c7\" \\\r\n--metrics-enabled=true \\\r\n--log-destination=\"CONSOLE\"\r\n```\r\n\r\nExecution engine is Besu `22.7.7`.\r\n\r\n**Expected behavior:** Should sync to head\r\n\r\n**Actual behavior:** Gets stuck in an error loop\r\n\r\n**Frequency:** (1?) This was a fresh sync. I don't want to resync again.\r\n\r\n### Versions (Add all that apply)\r\n* Software version: `teku/v22.9.1/linux-x86_64/oracle_openjdk-java-11`\r\n* Java version: `javac 11.0.17`\r\n* OS Name & Version: `NAME=\"Arch Linux\"`\r\n",
  "closed_by": {
    "login": "q9f",
    "id": 58883403,
    "node_id": "MDQ6VXNlcjU4ODgzNDAz",
    "avatar_url": "https://avatars.githubusercontent.com/u/58883403?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/q9f",
    "html_url": "https://github.com/q9f",
    "followers_url": "https://api.github.com/users/q9f/followers",
    "following_url": "https://api.github.com/users/q9f/following{/other_user}",
    "gists_url": "https://api.github.com/users/q9f/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/q9f/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/q9f/subscriptions",
    "organizations_url": "https://api.github.com/users/q9f/orgs",
    "repos_url": "https://api.github.com/users/q9f/repos",
    "events_url": "https://api.github.com/users/q9f/events{/privacy}",
    "received_events_url": "https://api.github.com/users/q9f/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/6339/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ConsenSys/teku/issues/6339/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1292729193",
    "html_url": "https://github.com/ConsenSys/teku/issues/6339#issuecomment-1292729193",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/6339",
    "id": 1292729193,
    "node_id": "IC_kwDOCM9I9M5NDXtp",
    "user": {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-10-26T22:24:25Z",
    "updated_at": "2022-10-26T22:24:25Z",
    "author_association": "CONTRIBUTOR",
    "body": "This indicates a bug in the execution client where it has reported a block as both VALID and then later INVALID which isn't possible. It's also reporting that the transition block was invalid which isn't the case on prater.\n\nThere's not really anything Teku can do in this situation - it's getting rubbish responses from the EL and is doing its best to protect itself by rejecting transitions that don't make sense. Ultimately the EL needs to be fixed to give consistent responses.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1292729193/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1293430643",
    "html_url": "https://github.com/ConsenSys/teku/issues/6339#issuecomment-1293430643",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/6339",
    "id": 1293430643,
    "node_id": "IC_kwDOCM9I9M5NGC9z",
    "user": {
      "login": "q9f",
      "id": 58883403,
      "node_id": "MDQ6VXNlcjU4ODgzNDAz",
      "avatar_url": "https://avatars.githubusercontent.com/u/58883403?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/q9f",
      "html_url": "https://github.com/q9f",
      "followers_url": "https://api.github.com/users/q9f/followers",
      "following_url": "https://api.github.com/users/q9f/following{/other_user}",
      "gists_url": "https://api.github.com/users/q9f/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/q9f/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/q9f/subscriptions",
      "organizations_url": "https://api.github.com/users/q9f/orgs",
      "repos_url": "https://api.github.com/users/q9f/repos",
      "events_url": "https://api.github.com/users/q9f/events{/privacy}",
      "received_events_url": "https://api.github.com/users/q9f/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-10-27T12:08:28Z",
    "updated_at": "2022-10-27T12:08:28Z",
    "author_association": "CONTRIBUTOR",
    "body": "Ok, I will try to reset my setup. Thanks!",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1293430643/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
