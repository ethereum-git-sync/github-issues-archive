{
  "url": "https://api.github.com/repos/ConsenSys/teku/issues/5160",
  "repository_url": "https://api.github.com/repos/ConsenSys/teku",
  "labels_url": "https://api.github.com/repos/ConsenSys/teku/issues/5160/labels{/name}",
  "comments_url": "https://api.github.com/repos/ConsenSys/teku/issues/5160/comments",
  "events_url": "https://api.github.com/repos/ConsenSys/teku/issues/5160/events",
  "html_url": "https://github.com/ConsenSys/teku/issues/5160",
  "id": 1165909578,
  "node_id": "I_kwDOCM9I9M5Ffl5K",
  "number": 5160,
  "title": "[Merge] Generate a new JWT Auth token prior to expriy",
  "user": {
    "login": "ajsutton",
    "id": 72675,
    "node_id": "MDQ6VXNlcjcyNjc1",
    "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ajsutton",
    "html_url": "https://github.com/ajsutton",
    "followers_url": "https://api.github.com/users/ajsutton/followers",
    "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
    "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
    "organizations_url": "https://api.github.com/users/ajsutton/orgs",
    "repos_url": "https://api.github.com/users/ajsutton/repos",
    "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ajsutton/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2022-03-11T01:51:55Z",
  "updated_at": "2022-03-27T22:23:04Z",
  "closed_at": "2022-03-27T22:23:04Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "### Description\nCurrently teku uses the existing JWT Auth token for the execution Engine API right up until it expires. This means it may have expired by the time it reaches the EL and has no tolerance for clock skew. We should generate a new token a couple of seconds prior to the previous one expiring.",
  "closed_by": {
    "login": "ajsutton",
    "id": 72675,
    "node_id": "MDQ6VXNlcjcyNjc1",
    "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ajsutton",
    "html_url": "https://github.com/ajsutton",
    "followers_url": "https://api.github.com/users/ajsutton/followers",
    "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
    "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
    "organizations_url": "https://api.github.com/users/ajsutton/orgs",
    "repos_url": "https://api.github.com/users/ajsutton/repos",
    "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ajsutton/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/5160/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ConsenSys/teku/issues/5160/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1078042957",
    "html_url": "https://github.com/ConsenSys/teku/issues/5160#issuecomment-1078042957",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/5160",
    "id": 1078042957,
    "node_id": "IC_kwDOCM9I9M5AQaFN",
    "user": {
      "login": "zilm13",
      "id": 6196452,
      "node_id": "MDQ6VXNlcjYxOTY0NTI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6196452?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/zilm13",
      "html_url": "https://github.com/zilm13",
      "followers_url": "https://api.github.com/users/zilm13/followers",
      "following_url": "https://api.github.com/users/zilm13/following{/other_user}",
      "gists_url": "https://api.github.com/users/zilm13/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/zilm13/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/zilm13/subscriptions",
      "organizations_url": "https://api.github.com/users/zilm13/orgs",
      "repos_url": "https://api.github.com/users/zilm13/repos",
      "events_url": "https://api.github.com/users/zilm13/events{/privacy}",
      "received_events_url": "https://api.github.com/users/zilm13/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-03-24T19:40:51Z",
    "updated_at": "2022-03-24T19:45:19Z",
    "author_association": "CONTRIBUTOR",
    "body": "It looks a bit strange for me.\r\nWe have an expiration of 5 seconds\r\nhttps://github.com/ConsenSys/teku/blob/6e940dedce3b3cddb7da306afb6f7271c2425833/ethereum/executionlayer/src/main/java/tech/pegasys/teku/ethereum/executionlayer/client/auth/JwtConfig.java#L19\r\nand we are setting token issuance for the current time + expiration delta, not expiration\r\nhttps://github.com/ConsenSys/teku/blob/9501d743e9b0fabb35f2f30b1960e1dc952d3300/ethereum/executionlayer/src/main/java/tech/pegasys/teku/ethereum/executionlayer/client/auth/TokenProvider.java#L36\r\nFrom my perspective it should be, say, 5 minutes token (so it would make a sense to update it a few seconds before, not 2-3 seconds after it's issued) and we should set its expiration to the correct number. If my understanding is correct, I could make a PR",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1078042957/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1078618814",
    "html_url": "https://github.com/ConsenSys/teku/issues/5160#issuecomment-1078618814",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/5160",
    "id": 1078618814,
    "node_id": "IC_kwDOCM9I9M5ASmq-",
    "user": {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-03-25T03:29:40Z",
    "updated_at": "2022-03-25T03:29:40Z",
    "author_association": "CONTRIBUTOR",
    "body": "We're correct in setting the issued at (`iat`) and not expiry in the token but I think you're right that we should be setting it to the current time not now + expiry.  So that `.setIssuedAt` line should be `.setIssuedAt(Date.from(Instant.ofEpochMilli(instantInMillis.longValue())))`.\r\n\r\nThat error actually explains why we're not seeing timed out JWT tokens more often because the EL will accept the token up to 5 seconds before or after the IAT (https://github.com/ethereum/execution-apis/blob/main/src/engine/authentication.md). So we're starting to use it at the first moment it's viable and stopping 5 seconds before it expires.\r\n\r\nWhen we fix this we'll need to ensure we stop using the token a couple of seconds before the expiry (ie use it at most 3s after iat). Probably the easiest way to do that is to just reduce the `JwtConfig.EXPIRES_IN_SECONDS` to 3 since it isn't used by the actual JWT token but controls when we stop using it.  The EL will continue to recognise the JWT up to 5 seconds after IAT so we then have a 2 second buffer.\r\n\r\nThe EL is not required to support an expiry in the JWT so we can't set that to 5 minutes.  The idea is that the JWT isn't valid for long to minimise the impact if it's leaked (e.g. if it's included in logs that the user then posts publicly while asking for support those tokens would already be invalid).",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1078618814/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1079419966",
    "html_url": "https://github.com/ConsenSys/teku/issues/5160#issuecomment-1079419966",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/5160",
    "id": 1079419966,
    "node_id": "IC_kwDOCM9I9M5AVqQ-",
    "user": {
      "login": "zilm13",
      "id": 6196452,
      "node_id": "MDQ6VXNlcjYxOTY0NTI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6196452?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/zilm13",
      "html_url": "https://github.com/zilm13",
      "followers_url": "https://api.github.com/users/zilm13/followers",
      "following_url": "https://api.github.com/users/zilm13/following{/other_user}",
      "gists_url": "https://api.github.com/users/zilm13/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/zilm13/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/zilm13/subscriptions",
      "organizations_url": "https://api.github.com/users/zilm13/orgs",
      "repos_url": "https://api.github.com/users/zilm13/repos",
      "events_url": "https://api.github.com/users/zilm13/events{/privacy}",
      "received_events_url": "https://api.github.com/users/zilm13/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-03-25T20:43:08Z",
    "updated_at": "2022-03-25T20:43:08Z",
    "author_association": "CONTRIBUTOR",
    "body": "@ajsutton yeah but if EL has slightly smaller current time than CL, any token will fail with current bug",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1079419966/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1079421124",
    "html_url": "https://github.com/ConsenSys/teku/issues/5160#issuecomment-1079421124",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/5160",
    "id": 1079421124,
    "node_id": "IC_kwDOCM9I9M5AVqjE",
    "user": {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-03-25T20:45:01Z",
    "updated_at": "2022-03-25T20:45:01Z",
    "author_association": "CONTRIBUTOR",
    "body": "Yes agreed though that's less likely since we generate then send. ",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1079421124/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
