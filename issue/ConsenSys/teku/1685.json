{
  "url": "https://api.github.com/repos/ConsenSys/teku/issues/1685",
  "repository_url": "https://api.github.com/repos/ConsenSys/teku",
  "labels_url": "https://api.github.com/repos/ConsenSys/teku/issues/1685/labels{/name}",
  "comments_url": "https://api.github.com/repos/ConsenSys/teku/issues/1685/comments",
  "events_url": "https://api.github.com/repos/ConsenSys/teku/issues/1685/events",
  "html_url": "https://github.com/ConsenSys/teku/issues/1685",
  "id": 608130192,
  "node_id": "MDU6SXNzdWU2MDgxMzAxOTI=",
  "number": 1685,
  "title": "[crash/fuzzing] \"java.lang.IndexOutOfBoundsException: index (0) must be less than size (0)\" during block ssz parsing",
  "user": {
    "login": "pventuzelo",
    "id": 9038181,
    "node_id": "MDQ6VXNlcjkwMzgxODE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/9038181?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/pventuzelo",
    "html_url": "https://github.com/pventuzelo",
    "followers_url": "https://api.github.com/users/pventuzelo/followers",
    "following_url": "https://api.github.com/users/pventuzelo/following{/other_user}",
    "gists_url": "https://api.github.com/users/pventuzelo/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/pventuzelo/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/pventuzelo/subscriptions",
    "organizations_url": "https://api.github.com/users/pventuzelo/orgs",
    "repos_url": "https://api.github.com/users/pventuzelo/repos",
    "events_url": "https://api.github.com/users/pventuzelo/events{/privacy}",
    "received_events_url": "https://api.github.com/users/pventuzelo/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2020-04-28T08:36:21Z",
  "updated_at": "2020-04-29T19:45:13Z",
  "closed_at": "2020-04-29T19:45:13Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Description\r\n\r\nDuring fuzzing with [beacon-fuzz](https://github.com/sigp/beacon-fuzz), I triggered an `java.lang.IndexOutOfBoundsException: index (0) must be less than size (0)` during block SSZ parsing using `teku transition blocks` tool.\r\n\r\n** bug come from `bits.getBit(i)` line 121**\r\n\r\n### Additional info\r\n\r\nlighthouse detects this bug and returns:\r\n```\r\nFailed to transition blocks: Failed to advance slot on iteration 95: EpochProcessingError(BeaconStateError(InvalidBitfield))\r\n```\r\n\r\n### Related code:\r\n\r\nhttps://github.com/PegaSysEng/teku/blob/f79f65fdc23414dd08d2e0c5d93211df3fa52665/ethereum/datastructures/src/main/java/tech/pegasys/artemis/datastructures/util/AttestationUtil.java#L114-L124\r\n\r\n### Steps to Reproduce (Bug)\r\n\r\n- Download: [index_less_size_oob_teku.zip](https://github.com/PegaSysEng/teku/files/4544345/index_less_size_oob_teku.zip)\r\n\r\n\r\n- Crash:\r\n``` sh\r\n# install\r\n./gradlew distTar installDist\r\n\r\n# go to build folder\r\ncd build/install/\r\n\r\n# Run teku\r\nbin/teku transition blocks --pre=index_less_size_oob_state_teku.ssz --network=mainnet index_less_size_oob_block_teku.ssz\r\njava.lang.IndexOutOfBoundsException: index (0) must be less than size (0)\r\n\tat com.google.common.base.Preconditions.checkElementIndex(Preconditions.java:1345)\r\n\tat com.google.common.base.Preconditions.checkElementIndex(Preconditions.java:1327)\r\n\tat tech.pegasys.artemis.ssz.SSZTypes.Bitlist.getBit(Bitlist.java:55)\r\n\tat tech.pegasys.artemis.datastructures.util.AttestationUtil.get_attesting_indices(AttestationUtil.java:121)\r\n\tat tech.pegasys.artemis.core.EpochProcessorUtil.get_unslashed_attesting_indices(EpochProcessorUtil.java:165)\r\n\tat tech.pegasys.artemis.core.EpochProcessorUtil.get_unslashed_attesting_indices(EpochProcessorUtil.java:156)\r\n\tat tech.pegasys.artemis.core.EpochProcessorUtil.get_attesting_balance(EpochProcessorUtil.java:186)\r\n\tat tech.pegasys.artemis.core.EpochProcessorUtil.process_justification_and_finalization(EpochProcessorUtil.java:227)\r\n\tat tech.pegasys.artemis.core.StateTransition.lambda$process_epoch$1(StateTransition.java:145)\r\n\tat tech.pegasys.artemis.datastructures.state.BeaconStateImpl.updated(BeaconStateImpl.java:273)\r\n\tat tech.pegasys.artemis.core.StateTransition.process_epoch(StateTransition.java:142)\r\n\tat tech.pegasys.artemis.core.StateTransition.process_slots(StateTransition.java:215)\r\n\tat tech.pegasys.artemis.core.StateTransition.initiate(StateTransition.java:94)\r\n\tat tech.pegasys.artemis.core.StateTransition.initiate(StateTransition.java:72)\r\n\tat tech.pegasys.artemis.cli.subcommand.TransitionCommand.lambda$blocks$0(TransitionCommand.java:82)\r\n\tat tech.pegasys.artemis.cli.subcommand.TransitionCommand.processStateTransition(TransitionCommand.java:131)\r\n\tat tech.pegasys.artemis.cli.subcommand.TransitionCommand.blocks(TransitionCommand.java:76)\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\r\n\tat java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n\tat java.base/java.lang.reflect.Method.invoke(Method.java:566)\r\n\tat picocli.CommandLine.executeUserObject(CommandLine.java:1802)\r\n\tat picocli.CommandLine.access$900(CommandLine.java:145)\r\n\tat picocli.CommandLine$RunLast.executeUserObjectOfLastSubcommandWithSameParent(CommandLine.java:2150)\r\n\tat picocli.CommandLine$RunLast.handle(CommandLine.java:2144)\r\n\tat picocli.CommandLine$RunLast.handle(CommandLine.java:2108)\r\n\tat picocli.CommandLine$AbstractParseResultHandler.execute(CommandLine.java:1975)\r\n\tat picocli.CommandLine.execute(CommandLine.java:1904)\r\n\tat tech.pegasys.artemis.cli.BeaconNodeCommand.parse(BeaconNodeCommand.java:185)\r\n\tat tech.pegasys.artemis.Artemis.main(Artemis.java:31)\r\n\r\n```\r\n\r\n### Versions\r\n* Github branch: `master`\r\n* Github commit: 1cc346671521a4381776bb9145af1be3b290fe8b\r\n* Java version: `openjdk version \"11.0.7\" 2020-04-14`\r\n* OS Name & Version: `Ubuntu 18.04.4 LTS`\r\n* Kernel Version: `4.15.0-96-generic`\r\n",
  "closed_by": {
    "login": "ajsutton",
    "id": 72675,
    "node_id": "MDQ6VXNlcjcyNjc1",
    "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ajsutton",
    "html_url": "https://github.com/ajsutton",
    "followers_url": "https://api.github.com/users/ajsutton/followers",
    "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
    "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
    "organizations_url": "https://api.github.com/users/ajsutton/orgs",
    "repos_url": "https://api.github.com/users/ajsutton/repos",
    "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ajsutton/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/1685/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ConsenSys/teku/issues/1685/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/620977116",
    "html_url": "https://github.com/ConsenSys/teku/issues/1685#issuecomment-620977116",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/1685",
    "id": 620977116,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyMDk3NzExNg==",
    "user": {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-04-29T04:01:16Z",
    "updated_at": "2020-04-29T04:01:16Z",
    "author_association": "CONTRIBUTOR",
    "body": "The SSZ in this case is valid, but the initial state contains pending attestations where the aggregation bits size is less than the committee size.  The transition subcommand doesn't do any validation on the input state so I wouldn't expect it to detect that.  In a running Teku the `IndexOutOfBoundsException` is caught and the bock import would fail but it does highlight some areas lacking validation around ensuring that the aggregation bit size matches the committee size.  Block import does it, fork choice required it to be at least as big but gossip validation missed it.\r\n\r\nI've tidied that up, but my reading of the fork choice spec suggests that it misses this case as well and never validates that the attestation's aggregation bits matches the committee size.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/620977116/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
