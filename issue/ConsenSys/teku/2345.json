{
  "url": "https://api.github.com/repos/ConsenSys/teku/issues/2345",
  "repository_url": "https://api.github.com/repos/ConsenSys/teku",
  "labels_url": "https://api.github.com/repos/ConsenSys/teku/issues/2345/labels{/name}",
  "comments_url": "https://api.github.com/repos/ConsenSys/teku/issues/2345/comments",
  "events_url": "https://api.github.com/repos/ConsenSys/teku/issues/2345/events",
  "html_url": "https://github.com/ConsenSys/teku/issues/2345",
  "id": 655516828,
  "node_id": "MDU6SXNzdWU2NTU1MTY4Mjg=",
  "number": 2345,
  "title": "[Fuzzing] Illegal Index Array Access in Attester Slashing Processing",
  "user": {
    "login": "zedt3ster",
    "id": 9854592,
    "node_id": "MDQ6VXNlcjk4NTQ1OTI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/9854592?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/zedt3ster",
    "html_url": "https://github.com/zedt3ster",
    "followers_url": "https://api.github.com/users/zedt3ster/followers",
    "following_url": "https://api.github.com/users/zedt3ster/following{/other_user}",
    "gists_url": "https://api.github.com/users/zedt3ster/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/zedt3ster/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/zedt3ster/subscriptions",
    "organizations_url": "https://api.github.com/users/zedt3ster/orgs",
    "repos_url": "https://api.github.com/users/zedt3ster/repos",
    "events_url": "https://api.github.com/users/zedt3ster/events{/privacy}",
    "received_events_url": "https://api.github.com/users/zedt3ster/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2020-07-13T01:09:52Z",
  "updated_at": "2020-07-14T09:03:00Z",
  "closed_at": "2020-07-14T09:03:00Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Description\r\n\r\nWhile fuzzing Teku's Attester Slashing processing using [beacon-fuzz](https://github.com/sigp/beacon-fuzz), I triggered the following exception:\r\n\r\n`Exception in thread \"main\" java.lang.ArrayIndexOutOfBoundsException: Index -1953788990 out of bounds for length 256`\r\n\r\nNote that this was triggered using a valid `BeaconState`, and the related `AttesterSlashing` SSZ container can be successfully parsed using [zcli](https://github.com/protolambda/zcli).\r\n\r\nFrom a quick glance, the affected code seems to be:\r\n\r\nhttps://github.com/PegaSysEng/teku/blob/d9fdf128e70b7cc4d5d0b556f1bea20f17b7bf22/ssz/src/main/java/tech/pegasys/teku/ssz/backing/cache/ArrayIntCache.java#L68-L76\r\n\r\n### Steps to Reproduce (Bug)\r\n\r\n- The related `BeaconState` and `AttesterSlashing` containers can be downloaded [here](https://github.com/PegaSysEng/teku/files/4910036/teku-attester-slashing-index-array.zip).\r\n\r\nWe have a small utility to reproduce this bug, as part of `eth2fuzz`:\r\n- Follow the instructions to set up a Teku `eth2fuzz` docker container, described [here](https://github.com/sigp/beacon-fuzz/tree/master/eth2fuzz) (i.e. `make teku`).\r\n- Drop the two files from the archive above in `beacon-fuzz/eth2fuzz/workspace/javafuzz`\r\n- Get a shell inside the docker container (must be ran from the `eth2fuzz` directory): \r\n`docker run -v $(pwd)/workspace:/eth2fuzz/workspace --entrypoint=bash -it eth2fuzz_teku`\r\n- Move to the right directory and build the utility: `cd workspace/javafuzz/` && `javac -cp .:$(./tekuclass.sh) TekuFuzz.java`\r\n- Run the debugging tool: `DEBUG_BEACONSTATE=beaconstate.ssz DEBUG_CONTAINER=ssz3.ssz CLASSPATH=$CLASSPATH:$(./tekuclass.sh) java TekuFuzz`\r\n- Observe the crash:\r\n```\r\n[+] beaconstate ok\r\nException in thread \"main\" java.lang.ArrayIndexOutOfBoundsException: Index -1953788990 out of bounds for length 256\r\n\tat tech.pegasys.teku.ssz.backing.cache.ArrayIntCache.getInt(ArrayIntCache.java:70)\r\n\tat tech.pegasys.teku.ssz.backing.view.AbstractCompositeViewRead.get(AbstractCompositeViewRead.java:87)\r\n\tat tech.pegasys.teku.ssz.backing.view.AbstractCompositeViewWrite.get(AbstractCompositeViewWrite.java:86)\r\n\tat tech.pegasys.teku.ssz.backing.view.AbstractCompositeViewWrite.get(AbstractCompositeViewWrite.java:47)\r\n\tat tech.pegasys.teku.ssz.backing.view.ListViewWriteImpl.get(ListViewWriteImpl.java:95)\r\n\tat tech.pegasys.teku.ssz.backing.view.ListViewWriteImpl.get(ListViewWriteImpl.java:31)\r\n\tat tech.pegasys.teku.ssz.SSZTypes.SSZBackingList.get(SSZBackingList.java:47)\r\n\tat tech.pegasys.teku.datastructures.util.ValidatorsUtil.lambda$getValidatorPubKey$0(ValidatorsUtil.java:76)\r\n\tat tech.pegasys.teku.util.cache.LRUCache.get(LRUCache.java:73)\r\n\tat tech.pegasys.teku.datastructures.util.ValidatorsUtil.getValidatorPubKey(ValidatorsUtil.java:76)\r\n\tat tech.pegasys.teku.datastructures.util.AttestationUtil.lambda$is_valid_indexed_attestation$0(AttestationUtil.java:159)\r\n\tat java.base/java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:195)\r\n\tat java.base/java.util.ArrayList$ArrayListSpliterator.forEachRemaining(ArrayList.java:1654)\r\n\tat java.base/java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:484)\r\n\tat java.base/java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:474)\r\n\tat java.base/java.util.stream.ReduceOps$ReduceOp.evaluateSequential(ReduceOps.java:913)\r\n\tat java.base/java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)\r\n\tat java.base/java.util.stream.ReferencePipeline.collect(ReferencePipeline.java:578)\r\n\tat tech.pegasys.teku.datastructures.util.AttestationUtil.is_valid_indexed_attestation(AttestationUtil.java:159)\r\n\tat tech.pegasys.teku.datastructures.util.AttestationUtil.is_valid_indexed_attestation(AttestationUtil.java:143)\r\n\tat tech.pegasys.teku.core.operationvalidators.AttesterSlashingStateTransitionValidator.lambda$validate$1(AttesterSlashingStateTransitionValidator.java:61)\r\n\tat java.base/java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:195)\r\n\tat java.base/java.util.Spliterators$ArraySpliterator.tryAdvance(Spliterators.java:958)\r\n\tat java.base/java.util.stream.ReferencePipeline.forEachWithCancel(ReferencePipeline.java:127)\r\n\tat java.base/java.util.stream.AbstractPipeline.copyIntoWithCancel(AbstractPipeline.java:502)\r\n\tat java.base/java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:488)\r\n\tat java.base/java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:474)\r\n\tat java.base/java.util.stream.FindOps$FindOp.evaluateSequential(FindOps.java:150)\r\n\tat java.base/java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)\r\n\tat java.base/java.util.stream.ReferencePipeline.findFirst(ReferencePipeline.java:543)\r\n\tat tech.pegasys.teku.core.operationvalidators.OperationInvalidReason.firstOf(OperationInvalidReason.java:31)\r\n\tat tech.pegasys.teku.core.operationvalidators.AttesterSlashingStateTransitionValidator.validate(AttesterSlashingStateTransitionValidator.java:54)\r\n\tat tech.pegasys.teku.core.operationvalidators.AttesterSlashingStateTransitionValidator.validate(AttesterSlashingStateTransitionValidator.java:39)\r\n\tat tech.pegasys.teku.core.BlockProcessorUtil.process_attester_slashings(BlockProcessorUtil.java:318)\r\n\tat TekuFuzz.lambda$teku_attester_slashing$1(TekuFuzz.java:206)\r\n\tat tech.pegasys.teku.datastructures.state.BeaconStateImpl.updated(BeaconStateImpl.java:247)\r\n\tat TekuFuzz.teku_attester_slashing(TekuFuzz.java:204)\r\n\tat TekuFuzz.main(TekuFuzz.java:95)\r\n```\r\n\r\n### Versions\r\n\r\n* Github branch: `master`\r\n* Commit: [d9fdf12](https://github.com/PegaSysEng/teku/commit/d9fdf128e70b7cc4d5d0b556f1bea20f17b7bf22)\r\n* Java version: `openjdk version \"11.0.7\" 2020-04-14`\r\n* OS Name & Version: `Ubuntu 18.04.4 LTS`",
  "closed_by": {
    "login": "ajsutton",
    "id": 72675,
    "node_id": "MDQ6VXNlcjcyNjc1",
    "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ajsutton",
    "html_url": "https://github.com/ajsutton",
    "followers_url": "https://api.github.com/users/ajsutton/followers",
    "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
    "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
    "organizations_url": "https://api.github.com/users/ajsutton/orgs",
    "repos_url": "https://api.github.com/users/ajsutton/repos",
    "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ajsutton/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/2345/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ConsenSys/teku/issues/2345/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/657896120",
    "html_url": "https://github.com/ConsenSys/teku/issues/2345#issuecomment-657896120",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/2345",
    "id": 657896120,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY1Nzg5NjEyMA==",
    "user": {
      "login": "zedt3ster",
      "id": 9854592,
      "node_id": "MDQ6VXNlcjk4NTQ1OTI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9854592?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/zedt3ster",
      "html_url": "https://github.com/zedt3ster",
      "followers_url": "https://api.github.com/users/zedt3ster/followers",
      "following_url": "https://api.github.com/users/zedt3ster/following{/other_user}",
      "gists_url": "https://api.github.com/users/zedt3ster/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/zedt3ster/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/zedt3ster/subscriptions",
      "organizations_url": "https://api.github.com/users/zedt3ster/orgs",
      "repos_url": "https://api.github.com/users/zedt3ster/repos",
      "events_url": "https://api.github.com/users/zedt3ster/events{/privacy}",
      "received_events_url": "https://api.github.com/users/zedt3ster/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-07-14T00:23:19Z",
    "updated_at": "2020-07-14T00:23:19Z",
    "author_association": "NONE",
    "body": "@ajsutton raised that the `BeaconState` actually used isn't compliant with the latest version of the eth2 spec (`v0.12.1`). I've reproduced this bug using a `BeaconState` pulled directly from one of the testnets currently running. For reference, you can find it \r\n[here](https://github.com/PegaSysEng/teku/files/4915819/valid-beaconstate.zip)\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/657896120/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
