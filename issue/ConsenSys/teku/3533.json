{
  "url": "https://api.github.com/repos/ConsenSys/teku/issues/3533",
  "repository_url": "https://api.github.com/repos/ConsenSys/teku",
  "labels_url": "https://api.github.com/repos/ConsenSys/teku/issues/3533/labels{/name}",
  "comments_url": "https://api.github.com/repos/ConsenSys/teku/issues/3533/comments",
  "events_url": "https://api.github.com/repos/ConsenSys/teku/issues/3533/events",
  "html_url": "https://github.com/ConsenSys/teku/issues/3533",
  "id": 800515465,
  "node_id": "MDU6SXNzdWU4MDA1MTU0NjU=",
  "number": 3533,
  "title": "ProtoNode RuntimeException",
  "user": {
    "login": "mbaxter",
    "id": 658601,
    "node_id": "MDQ6VXNlcjY1ODYwMQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/658601?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mbaxter",
    "html_url": "https://github.com/mbaxter",
    "followers_url": "https://api.github.com/users/mbaxter/followers",
    "following_url": "https://api.github.com/users/mbaxter/following{/other_user}",
    "gists_url": "https://api.github.com/users/mbaxter/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mbaxter/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mbaxter/subscriptions",
    "organizations_url": "https://api.github.com/users/mbaxter/orgs",
    "repos_url": "https://api.github.com/users/mbaxter/repos",
    "events_url": "https://api.github.com/users/mbaxter/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mbaxter/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1048919129,
      "node_id": "MDU6TGFiZWwxMDQ4OTE5MTI5",
      "url": "https://api.github.com/repos/ConsenSys/teku/labels/bug%20%F0%9F%90%9E",
      "name": "bug üêû",
      "color": "dd6c94",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 2172542566,
      "node_id": "MDU6TGFiZWwyMTcyNTQyNTY2",
      "url": "https://api.github.com/repos/ConsenSys/teku/labels/P3",
      "name": "P3",
      "color": "FFFF00",
      "default": false,
      "description": "Medium"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "ajsutton",
    "id": 72675,
    "node_id": "MDQ6VXNlcjcyNjc1",
    "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ajsutton",
    "html_url": "https://github.com/ajsutton",
    "followers_url": "https://api.github.com/users/ajsutton/followers",
    "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
    "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
    "organizations_url": "https://api.github.com/users/ajsutton/orgs",
    "repos_url": "https://api.github.com/users/ajsutton/repos",
    "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ajsutton/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2021-02-03T16:56:53Z",
  "updated_at": "2021-02-17T21:51:01Z",
  "closed_at": "2021-02-17T21:46:48Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "### Description\r\nWe have a user report of the following `ProtoNode` exception triggering repeatedly (every 500ms) on an instance of teku (running `20.12.1`):\r\n```\r\n10:34:16.842 ERROR - PLEASE FIX OR REPORT | Unexpected exception thrown for event 'interface tech.pegasys.teku.util.time.channels.TimeTickChannel.onTick' in handler 'tech.pegasys.teku.services.beaconchain.BeaconChainController'\r\njava.util.concurrent.CompletionException: java.lang.RuntimeException: ProtoNode: Delta to be subtracted is greater than node weight for block 0xa99cb183832311be35d7b6f46ee722dee84d52626aa3085d8ccb2781c38ef1ca (543848). Attempting to subtract 32426968918 from 461006704\r\n\tat java.util.concurrent.CompletableFuture.encodeRelay(CompletableFuture.java:367) ~[?:?]\r\n\tat java.util.concurrent.CompletableFuture.completeRelay(CompletableFuture.java:376) ~[?:?]\r\n\tat java.util.concurrent.CompletableFuture$UniRelay.tryFire(CompletableFuture.java:1093) ~[?:?]\r\n\tat java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:506) ~[?:?]\r\n\tat java.util.concurrent.CompletableFuture.completeExceptionally(CompletableFuture.java:2152) ~[?:?]\r\n\tat tech.pegasys.teku.infrastructure.async.SafeFuture.lambda$propagateResult$3(SafeFuture.java:141) ~[teku-infrastructure-async-20.12.1.jar:20.12.1]\r\n\tat java.util.concurrent.CompletableFuture.uniWhenComplete(CompletableFuture.java:859) ~[?:?]\r\n\tat java.util.concurrent.CompletableFuture.uniWhenCompleteStage(CompletableFuture.java:883) ~[?:?]\r\n\tat java.util.concurrent.CompletableFuture.whenComplete(CompletableFuture.java:2315) ~[?:?]\r\n\tat tech.pegasys.teku.infrastructure.async.SafeFuture.whenComplete(SafeFuture.java:494) ~[teku-infrastructure-async-20.12.1.jar:20.12.1]\r\n\tat tech.pegasys.teku.infrastructure.async.SafeFuture.whenComplete(SafeFuture.java:28) ~[teku-infrastructure-async-20.12.1.jar:20.12.1]\r\n\tat tech.pegasys.teku.infrastructure.async.SafeFuture.propagateResult(SafeFuture.java:138) ~[teku-infrastructure-async-20.12.1.jar:20.12.1]\r\n\tat tech.pegasys.teku.infrastructure.async.SafeFuture.propagateTo(SafeFuture.java:235) ~[teku-infrastructure-async-20.12.1.jar:20.12.1]\r\n\tat tech.pegasys.teku.statetransition.forkchoice.SingleThreadedForkChoiceExecutor.lambda$performTask$0(SingleThreadedForkChoiceExecutor.java:58) ~[teku-ethereum-statetransition-20.12.1.jar:20.12.1]\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1130) [?:?]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:630) [?:?]\r\n\tat java.lang.Thread.run(Thread.java:832) [?:?]\r\nCaused by: java.lang.RuntimeException: ProtoNode: Delta to be subtracted is greater than node weight for block 0xa99cb183832311be35d7b6f46ee722dee84d52626aa3085d8ccb2781c38ef1ca (543848). Attempting to subtract 32426968918 from 461006704\r\n\tat tech.pegasys.teku.protoarray.ProtoNode.adjustWeight(ProtoNode.java:66) ~[teku-protoarray-20.12.1.jar:20.12.1]\r\n\tat tech.pegasys.teku.protoarray.ProtoArray.applyDelta(ProtoArray.java:434) ~[teku-protoarray-20.12.1.jar:20.12.1]\r\n\tat tech.pegasys.teku.protoarray.ProtoArray.lambda$applyDeltas$6(ProtoArray.java:423) ~[teku-protoarray-20.12.1.jar:20.12.1]\r\n\tat tech.pegasys.teku.protoarray.ProtoArray.applyToNodes(ProtoArray.java:450) ~[teku-protoarray-20.12.1.jar:20.12.1]\r\n\tat tech.pegasys.teku.protoarray.ProtoArray.applyDeltas(ProtoArray.java:423) ~[teku-protoarray-20.12.1.jar:20.12.1]\r\n\tat tech.pegasys.teku.protoarray.ProtoArray.applyScoreChanges(ProtoArray.java:184) ~[teku-protoarray-20.12.1.jar:20.12.1]\r\n\tat tech.pegasys.teku.protoarray.ProtoArrayForkChoiceStrategy.findHead(ProtoArrayForkChoiceStrategy.java:207) ~[teku-protoarray-20.12.1.jar:20.12.1]\r\n\tat tech.pegasys.teku.protoarray.ProtoArrayForkChoiceStrategy.findHead(ProtoArrayForkChoiceStrategy.java:99) ~[teku-protoarray-20.12.1.jar:20.12.1]\r\n\tat tech.pegasys.teku.storage.store.StoreTransaction.applyForkChoiceScoreChanges(StoreTransaction.java:154) ~[teku-storage-20.12.1.jar:20.12.1]\r\n\tat tech.pegasys.teku.statetransition.forkchoice.ForkChoice.lambda$processHead$1(ForkChoice.java:106) ~[teku-ethereum-statetransition-20.12.1.jar:20.12.1]\r\n\tat tech.pegasys.teku.statetransition.forkchoice.SingleThreadedForkChoiceExecutor.lambda$syncPerformTask$1(SingleThreadedForkChoiceExecutor.java:77) ~[teku-ethereum-statetransition-20.12.1.jar:20.12.1]\r\n\tat tech.pegasys.teku.infrastructure.async.SafeFuture.of(SafeFuture.java:77) ~[teku-infrastructure-async-20.12.1.jar:20.12.1]\r\n\tat tech.pegasys.teku.statetransition.forkchoice.SingleThreadedForkChoiceExecutor.syncPerformTask(SingleThreadedForkChoiceExecutor.java:77) ~[teku-ethereum-statetransition-20.12.1.jar:20.12.1]\r\n\t... 4 more\r\n```\r\n",
  "closed_by": {
    "login": "rolfyone",
    "id": 2967240,
    "node_id": "MDQ6VXNlcjI5NjcyNDA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2967240?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/rolfyone",
    "html_url": "https://github.com/rolfyone",
    "followers_url": "https://api.github.com/users/rolfyone/followers",
    "following_url": "https://api.github.com/users/rolfyone/following{/other_user}",
    "gists_url": "https://api.github.com/users/rolfyone/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/rolfyone/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rolfyone/subscriptions",
    "organizations_url": "https://api.github.com/users/rolfyone/orgs",
    "repos_url": "https://api.github.com/users/rolfyone/repos",
    "events_url": "https://api.github.com/users/rolfyone/events{/privacy}",
    "received_events_url": "https://api.github.com/users/rolfyone/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/3533/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ConsenSys/teku/issues/3533/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/773770553",
    "html_url": "https://github.com/ConsenSys/teku/issues/3533#issuecomment-773770553",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/3533",
    "id": 773770553,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc3Mzc3MDU1Mw==",
    "user": {
      "login": "rolfyone",
      "id": 2967240,
      "node_id": "MDQ6VXNlcjI5NjcyNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2967240?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rolfyone",
      "html_url": "https://github.com/rolfyone",
      "followers_url": "https://api.github.com/users/rolfyone/followers",
      "following_url": "https://api.github.com/users/rolfyone/following{/other_user}",
      "gists_url": "https://api.github.com/users/rolfyone/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rolfyone/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rolfyone/subscriptions",
      "organizations_url": "https://api.github.com/users/rolfyone/orgs",
      "repos_url": "https://api.github.com/users/rolfyone/repos",
      "events_url": "https://api.github.com/users/rolfyone/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rolfyone/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-02-05T03:58:33Z",
    "updated_at": "2021-02-05T03:58:33Z",
    "author_association": "CONTRIBUTOR",
    "body": "block `a99cb183832311be35d7b6f46ee722dee84d52626aa3085d8ccb2781c38ef1ca` appears to be a pyrmont block hash, and it's an orphaned block.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/773770553/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/778845046",
    "html_url": "https://github.com/ConsenSys/teku/issues/3533#issuecomment-778845046",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/3533",
    "id": 778845046,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc3ODg0NTA0Ng==",
    "user": {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-02-14T21:31:28Z",
    "updated_at": "2021-02-14T21:31:28Z",
    "author_association": "CONTRIBUTOR",
    "body": "This happens when the `ProtoArray` and the record of votes wind up out of sync.  In previous cases we've seen this was caused by multiple threads updating the votes simultaneously but it was rearchitected to make that exceptionally unlikely.  Code review strongly suggests that wasn't what caused it this time.\n\nThe other possibly risk is that the `ProtoArray` was updated but then the storage of votes failed and that transaction was rolled back. The changes in the `ProtoArray` don't use transactions and so wouldn't have been rolled back, leaving the two out of sync.\n\nWe may need to make vote updates not use transactions either - the weightings in the `ProtoArray` aren't stored on disk so we only need the in-memory `ProtoArray` and votes to be in sync.  It's ok if the votes on disk are out of sync because of a missed update - that will be correctly when the next attestation from the relevant validators is received.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/778845046/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/780877933",
    "html_url": "https://github.com/ConsenSys/teku/issues/3533#issuecomment-780877933",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/3533",
    "id": 780877933,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc4MDg3NzkzMw==",
    "user": {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-02-17T21:51:01Z",
    "updated_at": "2021-02-17T21:51:01Z",
    "author_association": "CONTRIBUTOR",
    "body": "Switched votes to always update in memory even if the disk update fails.  Can't be certain that this was the original cause of the issue but it seems the most likely, so closing for now.  If it pops up again we may need to add asserts to ensure votes and protoarray weightings are only ever changed on the fork choice thread.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/780877933/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
