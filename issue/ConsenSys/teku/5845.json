{
  "url": "https://api.github.com/repos/ConsenSys/teku/issues/5845",
  "repository_url": "https://api.github.com/repos/ConsenSys/teku",
  "labels_url": "https://api.github.com/repos/ConsenSys/teku/issues/5845/labels{/name}",
  "comments_url": "https://api.github.com/repos/ConsenSys/teku/issues/5845/comments",
  "events_url": "https://api.github.com/repos/ConsenSys/teku/issues/5845/events",
  "html_url": "https://github.com/ConsenSys/teku/issues/5845",
  "id": 1284719716,
  "node_id": "I_kwDOCM9I9M5Mk0Rk",
  "number": 5845,
  "title": "Teku validator getting invalid response from Beacon Node API while connected to nimbus beacon client",
  "user": {
    "login": "TobiWo",
    "id": 10022464,
    "node_id": "MDQ6VXNlcjEwMDIyNDY0",
    "avatar_url": "https://avatars.githubusercontent.com/u/10022464?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/TobiWo",
    "html_url": "https://github.com/TobiWo",
    "followers_url": "https://api.github.com/users/TobiWo/followers",
    "following_url": "https://api.github.com/users/TobiWo/following{/other_user}",
    "gists_url": "https://api.github.com/users/TobiWo/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/TobiWo/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/TobiWo/subscriptions",
    "organizations_url": "https://api.github.com/users/TobiWo/orgs",
    "repos_url": "https://api.github.com/users/TobiWo/repos",
    "events_url": "https://api.github.com/users/TobiWo/events{/privacy}",
    "received_events_url": "https://api.github.com/users/TobiWo/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2022-06-25T21:29:55Z",
  "updated_at": "2022-06-28T00:59:10Z",
  "closed_at": "2022-06-28T00:59:10Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Description\r\nI have the following docker-compose setup:\r\n\r\n1. teku beacon node\r\n1. teku validator instance with two validators connected to the teku beacon client\r\n1. nimbus beacon client with also two validators on it's own\r\n\r\nThis is running on the Prater testnet.\r\n\r\nI just wanted to test different client combinations and realized the following while I switched the **teku validator to the nimbus beacon client**:\r\n1. The logs indicate that the validator connects to the nimbus beacon client event stream\r\n1. However, no attestations are published which results in missing attestations\r\n\r\nI also tried to connect teku to nimbus while nimbus is not running own validators but the result was the same.\r\n\r\nPlease find attached the log files for the teku validator (TRACE mode) and an example log from the nimbus beacon client (DEBUG mode).\r\n\r\n### Steps to Reproduce (Bug)\r\nThese are the docker-compose configs:\r\n\r\nNote: I discard the teku beacon node config here (as described above) as this does not add any relevant information for the issue. \r\n\r\n#### teku compose\r\n```yaml\r\nversion: '3.8'\r\nservices:\r\n\r\n  teku-validator-prater:\r\n    image: consensys/teku:22.6.0\r\n    container_name: teku-validator-prater\r\n    command:\r\n      - validator-client\r\n      - --data-path\r\n      - \"/consensus_data\"\r\n      - --network\r\n      - \"prater\"\r\n      - --metrics-enabled\r\n      - --beacon-node-api-endpoint\r\n      - \"http://10.3.0.5:5052\"\r\n      - --validator-keys\r\n      - \"/consensus_data/validator/keys:/consensus_data/validator/passwords\"\r\n      - --validators-graffiti\r\n      - \"TobiWo\"\r\n    volumes:\r\n      - /mnt/teku_prater/consensus_data:/consensus_data\r\n    stop_grace_period: 2m\r\n    restart: always\r\n    networks:\r\n      goerli-prater:\r\n        ipv4_address: 10.3.0.7\r\n\r\nnetworks:\r\n  goerli-prater:\r\n    external: true\r\n```\r\n\r\n#### nimbus compose\r\n```yaml\r\nversion: '3.8'\r\nservices:\r\n\r\n  nimbus-prater:\r\n    image: statusim/nimbus-eth2:amd64-v22.6.0\r\n    container_name: nimbus-prater\r\n    command:\r\n      - --data-dir=/consensus_data\r\n      - --network=prater\r\n      - --metrics\r\n      - --rest\r\n      - --rest-address=0.0.0.0\r\n      - --rest-allow-origin=*\r\n      - --web3-url=ws://10.3.0.2:8546\r\n      - --validator-monitor-auto\r\n    stop_grace_period: 2m\r\n    volumes:\r\n      - /mnt/nimbus_prater/consensus_data_nimbus:/consensus_data\r\n    restart: always\r\n    networks:\r\n      goerli-prater:\r\n        ipv4_address: 10.3.0.5\r\n\r\nnetworks:\r\n  goerli-prater:\r\n    external: true\r\n```\r\n\r\nJust for your reference, the docker network is defined in a different yaml.\r\n\r\n**Expected behavior:**\r\n1. Teku connects to nimbus successfully\r\n1. Attestations are published successfully\r\n\r\n**Actual behavior:**\r\nSee description and logs.\r\n\r\n**Frequency:**\r\nIt occurs everytime I connect the teku validator to the nimbus beacon client.\r\n\r\n### Versions\r\n* teku version: v22.6.0\r\n* nimbus image (version): nimbus-eth2:amd64-v22.6.0\r\n* Docker Version: 20.10.16\r\n* Cloud VM, type, size: 8 vCPUs, 32GB RAM, 500GB SSD storage, Ubuntu 20.04 (updated)\r\n\r\n### Logs\r\n[teku_validator_to_nimbus_beacon_stacktrace.log](https://github.com/ConsenSys/teku/files/8985556/teku_validator_to_nimbus_beacon_stacktrace.log)\r\n[nimbus_error_responce.log](https://github.com/ConsenSys/teku/files/8985559/nimbus_error_responce_for_teku_validator.txt)\r\n\r\n",
  "closed_by": {
    "login": "ajsutton",
    "id": 72675,
    "node_id": "MDQ6VXNlcjcyNjc1",
    "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ajsutton",
    "html_url": "https://github.com/ajsutton",
    "followers_url": "https://api.github.com/users/ajsutton/followers",
    "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
    "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
    "organizations_url": "https://api.github.com/users/ajsutton/orgs",
    "repos_url": "https://api.github.com/users/ajsutton/repos",
    "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ajsutton/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/5845/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ConsenSys/teku/issues/5845/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1167569111",
    "html_url": "https://github.com/ConsenSys/teku/issues/5845#issuecomment-1167569111",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/5845",
    "id": 1167569111,
    "node_id": "IC_kwDOCM9I9M5Fl7DX",
    "user": {
      "login": "jtraglia",
      "id": 95511699,
      "node_id": "U_kgDOBbFkkw",
      "avatar_url": "https://avatars.githubusercontent.com/u/95511699?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jtraglia",
      "html_url": "https://github.com/jtraglia",
      "followers_url": "https://api.github.com/users/jtraglia/followers",
      "following_url": "https://api.github.com/users/jtraglia/following{/other_user}",
      "gists_url": "https://api.github.com/users/jtraglia/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jtraglia/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jtraglia/subscriptions",
      "organizations_url": "https://api.github.com/users/jtraglia/orgs",
      "repos_url": "https://api.github.com/users/jtraglia/repos",
      "events_url": "https://api.github.com/users/jtraglia/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jtraglia/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-06-27T16:22:13Z",
    "updated_at": "2022-06-27T16:22:13Z",
    "author_association": "CONTRIBUTOR",
    "body": "Hey @TobiWo, thanks for the bug report! I haven't verified this with Nimbus, but I believe the issue is that the indices being sent to Nimbus are not strings; it's `[1,2,3]` but should be `[\"1\",\"2\",\"3\"]`. Technically [Teku is in the wrong here](https://ethereum.github.io/beacon-APIs/#/Validator/getAttesterDuties), but I think maybe Nimbus should still handle this situation. Teku will accept either, its deserializer is pretty forgiving.\r\n\r\nhttps://github.com/ConsenSys/teku/blob/ce6e13e32f2c5029aa05895f400c00a9c72a3f38/validator/remote/src/main/java/tech/pegasys/teku/validator/remote/apiclient/OkHttpValidatorRestApiClient.java#L145-L149\r\n\r\nAs you can see above, the validator indices are being sent as an array of ints. An easy solution would be convert this to a list of strings here. The alternative is to create an `int[]` deserializer, like we do for `byte[]` types. I'll make a PR for this today.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1167569111/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
