{
  "url": "https://api.github.com/repos/ConsenSys/teku/issues/6667",
  "repository_url": "https://api.github.com/repos/ConsenSys/teku",
  "labels_url": "https://api.github.com/repos/ConsenSys/teku/issues/6667/labels{/name}",
  "comments_url": "https://api.github.com/repos/ConsenSys/teku/issues/6667/comments",
  "events_url": "https://api.github.com/repos/ConsenSys/teku/issues/6667/events",
  "html_url": "https://github.com/ConsenSys/teku/issues/6667",
  "id": 1525479992,
  "node_id": "I_kwDOCM9I9M5a7Po4",
  "number": 6667,
  "title": "Add an override for the number of asyncrunner threads for VC service",
  "user": {
    "login": "corverroos",
    "id": 29249923,
    "node_id": "MDQ6VXNlcjI5MjQ5OTIz",
    "avatar_url": "https://avatars.githubusercontent.com/u/29249923?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/corverroos",
    "html_url": "https://github.com/corverroos",
    "followers_url": "https://api.github.com/users/corverroos/followers",
    "following_url": "https://api.github.com/users/corverroos/following{/other_user}",
    "gists_url": "https://api.github.com/users/corverroos/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/corverroos/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/corverroos/subscriptions",
    "organizations_url": "https://api.github.com/users/corverroos/orgs",
    "repos_url": "https://api.github.com/users/corverroos/repos",
    "events_url": "https://api.github.com/users/corverroos/events{/privacy}",
    "received_events_url": "https://api.github.com/users/corverroos/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1048919131,
      "node_id": "MDU6TGFiZWwxMDQ4OTE5MTMx",
      "url": "https://api.github.com/repos/ConsenSys/teku/labels/enhancement%20%F0%9F%95%B5%EF%B8%8F%E2%80%8D%E2%99%80%EF%B8%8F",
      "name": "enhancement üïµÔ∏è‚Äç‚ôÄÔ∏è",
      "color": "a2eeef",
      "default": false,
      "description": "New feature or request"
    },
    {
      "id": 1168202341,
      "node_id": "MDU6TGFiZWwxMTY4MjAyMzQx",
      "url": "https://api.github.com/repos/ConsenSys/teku/labels/blocked%20by%20research%20%F0%9F%91%A9%E2%80%8D%F0%9F%8F%AB",
      "name": "blocked by research üë©‚Äçüè´",
      "color": "039fc6",
      "default": false,
      "description": "This issue or pull request is blocked by incomplete spec"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 6,
  "created_at": "2023-01-09T12:14:19Z",
  "updated_at": "2023-02-06T13:00:59Z",
  "closed_at": "2023-02-06T13:00:59Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Updated Description\r\n\r\nSee [this comment](https://github.com/ConsenSys/teku/issues/6667#issuecomment-1379843164) for a better description of the requested feature\r\n\r\n### Original Description\r\n\r\nWe at Obol are running a \"performance/load testing\" DVT cluster using teku as the VC. The cluster has 500 active validators on goerli. The cluster is sporadically missing attestations due to \"inactivity\" from teku, ie, the VC doesn't perform some attestation duties. We created an internal ticket: https://github.com/ObolNetwork/charon/issues/1585\r\n\r\nThe VC logs the following for those missed slots:\r\n```\r\nWARN  - Skipping aggregation for slot 4694957 due to unexpected delay in slot processing\r\n```\r\n\r\nDigging into the teku code, I'm wondering if this due to [Serviceutils#calculateMaxThreads](https://github.com/ConsenSys/teku/blob/master/infrastructure/serviceutils/src/main/java/tech/pegasys/teku/service/serviceutils/ServiceConfig.java#L95)?\r\n - In a DVT cluster, some blocking API calls take much longer than in traditional single validator setups.\r\n - This is because we need to perform a bunch of internal p2p network hops for consensus across the whole cluster.\r\n - If other peers in the cluster are having issues, then the data might never be available and those queries need to timeout.\r\n - If teku is only using `max(Runtime.getRuntime().availableProcessors(), 5)` concurrent threads, then it seems likely that this is causing the problem.\r\n\r\nWould it be possible to increase this number or make it configurable?\r\n\r\n### Steps to Reproduce (Bug)\r\n\r\nRun a Obol DVT cluster with 4 nodes and 500 active validators on goerli.\r\n\r\n### Versions (Add all that apply)\r\n* Software version: 22.12.0\r\n* Java version: 17.0.5\r\n* OS Name & Version: Ubuntu (GKE)\r\n* Docker Version: Unknown (GKE)\r\n* Cloud VM, type, size: GKE node, JAVA_OPTS=\"-Xmx4g -Xms4g",
  "closed_by": {
    "login": "corverroos",
    "id": 29249923,
    "node_id": "MDQ6VXNlcjI5MjQ5OTIz",
    "avatar_url": "https://avatars.githubusercontent.com/u/29249923?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/corverroos",
    "html_url": "https://github.com/corverroos",
    "followers_url": "https://api.github.com/users/corverroos/followers",
    "following_url": "https://api.github.com/users/corverroos/following{/other_user}",
    "gists_url": "https://api.github.com/users/corverroos/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/corverroos/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/corverroos/subscriptions",
    "organizations_url": "https://api.github.com/users/corverroos/orgs",
    "repos_url": "https://api.github.com/users/corverroos/repos",
    "events_url": "https://api.github.com/users/corverroos/events{/privacy}",
    "received_events_url": "https://api.github.com/users/corverroos/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/6667/reactions",
    "total_count": 3,
    "+1": 3,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ConsenSys/teku/issues/6667/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1379730898",
    "html_url": "https://github.com/ConsenSys/teku/issues/6667#issuecomment-1379730898",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/6667",
    "id": 1379730898,
    "node_id": "IC_kwDOCM9I9M5SPQXS",
    "user": {
      "login": "lucassaldanha",
      "id": 1766440,
      "node_id": "MDQ6VXNlcjE3NjY0NDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1766440?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/lucassaldanha",
      "html_url": "https://github.com/lucassaldanha",
      "followers_url": "https://api.github.com/users/lucassaldanha/followers",
      "following_url": "https://api.github.com/users/lucassaldanha/following{/other_user}",
      "gists_url": "https://api.github.com/users/lucassaldanha/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/lucassaldanha/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/lucassaldanha/subscriptions",
      "organizations_url": "https://api.github.com/users/lucassaldanha/orgs",
      "repos_url": "https://api.github.com/users/lucassaldanha/repos",
      "events_url": "https://api.github.com/users/lucassaldanha/events{/privacy}",
      "received_events_url": "https://api.github.com/users/lucassaldanha/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-01-12T02:24:51Z",
    "updated_at": "2023-01-12T02:24:51Z",
    "author_association": "MEMBER",
    "body": "Hi,\r\n\r\nThanks for your report.\r\n\r\nWe have nodes running in Goerli with 5,000 validators and we are not seeing this problem. Our nodes have close to 100% inclusion rate, and we have not seen this warning in our logs.\r\n\r\nOur node is running on AWS, and has the following configuration:\r\n\r\nInstance type: m6a.2xlarge\r\n\r\n- 8 vCPUs\r\n- 32 GB RAM\r\n- 12.5 Gbps Network Bandwidth\r\n\r\nWe are using EBS gp3 storage with the following configuration:\r\n\r\n- 3,000 IOPS \r\n\r\nI checked our configuration and we are using:\r\n\r\n- -Xmx5g for heap size\r\n\r\nOne option that we are using that could be relevant in your case, is an experimental config `--Xrest-api-validator-threads` that configure the number of threads being used to handle validator api requests. **By default Teku uses 1**, **but we are using 4**:\r\n\r\n- --Xrest-api-validator-threads=4\r\n\r\n\r\nLet me know how your server compare with our reference Goerli node. Also, if you do have a chance to play around the `--Xrest-api-validator-threads` option I'd love to hear the results.\r\n\r\nReferences:\r\n- https://aws.amazon.com/ec2/instance-types/m6a/\r\n- https://aws.amazon.com/ebs/features/\r\n- https://github.com/ConsenSys/teku/blob/master/teku/src/main/java/tech/pegasys/teku/cli/options/BeaconRestApiOptions.java#L127-L132",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1379730898/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1379843164",
    "html_url": "https://github.com/ConsenSys/teku/issues/6667#issuecomment-1379843164",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/6667",
    "id": 1379843164,
    "node_id": "IC_kwDOCM9I9M5SPrxc",
    "user": {
      "login": "corverroos",
      "id": 29249923,
      "node_id": "MDQ6VXNlcjI5MjQ5OTIz",
      "avatar_url": "https://avatars.githubusercontent.com/u/29249923?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/corverroos",
      "html_url": "https://github.com/corverroos",
      "followers_url": "https://api.github.com/users/corverroos/followers",
      "following_url": "https://api.github.com/users/corverroos/following{/other_user}",
      "gists_url": "https://api.github.com/users/corverroos/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/corverroos/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/corverroos/subscriptions",
      "organizations_url": "https://api.github.com/users/corverroos/orgs",
      "repos_url": "https://api.github.com/users/corverroos/repos",
      "events_url": "https://api.github.com/users/corverroos/events{/privacy}",
      "received_events_url": "https://api.github.com/users/corverroos/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-01-12T05:41:51Z",
    "updated_at": "2023-01-12T05:43:18Z",
    "author_association": "NONE",
    "body": "Thanks @lucassaldanha , but our use-case is a bit different. We are **not** a running normal/traditional validator like you mentioned, we are running a [Obol DVT cluster](https://docs.obol.tech/docs/int/key-concepts#distributed-validator-node) with multiple Tekus as the VCs, Obol's charon nodes as the DVT middleware, and lighthouse as the beacon nodes. \r\n\r\nThe difference between a traditional validator and a distributed validator is the we split the validator key into keyshares across multiple VCs. We then introduce a middleware layer that does consensus on data to sign and does threshold aggregation to recombine partial signature before broadcasting them back up to the beacon node. The middleware layer therefore introduces multiple network hops (latency). See our [docs](https://obol.tech/) for more info.\r\n\r\nWhat that means is that the beacon API calls that the VC does has MUCH more latency than a traditional validator (since it doesn't talk with the BN, but rather with the DVT middleware client). And if there are problem in the DVT cluster, then many beacon api calls that the VC does might never return (since the data is never available), that means the calls block until they timeout. The teku beacon API http timeout is 10s I think (so almost 2 slots). \r\n\r\nSince the VC asyncrunner only uses a few threads (from 5 to #cpus) it is easy for all those threads to be blocked waiting for http timeout. During this time, no other duties can be performed. \r\n\r\nThis isn't a problem in your 5000 validator goerli setup since the VC talks directly to the BN (no DVT middleware) and the BN is properly resourced so always returns quickly (with  milliseconds or max a one or two seconds). Beacon api calls should never really block forever waiting for http timeout.\r\n\r\nWould it be possible to add an override for the VC number of asyncrunner threads, similar to the beacon API override you mentioned? Something like `--Xvalidator-client-runner-threads=20`\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1379843164/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1379846404",
    "html_url": "https://github.com/ConsenSys/teku/issues/6667#issuecomment-1379846404",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/6667",
    "id": 1379846404,
    "node_id": "IC_kwDOCM9I9M5SPskE",
    "user": {
      "login": "lucassaldanha",
      "id": 1766440,
      "node_id": "MDQ6VXNlcjE3NjY0NDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1766440?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/lucassaldanha",
      "html_url": "https://github.com/lucassaldanha",
      "followers_url": "https://api.github.com/users/lucassaldanha/followers",
      "following_url": "https://api.github.com/users/lucassaldanha/following{/other_user}",
      "gists_url": "https://api.github.com/users/lucassaldanha/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/lucassaldanha/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/lucassaldanha/subscriptions",
      "organizations_url": "https://api.github.com/users/lucassaldanha/orgs",
      "repos_url": "https://api.github.com/users/lucassaldanha/repos",
      "events_url": "https://api.github.com/users/lucassaldanha/events{/privacy}",
      "received_events_url": "https://api.github.com/users/lucassaldanha/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-01-12T05:48:01Z",
    "updated_at": "2023-01-12T05:48:01Z",
    "author_association": "MEMBER",
    "body": "@corverroos thank you for the explanation. I will raise this with our product manager to discuss this feature request.\r\n\r\nAt the moment the development team is 100% focused on the Capella upgrade, so realistically we won't be implementing any new feature requests until the upgrade (ETA March 2023).",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1379846404/reactions",
      "total_count": 2,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 1,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1379886334",
    "html_url": "https://github.com/ConsenSys/teku/issues/6667#issuecomment-1379886334",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/6667",
    "id": 1379886334,
    "node_id": "IC_kwDOCM9I9M5SP2T-",
    "user": {
      "login": "benjaminion",
      "id": 20796281,
      "node_id": "MDQ6VXNlcjIwNzk2Mjgx",
      "avatar_url": "https://avatars.githubusercontent.com/u/20796281?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/benjaminion",
      "html_url": "https://github.com/benjaminion",
      "followers_url": "https://api.github.com/users/benjaminion/followers",
      "following_url": "https://api.github.com/users/benjaminion/following{/other_user}",
      "gists_url": "https://api.github.com/users/benjaminion/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/benjaminion/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/benjaminion/subscriptions",
      "organizations_url": "https://api.github.com/users/benjaminion/orgs",
      "repos_url": "https://api.github.com/users/benjaminion/repos",
      "events_url": "https://api.github.com/users/benjaminion/events{/privacy}",
      "received_events_url": "https://api.github.com/users/benjaminion/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-01-12T06:51:17Z",
    "updated_at": "2023-01-12T06:51:17Z",
    "author_association": "CONTRIBUTOR",
    "body": "Hey all. How confident are you that this fix would resolve the issue you are seeing? Is it feasible for Obol to try patching Teku to confirm that the fix is effective? Just want to make sure that it's the right fix before we commit, and it's difficult for us to test on our side.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1379886334/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1379934090",
    "html_url": "https://github.com/ConsenSys/teku/issues/6667#issuecomment-1379934090",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/6667",
    "id": 1379934090,
    "node_id": "IC_kwDOCM9I9M5SQB-K",
    "user": {
      "login": "corverroos",
      "id": 29249923,
      "node_id": "MDQ6VXNlcjI5MjQ5OTIz",
      "avatar_url": "https://avatars.githubusercontent.com/u/29249923?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/corverroos",
      "html_url": "https://github.com/corverroos",
      "followers_url": "https://api.github.com/users/corverroos/followers",
      "following_url": "https://api.github.com/users/corverroos/following{/other_user}",
      "gists_url": "https://api.github.com/users/corverroos/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/corverroos/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/corverroos/subscriptions",
      "organizations_url": "https://api.github.com/users/corverroos/orgs",
      "repos_url": "https://api.github.com/users/corverroos/repos",
      "events_url": "https://api.github.com/users/corverroos/events{/privacy}",
      "received_events_url": "https://api.github.com/users/corverroos/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-01-12T07:51:39Z",
    "updated_at": "2023-01-12T07:51:39Z",
    "author_association": "NONE",
    "body": "Yes sure, we can test the fix on our side and let you know if it works üöÄ \r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1379934090/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1419042505",
    "html_url": "https://github.com/ConsenSys/teku/issues/6667#issuecomment-1419042505",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/6667",
    "id": 1419042505,
    "node_id": "IC_kwDOCM9I9M5UlN7J",
    "user": {
      "login": "corverroos",
      "id": 29249923,
      "node_id": "MDQ6VXNlcjI5MjQ5OTIz",
      "avatar_url": "https://avatars.githubusercontent.com/u/29249923?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/corverroos",
      "html_url": "https://github.com/corverroos",
      "followers_url": "https://api.github.com/users/corverroos/followers",
      "following_url": "https://api.github.com/users/corverroos/following{/other_user}",
      "gists_url": "https://api.github.com/users/corverroos/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/corverroos/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/corverroos/subscriptions",
      "organizations_url": "https://api.github.com/users/corverroos/orgs",
      "repos_url": "https://api.github.com/users/corverroos/repos",
      "events_url": "https://api.github.com/users/corverroos/events{/privacy}",
      "received_events_url": "https://api.github.com/users/corverroos/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-02-06T13:00:59Z",
    "updated_at": "2023-02-06T13:00:59Z",
    "author_association": "NONE",
    "body": "Closing as fixed by #6761",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1419042505/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
