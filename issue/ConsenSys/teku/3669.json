{
  "url": "https://api.github.com/repos/ConsenSys/teku/issues/3669",
  "repository_url": "https://api.github.com/repos/ConsenSys/teku",
  "labels_url": "https://api.github.com/repos/ConsenSys/teku/issues/3669/labels{/name}",
  "comments_url": "https://api.github.com/repos/ConsenSys/teku/issues/3669/comments",
  "events_url": "https://api.github.com/repos/ConsenSys/teku/issues/3669/events",
  "html_url": "https://github.com/ConsenSys/teku/issues/3669",
  "id": 817307841,
  "node_id": "MDU6SXNzdWU4MTczMDc4NDE=",
  "number": 3669,
  "title": "Intermittent Test: BeaconBlocksByRootIntegrationTest",
  "user": {
    "login": "Nashatyrev",
    "id": 8173857,
    "node_id": "MDQ6VXNlcjgxNzM4NTc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/8173857?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Nashatyrev",
    "html_url": "https://github.com/Nashatyrev",
    "followers_url": "https://api.github.com/users/Nashatyrev/followers",
    "following_url": "https://api.github.com/users/Nashatyrev/following{/other_user}",
    "gists_url": "https://api.github.com/users/Nashatyrev/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Nashatyrev/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Nashatyrev/subscriptions",
    "organizations_url": "https://api.github.com/users/Nashatyrev/orgs",
    "repos_url": "https://api.github.com/users/Nashatyrev/repos",
    "events_url": "https://api.github.com/users/Nashatyrev/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Nashatyrev/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2021-02-26T12:13:52Z",
  "updated_at": "2021-02-26T21:25:25Z",
  "closed_at": "2021-02-26T21:25:25Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "<!-- Have you done the following? -->\r\n<!--   * read the Code of Conduct? By filing an Issue, you are expected to -->  \r\n<!--     comply with it, including treating everyone with respect: -->\r\n<!--     https://github.com/ConsenSys/teku/blob/master/CODE-OF-CONDUCT.md -->\r\n<!--   * Reproduced the issue in the latest version of the software -->\r\n<!--   * Read the debugging wiki: https://github.com/ConsenSys/teku/wiki/debugging -->\r\n<!--   * Duplicate Issue check:  https://github.com/search?q=+is%3Aissue+repo%3AConsenSys/Teku -->\r\n<!-- Note:  Not all sections will apply to all issue types. -->\r\n\r\n### Description\r\n\r\nRunning a private branch integration tests on my Ubuntu AWS node I've got 2 failed tests: \r\n- one is the same as #3548 \r\n- another is `BeaconBlocksByRootIntegrationTest.shouldReturnSingleBlockWhenOnlyOneMatches()`\r\n\r\nNote: both didn't reproduce on the second run\r\n\r\n```\r\njava.util.concurrent.ExecutionException: tech.pegasys.teku.networking.eth2.rpc.core.RpcException$ExtraDataAppendedException: [Code 1] Extra data appended to end of message\r\n\tat java.base/java.util.concurrent.CompletableFuture.reportGet(CompletableFuture.java:395)\r\n\tat java.base/java.util.concurrent.CompletableFuture.get(CompletableFuture.java:2022)\r\n\tat tech.pegasys.teku.infrastructure.async.Waiter.waitFor(Waiter.java:55)\r\n\tat tech.pegasys.teku.networking.eth2.BeaconBlocksByRootIntegrationTest.requestBlocks(BeaconBlocksByRootIntegrationTest.java:237)\r\n\tat tech.pegasys.teku.networking.eth2.BeaconBlocksByRootIntegrationTest.shouldReturnSingleBlockWhenOnlyOneMatches(BeaconBlocksByRootIntegrationTest.java:106)\r\nCaused by: tech.pegasys.teku.networking.eth2.rpc.core.RpcException$ExtraDataAppendedException: [Code 1] Extra data appended to end of message\r\n\tat tech.pegasys.teku.networking.eth2.rpc.core.Eth2OutgoingRequestHandler.processData(Eth2OutgoingRequestHandler.java:114)\r\n\tat tech.pegasys.teku.networking.p2p.libp2p.rpc.RpcHandler$Controller.lambda$channelRead0$0(RpcHandler.java:142)\r\n\tat java.base/java.util.Optional.ifPresentOrElse(Optional.java:201)\r\n\tat tech.pegasys.teku.networking.p2p.libp2p.rpc.RpcHandler$Controller.runHandler(RpcHandler.java:203)\r\n\tat tech.pegasys.teku.networking.p2p.libp2p.rpc.RpcHandler$Controller.channelRead0(RpcHandler.java:142)\r\n\tat tech.pegasys.teku.networking.p2p.libp2p.rpc.RpcHandler$Controller.channelRead0(RpcHandler.java:116)\r\n\tat io.netty.channel.SimpleChannelInboundHandler.channelRead(SimpleChannelInboundHandler.java:99)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:379)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:365)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:357)\r\n\tat io.netty.channel.DefaultChannelPipeline$HeadContext.channelRead(DefaultChannelPipeline.java:1410)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:379)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:365)\r\n\tat io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:919)\r\n\tat io.libp2p.etc.util.netty.mux.AbstractMuxHandler.childRead(AbstractMuxHandler.kt:57)\r\n\tat io.libp2p.mux.MuxHandler.channelRead(MuxHandler.kt:45)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:379)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:365)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:357)\r\n\tat tech.pegasys.teku.networking.p2p.libp2p.MplexFirewall$MplexFirewallHandler.channelRead(MplexFirewall.java:109)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:379)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:365)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:357)\r\n\tat io.netty.handler.logging.LoggingHandler.channelRead(LoggingHandler.java:271)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:379)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:365)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:357)\r\n\tat io.netty.handler.codec.ByteToMessageDecoder.fireChannelRead(ByteToMessageDecoder.java:324)\r\n\tat io.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:296)\r\n\tat io.netty.handler.codec.ByteToMessageCodec.channelRead(ByteToMessageCodec.java:103)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:379)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:365)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:357)\r\n\tat io.netty.handler.codec.MessageToMessageDecoder.channelRead(MessageToMessageDecoder.java:103)\r\n\tat io.netty.handler.codec.MessageToMessageCodec.channelRead(MessageToMessageCodec.java:111)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:379)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:365)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:357)\r\n\tat io.netty.channel.CombinedChannelDuplexHandler$DelegatingChannelHandlerContext.fireChannelRead(CombinedChannelDuplexHandler.java:436)\r\n\tat io.netty.handler.codec.ByteToMessageDecoder.fireChannelRead(ByteToMessageDecoder.java:324)\r\n\tat io.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:296)\r\n\tat io.netty.channel.CombinedChannelDuplexHandler.channelRead(CombinedChannelDuplexHandler.java:251)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:379)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:365)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:357)\r\n\tat io.netty.channel.DefaultChannelPipeline$HeadContext.channelRead(DefaultChannelPipeline.java:1410)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:379)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:365)\r\n\tat io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:919)\r\n\tat io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:163)\r\n\tat io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:714)\r\n\tat io.netty.channel.nio.NioEventLoop.processSelectedKeysOptimized(NioEventLoop.java:650)\r\n\tat io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:576)\r\n\tat io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:493)\r\n\tat io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:989)\r\n\tat io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)\r\n\tat io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\r\n```\r\n\r\nBelow are Mplex wire logs. What's different from a normal run is that the rpc requester doesn't close its write side stream (or either didn't catch doing that):\r\n\r\n```\r\n2021-02-26 09:25:58.704+00:00 | nioEventLoopGroup-25-1 | DEBUG | mux | [id: 0xa2689dd2, L:/10.1.0.237:46738 - R:/10.1.0.237:8135] WRITE, MuxFrame(id=a2689dd2/18/true, flag=OPEN, data=null), 0B\r\n2021-02-26 09:25:58.705+00:00 | nioEventLoopGroup-25-1 | DEBUG | mux | [id: 0xa2689dd2, L:/10.1.0.237:46738 - R:/10.1.0.237:8135] FLUSH\r\n2021-02-26 09:25:58.706+00:00 | nioEventLoopGroup-25-1 | DEBUG | mux | [id: 0xa2689dd2, L:/10.1.0.237:46738 - R:/10.1.0.237:8135] WRITE: MuxFrame(id=a2689dd2/18/true, flag=DATA, data=132f6d756c746973747265616d2f312e302e300a), 20B\r\n         +-------------------------------------------------+\r\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\r\n+--------+-------------------------------------------------+----------------+\r\n|00000000| 13 2f 6d 75 6c 74 69 73 74 72 65 61 6d 2f 31 2e |./multistream/1.|\r\n|00000010| 30 2e 30 0a                                     |0.0.            |\r\n+--------+-------------------------------------------------+----------------+\r\n2021-02-26 09:25:58.706+00:00 | nioEventLoopGroup-25-1 | DEBUG | mux | [id: 0xa2689dd2, L:/10.1.0.237:46738 - R:/10.1.0.237:8135] FLUSH\r\n2021-02-26 09:25:58.706+00:00 | nioEventLoopGroup-25-1 | DEBUG | mux | [id: 0xa2689dd2, L:/10.1.0.237:46738 - R:/10.1.0.237:8135] WRITE: MuxFrame(id=a2689dd2/18/true, flag=DATA, data=3a2f657468322f626561636f6e5f636861696e2f7265712f626561636f6e5f626c6f636b735f62795f726f6f742f312f73737a5f736e617070790a), 59B\r\n         +-------------------------------------------------+\r\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\r\n+--------+-------------------------------------------------+----------------+\r\n|00000000| 3a 2f 65 74 68 32 2f 62 65 61 63 6f 6e 5f 63 68 |:/eth2/beacon_ch|\r\n|00000010| 61 69 6e 2f 72 65 71 2f 62 65 61 63 6f 6e 5f 62 |ain/req/beacon_b|\r\n|00000020| 6c 6f 63 6b 73 5f 62 79 5f 72 6f 6f 74 2f 31 2f |locks_by_root/1/|\r\n|00000030| 73 73 7a 5f 73 6e 61 70 70 79 0a                |ssz_snappy.     |\r\n+--------+-------------------------------------------------+----------------+\r\n2021-02-26 09:25:58.706+00:00 | nioEventLoopGroup-25-1 | DEBUG | mux | [id: 0xa2689dd2, L:/10.1.0.237:46738 - R:/10.1.0.237:8135] FLUSH\r\n2021-02-26 09:25:58.707+00:00 | nioEventLoopGroup-23-1 | DEBUG | mux | [id: 0x5196576f, L:/10.1.0.237:8135 - R:/10.1.0.237:46738] READ, MplexFrame(id=5196576f/18/false, flag=OPEN (init), data=), 0B\r\n2021-02-26 09:25:58.707+00:00 | nioEventLoopGroup-23-1 | DEBUG | mux | [id: 0x5196576f, L:/10.1.0.237:8135 - R:/10.1.0.237:46738] WRITE: MuxFrame(id=5196576f/18/false, flag=DATA, data=132f6d756c746973747265616d2f312e302e300a), 20B\r\n         +-------------------------------------------------+\r\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\r\n+--------+-------------------------------------------------+----------------+\r\n|00000000| 13 2f 6d 75 6c 74 69 73 74 72 65 61 6d 2f 31 2e |./multistream/1.|\r\n|00000010| 30 2e 30 0a                                     |0.0.            |\r\n+--------+-------------------------------------------------+----------------+\r\n2021-02-26 09:25:58.708+00:00 | nioEventLoopGroup-23-1 | DEBUG | mux | [id: 0x5196576f, L:/10.1.0.237:8135 - R:/10.1.0.237:46738] FLUSH\r\n2021-02-26 09:25:58.708+00:00 | nioEventLoopGroup-23-1 | DEBUG | mux | [id: 0x5196576f, L:/10.1.0.237:8135 - R:/10.1.0.237:46738] READ: MplexFrame(id=5196576f/18/false, flag=DATA (init), data=132f6d756c746973747265616d2f312e302e300a), 20B\r\n         +-------------------------------------------------+\r\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\r\n+--------+-------------------------------------------------+----------------+\r\n|00000000| 13 2f 6d 75 6c 74 69 73 74 72 65 61 6d 2f 31 2e |./multistream/1.|\r\n|00000010| 30 2e 30 0a                                     |0.0.            |\r\n+--------+-------------------------------------------------+----------------+\r\n2021-02-26 09:25:58.708+00:00 | nioEventLoopGroup-23-1 | DEBUG | mux | [id: 0x5196576f, L:/10.1.0.237:8135 - R:/10.1.0.237:46738] READ: MplexFrame(id=5196576f/18/false, flag=DATA (init), data=3a2f657468322f626561636f6e5f636861696e2f7265712f626561636f6e5f626c6f636b735f62795f726f6f742f312f73737a5f736e617070790a), 59B\r\n         +-------------------------------------------------+\r\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\r\n+--------+-------------------------------------------------+----------------+\r\n|00000000| 3a 2f 65 74 68 32 2f 62 65 61 63 6f 6e 5f 63 68 |:/eth2/beacon_ch|\r\n|00000010| 61 69 6e 2f 72 65 71 2f 62 65 61 63 6f 6e 5f 62 |ain/req/beacon_b|\r\n|00000020| 6c 6f 63 6b 73 5f 62 79 5f 72 6f 6f 74 2f 31 2f |locks_by_root/1/|\r\n|00000030| 73 73 7a 5f 73 6e 61 70 70 79 0a                |ssz_snappy.     |\r\n+--------+-------------------------------------------------+----------------+\r\n2021-02-26 09:25:58.709+00:00 | nioEventLoopGroup-23-1 | DEBUG | mux | [id: 0x5196576f, L:/10.1.0.237:8135 - R:/10.1.0.237:46738] WRITE: MuxFrame(id=5196576f/18/false, flag=DATA, data=3a2f657468322f626561636f6e5f636861696e2f7265712f626561636f6e5f626c6f636b735f62795f726f6f742f312f73737a5f736e617070790a), 59B\r\n         +-------------------------------------------------+\r\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\r\n+--------+-------------------------------------------------+----------------+\r\n|00000000| 3a 2f 65 74 68 32 2f 62 65 61 63 6f 6e 5f 63 68 |:/eth2/beacon_ch|\r\n|00000010| 61 69 6e 2f 72 65 71 2f 62 65 61 63 6f 6e 5f 62 |ain/req/beacon_b|\r\n|00000020| 6c 6f 63 6b 73 5f 62 79 5f 72 6f 6f 74 2f 31 2f |locks_by_root/1/|\r\n|00000030| 73 73 7a 5f 73 6e 61 70 70 79 0a                |ssz_snappy.     |\r\n+--------+-------------------------------------------------+----------------+\r\n2021-02-26 09:25:58.709+00:00 | nioEventLoopGroup-23-1 | DEBUG | mux | [id: 0x5196576f, L:/10.1.0.237:8135 - R:/10.1.0.237:46738] FLUSH\r\n2021-02-26 09:25:58.709+00:00 | nioEventLoopGroup-23-1 | DEBUG | mux | [id: 0x5196576f, L:/10.1.0.237:8135 - R:/10.1.0.237:46738] READ COMPLETE\r\n2021-02-26 09:25:58.709+00:00 | nioEventLoopGroup-25-1 | DEBUG | mux | [id: 0xa2689dd2, L:/10.1.0.237:46738 - R:/10.1.0.237:8135] READ: MplexFrame(id=a2689dd2/18/true, flag=DATA (resp), data=132f6d756c746973747265616d2f312e302e300a), 20B\r\n         +-------------------------------------------------+\r\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\r\n+--------+-------------------------------------------------+----------------+\r\n|00000000| 13 2f 6d 75 6c 74 69 73 74 72 65 61 6d 2f 31 2e |./multistream/1.|\r\n|00000010| 30 2e 30 0a                                     |0.0.            |\r\n+--------+-------------------------------------------------+----------------+\r\n2021-02-26 09:25:58.710+00:00 | nioEventLoopGroup-25-1 | DEBUG | mux | [id: 0xa2689dd2, L:/10.1.0.237:46738 - R:/10.1.0.237:8135] READ: MplexFrame(id=a2689dd2/18/true, flag=DATA (resp), data=3a2f657468322f626561636f6e5f636861696e2f7265712f626561636f6e5f626c6f636b735f62795f726f6f742f312f73737a5f736e617070790a), 59B\r\n         +-------------------------------------------------+\r\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\r\n+--------+-------------------------------------------------+----------------+\r\n|00000000| 3a 2f 65 74 68 32 2f 62 65 61 63 6f 6e 5f 63 68 |:/eth2/beacon_ch|\r\n|00000010| 61 69 6e 2f 72 65 71 2f 62 65 61 63 6f 6e 5f 62 |ain/req/beacon_b|\r\n|00000020| 6c 6f 63 6b 73 5f 62 79 5f 72 6f 6f 74 2f 31 2f |locks_by_root/1/|\r\n|00000030| 73 73 7a 5f 73 6e 61 70 70 79 0a                |ssz_snappy.     |\r\n+--------+-------------------------------------------------+----------------+\r\n2021-02-26 09:25:58.710+00:00 | nioEventLoopGroup-25-1 | DEBUG | mux | [id: 0xa2689dd2, L:/10.1.0.237:46738 - R:/10.1.0.237:8135] READ COMPLETE\r\n2021-02-26 09:25:58.711+00:00 | nioEventLoopGroup-25-1 | DEBUG | mux | [id: 0xa2689dd2, L:/10.1.0.237:46738 - R:/10.1.0.237:8135] WRITE: MuxFrame(id=a2689dd2/18/true, flag=DATA, data=20ff060000734e6150705900260000bb24f195207c2448db28b230abf257ed6f8dfb78ae32d32e77d923e9653e197ea5a86475e82c), 53B\r\n         +-------------------------------------------------+\r\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\r\n+--------+-------------------------------------------------+----------------+\r\n|00000000| 20 ff 06 00 00 73 4e 61 50 70 59 00 26 00 00 bb | ....sNaPpY.&...|\r\n|00000010| 24 f1 95 20 7c 24 48 db 28 b2 30 ab f2 57 ed 6f |$.. |$H.(.0..W.o|\r\n|00000020| 8d fb 78 ae 32 d3 2e 77 d9 23 e9 65 3e 19 7e a5 |..x.2..w.#.e>.~.|\r\n|00000030| a8 64 75 e8 2c                                  |.du.,           |\r\n+--------+-------------------------------------------------+----------------+\r\n2021-02-26 09:25:58.711+00:00 | nioEventLoopGroup-25-1 | DEBUG | mux | [id: 0xa2689dd2, L:/10.1.0.237:46738 - R:/10.1.0.237:8135] FLUSH\r\n2021-02-26 09:25:58.712+00:00 | nioEventLoopGroup-23-1 | DEBUG | mux | [id: 0x5196576f, L:/10.1.0.237:8135 - R:/10.1.0.237:46738] READ: MplexFrame(id=5196576f/18/false, flag=DATA (init), data=20ff060000734e6150705900260000bb24f195207c2448db28b230abf257ed6f8dfb78ae32d32e77d923e9653e197ea5a86475e82c), 53B\r\n         +-------------------------------------------------+\r\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\r\n+--------+-------------------------------------------------+----------------+\r\n|00000000| 20 ff 06 00 00 73 4e 61 50 70 59 00 26 00 00 bb | ....sNaPpY.&...|\r\n|00000010| 24 f1 95 20 7c 24 48 db 28 b2 30 ab f2 57 ed 6f |$.. |$H.(.0..W.o|\r\n|00000020| 8d fb 78 ae 32 d3 2e 77 d9 23 e9 65 3e 19 7e a5 |..x.2..w.#.e>.~.|\r\n|00000030| a8 64 75 e8 2c                                  |.du.,           |\r\n+--------+-------------------------------------------------+----------------+\r\n2021-02-26 09:25:58.713+00:00 | nioEventLoopGroup-23-1 | DEBUG | mux | [id: 0x5196576f, L:/10.1.0.237:8135 - R:/10.1.0.237:46738] WRITE: MuxFrame(id=5196576f/18/false, flag=DATA, data=009403ff060000734e6150705900690100651362ee9403f0696400000091cfaf8eb5eea7f2060097de73ee9f7b0041a66d7ecfefcc27cf7fbfdbeff2dd070035324d13c06d66e472813313ea5b061fd1577efd8b95e90584466bb078bcaabcca2072a8eb9862240dc165fe4564e46b5cb6a080a51c27d2e20d8d42a3ab0100000000001903f0c46746e70ca3650fde87a039db48f9d1ff3877798112e2bd940f8987e2f76c93312fa3f43a078e611b3951d755694bceb21a8191b7d14ece1ee3586cc39afbe3ba54000000a147f3b824f451fb3d7e89594f466250072602bba8003820549998aba85f46694286d28f860213e3b7b2fd7b5d18787c10158cf819eb712a5fe351540d40580e7cb6095507a04f58bfcf02379c8c71d355976d465fd7b52e696d0931c2a3d6b4f0a0278e4372459cca6159cd5e71cfee638302a7b9ca9b05c34181ac0a65ac5d030dcf807ef0ca626bbb058dd443bb78e33b888bdec8295c96e51f5545f96370870c10b9007a010008dc0000420400), 378B\r\n         +-------------------------------------------------+\r\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\r\n+--------+-------------------------------------------------+----------------+\r\n|00000000| 00 94 03 ff 06 00 00 73 4e 61 50 70 59 00 69 01 |.......sNaPpY.i.|\r\n|00000010| 00 65 13 62 ee 94 03 f0 69 64 00 00 00 91 cf af |.e.b....id......|\r\n|00000020| 8e b5 ee a7 f2 06 00 97 de 73 ee 9f 7b 00 41 a6 |.........s..{.A.|\r\n|00000030| 6d 7e cf ef cc 27 cf 7f bf db ef f2 dd 07 00 35 |m~...'.........5|\r\n|00000040| 32 4d 13 c0 6d 66 e4 72 81 33 13 ea 5b 06 1f d1 |2M..mf.r.3..[...|\r\n|00000050| 57 7e fd 8b 95 e9 05 84 46 6b b0 78 bc aa bc ca |W~......Fk.x....|\r\n|00000060| 20 72 a8 eb 98 62 24 0d c1 65 fe 45 64 e4 6b 5c | r...b$..e.Ed.k\\|\r\n|00000070| b6 a0 80 a5 1c 27 d2 e2 0d 8d 42 a3 ab 01 00 00 |.....'....B.....|\r\n|00000080| 00 00 00 19 03 f0 c4 67 46 e7 0c a3 65 0f de 87 |.......gF...e...|\r\n|00000090| a0 39 db 48 f9 d1 ff 38 77 79 81 12 e2 bd 94 0f |.9.H...8wy......|\r\n|000000a0| 89 87 e2 f7 6c 93 31 2f a3 f4 3a 07 8e 61 1b 39 |....l.1/..:..a.9|\r\n|000000b0| 51 d7 55 69 4b ce b2 1a 81 91 b7 d1 4e ce 1e e3 |Q.UiK.......N...|\r\n|000000c0| 58 6c c3 9a fb e3 ba 54 00 00 00 a1 47 f3 b8 24 |Xl.....T....G..$|\r\n|000000d0| f4 51 fb 3d 7e 89 59 4f 46 62 50 07 26 02 bb a8 |.Q.=~.YOFbP.&...|\r\n|000000e0| 00 38 20 54 99 98 ab a8 5f 46 69 42 86 d2 8f 86 |.8 T...._FiB....|\r\n|000000f0| 02 13 e3 b7 b2 fd 7b 5d 18 78 7c 10 15 8c f8 19 |......{].x|.....|\r\n|00000100| eb 71 2a 5f e3 51 54 0d 40 58 0e 7c b6 09 55 07 |.q*_.QT.@X.|..U.|\r\n|00000110| a0 4f 58 bf cf 02 37 9c 8c 71 d3 55 97 6d 46 5f |.OX...7..q.U.mF_|\r\n|00000120| d7 b5 2e 69 6d 09 31 c2 a3 d6 b4 f0 a0 27 8e 43 |...im.1......'.C|\r\n|00000130| 72 45 9c ca 61 59 cd 5e 71 cf ee 63 83 02 a7 b9 |rE..aY.^q..c....|\r\n|00000140| ca 9b 05 c3 41 81 ac 0a 65 ac 5d 03 0d cf 80 7e |....A...e.]....~|\r\n|00000150| f0 ca 62 6b bb 05 8d d4 43 bb 78 e3 3b 88 8b de |..bk....C.x.;...|\r\n|00000160| c8 29 5c 96 e5 1f 55 45 f9 63 70 87 0c 10 b9 00 |.)\\...UE.cp.....|\r\n|00000170| 7a 01 00 08 dc 00 00 42 04 00                   |z......B..      |\r\n+--------+-------------------------------------------------+----------------+\r\n2021-02-26 09:25:58.713+00:00 | nioEventLoopGroup-23-1 | DEBUG | mux | [id: 0x5196576f, L:/10.1.0.237:8135 - R:/10.1.0.237:46738] FLUSH\r\n2021-02-26 09:25:58.714+00:00 | nioEventLoopGroup-25-1 | DEBUG | mux | [id: 0xa2689dd2, L:/10.1.0.237:46738 - R:/10.1.0.237:8135] READ: MplexFrame(id=a2689dd2/18/true, flag=DATA (resp), data=009403ff060000734e6150705900690100651362ee9403f0696400000091cfaf8eb5eea7f2060097de73ee9f7b0041a66d7ecfefcc27cf7fbfdbeff2dd070035324d13c06d66e472813313ea5b061fd1577efd8b95e90584466bb078bcaabcca2072a8eb9862240dc165fe4564e46b5cb6a080a51c27d2e20d8d42a3ab0100000000001903f0c46746e70ca3650fde87a039db48f9d1ff3877798112e2bd940f8987e2f76c93312fa3f43a078e611b3951d755694bceb21a8191b7d14ece1ee3586cc39afbe3ba54000000a147f3b824f451fb3d7e89594f466250072602bba8003820549998aba85f46694286d28f860213e3b7b2fd7b5d18787c10158cf819eb712a5fe351540d40580e7cb6095507a04f58bfcf02379c8c71d355976d465fd7b52e696d0931c2a3d6b4f0a0278e4372459cca6159cd5e71cfee638302a7b9ca9b05c34181ac0a65ac5d030dcf807ef0ca626bbb058dd443bb78e33b888bdec8295c96e51f5545f96370870c10b9007a010008dc0000420400), 378B\r\n         +-------------------------------------------------+\r\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\r\n+--------+-------------------------------------------------+----------------+\r\n|00000000| 00 94 03 ff 06 00 00 73 4e 61 50 70 59 00 69 01 |.......sNaPpY.i.|\r\n|00000010| 00 65 13 62 ee 94 03 f0 69 64 00 00 00 91 cf af |.e.b....id......|\r\n|00000020| 8e b5 ee a7 f2 06 00 97 de 73 ee 9f 7b 00 41 a6 |.........s..{.A.|\r\n|00000030| 6d 7e cf ef cc 27 cf 7f bf db ef f2 dd 07 00 35 |m~...'.........5|\r\n|00000040| 32 4d 13 c0 6d 66 e4 72 81 33 13 ea 5b 06 1f d1 |2M..mf.r.3..[...|\r\n|00000050| 57 7e fd 8b 95 e9 05 84 46 6b b0 78 bc aa bc ca |W~......Fk.x....|\r\n|00000060| 20 72 a8 eb 98 62 24 0d c1 65 fe 45 64 e4 6b 5c | r...b$..e.Ed.k\\|\r\n|00000070| b6 a0 80 a5 1c 27 d2 e2 0d 8d 42 a3 ab 01 00 00 |.....'....B.....|\r\n|00000080| 00 00 00 19 03 f0 c4 67 46 e7 0c a3 65 0f de 87 |.......gF...e...|\r\n|00000090| a0 39 db 48 f9 d1 ff 38 77 79 81 12 e2 bd 94 0f |.9.H...8wy......|\r\n|000000a0| 89 87 e2 f7 6c 93 31 2f a3 f4 3a 07 8e 61 1b 39 |....l.1/..:..a.9|\r\n|000000b0| 51 d7 55 69 4b ce b2 1a 81 91 b7 d1 4e ce 1e e3 |Q.UiK.......N...|\r\n|000000c0| 58 6c c3 9a fb e3 ba 54 00 00 00 a1 47 f3 b8 24 |Xl.....T....G..$|\r\n|000000d0| f4 51 fb 3d 7e 89 59 4f 46 62 50 07 26 02 bb a8 |.Q.=~.YOFbP.&...|\r\n|000000e0| 00 38 20 54 99 98 ab a8 5f 46 69 42 86 d2 8f 86 |.8 T...._FiB....|\r\n|000000f0| 02 13 e3 b7 b2 fd 7b 5d 18 78 7c 10 15 8c f8 19 |......{].x|.....|\r\n|00000100| eb 71 2a 5f e3 51 54 0d 40 58 0e 7c b6 09 55 07 |.q*_.QT.@X.|..U.|\r\n|00000110| a0 4f 58 bf cf 02 37 9c 8c 71 d3 55 97 6d 46 5f |.OX...7..q.U.mF_|\r\n|00000120| d7 b5 2e 69 6d 09 31 c2 a3 d6 b4 f0 a0 27 8e 43 |...im.1......'.C|\r\n|00000130| 72 45 9c ca 61 59 cd 5e 71 cf ee 63 83 02 a7 b9 |rE..aY.^q..c....|\r\n|00000140| ca 9b 05 c3 41 81 ac 0a 65 ac 5d 03 0d cf 80 7e |....A...e.]....~|\r\n|00000150| f0 ca 62 6b bb 05 8d d4 43 bb 78 e3 3b 88 8b de |..bk....C.x.;...|\r\n|00000160| c8 29 5c 96 e5 1f 55 45 f9 63 70 87 0c 10 b9 00 |.)\\...UE.cp.....|\r\n|00000170| 7a 01 00 08 dc 00 00 42 04 00                   |z......B..      |\r\n+--------+-------------------------------------------------+----------------+\r\n2021-02-26 09:25:58.714+00:00 | nioEventLoopGroup-23-1 | DEBUG | mux | [id: 0x5196576f, L:/10.1.0.237:8135 - R:/10.1.0.237:46738] WRITE, MuxFrame(id=5196576f/18/false, flag=CLOSE, data=null), 0B\r\n2021-02-26 09:25:58.715+00:00 | nioEventLoopGroup-25-1 | DEBUG | mux | [id: 0xa2689dd2, L:/10.1.0.237:46738 - R:/10.1.0.237:8135] WRITE, MuxFrame(id=a2689dd2/18/true, flag=RESET, data=null), 0B\r\n2021-02-26 09:25:58.716+00:00 | nioEventLoopGroup-23-1 | DEBUG | mux | [id: 0x5196576f, L:/10.1.0.237:8135 - R:/10.1.0.237:46738] FLUSH\r\n2021-02-26 09:25:58.716+00:00 | nioEventLoopGroup-23-1 | DEBUG | mux | [id: 0x5196576f, L:/10.1.0.237:8135 - R:/10.1.0.237:46738] READ COMPLETE\r\n2021-02-26 09:25:58.716+00:00 | nioEventLoopGroup-25-1 | DEBUG | mux | [id: 0xa2689dd2, L:/10.1.0.237:46738 - R:/10.1.0.237:8135] FLUSH\r\n2021-02-26 09:25:58.717+00:00 | nioEventLoopGroup-25-1 | DEBUG | mux | [id: 0xa2689dd2, L:/10.1.0.237:46738 - R:/10.1.0.237:8135] READ COMPLETE\r\n2021-02-26 09:25:58.718+00:00 | nioEventLoopGroup-23-1 | DEBUG | mux | [id: 0x5196576f, L:/10.1.0.237:8135 - R:/10.1.0.237:46738] READ, MplexFrame(id=5196576f/18/false, flag=RESET (init), data=), 0B\r\n2021-02-26 09:25:58.718+00:00 | nioEventLoopGroup-23-1 | DEBUG | mux | [id: 0x5196576f, L:/10.1.0.237:8135 - R:/10.1.0.237:46738] READ COMPLETE\r\n2021-02-26 09:25:58.719+00:00 | nioEventLoopGroup-25-1 | DEBUG | mux | [id: 0xa2689dd2, L:/10.1.0.237:46738 - R:/10.1.0.237:8135] READ, MplexFrame(id=a2689dd2/18/true, flag=CLOSE (resp), data=), 0B\r\n2021-02-26 09:25:58.719+00:00 | nioEventLoopGroup-25-1 | DEBUG | mux | [id: 0xa2689dd2, L:/10.1.0.237:46738 - R:/10.1.0.237:8135] READ COMPLETE\r\n```",
  "closed_by": {
    "login": "Nashatyrev",
    "id": 8173857,
    "node_id": "MDQ6VXNlcjgxNzM4NTc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/8173857?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Nashatyrev",
    "html_url": "https://github.com/Nashatyrev",
    "followers_url": "https://api.github.com/users/Nashatyrev/followers",
    "following_url": "https://api.github.com/users/Nashatyrev/following{/other_user}",
    "gists_url": "https://api.github.com/users/Nashatyrev/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Nashatyrev/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Nashatyrev/subscriptions",
    "organizations_url": "https://api.github.com/users/Nashatyrev/orgs",
    "repos_url": "https://api.github.com/users/Nashatyrev/repos",
    "events_url": "https://api.github.com/users/Nashatyrev/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Nashatyrev/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/3669/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ConsenSys/teku/issues/3669/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/786686937",
    "html_url": "https://github.com/ConsenSys/teku/issues/3669#issuecomment-786686937",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/3669",
    "id": 786686937,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc4NjY4NjkzNw==",
    "user": {
      "login": "Nashatyrev",
      "id": 8173857,
      "node_id": "MDQ6VXNlcjgxNzM4NTc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8173857?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Nashatyrev",
      "html_url": "https://github.com/Nashatyrev",
      "followers_url": "https://api.github.com/users/Nashatyrev/followers",
      "following_url": "https://api.github.com/users/Nashatyrev/following{/other_user}",
      "gists_url": "https://api.github.com/users/Nashatyrev/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Nashatyrev/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Nashatyrev/subscriptions",
      "organizations_url": "https://api.github.com/users/Nashatyrev/orgs",
      "repos_url": "https://api.github.com/users/Nashatyrev/repos",
      "events_url": "https://api.github.com/users/Nashatyrev/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Nashatyrev/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-02-26T14:39:42Z",
    "updated_at": "2021-02-26T14:39:42Z",
    "author_association": "CONTRIBUTOR",
    "body": "Couldn't reproduce this by suspending requester stream `CLOSE` so this is not the root reason. \r\nUsed the following tweak to suspend \r\n```patch\r\nIndex: networking/p2p/src/main/java/tech/pegasys/teku/networking/p2p/libp2p/MplexFirewall.java\r\nIDEA additional info:\r\nSubsystem: com.intellij.openapi.diff.impl.patch.CharsetEP\r\n<+>UTF-8\r\n===================================================================\r\n--- networking/p2p/src/main/java/tech/pegasys/teku/networking/p2p/libp2p/MplexFirewall.java\t(revision eee8a286bee499057af104f83e4749686783d6d2)\r\n+++ networking/p2p/src/main/java/tech/pegasys/teku/networking/p2p/libp2p/MplexFirewall.java\t(date 1614342544080)\r\n@@ -18,9 +18,12 @@\r\n import io.libp2p.core.Connection;\r\n import io.libp2p.etc.util.netty.mux.MuxId;\r\n import io.libp2p.mux.MuxFrame;\r\n+import io.libp2p.mux.MuxFrame.Flag;\r\n+import io.netty.buffer.ByteBuf;\r\n import io.netty.channel.ChannelDuplexHandler;\r\n import io.netty.channel.ChannelHandlerContext;\r\n import io.netty.channel.ChannelPromise;\r\n+import java.nio.charset.StandardCharsets;\r\n import java.util.HashSet;\r\n import java.util.Set;\r\n import java.util.function.Supplier;\r\n@@ -110,6 +113,8 @@\r\n       }\r\n     }\r\n \r\n+\r\n+    MuxId rpcStreamId;\r\n     @Override\r\n     public void write(ChannelHandlerContext ctx, Object msg, ChannelPromise promise) {\r\n       MuxFrame muxFrame = (MuxFrame) msg;\r\n@@ -117,6 +122,21 @@\r\n         // Track only RESET since CLOSE from local doesn't close the stream for writing from remote\r\n         remoteOpenedStreamIds.remove(muxFrame.getId());\r\n       }\r\n+      if (muxFrame.getFlag() == Flag.DATA) {\r\n+        String rpcPattern = \"/eth2/beacon_chain/req/beacon_blocks_by_root/\";\r\n+        if (muxFrame.getData().readableBytes() > 16) {\r\n+          ByteBuf testBuf = muxFrame.getData().slice(1, rpcPattern.length());\r\n+          CharSequence sequence = testBuf\r\n+              .getCharSequence(0, testBuf.readableBytes(), StandardCharsets.UTF_8);\r\n+          if (CharSequence.compare(sequence, rpcPattern) == 0) {\r\n+            rpcStreamId = muxFrame.getId();\r\n+          }\r\n+        }\r\n+      }\r\n+      if (muxFrame.getFlag() == Flag.CLOSE && muxFrame.getId().equals(rpcStreamId) && muxFrame.getId().getInitiator()) {\r\n+        System.err.println(\"Ignore CLOSE write for \" + rpcStreamId);\r\n+        return;\r\n+      }\r\n       // ignoring since the write() just returns `promise` instance\r\n       FutureUtil.ignoreFuture(ctx.write(msg, promise));\r\n     }\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/786686937/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/786705594",
    "html_url": "https://github.com/ConsenSys/teku/issues/3669#issuecomment-786705594",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/3669",
    "id": 786705594,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc4NjcwNTU5NA==",
    "user": {
      "login": "Nashatyrev",
      "id": 8173857,
      "node_id": "MDQ6VXNlcjgxNzM4NTc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8173857?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Nashatyrev",
      "html_url": "https://github.com/Nashatyrev",
      "followers_url": "https://api.github.com/users/Nashatyrev/followers",
      "following_url": "https://api.github.com/users/Nashatyrev/following{/other_user}",
      "gists_url": "https://api.github.com/users/Nashatyrev/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Nashatyrev/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Nashatyrev/subscriptions",
      "organizations_url": "https://api.github.com/users/Nashatyrev/orgs",
      "repos_url": "https://api.github.com/users/Nashatyrev/repos",
      "events_url": "https://api.github.com/users/Nashatyrev/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Nashatyrev/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-02-26T15:10:52Z",
    "updated_at": "2021-02-26T15:10:52Z",
    "author_association": "CONTRIBUTOR",
    "body": "Adding the full test report:\r\n[tests.tar.gz](https://github.com/ConsenSys/teku/files/6050496/tests.tar.gz)\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/786705594/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
