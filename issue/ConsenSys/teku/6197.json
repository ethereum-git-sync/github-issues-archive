{
  "url": "https://api.github.com/repos/ConsenSys/teku/issues/6197",
  "repository_url": "https://api.github.com/repos/ConsenSys/teku",
  "labels_url": "https://api.github.com/repos/ConsenSys/teku/issues/6197/labels{/name}",
  "comments_url": "https://api.github.com/repos/ConsenSys/teku/issues/6197/comments",
  "events_url": "https://api.github.com/repos/ConsenSys/teku/issues/6197/events",
  "html_url": "https://github.com/ConsenSys/teku/issues/6197",
  "id": 1372029182,
  "node_id": "I_kwDOCM9I9M5Rx4D-",
  "number": 6197,
  "title": "reorg depth 0 seen on event stream",
  "user": {
    "login": "rolfyone",
    "id": 2967240,
    "node_id": "MDQ6VXNlcjI5NjcyNDA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2967240?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/rolfyone",
    "html_url": "https://github.com/rolfyone",
    "followers_url": "https://api.github.com/users/rolfyone/followers",
    "following_url": "https://api.github.com/users/rolfyone/following{/other_user}",
    "gists_url": "https://api.github.com/users/rolfyone/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/rolfyone/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rolfyone/subscriptions",
    "organizations_url": "https://api.github.com/users/rolfyone/orgs",
    "repos_url": "https://api.github.com/users/rolfyone/repos",
    "events_url": "https://api.github.com/users/rolfyone/events{/privacy}",
    "received_events_url": "https://api.github.com/users/rolfyone/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "zilm13",
    "id": 6196452,
    "node_id": "MDQ6VXNlcjYxOTY0NTI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6196452?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/zilm13",
    "html_url": "https://github.com/zilm13",
    "followers_url": "https://api.github.com/users/zilm13/followers",
    "following_url": "https://api.github.com/users/zilm13/following{/other_user}",
    "gists_url": "https://api.github.com/users/zilm13/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/zilm13/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/zilm13/subscriptions",
    "organizations_url": "https://api.github.com/users/zilm13/orgs",
    "repos_url": "https://api.github.com/users/zilm13/repos",
    "events_url": "https://api.github.com/users/zilm13/events{/privacy}",
    "received_events_url": "https://api.github.com/users/zilm13/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "zilm13",
      "id": 6196452,
      "node_id": "MDQ6VXNlcjYxOTY0NTI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6196452?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/zilm13",
      "html_url": "https://github.com/zilm13",
      "followers_url": "https://api.github.com/users/zilm13/followers",
      "following_url": "https://api.github.com/users/zilm13/following{/other_user}",
      "gists_url": "https://api.github.com/users/zilm13/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/zilm13/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/zilm13/subscriptions",
      "organizations_url": "https://api.github.com/users/zilm13/orgs",
      "repos_url": "https://api.github.com/users/zilm13/repos",
      "events_url": "https://api.github.com/users/zilm13/events{/privacy}",
      "received_events_url": "https://api.github.com/users/zilm13/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 6,
  "created_at": "2022-09-13T21:32:11Z",
  "updated_at": "2022-11-10T22:53:25Z",
  "closed_at": "2022-11-10T22:53:25Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "It looks like we got both blocks, and set 775 to head before 774 was made head, then went back to 774 being head first...\n\nhttps://beaconcha.in/block/4683774 (new head)\nhttps://beaconcha.in/block/4683775 (old head)\n```\n{\n  slot: '4683774',\n  depth: '0',\n  old_head_block: '0xb942665c2eb6093ce53e46db6f458fbd32f5ec44f320ad63b569854592cbd26e',\n  new_head_block: '0xeed75ccb5201c46614121324c7203e23b22ca166741fdb59bb426482b76369c4',\n  old_head_state: '0x5b3363a7d5d7e2d38400742402e0b7b9be2fe8ce57c814aa7c035b983a715570',\n  new_head_state: '0xe73d572c268d568284c919bb4e25951d27dc0bca48ce6e99ccde3db386ea8603',\n  epoch: '146367',\n  execution_optimistic: false\n}\n```",
  "closed_by": {
    "login": "ajsutton",
    "id": 72675,
    "node_id": "MDQ6VXNlcjcyNjc1",
    "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ajsutton",
    "html_url": "https://github.com/ajsutton",
    "followers_url": "https://api.github.com/users/ajsutton/followers",
    "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
    "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
    "organizations_url": "https://api.github.com/users/ajsutton/orgs",
    "repos_url": "https://api.github.com/users/ajsutton/repos",
    "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ajsutton/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/6197/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ConsenSys/teku/issues/6197/timeline",
  "performed_via_github_app": null,
  "state_reason": "not_planned"
}
[
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1245980073",
    "html_url": "https://github.com/ConsenSys/teku/issues/6197#issuecomment-1245980073",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/6197",
    "id": 1245980073,
    "node_id": "IC_kwDOCM9I9M5KRCWp",
    "user": {
      "login": "rolfyone",
      "id": 2967240,
      "node_id": "MDQ6VXNlcjI5NjcyNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2967240?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rolfyone",
      "html_url": "https://github.com/rolfyone",
      "followers_url": "https://api.github.com/users/rolfyone/followers",
      "following_url": "https://api.github.com/users/rolfyone/following{/other_user}",
      "gists_url": "https://api.github.com/users/rolfyone/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rolfyone/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rolfyone/subscriptions",
      "organizations_url": "https://api.github.com/users/rolfyone/orgs",
      "repos_url": "https://api.github.com/users/rolfyone/repos",
      "events_url": "https://api.github.com/users/rolfyone/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rolfyone/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-13T21:39:08Z",
    "updated_at": "2022-09-13T21:39:08Z",
    "author_association": "CONTRIBUTOR",
    "body": "side note - depth should also probably be using `minusMinZero`...",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1245980073/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1304504444",
    "html_url": "https://github.com/ConsenSys/teku/issues/6197#issuecomment-1304504444",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/6197",
    "id": 1304504444,
    "node_id": "IC_kwDOCM9I9M5NwSh8",
    "user": {
      "login": "zilm13",
      "id": 6196452,
      "node_id": "MDQ6VXNlcjYxOTY0NTI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6196452?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/zilm13",
      "html_url": "https://github.com/zilm13",
      "followers_url": "https://api.github.com/users/zilm13/followers",
      "following_url": "https://api.github.com/users/zilm13/following{/other_user}",
      "gists_url": "https://api.github.com/users/zilm13/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/zilm13/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/zilm13/subscriptions",
      "organizations_url": "https://api.github.com/users/zilm13/orgs",
      "repos_url": "https://api.github.com/users/zilm13/repos",
      "events_url": "https://api.github.com/users/zilm13/events{/privacy}",
      "received_events_url": "https://api.github.com/users/zilm13/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-11-05T11:43:54Z",
    "updated_at": "2022-11-05T11:45:04Z",
    "author_association": "CONTRIBUTOR",
    "body": "I've tested following ideas and now stuck:\r\n1. could be imported in reverse order - impossible, checks parent execution root during import\r\n2. `updateHead` could be called not only on import (`ForkChoice.processHead()` path):\r\n- it's called on invalid payloads\r\n- it's called when preparing for block production\r\nCouldn't be raced there, runs on `ForkChoiceThread`  \r\nalso `updateHead` is called on init - not our case\r\n3. could be imported 774, 775, 774 by some reason, it could give reorg like in issue. Could we import the block that is already imported?\r\nMade a test\r\n```\r\n  @Test\r\n  void onBlockReImport_shouldNotSendForkChoiceUpdatedNotification() {\r\n    final SignedBlockAndState blockAndState = chainBuilder.generateBlockAtSlot(ONE);\r\n    final SignedBlockAndState blockAndState2 = chainBuilder.generateBlockAtSlot(UInt64.valueOf(2));\r\n    storageSystem.chainUpdater().advanceCurrentSlotToAtLeast(blockAndState.getSlot());\r\n    final SafeFuture<BlockImportResult> importResult =\r\n      forkChoice.onBlock(blockAndState.getBlock(), Optional.empty(), executionLayer);\r\n    storageSystem.chainUpdater().advanceCurrentSlotToAtLeast(blockAndState2.getSlot());\r\n    final SafeFuture<BlockImportResult> importResult2 =\r\n      forkChoice.onBlock(blockAndState2.getBlock(), Optional.empty(), executionLayer);\r\n    final SafeFuture<BlockImportResult> importResult3 =\r\n      forkChoice.onBlock(blockAndState.getBlock(), Optional.empty(), executionLayer);\r\n    assertBlockImportedSuccessfully(importResult, false);\r\n    assertBlockImportedSuccessfully(importResult2, false);\r\n    assertBlockImportedSuccessfully(importResult3, false);\r\n\r\n    assertForkChoiceUpdateNotification(blockAndState, false);\r\n    assertForkChoiceUpdateNotification(blockAndState2, false);\r\n  }\r\n```  \r\nIt passes `assertForkChoiceUpdateNotification(blockAndState, false);`, so shouldn't be in issue. And even if we have race between 2nd and 3rd import before calling `importBlockAndState`, which only runs on `ForkChoiceThread`, we will not get such reorg as in issue.\r\n\r\n4. there was a bug in code at the moment of creating issue, now fixed\r\n`ForkChoice.java` - no changes, which could affect this behaviour\r\n`ForkChoiceNotifierImpl.java` - some changes related to block production preparation, shouldn't affect\r\n`RecentChainData.java` - identical\r\nSo, miss again",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1304504444/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1308538517",
    "html_url": "https://github.com/ConsenSys/teku/issues/6197#issuecomment-1308538517",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/6197",
    "id": 1308538517,
    "node_id": "IC_kwDOCM9I9M5N_raV",
    "user": {
      "login": "rolfyone",
      "id": 2967240,
      "node_id": "MDQ6VXNlcjI5NjcyNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2967240?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rolfyone",
      "html_url": "https://github.com/rolfyone",
      "followers_url": "https://api.github.com/users/rolfyone/followers",
      "following_url": "https://api.github.com/users/rolfyone/following{/other_user}",
      "gists_url": "https://api.github.com/users/rolfyone/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rolfyone/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rolfyone/subscriptions",
      "organizations_url": "https://api.github.com/users/rolfyone/orgs",
      "repos_url": "https://api.github.com/users/rolfyone/repos",
      "events_url": "https://api.github.com/users/rolfyone/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rolfyone/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-11-09T10:27:27Z",
    "updated_at": "2022-11-09T10:27:36Z",
    "author_association": "CONTRIBUTOR",
    "body": "the format is from EventSubscription in json, which is where it was reported by user to have a reorg depth 0...\r\n\r\nI'm not sure if that code is generating a reorg for the above test case, but i'd suggest that's where we're interested in probing, maybe a log for when that reorg gets triggered with depth 0 or something... \r\n```\r\n\r\nReorg Event *** New Head: b836ab11206d22c406e22e928242a79fcf0b8f911438ff7f558b47dd489197ea (4246125), Previous Head: 78029545df7a1c7105e9b38ae2f810e859809ef5149093566f9bdf2484769ea9 (4246126), Common Ancestor: 3a530a25df5ef52546d37f68a8d838d86cf9f0f2342b81587ed0cb0139b38a31 (4246123)\r\n  |   | Nov 3, 2022 @ 17:11:16.257 | Reorg Event *** New Head: cf137ba0673f3013c8c071e37db0c80c9435ce71759fc9c71bef5b7635105c54 (4245956), Previous Head: d2e6c2c15111a057a58048371fee9f1c23220a4702849d4ff801299eeb15a2d3 (4245955), Common Ancestor: 941cf6629e2542dc159a0c240ad5651dc4d0dc0376e3edc7ba8980036df01e90 (4245954)\r\n```\r\nwouldn't be surprised if that reorg event came through event subscriptions poorly... but we don't subscribe so it's hard to know...",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1308538517/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1310647626",
    "html_url": "https://github.com/ConsenSys/teku/issues/6197#issuecomment-1310647626",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/6197",
    "id": 1310647626,
    "node_id": "IC_kwDOCM9I9M5OHuVK",
    "user": {
      "login": "zilm13",
      "id": 6196452,
      "node_id": "MDQ6VXNlcjYxOTY0NTI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6196452?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/zilm13",
      "html_url": "https://github.com/zilm13",
      "followers_url": "https://api.github.com/users/zilm13/followers",
      "following_url": "https://api.github.com/users/zilm13/following{/other_user}",
      "gists_url": "https://api.github.com/users/zilm13/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/zilm13/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/zilm13/subscriptions",
      "organizations_url": "https://api.github.com/users/zilm13/orgs",
      "repos_url": "https://api.github.com/users/zilm13/repos",
      "events_url": "https://api.github.com/users/zilm13/events{/privacy}",
      "received_events_url": "https://api.github.com/users/zilm13/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-11-10T17:32:30Z",
    "updated_at": "2022-11-10T17:32:56Z",
    "author_association": "CONTRIBUTOR",
    "body": "This kind of event could be triggered by calling \r\n```\r\nRecentChainData.updateHead(774);\r\nRecentChainData.updateHead(775);\r\nRecentChainData.updateHead(774);\r\n```\r\non the last call `updateHead` will call `OperationsReOrgManager.chainHeadUpdated`with context which will trigger similar event,\r\nbut I've not found a way we could call it in this order as all callers are in `ForkChoiceThread` so the last call couldn't be happened. I've moved from `updateHead` to all its callers way upper and upper and stuck with no evidence how this could happen\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1310647626/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1310997716",
    "html_url": "https://github.com/ConsenSys/teku/issues/6197#issuecomment-1310997716",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/6197",
    "id": 1310997716,
    "node_id": "IC_kwDOCM9I9M5OJDzU",
    "user": {
      "login": "lucassaldanha",
      "id": 1766440,
      "node_id": "MDQ6VXNlcjE3NjY0NDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1766440?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/lucassaldanha",
      "html_url": "https://github.com/lucassaldanha",
      "followers_url": "https://api.github.com/users/lucassaldanha/followers",
      "following_url": "https://api.github.com/users/lucassaldanha/following{/other_user}",
      "gists_url": "https://api.github.com/users/lucassaldanha/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/lucassaldanha/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/lucassaldanha/subscriptions",
      "organizations_url": "https://api.github.com/users/lucassaldanha/orgs",
      "repos_url": "https://api.github.com/users/lucassaldanha/repos",
      "events_url": "https://api.github.com/users/lucassaldanha/events{/privacy}",
      "received_events_url": "https://api.github.com/users/lucassaldanha/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-11-10T22:49:26Z",
    "updated_at": "2022-11-10T22:49:26Z",
    "author_association": "MEMBER",
    "body": "> stuck with no evidence how this could happen\n\nI think it is time to close this ticket. We don't really have a way of reproducing it and we haven't received any new reports about it.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1310997716/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1311000565",
    "html_url": "https://github.com/ConsenSys/teku/issues/6197#issuecomment-1311000565",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/6197",
    "id": 1311000565,
    "node_id": "IC_kwDOCM9I9M5OJEf1",
    "user": {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-11-10T22:53:25Z",
    "updated_at": "2022-11-10T22:53:25Z",
    "author_association": "CONTRIBUTOR",
    "body": "Agreed, closing as can't reproduce. :( ",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1311000565/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
