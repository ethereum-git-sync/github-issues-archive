{
  "url": "https://api.github.com/repos/ConsenSys/teku/issues/6105",
  "repository_url": "https://api.github.com/repos/ConsenSys/teku",
  "labels_url": "https://api.github.com/repos/ConsenSys/teku/issues/6105/labels{/name}",
  "comments_url": "https://api.github.com/repos/ConsenSys/teku/issues/6105/comments",
  "events_url": "https://api.github.com/repos/ConsenSys/teku/issues/6105/events",
  "html_url": "https://github.com/ConsenSys/teku/issues/6105",
  "id": 1345609797,
  "node_id": "I_kwDOCM9I9M5QNGBF",
  "number": 6105,
  "title": "Don't make first descendant of head the new chain head",
  "user": {
    "login": "ajsutton",
    "id": 72675,
    "node_id": "MDQ6VXNlcjcyNjc1",
    "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ajsutton",
    "html_url": "https://github.com/ajsutton",
    "followers_url": "https://api.github.com/users/ajsutton/followers",
    "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
    "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
    "organizations_url": "https://api.github.com/users/ajsutton/orgs",
    "repos_url": "https://api.github.com/users/ajsutton/repos",
    "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ajsutton/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": {
    "login": "rolfyone",
    "id": 2967240,
    "node_id": "MDQ6VXNlcjI5NjcyNDA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2967240?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/rolfyone",
    "html_url": "https://github.com/rolfyone",
    "followers_url": "https://api.github.com/users/rolfyone/followers",
    "following_url": "https://api.github.com/users/rolfyone/following{/other_user}",
    "gists_url": "https://api.github.com/users/rolfyone/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/rolfyone/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rolfyone/subscriptions",
    "organizations_url": "https://api.github.com/users/rolfyone/orgs",
    "repos_url": "https://api.github.com/users/rolfyone/repos",
    "events_url": "https://api.github.com/users/rolfyone/events{/privacy}",
    "received_events_url": "https://api.github.com/users/rolfyone/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "rolfyone",
      "id": 2967240,
      "node_id": "MDQ6VXNlcjI5NjcyNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2967240?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rolfyone",
      "html_url": "https://github.com/rolfyone",
      "followers_url": "https://api.github.com/users/rolfyone/followers",
      "following_url": "https://api.github.com/users/rolfyone/following{/other_user}",
      "gists_url": "https://api.github.com/users/rolfyone/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rolfyone/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rolfyone/subscriptions",
      "organizations_url": "https://api.github.com/users/rolfyone/orgs",
      "repos_url": "https://api.github.com/users/rolfyone/repos",
      "events_url": "https://api.github.com/users/rolfyone/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rolfyone/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 7,
  "created_at": "2022-08-21T22:17:09Z",
  "updated_at": "2023-05-16T23:16:55Z",
  "closed_at": null,
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "### Description\nWay back, we implemented an optimisation for long sync where if the imported block is the child of the current canonical chain head, it would be set as the new head without having to run fork choice.\n\nWhile this still holds, during normal operation we run fork choice more often and there is more complexity around it. There is also a potential for race conditions as updating the chain head is an async operation - while they resolve themselves it leads to unnecessary reorgs.\n\nWe should investigate not automatically updating the chain head when a block is imported and leave it to be done when fork choice is next triggered to run.\n\nWe need to check if there are any async operations like retrieving a new justified/finalized state that should be preached to avoid delays.\nAlso need to ensure that the chain head gets updated often enough during a long sync and that performance isn't negatively affected.",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/6105/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ConsenSys/teku/issues/6105/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1234708287",
    "html_url": "https://github.com/ConsenSys/teku/issues/6105#issuecomment-1234708287",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/6105",
    "id": 1234708287,
    "node_id": "IC_kwDOCM9I9M5JmCc_",
    "user": {
      "login": "zilm13",
      "id": 6196452,
      "node_id": "MDQ6VXNlcjYxOTY0NTI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6196452?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/zilm13",
      "html_url": "https://github.com/zilm13",
      "followers_url": "https://api.github.com/users/zilm13/followers",
      "following_url": "https://api.github.com/users/zilm13/following{/other_user}",
      "gists_url": "https://api.github.com/users/zilm13/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/zilm13/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/zilm13/subscriptions",
      "organizations_url": "https://api.github.com/users/zilm13/orgs",
      "repos_url": "https://api.github.com/users/zilm13/repos",
      "events_url": "https://api.github.com/users/zilm13/events{/privacy}",
      "received_events_url": "https://api.github.com/users/zilm13/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-01T19:45:38Z",
    "updated_at": "2022-09-01T19:45:38Z",
    "author_association": "CONTRIBUTOR",
    "body": "Did I understand correctly that by optimization you mean not running explicitly [this method](https://github.com/ConsenSys/teku/blob/c3da1c9326ffe7aa6b7d7948db9b6217a7e0e473/ethereum/statetransition/src/main/java/tech/pegasys/teku/statetransition/forkchoice/ForkChoice.java#L177), so I need to:\r\n- remove setting a head on block import, it should be set by `processHead` when it's run (separately)\r\n- check when we run `processHead`, is there a potential for race but more likely reorgs, we should avoid it\r\n- check what could be cached there\r\n- check that during long sync head is not updated too rarely after changes\r\n- ensure performance isn't negatively affected ",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1234708287/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1235086598",
    "html_url": "https://github.com/ConsenSys/teku/issues/6105#issuecomment-1235086598",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/6105",
    "id": 1235086598,
    "node_id": "IC_kwDOCM9I9M5Jne0G",
    "user": {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-02T05:39:23Z",
    "updated_at": "2022-09-02T05:39:23Z",
    "author_association": "CONTRIBUTOR",
    "body": "The key thing is that we want to remove the logic that automatically makes a new block the chain head if it descends from the current head block (https://github.com/ConsenSys/teku/blob/c3da1c9326ffe7aa6b7d7948db9b6217a7e0e473/ethereum/statetransition/src/main/java/tech/pegasys/teku/statetransition/forkchoice/ForkChoice.java#L475-L486).\n\n> remove setting a head on block import, it should be set by processHead when it's run (separately)\n\nYes, I'm suggesting we think through what would happen if we didn't have `ForkChoice.updateForkChoiceForImportedBlock` which is updating the chain head as soon as we import the block. We would still be calling the `ForkChoice.processHead` method at the same times - that's the \"normal\" fork choice runs.\n\nThe first problem I can see is that we use the block import event to remove included operations from the pool if it's on the canonical chain but will now have to trigger that when we update the chain head, even if it's not strictly a reorg (ie if it just picks a new head further along the same fork).\n\n> check when we run processHead, is there a potential for race but more likely reorgs, we should avoid it\n\nI don't think this is an issue because we already have a bunch of controls around when `processHead` runs and it can handle if there are multiple updates in flight. We're just investigating not updating the head when a new block is imported.\n\n> check what could be cached there\n> check that during long sync head is not updated too rarely after changes\n> ensure performance isn't negatively affected\n\nYep to all these.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1235086598/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1294201801",
    "html_url": "https://github.com/ConsenSys/teku/issues/6105#issuecomment-1294201801",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/6105",
    "id": 1294201801,
    "node_id": "IC_kwDOCM9I9M5NI_PJ",
    "user": {
      "login": "rolfyone",
      "id": 2967240,
      "node_id": "MDQ6VXNlcjI5NjcyNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2967240?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rolfyone",
      "html_url": "https://github.com/rolfyone",
      "followers_url": "https://api.github.com/users/rolfyone/followers",
      "following_url": "https://api.github.com/users/rolfyone/following{/other_user}",
      "gists_url": "https://api.github.com/users/rolfyone/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rolfyone/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rolfyone/subscriptions",
      "organizations_url": "https://api.github.com/users/rolfyone/orgs",
      "repos_url": "https://api.github.com/users/rolfyone/repos",
      "events_url": "https://api.github.com/users/rolfyone/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rolfyone/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-10-27T22:41:24Z",
    "updated_at": "2022-10-27T22:41:24Z",
    "author_association": "CONTRIBUTOR",
    "body": "code complete behind a feature toggle, need to test this, back to bottom of current for now.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1294201801/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1467640077",
    "html_url": "https://github.com/ConsenSys/teku/issues/6105#issuecomment-1467640077",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/6105",
    "id": 1467640077,
    "node_id": "IC_kwDOCM9I9M5XemkN",
    "user": {
      "login": "lucassaldanha",
      "id": 1766440,
      "node_id": "MDQ6VXNlcjE3NjY0NDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1766440?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/lucassaldanha",
      "html_url": "https://github.com/lucassaldanha",
      "followers_url": "https://api.github.com/users/lucassaldanha/followers",
      "following_url": "https://api.github.com/users/lucassaldanha/following{/other_user}",
      "gists_url": "https://api.github.com/users/lucassaldanha/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/lucassaldanha/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/lucassaldanha/subscriptions",
      "organizations_url": "https://api.github.com/users/lucassaldanha/orgs",
      "repos_url": "https://api.github.com/users/lucassaldanha/repos",
      "events_url": "https://api.github.com/users/lucassaldanha/events{/privacy}",
      "received_events_url": "https://api.github.com/users/lucassaldanha/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-14T08:36:06Z",
    "updated_at": "2023-03-14T08:36:14Z",
    "author_association": "MEMBER",
    "body": "@rolfyone can we finish testing this and close the ticket?",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1467640077/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1468874506",
    "html_url": "https://github.com/ConsenSys/teku/issues/6105#issuecomment-1468874506",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/6105",
    "id": 1468874506,
    "node_id": "IC_kwDOCM9I9M5XjT8K",
    "user": {
      "login": "rolfyone",
      "id": 2967240,
      "node_id": "MDQ6VXNlcjI5NjcyNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2967240?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rolfyone",
      "html_url": "https://github.com/rolfyone",
      "followers_url": "https://api.github.com/users/rolfyone/followers",
      "following_url": "https://api.github.com/users/rolfyone/following{/other_user}",
      "gists_url": "https://api.github.com/users/rolfyone/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rolfyone/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rolfyone/subscriptions",
      "organizations_url": "https://api.github.com/users/rolfyone/orgs",
      "repos_url": "https://api.github.com/users/rolfyone/repos",
      "events_url": "https://api.github.com/users/rolfyone/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rolfyone/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-14T21:34:24Z",
    "updated_at": "2023-03-14T21:34:24Z",
    "author_association": "CONTRIBUTOR",
    "body": "feature toggle is `--Xfork-choice-first-descendent-as-head-enabled=false` (true by default), does need to be tested.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1468874506/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1535598738",
    "html_url": "https://github.com/ConsenSys/teku/issues/6105#issuecomment-1535598738",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/6105",
    "id": 1535598738,
    "node_id": "IC_kwDOCM9I9M5bh2CS",
    "user": {
      "login": "rolfyone",
      "id": 2967240,
      "node_id": "MDQ6VXNlcjI5NjcyNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2967240?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rolfyone",
      "html_url": "https://github.com/rolfyone",
      "followers_url": "https://api.github.com/users/rolfyone/followers",
      "following_url": "https://api.github.com/users/rolfyone/following{/other_user}",
      "gists_url": "https://api.github.com/users/rolfyone/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rolfyone/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rolfyone/subscriptions",
      "organizations_url": "https://api.github.com/users/rolfyone/orgs",
      "repos_url": "https://api.github.com/users/rolfyone/repos",
      "events_url": "https://api.github.com/users/rolfyone/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rolfyone/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-05T01:50:22Z",
    "updated_at": "2023-05-05T01:50:22Z",
    "author_association": "CONTRIBUTOR",
    "body": "once I toggled that on on goerli, our teku detailed board showed 'correct signatures' going from high 90's to mid 20's success, so reverting that for now, need to investigate why.\n\nFormula is : \n```\nclamp_max(avg((validator_performance_correct_sync_committee_messages{instance=~\"$system\"} / validator_performance_produced_sync_committee_messages{instance=~\"$system\"}) >= 0), 1)\n```\n\nneed to ensure the fork choice completes before sync committee messages are produced so that we're producing correct duties...\n",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1535598738/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1550476475",
    "html_url": "https://github.com/ConsenSys/teku/issues/6105#issuecomment-1550476475",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/6105",
    "id": 1550476475,
    "node_id": "IC_kwDOCM9I9M5camS7",
    "user": {
      "login": "rolfyone",
      "id": 2967240,
      "node_id": "MDQ6VXNlcjI5NjcyNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2967240?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rolfyone",
      "html_url": "https://github.com/rolfyone",
      "followers_url": "https://api.github.com/users/rolfyone/followers",
      "following_url": "https://api.github.com/users/rolfyone/following{/other_user}",
      "gists_url": "https://api.github.com/users/rolfyone/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rolfyone/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rolfyone/subscriptions",
      "organizations_url": "https://api.github.com/users/rolfyone/orgs",
      "repos_url": "https://api.github.com/users/rolfyone/repos",
      "events_url": "https://api.github.com/users/rolfyone/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rolfyone/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-16T23:16:54Z",
    "updated_at": "2023-05-16T23:16:54Z",
    "author_association": "CONTRIBUTOR",
    "body": "This has been running on goerli for a couple of weeks ok, have pushed to mainnet-nightly02.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1550476475/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
