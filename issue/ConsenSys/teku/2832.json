{
  "url": "https://api.github.com/repos/ConsenSys/teku/issues/2832",
  "repository_url": "https://api.github.com/repos/ConsenSys/teku",
  "labels_url": "https://api.github.com/repos/ConsenSys/teku/issues/2832/labels{/name}",
  "comments_url": "https://api.github.com/repos/ConsenSys/teku/issues/2832/comments",
  "events_url": "https://api.github.com/repos/ConsenSys/teku/issues/2832/events",
  "html_url": "https://github.com/ConsenSys/teku/issues/2832",
  "id": 706123618,
  "node_id": "MDU6SXNzdWU3MDYxMjM2MTg=",
  "number": 2832,
  "title": "Out of heap space (2GB heap)",
  "user": {
    "login": "benjaminion",
    "id": 20796281,
    "node_id": "MDQ6VXNlcjIwNzk2Mjgx",
    "avatar_url": "https://avatars.githubusercontent.com/u/20796281?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/benjaminion",
    "html_url": "https://github.com/benjaminion",
    "followers_url": "https://api.github.com/users/benjaminion/followers",
    "following_url": "https://api.github.com/users/benjaminion/following{/other_user}",
    "gists_url": "https://api.github.com/users/benjaminion/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/benjaminion/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/benjaminion/subscriptions",
    "organizations_url": "https://api.github.com/users/benjaminion/orgs",
    "repos_url": "https://api.github.com/users/benjaminion/repos",
    "events_url": "https://api.github.com/users/benjaminion/events{/privacy}",
    "received_events_url": "https://api.github.com/users/benjaminion/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1271198478,
      "node_id": "MDU6TGFiZWwxMjcxMTk4NDc4",
      "url": "https://api.github.com/repos/ConsenSys/teku/labels/performance%20%F0%9F%9A%80",
      "name": "performance ðŸš€",
      "color": "ffcce3",
      "default": false,
      "description": "Improves performance without changing functionality"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "ajsutton",
    "id": 72675,
    "node_id": "MDQ6VXNlcjcyNjc1",
    "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ajsutton",
    "html_url": "https://github.com/ajsutton",
    "followers_url": "https://api.github.com/users/ajsutton/followers",
    "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
    "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
    "organizations_url": "https://api.github.com/users/ajsutton/orgs",
    "repos_url": "https://api.github.com/users/ajsutton/repos",
    "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ajsutton/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 7,
  "created_at": "2020-09-22T06:48:37Z",
  "updated_at": "2020-12-02T21:53:36Z",
  "closed_at": "2020-12-02T21:53:36Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "As a design target, I want Teku to run within 2GB heap space at all times. Today I got a crash while running with `-Xmx2g`. Note that my previous version (`v0.12.6-dev-616f13a3`) ran for 2 weeks continually without an issue, while this one (`v0.12.7-dev-90d58455`) died after about 18 hours.\r\n\r\nIn the run up to the crash there were large numbers of `Regenerate state` messages.\r\n\r\n```\r\n03:50:25.703 INFO  - Regenerate state for block 0x135cd2e7ffb37e67f6e2e13ae1f0c8ddbbeb3e1395e254a9ccda0f091f611559 by replaying 26 blocks\r\n03:50:26.431 INFO  - Completed regeneration of block 0x135cd2e7ffb37e67f6e2e13ae1f0c8ddbbeb3e1395e254a9ccda0f091f611559 at slot 350013 by repl>\r\n03:50:26.456 INFO  - Slot Event  *** Slot: 350051, Block: 527262..8d7f, Epoch: 10939, Finalized checkpoint: 10936, Finalized root: b31bfb..5c1>\r\n03:50:26.803 INFO  - Regenerate state for block 0xc21e11a52f04d8a482036a1e3bfe3f4a001f5e3036bb990c0e92eaa6d894140d by replaying 2 blocks\r\n03:50:26.815 INFO  - Completed regeneration of block 0xc21e11a52f04d8a482036a1e3bfe3f4a001f5e3036bb990c0e92eaa6d894140d at slot 350015 by repl>\r\n03:50:28.327 INFO  - Regenerate state for block 0x084ef7d1add8e8a7bac3536c2668ca2d2b5f1e25cec8cfb5e172f4f74c2958a1 by replaying 4 blocks\r\n03:50:28.371 INFO  - Completed regeneration of block 0x084ef7d1add8e8a7bac3536c2668ca2d2b5f1e25cec8cfb5e172f4f74c2958a1 at slot 350031 by repl>\r\n03:50:29.085 INFO  - Regenerate state for block 0x2084943c1e7ad31bf4a3af70d8e3595e8fb9c78892252510e947f944610ee612 by replaying 3 blocks\r\n03:50:29.103 INFO  - Completed regeneration of block 0x2084943c1e7ad31bf4a3af70d8e3595e8fb9c78892252510e947f944610ee612 at slot 350034 by repl>\r\n03:50:29.255 INFO  - Regenerate state for block 0x9dc925d2bb7b42e11a2d5c1ba0425a328138defe45e261697bbb34c79ea2c40e by replaying 6 blocks\r\n03:50:29.311 INFO  - Completed regeneration of block 0x9dc925d2bb7b42e11a2d5c1ba0425a328138defe45e261697bbb34c79ea2c40e at slot 350023 by repl>\r\n03:50:29.598 INFO  - Regenerate state for block 0x422beef6dafb1f29f52346bf7f4a813f183e1fb531e25c8f73ccadbaded1b7ba by replaying 1 blocks\r\n03:50:29.600 INFO  - Completed regeneration of block 0x422beef6dafb1f29f52346bf7f4a813f183e1fb531e25c8f73ccadbaded1b7ba at slot 350016 by repl>\r\n03:50:35.367 INFO  - Regenerate state for block 0x644987976f12bdba57b234c59b33e57846716e664120f4e00a78b6575353bfdc by replaying 7 blocks\r\n03:50:35.407 INFO  - Completed regeneration of block 0x644987976f12bdba57b234c59b33e57846716e664120f4e00a78b6575353bfdc at slot 350041 by repl>\r\n03:50:35.765 INFO  - Regenerate state for block 0x4c34581c4cdb7329756c50922a14c8a7365de925bdcf3ff5cfc483ec8bf17563 by replaying 3 blocks\r\n03:50:35.783 INFO  - Completed regeneration of block 0x4c34581c4cdb7329756c50922a14c8a7365de925bdcf3ff5cfc483ec8bf17563 at slot 350047 by repl>\r\n03:50:37.985 INFO  - Regenerate state for block 0x8a0364ddd4d093fc3eac4487a58113362e3e388d85237f1ee9e4fb237d462ab5 by replaying 2 blocks\r\n03:50:37.992 INFO  - Completed regeneration of block 0x8a0364ddd4d093fc3eac4487a58113362e3e388d85237f1ee9e4fb237d462ab5 at slot 350042 by repl>\r\n03:50:39.221 INFO  - Regenerate state for block 0x4cde0da2a2778647f82f5544df208fc35d2601c74d0f5ed5a098b81d3fb22eaa by replaying 24 blocks\r\n03:50:39.502 INFO  - Completed regeneration of block 0x4cde0da2a2778647f82f5544df208fc35d2601c74d0f5ed5a098b81d3fb22eaa at slot 349983 by repl>\r\n03:50:40.352 INFO  - Slot Event  *** Slot: 350052, Block: c9d831..fb5e, Epoch: 10939, Finalized checkpoint: 10936, Finalized root: b31bfb..5c1>\r\n03:50:44.238 INFO  - Validator   *** Published attestation  Count: 3, Slot: 350053, Root: 707bc5..a45f\r\n03:50:48.631 INFO  - Slot Event  *** Slot: 350053, Block: 707bc5..a45f, Epoch: 10939, Finalized checkpoint: 10936, Finalized root: b31bfb..5c1>\r\n03:50:49.743 INFO  - Regenerate state for block 0x9c9a23529d1ab9419aca31486f73bfd703bcde110362cf450becf2e508314bf1 by replaying 6 blocks\r\n03:50:49.745 INFO  - Regenerate state for block 0xc21e11a52f04d8a482036a1e3bfe3f4a001f5e3036bb990c0e92eaa6d894140d by replaying 27 blocks\r\n03:50:49.775 INFO  - Completed regeneration of block 0x9c9a23529d1ab9419aca31486f73bfd703bcde110362cf450becf2e508314bf1 at slot 350040 by repl>\r\n03:50:50.556 INFO  - Completed regeneration of block 0xc21e11a52f04d8a482036a1e3bfe3f4a001f5e3036bb990c0e92eaa6d894140d at slot 350015 by repl>\r\n03:50:53.732 INFO  - Regenerate state for block 0x135cd2e7ffb37e67f6e2e13ae1f0c8ddbbeb3e1395e254a9ccda0f091f611559 by replaying 26 blocks\r\n03:50:54.475 INFO  - Completed regeneration of block 0x135cd2e7ffb37e67f6e2e13ae1f0c8ddbbeb3e1395e254a9ccda0f091f611559 at slot 350013 by repl>\r\n03:50:54.583 INFO  - Regenerate state for block 0x4c34581c4cdb7329756c50922a14c8a7365de925bdcf3ff5cfc483ec8bf17563 by replaying 2 blocks\r\n03:50:54.599 INFO  - Completed regeneration of block 0x4c34581c4cdb7329756c50922a14c8a7365de925bdcf3ff5cfc483ec8bf17563 at slot 350047 by repl>\r\n03:51:00.337 INFO  - Validator   *** Published attestation  Count: 1, Slot: 350054, Root: 87e0ea..95fc\r\n03:51:00.372 INFO  - Regenerate state for block 0x0d438acf500d0d4327014c2c798941784a89a04842adb59e903ccf5228df7a84 by replaying 10 blocks\r\n03:51:05.827 INFO  - Regenerate state for block 0x8a0364ddd4d093fc3eac4487a58113362e3e388d85237f1ee9e4fb237d462ab5 by replaying 3 blocks\r\n03:51:05.853 INFO  - Completed regeneration of block 0x0d438acf500d0d4327014c2c798941784a89a04842adb59e903ccf5228df7a84 at slot 349996 by repl>\r\n03:51:05.876 INFO  - Completed regeneration of block 0x8a0364ddd4d093fc3eac4487a58113362e3e388d85237f1ee9e4fb237d462ab5 at slot 350042 by repl>\r\n03:51:05.911 INFO  - Regenerate state for block 0x1d62243df324b927a18b8e7992139c2ef762cb0262ef16bf7474bd726603c485 by replaying 12 blocks\r\n03:51:06.107 INFO  - Completed regeneration of block 0x1d62243df324b927a18b8e7992139c2ef762cb0262ef16bf7474bd726603c485 at slot 350008 by repl>\r\njava.lang.OutOfMemoryError: Java heap space\r\nDumping heap to java_pid58933.hprof ...\r\nUnable to create java_pid58933.hprof: Permission denied\r\n```\r\n\r\nAfter this everything goes haywire - lots of errors, and had to `kill -9` Teku to get it to stop.\r\n\r\nUnfortunately I don't have the heap dump - need to sort out directory permissions.\r\n\r\nTeku version: `teku/v0.12.7-dev-90d58455/linux-x86_64/-privatebuild-openjdk64bitservervm-java-13`",
  "closed_by": {
    "login": "rolfyone",
    "id": 2967240,
    "node_id": "MDQ6VXNlcjI5NjcyNDA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2967240?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/rolfyone",
    "html_url": "https://github.com/rolfyone",
    "followers_url": "https://api.github.com/users/rolfyone/followers",
    "following_url": "https://api.github.com/users/rolfyone/following{/other_user}",
    "gists_url": "https://api.github.com/users/rolfyone/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/rolfyone/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rolfyone/subscriptions",
    "organizations_url": "https://api.github.com/users/rolfyone/orgs",
    "repos_url": "https://api.github.com/users/rolfyone/repos",
    "events_url": "https://api.github.com/users/rolfyone/events{/privacy}",
    "received_events_url": "https://api.github.com/users/rolfyone/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/2832/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ConsenSys/teku/issues/2832/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/696566362",
    "html_url": "https://github.com/ConsenSys/teku/issues/2832#issuecomment-696566362",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/2832",
    "id": 696566362,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY5NjU2NjM2Mg==",
    "user": {
      "login": "benjaminion",
      "id": 20796281,
      "node_id": "MDQ6VXNlcjIwNzk2Mjgx",
      "avatar_url": "https://avatars.githubusercontent.com/u/20796281?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/benjaminion",
      "html_url": "https://github.com/benjaminion",
      "followers_url": "https://api.github.com/users/benjaminion/followers",
      "following_url": "https://api.github.com/users/benjaminion/following{/other_user}",
      "gists_url": "https://api.github.com/users/benjaminion/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/benjaminion/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/benjaminion/subscriptions",
      "organizations_url": "https://api.github.com/users/benjaminion/orgs",
      "repos_url": "https://api.github.com/users/benjaminion/repos",
      "events_url": "https://api.github.com/users/benjaminion/events{/privacy}",
      "received_events_url": "https://api.github.com/users/benjaminion/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-09-22T07:54:09Z",
    "updated_at": "2020-09-22T07:58:37Z",
    "author_association": "CONTRIBUTOR",
    "body": "Happened again after less than an hour. I have the heap dump this time and will take a look later.\r\n\r\nI'd updated to `teku/v0.12.7-dev-9b0402d7/linux-x86_64/-privatebuild-openjdk64bitservervm-java-13`\r\n\r\nNote the multiple regenerations of `0x533763a6`... for example. Not sure if this is expected.\r\n\r\n```\r\n07:45:38.362 INFO  - Slot Event  *** Slot: 351227, Block: 8d0bc8..e9e3, Epoch: 10975, Finalized checkpoint: 10973, Finalized root: 2666cb..4f73, Peers: 80\r\n07:45:38.529 INFO  - Regenerate state for block 0xdd5b88722f71d01951224243a4ab86930a13fa00c8e85b304e98a2be02b49dc5 by replaying 24 blocks\r\n07:45:38.771 INFO  - Completed regeneration of block 0xe1b98643fa4ca803d10843b0f0544df8a877191d6d397783879982774d87a240 at slot 351166 by replaying 26 blocks. Took 771ms\r\n07:45:39.612 INFO  - Regenerate state for block 0x3d3f963ce5f298232c4a5c3a313d5b0d75bf9a6816ea96d3532cad6b85ff3aaf by replaying 2 blocks\r\n07:45:39.781 INFO  - Regenerate state for block 0x141a09d6f2b02c8b489773326dd17697032ba196315b9db6cc92b814dafad86c by replaying 2 blocks\r\n07:45:39.826 INFO  - Completed regeneration of block 0x3d3f963ce5f298232c4a5c3a313d5b0d75bf9a6816ea96d3532cad6b85ff3aaf at slot 351169 by replaying 2 blocks. Took 214ms\r\n07:45:39.847 INFO  - Completed regeneration of block 0xdd5b88722f71d01951224243a4ab86930a13fa00c8e85b304e98a2be02b49dc5 at slot 351164 by replaying 24 blocks. Took 1318ms\r\n07:45:39.850 INFO  - Regenerate state for block 0xfc31b9b63bb609ced9fb7d04fa6e687e09f14f0f25755d389cd3ed1c86f52226 by replaying 2 blocks\r\n07:45:39.902 INFO  - Completed regeneration of block 0xfc31b9b63bb609ced9fb7d04fa6e687e09f14f0f25755d389cd3ed1c86f52226 at slot 351213 by replaying 2 blocks. Took 51ms\r\n07:45:40.124 INFO  - Completed regeneration of block 0x141a09d6f2b02c8b489773326dd17697032ba196315b9db6cc92b814dafad86c at slot 351202 by replaying 2 blocks. Took 343ms\r\n07:45:40.130 INFO  - Regenerate state for block 0x533763a673555a3c2ca189577bbde4c8bbccf932bb28d809b84bdbf971d60b37 by replaying 5 blocks\r\n07:45:40.333 INFO  - Completed regeneration of block 0x533763a673555a3c2ca189577bbde4c8bbccf932bb28d809b84bdbf971d60b37 at slot 351207 by replaying 5 blocks. Took 203ms\r\n07:45:40.483 INFO  - Regenerate state for block 0x2fb80dcbc943ce7836f2f31515e7484fef43b04d5780f45e9ca729f19103798d by replaying 28 blocks\r\n07:45:40.483 INFO  - Regenerate state for block 0xbc749e3eb9fa051b288621f830505e73725bd9b354b4d3729f17c679523d9126 by replaying 7 blocks\r\n07:45:41.555 INFO  - Completed regeneration of block 0xbc749e3eb9fa051b288621f830505e73725bd9b354b4d3729f17c679523d9126 at slot 351176 by replaying 7 blocks. Took 1072ms\r\n07:45:41.641 INFO  - Regenerate state for block 0x7b27d0a153508efbecff4b5671f8bf3accabfa8030c101bc9ce1da9987aa1aa2 by replaying 4 blocks\r\n07:45:41.655 INFO  - Regenerate state for block 0xa217d1cf6cf92bf351e96a430c7a5e08b0aea3f8b54cdb0841904aef030ec7cd by replaying 7 blocks\r\n07:45:41.685 INFO  - Regenerate state for block 0x1ff557cb4f93019e96e1a26d4f8020bb08e2e3b63b46b0f95de7d2cb338ec9ab by replaying 16 blocks\r\n07:45:41.810 INFO  - Completed regeneration of block 0xa217d1cf6cf92bf351e96a430c7a5e08b0aea3f8b54cdb0841904aef030ec7cd at slot 351183 by replaying 7 blocks. Took 155ms\r\n07:45:41.812 INFO  - Regenerate state for block 0xbe0c24da7a4adaacf76b3791786c6f3588d14d58e2980303051fabc8798da4f0 by replaying 17 blocks\r\n07:45:42.671 INFO  - Completed regeneration of block 0x7b27d0a153508efbecff4b5671f8bf3accabfa8030c101bc9ce1da9987aa1aa2 at slot 351171 by replaying 4 blocks. Took 1030ms\r\n07:45:44.336 INFO  - Completed regeneration of block 0x1ff557cb4f93019e96e1a26d4f8020bb08e2e3b63b46b0f95de7d2cb338ec9ab at slot 351193 by replaying 16 blocks. Took 2651ms\r\n07:45:45.206 INFO  - Completed regeneration of block 0x2fb80dcbc943ce7836f2f31515e7484fef43b04d5780f45e9ca729f19103798d at slot 351199 by replaying 28 blocks. Took 4723ms\r\n07:45:45.213 INFO  - Completed regeneration of block 0xbe0c24da7a4adaacf76b3791786c6f3588d14d58e2980303051fabc8798da4f0 at slot 351194 by replaying 17 blocks. Took 3401ms\r\n07:45:45.226 INFO  - Regenerate state for block 0x1d8ebf58f9ceb34059ecd9b33b44ce62c75be8eafd1c64e2fec0aca3e8a4d803 by replaying 3 blocks\r\n07:45:45.245 INFO  - Regenerate state for block 0x380caf6a2ddbfc815fc77b13bdfdc7ea79d3a464ff202d6673827cfacf4607d0 by replaying 4 blocks\r\n07:45:46.059 INFO  - Completed regeneration of block 0x1d8ebf58f9ceb34059ecd9b33b44ce62c75be8eafd1c64e2fec0aca3e8a4d803 at slot 351186 by replaying 3 blocks. Took 833ms\r\n07:45:46.061 INFO  - Regenerate state for block 0xa5f9a2debc1c22fda6afe7450f7356d431d052656301426fe91cd7a15ac16fa5 by replaying 3 blocks\r\n07:45:46.869 INFO  - Completed regeneration of block 0xa5f9a2debc1c22fda6afe7450f7356d431d052656301426fe91cd7a15ac16fa5 at slot 351175 by replaying 3 blocks. Took 808ms\r\n07:45:46.898 INFO  - Completed regeneration of block 0x380caf6a2ddbfc815fc77b13bdfdc7ea79d3a464ff202d6673827cfacf4607d0 at slot 351205 by replaying 4 blocks. Took 1653ms\r\n07:45:47.724 INFO  - Regenerate state for block 0x8d314c14283a9cdd1da36f8f7004b1fdd343d7414fdd6e4a706e152987ab6906 by replaying 2 blocks\r\n07:45:47.756 INFO  - Regenerate state for block 0x533763a673555a3c2ca189577bbde4c8bbccf932bb28d809b84bdbf971d60b37 by replaying 2 blocks\r\n07:45:47.769 INFO  - Completed regeneration of block 0x533763a673555a3c2ca189577bbde4c8bbccf932bb28d809b84bdbf971d60b37 at slot 351207 by replaying 2 blocks. Took 13ms\r\n07:45:47.798 INFO  - Completed regeneration of block 0x8d314c14283a9cdd1da36f8f7004b1fdd343d7414fdd6e4a706e152987ab6906 at slot 351187 by replaying 2 blocks. Took 74ms\r\n07:45:47.802 INFO  - Regenerate state for block 0x67cc559fe8d98b7b28a9d47fe595debc97b36919422409e06a08f8eb9698e62f by replaying 2 blocks\r\n07:45:47.834 INFO  - Completed regeneration of block 0x67cc559fe8d98b7b28a9d47fe595debc97b36919422409e06a08f8eb9698e62f at slot 351216 by replaying 2 blocks. Took 32ms\r\n07:45:52.966 INFO  - Regenerate state for block 0x5888f7d338488b07fbd6c2d62daaf9429049c5f68403141d401d9bad0153a6b9 by replaying 10 blocks\r\n07:45:53.026 INFO  - Regenerate state for block 0xe1b98643fa4ca803d10843b0f0544df8a877191d6d397783879982774d87a240 by replaying 26 blocks\r\n07:45:53.976 INFO  - Regenerate state for block 0xa358d3e196f1f275428e5ba7c812fb06763356c7ae152ab2743344b5289c5346 by replaying 18 blocks\r\n07:45:54.922 INFO  - Completed regeneration of block 0x5888f7d338488b07fbd6c2d62daaf9429049c5f68403141d401d9bad0153a6b9 at slot 351225 by replaying 10 blocks. Took 1956ms\r\n07:45:58.249 INFO  - Regenerate state for block 0x533763a673555a3c2ca189577bbde4c8bbccf932bb28d809b84bdbf971d60b37 by replaying 2 blocks\r\n07:45:59.142 INFO  - Completed regeneration of block 0x533763a673555a3c2ca189577bbde4c8bbccf932bb28d809b84bdbf971d60b37 at slot 351207 by replaying 2 blocks. Took 892ms\r\n07:45:59.212 INFO  - Regenerate state for block 0x0beeb6827dd69c0494005ba5906c655f6d2dfd9fefa0ad95066d705d441eadd3 by replaying 3 blocks\r\n07:45:59.251 INFO  - Completed regeneration of block 0x0beeb6827dd69c0494005ba5906c655f6d2dfd9fefa0ad95066d705d441eadd3 at slot 351218 by replaying 3 blocks. Took 38ms\r\n07:46:00.170 INFO  - Completed regeneration of block 0xa358d3e196f1f275428e5ba7c812fb06763356c7ae152ab2743344b5289c5346 at slot 351157 by replaying 18 blocks. Took 6194ms\r\n07:46:02.843 INFO  - Completed regeneration of block 0xe1b98643fa4ca803d10843b0f0544df8a877191d6d397783879982774d87a240 at slot 351166 by replaying 26 blocks. Took 9817ms\r\n07:46:05.684 INFO  - Regenerate state for block 0xa5c13b1f2f11fabdb4181ba4a709f626401cae9f91b0f1fbde6d71746328cd69 by replaying 4 blocks\r\n07:46:08.354 INFO  - Regenerate state for block 0x418fc3d4f654d4dcc8a71ea2275ff66e6a1deb6723a7c59875f86e594d27650a by replaying 2 blocks\r\n07:46:09.171 INFO  - Regenerate state for block 0x5888f7d338488b07fbd6c2d62daaf9429049c5f68403141d401d9bad0153a6b9 by replaying 8 blocks\r\n07:46:09.175 INFO  - Completed regeneration of block 0xa5c13b1f2f11fabdb4181ba4a709f626401cae9f91b0f1fbde6d71746328cd69 at slot 351211 by replaying 4 blocks. Took 3490ms\r\n07:46:10.132 INFO  - Completed regeneration of block 0x418fc3d4f654d4dcc8a71ea2275ff66e6a1deb6723a7c59875f86e594d27650a at slot 351217 by replaying 2 blocks. Took 1778ms\r\n07:46:10.280 INFO  - Completed regeneration of block 0x5888f7d338488b07fbd6c2d62daaf9429049c5f68403141d401d9bad0153a6b9 at slot 351225 by replaying 8 blocks. Took 1109ms\r\n07:46:15.178 INFO  - Regenerate state for block 0x71111d8868c9edf4b56b5a495c313fe93304d92cb4ac9c8ad4c3e5617afad5e8 by replaying 3 blocks\r\n07:46:17.898 INFO  - Completed regeneration of block 0x71111d8868c9edf4b56b5a495c313fe93304d92cb4ac9c8ad4c3e5617afad5e8 at slot 351214 by replaying 3 blocks. Took 2720ms\r\n07:46:17.926 INFO  - Regenerate state for block 0x418fc3d4f654d4dcc8a71ea2275ff66e6a1deb6723a7c59875f86e594d27650a by replaying 3 blocks\r\n07:46:18.013 INFO  - Completed regeneration of block 0x418fc3d4f654d4dcc8a71ea2275ff66e6a1deb6723a7c59875f86e594d27650a at slot 351217 by replaying 3 blocks. Took 86ms\r\n07:46:18.078 INFO  - Regenerate state for block 0x0beeb6827dd69c0494005ba5906c655f6d2dfd9fefa0ad95066d705d441eadd3 by replaying 2 blocks\r\n07:46:18.111 INFO  - Completed regeneration of block 0x0beeb6827dd69c0494005ba5906c655f6d2dfd9fefa0ad95066d705d441eadd3 at slot 351218 by replaying 2 blocks. Took 33ms\r\n07:46:18.140 INFO  - Regenerate state for block 0xfc31b9b63bb609ced9fb7d04fa6e687e09f14f0f25755d389cd3ed1c86f52226 by replaying 2 blocks\r\n07:46:18.192 INFO  - Completed regeneration of block 0xfc31b9b63bb609ced9fb7d04fa6e687e09f14f0f25755d389cd3ed1c86f52226 at slot 351213 by replaying 2 blocks. Took 52ms\r\n07:46:19.250 INFO  - Regenerate state for block 0x5888f7d338488b07fbd6c2d62daaf9429049c5f68403141d401d9bad0153a6b9 by replaying 8 blocks\r\n07:46:21.351 INFO  - Completed regeneration of block 0x5888f7d338488b07fbd6c2d62daaf9429049c5f68403141d401d9bad0153a6b9 at slot 351225 by replaying 8 blocks. Took 2101ms\r\n07:46:29.297 INFO  - Regenerate state for block 0x7c486874f1ece3768f69655891e0c8ffbf7109eb150632d617e9ceb8a72ee0e9 by replaying 1 blocks\r\n07:46:29.305 INFO  - Completed regeneration of block 0x7c486874f1ece3768f69655891e0c8ffbf7109eb150632d617e9ceb8a72ee0e9 at slot 351201 by replaying 1 blocks. Took 8ms\r\n07:46:29.509 INFO  - Regenerate state for block 0x75c55b5d434a49abb984e927e2aef885ec66a52a6f91bb50b5926bd7d5082049 by replaying 3 blocks\r\n07:46:29.753 INFO  - Completed regeneration of block 0x75c55b5d434a49abb984e927e2aef885ec66a52a6f91bb50b5926bd7d5082049 at slot 351170 by replaying 3 blocks. Took 243ms\r\n07:46:29.761 INFO  - Regenerate state for block 0x80ded0b6588a7d577dea44aea7e5d8eccce3603fd92be66454aa10d15863bcf8 by replaying 16 blocks\r\n07:46:29.789 INFO  - Regenerate state for block 0x1ff557cb4f93019e96e1a26d4f8020bb08e2e3b63b46b0f95de7d2cb338ec9ab by replaying 20 blocks\r\n07:46:30.979 INFO  - Completed regeneration of block 0x80ded0b6588a7d577dea44aea7e5d8eccce3603fd92be66454aa10d15863bcf8 at slot 351189 by replaying 16 blocks. Took 1218ms\r\n07:46:31.017 INFO  - Completed regeneration of block 0x1ff557cb4f93019e96e1a26d4f8020bb08e2e3b63b46b0f95de7d2cb338ec9ab at slot 351193 by replaying 20 blocks. Took 1228ms\r\n07:46:31.983 INFO  - Regenerate state for block 0x218015800a096f2c79a791112a65ebc1acb9fb90d546ad9e5083dcd568e4aac6 by replaying 3 blocks\r\n07:46:33.799 INFO  - Completed regeneration of block 0x218015800a096f2c79a791112a65ebc1acb9fb90d546ad9e5083dcd568e4aac6 at slot 351195 by replaying 3 blocks. Took 1815ms\r\njava.lang.OutOfMemoryError: Java heap space\r\nDumping heap to java_pid75156.hprof ...\r\nHeap dump file created [3181872119 bytes in 17.297 secs]\r\n```\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/696566362/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/696795456",
    "html_url": "https://github.com/ConsenSys/teku/issues/2832#issuecomment-696795456",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/2832",
    "id": 696795456,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY5Njc5NTQ1Ng==",
    "user": {
      "login": "benjaminion",
      "id": 20796281,
      "node_id": "MDQ6VXNlcjIwNzk2Mjgx",
      "avatar_url": "https://avatars.githubusercontent.com/u/20796281?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/benjaminion",
      "html_url": "https://github.com/benjaminion",
      "followers_url": "https://api.github.com/users/benjaminion/followers",
      "following_url": "https://api.github.com/users/benjaminion/following{/other_user}",
      "gists_url": "https://api.github.com/users/benjaminion/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/benjaminion/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/benjaminion/subscriptions",
      "organizations_url": "https://api.github.com/users/benjaminion/orgs",
      "repos_url": "https://api.github.com/users/benjaminion/repos",
      "events_url": "https://api.github.com/users/benjaminion/events{/privacy}",
      "received_events_url": "https://api.github.com/users/benjaminion/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-09-22T15:27:16Z",
    "updated_at": "2020-09-22T15:28:01Z",
    "author_association": "CONTRIBUTOR",
    "body": "I've taken a quick look at the heap dump. The only thing that looks a bit unusual is that three storage related threads are consuming almost 500MB between them:\r\n\r\nClass Name | Shallow Heap | Retained Heap\r\n-- | -- | --\r\njava.lang.Thread @ 0x803b2320  StorageQueryChannel-0 Thread Â» | 112 | 161,254,520\r\njava.lang.Thread @ 0x800fe890  StorageQueryChannel-5 Thread Â» | 112 | 151,307,656\r\njava.lang.Thread @ 0x803b3570  StorageQueryChannel-7 Thread Â» | 112 | 148,217,472\r\n\r\nI'm now running with 3GB heap, and everything is smooth, but would like to revert to 2GB if possible!",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/696795456/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/697166727",
    "html_url": "https://github.com/ConsenSys/teku/issues/2832#issuecomment-697166727",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/2832",
    "id": 697166727,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY5NzE2NjcyNw==",
    "user": {
      "login": "Nashatyrev",
      "id": 8173857,
      "node_id": "MDQ6VXNlcjgxNzM4NTc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8173857?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Nashatyrev",
      "html_url": "https://github.com/Nashatyrev",
      "followers_url": "https://api.github.com/users/Nashatyrev/followers",
      "following_url": "https://api.github.com/users/Nashatyrev/following{/other_user}",
      "gists_url": "https://api.github.com/users/Nashatyrev/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Nashatyrev/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Nashatyrev/subscriptions",
      "organizations_url": "https://api.github.com/users/Nashatyrev/orgs",
      "repos_url": "https://api.github.com/users/Nashatyrev/repos",
      "events_url": "https://api.github.com/users/Nashatyrev/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Nashatyrev/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-09-23T06:42:15Z",
    "updated_at": "2020-09-23T06:50:04Z",
    "author_association": "CONTRIBUTOR",
    "body": "What network are you running on? Any specific configuration? Validators?\r\nWould be good if you can share the heap dump. ",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/697166727/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/697294944",
    "html_url": "https://github.com/ConsenSys/teku/issues/2832#issuecomment-697294944",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/2832",
    "id": 697294944,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY5NzI5NDk0NA==",
    "user": {
      "login": "benjaminion",
      "id": 20796281,
      "node_id": "MDQ6VXNlcjIwNzk2Mjgx",
      "avatar_url": "https://avatars.githubusercontent.com/u/20796281?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/benjaminion",
      "html_url": "https://github.com/benjaminion",
      "followers_url": "https://api.github.com/users/benjaminion/followers",
      "following_url": "https://api.github.com/users/benjaminion/following{/other_user}",
      "gists_url": "https://api.github.com/users/benjaminion/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/benjaminion/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/benjaminion/subscriptions",
      "organizations_url": "https://api.github.com/users/benjaminion/orgs",
      "repos_url": "https://api.github.com/users/benjaminion/repos",
      "events_url": "https://api.github.com/users/benjaminion/events{/privacy}",
      "received_events_url": "https://api.github.com/users/benjaminion/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-09-23T11:09:43Z",
    "updated_at": "2020-09-23T11:09:43Z",
    "author_association": "CONTRIBUTOR",
    "body": "Redacted config follows. I shared the heap dump with you privately.\r\n\r\n```\r\nnetwork: \"medalla\"\r\ndata-path: \"/data/teku_medalla/data\"\r\ndata-storage-mode: \"ARCHIVE\"\r\np2p-advertised-ip: \"<My external IP>\"\r\nmetrics-enabled: true\r\nmetrics-interface: \"0.0.0.0\"\r\nmetrics-host-allowlist: \"*\"\r\nrest-api-enabled: true\r\nrest-api-interface: \"0.0.0.0\"\r\nrest-api-docs-enabled: true\r\nrest-api-host-allowlist: \"*\"\r\np2p-peer-upper-bound: 80\r\np2p-peer-lower-bound: 70\r\nvalidators-key-files: [<64 validator key files>]\r\nvalidators-key-password-files: [<64 password files>]\r\neth1-endpoint: \"<Infura>\"\r\nlog-destination: \"CONSOLE\"\r\nvalidators-keystore-locking-enabled: false\r\nvalidators-graffiti: \"Metal Albert - https://eth2.news\"\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/697294944/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/697349106",
    "html_url": "https://github.com/ConsenSys/teku/issues/2832#issuecomment-697349106",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/2832",
    "id": 697349106,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY5NzM0OTEwNg==",
    "user": {
      "login": "Nashatyrev",
      "id": 8173857,
      "node_id": "MDQ6VXNlcjgxNzM4NTc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8173857?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Nashatyrev",
      "html_url": "https://github.com/Nashatyrev",
      "followers_url": "https://api.github.com/users/Nashatyrev/followers",
      "following_url": "https://api.github.com/users/Nashatyrev/following{/other_user}",
      "gists_url": "https://api.github.com/users/Nashatyrev/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Nashatyrev/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Nashatyrev/subscriptions",
      "organizations_url": "https://api.github.com/users/Nashatyrev/orgs",
      "repos_url": "https://api.github.com/users/Nashatyrev/repos",
      "events_url": "https://api.github.com/users/Nashatyrev/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Nashatyrev/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-09-23T13:01:27Z",
    "updated_at": "2020-09-23T13:01:27Z",
    "author_association": "CONTRIBUTOR",
    "body": "Looks like the heap was 'eaten' by backing state trees. As I understand the state was always deserialized from the storage to 'regenerate the state' and in this case the _full_ backing tree is recreated for _every_ state (opposite to state transition where a new state might be derived from a previous with just a dozen of new nodes in the backing tree)\r\n\r\n![Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ](https://user-images.githubusercontent.com/8173857/94014804-b45a9f80-fdb4-11ea-89a7-1f559b521dac.png)\r\n\r\nThe question is why there were so many parallel requests for older states... May be @mbaxter or @ajsutton have any ideas",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/697349106/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/697541558",
    "html_url": "https://github.com/ConsenSys/teku/issues/2832#issuecomment-697541558",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/2832",
    "id": 697541558,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY5NzU0MTU1OA==",
    "user": {
      "login": "mbaxter",
      "id": 658601,
      "node_id": "MDQ6VXNlcjY1ODYwMQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/658601?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mbaxter",
      "html_url": "https://github.com/mbaxter",
      "followers_url": "https://api.github.com/users/mbaxter/followers",
      "following_url": "https://api.github.com/users/mbaxter/following{/other_user}",
      "gists_url": "https://api.github.com/users/mbaxter/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mbaxter/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mbaxter/subscriptions",
      "organizations_url": "https://api.github.com/users/mbaxter/orgs",
      "repos_url": "https://api.github.com/users/mbaxter/repos",
      "events_url": "https://api.github.com/users/mbaxter/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mbaxter/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-09-23T15:26:59Z",
    "updated_at": "2020-09-23T15:26:59Z",
    "author_association": "CONTRIBUTOR",
    "body": "States and checkpoint states are cached using [soft references](https://github.com/PegaSysEng/teku/blob/8cf430e1cb713f421c9889e3c0aca48e09fb8b8d/ethereum/core/src/main/java/tech/pegasys/teku/core/stategenerator/CachingTaskQueue.java#L61), so if there's any memory pressure I think we'll start dropping those pretty aggressively.  I'd guess that all of the requests for random states are coming from our [gossiped attestation processing logic](https://github.com/PegaSysEng/teku/blob/8cf430e1cb713f421c9889e3c0aca48e09fb8b8d/networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/topics/validation/AttestationValidator.java#L129). ",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/697541558/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/697865018",
    "html_url": "https://github.com/ConsenSys/teku/issues/2832#issuecomment-697865018",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/2832",
    "id": 697865018,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY5Nzg2NTAxOA==",
    "user": {
      "login": "Nashatyrev",
      "id": 8173857,
      "node_id": "MDQ6VXNlcjgxNzM4NTc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8173857?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Nashatyrev",
      "html_url": "https://github.com/Nashatyrev",
      "followers_url": "https://api.github.com/users/Nashatyrev/followers",
      "following_url": "https://api.github.com/users/Nashatyrev/following{/other_user}",
      "gists_url": "https://api.github.com/users/Nashatyrev/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Nashatyrev/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Nashatyrev/subscriptions",
      "organizations_url": "https://api.github.com/users/Nashatyrev/orgs",
      "repos_url": "https://api.github.com/users/Nashatyrev/repos",
      "events_url": "https://api.github.com/users/Nashatyrev/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Nashatyrev/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-09-23T18:42:20Z",
    "updated_at": "2020-09-23T18:42:20Z",
    "author_association": "CONTRIBUTOR",
    "body": "Also found interesting things which worth to optimize: \r\n![Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ](https://user-images.githubusercontent.com/8173857/94055453-a2ddbb80-fde5-11ea-98c5-d2efba6b87f9.png)\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/697865018/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
