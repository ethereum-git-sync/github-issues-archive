{
  "url": "https://api.github.com/repos/ConsenSys/teku/issues/4062",
  "repository_url": "https://api.github.com/repos/ConsenSys/teku",
  "labels_url": "https://api.github.com/repos/ConsenSys/teku/issues/4062/labels{/name}",
  "comments_url": "https://api.github.com/repos/ConsenSys/teku/issues/4062/comments",
  "events_url": "https://api.github.com/repos/ConsenSys/teku/issues/4062/events",
  "html_url": "https://github.com/ConsenSys/teku/issues/4062",
  "id": 912949218,
  "node_id": "MDU6SXNzdWU5MTI5NDkyMTg=",
  "number": 4062,
  "title": "Is the docker build image correct for ARM64?",
  "user": {
    "login": "outdoteth",
    "id": 37438950,
    "node_id": "MDQ6VXNlcjM3NDM4OTUw",
    "avatar_url": "https://avatars.githubusercontent.com/u/37438950?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/outdoteth",
    "html_url": "https://github.com/outdoteth",
    "followers_url": "https://api.github.com/users/outdoteth/followers",
    "following_url": "https://api.github.com/users/outdoteth/following{/other_user}",
    "gists_url": "https://api.github.com/users/outdoteth/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/outdoteth/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/outdoteth/subscriptions",
    "organizations_url": "https://api.github.com/users/outdoteth/orgs",
    "repos_url": "https://api.github.com/users/outdoteth/repos",
    "events_url": "https://api.github.com/users/outdoteth/events{/privacy}",
    "received_events_url": "https://api.github.com/users/outdoteth/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2021-06-06T21:10:40Z",
  "updated_at": "2021-11-14T22:57:32Z",
  "closed_at": "2021-11-14T22:57:32Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Description\r\n\r\nWhen I run `docker run consensys/teku:develop-jdk15` I get the following warning in the logs:\r\n\r\n```\r\nWARNING: The requested image's platform (linux/amd64) does not match the detected host platform (linux/arm64/v8) and no specific platform was requested\r\n```\r\n\r\nThis warning is unexpected given this PR here that was supposed to solve it (I think?): https://github.com/ConsenSys/teku/pull/3389\r\n\r\nThen occasionally after stopping and starting the image a few times I will get this SIGSILL error:\r\n\r\n![Screenshot 2021-06-06 at 21 32 41](https://user-images.githubusercontent.com/37438950/120939429-f4c63780-c70f-11eb-92d6-cbfed1b61bf8.png)\r\n\r\nIn the [openjdk](https://github.com/docker-library/openjdk/blob/master/16/jdk/slim-buster/Dockerfile) images they detect the platform on the docker image like this:\r\n\r\n![Screenshot 2021-06-06 at 21 45 13](https://user-images.githubusercontent.com/37438950/120939572-8df54e00-c710-11eb-9a5b-3ae09715aff2.png)\r\n\r\nSo to confirm that the errors are to do with the arm64 platform, I cloned the repo, built from source and then generated a brand new jdk15 docker image on my system (apple mac M1 chip - arm64). Then after running the image I no longer get the warning or error - it's running fine here:\r\n\r\n![Screenshot 2021-06-06 at 21 44 21](https://user-images.githubusercontent.com/37438950/120939526-60a8a000-c710-11eb-97cd-489ccd8069c7.png)\r\n\r\n### Steps to Reproduce (Bug)\r\n1. go on Apple mac arm64 M1 chip laptop\r\n2. do `docker pull consensys/teku:develop-jdk15`\r\n2. do `docker run consensys/teku:develop-jdk15`\r\n3. see warning\r\n4. stop container\r\n5. start again\r\n6. repeat step 4-5 until SIGSILL error or container becomes unresponsive (logs aren't generated)\r\n\r\n**Expected behavior:**\r\njdk15 image on dockerhub image should run fine on arm64 \r\n\r\n### Versions (Add all that apply)\r\n* OS Name & Version: [`MacOS Big Sur 11.3.1 (20E241)`]\r\n* Kernel Version: [`Darwin Dylans-MacBook-Pro.local 20.4.0 Darwin Kernel Version 20.4.0: Thu Apr 22 21:46:41 PDT 2021; root:xnu-7195.101.2~1/RELEASE_ARM64_T8101 arm64`]\r\n* Docker Version: Docker version 20.10.6, build 370c289\r\n\r\n### Additional Information\r\nAll errors and warnings go away after building the docker images locally from source - although the jdk14 image fails with a \"platform not supported\" error in the build script. So I think if the jdk15 image is to actually work on arm64 it has to be built on a arm64 machine - or maybe there is a flag to do some kind of emulation in docker.\r\n",
  "closed_by": {
    "login": "ajsutton",
    "id": 72675,
    "node_id": "MDQ6VXNlcjcyNjc1",
    "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ajsutton",
    "html_url": "https://github.com/ajsutton",
    "followers_url": "https://api.github.com/users/ajsutton/followers",
    "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
    "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
    "organizations_url": "https://api.github.com/users/ajsutton/orgs",
    "repos_url": "https://api.github.com/users/ajsutton/repos",
    "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ajsutton/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/4062/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ConsenSys/teku/issues/4062/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/857212590",
    "html_url": "https://github.com/ConsenSys/teku/issues/4062#issuecomment-857212590",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/4062",
    "id": 857212590,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg1NzIxMjU5MA==",
    "user": {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-06-08T22:14:23Z",
    "updated_at": "2021-06-08T22:14:23Z",
    "author_association": "CONTRIBUTOR",
    "body": "Apologies for the delay in getting back to you on this one. It looks like you're right - whichever platform the docker image gets built on selects the jdk base image that matches that architecture and so winds up being a single-arch image. Teku itself doesn't have any particular arch dependencies, it's just ensuring the right java base image is used.\n\nBuilding locally on the architecture you need is the only work around for now.  We'll have to look into what we can do in our CI setup to get the pre-built images to be multi-arch.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/857212590/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/961531163",
    "html_url": "https://github.com/ConsenSys/teku/issues/4062#issuecomment-961531163",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/4062",
    "id": 961531163,
    "node_id": "IC_kwDOCM9I9M45T80b",
    "user": {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-11-05T00:17:58Z",
    "updated_at": "2021-11-05T00:17:58Z",
    "author_association": "CONTRIBUTOR",
    "body": "CircleCI now have arm executors which may make it easier to get an arm built docker image: https://circleci.com/docs/2.0/arm-resources/\n\nI think it should be possible to build an arm docker on Linux/x86 executors but when I looked a while back I wasn't able to get it to work in CircleCI.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/961531163/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
