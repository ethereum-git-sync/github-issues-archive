{
  "url": "https://api.github.com/repos/Consensys/teku/issues/7301",
  "repository_url": "https://api.github.com/repos/Consensys/teku",
  "labels_url": "https://api.github.com/repos/Consensys/teku/issues/7301/labels{/name}",
  "comments_url": "https://api.github.com/repos/Consensys/teku/issues/7301/comments",
  "events_url": "https://api.github.com/repos/Consensys/teku/issues/7301/events",
  "html_url": "https://github.com/Consensys/teku/issues/7301",
  "id": 1771439095,
  "node_id": "I_kwDOCM9I9M5plgP3",
  "number": 7301,
  "title": "Failed to load public keys from Web3Signer URL when TLS enabled",
  "user": {
    "login": "jleeh",
    "id": 10528926,
    "node_id": "MDQ6VXNlcjEwNTI4OTI2",
    "avatar_url": "https://avatars.githubusercontent.com/u/10528926?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jleeh",
    "html_url": "https://github.com/jleeh",
    "followers_url": "https://api.github.com/users/jleeh/followers",
    "following_url": "https://api.github.com/users/jleeh/following{/other_user}",
    "gists_url": "https://api.github.com/users/jleeh/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jleeh/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jleeh/subscriptions",
    "organizations_url": "https://api.github.com/users/jleeh/orgs",
    "repos_url": "https://api.github.com/users/jleeh/repos",
    "events_url": "https://api.github.com/users/jleeh/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jleeh/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2023-06-23T13:10:22Z",
  "updated_at": "2023-07-03T11:26:43Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "<!-- \r\nBy filing an Issue, you are expected to comply with the Code of Conduct, \r\nincluding treating everyone with respect:\r\nhttps://github.com/ConsenSys/teku/blob/master/CODE-OF-CONDUCT.md\r\n\r\nNot all sections will apply to all issue types.\r\n-->\r\n\r\n### Description\r\nWhen using the Web3Signer with Teku and specifying a URL to load public keys from, when TLS is enabled Teku will fail to load the public keys due to a SSL exception:\r\n```\r\njavax.net.ssl.SSLHandshakeException: PKIX path building failed: sun.security.provider.certpath.SunCertPathBuilderException: unable to find valid certification path to requested target\r\n```\r\n\r\nWhen the public keys are explicitly defined in the argument rather than the URL, Teku will correctly boot. As seen in the attached logs, Teku will state that the external signer is reachable but throw an exception upon the retrieval of public keys.\r\n\r\n[validator.log](https://github.com/ConsenSys/teku/files/11848741/validator.log)\r\n\r\n### Steps to Reproduce (Bug)\r\n- Run Web3Signer with TLS enabled\r\n- Run Teku with Web3Signer enabled and `--validators-external-signer-public-keys` set to a https URL \r\n\r\n**Expected behavior:** Teku will fetch all public keys from Web3Signer\r\n\r\n**Actual behavior:** Exception is thrown\r\n\r\n**Frequency:** Always, at boot\r\n\r\n### Versions (Add all that apply)\r\n* Software version: Teku 23.5.0 & 23.6.0, Web3Signer 23.5.0 & 23.6.0\r\n* Java version: Java version built into container `consensys/teku:23.6.0`",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/Consensys/teku/issues/7301/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/Consensys/teku/issues/7301/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/Consensys/teku/issues/comments/1609123731",
    "html_url": "https://github.com/Consensys/teku/issues/7301#issuecomment-1609123731",
    "issue_url": "https://api.github.com/repos/Consensys/teku/issues/7301",
    "id": 1609123731,
    "node_id": "IC_kwDOCM9I9M5f6UeT",
    "user": {
      "login": "tbenr",
      "id": 15999009,
      "node_id": "MDQ6VXNlcjE1OTk5MDA5",
      "avatar_url": "https://avatars.githubusercontent.com/u/15999009?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tbenr",
      "html_url": "https://github.com/tbenr",
      "followers_url": "https://api.github.com/users/tbenr/followers",
      "following_url": "https://api.github.com/users/tbenr/following{/other_user}",
      "gists_url": "https://api.github.com/users/tbenr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tbenr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tbenr/subscriptions",
      "organizations_url": "https://api.github.com/users/tbenr/orgs",
      "repos_url": "https://api.github.com/users/tbenr/repos",
      "events_url": "https://api.github.com/users/tbenr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tbenr/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-06-27T09:24:58Z",
    "updated_at": "2023-06-27T09:24:58Z",
    "author_association": "CONTRIBUTOR",
    "body": "Hi @jleeh , this seems like a misconfiguration to correctly establish a TLS connection toward `https://eth-goerli-web3signer.eth-goerli-web3signer.svc.cluster.local:9000`\r\n\r\nIn particular what is missing is the trust store where to look for certificates to trust CA root\\intermediaries of the certificate exposed by your `eth-goerli-web3signer.eth-goerli-web3signer.svc.cluster.local`.\r\n\r\nyou need to specify a trusted store via `--validators-external-signer-truststore`  and `--validators-external-signer-truststore-password-file` (https://docs.teku.consensys.net/reference/cli/subcommands/voluntary-exit#validators-external-signer-truststore) \r\n\r\na full tutorial on how to configure TLS to operate with an external signer is here:\r\nhttps://docs.teku.consensys.net/tutorials/configure-external-signer-tls",
    "reactions": {
      "url": "https://api.github.com/repos/Consensys/teku/issues/comments/1609123731/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/Consensys/teku/issues/comments/1618008146",
    "html_url": "https://github.com/Consensys/teku/issues/7301#issuecomment-1618008146",
    "issue_url": "https://api.github.com/repos/Consensys/teku/issues/7301",
    "id": 1618008146,
    "node_id": "IC_kwDOCM9I9M5gcNhS",
    "user": {
      "login": "jleeh",
      "id": 10528926,
      "node_id": "MDQ6VXNlcjEwNTI4OTI2",
      "avatar_url": "https://avatars.githubusercontent.com/u/10528926?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jleeh",
      "html_url": "https://github.com/jleeh",
      "followers_url": "https://api.github.com/users/jleeh/followers",
      "following_url": "https://api.github.com/users/jleeh/following{/other_user}",
      "gists_url": "https://api.github.com/users/jleeh/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jleeh/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jleeh/subscriptions",
      "organizations_url": "https://api.github.com/users/jleeh/orgs",
      "repos_url": "https://api.github.com/users/jleeh/repos",
      "events_url": "https://api.github.com/users/jleeh/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jleeh/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-03T11:26:43Z",
    "updated_at": "2023-07-03T11:26:43Z",
    "author_association": "NONE",
    "body": "Hey @tbenr, thanks for the response.\r\n\r\nBoth ` --validators-external-signer-truststore` and `--validators-external-signer-truststore-password-file` are specified. To be specific, external signing works when the public keys are literally defined in `--validators-external-signer-public-keys`, but not when the URL is given.\r\n\r\nFor example, this validator is from the Teku using web3signer but with the keys defined:\r\nhttps://goerli.beaconcha.in/validator/0xabc21bf57dfc4cab9f31cd6924b82d89aa102c88deb0b56dafaf5642c3532639d02531b84427eca41036e09bd483d0ba#attestations\r\n\r\nWorking:\r\n```\r\n--validators-external-signer-public-keys=0xabc21bf57dfc4cab9f31cd6924b82d89aa102c88deb0b56dafaf5642c3532639d02531b84427eca41036e09bd483d0ba,0xab6e5323bf76d6cd36d7cb1c4eac5d309bf92c04ae50ebb95cf642a70d2fc7e9900cb265f3973fa8965d9c631e7c3a72,0x8ea38b64bbfdc81e0eaf8fa80c21db76c1546567598d9eba55fc729a12f3cc752f4f35398caf0ed80baa7d0099367a46,0xb0baa498ae3fe6b0201d074748575d4d71f6109ba7ef1a51d8ce18b10f6cfccbcbe001818fa046ba701907fff43cdfc4,0x993cde4d1e15d1428041a0bbceb0a499cfdaf46be47aee8bd0d710270ddd1344104a67e916d765f5e7b860ff8c28e3c0,0xaab0b1a353901c910753038153e628a78caa14b1aba2d04cc1a235010a3c2f12b5a3463c82cb70bf51b17bec381de4cc,0xb7663fc1f8ce9f2c7087cdc81e646106b54de2d7e311c0e58afef79488a68f677b4da220c99dff8b53f5392f2bcf9332,0x85d84349118ef30b6bd589c116320d085246572832f01253e1b0a1b2ea5046a13f1739619130c4c54b2921c0d6568b9e,0xaf1e65ad026e2f7d8db7bc09f8592dc84d892c698e94dacea4a0db9dd353dd308ceb8ba1c2bd5e29e8746a847347837a,0x91f58f1065c9b6e66e3de59f6663265e392a23736490b3b50db4b9acc82e697319337dbcd422ecc01d9e2a8c3fb335f6\r\n```\r\n\r\nNot working:\r\n```\r\n--validators-external-signer-public-keys=https://eth-goerli-web3signer.eth-goerli-web3signer.svc.cluster.local:9000/api/v1/eth2/publicKeys\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/Consensys/teku/issues/comments/1618008146/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
