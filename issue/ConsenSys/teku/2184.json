{
  "url": "https://api.github.com/repos/ConsenSys/teku/issues/2184",
  "repository_url": "https://api.github.com/repos/ConsenSys/teku",
  "labels_url": "https://api.github.com/repos/ConsenSys/teku/issues/2184/labels{/name}",
  "comments_url": "https://api.github.com/repos/ConsenSys/teku/issues/2184/comments",
  "events_url": "https://api.github.com/repos/ConsenSys/teku/issues/2184/events",
  "html_url": "https://github.com/ConsenSys/teku/issues/2184",
  "id": 642652542,
  "node_id": "MDU6SXNzdWU2NDI2NTI1NDI=",
  "number": 2184,
  "title": "Add a lookup from state root to block root",
  "user": {
    "login": "ajsutton",
    "id": 72675,
    "node_id": "MDQ6VXNlcjcyNjc1",
    "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ajsutton",
    "html_url": "https://github.com/ajsutton",
    "followers_url": "https://api.github.com/users/ajsutton/followers",
    "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
    "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
    "organizations_url": "https://api.github.com/users/ajsutton/orgs",
    "repos_url": "https://api.github.com/users/ajsutton/repos",
    "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ajsutton/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "rolfyone",
    "id": 2967240,
    "node_id": "MDQ6VXNlcjI5NjcyNDA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2967240?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/rolfyone",
    "html_url": "https://github.com/rolfyone",
    "followers_url": "https://api.github.com/users/rolfyone/followers",
    "following_url": "https://api.github.com/users/rolfyone/following{/other_user}",
    "gists_url": "https://api.github.com/users/rolfyone/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/rolfyone/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rolfyone/subscriptions",
    "organizations_url": "https://api.github.com/users/rolfyone/orgs",
    "repos_url": "https://api.github.com/users/rolfyone/repos",
    "events_url": "https://api.github.com/users/rolfyone/events{/privacy}",
    "received_events_url": "https://api.github.com/users/rolfyone/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "rolfyone",
      "id": 2967240,
      "node_id": "MDQ6VXNlcjI5NjcyNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2967240?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rolfyone",
      "html_url": "https://github.com/rolfyone",
      "followers_url": "https://api.github.com/users/rolfyone/followers",
      "following_url": "https://api.github.com/users/rolfyone/following{/other_user}",
      "gists_url": "https://api.github.com/users/rolfyone/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rolfyone/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rolfyone/subscriptions",
      "organizations_url": "https://api.github.com/users/rolfyone/orgs",
      "repos_url": "https://api.github.com/users/rolfyone/repos",
      "events_url": "https://api.github.com/users/rolfyone/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rolfyone/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2020-06-21T22:28:44Z",
  "updated_at": "2020-07-28T04:18:47Z",
  "closed_at": "2020-07-28T04:18:47Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "### Description\nSo that I can lookup states by state root, add a mapping to hot and finalised storage that stores a `state root -> (block root, slot)` mapping.  In finalised data store `state root -> slot`.\n\nEnsure that mapping is added even for skipped slots (need to add an entry in `StateTransition.process_slot` when we set the new `state.state_roots` entry.\n\nWhen given a state root, we can then look up the associated block root (either directly in hot states or via `state root -> slot -> block root` for finalised) and from that get the state.  The returned state will not have any empty slots processed, so we may need to reprocess those empty slots which is why we're storing the slot not just the block root.",
  "closed_by": {
    "login": "rolfyone",
    "id": 2967240,
    "node_id": "MDQ6VXNlcjI5NjcyNDA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2967240?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/rolfyone",
    "html_url": "https://github.com/rolfyone",
    "followers_url": "https://api.github.com/users/rolfyone/followers",
    "following_url": "https://api.github.com/users/rolfyone/following{/other_user}",
    "gists_url": "https://api.github.com/users/rolfyone/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/rolfyone/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rolfyone/subscriptions",
    "organizations_url": "https://api.github.com/users/rolfyone/orgs",
    "repos_url": "https://api.github.com/users/rolfyone/repos",
    "events_url": "https://api.github.com/users/rolfyone/events{/privacy}",
    "received_events_url": "https://api.github.com/users/rolfyone/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/2184/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ConsenSys/teku/issues/2184/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/647884719",
    "html_url": "https://github.com/ConsenSys/teku/issues/2184#issuecomment-647884719",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/2184",
    "id": 647884719,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY0Nzg4NDcxOQ==",
    "user": {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-06-23T03:24:38Z",
    "updated_at": "2020-06-23T03:24:38Z",
    "author_association": "CONTRIBUTOR",
    "body": "We need to add a new lookup to `Store` which records `stateRoot->(blockRoot, slot)`. Using that information\nwe can regenerate any state by using the `blockRoot` to retrieve the state at the last block, then \nprocessing any empty slots to get up to `slot`.  We should ensure that any required processing is done\nwithout holding the `Store.readLock`.\n\nCan populate the state root lookup when regenerating states at startup (same time we populate `block_states`).\nWill need to ensure we capture the root for empty slots here.\n\nQ: We don't currently process slots until a block is received - should we change that to always track latest\nhead of the chain so we know the state root if the latest slot is empty?\n\n`Store.Transaction` will need to record new state roots in `putBlockAndState`. It will also need\n a new `putStateRoot(blockRoot, slot)` to support recording the state root for empty slots.\n `StateTransition.process_slot` will need to be able to optionally call `putBlockAndState` for each\n slot it processes.  Since this is in the middle of a transition we need to test carefully to ensure\n we capture the state root, slot and block root correctly so they are all consistent.\n \n`StoreTransactionUpdates` will need to be updated to send any new state roots to the storage system\nand to prune state roots from prior to finalization. Iterating through all state roots to prune based\non the slot is probably reasonable.\n\nThe database won't need to store state roots for hot state as they can be regenerated. For finalized\nstates it can store `stateRoot -> slot` and then use the existing `slot -> blockRoot` lookup to get\nthe block root.\n\nDetecting which state roots are on the finalized chain will have to be done by iterating through the \npruned states, and recording any state which matches a finalized block root as finalized.\n\nThe way this integrates may change when the work to support storing only some blocks in memory lands so will revisit then to do the actual integration work.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/647884719/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/657895508",
    "html_url": "https://github.com/ConsenSys/teku/issues/2184#issuecomment-657895508",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/2184",
    "id": 657895508,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY1Nzg5NTUwOA==",
    "user": {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-07-14T00:20:52Z",
    "updated_at": "2020-07-14T00:20:52Z",
    "author_association": "CONTRIBUTOR",
    "body": "So plan is:\r\n1. Capture state root for each generated state similar to the `InterimStateListener` in https://github.com/PegaSysEng/teku/compare/master...ajsutton:state-root-to-block-root These will be added to the store transaction and stored to the hot database but not kept in memory.\r\n2. Lookup by state root, goes to disk to load block root and slot for the given state root.  Then uses getStateByBlockRoot to get the closest state and reprocess any empty slots up to the required slot.\r\n3. On finalisation, start a background thread to walk through each state root in the hot database and delete it if the slot has now been finalised.\r\n4. For finalised data (if in prune mode, do nothing), start at the last finalised state we have stored, jump forward by `SLOTS_PER_HISTORICAL_ROOT` at a time and then use the state roots field from that state to store a stateRoot -> slot lookup.  We may need to generate states or may be able to just use states present in the store transaction.\r\n\r\nFollow up: while walking through finalised states to store state root lookup, store any states we regenerated that weren't already available from the store transaction because they'd been pruned.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/657895508/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
