{
  "url": "https://api.github.com/repos/ConsenSys/teku/issues/2980",
  "repository_url": "https://api.github.com/repos/ConsenSys/teku",
  "labels_url": "https://api.github.com/repos/ConsenSys/teku/issues/2980/labels{/name}",
  "comments_url": "https://api.github.com/repos/ConsenSys/teku/issues/2980/comments",
  "events_url": "https://api.github.com/repos/ConsenSys/teku/issues/2980/events",
  "html_url": "https://github.com/ConsenSys/teku/issues/2980",
  "id": 721966634,
  "node_id": "MDU6SXNzdWU3MjE5NjY2MzQ=",
  "number": 2980,
  "title": "Teku fails to start due to \"fatal error in Eth1DepositManager\"",
  "user": {
    "login": "kdelwat",
    "id": 1031518,
    "node_id": "MDQ6VXNlcjEwMzE1MTg=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1031518?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/kdelwat",
    "html_url": "https://github.com/kdelwat",
    "followers_url": "https://api.github.com/users/kdelwat/followers",
    "following_url": "https://api.github.com/users/kdelwat/following{/other_user}",
    "gists_url": "https://api.github.com/users/kdelwat/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/kdelwat/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/kdelwat/subscriptions",
    "organizations_url": "https://api.github.com/users/kdelwat/orgs",
    "repos_url": "https://api.github.com/users/kdelwat/repos",
    "events_url": "https://api.github.com/users/kdelwat/events{/privacy}",
    "received_events_url": "https://api.github.com/users/kdelwat/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2020-10-15T04:39:30Z",
  "updated_at": "2020-10-15T23:57:44Z",
  "closed_at": "2020-10-15T23:57:44Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Description\r\n\r\nI'm trying to run a validator on the Zinken testnet. When I try to start Teku, I get a fatal error:\r\n\r\n```\r\nFATAL - Exiting due to fatal error in Eth1DepositManager java.util.concurrent.CompletionException: tech.pegasys.teku.service.serviceutils.FatalServiceFailureException: java.util.concurrent.CompletionException: tech.pegasys.teku.pow.exception.InvalidDepositEventsException: Expected next deposit at index 162, but got 187 (See log file for full stack trace)\r\n```\r\n\r\nThis happens on start up every time. The full stack trace from the logs is:\r\n\r\n```\r\n2020-10-14 23:59:59.341+00:00 | pool-16-thread-572 | FATAL | teku-status-log | PLEASE CHECK YOUR ETH1 NODE | Encountered a problem retrieving deposit events from eth1 endpoint.\r\njava.util.concurrent.CompletionException: java.lang.RuntimeException: java.util.concurrent.CompletionException: tech.pegasys.teku.pow.exception.InvalidDepositEventsException: Expected next deposit at index 162, but got 187\r\n\tat java.util.concurrent.CompletableFuture.encodeThrowable(CompletableFuture.java:314) ~[?:?]\r\n\tat java.util.concurrent.CompletableFuture.completeThrowable(CompletableFuture.java:319) ~[?:?]\r\n\tat java.util.concurrent.CompletableFuture.uniHandle(CompletableFuture.java:932) ~[?:?]\r\n\tat java.util.concurrent.CompletableFuture$UniHandle.tryFire(CompletableFuture.java:907) ~[?:?]\r\n\tat java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:506) ~[?:?]\r\n\tat java.util.concurrent.CompletableFuture.complete(CompletableFuture.java:2073) ~[?:?]\r\n\tat tech.pegasys.teku.infrastructure.async.SafeFuture.lambda$propagateResult$2(SafeFuture.java:132) ~[teku-infrastructure-async-0.12.9-SNAPSHOT.jar:0.12.9-dev-1ba97581]\r\n\tat java.util.concurrent.CompletableFuture.uniWhenComplete(CompletableFuture.java:859) ~[?:?]\r\n\tat java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:837) ~[?:?]\r\n\tat java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:506) ~[?:?]\r\n\tat java.util.concurrent.CompletableFuture.complete(CompletableFuture.java:2073) ~[?:?]\r\n\tat tech.pegasys.teku.infrastructure.async.SafeFuture.lambda$propagateResult$2(SafeFuture.java:132) ~[teku-infrastructure-async-0.12.9-SNAPSHOT.jar:0.12.9-dev-1ba97581]\r\n\tat java.util.concurrent.CompletableFuture.uniWhenComplete(CompletableFuture.java:859) ~[?:?]\r\n\tat java.util.concurrent.CompletableFuture.uniWhenCompleteStage(CompletableFuture.java:883) ~[?:?]\r\n\tat java.util.concurrent.CompletableFuture.whenComplete(CompletableFuture.java:2251) ~[?:?]\r\n\tat tech.pegasys.teku.infrastructure.async.SafeFuture.whenComplete(SafeFuture.java:466) ~[teku-infrastructure-async-0.12.9-SNAPSHOT.jar:0.12.9-dev-1ba97581]\r\n\tat tech.pegasys.teku.infrastructure.async.SafeFuture.whenComplete(SafeFuture.java:28) ~[teku-infrastructure-async-0.12.9-SNAPSHOT.jar:0.12.9-dev-1ba97581]\r\n\tat tech.pegasys.teku.infrastructure.async.SafeFuture.propagateResult(SafeFuture.java:127) ~[teku-infrastructure-async-0.12.9-SNAPSHOT.jar:0.12.9-dev-1ba97581]\r\n\tat tech.pegasys.teku.infrastructure.async.SafeFuture.lambda$exceptionallyCompose$23(SafeFuture.java:319) ~[teku-infrastructure-async-0.12.9-SNAPSHOT.jar:0.12.9-dev-1ba97581]\r\n\tat java.util.concurrent.CompletableFuture.uniWhenComplete(CompletableFuture.java:859) ~[?:?]\r\n\tat java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:837) ~[?:?]\r\n\tat java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:506) ~[?:?]\r\n\tat java.util.concurrent.CompletableFuture.complete(CompletableFuture.java:2073) ~[?:?]\r\n\tat tech.pegasys.teku.infrastructure.async.SafeFuture.lambda$propagateResult$2(SafeFuture.java:132) ~[teku-infrastructure-async-0.12.9-SNAPSHOT.jar:0.12.9-dev-1ba97581]\r\n\tat java.util.concurrent.CompletableFuture.uniWhenComplete(CompletableFuture.java:859) ~[?:?]\r\n\tat java.util.concurrent.CompletableFuture.uniWhenCompleteStage(CompletableFuture.java:883) ~[?:?]\r\n\tat java.util.concurrent.CompletableFuture.whenComplete(CompletableFuture.java:2251) ~[?:?]\r\n\tat tech.pegasys.teku.infrastructure.async.SafeFuture.whenComplete(SafeFuture.java:466) ~[teku-infrastructure-async-0.12.9-SNAPSHOT.jar:0.12.9-dev-1ba97581]\r\n\tat tech.pegasys.teku.infrastructure.async.SafeFuture.whenComplete(SafeFuture.java:28) ~[teku-infrastructure-async-0.12.9-SNAPSHOT.jar:0.12.9-dev-1ba97581]\r\n\tat tech.pegasys.teku.infrastructure.async.SafeFuture.propagateResult(SafeFuture.java:127) ~[teku-infrastructure-async-0.12.9-SNAPSHOT.jar:0.12.9-dev-1ba97581]\r\n\tat tech.pegasys.teku.infrastructure.async.SafeFuture.lambda$exceptionallyCompose$23(SafeFuture.java:319) ~[teku-infrastructure-async-0.12.9-SNAPSHOT.jar:0.12.9-dev-1ba97581]\r\n\tat java.util.concurrent.CompletableFuture.uniWhenComplete(CompletableFuture.java:859) ~[?:?]\r\n\tat java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:837) ~[?:?]\r\n\tat java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:506) ~[?:?]\r\n\tat java.util.concurrent.CompletableFuture.complete(CompletableFuture.java:2073) ~[?:?]\r\n\tat tech.pegasys.teku.infrastructure.async.SafeFuture.lambda$propagateResult$2(SafeFuture.java:132) ~[teku-infrastructure-async-0.12.9-SNAPSHOT.jar:0.12.9-dev-1ba97581]\r\n\tat java.util.concurrent.CompletableFuture.uniWhenComplete(CompletableFuture.java:859) ~[?:?]\r\n\tat java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:837) ~[?:?]\r\n\tat java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:506) ~[?:?]\r\n\tat java.util.concurrent.CompletableFuture.complete(CompletableFuture.java:2073) ~[?:?]\r\n\tat org.web3j.utils.Async.lambda$run$1(Async.java:38) ~[core-4.6.2.jar:?]\r\n\tat java.util.concurrent.CompletableFuture$AsyncRun.run(CompletableFuture.java:1736) [?:?]\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) [?:?]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) [?:?]\r\n\tat java.lang.Thread.run(Thread.java:834) [?:?]\r\nCaused by: java.lang.RuntimeException: java.util.concurrent.CompletionException: tech.pegasys.teku.pow.exception.InvalidDepositEventsException: Expected next deposit at index 162, but got 187\r\n\tat tech.pegasys.teku.pow.DepositProcessingController.onSubscriptionDepositRequestFailed(DepositProcessingController.java:178) ~[teku-pow-0.12.9-SNAPSHOT.jar:0.12.9-dev-1ba97581]\r\n\tat tech.pegasys.teku.pow.DepositProcessingController.onSubscriptionDepositRequestFailed(DepositProcessingController.java:170) ~[teku-pow-0.12.9-SNAPSHOT.jar:0.12.9-dev-1ba97581]\r\n\tat tech.pegasys.teku.pow.DepositProcessingController.lambda$fetchLatestDepositsOneBlockAtATime$5(DepositProcessingController.java:154) ~[teku-pow-0.12.9-SNAPSHOT.jar:0.12.9-dev-1ba97581]\r\n\tat tech.pegasys.teku.infrastructure.async.SafeFuture.lambda$finish$18(SafeFuture.java:256) ~[teku-infrastructure-async-0.12.9-SNAPSHOT.jar:0.12.9-dev-1ba97581]\r\n\tat java.util.concurrent.CompletableFuture.uniHandle(CompletableFuture.java:930) ~[?:?]\r\n\t... 42 more\r\nCaused by: java.util.concurrent.CompletionException: tech.pegasys.teku.pow.exception.InvalidDepositEventsException: Expected next deposit at index 162, but got 187\r\n\tat java.util.concurrent.CompletableFuture.encodeThrowable(CompletableFuture.java:314) ~[?:?]\r\n\tat java.util.concurrent.CompletableFuture.completeThrowable(CompletableFuture.java:319) ~[?:?]\r\n\tat java.util.concurrent.CompletableFuture$UniCompose.tryFire(CompletableFuture.java:1081) ~[?:?]\r\n\t... 41 more\r\nCaused by: tech.pegasys.teku.pow.exception.InvalidDepositEventsException: Expected next deposit at index 162, but got 187\r\n\tat tech.pegasys.teku.pow.exception.InvalidDepositEventsException.expectedDepositAtIndex(InvalidDepositEventsException.java:26) ~[teku-pow-0.12.9-SNAPSHOT.jar:0.12.9-dev-1ba97581]\r\n\tat tech.pegasys.teku.pow.ValidatingEth1EventsPublisher.assertDepositEventIsValid(ValidatingEth1EventsPublisher.java:56) ~[teku-pow-0.12.9-SNAPSHOT.jar:0.12.9-dev-1ba97581]\r\n\tat tech.pegasys.teku.pow.ValidatingEth1EventsPublisher.onDepositsFromBlock(ValidatingEth1EventsPublisher.java:46) ~[teku-pow-0.12.9-SNAPSHOT.jar:0.12.9-dev-1ba97581]\r\n\tat tech.pegasys.teku.pow.DepositFetcher.postDeposits(DepositFetcher.java:189) ~[teku-pow-0.12.9-SNAPSHOT.jar:0.12.9-dev-1ba97581]\r\n\tat tech.pegasys.teku.pow.DepositFetcher.postEventsForBlock(DepositFetcher.java:155) ~[teku-pow-0.12.9-SNAPSHOT.jar:0.12.9-dev-1ba97581]\r\n\tat tech.pegasys.teku.pow.DepositFetcher.postDepositEvents(DepositFetcher.java:126) ~[teku-pow-0.12.9-SNAPSHOT.jar:0.12.9-dev-1ba97581]\r\n\tat tech.pegasys.teku.pow.DepositFetcher.lambda$postDepositEvents$3(DepositFetcher.java:142) ~[teku-pow-0.12.9-SNAPSHOT.jar:0.12.9-dev-1ba97581]\r\n\tat java.util.concurrent.CompletableFuture$UniCompose.tryFire(CompletableFuture.java:1072) ~[?:?]\r\n\t... 41 more\r\n```\r\n\r\nThere doesn't seem to be anything amiss with the Eth 1.0 node, the logs just show block imports:\r\n\r\n```\r\n...\r\nOct 15 04:36:25 ip-172-31-26-186 besu[97792]: 2020-10-15 04:36:25.254+00:00 | EthScheduler-Workers-1 | INFO  | PersistBlockTask | Imported #3,577,625 / 4 tx / 0 om / 110,575 (1.4%) gas / (0xc12e4bb5f6043beb0f35a06ac0a161d98e7b506e46d02c07c1a02ff4a31854aa) in 0.023s. Peers: 3\r\nOct 15 04:36:25 ip-172-31-26-186 besu[97792]: 2020-10-15 04:36:25.721+00:00 | EthScheduler-Workers-0 | INFO  | PersistBlockTask | Imported #3,577,625 / 3 tx / 0 om / 89,571 (1.1%) gas / (0xe7a5abe02c5089d07e856a5427fcb82c858113108271d24cd81716ab4a079682) in 0.047s. Peers: 3\r\nOct 15 04:36:40 ip-172-31-26-186 besu[97792]: 2020-10-15 04:36:40.695+00:00 | EthScheduler-Workers-0 | INFO  | PersistBlockTask | Imported #3,577,626 / 2 tx / 0 om / 44,092 (0.6%) gas / (0xa46421f324669bffa533dbdfad3efe110f43d4a339c9d498061fc9eb46213d37) in 0.007s. Peers: 3\r\nOct 15 04:36:42 ip-172-31-26-186 besu[97792]: 2020-10-15 04:36:42.463+00:00 | EthScheduler-Workers-1 | INFO  | PersistBlockTask | Imported #3,577,626 / 2 tx / 0 om / 70,675 (0.9%) gas / (0x1fc02b7f4e43d1ca1d64d311c89ba0437525f654e472172e580faaaad97270f1) in 0.059s. Peers: 3\r\n...\r\n```\r\n\r\n### Steps to Reproduce\r\n\r\n* Run Teku with: \r\n\r\n```\r\nteku \\\r\n    --validators-key-files /home/ubuntu/validator_keys/keystore-m_12381_3600_0_0_0-1602024580.json \\\r\n    --validators-key-password-files /home/ubuntu/validator_keys/password.txt \\\r\n    --network=zinken \\\r\n    --metrics-enabled \\\r\n    --rest-api-enabled=true \\\r\n    --rest-api-docs-enabled=true \\\r\n    --eth1-endpoint=http://localhost:8545\r\n```\r\n\r\n* For the Eth1 node, I'm using Besu 1.5.0 without any custom configuration:\r\n\r\n```\r\n/home/ubuntu/besu-1.5.0/bin/besu --network=goerli --rpc-http-enabled\r\n```\r\n\r\n### Versions\r\n* Software version: `0.12.9-dev-1ba97581`\r\n* Besu version: `1.5.0`\r\n* Java version: `openjdk version \"11.0.8\" 2020-07-14`\r\n* OS Name & Version: Ubuntu 20.04.1 LTS\r\n* Kernel Version: `Linux ip-172-31-26-186 5.4.0-1024-aws #24-Ubuntu SMP Sat Sep 5 06:19:55 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux`\r\n* Cloud VM AWS EC2 t3.small\r\n\r\n### Additional Information\r\n\r\nPlease let me know what other information would be useful to start debugging this!",
  "closed_by": {
    "login": "kdelwat",
    "id": 1031518,
    "node_id": "MDQ6VXNlcjEwMzE1MTg=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1031518?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/kdelwat",
    "html_url": "https://github.com/kdelwat",
    "followers_url": "https://api.github.com/users/kdelwat/followers",
    "following_url": "https://api.github.com/users/kdelwat/following{/other_user}",
    "gists_url": "https://api.github.com/users/kdelwat/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/kdelwat/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/kdelwat/subscriptions",
    "organizations_url": "https://api.github.com/users/kdelwat/orgs",
    "repos_url": "https://api.github.com/users/kdelwat/repos",
    "events_url": "https://api.github.com/users/kdelwat/events{/privacy}",
    "received_events_url": "https://api.github.com/users/kdelwat/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/2980/reactions",
    "total_count": 1,
    "+1": 1,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ConsenSys/teku/issues/2980/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/708913044",
    "html_url": "https://github.com/ConsenSys/teku/issues/2980#issuecomment-708913044",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/2980",
    "id": 708913044,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcwODkxMzA0NA==",
    "user": {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-10-15T05:48:09Z",
    "updated_at": "2020-10-15T05:48:09Z",
    "author_association": "CONTRIBUTOR",
    "body": "@kdelwat This looks like you've run into https://github.com/hyperledger/besu/issues/1153 where Besu is failing to return some of the logs from the deposit contract.  It was fixed in Besu 1.5.5.  It will take a 20-30 mins to rebuild its indices after you upgrade Besu and you'll likely then need to restart Teku but it should make progress after that.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/708913044/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/709649524",
    "html_url": "https://github.com/ConsenSys/teku/issues/2980#issuecomment-709649524",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/2980",
    "id": 709649524,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcwOTY0OTUyNA==",
    "user": {
      "login": "kdelwat",
      "id": 1031518,
      "node_id": "MDQ6VXNlcjEwMzE1MTg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1031518?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/kdelwat",
      "html_url": "https://github.com/kdelwat",
      "followers_url": "https://api.github.com/users/kdelwat/followers",
      "following_url": "https://api.github.com/users/kdelwat/following{/other_user}",
      "gists_url": "https://api.github.com/users/kdelwat/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/kdelwat/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/kdelwat/subscriptions",
      "organizations_url": "https://api.github.com/users/kdelwat/orgs",
      "repos_url": "https://api.github.com/users/kdelwat/repos",
      "events_url": "https://api.github.com/users/kdelwat/events{/privacy}",
      "received_events_url": "https://api.github.com/users/kdelwat/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-10-15T23:57:44Z",
    "updated_at": "2020-10-15T23:57:44Z",
    "author_association": "NONE",
    "body": "@ajsutton That seems to have fixed it, thank you :smile: ",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/709649524/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
