{
  "url": "https://api.github.com/repos/Consensys/teku/issues/7144",
  "repository_url": "https://api.github.com/repos/Consensys/teku",
  "labels_url": "https://api.github.com/repos/Consensys/teku/issues/7144/labels{/name}",
  "comments_url": "https://api.github.com/repos/Consensys/teku/issues/7144/comments",
  "events_url": "https://api.github.com/repos/Consensys/teku/issues/7144/events",
  "html_url": "https://github.com/Consensys/teku/issues/7144",
  "id": 1709271083,
  "node_id": "I_kwDOCM9I9M5l4Wgr",
  "number": 7144,
  "title": "Teku takes longer than expected to query block headers by root",
  "user": {
    "login": "rolfyone",
    "id": 2967240,
    "node_id": "MDQ6VXNlcjI5NjcyNDA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2967240?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/rolfyone",
    "html_url": "https://github.com/rolfyone",
    "followers_url": "https://api.github.com/users/rolfyone/followers",
    "following_url": "https://api.github.com/users/rolfyone/following{/other_user}",
    "gists_url": "https://api.github.com/users/rolfyone/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/rolfyone/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rolfyone/subscriptions",
    "organizations_url": "https://api.github.com/users/rolfyone/orgs",
    "repos_url": "https://api.github.com/users/rolfyone/repos",
    "events_url": "https://api.github.com/users/rolfyone/events{/privacy}",
    "received_events_url": "https://api.github.com/users/rolfyone/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": {
    "login": "zilm13",
    "id": 6196452,
    "node_id": "MDQ6VXNlcjYxOTY0NTI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6196452?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/zilm13",
    "html_url": "https://github.com/zilm13",
    "followers_url": "https://api.github.com/users/zilm13/followers",
    "following_url": "https://api.github.com/users/zilm13/following{/other_user}",
    "gists_url": "https://api.github.com/users/zilm13/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/zilm13/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/zilm13/subscriptions",
    "organizations_url": "https://api.github.com/users/zilm13/orgs",
    "repos_url": "https://api.github.com/users/zilm13/repos",
    "events_url": "https://api.github.com/users/zilm13/events{/privacy}",
    "received_events_url": "https://api.github.com/users/zilm13/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "zilm13",
      "id": 6196452,
      "node_id": "MDQ6VXNlcjYxOTY0NTI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6196452?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/zilm13",
      "html_url": "https://github.com/zilm13",
      "followers_url": "https://api.github.com/users/zilm13/followers",
      "following_url": "https://api.github.com/users/zilm13/following{/other_user}",
      "gists_url": "https://api.github.com/users/zilm13/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/zilm13/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/zilm13/subscriptions",
      "organizations_url": "https://api.github.com/users/zilm13/orgs",
      "repos_url": "https://api.github.com/users/zilm13/repos",
      "events_url": "https://api.github.com/users/zilm13/events{/privacy}",
      "received_events_url": "https://api.github.com/users/zilm13/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2023-05-15T03:59:39Z",
  "updated_at": "2023-07-20T14:02:01Z",
  "closed_at": null,
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "from customer:\n\nI created a python script which starts off by querying the head block of a client and uses the parent hash to iterate down the chain until the genesis block. The purpose of this was so that we can calculate the actual chain created and see if there are forks between clients. The api requests for each client was conducted serially.\n\nI noticed that it would take substantially longer to query teku compared to other clients as seen by the difference in time between fetch requests (note: the time was recorded at the start of fetching)\n\nThis was the endpoint I used to construct the data:\n/eth/v1/beacon/headers/{block_id}\nhttps://ethereum.github.io/beacon-APIs/#/Beacon/getBlockHeader \n\nmy thoughts:\n\nsomething funky might be happening with the way data is queried:\n```\n> time curl http://localhost:5051/eth/v1/beacon/headers/0x4b1018549c3d6db84fb736bdf8a478b5c9a789ae64de37ad496aa05fdadebee4\n <.. snip>\nreal\t0m0.324s\nuser\t0m0.005s\nsys\t0m0.000s\n> time curl http://localhost:5051/eth/v1/beacon/headers/6441471\n <.. snip>\nreal\t0m0.083s\nuser\t0m0.000s\nsys\t0m0.005s\n```\n\nNot sure if it's just because of the way search by root works, or if we're doing something unusual when searching by root, but worth taking a look at how it all works on finalized blocks",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/Consensys/teku/issues/7144/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/Consensys/teku/issues/7144/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/Consensys/teku/issues/comments/1642514274",
    "html_url": "https://github.com/Consensys/teku/issues/7144#issuecomment-1642514274",
    "issue_url": "https://api.github.com/repos/Consensys/teku/issues/7144",
    "id": 1642514274,
    "node_id": "IC_kwDOCM9I9M5h5sdi",
    "user": {
      "login": "zilm13",
      "id": 6196452,
      "node_id": "MDQ6VXNlcjYxOTY0NTI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6196452?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/zilm13",
      "html_url": "https://github.com/zilm13",
      "followers_url": "https://api.github.com/users/zilm13/followers",
      "following_url": "https://api.github.com/users/zilm13/following{/other_user}",
      "gists_url": "https://api.github.com/users/zilm13/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/zilm13/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/zilm13/subscriptions",
      "organizations_url": "https://api.github.com/users/zilm13/orgs",
      "repos_url": "https://api.github.com/users/zilm13/repos",
      "events_url": "https://api.github.com/users/zilm13/events{/privacy}",
      "received_events_url": "https://api.github.com/users/zilm13/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-19T17:56:43Z",
    "updated_at": "2023-07-19T17:57:32Z",
    "author_association": "CONTRIBUTOR",
    "body": "I did some measurement with finalized data. I don't have hot data locally and assume we will pass hot slot/roots fast if we want to check the whole chain. At least 1000 slots were measured for each run. I've checked fresh finalized data and old assuming db compaction or something like this could have impact on the result. p2p was turned off to disable its impact on the result\r\n```\r\nFresh finalized by root:\r\n50th percentile (median): 0.004\r\n90th percentile: 0.005\r\n99th percentile: 0.006\r\nOld finalized by root:\r\n50th percentile (median): 0.003\r\n90th percentile: 0.004\r\n99th percentile: 0.012\r\n\r\nFresh finalized by slot:\r\n50th percentile (median): 0.032\r\n90th percentile: 0.084\r\n99th percentile: 0.088\r\nOld finalized by slot:\r\n50th percentile (median): 0.003\r\n90th percentile: 0.004\r\n99th percentile: 0.005\r\n```\r\nThe only misfit I see here is \"Fresh finalized by slot\", which become even worse while writing this, which is opposite to the user results, I will try to understand the reason of such result and try to get also results for hot data, as user query could affect hot data.",
    "reactions": {
      "url": "https://api.github.com/repos/Consensys/teku/issues/comments/1642514274/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/Consensys/teku/issues/comments/1642605409",
    "html_url": "https://github.com/Consensys/teku/issues/7144#issuecomment-1642605409",
    "issue_url": "https://api.github.com/repos/Consensys/teku/issues/7144",
    "id": 1642605409,
    "node_id": "IC_kwDOCM9I9M5h6Cth",
    "user": {
      "login": "zilm13",
      "id": 6196452,
      "node_id": "MDQ6VXNlcjYxOTY0NTI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6196452?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/zilm13",
      "html_url": "https://github.com/zilm13",
      "followers_url": "https://api.github.com/users/zilm13/followers",
      "following_url": "https://api.github.com/users/zilm13/following{/other_user}",
      "gists_url": "https://api.github.com/users/zilm13/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/zilm13/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/zilm13/subscriptions",
      "organizations_url": "https://api.github.com/users/zilm13/orgs",
      "repos_url": "https://api.github.com/users/zilm13/repos",
      "events_url": "https://api.github.com/users/zilm13/events{/privacy}",
      "received_events_url": "https://api.github.com/users/zilm13/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-19T19:04:06Z",
    "updated_at": "2023-07-19T19:20:10Z",
    "author_association": "CONTRIBUTOR",
    "body": "Funny thing after restart both fresh and old by slot is even worse:\r\n```\r\n50th percentile (median): 0.045\r\n90th percentile: 0.124\r\n99th percentile: 0.131\r\n```\r\nChanging https://github.com/ConsenSys/teku/blob/1ed6a09a561fdc89f4d1a21d529c21b2aa0950f1/storage/src/main/java/tech/pegasys/teku/storage/server/kvstore/dataaccess/CombinedKvStoreDao.java#L275 `getFloorEntry` to `get` makes time on par with by root:\r\n```\r\n50th percentile (median): 0.004\r\n90th percentile: 0.005\r\n99th percentile: 0.006\r\n```\r\nOne seek is 40-64ms always [(this line)](https://github.com/ConsenSys/teku/blob/a9f0099bf7daadfc3ea89e06f37b337d2c323662/storage/src/main/java/tech/pegasys/teku/storage/server/leveldb/LevelDbInstance.java#L146), when block is missed in slot, next slot lookup adds the same amount of time to the result (which is, to be honest, very strange).",
    "reactions": {
      "url": "https://api.github.com/repos/Consensys/teku/issues/comments/1642605409/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/Consensys/teku/issues/comments/1642610625",
    "html_url": "https://github.com/Consensys/teku/issues/7144#issuecomment-1642610625",
    "issue_url": "https://api.github.com/repos/Consensys/teku/issues/7144",
    "id": 1642610625,
    "node_id": "IC_kwDOCM9I9M5h6D_B",
    "user": {
      "login": "zilm13",
      "id": 6196452,
      "node_id": "MDQ6VXNlcjYxOTY0NTI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6196452?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/zilm13",
      "html_url": "https://github.com/zilm13",
      "followers_url": "https://api.github.com/users/zilm13/followers",
      "following_url": "https://api.github.com/users/zilm13/following{/other_user}",
      "gists_url": "https://api.github.com/users/zilm13/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/zilm13/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/zilm13/subscriptions",
      "organizations_url": "https://api.github.com/users/zilm13/orgs",
      "repos_url": "https://api.github.com/users/zilm13/repos",
      "events_url": "https://api.github.com/users/zilm13/events{/privacy}",
      "received_events_url": "https://api.github.com/users/zilm13/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-19T19:08:43Z",
    "updated_at": "2023-07-19T19:12:40Z",
    "author_association": "CONTRIBUTOR",
    "body": "I would check all usages of `getFloorEntry` whether we really need it or not in every case plus I'd also check all `withIterator` usages if first and last column entry seek is slow too, just interesting",
    "reactions": {
      "url": "https://api.github.com/repos/Consensys/teku/issues/comments/1642610625/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/Consensys/teku/issues/comments/1643979810",
    "html_url": "https://github.com/Consensys/teku/issues/7144#issuecomment-1643979810",
    "issue_url": "https://api.github.com/repos/Consensys/teku/issues/7144",
    "id": 1643979810,
    "node_id": "IC_kwDOCM9I9M5h_SQi",
    "user": {
      "login": "zilm13",
      "id": 6196452,
      "node_id": "MDQ6VXNlcjYxOTY0NTI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6196452?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/zilm13",
      "html_url": "https://github.com/zilm13",
      "followers_url": "https://api.github.com/users/zilm13/followers",
      "following_url": "https://api.github.com/users/zilm13/following{/other_user}",
      "gists_url": "https://api.github.com/users/zilm13/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/zilm13/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/zilm13/subscriptions",
      "organizations_url": "https://api.github.com/users/zilm13/orgs",
      "repos_url": "https://api.github.com/users/zilm13/repos",
      "events_url": "https://api.github.com/users/zilm13/events{/privacy}",
      "received_events_url": "https://api.github.com/users/zilm13/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-20T13:58:39Z",
    "updated_at": "2023-07-20T14:02:01Z",
    "author_association": "CONTRIBUTOR",
    "body": "I did some measurements on our nodes and while Goerli measurements matches my local findings, Mainnet data varies a lot. So I'm not sure now. Please note, these measurements where taken with network on, which could affect the result.\r\n```\r\nGoerli finalized by slot 1\r\n50th percentile (median): 0.089\r\n90th percentile: 0.296\r\n99th percentile: 1.009\r\nGoerli by finalized slot 2\r\n50th percentile (median): 0.086\r\n90th percentile: 0.240\r\n99th percentile: 0.318\r\nGoerli by slot from head\r\n50th percentile (median): 0.086\r\n90th percentile: 0.241\r\n99th percentile: 0.313\r\n\r\nGoerli finalized by root 1\r\n50th percentile (median): 0.008\r\n90th percentile: 0.013\r\n99th percentile: 0.045\r\nGoerli finalized by root 2\r\n50th percentile (median): 0.007\r\n90th percentile: 0.010\r\n99th percentile: 0.017\r\nGoerli by root from head\r\n50th percentile (median): 0.007\r\n90th percentile: 0.013\r\n99th percentile: 0.116\r\n\r\nMainnet finalized by slot 1\r\n50th percentile (median): 0.006\r\n90th percentile: 0.008\r\n99th percentile: 1.457\r\nMainnet finalized by slot 2\r\n50th percentile (median): 0.208\r\n90th percentile: 0.397\r\n99th percentile: 1.881\r\nMainnet finalized by slot 3\r\n50th percentile (median): 0.005\r\n90th percentile: 0.006\r\n99th percentile: 0.010\r\nMainnet from head by slot 1\r\n50th percentile (median): 0.010\r\n90th percentile: 0.020\r\n99th percentile: 1.539\r\nMainnet from head by slot 2\r\n50th percentile (median): 0.009\r\n90th percentile: 0.013\r\n99th percentile: 1.509\r\n\r\nMainnet finalized by root 1\r\n50th percentile (median): 0.007\r\n90th percentile: 0.021\r\n99th percentile: 1.552\r\nMainnet finalized by root 2\r\n50th percentile (median): 0.009\r\n90th percentile: 0.21\r\n99th percentile: 0.402\r\nMainnet finalized by root 3\r\n50th percentile (median): 0.007\r\n90th percentile: 0.21\r\n99th percentile: 1.43116\r\nMainnet from head by root 1\r\n50th percentile (median): 0.008\r\n90th percentile: 0.012\r\n99th percentile: 1.293\r\nMainnet from head by root 2\r\n50th percentile (median): 0.009\r\n90th percentile: 0.213\r\n99th percentile: 0.409\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/Consensys/teku/issues/comments/1643979810/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
