{
  "url": "https://api.github.com/repos/ConsenSys/teku/issues/4867",
  "repository_url": "https://api.github.com/repos/ConsenSys/teku",
  "labels_url": "https://api.github.com/repos/ConsenSys/teku/issues/4867/labels{/name}",
  "comments_url": "https://api.github.com/repos/ConsenSys/teku/issues/4867/comments",
  "events_url": "https://api.github.com/repos/ConsenSys/teku/issues/4867/events",
  "html_url": "https://github.com/ConsenSys/teku/issues/4867",
  "id": 1105207435,
  "node_id": "I_kwDOCM9I9M5B4CCL",
  "number": 4867,
  "title": "Deadlock when stopping database",
  "user": {
    "login": "ajsutton",
    "id": 72675,
    "node_id": "MDQ6VXNlcjcyNjc1",
    "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ajsutton",
    "html_url": "https://github.com/ajsutton",
    "followers_url": "https://api.github.com/users/ajsutton/followers",
    "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
    "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
    "organizations_url": "https://api.github.com/users/ajsutton/orgs",
    "repos_url": "https://api.github.com/users/ajsutton/repos",
    "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ajsutton/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "zilm13",
    "id": 6196452,
    "node_id": "MDQ6VXNlcjYxOTY0NTI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6196452?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/zilm13",
    "html_url": "https://github.com/zilm13",
    "followers_url": "https://api.github.com/users/zilm13/followers",
    "following_url": "https://api.github.com/users/zilm13/following{/other_user}",
    "gists_url": "https://api.github.com/users/zilm13/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/zilm13/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/zilm13/subscriptions",
    "organizations_url": "https://api.github.com/users/zilm13/orgs",
    "repos_url": "https://api.github.com/users/zilm13/repos",
    "events_url": "https://api.github.com/users/zilm13/events{/privacy}",
    "received_events_url": "https://api.github.com/users/zilm13/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "zilm13",
      "id": 6196452,
      "node_id": "MDQ6VXNlcjYxOTY0NTI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6196452?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/zilm13",
      "html_url": "https://github.com/zilm13",
      "followers_url": "https://api.github.com/users/zilm13/followers",
      "following_url": "https://api.github.com/users/zilm13/following{/other_user}",
      "gists_url": "https://api.github.com/users/zilm13/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/zilm13/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/zilm13/subscriptions",
      "organizations_url": "https://api.github.com/users/zilm13/orgs",
      "repos_url": "https://api.github.com/users/zilm13/repos",
      "events_url": "https://api.github.com/users/zilm13/events{/privacy}",
      "received_events_url": "https://api.github.com/users/zilm13/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 0,
  "created_at": "2022-01-16T22:39:02Z",
  "updated_at": "2022-02-21T20:47:39Z",
  "closed_at": "2022-02-21T20:47:39Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "### Description\r\nThere's a potential for deadlock when shutting down Teku. This is harmless but means Teku needs to be force terminated instead of shutting down cleanly.\r\n\r\nRelevant thread stack traces:\r\n```\r\n\"Thread-14\" #116 prio=5 os_prio=31 cpu=2.53ms elapsed=264.33s tid=0x000000013cddd000 nid=0x18f0f waiting on condition  [0x0000000323771000]\r\n   java.lang.Thread.State: WAITING (parking)\r\n\tat jdk.internal.misc.Unsafe.park(java.base@17.0.1/Native Method)\r\n\t- parking to wait for  <0x00000006d7263610> (a java.util.concurrent.locks.ReentrantLock$NonfairSync)\r\n\tat java.util.concurrent.locks.LockSupport.park(java.base@17.0.1/LockSupport.java:211)\r\n\tat java.util.concurrent.locks.AbstractQueuedSynchronizer.acquire(java.base@17.0.1/AbstractQueuedSynchronizer.java:715)\r\n\tat java.util.concurrent.locks.AbstractQueuedSynchronizer.acquire(java.base@17.0.1/AbstractQueuedSynchronizer.java:938)\r\n\tat java.util.concurrent.locks.ReentrantLock$Sync.lock(java.base@17.0.1/ReentrantLock.java:153)\r\n\tat java.util.concurrent.locks.ReentrantLock.lock(java.base@17.0.1/ReentrantLock.java:322)\r\n\tat tech.pegasys.teku.storage.server.leveldb.LevelDbTransaction.close(LevelDbTransaction.java:109)\r\n\tat tech.pegasys.teku.storage.server.leveldb.LevelDbInstance$$Lambda$1925/0x0000000801472bb8.accept(Unknown Source)\r\n\tat java.util.ArrayList.forEach(java.base@17.0.1/ArrayList.java:1511)\r\n\tat tech.pegasys.teku.storage.server.leveldb.LevelDbInstance.close(LevelDbInstance.java:276)\r\n\t- locked <0x00000006c07a5110> (a tech.pegasys.teku.storage.server.leveldb.LevelDbInstance)\r\n\tat tech.pegasys.teku.storage.server.kvstore.dataaccess.V4HotKvStoreDao.close(V4HotKvStoreDao.java:203)\r\n\tat tech.pegasys.teku.storage.server.kvstore.KvStoreDatabase.close(KvStoreDatabase.java:533)\r\n\tat tech.pegasys.teku.services.chainstorage.StorageService.lambda$doStop$1(StorageService.java:80)\r\n\tat tech.pegasys.teku.services.chainstorage.StorageService$$Lambda$1923/0x0000000801472758.run(Unknown Source)\r\n\tat tech.pegasys.teku.infrastructure.async.SafeFuture.fromRunnable(SafeFuture.java:154)\r\n\tat tech.pegasys.teku.services.chainstorage.StorageService.doStop(StorageService.java:78)\r\n\tat tech.pegasys.teku.service.serviceutils.Service.stop(Service.java:42)\r\n\tat tech.pegasys.teku.services.ServiceController$$Lambda$1921/0x00000008014722f8.apply(Unknown Source)\r\n\tat java.util.stream.ReferencePipeline$3$1.accept(java.base@17.0.1/ReferencePipeline.java:197)\r\n\tat java.util.ArrayList$ArrayListSpliterator.forEachRemaining(java.base@17.0.1/ArrayList.java:1625)\r\n\tat java.util.stream.AbstractPipeline.copyInto(java.base@17.0.1/AbstractPipeline.java:509)\r\n\tat java.util.stream.AbstractPipeline.wrapAndCopyInto(java.base@17.0.1/AbstractPipeline.java:499)\r\n\tat java.util.stream.AbstractPipeline.evaluate(java.base@17.0.1/AbstractPipeline.java:575)\r\n\tat java.util.stream.AbstractPipeline.evaluateToArrayNode(java.base@17.0.1/AbstractPipeline.java:260)\r\n\tat java.util.stream.ReferencePipeline.toArray(java.base@17.0.1/ReferencePipeline.java:616)\r\n\tat tech.pegasys.teku.services.ServiceController.doStop(ServiceController.java:40)\r\n\tat tech.pegasys.teku.service.serviceutils.Service.stop(Service.java:42)\r\n\tat tech.pegasys.teku.AbstractNode.stop(AbstractNode.java:138)\r\n\tat tech.pegasys.teku.Teku.lambda$main$0(Teku.java:47)\r\n\tat tech.pegasys.teku.Teku$$Lambda$1044/0x0000000801311000.run(Unknown Source)\r\n\tat java.lang.Thread.run(java.base@17.0.1/Thread.java:833)\r\n\r\n\"StorageUpdateChannel-0\" #41 daemon prio=5 os_prio=31 cpu=61028.62ms elapsed=1127.37s tid=0x000000012a589c00 nid=0xae03 waiting for monitor entry  [0x000000029988a000]\r\n   java.lang.Thread.State: BLOCKED (on object monitor)\r\n\tat tech.pegasys.teku.storage.server.leveldb.LevelDbInstance.onTransactionClosed(LevelDbInstance.java:306)\r\n\t- waiting to lock <0x00000006c07a5110> (a tech.pegasys.teku.storage.server.leveldb.LevelDbInstance)\r\n\tat tech.pegasys.teku.storage.server.leveldb.LevelDbTransaction.close(LevelDbTransaction.java:117)\r\n\tat tech.pegasys.teku.storage.server.leveldb.LevelDbTransaction.lambda$commit$6(LevelDbTransaction.java:97)\r\n\tat tech.pegasys.teku.storage.server.leveldb.LevelDbTransaction$$Lambda$574/0x00000008010dd990.run(Unknown Source)\r\n\tat tech.pegasys.teku.storage.server.leveldb.LevelDbTransaction.applyUpdate(LevelDbTransaction.java:130)\r\n\tat tech.pegasys.teku.storage.server.leveldb.LevelDbTransaction.commit(LevelDbTransaction.java:92)\r\n\tat tech.pegasys.teku.storage.server.kvstore.dataaccess.V4HotKvStoreDao$V4HotUpdater.commit(V4HotKvStoreDao.java:325)\r\n\tat tech.pegasys.teku.storage.server.kvstore.KvStoreDatabase.doUpdate(KvStoreDatabase.java:576)\r\n\tat tech.pegasys.teku.storage.server.kvstore.KvStoreDatabase.update(KvStoreDatabase.java:248)\r\n\tat tech.pegasys.teku.storage.server.ChainStorage.lambda$onStorageUpdate$0(ChainStorage.java:92)\r\n\tat tech.pegasys.teku.storage.server.ChainStorage$$Lambda$1058/0x0000000801313bd8.run(Unknown Source)\r\n\tat tech.pegasys.teku.infrastructure.async.SafeFuture.fromRunnable(SafeFuture.java:154)\r\n\tat tech.pegasys.teku.storage.server.ChainStorage.onStorageUpdate(ChainStorage.java:90)\r\n\tat jdk.internal.reflect.GeneratedMethodAccessor5.invoke(Unknown Source)\r\n\tat jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(java.base@17.0.1/DelegatingMethodAccessorImpl.java:43)\r\n\tat java.lang.reflect.Method.invoke(java.base@17.0.1/Method.java:568)\r\n\tat tech.pegasys.teku.infrastructure.events.DirectEventDeliverer.executeMethod(DirectEventDeliverer.java:74)\r\n\tat tech.pegasys.teku.infrastructure.events.DirectEventDeliverer.deliverToWithResponse(DirectEventDeliverer.java:67)\r\n\tat tech.pegasys.teku.infrastructure.events.AsyncEventDeliverer.lambda$deliverToWithResponse$1(AsyncEventDeliverer.java:75)\r\n\tat tech.pegasys.teku.infrastructure.events.AsyncEventDeliverer$$Lambda$452/0x000000080106d8c0.run(Unknown Source)\r\n\tat tech.pegasys.teku.infrastructure.events.AsyncEventDeliverer$QueueReader.deliverNextEvent(AsyncEventDeliverer.java:117)\r\n\tat tech.pegasys.teku.infrastructure.events.AsyncEventDeliverer$QueueReader.run(AsyncEventDeliverer.java:109)\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(java.base@17.0.1/ThreadPoolExecutor.java:1136)\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(java.base@17.0.1/ThreadPoolExecutor.java:635)\r\n\tat java.lang.Thread.run(java.base@17.0.1/Thread.java:833)\r\n\r\n\"forkchoice-async-0\" #66 prio=5 os_prio=31 cpu=10159.85ms elapsed=1123.65s tid=0x000000012ca91a00 nid=0x14003 waiting on condition  [0x000000029c592000]\r\n   java.lang.Thread.State: WAITING (parking)\r\n\tat jdk.internal.misc.Unsafe.park(java.base@17.0.1/Native Method)\r\n\t- parking to wait for  <0x00000006d71a1cf8> (a java.util.concurrent.CompletableFuture$Signaller)\r\n\tat java.util.concurrent.locks.LockSupport.park(java.base@17.0.1/LockSupport.java:211)\r\n\tat java.util.concurrent.CompletableFuture$Signaller.block(java.base@17.0.1/CompletableFuture.java:1864)\r\n\tat java.util.concurrent.ForkJoinPool.unmanagedBlock(java.base@17.0.1/ForkJoinPool.java:3463)\r\n\tat java.util.concurrent.ForkJoinPool.managedBlock(java.base@17.0.1/ForkJoinPool.java:3434)\r\n\tat java.util.concurrent.CompletableFuture.waitingGet(java.base@17.0.1/CompletableFuture.java:1898)\r\n\tat java.util.concurrent.CompletableFuture.join(java.base@17.0.1/CompletableFuture.java:2117)\r\n\tat tech.pegasys.teku.statetransition.forkchoice.ForkChoice.importBlockAndState(ForkChoice.java:291)\r\n\tat tech.pegasys.teku.statetransition.forkchoice.ForkChoice.lambda$onBlock$4(ForkChoice.java:220)\r\n\tat tech.pegasys.teku.statetransition.forkchoice.ForkChoice$$Lambda$1619/0x000000080141aa70.apply(Unknown Source)\r\n\tat java.util.concurrent.CompletableFuture$UniApply.tryFire(java.base@17.0.1/CompletableFuture.java:646)\r\n\tat java.util.concurrent.CompletableFuture$Completion.run(java.base@17.0.1/CompletableFuture.java:482)\r\n\tat tech.pegasys.teku.infrastructure.async.eventthread.AsyncRunnerEventThread.lambda$asSupplier$2(AsyncRunnerEventThread.java:131)\r\n\tat tech.pegasys.teku.infrastructure.async.eventthread.AsyncRunnerEventThread$$Lambda$598/0x00000008010e1b28.get(Unknown Source)\r\n\tat tech.pegasys.teku.infrastructure.async.eventthread.AsyncRunnerEventThread.recordEventThreadIdAndExecute(AsyncRunnerEventThread.java:122)\r\n\tat tech.pegasys.teku.infrastructure.async.eventthread.AsyncRunnerEventThread.lambda$doExecute$1(AsyncRunnerEventThread.java:105)\r\n\tat tech.pegasys.teku.infrastructure.async.eventthread.AsyncRunnerEventThread$$Lambda$562/0x00000008010daea8.get(Unknown Source)\r\n\tat tech.pegasys.teku.infrastructure.async.SafeFuture.of(SafeFuture.java:81)\r\n\tat tech.pegasys.teku.infrastructure.async.AsyncRunner.lambda$runAsync$2(AsyncRunner.java:38)\r\n\tat tech.pegasys.teku.infrastructure.async.AsyncRunner$$Lambda$466/0x00000008010753e8.get(Unknown Source)\r\n\tat tech.pegasys.teku.infrastructure.async.SafeFuture.of(SafeFuture.java:73)\r\n\tat tech.pegasys.teku.infrastructure.async.ScheduledExecutorAsyncRunner.lambda$createRunnableForAction$1(ScheduledExecutorAsyncRunner.java:119)\r\n\tat tech.pegasys.teku.infrastructure.async.ScheduledExecutorAsyncRunner$$Lambda$388/0x0000000800f9eb18.run(Unknown Source)\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(java.base@17.0.1/ThreadPoolExecutor.java:1136)\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(java.base@17.0.1/ThreadPoolExecutor.java:635)\r\n\tat java.lang.Thread.run(java.base@17.0.1/Thread.java:833)\r\n```\r\n",
  "closed_by": {
    "login": "zilm13",
    "id": 6196452,
    "node_id": "MDQ6VXNlcjYxOTY0NTI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6196452?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/zilm13",
    "html_url": "https://github.com/zilm13",
    "followers_url": "https://api.github.com/users/zilm13/followers",
    "following_url": "https://api.github.com/users/zilm13/following{/other_user}",
    "gists_url": "https://api.github.com/users/zilm13/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/zilm13/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/zilm13/subscriptions",
    "organizations_url": "https://api.github.com/users/zilm13/orgs",
    "repos_url": "https://api.github.com/users/zilm13/repos",
    "events_url": "https://api.github.com/users/zilm13/events{/privacy}",
    "received_events_url": "https://api.github.com/users/zilm13/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/4867/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ConsenSys/teku/issues/4867/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[

]
