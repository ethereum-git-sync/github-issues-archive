{
  "url": "https://api.github.com/repos/Consensys/teku/issues/7503",
  "repository_url": "https://api.github.com/repos/Consensys/teku",
  "labels_url": "https://api.github.com/repos/Consensys/teku/issues/7503/labels{/name}",
  "comments_url": "https://api.github.com/repos/Consensys/teku/issues/7503/comments",
  "events_url": "https://api.github.com/repos/Consensys/teku/issues/7503/events",
  "html_url": "https://github.com/Consensys/teku/issues/7503",
  "id": 1892446583,
  "node_id": "I_kwDOCM9I9M5wzHF3",
  "number": 7503,
  "title": "web3signer remote registration, unable to delete keys",
  "user": {
    "login": "yorickdowne",
    "id": 71337066,
    "node_id": "MDQ6VXNlcjcxMzM3MDY2",
    "avatar_url": "https://avatars.githubusercontent.com/u/71337066?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/yorickdowne",
    "html_url": "https://github.com/yorickdowne",
    "followers_url": "https://api.github.com/users/yorickdowne/followers",
    "following_url": "https://api.github.com/users/yorickdowne/following{/other_user}",
    "gists_url": "https://api.github.com/users/yorickdowne/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/yorickdowne/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/yorickdowne/subscriptions",
    "organizations_url": "https://api.github.com/users/yorickdowne/orgs",
    "repos_url": "https://api.github.com/users/yorickdowne/repos",
    "events_url": "https://api.github.com/users/yorickdowne/events{/privacy}",
    "received_events_url": "https://api.github.com/users/yorickdowne/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 6,
  "created_at": "2023-09-12T12:46:00Z",
  "updated_at": "2023-09-18T02:10:21Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Description\r\n\r\nI am starting Teku with `--validators-external-signer-url http://web3signer:9000 --validators-external-signer-public-keys external-signer` so that keys loaded into web3signer come in on startup, and users do not need to manually register these keys if they switched consensus layer clients.\r\n\r\nI also register the keys with Teku when loading them into web3signer, so that they are immediately live.\r\n\r\nThis creates an issue when trying to delete the remote registration.\r\n\r\n- Load keys into web3signer and register as remote key with Teku, via keymanager API\r\n- Restart Teku, it loads keys from the web3signer URL\r\n- Attempt to delete keys and delete remote registration, this fails. Likely because the remote registration was created upon startup from the web3signer URL:\r\n\r\n```\r\nRemote registration for validator 0x8fe5b2c0ce05093e3c6bbe1db0363b542709dfb4b8433e13ce23f1e7a7d840cc09a2ad97c5fd03980988df48bbe840f2 was found but an error was encountered trying to delete it:\r\nCannot remove read-only validator\r\n```\r\n\r\n- Restart Teku again. It would now not get a key list from web3signer, but it still sees the remote registration that was created on key import:\r\n\r\n```\r\nNo keys loaded into web3signer\r\nRemote keys registered with consensus\r\n0x9642bbe4853617cb603863e4c90398304724ad192c4d6337fded814a6ab0c04ede5dafd9d9148ae4c0d1a51354a17687 http://web3signer:9000\r\n0x8fe5b2c0ce05093e3c6bbe1db0363b542709dfb4b8433e13ce23f1e7a7d840cc09a2ad97c5fd03980988df48bbe840f2 http://web3signer:9000\r\n```\r\n\r\nThis is worrisome for users: They deleted keys but still see the registration. One user came to me with slashing fears.\r\n\r\n**Expected behavior:**\r\n\r\nI'd like to be able to remove registrations that I created, or that were created from web3signer when Teku starts, so key deletion also removes the remote registration from Teku.\r\n\r\nI'd like to keep the behavior where keys are immediately live on import, which is why they are imported into web3signer and then registered with Teku, both via keymanager API.\r\n\r\n**Frequency:**\r\n\r\nReproducible\r\n\r\n### Versions (Add all that apply)\r\n* Software version: `teku/v23.9.0/linux-x86_64/-eclipseadoptium-openjdk64bitservervm-java-17`\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/Consensys/teku/issues/7503/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/Consensys/teku/issues/7503/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/Consensys/teku/issues/comments/1716978966",
    "html_url": "https://github.com/Consensys/teku/issues/7503#issuecomment-1716978966",
    "issue_url": "https://api.github.com/repos/Consensys/teku/issues/7503",
    "id": 1716978966,
    "node_id": "IC_kwDOCM9I9M5mVwUW",
    "user": {
      "login": "rolfyone",
      "id": 2967240,
      "node_id": "MDQ6VXNlcjI5NjcyNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2967240?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rolfyone",
      "html_url": "https://github.com/rolfyone",
      "followers_url": "https://api.github.com/users/rolfyone/followers",
      "following_url": "https://api.github.com/users/rolfyone/following{/other_user}",
      "gists_url": "https://api.github.com/users/rolfyone/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rolfyone/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rolfyone/subscriptions",
      "organizations_url": "https://api.github.com/users/rolfyone/orgs",
      "repos_url": "https://api.github.com/users/rolfyone/repos",
      "events_url": "https://api.github.com/users/rolfyone/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rolfyone/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-09-13T05:38:22Z",
    "updated_at": "2023-09-13T05:38:22Z",
    "author_association": "CONTRIBUTOR",
    "body": "any Key that is added outside of keymanager is 'read only', because each startup it's going to load from the configuration and we have no control to remove it.\nIt can be very confusing attempting to load keys via config AND via keymanager, so my initial suggestion would be avoiding attempting to do that.\n\nUsing `--validators-external-signer-public-keys external-signer` basically tells teku to load the key via configuration, and I'd expect that any loaded via keymanager after that should actually fail to import given that they're present in the signer list already, are you saying you can add via config AND keymanager?\n\nI'll play around, but my initial assumption is avoid specifying `--validators-external-signer-public-keys external-signer`, as this loads via configuration (meaning they're read only), and you're wanting to manage keys with key-manager by the sounds.\n",
    "reactions": {
      "url": "https://api.github.com/repos/Consensys/teku/issues/comments/1716978966/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/Consensys/teku/issues/comments/1717790580",
    "html_url": "https://github.com/Consensys/teku/issues/7503#issuecomment-1717790580",
    "issue_url": "https://api.github.com/repos/Consensys/teku/issues/7503",
    "id": 1717790580,
    "node_id": "IC_kwDOCM9I9M5mY2d0",
    "user": {
      "login": "yorickdowne",
      "id": 71337066,
      "node_id": "MDQ6VXNlcjcxMzM3MDY2",
      "avatar_url": "https://avatars.githubusercontent.com/u/71337066?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/yorickdowne",
      "html_url": "https://github.com/yorickdowne",
      "followers_url": "https://api.github.com/users/yorickdowne/followers",
      "following_url": "https://api.github.com/users/yorickdowne/following{/other_user}",
      "gists_url": "https://api.github.com/users/yorickdowne/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/yorickdowne/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/yorickdowne/subscriptions",
      "organizations_url": "https://api.github.com/users/yorickdowne/orgs",
      "repos_url": "https://api.github.com/users/yorickdowne/repos",
      "events_url": "https://api.github.com/users/yorickdowne/events{/privacy}",
      "received_events_url": "https://api.github.com/users/yorickdowne/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-09-13T14:52:25Z",
    "updated_at": "2023-09-13T14:52:25Z",
    "author_association": "NONE",
    "body": "I’m trying to have my cake and eat it, too.\r\n\r\nWhen users load new keys into web3signer I’d like those to be live right away, so hence the use of keymanager. Is there another way, like sending a signal?\r\n\r\nWhen users switch clients, I’d like Teku to pick up web3signer keys without the need to use keymanager, hence the use of the command line parameter to load public keys. ",
    "reactions": {
      "url": "https://api.github.com/repos/Consensys/teku/issues/comments/1717790580/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/Consensys/teku/issues/comments/1717845757",
    "html_url": "https://github.com/Consensys/teku/issues/7503#issuecomment-1717845757",
    "issue_url": "https://api.github.com/repos/Consensys/teku/issues/7503",
    "id": 1717845757,
    "node_id": "IC_kwDOCM9I9M5mZD79",
    "user": {
      "login": "tbenr",
      "id": 15999009,
      "node_id": "MDQ6VXNlcjE1OTk5MDA5",
      "avatar_url": "https://avatars.githubusercontent.com/u/15999009?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tbenr",
      "html_url": "https://github.com/tbenr",
      "followers_url": "https://api.github.com/users/tbenr/followers",
      "following_url": "https://api.github.com/users/tbenr/following{/other_user}",
      "gists_url": "https://api.github.com/users/tbenr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tbenr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tbenr/subscriptions",
      "organizations_url": "https://api.github.com/users/tbenr/orgs",
      "repos_url": "https://api.github.com/users/tbenr/repos",
      "events_url": "https://api.github.com/users/tbenr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tbenr/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-09-13T15:20:29Z",
    "updated_at": "2023-09-13T15:20:29Z",
    "author_association": "CONTRIBUTOR",
    "body": "@yorickdowne you can try https://docs.teku.consensys.net/how-to/load-validators-without-restarting\r\nI don't know if it is add-only",
    "reactions": {
      "url": "https://api.github.com/repos/Consensys/teku/issues/comments/1717845757/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/Consensys/teku/issues/comments/1718701091",
    "html_url": "https://github.com/Consensys/teku/issues/7503#issuecomment-1718701091",
    "issue_url": "https://api.github.com/repos/Consensys/teku/issues/7503",
    "id": 1718701091,
    "node_id": "IC_kwDOCM9I9M5mcUwj",
    "user": {
      "login": "rolfyone",
      "id": 2967240,
      "node_id": "MDQ6VXNlcjI5NjcyNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2967240?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rolfyone",
      "html_url": "https://github.com/rolfyone",
      "followers_url": "https://api.github.com/users/rolfyone/followers",
      "following_url": "https://api.github.com/users/rolfyone/following{/other_user}",
      "gists_url": "https://api.github.com/users/rolfyone/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rolfyone/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rolfyone/subscriptions",
      "organizations_url": "https://api.github.com/users/rolfyone/orgs",
      "repos_url": "https://api.github.com/users/rolfyone/repos",
      "events_url": "https://api.github.com/users/rolfyone/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rolfyone/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-09-14T03:15:15Z",
    "updated_at": "2023-09-14T03:15:15Z",
    "author_association": "CONTRIBUTOR",
    "body": "I had a play today and was able to use `kill -s HUP <TEKU_PID>` to load more validators owned by a web3signer.\n\nIs this what we were looking to understand from this ticket ultimately?\n\nBasically my process:\n\n - loaded a set of keys to web3signer (about 130) - used my interop-keys.sh script\n\n - start teku as minimal, with \n ```\nvalidators-external-signer-url: http://localhost:19000\nvalidators-external-signer-public-keys: external-signer\n```\nsaw 130 keys loaded...\n\n - load more keys into web3signer, send hup, get notified `Loading 126 validator keys...`\n - normal prompts about slashing protection data etc, \n - issue another HUP, get `loading 0 validator keys`, because there were no new keys to load.\n \nI'm not sure removing would be so easy, as this process does seem additive, just putting it out there, in case that's a problem..",
    "reactions": {
      "url": "https://api.github.com/repos/Consensys/teku/issues/comments/1718701091/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/Consensys/teku/issues/comments/1718730597",
    "html_url": "https://github.com/Consensys/teku/issues/7503#issuecomment-1718730597",
    "issue_url": "https://api.github.com/repos/Consensys/teku/issues/7503",
    "id": 1718730597,
    "node_id": "IC_kwDOCM9I9M5mcb9l",
    "user": {
      "login": "rolfyone",
      "id": 2967240,
      "node_id": "MDQ6VXNlcjI5NjcyNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2967240?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rolfyone",
      "html_url": "https://github.com/rolfyone",
      "followers_url": "https://api.github.com/users/rolfyone/followers",
      "following_url": "https://api.github.com/users/rolfyone/following{/other_user}",
      "gists_url": "https://api.github.com/users/rolfyone/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rolfyone/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rolfyone/subscriptions",
      "organizations_url": "https://api.github.com/users/rolfyone/orgs",
      "repos_url": "https://api.github.com/users/rolfyone/repos",
      "events_url": "https://api.github.com/users/rolfyone/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rolfyone/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-09-14T04:02:19Z",
    "updated_at": "2023-09-14T04:02:19Z",
    "author_association": "CONTRIBUTOR",
    "body": "We actually have a test explicitly showing that we don't remove keys from an external signer, so if key a is there on load, and only b is there on reload, you'd be attempting duties for (a,b)\n\nI don't think this would be super hard to modify if it's helpful to remove the keys on HUP... probably a day or 2 of playing...",
    "reactions": {
      "url": "https://api.github.com/repos/Consensys/teku/issues/comments/1718730597/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/Consensys/teku/issues/comments/1722666055",
    "html_url": "https://github.com/Consensys/teku/issues/7503#issuecomment-1722666055",
    "issue_url": "https://api.github.com/repos/Consensys/teku/issues/7503",
    "id": 1722666055,
    "node_id": "IC_kwDOCM9I9M5mrcxH",
    "user": {
      "login": "rolfyone",
      "id": 2967240,
      "node_id": "MDQ6VXNlcjI5NjcyNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2967240?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rolfyone",
      "html_url": "https://github.com/rolfyone",
      "followers_url": "https://api.github.com/users/rolfyone/followers",
      "following_url": "https://api.github.com/users/rolfyone/following{/other_user}",
      "gists_url": "https://api.github.com/users/rolfyone/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rolfyone/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rolfyone/subscriptions",
      "organizations_url": "https://api.github.com/users/rolfyone/orgs",
      "repos_url": "https://api.github.com/users/rolfyone/repos",
      "events_url": "https://api.github.com/users/rolfyone/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rolfyone/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-09-18T02:08:37Z",
    "updated_at": "2023-09-18T02:08:37Z",
    "author_association": "CONTRIBUTOR",
    "body": "This is actually less simple than I was hoping, I might have to re-evaluate.\n\nMy use case:\n - start a network with 256 external validators\n - after a few epochs, remove them from the external signer\n - send HUP to teku (reloads) - still trying to perform duties (not great)\n - send keys to signer again  - successfully perform duties on teku with no hup (so the keys didnt get removed correctly)\n \nI'm going to close that PR un-merged, as this won't be the change you're looking for giving that odd behaviour, we'll have to have a closer look at it all.",
    "reactions": {
      "url": "https://api.github.com/repos/Consensys/teku/issues/comments/1722666055/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
