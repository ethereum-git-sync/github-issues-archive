{
  "url": "https://api.github.com/repos/ConsenSys/teku/issues/3261",
  "repository_url": "https://api.github.com/repos/ConsenSys/teku",
  "labels_url": "https://api.github.com/repos/ConsenSys/teku/issues/3261/labels{/name}",
  "comments_url": "https://api.github.com/repos/ConsenSys/teku/issues/3261/comments",
  "events_url": "https://api.github.com/repos/ConsenSys/teku/issues/3261/events",
  "html_url": "https://github.com/ConsenSys/teku/issues/3261",
  "id": 746894489,
  "node_id": "MDU6SXNzdWU3NDY4OTQ0ODk=",
  "number": 3261,
  "title": "Inaccurate \"expected_attestations\" validator performance metric",
  "user": {
    "login": "mbaxter",
    "id": 658601,
    "node_id": "MDQ6VXNlcjY1ODYwMQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/658601?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mbaxter",
    "html_url": "https://github.com/mbaxter",
    "followers_url": "https://api.github.com/users/mbaxter/followers",
    "following_url": "https://api.github.com/users/mbaxter/following{/other_user}",
    "gists_url": "https://api.github.com/users/mbaxter/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mbaxter/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mbaxter/subscriptions",
    "organizations_url": "https://api.github.com/users/mbaxter/orgs",
    "repos_url": "https://api.github.com/users/mbaxter/repos",
    "events_url": "https://api.github.com/users/mbaxter/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mbaxter/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "cemozerr",
    "id": 16581242,
    "node_id": "MDQ6VXNlcjE2NTgxMjQy",
    "avatar_url": "https://avatars.githubusercontent.com/u/16581242?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/cemozerr",
    "html_url": "https://github.com/cemozerr",
    "followers_url": "https://api.github.com/users/cemozerr/followers",
    "following_url": "https://api.github.com/users/cemozerr/following{/other_user}",
    "gists_url": "https://api.github.com/users/cemozerr/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/cemozerr/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/cemozerr/subscriptions",
    "organizations_url": "https://api.github.com/users/cemozerr/orgs",
    "repos_url": "https://api.github.com/users/cemozerr/repos",
    "events_url": "https://api.github.com/users/cemozerr/events{/privacy}",
    "received_events_url": "https://api.github.com/users/cemozerr/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "cemozerr",
      "id": 16581242,
      "node_id": "MDQ6VXNlcjE2NTgxMjQy",
      "avatar_url": "https://avatars.githubusercontent.com/u/16581242?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cemozerr",
      "html_url": "https://github.com/cemozerr",
      "followers_url": "https://api.github.com/users/cemozerr/followers",
      "following_url": "https://api.github.com/users/cemozerr/following{/other_user}",
      "gists_url": "https://api.github.com/users/cemozerr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cemozerr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cemozerr/subscriptions",
      "organizations_url": "https://api.github.com/users/cemozerr/orgs",
      "repos_url": "https://api.github.com/users/cemozerr/repos",
      "events_url": "https://api.github.com/users/cemozerr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cemozerr/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2020-11-19T20:21:07Z",
  "updated_at": "2020-11-24T04:44:28Z",
  "closed_at": "2020-11-24T04:44:28Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "### Description\r\nWe record a single \"[expected attestation](https://github.com/ConsenSys/teku/blob/acf069bb022a5590c3c170e57c1a71717a8154d5/validator/coordinator/src/main/java/tech/pegasys/teku/validator/coordinator/performance/ValidatorPerformanceMetrics.java#L40-L45)\" [when an unsigned attestation is created](https://github.com/ConsenSys/teku/blob/acf069bb022a5590c3c170e57c1a71717a8154d5/validator/coordinator/src/main/java/tech/pegasys/teku/validator/coordinator/ValidatorApiHandler.java#L258).  But when [`AttestationProductionDuty.produceAttestationsForCommittee`](https://github.com/ConsenSys/teku/blob/acf069bb022a5590c3c170e57c1a71717a8154d5/validator/client/src/main/java/tech/pegasys/teku/validator/client/duties/AttestationProductionDuty.java#L112-L120) runs, it requests a single unsigned attestation and can then end up creating multiple signed attestations for each validator in the committee.  The end result is that we can end up with metrics for \"included_attestations\" exceeding the value of \"expected_attestations\".",
  "closed_by": {
    "login": "ajsutton",
    "id": 72675,
    "node_id": "MDQ6VXNlcjcyNjc1",
    "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ajsutton",
    "html_url": "https://github.com/ajsutton",
    "followers_url": "https://api.github.com/users/ajsutton/followers",
    "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
    "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
    "organizations_url": "https://api.github.com/users/ajsutton/orgs",
    "repos_url": "https://api.github.com/users/ajsutton/repos",
    "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ajsutton/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/3261/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ConsenSys/teku/issues/3261/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/730616711",
    "html_url": "https://github.com/ConsenSys/teku/issues/3261#issuecomment-730616711",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/3261",
    "id": 730616711,
    "node_id": "MDEyOklzc3VlQ29tbWVudDczMDYxNjcxMQ==",
    "user": {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-11-19T20:24:37Z",
    "updated_at": "2020-11-19T20:24:37Z",
    "author_association": "CONTRIBUTOR",
    "body": "Word of warning - we donâ€™t want to change the validator to create a new attestation data for every validator, that would be a major performance hit when running a lot of validators. Not sure how to fix it otherwise but definitely not that answer. :)",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/730616711/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/730620419",
    "html_url": "https://github.com/ConsenSys/teku/issues/3261#issuecomment-730620419",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/3261",
    "id": 730620419,
    "node_id": "MDEyOklzc3VlQ29tbWVudDczMDYyMDQxOQ==",
    "user": {
      "login": "cemozerr",
      "id": 16581242,
      "node_id": "MDQ6VXNlcjE2NTgxMjQy",
      "avatar_url": "https://avatars.githubusercontent.com/u/16581242?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cemozerr",
      "html_url": "https://github.com/cemozerr",
      "followers_url": "https://api.github.com/users/cemozerr/followers",
      "following_url": "https://api.github.com/users/cemozerr/following{/other_user}",
      "gists_url": "https://api.github.com/users/cemozerr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cemozerr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cemozerr/subscriptions",
      "organizations_url": "https://api.github.com/users/cemozerr/orgs",
      "repos_url": "https://api.github.com/users/cemozerr/repos",
      "events_url": "https://api.github.com/users/cemozerr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cemozerr/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-11-19T20:31:45Z",
    "updated_at": "2020-11-19T20:31:45Z",
    "author_association": "CONTRIBUTOR",
    "body": "I was thinking we could add a custom API where the validator client reports to beacon node the result of calling `sendSignedAttestation`",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/730620419/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/730625827",
    "html_url": "https://github.com/ConsenSys/teku/issues/3261#issuecomment-730625827",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/3261",
    "id": 730625827,
    "node_id": "MDEyOklzc3VlQ29tbWVudDczMDYyNTgyNw==",
    "user": {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-11-19T20:42:46Z",
    "updated_at": "2020-11-19T20:42:46Z",
    "author_association": "CONTRIBUTOR",
    "body": "I'd say we want to stick to the standard API.  Actually we have to call `sendSignedAttestation` once per validator so if we just counted the number of those it would correctly report the number of produced attestations which is a good comparison to the number actually included.\r\n\r\nFrom chat, Ben just mentioned:\r\n> Fyi, my workaround in Grafana is to do sum(validator_performance_included_attestations{instance=~\"$system\"}) / sum(validator_local_validator_count{instance=~\"$system\"}) as, except for the first epoch when Teku is starting, the expected number per epoch is the number of attached validators.\r\n\r\nThat's also a useful approach and we track the number of validators based on their subnet subscriptions (which even include the ID): ActiveValidatorTracker is the class that does it.  That would give us the number of attestations we should have produced in the epoch regardless of whether the validator client failed to produce them (only has to get as far as calculating duties I think).\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/730625827/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/730632311",
    "html_url": "https://github.com/ConsenSys/teku/issues/3261#issuecomment-730632311",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/3261",
    "id": 730632311,
    "node_id": "MDEyOklzc3VlQ29tbWVudDczMDYzMjMxMQ==",
    "user": {
      "login": "cemozerr",
      "id": 16581242,
      "node_id": "MDQ6VXNlcjE2NTgxMjQy",
      "avatar_url": "https://avatars.githubusercontent.com/u/16581242?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cemozerr",
      "html_url": "https://github.com/cemozerr",
      "followers_url": "https://api.github.com/users/cemozerr/followers",
      "following_url": "https://api.github.com/users/cemozerr/following{/other_user}",
      "gists_url": "https://api.github.com/users/cemozerr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cemozerr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cemozerr/subscriptions",
      "organizations_url": "https://api.github.com/users/cemozerr/orgs",
      "repos_url": "https://api.github.com/users/cemozerr/repos",
      "events_url": "https://api.github.com/users/cemozerr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cemozerr/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-11-19T20:56:30Z",
    "updated_at": "2020-11-19T21:01:23Z",
    "author_association": "CONTRIBUTOR",
    "body": "I think Ben's approach is the simplest and generally the best approach. A while back as I was investigating this issue, I remember noticing counting the number of `sendSignedAttestation`'s would not work either. I don't exactly remember why, but I think it was due to the fact that `createUnsignedAttestation` itself could fail too, and in that scenario we would not have called `sendSignedAttestation`",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/730632311/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
