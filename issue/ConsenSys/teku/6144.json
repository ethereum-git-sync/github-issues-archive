{
  "url": "https://api.github.com/repos/ConsenSys/teku/issues/6144",
  "repository_url": "https://api.github.com/repos/ConsenSys/teku",
  "labels_url": "https://api.github.com/repos/ConsenSys/teku/issues/6144/labels{/name}",
  "comments_url": "https://api.github.com/repos/ConsenSys/teku/issues/6144/comments",
  "events_url": "https://api.github.com/repos/ConsenSys/teku/issues/6144/events",
  "html_url": "https://github.com/ConsenSys/teku/issues/6144",
  "id": 1354738793,
  "node_id": "I_kwDOCM9I9M5Qv6xp",
  "number": 6144,
  "title": "Service unavailable when fetching validator duties",
  "user": {
    "login": "alrevuelta",
    "id": 8811422,
    "node_id": "MDQ6VXNlcjg4MTE0MjI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/8811422?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/alrevuelta",
    "html_url": "https://github.com/alrevuelta",
    "followers_url": "https://api.github.com/users/alrevuelta/followers",
    "following_url": "https://api.github.com/users/alrevuelta/following{/other_user}",
    "gists_url": "https://api.github.com/users/alrevuelta/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/alrevuelta/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/alrevuelta/subscriptions",
    "organizations_url": "https://api.github.com/users/alrevuelta/orgs",
    "repos_url": "https://api.github.com/users/alrevuelta/repos",
    "events_url": "https://api.github.com/users/alrevuelta/events{/privacy}",
    "received_events_url": "https://api.github.com/users/alrevuelta/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2022-08-29T18:54:39Z",
  "updated_at": "2022-08-31T11:50:35Z",
  "closed_at": "2022-08-31T11:50:34Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Description\r\n\r\nWhen fetching the validator duties for a given epoch (a recent one close to the head) I get that the service is not available. Note that the endpoint I'm using is `eth/v1/validator/duties/proposer/xxx` and that the node is working properly (i.e. `curl http://localhost:5051/eth/v1/beacon/genesis` works)\r\n\r\n```\r\n{\"code\":503,\"message\":\"Service unavailable\"}\r\n```\r\n\r\nNote also that I started synching the node with an Infura provided `initial-state` several hours before, so perhaps the node hasn't downloaded the whole beacon chain. However, I'm fetching the duties of very recent epochs so it shouldn't be related.\r\n\r\n### Steps to Reproduce\r\n\r\n```\r\ncurl localhost:5051/eth/v1/validator/duties/proposer/143159\r\n```\r\n\r\n**Expected behavior:** Get the duties of this given epoch\r\n\r\n**Actual behavior:** Return a \"Service unavailable\" error\r\n\r\n**Frequency:** Always\r\n\r\n### Versions (Add all that apply)\r\n* Software version: `consensys/teku:22.8.1`\r\n* Java version: NA\r\n* OS Name & Version: NA\r\n* Docker Version: NA\r\n* Cloud VM, type, size: NA",
  "closed_by": {
    "login": "alrevuelta",
    "id": 8811422,
    "node_id": "MDQ6VXNlcjg4MTE0MjI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/8811422?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/alrevuelta",
    "html_url": "https://github.com/alrevuelta",
    "followers_url": "https://api.github.com/users/alrevuelta/followers",
    "following_url": "https://api.github.com/users/alrevuelta/following{/other_user}",
    "gists_url": "https://api.github.com/users/alrevuelta/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/alrevuelta/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/alrevuelta/subscriptions",
    "organizations_url": "https://api.github.com/users/alrevuelta/orgs",
    "repos_url": "https://api.github.com/users/alrevuelta/repos",
    "events_url": "https://api.github.com/users/alrevuelta/events{/privacy}",
    "received_events_url": "https://api.github.com/users/alrevuelta/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/6144/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ConsenSys/teku/issues/6144/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1231223531",
    "html_url": "https://github.com/ConsenSys/teku/issues/6144#issuecomment-1231223531",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/6144",
    "id": 1231223531,
    "node_id": "IC_kwDOCM9I9M5JYvrr",
    "user": {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-30T06:49:34Z",
    "updated_at": "2022-08-30T06:49:34Z",
    "author_association": "CONTRIBUTOR",
    "body": "The 503 response code indicates that the beacon node is still syncing.  Using initial-state it should have been in sync very quickly, but only if there wasn't already an existing database.  What do the beacon node logs show?",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1231223531/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1231460832",
    "html_url": "https://github.com/ConsenSys/teku/issues/6144#issuecomment-1231460832",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/6144",
    "id": 1231460832,
    "node_id": "IC_kwDOCM9I9M5JZpng",
    "user": {
      "login": "alrevuelta",
      "id": 8811422,
      "node_id": "MDQ6VXNlcjg4MTE0MjI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8811422?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alrevuelta",
      "html_url": "https://github.com/alrevuelta",
      "followers_url": "https://api.github.com/users/alrevuelta/followers",
      "following_url": "https://api.github.com/users/alrevuelta/following{/other_user}",
      "gists_url": "https://api.github.com/users/alrevuelta/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alrevuelta/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alrevuelta/subscriptions",
      "organizations_url": "https://api.github.com/users/alrevuelta/orgs",
      "repos_url": "https://api.github.com/users/alrevuelta/repos",
      "events_url": "https://api.github.com/users/alrevuelta/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alrevuelta/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-30T10:14:52Z",
    "updated_at": "2022-08-30T10:14:52Z",
    "author_association": "NONE",
    "body": "Adding the flags I'm using:\r\n```console\r\n- --data-path=/opt/teku/data\r\n- --network=mainnet\r\n- --ee-endpoint=http://geth:8551\r\n- --ee-jwt-secret-file=/consensus/jwtsecret\r\n- --metrics-enabled=true\r\n- --rest-api-enabled=true\r\n- --rest-api-host-allowlist=*\r\n- --initial-state=https://xxx:yyy@zzz.io/eth/v2/debug/beacon/states/finalized\r\n```\r\n\r\nRelated to the logs:\r\n* I see no errors\r\n* These are the last lines. Note that at the time of writing the head epoch is 143298 (as per beaconcha.in) so my node appears to be in sync.\r\n```\r\nEpoch Event *** Epoch: 143298, Justified checkpoint: 143297, Finalized checkpoint: 143296, Finalized root: 4beff9e039a80bcfd51836a8f1f815fa9fce62e9a183f9776b25964fa138656a\r\n\r\nSlot Event  *** Slot: 4585536, Block: 9b3175327a1e239a9287a370a7836a6f75c9149909ab6f982aed78d430a80584, Justified: 143297, Finalized: 143296, Peers: 100\r\n\r\n...\r\n\r\nSlot Event  *** Slot: 4585551, Block: 761bc6967d62c0c4f87a63801401b5dd99e7f31f7c002ce2defce6c607a28d49, Justified: 143297, Finalized: 143296, Peers: 97\r\n```\r\n\r\nThe node is not syncing, so already in sync.\r\n```console\r\n$ curl localhost:5051/eth/v1/node/syncing\r\n{\"data\":{\"head_slot\":\"4585552\",\"sync_distance\":\"0\",\"is_syncing\":false,\"is_optimistic\":false}}\r\n```\r\n\r\nAnd I have discovered a very weird behaviour. The endpoint `/eth/v1/validator/duties/proposer/xxx` works from `epoch=head` to `epoch=head-4` but it acts as a sliding window:\r\n* For example, let's say head is epoch = 143302\r\n* All epochs: 143302, 143301, 143300, 143299 work\r\n* Epoch 143298 does not work\r\n* When epoch++, epoch 143299 (which previously worked) stops working\r\n* When epoch++ again, epoch 143300 (which used to work) stops working\r\n\r\nWhen `head=143302`\r\ncurl localhost:5051/eth/v1/validator/duties/proposer/143302 OK\r\ncurl localhost:5051/eth/v1/validator/duties/proposer/143301 OK\r\ncurl localhost:5051/eth/v1/validator/duties/proposer/143300 OK\r\ncurl localhost:5051/eth/v1/validator/duties/proposer/143299 OK      **<- This used to work!**\r\ncurl localhost:5051/eth/v1/validator/duties/proposer/143298 NOK\r\n\r\nWhen `head=143303`\r\ncurl localhost:5051/eth/v1/validator/duties/proposer/143303 OK\r\ncurl localhost:5051/eth/v1/validator/duties/proposer/143302 OK\r\ncurl localhost:5051/eth/v1/validator/duties/proposer/143301 OK\r\ncurl localhost:5051/eth/v1/validator/duties/proposer/143300 OK\r\ncurl localhost:5051/eth/v1/validator/duties/proposer/143299 NOK. **<- Now it doesn't!**\r\n\r\nMore NOK examples in case it helps (`head=143303`)\r\ncurl localhost:5051/eth/v1/validator/duties/proposer/1 NOK\r\ncurl localhost:5051/eth/v1/validator/duties/proposer/50000 NOK\r\ncurl localhost:5051/eth/v1/validator/duties/proposer/140000 NOK\r\ncurl localhost:5051/eth/v1/validator/duties/proposer/143000 NOK\r\ncurl localhost:5051/eth/v1/validator/duties/proposer/143250 NOK\r\n\r\nI have checked my setup multiple times and I can't find anything wrong. Note that I'm using docker-compose mounting `/opt/teku/data` in a local folder.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1231460832/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1231494471",
    "html_url": "https://github.com/ConsenSys/teku/issues/6144#issuecomment-1231494471",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/6144",
    "id": 1231494471,
    "node_id": "IC_kwDOCM9I9M5JZx1H",
    "user": {
      "login": "alrevuelta",
      "id": 8811422,
      "node_id": "MDQ6VXNlcjg4MTE0MjI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8811422?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alrevuelta",
      "html_url": "https://github.com/alrevuelta",
      "followers_url": "https://api.github.com/users/alrevuelta/followers",
      "following_url": "https://api.github.com/users/alrevuelta/following{/other_user}",
      "gists_url": "https://api.github.com/users/alrevuelta/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alrevuelta/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alrevuelta/subscriptions",
      "organizations_url": "https://api.github.com/users/alrevuelta/orgs",
      "repos_url": "https://api.github.com/users/alrevuelta/repos",
      "events_url": "https://api.github.com/users/alrevuelta/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alrevuelta/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-30T10:48:15Z",
    "updated_at": "2022-08-30T10:48:15Z",
    "author_association": "NONE",
    "body": "> The 503 response code indicates that the beacon node is still syncing\r\n\r\nSome more information related to this.\r\n\r\nNote that this example uses a different setup than the one described above. It uses a Teku node without any `initial-state` that was just launched.\r\n\r\nUsing the endpoint I was using in an unsynced node I get this error, which is expected:\r\n```console\r\n$ curl localhost:5051/eth/v1/validator/duties/proposer/1\r\n{\"code\":503,\"message\":\"Beacon node is currently syncing and not serving requests\"}\r\n```\r\n\r\nBut in my case its \"**Service unavailable**\" which is different from \"**Beacon node is currently syncing and not serving requests**\", but still a 503 error.\r\n\r\nPerhaps the issue is related to the `initial-state`?\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1231494471/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1232242354",
    "html_url": "https://github.com/ConsenSys/teku/issues/6144#issuecomment-1232242354",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/6144",
    "id": 1232242354,
    "node_id": "IC_kwDOCM9I9M5Jcoay",
    "user": {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-30T22:38:57Z",
    "updated_at": "2022-08-30T22:38:57Z",
    "author_association": "CONTRIBUTOR",
    "body": "Ah, calculating proposer duties requires access to a BeaconState from within that epoch.  By default Teku using prune storage mode which doesn't store any states prior to the finalized checkpoint so when you're requesting proposer duties for a historic state the service is unavailable because that state has been pruned and the information is no longer available.  We should provide a more useful reason here though.\r\n\r\nSo you'd need to set `--data-archive-mode=archive` to get Teku to retain older states but it still wouldn't have information from before you first enable that or before the initial state you sync from.  To get the entire history you'd have to sync from genesis.\r\n\r\nAlternatively you could try out the experimental support for reconstructing historic states which lets you using initial-state to get in sync quickly but then backfills the historic beacon states. It will still take quite a while to get through them all but would be faster than syncing from genesis as we don't need to revalidate signatures.  You can enable it with `--Xreconstruct-historic-states`.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1232242354/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1232833567",
    "html_url": "https://github.com/ConsenSys/teku/issues/6144#issuecomment-1232833567",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/6144",
    "id": 1232833567,
    "node_id": "IC_kwDOCM9I9M5Je4wf",
    "user": {
      "login": "alrevuelta",
      "id": 8811422,
      "node_id": "MDQ6VXNlcjg4MTE0MjI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8811422?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alrevuelta",
      "html_url": "https://github.com/alrevuelta",
      "followers_url": "https://api.github.com/users/alrevuelta/followers",
      "following_url": "https://api.github.com/users/alrevuelta/following{/other_user}",
      "gists_url": "https://api.github.com/users/alrevuelta/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alrevuelta/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alrevuelta/subscriptions",
      "organizations_url": "https://api.github.com/users/alrevuelta/orgs",
      "repos_url": "https://api.github.com/users/alrevuelta/repos",
      "events_url": "https://api.github.com/users/alrevuelta/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alrevuelta/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-31T11:50:34Z",
    "updated_at": "2022-08-31T11:50:34Z",
    "author_association": "NONE",
    "body": "Thanks! I see, great explanation!\r\n\r\nClosing, since it's expected behavior. I solved my problem by just removing the `initial-state` flag and syncing the node from genesis since the suggested alternatives, `archive` doesn't fully solve my issue and I don't want to rely on experimental stuff.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1232833567/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
