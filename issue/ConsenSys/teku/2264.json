{
  "url": "https://api.github.com/repos/ConsenSys/teku/issues/2264",
  "repository_url": "https://api.github.com/repos/ConsenSys/teku",
  "labels_url": "https://api.github.com/repos/ConsenSys/teku/issues/2264/labels{/name}",
  "comments_url": "https://api.github.com/repos/ConsenSys/teku/issues/2264/comments",
  "events_url": "https://api.github.com/repos/ConsenSys/teku/issues/2264/events",
  "html_url": "https://github.com/ConsenSys/teku/issues/2264",
  "id": 647818447,
  "node_id": "MDU6SXNzdWU2NDc4MTg0NDc=",
  "number": 2264,
  "title": "Invalid Merkle tree proof in generated block",
  "user": {
    "login": "ajsutton",
    "id": 72675,
    "node_id": "MDQ6VXNlcjcyNjc1",
    "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ajsutton",
    "html_url": "https://github.com/ajsutton",
    "followers_url": "https://api.github.com/users/ajsutton/followers",
    "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
    "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
    "organizations_url": "https://api.github.com/users/ajsutton/orgs",
    "repos_url": "https://api.github.com/users/ajsutton/repos",
    "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ajsutton/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1048919129,
      "node_id": "MDU6TGFiZWwxMDQ4OTE5MTI5",
      "url": "https://api.github.com/repos/ConsenSys/teku/labels/bug%20%F0%9F%90%9E",
      "name": "bug üêû",
      "color": "dd6c94",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 2172541810,
      "node_id": "MDU6TGFiZWwyMTcyNTQxODEw",
      "url": "https://api.github.com/repos/ConsenSys/teku/labels/P2",
      "name": "P2",
      "color": "FFA500",
      "default": false,
      "description": "High"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "ajsutton",
    "id": 72675,
    "node_id": "MDQ6VXNlcjcyNjc1",
    "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ajsutton",
    "html_url": "https://github.com/ajsutton",
    "followers_url": "https://api.github.com/users/ajsutton/followers",
    "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
    "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
    "organizations_url": "https://api.github.com/users/ajsutton/orgs",
    "repos_url": "https://api.github.com/users/ajsutton/repos",
    "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ajsutton/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2020-06-30T03:08:58Z",
  "updated_at": "2020-07-14T01:37:12Z",
  "closed_at": "2020-07-14T01:37:11Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "### Description\r\nGot this error in Altona:\r\n```\r\n{\"timestamp\":\"2020-06-29T19:24:05,144\",\"level\":\"ERROR\",\"thread\":\"ValidatorApiChannel-0\",\"class\":\"teku-validator-log\",\"message\":\"Validator   *** Failed to produce block  Slot: 2070\",\"throwable\":\" tech.pegasys.teku.core.StateTransitionException: tech.pegasys.teku.core.exceptions.BlockProcessingException: java.lang.IllegalArgumentException: process_deposit: Verify the Merkle branch\r\nat tech.pegasys.teku.core.StateTransition.initiate(StateTransition.java:97)\r\nat tech.pegasys.teku.core.BlockProposalUtil.createNewUnsignedBlock(BlockProposalUtil.java:78)\r\nat tech.pegasys.teku.validator.coordinator.BlockFactory.createUnsignedBlock(BlockFactory.java:109)\r\nat tech.pegasys.teku.validator.coordinator.ValidatorApiHandler.lambda$createUnsignedBlock$3(ValidatorApiHandler.java:152)\r\nat tech.pegasys.teku.validator.coordinator.ValidatorApiHandler.lambda$createFromBlockAndState$4(ValidatorApiHandler.java:167)\r\nat tech.pegasys.teku.util.async.SafeFuture.lambda$thenApplyChecked$15(SafeFuture.java:275)\r\nat java.base/java.util.concurrent.CompletableFuture.uniComposeStage(CompletableFuture.java:1106)\r\nat java.base/java.util.concurrent.CompletableFuture.thenCompose(CompletableFuture.java:2235)\r\nat tech.pegasys.teku.util.async.SafeFuture.thenCompose(SafeFuture.java:312)\r\nat tech.pegasys.teku.util.async.SafeFuture.thenApplyChecked(SafeFuture.java:272)\r\nat tech.pegasys.teku.validator.coordinator.ValidatorApiHandler.createFromBlockAndState(ValidatorApiHandler.java:162)\r\nat tech.pegasys.teku.validator.coordinator.ValidatorApiHandler.createUnsignedBlock(ValidatorApiHandler.java:149)\r\nat jdk.internal.reflect.GeneratedMethodAccessor84.invoke(Unknown Source)\r\nat java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\nat java.base/java.lang.reflect.Method.invoke(Method.java:566)\r\nat tech.pegasys.teku.events.DirectEventDeliverer.executeMethod(DirectEventDeliverer.java:70)\r\nat tech.pegasys.teku.events.DirectEventDeliverer.deliverToWithResponse(DirectEventDeliverer.java:63)\r\nat tech.pegasys.teku.events.AsyncEventDeliverer.lambda$deliverToWithResponse$1(AsyncEventDeliverer.java:70)\r\nat tech.pegasys.teku.events.AsyncEventDeliverer$QueueReader.deliverNextEvent(AsyncEventDeliverer.java:111)\r\nat tech.pegasys.teku.events.AsyncEventDeliverer$QueueReader.run(AsyncEventDeliverer.java:103)\r\nat java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)\r\nat java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)\r\nat java.base/java.lang.Thread.run(Thread.java:834)\r\n\\nCaused by: tech.pegasys.teku.core.exceptions.BlockProcessingException: java.lang.IllegalArgumentException: process_deposit: Verify the Merkle branch\r\nat tech.pegasys.teku.core.BlockProcessorUtil.process_deposits(BlockProcessorUtil.java:420)\r\nat tech.pegasys.teku.core.BlockProcessorUtil.process_operations_no_validation(BlockProcessorUtil.java:222)\r\nat tech.pegasys.teku.core.StateTransition.lambda$process_block$0(StateTransition.java:115)\r\nat tech.pegasys.teku.datastructures.state.BeaconStateImpl.updated(BeaconStateImpl.java:246)\r\nat tech.pegasys.teku.core.StateTransition.process_block(StateTransition.java:110)\r\nat tech.pegasys.teku.core.StateTransition.initiate(StateTransition.java:82)\\n\\t... 22 more\\nCaused by: java.lang.IllegalArgumentException: process_deposit: Verify the Merkle branch\r\nat com.google.common.base.Preconditions.checkArgument(Preconditions.java:142)\r\nat tech.pegasys.teku.datastructures.util.BeaconStateUtil.process_deposit(BeaconStateUtil.java:112)\r\nat tech.pegasys.teku.core.BlockProcessorUtil.process_deposits(BlockProcessorUtil.java:416)\\n\\t... 27 more\\n\"}\r\n```\r\n",
  "closed_by": {
    "login": "ajsutton",
    "id": 72675,
    "node_id": "MDQ6VXNlcjcyNjc1",
    "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ajsutton",
    "html_url": "https://github.com/ajsutton",
    "followers_url": "https://api.github.com/users/ajsutton/followers",
    "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
    "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
    "organizations_url": "https://api.github.com/users/ajsutton/orgs",
    "repos_url": "https://api.github.com/users/ajsutton/repos",
    "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ajsutton/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/2264/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ConsenSys/teku/issues/2264/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/651552601",
    "html_url": "https://github.com/ConsenSys/teku/issues/2264#issuecomment-651552601",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/2264",
    "id": 651552601,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY1MTU1MjYwMQ==",
    "user": {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-06-30T05:40:51Z",
    "updated_at": "2020-06-30T05:40:51Z",
    "author_association": "CONTRIBUTOR",
    "body": "I'm at a loss as to how this happened.  At slot 2070 our Eth1Data vote would not have been sufficient to switch to the new Eth1Data.  So eth1DepositIndex was 1526 and deposit count 1657 meaning there were more deposits than could be included (the block that wound up being included at 2071 included those 16 deposits): https://altona.beaconcha.in/block/2071\n\nIf I comment out a couple of things so we don't prune deposit events and allow creating new blocks in historic slots, I'm able to successfully create the block we should have made at slot 2070.\n\nAll additions to `depositMerkleTree` and the call to create the proof are correctly within `synchronized` blocks - there are a couple of calls which populate the Eth1Data cache which are unsynchronised by they're read only so they might make us vote for the wrong Eth1Data but shouldn't be able to cause an invalid proof.   The deposits included in the body of the block I generated are exactly identical to the ones included in the real block at 2071 (which included the deposits we should have).  So we're able to create the proof correctly but something happened in real-time which made the proofs incorrect.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/651552601/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/657915544",
    "html_url": "https://github.com/ConsenSys/teku/issues/2264#issuecomment-657915544",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/2264",
    "id": 657915544,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY1NzkxNTU0NA==",
    "user": {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-07-14T01:37:11Z",
    "updated_at": "2020-07-14T01:37:11Z",
    "author_association": "CONTRIBUTOR",
    "body": "Looks like the synchronization issues were the cause and it's now fixed.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/657915544/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
