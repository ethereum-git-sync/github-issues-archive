{
  "url": "https://api.github.com/repos/ConsenSys/teku/issues/2661",
  "repository_url": "https://api.github.com/repos/ConsenSys/teku",
  "labels_url": "https://api.github.com/repos/ConsenSys/teku/issues/2661/labels{/name}",
  "comments_url": "https://api.github.com/repos/ConsenSys/teku/issues/2661/comments",
  "events_url": "https://api.github.com/repos/ConsenSys/teku/issues/2661/events",
  "html_url": "https://github.com/ConsenSys/teku/issues/2661",
  "id": 686526039,
  "node_id": "MDU6SXNzdWU2ODY1MjYwMzk=",
  "number": 2661,
  "title": "Teku periodically dropping out of sync",
  "user": {
    "login": "mbaxter",
    "id": 658601,
    "node_id": "MDQ6VXNlcjY1ODYwMQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/658601?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mbaxter",
    "html_url": "https://github.com/mbaxter",
    "followers_url": "https://api.github.com/users/mbaxter/followers",
    "following_url": "https://api.github.com/users/mbaxter/following{/other_user}",
    "gists_url": "https://api.github.com/users/mbaxter/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mbaxter/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mbaxter/subscriptions",
    "organizations_url": "https://api.github.com/users/mbaxter/orgs",
    "repos_url": "https://api.github.com/users/mbaxter/repos",
    "events_url": "https://api.github.com/users/mbaxter/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mbaxter/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1048919129,
      "node_id": "MDU6TGFiZWwxMDQ4OTE5MTI5",
      "url": "https://api.github.com/repos/ConsenSys/teku/labels/bug%20%F0%9F%90%9E",
      "name": "bug 🐞",
      "color": "dd6c94",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 2172541810,
      "node_id": "MDU6TGFiZWwyMTcyNTQxODEw",
      "url": "https://api.github.com/repos/ConsenSys/teku/labels/P2",
      "name": "P2",
      "color": "FFA500",
      "default": false,
      "description": "High"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "ajsutton",
    "id": 72675,
    "node_id": "MDQ6VXNlcjcyNjc1",
    "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ajsutton",
    "html_url": "https://github.com/ajsutton",
    "followers_url": "https://api.github.com/users/ajsutton/followers",
    "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
    "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
    "organizations_url": "https://api.github.com/users/ajsutton/orgs",
    "repos_url": "https://api.github.com/users/ajsutton/repos",
    "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ajsutton/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2020-08-26T18:25:45Z",
  "updated_at": "2020-08-27T03:39:57Z",
  "closed_at": "2020-08-27T03:39:57Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "### Description\r\nWe're getting reports of teku nodes periodically falling out of sync.  Seeing a series of slot events with empty blocks (dozens):\r\n```\r\nSlot Event  *** Slot: 158093, Block:    ... empty, Epoch: 4940, Finalized checkpoint: 4938, Finalized root: 73a437..be07, Peers: 74\r\n```\r\n\r\nEventually teku initiates a PeerSync and catches up.  But then falls behind again.  Anecdotally it seems like: \r\n> \"once it gets behind it’s stuck behind until it gets about ~50 slots behind and decides to sync the ~100 latest blocks\"\r\n\r\n### Versions (Add all that apply)\r\n* Software version: teku/v0.12.5-295d0f67\r\n\r\n",
  "closed_by": {
    "login": "ajsutton",
    "id": 72675,
    "node_id": "MDQ6VXNlcjcyNjc1",
    "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ajsutton",
    "html_url": "https://github.com/ajsutton",
    "followers_url": "https://api.github.com/users/ajsutton/followers",
    "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
    "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
    "organizations_url": "https://api.github.com/users/ajsutton/orgs",
    "repos_url": "https://api.github.com/users/ajsutton/repos",
    "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ajsutton/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/2661/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ConsenSys/teku/issues/2661/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/681050160",
    "html_url": "https://github.com/ConsenSys/teku/issues/2661#issuecomment-681050160",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/2661",
    "id": 681050160,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY4MTA1MDE2MA==",
    "user": {
      "login": "mbaxter",
      "id": 658601,
      "node_id": "MDQ6VXNlcjY1ODYwMQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/658601?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mbaxter",
      "html_url": "https://github.com/mbaxter",
      "followers_url": "https://api.github.com/users/mbaxter/followers",
      "following_url": "https://api.github.com/users/mbaxter/following{/other_user}",
      "gists_url": "https://api.github.com/users/mbaxter/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mbaxter/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mbaxter/subscriptions",
      "organizations_url": "https://api.github.com/users/mbaxter/orgs",
      "repos_url": "https://api.github.com/users/mbaxter/repos",
      "events_url": "https://api.github.com/users/mbaxter/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mbaxter/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-08-26T18:31:09Z",
    "updated_at": "2020-08-26T18:31:09Z",
    "author_association": "CONTRIBUTOR",
    "body": "I noticed that our own validator nodes started producing more empty slot events after an update on Aug 23 with the following changes: https://github.com/PegaSysEng/teku/compare/edde317223aa0578209ae588eaf435ca06a9ab17...1dc9801674819f2445d4d595209d3d893c2a96a2\r\n\r\nSee logs [here](https://kibana-logs-ohio.ops.pegasys.tech/app/kibana#/discover?_g=(filters:!(),refreshInterval:(pause:!t,value:0),time:(from:'2020-08-04T00:00:00.000Z',to:'2020-08-26T12:00:00.000Z'))&_a=(columns:!(message,instance),filters:!(('$state':(store:appState),meta:(alias:!n,disabled:!f,index:'8edd65d0-a9f4-11ea-9961-599210e124ad',key:service,negate:!f,params:(query:teku),type:phrase),query:(match_phrase:(service:teku))),('$state':(store:appState),meta:(alias:!n,disabled:!f,index:'8edd65d0-a9f4-11ea-9961-599210e124ad',key:instance,negate:!f,params:!(dev-teku-ohio-medalla-1,dev-teku-ohio-medalla-2,dev-teku-ohio-medalla-3,dev-teku-ohio-medalla-4),type:phrases,value:'dev-teku-ohio-medalla-1,%20dev-teku-ohio-medalla-2,%20dev-teku-ohio-medalla-3,%20dev-teku-ohio-medalla-4'),query:(bool:(minimum_should_match:1,should:!((match_phrase:(instance:dev-teku-ohio-medalla-1)),(match_phrase:(instance:dev-teku-ohio-medalla-2)),(match_phrase:(instance:dev-teku-ohio-medalla-3)),(match_phrase:(instance:dev-teku-ohio-medalla-4))))))),index:'8edd65d0-a9f4-11ea-9961-599210e124ad',interval:auto,query:(language:kuery,query:'%22Block:%20%20%20%20...%20empty%22'),sort:!(!('@timestamp',desc)))).\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/681050160/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/681207778",
    "html_url": "https://github.com/ConsenSys/teku/issues/2661#issuecomment-681207778",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/2661",
    "id": 681207778,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY4MTIwNzc3OA==",
    "user": {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-08-27T01:16:15Z",
    "updated_at": "2020-08-27T01:16:15Z",
    "author_association": "CONTRIBUTOR",
    "body": "Got a case of this with trace level logging for `BlockImporter` which is quite revealing. I've added some notes in brackets at the end based on what beaconcha.in reports:\n\n```\nSlot Event  *** Slot: 161983, Block: 3773dc..ca54, Epoch: 5061, Finalized checkpoint: 5059, Finalized root: b2e0ac..53ed, Peers: 74  (Correct Block)\nEpoch Event *** Epoch: 5062, Justified checkpoint: 5060, Finalized checkpoint: 5059, Finalized root: b2e0ac..53ed\nSlot Event  *** Slot: 161984, Block:    ... empty, Epoch: 5062, Finalized checkpoint: 5059, Finalized root: b2e0ac..53ed, Peers: 74  (Block existed)\n                Chain reorg from 0x3773dc509d364ad8eee5b8a8415ebf0c60b385a77ac488a756c697f1b187ca54 (161984) to 0x043034f0d9ae9d6b6e6b46621021a257f8f2ff8a7868c83fefe0c3aab6223b65 (161984) (Reorg from empty slot to correct block)\n                Successfully imported block 043034..3b65 (161984)                                                                    (Correct Block)\n                Failed to import block for reason UNKNOWN_PARENT: ed2476..a8c1 (161985)                                              (Correct Block - parent is 043034..3b65 which we do have)\nSlot Event  *** Slot: 161985, Block:    ... empty, Epoch: 5062, Finalized checkpoint: 5060, Finalized root: edc40a..5c99, Peers: 74\n                Failed to import block for reason UNKNOWN_PARENT: 15ee3d..ee12 (161986)\nSlot Event  *** Slot: 161986, Block:    ... empty, Epoch: 5062, Finalized checkpoint: 5060, Finalized root: edc40a..5c99, Peers: 73\nSlot Event  *** Slot: 161987, Block:    ... empty, Epoch: 5062, Finalized checkpoint: 5060, Finalized root: edc40a..5c99, Peers: 72\nSlot Event  *** Slot: 161988, Block:    ... empty, Epoch: 5062, Finalized checkpoint: 5060, Finalized root: edc40a..5c99, Peers: 72\n                Failed to import block for reason UNKNOWN_PARENT: 545348..397f (161989)\nSlot Event  *** Slot: 161989, Block:    ... empty, Epoch: 5062, Finalized checkpoint: 5060, Finalized root: edc40a..5c99, Peers: 73\n```\n\nSo we received all the blocks we needed, but for some reason failed importing 161985 because we didn't find the parent. We would have added it to the pending queue but because we did have the parent, it would never have been triggered to retry the import as that would normally happen once the parent is imported. Eventually it switched to sync mode again and caught up then carried on tracking head without an issue (but will fall behind again when this issue next occurs).",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/681207778/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/681232962",
    "html_url": "https://github.com/ConsenSys/teku/issues/2661#issuecomment-681232962",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/2661",
    "id": 681232962,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY4MTIzMjk2Mg==",
    "user": {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-08-27T01:26:53Z",
    "updated_at": "2020-08-27T01:26:53Z",
    "author_association": "CONTRIBUTOR",
    "body": "Ah, there's a race condition with importing blocks - we've wound up receiving 161984 and 161985 close together such that we haven't finished importing 161984 before we start gathering the data for 161985 so 161985 fails to find it's parent state.  All of that's ok (161985 could have been from a different fork so able to import in parallel).  The race condition is in `BlockManager` tracking pending blocks.  The sequence would be something like:\n\n1. `BlockManager.importBlock` Start importing 161984\n2. `BlockManager.importBlock` Start importing 161985\n3. `BlockManager.onBlockImported` Receives notification that 161984 finished imported. No pending blocks are waiting.\n4. `BlockManager.importBlock` receives `UNKNOWN_PARENT` response for 161985 and adds it to the pending block pool.  But this is too late to get the notification that 161984 has already completed.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/681232962/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
