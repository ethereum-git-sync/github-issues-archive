{
  "url": "https://api.github.com/repos/ConsenSys/teku/issues/5399",
  "repository_url": "https://api.github.com/repos/ConsenSys/teku",
  "labels_url": "https://api.github.com/repos/ConsenSys/teku/issues/5399/labels{/name}",
  "comments_url": "https://api.github.com/repos/ConsenSys/teku/issues/5399/comments",
  "events_url": "https://api.github.com/repos/ConsenSys/teku/issues/5399/events",
  "html_url": "https://github.com/ConsenSys/teku/issues/5399",
  "id": 1217897475,
  "node_id": "I_kwDOCM9I9M5Il6QD",
  "number": 5399,
  "title": "Attestation event stream always closes abruptly and can sometimes trigger an Exception",
  "user": {
    "login": "InvisibleSymbol",
    "id": 34715248,
    "node_id": "MDQ6VXNlcjM0NzE1MjQ4",
    "avatar_url": "https://avatars.githubusercontent.com/u/34715248?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/InvisibleSymbol",
    "html_url": "https://github.com/InvisibleSymbol",
    "followers_url": "https://api.github.com/users/InvisibleSymbol/followers",
    "following_url": "https://api.github.com/users/InvisibleSymbol/following{/other_user}",
    "gists_url": "https://api.github.com/users/InvisibleSymbol/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/InvisibleSymbol/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/InvisibleSymbol/subscriptions",
    "organizations_url": "https://api.github.com/users/InvisibleSymbol/orgs",
    "repos_url": "https://api.github.com/users/InvisibleSymbol/repos",
    "events_url": "https://api.github.com/users/InvisibleSymbol/events{/privacy}",
    "received_events_url": "https://api.github.com/users/InvisibleSymbol/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "ajsutton",
    "id": 72675,
    "node_id": "MDQ6VXNlcjcyNjc1",
    "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ajsutton",
    "html_url": "https://github.com/ajsutton",
    "followers_url": "https://api.github.com/users/ajsutton/followers",
    "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
    "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
    "organizations_url": "https://api.github.com/users/ajsutton/orgs",
    "repos_url": "https://api.github.com/users/ajsutton/repos",
    "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ajsutton/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2022-04-27T21:22:47Z",
  "updated_at": "2022-05-03T08:53:15Z",
  "closed_at": "2022-05-03T08:53:15Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "<!-- \r\nBy filing an Issue, you are expected to comply with the Code of Conduct, \r\nincluding treating everyone with respect:\r\nhttps://github.com/ConsenSys/teku/blob/master/CODE-OF-CONDUCT.md\r\n\r\nNot all sections will apply to all issue types.\r\n-->\r\n\r\n### Description\r\nI need a constant feed of all Attestation my node receives for a project I'm working on. The `http://node/eth/v1/events?topics=attestation` endpoint fits my needs perfectly, but is sadly unusable due to Teku constantly closing the stream. \r\n\r\n_This is both reproducible on my private node and with the endpoints infura provides, as they also use Teku._\r\n\r\n### Steps to Reproduce (Bug)\r\n`curl -X GET \"http://node:5051/eth/v1/events?topics=attestation\" -H 'Accept: text/event-stream'`\r\n\r\n**Expected behavior:**\r\nWell, nothing. I would expect an uninterrupted stream of attestation and no Exceptions being triggered.\r\n\r\n**Actual behavior:** \r\nAfter a few seconds, the stream will simply be cut-off (sometimes in the middle of data), with no error in the node logs. Every now and then an Exception like [this](https://github.com/ConsenSys/teku/files/8577731/teku_exception.log) or [this](https://github.com/ConsenSys/teku/files/8577773/teku_exception.log) appears when the stream gets cut.\r\n\r\n**Frequency:** \r\nThe Exception occurs about 20% of the time, the cut-off itselfs always after varying durations (1-30 seconds).\r\n\r\n### Versions\r\n* Software version: teku/v22.4.0/linux-x86_64/-eclipseadoptium-openjdk64bitservervm-java-17\r\n* OS Name & Version: Ubuntu 22.04 LTS\r\n* Docker Version: 20.10.14 Community\r\n* Cloud VM, type, size: Hetzner AX41-NVME",
  "closed_by": {
    "login": "ajsutton",
    "id": 72675,
    "node_id": "MDQ6VXNlcjcyNjc1",
    "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ajsutton",
    "html_url": "https://github.com/ajsutton",
    "followers_url": "https://api.github.com/users/ajsutton/followers",
    "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
    "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
    "organizations_url": "https://api.github.com/users/ajsutton/orgs",
    "repos_url": "https://api.github.com/users/ajsutton/repos",
    "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ajsutton/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/5399/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ConsenSys/teku/issues/5399/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1115515030",
    "html_url": "https://github.com/ConsenSys/teku/issues/5399#issuecomment-1115515030",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/5399",
    "id": 1115515030,
    "node_id": "IC_kwDOCM9I9M5CfWiW",
    "user": {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-03T01:04:08Z",
    "updated_at": "2022-05-03T01:04:08Z",
    "author_association": "CONTRIBUTOR",
    "body": "Sorry, we discussed this but apparently didn't actually post a response here. The event stream will disconnect when there are too many messages backed up that haven't been delivered to a subscriber yet. That protection is really important to prevent clients from connecting but never reading any data and then having pending events queue up and use all of Teku's memory.\r\n\r\nThe problem with trying to subscribe to attestations is that when the node is subscribed to all subnets it will receive about 10,000 attestations all at once and that tends to cause the queue of messages to spike and cause the connection to be disconnected.\r\n\r\nYou can increase the maximum queue size with `--Xrest-api-max-pending-events` to better handle these spikes.  We can probably also change the disconnection to allow the maximum to be exceeded for a short period of time to better handle these kinds of spikes.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1115515030/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
