{
  "url": "https://api.github.com/repos/ConsenSys/teku/issues/3262",
  "repository_url": "https://api.github.com/repos/ConsenSys/teku",
  "labels_url": "https://api.github.com/repos/ConsenSys/teku/issues/3262/labels{/name}",
  "comments_url": "https://api.github.com/repos/ConsenSys/teku/issues/3262/comments",
  "events_url": "https://api.github.com/repos/ConsenSys/teku/issues/3262/events",
  "html_url": "https://github.com/ConsenSys/teku/issues/3262",
  "id": 746964285,
  "node_id": "MDU6SXNzdWU3NDY5NjQyODU=",
  "number": 3262,
  "title": "Optimise block creation for first slot of epoch",
  "user": {
    "login": "ajsutton",
    "id": 72675,
    "node_id": "MDQ6VXNlcjcyNjc1",
    "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ajsutton",
    "html_url": "https://github.com/ajsutton",
    "followers_url": "https://api.github.com/users/ajsutton/followers",
    "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
    "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
    "organizations_url": "https://api.github.com/users/ajsutton/orgs",
    "repos_url": "https://api.github.com/users/ajsutton/repos",
    "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ajsutton/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1271198478,
      "node_id": "MDU6TGFiZWwxMjcxMTk4NDc4",
      "url": "https://api.github.com/repos/ConsenSys/teku/labels/performance%20%F0%9F%9A%80",
      "name": "performance ðŸš€",
      "color": "ffcce3",
      "default": false,
      "description": "Improves performance without changing functionality"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2020-11-19T22:09:32Z",
  "updated_at": "2022-08-16T10:17:17Z",
  "closed_at": "2022-08-16T10:17:16Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "### Description\nSeeing a higher rate of orphan blocks on Pyrmont for the first slot of the epoch. This will be due to the need to do epoch processing. We should investigate what optimisations are possible.",
  "closed_by": {
    "login": "ajsutton",
    "id": 72675,
    "node_id": "MDQ6VXNlcjcyNjc1",
    "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ajsutton",
    "html_url": "https://github.com/ajsutton",
    "followers_url": "https://api.github.com/users/ajsutton/followers",
    "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
    "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
    "organizations_url": "https://api.github.com/users/ajsutton/orgs",
    "repos_url": "https://api.github.com/users/ajsutton/repos",
    "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ajsutton/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/3262/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ConsenSys/teku/issues/3262/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/744150232",
    "html_url": "https://github.com/ConsenSys/teku/issues/3262#issuecomment-744150232",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/3262",
    "id": 744150232,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc0NDE1MDIzMg==",
    "user": {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-12-14T03:59:42Z",
    "updated_at": "2020-12-14T03:59:42Z",
    "author_association": "CONTRIBUTOR",
    "body": "With epoch transition now being precomputed we're seeing Teku produce the first block of epochs well inside the 4s cutoff to get votes.  It's still slower than other blocks but seems to be fast enough to be voted for.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/744150232/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/744353916",
    "html_url": "https://github.com/ConsenSys/teku/issues/3262#issuecomment-744353916",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/3262",
    "id": 744353916,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc0NDM1MzkxNg==",
    "user": {
      "login": "mcdee",
      "id": 511384,
      "node_id": "MDQ6VXNlcjUxMTM4NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/511384?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mcdee",
      "html_url": "https://github.com/mcdee",
      "followers_url": "https://api.github.com/users/mcdee/followers",
      "following_url": "https://api.github.com/users/mcdee/following{/other_user}",
      "gists_url": "https://api.github.com/users/mcdee/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mcdee/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mcdee/subscriptions",
      "organizations_url": "https://api.github.com/users/mcdee/orgs",
      "repos_url": "https://api.github.com/users/mcdee/repos",
      "events_url": "https://api.github.com/users/mcdee/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mcdee/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-12-14T10:45:52Z",
    "updated_at": "2020-12-14T10:45:52Z",
    "author_association": "CONTRIBUTOR",
    "body": "What is the process from a validator client's point of view to fetch a block proposal from teku?  Looking at the first slot of the epoch, can the validator client request the block as soon as the epoch starts (as defined by wall time) or is there a delay before teku will have applied the epoch transition and be able to provide a suitable block?",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/744353916/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/744703451",
    "html_url": "https://github.com/ConsenSys/teku/issues/3262#issuecomment-744703451",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/3262",
    "id": 744703451,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc0NDcwMzQ1MQ==",
    "user": {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-12-14T20:52:22Z",
    "updated_at": "2020-12-14T20:52:22Z",
    "author_association": "CONTRIBUTOR",
    "body": "Teku is able to create a block straight away (and even a few slots before the epoch start to allow for clock skew though obviously you don't want to be creating a new block before the slots before it have had a fair chance to be filled).  The epoch transition precomputing that just went into master runs a couple of seconds before the epoch boundary but if you request before that happens or if a block comes in that invalidates it, either the get duties call or the create block call with recalculate the correct epoch transition as part of the call (and that is then cached).\r\n\r\nThe one key timing based thing the beacon chain does, which isn't automatically done by the REST API calls a validator would make is it does a \"full\" fork choice run 4 seconds into the slot which is when it may switch forks.  That's not as critical as it sounds though as if a new block is received that builds on the current chain head we immediately select it as the new head without having to run that \"full\" fork choice.  So if you requested an attestation before the full fork choice run you might be on the old branch for one more slot than you probably should have been.\r\n\r\nThat fork choice run at 4 seconds made a lot more sense when it was the start of the validator attestation process but I suspect it should move more towards the end of the slot now so it can more quickly apply the attestations from the slot and have everything ready to create the next block.  Ultimately though, this is just the beacon node doing its job of ensuring it has the right chain for you and the validator ideally shouldn't need to think about it at all.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/744703451/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/767449449",
    "html_url": "https://github.com/ConsenSys/teku/issues/3262#issuecomment-767449449",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/3262",
    "id": 767449449,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc2NzQ0OTQ0OQ==",
    "user": {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-01-26T10:25:55Z",
    "updated_at": "2021-01-26T10:25:55Z",
    "author_association": "CONTRIBUTOR",
    "body": "One thing we could do, suggested by SigP is to process the next slot as soon as a block is imported.  Probably only do it for the canonical chain and then it would ensure the next block can be applied immediately.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/767449449/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1216443036",
    "html_url": "https://github.com/ConsenSys/teku/issues/3262#issuecomment-1216443036",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/3262",
    "id": 1216443036,
    "node_id": "IC_kwDOCM9I9M5IgXKc",
    "user": {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-16T10:17:16Z",
    "updated_at": "2022-08-16T10:17:16Z",
    "author_association": "CONTRIBUTOR",
    "body": "We're seeing consistently good performance creating blocks now. There's ongoing performance work under other tickets so will close this one.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1216443036/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
