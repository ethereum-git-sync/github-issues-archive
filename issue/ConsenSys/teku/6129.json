{
  "url": "https://api.github.com/repos/ConsenSys/teku/issues/6129",
  "repository_url": "https://api.github.com/repos/ConsenSys/teku",
  "labels_url": "https://api.github.com/repos/ConsenSys/teku/issues/6129/labels{/name}",
  "comments_url": "https://api.github.com/repos/ConsenSys/teku/issues/6129/comments",
  "events_url": "https://api.github.com/repos/ConsenSys/teku/issues/6129/events",
  "html_url": "https://github.com/ConsenSys/teku/issues/6129",
  "id": 1350886936,
  "node_id": "I_kwDOCM9I9M5QhOYY",
  "number": 6129,
  "title": "Teku validator client does not load all the keys from external signer",
  "user": {
    "login": "ybstaked",
    "id": 85460995,
    "node_id": "MDQ6VXNlcjg1NDYwOTk1",
    "avatar_url": "https://avatars.githubusercontent.com/u/85460995?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ybstaked",
    "html_url": "https://github.com/ybstaked",
    "followers_url": "https://api.github.com/users/ybstaked/followers",
    "following_url": "https://api.github.com/users/ybstaked/following{/other_user}",
    "gists_url": "https://api.github.com/users/ybstaked/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ybstaked/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ybstaked/subscriptions",
    "organizations_url": "https://api.github.com/users/ybstaked/orgs",
    "repos_url": "https://api.github.com/users/ybstaked/repos",
    "events_url": "https://api.github.com/users/ybstaked/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ybstaked/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2022-08-25T13:17:47Z",
  "updated_at": "2022-09-12T04:12:38Z",
  "closed_at": "2022-09-12T04:12:38Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "<!-- \r\nBy filing an Issue, you are expected to comply with the Code of Conduct, \r\nincluding treating everyone with respect:\r\nhttps://github.com/ConsenSys/teku/blob/master/CODE-OF-CONDUCT.md\r\n\r\nNot all sections will apply to all issue types.\r\n-->\r\n\r\n### Description\r\n- Teku validator client does not load all the keys from external signer, it fails silently or without a detailed error message, which causes many of our validators to miss attestations\r\n\r\n### Steps to Reproduce (Bug)\r\n[Please be as specific as possible]\r\n\r\nTeku validator clients: We run these each configured to manage ~240 keys.  They connect to a kubernetes svc beacon node load balancer w/ .25 cpu,  0.5Gi ram with the following parameters:\r\n```\r\nteku validator-client --network=auto --log-include-validator-duties-enabled=true --log-include-events-enabled=true --metrics-enabled=true --metrics-host-allowlist=* --metrics-port=8081 --metrics-interface=0.0.0.0 --data-path=/data --validators-external-signer-public-keys=\"http://$POD_IP:5050/api/v1/eth2/publicKeys\" --beacon-node-api-endpoint=\"http://cl-teku-beacon.eth.svc.cluster.local:5051/\" --validators-external-signer-url=\"http://$POD_IP:5050\" --validators-external-signer-timeout=2500 --log-color-enabled=false --log-file=/tmp/ethereum2.log\r\n```\r\n\r\nMessage in teku logs when this happens\r\n```\r\n[eth-validator-teku-eth-wallet-0176-0] 21:37:54.706 ERROR - External signer is currently not reachable at http://10.46.153.75:5050/\r\n[eth-validator-teku-eth-wallet-0176-0] 21:38:44.307 ERROR - Validator   *** Failed to produce attestation  Slot: 4546091 Validator: b4f882e tech.pegasys.teku.validator.client.signer.ExternalSignerException: External signer (http://10.46.153.75:5050/) failed to sign due to java.net.http.HttpTimeoutException: request timed out (See log file for full stack trace)\r\n```\r\n\r\n\r\n**Expected behavior:** [What you expect to happen]\r\n- Better retry from validator client to external signer to get all load keys and/or be more explicit when it cannot load all keys\r\n- Same behavior as prysm\r\n\r\n**Actual behavior:** [What actually happens]\r\n- Fail silently\r\n\r\n**Frequency:** [How regularly does it occur?]\r\n- When multiple validator clients are restarted together\r\n\r\n### Versions (Add all that apply)\r\n* Software version: [`teku --version` or look for log lines starting with `Teku version:`] 22.8.1\r\n* Java version: [`java -version`] eclipse-temurin:17.0.3_7-jdk-focal\r\n* OS Name & Version: [`cat /etc/*release`] ubuntu:20.04 docker base image\r\n* Docker Version: [`docker version`]\r\n* Cloud VM, type, size: [Amazon Web Services I3-large]",
  "closed_by": {
    "login": "ajsutton",
    "id": 72675,
    "node_id": "MDQ6VXNlcjcyNjc1",
    "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ajsutton",
    "html_url": "https://github.com/ajsutton",
    "followers_url": "https://api.github.com/users/ajsutton/followers",
    "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
    "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
    "organizations_url": "https://api.github.com/users/ajsutton/orgs",
    "repos_url": "https://api.github.com/users/ajsutton/repos",
    "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ajsutton/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/6129/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ConsenSys/teku/issues/6129/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1227802895",
    "html_url": "https://github.com/ConsenSys/teku/issues/6129#issuecomment-1227802895",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/6129",
    "id": 1227802895,
    "node_id": "IC_kwDOCM9I9M5JLskP",
    "user": {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-25T22:00:35Z",
    "updated_at": "2022-08-25T22:00:35Z",
    "author_association": "CONTRIBUTOR",
    "body": "Thanks for the info.  The logs indicate that Teku made five attempts to start.  The first four attempts to exited immediately with the error message:\r\n```\r\nFailed to load public keys from URL http://10.46.159.194:5050/api/v1/eth2/publicKeys\r\n```\r\n\r\nThis is because the external signer did not respond with the list of keys Teku should run. I’m assuming that Kubernetes automatically restarted teku  which caused it to retry loading the keys and again failed.  The logs also show that Teku has been configured to log to `/tmp/ethereum2.log` and additional detail on why the request to the signer failed will be in that log file. When the validators are unable to be loaded, teku has no way possible way to operate. The only two options are to exit with an explanation as it does, or continue running without performing any duties and repeatedly retry loading. We’ve chosen to have Teku exit in this case for a few reasons:\r\n\r\n1. Having the process exit tends to trigger monitoring alerts much more quickly and clearly than just having error messages in the log\r\n2. Given this instance of Teku has never seen the supplied URL work, it may be that there’s been a misconfiguration and the URL will never work, in which case retrying wouldn’t help\r\n3. In most setups there should be a system designed to automatically restart the process anyway which causes it to retry the request. It appears Kubernetes is doing that in this case\r\n\r\nOn the fifth attempt, Teku successfully loaded 246 validator keys and began loading and performing duties for them. The `External signer (http://10.46.153.75:5050/) failed to sign due to java.net.http.HttpTimeoutException` message indicates that when Teku requested the external signer sign an attestation as part of performing one of those scheduled duties, the signer did not respond in a timely fashion and the request failed because of that timeout. \r\n\r\nSo firstly in terms of logging, it looks like Teku is configured to split logging between the console and log file, but only the console output seems to be getting captured. For a Kubernetes setup, setting `--log-destination console` is generally recommended so that all log output is sent to the console.  That said, in this case the console log is already clearly reporting each failure with the indication that the signer is not responding.\r\n\r\nAs to why the signer is timing out after a restart, when the validator client restarts, it needs to recalculate all the duties that each validator is required to perform. As part of that, each validator needs to create a signature, via the external signer, to determine if it is the aggregator for the slot it is scheduled in. Duties can be calculated for both the current and next epoch so each validator would need to create two signatures as part of calculating those duties. So when the validator client is restarted, there is an increase in the number of signing requests sent to the external signer.  The signer doesn’t appear to be able to handle this increased load, leading to a timeout on some requests, while other requests are succeeding as seen by the log messages from Teku about successfully publishing attestations.\r\n\r\nWhen signing an attestation times out, Teku doesn’t retry because the attestation is already late and unlikely to be included and issuing another signing request to an already overloaded external signer would just overload it further likely leading to missing other attestations as well.\r\n\r\nUltimately resolving this issue will require identifying why the external signer is unable to respond in a timely manner. I’d also recommend looking at its response times even outside periods where validator clients have restarted as if it’s close to its resource limit there may be delays that don’t reach the timeout threshold but still slow down production of attestations and potentially reduce the rewards earned.\r\n\r\nTeku does have a couple of options to help tune its behaviour when the external signer is struggling to respond. Firstly the timeout can be adjusted with `--validators-external-signer-timeout` currently you’ve’ reduced this to 2500ms which gives the signer less time and makes timeouts more likely. Leaving this at the default of 5s would make timeouts less likely.\r\n\r\nThe rate of signing requests sent to the external signer as part of calculating duties can also be restricted with the `--Xvalidators-external-signer-concurrent-limit` option. The default is to limit to 32 concurrent requests and this could be reduced. A lower value will send fewer requests to the signer at a time, making it less likely to become overloaded, but will also mean it takes longer for Teku to calculate the duties for all validators which may introduce delays in beginning to perform those duties if the limit is set too low and the signer is still slow to respond.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1227802895/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1230616814",
    "html_url": "https://github.com/ConsenSys/teku/issues/6129#issuecomment-1230616814",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/6129",
    "id": 1230616814,
    "node_id": "IC_kwDOCM9I9M5JWbju",
    "user": {
      "login": "ybstaked",
      "id": 85460995,
      "node_id": "MDQ6VXNlcjg1NDYwOTk1",
      "avatar_url": "https://avatars.githubusercontent.com/u/85460995?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ybstaked",
      "html_url": "https://github.com/ybstaked",
      "followers_url": "https://api.github.com/users/ybstaked/followers",
      "following_url": "https://api.github.com/users/ybstaked/following{/other_user}",
      "gists_url": "https://api.github.com/users/ybstaked/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ybstaked/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ybstaked/subscriptions",
      "organizations_url": "https://api.github.com/users/ybstaked/orgs",
      "repos_url": "https://api.github.com/users/ybstaked/repos",
      "events_url": "https://api.github.com/users/ybstaked/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ybstaked/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-29T17:27:22Z",
    "updated_at": "2022-08-29T17:27:22Z",
    "author_association": "NONE",
    "body": "Thanks, @ajsutton, we'll roll out the `--validators-external-signer-timeout=5000``` and report if we're still having issues. ",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1230616814/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1243195983",
    "html_url": "https://github.com/ConsenSys/teku/issues/6129#issuecomment-1243195983",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/6129",
    "id": 1243195983,
    "node_id": "IC_kwDOCM9I9M5KGapP",
    "user": {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-12T04:12:38Z",
    "updated_at": "2022-09-12T04:12:38Z",
    "author_association": "CONTRIBUTOR",
    "body": "Going to close this one, but feel free to reopen or reach out if it's still happening with the increased timeout.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1243195983/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
