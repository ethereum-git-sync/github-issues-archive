{
  "url": "https://api.github.com/repos/ConsenSys/teku/issues/1743",
  "repository_url": "https://api.github.com/repos/ConsenSys/teku",
  "labels_url": "https://api.github.com/repos/ConsenSys/teku/issues/1743/labels{/name}",
  "comments_url": "https://api.github.com/repos/ConsenSys/teku/issues/1743/comments",
  "events_url": "https://api.github.com/repos/ConsenSys/teku/issues/1743/events",
  "html_url": "https://github.com/ConsenSys/teku/issues/1743",
  "id": 614680940,
  "node_id": "MDU6SXNzdWU2MTQ2ODA5NDA=",
  "number": 1743,
  "title": "ProtoArrayForkChoiceStrategy.onAttestation is not thread-safe",
  "user": {
    "login": "ericsson49",
    "id": 10426192,
    "node_id": "MDQ6VXNlcjEwNDI2MTky",
    "avatar_url": "https://avatars.githubusercontent.com/u/10426192?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ericsson49",
    "html_url": "https://github.com/ericsson49",
    "followers_url": "https://api.github.com/users/ericsson49/followers",
    "following_url": "https://api.github.com/users/ericsson49/following{/other_user}",
    "gists_url": "https://api.github.com/users/ericsson49/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ericsson49/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ericsson49/subscriptions",
    "organizations_url": "https://api.github.com/users/ericsson49/orgs",
    "repos_url": "https://api.github.com/users/ericsson49/repos",
    "events_url": "https://api.github.com/users/ericsson49/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ericsson49/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "cemozerr",
    "id": 16581242,
    "node_id": "MDQ6VXNlcjE2NTgxMjQy",
    "avatar_url": "https://avatars.githubusercontent.com/u/16581242?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/cemozerr",
    "html_url": "https://github.com/cemozerr",
    "followers_url": "https://api.github.com/users/cemozerr/followers",
    "following_url": "https://api.github.com/users/cemozerr/following{/other_user}",
    "gists_url": "https://api.github.com/users/cemozerr/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/cemozerr/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/cemozerr/subscriptions",
    "organizations_url": "https://api.github.com/users/cemozerr/orgs",
    "repos_url": "https://api.github.com/users/cemozerr/repos",
    "events_url": "https://api.github.com/users/cemozerr/events{/privacy}",
    "received_events_url": "https://api.github.com/users/cemozerr/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "cemozerr",
      "id": 16581242,
      "node_id": "MDQ6VXNlcjE2NTgxMjQy",
      "avatar_url": "https://avatars.githubusercontent.com/u/16581242?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cemozerr",
      "html_url": "https://github.com/cemozerr",
      "followers_url": "https://api.github.com/users/cemozerr/followers",
      "following_url": "https://api.github.com/users/cemozerr/following{/other_user}",
      "gists_url": "https://api.github.com/users/cemozerr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cemozerr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cemozerr/subscriptions",
      "organizations_url": "https://api.github.com/users/cemozerr/orgs",
      "repos_url": "https://api.github.com/users/cemozerr/repos",
      "events_url": "https://api.github.com/users/cemozerr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cemozerr/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 0,
  "created_at": "2020-05-08T11:21:42Z",
  "updated_at": "2020-05-08T19:25:32Z",
  "closed_at": "2020-05-08T19:25:32Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "### Description\r\n`ProtoArrayForkChoiceStrategy.onAttestation` uses a java parallel stream to process Validator indices of `IndexedAttestation`. During the processing a `Store.Transaction.getVote` method is called, which modifies a `votes` `HashMap`. Because of the parallel stream processing, the `votes` can be accessed (both read and modify) from several threads, which can lead to an exception, since `HashMap` is not thread-safe, and an access to it should be synchronized externally.\r\nA partial stack trace (see below for a full version):\r\n```\r\nCaused by: java.lang.ClassCastException: class java.util.HashMap$Node cannot be cast to class java.util.HashMap$TreeNode (java.util.HashMap$Node and java.util.HashMap$TreeNode are in module java.base of loader 'bootstrap')\r\n\tat java.base/java.util.HashMap$TreeNode.moveRootToFront(HashMap.java:1882)\r\n\tat java.base/java.util.HashMap$TreeNode.putTreeVal(HashMap.java:2061)\r\n\tat java.base/java.util.HashMap.putVal(HashMap.java:633)\r\n\tat java.base/java.util.HashMap.put(HashMap.java:607)\r\n\tat tech.pegasys.teku.storage.Store$Transaction.getVote(Store.java:324)\r\n\tat tech.pegasys.teku.protoarray.ProtoArrayForkChoiceStrategy.processAttestation(ProtoArrayForkChoiceStrategy.java:151)\r\n\tat tech.pegasys.teku.protoarray.ProtoArrayForkChoiceStrategy.lambda$onAttestation$0(ProtoArrayForkChoiceStrategy.java:92)\r\n\tat java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.accept(ForEachOps.java:183)\r\n\tat java.base/java.util.ArrayList$ArrayListSpliterator.forEachRemaining(ArrayList.java:1654)\r\n\tat java.base/java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:484)\r\n\tat java.base/java.util.stream.ForEachOps$ForEachTask.compute(ForEachOps.java:290)\r\n\tat java.base/java.util.concurrent.CountedCompleter.exec(CountedCompleter.java:746)\r\n\tat java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:290)\r\n\tat java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1020)\r\n\tat java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1656)\r\n\tat java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1594)\r\n\tat java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:177)\r\n```\r\n### Steps to Reproduce (Bug)\r\n\r\nIt's relatively rare situation, when the problem manifests itself, so one should many several times to discover it, in general.\r\nI wrote a simple test reproducing the bug more or less reliably.\r\n\r\n```\r\npackage tech.pegasys.teku.protoarray;\r\n\r\nimport com.google.common.primitives.UnsignedLong;\r\nimport org.apache.tuweni.bytes.Bytes32;\r\nimport org.junit.jupiter.api.Test;\r\nimport tech.pegasys.teku.bls.BLSSignature;\r\nimport tech.pegasys.teku.datastructures.operations.AttestationData;\r\nimport tech.pegasys.teku.datastructures.operations.IndexedAttestation;\r\nimport tech.pegasys.teku.datastructures.state.Checkpoint;\r\nimport tech.pegasys.teku.ssz.SSZTypes.SSZList;\r\nimport tech.pegasys.teku.storage.Store;\r\nimport tech.pegasys.teku.storage.api.StubStorageUpdateChannel;\r\n\r\nimport java.util.stream.Collectors;\r\nimport java.util.stream.IntStream;\r\n\r\npublic class ParallelTest {\r\n    @Test\r\n    public void test() {\r\n        int length = 1000;\r\n        for (int i = 0; i < 1000000; i++) {\r\n            Store store = ProtoArrayTestUtil.createStoreToManipulateVotes();\r\n            ProtoArrayForkChoiceStrategy forkChoice = ProtoArrayForkChoiceStrategy.create(store);\r\n            Store.Transaction transaction = store.startTransaction(new StubStorageUpdateChannel());\r\n            Checkpoint chkp = new Checkpoint(UnsignedLong.ZERO, Bytes32.ZERO);\r\n            var data = new AttestationData(UnsignedLong.ONE, UnsignedLong.ZERO, Bytes32.ZERO, chkp, chkp);\r\n            var indices = SSZList.createMutable(\r\n                    IntStream.range(0, length).mapToObj(UnsignedLong::valueOf).collect(Collectors.toList()), length, UnsignedLong.class);\r\n\r\n            IndexedAttestation attestation = new IndexedAttestation(indices, data, BLSSignature.empty());\r\n\r\n            forkChoice.onAttestation(transaction, attestation);\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n### Full Stack Trace\r\n```\r\njava.lang.ClassCastException\r\n\tat java.base/jdk.internal.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)\r\n\tat java.base/jdk.internal.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:62)\r\n\tat java.base/jdk.internal.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)\r\n\tat java.base/java.lang.reflect.Constructor.newInstance(Constructor.java:490)\r\n\tat java.base/java.util.concurrent.ForkJoinTask.getThrowableException(ForkJoinTask.java:603)\r\n\tat java.base/java.util.concurrent.ForkJoinTask.reportException(ForkJoinTask.java:678)\r\n\tat java.base/java.util.concurrent.ForkJoinTask.invoke(ForkJoinTask.java:737)\r\n\tat java.base/java.util.stream.ForEachOps$ForEachOp.evaluateParallel(ForEachOps.java:159)\r\n\tat java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.evaluateParallel(ForEachOps.java:173)\r\n\tat java.base/java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:233)\r\n\tat java.base/java.util.stream.ReferencePipeline.forEach(ReferencePipeline.java:497)\r\n\tat java.base/java.util.stream.ReferencePipeline$Head.forEach(ReferencePipeline.java:661)\r\n\tat tech.pegasys.teku.protoarray.ProtoArrayForkChoiceStrategy.onAttestation(ProtoArrayForkChoiceStrategy.java:90)\r\n\tat tech.pegasys.teku.protoarray.ParallelTest.test(ParallelTest.java:32)\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\r\n\tat java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n\tat java.base/java.lang.reflect.Method.invoke(Method.java:566)\r\n\tat org.junit.platform.commons.util.ReflectionUtils.invokeMethod(ReflectionUtils.java:675)\r\n\tat org.junit.jupiter.engine.execution.MethodInvocation.proceed(MethodInvocation.java:60)\r\n\tat org.junit.jupiter.engine.execution.InvocationInterceptorChain$ValidatingInvocation.proceed(InvocationInterceptorChain.java:125)\r\n\tat org.junit.jupiter.engine.extension.TimeoutExtension.intercept(TimeoutExtension.java:132)\r\n\tat org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestableMethod(TimeoutExtension.java:124)\r\n\tat org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestMethod(TimeoutExtension.java:74)\r\n\tat org.junit.jupiter.engine.execution.ExecutableInvoker$ReflectiveInterceptorCall.lambda$ofVoidMethod$0(ExecutableInvoker.java:115)\r\n\tat org.junit.jupiter.engine.execution.ExecutableInvoker.lambda$invoke$0(ExecutableInvoker.java:105)\r\n\tat org.junit.jupiter.engine.execution.InvocationInterceptorChain$InterceptedInvocation.proceed(InvocationInterceptorChain.java:104)\r\n\tat org.junit.jupiter.engine.execution.InvocationInterceptorChain.proceed(InvocationInterceptorChain.java:62)\r\n\tat org.junit.jupiter.engine.execution.InvocationInterceptorChain.chainAndInvoke(InvocationInterceptorChain.java:43)\r\n\tat org.junit.jupiter.engine.execution.InvocationInterceptorChain.invoke(InvocationInterceptorChain.java:35)\r\n\tat org.junit.jupiter.engine.execution.ExecutableInvoker.invoke(ExecutableInvoker.java:104)\r\n\tat org.junit.jupiter.engine.execution.ExecutableInvoker.invoke(ExecutableInvoker.java:98)\r\n\tat org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.lambda$invokeTestMethod$6(TestMethodTestDescriptor.java:202)\r\n\tat org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)\r\n\tat org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.invokeTestMethod(TestMethodTestDescriptor.java:198)\r\n\tat org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:135)\r\n\tat org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:69)\r\n\tat org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$5(NodeTestTask.java:135)\r\n\tat org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)\r\n\tat org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$7(NodeTestTask.java:125)\r\n\tat org.junit.platform.engine.support.hierarchical.Node.around(Node.java:135)\r\n\tat org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:123)\r\n\tat org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)\r\n\tat org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:122)\r\n\tat org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:80)\r\n\tat java.base/java.util.ArrayList.forEach(ArrayList.java:1540)\r\n\tat org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:38)\r\n\tat org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$5(NodeTestTask.java:139)\r\n\tat org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)\r\n\tat org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$7(NodeTestTask.java:125)\r\n\tat org.junit.platform.engine.support.hierarchical.Node.around(Node.java:135)\r\n\tat org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:123)\r\n\tat org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)\r\n\tat org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:122)\r\n\tat org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:80)\r\n\tat java.base/java.util.ArrayList.forEach(ArrayList.java:1540)\r\n\tat org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:38)\r\n\tat org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$5(NodeTestTask.java:139)\r\n\tat org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)\r\n\tat org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$7(NodeTestTask.java:125)\r\n\tat org.junit.platform.engine.support.hierarchical.Node.around(Node.java:135)\r\n\tat org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:123)\r\n\tat org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)\r\n\tat org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:122)\r\n\tat org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:80)\r\n\tat org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.submit(SameThreadHierarchicalTestExecutorService.java:32)\r\n\tat org.junit.platform.engine.support.hierarchical.HierarchicalTestExecutor.execute(HierarchicalTestExecutor.java:57)\r\n\tat org.junit.platform.engine.support.hierarchical.HierarchicalTestEngine.execute(HierarchicalTestEngine.java:51)\r\n\tat org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:229)\r\n\tat org.junit.platform.launcher.core.DefaultLauncher.lambda$execute$6(DefaultLauncher.java:197)\r\n\tat org.junit.platform.launcher.core.DefaultLauncher.withInterceptedStreams(DefaultLauncher.java:211)\r\n\tat org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:191)\r\n\tat org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:128)\r\n\tat com.intellij.junit5.JUnit5IdeaTestRunner.startRunnerWithArgs(JUnit5IdeaTestRunner.java:69)\r\n\tat com.intellij.rt.junit.IdeaTestRunner$Repeater.startRunnerWithArgs(IdeaTestRunner.java:33)\r\n\tat com.intellij.rt.junit.JUnitStarter.prepareStreamsAndStart(JUnitStarter.java:230)\r\n\tat com.intellij.rt.junit.JUnitStarter.main(JUnitStarter.java:58)\r\nCaused by: java.lang.ClassCastException: class java.util.HashMap$Node cannot be cast to class java.util.HashMap$TreeNode (java.util.HashMap$Node and java.util.HashMap$TreeNode are in module java.base of loader 'bootstrap')\r\n\tat java.base/java.util.HashMap$TreeNode.moveRootToFront(HashMap.java:1882)\r\n\tat java.base/java.util.HashMap$TreeNode.putTreeVal(HashMap.java:2061)\r\n\tat java.base/java.util.HashMap.putVal(HashMap.java:633)\r\n\tat java.base/java.util.HashMap.put(HashMap.java:607)\r\n\tat tech.pegasys.teku.storage.Store$Transaction.getVote(Store.java:324)\r\n\tat tech.pegasys.teku.protoarray.ProtoArrayForkChoiceStrategy.processAttestation(ProtoArrayForkChoiceStrategy.java:151)\r\n\tat tech.pegasys.teku.protoarray.ProtoArrayForkChoiceStrategy.lambda$onAttestation$0(ProtoArrayForkChoiceStrategy.java:92)\r\n\tat java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.accept(ForEachOps.java:183)\r\n\tat java.base/java.util.ArrayList$ArrayListSpliterator.forEachRemaining(ArrayList.java:1654)\r\n\tat java.base/java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:484)\r\n\tat java.base/java.util.stream.ForEachOps$ForEachTask.compute(ForEachOps.java:290)\r\n\tat java.base/java.util.concurrent.CountedCompleter.exec(CountedCompleter.java:746)\r\n\tat java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:290)\r\n\tat java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1020)\r\n\tat java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1656)\r\n\tat java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1594)\r\n\tat java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:177)\r\n```\r\n",
  "closed_by": {
    "login": "cemozerr",
    "id": 16581242,
    "node_id": "MDQ6VXNlcjE2NTgxMjQy",
    "avatar_url": "https://avatars.githubusercontent.com/u/16581242?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/cemozerr",
    "html_url": "https://github.com/cemozerr",
    "followers_url": "https://api.github.com/users/cemozerr/followers",
    "following_url": "https://api.github.com/users/cemozerr/following{/other_user}",
    "gists_url": "https://api.github.com/users/cemozerr/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/cemozerr/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/cemozerr/subscriptions",
    "organizations_url": "https://api.github.com/users/cemozerr/orgs",
    "repos_url": "https://api.github.com/users/cemozerr/repos",
    "events_url": "https://api.github.com/users/cemozerr/events{/privacy}",
    "received_events_url": "https://api.github.com/users/cemozerr/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/1743/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ConsenSys/teku/issues/1743/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[

]
