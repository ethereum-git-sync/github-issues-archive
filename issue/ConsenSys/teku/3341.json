{
  "url": "https://api.github.com/repos/ConsenSys/teku/issues/3341",
  "repository_url": "https://api.github.com/repos/ConsenSys/teku",
  "labels_url": "https://api.github.com/repos/ConsenSys/teku/issues/3341/labels{/name}",
  "comments_url": "https://api.github.com/repos/ConsenSys/teku/issues/3341/comments",
  "events_url": "https://api.github.com/repos/ConsenSys/teku/issues/3341/events",
  "html_url": "https://github.com/ConsenSys/teku/issues/3341",
  "id": 754584809,
  "node_id": "MDU6SXNzdWU3NTQ1ODQ4MDk=",
  "number": 3341,
  "title": "Teku slow to shutdown",
  "user": {
    "login": "benjaminion",
    "id": 20796281,
    "node_id": "MDQ6VXNlcjIwNzk2Mjgx",
    "avatar_url": "https://avatars.githubusercontent.com/u/20796281?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/benjaminion",
    "html_url": "https://github.com/benjaminion",
    "followers_url": "https://api.github.com/users/benjaminion/followers",
    "following_url": "https://api.github.com/users/benjaminion/following{/other_user}",
    "gists_url": "https://api.github.com/users/benjaminion/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/benjaminion/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/benjaminion/subscriptions",
    "organizations_url": "https://api.github.com/users/benjaminion/orgs",
    "repos_url": "https://api.github.com/users/benjaminion/repos",
    "events_url": "https://api.github.com/users/benjaminion/events{/privacy}",
    "received_events_url": "https://api.github.com/users/benjaminion/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1048919129,
      "node_id": "MDU6TGFiZWwxMDQ4OTE5MTI5",
      "url": "https://api.github.com/repos/ConsenSys/teku/labels/bug%20%F0%9F%90%9E",
      "name": "bug üêû",
      "color": "dd6c94",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 2172544944,
      "node_id": "MDU6TGFiZWwyMTcyNTQ0OTQ0",
      "url": "https://api.github.com/repos/ConsenSys/teku/labels/P4",
      "name": "P4",
      "color": "008000",
      "default": false,
      "description": "Low"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "rolfyone",
    "id": 2967240,
    "node_id": "MDQ6VXNlcjI5NjcyNDA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2967240?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/rolfyone",
    "html_url": "https://github.com/rolfyone",
    "followers_url": "https://api.github.com/users/rolfyone/followers",
    "following_url": "https://api.github.com/users/rolfyone/following{/other_user}",
    "gists_url": "https://api.github.com/users/rolfyone/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/rolfyone/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rolfyone/subscriptions",
    "organizations_url": "https://api.github.com/users/rolfyone/orgs",
    "repos_url": "https://api.github.com/users/rolfyone/repos",
    "events_url": "https://api.github.com/users/rolfyone/events{/privacy}",
    "received_events_url": "https://api.github.com/users/rolfyone/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "rolfyone",
      "id": 2967240,
      "node_id": "MDQ6VXNlcjI5NjcyNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2967240?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rolfyone",
      "html_url": "https://github.com/rolfyone",
      "followers_url": "https://api.github.com/users/rolfyone/followers",
      "following_url": "https://api.github.com/users/rolfyone/following{/other_user}",
      "gists_url": "https://api.github.com/users/rolfyone/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rolfyone/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rolfyone/subscriptions",
      "organizations_url": "https://api.github.com/users/rolfyone/orgs",
      "repos_url": "https://api.github.com/users/rolfyone/repos",
      "events_url": "https://api.github.com/users/rolfyone/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rolfyone/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2020-12-01T17:25:50Z",
  "updated_at": "2020-12-03T01:23:55Z",
  "closed_at": "2020-12-03T01:23:55Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "A couple of reports of Teku being very slow to shutdown on `^C`.\r\n\r\nHere's one. There's reportedly a long pause (~ a minute) before `Thread pool did not terminate`. This is running in our Docker image.\r\n```\r\n16:51:48.438 INFO  - Sync Event  *** Current slot: 1457, Head slot: 38, Connected peers: 0\r\n^CTeku is shutting down\r\n16:51:51.272 FATAL - Exiting due to fatal error in Eth1DepositManager\r\njava.util.concurrent.CompletionException: tech.pegasys.teku.service.serviceutils.FatalServiceFailureException: java.util.concurrent.CompletionException: java.util.concurrent.RejectedExecutionException: Task java.util.concurrent.CompletableFuture$AsyncRun@7f6f4822 rejected from java.util.concurrent.ThreadPoolExecutor@295b4f83[Shutting down, pool size = 1, active threads = 1, queued tasks = 0, completed tasks = 118]\r\n        at java.util.concurrent.CompletableFuture.encodeThrowable(CompletableFuture.java:314) ~[?:?]\r\n        at java.util.concurrent.CompletableFuture.completeThrowable(CompletableFuture.java:319) ~[?:?]\r\n        at java.util.concurrent.CompletableFuture.uniExceptionally(CompletableFuture.java:990) ~[?:?]\r\n        at java.util.concurrent.CompletableFuture$UniExceptionally.tryFire(CompletableFuture.java:970) ~[?:?]\r\n        at java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:506) ~[?:?]\r\n        at java.util.concurrent.CompletableFuture.complete(CompletableFuture.java:2137) ~[?:?]\r\n        at tech.pegasys.teku.infrastructure.async.SafeFuture.lambda$propagateResult$3(SafeFuture.java:152) ~[teku-infrastructure-async-20.11.1.jar:20.11.1]\r\n        at java.util.concurrent.CompletableFuture.uniWhenComplete(CompletableFuture.java:859) ~[?:?]\r\n        at java.util.concurrent.CompletableFuture.uniWhenCompleteStage(CompletableFuture.java:883) ~[?:?]\r\n        at java.util.concurrent.CompletableFuture.whenComplete(CompletableFuture.java:2315) ~[?:?]\r\n        at tech.pegasys.teku.infrastructure.async.SafeFuture.whenComplete(SafeFuture.java:503) ~[teku-infrastructure-async-20.11.1.jar:20.11.1]\r\n        at tech.pegasys.teku.infrastructure.async.SafeFuture.whenComplete(SafeFuture.java:28) ~[teku-infrastructure-async-20.11.1.jar:20.11.1]\r\n        at tech.pegasys.teku.infrastructure.async.SafeFuture.propagateResult(SafeFuture.java:147) ~[teku-infrastructure-async-20.11.1.jar:20.11.1]\r\n        at tech.pegasys.teku.infrastructure.async.SafeFuture.lambda$exceptionallyCompose$25(SafeFuture.java:347) ~[teku-infrastructure-async-20.11.1.jar:20.11.1]\r\n        at java.util.concurrent.CompletableFuture.uniWhenComplete(CompletableFuture.java:859) ~[?:?]\r\n        at java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:837) ~[?:?]\r\n        at java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:506) ~[?:?]\r\n        at java.util.concurrent.CompletableFuture.complete(CompletableFuture.java:2137) ~[?:?]\r\n        at tech.pegasys.teku.infrastructure.async.SafeFuture.lambda$propagateResult$3(SafeFuture.java:152) ~[teku-infrastructure-async-20.11.1.jar:20.11.1]\r\n        at java.util.concurrent.CompletableFuture.uniWhenComplete(CompletableFuture.java:859) ~[?:?]\r\n        at java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:837) ~[?:?]\r\n        at java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:506) ~[?:?]\r\n        at java.util.concurrent.CompletableFuture.complete(CompletableFuture.java:2137) ~[?:?]\r\n        at org.web3j.utils.Async.lambda$run$1(Async.java:38) ~[core-4.6.2.jar:?]\r\n        at java.util.concurrent.CompletableFuture$AsyncRun.run(CompletableFuture.java:1800) [?:?]\r\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1130) [?:?]\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:630) [?:?]\r\n        at java.lang.Thread.run(Thread.java:832) [?:?]\r\nCaused by: tech.pegasys.teku.service.serviceutils.FatalServiceFailureException: java.util.concurrent.CompletionException: java.util.concurrent.RejectedExecutionException: Task java.util.concurrent.CompletableFuture$AsyncRun@7f6f4822 rejected from java.util.concurrent.ThreadPoolExecutor@295b4f83[Shutting down, pool size = 1, active threads = 1, queued tasks = 0, completed tasks = 118]\r\n        at tech.pegasys.teku.pow.Eth1DepositManager.lambda$start$3(Eth1DepositManager.java:74) ~[teku-pow-20.11.1.jar:20.11.1]\r\n        at java.util.concurrent.CompletableFuture.uniExceptionally(CompletableFuture.java:986) ~[?:?]\r\n        ... 25 more\r\nCaused by: java.util.concurrent.CompletionException: java.util.concurrent.RejectedExecutionException: Task java.util.concurrent.CompletableFuture$AsyncRun@7f6f4822 rejected from java.util.concurrent.ThreadPoolExecutor@295b4f83[Shutting down, pool size = 1, active threads = 1, queued tasks = 0, completed tasks = 118]\r\n        at java.util.concurrent.CompletableFuture.encodeThrowable(CompletableFuture.java:314) ~[?:?]\r\n        at java.util.concurrent.CompletableFuture.completeThrowable(CompletableFuture.java:319) ~[?:?]\r\n        at java.util.concurrent.CompletableFuture$UniCompose.tryFire(CompletableFuture.java:1155) ~[?:?]\r\n        ... 24 more\r\nCaused by: java.util.concurrent.RejectedExecutionException: Task java.util.concurrent.CompletableFuture$AsyncRun@7f6f4822 rejected from java.util.concurrent.ThreadPoolExecutor@295b4f83[Shutting down, pool size = 1, active threads = 1, queued tasks = 0, completed tasks = 118]\r\n        at java.util.concurrent.ThreadPoolExecutor$AbortPolicy.rejectedExecution(ThreadPoolExecutor.java:2057) ~[?:?]\r\n        at java.util.concurrent.ThreadPoolExecutor.reject(ThreadPoolExecutor.java:827) ~[?:?]\r\n        at java.util.concurrent.ThreadPoolExecutor.execute(ThreadPoolExecutor.java:1357) ~[?:?]\r\n        at java.util.concurrent.CompletableFuture.asyncRunStage(CompletableFuture.java:1814) ~[?:?]\r\n        at java.util.concurrent.CompletableFuture.runAsync(CompletableFuture.java:2023) ~[?:?]\r\n        at org.web3j.utils.Async.run(Async.java:33) ~[core-4.6.2.jar:?]\r\n        at org.web3j.protocol.Service.sendAsync(Service.java:60) ~[core-4.6.2.jar:?]\r\n        at org.web3j.protocol.core.Request.sendAsync(Request.java:91) ~[core-4.6.2.jar:?]\r\n        at tech.pegasys.teku.pow.contract.DepositContract.depositEventInRange(DepositContract.java:139) ~[teku-pow-20.11.1.jar:20.11.1]\r\n        at tech.pegasys.teku.pow.DepositFetcher.processDepositsInBatch(DepositFetcher.java:128) ~[teku-pow-20.11.1.jar:20.11.1]\r\n        at tech.pegasys.teku.pow.DepositFetcher.sendNextBatchRequest(DepositFetcher.java:92) ~[teku-pow-20.11.1.jar:20.11.1]\r\n        at tech.pegasys.teku.pow.DepositFetcher.lambda$sendNextBatchRequest$2(DepositFetcher.java:120) ~[teku-pow-20.11.1.jar:20.11.1]\r\n        at java.util.concurrent.CompletableFuture$UniCompose.tryFire(CompletableFuture.java:1146) ~[?:?]\r\n        ... 24 more\r\n16:51:51.323 WARN  - Error shutting down connection manager\r\n16:51:51.326 INFO  - Stopping discovery server\r\n16:51:51.327 INFO  - Shutting down discovery server\r\n16:51:53.334 INFO  - Scheduler DefaultQuartzScheduler_$_NON_CLUSTERED shutting down.\r\n16:51:53.334 INFO  - Scheduler DefaultQuartzScheduler_$_NON_CLUSTERED paused.\r\n16:51:53.335 INFO  - Scheduler DefaultQuartzScheduler_$_NON_CLUSTERED shutdown complete.\r\nThread pool did not terminate\r\n```",
  "closed_by": {
    "login": "rolfyone",
    "id": 2967240,
    "node_id": "MDQ6VXNlcjI5NjcyNDA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2967240?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/rolfyone",
    "html_url": "https://github.com/rolfyone",
    "followers_url": "https://api.github.com/users/rolfyone/followers",
    "following_url": "https://api.github.com/users/rolfyone/following{/other_user}",
    "gists_url": "https://api.github.com/users/rolfyone/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/rolfyone/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rolfyone/subscriptions",
    "organizations_url": "https://api.github.com/users/rolfyone/orgs",
    "repos_url": "https://api.github.com/users/rolfyone/repos",
    "events_url": "https://api.github.com/users/rolfyone/events{/privacy}",
    "received_events_url": "https://api.github.com/users/rolfyone/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/3341/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ConsenSys/teku/issues/3341/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/736891434",
    "html_url": "https://github.com/ConsenSys/teku/issues/3341#issuecomment-736891434",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/3341",
    "id": 736891434,
    "node_id": "MDEyOklzc3VlQ29tbWVudDczNjg5MTQzNA==",
    "user": {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-12-01T23:41:55Z",
    "updated_at": "2020-12-01T23:41:55Z",
    "author_association": "CONTRIBUTOR",
    "body": "Teku is waiting on a read from the eth1 node which is preventing shutdown:\r\n\r\n```\r\n\"pool-18-thread-1\" #88 prio=5 os_prio=31 cpu=136.08ms elapsed=280.66s tid=0x00007f9912b2f000 nid=0x15d03 runnable  [0x0000700013863000]\r\n   java.lang.Thread.State: RUNNABLE\r\n\tat sun.nio.ch.Net.poll(java.base@14.0.2/Native Method)\r\n\tat sun.nio.ch.NioSocketImpl.park(java.base@14.0.2/NioSocketImpl.java:181)\r\n\tat sun.nio.ch.NioSocketImpl.timedRead(java.base@14.0.2/NioSocketImpl.java:285)\r\n\tat sun.nio.ch.NioSocketImpl.implRead(java.base@14.0.2/NioSocketImpl.java:309)\r\n\tat sun.nio.ch.NioSocketImpl.read(java.base@14.0.2/NioSocketImpl.java:350)\r\n\tat sun.nio.ch.NioSocketImpl$1.read(java.base@14.0.2/NioSocketImpl.java:803)\r\n\tat java.net.Socket$SocketInputStream.read(java.base@14.0.2/Socket.java:982)\r\n\tat okio.InputStreamSource.read(JvmOkio.kt:90)\r\n\tat okio.AsyncTimeout$source$1.read(AsyncTimeout.kt:129)\r\n\tat okio.RealBufferedSource.indexOf(RealBufferedSource.kt:449)\r\n\tat okio.RealBufferedSource.readUtf8LineStrict(RealBufferedSource.kt:333)\r\n\tat okhttp3.internal.http1.HeadersReader.readLine(HeadersReader.kt:29)\r\n\tat okhttp3.internal.http1.Http1ExchangeCodec.readResponseHeaders(Http1ExchangeCodec.kt:178)\r\n\tat okhttp3.internal.connection.Exchange.readResponseHeaders(Exchange.kt:106)\r\n\tat okhttp3.internal.http.CallServerInterceptor.intercept(CallServerInterceptor.kt:79)\r\n\tat okhttp3.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.kt:109)\r\n\tat okhttp3.internal.connection.ConnectInterceptor.intercept(ConnectInterceptor.kt:34)\r\n\tat okhttp3.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.kt:109)\r\n\tat okhttp3.internal.cache.CacheInterceptor.intercept(CacheInterceptor.kt:95)\r\n\tat okhttp3.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.kt:109)\r\n\tat okhttp3.internal.http.BridgeInterceptor.intercept(BridgeInterceptor.kt:83)\r\n\tat okhttp3.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.kt:109)\r\n\tat okhttp3.internal.http.RetryAndFollowUpInterceptor.intercept(RetryAndFollowUpInterceptor.kt:76)\r\n\tat okhttp3.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.kt:109)\r\n\tat okhttp3.internal.connection.RealCall.getResponseWithInterceptorChain$okhttp(RealCall.kt:201)\r\n\tat okhttp3.internal.connection.RealCall.execute(RealCall.kt:154)\r\n\tat org.web3j.protocol.http.HttpService.performIO(HttpService.java:160)\r\n\tat org.web3j.protocol.Service.send(Service.java:48)\r\n\tat org.web3j.protocol.Service.lambda$sendAsync$0(Service.java:60)\r\n\tat org.web3j.protocol.Service$$Lambda$617/0x00000008010a1840.call(Unknown Source)\r\n\tat org.web3j.utils.Async.lambda$run$1(Async.java:38)\r\n\tat org.web3j.utils.Async$$Lambda$618/0x00000008010a1c40.run(Unknown Source)\r\n\tat java.util.concurrent.CompletableFuture$AsyncRun.run(java.base@14.0.2/CompletableFuture.java:1800)\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(java.base@14.0.2/ThreadPoolExecutor.java:1130)\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(java.base@14.0.2/ThreadPoolExecutor.java:630)\r\n\tat java.lang.Thread.run(java.base@14.0.2/Thread.java:832)\r\n\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/736891434/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/737597916",
    "html_url": "https://github.com/ConsenSys/teku/issues/3341#issuecomment-737597916",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/3341",
    "id": 737597916,
    "node_id": "MDEyOklzc3VlQ29tbWVudDczNzU5NzkxNg==",
    "user": {
      "login": "rolfyone",
      "id": 2967240,
      "node_id": "MDQ6VXNlcjI5NjcyNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2967240?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rolfyone",
      "html_url": "https://github.com/rolfyone",
      "followers_url": "https://api.github.com/users/rolfyone/followers",
      "following_url": "https://api.github.com/users/rolfyone/following{/other_user}",
      "gists_url": "https://api.github.com/users/rolfyone/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rolfyone/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rolfyone/subscriptions",
      "organizations_url": "https://api.github.com/users/rolfyone/orgs",
      "repos_url": "https://api.github.com/users/rolfyone/repos",
      "events_url": "https://api.github.com/users/rolfyone/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rolfyone/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-12-03T01:23:55Z",
    "updated_at": "2020-12-03T01:23:55Z",
    "author_association": "CONTRIBUTOR",
    "body": "Geth is taking a while for the socket to time out and close, and despite efforts being made it's not easy to close from our side. We might just have to live with this for now, as there doesn't seem to be a good work-around.\n\nI guess, closing as \"won't fix\" unless more information comes to light to suggest it's more than just a slow shutdown.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/737597916/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
