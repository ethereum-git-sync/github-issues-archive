{
  "url": "https://api.github.com/repos/ConsenSys/teku/issues/3626",
  "repository_url": "https://api.github.com/repos/ConsenSys/teku",
  "labels_url": "https://api.github.com/repos/ConsenSys/teku/issues/3626/labels{/name}",
  "comments_url": "https://api.github.com/repos/ConsenSys/teku/issues/3626/comments",
  "events_url": "https://api.github.com/repos/ConsenSys/teku/issues/3626/events",
  "html_url": "https://github.com/ConsenSys/teku/issues/3626",
  "id": 811258795,
  "node_id": "MDU6SXNzdWU4MTEyNTg3OTU=",
  "number": 3626,
  "title": "Investigate Fatal SIGILL Error",
  "user": {
    "login": "mbaxter",
    "id": 658601,
    "node_id": "MDQ6VXNlcjY1ODYwMQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/658601?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mbaxter",
    "html_url": "https://github.com/mbaxter",
    "followers_url": "https://api.github.com/users/mbaxter/followers",
    "following_url": "https://api.github.com/users/mbaxter/following{/other_user}",
    "gists_url": "https://api.github.com/users/mbaxter/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mbaxter/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mbaxter/subscriptions",
    "organizations_url": "https://api.github.com/users/mbaxter/orgs",
    "repos_url": "https://api.github.com/users/mbaxter/repos",
    "events_url": "https://api.github.com/users/mbaxter/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mbaxter/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "ajsutton",
    "id": 72675,
    "node_id": "MDQ6VXNlcjcyNjc1",
    "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ajsutton",
    "html_url": "https://github.com/ajsutton",
    "followers_url": "https://api.github.com/users/ajsutton/followers",
    "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
    "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
    "organizations_url": "https://api.github.com/users/ajsutton/orgs",
    "repos_url": "https://api.github.com/users/ajsutton/repos",
    "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ajsutton/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2021-02-18T16:28:19Z",
  "updated_at": "2021-03-29T03:28:42Z",
  "closed_at": "2021-03-29T03:28:42Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "### Description\r\nInvestigate the fatal SIGILL error encountered in our acceptance tests [here](https://app.circleci.com/pipelines/github/ConsenSys/teku/10697/workflows/e67bb580-8643-4266-8d19-99d94af8698b/jobs/67884): \r\n```\r\nRemoteValidatorAcceptanceTest > shouldCreateAttestationsWithRemoteValidator() FAILED\r\n    org.testcontainers.containers.ContainerLaunchException at RemoteValidatorAcceptanceTest.java:48\r\n        Caused by: org.rnorth.ducttape.RetryCountExceededException at RemoteValidatorAcceptanceTest.java:48\r\n            Caused by: org.testcontainers.containers.ContainerLaunchException at RemoteValidatorAcceptanceTest.java:48\r\n                Caused by: java.lang.IllegalStateException at RemoteValidatorAcceptanceTest.java:48\r\n\r\nRemoteValidatorAcceptanceTest > shouldCreateAttestationsWithRemoteValidatorStartingFirst() FAILED\r\n    java.lang.AssertionError at RemoteValidatorAcceptanceTest.java:59\r\n        Caused by: org.awaitility.core.ConditionTimeoutException at RemoteValidatorAcceptanceTest.java:59\r\n            Caused by: java.lang.AssertionError at Node.java:67\r\n#\r\n# A fatal error has been detected by the Java Runtime Environment:\r\n#\r\n#  SIGILL (0x4) at pc=0x00007f8a4ecec017, pid=8951, tid=8975\r\n#\r\n# JRE version: OpenJDK Runtime Environment (11.0.8+10) (build 11.0.8+10-post-Ubuntu-0ubuntu120.04)\r\n# Java VM: OpenJDK 64-Bit Server VM (11.0.8+10-post-Ubuntu-0ubuntu120.04, mixed mode, sharing, tiered, compressed oops, g1 gc, linux-amd64)\r\n# Problematic frame:\r\n# C  [libblst.so+0x20017]\r\n#\r\n# Core dump will be written. Default location: Core dumps may be processed with \"/usr/share/apport/apport %p %s %c %d %P %E\" (or dumping to /home/circleci/project/acceptance-tests/core.8951)\r\n#\r\n# An error report file with more information is saved as:\r\n# /home/circleci/project/acceptance-tests/hs_err_pid8951.log\r\n#\r\n# If you would like to submit a bug report, please visit:\r\n#   https://bugs.launchpad.net/ubuntu/+source/openjdk-lts\r\n# The crash happened outside the Java Virtual Machine in native code.\r\n# See problematic frame for where to report the bug.\r\n#\r\n```\r\n",
  "closed_by": {
    "login": "ajsutton",
    "id": 72675,
    "node_id": "MDQ6VXNlcjcyNjc1",
    "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ajsutton",
    "html_url": "https://github.com/ajsutton",
    "followers_url": "https://api.github.com/users/ajsutton/followers",
    "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
    "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
    "organizations_url": "https://api.github.com/users/ajsutton/orgs",
    "repos_url": "https://api.github.com/users/ajsutton/repos",
    "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ajsutton/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/3626/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ConsenSys/teku/issues/3626/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/808450996",
    "html_url": "https://github.com/ConsenSys/teku/issues/3626#issuecomment-808450996",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/3626",
    "id": 808450996,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwODQ1MDk5Ng==",
    "user": {
      "login": "benjaminion",
      "id": 20796281,
      "node_id": "MDQ6VXNlcjIwNzk2Mjgx",
      "avatar_url": "https://avatars.githubusercontent.com/u/20796281?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/benjaminion",
      "html_url": "https://github.com/benjaminion",
      "followers_url": "https://api.github.com/users/benjaminion/followers",
      "following_url": "https://api.github.com/users/benjaminion/following{/other_user}",
      "gists_url": "https://api.github.com/users/benjaminion/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/benjaminion/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/benjaminion/subscriptions",
      "organizations_url": "https://api.github.com/users/benjaminion/orgs",
      "repos_url": "https://api.github.com/users/benjaminion/repos",
      "events_url": "https://api.github.com/users/benjaminion/events{/privacy}",
      "received_events_url": "https://api.github.com/users/benjaminion/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-26T19:06:12Z",
    "updated_at": "2021-03-26T19:06:12Z",
    "author_association": "CONTRIBUTOR",
    "body": "After some investigation... it looks like Jblst is not correctly building the portable version in CI. Here's part of the most recent [Jblst build](https://app.circleci.com/pipelines/github/ConsenSys/jblst/179/workflows/0f12812a-c4c0-44df-b4c4-8689aa29029e/jobs/661).\r\n\r\nIt runs this code\r\n\r\n```\r\ncd blst\r\n./build.sh -D__BLST_PORTABLE__\r\n./bindings/java/run.me\r\n```\r\n\r\nand gives this output\r\n\r\n```\r\n+ cc -O -fPIC -Wall -Wextra -Werror -D__ADX__ -D__BLST_PORTABLE__ -mno-avx -c ./src/server.c\r\n+ cc -O -fPIC -Wall -Wextra -Werror -D__ADX__ -D__BLST_PORTABLE__ -mno-avx -c ./build/assembly.S\r\n+ ar rc libblst.a assembly.o server.o\r\n+ swig -c++ -java -package supranational.blst -outdir supranational/blst -o blst_wrap.cpp /home/circleci/jblst/blst/bindings/blst.swg\r\n+ /usr/local/openjdk-11/bin/javac supranational/blst/BLST_ERROR.java supranational/blst/P1.java supranational/blst/P1_Affine.java supranational/blst/P2.java supranational/blst/P2_Affine.java supranational/blst/PT.java supranational/blst/Pairing.java supranational/blst/SecretKey.java supranational/blst/blst.java supranational/blst/blstJNI.java\r\n+ cc -O -fPIC -Wall -Wextra -Werror -D__ADX__ -mno-avx -c /home/circleci/jblst/blst/bindings/../src/server.c\r\n+ cc -O -fPIC -Wall -Wextra -Werror -D__ADX__ -mno-avx -c /home/circleci/jblst/blst/bindings/../build/assembly.S\r\n+ ar rc libblst.a assembly.o server.o\r\n+ c++ -shared -o supranational/blst/Linux/amd64/libblst.so -fPIC -I/usr/local/openjdk-11/include -I/usr/local/openjdk-11/include/linux -I/home/circleci/jblst/blst/bindings -O -Wall -Wno-unused-function blst_wrap.cpp libblst.a -Wl,-Bsymbolic\r\n+ /usr/local/openjdk-11/bin/jar cf supranational.blst.jar supranational/blst/BLST_ERROR$SwigNext.class supranational/blst/BLST_ERROR.class supranational/blst/P1.class supranational/blst/P1_Affine.class supranational/blst/P2.class supranational/blst/P2_Affine.class supranational/blst/PT.class supranational/blst/Pairing.class supranational/blst/SecretKey.class supranational/blst/blst.class supranational/blst/blstJNI.class supranational/blst/Linux/amd64/libblst.so\r\n+ /usr/local/openjdk-11/bin/javac runnable.java\r\n+ /usr/local/openjdk-11/bin/java -classpath supranational.blst.jar:. runnable\r\nOK\r\n```\r\n\r\nNote that _libblst.a_ is built twice. The first time with the portable flag, the second time without. It is the second one that is processed into the shared library and included in the Jar file.\r\n\r\nThe second build seems to be due to _bindings/java/run.me_ running _build.sh_ in its own directory rather than re-using the one we just built. It does not get passed the `-D__BLST_PORTABLE__` flag.\r\n\r\nIt might be possible to fix this most easily by setting the environment variable `CFLAGS=-D__BLST_PORTABLE__`. This works in my environment:\r\n\r\n```\r\nCFLAGS=-D__BLST_PORTABLE__ ./bindings/java/run.me\r\n```\r\n\r\nAnd we probably don't need the first build at all in this case.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/808450996/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/808968347",
    "html_url": "https://github.com/ConsenSys/teku/issues/3626#issuecomment-808968347",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/3626",
    "id": 808968347,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgwODk2ODM0Nw==",
    "user": {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-03-28T22:17:26Z",
    "updated_at": "2021-03-28T22:17:26Z",
    "author_association": "CONTRIBUTOR",
    "body": "Modified the build script so that we do both the libblst and java bindings build from within the `bindings/java` directory so that the outputs wind up in the expected place and it doesn't rebuild.\r\n\r\nWe can't set the portable flag when building the java bindings so have to pre-build the native library first but the blst build scripts are quite brittle unfortunately.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/808968347/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
