{
  "url": "https://api.github.com/repos/ConsenSys/teku/issues/3328",
  "repository_url": "https://api.github.com/repos/ConsenSys/teku",
  "labels_url": "https://api.github.com/repos/ConsenSys/teku/issues/3328/labels{/name}",
  "comments_url": "https://api.github.com/repos/ConsenSys/teku/issues/3328/comments",
  "events_url": "https://api.github.com/repos/ConsenSys/teku/issues/3328/events",
  "html_url": "https://github.com/ConsenSys/teku/issues/3328",
  "id": 752876901,
  "node_id": "MDU6SXNzdWU3NTI4NzY5MDE=",
  "number": 3328,
  "title": "/eth/v1/attestation_data returning out-of-date information",
  "user": {
    "login": "mcdee",
    "id": 511384,
    "node_id": "MDQ6VXNlcjUxMTM4NA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/511384?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mcdee",
    "html_url": "https://github.com/mcdee",
    "followers_url": "https://api.github.com/users/mcdee/followers",
    "following_url": "https://api.github.com/users/mcdee/following{/other_user}",
    "gists_url": "https://api.github.com/users/mcdee/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mcdee/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mcdee/subscriptions",
    "organizations_url": "https://api.github.com/users/mcdee/orgs",
    "repos_url": "https://api.github.com/users/mcdee/repos",
    "events_url": "https://api.github.com/users/mcdee/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mcdee/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1048919129,
      "node_id": "MDU6TGFiZWwxMDQ4OTE5MTI5",
      "url": "https://api.github.com/repos/ConsenSys/teku/labels/bug%20%F0%9F%90%9E",
      "name": "bug üêû",
      "color": "dd6c94",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 2172542566,
      "node_id": "MDU6TGFiZWwyMTcyNTQyNTY2",
      "url": "https://api.github.com/repos/ConsenSys/teku/labels/P3",
      "name": "P3",
      "color": "FFFF00",
      "default": false,
      "description": "Medium"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2020-11-29T09:38:46Z",
  "updated_at": "2020-11-30T00:14:15Z",
  "closed_at": "2020-11-30T00:14:15Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "### Description\r\n\r\nUsing Teku 20.11.00.\r\n\r\nIt appears that Teku is occasionally returning poor information in the attestation data request.  Specifically, it appears to have an old source epoch.\r\n\r\nFor example, here are some Vouch logs that show it querying both Lighthouse and Teku for attestation data, along with their relevant responses:\r\n\r\n```\r\n{\"level\":\"trace\",\"service\":\"client\",\"impl\":\"standardv1\",\"id\":\"441dc588\",\"endpoint\":\"/eth/v1/validator/attestation_data?slot=77760&committee_index=13\",\"time\":\"2020-11-29T07:12:11Z\",\"message\":\"GET request\"}\r\n{\"level\":\"trace\",\"service\":\"client\",\"impl\":\"standardv1\",\"id\":\"2763a030\",\"endpoint\":\"/eth/v1/validator/attestation_data?slot=77760&committee_index=13\",\"time\":\"2020-11-29T07:12:11Z\",\"message\":\"GET request\"}\r\n{\"level\":\"trace\",\"service\":\"client\",\"impl\":\"standardv1\",\"id\":\"441dc588\",\"response\":\"{\\\"data\\\":{\\\"slot\\\":\\\"77760\\\",\\\"index\\\":\\\"13\\\",\\\"beacon_block_root\\\":\\\"0x5b9f5e58dd2a54e6c0cc29d494aa93da2389fd3d2c1b9e07dc03d44a965cbe46\\\",\\\"source\\\":{\\\"epoch\\\":\\\"2429\\\",\\\"root\\\":\\\"0x1316fb5307d394903183c3ff2eb5b28e792ce2607f5a4311daf122a383957d59\\\"},\\\"target\\\":{\\\"epoch\\\":\\\"2430\\\",\\\"root\\\":\\\"0x5b9f5e58dd2a54e6c0cc29d494aa93da2389fd3d2c1b9e07dc03d44a965cbe46\\\"}}}\",\"time\":\"2020-11-29T07:12:11Z\",\"message\":\"GET response\"}\r\n{\"level\":\"trace\",\"service\":\"client\",\"impl\":\"standardv1\",\"id\":\"2763a030\",\"response\":\"{\\\"data\\\":{\\\"slot\\\":\\\"77760\\\",\\\"index\\\":\\\"13\\\",\\\"beacon_block_root\\\":\\\"0xdfa159a0608151629ce1d3c87ab9545af07703b395057b61ffcde82e4ad96b72\\\",\\\"source\\\":{\\\"epoch\\\":\\\"2428\\\",\\\"root\\\":\\\"0xae00733248d9ef0e1ec0e26b6bb948220edb6c622ff3313923bdda79b84af06e\\\"},\\\"target\\\":{\\\"epoch\\\":\\\"2430\\\",\\\"root\\\":\\\"0xdfa159a0608151629ce1d3c87ab9545af07703b395057b61ffcde82e4ad96b72\\\"}}}\",\"time\":\"2020-11-29T07:12:11Z\",\"message\":\"GET response\"}\r\n\r\n```\r\n\r\nIt can be seen that the data provided by Teku has an older source epoch (2428 for Teku, 2429 for Lighthouse).  Proceeding with this data results in the attestation being dropped by the network.\r\n\r\nChecking the timing for this slot, at the time the request was made (2020-11-29T07:12:11, as per the logs) the beacon chain was 4 seconds in to its slot (and epoch; this is on an epoch transition), so I would have expected Teku to be ready to serve the correct data.\r\n\r\nThe server on which the beacon nodes run is quite highly specced (Ryzen 9 3900, 128GB RAM, NVMe SSDs).  The log does show the block for 77760 coming in after the above calls were made:\r\n\r\n```\r\n07:12:07.400 INFO  - Epoch Event *** Epoch: 2430, Justified checkpoint: 2428, Finalized checkpoint: 2427, Finalized root: 800438..1d90\r\n07:12:14.457 INFO  - Slot Event  *** Slot: 77760, Block: 5b9f5e..be46, Epoch: 2430, Finalized checkpoint: 2428, Finalized root: ae0073..f06e, Peers: 73\r\n```\r\n\r\n",
  "closed_by": {
    "login": "ajsutton",
    "id": 72675,
    "node_id": "MDQ6VXNlcjcyNjc1",
    "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ajsutton",
    "html_url": "https://github.com/ajsutton",
    "followers_url": "https://api.github.com/users/ajsutton/followers",
    "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
    "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
    "organizations_url": "https://api.github.com/users/ajsutton/orgs",
    "repos_url": "https://api.github.com/users/ajsutton/repos",
    "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ajsutton/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/3328/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ConsenSys/teku/issues/3328/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/735467770",
    "html_url": "https://github.com/ConsenSys/teku/issues/3328#issuecomment-735467770",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/3328",
    "id": 735467770,
    "node_id": "MDEyOklzc3VlQ29tbWVudDczNTQ2Nzc3MA==",
    "user": {
      "login": "rolfyone",
      "id": 2967240,
      "node_id": "MDQ6VXNlcjI5NjcyNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2967240?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rolfyone",
      "html_url": "https://github.com/rolfyone",
      "followers_url": "https://api.github.com/users/rolfyone/followers",
      "following_url": "https://api.github.com/users/rolfyone/following{/other_user}",
      "gists_url": "https://api.github.com/users/rolfyone/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rolfyone/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rolfyone/subscriptions",
      "organizations_url": "https://api.github.com/users/rolfyone/orgs",
      "repos_url": "https://api.github.com/users/rolfyone/repos",
      "events_url": "https://api.github.com/users/rolfyone/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rolfyone/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-11-29T22:27:00Z",
    "updated_at": "2020-11-29T22:27:00Z",
    "author_association": "CONTRIBUTOR",
    "body": "Possibly related to #3262 - it may be because of epoch boundary processing.\n\nIt looks like the API is just passing through to the server, nothing 'unusual' is needed to process the request.\n\nThanks for raising this, we'll look into it.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/735467770/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
