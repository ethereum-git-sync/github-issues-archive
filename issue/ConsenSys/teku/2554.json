{
  "url": "https://api.github.com/repos/ConsenSys/teku/issues/2554",
  "repository_url": "https://api.github.com/repos/ConsenSys/teku",
  "labels_url": "https://api.github.com/repos/ConsenSys/teku/issues/2554/labels{/name}",
  "comments_url": "https://api.github.com/repos/ConsenSys/teku/issues/2554/comments",
  "events_url": "https://api.github.com/repos/ConsenSys/teku/issues/2554/events",
  "html_url": "https://github.com/ConsenSys/teku/issues/2554",
  "id": 676760059,
  "node_id": "MDU6SXNzdWU2NzY3NjAwNTk=",
  "number": 2554,
  "title": "Teku fails to recover after Internet connection is offline",
  "user": {
    "login": "dankrad",
    "id": 6130607,
    "node_id": "MDQ6VXNlcjYxMzA2MDc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6130607?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/dankrad",
    "html_url": "https://github.com/dankrad",
    "followers_url": "https://api.github.com/users/dankrad/followers",
    "following_url": "https://api.github.com/users/dankrad/following{/other_user}",
    "gists_url": "https://api.github.com/users/dankrad/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/dankrad/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/dankrad/subscriptions",
    "organizations_url": "https://api.github.com/users/dankrad/orgs",
    "repos_url": "https://api.github.com/users/dankrad/repos",
    "events_url": "https://api.github.com/users/dankrad/events{/privacy}",
    "received_events_url": "https://api.github.com/users/dankrad/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1048919129,
      "node_id": "MDU6TGFiZWwxMDQ4OTE5MTI5",
      "url": "https://api.github.com/repos/ConsenSys/teku/labels/bug%20%F0%9F%90%9E",
      "name": "bug üêû",
      "color": "dd6c94",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 2172541810,
      "node_id": "MDU6TGFiZWwyMTcyNTQxODEw",
      "url": "https://api.github.com/repos/ConsenSys/teku/labels/P2",
      "name": "P2",
      "color": "FFA500",
      "default": false,
      "description": "High"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "mbaxter",
    "id": 658601,
    "node_id": "MDQ6VXNlcjY1ODYwMQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/658601?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mbaxter",
    "html_url": "https://github.com/mbaxter",
    "followers_url": "https://api.github.com/users/mbaxter/followers",
    "following_url": "https://api.github.com/users/mbaxter/following{/other_user}",
    "gists_url": "https://api.github.com/users/mbaxter/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mbaxter/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mbaxter/subscriptions",
    "organizations_url": "https://api.github.com/users/mbaxter/orgs",
    "repos_url": "https://api.github.com/users/mbaxter/repos",
    "events_url": "https://api.github.com/users/mbaxter/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mbaxter/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "mbaxter",
      "id": 658601,
      "node_id": "MDQ6VXNlcjY1ODYwMQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/658601?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mbaxter",
      "html_url": "https://github.com/mbaxter",
      "followers_url": "https://api.github.com/users/mbaxter/followers",
      "following_url": "https://api.github.com/users/mbaxter/following{/other_user}",
      "gists_url": "https://api.github.com/users/mbaxter/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mbaxter/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mbaxter/subscriptions",
      "organizations_url": "https://api.github.com/users/mbaxter/orgs",
      "repos_url": "https://api.github.com/users/mbaxter/repos",
      "events_url": "https://api.github.com/users/mbaxter/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mbaxter/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2020-08-11T10:23:59Z",
  "updated_at": "2020-08-20T21:12:10Z",
  "closed_at": "2020-08-20T21:12:09Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "\r\n### Description\r\nAfter an internet connection drop, teku never came back online and re-synched. In fact, there are really concerning Errors in the log:\r\n```02:53:00.363 ERROR - Validator   *** Produced invalid attestation for slot 47064 with expected validator index: 3598 and actual validator index: 21384 . Invalid reason: Aggregation bitlist size (135) does not match committee size (134)\r\n```\r\nand\r\n```02:16:00.379 ERROR - Validator   *** Failed to produce attestation  Slot: 46879 tech.pegasys.teku.core.signatures.SlashableConditionException: Refusing to sign attestation at slot 46879 with source epoch 1461 and target epoch 1464 because it may violate a slashing condition (See log file for full stack trace)\r\n```\r\n\r\n### Acceptance Criteria\r\nTeku should automatically resume operations on connection drops. Validators should not produce invalid attestations.\r\n\r\n### Steps to Reproduce (Bug)\r\n\r\n**Expected behavior:** [What you expect to happen]\r\n\r\n**Actual behavior:** [What actually happens]\r\n\r\n**Frequency:** [What percentage of the time does it occur?]\r\n\r\n### Versions (Add all that apply)\r\n* Software version: teku/v0.12.3-dev-2993d20d/linux-x86_64/-ubuntu-openjdk64bitservervm-java-11\r\n* Java version: openjdk version \"11.0.8\" 2020-07-14\r\n* OS Name & Version: Ubuntu 20.04 LTS\r\n* Kernel Version: Linux pascal 5.4.0-42-generic #46-Ubuntu SMP Fri Jul 10 00:24:02 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux\r\n* Virtual Machine software & version: /\r\n* Docker Version: /\r\n* Cloud VM, type, size: /\r\n\r\n### Additional Information\r\n\r\n\r\n",
  "closed_by": {
    "login": "mbaxter",
    "id": 658601,
    "node_id": "MDQ6VXNlcjY1ODYwMQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/658601?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mbaxter",
    "html_url": "https://github.com/mbaxter",
    "followers_url": "https://api.github.com/users/mbaxter/followers",
    "following_url": "https://api.github.com/users/mbaxter/following{/other_user}",
    "gists_url": "https://api.github.com/users/mbaxter/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mbaxter/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mbaxter/subscriptions",
    "organizations_url": "https://api.github.com/users/mbaxter/orgs",
    "repos_url": "https://api.github.com/users/mbaxter/repos",
    "events_url": "https://api.github.com/users/mbaxter/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mbaxter/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/2554/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ConsenSys/teku/issues/2554/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/671866980",
    "html_url": "https://github.com/ConsenSys/teku/issues/2554#issuecomment-671866980",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/2554",
    "id": 671866980,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY3MTg2Njk4MA==",
    "user": {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-08-11T10:31:28Z",
    "updated_at": "2020-08-11T10:31:28Z",
    "author_association": "CONTRIBUTOR",
    "body": "Hi @dankrad The exceptions didn't come through.  We have had issues in the past with connections not restoring but recent tests have been good so would be very useful to see the content of those exceptions and if at all possible the full log output.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/671866980/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/671875257",
    "html_url": "https://github.com/ConsenSys/teku/issues/2554#issuecomment-671875257",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/2554",
    "id": 671875257,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY3MTg3NTI1Nw==",
    "user": {
      "login": "dankrad",
      "id": 6130607,
      "node_id": "MDQ6VXNlcjYxMzA2MDc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6130607?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dankrad",
      "html_url": "https://github.com/dankrad",
      "followers_url": "https://api.github.com/users/dankrad/followers",
      "following_url": "https://api.github.com/users/dankrad/following{/other_user}",
      "gists_url": "https://api.github.com/users/dankrad/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dankrad/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dankrad/subscriptions",
      "organizations_url": "https://api.github.com/users/dankrad/orgs",
      "repos_url": "https://api.github.com/users/dankrad/repos",
      "events_url": "https://api.github.com/users/dankrad/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dankrad/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-08-11T10:51:29Z",
    "updated_at": "2020-08-11T10:51:29Z",
    "author_association": "NONE",
    "body": "\r\n\r\n[tekulog.zip](https://github.com/PegaSysEng/teku/files/5056493/tekulog.zip)\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/671875257/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/671877492",
    "html_url": "https://github.com/ConsenSys/teku/issues/2554#issuecomment-671877492",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/2554",
    "id": 671877492,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY3MTg3NzQ5Mg==",
    "user": {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-08-11T10:57:27Z",
    "updated_at": "2020-08-11T10:57:27Z",
    "author_association": "CONTRIBUTOR",
    "body": "Thanks. It's getting late here so I won't be able to look into this much now but we'll investigate.\r\n\r\nThe messages:\r\n```\r\n2020-08-11 11:29:28.634+01:00 | P2PService-event-thread-0 | WARN  | AbstractRouter | AbstractRouter internal error on message null from peer null\r\nio.libp2p.core.InternalErrorException: [peerHandler] not initialized yet\r\n```\r\nare harmless (albeit very annoying) and will be fixed by https://github.com/PegaSysEng/teku/pull/2549\r\n\r\nI haven't had a chance to look into the other messages yet.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/671877492/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/672172619",
    "html_url": "https://github.com/ConsenSys/teku/issues/2554#issuecomment-672172619",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/2554",
    "id": 672172619,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY3MjE3MjYxOQ==",
    "user": {
      "login": "mbaxter",
      "id": 658601,
      "node_id": "MDQ6VXNlcjY1ODYwMQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/658601?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mbaxter",
      "html_url": "https://github.com/mbaxter",
      "followers_url": "https://api.github.com/users/mbaxter/followers",
      "following_url": "https://api.github.com/users/mbaxter/following{/other_user}",
      "gists_url": "https://api.github.com/users/mbaxter/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mbaxter/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mbaxter/subscriptions",
      "organizations_url": "https://api.github.com/users/mbaxter/orgs",
      "repos_url": "https://api.github.com/users/mbaxter/repos",
      "events_url": "https://api.github.com/users/mbaxter/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mbaxter/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-08-11T18:33:04Z",
    "updated_at": "2020-08-11T18:33:04Z",
    "author_association": "CONTRIBUTOR",
    "body": "It looks like the node gets stuck in a way that looks very similar to the caching issue described [here](https://github.com/PegaSysEng/teku/pull/2501)\r\n```\r\n2020-08-11 02:14:00.374+01:00 | validator-async-19127 | INFO  | teku-validator-log | \u001B[34mValidator   *** Published attestation  Count: 4, Slot: 46869, Root: 09bff2..82b0\u001B[0m\r\n\r\n2020-08-11 02:14:08.344+01:00 | TimeTickChannel-0 | INFO  | teku-event-log | \u001B[37mSync Event  *** Current slot: 46870, Head slot: 46723, Connected peers: 2\u001B[0m\r\n\r\n2020-08-11 02:14:32.353+01:00 | TimeTickChannel-0 | INFO  | teku-event-log | \u001B[37mSync Event  *** Current slot: 46872, Head slot: 46781, Connected peers: 2\u001B[0m\r\n\r\n2020-08-11 02:14:48.400+01:00 | validator-async-19125 | INFO  | teku-validator-log | \u001B[34mValidator   *** Published attestation  Count: 2, Slot: 46873, Root: 66506c..c73b\u001B[0m\r\n\r\n2020-08-11 02:14:50.352+01:00 | TimeTickChannel-0 | INFO  | teku-event-log | \u001B[37mSync Event  *** Current slot: 46873, Head slot: 46781, Connected peers: 1\u001B[0m\r\n\r\n2020-08-11 02:15:40.466+01:00 | p2p-async-154 | WARN  | PeerSync | Failed to import block from peer (err: FAILED_STATE_TRANSITION) SignedBeaconBlock{message=BeaconBlock{root=0x0b2e30dfba428e51f1d21222a6238bcf70a45548086b51e98ef38afe27baeb22, slot=46787, proposer_index=13778, parent_root=0x39fbe8ebbd97a8bbd952000639934796d80b5f44e91127b84e57dc41bc8caa50, state_root=0xbb5a093c3f9a54f6b56dddd215b81ddacdc39529ef2e4f5b26446f67a4fcd966, body=0x8bf4ed333bffd9544083f0cf0caeb8e0388f9933c1cab9cb08034e3f5bd956e7}, signature=0x9299f97327834c7c61df786bff1ab2acf97c70ff80efa62393ccf24220d2e165795b94fb2eaae0fbaf540788706d1b4a054940dc33fe521e3b445a4c951aa9faba555654964de2290cefdeb9de414f6fc07e3843ac32337e04ecc474f18c0c13}: Eth2Peer{id=16Uiu2HAm2i5u6hKcANdRomyYQz1bq1syx7EhGDratyz5TLsnA86E, remoteStatus=Optional[PeerStatus{forkDigest=0xe7a75d5a, finalizedRoot=0x39fbe8ebbd97a8bbd952000639934796d80b5f44e91127b84e57dc41bc8caa50, finalizedEpoch=1462, headRoot=0x1339768c2aafc495962c89370d56c03ef85a25271ee1de5e4a95112ea9025340, headSlot=46876}]}\r\n```\r\n\r\nThe chain head has fallen behind because of connectivity issues, we go to produce an attestation for the current slot, using an old chain head.  Because of a bug in our caching / attestation production logic (now fixed), we would cache the committee information calculated from this old state.  When we go to import a new block, we pull invalid committee information from our cache, causing us to see invalid attestations in the block we're importing.  Since the cache is now corrupted, the node can't recover and import any new blocks.\r\n\r\nTry updating to the latest code from master, which has a fix for this issue.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/672172619/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/677907595",
    "html_url": "https://github.com/ConsenSys/teku/issues/2554#issuecomment-677907595",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/2554",
    "id": 677907595,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY3NzkwNzU5NQ==",
    "user": {
      "login": "mbaxter",
      "id": 658601,
      "node_id": "MDQ6VXNlcjY1ODYwMQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/658601?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mbaxter",
      "html_url": "https://github.com/mbaxter",
      "followers_url": "https://api.github.com/users/mbaxter/followers",
      "following_url": "https://api.github.com/users/mbaxter/following{/other_user}",
      "gists_url": "https://api.github.com/users/mbaxter/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mbaxter/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mbaxter/subscriptions",
      "organizations_url": "https://api.github.com/users/mbaxter/orgs",
      "repos_url": "https://api.github.com/users/mbaxter/repos",
      "events_url": "https://api.github.com/users/mbaxter/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mbaxter/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-08-20T21:12:09Z",
    "updated_at": "2020-08-20T21:12:09Z",
    "author_association": "CONTRIBUTOR",
    "body": "Closing this for now - as this should be addressed by the fix to #2446\r\n\r\nPlease reopen if you run into this again. ",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/677907595/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
