{
  "url": "https://api.github.com/repos/ConsenSys/teku/issues/6576",
  "repository_url": "https://api.github.com/repos/ConsenSys/teku",
  "labels_url": "https://api.github.com/repos/ConsenSys/teku/issues/6576/labels{/name}",
  "comments_url": "https://api.github.com/repos/ConsenSys/teku/issues/6576/comments",
  "events_url": "https://api.github.com/repos/ConsenSys/teku/issues/6576/events",
  "html_url": "https://github.com/ConsenSys/teku/issues/6576",
  "id": 1485952694,
  "node_id": "I_kwDOCM9I9M5Ykda2",
  "number": 6576,
  "title": "Support pruning old blocks",
  "user": {
    "login": "ajsutton",
    "id": 72675,
    "node_id": "MDQ6VXNlcjcyNjc1",
    "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ajsutton",
    "html_url": "https://github.com/ajsutton",
    "followers_url": "https://api.github.com/users/ajsutton/followers",
    "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
    "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
    "organizations_url": "https://api.github.com/users/ajsutton/orgs",
    "repos_url": "https://api.github.com/users/ajsutton/repos",
    "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ajsutton/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "ajsutton",
    "id": 72675,
    "node_id": "MDQ6VXNlcjcyNjc1",
    "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ajsutton",
    "html_url": "https://github.com/ajsutton",
    "followers_url": "https://api.github.com/users/ajsutton/followers",
    "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
    "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
    "organizations_url": "https://api.github.com/users/ajsutton/orgs",
    "repos_url": "https://api.github.com/users/ajsutton/repos",
    "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ajsutton/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 6,
  "created_at": "2022-12-09T04:24:41Z",
  "updated_at": "2022-12-19T21:22:43Z",
  "closed_at": "2022-12-16T08:16:42Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "### Description\nNow that checkpoint sync is supported by all clients, we can start moving away from storing the full block history back to genesis.\n\nAdd a (initially hidden, --X) option to specify the maximum retention period for historic block data. This should be specified in number of epochs to retain.  The minimum allowed value is [`MIN_EPOCHS_FOR_BLOCK_REQUESTS`](https://github.com/ethereum/consensus-specs/blob/dev/specs/phase0/p2p-interface.md#configuration). If the value is set to less than this, log a warning and use `MIN_EPOCHS_FOR_BLOCK_REQUESTS` as the retention period.\n\nIf the retention period is set to 0, retain all blocks back to genesis.  Q: Should we instead have a separate `--block-pruning-enabled` option to disable?\n\nAlso ensure that the historic block fetcher never attempts to fetch blocks prior to this retention period. It will also not be possible to rebuild historic states when block data is pruned (since it requires blocks all the way back to genesis).",
  "closed_by": {
    "login": "tbenr",
    "id": 15999009,
    "node_id": "MDQ6VXNlcjE1OTk5MDA5",
    "avatar_url": "https://avatars.githubusercontent.com/u/15999009?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tbenr",
    "html_url": "https://github.com/tbenr",
    "followers_url": "https://api.github.com/users/tbenr/followers",
    "following_url": "https://api.github.com/users/tbenr/following{/other_user}",
    "gists_url": "https://api.github.com/users/tbenr/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tbenr/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tbenr/subscriptions",
    "organizations_url": "https://api.github.com/users/tbenr/orgs",
    "repos_url": "https://api.github.com/users/tbenr/repos",
    "events_url": "https://api.github.com/users/tbenr/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tbenr/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/6576/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ConsenSys/teku/issues/6576/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1344051184",
    "html_url": "https://github.com/ConsenSys/teku/issues/6576#issuecomment-1344051184",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/6576",
    "id": 1344051184,
    "node_id": "IC_kwDOCM9I9M5QHJfw",
    "user": {
      "login": "benjaminion",
      "id": 20796281,
      "node_id": "MDQ6VXNlcjIwNzk2Mjgx",
      "avatar_url": "https://avatars.githubusercontent.com/u/20796281?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/benjaminion",
      "html_url": "https://github.com/benjaminion",
      "followers_url": "https://api.github.com/users/benjaminion/followers",
      "following_url": "https://api.github.com/users/benjaminion/following{/other_user}",
      "gists_url": "https://api.github.com/users/benjaminion/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/benjaminion/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/benjaminion/subscriptions",
      "organizations_url": "https://api.github.com/users/benjaminion/orgs",
      "repos_url": "https://api.github.com/users/benjaminion/repos",
      "events_url": "https://api.github.com/users/benjaminion/events{/privacy}",
      "received_events_url": "https://api.github.com/users/benjaminion/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-09T09:17:20Z",
    "updated_at": "2022-12-09T09:17:20Z",
    "author_association": "CONTRIBUTOR",
    "body": "Would we auto-prune existing databases that have existing data back to genesis? (2 years' worth now.) Or would this apply only to newly-checkpoint-synced nodes?\r\n\r\nI can see arguments for both, but we should choose by default whichever is least surprising to users - probably the latter. Maybe supply a tool option to prune old DBs. (Users could manually delete an old DB and do a checkpoint sync, but this comes at the cost of re-downloading 5 months worth of blocks, which is non-trivial.)",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1344051184/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1344789824",
    "html_url": "https://github.com/ConsenSys/teku/issues/6576#issuecomment-1344789824",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/6576",
    "id": 1344789824,
    "node_id": "IC_kwDOCM9I9M5QJ91A",
    "user": {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-09T21:15:04Z",
    "updated_at": "2022-12-09T21:15:04Z",
    "author_association": "CONTRIBUTOR",
    "body": "Good question - ideally for existing databases the current behaviour of keeping all blocks back to genesis would be preserved so there are no surprises.  But I think we want to make it easy to enable this and just have it prune old data in the background rather than having to run a separate tool. So I think we'd just want to make the default enabled/disabled value dependent on the database so it defaults to disabled for any database created before this feature that hasn't enabled it at some point.\r\n\r\nBut the initial implementation would be disabled by default and I think we'd leave this as an opt-in feature for a fair while anyway.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1344789824/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1345866703",
    "html_url": "https://github.com/ConsenSys/teku/issues/6576#issuecomment-1345866703",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/6576",
    "id": 1345866703,
    "node_id": "IC_kwDOCM9I9M5QOEvP",
    "user": {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-12T04:41:38Z",
    "updated_at": "2022-12-12T04:41:38Z",
    "author_association": "CONTRIBUTOR",
    "body": "For initial implementation I've wound up with just a block-pruning-enabled flag and no option to customise the number of epochs it keeps. We could make it configurable if needed but it added complexity and given the spec requires about 5 months of storage, I'm not really sure why you'd want somewhere between that and everything. Maybe tax reporting but seems very very niche...",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1345866703/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1347278424",
    "html_url": "https://github.com/ConsenSys/teku/issues/6576#issuecomment-1347278424",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/6576",
    "id": 1347278424,
    "node_id": "IC_kwDOCM9I9M5QTdZY",
    "user": {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-12T20:42:07Z",
    "updated_at": "2022-12-12T20:42:07Z",
    "author_association": "CONTRIBUTOR",
    "body": "Initial implementation done, there's a few remaining things to get to done:\n\n1. Check that switching this on with a fully sync'd node works smoothly. Currently it deletes all historic blocks in a single transaction but that may explode memory usage.\n2. Make the flag visible and documented\n\nIf we want to change the default to be enabled, we also need to work out how to deal with existing databases as per the discussion above. It would likely need to remain disabled by default for existing databases and should be disabled when in archive mode.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1347278424/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1347281257",
    "html_url": "https://github.com/ConsenSys/teku/issues/6576#issuecomment-1347281257",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/6576",
    "id": 1347281257,
    "node_id": "IC_kwDOCM9I9M5QTeFp",
    "user": {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-12T20:43:02Z",
    "updated_at": "2022-12-12T20:43:02Z",
    "author_association": "CONTRIBUTOR",
    "body": "Actually one possibility would be to change this to be a third `--data-storage-mode` so we'd have `ARCHIVE`, `PRUNE` and `PRUNE_ALL` or something like that.  Shame `PRUNE` isn't `PRUNE_STATES`...",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1347281257/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1347547797",
    "html_url": "https://github.com/ConsenSys/teku/issues/6576#issuecomment-1347547797",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/6576",
    "id": 1347547797,
    "node_id": "IC_kwDOCM9I9M5QUfKV",
    "user": {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-13T00:01:33Z",
    "updated_at": "2022-12-13T00:01:33Z",
    "author_association": "CONTRIBUTOR",
    "body": "Moved over to `--data-storage-mode` with ARCHIVE, PRUNE and the new MINIMAL option that also prunes blocks.  Have spun up a new node on mainnet that's currently backfilling all blocks so that we can test performance when first switching to MINIMAL.\n\nAlso worth noting that if you switch from MINIMAL to PRUNE, Teku will automatically backfill the blocks again which is kind of cool.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1347547797/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
