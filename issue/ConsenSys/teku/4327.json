{
  "url": "https://api.github.com/repos/ConsenSys/teku/issues/4327",
  "repository_url": "https://api.github.com/repos/ConsenSys/teku",
  "labels_url": "https://api.github.com/repos/ConsenSys/teku/issues/4327/labels{/name}",
  "comments_url": "https://api.github.com/repos/ConsenSys/teku/issues/4327/comments",
  "events_url": "https://api.github.com/repos/ConsenSys/teku/issues/4327/events",
  "html_url": "https://github.com/ConsenSys/teku/issues/4327",
  "id": 990500596,
  "node_id": "MDU6SXNzdWU5OTA1MDA1OTY=",
  "number": 4327,
  "title": "Teku does not check for liveness of the TCP connections for metrics",
  "user": {
    "login": "Neurone",
    "id": 562943,
    "node_id": "MDQ6VXNlcjU2Mjk0Mw==",
    "avatar_url": "https://avatars.githubusercontent.com/u/562943?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Neurone",
    "html_url": "https://github.com/Neurone",
    "followers_url": "https://api.github.com/users/Neurone/followers",
    "following_url": "https://api.github.com/users/Neurone/following{/other_user}",
    "gists_url": "https://api.github.com/users/Neurone/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Neurone/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Neurone/subscriptions",
    "organizations_url": "https://api.github.com/users/Neurone/orgs",
    "repos_url": "https://api.github.com/users/Neurone/repos",
    "events_url": "https://api.github.com/users/Neurone/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Neurone/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "ajsutton",
    "id": 72675,
    "node_id": "MDQ6VXNlcjcyNjc1",
    "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ajsutton",
    "html_url": "https://github.com/ajsutton",
    "followers_url": "https://api.github.com/users/ajsutton/followers",
    "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
    "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
    "organizations_url": "https://api.github.com/users/ajsutton/orgs",
    "repos_url": "https://api.github.com/users/ajsutton/repos",
    "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ajsutton/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2021-09-08T00:58:25Z",
  "updated_at": "2021-10-12T03:12:53Z",
  "closed_at": "2021-10-12T03:12:53Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "### Description\r\nTeku does not check TCP connection liveness for metrics.\r\n\r\nIf a Prometheus client on another machine establish a connection and then it stops sending packets (i.e. due to crash, networking errors, malicious behaviours, etc.), the server-side connection remains `ESTABLISHED` forever. The next time the Prometheus client tries to connect to Teku again, a new connection is created.\r\n\r\nI noticed this because of a misconfiguration in the Raspberry I use as monitoring server. Every 20 minutes the Pi tries to suspend, but it fails and it reboot itself. All this takes less then 30 seconds, so it's not really noticeable, but it is enough to cause my Teku an increment of 72 stale TCP connections per day. The only way to force Teku to kill those connections is to restart it.\r\n\r\nIt's not a fault in machine or network configuration: I have other servers on the same machine along with Teku (i.e. geth) and the same Prometheus client works fine with all of them except Teku.\r\n\r\nThe problem seems related to how `io.vertx` handles TCP connections, or maybe it is `io.netty`'s fault.\r\n\r\nI didn't understand enough how vertx uses netty, but I created a custom build with `netty 4.1.67` and `vertx 3.9.9` (released just few hours ago) and nothing changed.\r\n\r\nI tried with `vertx 4.1.3` also, but I encountered other problems so it's not a valid test.\r\n\r\n### Steps to Reproduce (Bug)\r\n1. Enable metrics (`--metrics-enabled=true`)\r\n2. Establish a connection from another machine (i.e. with Prometheus, or manually with something like `nc <IP> <PORT>`)\r\n3. Disconnect or forcibly terminate the client machine\r\n4. Connection remains `ESTABLISHED` on the Teku side\r\n5. Connect or start the client machine again\r\n6. Establish a new connection\r\n7. The new connection is created and established, but the old one remains `ESTABLISHED` forever\r\n\r\n**Expected behavior:**\r\nIf Prometheus client goes offline forcibly or due to unexpected issues, the server-side connection is closed after a timeout.\r\n\r\n**Actual behavior:**\r\nIf Prometheus client goes offline forcibly or due to unexpected issues, the server-side connection remains open forever. The next time the Prometheus client tries to connect to Teku, a new connection is established.\r\n\r\n**Frequency:**\r\nIt happens every time I tried. Pretty _solid_ behaviour, maybe is it an intended configuration for some reason?\r\n\r\n### Versions\r\n* Software version: `teku/v21.8.2/linux-x86_64/-privatebuild-openjdk64bitservervm-java-14`\r\n* Java version: `openjdk version \"14.0.2\" 2020-07-14 -- OpenJDK Runtime Environment (build 14.0.2+12-Ubuntu-120.04) --\r\nOpenJDK 64-Bit Server VM (build 14.0.2+12-Ubuntu-120.04, mixed mode, sharing)`\r\n* OS Name & Version: `Ubuntu 20.04.3 LTS`\r\n* Kernel Version: `Linux ethmachine 5.11.0-34-generic #36~20.04.1-Ubuntu SMP Fri Aug 27 08:06:32 UTC 2021 x86_64 x86_64 x86_64 GNU/Linux`",
  "closed_by": {
    "login": "ajsutton",
    "id": 72675,
    "node_id": "MDQ6VXNlcjcyNjc1",
    "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ajsutton",
    "html_url": "https://github.com/ajsutton",
    "followers_url": "https://api.github.com/users/ajsutton/followers",
    "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
    "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
    "organizations_url": "https://api.github.com/users/ajsutton/orgs",
    "repos_url": "https://api.github.com/users/ajsutton/repos",
    "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ajsutton/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/4327/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ConsenSys/teku/issues/4327/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/914771642",
    "html_url": "https://github.com/ConsenSys/teku/issues/4327#issuecomment-914771642",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/4327",
    "id": 914771642,
    "node_id": "IC_kwDOCM9I9M42hk66",
    "user": {
      "login": "Neurone",
      "id": 562943,
      "node_id": "MDQ6VXNlcjU2Mjk0Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/562943?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Neurone",
      "html_url": "https://github.com/Neurone",
      "followers_url": "https://api.github.com/users/Neurone/followers",
      "following_url": "https://api.github.com/users/Neurone/following{/other_user}",
      "gists_url": "https://api.github.com/users/Neurone/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Neurone/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Neurone/subscriptions",
      "organizations_url": "https://api.github.com/users/Neurone/orgs",
      "repos_url": "https://api.github.com/users/Neurone/repos",
      "events_url": "https://api.github.com/users/Neurone/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Neurone/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-09-08T01:21:48Z",
    "updated_at": "2021-09-08T01:22:32Z",
    "author_association": "CONTRIBUTOR",
    "body": "It seems possible to set a timeout using [setIdleTimeout](https://vertx.io/docs/3.9.9/apidocs/io/vertx/core/http/HttpServerOptions.html#setIdleTimeout-int-) in Vertx's [HttpServerOptions](https://vertx.io/docs/3.9.9/apidocs/io/vertx/core/http/HttpServerOptions.html) class.\r\n\r\nIt seems to me that Teku uses a library from Besu to create the metrics server, but the Besu [MetricsHttpService](https://github.com/hyperledger/besu/blob/main/metrics/core/src/main/java/org/hyperledger/besu/metrics/prometheus/MetricsHttpService.java) does not currently allow setting the setIdleTimeout parameter.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/914771642/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/916553860",
    "html_url": "https://github.com/ConsenSys/teku/issues/4327#issuecomment-916553860",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/4327",
    "id": 916553860,
    "node_id": "IC_kwDOCM9I9M42oYCE",
    "user": {
      "login": "rolfyone",
      "id": 2967240,
      "node_id": "MDQ6VXNlcjI5NjcyNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2967240?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rolfyone",
      "html_url": "https://github.com/rolfyone",
      "followers_url": "https://api.github.com/users/rolfyone/followers",
      "following_url": "https://api.github.com/users/rolfyone/following{/other_user}",
      "gists_url": "https://api.github.com/users/rolfyone/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rolfyone/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rolfyone/subscriptions",
      "organizations_url": "https://api.github.com/users/rolfyone/orgs",
      "repos_url": "https://api.github.com/users/rolfyone/repos",
      "events_url": "https://api.github.com/users/rolfyone/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rolfyone/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-09-10T01:08:53Z",
    "updated_at": "2021-09-10T01:08:53Z",
    "author_association": "CONTRIBUTOR",
    "body": "Thanks for the write-up. I've put in a besu PR to add an idle timeout, and tested manually with telnet connections, and that should solve the issue.  We'll have to wait until besu releases their next version until we can pull the change through to teku.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/916553860/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/917105764",
    "html_url": "https://github.com/ConsenSys/teku/issues/4327#issuecomment-917105764",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/4327",
    "id": 917105764,
    "node_id": "IC_kwDOCM9I9M42qexk",
    "user": {
      "login": "Neurone",
      "id": 562943,
      "node_id": "MDQ6VXNlcjU2Mjk0Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/562943?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Neurone",
      "html_url": "https://github.com/Neurone",
      "followers_url": "https://api.github.com/users/Neurone/followers",
      "following_url": "https://api.github.com/users/Neurone/following{/other_user}",
      "gists_url": "https://api.github.com/users/Neurone/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Neurone/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Neurone/subscriptions",
      "organizations_url": "https://api.github.com/users/Neurone/orgs",
      "repos_url": "https://api.github.com/users/Neurone/repos",
      "events_url": "https://api.github.com/users/Neurone/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Neurone/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-09-10T18:06:30Z",
    "updated_at": "2021-09-10T18:06:30Z",
    "author_association": "CONTRIBUTOR",
    "body": "I suggested a PR (https://github.com/hyperledger/besu/pull/2752) to make idle timeout configurable",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/917105764/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
