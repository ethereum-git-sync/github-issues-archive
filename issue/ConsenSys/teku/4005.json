{
  "url": "https://api.github.com/repos/ConsenSys/teku/issues/4005",
  "repository_url": "https://api.github.com/repos/ConsenSys/teku",
  "labels_url": "https://api.github.com/repos/ConsenSys/teku/issues/4005/labels{/name}",
  "comments_url": "https://api.github.com/repos/ConsenSys/teku/issues/4005/comments",
  "events_url": "https://api.github.com/repos/ConsenSys/teku/issues/4005/events",
  "html_url": "https://github.com/ConsenSys/teku/issues/4005",
  "id": 894517082,
  "node_id": "MDU6SXNzdWU4OTQ1MTcwODI=",
  "number": 4005,
  "title": "Eth1 head at follow distance is a function of block height",
  "user": {
    "login": "mkalinin",
    "id": 1892772,
    "node_id": "MDQ6VXNlcjE4OTI3NzI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1892772?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mkalinin",
    "html_url": "https://github.com/mkalinin",
    "followers_url": "https://api.github.com/users/mkalinin/followers",
    "following_url": "https://api.github.com/users/mkalinin/following{/other_user}",
    "gists_url": "https://api.github.com/users/mkalinin/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mkalinin/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mkalinin/subscriptions",
    "organizations_url": "https://api.github.com/users/mkalinin/orgs",
    "repos_url": "https://api.github.com/users/mkalinin/repos",
    "events_url": "https://api.github.com/users/mkalinin/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mkalinin/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "ajsutton",
    "id": 72675,
    "node_id": "MDQ6VXNlcjcyNjc1",
    "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ajsutton",
    "html_url": "https://github.com/ajsutton",
    "followers_url": "https://api.github.com/users/ajsutton/followers",
    "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
    "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
    "organizations_url": "https://api.github.com/users/ajsutton/orgs",
    "repos_url": "https://api.github.com/users/ajsutton/repos",
    "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ajsutton/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2021-05-18T15:39:14Z",
  "updated_at": "2021-06-21T22:45:00Z",
  "closed_at": "2021-06-21T22:45:00Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Description\r\n\r\nThe spec states that candidate Eth1 blocks must be filtered this way:\r\n```py\r\ndef is_candidate_block(block: Eth1Block, period_start: uint64) -> bool:\r\n    return (\r\n        block.timestamp + SECONDS_PER_ETH1_BLOCK * ETH1_FOLLOW_DISTANCE <= period_start\r\n        and block.timestamp + SECONDS_PER_ETH1_BLOCK * ETH1_FOLLOW_DISTANCE * 2 >= period_start\r\n    )\r\n```\r\n\r\nEffectively Teku processes candidate blocks in two steps:\r\n- cache Eth1 blocks that satisfy following conditions `block.timestamp >= eth1_head_block.timestamp - cacheDuration` && `block.number <= eth1_head_block.number - ETH1_FOLLOW_DISTANCE`\r\n- apply `is_candidate_block` filter to cached blocks\r\n\r\nIf seconds per block in Eth1 network is _greater_ than `SECONDS_PER_ETH1_BLOCK` Teku may effectively stem from `is_candidate_block` conditions stated by the spec to the following:\r\n```py\r\ndef is_candidate_block(block: Eth1Block, period_start: uint64) -> bool:\r\n    return (\r\n        block.number + ETH1_FOLLOW_DISTANCE <= eth1_head_block.number\r\n        and block.timestamp + SECONDS_PER_ETH1_BLOCK * ETH1_FOLLOW_DISTANCE * 2 >= period_start\r\n    )\r\n```\r\n\r\nThe source of this bug is in the logic of head tracker that notifies about new Eth1 block at follow distance using block height instead of timestamp:\r\nhttps://github.com/ConsenSys/teku/blob/8df7ae14c1a9d4ebe633b3d835200576a00c9f91/pow/src/main/java/tech/pegasys/teku/pow/Eth1HeadTracker.java#L81\r\n\r\n### Effect\r\n\r\nSay real time per block is `15s` on average while `SECONDS_PER_ETH1_BLOCK = 14`. It would result in about `136` blocks not included in cache at the start of new voting period. Since, they are not in the cache they won't be considered as eth1 vote candidates.\r\n\r\nThe place this issue was originally discovered is [Nocturne](http://github.com/protolambda/nocturne) devnet, a testnet with deployed Merge code. Nocturne has empty slots which increase time between blocks and makes this issue occur. In other words, fixing this issue is important for the Merge.",
  "closed_by": {
    "login": "ajsutton",
    "id": 72675,
    "node_id": "MDQ6VXNlcjcyNjc1",
    "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ajsutton",
    "html_url": "https://github.com/ajsutton",
    "followers_url": "https://api.github.com/users/ajsutton/followers",
    "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
    "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
    "organizations_url": "https://api.github.com/users/ajsutton/orgs",
    "repos_url": "https://api.github.com/users/ajsutton/repos",
    "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ajsutton/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/4005/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ConsenSys/teku/issues/4005/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/844682074",
    "html_url": "https://github.com/ConsenSys/teku/issues/4005#issuecomment-844682074",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/4005",
    "id": 844682074,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg0NDY4MjA3NA==",
    "user": {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-05-20T04:38:19Z",
    "updated_at": "2021-05-20T04:38:19Z",
    "author_association": "CONTRIBUTOR",
    "body": "You know I could have sworn the spec always followed 2048 blocks behind head, not just time based but have reviewed it and agree with your analysis. Won't be a quick fix unfortunately since you can't blocks by timestamp so we'll have to change our approach to tracking the head.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/844682074/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/844875923",
    "html_url": "https://github.com/ConsenSys/teku/issues/4005#issuecomment-844875923",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/4005",
    "id": 844875923,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg0NDg3NTkyMw==",
    "user": {
      "login": "mkalinin",
      "id": 1892772,
      "node_id": "MDQ6VXNlcjE4OTI3NzI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1892772?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mkalinin",
      "html_url": "https://github.com/mkalinin",
      "followers_url": "https://api.github.com/users/mkalinin/followers",
      "following_url": "https://api.github.com/users/mkalinin/following{/other_user}",
      "gists_url": "https://api.github.com/users/mkalinin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mkalinin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mkalinin/subscriptions",
      "organizations_url": "https://api.github.com/users/mkalinin/orgs",
      "repos_url": "https://api.github.com/users/mkalinin/repos",
      "events_url": "https://api.github.com/users/mkalinin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mkalinin/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-05-20T08:50:28Z",
    "updated_at": "2021-05-20T08:50:28Z",
    "author_association": "NONE",
    "body": "> You know I could have sworn the spec always followed 2048 blocks behind head, not just time based but have reviewed it and agree with your analysis. Won't be a quick fix unfortunately since you can't blocks by timestamp so we'll have to change our approach to tracking the head.\r\n\r\nSpec used block height from the very beginning and then switched to timestamp based approach -- it might be a source of confusion.\r\n\r\nI totally agree, there is no easy fix to that. Since there is no way to query blocks by timestamp a straightforward fix would require traversing blocks starting at `ETH1_FOLLOW_DISTANCE` and picking the last block that satisfies eth1 voting conditions. This is suboptimal and we might want to cache adjusted follow distance if block time has been increased in order to reduce traversal complexity; but when time between blocks starts sliding back towards `SECONDS_PER_ETH1_BLOCK` this cached follow distance should be re-adjusted.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/844875923/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/844883955",
    "html_url": "https://github.com/ConsenSys/teku/issues/4005#issuecomment-844883955",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/4005",
    "id": 844883955,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg0NDg4Mzk1NQ==",
    "user": {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-05-20T08:59:57Z",
    "updated_at": "2021-05-20T08:59:57Z",
    "author_association": "CONTRIBUTOR",
    "body": "Given we have to walk through every block in the cache period anyway to populate the cache, I think as long we don't entirely overshoot the period we need to cache we can wind up making the same number of requests without being too fancy.\r\n\r\nBasically I'm thinking we request the block that's `ETH1_FOLLOW_DISTANCE` behind the current head.  My assumption is that that block will a) not be before the start of the period we need to cache (block time would have to be out by a factor of 2 I think) and b) we're not going to get any forks at that distance even if it turns out to be more recent than we need.\r\n\r\nThen we just walk backwards from there to the start of the period we need to cache as we currently do, and also walk forward until we get the first block that's more recent than `ETH1_FOLLOW_DISTANCE * SECONDS_PER_ETH1_BLOCK`. When time progresses enough that the last block is now within the period we should cache, we request the next block after it, ensuring that we always wind up holding one block that's more recent than the period we need.  That actually lets us stop polling the head block as well so should wind up significantly reducing the number of requests we need to make to the eth1 node.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/844883955/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/844887481",
    "html_url": "https://github.com/ConsenSys/teku/issues/4005#issuecomment-844887481",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/4005",
    "id": 844887481,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg0NDg4NzQ4MQ==",
    "user": {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-05-20T09:03:59Z",
    "updated_at": "2021-05-20T09:03:59Z",
    "author_association": "CONTRIBUTOR",
    "body": "I'm thinking with that approach even if `ETH1_FOLLOW_DISTANCE` winds up being more recent than we actually want, we just wind up caching more than we need initially and will gradually prune the cache down over time since we won't request any new blocks until the most recent one we have is within the cache period.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/844887481/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
