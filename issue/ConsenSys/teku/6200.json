{
  "url": "https://api.github.com/repos/ConsenSys/teku/issues/6200",
  "repository_url": "https://api.github.com/repos/ConsenSys/teku",
  "labels_url": "https://api.github.com/repos/ConsenSys/teku/issues/6200/labels{/name}",
  "comments_url": "https://api.github.com/repos/ConsenSys/teku/issues/6200/comments",
  "events_url": "https://api.github.com/repos/ConsenSys/teku/issues/6200/events",
  "html_url": "https://github.com/ConsenSys/teku/issues/6200",
  "id": 1372309223,
  "node_id": "I_kwDOCM9I9M5Ry8bn",
  "number": 6200,
  "title": "sync executor queue fills up while in sync",
  "user": {
    "login": "ajsutton",
    "id": 72675,
    "node_id": "MDQ6VXNlcjcyNjc1",
    "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ajsutton",
    "html_url": "https://github.com/ajsutton",
    "followers_url": "https://api.github.com/users/ajsutton/followers",
    "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
    "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
    "organizations_url": "https://api.github.com/users/ajsutton/orgs",
    "repos_url": "https://api.github.com/users/ajsutton/repos",
    "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ajsutton/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "ajsutton",
    "id": 72675,
    "node_id": "MDQ6VXNlcjcyNjc1",
    "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ajsutton",
    "html_url": "https://github.com/ajsutton",
    "followers_url": "https://api.github.com/users/ajsutton/followers",
    "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
    "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
    "organizations_url": "https://api.github.com/users/ajsutton/orgs",
    "repos_url": "https://api.github.com/users/ajsutton/repos",
    "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ajsutton/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2022-09-14T04:22:24Z",
  "updated_at": "2022-10-06T03:12:23Z",
  "closed_at": "2022-10-06T03:12:23Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "### Description\r\nNot a lot to go on to work out why this is happening, but in two instances I've seen nodes start reporting `RejectedExecutionException`:\r\n\r\n```\r\n{\"@timestamp\":\"2022-09-14T00:06:27,969\",\"level\":\"ERROR\",\"thread\":\"nioEventLoopGroup-3-1\",\"class\":\"TekuDefaultExceptionHandler\",\"message\":\"Unexpected rejected execution due to full task queue in nioEventLoopGroup-3-1\",\"throwable\":\"\"}\r\n{\"@timestamp\":\"2022-09-14T00:06:28,923\",\"level\":\"ERROR\",\"thread\":\"nioEventLoopGroup-3-5\",\"class\":\"TekuDefaultExceptionHandler\",\"message\":\"Unexpected rejected execution due to full task queue in nioEventLoopGroup-3-5\",\"throwable\":\"\"}\r\n{\"@timestamp\":\"2022-09-14T00:06:28,928\",\"level\":\"ERROR\",\"thread\":\"nioEventLoopGroup-3-4\",\"class\":\"TekuDefaultExceptionHandler\",\"message\":\"Unexpected rejected execution due to full task queue in nioEventLoopGroup-3-4\",\"throwable\":\"\"}\r\n{\"@timestamp\":\"2022-09-14T00:06:29,541\",\"level\":\"ERROR\",\"thread\":\"nioEventLoopGroup-3-16\",\"class\":\"TekuDefaultExceptionHandler\",\"message\":\"Unexpected rejected execution due to full task queue in nioEventLoopGroup-3-16\",\"throwable\":\"\"}\r\n{\"@timestamp\":\"2022-09-14T00:06:29,924\",\"level\":\"ERROR\",\"thread\":\"nioEventLoopGroup-3-6\",\"class\":\"TekuDefaultExceptionHandler\",\"message\":\"Unexpected rejected execution due to full task queue in nioEventLoopGroup-3-6\",\"throwable\":\"\"}\r\n{\"@timestamp\":\"2022-09-14T00:06:29,924\",\"level\":\"ERROR\",\"thread\":\"nioEventLoopGroup-3-6\",\"class\":\"TekuDefaultExceptionHandler\",\"message\":\"Unexpected rejected execution due to full task queue in nioEventLoopGroup-3-6\",\"throwable\":\"\"}\r\n{\"@timestamp\":\"2022-09-14T00:06:29,979\",\"level\":\"ERROR\",\"thread\":\"nioEventLoopGroup-3-11\",\"class\":\"TekuDefaultExceptionHandler\",\"message\":\"Unexpected rejected execution due to full task queue in nioEventLoopGroup-3-11\",\"throwable\":\"\"}\r\n{\"@timestamp\":\"2022-09-14T00:06:29,985\",\"level\":\"ERROR\",\"thread\":\"nioEventLoopGroup-3-11\",\"class\":\"TekuDefaultExceptionHandler\",\"message\":\"Unexpected rejected execution due to full task queue in nioEventLoopGroup-3-11\",\"throwable\":\"\"}\r\n{\"@timestamp\":\"2022-09-14T00:06:30,003\",\"level\":\"ERROR\",\"thread\":\"nioEventLoopGroup-3-2\",\"class\":\"TekuDefaultExceptionHandler\",\"message\":\"Unexpected rejected execution due to full task queue in nioEventLoopGroup-3-2\",\"throwable\":\"\"}\r\n{\"@timestamp\":\"2022-09-14T00:06:30,005\",\"level\":\"ERROR\",\"thread\":\"nioEventLoopGroup-3-12\",\"class\":\"TekuDefaultExceptionHandler\",\"message\":\"Unexpected rejected execution due to full task queue in nioEventLoopGroup-3-12\",\"throwable\":\"\"}\r\n```\r\n\r\nAnd the executor queue for `sync` is full. The queue length seems to grow longer and longer over a number of hours until it's full:\r\n![image](https://user-images.githubusercontent.com/72675/190058532-825aa8fc-a571-47a7-bd5a-6f365953b419.png)\r\n\r\n\r\nThe node is generally unaffected and continues to follow the chain and create attestations well with no impact on rewards earned.\r\n\r\nCaptured some stack traces from the first time this happened - key thread seems to be the `sync-async-0`.\r\n[stack.txt](https://github.com/ConsenSys/teku/files/9562645/stack.txt)\r\n[stack2.txt](https://github.com/ConsenSys/teku/files/9562646/stack2.txt)\r\n[stack3.txt](https://github.com/ConsenSys/teku/files/9562647/stack3.txt)\r\n[stack4.txt](https://github.com/ConsenSys/teku/files/9562648/stack4.txt)\r\n[stack5.txt](https://github.com/ConsenSys/teku/files/9562649/stack5.txt)\r\n",
  "closed_by": {
    "login": "ajsutton",
    "id": 72675,
    "node_id": "MDQ6VXNlcjcyNjc1",
    "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ajsutton",
    "html_url": "https://github.com/ajsutton",
    "followers_url": "https://api.github.com/users/ajsutton/followers",
    "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
    "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
    "organizations_url": "https://api.github.com/users/ajsutton/orgs",
    "repos_url": "https://api.github.com/users/ajsutton/repos",
    "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ajsutton/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/6200/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ConsenSys/teku/issues/6200/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1257677494",
    "html_url": "https://github.com/ConsenSys/teku/issues/6200#issuecomment-1257677494",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/6200",
    "id": 1257677494,
    "node_id": "IC_kwDOCM9I9M5K9qK2",
    "user": {
      "login": "zilm13",
      "id": 6196452,
      "node_id": "MDQ6VXNlcjYxOTY0NTI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6196452?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/zilm13",
      "html_url": "https://github.com/zilm13",
      "followers_url": "https://api.github.com/users/zilm13/followers",
      "following_url": "https://api.github.com/users/zilm13/following{/other_user}",
      "gists_url": "https://api.github.com/users/zilm13/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/zilm13/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/zilm13/subscriptions",
      "organizations_url": "https://api.github.com/users/zilm13/orgs",
      "repos_url": "https://api.github.com/users/zilm13/repos",
      "events_url": "https://api.github.com/users/zilm13/events{/privacy}",
      "received_events_url": "https://api.github.com/users/zilm13/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-26T08:27:01Z",
    "updated_at": "2022-09-26T08:27:32Z",
    "author_association": "CONTRIBUTOR",
    "body": "I've tried to get into this but got no idea how it happens. Do you have any ideas how to reproduce it?\r\nIt could be deadlock of subsequent tasks or some call from another thread. I've not found evidence of either one and no other ideas left.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1257677494/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1265170164",
    "html_url": "https://github.com/ConsenSys/teku/issues/6200#issuecomment-1265170164",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/6200",
    "id": 1265170164,
    "node_id": "IC_kwDOCM9I9M5LaPb0",
    "user": {
      "login": "tbenr",
      "id": 15999009,
      "node_id": "MDQ6VXNlcjE1OTk5MDA5",
      "avatar_url": "https://avatars.githubusercontent.com/u/15999009?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tbenr",
      "html_url": "https://github.com/tbenr",
      "followers_url": "https://api.github.com/users/tbenr/followers",
      "following_url": "https://api.github.com/users/tbenr/following{/other_user}",
      "gists_url": "https://api.github.com/users/tbenr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tbenr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tbenr/subscriptions",
      "organizations_url": "https://api.github.com/users/tbenr/orgs",
      "repos_url": "https://api.github.com/users/tbenr/repos",
      "events_url": "https://api.github.com/users/tbenr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tbenr/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-10-03T09:25:27Z",
    "updated_at": "2022-10-03T09:25:27Z",
    "author_association": "CONTRIBUTOR",
    "body": "It happened to me too. Suddenly appeared and got them in burst. Had to restart the node. Got them for 12h, node continued performing duties.\r\n```\r\nteku_node_1  | 2022-10-02 23:40:09.550 ERROR - Unexpected rejected execution due to full task queue in beaconchain-async-14\r\nteku_node_1  | 2022-10-02 23:40:10.772 ERROR - Unexpected rejected execution due to full task queue in nioEventLoopGroup-3-28\r\nteku_node_1  | 2022-10-02 23:40:10.795 ERROR - Unexpected rejected execution due to full task queue in beaconchain-async-4\r\nteku_node_1  | 2022-10-02 23:40:10.972 ERROR - Unexpected rejected execution due to full task queue in nioEventLoopGroup-3-31\r\nteku_node_1  | 2022-10-02 23:40:11.630 ERROR - Unexpected rejected execution due to full task queue in nioEventLoopGroup-3-30\r\nteku_node_1  | 2022-10-02 23:40:11.943 ERROR - Unexpected rejected execution due to full task queue in nioEventLoopGroup-3-11\r\nteku_node_1  | 2022-10-02 23:40:11.945 ERROR - Unexpected rejected execution due to full task queue in nioEventLoopGroup-3-11\r\nteku_node_1  | 2022-10-02 23:40:11.987 ERROR - Unexpected rejected execution due to full task queue in nioEventLoopGroup-3-8\r\nteku_node_1  | 2022-10-02 23:40:11.991 ERROR - Unexpected rejected execution due to full task queue in nioEventLoopGroup-3-8\r\nteku_node_1  | 2022-10-02 23:40:12.021 ERROR - Unexpected rejected execution due to full task queue in beaconchain-async-5\r\nteku_node_1  | 2022-10-02 23:40:12.023 ERROR - Unexpected rejected execution due to full task queue in nioEventLoopGroup-3-9\r\nteku_node_1  | 2022-10-02 23:40:12.041 ERROR - Unexpected rejected execution due to full task queue in nioEventLoopGroup-3-32\r\nteku_node_1  | 2022-10-02 23:40:12.316 ERROR - Unexpected rejected execution due to full task queue in nioEventLoopGroup-3-12\r\nteku_node_1  | 2022-10-02 23:40:12.571 ERROR - Unexpected rejected execution due to full task queue in nioEventLoopGroup-3-5\r\nteku_node_1  | 2022-10-02 23:40:13.759 ERROR - Unexpected rejected execution due to full task queue in nioEventLoopGroup-3-20\r\nteku_node_1  | 2022-10-02 23:40:15.244 INFO  - Slot Event  *** Slot: 4826899, Block: 449046a1aac54d56e4ec947c2928fb77ff55bf9f1d9c6aab02c47e42cd5fd643, Justified: 150839, Finalized: 150838, Peers: 100\r\nteku_node_1  | 2022-10-02 23:40:18.573 ERROR - Unexpected rejected execution due to full task queue in beaconchain-async-0\r\nteku_node_1  | 2022-10-02 23:40:21.234 ERROR - Unexpected rejected execution due to full task queue in p2p-async-5\r\nteku_node_1  | 2022-10-02 23:40:21.261 ERROR - Unexpected rejected execution due to full task queue in beaconchain-async-11\r\nteku_node_1  | 2022-10-02 23:40:21.299 ERROR - Unexpected rejected execution due to full task queue in nioEventLoopGroup-3-19\r\nteku_node_1  | 2022-10-02 23:40:21.331 ERROR - Unexpected rejected execution due to full task queue in nioEventLoopGroup-3-21\r\nteku_node_1  | 2022-10-02 23:40:21.334 ERROR - Unexpected rejected execution due to full task queue in nioEventLoopGroup-3-21\r\nteku_node_1  | 2022-10-02 23:40:25.394 ERROR - Unexpected rejected execution due to full task queue in nioEventLoopGroup-3-10\r\nteku_node_1  | 2022-10-02 23:40:25.481 ERROR - Unexpected rejected execution due to full task queue in nioEventLoopGroup-3-4\r\nteku_node_1  | 2022-10-02 23:40:25.484 ERROR - Unexpected rejected execution due to full task queue in beaconchain-async-1\r\nteku_node_1  | 2022-10-02 23:40:25.988 ERROR - Unexpected rejected execution due to full task queue in p2p-async-9\r\nteku_node_1  | 2022-10-02 23:40:26.512 ERROR - Unexpected rejected execution due to full task queue in beaconchain-async-7\r\nteku_node_1  | 2022-10-02 23:40:26.533 ERROR - Unexpected rejected execution due to full task queue in nioEventLoopGroup-3-13\r\nteku_node_1  | 2022-10-02 23:40:26.552 ERROR - Unexpected rejected execution due to full task queue in nioEventLoopGroup-3-14\r\nteku_node_1  | 2022-10-02 23:40:26.598 ERROR - Unexpected rejected execution due to full task queue in nioEventLoopGroup-3-15\r\nteku_node_1  | 2022-10-02 23:40:26.604 ERROR - Unexpected rejected execution due to full task queue in nioEventLoopGroup-3-15\r\nteku_node_1  | 2022-10-02 23:40:26.771 ERROR - Unexpected rejected execution due to full task queue in nioEventLoopGroup-3-16\r\nteku_node_1  | 2022-10-02 23:40:26.773 ERROR - Unexpected rejected execution due to full task queue in nioEventLoopGroup-3-13\r\nteku_node_1  | 2022-10-02 23:40:26.774 ERROR - Unexpected rejected execution due to full task queue in nioEventLoopGroup-3-16\r\nteku_node_1  | 2022-10-02 23:40:27.258 INFO  - Slot Event  *** Slot: 4826900, Block: 63055de84994c8b5397ff3ab4a9f0f77da47abd6aa282fc2ed790993dc51a7a5, Justified: 150839, Finalized: 150838, Peers: 100\r\nteku_node_1  | 2022-10-02 23:40:27.273 ERROR - Unexpected rejected execution due to full task queue in nioEventLoopGroup-3-24\r\nteku_node_1  | 2022-10-02 23:40:27.274 ERROR - Unexpected rejected execution due to full task queue in nioEventLoopGroup-3-24\r\nteku_node_1  | 2022-10-02 23:40:27.295 ERROR - Unexpected rejected execution due to full task queue in nioEventLoopGroup-3-21\r\nteku_node_1  | 2022-10-02 23:40:27.390 ERROR - Unexpected rejected execution due to full task queue in nioEventLoopGroup-3-19\r\nteku_node_1  | 2022-10-02 23:40:27.413 ERROR - Unexpected rejected execution due to full task queue in nioEventLoopGroup-3-21\r\nteku_node_1  | 2022-10-02 23:40:28.273 ERROR - Unexpected rejected execution due to full task queue in nioEventLoopGroup-3-18\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1265170164/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1267858404",
    "html_url": "https://github.com/ConsenSys/teku/issues/6200#issuecomment-1267858404",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/6200",
    "id": 1267858404,
    "node_id": "IC_kwDOCM9I9M5Lkfvk",
    "user": {
      "login": "ajsutton",
      "id": 72675,
      "node_id": "MDQ6VXNlcjcyNjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/72675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajsutton",
      "html_url": "https://github.com/ajsutton",
      "followers_url": "https://api.github.com/users/ajsutton/followers",
      "following_url": "https://api.github.com/users/ajsutton/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajsutton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajsutton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajsutton/subscriptions",
      "organizations_url": "https://api.github.com/users/ajsutton/orgs",
      "repos_url": "https://api.github.com/users/ajsutton/repos",
      "events_url": "https://api.github.com/users/ajsutton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajsutton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-10-05T03:09:26Z",
    "updated_at": "2022-10-05T03:09:26Z",
    "author_association": "CONTRIBUTOR",
    "body": "Grabbed a heap dump from a node this problem was occurring on and could see that `TargetChains` was tracking some 34,000 different possible targets. That would explain why all the stack traces show it sorting those chains to select the best option and the time taken doing that would cause the event queue to back up.\r\n\r\nWhat's not clear however is whether a leak in the target chains caused the problem or if it was a symptom of an earlier problem. Running locally the target chain tracking seems to be working fine. Will add a metric to report the number of tracked chains so we have more info.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1267858404/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
