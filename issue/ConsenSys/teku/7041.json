{
  "url": "https://api.github.com/repos/ConsenSys/teku/issues/7041",
  "repository_url": "https://api.github.com/repos/ConsenSys/teku",
  "labels_url": "https://api.github.com/repos/ConsenSys/teku/issues/7041/labels{/name}",
  "comments_url": "https://api.github.com/repos/ConsenSys/teku/issues/7041/comments",
  "events_url": "https://api.github.com/repos/ConsenSys/teku/issues/7041/events",
  "html_url": "https://github.com/ConsenSys/teku/issues/7041",
  "id": 1670126852,
  "node_id": "I_kwDOCM9I9M5jjB0E",
  "number": 7041,
  "title": "Slow processing of blocks with multiple voluntary exit operations",
  "user": {
    "login": "lucassaldanha",
    "id": 1766440,
    "node_id": "MDQ6VXNlcjE3NjY0NDA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1766440?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/lucassaldanha",
    "html_url": "https://github.com/lucassaldanha",
    "followers_url": "https://api.github.com/users/lucassaldanha/followers",
    "following_url": "https://api.github.com/users/lucassaldanha/following{/other_user}",
    "gists_url": "https://api.github.com/users/lucassaldanha/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/lucassaldanha/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/lucassaldanha/subscriptions",
    "organizations_url": "https://api.github.com/users/lucassaldanha/orgs",
    "repos_url": "https://api.github.com/users/lucassaldanha/repos",
    "events_url": "https://api.github.com/users/lucassaldanha/events{/privacy}",
    "received_events_url": "https://api.github.com/users/lucassaldanha/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1048919129,
      "node_id": "MDU6TGFiZWwxMDQ4OTE5MTI5",
      "url": "https://api.github.com/repos/ConsenSys/teku/labels/bug%20%F0%9F%90%9E",
      "name": "bug üêû",
      "color": "dd6c94",
      "default": false,
      "description": "Something isn't working"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "rolfyone",
    "id": 2967240,
    "node_id": "MDQ6VXNlcjI5NjcyNDA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2967240?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/rolfyone",
    "html_url": "https://github.com/rolfyone",
    "followers_url": "https://api.github.com/users/rolfyone/followers",
    "following_url": "https://api.github.com/users/rolfyone/following{/other_user}",
    "gists_url": "https://api.github.com/users/rolfyone/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/rolfyone/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rolfyone/subscriptions",
    "organizations_url": "https://api.github.com/users/rolfyone/orgs",
    "repos_url": "https://api.github.com/users/rolfyone/repos",
    "events_url": "https://api.github.com/users/rolfyone/events{/privacy}",
    "received_events_url": "https://api.github.com/users/rolfyone/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "rolfyone",
      "id": 2967240,
      "node_id": "MDQ6VXNlcjI5NjcyNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2967240?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rolfyone",
      "html_url": "https://github.com/rolfyone",
      "followers_url": "https://api.github.com/users/rolfyone/followers",
      "following_url": "https://api.github.com/users/rolfyone/following{/other_user}",
      "gists_url": "https://api.github.com/users/rolfyone/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rolfyone/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rolfyone/subscriptions",
      "organizations_url": "https://api.github.com/users/rolfyone/orgs",
      "repos_url": "https://api.github.com/users/rolfyone/repos",
      "events_url": "https://api.github.com/users/rolfyone/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rolfyone/received_events",
      "type": "User",
      "site_admin": false
    },
    {
      "login": "tbenr",
      "id": 15999009,
      "node_id": "MDQ6VXNlcjE1OTk5MDA5",
      "avatar_url": "https://avatars.githubusercontent.com/u/15999009?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tbenr",
      "html_url": "https://github.com/tbenr",
      "followers_url": "https://api.github.com/users/tbenr/followers",
      "following_url": "https://api.github.com/users/tbenr/following{/other_user}",
      "gists_url": "https://api.github.com/users/tbenr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tbenr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tbenr/subscriptions",
      "organizations_url": "https://api.github.com/users/tbenr/orgs",
      "repos_url": "https://api.github.com/users/tbenr/repos",
      "events_url": "https://api.github.com/users/tbenr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tbenr/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2023-04-16T20:41:07Z",
  "updated_at": "2023-04-18T12:45:42Z",
  "closed_at": "2023-04-18T12:45:41Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "### Description\nWe discovered this during our investigations post-Capella. The voluntary exit code path has never been in the critical path of block processing, now due to the growing number of validators exiting, more blocks with multiple exits exist.\n\nThis behaviour has been observed in our own nodes and multiple discord users have reported it as well.\n\ne.g.\n```\n21:34:04.195 WARN  - Late Block Import *** Block: 17995607bcfee97f8f7ab71a0096d4272c60342a54fbb57352dbe84672ba5f4d (6216468) proposer 473561 arrival 2673ms, pre-state_retrieved +14ms, processed +2496ms, execution_payload_result_received +0ms, begin_importing +0ms, transaction_prepared +1ms, transaction_committed +0ms, completed +11ms\n```\n\n### Steps to Reproduce (Bug)\nMainnet issue.\n\n**Expected behavior:** Stable block processing time, no late blocks warnings.\n\n**Actual behavior:** Increased block processing time. Lots of late block import warnings.\n\n**Frequency:** [How regularly does it occur?]\nOften. Hard to predict if the volume of exits will drop or not. In any case we need to fix this.\n\n### Versions (Add all that apply)\n* 23.3.1 and previous versions",
  "closed_by": {
    "login": "tbenr",
    "id": 15999009,
    "node_id": "MDQ6VXNlcjE1OTk5MDA5",
    "avatar_url": "https://avatars.githubusercontent.com/u/15999009?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tbenr",
    "html_url": "https://github.com/tbenr",
    "followers_url": "https://api.github.com/users/tbenr/followers",
    "following_url": "https://api.github.com/users/tbenr/following{/other_user}",
    "gists_url": "https://api.github.com/users/tbenr/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tbenr/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tbenr/subscriptions",
    "organizations_url": "https://api.github.com/users/tbenr/orgs",
    "repos_url": "https://api.github.com/users/tbenr/repos",
    "events_url": "https://api.github.com/users/tbenr/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tbenr/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/7041/reactions",
    "total_count": 1,
    "+1": 1,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ConsenSys/teku/issues/7041/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1510481141",
    "html_url": "https://github.com/ConsenSys/teku/issues/7041#issuecomment-1510481141",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/7041",
    "id": 1510481141,
    "node_id": "IC_kwDOCM9I9M5aCBz1",
    "user": {
      "login": "lucassaldanha",
      "id": 1766440,
      "node_id": "MDQ6VXNlcjE3NjY0NDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1766440?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/lucassaldanha",
      "html_url": "https://github.com/lucassaldanha",
      "followers_url": "https://api.github.com/users/lucassaldanha/followers",
      "following_url": "https://api.github.com/users/lucassaldanha/following{/other_user}",
      "gists_url": "https://api.github.com/users/lucassaldanha/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/lucassaldanha/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/lucassaldanha/subscriptions",
      "organizations_url": "https://api.github.com/users/lucassaldanha/orgs",
      "repos_url": "https://api.github.com/users/lucassaldanha/repos",
      "events_url": "https://api.github.com/users/lucassaldanha/events{/privacy}",
      "received_events_url": "https://api.github.com/users/lucassaldanha/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-16T20:42:16Z",
    "updated_at": "2023-04-16T20:43:05Z",
    "author_association": "MEMBER",
    "body": "Notice we had a spike in the processed time even before the Capella activation.\n\n![plot - block processed time and volutary exits.png](https://images.zenhubusercontent.com/5e7019978ec11b7684ec1dd8/3e499479-f49f-40fc-a58b-e968855e1ab8)",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1510481141/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1510481383",
    "html_url": "https://github.com/ConsenSys/teku/issues/7041#issuecomment-1510481383",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/7041",
    "id": 1510481383,
    "node_id": "IC_kwDOCM9I9M5aCB3n",
    "user": {
      "login": "lucassaldanha",
      "id": 1766440,
      "node_id": "MDQ6VXNlcjE3NjY0NDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1766440?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/lucassaldanha",
      "html_url": "https://github.com/lucassaldanha",
      "followers_url": "https://api.github.com/users/lucassaldanha/followers",
      "following_url": "https://api.github.com/users/lucassaldanha/following{/other_user}",
      "gists_url": "https://api.github.com/users/lucassaldanha/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/lucassaldanha/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/lucassaldanha/subscriptions",
      "organizations_url": "https://api.github.com/users/lucassaldanha/orgs",
      "repos_url": "https://api.github.com/users/lucassaldanha/repos",
      "events_url": "https://api.github.com/users/lucassaldanha/events{/privacy}",
      "received_events_url": "https://api.github.com/users/lucassaldanha/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-16T20:43:39Z",
    "updated_at": "2023-04-16T20:43:39Z",
    "author_association": "MEMBER",
    "body": "@tbenr has done some timing test and has confirmed the correlation between slow processed time and the number of exit operations in the block.",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1510481383/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1510488223",
    "html_url": "https://github.com/ConsenSys/teku/issues/7041#issuecomment-1510488223",
    "issue_url": "https://api.github.com/repos/ConsenSys/teku/issues/7041",
    "id": 1510488223,
    "node_id": "IC_kwDOCM9I9M5aCDif",
    "user": {
      "login": "lucassaldanha",
      "id": 1766440,
      "node_id": "MDQ6VXNlcjE3NjY0NDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1766440?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/lucassaldanha",
      "html_url": "https://github.com/lucassaldanha",
      "followers_url": "https://api.github.com/users/lucassaldanha/followers",
      "following_url": "https://api.github.com/users/lucassaldanha/following{/other_user}",
      "gists_url": "https://api.github.com/users/lucassaldanha/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/lucassaldanha/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/lucassaldanha/subscriptions",
      "organizations_url": "https://api.github.com/users/lucassaldanha/orgs",
      "repos_url": "https://api.github.com/users/lucassaldanha/repos",
      "events_url": "https://api.github.com/users/lucassaldanha/events{/privacy}",
      "received_events_url": "https://api.github.com/users/lucassaldanha/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-16T21:06:50Z",
    "updated_at": "2023-04-16T21:06:50Z",
    "author_association": "MEMBER",
    "body": "Quick note on this: not every Late Block Import error is related to this issue. Most of the time, a late block warning is because we receive the block already pretty late from gossip, and don't really have time to process it timely.\r\n\r\nFor example, in this error message, block arrival is almost 6 seconds into the slot!!! It isn't teku's fault! :)\r\n```\r\nBlock: d0f90ad8e68cc6b30d602b2cdf4986b7346e6fa94446d3e1a8f751bade31a91c (6237869) proposer 268010 arrival 5881ms, pre-state_retrieved +10ms, processed +794ms, execution_payload_result_received +814ms, begin_importing +0ms, transaction_prepared +0ms, transaction_committed +0ms, completed +32ms\r\n```\r\n\r\nThe problem this ticket is concerned about is when the block is timely, but we take too long to process it. The important part of the warning message, in this case, is `processed +XXXms`.  We saw some instances where teku was taking almost 3 seconds to process the block and this is unacceptable.\r\n\r\nFor reference, an example of slow processing (2357ms):\r\n```\r\nLate Block Import *** Block: e4e23cf14a255fa302433f16e59d7fe93a5a9f4ba75b8b4969660978d635524a (6210849) proposer 98719 arrival 1935ms, pre-state_retrieved +9ms, processed +2357ms, execution_payload_result_received +0ms, begin_importing +0ms, transaction_prepared +1ms, transaction_committed +0ms, completed +70ms\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/ConsenSys/teku/issues/comments/1510488223/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
