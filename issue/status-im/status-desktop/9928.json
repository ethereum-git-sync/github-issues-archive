{
  "url": "https://api.github.com/repos/status-im/status-desktop/issues/9928",
  "repository_url": "https://api.github.com/repos/status-im/status-desktop",
  "labels_url": "https://api.github.com/repos/status-im/status-desktop/issues/9928/labels{/name}",
  "comments_url": "https://api.github.com/repos/status-im/status-desktop/issues/9928/comments",
  "events_url": "https://api.github.com/repos/status-im/status-desktop/issues/9928/events",
  "html_url": "https://github.com/status-im/status-desktop/issues/9928",
  "id": 1628502654,
  "node_id": "I_kwDOD5KrTM5hEPp-",
  "number": 9928,
  "title": "Same message text sometimes appears twice in waku v2 desktop app",
  "user": {
    "login": "burnettk",
    "id": 18027,
    "node_id": "MDQ6VXNlcjE4MDI3",
    "avatar_url": "https://avatars.githubusercontent.com/u/18027?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/burnettk",
    "html_url": "https://github.com/burnettk",
    "followers_url": "https://api.github.com/users/burnettk/followers",
    "following_url": "https://api.github.com/users/burnettk/following{/other_user}",
    "gists_url": "https://api.github.com/users/burnettk/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/burnettk/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/burnettk/subscriptions",
    "organizations_url": "https://api.github.com/users/burnettk/orgs",
    "repos_url": "https://api.github.com/users/burnettk/repos",
    "events_url": "https://api.github.com/users/burnettk/events{/privacy}",
    "received_events_url": "https://api.github.com/users/burnettk/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 2036563458,
      "node_id": "MDU6TGFiZWwyMDM2NTYzNDU4",
      "url": "https://api.github.com/repos/status-im/status-desktop/labels/bug",
      "name": "bug",
      "color": "d73a4a",
      "default": true,
      "description": "Something isn't working"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2023-03-17T00:29:13Z",
  "updated_at": "2023-03-28T16:44:42Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "# Bug Report\r\n\r\n## Description\r\n\r\nMessages sometimes appear twice in waku v2 desktop app.\r\n\r\n## Steps to reproduce\r\n\r\nWe are sending messages using [this client](https://github.com/status-im/spiffworkflow-connector/blob/master/connectors/connector-waku/connector_waku/commands/sendMessage.py). It communicates with [this waku node](https://github.com/status-im/status-go/tree/develop/cmd/spiff-workflow) which has an RPC endpoint where we send these two types of messages:\r\n\r\n * wakuext_addContact \r\n * wakuext_sendOneToOneMessage\r\n\r\n#### Expected behavior\r\n\r\nWhen one message is sent, one message is shown in the desktop app.\r\n\r\n#### Actual behavior\r\n\r\nSometimes, but not always, message with same contents is shown twice in the desktop app.\r\n\r\n### Additional Information\r\n\r\n- Status desktop version: 0.9.0\r\n- Operating System: Windows / Mac.\r\n\r\nWe have done some analysis, including looking at the logs of our system, and can't say for sure, but we couldn't see any issues on our side (like actually sending the http request twice, etc). I didn't see a similar report when I searched for \"double\" and \"duplicate\" in the github issues. Has this sort of issue been seen before? Thank you.",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/status-im/status-desktop/issues/9928/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/status-im/status-desktop/issues/9928/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/status-im/status-desktop/issues/comments/1474144040",
    "html_url": "https://github.com/status-im/status-desktop/issues/9928#issuecomment-1474144040",
    "issue_url": "https://api.github.com/repos/status-im/status-desktop/issues/9928",
    "id": 1474144040,
    "node_id": "IC_kwDOD5KrTM5X3aco",
    "user": {
      "login": "jrainville",
      "id": 11926403,
      "node_id": "MDQ6VXNlcjExOTI2NDAz",
      "avatar_url": "https://avatars.githubusercontent.com/u/11926403?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jrainville",
      "html_url": "https://github.com/jrainville",
      "followers_url": "https://api.github.com/users/jrainville/followers",
      "following_url": "https://api.github.com/users/jrainville/following{/other_user}",
      "gists_url": "https://api.github.com/users/jrainville/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jrainville/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jrainville/subscriptions",
      "organizations_url": "https://api.github.com/users/jrainville/orgs",
      "repos_url": "https://api.github.com/users/jrainville/repos",
      "events_url": "https://api.github.com/users/jrainville/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jrainville/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-17T17:06:33Z",
    "updated_at": "2023-03-17T17:06:33Z",
    "author_association": "MEMBER",
    "body": "Maybe it's an issue with `wakuext_sendOneToOneMessage`. We don't use it anymore. Now we use `wakuext_sendChatMessage` for all messages. Maybe it will help? See https://github.com/status-im/status-desktop/blob/master/src/backend/chat.nim#L53\r\n\r\nOtherwise, maybe it's some sort of problem with how you need to be mutual contact to send and receive messages in 1-1 chats on Desktop?\r\nDo you send messages before that mutual condition is reached?\r\n\r\nOtherwise, do I understand correctly that you call `wakuext_addContact` for each send message? If so, that probably causes some weird behaviour.\r\nLike I said above, the only pre-requisite to chat in a 1-1 is that both accounts added each other as contact (what we call mutual).\r\n\r\nHope it helps ",
    "reactions": {
      "url": "https://api.github.com/repos/status-im/status-desktop/issues/comments/1474144040/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/status-im/status-desktop/issues/comments/1487268171",
    "html_url": "https://github.com/status-im/status-desktop/issues/9928#issuecomment-1487268171",
    "issue_url": "https://api.github.com/repos/status-im/status-desktop/issues/9928",
    "id": 1487268171,
    "node_id": "IC_kwDOD5KrTM5YpelL",
    "user": {
      "login": "burnettk",
      "id": 18027,
      "node_id": "MDQ6VXNlcjE4MDI3",
      "avatar_url": "https://avatars.githubusercontent.com/u/18027?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/burnettk",
      "html_url": "https://github.com/burnettk",
      "followers_url": "https://api.github.com/users/burnettk/followers",
      "following_url": "https://api.github.com/users/burnettk/following{/other_user}",
      "gists_url": "https://api.github.com/users/burnettk/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/burnettk/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/burnettk/subscriptions",
      "organizations_url": "https://api.github.com/users/burnettk/orgs",
      "repos_url": "https://api.github.com/users/burnettk/repos",
      "events_url": "https://api.github.com/users/burnettk/events{/privacy}",
      "received_events_url": "https://api.github.com/users/burnettk/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-28T16:44:41Z",
    "updated_at": "2023-03-28T16:44:41Z",
    "author_association": "NONE",
    "body": "thank you, @jrainville .\r\n\r\n1. regarding `wakuext_sendOneToOneMessage` and `wakuext_sendChatMessage`, I checked with @cammellos , who has been advising us with waku integration, and he indicates that \"underneath it just uses the same api call. basically the only extra thing that [wakuext_sendOneToOneMessage] does is to create a chat. generally you would have to make 2 rpc, create chat first, and send message. this one adds both.\" So I guess `sendOneToOneMessage` is a convenience wrapper around `sendChatMessage`.\r\n\r\n2. Yes, you are understanding correctly that we call `wakuext_addContact` for each message. This is not the greatest thing in the world, since normally it's not necessary, and there was some discussion about this in the SpiffWorkflow discord on 12 Feb 2023, where @harmeet-status and @cammellos were discussing that it would be possible to `query for the contacts, and only if it's not in the contacts, send a contact request`, but we had agreed at that time to defer this optimization. We haven't seen any other side effects, and back messages are all delivered as soon as the recipient accepts the contact request. So we can't rule out the multiple `wakuext_addContact` requests as the cause of the text appearing twice, but I guess it's probably in \"unlikely to be the root cause\" territory.",
    "reactions": {
      "url": "https://api.github.com/repos/status-im/status-desktop/issues/comments/1487268171/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
