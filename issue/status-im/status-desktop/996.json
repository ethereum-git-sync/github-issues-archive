{
  "url": "https://api.github.com/repos/status-im/status-desktop/issues/996",
  "repository_url": "https://api.github.com/repos/status-im/status-desktop",
  "labels_url": "https://api.github.com/repos/status-im/status-desktop/issues/996/labels{/name}",
  "comments_url": "https://api.github.com/repos/status-im/status-desktop/issues/996/comments",
  "events_url": "https://api.github.com/repos/status-im/status-desktop/issues/996/events",
  "html_url": "https://github.com/status-im/status-desktop/issues/996",
  "id": 707693838,
  "node_id": "MDU6SXNzdWU3MDc2OTM4Mzg=",
  "number": 996,
  "title": "Bug: Spawning threads inside of an event handler that eventually calls a `nim-status` method crashes app",
  "user": {
    "login": "emizzle",
    "id": 5089238,
    "node_id": "MDQ6VXNlcjUwODkyMzg=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5089238?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/emizzle",
    "html_url": "https://github.com/emizzle",
    "followers_url": "https://api.github.com/users/emizzle/followers",
    "following_url": "https://api.github.com/users/emizzle/following{/other_user}",
    "gists_url": "https://api.github.com/users/emizzle/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/emizzle/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/emizzle/subscriptions",
    "organizations_url": "https://api.github.com/users/emizzle/orgs",
    "repos_url": "https://api.github.com/users/emizzle/repos",
    "events_url": "https://api.github.com/users/emizzle/events{/privacy}",
    "received_events_url": "https://api.github.com/users/emizzle/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 2036563458,
      "node_id": "MDU6TGFiZWwyMDM2NTYzNDU4",
      "url": "https://api.github.com/repos/status-im/status-desktop/labels/bug",
      "name": "bug",
      "color": "d73a4a",
      "default": true,
      "description": "Something isn't working"
    },
    {
      "id": 2347610790,
      "node_id": "MDU6TGFiZWwyMzQ3NjEwNzkw",
      "url": "https://api.github.com/repos/status-im/status-desktop/labels/Chat",
      "name": "Chat",
      "color": "9279e0",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "emizzle",
    "id": 5089238,
    "node_id": "MDQ6VXNlcjUwODkyMzg=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5089238?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/emizzle",
    "html_url": "https://github.com/emizzle",
    "followers_url": "https://api.github.com/users/emizzle/followers",
    "following_url": "https://api.github.com/users/emizzle/following{/other_user}",
    "gists_url": "https://api.github.com/users/emizzle/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/emizzle/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/emizzle/subscriptions",
    "organizations_url": "https://api.github.com/users/emizzle/orgs",
    "repos_url": "https://api.github.com/users/emizzle/repos",
    "events_url": "https://api.github.com/users/emizzle/events{/privacy}",
    "received_events_url": "https://api.github.com/users/emizzle/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "richard-ramos",
      "id": 1106587,
      "node_id": "MDQ6VXNlcjExMDY1ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1106587?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/richard-ramos",
      "html_url": "https://github.com/richard-ramos",
      "followers_url": "https://api.github.com/users/richard-ramos/followers",
      "following_url": "https://api.github.com/users/richard-ramos/following{/other_user}",
      "gists_url": "https://api.github.com/users/richard-ramos/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/richard-ramos/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/richard-ramos/subscriptions",
      "organizations_url": "https://api.github.com/users/richard-ramos/orgs",
      "repos_url": "https://api.github.com/users/richard-ramos/repos",
      "events_url": "https://api.github.com/users/richard-ramos/events{/privacy}",
      "received_events_url": "https://api.github.com/users/richard-ramos/received_events",
      "type": "User",
      "site_admin": false
    },
    {
      "login": "emizzle",
      "id": 5089238,
      "node_id": "MDQ6VXNlcjUwODkyMzg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5089238?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/emizzle",
      "html_url": "https://github.com/emizzle",
      "followers_url": "https://api.github.com/users/emizzle/followers",
      "following_url": "https://api.github.com/users/emizzle/following{/other_user}",
      "gists_url": "https://api.github.com/users/emizzle/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/emizzle/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/emizzle/subscriptions",
      "organizations_url": "https://api.github.com/users/emizzle/orgs",
      "repos_url": "https://api.github.com/users/emizzle/repos",
      "events_url": "https://api.github.com/users/emizzle/events{/privacy}",
      "received_events_url": "https://api.github.com/users/emizzle/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2020-09-23T21:33:46Z",
  "updated_at": "2020-11-30T14:22:46Z",
  "closed_at": "2020-11-30T14:22:46Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "Seems to be another threading issue :neutral_face: The issue arises when spawning threads inside an event handler: https://github.com/status-im/nim-status-client/blob/8648688f2acde44f022932f23058320303bf8898/src/app/chat/core.nim#L45-L47\r\n\r\nInside the spawned thread, `self.view.obtainAvailableStickerPacks()` calls a `nim-status` method: https://github.com/status-im/nim-status-client/blob/8648688f2acde44f022932f23058320303bf8898/src/app/chat/view.nim#L128-L136\r\n`status_stickers.getAvailableStickerPacks()` eventually calls a `nim-status` method (`callPrivateRPC`).\r\n\r\nThe stack trace looks like it's actually hitting an error inside of the `eventemitter` lib, which makes me wonder if that lib is trying to access memory that has been GC'd:\r\n```\r\nDBG 2020-09-23 13:23:10+10:00 callPrivateRPC                             topics=\"rpc\" tid=4099335 file=core.nim:22 rpc_method=eth_call\r\n/Users/emizzle/repos/github.com/status-im/nim-status-client/src/nim_status_client.nim(167) nim_status_client\r\n/Users/emizzle/repos/github.com/status-im/nim-status-client/src/nim_status_client.nim(164) mainProc\r\n/Users/emizzle/repos/github.com/status-im/nim-status-client/vendor/nimqml/src/nimqml/private/qapplication.nim(8) exec\r\n/Users/emizzle/repos/github.com/status-im/nim-status-client/vendor/nimqml/src/nimqml/private/qobject.nim(49) qobjectCallback\r\n/Users/emizzle/repos/github.com/status-im/nim-status-client/vendor/nimqml/src/nimqml/private/qobject.nim(34) onSlotCalled\r\n/Users/emizzle/repos/github.com/status-im/nim-status-client/vendor/nimbus-build-system/vendor/Nim/lib/core/macros.nim(566) onSlotCalled\r\n/Users/emizzle/repos/github.com/status-im/nim-status-client/src/status/signals/core.nim(72) receiveSignal\r\n/Users/emizzle/repos/github.com/status-im/nim-status-client/src/status/signals/core.nim(67) processSignal\r\n/Users/emizzle/repos/github.com/status-im/nim-status-client/vendor/eventemitter/src/eventemitter.nim(30) emit\r\n/Users/emizzle/repos/github.com/status-im/nim-status-client/vendor/eventemitter/src/eventemitter.nim(34) emit\r\n/Users/emizzle/repos/github.com/status-im/nim-status-client/src/app/node/core.nim(31) :anonymous\r\n/Users/emizzle/repos/github.com/status-im/nim-status-client/src/status/network.nim(21) peerSummaryChange\r\n/Users/emizzle/repos/github.com/status-im/nim-status-client/vendor/eventemitter/src/eventemitter.nim(30) emit\r\n/Users/emizzle/repos/github.com/status-im/nim-status-client/vendor/eventemitter/src/eventemitter.nim(34) emit\r\n/Users/emizzle/repos/github.com/status-im/nim-status-client/vendor/nimbus-build-system/vendor/Nim/lib/system/fatal.nim(49) sysFatal\r\nError: unhandled exception: index 2 not in 0 .. 1 [IndexError]\r\n```\r\n\r\nAs you can see in the code snippets above, I tried marking everything inside of the spawned thread as `{.gcsafe.}`, however it had no effect.\r\n```\r\nself.status.events.once(\"network:connected\") do(e: Args):\r\n    {.gcsafe.}:\r\n      debugEcho \">>> [chat/core.init] network connected event, obtaining sticker packs\"\r\n      self.view.obtainAvailableStickerPacks()\r\n```\r\nI printed `debugEcho` statements to find the culprit, and it essentially did not surpass `let response = nim_status.callPrivateRPC($inputJSON)`, so that makes me think that possibly the error is actually inside of `nim-status`.\r\n\r\n### `lldb` trace\r\n```\r\nDBG 2020-09-24 17:56:10+10:00 callPrivateRPC                             topics=\"rpc\" tid=4644683 file=core.nim:22 rpc_method=eth_call\r\nQtCore was compiled with optimization - stepping may behave oddly; variables may not be available.\r\nProcess 78958 stopped\r\n* thread #1, queue = 'com.apple.main-thread', stop reason = EXC_BAD_ACCESS (code=EXC_I386_GPFLT)\r\n    frame #0: 0x000000010281c980 QtCore`QObject::~QObject() [inlined] QObjectPrivate::Sender::receiverDeleted() at qobject_p.h:219:29 [opt]\r\n```",
  "closed_by": {
    "login": "iurimatias",
    "id": 176720,
    "node_id": "MDQ6VXNlcjE3NjcyMA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/176720?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/iurimatias",
    "html_url": "https://github.com/iurimatias",
    "followers_url": "https://api.github.com/users/iurimatias/followers",
    "following_url": "https://api.github.com/users/iurimatias/following{/other_user}",
    "gists_url": "https://api.github.com/users/iurimatias/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/iurimatias/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/iurimatias/subscriptions",
    "organizations_url": "https://api.github.com/users/iurimatias/orgs",
    "repos_url": "https://api.github.com/users/iurimatias/repos",
    "events_url": "https://api.github.com/users/iurimatias/events{/privacy}",
    "received_events_url": "https://api.github.com/users/iurimatias/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/status-im/status-desktop/issues/996/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/status-im/status-desktop/issues/996/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/status-im/status-desktop/issues/comments/698988427",
    "html_url": "https://github.com/status-im/status-desktop/issues/996#issuecomment-698988427",
    "issue_url": "https://api.github.com/repos/status-im/status-desktop/issues/996",
    "id": 698988427,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY5ODk4ODQyNw==",
    "user": {
      "login": "michaelsbradleyjr",
      "id": 194260,
      "node_id": "MDQ6VXNlcjE5NDI2MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/194260?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelsbradleyjr",
      "html_url": "https://github.com/michaelsbradleyjr",
      "followers_url": "https://api.github.com/users/michaelsbradleyjr/followers",
      "following_url": "https://api.github.com/users/michaelsbradleyjr/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelsbradleyjr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelsbradleyjr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelsbradleyjr/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelsbradleyjr/orgs",
      "repos_url": "https://api.github.com/users/michaelsbradleyjr/repos",
      "events_url": "https://api.github.com/users/michaelsbradleyjr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelsbradleyjr/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-09-25T15:16:16Z",
    "updated_at": "2020-09-25T15:16:16Z",
    "author_association": "CONTRIBUTOR",
    "body": "```\r\nstop reason = EXC_BAD_ACCESS (code=EXC_I386_GPFLT)\r\n    frame #0: 0x000000010281c980 QtCore`QObject::~QObject() [inlined] QObjectPrivate::Sender::receiverDeleted() at qobject_p.h:219:29 [opt]\r\n```\r\n\r\nThat's the \"signature\" of the same memory corruption bug that @richard-ramos and I have been looking into, hopefully we'll get some more insights next week with the help of the Nimbus team.",
    "reactions": {
      "url": "https://api.github.com/repos/status-im/status-desktop/issues/comments/698988427/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/status-im/status-desktop/issues/comments/735815402",
    "html_url": "https://github.com/status-im/status-desktop/issues/996#issuecomment-735815402",
    "issue_url": "https://api.github.com/repos/status-im/status-desktop/issues/996",
    "id": 735815402,
    "node_id": "MDEyOklzc3VlQ29tbWVudDczNTgxNTQwMg==",
    "user": {
      "login": "iurimatias",
      "id": 176720,
      "node_id": "MDQ6VXNlcjE3NjcyMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/176720?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/iurimatias",
      "html_url": "https://github.com/iurimatias",
      "followers_url": "https://api.github.com/users/iurimatias/followers",
      "following_url": "https://api.github.com/users/iurimatias/following{/other_user}",
      "gists_url": "https://api.github.com/users/iurimatias/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/iurimatias/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/iurimatias/subscriptions",
      "organizations_url": "https://api.github.com/users/iurimatias/orgs",
      "repos_url": "https://api.github.com/users/iurimatias/repos",
      "events_url": "https://api.github.com/users/iurimatias/events{/privacy}",
      "received_events_url": "https://api.github.com/users/iurimatias/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-11-30T14:22:34Z",
    "updated_at": "2020-11-30T14:22:34Z",
    "author_association": "MEMBER",
    "body": "partially done / superseded by task-runner https://github.com/status-im/nim-task-runner/issues/3",
    "reactions": {
      "url": "https://api.github.com/repos/status-im/status-desktop/issues/comments/735815402/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
