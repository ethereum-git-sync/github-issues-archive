{
  "url": "https://api.github.com/repos/status-im/status-mobile/issues/7097",
  "repository_url": "https://api.github.com/repos/status-im/status-mobile",
  "labels_url": "https://api.github.com/repos/status-im/status-mobile/issues/7097/labels{/name}",
  "comments_url": "https://api.github.com/repos/status-im/status-mobile/issues/7097/comments",
  "events_url": "https://api.github.com/repos/status-im/status-mobile/issues/7097/events",
  "html_url": "https://github.com/status-im/status-mobile/issues/7097",
  "id": 390996393,
  "node_id": "MDU6SXNzdWUzOTA5OTYzOTM=",
  "number": 7097,
  "title": "Messages not loaded from the database if out-of-order messages are received",
  "user": {
    "login": "cammellos",
    "id": 1017008,
    "node_id": "MDQ6VXNlcjEwMTcwMDg=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1017008?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/cammellos",
    "html_url": "https://github.com/cammellos",
    "followers_url": "https://api.github.com/users/cammellos/followers",
    "following_url": "https://api.github.com/users/cammellos/following{/other_user}",
    "gists_url": "https://api.github.com/users/cammellos/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/cammellos/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/cammellos/subscriptions",
    "organizations_url": "https://api.github.com/users/cammellos/orgs",
    "repos_url": "https://api.github.com/users/cammellos/repos",
    "events_url": "https://api.github.com/users/cammellos/events{/privacy}",
    "received_events_url": "https://api.github.com/users/cammellos/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 795655580,
      "node_id": "MDU6TGFiZWw3OTU2NTU1ODA=",
      "url": "https://api.github.com/repos/status-im/status-mobile/labels/chat",
      "name": "chat",
      "color": "f70cb0",
      "default": false,
      "description": null
    },
    {
      "id": 1126212882,
      "node_id": "MDU6TGFiZWwxMTI2MjEyODgy",
      "url": "https://api.github.com/repos/status-im/status-mobile/labels/chat-reliability",
      "name": "chat-reliability",
      "color": "9df2dd",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "cammellos",
    "id": 1017008,
    "node_id": "MDQ6VXNlcjEwMTcwMDg=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1017008?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/cammellos",
    "html_url": "https://github.com/cammellos",
    "followers_url": "https://api.github.com/users/cammellos/followers",
    "following_url": "https://api.github.com/users/cammellos/following{/other_user}",
    "gists_url": "https://api.github.com/users/cammellos/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/cammellos/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/cammellos/subscriptions",
    "organizations_url": "https://api.github.com/users/cammellos/orgs",
    "repos_url": "https://api.github.com/users/cammellos/repos",
    "events_url": "https://api.github.com/users/cammellos/events{/privacy}",
    "received_events_url": "https://api.github.com/users/cammellos/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "cammellos",
      "id": 1017008,
      "node_id": "MDQ6VXNlcjEwMTcwMDg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1017008?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cammellos",
      "html_url": "https://github.com/cammellos",
      "followers_url": "https://api.github.com/users/cammellos/followers",
      "following_url": "https://api.github.com/users/cammellos/following{/other_user}",
      "gists_url": "https://api.github.com/users/cammellos/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cammellos/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cammellos/subscriptions",
      "organizations_url": "https://api.github.com/users/cammellos/orgs",
      "repos_url": "https://api.github.com/users/cammellos/repos",
      "events_url": "https://api.github.com/users/cammellos/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cammellos/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2018-12-14T07:28:21Z",
  "updated_at": "2018-12-25T08:32:58Z",
  "closed_at": "2018-12-25T08:32:58Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "Some messages are not loaded from the database if messages with an older timestamp are received (from the mailserver for example).\r\n\r\n### Step to replicate\r\nThe steps to  replicate are a bit artificial, this is the simplest way, but fetching old messages from the mailserver might also result in this behavior, or receiving a message from a peer with the clock set to the wrong time.\r\n\r\n1) Post 100 messages (1,2,3,4,5...) in a public chat\r\n2) Make sure all those messages are on device A\r\n3) Change your time to -1 day\r\n4) Login/Logout\r\n5) Go to that chat, do not scroll up\r\n6) Post a few messages (5)\r\n7) Scroll up, there should be some gaps in messages\r\n\r\nLogin/logout should fix the issue and those messages should appear again.\r\n\r\n### Details\r\n\r\nThis is due to the fact that we use the count of messages loaded to paginate, but the collection underneath (and our count as well) change with the receiving of messages, which leads to unstable pagination.\r\n\r\nA possible solution is to use a cursor `clock-value-message-id` and use that to paginate (no skipping, you always fetch the last x messages that have a cursor value > last-clock-value fetched). This might lead to empty pages (pages full of duplicates) if old messages are received and the request will have to be retried, but at least it won't be resulting in skipped messages (which has an impact on the user, unlike empty pages that can be retried).",
  "closed_by": {
    "login": "rasom",
    "id": 2364994,
    "node_id": "MDQ6VXNlcjIzNjQ5OTQ=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2364994?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/rasom",
    "html_url": "https://github.com/rasom",
    "followers_url": "https://api.github.com/users/rasom/followers",
    "following_url": "https://api.github.com/users/rasom/following{/other_user}",
    "gists_url": "https://api.github.com/users/rasom/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/rasom/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rasom/subscriptions",
    "organizations_url": "https://api.github.com/users/rasom/orgs",
    "repos_url": "https://api.github.com/users/rasom/repos",
    "events_url": "https://api.github.com/users/rasom/events{/privacy}",
    "received_events_url": "https://api.github.com/users/rasom/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/status-im/status-mobile/issues/7097/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/status-im/status-mobile/issues/7097/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/447367816",
    "html_url": "https://github.com/status-im/status-mobile/issues/7097#issuecomment-447367816",
    "issue_url": "https://api.github.com/repos/status-im/status-mobile/issues/7097",
    "id": 447367816,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ0NzM2NzgxNg==",
    "user": {
      "login": "churik",
      "id": 4557972,
      "node_id": "MDQ6VXNlcjQ1NTc5NzI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4557972?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/churik",
      "html_url": "https://github.com/churik",
      "followers_url": "https://api.github.com/users/churik/followers",
      "following_url": "https://api.github.com/users/churik/following{/other_user}",
      "gists_url": "https://api.github.com/users/churik/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/churik/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/churik/subscriptions",
      "organizations_url": "https://api.github.com/users/churik/orgs",
      "repos_url": "https://api.github.com/users/churik/repos",
      "events_url": "https://api.github.com/users/churik/events{/privacy}",
      "received_events_url": "https://api.github.com/users/churik/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-12-14T15:58:34Z",
    "updated_at": "2018-12-14T15:58:34Z",
    "author_association": "MEMBER",
    "body": "@cammellos yeah, this is way to reproduce the issue what @rasom told recently.\r\nBasically on this case I got:\r\n-  messages are shown as sent several times  after scrolling down;\r\n- these messages are shown at the end of other chats when I'm switching between them;\r\n- after  setting automatic date and login\\logout issue messages are shown as sent yesterday you can switch between chats normally.\r\nLogs:\r\n[Status_r.log](https://github.com/status-im/status-react/files/2680759/Status_r.log)\r\n[geth.log](https://github.com/status-im/status-react/files/2680761/geth.log)\r\n\r\n<img width=\"568\" alt=\"messages_old\" src=\"https://user-images.githubusercontent.com/4557972/50013206-d65ca680-ffc0-11e8-9a4d-55ca2f81d9af.png\">\r\n<img width=\"568\" alt=\"older\" src=\"https://user-images.githubusercontent.com/4557972/50013453-76b2cb00-ffc1-11e8-877d-d3c8b06b3e87.png\">\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/447367816/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
