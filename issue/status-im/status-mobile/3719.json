{
  "url": "https://api.github.com/repos/status-im/status-mobile/issues/3719",
  "repository_url": "https://api.github.com/repos/status-im/status-mobile",
  "labels_url": "https://api.github.com/repos/status-im/status-mobile/issues/3719/labels{/name}",
  "comments_url": "https://api.github.com/repos/status-im/status-mobile/issues/3719/comments",
  "events_url": "https://api.github.com/repos/status-im/status-mobile/issues/3719/events",
  "html_url": "https://github.com/status-im/status-mobile/issues/3719",
  "id": 309439331,
  "node_id": "MDU6SXNzdWUzMDk0MzkzMzE=",
  "number": 3719,
  "title": "Cleared message history reappears in Group and Public chats with all received messages",
  "user": {
    "login": "Serhy",
    "id": 8749671,
    "node_id": "MDQ6VXNlcjg3NDk2NzE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/8749671?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Serhy",
    "html_url": "https://github.com/Serhy",
    "followers_url": "https://api.github.com/users/Serhy/followers",
    "following_url": "https://api.github.com/users/Serhy/following{/other_user}",
    "gists_url": "https://api.github.com/users/Serhy/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Serhy/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Serhy/subscriptions",
    "organizations_url": "https://api.github.com/users/Serhy/orgs",
    "repos_url": "https://api.github.com/users/Serhy/repos",
    "events_url": "https://api.github.com/users/Serhy/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Serhy/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 330296931,
      "node_id": "MDU6TGFiZWwzMzAyOTY5MzE=",
      "url": "https://api.github.com/repos/status-im/status-mobile/labels/bug",
      "name": "bug",
      "color": "fc2929",
      "default": true,
      "description": null
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "janherich",
    "id": 1910609,
    "node_id": "MDQ6VXNlcjE5MTA2MDk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1910609?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/janherich",
    "html_url": "https://github.com/janherich",
    "followers_url": "https://api.github.com/users/janherich/followers",
    "following_url": "https://api.github.com/users/janherich/following{/other_user}",
    "gists_url": "https://api.github.com/users/janherich/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/janherich/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/janherich/subscriptions",
    "organizations_url": "https://api.github.com/users/janherich/orgs",
    "repos_url": "https://api.github.com/users/janherich/repos",
    "events_url": "https://api.github.com/users/janherich/events{/privacy}",
    "received_events_url": "https://api.github.com/users/janherich/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "janherich",
      "id": 1910609,
      "node_id": "MDQ6VXNlcjE5MTA2MDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1910609?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/janherich",
      "html_url": "https://github.com/janherich",
      "followers_url": "https://api.github.com/users/janherich/followers",
      "following_url": "https://api.github.com/users/janherich/following{/other_user}",
      "gists_url": "https://api.github.com/users/janherich/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/janherich/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/janherich/subscriptions",
      "organizations_url": "https://api.github.com/users/janherich/orgs",
      "repos_url": "https://api.github.com/users/janherich/repos",
      "events_url": "https://api.github.com/users/janherich/events{/privacy}",
      "received_events_url": "https://api.github.com/users/janherich/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 7,
  "created_at": "2018-03-28T16:25:37Z",
  "updated_at": "2018-04-13T10:00:58Z",
  "closed_at": "2018-04-13T10:00:58Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "\r\n***Type***: Bug\r\n\r\n***Summary***: Cleared chat history reappears after contact re-log in with all received messages prior chat history in the Group/Public chat\r\n\r\n#### Expected behavior\r\nNo reappearance of cleared message history after re-login in Group and Public chats\r\n#### Actual behavior\r\nReappearance of cleared message history after re-login  in Group and Public chats with all **received** messages\r\n\r\n### Reproduction\r\n\r\n- Log in to Status on Device 1 and Device 2 as 'Contact 1' and 'Contact 2' respectively\r\n- Contact 1 adds Contact 2 in contacts \r\n- Contact 1 creates Group Chat with Contact 2\r\n- Contact 1 and Contact 2 joins the same Public Chat (e.g. `newprotocolworks`\r\n- Contact 1 sends 10 messages in Group Chat\r\n- Contact 1 sends 10 messages in Public Chat\r\n- Contact 2 navigates to Group Chat and clears it's history\r\n- Contact 2 navigates to Public Chat and clears it's history\r\n- Contact 2 re-logins and stays on Home screen\r\n\r\n### Additional Information\r\nStatus version: b33bd65\r\nOperating System: Android and iOS\r\n\r\n#### Logs\r\nTF session with logs from Android (Contact2 in above scenario): https://app.testfairy.com/projects/4803622-status/builds/7985879/sessions/49/?accessToken=DvEKf92szvy4Hiq7cE5z2cq7zw8\r\n",
  "closed_by": {
    "login": "Serhy",
    "id": 8749671,
    "node_id": "MDQ6VXNlcjg3NDk2NzE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/8749671?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Serhy",
    "html_url": "https://github.com/Serhy",
    "followers_url": "https://api.github.com/users/Serhy/followers",
    "following_url": "https://api.github.com/users/Serhy/following{/other_user}",
    "gists_url": "https://api.github.com/users/Serhy/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Serhy/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Serhy/subscriptions",
    "organizations_url": "https://api.github.com/users/Serhy/orgs",
    "repos_url": "https://api.github.com/users/Serhy/repos",
    "events_url": "https://api.github.com/users/Serhy/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Serhy/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/status-im/status-mobile/issues/3719/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/status-im/status-mobile/issues/3719/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/376990711",
    "html_url": "https://github.com/status-im/status-mobile/issues/3719#issuecomment-376990711",
    "issue_url": "https://api.github.com/repos/status-im/status-mobile/issues/3719",
    "id": 376990711,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM3Njk5MDcxMQ==",
    "user": {
      "login": "cammellos",
      "id": 1017008,
      "node_id": "MDQ6VXNlcjEwMTcwMDg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1017008?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cammellos",
      "html_url": "https://github.com/cammellos",
      "followers_url": "https://api.github.com/users/cammellos/followers",
      "following_url": "https://api.github.com/users/cammellos/following{/other_user}",
      "gists_url": "https://api.github.com/users/cammellos/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cammellos/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cammellos/subscriptions",
      "organizations_url": "https://api.github.com/users/cammellos/orgs",
      "repos_url": "https://api.github.com/users/cammellos/repos",
      "events_url": "https://api.github.com/users/cammellos/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cammellos/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-03-28T18:34:16Z",
    "updated_at": "2018-03-28T18:34:16Z",
    "author_association": "MEMBER",
    "body": "@Serhy I can replicate in current develop (public chats), can you do the same?",
    "reactions": {
      "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/376990711/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/377694562",
    "html_url": "https://github.com/status-im/status-mobile/issues/3719#issuecomment-377694562",
    "issue_url": "https://api.github.com/repos/status-im/status-mobile/issues/3719",
    "id": 377694562,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM3NzY5NDU2Mg==",
    "user": {
      "login": "yevh-berdnyk",
      "id": 29711298,
      "node_id": "MDQ6VXNlcjI5NzExMjk4",
      "avatar_url": "https://avatars.githubusercontent.com/u/29711298?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/yevh-berdnyk",
      "html_url": "https://github.com/yevh-berdnyk",
      "followers_url": "https://api.github.com/users/yevh-berdnyk/followers",
      "following_url": "https://api.github.com/users/yevh-berdnyk/following{/other_user}",
      "gists_url": "https://api.github.com/users/yevh-berdnyk/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/yevh-berdnyk/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/yevh-berdnyk/subscriptions",
      "organizations_url": "https://api.github.com/users/yevh-berdnyk/orgs",
      "repos_url": "https://api.github.com/users/yevh-berdnyk/repos",
      "events_url": "https://api.github.com/users/yevh-berdnyk/events{/privacy}",
      "received_events_url": "https://api.github.com/users/yevh-berdnyk/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-03-31T13:52:18Z",
    "updated_at": "2018-03-31T13:52:18Z",
    "author_association": "CONTRIBUTOR",
    "body": "@Serhy, @cammellos, I've also reproduced it in nightly build ",
    "reactions": {
      "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/377694562/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/377916401",
    "html_url": "https://github.com/status-im/status-mobile/issues/3719#issuecomment-377916401",
    "issue_url": "https://api.github.com/repos/status-im/status-mobile/issues/3719",
    "id": 377916401,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM3NzkxNjQwMQ==",
    "user": {
      "login": "Serhy",
      "id": 8749671,
      "node_id": "MDQ6VXNlcjg3NDk2NzE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8749671?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Serhy",
      "html_url": "https://github.com/Serhy",
      "followers_url": "https://api.github.com/users/Serhy/followers",
      "following_url": "https://api.github.com/users/Serhy/following{/other_user}",
      "gists_url": "https://api.github.com/users/Serhy/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Serhy/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Serhy/subscriptions",
      "organizations_url": "https://api.github.com/users/Serhy/orgs",
      "repos_url": "https://api.github.com/users/Serhy/repos",
      "events_url": "https://api.github.com/users/Serhy/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Serhy/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-04-02T12:07:40Z",
    "updated_at": "2018-04-02T12:07:40Z",
    "author_association": "CONTRIBUTOR",
    "body": "Retested the scenario from description on 323rd Jenkins nightly build and could not reproduce it on Android and iOS. ",
    "reactions": {
      "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/377916401/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/378272877",
    "html_url": "https://github.com/status-im/status-mobile/issues/3719#issuecomment-378272877",
    "issue_url": "https://api.github.com/repos/status-im/status-mobile/issues/3719",
    "id": 378272877,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM3ODI3Mjg3Nw==",
    "user": {
      "login": "janherich",
      "id": 1910609,
      "node_id": "MDQ6VXNlcjE5MTA2MDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1910609?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/janherich",
      "html_url": "https://github.com/janherich",
      "followers_url": "https://api.github.com/users/janherich/followers",
      "following_url": "https://api.github.com/users/janherich/following{/other_user}",
      "gists_url": "https://api.github.com/users/janherich/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/janherich/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/janherich/subscriptions",
      "organizations_url": "https://api.github.com/users/janherich/orgs",
      "repos_url": "https://api.github.com/users/janherich/repos",
      "events_url": "https://api.github.com/users/janherich/events{/privacy}",
      "received_events_url": "https://api.github.com/users/janherich/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-04-03T14:37:09Z",
    "updated_at": "2018-04-03T14:42:31Z",
    "author_association": "CONTRIBUTOR",
    "body": "The issue is fixed in `experiment/new-protocol-app` branch @Serhy .\r\nIt was little bit more tricky, because the root cause of the issue (which is for sure present in develop as well, it's just not reproducible 100% of time) is the fact the we need to know past message ids to be able to reject them when they are received again - once we truly hard delete messages from app-db and realm, there is no way to know that we ever received them - so when we start app again, request messages from offline inbox servers and those old messages are received (we unfortunately can't rely on offline inboxing being accurate and only delivering messages which were sent to us while we were offline, we always just receive *all* the messages and it's our responsibility to filter out those we already have), we have no way to distinguish that we don't want to receive \"cleared\" messages, so they are received and displayed again.\r\nThe (hacky) solution is not hard delete messages when clearing history, only set the `:show?` property to false, that way they will be effectively hidden from UI, while we still have knowledge about them and can protect against receiving them again.\r\nMuch better and more efficient solution would be to rely on last clock value for such things, but as it won't work for public/group chats currently, we can't use it, but we should revisit the implementation in the future.",
    "reactions": {
      "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/378272877/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/378279006",
    "html_url": "https://github.com/status-im/status-mobile/issues/3719#issuecomment-378279006",
    "issue_url": "https://api.github.com/repos/status-im/status-mobile/issues/3719",
    "id": 378279006,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM3ODI3OTAwNg==",
    "user": {
      "login": "Serhy",
      "id": 8749671,
      "node_id": "MDQ6VXNlcjg3NDk2NzE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8749671?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Serhy",
      "html_url": "https://github.com/Serhy",
      "followers_url": "https://api.github.com/users/Serhy/followers",
      "following_url": "https://api.github.com/users/Serhy/following{/other_user}",
      "gists_url": "https://api.github.com/users/Serhy/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Serhy/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Serhy/subscriptions",
      "organizations_url": "https://api.github.com/users/Serhy/orgs",
      "repos_url": "https://api.github.com/users/Serhy/repos",
      "events_url": "https://api.github.com/users/Serhy/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Serhy/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-04-03T14:54:14Z",
    "updated_at": "2018-04-03T14:54:14Z",
    "author_association": "CONTRIBUTOR",
    "body": "Thanks a lot, @janherich for clarification! \r\nSo as the the issue in Develop and new-protocol-app and fixed in the experiment/new-protocol-app - we can close the issue after new-protocol is merged and we validate bug is gone in Develop. \r\n\r\nHowever, I'll check it in scope of `experiment/new-protocol-app`. ",
    "reactions": {
      "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/378279006/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/378323136",
    "html_url": "https://github.com/status-im/status-mobile/issues/3719#issuecomment-378323136",
    "issue_url": "https://api.github.com/repos/status-im/status-mobile/issues/3719",
    "id": 378323136,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM3ODMyMzEzNg==",
    "user": {
      "login": "Serhy",
      "id": 8749671,
      "node_id": "MDQ6VXNlcjg3NDk2NzE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8749671?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Serhy",
      "html_url": "https://github.com/Serhy",
      "followers_url": "https://api.github.com/users/Serhy/followers",
      "following_url": "https://api.github.com/users/Serhy/following{/other_user}",
      "gists_url": "https://api.github.com/users/Serhy/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Serhy/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Serhy/subscriptions",
      "organizations_url": "https://api.github.com/users/Serhy/orgs",
      "repos_url": "https://api.github.com/users/Serhy/repos",
      "events_url": "https://api.github.com/users/Serhy/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Serhy/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-04-03T17:02:37Z",
    "updated_at": "2018-04-03T17:02:40Z",
    "author_association": "CONTRIBUTOR",
    "body": "In the next builds Android: https://i.diawi.com/xXkFsd and iOS: https://i.diawi.com/dTtQ2K (194th Jenkins build) issue not reproduced anymore! \r\nThe only exception is that I wasn't able to check GroupChat on non-admin side due to app crash - described in https://github.com/status-im/status-react/issues/3702#issuecomment-378319563 \r\n\r\nOnce it passes develop along with the test covered GroupChat - we are good!\n\n<blockquote><div><strong><a href=\"https://i.diawi.com/xXkFsd\">Install - Diawi - Development and In-house Apps Wireless Installation</a></strong></div></blockquote>\n<blockquote><div><strong><a href=\"https://i.diawi.com/dTtQ2K\">Install - Diawi - Development and In-house Apps Wireless Installation</a></strong></div></blockquote>",
    "reactions": {
      "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/378323136/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/381088182",
    "html_url": "https://github.com/status-im/status-mobile/issues/3719#issuecomment-381088182",
    "issue_url": "https://api.github.com/repos/status-im/status-mobile/issues/3719",
    "id": 381088182,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM4MTA4ODE4Mg==",
    "user": {
      "login": "Serhy",
      "id": 8749671,
      "node_id": "MDQ6VXNlcjg3NDk2NzE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8749671?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Serhy",
      "html_url": "https://github.com/Serhy",
      "followers_url": "https://api.github.com/users/Serhy/followers",
      "following_url": "https://api.github.com/users/Serhy/following{/other_user}",
      "gists_url": "https://api.github.com/users/Serhy/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Serhy/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Serhy/subscriptions",
      "organizations_url": "https://api.github.com/users/Serhy/orgs",
      "repos_url": "https://api.github.com/users/Serhy/repos",
      "events_url": "https://api.github.com/users/Serhy/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Serhy/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-04-13T10:00:58Z",
    "updated_at": "2018-04-13T10:00:58Z",
    "author_association": "CONTRIBUTOR",
    "body": "Tested in latest nightly - can't reproduce anymore. Cleared message history in Group/Public chat doesn't re-appear.\r\nHappy to close it!",
    "reactions": {
      "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/381088182/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
