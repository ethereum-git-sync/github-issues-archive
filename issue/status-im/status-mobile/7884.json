{
  "url": "https://api.github.com/repos/status-im/status-mobile/issues/7884",
  "repository_url": "https://api.github.com/repos/status-im/status-mobile",
  "labels_url": "https://api.github.com/repos/status-im/status-mobile/issues/7884/labels{/name}",
  "comments_url": "https://api.github.com/repos/status-im/status-mobile/issues/7884/comments",
  "events_url": "https://api.github.com/repos/status-im/status-mobile/issues/7884/events",
  "html_url": "https://github.com/status-im/status-mobile/issues/7884",
  "id": 428713388,
  "node_id": "MDU6SXNzdWU0Mjg3MTMzODg=",
  "number": 7884,
  "title": "Clock value is from the past",
  "user": {
    "login": "adambabik",
    "id": 277870,
    "node_id": "MDQ6VXNlcjI3Nzg3MA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/277870?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/adambabik",
    "html_url": "https://github.com/adambabik",
    "followers_url": "https://api.github.com/users/adambabik/followers",
    "following_url": "https://api.github.com/users/adambabik/following{/other_user}",
    "gists_url": "https://api.github.com/users/adambabik/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/adambabik/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/adambabik/subscriptions",
    "organizations_url": "https://api.github.com/users/adambabik/orgs",
    "repos_url": "https://api.github.com/users/adambabik/repos",
    "events_url": "https://api.github.com/users/adambabik/events{/privacy}",
    "received_events_url": "https://api.github.com/users/adambabik/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1143032367,
      "node_id": "MDU6TGFiZWwxMTQzMDMyMzY3",
      "url": "https://api.github.com/repos/status-im/status-mobile/labels/core",
      "name": "core",
      "color": "8befdd",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2019-04-03T11:28:05Z",
  "updated_at": "2020-09-17T12:26:56Z",
  "closed_at": "2020-09-17T12:26:56Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "# Problem\n\nFor `#status` chat, I observed a very strange `clock` values for some envelopes from a particular account.\n\nTake a look:\n```\nAccount   | Envelope Hash   | Clock value     | Timestamp            | Message\n------------------------------------------------------------------------------\n0x03f8fa8 | Hash = 0xf75bb3 | 155426119985601 | 03 Apr 19 05:13 CEST | Ping\n0x03f8fa8 | Hash = 0x55358a | 155426119985601 | 03 Apr 19 05:13 CEST | Ping\n0x03f8fa8 | Hash = 0xf75bb3 | 155426119985601 | 03 Apr 19 05:13 CEST | Ping\n...\n0x03f8fa8 | Hash = 0xdbef95 | 155614702284313 | 02 Apr 19 13:04 CEST | Me too\n0x03f8fa8 | Hash = 0x98bcfd | 155614702284319 | 02 Apr 19 13:08 CEST | The messages are apprearing in past\n...\n0x03f8fa8 | Hash = 0x174870 | 155614702284321 | 02 Apr 19 13:09 CEST | Some messages\n0x03f8fa8 | Hash = 0x7ff065 | 155614702284322 | 02 Apr 19 13:20 CEST | See https://notes.status.im/uploads/upload_67d7f92b11acd559b9eae8bbe259cf43.jpg\n```\n\n# Notes\n\nIt looks like some old clock value was initially calculated and only later updated to the correct one.\n\ncc @annadanchenko",
  "closed_by": {
    "login": "cammellos",
    "id": 1017008,
    "node_id": "MDQ6VXNlcjEwMTcwMDg=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1017008?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/cammellos",
    "html_url": "https://github.com/cammellos",
    "followers_url": "https://api.github.com/users/cammellos/followers",
    "following_url": "https://api.github.com/users/cammellos/following{/other_user}",
    "gists_url": "https://api.github.com/users/cammellos/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/cammellos/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/cammellos/subscriptions",
    "organizations_url": "https://api.github.com/users/cammellos/orgs",
    "repos_url": "https://api.github.com/users/cammellos/repos",
    "events_url": "https://api.github.com/users/cammellos/events{/privacy}",
    "received_events_url": "https://api.github.com/users/cammellos/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/status-im/status-mobile/issues/7884/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/status-im/status-mobile/issues/7884/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/479455061",
    "html_url": "https://github.com/status-im/status-mobile/issues/7884#issuecomment-479455061",
    "issue_url": "https://api.github.com/repos/status-im/status-mobile/issues/7884",
    "id": 479455061,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ3OTQ1NTA2MQ==",
    "user": {
      "login": "cammellos",
      "id": 1017008,
      "node_id": "MDQ6VXNlcjEwMTcwMDg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1017008?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cammellos",
      "html_url": "https://github.com/cammellos",
      "followers_url": "https://api.github.com/users/cammellos/followers",
      "following_url": "https://api.github.com/users/cammellos/following{/other_user}",
      "gists_url": "https://api.github.com/users/cammellos/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cammellos/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cammellos/subscriptions",
      "organizations_url": "https://api.github.com/users/cammellos/orgs",
      "repos_url": "https://api.github.com/users/cammellos/repos",
      "events_url": "https://api.github.com/users/cammellos/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cammellos/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-04-03T11:47:05Z",
    "updated_at": "2019-04-03T11:47:05Z",
    "author_association": "MEMBER",
    "body": "@adambabik not sure I read this correctly, but roughly looks correct, your concern is that:\r\n\r\n`155426119985601`\r\n\r\nis much smaller than\r\n\r\n`155614702284313` \r\n\r\n?",
    "reactions": {
      "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/479455061/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/479455948",
    "html_url": "https://github.com/status-im/status-mobile/issues/7884#issuecomment-479455948",
    "issue_url": "https://api.github.com/repos/status-im/status-mobile/issues/7884",
    "id": 479455948,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ3OTQ1NTk0OA==",
    "user": {
      "login": "adambabik",
      "id": 277870,
      "node_id": "MDQ6VXNlcjI3Nzg3MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/277870?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/adambabik",
      "html_url": "https://github.com/adambabik",
      "followers_url": "https://api.github.com/users/adambabik/followers",
      "following_url": "https://api.github.com/users/adambabik/following{/other_user}",
      "gists_url": "https://api.github.com/users/adambabik/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/adambabik/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/adambabik/subscriptions",
      "organizations_url": "https://api.github.com/users/adambabik/orgs",
      "repos_url": "https://api.github.com/users/adambabik/repos",
      "events_url": "https://api.github.com/users/adambabik/events{/privacy}",
      "received_events_url": "https://api.github.com/users/adambabik/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-04-03T11:50:05Z",
    "updated_at": "2019-04-04T09:04:49Z",
    "author_association": "CONTRIBUTOR",
    "body": "Yeah and the fact that there are other messages sent around the same time\r\nwith higher clock value by others.\r\n\r\nIt might be correct behavior but if so I wonder how the mobile client\r\nhandles it.\r\n\r\nThat person also complained that the order of messages is incorrect for\r\nhis/her.",
    "reactions": {
      "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/479455948/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/479458716",
    "html_url": "https://github.com/status-im/status-mobile/issues/7884#issuecomment-479458716",
    "issue_url": "https://api.github.com/repos/status-im/status-mobile/issues/7884",
    "id": 479458716,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ3OTQ1ODcxNg==",
    "user": {
      "login": "cammellos",
      "id": 1017008,
      "node_id": "MDQ6VXNlcjEwMTcwMDg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1017008?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cammellos",
      "html_url": "https://github.com/cammellos",
      "followers_url": "https://api.github.com/users/cammellos/followers",
      "following_url": "https://api.github.com/users/cammellos/following{/other_user}",
      "gists_url": "https://api.github.com/users/cammellos/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cammellos/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cammellos/subscriptions",
      "organizations_url": "https://api.github.com/users/cammellos/orgs",
      "repos_url": "https://api.github.com/users/cammellos/repos",
      "events_url": "https://api.github.com/users/cammellos/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cammellos/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-04-03T11:59:06Z",
    "updated_at": "2019-04-03T11:59:06Z",
    "author_association": "MEMBER",
    "body": "Ok, so in terms of clock values:\r\n\r\nWe use lamport timestamps for ordering as it's one way to achieve causal ordering.\r\n\r\nBasically clock value of a new message is equal to `last-clock-value-in-a-chat + 1`.\r\n\r\nIf there's no clock value (i.e you never fetched any message from the chat, see those `ping` messages), we initialize that with a `timestamp` (instead of 0), but since it's a logic clock, the actual `clock-value` of the chat might be higher (that's the case in #status), so it will be ordered in the past (that's unfortunately is unavoidable).\r\nSo that explains the ordering.\r\n\r\nThe fact that they are displayed in the notification bar I believe is a bug, although they should be marked as new messages, I can see if I can replicate.\r\n\r\nThere's also an open bug on ordering as some code sorts messages by timestamp, which it should not, but that's a different issue.",
    "reactions": {
      "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/479458716/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/479815601",
    "html_url": "https://github.com/status-im/status-mobile/issues/7884#issuecomment-479815601",
    "issue_url": "https://api.github.com/repos/status-im/status-mobile/issues/7884",
    "id": 479815601,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ3OTgxNTYwMQ==",
    "user": {
      "login": "adambabik",
      "id": 277870,
      "node_id": "MDQ6VXNlcjI3Nzg3MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/277870?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/adambabik",
      "html_url": "https://github.com/adambabik",
      "followers_url": "https://api.github.com/users/adambabik/followers",
      "following_url": "https://api.github.com/users/adambabik/following{/other_user}",
      "gists_url": "https://api.github.com/users/adambabik/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/adambabik/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/adambabik/subscriptions",
      "organizations_url": "https://api.github.com/users/adambabik/orgs",
      "repos_url": "https://api.github.com/users/adambabik/repos",
      "events_url": "https://api.github.com/users/adambabik/events{/privacy}",
      "received_events_url": "https://api.github.com/users/adambabik/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-04-04T09:08:07Z",
    "updated_at": "2019-04-04T09:08:07Z",
    "author_association": "CONTRIBUTOR",
    "body": "> but since it's a logic clock, the actual clock-value of the chat might be higher (that's the case in #status), so it will be ordered in the past (that's unfortunately is unavoidable).\r\n\r\nThat makes sense, I wanted to confirm that there is no \"heuristic\" that would try to rearrange messages if any new appear in the chat or something like that. And we don't have any UI that would suggest waiting until the request for message before sending new messages? \r\n\r\nThis is pretty common case I would say. When working on the console client, it's pretty common to see a few messages out of order every day.",
    "reactions": {
      "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/479815601/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/479817475",
    "html_url": "https://github.com/status-im/status-mobile/issues/7884#issuecomment-479817475",
    "issue_url": "https://api.github.com/repos/status-im/status-mobile/issues/7884",
    "id": 479817475,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ3OTgxNzQ3NQ==",
    "user": {
      "login": "cammellos",
      "id": 1017008,
      "node_id": "MDQ6VXNlcjEwMTcwMDg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1017008?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cammellos",
      "html_url": "https://github.com/cammellos",
      "followers_url": "https://api.github.com/users/cammellos/followers",
      "following_url": "https://api.github.com/users/cammellos/following{/other_user}",
      "gists_url": "https://api.github.com/users/cammellos/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cammellos/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cammellos/subscriptions",
      "organizations_url": "https://api.github.com/users/cammellos/orgs",
      "repos_url": "https://api.github.com/users/cammellos/repos",
      "events_url": "https://api.github.com/users/cammellos/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cammellos/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-04-04T09:13:45Z",
    "updated_at": "2019-04-04T09:13:45Z",
    "author_association": "MEMBER",
    "body": "Currently we don't have that, but there's an outstanding PR moving in that direction https://github.com/status-im/status-react/pull/7663 although is only for empty chats.\r\nAlso currently we have too much room for messages with high clock value (1 month), and we should shrink that to something more sensible (a day or even less), but we need to wait for #status to normalize first, and possibly use NTP time for the timestamp component of the clock value.",
    "reactions": {
      "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/479817475/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
