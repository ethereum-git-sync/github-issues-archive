{
  "url": "https://api.github.com/repos/status-im/status-mobile/issues/14173",
  "repository_url": "https://api.github.com/repos/status-im/status-mobile",
  "labels_url": "https://api.github.com/repos/status-im/status-mobile/issues/14173/labels{/name}",
  "comments_url": "https://api.github.com/repos/status-im/status-mobile/issues/14173/comments",
  "events_url": "https://api.github.com/repos/status-im/status-mobile/issues/14173/events",
  "html_url": "https://github.com/status-im/status-mobile/issues/14173",
  "id": 1413322541,
  "node_id": "I_kwDOAx4p2c5UPZct",
  "number": 14173,
  "title": "Incorrect pagination of notifications",
  "user": {
    "login": "ilmotta",
    "id": 46027,
    "node_id": "MDQ6VXNlcjQ2MDI3",
    "avatar_url": "https://avatars.githubusercontent.com/u/46027?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ilmotta",
    "html_url": "https://github.com/ilmotta",
    "followers_url": "https://api.github.com/users/ilmotta/followers",
    "following_url": "https://api.github.com/users/ilmotta/following{/other_user}",
    "gists_url": "https://api.github.com/users/ilmotta/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ilmotta/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ilmotta/subscriptions",
    "organizations_url": "https://api.github.com/users/ilmotta/orgs",
    "repos_url": "https://api.github.com/users/ilmotta/repos",
    "events_url": "https://api.github.com/users/ilmotta/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ilmotta/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 330296931,
      "node_id": "MDU6TGFiZWwzMzAyOTY5MzE=",
      "url": "https://api.github.com/repos/status-im/status-mobile/labels/bug",
      "name": "bug",
      "color": "fc2929",
      "default": true,
      "description": null
    },
    {
      "id": 883447811,
      "node_id": "MDU6TGFiZWw4ODM0NDc4MTE=",
      "url": "https://api.github.com/repos/status-im/status-mobile/labels/status-go",
      "name": "status-go",
      "color": "59bee0",
      "default": false,
      "description": ""
    },
    {
      "id": 2948932638,
      "node_id": "MDU6TGFiZWwyOTQ4OTMyNjM4",
      "url": "https://api.github.com/repos/status-im/status-mobile/labels/Activity%20center",
      "name": "Activity center",
      "color": "d4c5f9",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "rasom",
    "id": 2364994,
    "node_id": "MDQ6VXNlcjIzNjQ5OTQ=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2364994?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/rasom",
    "html_url": "https://github.com/rasom",
    "followers_url": "https://api.github.com/users/rasom/followers",
    "following_url": "https://api.github.com/users/rasom/following{/other_user}",
    "gists_url": "https://api.github.com/users/rasom/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/rasom/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rasom/subscriptions",
    "organizations_url": "https://api.github.com/users/rasom/orgs",
    "repos_url": "https://api.github.com/users/rasom/repos",
    "events_url": "https://api.github.com/users/rasom/events{/privacy}",
    "received_events_url": "https://api.github.com/users/rasom/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "rasom",
      "id": 2364994,
      "node_id": "MDQ6VXNlcjIzNjQ5OTQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2364994?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rasom",
      "html_url": "https://github.com/rasom",
      "followers_url": "https://api.github.com/users/rasom/followers",
      "following_url": "https://api.github.com/users/rasom/following{/other_user}",
      "gists_url": "https://api.github.com/users/rasom/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rasom/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rasom/subscriptions",
      "organizations_url": "https://api.github.com/users/rasom/orgs",
      "repos_url": "https://api.github.com/users/rasom/repos",
      "events_url": "https://api.github.com/users/rasom/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rasom/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": {
    "url": "https://api.github.com/repos/status-im/status-mobile/milestones/62",
    "html_url": "https://github.com/status-im/status-mobile/milestone/62",
    "labels_url": "https://api.github.com/repos/status-im/status-mobile/milestones/62/labels",
    "id": 8714443,
    "node_id": "MI_kwDOAx4p2c4AhPjL",
    "number": 62,
    "title": "1.21.0-rc.1",
    "description": "",
    "creator": {
      "login": "cammellos",
      "id": 1017008,
      "node_id": "MDQ6VXNlcjEwMTcwMDg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1017008?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cammellos",
      "html_url": "https://github.com/cammellos",
      "followers_url": "https://api.github.com/users/cammellos/followers",
      "following_url": "https://api.github.com/users/cammellos/following{/other_user}",
      "gists_url": "https://api.github.com/users/cammellos/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cammellos/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cammellos/subscriptions",
      "organizations_url": "https://api.github.com/users/cammellos/orgs",
      "repos_url": "https://api.github.com/users/cammellos/repos",
      "events_url": "https://api.github.com/users/cammellos/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cammellos/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 0,
    "closed_issues": 114,
    "state": "closed",
    "created_at": "2022-12-02T16:12:04Z",
    "updated_at": "2023-02-27T11:06:34Z",
    "due_on": null,
    "closed_at": "2023-02-27T11:06:34Z"
  },
  "comments": 2,
  "created_at": "2022-10-18T14:23:53Z",
  "updated_at": "2023-01-27T08:05:53Z",
  "closed_at": "2023-01-27T08:05:53Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "# Bug Report\r\n\r\n## Problem \r\n\r\nRead/unread notifications are not properly paginated due to a mismatch in how the frontend decodes the cursor _\"string\"_ sent by the backend.\r\n\r\n#### Expected behavior\r\n\r\nWhen scrolling over notifications, the user should be able to see all existing notifications stored in the local DB.\r\n\r\n### Reproduction\r\n\r\nThere are many ways to reproduce this issue, because it happens with various combinations of notifications size and number of notifications per page.\r\n\r\n1. Open Status.\r\n2. Log in with a user with 3 notifications.\r\n3. Enable the new AC flag.\r\n4. Enable the new UI.\r\n5. Modify the code `status-im.activity-center.core/defaults` `:notifications-per-page` to 1.\r\n6. Open the new AC.\r\n7. Notice only two notifications are ever displayed.\r\n\r\n### Notes\r\n\r\nWe have pinpointed the issue to be related to how the mobile app decodes RPC responses, probably the Java code (for production env). Currently, status-go sends a `cursor` that's a DB concatenation of the zero-padded notification timestamp with its ID, but when the frontend decodes the cursor as UTF-8, it changes the precise sequence of bytes when it sends it back to fetch the next result set.\r\n\r\nIt's likely the case that only status-go will need the fix, because the mobile app doesn't manipulate the cursor, apart from storing in the app DB and sending it back to fetch subsequent pages.\r\n\r\n### Possible solution\r\n\r\nThere seems to be more than one way to solve this problem. It's recommended to bring it up to status-go folks to get more opinions, but one solution that fixed the problem was to store the notification IDs as strings instead of `types.HexBytes`. This solution would cause a _local_ breaking change in status-go.\r\n\r\nFor reference, here's how an ID is built:\r\n\r\n```go\r\n// MessageID calculates the messageID from author's compressed public key\r\n// and not encrypted but encoded payload.\r\nfunc MessageID(author *ecdsa.PublicKey, data []byte) types.HexBytes {\r\n    keyBytes := crypto.FromECDSAPub(author)\r\n    return types.HexBytes(crypto.Keccak256(append(keyBytes, data...)))\r\n}\r\n````\r\n\r\nWe should probably also consider changing the pagination implementation to use `<` instead of `<=` to catch out-of-order messages. See `protocol/activity_center_persistence.go#buildActivityCenterQuery`.",
  "closed_by": {
    "login": "rasom",
    "id": 2364994,
    "node_id": "MDQ6VXNlcjIzNjQ5OTQ=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2364994?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/rasom",
    "html_url": "https://github.com/rasom",
    "followers_url": "https://api.github.com/users/rasom/followers",
    "following_url": "https://api.github.com/users/rasom/following{/other_user}",
    "gists_url": "https://api.github.com/users/rasom/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/rasom/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rasom/subscriptions",
    "organizations_url": "https://api.github.com/users/rasom/orgs",
    "repos_url": "https://api.github.com/users/rasom/repos",
    "events_url": "https://api.github.com/users/rasom/events{/privacy}",
    "received_events_url": "https://api.github.com/users/rasom/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/status-im/status-mobile/issues/14173/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/status-im/status-mobile/issues/14173/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/1404796226",
    "html_url": "https://github.com/status-im/status-mobile/issues/14173#issuecomment-1404796226",
    "issue_url": "https://api.github.com/repos/status-im/status-mobile/issues/14173",
    "id": 1404796226,
    "node_id": "IC_kwDOAx4p2c5Tu31C",
    "user": {
      "login": "rasom",
      "id": 2364994,
      "node_id": "MDQ6VXNlcjIzNjQ5OTQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2364994?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rasom",
      "html_url": "https://github.com/rasom",
      "followers_url": "https://api.github.com/users/rasom/followers",
      "following_url": "https://api.github.com/users/rasom/following{/other_user}",
      "gists_url": "https://api.github.com/users/rasom/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rasom/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rasom/subscriptions",
      "organizations_url": "https://api.github.com/users/rasom/orgs",
      "repos_url": "https://api.github.com/users/rasom/repos",
      "events_url": "https://api.github.com/users/rasom/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rasom/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-01-26T10:16:24Z",
    "updated_at": "2023-01-26T10:46:32Z",
    "author_association": "MEMBER",
    "body": "I see two separate issues here.\r\n1) when `:notifications-per-page=1` `:on-end-reached` is not triggered after the first fetch likely because the second notification completely fits on screen and `flat-list` \"sees no reason\" to request more of them (to trigger `:on-end-reached`). When we have  `:notifications-per-page=8` or something this issue becomes irrelevant. \r\n2) in some particular cases, and that happens only with specific cursors, not with all of them, although in SQL query we have condition like `cursor <= parameters.cursor`, the record for which `cursor == parameters.cursor` is not selected and it doesn't make it to the result set (although it should). This second one might be related to encoding/decoding. Not sure though that \r\n     > probably the Java code\r\n \r\n     part is relevant because I reproduce this on iOS simulator.",
    "reactions": {
      "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/1404796226/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/1404870160",
    "html_url": "https://github.com/status-im/status-mobile/issues/14173#issuecomment-1404870160",
    "issue_url": "https://api.github.com/repos/status-im/status-mobile/issues/14173",
    "id": 1404870160,
    "node_id": "IC_kwDOAx4p2c5TvJ4Q",
    "user": {
      "login": "ilmotta",
      "id": 46027,
      "node_id": "MDQ6VXNlcjQ2MDI3",
      "avatar_url": "https://avatars.githubusercontent.com/u/46027?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ilmotta",
      "html_url": "https://github.com/ilmotta",
      "followers_url": "https://api.github.com/users/ilmotta/followers",
      "following_url": "https://api.github.com/users/ilmotta/following{/other_user}",
      "gists_url": "https://api.github.com/users/ilmotta/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ilmotta/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ilmotta/subscriptions",
      "organizations_url": "https://api.github.com/users/ilmotta/orgs",
      "repos_url": "https://api.github.com/users/ilmotta/repos",
      "events_url": "https://api.github.com/users/ilmotta/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ilmotta/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-01-26T11:22:58Z",
    "updated_at": "2023-01-26T11:22:58Z",
    "author_association": "CONTRIBUTOR",
    "body": ">when :notifications-per-page=1 :on-end-reached is not triggered after the first fetch likely because the second notification completely fits on screen and flat-list \"sees no reason\" to request more of them (to trigger :on-end-reached). When we have :notifications-per-page=8 or something this issue becomes irrelevant.\r\n\r\n@rasom, I tried to eliminate the mobile code from the equation, and back then I thought I eliminated the possibility that the mobile client was not requesting the next page correctly due to `on-end-reached`. Of course, you should double-check this, but in my experiments the problem was always that mobile was sending the cursor it received (without modification of course), but it was getting back missing notifications due to the encoding differences in the cursor.\r\n\r\n>This second one might be related to encoding/decoding. Not sure though that\r\n\r\nIt's very likely that it's related to encoding. There are many ways to see this. One is to copy the cursor generated by status-go and use it in mobile as a hardcoded string, and you'll see that mobile receives all notifications correctly. The point being that mobile doesn't touch the cursor, it only stores in the db and reuse it, so something much lower-level is going on.\r\n\r\nIt's been so long that I don't remember the details, but I believe the proposed solution worked well, but it might not be the best solution. @cammellos has context of this issue, as he helped me a lot in the investigation.",
    "reactions": {
      "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/1404870160/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
