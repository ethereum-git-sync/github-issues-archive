{
  "url": "https://api.github.com/repos/status-im/status-mobile/issues/13355",
  "repository_url": "https://api.github.com/repos/status-im/status-mobile",
  "labels_url": "https://api.github.com/repos/status-im/status-mobile/issues/13355/labels{/name}",
  "comments_url": "https://api.github.com/repos/status-im/status-mobile/issues/13355/comments",
  "events_url": "https://api.github.com/repos/status-im/status-mobile/issues/13355/events",
  "html_url": "https://github.com/status-im/status-mobile/issues/13355",
  "id": 1233954925,
  "node_id": "I_kwDOAx4p2c5JjKht",
  "number": 13355,
  "title": "Long time (5-15 sec) for loading chat messages",
  "user": {
    "login": "churik",
    "id": 4557972,
    "node_id": "MDQ6VXNlcjQ1NTc5NzI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4557972?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/churik",
    "html_url": "https://github.com/churik",
    "followers_url": "https://api.github.com/users/churik/followers",
    "following_url": "https://api.github.com/users/churik/following{/other_user}",
    "gists_url": "https://api.github.com/users/churik/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/churik/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/churik/subscriptions",
    "organizations_url": "https://api.github.com/users/churik/orgs",
    "repos_url": "https://api.github.com/users/churik/repos",
    "events_url": "https://api.github.com/users/churik/events{/privacy}",
    "received_events_url": "https://api.github.com/users/churik/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 330296931,
      "node_id": "MDU6TGFiZWwzMzAyOTY5MzE=",
      "url": "https://api.github.com/repos/status-im/status-mobile/labels/bug",
      "name": "bug",
      "color": "fc2929",
      "default": true,
      "description": null
    },
    {
      "id": 783781483,
      "node_id": "MDU6TGFiZWw3ODM3ODE0ODM=",
      "url": "https://api.github.com/repos/status-im/status-mobile/labels/performance",
      "name": "performance",
      "color": "dd3bd8",
      "default": false,
      "description": null
    },
    {
      "id": 3990911030,
      "node_id": "LA_kwDOAx4p2c7t4Hg2",
      "url": "https://api.github.com/repos/status-im/status-mobile/labels/E:Bugfixes",
      "name": "E:Bugfixes",
      "color": "32BD0C",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "flexsurfer",
    "id": 11790366,
    "node_id": "MDQ6VXNlcjExNzkwMzY2",
    "avatar_url": "https://avatars.githubusercontent.com/u/11790366?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/flexsurfer",
    "html_url": "https://github.com/flexsurfer",
    "followers_url": "https://api.github.com/users/flexsurfer/followers",
    "following_url": "https://api.github.com/users/flexsurfer/following{/other_user}",
    "gists_url": "https://api.github.com/users/flexsurfer/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/flexsurfer/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/flexsurfer/subscriptions",
    "organizations_url": "https://api.github.com/users/flexsurfer/orgs",
    "repos_url": "https://api.github.com/users/flexsurfer/repos",
    "events_url": "https://api.github.com/users/flexsurfer/events{/privacy}",
    "received_events_url": "https://api.github.com/users/flexsurfer/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "flexsurfer",
      "id": 11790366,
      "node_id": "MDQ6VXNlcjExNzkwMzY2",
      "avatar_url": "https://avatars.githubusercontent.com/u/11790366?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/flexsurfer",
      "html_url": "https://github.com/flexsurfer",
      "followers_url": "https://api.github.com/users/flexsurfer/followers",
      "following_url": "https://api.github.com/users/flexsurfer/following{/other_user}",
      "gists_url": "https://api.github.com/users/flexsurfer/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/flexsurfer/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/flexsurfer/subscriptions",
      "organizations_url": "https://api.github.com/users/flexsurfer/orgs",
      "repos_url": "https://api.github.com/users/flexsurfer/repos",
      "events_url": "https://api.github.com/users/flexsurfer/events{/privacy}",
      "received_events_url": "https://api.github.com/users/flexsurfer/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": {
    "url": "https://api.github.com/repos/status-im/status-mobile/milestones/59",
    "html_url": "https://github.com/status-im/status-mobile/milestone/59",
    "labels_url": "https://api.github.com/repos/status-im/status-mobile/milestones/59/labels",
    "id": 7721557,
    "node_id": "MI_kwDOAx4p2c4AddJV",
    "number": 59,
    "title": "Release 1.20",
    "description": "",
    "creator": {
      "login": "cammellos",
      "id": 1017008,
      "node_id": "MDQ6VXNlcjEwMTcwMDg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1017008?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cammellos",
      "html_url": "https://github.com/cammellos",
      "followers_url": "https://api.github.com/users/cammellos/followers",
      "following_url": "https://api.github.com/users/cammellos/following{/other_user}",
      "gists_url": "https://api.github.com/users/cammellos/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cammellos/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cammellos/subscriptions",
      "organizations_url": "https://api.github.com/users/cammellos/orgs",
      "repos_url": "https://api.github.com/users/cammellos/repos",
      "events_url": "https://api.github.com/users/cammellos/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cammellos/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 0,
    "closed_issues": 57,
    "state": "closed",
    "created_at": "2022-02-28T16:35:08Z",
    "updated_at": "2023-06-01T10:05:16Z",
    "due_on": null,
    "closed_at": "2022-12-02T16:06:03Z"
  },
  "comments": 9,
  "created_at": "2022-05-12T13:04:06Z",
  "updated_at": "2022-06-03T11:38:22Z",
  "closed_at": "2022-06-03T11:38:22Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "# Bug Report\r\n\r\n\r\n## Problem \r\nOriginally reported by user (discussion is [here](https://discord.com/channels/624205794384281629/704741763729850529/967599448559611975))\r\nAccording to the discussion, the 1-1 chat takes significant time (5-15 sec) to render the messages if the chat was re-entered by navigating back from the home screen (the app was upgraded from 1.18).\r\nCouldn't reproduce it.\r\n\r\n#### Expected behavior\r\nchat loads instantly\r\n\r\n#### Actual behavior\r\n5-15 sec\r\n\r\n### Reproduction\r\n**I didn't manage to reproduce it in 1-1 chat (20+ heavy audio, 50+ images)**\r\nVideo attached.\r\n\r\nhttps://user-images.githubusercontent.com/4557972/168080620-a141eca7-9305-4b57-b2cd-510d5c9129c0.mp4\r\n\r\n1) Open Status\r\n2) Open 1-1 chat\r\n3) Reopen app\r\n4) Go back and select chat from home screen\r\n\r\n### Additional Information\r\n\r\n- Status version: release 1.19 \r\n- Operating System: Android, iOS\r\n\r\n",
  "closed_by": {
    "login": "flexsurfer",
    "id": 11790366,
    "node_id": "MDQ6VXNlcjExNzkwMzY2",
    "avatar_url": "https://avatars.githubusercontent.com/u/11790366?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/flexsurfer",
    "html_url": "https://github.com/flexsurfer",
    "followers_url": "https://api.github.com/users/flexsurfer/followers",
    "following_url": "https://api.github.com/users/flexsurfer/following{/other_user}",
    "gists_url": "https://api.github.com/users/flexsurfer/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/flexsurfer/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/flexsurfer/subscriptions",
    "organizations_url": "https://api.github.com/users/flexsurfer/orgs",
    "repos_url": "https://api.github.com/users/flexsurfer/repos",
    "events_url": "https://api.github.com/users/flexsurfer/events{/privacy}",
    "received_events_url": "https://api.github.com/users/flexsurfer/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/status-im/status-mobile/issues/13355/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/status-im/status-mobile/issues/13355/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/1135715387",
    "html_url": "https://github.com/status-im/status-mobile/issues/13355#issuecomment-1135715387",
    "issue_url": "https://api.github.com/repos/status-im/status-mobile/issues/13355",
    "id": 1135715387,
    "node_id": "IC_kwDOAx4p2c5DsaQ7",
    "user": {
      "login": "flexsurfer",
      "id": 11790366,
      "node_id": "MDQ6VXNlcjExNzkwMzY2",
      "avatar_url": "https://avatars.githubusercontent.com/u/11790366?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/flexsurfer",
      "html_url": "https://github.com/flexsurfer",
      "followers_url": "https://api.github.com/users/flexsurfer/followers",
      "following_url": "https://api.github.com/users/flexsurfer/following{/other_user}",
      "gists_url": "https://api.github.com/users/flexsurfer/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/flexsurfer/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/flexsurfer/subscriptions",
      "organizations_url": "https://api.github.com/users/flexsurfer/orgs",
      "repos_url": "https://api.github.com/users/flexsurfer/repos",
      "events_url": "https://api.github.com/users/flexsurfer/events{/privacy}",
      "received_events_url": "https://api.github.com/users/flexsurfer/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-24T10:13:21Z",
    "updated_at": "2022-05-25T06:55:50Z",
    "author_association": "MEMBER",
    "body": "it can be replicated on the application with lots of messages (~90k messages)\r\n\r\ntimes on a slow android device\r\n\r\n```\r\nwakuext_chatMessages 141.55900000035763ms\r\nwakuext_emojiReactionsByChatID 1293.7240000069141ms (~1.2sec)\r\nwakuext_chatPinnedMessages 1286.5460000038147ms (~1.2sec)\r\nwakuext_markAllRead 1133.9249999970198ms (~1.2sec)\r\n```\r\n\r\nEDITED: it seems like sometimes methods \"waiting\" to be sent in batch, so most likely here `emojiReactionsByChatID` and. `chatPinnedMessages` \"waiting\" for  `markAllRead`, because `markAllRead` always shows this time, but other two sometimes shows ~50-80ms ",
    "reactions": {
      "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/1135715387/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/1135730708",
    "html_url": "https://github.com/status-im/status-mobile/issues/13355#issuecomment-1135730708",
    "issue_url": "https://api.github.com/repos/status-im/status-mobile/issues/13355",
    "id": 1135730708,
    "node_id": "IC_kwDOAx4p2c5DseAU",
    "user": {
      "login": "flexsurfer",
      "id": 11790366,
      "node_id": "MDQ6VXNlcjExNzkwMzY2",
      "avatar_url": "https://avatars.githubusercontent.com/u/11790366?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/flexsurfer",
      "html_url": "https://github.com/flexsurfer",
      "followers_url": "https://api.github.com/users/flexsurfer/followers",
      "following_url": "https://api.github.com/users/flexsurfer/following{/other_user}",
      "gists_url": "https://api.github.com/users/flexsurfer/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/flexsurfer/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/flexsurfer/subscriptions",
      "organizations_url": "https://api.github.com/users/flexsurfer/orgs",
      "repos_url": "https://api.github.com/users/flexsurfer/repos",
      "events_url": "https://api.github.com/users/flexsurfer/events{/privacy}",
      "received_events_url": "https://api.github.com/users/flexsurfer/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-24T10:24:05Z",
    "updated_at": "2022-05-24T10:24:05Z",
    "author_association": "MEMBER",
    "body": "wakuext_markAllRead 1133.9249999970198ms (~1.2sec)\r\n\r\n```go\r\nExec(`UPDATE user_messages SET seen = 1 WHERE local_chat_id = ? AND not(seen) AND clock_value <= ? AND not(mentioned)`, chatID, clock)\r\n\r\nExec(`UPDATE user_messages SET seen = 1 WHERE local_chat_id = ? AND not(seen) AND clock_value <= ? AND mentioned`, chatID, clock)\r\n\r\nExec(`UPDATE chats\r\n\tSET unviewed_message_count =\r\n\t(SELECT COUNT(1)\r\n\tFROM user_messages\r\n\tWHERE local_chat_id = ? AND seen = 0),\r\n\tunviewed_mentions_count =\r\n\t(SELECT COUNT(1)\r\n\tFROM user_messages\r\n\tWHERE local_chat_id = ? AND seen = 0 AND mentioned),\r\n               highlight = 0\r\nWHERE id = ?`, chatID, chatID, chatID)\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/1135730708/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/1135750546",
    "html_url": "https://github.com/status-im/status-mobile/issues/13355#issuecomment-1135750546",
    "issue_url": "https://api.github.com/repos/status-im/status-mobile/issues/13355",
    "id": 1135750546,
    "node_id": "IC_kwDOAx4p2c5Dsi2S",
    "user": {
      "login": "flexsurfer",
      "id": 11790366,
      "node_id": "MDQ6VXNlcjExNzkwMzY2",
      "avatar_url": "https://avatars.githubusercontent.com/u/11790366?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/flexsurfer",
      "html_url": "https://github.com/flexsurfer",
      "followers_url": "https://api.github.com/users/flexsurfer/followers",
      "following_url": "https://api.github.com/users/flexsurfer/following{/other_user}",
      "gists_url": "https://api.github.com/users/flexsurfer/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/flexsurfer/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/flexsurfer/subscriptions",
      "organizations_url": "https://api.github.com/users/flexsurfer/orgs",
      "repos_url": "https://api.github.com/users/flexsurfer/repos",
      "events_url": "https://api.github.com/users/flexsurfer/events{/privacy}",
      "received_events_url": "https://api.github.com/users/flexsurfer/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-24T10:38:13Z",
    "updated_at": "2022-05-24T10:39:00Z",
    "author_association": "MEMBER",
    "body": "wakuext_emojiReactionsByChatID 1293.7240000069141ms (~1.2sec)\r\n\r\n```go\r\nquery := fmt.Sprintf(`\r\n\tSELECT\r\n\t    e.clock_value,\r\n\t    e.source,\r\n\t    e.emoji_id,\r\n\t    e.message_id,\r\n\t    e.chat_id,\r\n\t    e.local_chat_id,\r\n\t    e.retracted\r\n\tFROM\r\n\t\temoji_reactions e\r\n\tWHERE NOT(e.retracted)\r\n\tAND\r\n\te.local_chat_id = ?\r\n\tAND\r\n\te.message_id IN\r\n\t(SELECT id FROM user_messages m WHERE NOT(m.hide) AND m.local_chat_id = ? %s\r\n\tORDER BY substr('0000000000000000000000000000000000000000000000000000000000000000' || m.clock_value, -64, 64) || m.id DESC LIMIT ?)\r\n\tLIMIT 1000\r\n`, cursorWhere)\r\n\t\t```",
    "reactions": {
      "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/1135750546/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/1135760985",
    "html_url": "https://github.com/status-im/status-mobile/issues/13355#issuecomment-1135760985",
    "issue_url": "https://api.github.com/repos/status-im/status-mobile/issues/13355",
    "id": 1135760985,
    "node_id": "IC_kwDOAx4p2c5DslZZ",
    "user": {
      "login": "flexsurfer",
      "id": 11790366,
      "node_id": "MDQ6VXNlcjExNzkwMzY2",
      "avatar_url": "https://avatars.githubusercontent.com/u/11790366?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/flexsurfer",
      "html_url": "https://github.com/flexsurfer",
      "followers_url": "https://api.github.com/users/flexsurfer/followers",
      "following_url": "https://api.github.com/users/flexsurfer/following{/other_user}",
      "gists_url": "https://api.github.com/users/flexsurfer/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/flexsurfer/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/flexsurfer/subscriptions",
      "organizations_url": "https://api.github.com/users/flexsurfer/orgs",
      "repos_url": "https://api.github.com/users/flexsurfer/repos",
      "events_url": "https://api.github.com/users/flexsurfer/events{/privacy}",
      "received_events_url": "https://api.github.com/users/flexsurfer/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-24T10:50:33Z",
    "updated_at": "2022-05-24T10:50:33Z",
    "author_association": "MEMBER",
    "body": "wakuext_chatPinnedMessages 1286.5460000038147ms (~1.2sec)\r\n\r\n```go\r\ndb.db.Query(\r\n\t\tfmt.Sprintf(`\r\n\t\t\tSELECT\r\n\t\t\t\t%s,\r\n\t\t\t\tpm.clock_value as pinnedAt,\r\n\t\t\t\tpm.pinned_by as pinnedBy,\r\n\t\t\t\tsubstr('0000000000000000000000000000000000000000000000000000000000000000' || m1.clock_value, -64, 64) || m1.id as cursor\r\n\t\t\tFROM\r\n\t\t\t\tpin_messages pm\r\n\t\t\tJOIN\r\n\t\t\t\tuser_messages m1\r\n\t\t\tON\r\n\t\t\t\tpm.message_id = m1.id\r\n\t\t\tLEFT JOIN\r\n\t\t\t\tuser_messages m2\r\n\t\t\tON\r\n\t\t\t\tm1.response_to = m2.id\r\n\t\t\tLEFT JOIN\r\n\t\t\t\tcontacts c\r\n\t\t\tON\r\n\t\t\t\tm1.source = c.id\r\n\t\t\tWHERE\r\n\t\t\t\tpm.pinned = 1\r\n\t\t\t\tAND NOT(m1.hide) AND m1.local_chat_id IN %s %s\r\n\t\t\tORDER BY cursor DESC\r\n\t\t\t%s\r\n\t\t`, allFields, \"(?\"+strings.Repeat(\",?\", len(chatIDs)-1)+\")\", cursorWhere, limitStr),\r\n\t\targs..., // take one more to figure our whether a cursor should be returned\r\n\t)\r\n\t```",
    "reactions": {
      "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/1135760985/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/1136834021",
    "html_url": "https://github.com/status-im/status-mobile/issues/13355#issuecomment-1136834021",
    "issue_url": "https://api.github.com/repos/status-im/status-mobile/issues/13355",
    "id": 1136834021,
    "node_id": "IC_kwDOAx4p2c5DwrXl",
    "user": {
      "login": "flexsurfer",
      "id": 11790366,
      "node_id": "MDQ6VXNlcjExNzkwMzY2",
      "avatar_url": "https://avatars.githubusercontent.com/u/11790366?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/flexsurfer",
      "html_url": "https://github.com/flexsurfer",
      "followers_url": "https://api.github.com/users/flexsurfer/followers",
      "following_url": "https://api.github.com/users/flexsurfer/following{/other_user}",
      "gists_url": "https://api.github.com/users/flexsurfer/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/flexsurfer/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/flexsurfer/subscriptions",
      "organizations_url": "https://api.github.com/users/flexsurfer/orgs",
      "repos_url": "https://api.github.com/users/flexsurfer/repos",
      "events_url": "https://api.github.com/users/flexsurfer/events{/privacy}",
      "received_events_url": "https://api.github.com/users/flexsurfer/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-25T06:55:54Z",
    "updated_at": "2022-05-25T06:55:54Z",
    "author_association": "MEMBER",
    "body": "it seems like sometimes methods \"waiting\" to be sent in batch, so most likely here `emojiReactionsByChatID` and. `chatPinnedMessages` \"waiting\" for  `markAllRead`, because `markAllRead` always shows this time, but other two sometimes shows ~50-80ms ",
    "reactions": {
      "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/1136834021/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/1136834615",
    "html_url": "https://github.com/status-im/status-mobile/issues/13355#issuecomment-1136834615",
    "issue_url": "https://api.github.com/repos/status-im/status-mobile/issues/13355",
    "id": 1136834615,
    "node_id": "IC_kwDOAx4p2c5Dwrg3",
    "user": {
      "login": "flexsurfer",
      "id": 11790366,
      "node_id": "MDQ6VXNlcjExNzkwMzY2",
      "avatar_url": "https://avatars.githubusercontent.com/u/11790366?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/flexsurfer",
      "html_url": "https://github.com/flexsurfer",
      "followers_url": "https://api.github.com/users/flexsurfer/followers",
      "following_url": "https://api.github.com/users/flexsurfer/following{/other_user}",
      "gists_url": "https://api.github.com/users/flexsurfer/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/flexsurfer/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/flexsurfer/subscriptions",
      "organizations_url": "https://api.github.com/users/flexsurfer/orgs",
      "repos_url": "https://api.github.com/users/flexsurfer/repos",
      "events_url": "https://api.github.com/users/flexsurfer/events{/privacy}",
      "received_events_url": "https://api.github.com/users/flexsurfer/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-25T06:56:14Z",
    "updated_at": "2022-05-25T06:56:14Z",
    "author_association": "MEMBER",
    "body": "so at first we need to improve `markAllRead`",
    "reactions": {
      "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/1136834615/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/1136835338",
    "html_url": "https://github.com/status-im/status-mobile/issues/13355#issuecomment-1136835338",
    "issue_url": "https://api.github.com/repos/status-im/status-mobile/issues/13355",
    "id": 1136835338,
    "node_id": "IC_kwDOAx4p2c5DwrsK",
    "user": {
      "login": "flexsurfer",
      "id": 11790366,
      "node_id": "MDQ6VXNlcjExNzkwMzY2",
      "avatar_url": "https://avatars.githubusercontent.com/u/11790366?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/flexsurfer",
      "html_url": "https://github.com/flexsurfer",
      "followers_url": "https://api.github.com/users/flexsurfer/followers",
      "following_url": "https://api.github.com/users/flexsurfer/following{/other_user}",
      "gists_url": "https://api.github.com/users/flexsurfer/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/flexsurfer/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/flexsurfer/subscriptions",
      "organizations_url": "https://api.github.com/users/flexsurfer/orgs",
      "repos_url": "https://api.github.com/users/flexsurfer/repos",
      "events_url": "https://api.github.com/users/flexsurfer/events{/privacy}",
      "received_events_url": "https://api.github.com/users/flexsurfer/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-25T06:56:37Z",
    "updated_at": "2022-05-25T06:56:37Z",
    "author_association": "MEMBER",
    "body": "```go\r\nfunc (db sqlitePersistence) MarkAllRead(chatID string, clock uint64) error {\r\n\ttx, err := db.db.BeginTx(context.Background(), &sql.TxOptions{})\r\n\tif err != nil {\r\n\t\treturn err\r\n\t}\r\n\tdefer func() {\r\n\t\tif err == nil {\r\n\t\t\terr = tx.Commit()\r\n\t\t\treturn\r\n\t\t}\r\n\t\t// don't shadow original error\r\n\t\t_ = tx.Rollback()\r\n\t}()\r\n\r\n\tstart := time.Now()\r\n\r\n\tseenResult, err := tx.Exec(`UPDATE user_messages SET seen = 1 WHERE local_chat_id = ? AND not(seen)`, chatID)\r\n\tif err != nil {\r\n\t\treturn err\r\n\t}\r\n\r\n\tseen, err := seenResult.RowsAffected()\r\n\tif err != nil {\r\n\t\treturn err\r\n\t}\r\n\r\n\telapsed := time.Since(start)\r\n\tlog.Printf(\"UPDATE user_messages %s took %s - %d\", chatID, elapsed, seen)\r\n\r\n\treturn nil\r\n}\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/1136835338/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/1136838905",
    "html_url": "https://github.com/status-im/status-mobile/issues/13355#issuecomment-1136838905",
    "issue_url": "https://api.github.com/repos/status-im/status-mobile/issues/13355",
    "id": 1136838905,
    "node_id": "IC_kwDOAx4p2c5Dwsj5",
    "user": {
      "login": "flexsurfer",
      "id": 11790366,
      "node_id": "MDQ6VXNlcjExNzkwMzY2",
      "avatar_url": "https://avatars.githubusercontent.com/u/11790366?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/flexsurfer",
      "html_url": "https://github.com/flexsurfer",
      "followers_url": "https://api.github.com/users/flexsurfer/followers",
      "following_url": "https://api.github.com/users/flexsurfer/following{/other_user}",
      "gists_url": "https://api.github.com/users/flexsurfer/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/flexsurfer/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/flexsurfer/subscriptions",
      "organizations_url": "https://api.github.com/users/flexsurfer/orgs",
      "repos_url": "https://api.github.com/users/flexsurfer/repos",
      "events_url": "https://api.github.com/users/flexsurfer/events{/privacy}",
      "received_events_url": "https://api.github.com/users/flexsurfer/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-25T06:58:33Z",
    "updated_at": "2022-05-25T06:58:43Z",
    "author_association": "MEMBER",
    "body": "in code above we have only one query `UPDATE user_messages SET seen = 1 WHERE local_chat_id = ? AND not(seen)`\r\n\r\nit updates 0 rows, so nothing to update, but it still takes 600ms, although `EXPLAIN QUERY PLAN UPDATE user_messages SET seen = 1 WHERE local_chat_id = ? AND not(seen) ` shows that index is used \r\n`SEARCH TABLE user_messages USING INDEX seen_local_chat_id_idx (local_chat_id=?)`",
    "reactions": {
      "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/1136838905/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/1143602450",
    "html_url": "https://github.com/status-im/status-mobile/issues/13355#issuecomment-1143602450",
    "issue_url": "https://api.github.com/repos/status-im/status-mobile/issues/13355",
    "id": 1143602450,
    "node_id": "IC_kwDOAx4p2c5EKf0S",
    "user": {
      "login": "churik",
      "id": 4557972,
      "node_id": "MDQ6VXNlcjQ1NTc5NzI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4557972?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/churik",
      "html_url": "https://github.com/churik",
      "followers_url": "https://api.github.com/users/churik/followers",
      "following_url": "https://api.github.com/users/churik/following{/other_user}",
      "gists_url": "https://api.github.com/users/churik/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/churik/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/churik/subscriptions",
      "organizations_url": "https://api.github.com/users/churik/orgs",
      "repos_url": "https://api.github.com/users/churik/repos",
      "events_url": "https://api.github.com/users/churik/events{/privacy}",
      "received_events_url": "https://api.github.com/users/churik/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-06-01T13:18:48Z",
    "updated_at": "2022-06-01T13:18:48Z",
    "author_association": "MEMBER",
    "body": "Able to reproduce this issue with [this DB](https://drive.google.com/file/d/1kaaBYkZH3018vh_H801vdFGNnuY-EIAf/view?usp=sharing):\r\nData:\r\n- 5 public chats with 20k messages each\r\n- one 1-1 chat with 20k messages\r\n- 200 contacts\r\n\r\nSeed phrase:\r\n`midnight skirt eight display earn moment remain lava arrange visual topple clip`\r\nInstruction on how to import DB is [here](https://notes.status.im/yJMuhPAGT5inXa9Zb4vMZw)\r\n\r\nhttps://user-images.githubusercontent.com/4557972/171413509-ebda0c26-c75e-4a14-a71a-3ab666d57ec3.mp4\r\n\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/1143602450/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
