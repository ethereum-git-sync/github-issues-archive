{
  "url": "https://api.github.com/repos/status-im/status-mobile/issues/10855",
  "repository_url": "https://api.github.com/repos/status-im/status-mobile",
  "labels_url": "https://api.github.com/repos/status-im/status-mobile/issues/10855/labels{/name}",
  "comments_url": "https://api.github.com/repos/status-im/status-mobile/issues/10855/comments",
  "events_url": "https://api.github.com/repos/status-im/status-mobile/issues/10855/events",
  "html_url": "https://github.com/status-im/status-mobile/issues/10855",
  "id": 642831791,
  "node_id": "MDU6SXNzdWU2NDI4MzE3OTE=",
  "number": 10855,
  "title": "Mailserver \"Automatic selection\" get stuck on timeouting mailserver ",
  "user": {
    "login": "3esmit",
    "id": 224810,
    "node_id": "MDQ6VXNlcjIyNDgxMA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/224810?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/3esmit",
    "html_url": "https://github.com/3esmit",
    "followers_url": "https://api.github.com/users/3esmit/followers",
    "following_url": "https://api.github.com/users/3esmit/following{/other_user}",
    "gists_url": "https://api.github.com/users/3esmit/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/3esmit/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/3esmit/subscriptions",
    "organizations_url": "https://api.github.com/users/3esmit/orgs",
    "repos_url": "https://api.github.com/users/3esmit/repos",
    "events_url": "https://api.github.com/users/3esmit/events{/privacy}",
    "received_events_url": "https://api.github.com/users/3esmit/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 330296931,
      "node_id": "MDU6TGFiZWwzMzAyOTY5MzE=",
      "url": "https://api.github.com/repos/status-im/status-mobile/labels/bug",
      "name": "bug",
      "color": "fc2929",
      "default": true,
      "description": null
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2020-06-22T07:35:21Z",
  "updated_at": "2020-09-17T12:49:08Z",
  "closed_at": "2020-09-17T12:49:08Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "# Bug Report\r\n\r\n## Problem\r\n\r\nWhen a mailserver is timeouting, as this:\r\n```\r\n > ./build/bin/node-canary -log=WARN -mailserver='enode://ee2b53b0ace9692167a410514bca3024695dbf0e1a68e1dff9716da620efb195f04a4b9e873fb9b74ac84de801106c465b8e2b6c4f0d93b8749d1578bfcaf03e@104.197.238.144:443' \r\nERROR[06-22|09:10:28.751] Error waiting for mailserver response    package=status-go/cmd/node-canary error=\"timed out waiting for mailserver response\"\r\n```\r\n\r\nThe messages keep loading forever, and I need to manually disable automatic selection, and try another.\r\n\r\n## Current Behavior\r\n\r\nBy default, messages don't load and no error is given.\r\n\r\n## Expected Behavior \r\n\r\nIt should detect that a node is not answering and move on to next.\r\n\r\n\r\n## Additional info\r\n\r\nThis was happening on:\r\n\r\n```\r\nmail-01.gc-us-central1-a.eth.prod: \"never answers\" (infinite loading)\r\nmail-02.gc-us-central1-a.eth.prod: \"never answers\" (infinite loading)\r\nmail-03.gc-us-central1-a.eth.prod: \"never answers\" (infinite loading)\r\n```\r\n\r\nAnd was caused, according to @jakubgs: \"the 3 hosts ran out of space, but for some reason I didn't get a prometheus metric alert\"\r\n\r\nApp version : 1.3.0\r\nDevice: OnePlus 5T\r\nAndroid Version: 8.1.0",
  "closed_by": {
    "login": "cammellos",
    "id": 1017008,
    "node_id": "MDQ6VXNlcjEwMTcwMDg=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1017008?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/cammellos",
    "html_url": "https://github.com/cammellos",
    "followers_url": "https://api.github.com/users/cammellos/followers",
    "following_url": "https://api.github.com/users/cammellos/following{/other_user}",
    "gists_url": "https://api.github.com/users/cammellos/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/cammellos/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/cammellos/subscriptions",
    "organizations_url": "https://api.github.com/users/cammellos/orgs",
    "repos_url": "https://api.github.com/users/cammellos/repos",
    "events_url": "https://api.github.com/users/cammellos/events{/privacy}",
    "received_events_url": "https://api.github.com/users/cammellos/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/status-im/status-mobile/issues/10855/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/status-im/status-mobile/issues/10855/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/647348383",
    "html_url": "https://github.com/status-im/status-mobile/issues/10855#issuecomment-647348383",
    "issue_url": "https://api.github.com/repos/status-im/status-mobile/issues/10855",
    "id": 647348383,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY0NzM0ODM4Mw==",
    "user": {
      "login": "jakubgs",
      "id": 2212681,
      "node_id": "MDQ6VXNlcjIyMTI2ODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2212681?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jakubgs",
      "html_url": "https://github.com/jakubgs",
      "followers_url": "https://api.github.com/users/jakubgs/followers",
      "following_url": "https://api.github.com/users/jakubgs/following{/other_user}",
      "gists_url": "https://api.github.com/users/jakubgs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jakubgs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jakubgs/subscriptions",
      "organizations_url": "https://api.github.com/users/jakubgs/orgs",
      "repos_url": "https://api.github.com/users/jakubgs/repos",
      "events_url": "https://api.github.com/users/jakubgs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jakubgs/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-06-22T07:49:27Z",
    "updated_at": "2020-06-22T07:49:27Z",
    "author_association": "MEMBER",
    "body": "Correct, the issue was caused by no free disk space left. But I think there's two issues here:\r\n\r\n1. Connecting to a history node with disk space issues:\r\n  - `timed out waiting for mailserver response`\r\n  - This error doesn't make much sense and `status-go` could probably be improved in that regard\r\n2. The app itself doesn't attempt to pick another mailserver despite the so called \"timeout\".",
    "reactions": {
      "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/647348383/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/647356410",
    "html_url": "https://github.com/status-im/status-mobile/issues/10855#issuecomment-647356410",
    "issue_url": "https://api.github.com/repos/status-im/status-mobile/issues/10855",
    "id": 647356410,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY0NzM1NjQxMA==",
    "user": {
      "login": "jakubgs",
      "id": 2212681,
      "node_id": "MDQ6VXNlcjIyMTI2ODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2212681?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jakubgs",
      "html_url": "https://github.com/jakubgs",
      "followers_url": "https://api.github.com/users/jakubgs/followers",
      "following_url": "https://api.github.com/users/jakubgs/following{/other_user}",
      "gists_url": "https://api.github.com/users/jakubgs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jakubgs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jakubgs/subscriptions",
      "organizations_url": "https://api.github.com/users/jakubgs/orgs",
      "repos_url": "https://api.github.com/users/jakubgs/repos",
      "events_url": "https://api.github.com/users/jakubgs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jakubgs/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-06-22T08:05:45Z",
    "updated_at": "2020-06-22T08:05:45Z",
    "author_association": "MEMBER",
    "body": "Looks like disk space run out because of new db backups I added, but the retention is too high, so it ate up all disk space. Will fix that today.",
    "reactions": {
      "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/647356410/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/647407611",
    "html_url": "https://github.com/status-im/status-mobile/issues/10855#issuecomment-647407611",
    "issue_url": "https://api.github.com/repos/status-im/status-mobile/issues/10855",
    "id": 647407611,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY0NzQwNzYxMQ==",
    "user": {
      "login": "jakubgs",
      "id": 2212681,
      "node_id": "MDQ6VXNlcjIyMTI2ODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2212681?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jakubgs",
      "html_url": "https://github.com/jakubgs",
      "followers_url": "https://api.github.com/users/jakubgs/followers",
      "following_url": "https://api.github.com/users/jakubgs/following{/other_user}",
      "gists_url": "https://api.github.com/users/jakubgs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jakubgs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jakubgs/subscriptions",
      "organizations_url": "https://api.github.com/users/jakubgs/orgs",
      "repos_url": "https://api.github.com/users/jakubgs/repos",
      "events_url": "https://api.github.com/users/jakubgs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jakubgs/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-06-22T09:43:55Z",
    "updated_at": "2020-06-22T09:43:55Z",
    "author_association": "MEMBER",
    "body": "Okay, I see what was the issue. We had retention set right to `3`:\r\n```yml\r\nmailsrv_pg_bb_backup_retention: 3\r\n```\r\nhttps://github.com/status-im/infra-eth-cluster/blob/d8dca70/ansible/roles/statusd-mailsrv/defaults/main.yml#L144\r\nBut the purging part of the script has a bug:\r\n```sh\r\n      # Purge old dumps\r\n      OLD_DUMPS=$(ls -Art ${BKP_DIR} | head -n -${MAX_KEPT})\r\n      rm -vf ${OLD_DUMPS}\r\n```\r\nhttps://github.com/status-im/infra-eth-cluster/blob/d8dca70/ansible/roles/statusd-mailsrv/tasks/backup.yml#L34-L36\r\nWhen calling `rm` on `${OLD_DUMPS}` it's not using an absolute path, but a relative one.",
    "reactions": {
      "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/647407611/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/647411835",
    "html_url": "https://github.com/status-im/status-mobile/issues/10855#issuecomment-647411835",
    "issue_url": "https://api.github.com/repos/status-im/status-mobile/issues/10855",
    "id": 647411835,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY0NzQxMTgzNQ==",
    "user": {
      "login": "jakubgs",
      "id": 2212681,
      "node_id": "MDQ6VXNlcjIyMTI2ODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2212681?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jakubgs",
      "html_url": "https://github.com/jakubgs",
      "followers_url": "https://api.github.com/users/jakubgs/followers",
      "following_url": "https://api.github.com/users/jakubgs/following{/other_user}",
      "gists_url": "https://api.github.com/users/jakubgs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jakubgs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jakubgs/subscriptions",
      "organizations_url": "https://api.github.com/users/jakubgs/orgs",
      "repos_url": "https://api.github.com/users/jakubgs/repos",
      "events_url": "https://api.github.com/users/jakubgs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jakubgs/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-06-22T09:52:13Z",
    "updated_at": "2020-06-22T10:02:45Z",
    "author_association": "MEMBER",
    "body": "Modified the `systemd-timer` to support setting work dir: https://github.com/status-im/infra-role-systemd-timer/commit/3ba6995b\r\nAnd modified the history node role to set it correctly: https://github.com/status-im/infra-eth-cluster/commit/f9cc9fd7\r\nLooks much better:\r\n```\r\nsystemd[1]: Starting Dumping mailserver PostgreSQL database...\r\ndump-statusd-mail-db[9579]: Created: /var/tmp/backups/mailsrv/statusd_mail_db_dump_20200622095042.sql\r\ndump-statusd-mail-db[9579]: removed 'statusd_mail_db_dump_20200331130625.sql'\r\ndump-statusd-mail-db[9579]: removed 'statusd_mail_db_dump_20200401000003.sql'\r\ndump-statusd-mail-db[9579]: removed 'statusd_mail_db_dump_20200402000004.sql'\r\n...\r\ndump-statusd-mail-db[9579]: removed 'statusd_mail_db_dump_20200621000005.sql'\r\ndump-statusd-mail-db[9579]: removed 'statusd_mail_db_dump_20200622000005.sql'\r\ndump-statusd-mail-db[9579]: removed 'statusd_mail_db_dump_20200622093738.sql'\r\nsystemd[1]: Started Dumping mailserver PostgreSQL database.\r\n```\r\n```\r\nadmin@mail-01.do-ams3.eth.prod:~ % ls -l /var/tmp/backups/mailsrv \r\ntotal 1884088\r\n-rw-r--r-- 1 root root 643025572 Jun 22 09:39 statusd_mail_db_dump_20200622093918.sql\r\n-rw-r--r-- 1 root root 643115453 Jun 22 09:48 statusd_mail_db_dump_20200622094816.sql\r\n-rw-r--r-- 1 root root 643146256 Jun 22 09:51 statusd_mail_db_dump_20200622095042.sql\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/647411835/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
