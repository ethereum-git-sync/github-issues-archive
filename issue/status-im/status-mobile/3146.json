{
  "url": "https://api.github.com/repos/status-im/status-mobile/issues/3146",
  "repository_url": "https://api.github.com/repos/status-im/status-mobile",
  "labels_url": "https://api.github.com/repos/status-im/status-mobile/issues/3146/labels{/name}",
  "comments_url": "https://api.github.com/repos/status-im/status-mobile/issues/3146/comments",
  "events_url": "https://api.github.com/repos/status-im/status-mobile/issues/3146/events",
  "html_url": "https://github.com/status-im/status-mobile/issues/3146",
  "id": 291842935,
  "node_id": "MDU6SXNzdWUyOTE4NDI5MzU=",
  "number": 3146,
  "title": "[Perf] Test Hypothesis 5: synchronous realm reads/writes are the major factor contributing to bad UI performance and event processing speed",
  "user": {
    "login": "janherich",
    "id": 1910609,
    "node_id": "MDQ6VXNlcjE5MTA2MDk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1910609?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/janherich",
    "html_url": "https://github.com/janherich",
    "followers_url": "https://api.github.com/users/janherich/followers",
    "following_url": "https://api.github.com/users/janherich/following{/other_user}",
    "gists_url": "https://api.github.com/users/janherich/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/janherich/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/janherich/subscriptions",
    "organizations_url": "https://api.github.com/users/janherich/orgs",
    "repos_url": "https://api.github.com/users/janherich/repos",
    "events_url": "https://api.github.com/users/janherich/events{/privacy}",
    "received_events_url": "https://api.github.com/users/janherich/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 783781483,
      "node_id": "MDU6TGFiZWw3ODM3ODE0ODM=",
      "url": "https://api.github.com/repos/status-im/status-mobile/labels/performance",
      "name": "performance",
      "color": "dd3bd8",
      "default": false,
      "description": null
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "janherich",
    "id": 1910609,
    "node_id": "MDQ6VXNlcjE5MTA2MDk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1910609?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/janherich",
    "html_url": "https://github.com/janherich",
    "followers_url": "https://api.github.com/users/janherich/followers",
    "following_url": "https://api.github.com/users/janherich/following{/other_user}",
    "gists_url": "https://api.github.com/users/janherich/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/janherich/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/janherich/subscriptions",
    "organizations_url": "https://api.github.com/users/janherich/orgs",
    "repos_url": "https://api.github.com/users/janherich/repos",
    "events_url": "https://api.github.com/users/janherich/events{/privacy}",
    "received_events_url": "https://api.github.com/users/janherich/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "janherich",
      "id": 1910609,
      "node_id": "MDQ6VXNlcjE5MTA2MDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1910609?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/janherich",
      "html_url": "https://github.com/janherich",
      "followers_url": "https://api.github.com/users/janherich/followers",
      "following_url": "https://api.github.com/users/janherich/following{/other_user}",
      "gists_url": "https://api.github.com/users/janherich/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/janherich/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/janherich/subscriptions",
      "organizations_url": "https://api.github.com/users/janherich/orgs",
      "repos_url": "https://api.github.com/users/janherich/repos",
      "events_url": "https://api.github.com/users/janherich/events{/privacy}",
      "received_events_url": "https://api.github.com/users/janherich/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2018-01-26T09:28:28Z",
  "updated_at": "2018-02-19T11:27:43Z",
  "closed_at": "2018-02-19T11:27:43Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "### Identified Behavior\r\n\r\nThe app UI is very slow to respond in certain cases, it's most visible when receiving a lot of messages, but also when sending a new message, user perceives noticeable lags between hitting the `send` button and UI updated as a result of such action (new message is rendered, etc.)\r\n\r\n- [x] User story part of MVP scope\r\n- [x] Identified end user behavior\r\n\r\n### Hypothesis\r\n\r\nAccording to preliminary testing (done in `dev` mode), synchronous realm reads/writes always take **7-8ms** which completely dwarfs any time spent in actually updating persisting datastructure representing our app state (`re-frame` app-db) - doing even complicated nested update on app-db is basically not measurable using the `time` function. \r\nFollowing facts also hold true:\r\n* While 7-8ms doesn't seem like much at the first glance, frequent usage paths (like receiving/sending message) involves **many** of such operations done in sequence, easily pushing it to **50-100ms**, already taking much more then time of one 16fps frame, not even mentioning that in case of message receiving, it could happen that more of such events are queued on the `re-frame` event queue which blocks till all the events are processed (we \"solved\" that critical case with hacky workaround)\r\n* For app to work (eq UI is responsive) we strictly don't need anything else other then operate on `re-frame` app-db (and changes there are automatically reflected through subscriptions->views to UI). Network communication can happen asynchronously (this is already the case in some times), the same holds true for persisting data through any DB we decide to use (realm currently).\r\nBy separating lightning-fast, pure functional data events from other effects and putting those (potentially much more expensive) other effects on separate queue (or more queues), we can leverage good default `re-frame` performance (which is fine when used as its meant to be, primary updating `app-db`) and fine-tune the other queues so that their throughput is just enough and not blocking anything.\r\n\r\n### Assumptions\r\n\r\n- The app responsiveness suffers because of the architecture mixing functional data updates & side effect IO together\r\n- App responsiveness is generally bad for MVP user flows\r\n\r\n### Experiment\r\n\r\nTo quickly test the hypothesis, focus on just one user path (let's say, receiving messages) and make sure nothing like sync IO (realm reads/writes, web3 callbacks, etc.) is happening on the main `re-frame` queue, offload it to separate queue + make sure that realm reads (necessary for that path) all happen at the app-startup, so when new message arrives, everything necessary for processing is already in `re-frame` app-db.\r\n\r\n#### Responsiveness metrics\r\n1. UI performance (time to receive 50 messages much better then now)\r\n\r\n### Acceptance criteria\r\n\r\n- [ ] Measure UI performance\r\n- [x] Make sure that UI is not blocking ",
  "closed_by": {
    "login": "dmitryn",
    "id": 23836,
    "node_id": "MDQ6VXNlcjIzODM2",
    "avatar_url": "https://avatars.githubusercontent.com/u/23836?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/dmitryn",
    "html_url": "https://github.com/dmitryn",
    "followers_url": "https://api.github.com/users/dmitryn/followers",
    "following_url": "https://api.github.com/users/dmitryn/following{/other_user}",
    "gists_url": "https://api.github.com/users/dmitryn/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/dmitryn/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/dmitryn/subscriptions",
    "organizations_url": "https://api.github.com/users/dmitryn/orgs",
    "repos_url": "https://api.github.com/users/dmitryn/repos",
    "events_url": "https://api.github.com/users/dmitryn/events{/privacy}",
    "received_events_url": "https://api.github.com/users/dmitryn/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/status-im/status-mobile/issues/3146/reactions",
    "total_count": 5,
    "+1": 5,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/status-im/status-mobile/issues/3146/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/361181249",
    "html_url": "https://github.com/status-im/status-mobile/issues/3146#issuecomment-361181249",
    "issue_url": "https://api.github.com/repos/status-im/status-mobile/issues/3146",
    "id": 361181249,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM2MTE4MTI0OQ==",
    "user": {
      "login": "janherich",
      "id": 1910609,
      "node_id": "MDQ6VXNlcjE5MTA2MDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1910609?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/janherich",
      "html_url": "https://github.com/janherich",
      "followers_url": "https://api.github.com/users/janherich/followers",
      "following_url": "https://api.github.com/users/janherich/following{/other_user}",
      "gists_url": "https://api.github.com/users/janherich/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/janherich/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/janherich/subscriptions",
      "organizations_url": "https://api.github.com/users/janherich/orgs",
      "repos_url": "https://api.github.com/users/janherich/repos",
      "events_url": "https://api.github.com/users/janherich/events{/privacy}",
      "received_events_url": "https://api.github.com/users/janherich/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-01-29T09:05:04Z",
    "updated_at": "2018-01-29T09:05:04Z",
    "author_association": "CONTRIBUTOR",
    "body": "Branch testing the hypothesis is called `feature/offband-realm-#3146`",
    "reactions": {
      "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/361181249/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/366133326",
    "html_url": "https://github.com/status-im/status-mobile/issues/3146#issuecomment-366133326",
    "issue_url": "https://api.github.com/repos/status-im/status-mobile/issues/3146",
    "id": 366133326,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM2NjEzMzMyNg==",
    "user": {
      "login": "oskarth",
      "id": 1552237,
      "node_id": "MDQ6VXNlcjE1NTIyMzc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1552237?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/oskarth",
      "html_url": "https://github.com/oskarth",
      "followers_url": "https://api.github.com/users/oskarth/followers",
      "following_url": "https://api.github.com/users/oskarth/following{/other_user}",
      "gists_url": "https://api.github.com/users/oskarth/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/oskarth/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/oskarth/subscriptions",
      "organizations_url": "https://api.github.com/users/oskarth/orgs",
      "repos_url": "https://api.github.com/users/oskarth/repos",
      "events_url": "https://api.github.com/users/oskarth/events{/privacy}",
      "received_events_url": "https://api.github.com/users/oskarth/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-02-16T03:11:33Z",
    "updated_at": "2018-02-16T03:11:33Z",
    "author_association": "CONTRIBUTOR",
    "body": "@janherich @dmitryn What's the state of this experiment?",
    "reactions": {
      "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/366133326/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/366186714",
    "html_url": "https://github.com/status-im/status-mobile/issues/3146#issuecomment-366186714",
    "issue_url": "https://api.github.com/repos/status-im/status-mobile/issues/3146",
    "id": 366186714,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM2NjE4NjcxNA==",
    "user": {
      "login": "janherich",
      "id": 1910609,
      "node_id": "MDQ6VXNlcjE5MTA2MDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1910609?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/janherich",
      "html_url": "https://github.com/janherich",
      "followers_url": "https://api.github.com/users/janherich/followers",
      "following_url": "https://api.github.com/users/janherich/following{/other_user}",
      "gists_url": "https://api.github.com/users/janherich/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/janherich/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/janherich/subscriptions",
      "organizations_url": "https://api.github.com/users/janherich/orgs",
      "repos_url": "https://api.github.com/users/janherich/repos",
      "events_url": "https://api.github.com/users/janherich/events{/privacy}",
      "received_events_url": "https://api.github.com/users/janherich/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-02-16T09:37:07Z",
    "updated_at": "2018-02-16T09:37:07Z",
    "author_association": "CONTRIBUTOR",
    "body": "@oskarth Hypothesis was basically proved and fixed in most critical places slowing down the app.",
    "reactions": {
      "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/366186714/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/366211460",
    "html_url": "https://github.com/status-im/status-mobile/issues/3146#issuecomment-366211460",
    "issue_url": "https://api.github.com/repos/status-im/status-mobile/issues/3146",
    "id": 366211460,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM2NjIxMTQ2MA==",
    "user": {
      "login": "dmitryn",
      "id": 23836,
      "node_id": "MDQ6VXNlcjIzODM2",
      "avatar_url": "https://avatars.githubusercontent.com/u/23836?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dmitryn",
      "html_url": "https://github.com/dmitryn",
      "followers_url": "https://api.github.com/users/dmitryn/followers",
      "following_url": "https://api.github.com/users/dmitryn/following{/other_user}",
      "gists_url": "https://api.github.com/users/dmitryn/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dmitryn/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dmitryn/subscriptions",
      "organizations_url": "https://api.github.com/users/dmitryn/orgs",
      "repos_url": "https://api.github.com/users/dmitryn/repos",
      "events_url": "https://api.github.com/users/dmitryn/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dmitryn/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-02-16T11:27:51Z",
    "updated_at": "2018-02-16T11:27:51Z",
    "author_association": "CONTRIBUTOR",
    "body": "@oskarth some of my PRs related to this hypothesis are still in TO TEST state:\r\nhttps://github.com/status-im/status-react/pull/3212\r\nhttps://github.com/status-im/status-react/pull/3225\r\nhttps://github.com/status-im/status-react/pull/3265\r\n\r\nI'm not going to add anything more to this experiment. As Jan said, experiment could be considered over.",
    "reactions": {
      "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/366211460/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
