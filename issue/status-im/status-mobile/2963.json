{
  "url": "https://api.github.com/repos/status-im/status-mobile/issues/2963",
  "repository_url": "https://api.github.com/repos/status-im/status-mobile",
  "labels_url": "https://api.github.com/repos/status-im/status-mobile/issues/2963/labels{/name}",
  "comments_url": "https://api.github.com/repos/status-im/status-mobile/issues/2963/comments",
  "events_url": "https://api.github.com/repos/status-im/status-mobile/issues/2963/events",
  "html_url": "https://github.com/status-im/status-mobile/issues/2963",
  "id": 286984194,
  "node_id": "MDU6SXNzdWUyODY5ODQxOTQ=",
  "number": 2963,
  "title": "[Perf] Test hypothesis 1: RN Bridge render bottleneck",
  "user": {
    "login": "oskarth",
    "id": 1552237,
    "node_id": "MDQ6VXNlcjE1NTIyMzc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1552237?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/oskarth",
    "html_url": "https://github.com/oskarth",
    "followers_url": "https://api.github.com/users/oskarth/followers",
    "following_url": "https://api.github.com/users/oskarth/following{/other_user}",
    "gists_url": "https://api.github.com/users/oskarth/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/oskarth/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/oskarth/subscriptions",
    "organizations_url": "https://api.github.com/users/oskarth/orgs",
    "repos_url": "https://api.github.com/users/oskarth/repos",
    "events_url": "https://api.github.com/users/oskarth/events{/privacy}",
    "received_events_url": "https://api.github.com/users/oskarth/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 783781483,
      "node_id": "MDU6TGFiZWw3ODM3ODE0ODM=",
      "url": "https://api.github.com/repos/status-im/status-mobile/labels/performance",
      "name": "performance",
      "color": "dd3bd8",
      "default": false,
      "description": null
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "rasom",
    "id": 2364994,
    "node_id": "MDQ6VXNlcjIzNjQ5OTQ=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2364994?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/rasom",
    "html_url": "https://github.com/rasom",
    "followers_url": "https://api.github.com/users/rasom/followers",
    "following_url": "https://api.github.com/users/rasom/following{/other_user}",
    "gists_url": "https://api.github.com/users/rasom/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/rasom/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rasom/subscriptions",
    "organizations_url": "https://api.github.com/users/rasom/orgs",
    "repos_url": "https://api.github.com/users/rasom/repos",
    "events_url": "https://api.github.com/users/rasom/events{/privacy}",
    "received_events_url": "https://api.github.com/users/rasom/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "rasom",
      "id": 2364994,
      "node_id": "MDQ6VXNlcjIzNjQ5OTQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2364994?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rasom",
      "html_url": "https://github.com/rasom",
      "followers_url": "https://api.github.com/users/rasom/followers",
      "following_url": "https://api.github.com/users/rasom/following{/other_user}",
      "gists_url": "https://api.github.com/users/rasom/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rasom/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rasom/subscriptions",
      "organizations_url": "https://api.github.com/users/rasom/orgs",
      "repos_url": "https://api.github.com/users/rasom/repos",
      "events_url": "https://api.github.com/users/rasom/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rasom/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2018-01-09T06:35:40Z",
  "updated_at": "2018-01-29T20:20:26Z",
  "closed_at": "2018-01-29T20:20:26Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "## Identified Behavior\r\n\r\nToggling between chat list and chat tabs is noticeably laggy on many devices. Compare with Telegram e.g. Additionally, this might also impact other common transitions.\r\n\r\n- [x] Behavior has been confirmed to be part of MVP.\r\n- [x] Confirm this is still a problem for end users on our supported devices.\r\n\r\n## Hypothesis\r\n\r\nBad performance for toggling between tabs is due to RN Bridge roundtrips being a bottleneck for rendering.\r\n\r\n(This is a common performance bottleneck for React Native programs.)\r\n\r\n## Assumptions\r\n\r\n1) Assuming this is still a critical problem for end user\r\n2) Assuming it is reasonably easy to fixable\r\n\r\n## Experiment\r\n\r\nUse Spy or rn-snoopy to verify RN bridge roundtrips is the bottleneck. \r\n\r\nAdditionally, consider making use of re-frisk or manual timers to supplement above.\r\n\r\n- [x] This is the quickest way to test the hypothesis.\r\n\r\n## Acceptance critiera\r\n\r\n- [ ] Numbers on what is happening from user click on one tab to another, especially 80% effort\r\n- [ ] Understanding and write-up of the root cause\r\n- [ ] Specific issue suggestion on what code to implement to fix it\r\n- [ ] (Optionally) spike out potential solution and verify fix is working\r\n\r\n## Notes\r\n\r\nSee\r\n\r\n- https://medium.com/@jondot/debugging-react-native-performance-snoopy-and-the-messagequeue-fe014cd047ac\r\n\r\n- https://github.com/jondot/rn-snoopy \r\n\r\n- https://github.com/status-im/status-react/pull/2849\r\n\r\n-  https://github.com/status-im/status-react/pull/2765 (merged)\r\n  \r\n  \r\n  ",
  "closed_by": {
    "login": "rasom",
    "id": 2364994,
    "node_id": "MDQ6VXNlcjIzNjQ5OTQ=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2364994?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/rasom",
    "html_url": "https://github.com/rasom",
    "followers_url": "https://api.github.com/users/rasom/followers",
    "following_url": "https://api.github.com/users/rasom/following{/other_user}",
    "gists_url": "https://api.github.com/users/rasom/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/rasom/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rasom/subscriptions",
    "organizations_url": "https://api.github.com/users/rasom/orgs",
    "repos_url": "https://api.github.com/users/rasom/repos",
    "events_url": "https://api.github.com/users/rasom/events{/privacy}",
    "received_events_url": "https://api.github.com/users/rasom/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/status-im/status-mobile/issues/2963/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/status-im/status-mobile/issues/2963/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/356193709",
    "html_url": "https://github.com/status-im/status-mobile/issues/2963#issuecomment-356193709",
    "issue_url": "https://api.github.com/repos/status-im/status-mobile/issues/2963",
    "id": 356193709,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM1NjE5MzcwOQ==",
    "user": {
      "login": "oskarth",
      "id": 1552237,
      "node_id": "MDQ6VXNlcjE1NTIyMzc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1552237?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/oskarth",
      "html_url": "https://github.com/oskarth",
      "followers_url": "https://api.github.com/users/oskarth/followers",
      "following_url": "https://api.github.com/users/oskarth/following{/other_user}",
      "gists_url": "https://api.github.com/users/oskarth/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/oskarth/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/oskarth/subscriptions",
      "organizations_url": "https://api.github.com/users/oskarth/orgs",
      "repos_url": "https://api.github.com/users/oskarth/repos",
      "events_url": "https://api.github.com/users/oskarth/events{/privacy}",
      "received_events_url": "https://api.github.com/users/oskarth/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-01-09T06:36:31Z",
    "updated_at": "2018-01-09T06:36:31Z",
    "author_association": "CONTRIBUTOR",
    "body": "@rasom Do you want to own this issue? Do you agree with it?\r\n\r\n@annadanchenko Concurrently with testing of this hypothesis, can you please confirm this is still a problem for end users on our supported devices?\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/356193709/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/356275505",
    "html_url": "https://github.com/status-im/status-mobile/issues/2963#issuecomment-356275505",
    "issue_url": "https://api.github.com/repos/status-im/status-mobile/issues/2963",
    "id": 356275505,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM1NjI3NTUwNQ==",
    "user": {
      "login": "rasom",
      "id": 2364994,
      "node_id": "MDQ6VXNlcjIzNjQ5OTQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2364994?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rasom",
      "html_url": "https://github.com/rasom",
      "followers_url": "https://api.github.com/users/rasom/followers",
      "following_url": "https://api.github.com/users/rasom/following{/other_user}",
      "gists_url": "https://api.github.com/users/rasom/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rasom/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rasom/subscriptions",
      "organizations_url": "https://api.github.com/users/rasom/orgs",
      "repos_url": "https://api.github.com/users/rasom/repos",
      "events_url": "https://api.github.com/users/rasom/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rasom/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-01-09T12:52:02Z",
    "updated_at": "2018-01-09T12:52:02Z",
    "author_association": "MEMBER",
    "body": "@oskarth yes and yes",
    "reactions": {
      "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/356275505/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/359071896",
    "html_url": "https://github.com/status-im/status-mobile/issues/2963#issuecomment-359071896",
    "issue_url": "https://api.github.com/repos/status-im/status-mobile/issues/2963",
    "id": 359071896,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM1OTA3MTg5Ng==",
    "user": {
      "login": "oskarth",
      "id": 1552237,
      "node_id": "MDQ6VXNlcjE1NTIyMzc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1552237?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/oskarth",
      "html_url": "https://github.com/oskarth",
      "followers_url": "https://api.github.com/users/oskarth/followers",
      "following_url": "https://api.github.com/users/oskarth/following{/other_user}",
      "gists_url": "https://api.github.com/users/oskarth/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/oskarth/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/oskarth/subscriptions",
      "organizations_url": "https://api.github.com/users/oskarth/orgs",
      "repos_url": "https://api.github.com/users/oskarth/repos",
      "events_url": "https://api.github.com/users/oskarth/events{/privacy}",
      "received_events_url": "https://api.github.com/users/oskarth/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-01-19T19:53:28Z",
    "updated_at": "2018-01-19T19:53:28Z",
    "author_association": "CONTRIBUTOR",
    "body": "> Use Spy or rn-snoopy to verify RN bridge roundtrips is the bottleneck.\r\n\r\nOne problem with this experiment setup is that a lot of calls, as @rasom pointed out, aren't bidirectional, e.g. some are async/unidirectional. This means it isn't always straightforward to see what the cost of each \"bridge crossing\".\r\n\r\n@rasom You've posted a bunch of observations from this in Slack, would you mind posting a summary of things you found in this issue so we don't lose it?",
    "reactions": {
      "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/359071896/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/360472875",
    "html_url": "https://github.com/status-im/status-mobile/issues/2963#issuecomment-360472875",
    "issue_url": "https://api.github.com/repos/status-im/status-mobile/issues/2963",
    "id": 360472875,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM2MDQ3Mjg3NQ==",
    "user": {
      "login": "rasom",
      "id": 2364994,
      "node_id": "MDQ6VXNlcjIzNjQ5OTQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2364994?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rasom",
      "html_url": "https://github.com/rasom",
      "followers_url": "https://api.github.com/users/rasom/followers",
      "following_url": "https://api.github.com/users/rasom/following{/other_user}",
      "gists_url": "https://api.github.com/users/rasom/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rasom/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rasom/subscriptions",
      "organizations_url": "https://api.github.com/users/rasom/orgs",
      "repos_url": "https://api.github.com/users/rasom/repos",
      "events_url": "https://api.github.com/users/rasom/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rasom/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-01-25T13:55:01Z",
    "updated_at": "2018-01-25T14:33:01Z",
    "author_association": "MEMBER",
    "body": "To sum up communication through RN bridge, we have the next types of messages:\r\n\r\n\r\n1.\tstatus-module\r\nThe main concern was related to the way how we use web3, but it seems that regardless of number of incoming messages we don’t have more than 6-8 in/out RN bridge messages related to this module. \r\n\r\n\r\n2.\tTiming/JSTimers\r\nThis module is used by animation (not native), when we call setTimeout/setInterval explicitly and under the hood by core.async. Right now we have 20-24 messages per second related to this module. So we can define a threshold about 50 mps which means that if we have more than 50 mps for this module something suspicious is happening, and this will trigger some notification in app (in dev mode).\r\n\r\n\r\n3.\twebsocket\r\nIs used only in develop mode for dev tools and probably figwheel/re-frisk\r\n\r\n\r\n4.\tui-manager\r\nMost of calls related to this module happen on navigation. As far as I can say we have something similar to direct dependency between the number of these calls and duration of navigation between screens. We also can define a threshold for this type of messages, I suppose that it should be about 40 for Android and ~100 on iOS. That’s the numbers when delay before rendering a new screen starts being noticeable (anyway exact numbers TBD)\r\n\r\n\r\n| ___________________ | ____________develop___________ | experiment/nav-groups\r\n|- | ---- | ---- |\r\nchats -> console chat | updateView 7 createView   205 setChildren  159 Total: **373** | updateView 12 Create view 80  setChildren 58  Total: **150**\r\nchats -> profile | updateView 10 createView 89 setChildren 62 Total: **161** | updateView 12 createView 9 setChildren 5 Total: **26**\r\nprofile -> chats | updateView 10 Createview 58 setChildren. 41 Total: **109** | updateView 12 createView 10 setChildren 6 Total: **28**\r\n\r\n\r\n\r\n5.\ttouches\r\nThese messages happen when we touch screen, so if we touch it a lot there can be a lot of them but I doubt that they have serious impact on perf.\r\n\r\n\r\n6.\tnative-animation\r\nMessages related to animation with setNativeDriver=true. \r\n\r\n\r\n7.\tkeyboard-observer\r\nWe explicitly call this module once in root element, then it also is called by FlatList. Nothing important, but it looked for suspicious at first glance because I was under impression the we call it for no reason. But we don’t.\r\n\r\n\r\n8. There are also different messages similar to\r\n  `RCTEventEmitter.receiveEvent([23,”topLayout\"`\r\nMany of them happens when animation with setNativeDriver=false is used, so in most cases we can notice same stuff by watching Timing/JSTimers\r\n\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/360472875/reactions",
      "total_count": 4,
      "+1": 4,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
