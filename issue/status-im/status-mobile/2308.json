{
  "url": "https://api.github.com/repos/status-im/status-mobile/issues/2308",
  "repository_url": "https://api.github.com/repos/status-im/status-mobile",
  "labels_url": "https://api.github.com/repos/status-im/status-mobile/issues/2308/labels{/name}",
  "comments_url": "https://api.github.com/repos/status-im/status-mobile/issues/2308/comments",
  "events_url": "https://api.github.com/repos/status-im/status-mobile/issues/2308/events",
  "html_url": "https://github.com/status-im/status-mobile/issues/2308",
  "id": 268754289,
  "node_id": "MDU6SXNzdWUyNjg3NTQyODk=",
  "number": 2308,
  "title": "Old status discoveries are not deleted from the account",
  "user": {
    "login": "goranjovic",
    "id": 711764,
    "node_id": "MDQ6VXNlcjcxMTc2NA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/711764?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/goranjovic",
    "html_url": "https://github.com/goranjovic",
    "followers_url": "https://api.github.com/users/goranjovic/followers",
    "following_url": "https://api.github.com/users/goranjovic/following{/other_user}",
    "gists_url": "https://api.github.com/users/goranjovic/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/goranjovic/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/goranjovic/subscriptions",
    "organizations_url": "https://api.github.com/users/goranjovic/orgs",
    "repos_url": "https://api.github.com/users/goranjovic/repos",
    "events_url": "https://api.github.com/users/goranjovic/events{/privacy}",
    "received_events_url": "https://api.github.com/users/goranjovic/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 330296931,
      "node_id": "MDU6TGFiZWwzMzAyOTY5MzE=",
      "url": "https://api.github.com/repos/status-im/status-mobile/labels/bug",
      "name": "bug",
      "color": "fc2929",
      "default": true,
      "description": null
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "yenda",
    "id": 1181225,
    "node_id": "MDQ6VXNlcjExODEyMjU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1181225?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/yenda",
    "html_url": "https://github.com/yenda",
    "followers_url": "https://api.github.com/users/yenda/followers",
    "following_url": "https://api.github.com/users/yenda/following{/other_user}",
    "gists_url": "https://api.github.com/users/yenda/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/yenda/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/yenda/subscriptions",
    "organizations_url": "https://api.github.com/users/yenda/orgs",
    "repos_url": "https://api.github.com/users/yenda/repos",
    "events_url": "https://api.github.com/users/yenda/events{/privacy}",
    "received_events_url": "https://api.github.com/users/yenda/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "yenda",
      "id": 1181225,
      "node_id": "MDQ6VXNlcjExODEyMjU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1181225?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/yenda",
      "html_url": "https://github.com/yenda",
      "followers_url": "https://api.github.com/users/yenda/followers",
      "following_url": "https://api.github.com/users/yenda/following{/other_user}",
      "gists_url": "https://api.github.com/users/yenda/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/yenda/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/yenda/subscriptions",
      "organizations_url": "https://api.github.com/users/yenda/orgs",
      "repos_url": "https://api.github.com/users/yenda/repos",
      "events_url": "https://api.github.com/users/yenda/events{/privacy}",
      "received_events_url": "https://api.github.com/users/yenda/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2017-10-26T13:12:10Z",
  "updated_at": "2018-04-12T09:13:22Z",
  "closed_at": "2018-04-12T09:13:22Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "[comment]: # (Please replace ... with your information. Remove < and >)\r\n\r\n### User Story\r\n\r\nAs a user I want the maximum number of discoveries on my device to be 1000\r\n\r\n### Description\r\n\r\n\r\n*Type*:  Bug\r\n\r\n*Summary*: When the number of discoveries received on a single account reaches 1000, the oldest discoveries have to be deleted in order to maintain a fixed number of total discoveries available locally. This is not the case currently.\r\n\r\n#### Expected behavior\r\n\r\n- Number of discoveries goes beyond 1000\r\n- The oldest discoveries are deleted\r\n- New number of discoveries is smaller than or equal to 1000.\r\n\r\n#### Actual behavior\r\n\r\n- After user login, if the number of discoveries was larger than 1000 app attempts to remove the oldest 200\r\n- App crashes with red screen and message: \"The realm is already in a write transaction\"\r\n\r\nNote: even without the red screen error, the algorithm doesn't work. It only deletes the old discoveries after login, so there is no guarantee that the following scenario can't happen:\r\n\r\n- User receives 1500 statuses\r\n- Logs out and in again, now the oldest 200 are removed, new count is 1300\r\n- User receives another 1500 statuses, now it's 2800\r\n- Logs out and in again, now it's 2600\r\n- ...etc\r\n\r\n### Reproduction\r\n\r\nDue to the very large threshold, this is quite tedious to reproduce manually. I only managed to do that by manually changing the code to keep maximum 10 discoveries (not 1000) and to remove 2 (not 200).\r\n\r\n### Solution\r\n*Summary*: \r\n\r\nThe exact solution will depend on Realm related details.\r\n\r\nGenerally, it could go something like this:\r\nAfter every addition of discoveries, if the new count  C is larger than 1000, remove the oldest C - 1000 + buffer. The purpose of the buffer value would be not to slow down the writes by always deleting on every write for all accounts with too many discoveries, e.g. for buffer with value 200, the actual count of discoveries would fluctuate between 800 and 1000.\r\n\r\nAlternatively, we could check if there is a good pattern for capped collections in Realm.",
  "closed_by": {
    "login": "goranjovic",
    "id": 711764,
    "node_id": "MDQ6VXNlcjcxMTc2NA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/711764?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/goranjovic",
    "html_url": "https://github.com/goranjovic",
    "followers_url": "https://api.github.com/users/goranjovic/followers",
    "following_url": "https://api.github.com/users/goranjovic/following{/other_user}",
    "gists_url": "https://api.github.com/users/goranjovic/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/goranjovic/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/goranjovic/subscriptions",
    "organizations_url": "https://api.github.com/users/goranjovic/orgs",
    "repos_url": "https://api.github.com/users/goranjovic/repos",
    "events_url": "https://api.github.com/users/goranjovic/events{/privacy}",
    "received_events_url": "https://api.github.com/users/goranjovic/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/status-im/status-mobile/issues/2308/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/status-im/status-mobile/issues/2308/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/380734428",
    "html_url": "https://github.com/status-im/status-mobile/issues/2308#issuecomment-380734428",
    "issue_url": "https://api.github.com/repos/status-im/status-mobile/issues/2308",
    "id": 380734428,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM4MDczNDQyOA==",
    "user": {
      "login": "goranjovic",
      "id": 711764,
      "node_id": "MDQ6VXNlcjcxMTc2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/711764?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/goranjovic",
      "html_url": "https://github.com/goranjovic",
      "followers_url": "https://api.github.com/users/goranjovic/followers",
      "following_url": "https://api.github.com/users/goranjovic/following{/other_user}",
      "gists_url": "https://api.github.com/users/goranjovic/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/goranjovic/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/goranjovic/subscriptions",
      "organizations_url": "https://api.github.com/users/goranjovic/orgs",
      "repos_url": "https://api.github.com/users/goranjovic/repos",
      "events_url": "https://api.github.com/users/goranjovic/events{/privacy}",
      "received_events_url": "https://api.github.com/users/goranjovic/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-04-12T09:13:22Z",
    "updated_at": "2018-04-12T09:13:22Z",
    "author_association": "CONTRIBUTOR",
    "body": "obsolete as we removed discover",
    "reactions": {
      "url": "https://api.github.com/repos/status-im/status-mobile/issues/comments/380734428/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
