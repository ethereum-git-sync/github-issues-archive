{
  "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3833",
  "repository_url": "https://api.github.com/repos/NomicFoundation/hardhat",
  "labels_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3833/labels{/name}",
  "comments_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3833/comments",
  "events_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3833/events",
  "html_url": "https://github.com/NomicFoundation/hardhat/issues/3833",
  "id": 1661088512,
  "node_id": "I_kwDOB7jojM5jAjMA",
  "number": 3833,
  "title": "withArgs doesn't deep compare arrays within structs",
  "user": {
    "login": "ryanio",
    "id": 22116,
    "node_id": "MDQ6VXNlcjIyMTE2",
    "avatar_url": "https://avatars.githubusercontent.com/u/22116?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ryanio",
    "html_url": "https://github.com/ryanio",
    "followers_url": "https://api.github.com/users/ryanio/followers",
    "following_url": "https://api.github.com/users/ryanio/following{/other_user}",
    "gists_url": "https://api.github.com/users/ryanio/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ryanio/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ryanio/subscriptions",
    "organizations_url": "https://api.github.com/users/ryanio/orgs",
    "repos_url": "https://api.github.com/users/ryanio/repos",
    "events_url": "https://api.github.com/users/ryanio/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ryanio/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 901960538,
      "node_id": "MDU6TGFiZWw5MDE5NjA1Mzg=",
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/labels/type:bug",
      "name": "type:bug",
      "color": "FBCA04",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 4937720577,
      "node_id": "LA_kwDOB7jojM8AAAABJk-jAQ",
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/labels/status:ready",
      "name": "status:ready",
      "color": "0E8A16",
      "default": false,
      "description": "This issue is ready to be worked on"
    },
    {
      "id": 4952257781,
      "node_id": "LA_kwDOB7jojM8AAAABJy109Q",
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/labels/area:chai-matchers",
      "name": "area:chai-matchers",
      "color": "5319E7",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2023-04-10T17:16:43Z",
  "updated_at": "2023-08-24T23:48:22Z",
  "closed_at": null,
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "### Version of Hardhat\r\n\r\n2.13.1\r\n\r\n### What happened?\r\n\r\nGetting this error on the second and third `expect` in the included test file (the first `expect` passes fine):\r\n```\r\nAssertionError: expected [] to equal []\r\nexpected - actual\r\n```\r\n\r\n### Minimal reproduction steps\r\n\r\nTest.sol\r\n```solidity\r\n// SPDX-License-Identifier: UNLICENSED\r\npragma solidity ^0.8.9;\r\n\r\ncontract Test {\r\n    struct TestStruct1 {\r\n        address[] a;\r\n    }\r\n    struct TestStruct2 {\r\n        address a;\r\n        address[] b;\r\n    }\r\n    event TestEvent1(TestStruct1 test);\r\n    event TestEvent2(TestStruct2 test);\r\n\r\n    function test1() public {\r\n        TestStruct1 memory testStruct = TestStruct1({a: new address[](0)});\r\n        emit TestEvent1(testStruct);\r\n    }\r\n\r\n    function test2() public {\r\n        TestStruct2 memory testStruct = TestStruct2({\r\n            a: address(0),\r\n            b: new address[](0)\r\n        });\r\n        emit TestEvent2(testStruct);\r\n    }\r\n}\r\n\r\n```\r\n\r\nTest.ts\r\n```typescript\r\nimport { expect } from \"chai\";\r\nimport { ethers } from \"hardhat\";\r\n\r\ndescribe(\"Test\", function () {\r\n  it(\"withArgs should handle comparing an array inside a struct\", async function () {\r\n    const Test = await ethers.getContractFactory(\"Test\");\r\n    const test = await Test.deploy();\r\n\r\n    // This passes fine.\r\n    await expect(test.test1()).to.emit(test, \"TestEvent1\").withArgs([]);\r\n\r\n    // Here is the issue.\r\n    await expect(test.test1()).to.emit(test, \"TestEvent1\").withArgs([[]]);\r\n\r\n    // This also errors.\r\n    await expect(test.test2())\r\n      .to.emit(test, \"TestEvent2\")\r\n      .withArgs([ethers.constants.AddressZero, []]);\r\n  });\r\n});\r\n```\r\n\r\n\r\n### Search terms\r\n\r\nwithArgs, deep, comparison",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3833/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3833/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1526532504",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/3833#issuecomment-1526532504",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3833",
    "id": 1526532504,
    "node_id": "IC_kwDOB7jojM5a_QmY",
    "user": {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-27T21:37:17Z",
    "updated_at": "2023-04-27T21:37:17Z",
    "author_association": "MEMBER",
    "body": "Confirmed, thanks for the great reproduction snippets!",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1526532504/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1526703818",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/3833#issuecomment-1526703818",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3833",
    "id": 1526703818,
    "node_id": "IC_kwDOB7jojM5a_6bK",
    "user": {
      "login": "ryanio",
      "id": 22116,
      "node_id": "MDQ6VXNlcjIyMTE2",
      "avatar_url": "https://avatars.githubusercontent.com/u/22116?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanio",
      "html_url": "https://github.com/ryanio",
      "followers_url": "https://api.github.com/users/ryanio/followers",
      "following_url": "https://api.github.com/users/ryanio/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanio/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanio/orgs",
      "repos_url": "https://api.github.com/users/ryanio/repos",
      "events_url": "https://api.github.com/users/ryanio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-27T23:04:56Z",
    "updated_at": "2023-04-27T23:04:56Z",
    "author_association": "CONTRIBUTOR",
    "body": "@fvictorio champion, thank you!",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1526703818/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 1,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1692556767",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/3833#issuecomment-1692556767",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3833",
    "id": 1692556767,
    "node_id": "IC_kwDOB7jojM5k4l3f",
    "user": {
      "login": "albertnbrown",
      "id": 38142946,
      "node_id": "MDQ6VXNlcjM4MTQyOTQ2",
      "avatar_url": "https://avatars.githubusercontent.com/u/38142946?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/albertnbrown",
      "html_url": "https://github.com/albertnbrown",
      "followers_url": "https://api.github.com/users/albertnbrown/followers",
      "following_url": "https://api.github.com/users/albertnbrown/following{/other_user}",
      "gists_url": "https://api.github.com/users/albertnbrown/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/albertnbrown/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/albertnbrown/subscriptions",
      "organizations_url": "https://api.github.com/users/albertnbrown/orgs",
      "repos_url": "https://api.github.com/users/albertnbrown/repos",
      "events_url": "https://api.github.com/users/albertnbrown/events{/privacy}",
      "received_events_url": "https://api.github.com/users/albertnbrown/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-08-24T23:48:21Z",
    "updated_at": "2023-08-24T23:48:21Z",
    "author_association": "NONE",
    "body": "Experienced this issue but with an array of structs, was able to fix locally by changing the `.equal` on [this line](https://github.com/NomicFoundation/hardhat/blob/8a91508b521cd35d5697d9de935286eba373fc78/packages/hardhat-chai-matchers/src/internal/emit.ts#L212) to an `.eql` (the assertion passed). Not sure if this fully addresses the issue above.\r\n\r\nThe solution is not quite ideal because of how the raw event log objects are constructed (as you'll see in my example code), but `emit.ts` could try to convert objects to the desired form or take the event logs and remove the extra properties.\r\n\r\nI'm using:\r\n```\r\n\"hardhat\": \"^2.13.1\",\r\n\"@nomiclabs/hardhat-waffle\": \"^2.0.1\",\r\n```\r\nbut I haven't seen a change in this issue since this version, let me know if I'm wrong.\r\n\r\nreproduction steps:\r\n\r\nTest.sol\r\n\r\n```\r\n// SPDX-License-Identifier: UNLICENSED\r\npragma solidity ^0.8.9;\r\n\r\ncontract Test {\r\n    struct TestStruct {\r\n        address a;\r\n        uint256 b;\r\n    }\r\n\r\n    event TestEvent(TestStruct[] test);\r\n\r\n    function test(TestStruct[] calldata testArray) public {\r\n        emit TestEvent(testArray);\r\n    }\r\n}\r\n```\r\n\r\nTest.ts\r\n\r\n```\r\nimport { expect } from \"chai\";\r\nimport { ethers } from \"hardhat\";\r\n\r\ndescribe(\"Test\", function () {\r\nconst PLACEHOLDER_ADDRESS1 = '0x1111111111111111111111111111111111111111'\r\nconst PLACEHOLDER_ADDRESS2 = '0x2222222222222222222222222222222222222222'\r\n\r\n  it(\"withArgs should handle comparing a struct inside an array\", async function () {\r\n    const Test = await ethers.getContractFactory(\"Test\");\r\n    const test = await Test.deploy();\r\n\r\n    const testArray = [{a: PLACEHOLDER_ADDRESS1, b: 1}, {a: PLACEHOLDER_ADDRESS2, b:2}]\r\n\r\n    // This errors because the format in events has both array-like properties and object-like properties\r\n    await expect(test.test(testArray)).to.emit(test, \"TestEvent\").withArgs(testArray);\r\n\r\n    // This passes if assertArgsArraysEqual uses deep equals, however the mix of array and object type is pretty rough\r\n    const eventTestArray = testArray.map((obj) => { return [obj.a, obj.b] })\r\n    eventTestArray.forEach((obj) => { obj['a'] = obj[0]; obj['b'] = obj[1] })\r\n    await expect(test.test(testArray)).to.emit(test, \"TestEvent\").withArgs(testArray);\r\n});\r\n```\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1692556767/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
