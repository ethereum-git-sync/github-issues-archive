{
  "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3339",
  "repository_url": "https://api.github.com/repos/NomicFoundation/hardhat",
  "labels_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3339/labels{/name}",
  "comments_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3339/comments",
  "events_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3339/events",
  "html_url": "https://github.com/NomicFoundation/hardhat/issues/3339",
  "id": 1445582620,
  "node_id": "I_kwDOB7jojM5WKdcc",
  "number": 3339,
  "title": "Swap in uniswap with error \"UniswapV2: TRANSFER_FAILED\" in hardhat network fork",
  "user": {
    "login": "TangMonk",
    "id": 3498786,
    "node_id": "MDQ6VXNlcjM0OTg3ODY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3498786?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/TangMonk",
    "html_url": "https://github.com/TangMonk",
    "followers_url": "https://api.github.com/users/TangMonk/followers",
    "following_url": "https://api.github.com/users/TangMonk/following{/other_user}",
    "gists_url": "https://api.github.com/users/TangMonk/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/TangMonk/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/TangMonk/subscriptions",
    "organizations_url": "https://api.github.com/users/TangMonk/orgs",
    "repos_url": "https://api.github.com/users/TangMonk/repos",
    "events_url": "https://api.github.com/users/TangMonk/events{/privacy}",
    "received_events_url": "https://api.github.com/users/TangMonk/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": true,
  "assignee": {
    "login": "fvictorio",
    "id": 417134,
    "node_id": "MDQ6VXNlcjQxNzEzNA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/fvictorio",
    "html_url": "https://github.com/fvictorio",
    "followers_url": "https://api.github.com/users/fvictorio/followers",
    "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
    "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
    "organizations_url": "https://api.github.com/users/fvictorio/orgs",
    "repos_url": "https://api.github.com/users/fvictorio/repos",
    "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
    "received_events_url": "https://api.github.com/users/fvictorio/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2022-11-11T14:52:09Z",
  "updated_at": "2023-02-15T00:15:27Z",
  "closed_at": "2022-11-16T12:01:29Z",
  "author_association": "NONE",
  "active_lock_reason": "resolved",
  "body": "I am trying to swap token in hardhat network fork in ethereum\r\n\r\n```\r\n(async () => {\r\n    const Web3 = require('web3');\r\n    const ethers = require('ethers');\r\n    const web3 = new Web3(\"http://127.0.0.1:8545/\") // connect hardhat\r\n\r\n    const ROUTER_V2 = \"0x7a250d5630B4cF539739dF2C5dAcb4c659F2488D\"\r\n    const WETH = \"0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2\"\r\n    const WCI_TOKEN = \"0xC5a9BC46A7dbe1c6dE493E84A18f02E70E2c5A32\"\r\n\r\n    const pubKey = \"0x8626f6940E2eb28930eFb4CeF49B2d1F2C9C1199\"\r\n    const priKey = \"0xdf57089febbacf7ba0bc227dafbffa9fc08a93fdc68e1e42411a14efcf23656e\"\r\n\r\n    const account = web3.eth.accounts.privateKeyToAccount(priKey);\r\n    web3.eth.accounts.wallet.add(account);\r\n    web3.eth.defaultAccount = account.address;\r\n\r\n\r\n    let abi = [\r\n        {\r\n            \"inputs\": [\r\n                {\r\n                    \"internalType\": \"uint256\",\r\n                    \"name\": \"amountIn\",\r\n                    \"type\": \"uint256\"\r\n                },\r\n                {\r\n                    \"internalType\": \"address[]\",\r\n                    \"name\": \"path\",\r\n                    \"type\": \"address[]\"\r\n                }\r\n            ],\r\n            \"name\": \"getAmountsOut\",\r\n            \"outputs\": [\r\n                {\r\n                    \"internalType\": \"uint256[]\",\r\n                    \"name\": \"amounts\",\r\n                    \"type\": \"uint256[]\"\r\n                }\r\n            ],\r\n            \"stateMutability\": \"view\",\r\n            \"type\": \"function\"\r\n        },\r\n        {\r\n            \"inputs\": [\r\n                {\r\n                    \"internalType\": \"uint256\",\r\n                    \"name\": \"amountOutMin\",\r\n                    \"type\": \"uint256\"\r\n                },\r\n                {\r\n                    \"internalType\": \"address[]\",\r\n                    \"name\": \"path\",\r\n                    \"type\": \"address[]\"\r\n                },\r\n                {\r\n                    \"internalType\": \"address\",\r\n                    \"name\": \"to\",\r\n                    \"type\": \"address\"\r\n                },\r\n                {\r\n                    \"internalType\": \"uint256\",\r\n                    \"name\": \"deadline\",\r\n                    \"type\": \"uint256\"\r\n                }\r\n            ],\r\n            \"name\": \"swapExactETHForTokens\",\r\n            \"outputs\": [\r\n                {\r\n                    \"internalType\": \"uint256[]\",\r\n                    \"name\": \"amounts\",\r\n                    \"type\": \"uint256[]\"\r\n                }\r\n            ],\r\n            \"stateMutability\": \"payable\",\r\n            \"type\": \"function\"\r\n        }\r\n    ]\r\n\r\n    let uniswapRouter = new web3.eth.Contract(abi, ROUTER_V2)\r\n    let oneEth = web3.utils.toWei('1')\r\n\r\n    let getAmountOutTx = await uniswapRouter.methods.getAmountsOut(oneEth, [WETH, WCI_TOKEN]).call()\r\n\r\n    console.log(getAmountOutTx)\r\n\r\n    //swap\r\n    let deadline = web3.utils.toHex(Math.round(Date.now() / 1000) + 60 * 20)\r\n    let swapTx = uniswapRouter.methods.swapExactETHForTokens(0, [WETH, WCI_TOKEN], pubKey, deadline)\r\n    let swapTxGas = await swapTx.estimateGas({ from: pubKey, value: oneEth })\r\n    let swapTxData = await swapTx.send({value: oneEth, from: pubKey, gas: swapTxGas})\r\n    \r\n    console.log(swapTxData);\r\n})()\r\n```\r\nThis above code will success at first time, But will failed in second time, why?thanks\r\n\r\nAnd there is a another weird problem, If I change the default wallet with a new wallet with `web3.eth.defaultAccount = newWallet;`(Wallet provide by hardhat), it will success, it is ok.  it is as expected.\r\n\r\nBut I switch back to the before wallet, it success unexpectedly.\r\n\r\nLike following:\r\n\r\n```\r\nWallet 1 - Swap token -> SUCCESS\r\nWallet 1 - Swap token -> FAILED  (WEIRD)\r\nWallet 2 - Swap token -> SUCCESS\r\nWallet 1 - Swap Token -> SUCCESS  (WEIRD)\r\n```",
  "closed_by": {
    "login": "fvictorio",
    "id": 417134,
    "node_id": "MDQ6VXNlcjQxNzEzNA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/fvictorio",
    "html_url": "https://github.com/fvictorio",
    "followers_url": "https://api.github.com/users/fvictorio/followers",
    "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
    "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
    "organizations_url": "https://api.github.com/users/fvictorio/orgs",
    "repos_url": "https://api.github.com/users/fvictorio/repos",
    "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
    "received_events_url": "https://api.github.com/users/fvictorio/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3339/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3339/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1311786229",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/3339#issuecomment-1311786229",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3339",
    "id": 1311786229,
    "node_id": "IC_kwDOB7jojM5OMET1",
    "user": {
      "login": "github-actions[bot]",
      "id": 41898282,
      "node_id": "MDM6Qm90NDE4OTgyODI=",
      "avatar_url": "https://avatars.githubusercontent.com/in/15368?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/github-actions%5Bbot%5D",
      "html_url": "https://github.com/apps/github-actions",
      "followers_url": "https://api.github.com/users/github-actions%5Bbot%5D/followers",
      "following_url": "https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}",
      "gists_url": "https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/github-actions%5Bbot%5D/subscriptions",
      "organizations_url": "https://api.github.com/users/github-actions%5Bbot%5D/orgs",
      "repos_url": "https://api.github.com/users/github-actions%5Bbot%5D/repos",
      "events_url": "https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}",
      "received_events_url": "https://api.github.com/users/github-actions%5Bbot%5D/received_events",
      "type": "Bot",
      "site_admin": false
    },
    "created_at": "2022-11-11T14:52:35Z",
    "updated_at": "2022-11-11T14:52:35Z",
    "author_association": "CONTRIBUTOR",
    "body": "This issue is also being [tracked on Linear](https://linear.app/nomic-foundation/issue/HH-1326/swap-in-uniswap-with-error-uniswapv2-transfer-failed-in-hardhat).\n\nWe use Linear to manage our development process, but we keep the conversations on Github.\n\nLINEAR-ID: c398ce63-43d7-4253-b3f6-f11b5f167182",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1311786229/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1316894277",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/3339#issuecomment-1316894277",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3339",
    "id": 1316894277,
    "node_id": "IC_kwDOB7jojM5OfjZF",
    "user": {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-11-16T12:01:28Z",
    "updated_at": "2022-11-16T12:01:28Z",
    "author_association": "MEMBER",
    "body": "I don't think this is related to Hardhat. That token seems to have some constraint that doesn't let you send it to the same address in to consecutive blocks, or something like that. Notice that if you mine an empty block after making the swap, you can do it again from the same account.\r\n\r\nThat's all the help I can give you. For the record, we don't give support for app-specific issues like this. I just checked in the case that this was a bug in Hardhat and figured out that.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1316894277/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
