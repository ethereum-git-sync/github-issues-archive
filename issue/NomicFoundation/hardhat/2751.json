{
  "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2751",
  "repository_url": "https://api.github.com/repos/NomicFoundation/hardhat",
  "labels_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2751/labels{/name}",
  "comments_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2751/comments",
  "events_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2751/events",
  "html_url": "https://github.com/NomicFoundation/hardhat/issues/2751",
  "id": 1246878294,
  "node_id": "I_kwDOB7jojM5KUdpW",
  "number": 2751,
  "title": "Custom errors not recognized with `delegatecall` in a `constructor`",
  "user": {
    "login": "nataouze",
    "id": 16722185,
    "node_id": "MDQ6VXNlcjE2NzIyMTg1",
    "avatar_url": "https://avatars.githubusercontent.com/u/16722185?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/nataouze",
    "html_url": "https://github.com/nataouze",
    "followers_url": "https://api.github.com/users/nataouze/followers",
    "following_url": "https://api.github.com/users/nataouze/following{/other_user}",
    "gists_url": "https://api.github.com/users/nataouze/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/nataouze/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/nataouze/subscriptions",
    "organizations_url": "https://api.github.com/users/nataouze/orgs",
    "repos_url": "https://api.github.com/users/nataouze/repos",
    "events_url": "https://api.github.com/users/nataouze/events{/privacy}",
    "received_events_url": "https://api.github.com/users/nataouze/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 901960538,
      "node_id": "MDU6TGFiZWw5MDE5NjA1Mzg=",
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/labels/type:bug",
      "name": "type:bug",
      "color": "FBCA04",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 4937720577,
      "node_id": "LA_kwDOB7jojM8AAAABJk-jAQ",
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/labels/status:ready",
      "name": "status:ready",
      "color": "0E8A16",
      "default": false,
      "description": "This issue is ready to be worked on"
    },
    {
      "id": 4951951046,
      "node_id": "LA_kwDOB7jojM8AAAABJyjGxg",
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/labels/area:error-inferrer",
      "name": "area:error-inferrer",
      "color": "5319E7",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2022-05-24T17:11:30Z",
  "updated_at": "2023-01-03T09:16:46Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "<!--\r\n\r\nThank you for using Hardhat and taking the time to open an issue!\r\n\r\n**Note that this issue tracker is not a support channel.**\r\n\r\n- For help with Hardhat and Hardhat network, please use our [Discord server](https://hardhat.org/discord).\r\n- For help with ethers.js, please go to [its Github Discussions](https://github.com/ethers-io/ethers.js/discussions).\r\n\r\nIf you are reporting a bug, please include reproduction steps. The best way to do this is to include a [Minimal Reproducible Example](https://stackoverflow.com/help/minimal-reproducible-example). If you can't do that, then include a link to your repo, and the steps to reproduce the problem. The easiest it is to reproduce your problem, the faster we are going to be able to fix it.\r\n\r\nIf you are submitting a feature request, please take the time to clearly describe your use case, and not only your proposed solution.\r\n\r\nThis issue will be automatically assigned to a Hardhat team member. This person will act as the point of contact between you and the team, but won't necessarily fix it nor address it in any way. An issue being assigned does not mean that it's being worked on.\r\n\r\n-->\r\n\r\nWe have a contract which reverts with a custom error.\r\nWe have a proxy which rethrows errors after using `delegatecall` on a target contract. Typically:\r\n```solidity\r\n        (bool success, bytes memory returndata) = target.delegatecall(data);\r\n        if (!success) {\r\n            assembly {\r\n                revert(add(32, returndata), mload(returndata))\r\n            }\r\n        }\r\n```\r\n\r\nWhen the contract reverts while being `delegatecall`'ed by the proxy, hardhat successfully matches the custom error: `Error: VM Exception while processing transaction: reverted with custom error 'MyCustomErrror()'`\r\n\r\nExcept if the proxy operates the `delegatecall` within its own constructor. In this case we obtain `VM Exception while processing transaction: reverted with an unrecognized custom error` instead.\r\n\r\nHere are the logs generated in both cases.\r\n\r\nRethrow custom error from delegatecall at function call:\r\n```\r\n     Error: VM Exception while processing transaction: reverted with custom error 'MyCustomErrror()'\r\n    at CustomErrorContract.a (contracts/CustomErrorContract.sol:8)\r\n    at RethrowAtFunctionCall.test (contracts/RethrowAtFunctionCall.sol:6)\r\n    at HardhatNode._mineBlockWithPendingTxs (node_modules/hardhat/src/internal/hardhat-network/provider/node.ts:1773:23)\r\n    at HardhatNode.mineBlock (node_modules/hardhat/src/internal/hardhat-network/provider/node.ts:466:16)\r\n    at EthModule._sendTransactionAndReturnHash (node_modules/hardhat/src/internal/hardhat-network/provider/modules/eth.ts:1504:18)\r\n    at HardhatNetworkProvider.request (node_modules/hardhat/src/internal/hardhat-network/provider/provider.ts:118:18)\r\n    at EthersProviderWrapper.send (node_modules/@nomiclabs/hardhat-ethers/src/internal/ethers-provider-wrapper.ts:13:20)\r\n```\r\n\r\nRethrow custom error from delegatecall at construction:\r\n```\r\n     Error: cannot estimate gas; transaction may fail or may require manual gas limit [ See: https://links.ethers.org/v5-errors-UNPREDICTABLE_GAS_LIMIT ] (reason=\"VM Exception while processing transaction: reverted with an unrecognized custom error\", method=\"estimateGas\", transaction={\"from\":\"0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266\",\"data\":\"0x608060405234801561001057600080fd5b5060405161039838038061039883398181016040528101906100329190610291565b6000808373ffffffffffffffffffffffffffffffffffffffff168360405161005a9190610334565b600060405180830381855af49150503d8060008114610095576040519150601f19603f3d011682016040523d82523d6000602084013e61009a565b606091505b5091509150816100ac57805181602001fd5b5050505061034b565b6000604051905090565b600080fd5b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b60006100f4826100c9565b9050919050565b610104816100e9565b811461010f57600080fd5b50565b600081519050610121816100fb565b92915050565b600080fd5b600080fd5b6000601f19601f8301169050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b61017a82610131565b810181811067ffffffffffffffff8211171561019957610198610142565b5b80604052505050565b60006101ac6100b5565b90506101b88282610171565b919050565b600067ffffffffffffffff8211156101d8576101d7610142565b5b6101e182610131565b9050602081019050919050565b60005b8381101561020c5780820151818401526020810190506101f1565b8381111561021b576000848401525b50505050565b600061023461022f846101bd565b6101a2565b9050828152602081018484840111156102505761024f61012c565b5b61025b8482856101ee565b509392505050565b600082601f83011261027857610277610127565b5b8151610288848260208601610221565b91505092915050565b600080604083850312156102a8576102a76100bf565b5b60006102b685828601610112565b925050602083015167ffffffffffffffff8111156102d7576102d66100c4565b5b6102e385828601610263565b9150509250929050565b600081519050919050565b600081905092915050565b600061030e826102ed565b61031881856102f8565b93506103288185602086016101ee565b80840191505092915050565b60006103408284610303565b915081905092915050565b603f806103596000396000f3fe6080604052600080fdfea26469706673582212204e728f862565e731f8737313ac0debd0b7011a81bb878cf6ee7613c61923442864736f6c634300080e0033000000000000000000000000cf7ed3acca5a467e9e704c703e8d87f634fb0fc9000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000040dbe671f00000000000000000000000000000000000000000000000000000000\",\"accessList\":null}, error={\"stackTrace\":[{\"type\":6,\"sourceReference\":{\"function\":\"constructor\",\"contract\":\"RethrowAtConstruction\",\"sourceName\":\"contracts/RethrowAtConstruction.sol\",\"sourceContent\":\"// SPDX-License-Identifier: Unlicense\\npragma solidity ^0.8.0;\\n\\ncontract RethrowAtConstruction {\\n    constructor(address target, bytes memory data) {\\n        (bool success, bytes memory returndata) = target.delegatecall(data);\\n        if (!success) {\\n            assembly {\\n                revert(add(32, returndata), mload(returndata))\\n            }\\n        }\\n    }\\n}\\n\",\"line\":9,\"range\":[289,335]},\"message\":\"reverted with an unrecognized custom error\"}],\"data\":\"0x158b4da0\"}, code=UNPREDICTABLE_GAS_LIMIT, version=providers/5.6.7)\r\n      at Logger.makeError (node_modules/@ethersproject/logger/src.ts/index.ts:261:28)\r\n      at Logger.throwError (node_modules/@ethersproject/logger/src.ts/index.ts:273:20)\r\n      at checkError (node_modules/@ethersproject/providers/src.ts/json-rpc-provider.ts:78:20)\r\n      at EthersProviderWrapper.<anonymous> (node_modules/@ethersproject/providers/src.ts/json-rpc-provider.ts:603:20)\r\n      at step (node_modules/@ethersproject/providers/lib/json-rpc-provider.js:48:23)\r\n      at Object.throw (node_modules/@ethersproject/providers/lib/json-rpc-provider.js:29:53)\r\n      at rejected (node_modules/@ethersproject/providers/lib/json-rpc-provider.js:21:65)\r\n```\r\n\r\n[Minimal Reproducible Example]\r\nhttps://github.com/nataouze/hardhat-rethrow-reproduction",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2751/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2751/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1136208210",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/2751#issuecomment-1136208210",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2751",
    "id": 1136208210,
    "node_id": "IC_kwDOB7jojM5DuSlS",
    "user": {
      "login": "github-actions[bot]",
      "id": 41898282,
      "node_id": "MDM6Qm90NDE4OTgyODI=",
      "avatar_url": "https://avatars.githubusercontent.com/in/15368?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/github-actions%5Bbot%5D",
      "html_url": "https://github.com/apps/github-actions",
      "followers_url": "https://api.github.com/users/github-actions%5Bbot%5D/followers",
      "following_url": "https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}",
      "gists_url": "https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/github-actions%5Bbot%5D/subscriptions",
      "organizations_url": "https://api.github.com/users/github-actions%5Bbot%5D/orgs",
      "repos_url": "https://api.github.com/users/github-actions%5Bbot%5D/repos",
      "events_url": "https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}",
      "received_events_url": "https://api.github.com/users/github-actions%5Bbot%5D/received_events",
      "type": "Bot",
      "site_admin": false
    },
    "created_at": "2022-05-24T17:12:05Z",
    "updated_at": "2022-05-24T17:12:05Z",
    "author_association": "CONTRIBUTOR",
    "body": "This issue is also being [tracked on Linear](https://linear.app/nomic-foundation/issue/HH-713/custom-errors-not-recognized-with-delegatecall-in-a-constructor).\n\nWe use Linear to manage our development process, but we keep the conversations on Github.\n\nLINEAR-ID: 69f232aa-50b3-49ad-829f-debc2c1871f6",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1136208210/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1164688372",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/2751#issuecomment-1164688372",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2751",
    "id": 1164688372,
    "node_id": "IC_kwDOB7jojM5Fa7v0",
    "user": {
      "login": "github-actions[bot]",
      "id": 41898282,
      "node_id": "MDM6Qm90NDE4OTgyODI=",
      "avatar_url": "https://avatars.githubusercontent.com/in/15368?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/github-actions%5Bbot%5D",
      "html_url": "https://github.com/apps/github-actions",
      "followers_url": "https://api.github.com/users/github-actions%5Bbot%5D/followers",
      "following_url": "https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}",
      "gists_url": "https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/github-actions%5Bbot%5D/subscriptions",
      "organizations_url": "https://api.github.com/users/github-actions%5Bbot%5D/orgs",
      "repos_url": "https://api.github.com/users/github-actions%5Bbot%5D/repos",
      "events_url": "https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}",
      "received_events_url": "https://api.github.com/users/github-actions%5Bbot%5D/received_events",
      "type": "Bot",
      "site_admin": false
    },
    "created_at": "2022-06-23T17:35:56Z",
    "updated_at": "2022-06-23T17:35:56Z",
    "author_association": "CONTRIBUTOR",
    "body": "This issue was marked as stale because it didn't have any activity in the last 30 days. If you think it's still relevant, please leave a comment indicating so. Otherwise, it will be closed in 7 days.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1164688372/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1165079733",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/2751#issuecomment-1165079733",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2751",
    "id": 1165079733,
    "node_id": "IC_kwDOB7jojM5FcbS1",
    "user": {
      "login": "nataouze",
      "id": 16722185,
      "node_id": "MDQ6VXNlcjE2NzIyMTg1",
      "avatar_url": "https://avatars.githubusercontent.com/u/16722185?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nataouze",
      "html_url": "https://github.com/nataouze",
      "followers_url": "https://api.github.com/users/nataouze/followers",
      "following_url": "https://api.github.com/users/nataouze/following{/other_user}",
      "gists_url": "https://api.github.com/users/nataouze/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nataouze/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nataouze/subscriptions",
      "organizations_url": "https://api.github.com/users/nataouze/orgs",
      "repos_url": "https://api.github.com/users/nataouze/repos",
      "events_url": "https://api.github.com/users/nataouze/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nataouze/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-06-24T01:34:23Z",
    "updated_at": "2022-06-24T01:34:23Z",
    "author_association": "NONE",
    "body": "Is there any plan to take a look at this issue? Thank you",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1165079733/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1180253053",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/2751#issuecomment-1180253053",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2751",
    "id": 1180253053,
    "node_id": "IC_kwDOB7jojM5GWTt9",
    "user": {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-11T10:58:44Z",
    "updated_at": "2022-07-11T10:58:44Z",
    "author_association": "MEMBER",
    "body": "Sorry for not responding before @nataouze, I can confirm this. Thanks a lot for the reproduction example, it was extremely helpful.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1180253053/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
