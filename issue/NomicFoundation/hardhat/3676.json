{
  "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3676",
  "repository_url": "https://api.github.com/repos/NomicFoundation/hardhat",
  "labels_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3676/labels{/name}",
  "comments_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3676/comments",
  "events_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3676/events",
  "html_url": "https://github.com/NomicFoundation/hardhat/issues/3676",
  "id": 1585807452,
  "node_id": "I_kwDOB7jojM5ehYBc",
  "number": 3676,
  "title": "ESM Support / Runtime Network Change Support",
  "user": {
    "login": "mihaic195",
    "id": 34626017,
    "node_id": "MDQ6VXNlcjM0NjI2MDE3",
    "avatar_url": "https://avatars.githubusercontent.com/u/34626017?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mihaic195",
    "html_url": "https://github.com/mihaic195",
    "followers_url": "https://api.github.com/users/mihaic195/followers",
    "following_url": "https://api.github.com/users/mihaic195/following{/other_user}",
    "gists_url": "https://api.github.com/users/mihaic195/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mihaic195/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mihaic195/subscriptions",
    "organizations_url": "https://api.github.com/users/mihaic195/orgs",
    "repos_url": "https://api.github.com/users/mihaic195/repos",
    "events_url": "https://api.github.com/users/mihaic195/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mihaic195/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 4937119027,
      "node_id": "LA_kwDOB7jojM8AAAABJkZ1Mw",
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/labels/status:triaging",
      "name": "status:triaging",
      "color": "0E8A16",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": true,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2023-02-15T12:52:41Z",
  "updated_at": "2023-05-23T00:14:04Z",
  "closed_at": "2023-02-21T10:26:59Z",
  "author_association": "NONE",
  "active_lock_reason": "resolved",
  "body": "### Version of Hardhat\n\n2.12.7\n\n### What happened?\n\nRelated to: https://github.com/NomicFoundation/hardhat/issues/3043\r\n\r\nFor example: \r\nMultiple contracts with different configs are deployed programmatically, on a daily basis, on various chains. This is done through the browser using ethers.js and artifacts generated by the hardhat compilation in a next.js app.\r\nThe projects, contract tests, and hardhat config is written in TS.\r\n\r\nI need a way to use the HRE in an ESM environment (e.g. next.js backend API) to be able to verify the _said_ contracts using the `verify:verify` task. Since Next.js enforces ESM, I cannot use HRE in a next.js app.\n\n### Minimal reproduction steps\n\n- To solve the problem above, I created a microservice in nest.js with a `commonjs` config. \r\n- This allows me to create an endpoint and import HRE to run the `verify:verify` task once the endpoint is called.\r\n- In the nest.js project, I copied over the solidity contracts, compiled them with the same hardhat config from next.js, and moved the generated artifacts back to the next.js app so that there is a matching bytecode between next.js and nest.js.\r\n- Note: importing HRE was only possible if the hardhat config was written in JS, not in TS like in the next.js app.\r\n- Having hardhat config in JS in the next.js app is not an option as my tests are written in TS, and if the hardhat config is in JS, they won't be picked up by hardhat.\r\n\r\nAt this point, I'm faced with another issue:\r\n\r\n- The endpoint above is called with a specific chain ID based on the chain on which I want the contract to be verified. The default network is `hardhat`.\r\nSo I need a way to change the network at runtime, which I was only able to do with the help of this package: https://github.com/dmihal/hardhat-change-network.\r\n\r\n### TL;DR\r\n\r\nBecause of the limitations above, I'm forced to have a separate verification microservice instead of creating a simple endpoint in a next.js app. I also have to use some sorcery to change the network at runtime.\r\n\r\nIn the end, it works, but it's far from ideal, as it requires much maintenance to do it this way.\r\n\r\nI would gladly help in any way I can to overcome these issues if needed.\n\n### Search terms\n\nhre, hardhat runtime environment, verification, esm, commonjs",
  "closed_by": {
    "login": "fvictorio",
    "id": 417134,
    "node_id": "MDQ6VXNlcjQxNzEzNA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/fvictorio",
    "html_url": "https://github.com/fvictorio",
    "followers_url": "https://api.github.com/users/fvictorio/followers",
    "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
    "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
    "organizations_url": "https://api.github.com/users/fvictorio/orgs",
    "repos_url": "https://api.github.com/users/fvictorio/repos",
    "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
    "received_events_url": "https://api.github.com/users/fvictorio/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3676/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3676/timeline",
  "performed_via_github_app": null,
  "state_reason": "not_planned"
}
[
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1437024058",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/3676#issuecomment-1437024058",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3676",
    "id": 1437024058,
    "node_id": "IC_kwDOB7jojM5Vpz86",
    "user": {
      "login": "sshmaxime",
      "id": 25589782,
      "node_id": "MDQ6VXNlcjI1NTg5Nzgy",
      "avatar_url": "https://avatars.githubusercontent.com/u/25589782?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sshmaxime",
      "html_url": "https://github.com/sshmaxime",
      "followers_url": "https://api.github.com/users/sshmaxime/followers",
      "following_url": "https://api.github.com/users/sshmaxime/following{/other_user}",
      "gists_url": "https://api.github.com/users/sshmaxime/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sshmaxime/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sshmaxime/subscriptions",
      "organizations_url": "https://api.github.com/users/sshmaxime/orgs",
      "repos_url": "https://api.github.com/users/sshmaxime/repos",
      "events_url": "https://api.github.com/users/sshmaxime/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sshmaxime/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-02-20T13:25:47Z",
    "updated_at": "2023-02-20T13:25:47Z",
    "author_association": "CONTRIBUTOR",
    "body": "Hey @mihaic195, if I understood well, you want to run Hardhat on your backend service, in your case a serverless function of Next.Js, in order to call the `verify` task of Hardhat. This needs to be chain specific and therefore, depending on what chainId you receive in your endpoint you need to programmatically change the network accordingly ?\r\n\r\nIs that it ?",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1437024058/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1437161382",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/3676#issuecomment-1437161382",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3676",
    "id": 1437161382,
    "node_id": "IC_kwDOB7jojM5VqVem",
    "user": {
      "login": "mihaic195",
      "id": 34626017,
      "node_id": "MDQ6VXNlcjM0NjI2MDE3",
      "avatar_url": "https://avatars.githubusercontent.com/u/34626017?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mihaic195",
      "html_url": "https://github.com/mihaic195",
      "followers_url": "https://api.github.com/users/mihaic195/followers",
      "following_url": "https://api.github.com/users/mihaic195/following{/other_user}",
      "gists_url": "https://api.github.com/users/mihaic195/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mihaic195/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mihaic195/subscriptions",
      "organizations_url": "https://api.github.com/users/mihaic195/orgs",
      "repos_url": "https://api.github.com/users/mihaic195/repos",
      "events_url": "https://api.github.com/users/mihaic195/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mihaic195/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-02-20T15:05:23Z",
    "updated_at": "2023-02-20T15:05:23Z",
    "author_association": "NONE",
    "body": "@sshmaxime that is exactly right.\r\nAdditionally, Next.js is ESM only, so it's not possible to use Hardhat in a Next.js API endpoint, hence the reason for a separate Nest.js service using CommonJS.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1437161382/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1437374698",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/3676#issuecomment-1437374698",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3676",
    "id": 1437374698,
    "node_id": "IC_kwDOB7jojM5VrJjq",
    "user": {
      "login": "sshmaxime",
      "id": 25589782,
      "node_id": "MDQ6VXNlcjI1NTg5Nzgy",
      "avatar_url": "https://avatars.githubusercontent.com/u/25589782?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sshmaxime",
      "html_url": "https://github.com/sshmaxime",
      "followers_url": "https://api.github.com/users/sshmaxime/followers",
      "following_url": "https://api.github.com/users/sshmaxime/following{/other_user}",
      "gists_url": "https://api.github.com/users/sshmaxime/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sshmaxime/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sshmaxime/subscriptions",
      "organizations_url": "https://api.github.com/users/sshmaxime/orgs",
      "repos_url": "https://api.github.com/users/sshmaxime/repos",
      "events_url": "https://api.github.com/users/sshmaxime/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sshmaxime/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-02-20T17:56:16Z",
    "updated_at": "2023-02-20T17:56:16Z",
    "author_association": "CONTRIBUTOR",
    "body": "Ok, then, could you explain **exactly** what your issue is about, other than Hardhat is not ESM compatible yet.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1437374698/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1438222141",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/3676#issuecomment-1438222141",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3676",
    "id": 1438222141,
    "node_id": "IC_kwDOB7jojM5VuYc9",
    "user": {
      "login": "mihaic195",
      "id": 34626017,
      "node_id": "MDQ6VXNlcjM0NjI2MDE3",
      "avatar_url": "https://avatars.githubusercontent.com/u/34626017?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mihaic195",
      "html_url": "https://github.com/mihaic195",
      "followers_url": "https://api.github.com/users/mihaic195/followers",
      "following_url": "https://api.github.com/users/mihaic195/following{/other_user}",
      "gists_url": "https://api.github.com/users/mihaic195/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mihaic195/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mihaic195/subscriptions",
      "organizations_url": "https://api.github.com/users/mihaic195/orgs",
      "repos_url": "https://api.github.com/users/mihaic195/repos",
      "events_url": "https://api.github.com/users/mihaic195/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mihaic195/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-02-21T10:21:46Z",
    "updated_at": "2023-02-21T10:21:46Z",
    "author_association": "NONE",
    "body": "Other than Hardhat is not ESM compatible yet, there is no straightforward way to change the network programmatically at runtime, except for using something like [hardhat-change-network](https://github.com/dmihal/hardhat-change-network), which is a hackish way of doing it as per the package author.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1438222141/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1438230194",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/3676#issuecomment-1438230194",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3676",
    "id": 1438230194,
    "node_id": "IC_kwDOB7jojM5Vuaay",
    "user": {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-02-21T10:26:59Z",
    "updated_at": "2023-02-21T10:26:59Z",
    "author_association": "MEMBER",
    "body": "Hi @mihaic195, I think what you want is covered by #3043, #2797 and maybe also #3385. #2797 is in turn blocked by #3042, which is about being able to create different HREs in runtime with different configs. In your case, this would let you create a new HRE with the proper network for each verification. Sadly, we don't have an ETA for this.\r\n\r\nI'm going to assume that those issues cover this use case and close this one. Please let me know if you disagree.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1438230194/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
