{
  "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3790",
  "repository_url": "https://api.github.com/repos/NomicFoundation/hardhat",
  "labels_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3790/labels{/name}",
  "comments_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3790/comments",
  "events_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3790/events",
  "html_url": "https://github.com/NomicFoundation/hardhat/issues/3790",
  "id": 1639116044,
  "node_id": "I_kwDOB7jojM5hsu0M",
  "number": 3790,
  "title": "Figure out and document how to use Hardhat with vitest",
  "user": {
    "login": "wighawag",
    "id": 790580,
    "node_id": "MDQ6VXNlcjc5MDU4MA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/790580?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/wighawag",
    "html_url": "https://github.com/wighawag",
    "followers_url": "https://api.github.com/users/wighawag/followers",
    "following_url": "https://api.github.com/users/wighawag/following{/other_user}",
    "gists_url": "https://api.github.com/users/wighawag/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/wighawag/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/wighawag/subscriptions",
    "organizations_url": "https://api.github.com/users/wighawag/orgs",
    "repos_url": "https://api.github.com/users/wighawag/repos",
    "events_url": "https://api.github.com/users/wighawag/events{/privacy}",
    "received_events_url": "https://api.github.com/users/wighawag/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 947232449,
      "node_id": "MDU6TGFiZWw5NDcyMzI0NDk=",
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/labels/type:docs",
      "name": "type:docs",
      "color": "FBCA04",
      "default": false,
      "description": "Documentation-related issue"
    },
    {
      "id": 4937720577,
      "node_id": "LA_kwDOB7jojM8AAAABJk-jAQ",
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/labels/status:ready",
      "name": "status:ready",
      "color": "0E8A16",
      "default": false,
      "description": "This issue is ready to be worked on"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2023-03-24T10:22:07Z",
  "updated_at": "2023-06-26T13:52:22Z",
  "closed_at": null,
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "### Version of Hardhat\n\n2.13.0\n\n### What happened?\n\nI tried to make my hardhat test work with vitest\r\n\r\njust replacing chai with vitest in the example in the doc and I get the following error:\r\n\r\n(typescript project)\r\n\r\n```\r\n FAIL  test/Lock.test.ts [ test/Lock.test.ts ]\r\nSyntaxError: Cannot use import statement outside a module\r\n ❯ importCsjOrEsModule node_modules/hardhat/src/internal/core/config/config-loading.ts:30:22\r\n ❯ loadConfigAndTasks node_modules/hardhat/src/internal/core/config/config-loading.ts:94:18\r\n\r\nModule /home/wighawag/dev/github/bug-reproduction/hardhat-vitest/hardhat.config.ts:1 seems to be an ES Module but shipped in a CommonJS package. You might want to create an issue to the package \"\" asking them to ship the file in .mjs extension or add \"type\": \"module\" in their package.json.\r\n\r\nAs a temporary workaround you can try to inline the package by updating your config:\r\n\r\n// vitest.config.js\r\nexport default {\r\n  test: {\r\n    deps: {\r\n      inline: [\r\n        \"\"\r\n      ]\r\n    }\r\n  }\r\n}\r\n```\n\n### Minimal reproduction steps\n\nhttps://github.com/bug-reproduction/hardhat-vitest\n\n### Search terms\n\nvitest",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3790/reactions",
    "total_count": 2,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 2
  },
  "timeline_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3790/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1529961250",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/3790#issuecomment-1529961250",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3790",
    "id": 1529961250,
    "node_id": "IC_kwDOB7jojM5bMVsi",
    "user": {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-01T17:07:16Z",
    "updated_at": "2023-05-01T17:07:16Z",
    "author_association": "MEMBER",
    "body": "Can confirm this happens. Sadly I don't have a workaround, but using a `hardhat.config.js` does work.\r\n\r\nMy guess is that vite is messing with Hardhat's loading of the ts config file. We should investigate if there's some way to exclude all hardhat files (and the config) from vite's \"execution\".",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1529961250/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1534758972",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/3790#issuecomment-1534758972",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3790",
    "id": 1534758972,
    "node_id": "IC_kwDOB7jojM5bepA8",
    "user": {
      "login": "clemsos",
      "id": 743246,
      "node_id": "MDQ6VXNlcjc0MzI0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/743246?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/clemsos",
      "html_url": "https://github.com/clemsos",
      "followers_url": "https://api.github.com/users/clemsos/followers",
      "following_url": "https://api.github.com/users/clemsos/following{/other_user}",
      "gists_url": "https://api.github.com/users/clemsos/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/clemsos/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/clemsos/subscriptions",
      "organizations_url": "https://api.github.com/users/clemsos/orgs",
      "repos_url": "https://api.github.com/users/clemsos/repos",
      "events_url": "https://api.github.com/users/clemsos/events{/privacy}",
      "received_events_url": "https://api.github.com/users/clemsos/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-04T13:12:27Z",
    "updated_at": "2023-05-04T13:12:27Z",
    "author_association": "NONE",
    "body": "Hello, I am trying to achieve vitest+hardhat too (migrating from jest). I have been running my tests with vitest against a hardhat node (with \"vanilla\" ethers and no specific hardhat feature instead). This works but I am running into nonces issue as the test use the `describe.each` pattern which will run all test in parrallel. Any idea?",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1534758972/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1534882532",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/3790#issuecomment-1534882532",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3790",
    "id": 1534882532,
    "node_id": "IC_kwDOB7jojM5bfHLk",
    "user": {
      "login": "julien51",
      "id": 17735,
      "node_id": "MDQ6VXNlcjE3NzM1",
      "avatar_url": "https://avatars.githubusercontent.com/u/17735?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/julien51",
      "html_url": "https://github.com/julien51",
      "followers_url": "https://api.github.com/users/julien51/followers",
      "following_url": "https://api.github.com/users/julien51/following{/other_user}",
      "gists_url": "https://api.github.com/users/julien51/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/julien51/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/julien51/subscriptions",
      "organizations_url": "https://api.github.com/users/julien51/orgs",
      "repos_url": "https://api.github.com/users/julien51/repos",
      "events_url": "https://api.github.com/users/julien51/events{/privacy}",
      "received_events_url": "https://api.github.com/users/julien51/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-04T14:27:26Z",
    "updated_at": "2023-05-04T14:27:26Z",
    "author_association": "CONTRIBUTOR",
    "body": "Could this be fixed with https://github.com/NomicFoundation/hardhat/issues/3385 ?",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1534882532/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1548182458",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/3790#issuecomment-1548182458",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3790",
    "id": 1548182458,
    "node_id": "IC_kwDOB7jojM5cR2O6",
    "user": {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-15T16:32:05Z",
    "updated_at": "2023-05-15T16:32:05Z",
    "author_association": "MEMBER",
    "body": "> Could this be fixed with #3385 ?\r\n\r\nMaybe? I don't know enough about vite to be sure.\r\n\r\n> Hello, I am trying to achieve vitest+hardhat too (migrating from jest). I have been running my tests with vitest against a hardhat node (with \"vanilla\" ethers and no specific hardhat feature instead). This works but I am running into nonces issue as the test use the `describe.each` pattern which will run all test in parrallel. Any idea?\r\n\r\nOh, interesting. My guess is that you should use a different account in each test, otherwise race conditions with the nonces are hard to avoid. In mocha, there is an environment variable that tells you the number of the worker running that test, so you could get the account N based on that, and use it for that file. For example:\r\n\r\n```\r\nconst accounts = // hardhat addresses\r\n\r\nconst senderAddress = accounts[viteWorkerId]; // use this in the rest of the tests\r\n```\r\n\r\nI don't know the specifics of your tests to help with the rest, but maybe that idea is useful for you.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1548182458/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
