{
  "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1466",
  "repository_url": "https://api.github.com/repos/NomicFoundation/hardhat",
  "labels_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1466/labels{/name}",
  "comments_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1466/comments",
  "events_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1466/events",
  "html_url": "https://github.com/NomicFoundation/hardhat/issues/1466",
  "id": 895406601,
  "node_id": "MDU6SXNzdWU4OTU0MDY2MDE=",
  "number": 1466,
  "title": "Should have recover logic dealing with cached `list.json` on compiler download interruption",
  "user": {
    "login": "AmagiDDmxh",
    "id": 22388514,
    "node_id": "MDQ6VXNlcjIyMzg4NTE0",
    "avatar_url": "https://avatars.githubusercontent.com/u/22388514?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/AmagiDDmxh",
    "html_url": "https://github.com/AmagiDDmxh",
    "followers_url": "https://api.github.com/users/AmagiDDmxh/followers",
    "following_url": "https://api.github.com/users/AmagiDDmxh/following{/other_user}",
    "gists_url": "https://api.github.com/users/AmagiDDmxh/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/AmagiDDmxh/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/AmagiDDmxh/subscriptions",
    "organizations_url": "https://api.github.com/users/AmagiDDmxh/orgs",
    "repos_url": "https://api.github.com/users/AmagiDDmxh/repos",
    "events_url": "https://api.github.com/users/AmagiDDmxh/events{/privacy}",
    "received_events_url": "https://api.github.com/users/AmagiDDmxh/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 901960538,
      "node_id": "MDU6TGFiZWw5MDE5NjA1Mzg=",
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/labels/type:bug",
      "name": "type:bug",
      "color": "FBCA04",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 901960542,
      "node_id": "MDU6TGFiZWw5MDE5NjA1NDI=",
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/labels/good-first-issue",
      "name": "good-first-issue",
      "color": "006B75",
      "default": false,
      "description": "Good for newcomers. Guidance available if needed"
    }
  ],
  "state": "closed",
  "locked": true,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2021-05-19T12:50:39Z",
  "updated_at": "2022-11-18T10:08:30Z",
  "closed_at": "2021-12-09T19:24:57Z",
  "author_association": "NONE",
  "active_lock_reason": "resolved",
  "body": "### Step to reproduce\r\n1. run `npx hardhat run scripts/deploy.js --network localhost` which would install new compiler\r\n2. In the middle, interrupt it by press `control` + `c`\r\n3. run `npx hardhat run scripts/deploy.js --network localhost` which would install new compiler again\r\n4. Error prompts\r\n```bash\r\nAn unexpected error occurred:\r\n\r\nSyntaxError: /Users/.../Library/Caches/hardhat-nodejs/compilers/macosx-amd64/list.json: Unexpected end of JSON input\r\n    at JSON.parse (<anonymous>)\r\n    at /Users/.../hardhat-hackathon-boilerplate/node_modules/jsonfile/index.js:33:18\r\n    at /Users/.../hardhat-hackathon-boilerplate/node_modules/graceful-fs/graceful-fs.js:123:16\r\n```\r\n\r\nDuring the interruption, write stream on the `list.json` simply turn off instead of recover the previous file, I guess.\r\n",
  "closed_by": {
    "login": "fvictorio",
    "id": 417134,
    "node_id": "MDQ6VXNlcjQxNzEzNA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/fvictorio",
    "html_url": "https://github.com/fvictorio",
    "followers_url": "https://api.github.com/users/fvictorio/followers",
    "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
    "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
    "organizations_url": "https://api.github.com/users/fvictorio/orgs",
    "repos_url": "https://api.github.com/users/fvictorio/repos",
    "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
    "received_events_url": "https://api.github.com/users/fvictorio/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1466/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1466/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/844484543",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/1466#issuecomment-844484543",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1466",
    "id": 844484543,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg0NDQ4NDU0Mw==",
    "user": {
      "login": "alcuadrado",
      "id": 176499,
      "node_id": "MDQ6VXNlcjE3NjQ5OQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/176499?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alcuadrado",
      "html_url": "https://github.com/alcuadrado",
      "followers_url": "https://api.github.com/users/alcuadrado/followers",
      "following_url": "https://api.github.com/users/alcuadrado/following{/other_user}",
      "gists_url": "https://api.github.com/users/alcuadrado/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alcuadrado/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alcuadrado/subscriptions",
      "organizations_url": "https://api.github.com/users/alcuadrado/orgs",
      "repos_url": "https://api.github.com/users/alcuadrado/repos",
      "events_url": "https://api.github.com/users/alcuadrado/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alcuadrado/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-05-19T21:23:50Z",
    "updated_at": "2021-05-19T21:23:50Z",
    "author_association": "MEMBER",
    "body": "Thanks for reporting this issue, @AmagiDDmxh! \r\n\r\nI think the problem is that the interruption came in the middle of the `list.json` download. We should download it to a temporal file instead, and then move it, as it's a shorter (if not atomic) operation.\r\n\r\nIn the meantime, run `npx hardhat clean --global`.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/844484543/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/980075615",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/1466#issuecomment-980075615",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1466",
    "id": 980075615,
    "node_id": "IC_kwDOB7jojM46asRf",
    "user": {
      "login": "kanej",
      "id": 24030,
      "node_id": "MDQ6VXNlcjI0MDMw",
      "avatar_url": "https://avatars.githubusercontent.com/u/24030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/kanej",
      "html_url": "https://github.com/kanej",
      "followers_url": "https://api.github.com/users/kanej/followers",
      "following_url": "https://api.github.com/users/kanej/following{/other_user}",
      "gists_url": "https://api.github.com/users/kanej/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/kanej/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/kanej/subscriptions",
      "organizations_url": "https://api.github.com/users/kanej/orgs",
      "repos_url": "https://api.github.com/users/kanej/repos",
      "events_url": "https://api.github.com/users/kanej/events{/privacy}",
      "received_events_url": "https://api.github.com/users/kanej/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-11-26T15:58:57Z",
    "updated_at": "2021-11-26T15:58:57Z",
    "author_association": "MEMBER",
    "body": "I have been able to reproduce the error based on the assumption that the `list.json` file is only partially downloaded:\r\n\r\n1. create a new hardhat project based on the basic template\r\n2. Start `npx hardhat node`\r\n3. Run the sample deploy script `npx hardhat run ./scripts/sample-script.js --network localhost` triggering a compile (and compiler download)\r\n4. Edit the `/Users/<user-name>/Library/Caches/hardhat-nodejs/compilers/macosx-amd64/list.json` file to be a partial and invalid json file, so deleting half of it for instance\r\n5. Edit the `contracts/Greeter.sol` to force recompile on next deploy\r\n6. Rerun the sample deploy script `npx hardhat run ./scripts/sample-script.js --network localhost`\r\n\r\nThat gives the expected error:\r\n\r\n```shell\r\nAn unexpected error occurred:\r\n\r\nSyntaxError: /Users/<user-name>/Library/Caches/hardhat-nodejs/compilers/macosx-amd64/list.json: Unexpected end of JSON input\r\n    at JSON.parse (<anonymous>)\r\n    at /Users/<user-name>/projects/sandbox/another/node_modules/jsonfile/index.js:33:18\r\n    at /Users/<user-name>/projects/sandbox/another/node_modules/graceful-fs/graceful-fs.js:123:16\r\n    at FSReqCallback.readFileAfterClose [as oncomplete] (internal/fs/read_file_context.js:71:3)\r\n```\r\n\r\n## Approach\r\n\r\nRather than minimising the opportunity for a halt to leave the `list.json` in a bad state, can I suggest we have hardhat recover from a malformed `list.json` by redownloading it and trying to parse it once more. That would cover this case of an interrupted download but guard against malformed `list.json` more generally.\r\n\r\nI will push a PR showing the idea. \r\n",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/980075615/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/990158815",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/1466#issuecomment-990158815",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1466",
    "id": 990158815,
    "node_id": "IC_kwDOB7jojM47BJ_f",
    "user": {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-12-09T19:24:57Z",
    "updated_at": "2021-12-09T19:24:57Z",
    "author_association": "MEMBER",
    "body": "Fixed in [`hardhat@2.7.1`](https://github.com/nomiclabs/hardhat/releases/tag/hardhat%402.7.1)",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/990158815/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
