{
  "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2970",
  "repository_url": "https://api.github.com/repos/NomicFoundation/hardhat",
  "labels_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2970/labels{/name}",
  "comments_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2970/comments",
  "events_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2970/events",
  "html_url": "https://github.com/NomicFoundation/hardhat/issues/2970",
  "id": 1310827816,
  "node_id": "I_kwDOB7jojM5OIaUo",
  "number": 2970,
  "title": "hardhat-chai-matchers + OpenZeppelin.AccessControl: revertedWith AssertionError message reports expected equals actual",
  "user": {
    "login": "fabianorodrigo",
    "id": 23061789,
    "node_id": "MDQ6VXNlcjIzMDYxNzg5",
    "avatar_url": "https://avatars.githubusercontent.com/u/23061789?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/fabianorodrigo",
    "html_url": "https://github.com/fabianorodrigo",
    "followers_url": "https://api.github.com/users/fabianorodrigo/followers",
    "following_url": "https://api.github.com/users/fabianorodrigo/following{/other_user}",
    "gists_url": "https://api.github.com/users/fabianorodrigo/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/fabianorodrigo/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/fabianorodrigo/subscriptions",
    "organizations_url": "https://api.github.com/users/fabianorodrigo/orgs",
    "repos_url": "https://api.github.com/users/fabianorodrigo/repos",
    "events_url": "https://api.github.com/users/fabianorodrigo/events{/privacy}",
    "received_events_url": "https://api.github.com/users/fabianorodrigo/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": true,
  "assignee": {
    "login": "fvictorio",
    "id": 417134,
    "node_id": "MDQ6VXNlcjQxNzEzNA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/fvictorio",
    "html_url": "https://github.com/fvictorio",
    "followers_url": "https://api.github.com/users/fvictorio/followers",
    "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
    "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
    "organizations_url": "https://api.github.com/users/fvictorio/orgs",
    "repos_url": "https://api.github.com/users/fvictorio/repos",
    "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
    "received_events_url": "https://api.github.com/users/fvictorio/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2022-07-20T10:37:41Z",
  "updated_at": "2022-11-17T21:40:16Z",
  "closed_at": "2022-07-20T22:11:40Z",
  "author_association": "NONE",
  "active_lock_reason": "resolved",
  "body": "Hello guys,\r\n\r\nI believe I found out a problem in hardhat-chai-matchers or at least the AssertionError message is not clear.\r\nI'm using hardhat 2.10.1 and @openzeppelin/contracts 4.7.0.\r\n\r\nThe AssertionError message is:\r\n```\r\nAssertionError: Expected transaction to be reverted with reason 'AccessControl: account 0x15d34AAf54267DB7D7c367839AAf71A00a2C6A65 is missing role 0x9b82d2f38fbdf13006bfa741767f793d917e063392737837b580c1c2b1e0bab3', but it reverted with reason 'AccessControl: account 0x15d34aaf54267db7d7c367839aaf71a00a2c6a65 is missing role 0x9b82d2f38fbdf13006bfa741767f793d917e063392737837b580c1c2b1e0bab3'\r\n```\r\n\r\nAs you can check, the expected and received messages are equal.\r\n\r\n**CONTRACT**\r\n```\r\n// SPDX-License-Identifier: UNLICENSED\r\npragma solidity ^0.8.9;\r\n\r\nimport \"@openzeppelin/contracts/access/AccessControl.sol\";\r\n\r\ncontract ETHPool is AccessControl {\r\n    error InvalidAmount();\r\n    error NoActiveUsers();\r\n\r\n    event RewardDeposit(uint256 amount);\r\n\r\n    uint256 public poolBalance;\r\n\r\n    // List of active users, who are able to receive the next rewards\r\n    address[] public activeUsers;\r\n    // mapping from user address to its balance\r\n    mapping(address => uint) public balances;\r\n\r\n    // Create a new role identifier for the team role\r\n    bytes32 public constant TEAM_ROLE = keccak256(\"TEAM\");\r\n\r\n    constructor(address _manager) {\r\n        // Grant the admin role for all roles to a the publisher account\r\n        _setupRole(DEFAULT_ADMIN_ROLE, msg.sender);\r\n        // Each role has an associated admin role. Set the admin role for TEAM role to a specific account\r\n        _setupRole(getRoleAdmin(TEAM_ROLE), _manager);\r\n    }\r\n\r\n    function depositReward() external payable onlyRole(TEAM_ROLE) {\r\n        if (msg.value == 0) {\r\n            revert InvalidAmount();\r\n        }\r\n        if (activeUsers.length == 0) {\r\n            revert NoActiveUsers();\r\n        }\r\n        for (uint256 i = 0; i < activeUsers.length; i++) {\r\n            balances[activeUsers[i]] +=\r\n                (msg.value * balances[activeUsers[i]]) /\r\n                poolBalance;\r\n        }\r\n        poolBalance += msg.value;\r\n        emit RewardDeposit(msg.value);\r\n    }\r\n}\r\n```\r\n\r\nFIXTURE\r\n```\r\nimport {ethers} from \"hardhat\";\r\n\r\n// We use loadFixture to run this setup once, snapshot that state,\r\n// and reset Hardhat Network to that snapshopt in every test.\r\nexport async function deployETHPoolFixture() {\r\n  // Contracts are deployed using the first signer/account by default\r\n  const [\r\n    owner,\r\n    manager,\r\n    teamMember,\r\n    teamMemberB,\r\n    accountA,\r\n    accountB,\r\n    accountC,\r\n    accountD,\r\n    accountE,\r\n  ] = await ethers.getSigners();\r\n\r\n  const ETHPoolFactory = await ethers.getContractFactory(\"ETHPool\");\r\n  const ethPool = await ETHPoolFactory.deploy(manager.address);\r\n\r\n  const TEAM_ROLE = await ethPool.TEAM_ROLE();\r\n  const TEAM_ADMIN_ROLE = await ethPool.getRoleAdmin(TEAM_ROLE);\r\n\r\n  await ethPool.connect(owner).grantRole(TEAM_ROLE, teamMember.address);\r\n  await ethPool.connect(manager).grantRole(TEAM_ROLE, teamMemberB.address);\r\n\r\n  return {\r\n    ethPool,\r\n    owner,\r\n    manager,\r\n    teamMember,\r\n    teamMemberB,\r\n    accountA,\r\n    accountB,\r\n    accountC,\r\n    accountD,\r\n    accountE,\r\n    TEAM_ADMIN_ROLE,\r\n    TEAM_ROLE,\r\n  };\r\n}\r\n```\r\n\r\nTEST\r\n```\r\nimport {loadFixture} from \"@nomicfoundation/hardhat-network-helpers\";\r\nimport {expect} from \"chai\";\r\nimport {ethers} from \"hardhat\";\r\nimport {deployETHPoolFixture} from \"./shared/fixture\";\r\n\r\ndescribe(\"ETHPool\", function () {\r\n  // We use loadFixture to run this setup once, snapshot that state,\r\n  // and reset Hardhat Network to that snapshopt in every test.\r\n  const ETHPoolFixture = deployETHPoolFixture;\r\n\r\n  describe(\"Rewards\", function () {\r\n    it(\"Should revert if some account without team role try to send reward\", async function () {\r\n      const {ethPool, accountA, TEAM_ROLE} = await loadFixture(ETHPoolFixture);\r\n\r\n      await expect(\r\n        ethPool.connect(accountA).depositReward({\r\n          value: ethers.constants.One,\r\n        })\r\n      ).to.be.revertedWith(\r\n        `AccessControl: account ${accountA.address} is missing role ${TEAM_ROLE}`\r\n      );\r\n    });\r\n  });\r\n});\r\n```\r\n",
  "closed_by": {
    "login": "fabianorodrigo",
    "id": 23061789,
    "node_id": "MDQ6VXNlcjIzMDYxNzg5",
    "avatar_url": "https://avatars.githubusercontent.com/u/23061789?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/fabianorodrigo",
    "html_url": "https://github.com/fabianorodrigo",
    "followers_url": "https://api.github.com/users/fabianorodrigo/followers",
    "following_url": "https://api.github.com/users/fabianorodrigo/following{/other_user}",
    "gists_url": "https://api.github.com/users/fabianorodrigo/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/fabianorodrigo/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/fabianorodrigo/subscriptions",
    "organizations_url": "https://api.github.com/users/fabianorodrigo/orgs",
    "repos_url": "https://api.github.com/users/fabianorodrigo/repos",
    "events_url": "https://api.github.com/users/fabianorodrigo/events{/privacy}",
    "received_events_url": "https://api.github.com/users/fabianorodrigo/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2970/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2970/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1190113808",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/2970#issuecomment-1190113808",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2970",
    "id": 1190113808,
    "node_id": "IC_kwDOB7jojM5G77IQ",
    "user": {
      "login": "github-actions[bot]",
      "id": 41898282,
      "node_id": "MDM6Qm90NDE4OTgyODI=",
      "avatar_url": "https://avatars.githubusercontent.com/in/15368?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/github-actions%5Bbot%5D",
      "html_url": "https://github.com/apps/github-actions",
      "followers_url": "https://api.github.com/users/github-actions%5Bbot%5D/followers",
      "following_url": "https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}",
      "gists_url": "https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/github-actions%5Bbot%5D/subscriptions",
      "organizations_url": "https://api.github.com/users/github-actions%5Bbot%5D/orgs",
      "repos_url": "https://api.github.com/users/github-actions%5Bbot%5D/repos",
      "events_url": "https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}",
      "received_events_url": "https://api.github.com/users/github-actions%5Bbot%5D/received_events",
      "type": "Bot",
      "site_admin": false
    },
    "created_at": "2022-07-20T10:38:07Z",
    "updated_at": "2022-07-20T10:38:07Z",
    "author_association": "CONTRIBUTOR",
    "body": "This issue is also being [tracked on Linear](https://linear.app/nomic-foundation/issue/HH-979/hardhat-chai-matchers-openzeppelinaccesscontrol-revertedwith).\n\nWe use Linear to manage our development process, but we keep the conversations on Github.\n\nLINEAR-ID: 0efbb0b4-ecd6-4bb5-919e-b72a45295722",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1190113808/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1190655586",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/2970#issuecomment-1190655586",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2970",
    "id": 1190655586,
    "node_id": "IC_kwDOB7jojM5G9_Zi",
    "user": {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-20T19:13:29Z",
    "updated_at": "2022-07-20T19:13:29Z",
    "author_association": "MEMBER",
    "body": "Hi @fabianorodrigo, thanks for opening this. The errors you shared are not exactly equal though: the one you are using as the expected value has a checksummed address, while the one returned by the contract is all in lowercase.\r\n\r\nI think you just need to do this:\r\n\r\n```\r\n        `AccessControl: account ${accountA.address.toLowerCase()} is missing role ${TEAM_ROLE}`\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1190655586/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1190812579",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/2970#issuecomment-1190812579",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2970",
    "id": 1190812579,
    "node_id": "IC_kwDOB7jojM5G-luj",
    "user": {
      "login": "fabianorodrigo",
      "id": 23061789,
      "node_id": "MDQ6VXNlcjIzMDYxNzg5",
      "avatar_url": "https://avatars.githubusercontent.com/u/23061789?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fabianorodrigo",
      "html_url": "https://github.com/fabianorodrigo",
      "followers_url": "https://api.github.com/users/fabianorodrigo/followers",
      "following_url": "https://api.github.com/users/fabianorodrigo/following{/other_user}",
      "gists_url": "https://api.github.com/users/fabianorodrigo/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fabianorodrigo/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fabianorodrigo/subscriptions",
      "organizations_url": "https://api.github.com/users/fabianorodrigo/orgs",
      "repos_url": "https://api.github.com/users/fabianorodrigo/repos",
      "events_url": "https://api.github.com/users/fabianorodrigo/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fabianorodrigo/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-20T22:11:40Z",
    "updated_at": "2022-07-20T22:11:40Z",
    "author_association": "NONE",
    "body": "> Hi @fabianorodrigo, thanks for opening this. The errors you shared are not exactly equal though: the one you are using as the expected value has a checksummed address, while the one returned by the contract is all in lowercase.\r\n> \r\n> I think you just need to do this:\r\n> \r\n> ```\r\n>         `AccessControl: account ${accountA.address.toLowerCase()} is missing role ${TEAM_ROLE}`\r\n> ```\r\n\r\n@fvictorio , you're right! I haven't noticed this little difference.\r\nThank you also for your suggestion.\r\n\r\nRegards",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1190812579/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
