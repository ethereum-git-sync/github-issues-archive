{
  "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3006",
  "repository_url": "https://api.github.com/repos/NomicFoundation/hardhat",
  "labels_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3006/labels{/name}",
  "comments_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3006/comments",
  "events_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3006/events",
  "html_url": "https://github.com/NomicFoundation/hardhat/issues/3006",
  "id": 1326569838,
  "node_id": "I_kwDOB7jojM5PEdlu",
  "number": 3006,
  "title": "`hardhat_mine` doesn't work with large block numbers",
  "user": {
    "login": "wchargin",
    "id": 4317806,
    "node_id": "MDQ6VXNlcjQzMTc4MDY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4317806?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/wchargin",
    "html_url": "https://github.com/wchargin",
    "followers_url": "https://api.github.com/users/wchargin/followers",
    "following_url": "https://api.github.com/users/wchargin/following{/other_user}",
    "gists_url": "https://api.github.com/users/wchargin/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/wchargin/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/wchargin/subscriptions",
    "organizations_url": "https://api.github.com/users/wchargin/orgs",
    "repos_url": "https://api.github.com/users/wchargin/repos",
    "events_url": "https://api.github.com/users/wchargin/events{/privacy}",
    "received_events_url": "https://api.github.com/users/wchargin/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 901960538,
      "node_id": "MDU6TGFiZWw5MDE5NjA1Mzg=",
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/labels/type:bug",
      "name": "type:bug",
      "color": "FBCA04",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 4937720577,
      "node_id": "LA_kwDOB7jojM8AAAABJk-jAQ",
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/labels/status:ready",
      "name": "status:ready",
      "color": "0E8A16",
      "default": false,
      "description": "This issue is ready to be worked on"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2022-08-03T01:35:18Z",
  "updated_at": "2023-01-03T09:16:40Z",
  "closed_at": null,
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "I have a contract that behaves differently when the block number exceeds\r\n2^64. Obviously, this height isn't expected to be reached any time soon\r\nunder current mainnet parameters, but it could plausibly happen on some\r\nside chain (or later version of mainnet), and it should definitely be\r\npossible to test.\r\n\r\nAt first glance, the `hardhat_mine` RPC from #1112 and #2032 seem like\r\nthe perfect tools. But I'm running into two issues:\r\n\r\n  - Though the docs claim that this method is constant-time with \"the\r\n    same performance no matter how many blocks are mined\", it seems to\r\n    markedly slow down as `n` exceeds around 2^32.\r\n\r\n  - Mining more than 2^53 blocks at once doesn't seem to be supported at\r\n    all: \"Error: Number can only safely store up to 53 bits\".\r\n\r\n\r\nThis script demonstrates (`npx hardhat run script.js` in a fresh repo):\r\n\r\n```javascript\r\nconst hre = require(\"hardhat\");\r\nconst { loadFixture } = require(\"@nomicfoundation/hardhat-network-helpers\");\r\n\r\nasync function deployFixture() {\r\n  // Nothing to do.\r\n}\r\n\r\nasync function go(exponent) {\r\n  const n = 1n << BigInt(exponent);\r\n  console.log(`--- n = 2^${exponent}`);\r\n  try {\r\n    await loadFixture(deployFixture);\r\n    const hexN = \"0x\" + n.toString(16);\r\n    const start = process.hrtime.bigint();\r\n    await hre.network.provider.send(\"hardhat_mine\", [hexN]);\r\n    console.log(`mined ${n} blocks`);\r\n    const blockNumber = await hre.network.provider\r\n      .send(\"eth_blockNumber\")\r\n      .then((n) => hre.ethers.BigNumber.from(n));\r\n    const end = process.hrtime.bigint();\r\n    console.log(`latest block: ${blockNumber}`);\r\n    console.log(`elapsed: ${formatNs(end - start)}`);\r\n  } catch (e) {\r\n    console.error(\"failed: \" + e);\r\n  }\r\n  console.log();\r\n}\r\n\r\nfunction formatNs(ns) {\r\n  const us = Number(ns / BigInt(1e3));\r\n  const ms = (us / 1e3).toFixed(3);\r\n  return `${ms} ms`;\r\n}\r\n\r\nasync function main() {\r\n  await go(0);\r\n  await go(64); // fails: \"Number can only safely store up to 53 bits\"\r\n\r\n  await go(1);\r\n  await go(16);\r\n  await go(32);\r\n  await go(34);\r\n  await go(36);\r\n  await go(37);\r\n  await go(38);\r\n  await go(40);\r\n}\r\n\r\nmain();\r\n```\r\n\r\nSample outputs:\r\n\r\n```\r\n--- n = 2^0\r\nmined 1 blocks\r\nlatest block: 1\r\nelapsed: 46.037 ms\r\n\r\n--- n = 2^64\r\nfailed: Error: Number can only safely store up to 53 bits\r\n\r\n--- n = 2^1\r\nmined 2 blocks\r\nlatest block: 2\r\nelapsed: 3.287 ms\r\n\r\n--- n = 2^16\r\nmined 65536 blocks\r\nlatest block: 65536\r\nelapsed: 4.223 ms\r\n\r\n--- n = 2^32\r\nmined 4294967296 blocks\r\nlatest block: 4294967296\r\nelapsed: 31.722 ms\r\n\r\n--- n = 2^34\r\nmined 17179869184 blocks\r\nlatest block: 17179869184\r\nelapsed: 185.327 ms\r\n\r\n--- n = 2^36\r\nmined 68719476736 blocks\r\nlatest block: 68719476736\r\nelapsed: 2770.086 ms\r\n\r\n--- n = 2^37\r\nmined 137438953472 blocks\r\nlatest block: 137438953472\r\nelapsed: 10960.585 ms\r\n\r\n--- n = 2^38\r\nmined 274877906944 blocks\r\nlatest block: 274877906944\r\nelapsed: 44671.872 ms\r\n\r\n--- n = 2^40\r\n^C [after 10 minutes]\r\n```\r\n\r\nAlso, executing trivial transactions after mining order-of 2^38 blocks\r\nseems to take a long time, too (order-of 100 seconds).\r\n\r\nThis is a little surprising to me since the `mineBlocks` implementation\r\nseems to take its arguments as `BigNumber`s, so it sounds like it\r\nexpects to work in those ranges:\r\nhttps://github.com/NomicFoundation/hardhat/blob/bcd32259a1439a57a60ca67d2682014d051f5f8a/packages/hardhat-core/src/internal/hardhat-network/provider/node.ts#L508-L509\r\n\r\nWhat's the best way for me to test contract behavior when `block.number`\r\nexceeds `type(uint64).max`?\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3006/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3006/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1203385215",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/3006#issuecomment-1203385215",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3006",
    "id": 1203385215,
    "node_id": "IC_kwDOB7jojM5HujN_",
    "user": {
      "login": "github-actions[bot]",
      "id": 41898282,
      "node_id": "MDM6Qm90NDE4OTgyODI=",
      "avatar_url": "https://avatars.githubusercontent.com/in/15368?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/github-actions%5Bbot%5D",
      "html_url": "https://github.com/apps/github-actions",
      "followers_url": "https://api.github.com/users/github-actions%5Bbot%5D/followers",
      "following_url": "https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}",
      "gists_url": "https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/github-actions%5Bbot%5D/subscriptions",
      "organizations_url": "https://api.github.com/users/github-actions%5Bbot%5D/orgs",
      "repos_url": "https://api.github.com/users/github-actions%5Bbot%5D/repos",
      "events_url": "https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}",
      "received_events_url": "https://api.github.com/users/github-actions%5Bbot%5D/received_events",
      "type": "Bot",
      "site_admin": false
    },
    "created_at": "2022-08-03T01:36:20Z",
    "updated_at": "2022-08-03T01:36:20Z",
    "author_association": "CONTRIBUTOR",
    "body": "This issue is also being [tracked on Linear](https://linear.app/nomic-foundation/issue/HH-1008/hardhat-mine-doesnt-work-with-large-block-numbers).\n\nWe use Linear to manage our development process, but we keep the conversations on Github.\n\nLINEAR-ID: 54194f1e-982c-497c-8bfa-3925d5a114ea",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1203385215/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1237341827",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/3006#issuecomment-1237341827",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3006",
    "id": 1237341827,
    "node_id": "IC_kwDOB7jojM5JwFaD",
    "user": {
      "login": "feuGeneA",
      "id": 7883777,
      "node_id": "MDQ6VXNlcjc4ODM3Nzc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7883777?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/feuGeneA",
      "html_url": "https://github.com/feuGeneA",
      "followers_url": "https://api.github.com/users/feuGeneA/followers",
      "following_url": "https://api.github.com/users/feuGeneA/following{/other_user}",
      "gists_url": "https://api.github.com/users/feuGeneA/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/feuGeneA/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/feuGeneA/subscriptions",
      "organizations_url": "https://api.github.com/users/feuGeneA/orgs",
      "repos_url": "https://api.github.com/users/feuGeneA/repos",
      "events_url": "https://api.github.com/users/feuGeneA/events{/privacy}",
      "received_events_url": "https://api.github.com/users/feuGeneA/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-05T17:46:04Z",
    "updated_at": "2022-09-05T17:46:04Z",
    "author_association": "CONTRIBUTOR",
    "body": "We're giving this a lower priority because it doesn't seem to have a real world application/impact. If you disagree, please explain your use case and it may convince us to increase the priority. Thank you.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1237341827/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
