{
  "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1721",
  "repository_url": "https://api.github.com/repos/NomicFoundation/hardhat",
  "labels_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1721/labels{/name}",
  "comments_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1721/comments",
  "events_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1721/events",
  "html_url": "https://github.com/NomicFoundation/hardhat/issues/1721",
  "id": 951751432,
  "node_id": "MDU6SXNzdWU5NTE3NTE0MzI=",
  "number": 1721,
  "title": "Random \"contract call run out of gas and made the transaction revert\" errors while running tests",
  "user": {
    "login": "ppedziwiatr",
    "id": 84311757,
    "node_id": "MDQ6VXNlcjg0MzExNzU3",
    "avatar_url": "https://avatars.githubusercontent.com/u/84311757?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ppedziwiatr",
    "html_url": "https://github.com/ppedziwiatr",
    "followers_url": "https://api.github.com/users/ppedziwiatr/followers",
    "following_url": "https://api.github.com/users/ppedziwiatr/following{/other_user}",
    "gists_url": "https://api.github.com/users/ppedziwiatr/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ppedziwiatr/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ppedziwiatr/subscriptions",
    "organizations_url": "https://api.github.com/users/ppedziwiatr/orgs",
    "repos_url": "https://api.github.com/users/ppedziwiatr/repos",
    "events_url": "https://api.github.com/users/ppedziwiatr/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ppedziwiatr/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": true,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2021-07-23T17:03:16Z",
  "updated_at": "2023-03-30T00:14:24Z",
  "closed_at": "2022-12-29T10:54:47Z",
  "author_association": "NONE",
  "active_lock_reason": "resolved",
  "body": "Hi,\r\n\r\nwe're having really strange issues with running tests. There are about 100 of them, and on each run some of them (usually 2 or 3) fail with the error from title, e.g.:\r\n```\r\n4) Smart loan\r\n       A loan with debt and repayment\r\n         should repay funds:\r\n     Error: Transaction reverted: contract call run out of gas and made the transaction revert\r\n      at CompoundingIndex.rayPow (contracts/WadRayMath.sol:83)\r\n      at CompoundingIndex.getCompoundedFactor (contracts/CompoundingIndex.sol:112)\r\n      at CompoundingIndex.getIndex (contracts/CompoundingIndex.sol:75)\r\n      at CompoundingIndex.updateIndex (contracts/CompoundingIndex.sol:102)\r\n      at CompoundingIndex.setRate (contracts/CompoundingIndex.sol:45)\r\n      at Pool.updateRates (contracts/Pool.sol:200)\r\n      at Pool.repay (contracts/Pool.sol:150)\r\n      at SmartLoan.repay (contracts/SmartLoan.sol:109)\r\n      at processTicksAndRejections (internal/process/task_queues.js:95:5)\r\n      at HardhatNode._mineBlockWithPendingTxs (node_modules/hardhat/src/internal/hardhat-network/provider/node.ts:1575:23)\r\n```      \r\n\r\nWhat is really odd is that It happens (every time!) only on computers with intel-based cpu-s (on both MacOS on Linux, also in github hook - you can see it here: https://github.com/jakub-wojciechowski/avaloan/pull/4/checks )\r\n\r\nHowever - it has never happened on my M1 Macbook.\r\n\r\nI've already tried different settings described in this issue: https://github.com/nomiclabs/hardhat/issues/660 - but none of them seems to help.\r\n\r\nCurrent configuration: https://github.com/jakub-wojciechowski/avaloan/blob/dcf754acb37d82b03256b219e612c8f77d1950c1/hardhat.config.ts\r\n\r\nWhat may be causing these issues?\r\n\r\nMy only idea is that it is because of frequent contracts deploys (in \"beforeEach\") - for example https://github.com/jakub-wojciechowski/avaloan/blob/dcf754acb37d82b03256b219e612c8f77d1950c1/test/pool-fixed-rates-deposits_1.test.ts\r\n\r\nBut I really would not like to switch to deploying contracts in \"before\" - as it would introduce some nasty dependencies between tests.\r\n\r\nAnd still - I can't understand why it isn't an issue on Apple Silicon.\r\n\r\nAny help would be appreciated :-) \r\n\r\nUsing hardhat `2.5.0`.\r\n\r\n",
  "closed_by": {
    "login": "fvictorio",
    "id": 417134,
    "node_id": "MDQ6VXNlcjQxNzEzNA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/fvictorio",
    "html_url": "https://github.com/fvictorio",
    "followers_url": "https://api.github.com/users/fvictorio/followers",
    "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
    "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
    "organizations_url": "https://api.github.com/users/fvictorio/orgs",
    "repos_url": "https://api.github.com/users/fvictorio/repos",
    "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
    "received_events_url": "https://api.github.com/users/fvictorio/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1721/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1721/timeline",
  "performed_via_github_app": null,
  "state_reason": "not_planned"
}
[
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/886662144",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/1721#issuecomment-886662144",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1721",
    "id": 886662144,
    "node_id": "IC_kwDOB7jojM402WQA",
    "user": {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-07-26T12:33:07Z",
    "updated_at": "2021-07-26T12:33:07Z",
    "author_association": "MEMBER",
    "body": "Hey @ppedziwiatr, any chance you could convert this into a [minimal reproducible example](https://stackoverflow.com/help/minimal-reproducible-example)? In your case, it probably means removing all the stuff you can (plugins, other contracts, other tests) until you have the minimal amount of code that still reproduces this. If you can do that, we'll be able to look into this sooner.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/886662144/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/887429777",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/1721#issuecomment-887429777",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1721",
    "id": 887429777,
    "node_id": "IC_kwDOB7jojM405RqR",
    "user": {
      "login": "ppedziwiatr",
      "id": 84311757,
      "node_id": "MDQ6VXNlcjg0MzExNzU3",
      "avatar_url": "https://avatars.githubusercontent.com/u/84311757?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ppedziwiatr",
      "html_url": "https://github.com/ppedziwiatr",
      "followers_url": "https://api.github.com/users/ppedziwiatr/followers",
      "following_url": "https://api.github.com/users/ppedziwiatr/following{/other_user}",
      "gists_url": "https://api.github.com/users/ppedziwiatr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ppedziwiatr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ppedziwiatr/subscriptions",
      "organizations_url": "https://api.github.com/users/ppedziwiatr/orgs",
      "repos_url": "https://api.github.com/users/ppedziwiatr/repos",
      "events_url": "https://api.github.com/users/ppedziwiatr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ppedziwiatr/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-07-27T11:21:22Z",
    "updated_at": "2021-07-27T13:20:57Z",
    "author_association": "NONE",
    "body": "> Hey @ppedziwiatr, any chance you could convert this into a [minimal reproducible example](https://stackoverflow.com/help/minimal-reproducible-example)? In your case, it probably means removing all the stuff you can (plugins, other contracts, other tests) until you have the minimal amount of code that still reproduces this. If you can do that, we'll be able to look into this sooner.\r\n\r\nHere's branch with sth. that I believe is MRE - https://github.com/jakub-wojciechowski/avaloan/tree/ppe/hardhat-gas-issues\r\nThis is the minimum amount of the tests that are required to make the tests fail everytime on my old Intel-based CPU laptop (10 fails for 10 runs). Same issues on Windows and Intel-based macbooks. I've also removed all non-related source code and left only the required set of depedencies.\r\n\r\nExample errors on Intel:\r\n![image](https://user-images.githubusercontent.com/84311757/127145620-ed4a4138-a03e-4d6c-9100-4b3edecdb46f.png)\r\n\r\n\r\n\r\nIt works without any issues (10 runs, no errors) on my Apple Silicon:\r\n![image](https://user-images.githubusercontent.com/84311757/127145876-549621f5-36ce-4a93-9f99-b20b2f7673c3.png)\r\n\r\n\r\n@fvictorio , please let me know if this version is giving you errors - we've tested it on a yet another Intel machine and it failed 3 times on 5 runs...\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/887429777/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/889898243",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/1721#issuecomment-889898243",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1721",
    "id": 889898243,
    "node_id": "IC_kwDOB7jojM41CsUD",
    "user": {
      "login": "jakub-wojciechowski",
      "id": 27825272,
      "node_id": "MDQ6VXNlcjI3ODI1Mjcy",
      "avatar_url": "https://avatars.githubusercontent.com/u/27825272?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jakub-wojciechowski",
      "html_url": "https://github.com/jakub-wojciechowski",
      "followers_url": "https://api.github.com/users/jakub-wojciechowski/followers",
      "following_url": "https://api.github.com/users/jakub-wojciechowski/following{/other_user}",
      "gists_url": "https://api.github.com/users/jakub-wojciechowski/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jakub-wojciechowski/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jakub-wojciechowski/subscriptions",
      "organizations_url": "https://api.github.com/users/jakub-wojciechowski/orgs",
      "repos_url": "https://api.github.com/users/jakub-wojciechowski/repos",
      "events_url": "https://api.github.com/users/jakub-wojciechowski/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jakub-wojciechowski/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-07-30T13:36:14Z",
    "updated_at": "2021-07-30T13:36:14Z",
    "author_association": "NONE",
    "body": "I've been looking into this issue and I'm not sure if the gas parameter from the hre (Hardhat runtime environment) is passed correctly, especially if there are multiple plugins attached (both hardhat-ethers and hardhat-wallet). After playing with that \"gas\" parameter, I haven't noticed any changes spying the hardhat-ethers. I've also noticed that the gas is estimated even when the \"gas\" parameter is set (is this expected behaviour)?\r\nAnyway, I [implemented a simple wrapper](https://github.com/jakub-wojciechowski/avaloan/blob/master/test/_helpers.ts#L36) around the signers - to set the gas limit at a transaction level:\r\n\r\n```\r\nexport const getFixedGasSigners = async function(gasLimit:number) {\r\n  const signers : SignerWithAddress[] = await ethers.getSigners();\r\n  signers.forEach(signer => {\r\n    let orig = signer.sendTransaction;\r\n    signer.sendTransaction = function(transaction) {\r\n      transaction.gasLimit = BigNumber.from(gasLimit.toString());\r\n      return orig.apply(signer, [transaction]);\r\n    }\r\n  });\r\n  return signers;\r\n};\r\n```\r\n\r\nIt helped to fix all the issues with tests and they are executed roughly 2 times faster, due to skipping the gas estimation step. \r\n\r\nI hope this will help you to track down the problem or have a workaround for anyone facing the same issue until it's properly fixed. ",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/889898243/reactions",
      "total_count": 3,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 1,
      "confused": 0,
      "heart": 0,
      "rocket": 2,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1207952575",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/1721#issuecomment-1207952575",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1721",
    "id": 1207952575,
    "node_id": "IC_kwDOB7jojM5H_-S_",
    "user": {
      "login": "github-actions[bot]",
      "id": 41898282,
      "node_id": "MDM6Qm90NDE4OTgyODI=",
      "avatar_url": "https://avatars.githubusercontent.com/in/15368?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/github-actions%5Bbot%5D",
      "html_url": "https://github.com/apps/github-actions",
      "followers_url": "https://api.github.com/users/github-actions%5Bbot%5D/followers",
      "following_url": "https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}",
      "gists_url": "https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/github-actions%5Bbot%5D/subscriptions",
      "organizations_url": "https://api.github.com/users/github-actions%5Bbot%5D/orgs",
      "repos_url": "https://api.github.com/users/github-actions%5Bbot%5D/repos",
      "events_url": "https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}",
      "received_events_url": "https://api.github.com/users/github-actions%5Bbot%5D/received_events",
      "type": "Bot",
      "site_admin": false
    },
    "created_at": "2022-08-08T10:36:12Z",
    "updated_at": "2022-08-08T10:36:12Z",
    "author_association": "CONTRIBUTOR",
    "body": "This issue was marked as stale because it didn't have any activity in the last 30 days. If you think it's still relevant, please leave a comment indicating so. Otherwise, it will be closed in 7 days.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1207952575/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1367235382",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/1721#issuecomment-1367235382",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1721",
    "id": 1367235382,
    "node_id": "IC_kwDOB7jojM5Rfls2",
    "user": {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-29T10:54:47Z",
    "updated_at": "2022-12-29T10:54:47Z",
    "author_association": "MEMBER",
    "body": "I'm revisiting this issue and, as part of that, I removed the `ethereum-waffle` usages of the reproduction repo and replaced them with deployments using `hardhat-ethers`. For some reason, after that the problem went away.\r\n\r\nSo it's very likely that the problem is related to Waffle's `deployContract`. Sadly, that's out of scope for me, so I'm going to tentatively close this issue. If someone has a similar problem and can provide minimal reproduction steps, please open a new issue.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1367235382/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
