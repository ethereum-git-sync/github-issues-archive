{
  "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1241",
  "repository_url": "https://api.github.com/repos/NomicFoundation/hardhat",
  "labels_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1241/labels{/name}",
  "comments_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1241/comments",
  "events_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1241/events",
  "html_url": "https://github.com/NomicFoundation/hardhat/issues/1241",
  "id": 807112467,
  "node_id": "MDU6SXNzdWU4MDcxMTI0Njc=",
  "number": 1241,
  "title": "HardHat network experiences unexplained reversions during iterations of pure/view functions",
  "user": {
    "login": "CodeForcer",
    "id": 31618931,
    "node_id": "MDQ6VXNlcjMxNjE4OTMx",
    "avatar_url": "https://avatars.githubusercontent.com/u/31618931?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/CodeForcer",
    "html_url": "https://github.com/CodeForcer",
    "followers_url": "https://api.github.com/users/CodeForcer/followers",
    "following_url": "https://api.github.com/users/CodeForcer/following{/other_user}",
    "gists_url": "https://api.github.com/users/CodeForcer/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/CodeForcer/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/CodeForcer/subscriptions",
    "organizations_url": "https://api.github.com/users/CodeForcer/orgs",
    "repos_url": "https://api.github.com/users/CodeForcer/repos",
    "events_url": "https://api.github.com/users/CodeForcer/events{/privacy}",
    "received_events_url": "https://api.github.com/users/CodeForcer/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": true,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2021-02-12T10:17:20Z",
  "updated_at": "2023-03-30T00:14:11Z",
  "closed_at": "2022-12-29T19:21:33Z",
  "author_association": "NONE",
  "active_lock_reason": "resolved",
  "body": "I've created a test repo to demonstrate the issue:\r\nhttps://github.com/CodeForcer/curve-error-example-2\r\n\r\nTo run the test case just create `.env` file with a archive url variable `ARCHIVE_NODE_API=https://eth-mainnet.alchemyapi.io/etc...`, then run `yarn install` followed by `npx hardhat test`.\r\n\r\nThe test takes a while to run, but demonstrates the error by attempting to execute a pure/view function 200 times.\r\n\r\nGiven the function is pure/view, there should be no difference between each iteration, yet the iteration fails after 25 runs with a reversion on another contract.",
  "closed_by": {
    "login": "fvictorio",
    "id": 417134,
    "node_id": "MDQ6VXNlcjQxNzEzNA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/fvictorio",
    "html_url": "https://github.com/fvictorio",
    "followers_url": "https://api.github.com/users/fvictorio/followers",
    "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
    "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
    "organizations_url": "https://api.github.com/users/fvictorio/orgs",
    "repos_url": "https://api.github.com/users/fvictorio/repos",
    "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
    "received_events_url": "https://api.github.com/users/fvictorio/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1241/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1241/timeline",
  "performed_via_github_app": null,
  "state_reason": "not_planned"
}
[
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/778138331",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/1241#issuecomment-778138331",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1241",
    "id": 778138331,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc3ODEzODMzMQ==",
    "user": {
      "login": "CodeForcer",
      "id": 31618931,
      "node_id": "MDQ6VXNlcjMxNjE4OTMx",
      "avatar_url": "https://avatars.githubusercontent.com/u/31618931?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/CodeForcer",
      "html_url": "https://github.com/CodeForcer",
      "followers_url": "https://api.github.com/users/CodeForcer/followers",
      "following_url": "https://api.github.com/users/CodeForcer/following{/other_user}",
      "gists_url": "https://api.github.com/users/CodeForcer/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/CodeForcer/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/CodeForcer/subscriptions",
      "organizations_url": "https://api.github.com/users/CodeForcer/orgs",
      "repos_url": "https://api.github.com/users/CodeForcer/repos",
      "events_url": "https://api.github.com/users/CodeForcer/events{/privacy}",
      "received_events_url": "https://api.github.com/users/CodeForcer/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-02-12T11:23:35Z",
    "updated_at": "2021-02-12T11:23:56Z",
    "author_association": "NONE",
    "body": "Some further investigation which might help diagnose. I changed the code to make the call in a lower-level manner:\r\n```\r\nfunction test() public {\r\n  console.log(\"Running stateless Curve function multiple times\");\r\n\r\n  for (uint256 i = 0; i < 200; i++) {\r\n    curvePool.call(abi.encodeWithSignature(\r\n      \"get_dy_underlying(int128,int128,uint256)\",\r\n      int128(1),\r\n      int128(2),\r\n      1\r\n    ));\r\n    console.log(\"Successful iteration\", i);\r\n  }\r\n}\r\n```\r\n\r\nNow the HardHat error is:\r\n```\r\n<...>\r\nSuccessful iteration 22\r\nSuccessful iteration 23\r\nSuccessful iteration 24\r\nSuccessful iteration 25\r\nSuccessful iteration 26\r\n    1) Replicates a confusing problem with Curve\r\n\r\n\r\n  0 passing (7s)\r\n  1 failing\r\n\r\n  1) Test Curve Bug\r\n       Replicates a confusing problem with Curve:\r\n     Error: Transaction run out of gas\r\n      at new TransactionExecutionError (node_modules/hardhat/src/internal/hardhat-network/provider/errors.ts:97:16)\r\n      at HardhatNode._manageErrors (node_modules/hardhat/src/internal/hardhat-network/provider/node.ts:935:14)\r\n      at HardhatNode.runTransactionInNewBlock (node_modules/hardhat/src/internal/hardhat-network/provider/node.ts:312:30)\r\n      at process._tickCallback (internal/process/next_tick.js:68:7)\r\n\r\nFailed to generate 1 stack trace. Run Hardhat with --verbose to learn more\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/778138331/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/779259351",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/1241#issuecomment-779259351",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1241",
    "id": 779259351,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc3OTI1OTM1MQ==",
    "user": {
      "login": "CodeForcer",
      "id": 31618931,
      "node_id": "MDQ6VXNlcjMxNjE4OTMx",
      "avatar_url": "https://avatars.githubusercontent.com/u/31618931?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/CodeForcer",
      "html_url": "https://github.com/CodeForcer",
      "followers_url": "https://api.github.com/users/CodeForcer/followers",
      "following_url": "https://api.github.com/users/CodeForcer/following{/other_user}",
      "gists_url": "https://api.github.com/users/CodeForcer/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/CodeForcer/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/CodeForcer/subscriptions",
      "organizations_url": "https://api.github.com/users/CodeForcer/orgs",
      "repos_url": "https://api.github.com/users/CodeForcer/repos",
      "events_url": "https://api.github.com/users/CodeForcer/events{/privacy}",
      "received_events_url": "https://api.github.com/users/CodeForcer/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-02-15T14:31:52Z",
    "updated_at": "2021-02-15T14:31:52Z",
    "author_association": "NONE",
    "body": "Ok, I've discovered the cause here. The actual error is \"out of gas\", but is being suppressed in the first example. Raising block gas limit fixes the error.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/779259351/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/980807237",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/1241#issuecomment-980807237",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1241",
    "id": 980807237,
    "node_id": "IC_kwDOB7jojM46de5F",
    "user": {
      "login": "cameel",
      "id": 137030,
      "node_id": "MDQ6VXNlcjEzNzAzMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cameel",
      "html_url": "https://github.com/cameel",
      "followers_url": "https://api.github.com/users/cameel/followers",
      "following_url": "https://api.github.com/users/cameel/following{/other_user}",
      "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
      "organizations_url": "https://api.github.com/users/cameel/orgs",
      "repos_url": "https://api.github.com/users/cameel/repos",
      "events_url": "https://api.github.com/users/cameel/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cameel/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-11-27T23:44:37Z",
    "updated_at": "2021-11-27T23:44:37Z",
    "author_association": "NONE",
    "body": "This seems to work as expected. Calling view and pure functions on chain (i.e. from a contract) is not free. You do not pay any gas only if a node simulates its execution for you without actually publishing that fact to the rest of the network. Depending on what the function does, executing it 25 times could very well use up all gas.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/980807237/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1367535626",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/1241#issuecomment-1367535626",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1241",
    "id": 1367535626,
    "node_id": "IC_kwDOB7jojM5RgvAK",
    "user": {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-29T19:21:33Z",
    "updated_at": "2022-12-29T19:21:33Z",
    "author_association": "MEMBER",
    "body": "Hmm, I'm going to close this because this is expected behavior. I am interested in the fact that the original reproduction didn't result in an OOG error, but the repo doesn't exist anymore.\r\n\r\n@CodeForcer if you happen to still have that repo, I will open a new issue about this. But I would understand if you don't, it's been almost 2 years :sweat:",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1367535626/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
