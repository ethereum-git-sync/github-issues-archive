{
  "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/4310",
  "repository_url": "https://api.github.com/repos/NomicFoundation/hardhat",
  "labels_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/4310/labels{/name}",
  "comments_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/4310/comments",
  "events_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/4310/events",
  "html_url": "https://github.com/NomicFoundation/hardhat/issues/4310",
  "id": 1854852975,
  "node_id": "I_kwDOB7jojM5ujs9v",
  "number": 4310,
  "title": "Coverage: Contract size too large error thrown ONLY when running with parallel: true",
  "user": {
    "login": "0xdavinchee",
    "id": 20151633,
    "node_id": "MDQ6VXNlcjIwMTUxNjMz",
    "avatar_url": "https://avatars.githubusercontent.com/u/20151633?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/0xdavinchee",
    "html_url": "https://github.com/0xdavinchee",
    "followers_url": "https://api.github.com/users/0xdavinchee/followers",
    "following_url": "https://api.github.com/users/0xdavinchee/following{/other_user}",
    "gists_url": "https://api.github.com/users/0xdavinchee/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/0xdavinchee/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/0xdavinchee/subscriptions",
    "organizations_url": "https://api.github.com/users/0xdavinchee/orgs",
    "repos_url": "https://api.github.com/users/0xdavinchee/repos",
    "events_url": "https://api.github.com/users/0xdavinchee/events{/privacy}",
    "received_events_url": "https://api.github.com/users/0xdavinchee/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 4937119027,
      "node_id": "LA_kwDOB7jojM8AAAABJkZ1Mw",
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/labels/status:triaging",
      "name": "status:triaging",
      "color": "0E8A16",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": {
    "login": "fvictorio",
    "id": 417134,
    "node_id": "MDQ6VXNlcjQxNzEzNA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/fvictorio",
    "html_url": "https://github.com/fvictorio",
    "followers_url": "https://api.github.com/users/fvictorio/followers",
    "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
    "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
    "organizations_url": "https://api.github.com/users/fvictorio/orgs",
    "repos_url": "https://api.github.com/users/fvictorio/repos",
    "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
    "received_events_url": "https://api.github.com/users/fvictorio/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2023-08-17T11:54:23Z",
  "updated_at": "2023-09-20T12:17:44Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Version of Hardhat\n\n2.17.1\n\n### What happened?\n\nWhat happened: when I run my coverage tests using `npx hardhat coverage` with ` { mocha: { parallel: true } }` in `hardhat.config.ts`,  it throws an error:\r\n```\r\nEnable the 'allowUnlimitedContractSize' option to allow init codes of any length.\r\n  Error: Returned error: Trying to send a deployment transaction whose init code length is 57472. The max length allowed by EIP-3860 is 49152.\r\n```\r\n\r\nWhat is expected: coverage runs despite this issue.\n\n### Minimal reproduction steps\n\n```\r\n# Clone the superfluid-finance repo\r\ngit clone git@github.com:superfluid-finance/protocol-monorepo.git\r\n\r\n# cd into dir, install dependencies, and build\r\ncd protocol-monorepo && yarn install && yarn build\r\n\r\n# go into ethereum-contracts folder\r\ncd packages/ethereum-contracts\r\n\r\n# create a .env and put the necessary vars in there\r\necho \"HARDHAT_TEST_JOBS=4\" > .env && echo \"HARDHAT_RUN_PARALLEL=true\" >> .env\r\n\r\n# run the coverage tests\r\nyarn test-coverage:hardhat\r\n\r\n# it should break, now remove the vars from .env and if you rerun it, it will work\r\n```\r\n\r\nThis can be fixed by adhering to the error message, but we would rather not do that if possible.\n\n### Search terms\n\n_No response_",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/4310/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/4310/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1726317778",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/4310#issuecomment-1726317778",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/4310",
    "id": 1726317778,
    "node_id": "IC_kwDOB7jojM5m5YTS",
    "user": {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-09-19T19:01:02Z",
    "updated_at": "2023-09-19T19:01:02Z",
    "author_association": "MEMBER",
    "body": "Hey @0xdavinchee, sorry for not responding before. I think I know what's going on here, I'll try to explain it.\r\n\r\n`solidity-coverage` does automatically enable the `allowUnlimitedContractSize` flag. The reason it does it is that, before running the tests, the code is instrumented with coverage-measuring code. This increases the size of the bytecode, so it's really common for contracts to go over the limit when measuring test coverage.\r\n\r\nNow the thing is that, when you run tests in parallel _and_ measure coverage, that flag is not being correctly set, and you get that warning. I think the reason why it's not being correctly set is that mocha, in parallel mode, runs each test file in a separate worker process, but solidity-coverage only enables the flag in the \"parent\" process, which has no effect.\r\n\r\nFrom what I saw in `solidity-coverage`'s code, I don't think this is the only thing that won't work correctly with the plugin. Sadly I think the best you can do is use serial mode when running coverage, at least until `solidity-coverage` is adapted to work correctly in parallel mode (see https://github.com/sc-forks/solidity-coverage/issues/691).\r\n\r\nAlternatively, you can enable the `allowUnlimitedContractSize` flag in your config when running coverage, but there isn't a good way to do that (you can't see the task that is being run from the config).",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1726317778/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1727609317",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/4310#issuecomment-1727609317",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/4310",
    "id": 1727609317,
    "node_id": "IC_kwDOB7jojM5m-Tnl",
    "user": {
      "login": "0xdavinchee",
      "id": 20151633,
      "node_id": "MDQ6VXNlcjIwMTUxNjMz",
      "avatar_url": "https://avatars.githubusercontent.com/u/20151633?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/0xdavinchee",
      "html_url": "https://github.com/0xdavinchee",
      "followers_url": "https://api.github.com/users/0xdavinchee/followers",
      "following_url": "https://api.github.com/users/0xdavinchee/following{/other_user}",
      "gists_url": "https://api.github.com/users/0xdavinchee/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/0xdavinchee/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/0xdavinchee/subscriptions",
      "organizations_url": "https://api.github.com/users/0xdavinchee/orgs",
      "repos_url": "https://api.github.com/users/0xdavinchee/repos",
      "events_url": "https://api.github.com/users/0xdavinchee/events{/privacy}",
      "received_events_url": "https://api.github.com/users/0xdavinchee/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-09-20T12:17:44Z",
    "updated_at": "2023-09-20T12:17:44Z",
    "author_association": "NONE",
    "body": "hey @fvictorio no worries at all for not responding before, thank you for responding and explaining what the issue is here. \r\n\r\ngood to know what the underlying issue is!",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1727609317/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 1,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
