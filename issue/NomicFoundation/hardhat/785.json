{
  "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/785",
  "repository_url": "https://api.github.com/repos/NomicFoundation/hardhat",
  "labels_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/785/labels{/name}",
  "comments_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/785/comments",
  "events_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/785/events",
  "html_url": "https://github.com/NomicFoundation/hardhat/issues/785",
  "id": 699695762,
  "node_id": "MDU6SXNzdWU2OTk2OTU3NjI=",
  "number": 785,
  "title": "buidler-evm issue with retrieving events",
  "user": {
    "login": "mrice32",
    "id": 11791551,
    "node_id": "MDQ6VXNlcjExNzkxNTUx",
    "avatar_url": "https://avatars.githubusercontent.com/u/11791551?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mrice32",
    "html_url": "https://github.com/mrice32",
    "followers_url": "https://api.github.com/users/mrice32/followers",
    "following_url": "https://api.github.com/users/mrice32/following{/other_user}",
    "gists_url": "https://api.github.com/users/mrice32/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mrice32/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mrice32/subscriptions",
    "organizations_url": "https://api.github.com/users/mrice32/orgs",
    "repos_url": "https://api.github.com/users/mrice32/repos",
    "events_url": "https://api.github.com/users/mrice32/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mrice32/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 901960538,
      "node_id": "MDU6TGFiZWw5MDE5NjA1Mzg=",
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/labels/type:bug",
      "name": "type:bug",
      "color": "FBCA04",
      "default": false,
      "description": "Something isn't working"
    }
  ],
  "state": "closed",
  "locked": true,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 7,
  "created_at": "2020-09-11T19:59:43Z",
  "updated_at": "2023-02-03T00:14:30Z",
  "closed_at": "2022-11-04T18:58:14Z",
  "author_association": "NONE",
  "active_lock_reason": "resolved",
  "body": "We're trying to run tests that we previously ran with truffle in buidler and we're running into a strange issue when doing event queries. It's not reproducible on _every_ query, but it seems to happen deterministically within certain tests.\r\n\r\n```\r\n     TypeError: Cannot read property 'length' of undefined\r\n      at topicMatched (/Users/matt/git/protocol/node_modules/@nomiclabs/buidler/src/internal/buidler-evm/provider/filter.ts:120:45)\r\n      at Object.filterLogs (/Users/matt/git/protocol/node_modules/@nomiclabs/buidler/src/internal/buidler-evm/provider/filter.ts:95:10)\r\n      at BuidlerNode.getLogs (/Users/matt/git/protocol/node_modules/@nomiclabs/buidler/src/internal/buidler-evm/provider/node.ts:969:14)\r\n      at processTicksAndRejections (internal/process/task_queues.js:97:5)\r\n      at BuidlerEVMProvider.send (/Users/matt/git/protocol/node_modules/@nomiclabs/buidler/src/internal/buidler-evm/provider/provider.ts:80:14)\r\n      at Web3HTTPProviderAdapter._sendJsonRpcRequest (/Users/matt/git/protocol/packages/common/node_modules/@nomiclabs/buidler-web3/src/web3-provider-adapter.ts:80:22)\r\n```\r\n\r\nWe've narrowed it to [this line](https://github.com/UMAprotocol/protocol/blob/9f91239647d36bfcd354026cced52274016f48cb/packages/liquidator/test/Liquidator.js#L222) in the test and [this query](https://github.com/UMAprotocol/protocol/blob/9f91239647d36bfcd354026cced52274016f48cb/packages/financial-templates-lib/src/clients/ExpiringMultiPartyClient.js#L121). It fails in many other test cases and scenarios, but we wanted to give a very particular case. If you'd like to investigate further, I'm happy to share a branch from our repo where you can reproduce!\r\n\r\n",
  "closed_by": {
    "login": "alcuadrado",
    "id": 176499,
    "node_id": "MDQ6VXNlcjE3NjQ5OQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/176499?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/alcuadrado",
    "html_url": "https://github.com/alcuadrado",
    "followers_url": "https://api.github.com/users/alcuadrado/followers",
    "following_url": "https://api.github.com/users/alcuadrado/following{/other_user}",
    "gists_url": "https://api.github.com/users/alcuadrado/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/alcuadrado/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/alcuadrado/subscriptions",
    "organizations_url": "https://api.github.com/users/alcuadrado/orgs",
    "repos_url": "https://api.github.com/users/alcuadrado/repos",
    "events_url": "https://api.github.com/users/alcuadrado/events{/privacy}",
    "received_events_url": "https://api.github.com/users/alcuadrado/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/785/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/785/timeline",
  "performed_via_github_app": null,
  "state_reason": "not_planned"
}
[
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/691292816",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/785#issuecomment-691292816",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/785",
    "id": 691292816,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY5MTI5MjgxNg==",
    "user": {
      "login": "mrice32",
      "id": 11791551,
      "node_id": "MDQ6VXNlcjExNzkxNTUx",
      "avatar_url": "https://avatars.githubusercontent.com/u/11791551?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mrice32",
      "html_url": "https://github.com/mrice32",
      "followers_url": "https://api.github.com/users/mrice32/followers",
      "following_url": "https://api.github.com/users/mrice32/following{/other_user}",
      "gists_url": "https://api.github.com/users/mrice32/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mrice32/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mrice32/subscriptions",
      "organizations_url": "https://api.github.com/users/mrice32/orgs",
      "repos_url": "https://api.github.com/users/mrice32/repos",
      "events_url": "https://api.github.com/users/mrice32/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mrice32/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-09-11T20:16:24Z",
    "updated_at": "2020-09-11T20:16:24Z",
    "author_association": "NONE",
    "body": "Here's the branch where this can be repro'd: https://github.com/mrice32/protocol/tree/buidler.\r\n\r\nIf you pull down that branch (`git clone https://github.com/mrice32/protocol.git && git checkout buidler`), run:\r\n```sh\r\nyarn\r\nyarn qbuild\r\ncd packages/liquidator\r\nyarn buidler test\r\n```\r\n\r\nThis will run all the tests in that package and will show the above error for many of them.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/691292816/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/691301630",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/785#issuecomment-691301630",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/785",
    "id": 691301630,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY5MTMwMTYzMA==",
    "user": {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-09-11T20:39:05Z",
    "updated_at": "2020-09-11T20:39:05Z",
    "author_association": "MEMBER",
    "body": "I actually get an error before that, when running `yarn qbuild`:\r\n\r\n```\r\nâžœ yarn qbuild\r\nyarn run v1.22.5\r\n$ yarn lerna run build --stream --ignore '*/*dapp*'\r\n$ /home/fvictorio/repos/protocol/node_modules/.bin/lerna run build --stream --ignore '*/*dapp*'\r\nlerna notice cli v3.22.1\r\nlerna info versioning independent\r\nlerna notice filter excluding \"*/*dapp*\"\r\nlerna info filter [ '!*/*dapp*' ]\r\nlerna info Executing command in 1 package: \"yarn run build\"\r\n@umaprotocol/core: $ yarn truffle compile && yarn load-addresses\r\n@umaprotocol/core: $ /home/fvictorio/repos/protocol/node_modules/.bin/truffle compile\r\n@umaprotocol/core: BuidlerError: BDLR5: BuidlerContext is not created.\r\n@umaprotocol/core:     at Function.getBuidlerContext (/home/fvictorio/repos/protocol/packages/common/node_modules/@nomiclabs/buidler/src/internal/context.ts:32:13)\r\n@umaprotocol/core:     at usePlugin (/home/fvictorio/repos/protocol/packages/common/node_modules/@nomiclabs/buidler/src/internal/core/config/config-env.ts:97:30)\r\n...\r\n```\r\n\r\nThe problem seems to be that you are requiring a buidler config outside a buidler context. Does that error not happen to you?",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/691301630/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/691309739",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/785#issuecomment-691309739",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/785",
    "id": 691309739,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY5MTMwOTczOQ==",
    "user": {
      "login": "mrice32",
      "id": 11791551,
      "node_id": "MDQ6VXNlcjExNzkxNTUx",
      "avatar_url": "https://avatars.githubusercontent.com/u/11791551?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mrice32",
      "html_url": "https://github.com/mrice32",
      "followers_url": "https://api.github.com/users/mrice32/followers",
      "following_url": "https://api.github.com/users/mrice32/following{/other_user}",
      "gists_url": "https://api.github.com/users/mrice32/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mrice32/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mrice32/subscriptions",
      "organizations_url": "https://api.github.com/users/mrice32/orgs",
      "repos_url": "https://api.github.com/users/mrice32/repos",
      "events_url": "https://api.github.com/users/mrice32/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mrice32/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-09-11T21:00:42Z",
    "updated_at": "2020-09-11T21:01:17Z",
    "author_association": "NONE",
    "body": "Sorry about that. I think that's unrelated. Let me see if I can fix it. The reason I didn't see that error was that I had run the qbuild step before making some of the buidler-related changes.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/691309739/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/691314089",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/785#issuecomment-691314089",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/785",
    "id": 691314089,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY5MTMxNDA4OQ==",
    "user": {
      "login": "mrice32",
      "id": 11791551,
      "node_id": "MDQ6VXNlcjExNzkxNTUx",
      "avatar_url": "https://avatars.githubusercontent.com/u/11791551?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mrice32",
      "html_url": "https://github.com/mrice32",
      "followers_url": "https://api.github.com/users/mrice32/followers",
      "following_url": "https://api.github.com/users/mrice32/following{/other_user}",
      "gists_url": "https://api.github.com/users/mrice32/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mrice32/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mrice32/subscriptions",
      "organizations_url": "https://api.github.com/users/mrice32/orgs",
      "repos_url": "https://api.github.com/users/mrice32/repos",
      "events_url": "https://api.github.com/users/mrice32/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mrice32/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-09-11T21:12:01Z",
    "updated_at": "2020-09-11T21:12:01Z",
    "author_association": "NONE",
    "body": "@fvictorio sorry for the confusion. I've made a small update to the branch. The build issue should be fixed, and you should be able to see the test failures using that initial string of commands.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/691314089/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/696082419",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/785#issuecomment-696082419",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/785",
    "id": 696082419,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY5NjA4MjQxOQ==",
    "user": {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-09-21T12:29:36Z",
    "updated_at": "2020-09-21T12:29:36Z",
    "author_association": "MEMBER",
    "body": "Hey @mrice32, sorry for the late response.\r\n\r\nI can confirm this is happening, but I'm not quite sure yet. We seem to be assuming that the `logs` entry of all transaction receipts have the same structure, but that doesn't seem to be the case? More specifically, we assume that each log has a `topics` property that is a `string[]`, but sometimes that property doesn't exist. That's why the `cannot read property length of undefined` shows up.\r\n\r\nFrom what I can see, when the log doesn't have a `topics`, it does have a `signature` property.\r\n\r\nThis will need further investigation, but it definitely looks like a bug. I'm curious about why this hasn't happened before. Do you have a guess of something in your setup that might be different from a \"normal\" setup?",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/696082419/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/696090315",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/785#issuecomment-696090315",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/785",
    "id": 696090315,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY5NjA5MDMxNQ==",
    "user": {
      "login": "mrice32",
      "id": 11791551,
      "node_id": "MDQ6VXNlcjExNzkxNTUx",
      "avatar_url": "https://avatars.githubusercontent.com/u/11791551?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mrice32",
      "html_url": "https://github.com/mrice32",
      "followers_url": "https://api.github.com/users/mrice32/followers",
      "following_url": "https://api.github.com/users/mrice32/following{/other_user}",
      "gists_url": "https://api.github.com/users/mrice32/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mrice32/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mrice32/subscriptions",
      "organizations_url": "https://api.github.com/users/mrice32/orgs",
      "repos_url": "https://api.github.com/users/mrice32/repos",
      "events_url": "https://api.github.com/users/mrice32/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mrice32/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-09-21T12:45:54Z",
    "updated_at": "2020-09-21T12:46:05Z",
    "author_association": "NONE",
    "body": "> Hey @mrice32, sorry for the late response.\r\n> \r\n> I can confirm this is happening, but I'm not quite sure yet. We seem to be assuming that the `logs` entry of all transaction receipts have the same structure, but that doesn't seem to be the case? More specifically, we assume that each log has a `topics` property that is a `string[]`, but sometimes that property doesn't exist. That's why the `cannot read property length of undefined` shows up.\r\n> \r\n> From what I can see, when the log doesn't have a `topics`, it does have a `signature` property.\r\n> \r\n> This will need further investigation, but it definitely looks like a bug. I'm curious about why this hasn't happened before. Do you have a guess of something in your setup that might be different from a \"normal\" setup?\r\n\r\n@fvictorio Thanks for looking into it!\r\n\r\nOur setup is weird in a few ways:\r\n- Our buidler config is shared across different packages in the monorepo, so we export a function to run the buidler setup and call that function on execution of the individual configs in the different packages. We are also customizing the file paths for the directories.\r\n- We use a combination of web3 and truffle contract instantiations to query events and call functions. I know buidler modifies the truffle contract instantiations, but not sure if using both may cause issues. I believe that the calls in question are coming from web3 contract instantiations rather than truffle ones.\r\n\r\nThere certainly may be other types of strangeness in our setup, but those are the only two I can think of off the top of my head!",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/696090315/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1304010794",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/785#issuecomment-1304010794",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/785",
    "id": 1304010794,
    "node_id": "IC_kwDOB7jojM5NuaAq",
    "user": {
      "login": "alcuadrado",
      "id": 176499,
      "node_id": "MDQ6VXNlcjE3NjQ5OQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/176499?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alcuadrado",
      "html_url": "https://github.com/alcuadrado",
      "followers_url": "https://api.github.com/users/alcuadrado/followers",
      "following_url": "https://api.github.com/users/alcuadrado/following{/other_user}",
      "gists_url": "https://api.github.com/users/alcuadrado/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alcuadrado/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alcuadrado/subscriptions",
      "organizations_url": "https://api.github.com/users/alcuadrado/orgs",
      "repos_url": "https://api.github.com/users/alcuadrado/repos",
      "events_url": "https://api.github.com/users/alcuadrado/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alcuadrado/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-11-04T18:58:14Z",
    "updated_at": "2022-11-04T18:58:14Z",
    "author_association": "MEMBER",
    "body": "Hi,\r\n\r\nI'm closing this issue as it has been a long time without activity, and it's unlikely it's still relevant/present.\r\n\r\nThanks for reporting it anyway, and please open a new one if you think it's needed.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1304010794/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
