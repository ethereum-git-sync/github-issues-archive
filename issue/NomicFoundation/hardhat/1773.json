{
  "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1773",
  "repository_url": "https://api.github.com/repos/NomicFoundation/hardhat",
  "labels_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1773/labels{/name}",
  "comments_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1773/comments",
  "events_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1773/events",
  "html_url": "https://github.com/NomicFoundation/hardhat/issues/1773",
  "id": 963439169,
  "node_id": "MDU6SXNzdWU5NjM0MzkxNjk=",
  "number": 1773,
  "title": "Incorrect behaviour when listening to contract events: when refresh the page, listener get called for past events",
  "user": {
    "login": "StErMi",
    "id": 146166,
    "node_id": "MDQ6VXNlcjE0NjE2Ng==",
    "avatar_url": "https://avatars.githubusercontent.com/u/146166?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/StErMi",
    "html_url": "https://github.com/StErMi",
    "followers_url": "https://api.github.com/users/StErMi/followers",
    "following_url": "https://api.github.com/users/StErMi/following{/other_user}",
    "gists_url": "https://api.github.com/users/StErMi/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/StErMi/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/StErMi/subscriptions",
    "organizations_url": "https://api.github.com/users/StErMi/orgs",
    "repos_url": "https://api.github.com/users/StErMi/repos",
    "events_url": "https://api.github.com/users/StErMi/events{/privacy}",
    "received_events_url": "https://api.github.com/users/StErMi/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": true,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 6,
  "created_at": "2021-08-08T14:00:27Z",
  "updated_at": "2023-03-30T00:14:27Z",
  "closed_at": "2022-12-29T09:08:53Z",
  "author_association": "NONE",
  "active_lock_reason": "resolved",
  "body": "Hi there,\r\n\r\nI think that there's a bug on event listening with the local hardhat network. I've tested it deploying on rinkeby with alchemy and it seems to work as expected.\r\n\r\nExpected\r\n\r\nI listen to an event and I only get NEW events.\r\nIf I refresh the page the listener should not give me past events.\r\n\r\nCurrent behavior:\r\n\r\nWhen I refresh the page, the listener get triggered with past events\r\n\r\nContract on Rinkeby: https://rinkeby.etherscan.io/address/0xcf4111362047bca0ad7e0c584b878d79c98cea04#code\r\nContract code\r\n\r\n```\r\n//SPDX-License-Identifier: Unlicense\r\npragma solidity ^0.8.4;\r\n\r\nimport \"@openzeppelin/contracts/access/Ownable.sol\";\r\n\r\ncontract TestEventContract is Ownable {\r\n    event TestEvent(string paramString, uint256 timestamp);\r\n\r\n    constructor() {\r\n        // do nothing\r\n    }\r\n\r\n    function raiseEvent(string memory paramString) public {\r\n        emit TestEvent(paramString, block.timestamp);\r\n    }\r\n}\r\n```\r\n\r\nReact code to listen to events (it's a hook)\r\n\r\n```\r\nimport {JsonRpcSigner, Web3Provider} from '@ethersproject/providers';\r\nimport {ethers} from 'ethers';\r\nimport {useEffect} from 'react';\r\n\r\nimport {TestEventContract__factory} from '../typechain/factories/TestEventContract__factory';\r\n\r\nconst getTestEventContract = (withSigner = false) => {\r\n  const contractAddress = '0xCf4111362047bCa0AD7e0C584B878D79C98cEa04';\r\n  const provider: Web3Provider = new ethers.providers.Web3Provider((window as any).ethereum);\r\n  const signer: JsonRpcSigner | Web3Provider = withSigner ? provider.getSigner() : provider;\r\n  const contract = TestEventContract__factory.connect(contractAddress, signer);\r\n  return contract;\r\n};\r\n\r\nconst useListenToEvents = () => {\r\n  useEffect(() => {\r\n    console.log(`useListenToEvents useEffect enter`);\r\n    const contract = getTestEventContract();\r\n\r\n    const filter = contract.filters.TestEvent();\r\n    const listener = (event: any) => {\r\n      console.log(`useListenToEvents new event`);\r\n      console.log(event);\r\n    };\r\n\r\n    contract.on(filter, listener);\r\n\r\n    return () => {\r\n      console.log(`useListenToEvents useEffect exit`);\r\n      contract.removeListener(filter, listener);\r\n    };\r\n  }, []);\r\n\r\n  // return newRegin;\r\n};\r\n\r\nexport {useListenToEvents};\r\n```\r\n\r\n\r\n\r\n\r\n",
  "closed_by": {
    "login": "fvictorio",
    "id": 417134,
    "node_id": "MDQ6VXNlcjQxNzEzNA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/fvictorio",
    "html_url": "https://github.com/fvictorio",
    "followers_url": "https://api.github.com/users/fvictorio/followers",
    "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
    "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
    "organizations_url": "https://api.github.com/users/fvictorio/orgs",
    "repos_url": "https://api.github.com/users/fvictorio/repos",
    "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
    "received_events_url": "https://api.github.com/users/fvictorio/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1773/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1773/timeline",
  "performed_via_github_app": null,
  "state_reason": "not_planned"
}
[
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/898225407",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/1773#issuecomment-898225407",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1773",
    "id": 898225407,
    "node_id": "IC_kwDOB7jojM41idT_",
    "user": {
      "login": "StErMi",
      "id": 146166,
      "node_id": "MDQ6VXNlcjE0NjE2Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/146166?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/StErMi",
      "html_url": "https://github.com/StErMi",
      "followers_url": "https://api.github.com/users/StErMi/followers",
      "following_url": "https://api.github.com/users/StErMi/following{/other_user}",
      "gists_url": "https://api.github.com/users/StErMi/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/StErMi/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/StErMi/subscriptions",
      "organizations_url": "https://api.github.com/users/StErMi/orgs",
      "repos_url": "https://api.github.com/users/StErMi/repos",
      "events_url": "https://api.github.com/users/StErMi/events{/privacy}",
      "received_events_url": "https://api.github.com/users/StErMi/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-08-13T06:33:06Z",
    "updated_at": "2021-08-13T06:33:06Z",
    "author_association": "NONE",
    "body": "@fvictorio do you need something else to reproduce the problem?",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/898225407/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/898441361",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/1773#issuecomment-898441361",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1773",
    "id": 898441361,
    "node_id": "IC_kwDOB7jojM41jSCR",
    "user": {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-08-13T13:01:02Z",
    "updated_at": "2021-08-13T13:01:02Z",
    "author_association": "MEMBER",
    "body": "@StErMi, no, thank you. I think I also noticed this. We are working on something that might fix this.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/898441361/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 1,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1027143553",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/1773#issuecomment-1027143553",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1773",
    "id": 1027143553,
    "node_id": "IC_kwDOB7jojM49OPeB",
    "user": {
      "login": "abusomani",
      "id": 8527270,
      "node_id": "MDQ6VXNlcjg1MjcyNzA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8527270?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/abusomani",
      "html_url": "https://github.com/abusomani",
      "followers_url": "https://api.github.com/users/abusomani/followers",
      "following_url": "https://api.github.com/users/abusomani/following{/other_user}",
      "gists_url": "https://api.github.com/users/abusomani/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/abusomani/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/abusomani/subscriptions",
      "organizations_url": "https://api.github.com/users/abusomani/orgs",
      "repos_url": "https://api.github.com/users/abusomani/repos",
      "events_url": "https://api.github.com/users/abusomani/events{/privacy}",
      "received_events_url": "https://api.github.com/users/abusomani/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-02-01T18:13:59Z",
    "updated_at": "2022-02-01T18:13:59Z",
    "author_association": "NONE",
    "body": "@fvictorio Were you able to resolve the issue? What was the fix?",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1027143553/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1069642941",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/1773#issuecomment-1069642941",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1773",
    "id": 1069642941,
    "node_id": "IC_kwDOB7jojM4_wXS9",
    "user": {
      "login": "sveitser",
      "id": 1040871,
      "node_id": "MDQ6VXNlcjEwNDA4NzE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1040871?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sveitser",
      "html_url": "https://github.com/sveitser",
      "followers_url": "https://api.github.com/users/sveitser/followers",
      "following_url": "https://api.github.com/users/sveitser/following{/other_user}",
      "gists_url": "https://api.github.com/users/sveitser/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sveitser/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sveitser/subscriptions",
      "organizations_url": "https://api.github.com/users/sveitser/orgs",
      "repos_url": "https://api.github.com/users/sveitser/repos",
      "events_url": "https://api.github.com/users/sveitser/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sveitser/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-03-16T21:16:20Z",
    "updated_at": "2022-03-16T21:16:20Z",
    "author_association": "NONE",
    "body": "I'm not sure this is the same issue but it may be related. We ran into an issue where hardhat always returns events from the last block because `fromBlock` is set to the latest block number if `fromBlock` is greater than the latest block number and `fromBlock` is inclusive.\r\n\r\nhttps://github.com/NomicFoundation/hardhat/blob/4d43cbbebdb2ced843a29fa12b895d4fe5f01e83/packages/hardhat-core/src/internal/hardhat-network/provider/node.ts#L2392-L2393\r\n\r\nWith go-ethereum setting a `fromBlock` greater than the latest block number does not return any events.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1069642941/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1191404327",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/1773#issuecomment-1191404327",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1773",
    "id": 1191404327,
    "node_id": "IC_kwDOB7jojM5HA2Mn",
    "user": {
      "login": "vincanger",
      "id": 70215737,
      "node_id": "MDQ6VXNlcjcwMjE1NzM3",
      "avatar_url": "https://avatars.githubusercontent.com/u/70215737?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vincanger",
      "html_url": "https://github.com/vincanger",
      "followers_url": "https://api.github.com/users/vincanger/followers",
      "following_url": "https://api.github.com/users/vincanger/following{/other_user}",
      "gists_url": "https://api.github.com/users/vincanger/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vincanger/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vincanger/subscriptions",
      "organizations_url": "https://api.github.com/users/vincanger/orgs",
      "repos_url": "https://api.github.com/users/vincanger/repos",
      "events_url": "https://api.github.com/users/vincanger/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vincanger/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-21T12:07:23Z",
    "updated_at": "2022-07-21T12:07:57Z",
    "author_association": "NONE",
    "body": "@StErMi @abusomani  I solved this while testing against the hardhat node on localhost (code below) but I'm curious if this would cause problems in production?\r\n\r\n```TypeScript\r\n  useEffect(() => {\r\n    const getBlockNumber = async () => setPrevBlockNumber(await provider.getBlockNumber());\r\n    getBlockNumber();\r\n    \r\n    //...\r\n    \r\n    const transferHandler = async (amount, emittedEvent) => {\r\n      if (emittedEvent.blockNumber > prevBlockNumber) {\r\n         //... do stuff\r\n      }\r\n      setPrevBlockNumber(emittedEvent.blockNumber);\r\n    }\r\n\r\n    tokenContract.contract.on(TokenEvent.Transfer, transferHandler);\r\n\r\n    return () => {\r\n      tokenContract.contract.off(TokenEvent.Transfer, transferHandler);\r\n    }\r\n  }, []);\r\n```\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1191404327/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1367173806",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/1773#issuecomment-1367173806",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1773",
    "id": 1367173806,
    "node_id": "IC_kwDOB7jojM5RfWqu",
    "user": {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-29T09:08:53Z",
    "updated_at": "2022-12-29T09:08:53Z",
    "author_association": "MEMBER",
    "body": "The issue here is that when you start listening for events, the latest block is immediately checked. If you are using the Hardhat network and no block was mined since the transaction that emitted the vent was sent, then the listener will be triggered again. This is just the way ethers works (check [this comment](https://github.com/ethers-io/ethers.js/issues/386#issuecomment-451025717)).\r\n\r\nPossible solutions:\r\n- Mine a new empty block using the [`mine`](https://hardhat.org/hardhat-network-helpers/docs/reference#mining-blocks) helper.\r\n- Enable [interval mining](https://hardhat.org/hardhat-network/docs/reference#mining-modes) so that new blocks are periodically mined.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1367173806/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
