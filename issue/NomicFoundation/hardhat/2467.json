{
  "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2467",
  "repository_url": "https://api.github.com/repos/NomicFoundation/hardhat",
  "labels_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2467/labels{/name}",
  "comments_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2467/comments",
  "events_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2467/events",
  "html_url": "https://github.com/NomicFoundation/hardhat/issues/2467",
  "id": 1163924488,
  "node_id": "I_kwDOB7jojM5FYBQI",
  "number": 2467,
  "title": "`hardhat_mine` produces a failed tx when running in Coverage",
  "user": {
    "login": "julianmrodri",
    "id": 56316686,
    "node_id": "MDQ6VXNlcjU2MzE2Njg2",
    "avatar_url": "https://avatars.githubusercontent.com/u/56316686?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/julianmrodri",
    "html_url": "https://github.com/julianmrodri",
    "followers_url": "https://api.github.com/users/julianmrodri/followers",
    "following_url": "https://api.github.com/users/julianmrodri/following{/other_user}",
    "gists_url": "https://api.github.com/users/julianmrodri/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/julianmrodri/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/julianmrodri/subscriptions",
    "organizations_url": "https://api.github.com/users/julianmrodri/orgs",
    "repos_url": "https://api.github.com/users/julianmrodri/repos",
    "events_url": "https://api.github.com/users/julianmrodri/events{/privacy}",
    "received_events_url": "https://api.github.com/users/julianmrodri/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": true,
  "assignee": {
    "login": "fvictorio",
    "id": 417134,
    "node_id": "MDQ6VXNlcjQxNzEzNA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/fvictorio",
    "html_url": "https://github.com/fvictorio",
    "followers_url": "https://api.github.com/users/fvictorio/followers",
    "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
    "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
    "organizations_url": "https://api.github.com/users/fvictorio/orgs",
    "repos_url": "https://api.github.com/users/fvictorio/repos",
    "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
    "received_events_url": "https://api.github.com/users/fvictorio/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2022-03-09T13:13:30Z",
  "updated_at": "2022-11-18T00:17:35Z",
  "closed_at": "2022-04-27T20:16:51Z",
  "author_association": "NONE",
  "active_lock_reason": "resolved",
  "body": "Hi, we are facing a strange situation using the newly added `hardhat_mine` to mine several blocks at once.\r\n\r\nWhen we use it in our *regular* tests, it works fine. But when running in **coverage** mode (`npx hardhat coverage`) we get in one case the following error in a transaction sent *right after* the blocks are mined:\r\n\r\n```\r\nInvalidInputError: Transaction gasPrice (1) is too low for the next block, which has a baseFeePerGas of 7\r\n      at HardhatNode._validateAutominedTx (node_modules/hardhat/src/internal/hardhat-network/provider/node.ts:1661:17)\r\n      at async HardhatNode.sendTransaction (node_modules/hardhat/src/internal/hardhat-network/provider/node.ts:435:5)\r\n      at async EthModule._sendTransactionAndReturnHash (node_modules/hardhat/src/internal/hardhat-network/provider/modules/eth.ts:1496:18)\r\n      at async HardhatNetworkProvider.request (node_modules/hardhat/src/internal/hardhat-network/provider/provider.ts:118:18)\r\n      at async EthersProviderWrapper.send (node_modules/@nomiclabs/hardhat-ethers/src/internal/ethers-provider-wrapper.ts:13:20)\r\n```\r\n\r\nWe created the following auxiliary function to be able to specify in our tests the number of blocks to mine. \r\n\r\n```\r\nexport const advanceBlocks = async (blocks: number) => {\r\n  await ethers.provider.send('hardhat_mine', ['0x' + blocks.toString(16)])\r\n}\r\n```\r\n\r\n In this specific test that fails we are calling in in this way:\r\n\r\n ```\r\n await advanceBlocks(17). // This causes a fail (in a subsequent tx) when running in coverage, but works fine in regular test.\r\n ```\r\nIn order to avoid this issue I can do `await advanceBlocks(1)`, 17 times and that would do the trick and everything works fine even in coverage mode:\r\n\r\n```\r\n await advanceBlocks(1). //  This works when running in coverage, and works fine in regular test.\r\n await advanceBlocks(1)\r\n await advanceBlocks(1)\r\n ....\r\n .....\r\n await advanceBlocks(1)   // 17 times..\r\n```\r\n\r\nThis is the configuration in our `hardhat.config.ts`\r\n\r\n```\r\n   hardhat: {\r\n      gas: 999999999999,\r\n      blockGasLimit: 0x1fffffffffffff,\r\n      allowUnlimitedContractSize: true,\r\n    },\r\n```\r\nAny help or guidance in how we can fix this and still use the `hardhat_mine` with multiple blocks would be highly appreciated.\r\n\r\n\r\nThanks!\r\nJulian",
  "closed_by": {
    "login": "alcuadrado",
    "id": 176499,
    "node_id": "MDQ6VXNlcjE3NjQ5OQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/176499?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/alcuadrado",
    "html_url": "https://github.com/alcuadrado",
    "followers_url": "https://api.github.com/users/alcuadrado/followers",
    "following_url": "https://api.github.com/users/alcuadrado/following{/other_user}",
    "gists_url": "https://api.github.com/users/alcuadrado/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/alcuadrado/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/alcuadrado/subscriptions",
    "organizations_url": "https://api.github.com/users/alcuadrado/orgs",
    "repos_url": "https://api.github.com/users/alcuadrado/repos",
    "events_url": "https://api.github.com/users/alcuadrado/events{/privacy}",
    "received_events_url": "https://api.github.com/users/alcuadrado/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2467/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2467/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1063019740",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/2467#issuecomment-1063019740",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2467",
    "id": 1063019740,
    "node_id": "IC_kwDOB7jojM4_XGTc",
    "user": {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-03-09T15:09:31Z",
    "updated_at": "2022-03-09T15:09:31Z",
    "author_association": "MEMBER",
    "body": "Thanks a lot for reporting this @julianmrodri. I think I know what's going on and how to fix it.\r\n\r\nFor the time being, a workaround is to do this after calling `hardhat_mine`:\r\n\r\n```\r\nawait network.provider.send('hardhat_setNextBlockBaseFeePerGas', ['0x0'])\r\n```\r\n\r\nI know it's not a great solution, but maybe it can help you until we release a fix for this.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1063019740/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1063045157",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/2467#issuecomment-1063045157",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2467",
    "id": 1063045157,
    "node_id": "IC_kwDOB7jojM4_XMgl",
    "user": {
      "login": "julianmrodri",
      "id": 56316686,
      "node_id": "MDQ6VXNlcjU2MzE2Njg2",
      "avatar_url": "https://avatars.githubusercontent.com/u/56316686?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/julianmrodri",
      "html_url": "https://github.com/julianmrodri",
      "followers_url": "https://api.github.com/users/julianmrodri/followers",
      "following_url": "https://api.github.com/users/julianmrodri/following{/other_user}",
      "gists_url": "https://api.github.com/users/julianmrodri/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/julianmrodri/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/julianmrodri/subscriptions",
      "organizations_url": "https://api.github.com/users/julianmrodri/orgs",
      "repos_url": "https://api.github.com/users/julianmrodri/repos",
      "events_url": "https://api.github.com/users/julianmrodri/events{/privacy}",
      "received_events_url": "https://api.github.com/users/julianmrodri/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-03-09T15:32:15Z",
    "updated_at": "2022-03-09T15:32:15Z",
    "author_association": "NONE",
    "body": "Thanks, the workaround seems to work! ",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1063045157/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 1,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1164293888",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/2467#issuecomment-1164293888",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2467",
    "id": 1164293888,
    "node_id": "IC_kwDOB7jojM5FZbcA",
    "user": {
      "login": "ivelin",
      "id": 2234901,
      "node_id": "MDQ6VXNlcjIyMzQ5MDE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2234901?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ivelin",
      "html_url": "https://github.com/ivelin",
      "followers_url": "https://api.github.com/users/ivelin/followers",
      "following_url": "https://api.github.com/users/ivelin/following{/other_user}",
      "gists_url": "https://api.github.com/users/ivelin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ivelin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ivelin/subscriptions",
      "organizations_url": "https://api.github.com/users/ivelin/orgs",
      "repos_url": "https://api.github.com/users/ivelin/repos",
      "events_url": "https://api.github.com/users/ivelin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ivelin/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-06-23T11:29:14Z",
    "updated_at": "2022-06-23T11:50:17Z",
    "author_association": "NONE",
    "body": "Hi folks. Thank you for the incredible work.\r\n\r\nThis particular issues occurs with the latest hardhat v2.9.9 when using xdeployer in test cases. See PR log here:\r\nhttps://github.com/SporosDAO/sweat-token/runs/7022447221?check_suite_focus=true#step:3:84\r\n\r\nThe suggested workaround above does not seem to help when used around create2deploy.deploy in test cases.\r\n\r\nUPDATE:\r\nThe workaround for us was to increase `gasLimit` for `xdeploy` in `hardhat.config.ts`.\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1164293888/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
