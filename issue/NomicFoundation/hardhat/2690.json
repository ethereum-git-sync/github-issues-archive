{
  "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2690",
  "repository_url": "https://api.github.com/repos/NomicFoundation/hardhat",
  "labels_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2690/labels{/name}",
  "comments_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2690/comments",
  "events_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2690/events",
  "html_url": "https://github.com/NomicFoundation/hardhat/issues/2690",
  "id": 1231146078,
  "node_id": "I_kwDOB7jojM5JYcxe",
  "number": 2690,
  "title": "Rinkeby deployment not working",
  "user": {
    "login": "0xTimepunk",
    "id": 45543880,
    "node_id": "MDQ6VXNlcjQ1NTQzODgw",
    "avatar_url": "https://avatars.githubusercontent.com/u/45543880?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/0xTimepunk",
    "html_url": "https://github.com/0xTimepunk",
    "followers_url": "https://api.github.com/users/0xTimepunk/followers",
    "following_url": "https://api.github.com/users/0xTimepunk/following{/other_user}",
    "gists_url": "https://api.github.com/users/0xTimepunk/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/0xTimepunk/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/0xTimepunk/subscriptions",
    "organizations_url": "https://api.github.com/users/0xTimepunk/orgs",
    "repos_url": "https://api.github.com/users/0xTimepunk/repos",
    "events_url": "https://api.github.com/users/0xTimepunk/events{/privacy}",
    "received_events_url": "https://api.github.com/users/0xTimepunk/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": true,
  "assignee": {
    "login": "alcuadrado",
    "id": 176499,
    "node_id": "MDQ6VXNlcjE3NjQ5OQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/176499?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/alcuadrado",
    "html_url": "https://github.com/alcuadrado",
    "followers_url": "https://api.github.com/users/alcuadrado/followers",
    "following_url": "https://api.github.com/users/alcuadrado/following{/other_user}",
    "gists_url": "https://api.github.com/users/alcuadrado/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/alcuadrado/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/alcuadrado/subscriptions",
    "organizations_url": "https://api.github.com/users/alcuadrado/orgs",
    "repos_url": "https://api.github.com/users/alcuadrado/repos",
    "events_url": "https://api.github.com/users/alcuadrado/events{/privacy}",
    "received_events_url": "https://api.github.com/users/alcuadrado/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "alcuadrado",
      "id": 176499,
      "node_id": "MDQ6VXNlcjE3NjQ5OQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/176499?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alcuadrado",
      "html_url": "https://github.com/alcuadrado",
      "followers_url": "https://api.github.com/users/alcuadrado/followers",
      "following_url": "https://api.github.com/users/alcuadrado/following{/other_user}",
      "gists_url": "https://api.github.com/users/alcuadrado/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alcuadrado/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alcuadrado/subscriptions",
      "organizations_url": "https://api.github.com/users/alcuadrado/orgs",
      "repos_url": "https://api.github.com/users/alcuadrado/repos",
      "events_url": "https://api.github.com/users/alcuadrado/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alcuadrado/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2022-05-10T13:19:06Z",
  "updated_at": "2022-11-18T00:17:40Z",
  "closed_at": "2022-06-19T20:33:42Z",
  "author_association": "NONE",
  "active_lock_reason": "resolved",
  "body": "Suddenly rinkeby deployments do not work (are stuck) in hardhat  hardhat run --network rinkeby scripts/deploy.ts\r\n\r\nRinkeby network doesn't seem down and hardhat does not provide any information about what's happening.\r\n\r\nI tried setting gas and gasPrice in hardhat config without any help\r\n\r\n```\r\n    rinkeby: {\r\n      url: 'https://eth-rinkeby.alchemyapi.io/v2/' + process.env.ALCHEMY_TOKEN,\r\n      accounts: {\r\n        mnemonic: process.env.MNEMONIC as string,\r\n      },\r\n      gas: 2100000,\r\n      gasPrice: 8000000000,\r\n    },\r\n```\r\n\r\nThe strangest thing is that this deployment was working yesterday.\r\nI tried deploying to rinkeby on different repos that were previously working and they are stuck as well. Asked a colleague to do the deployment and tried in a different pc and it is also stuck.",
  "closed_by": {
    "login": "github-actions[bot]",
    "id": 41898282,
    "node_id": "MDM6Qm90NDE4OTgyODI=",
    "avatar_url": "https://avatars.githubusercontent.com/in/15368?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/github-actions%5Bbot%5D",
    "html_url": "https://github.com/apps/github-actions",
    "followers_url": "https://api.github.com/users/github-actions%5Bbot%5D/followers",
    "following_url": "https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}",
    "gists_url": "https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/github-actions%5Bbot%5D/subscriptions",
    "organizations_url": "https://api.github.com/users/github-actions%5Bbot%5D/orgs",
    "repos_url": "https://api.github.com/users/github-actions%5Bbot%5D/repos",
    "events_url": "https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}",
    "received_events_url": "https://api.github.com/users/github-actions%5Bbot%5D/received_events",
    "type": "Bot",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2690/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2690/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1122383248",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/2690#issuecomment-1122383248",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2690",
    "id": 1122383248,
    "node_id": "IC_kwDOB7jojM5C5jWQ",
    "user": {
      "login": "github-actions[bot]",
      "id": 41898282,
      "node_id": "MDM6Qm90NDE4OTgyODI=",
      "avatar_url": "https://avatars.githubusercontent.com/in/15368?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/github-actions%5Bbot%5D",
      "html_url": "https://github.com/apps/github-actions",
      "followers_url": "https://api.github.com/users/github-actions%5Bbot%5D/followers",
      "following_url": "https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}",
      "gists_url": "https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/github-actions%5Bbot%5D/subscriptions",
      "organizations_url": "https://api.github.com/users/github-actions%5Bbot%5D/orgs",
      "repos_url": "https://api.github.com/users/github-actions%5Bbot%5D/repos",
      "events_url": "https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}",
      "received_events_url": "https://api.github.com/users/github-actions%5Bbot%5D/received_events",
      "type": "Bot",
      "site_admin": false
    },
    "created_at": "2022-05-10T13:20:00Z",
    "updated_at": "2022-05-10T13:20:00Z",
    "author_association": "CONTRIBUTOR",
    "body": "This issue is also being [tracked on Linear](https://linear.app/nomic-foundation/issue/HH-630/rinkeby-deployment-not-working-[nomicfoundationhardhat2690]).\n\nWe use Linear to manage our development process, but we keep the conversations on Github.\n\nLINEAR-ID: a273f22e-238e-4189-b89e-7d6deb08f386",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1122383248/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1122396823",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/2690#issuecomment-1122396823",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2690",
    "id": 1122396823,
    "node_id": "IC_kwDOB7jojM5C5mqX",
    "user": {
      "login": "0xTimepunk",
      "id": 45543880,
      "node_id": "MDQ6VXNlcjQ1NTQzODgw",
      "avatar_url": "https://avatars.githubusercontent.com/u/45543880?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/0xTimepunk",
      "html_url": "https://github.com/0xTimepunk",
      "followers_url": "https://api.github.com/users/0xTimepunk/followers",
      "following_url": "https://api.github.com/users/0xTimepunk/following{/other_user}",
      "gists_url": "https://api.github.com/users/0xTimepunk/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/0xTimepunk/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/0xTimepunk/subscriptions",
      "organizations_url": "https://api.github.com/users/0xTimepunk/orgs",
      "repos_url": "https://api.github.com/users/0xTimepunk/repos",
      "events_url": "https://api.github.com/users/0xTimepunk/events{/privacy}",
      "received_events_url": "https://api.github.com/users/0xTimepunk/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-10T13:29:52Z",
    "updated_at": "2022-05-10T13:29:52Z",
    "author_association": "NONE",
    "body": "Apparently this issue is connected to the usage of alchemy endpoint. If I use infura it works",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1122396823/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1125873204",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/2690#issuecomment-1125873204",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2690",
    "id": 1125873204,
    "node_id": "IC_kwDOB7jojM5DG3Y0",
    "user": {
      "login": "kowalski",
      "id": 287481,
      "node_id": "MDQ6VXNlcjI4NzQ4MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/287481?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/kowalski",
      "html_url": "https://github.com/kowalski",
      "followers_url": "https://api.github.com/users/kowalski/followers",
      "following_url": "https://api.github.com/users/kowalski/following{/other_user}",
      "gists_url": "https://api.github.com/users/kowalski/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/kowalski/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/kowalski/subscriptions",
      "organizations_url": "https://api.github.com/users/kowalski/orgs",
      "repos_url": "https://api.github.com/users/kowalski/repos",
      "events_url": "https://api.github.com/users/kowalski/events{/privacy}",
      "received_events_url": "https://api.github.com/users/kowalski/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-13T10:02:29Z",
    "updated_at": "2022-05-13T10:03:11Z",
    "author_association": "NONE",
    "body": "I think I've seen a similar problem and was able to debug this a bit further. \r\nI don't think that changing the endpoint to Infura made a difference. What made a difference are network conditions on Rinkeby and the fact that it took some time.\r\n\r\nLet me explain.\r\n\r\nI think the problem is here: \r\nhttps://github.com/NomicFoundation/hardhat/blob/master/packages/hardhat-core/src/internal/core/providers/gas-providers.ts#L278\r\n\r\nWhen sending a type=2 transaction provider calculates fee parameters as:\r\n```\r\nmaxFeePerGas = 81/64 * baseFeeFromLastBlock\r\nmaxPriorityFeePerGas = maxPriorityFeePerGasFromLastBlock\r\n```\r\n\r\nThis formulas work fine for Mainnet but not for Rinkeby. Difference is that for Rinkeby it's normal to priorityFeePerGas be roughtly equal to baseFee. On Mainnet priority fee is much lower when compared to baseFee.\r\n\r\nThe kicker is that:\r\n\r\n```\r\nmaxFeePerGas = maxBaseFeePerGas + maxPriorityFeePerGas\r\n```\r\n \r\nSince `_suggestEip1559FeePriceValues` sets:\r\n\r\n```\r\nmaxFeePerGas = 1.26 * baseFeePerGas\r\n```\r\n\r\nIt means that it will work only if priorityFee is lower than `0.26 * baseFeePerGas`. This is true for mainnet and usually is true for Rinkeby. But sometimes it's not true for Rinkeby and when it's not the only was to have this working is to pass fee parameters explicitely to `deploy` function.\r\n\r\nMy suggestion for a fix:\r\n\r\n```\r\n        maxFeePerGas: rpcQuantityToBN(response.baseFeePerGas[1])\r\n          .mul(\r\n            new BN(9).pow(\r\n              new BN(\r\n                AutomaticGasPriceProvider.EIP1559_BASE_FEE_MAX_FULL_BLOCKS_PREFERENCE -\r\n                  1\r\n              )\r\n            )\r\n          )\r\n          .div(\r\n            new BN(8).pow(\r\n              new BN(\r\n                AutomaticGasPriceProvider.EIP1559_BASE_FEE_MAX_FULL_BLOCKS_PREFERENCE -\r\n                  1\r\n              )\r\n            )\r\n-         ),\r\n+        ).add(rpcQuantityToBN(response.reward[0][0])),\r\n        maxPriorityFeePerGas: rpcQuantityToBN(response.reward[0][0]),\r\n```\r\n\r\nRational: this changes the calculation as:\r\n\r\n```\r\nmaxFeePerGas = 1.26 * baseFeePerGas + previousMaxPriorotyFeePerGas\r\n```\r\ntherefore correctly encapsulates the maximum required fee (assuming 2 blocks where produced with 200% gas limit usage)",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1125873204/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1153286048",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/2690#issuecomment-1153286048",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2690",
    "id": 1153286048,
    "node_id": "IC_kwDOB7jojM5Evb-g",
    "user": {
      "login": "github-actions[bot]",
      "id": 41898282,
      "node_id": "MDM6Qm90NDE4OTgyODI=",
      "avatar_url": "https://avatars.githubusercontent.com/in/15368?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/github-actions%5Bbot%5D",
      "html_url": "https://github.com/apps/github-actions",
      "followers_url": "https://api.github.com/users/github-actions%5Bbot%5D/followers",
      "following_url": "https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}",
      "gists_url": "https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/github-actions%5Bbot%5D/subscriptions",
      "organizations_url": "https://api.github.com/users/github-actions%5Bbot%5D/orgs",
      "repos_url": "https://api.github.com/users/github-actions%5Bbot%5D/repos",
      "events_url": "https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}",
      "received_events_url": "https://api.github.com/users/github-actions%5Bbot%5D/received_events",
      "type": "Bot",
      "site_admin": false
    },
    "created_at": "2022-06-12T20:33:28Z",
    "updated_at": "2022-06-12T20:33:28Z",
    "author_association": "CONTRIBUTOR",
    "body": "This issue was marked as stale because it didn't have any activity in the last 30 days. If you think it's still relevant, please leave a comment indicating so. Otherwise, it will be closed in 7 days.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1153286048/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1159806535",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/2690#issuecomment-1159806535",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2690",
    "id": 1159806535,
    "node_id": "IC_kwDOB7jojM5FIT5H",
    "user": {
      "login": "github-actions[bot]",
      "id": 41898282,
      "node_id": "MDM6Qm90NDE4OTgyODI=",
      "avatar_url": "https://avatars.githubusercontent.com/in/15368?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/github-actions%5Bbot%5D",
      "html_url": "https://github.com/apps/github-actions",
      "followers_url": "https://api.github.com/users/github-actions%5Bbot%5D/followers",
      "following_url": "https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}",
      "gists_url": "https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/github-actions%5Bbot%5D/subscriptions",
      "organizations_url": "https://api.github.com/users/github-actions%5Bbot%5D/orgs",
      "repos_url": "https://api.github.com/users/github-actions%5Bbot%5D/repos",
      "events_url": "https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}",
      "received_events_url": "https://api.github.com/users/github-actions%5Bbot%5D/received_events",
      "type": "Bot",
      "site_admin": false
    },
    "created_at": "2022-06-19T20:33:41Z",
    "updated_at": "2022-06-19T20:33:41Z",
    "author_association": "CONTRIBUTOR",
    "body": "This issue was closed because it has been stalled for 7 days with no activity.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1159806535/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
