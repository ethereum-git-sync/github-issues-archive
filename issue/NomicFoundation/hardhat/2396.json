{
  "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2396",
  "repository_url": "https://api.github.com/repos/NomicFoundation/hardhat",
  "labels_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2396/labels{/name}",
  "comments_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2396/comments",
  "events_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2396/events",
  "html_url": "https://github.com/NomicFoundation/hardhat/issues/2396",
  "id": 1141762504,
  "node_id": "I_kwDOB7jojM5EDenI",
  "number": 2396,
  "title": "Hardfork activation history not working on polygon fork",
  "user": {
    "login": "samlaf",
    "id": 9342524,
    "node_id": "MDQ6VXNlcjkzNDI1MjQ=",
    "avatar_url": "https://avatars.githubusercontent.com/u/9342524?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/samlaf",
    "html_url": "https://github.com/samlaf",
    "followers_url": "https://api.github.com/users/samlaf/followers",
    "following_url": "https://api.github.com/users/samlaf/following{/other_user}",
    "gists_url": "https://api.github.com/users/samlaf/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/samlaf/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/samlaf/subscriptions",
    "organizations_url": "https://api.github.com/users/samlaf/orgs",
    "repos_url": "https://api.github.com/users/samlaf/repos",
    "events_url": "https://api.github.com/users/samlaf/events{/privacy}",
    "received_events_url": "https://api.github.com/users/samlaf/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": true,
  "assignee": {
    "login": "feuGeneA",
    "id": 7883777,
    "node_id": "MDQ6VXNlcjc4ODM3Nzc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/7883777?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/feuGeneA",
    "html_url": "https://github.com/feuGeneA",
    "followers_url": "https://api.github.com/users/feuGeneA/followers",
    "following_url": "https://api.github.com/users/feuGeneA/following{/other_user}",
    "gists_url": "https://api.github.com/users/feuGeneA/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/feuGeneA/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/feuGeneA/subscriptions",
    "organizations_url": "https://api.github.com/users/feuGeneA/orgs",
    "repos_url": "https://api.github.com/users/feuGeneA/repos",
    "events_url": "https://api.github.com/users/feuGeneA/events{/privacy}",
    "received_events_url": "https://api.github.com/users/feuGeneA/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "feuGeneA",
      "id": 7883777,
      "node_id": "MDQ6VXNlcjc4ODM3Nzc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7883777?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/feuGeneA",
      "html_url": "https://github.com/feuGeneA",
      "followers_url": "https://api.github.com/users/feuGeneA/followers",
      "following_url": "https://api.github.com/users/feuGeneA/following{/other_user}",
      "gists_url": "https://api.github.com/users/feuGeneA/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/feuGeneA/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/feuGeneA/subscriptions",
      "organizations_url": "https://api.github.com/users/feuGeneA/orgs",
      "repos_url": "https://api.github.com/users/feuGeneA/repos",
      "events_url": "https://api.github.com/users/feuGeneA/events{/privacy}",
      "received_events_url": "https://api.github.com/users/feuGeneA/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2022-02-17T19:23:12Z",
  "updated_at": "2022-11-18T09:53:45Z",
  "closed_at": "2022-05-12T22:35:47Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": "resolved",
  "body": "I am running a forked polygon node from a historical block:\r\n```\r\nnpx hardhat node --fork https://polygon-mainnet.infura.io/v3/${INFURA_KEY} --fork-block-number 25055503\r\n```\r\nand then running a script which queries a quickswap pair's reserves 4 blocks back (block 25055499). But I am receiving this error:\r\n```\r\nInternalError: No known hardfork for execution on historical block 25055499 (relative to fork block number 25055503). The node was not configured with a hardfork activation history.  See http://hardhat.org/hardhat-network/guides/mainnet-forking.html#using-a-custom-hardfork-history\r\n    at HardhatNode._selectHardfork (/home/samlaf/dev/bots/arb-bots/full-bots/2-nacho-weth/node_modules/hardhat/src/internal/hardhat-network/provider/node.ts:2406:13)\r\n    at HardhatNode.isEip1559Active (/home/samlaf/dev/bots/arb-bots/full-bots/2-nacho-weth/node_modules/hardhat/src/internal/hardhat-network/provider/node.ts:2350:14)\r\n    at HardhatNode.runCall (/home/samlaf/dev/bots/arb-bots/full-bots/2-nacho-weth/node_modules/hardhat/src/internal/hardhat-network/provider/node.ts:506:13)\r\n    at processTicksAndRejections (node:internal/process/task_queues:96:5)\r\n    at async EthModule._callAction (/home/samlaf/dev/bots/arb-bots/full-bots/2-nacho-weth/node_modules/hardhat/src/internal/hardhat-network/provider/modules/eth.ts:353:9)\r\n    at async HardhatNetworkProvider.request (/home/samlaf/dev/bots/arb-bots/full-bots/2-nacho-weth/node_modules/hardhat/src/internal/hardhat-network/provider/provider.ts:117:18)\r\n    at async EthersProviderWrapper.send (/home/samlaf/dev/bots/arb-bots/full-bots/2-nacho-weth/node_modules/@nomiclabs/hardhat-ethers/src/internal/ethers-provider-wrapper.ts:13:20)\r\n```\r\n\r\nI have read the documentation and my `hardhat.config.ts` looks like this:\r\n```\r\n localhost: {\r\n      // Not working for some reason... see https://hardhat.org/hardhat-network/guides/mainnet-forking.html#using-a-custom-hardfork-history\r\n      chains: {\r\n        31337: {\r\n          hardforkHistory: {\r\n            \"london\": 23850000,\r\n          }\r\n        }\r\n      },\r\n      forking: {\r\n        url: `https://polygon-mainnet.infura.io/v3/${process.env.INFURA_KEY}`,\r\n        blockNumber: 25055503\r\n      },\r\n      chainId: 137,\r\n      accounts: {\r\n        // Default mnemonic\r\n        // See: https://hardhat.org/hardhat-network/reference/#accounts\r\n        mnemonic: \"test test test test test test test test test test test junk\",\r\n        accountsBalance: \"10000000000000000000000000000\", // == 1e10 * 1e18 MATIC\r\n      },\r\n    }\r\n```\r\nI tried adding/removing the `chains`, `forking`, and `chainId` properties, without success.\r\nAny help would be appreciated.",
  "closed_by": {
    "login": "github-actions[bot]",
    "id": 41898282,
    "node_id": "MDM6Qm90NDE4OTgyODI=",
    "avatar_url": "https://avatars.githubusercontent.com/in/15368?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/github-actions%5Bbot%5D",
    "html_url": "https://github.com/apps/github-actions",
    "followers_url": "https://api.github.com/users/github-actions%5Bbot%5D/followers",
    "following_url": "https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}",
    "gists_url": "https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/github-actions%5Bbot%5D/subscriptions",
    "organizations_url": "https://api.github.com/users/github-actions%5Bbot%5D/orgs",
    "repos_url": "https://api.github.com/users/github-actions%5Bbot%5D/repos",
    "events_url": "https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}",
    "received_events_url": "https://api.github.com/users/github-actions%5Bbot%5D/received_events",
    "type": "Bot",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2396/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2396/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1044937872",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/2396#issuecomment-1044937872",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2396",
    "id": 1044937872,
    "node_id": "IC_kwDOB7jojM4-SHyQ",
    "user": {
      "login": "samlaf",
      "id": 9342524,
      "node_id": "MDQ6VXNlcjkzNDI1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9342524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/samlaf",
      "html_url": "https://github.com/samlaf",
      "followers_url": "https://api.github.com/users/samlaf/followers",
      "following_url": "https://api.github.com/users/samlaf/following{/other_user}",
      "gists_url": "https://api.github.com/users/samlaf/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/samlaf/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/samlaf/subscriptions",
      "organizations_url": "https://api.github.com/users/samlaf/orgs",
      "repos_url": "https://api.github.com/users/samlaf/repos",
      "events_url": "https://api.github.com/users/samlaf/events{/privacy}",
      "received_events_url": "https://api.github.com/users/samlaf/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-02-18T18:04:20Z",
    "updated_at": "2022-02-18T18:04:20Z",
    "author_association": "CONTRIBUTOR",
    "body": "I managed to fix this problem.\r\nThere were many things wrong about my config file, and things I didn't understand about hardhat network. I feel like the documentation at https://hardhat.org/hardhat-network/guides/mainnet-forking.html#using-a-custom-hardfork-history is very much lacking, and I'll write what I think should be updated/added/removed.\r\n\r\n## \"Unusual network\" / \"well-known network\"\r\nThe first paragraph\r\n\r\n\"If you're forking an **unusual network**, and if you want to execute EVM code in the context of a historical block retrieved from that network, then you will need to configure Hardhat Network to know which hardforks to apply to which blocks. (If you're forking a **well-known network**, Hardhat Network will automatically choose the right hardfork for the execution of your EVM code, based on known histories of public networks, so you can safely ignore this section.)\"\r\n\r\nThis wording should be changed and made more precise, since I assumed Polygon was a \"well-known network\", but it apparently isn't. Running `npx hardhat console` and printing `network` shows the only chains that have default fork histories\r\n![image](https://user-images.githubusercontent.com/9342524/154735674-22c41689-fac6-4b24-8025-1f6e4a59142b.png)\r\nwith 137 (polygon) nowhere to be found.\r\n\r\n## hardhat vs localhost network\r\nThe distinction between the hardhat and localhost networks should be made more explicit somewhere in the docs. It confused me for a while, and still confuses me slightly.\r\n\r\n`npx hardhat console` ------localhost (31337)----> `npx hardhat node --fork <ALCHEMY_POLYGON_NODE>` ------hardhat(137)----> alchemy node\r\n\r\nWhenever opening the hardhat console or running a script that connects to the hardhat local node, we connect using `--network localhost`, which has chainId 31337\r\n![image](https://user-images.githubusercontent.com/9342524/154736550-13330e43-f3dc-4894-9537-907c05fc18fc.png)\r\nFurthermore, this network doesn't have any hardhat fork history, which confused me to make the above mistake of adding this to my hardhat config\r\n```\r\n localhost: {\r\n      // Not working for some reason... see https://hardhat.org/hardhat-network/guides/mainnet-forking.html#using-a-custom-hardfork-history\r\n      chains: {\r\n        31337: {\r\n          hardforkHistory: {\r\n            \"london\": 23850000,\r\n          }\r\n        }\r\n      },\r\n```\r\ninstead of the correct\r\n```\r\nhardhat: {\r\n      chains: {\r\n        137: {\r\n          hardforkHistory: {\r\n            london: 23850000\r\n          }\r\n        }\r\n      }\r\n```\r\n\r\n**I think it should be made explicit that we only ever need to change the hardhat network config, and never the localhost one, and maybe why (I still don't understand if there are any benefits to adding a localhost config)**\r\n\r\n## Adding an example (possibly with polygon)\r\nI would suggest adding an example of querying from an archive state from a fork of an \"unusual network\" such as polygon. Here is my config and example of querying the WMATIC totalSupply().\r\n```\r\n// hardhat.config.ts\r\n  networks: {\r\n    hardhat: {\r\n      forking: {\r\n        url: `${process.env.ALCHEMY_POLYGON_URL}`,\r\n        blockNumber: 25055503\r\n      },\r\n      chains: {\r\n        137: {\r\n          hardforkHistory: {\r\n            london: 23850000\r\n          }\r\n        }\r\n      }\r\n    },\r\n```\r\n```\r\n// scripts/polygonLocalArchiveCall.ts\r\nimport { ethers } from \"hardhat\";\r\nmain()\r\nasync function main() {\r\n  const abi = [ \"function totalSupply() returns (uint256)\"];\r\n  const iface = new ethers.utils.Interface(abi);\r\n  const totalSupplyCallResult = await ethers.provider.call(\r\n    {\r\n      to: \"0x0d500B1d8E8eF31E21C99d1Db9A6444d3ADf1270\",\r\n      data: iface.encodeFunctionData(\"totalSupply\"),\r\n    },\r\n    25055501\r\n  );\r\n  const totalSupply = iface.decodeFunctionResult(\r\n    \"totalSupply\",\r\n    totalSupplyCallResult\r\n  );\r\n  console.log(\"WMATIC totalSupply at block 25055501:\", totalSupply);\r\n}\r\n```\r\nand then run\r\n```\r\nnpx hardhat node\r\nnpx hardhat run scripts/polygonLocalArchiveCall.ts\r\n```\r\nwhich prints `WMATIC totalSupply at historical block 25055501: [ BigNumber { value: \"335767339284440162444238474\" } ]`",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1044937872/reactions",
      "total_count": 2,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 2,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1119067348",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/2396#issuecomment-1119067348",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2396",
    "id": 1119067348,
    "node_id": "IC_kwDOB7jojM5Cs5zU",
    "user": {
      "login": "github-actions[bot]",
      "id": 41898282,
      "node_id": "MDM6Qm90NDE4OTgyODI=",
      "avatar_url": "https://avatars.githubusercontent.com/in/15368?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/github-actions%5Bbot%5D",
      "html_url": "https://github.com/apps/github-actions",
      "followers_url": "https://api.github.com/users/github-actions%5Bbot%5D/followers",
      "following_url": "https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}",
      "gists_url": "https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/github-actions%5Bbot%5D/subscriptions",
      "organizations_url": "https://api.github.com/users/github-actions%5Bbot%5D/orgs",
      "repos_url": "https://api.github.com/users/github-actions%5Bbot%5D/repos",
      "events_url": "https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}",
      "received_events_url": "https://api.github.com/users/github-actions%5Bbot%5D/received_events",
      "type": "Bot",
      "site_admin": false
    },
    "created_at": "2022-05-05T21:33:27Z",
    "updated_at": "2022-05-05T21:33:27Z",
    "author_association": "CONTRIBUTOR",
    "body": "This issue was marked as stale because it didn't have any activity in the last 30 days. If you think it's still relevant, please leave a comment indicating so. Otherwise, it will be closed in 7 days.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1119067348/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1125479965",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/2396#issuecomment-1125479965",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2396",
    "id": 1125479965,
    "node_id": "IC_kwDOB7jojM5DFXYd",
    "user": {
      "login": "github-actions[bot]",
      "id": 41898282,
      "node_id": "MDM6Qm90NDE4OTgyODI=",
      "avatar_url": "https://avatars.githubusercontent.com/in/15368?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/github-actions%5Bbot%5D",
      "html_url": "https://github.com/apps/github-actions",
      "followers_url": "https://api.github.com/users/github-actions%5Bbot%5D/followers",
      "following_url": "https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}",
      "gists_url": "https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/github-actions%5Bbot%5D/subscriptions",
      "organizations_url": "https://api.github.com/users/github-actions%5Bbot%5D/orgs",
      "repos_url": "https://api.github.com/users/github-actions%5Bbot%5D/repos",
      "events_url": "https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}",
      "received_events_url": "https://api.github.com/users/github-actions%5Bbot%5D/received_events",
      "type": "Bot",
      "site_admin": false
    },
    "created_at": "2022-05-12T22:35:47Z",
    "updated_at": "2022-05-12T22:35:47Z",
    "author_association": "CONTRIBUTOR",
    "body": "This issue was closed because it has been stalled for 7 days with no activity.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1125479965/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
