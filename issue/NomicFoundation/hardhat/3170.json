{
  "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3170",
  "repository_url": "https://api.github.com/repos/NomicFoundation/hardhat",
  "labels_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3170/labels{/name}",
  "comments_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3170/comments",
  "events_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3170/events",
  "html_url": "https://github.com/NomicFoundation/hardhat/issues/3170",
  "id": 1370954953,
  "node_id": "I_kwDOB7jojM5RtxzJ",
  "number": 3170,
  "title": "Incorrect block hash when forking other EVM chains",
  "user": {
    "login": "leduythuccs",
    "id": 23715841,
    "node_id": "MDQ6VXNlcjIzNzE1ODQx",
    "avatar_url": "https://avatars.githubusercontent.com/u/23715841?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/leduythuccs",
    "html_url": "https://github.com/leduythuccs",
    "followers_url": "https://api.github.com/users/leduythuccs/followers",
    "following_url": "https://api.github.com/users/leduythuccs/following{/other_user}",
    "gists_url": "https://api.github.com/users/leduythuccs/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/leduythuccs/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/leduythuccs/subscriptions",
    "organizations_url": "https://api.github.com/users/leduythuccs/orgs",
    "repos_url": "https://api.github.com/users/leduythuccs/repos",
    "events_url": "https://api.github.com/users/leduythuccs/events{/privacy}",
    "received_events_url": "https://api.github.com/users/leduythuccs/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 901960538,
      "node_id": "MDU6TGFiZWw5MDE5NjA1Mzg=",
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/labels/type:bug",
      "name": "type:bug",
      "color": "FBCA04",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 947230177,
      "node_id": "MDU6TGFiZWw5NDcyMzAxNzc=",
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/labels/status:blocked",
      "name": "status:blocked",
      "color": "0E8A16",
      "default": false,
      "description": "Blocked by other issues or external reasons"
    },
    {
      "id": 4745762096,
      "node_id": "LA_kwDOB7jojM8AAAABGt6VMA",
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/labels/blocked-reason:needs-rethnet",
      "name": "blocked-reason:needs-rethnet",
      "color": "B60205",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2022-09-13T06:58:56Z",
  "updated_at": "2022-12-30T14:34:48Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "\r\n\r\nWhen forking other EVM chains (like Avax, Avax testnet, Aurora, Polygon, ...), the blockhash getting from `eth_getBlockByNumber` is not match with the RPC, the reason is:\r\n- In this: [ForkBlockchain.ts#L272](https://github.com/NomicFoundation/hardhat/blob/main/packages/hardhat-core/src/internal/hardhat-network/provider/fork/ForkBlockchain.ts#L272), hardhat use the blockdata to create a new `Block` instance. `Block` instance will use Ethereum formula to calculate the block hash.\r\n- On Avax (and many other chains), they don't follow Ethereum's block hash formula so the calculated hash result will differ from the actual hash from the RPC.\r\n\r\n---\r\n\r\n## Reproduce this: \r\n- `yarn hardhat node --fork https://api.avax-test.network/ext/bc/C/rpc`\r\n- Fetch a random-block information: \r\n```\r\ncurl -X GET \\\r\n  'localhost:8545' \\\r\n  --data-raw '{\r\n  \"method\": \"eth_getBlockByNumber\",\r\n  \"params\": [\r\n    \"0xC5CFC8\",\r\n    false\r\n  ],\r\n  \"jsonrpc\": \"2.0\",\r\n  \"id\": 44\r\n}'\r\n```\r\n- That block is here: https://testnet.snowtrace.io/block/12963784, its hash is `0x454706c3214e4c4c1336dce67b57d608d6feca590a882922b2e0ca440e075bbd` while hardhat is returning `0xbd00f86284b05bf7b69f04a0c3186fc548692d3664f900389487d9199957afbb`\r\n\r\n\r\n---\r\n\r\n## How to fix\r\n- I found a hacky fix is that we can override the `.hash()` function of the block instance, like what i did in [this commit](https://github.com/leduythuccs/hardhat/commit/c281456576335136fd897f49c1babe2708733b9d#diff-3628ae92cd2b1e8992b468bbc78cc7a69a029ad275d377ab46d7cbb21df198acR308 )\r\n\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3170/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3170/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1244982921",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/3170#issuecomment-1244982921",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3170",
    "id": 1244982921,
    "node_id": "IC_kwDOB7jojM5KNO6J",
    "user": {
      "login": "github-actions[bot]",
      "id": 41898282,
      "node_id": "MDM6Qm90NDE4OTgyODI=",
      "avatar_url": "https://avatars.githubusercontent.com/in/15368?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/github-actions%5Bbot%5D",
      "html_url": "https://github.com/apps/github-actions",
      "followers_url": "https://api.github.com/users/github-actions%5Bbot%5D/followers",
      "following_url": "https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}",
      "gists_url": "https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/github-actions%5Bbot%5D/subscriptions",
      "organizations_url": "https://api.github.com/users/github-actions%5Bbot%5D/orgs",
      "repos_url": "https://api.github.com/users/github-actions%5Bbot%5D/repos",
      "events_url": "https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}",
      "received_events_url": "https://api.github.com/users/github-actions%5Bbot%5D/received_events",
      "type": "Bot",
      "site_admin": false
    },
    "created_at": "2022-09-13T06:59:19Z",
    "updated_at": "2022-09-13T06:59:19Z",
    "author_association": "CONTRIBUTOR",
    "body": "This issue is also being [tracked on Linear](https://linear.app/nomic-foundation/issue/HH-1168/in-correct-block-hash-when-forking-other-evm-chains).\n\nWe use Linear to manage our development process, but we keep the conversations on Github.\n\nLINEAR-ID: 16b29507-4f6d-4de8-8804-d6ea49d712f4",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1244982921/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1244987140",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/3170#issuecomment-1244987140",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3170",
    "id": 1244987140,
    "node_id": "IC_kwDOB7jojM5KNP8E",
    "user": {
      "login": "leduythuccs",
      "id": 23715841,
      "node_id": "MDQ6VXNlcjIzNzE1ODQx",
      "avatar_url": "https://avatars.githubusercontent.com/u/23715841?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/leduythuccs",
      "html_url": "https://github.com/leduythuccs",
      "followers_url": "https://api.github.com/users/leduythuccs/followers",
      "following_url": "https://api.github.com/users/leduythuccs/following{/other_user}",
      "gists_url": "https://api.github.com/users/leduythuccs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/leduythuccs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/leduythuccs/subscriptions",
      "organizations_url": "https://api.github.com/users/leduythuccs/orgs",
      "repos_url": "https://api.github.com/users/leduythuccs/repos",
      "events_url": "https://api.github.com/users/leduythuccs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/leduythuccs/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-13T07:04:01Z",
    "updated_at": "2022-09-13T07:04:01Z",
    "author_association": "NONE",
    "body": "This issue is not a problem for most of the users tho. I only realized this when trying to run a subgraph with a local hardhat fork. Subgraph verifies the block hash in order to detect re-org. ",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1244987140/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1252925792",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/3170#issuecomment-1252925792",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3170",
    "id": 1252925792,
    "node_id": "IC_kwDOB7jojM5KriFg",
    "user": {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-20T21:20:45Z",
    "updated_at": "2022-09-20T21:20:45Z",
    "author_association": "MEMBER",
    "body": "Hi @leduythuccs, thanks for reporting this.\r\n\r\nThis is a hard one because ethereumjs doesn't provide any way to set the hash. Monkey-patching is always an option, of course, but I don't think the risk is justified in this case. In any case, we really don't want to have that unnecessary hash computation (we should just use whatever the remote node returned).",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1252925792/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
