{
  "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3090",
  "repository_url": "https://api.github.com/repos/NomicFoundation/hardhat",
  "labels_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3090/labels{/name}",
  "comments_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3090/comments",
  "events_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3090/events",
  "html_url": "https://github.com/NomicFoundation/hardhat/issues/3090",
  "id": 1353359004,
  "node_id": "I_kwDOB7jojM5Qqp6c",
  "number": 3090,
  "title": "In-process hardhat node's block number increases when a ethers contract call fails and an out-of-process one doesn't",
  "user": {
    "login": "ouoabcde",
    "id": 17924874,
    "node_id": "MDQ6VXNlcjE3OTI0ODc0",
    "avatar_url": "https://avatars.githubusercontent.com/u/17924874?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ouoabcde",
    "html_url": "https://github.com/ouoabcde",
    "followers_url": "https://api.github.com/users/ouoabcde/followers",
    "following_url": "https://api.github.com/users/ouoabcde/following{/other_user}",
    "gists_url": "https://api.github.com/users/ouoabcde/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ouoabcde/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ouoabcde/subscriptions",
    "organizations_url": "https://api.github.com/users/ouoabcde/orgs",
    "repos_url": "https://api.github.com/users/ouoabcde/repos",
    "events_url": "https://api.github.com/users/ouoabcde/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ouoabcde/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 4937718880,
      "node_id": "LA_kwDOB7jojM8AAAABJk-cYA",
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/labels/type:improvement",
      "name": "type:improvement",
      "color": "FBCA04",
      "default": false,
      "description": ""
    },
    {
      "id": 4937720577,
      "node_id": "LA_kwDOB7jojM8AAAABJk-jAQ",
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/labels/status:ready",
      "name": "status:ready",
      "color": "0E8A16",
      "default": false,
      "description": "This issue is ready to be worked on"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 6,
  "created_at": "2022-08-28T13:48:10Z",
  "updated_at": "2023-01-03T09:16:37Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "<!--\r\n\r\nThank you for using Hardhat and taking the time to open an issue!\r\n\r\n**Note that this issue tracker is not a support channel.**\r\n\r\n- For help with Hardhat and Hardhat network, please use our [Discord server](https://hardhat.org/discord).\r\n- For help with ethers.js, please go to [its Github Discussions](https://github.com/ethers-io/ethers.js/discussions).\r\n\r\nIf you are reporting a bug, please include reproduction steps. The best way to do this is to include a [Minimal Reproducible Example](https://stackoverflow.com/help/minimal-reproducible-example). If you can't do that, then include a link to your repo, and the steps to reproduce the problem. The easiest it is to reproduce your problem, the faster we are going to be able to fix it.\r\n\r\nIf you are submitting a feature request, please take the time to clearly describe your use case, and not only your proposed solution.\r\n\r\nThis issue will be automatically assigned to a Hardhat team member. This person will act as the point of contact between you and the team, but won't necessarily fix it nor address it in any way. An issue being assigned does not mean that it's being worked on.\r\n\r\n-->\r\nWhen the function is expected to revert in test code, the built-in hardhat node still increases it's block number. But if I use the local hardhat node which is ran by `npx hardhat node`, it's revert check passes well and not increases it's block number. Here is the test code format I used.\r\n\r\n```\r\nrequire(\"@nomicfoundation/hardhat-chai-matchers\");\r\nconst { expect } = require(\"chai\");\r\n\r\n...\r\n\r\nit(\"Should revert at some condition\", async () => {\r\n    let currentBlockNumber = await ethers.provider.getBlockNumber();\r\n    console.log(`current block number: ${currentBlockNumber}`); // 1\r\n\r\n    await expect(contract.someFunction({ reverting option })).to.be.revertedWith(\"revert message\");\r\n\r\n    currentBlockNumber = await ethers.provider.getBlockNumber();\r\n    console.log(`current block number: ${currentBlockNumber}`); // 2 when using built-in hardhat node (wrong), 1 when using 'npx hardhat node' (right)\r\n});\r\n```\r\n\r\nAnd here's the package versions I used.\r\n\r\n```\r\n\"devDependencies\": {\r\n  \"@ethersproject/abi\": \"^5.6.4\",\r\n  \"@ethersproject/providers\": \"^5.6.8\",\r\n  \"@nomicfoundation/hardhat-chai-matchers\": \"^1.0.2\",\r\n  \"@nomicfoundation/hardhat-network-helpers\": \"^1.0.3\",\r\n  \"@nomicfoundation/hardhat-toolbox\": \"^1.0.2\",\r\n  \"@nomiclabs/hardhat-ethers\": \"^2.1.0\",\r\n  \"@nomiclabs/hardhat-etherscan\": \"^3.1.0\",\r\n  \"@typechain/ethers-v5\": \"^10.1.0\",\r\n  \"@typechain/hardhat\": \"^6.1.2\",\r\n  \"chai\": \"^4.3.6\",\r\n  \"ethers\": \"^5.6.9\",\r\n  \"hardhat\": \"^2.10.1\",\r\n  \"hardhat-gas-reporter\": \"^1.0.8\",\r\n  \"solidity-coverage\": \"^0.7.21\",\r\n  \"typechain\": \"^8.1.0\"\r\n}\r\n```",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3090/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3090/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1229460929",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/3090#issuecomment-1229460929",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3090",
    "id": 1229460929,
    "node_id": "IC_kwDOB7jojM5JSBXB",
    "user": {
      "login": "github-actions[bot]",
      "id": 41898282,
      "node_id": "MDM6Qm90NDE4OTgyODI=",
      "avatar_url": "https://avatars.githubusercontent.com/in/15368?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/github-actions%5Bbot%5D",
      "html_url": "https://github.com/apps/github-actions",
      "followers_url": "https://api.github.com/users/github-actions%5Bbot%5D/followers",
      "following_url": "https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}",
      "gists_url": "https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/github-actions%5Bbot%5D/subscriptions",
      "organizations_url": "https://api.github.com/users/github-actions%5Bbot%5D/orgs",
      "repos_url": "https://api.github.com/users/github-actions%5Bbot%5D/repos",
      "events_url": "https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}",
      "received_events_url": "https://api.github.com/users/github-actions%5Bbot%5D/received_events",
      "type": "Bot",
      "site_admin": false
    },
    "created_at": "2022-08-28T13:48:34Z",
    "updated_at": "2022-08-28T13:48:34Z",
    "author_association": "CONTRIBUTOR",
    "body": "This issue is also being [tracked on Linear](https://linear.app/nomic-foundation/issue/HH-1101/built-in-hardhat-nodes-block-number-increases-when-its-expected-to).\n\nWe use Linear to manage our development process, but we keep the conversations on Github.\n\nLINEAR-ID: 885a619d-70fe-4345-9131-51826e6a74d4",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1229460929/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1229461911",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/3090#issuecomment-1229461911",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3090",
    "id": 1229461911,
    "node_id": "IC_kwDOB7jojM5JSBmX",
    "user": {
      "login": "alcuadrado",
      "id": 176499,
      "node_id": "MDQ6VXNlcjE3NjQ5OQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/176499?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alcuadrado",
      "html_url": "https://github.com/alcuadrado",
      "followers_url": "https://api.github.com/users/alcuadrado/followers",
      "following_url": "https://api.github.com/users/alcuadrado/following{/other_user}",
      "gists_url": "https://api.github.com/users/alcuadrado/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alcuadrado/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alcuadrado/subscriptions",
      "organizations_url": "https://api.github.com/users/alcuadrado/orgs",
      "repos_url": "https://api.github.com/users/alcuadrado/repos",
      "events_url": "https://api.github.com/users/alcuadrado/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alcuadrado/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-28T13:52:13Z",
    "updated_at": "2022-08-28T13:52:38Z",
    "author_association": "MEMBER",
    "body": "Thanks for reporting this. I changed the title so it's more descriptive. Let me know if it's wrong.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1229461911/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1229462159",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/3090#issuecomment-1229462159",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3090",
    "id": 1229462159,
    "node_id": "IC_kwDOB7jojM5JSBqP",
    "user": {
      "login": "alcuadrado",
      "id": 176499,
      "node_id": "MDQ6VXNlcjE3NjQ5OQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/176499?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alcuadrado",
      "html_url": "https://github.com/alcuadrado",
      "followers_url": "https://api.github.com/users/alcuadrado/followers",
      "following_url": "https://api.github.com/users/alcuadrado/following{/other_user}",
      "gists_url": "https://api.github.com/users/alcuadrado/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alcuadrado/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alcuadrado/subscriptions",
      "organizations_url": "https://api.github.com/users/alcuadrado/orgs",
      "repos_url": "https://api.github.com/users/alcuadrado/repos",
      "events_url": "https://api.github.com/users/alcuadrado/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alcuadrado/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-28T13:53:02Z",
    "updated_at": "2022-08-28T13:53:02Z",
    "author_association": "MEMBER",
    "body": "The ideal scenario should be that in both situations a block is created.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1229462159/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1229464350",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/3090#issuecomment-1229464350",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3090",
    "id": 1229464350,
    "node_id": "IC_kwDOB7jojM5JSCMe",
    "user": {
      "login": "ouoabcde",
      "id": 17924874,
      "node_id": "MDQ6VXNlcjE3OTI0ODc0",
      "avatar_url": "https://avatars.githubusercontent.com/u/17924874?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ouoabcde",
      "html_url": "https://github.com/ouoabcde",
      "followers_url": "https://api.github.com/users/ouoabcde/followers",
      "following_url": "https://api.github.com/users/ouoabcde/following{/other_user}",
      "gists_url": "https://api.github.com/users/ouoabcde/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ouoabcde/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ouoabcde/subscriptions",
      "organizations_url": "https://api.github.com/users/ouoabcde/orgs",
      "repos_url": "https://api.github.com/users/ouoabcde/repos",
      "events_url": "https://api.github.com/users/ouoabcde/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ouoabcde/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-28T14:01:09Z",
    "updated_at": "2022-08-28T14:01:09Z",
    "author_association": "NONE",
    "body": "@alcuadrado Yes the title seems correct. And the ideal scenario should be that in both situations, a block should not be created, because it's reverting transaction.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1229464350/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1230111846",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/3090#issuecomment-1230111846",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3090",
    "id": 1230111846,
    "node_id": "IC_kwDOB7jojM5JUgRm",
    "user": {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-29T10:42:32Z",
    "updated_at": "2022-08-29T10:42:32Z",
    "author_association": "MEMBER",
    "body": "@ouoabcde reverted transactions are also mined, and therefore create new blocks.\r\n\r\nThe reason for the different behaviors here is that when you use `npx hardhat node`, ethers performs an `estimateGas` call and, when that fails, it doesn't send the transaction at all.\r\n\r\nIn the in-process network there's no `estimateGas` call done and so the transactions is sent and mined (and reverts).\r\n\r\nI do agree that having different behaviors is not ideal though.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1230111846/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1230443785",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/3090#issuecomment-1230443785",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3090",
    "id": 1230443785,
    "node_id": "IC_kwDOB7jojM5JVxUJ",
    "user": {
      "login": "ouoabcde",
      "id": 17924874,
      "node_id": "MDQ6VXNlcjE3OTI0ODc0",
      "avatar_url": "https://avatars.githubusercontent.com/u/17924874?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ouoabcde",
      "html_url": "https://github.com/ouoabcde",
      "followers_url": "https://api.github.com/users/ouoabcde/followers",
      "following_url": "https://api.github.com/users/ouoabcde/following{/other_user}",
      "gists_url": "https://api.github.com/users/ouoabcde/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ouoabcde/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ouoabcde/subscriptions",
      "organizations_url": "https://api.github.com/users/ouoabcde/orgs",
      "repos_url": "https://api.github.com/users/ouoabcde/repos",
      "events_url": "https://api.github.com/users/ouoabcde/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ouoabcde/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-29T15:06:53Z",
    "updated_at": "2022-08-29T16:18:59Z",
    "author_association": "NONE",
    "body": "@fvictorio Got it! Yeah, it seems that their behaviors should be unified. For reference, when I used other test environments like Remix and Truffle, Remix increased the block number when reverted, and Truffle didn't.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1230443785/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
