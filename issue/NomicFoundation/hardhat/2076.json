{
  "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2076",
  "repository_url": "https://api.github.com/repos/NomicFoundation/hardhat",
  "labels_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2076/labels{/name}",
  "comments_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2076/comments",
  "events_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2076/events",
  "html_url": "https://github.com/NomicFoundation/hardhat/issues/2076",
  "id": 1057613214,
  "node_id": "I_kwDOB7jojM4_CeWe",
  "number": 2076,
  "title": "Hardhat test command poor performance when there are large number of tests",
  "user": {
    "login": "Siegrift",
    "id": 22679154,
    "node_id": "MDQ6VXNlcjIyNjc5MTU0",
    "avatar_url": "https://avatars.githubusercontent.com/u/22679154?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Siegrift",
    "html_url": "https://github.com/Siegrift",
    "followers_url": "https://api.github.com/users/Siegrift/followers",
    "following_url": "https://api.github.com/users/Siegrift/following{/other_user}",
    "gists_url": "https://api.github.com/users/Siegrift/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Siegrift/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Siegrift/subscriptions",
    "organizations_url": "https://api.github.com/users/Siegrift/orgs",
    "repos_url": "https://api.github.com/users/Siegrift/repos",
    "events_url": "https://api.github.com/users/Siegrift/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Siegrift/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": true,
  "assignee": {
    "login": "alcuadrado",
    "id": 176499,
    "node_id": "MDQ6VXNlcjE3NjQ5OQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/176499?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/alcuadrado",
    "html_url": "https://github.com/alcuadrado",
    "followers_url": "https://api.github.com/users/alcuadrado/followers",
    "following_url": "https://api.github.com/users/alcuadrado/following{/other_user}",
    "gists_url": "https://api.github.com/users/alcuadrado/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/alcuadrado/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/alcuadrado/subscriptions",
    "organizations_url": "https://api.github.com/users/alcuadrado/orgs",
    "repos_url": "https://api.github.com/users/alcuadrado/repos",
    "events_url": "https://api.github.com/users/alcuadrado/events{/privacy}",
    "received_events_url": "https://api.github.com/users/alcuadrado/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "alcuadrado",
      "id": 176499,
      "node_id": "MDQ6VXNlcjE3NjQ5OQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/176499?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alcuadrado",
      "html_url": "https://github.com/alcuadrado",
      "followers_url": "https://api.github.com/users/alcuadrado/followers",
      "following_url": "https://api.github.com/users/alcuadrado/following{/other_user}",
      "gists_url": "https://api.github.com/users/alcuadrado/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alcuadrado/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alcuadrado/subscriptions",
      "organizations_url": "https://api.github.com/users/alcuadrado/orgs",
      "repos_url": "https://api.github.com/users/alcuadrado/repos",
      "events_url": "https://api.github.com/users/alcuadrado/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alcuadrado/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 7,
  "created_at": "2021-11-18T17:26:43Z",
  "updated_at": "2022-11-18T10:08:19Z",
  "closed_at": "2022-01-03T21:08:47Z",
  "author_association": "NONE",
  "active_lock_reason": "resolved",
  "body": "Hi,\r\n\r\non our project (https://github.com/api3dao/airnode) hardhat tests run way too slowly (nearly ~30 minutes, see screenshot).\r\nI've figured out that the performance penalty is due to large number of test files. I am not sure what causes this performance penalty but my fix for now is to run `hardhat test` with each test file separately.\r\n\r\n![image](https://user-images.githubusercontent.com/22679154/142464992-b6ee48a0-3a35-469f-8bac-4bd9f8b90a52.png)\r\n\r\nThis penalty also happens if I run only a subset of tests (using `.only`)\r\n\r\n## To reproduce\r\n\r\nYou can take a look at our project in the protocol tests - https://github.com/api3dao/airnode/tree/master/packages/airnode-protocol/test and run `hardhat test` there. But I think this is reproducible just by creating a large number of test files.\r\n\r\n## Versions\r\n\r\n\"hardhat\": \"^2.6.0\",",
  "closed_by": {
    "login": "alcuadrado",
    "id": 176499,
    "node_id": "MDQ6VXNlcjE3NjQ5OQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/176499?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/alcuadrado",
    "html_url": "https://github.com/alcuadrado",
    "followers_url": "https://api.github.com/users/alcuadrado/followers",
    "following_url": "https://api.github.com/users/alcuadrado/following{/other_user}",
    "gists_url": "https://api.github.com/users/alcuadrado/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/alcuadrado/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/alcuadrado/subscriptions",
    "organizations_url": "https://api.github.com/users/alcuadrado/orgs",
    "repos_url": "https://api.github.com/users/alcuadrado/repos",
    "events_url": "https://api.github.com/users/alcuadrado/events{/privacy}",
    "received_events_url": "https://api.github.com/users/alcuadrado/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2076/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2076/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/983684909",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/2076#issuecomment-983684909",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2076",
    "id": 983684909,
    "node_id": "IC_kwDOB7jojM46odct",
    "user": {
      "login": "alcuadrado",
      "id": 176499,
      "node_id": "MDQ6VXNlcjE3NjQ5OQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/176499?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alcuadrado",
      "html_url": "https://github.com/alcuadrado",
      "followers_url": "https://api.github.com/users/alcuadrado/followers",
      "following_url": "https://api.github.com/users/alcuadrado/following{/other_user}",
      "gists_url": "https://api.github.com/users/alcuadrado/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alcuadrado/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alcuadrado/subscriptions",
      "organizations_url": "https://api.github.com/users/alcuadrado/orgs",
      "repos_url": "https://api.github.com/users/alcuadrado/repos",
      "events_url": "https://api.github.com/users/alcuadrado/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alcuadrado/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-12-01T14:16:32Z",
    "updated_at": "2021-12-01T14:16:32Z",
    "author_association": "MEMBER",
    "body": "Thanks for submitting this issue, @Siegrift \r\n\r\nYour description makes me think that this is unrelated to Hardhat, and more to mocha.\r\n\r\nI only see a few test files in the project you linked. Have you modified the codebase lately? Can you link us to a commit instead?\r\n\r\nThanks",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/983684909/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/983797768",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/2076#issuecomment-983797768",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2076",
    "id": 983797768,
    "node_id": "IC_kwDOB7jojM46o5AI",
    "user": {
      "login": "Siegrift",
      "id": 22679154,
      "node_id": "MDQ6VXNlcjIyNjc5MTU0",
      "avatar_url": "https://avatars.githubusercontent.com/u/22679154?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Siegrift",
      "html_url": "https://github.com/Siegrift",
      "followers_url": "https://api.github.com/users/Siegrift/followers",
      "following_url": "https://api.github.com/users/Siegrift/following{/other_user}",
      "gists_url": "https://api.github.com/users/Siegrift/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Siegrift/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Siegrift/subscriptions",
      "organizations_url": "https://api.github.com/users/Siegrift/orgs",
      "repos_url": "https://api.github.com/users/Siegrift/repos",
      "events_url": "https://api.github.com/users/Siegrift/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Siegrift/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-12-01T16:12:29Z",
    "updated_at": "2021-12-01T16:12:29Z",
    "author_association": "NONE",
    "body": "Yeah, sorry that was a poor link from me.\r\n\r\nThese are the tests: https://github.com/api3dao/airnode/tree/master/packages/airnode-protocol/test\r\nThis is the script I have implemented to reduce the execution speed: https://github.com/api3dao/airnode/blob/master/packages/airnode-protocol/scripts/run-hardhat-tests.ts\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/983797768/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/983804726",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/2076#issuecomment-983804726",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2076",
    "id": 983804726,
    "node_id": "IC_kwDOB7jojM46o6s2",
    "user": {
      "login": "alcuadrado",
      "id": 176499,
      "node_id": "MDQ6VXNlcjE3NjQ5OQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/176499?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alcuadrado",
      "html_url": "https://github.com/alcuadrado",
      "followers_url": "https://api.github.com/users/alcuadrado/followers",
      "following_url": "https://api.github.com/users/alcuadrado/following{/other_user}",
      "gists_url": "https://api.github.com/users/alcuadrado/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alcuadrado/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alcuadrado/subscriptions",
      "organizations_url": "https://api.github.com/users/alcuadrado/orgs",
      "repos_url": "https://api.github.com/users/alcuadrado/repos",
      "events_url": "https://api.github.com/users/alcuadrado/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alcuadrado/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-12-01T16:19:54Z",
    "updated_at": "2021-12-01T16:19:54Z",
    "author_association": "MEMBER",
    "body": "But I only see ~15 test files there, is that the number you had in mind? ",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/983804726/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/983821777",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/2076#issuecomment-983821777",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2076",
    "id": 983821777,
    "node_id": "IC_kwDOB7jojM46o-3R",
    "user": {
      "login": "Siegrift",
      "id": 22679154,
      "node_id": "MDQ6VXNlcjIyNjc5MTU0",
      "avatar_url": "https://avatars.githubusercontent.com/u/22679154?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Siegrift",
      "html_url": "https://github.com/Siegrift",
      "followers_url": "https://api.github.com/users/Siegrift/followers",
      "following_url": "https://api.github.com/users/Siegrift/following{/other_user}",
      "gists_url": "https://api.github.com/users/Siegrift/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Siegrift/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Siegrift/subscriptions",
      "organizations_url": "https://api.github.com/users/Siegrift/orgs",
      "repos_url": "https://api.github.com/users/Siegrift/repos",
      "events_url": "https://api.github.com/users/Siegrift/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Siegrift/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-12-01T16:39:11Z",
    "updated_at": "2021-12-01T16:39:11Z",
    "author_association": "NONE",
    "body": "Yeah, but the actualy number of tests is rather large. For example, take a look at https://github.com/api3dao/airnode/blob/master/packages/airnode-protocol/test/rrp/AirnodeRrp.sol.js\r\n\r\nWhen the tests are run using `hardhat test` they take around 27 minutes (as in the screenshot) and it seems that the bottleneck is just the number of tests, because when I test file by file (using the linked script) the execution is 9 minutes (see screenshot from current master).\r\n\r\n![image](https://user-images.githubusercontent.com/22679154/144275200-6949a674-a546-40a6-95aa-9d316d874e8b.png)\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/983821777/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1004314320",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/2076#issuecomment-1004314320",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2076",
    "id": 1004314320,
    "node_id": "IC_kwDOB7jojM473J7Q",
    "user": {
      "login": "alcuadrado",
      "id": 176499,
      "node_id": "MDQ6VXNlcjE3NjQ5OQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/176499?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alcuadrado",
      "html_url": "https://github.com/alcuadrado",
      "followers_url": "https://api.github.com/users/alcuadrado/followers",
      "following_url": "https://api.github.com/users/alcuadrado/following{/other_user}",
      "gists_url": "https://api.github.com/users/alcuadrado/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alcuadrado/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alcuadrado/subscriptions",
      "organizations_url": "https://api.github.com/users/alcuadrado/orgs",
      "repos_url": "https://api.github.com/users/alcuadrado/repos",
      "events_url": "https://api.github.com/users/alcuadrado/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alcuadrado/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-01-03T19:42:36Z",
    "updated_at": "2022-01-03T19:42:36Z",
    "author_association": "MEMBER",
    "body": "@Siegrift I think one reason this is happening is that you are defining top-level `beforeEach`s in each file. Mocha calls these [root-level hooks](https://mochajs.org/#root-level-hooks) and are now discouraged.\r\n\r\nroot-level hooks are not scoped to the file where they are declared, but global. This means that you are running every top-level `beforeEach` for every test. When you run a single file, the unrelated `beforeEach`s are never registered.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1004314320/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1004335853",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/2076#issuecomment-1004335853",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2076",
    "id": 1004335853,
    "node_id": "IC_kwDOB7jojM473PLt",
    "user": {
      "login": "Siegrift",
      "id": 22679154,
      "node_id": "MDQ6VXNlcjIyNjc5MTU0",
      "avatar_url": "https://avatars.githubusercontent.com/u/22679154?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Siegrift",
      "html_url": "https://github.com/Siegrift",
      "followers_url": "https://api.github.com/users/Siegrift/followers",
      "following_url": "https://api.github.com/users/Siegrift/following{/other_user}",
      "gists_url": "https://api.github.com/users/Siegrift/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Siegrift/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Siegrift/subscriptions",
      "organizations_url": "https://api.github.com/users/Siegrift/orgs",
      "repos_url": "https://api.github.com/users/Siegrift/repos",
      "events_url": "https://api.github.com/users/Siegrift/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Siegrift/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-01-03T20:21:15Z",
    "updated_at": "2022-01-03T20:21:15Z",
    "author_association": "NONE",
    "body": "Thanks, I didn't know about this behaviour but it makes sense.\r\n\r\nAn easy way is to not use these root level hooks and make sure the tests are wrapped inside a `describe` statement.\r\nIs there a better way? (This seems like it's very easy to forget about)",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1004335853/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1004359978",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/2076#issuecomment-1004359978",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2076",
    "id": 1004359978,
    "node_id": "IC_kwDOB7jojM473VEq",
    "user": {
      "login": "alcuadrado",
      "id": 176499,
      "node_id": "MDQ6VXNlcjE3NjQ5OQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/176499?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alcuadrado",
      "html_url": "https://github.com/alcuadrado",
      "followers_url": "https://api.github.com/users/alcuadrado/followers",
      "following_url": "https://api.github.com/users/alcuadrado/following{/other_user}",
      "gists_url": "https://api.github.com/users/alcuadrado/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alcuadrado/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alcuadrado/subscriptions",
      "organizations_url": "https://api.github.com/users/alcuadrado/orgs",
      "repos_url": "https://api.github.com/users/alcuadrado/repos",
      "events_url": "https://api.github.com/users/alcuadrado/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alcuadrado/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-01-03T21:08:47Z",
    "updated_at": "2022-01-03T21:08:47Z",
    "author_association": "MEMBER",
    "body": "I don't think there's a better alternative. IMO you should always place things inside a describe/context. \r\n\r\nMaybe you can add a linter rule to forbid top-level before each calls.\r\n\r\nI'm closing this issue as I couldn't find any other reason for the slow down. Feel free to open a new one if you find something else.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1004359978/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
