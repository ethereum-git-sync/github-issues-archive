{
  "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/4151",
  "repository_url": "https://api.github.com/repos/NomicFoundation/hardhat",
  "labels_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/4151/labels{/name}",
  "comments_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/4151/comments",
  "events_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/4151/events",
  "html_url": "https://github.com/NomicFoundation/hardhat/issues/4151",
  "id": 1805173366,
  "node_id": "I_kwDOB7jojM5rmMJ2",
  "number": 4151,
  "title": "Improve experience of mixing hardhat_reset and fixtures",
  "user": {
    "login": "fvictorio",
    "id": 417134,
    "node_id": "MDQ6VXNlcjQxNzEzNA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/fvictorio",
    "html_url": "https://github.com/fvictorio",
    "followers_url": "https://api.github.com/users/fvictorio/followers",
    "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
    "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
    "organizations_url": "https://api.github.com/users/fvictorio/orgs",
    "repos_url": "https://api.github.com/users/fvictorio/repos",
    "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
    "received_events_url": "https://api.github.com/users/fvictorio/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 4937718880,
      "node_id": "LA_kwDOB7jojM8AAAABJk-cYA",
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/labels/type:improvement",
      "name": "type:improvement",
      "color": "FBCA04",
      "default": false,
      "description": ""
    },
    {
      "id": 4937720577,
      "node_id": "LA_kwDOB7jojM8AAAABJk-jAQ",
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/labels/status:ready",
      "name": "status:ready",
      "color": "0E8A16",
      "default": false,
      "description": "This issue is ready to be worked on"
    },
    {
      "id": 4952057568,
      "node_id": "LA_kwDOB7jojM8AAAABJypm4A",
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/labels/area:network-helpers",
      "name": "area:network-helpers",
      "color": "5319E7",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2023-07-14T16:50:11Z",
  "updated_at": "2023-12-12T18:45:50Z",
  "closed_at": null,
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "If you use fixtures and `hardhat_reset`, you will likely run into an error like:\r\n\r\n```\r\nFixtureSnapshotError: There was an error reverting the snapshot of the fixture.\r\n\r\nThis might be caused by using nested loadFixture calls in a test, for example by using multiple beforeEach calls. This is not supported yet.\r\n```\r\n\r\nThat message is misleading, and also a lie: we support nested loadFixture calls now.\r\n\r\nTwo things to do here:\r\n- Update that error message\r\n- Check if there's an easy way to detect that there was a reset and act accordingly (just clear the fixtures array in that case I guess?)",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/4151/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/4151/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1646676797",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/4151#issuecomment-1646676797",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/4151",
    "id": 1646676797,
    "node_id": "IC_kwDOB7jojM5iJks9",
    "user": {
      "login": "zdenham",
      "id": 16373521,
      "node_id": "MDQ6VXNlcjE2MzczNTIx",
      "avatar_url": "https://avatars.githubusercontent.com/u/16373521?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/zdenham",
      "html_url": "https://github.com/zdenham",
      "followers_url": "https://api.github.com/users/zdenham/followers",
      "following_url": "https://api.github.com/users/zdenham/following{/other_user}",
      "gists_url": "https://api.github.com/users/zdenham/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/zdenham/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/zdenham/subscriptions",
      "organizations_url": "https://api.github.com/users/zdenham/orgs",
      "repos_url": "https://api.github.com/users/zdenham/repos",
      "events_url": "https://api.github.com/users/zdenham/events{/privacy}",
      "received_events_url": "https://api.github.com/users/zdenham/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-22T21:42:24Z",
    "updated_at": "2023-07-22T22:33:28Z",
    "author_association": "NONE",
    "body": "I'm also seeing this issue with fixtures + `hardhat_reset` on _any_ test, our workaround was to run this test which required rest without fixtures (and separately from the rest of our tests with fixtures).",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1646676797/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1654673571",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/4151#issuecomment-1654673571",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/4151",
    "id": 1654673571,
    "node_id": "IC_kwDOB7jojM5ioFCj",
    "user": {
      "login": "Saty248",
      "id": 68778874,
      "node_id": "MDQ6VXNlcjY4Nzc4ODc0",
      "avatar_url": "https://avatars.githubusercontent.com/u/68778874?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Saty248",
      "html_url": "https://github.com/Saty248",
      "followers_url": "https://api.github.com/users/Saty248/followers",
      "following_url": "https://api.github.com/users/Saty248/following{/other_user}",
      "gists_url": "https://api.github.com/users/Saty248/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Saty248/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Saty248/subscriptions",
      "organizations_url": "https://api.github.com/users/Saty248/orgs",
      "repos_url": "https://api.github.com/users/Saty248/repos",
      "events_url": "https://api.github.com/users/Saty248/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Saty248/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-27T22:39:23Z",
    "updated_at": "2023-07-27T22:39:23Z",
    "author_association": "CONTRIBUTOR",
    "body": "hi @fvictorio ,am working on this issue.. \r\n\r\n1. first of all ,in my pr, am changing the the error message to \r\n\r\nThere was an error reverting the snapshot of the fixture.\r\n\r\nThis might be caused by using hardhat_reset and loadFixture calls in a testcase.  \r\n\r\n2. what we also can do is, when hardhat_reset is called, we create a function at the loadFixtures which sets the fixtures array to empty.\r\n\r\nany thoughts about this idea?",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1654673571/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1852612674",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/4151#issuecomment-1852612674",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/4151",
    "id": 1852612674,
    "node_id": "IC_kwDOB7jojM5ubKBC",
    "user": {
      "login": "julianmrodri",
      "id": 56316686,
      "node_id": "MDQ6VXNlcjU2MzE2Njg2",
      "avatar_url": "https://avatars.githubusercontent.com/u/56316686?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/julianmrodri",
      "html_url": "https://github.com/julianmrodri",
      "followers_url": "https://api.github.com/users/julianmrodri/followers",
      "following_url": "https://api.github.com/users/julianmrodri/following{/other_user}",
      "gists_url": "https://api.github.com/users/julianmrodri/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/julianmrodri/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/julianmrodri/subscriptions",
      "organizations_url": "https://api.github.com/users/julianmrodri/orgs",
      "repos_url": "https://api.github.com/users/julianmrodri/repos",
      "events_url": "https://api.github.com/users/julianmrodri/events{/privacy}",
      "received_events_url": "https://api.github.com/users/julianmrodri/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-12-12T18:45:19Z",
    "updated_at": "2023-12-12T18:45:50Z",
    "author_association": "NONE",
    "body": "I think Im facing this issue! \r\n\r\nWhat is strange in my case is that i works locally but not in CI. When the test runs in Github actions I get: What could be the reason Im only seeing the error in CI?  Is there a workaround? \r\n\r\nI do not have nested beforeEach, but I do a network reset and then a beforeEach that deploys a lot of contracts, and performs impersonation, etc.\r\n\r\n``` \r\n FixtureSnapshotError: There was an error reverting the snapshot of the fixture.\r\n\r\nThis might be caused by using nested loadFixture calls in a test, for example by using multiple beforeEach calls. This is not supported yet.\r\n      at loadFixture (/home/runner/work/protocol/protocol/node_modules/@nomicfoundation/hardhat-network-helpers/src/loadFixture.ts:51:15)\r\n      at runMicrotasks (<anonymous>)\r\n      at processTicksAndRejections (node:internal/process/task_queues:96:5)\r\n      at runNextTicks (node:internal/process/task_queues:65:3)\r\n      at processImmediate (node:internal/timers:437:9)\r\n      at async Context.<anonymous> (/home/runner/work/protocol/protocol/test/integration/FacadeMonitorNew.test.ts:159:9)\r\n  \r\n      Caused by: InvalidSnapshotError: Trying to restore an invalid snapshot.\r\n          at Object.restore (/home/runner/work/protocol/protocol/node_modules/@nomicfoundation/hardhat-network-helpers/src/helpers/takeSnapshot.ts:46:15)\r\n          at runMicrotasks (<anonymous>)\r\n          at processTicksAndRejections (node:internal/process/task_queues:96:5)\r\n          at runNextTicks (node:internal/process/task_queues:65:3)\r\n          at processImmediate (node:internal/timers:437:9)\r\n          at async loadFixture (/home/runner/work/protocol/protocol/node_modules/@nomicfoundation/hardhat-network-helpers/src/loadFixture.ts:44:7)\r\n  ...\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1852612674/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
