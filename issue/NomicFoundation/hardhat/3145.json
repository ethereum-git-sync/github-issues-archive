{
  "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3145",
  "repository_url": "https://api.github.com/repos/NomicFoundation/hardhat",
  "labels_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3145/labels{/name}",
  "comments_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3145/comments",
  "events_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3145/events",
  "html_url": "https://github.com/NomicFoundation/hardhat/issues/3145",
  "id": 1364352050,
  "node_id": "I_kwDOB7jojM5RUlwy",
  "number": 3145,
  "title": "hardhat gas behaviour differs from geth",
  "user": {
    "login": "wighawag",
    "id": 790580,
    "node_id": "MDQ6VXNlcjc5MDU4MA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/790580?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/wighawag",
    "html_url": "https://github.com/wighawag",
    "followers_url": "https://api.github.com/users/wighawag/followers",
    "following_url": "https://api.github.com/users/wighawag/following{/other_user}",
    "gists_url": "https://api.github.com/users/wighawag/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/wighawag/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/wighawag/subscriptions",
    "organizations_url": "https://api.github.com/users/wighawag/orgs",
    "repos_url": "https://api.github.com/users/wighawag/repos",
    "events_url": "https://api.github.com/users/wighawag/events{/privacy}",
    "received_events_url": "https://api.github.com/users/wighawag/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": true,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2022-09-07T09:15:10Z",
  "updated_at": "2023-03-28T00:15:45Z",
  "closed_at": "2022-12-27T18:22:46Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": "resolved",
  "body": "I was testing out a bug in solidity and found out that hardhat has a different gas behaviour that prevent me from testing the behaviour with hardhat\r\n\r\nReproduction repo has more details\r\nhttps://github.com/bug-reproduction/solidity-assembly-variable-reset\r\n\r\nbut basically with that code \r\n\r\n\r\n```solidity\r\n// SPDX-License-Identifier: AGPL-1.0\r\npragma solidity 0.8.16;\r\n\r\ncontract Test {\r\n\tevent Debug(address deployedContract);\r\n\r\n\tfunction deployData(bytes calldata) external {\r\n\t\taddress newContract;\r\n\t\tassembly {\r\n\t\t\tlet len := calldataload(36)\r\n\t\t\tlet p := mload(0x40)\r\n\t\t\tmstore(p, 0x61FFFF600E60003961FFFF6000F3000000000000000000000000000000000000)\r\n\t\t\tlet lenByte1 := shr(8, len)\r\n\t\t\tlet lenByte2 := and(len, 0xFF)\r\n\t\t\tmstore8(add(p, 1), lenByte1)\r\n\t\t\tmstore8(add(p, 2), lenByte2)\r\n\t\t\tmstore8(add(p, 9), lenByte1)\r\n\t\t\tmstore8(add(p, 10), lenByte2)\r\n\t\t\tcalldatacopy(add(p, 14), 68, len)\r\n\r\n\t\t\tnewContract := create(0, p, add(len, 14))\r\n\t\t\tlog1(p, add(len, 14), newContract) // need this line, no idea why, looks like some memory management issues\r\n\t\t}\r\n\t\temit Debug(newContract);\r\n\t}\r\n\r\n}\r\n\r\n```\r\n\r\nIf I execute deployData with an input of 24000 bytes, hardhat always fails while geth works",
  "closed_by": {
    "login": "fvictorio",
    "id": 417134,
    "node_id": "MDQ6VXNlcjQxNzEzNA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/fvictorio",
    "html_url": "https://github.com/fvictorio",
    "followers_url": "https://api.github.com/users/fvictorio/followers",
    "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
    "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
    "organizations_url": "https://api.github.com/users/fvictorio/orgs",
    "repos_url": "https://api.github.com/users/fvictorio/repos",
    "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
    "received_events_url": "https://api.github.com/users/fvictorio/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3145/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3145/timeline",
  "performed_via_github_app": null,
  "state_reason": "not_planned"
}
[
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1239127471",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/3145#issuecomment-1239127471",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3145",
    "id": 1239127471,
    "node_id": "IC_kwDOB7jojM5J25Wv",
    "user": {
      "login": "github-actions[bot]",
      "id": 41898282,
      "node_id": "MDM6Qm90NDE4OTgyODI=",
      "avatar_url": "https://avatars.githubusercontent.com/in/15368?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/github-actions%5Bbot%5D",
      "html_url": "https://github.com/apps/github-actions",
      "followers_url": "https://api.github.com/users/github-actions%5Bbot%5D/followers",
      "following_url": "https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}",
      "gists_url": "https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/github-actions%5Bbot%5D/subscriptions",
      "organizations_url": "https://api.github.com/users/github-actions%5Bbot%5D/orgs",
      "repos_url": "https://api.github.com/users/github-actions%5Bbot%5D/repos",
      "events_url": "https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}",
      "received_events_url": "https://api.github.com/users/github-actions%5Bbot%5D/received_events",
      "type": "Bot",
      "site_admin": false
    },
    "created_at": "2022-09-07T09:15:29Z",
    "updated_at": "2022-09-07T09:15:29Z",
    "author_association": "CONTRIBUTOR",
    "body": "This issue is also being [tracked on Linear](https://linear.app/nomic-foundation/issue/HH-1147/hardhat-gas-behaviour-differs-from-geth-[nomicfoundationhardhat3145]).\n\nWe use Linear to manage our development process, but we keep the conversations on Github.\n\nLINEAR-ID: 05681fc6-70c0-42c0-b7bc-0011b916227b",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1239127471/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1239634179",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/3145#issuecomment-1239634179",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3145",
    "id": 1239634179,
    "node_id": "IC_kwDOB7jojM5J41ED",
    "user": {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-07T16:42:23Z",
    "updated_at": "2022-09-07T16:42:23Z",
    "author_association": "MEMBER",
    "body": "Thank you Ronan, I'll take a look asap.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1239634179/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1241740929",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/3145#issuecomment-1241740929",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3145",
    "id": 1241740929,
    "node_id": "IC_kwDOB7jojM5KA3aB",
    "user": {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-09T09:35:09Z",
    "updated_at": "2022-09-09T09:35:09Z",
    "author_association": "MEMBER",
    "body": "Ok, I found what's going on here.\r\n\r\nWhen you use the in-process hardhat network, we automatically use the block gas limit as the gas limit for all transactions. This makes execution faster, because no `estimateGas` is needed (which is slow).\r\n\r\nTo accomplish that behavior in ethers, we add a `gas` property to all the fragments in the `ContractFactory`. The problem is that ethers then [adds](https://github.com/ethers-io/ethers.js/blob/ec1b9583039a14a0e0fa15d0a2a6082a2f41cf5b/packages/contracts/src.ts/index.ts#L249-L262) the intrinsic cost of the tx to that gas value. So we subtract [one million](https://github.com/NomicFoundation/hardhat/blob/dbf7c0b33001ebca01ac3737e8599ef251cf0de7/packages/hardhat-ethers/src/internal/helpers.ts#L382-L387) to the block gas limit, asssuming no tx will have a intrinsic cost greater than that.\r\n\r\nBut guess what? Your transaction in that test has an intrinsic cost that is bigger than one million :sweat_smile:\r\n\r\nThe easiest workaround here is to disable that behavior in the hardhat network:\r\n\r\n```\r\nnetworks: {\r\n  hardhat: {\r\n    gas: \"auto\"\r\n```\r\n\r\nThat will use `estimateGas` for all transactions, and you should get the same behavior as in geth.\r\n\r\nAlternatively, you can add an explicit gas limit to the transactions that have a huge call data.\r\n\r\nObviously that's just a workaround, we need to figure out a proper solution somehow. But in the meantime, I hope that helps you as a temporary solution.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1241740929/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1241783110",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/3145#issuecomment-1241783110",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3145",
    "id": 1241783110,
    "node_id": "IC_kwDOB7jojM5KBBtG",
    "user": {
      "login": "wighawag",
      "id": 790580,
      "node_id": "MDQ6VXNlcjc5MDU4MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/790580?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/wighawag",
      "html_url": "https://github.com/wighawag",
      "followers_url": "https://api.github.com/users/wighawag/followers",
      "following_url": "https://api.github.com/users/wighawag/following{/other_user}",
      "gists_url": "https://api.github.com/users/wighawag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/wighawag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/wighawag/subscriptions",
      "organizations_url": "https://api.github.com/users/wighawag/orgs",
      "repos_url": "https://api.github.com/users/wighawag/repos",
      "events_url": "https://api.github.com/users/wighawag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/wighawag/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-09T10:16:00Z",
    "updated_at": "2022-09-09T10:16:00Z",
    "author_association": "CONTRIBUTOR",
    "body": "Thanks @fvictorio ! it works ",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1241783110/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1366091428",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/3145#issuecomment-1366091428",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3145",
    "id": 1366091428,
    "node_id": "IC_kwDOB7jojM5RbOak",
    "user": {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-27T18:22:46Z",
    "updated_at": "2022-12-27T18:22:46Z",
    "author_association": "MEMBER",
    "body": "Closing this in favor of #3469.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1366091428/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
