{
  "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2126",
  "repository_url": "https://api.github.com/repos/NomicFoundation/hardhat",
  "labels_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2126/labels{/name}",
  "comments_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2126/comments",
  "events_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2126/events",
  "html_url": "https://github.com/NomicFoundation/hardhat/issues/2126",
  "id": 1070756207,
  "node_id": "I_kwDOB7jojM4_0nFv",
  "number": 2126,
  "title": "Different behaviour in Hardhat forked mode than on mainnet",
  "user": {
    "login": "Bobface",
    "id": 10945014,
    "node_id": "MDQ6VXNlcjEwOTQ1MDE0",
    "avatar_url": "https://avatars.githubusercontent.com/u/10945014?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Bobface",
    "html_url": "https://github.com/Bobface",
    "followers_url": "https://api.github.com/users/Bobface/followers",
    "following_url": "https://api.github.com/users/Bobface/following{/other_user}",
    "gists_url": "https://api.github.com/users/Bobface/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Bobface/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Bobface/subscriptions",
    "organizations_url": "https://api.github.com/users/Bobface/orgs",
    "repos_url": "https://api.github.com/users/Bobface/repos",
    "events_url": "https://api.github.com/users/Bobface/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Bobface/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": true,
  "assignee": {
    "login": "alcuadrado",
    "id": 176499,
    "node_id": "MDQ6VXNlcjE3NjQ5OQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/176499?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/alcuadrado",
    "html_url": "https://github.com/alcuadrado",
    "followers_url": "https://api.github.com/users/alcuadrado/followers",
    "following_url": "https://api.github.com/users/alcuadrado/following{/other_user}",
    "gists_url": "https://api.github.com/users/alcuadrado/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/alcuadrado/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/alcuadrado/subscriptions",
    "organizations_url": "https://api.github.com/users/alcuadrado/orgs",
    "repos_url": "https://api.github.com/users/alcuadrado/repos",
    "events_url": "https://api.github.com/users/alcuadrado/events{/privacy}",
    "received_events_url": "https://api.github.com/users/alcuadrado/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "alcuadrado",
      "id": 176499,
      "node_id": "MDQ6VXNlcjE3NjQ5OQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/176499?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alcuadrado",
      "html_url": "https://github.com/alcuadrado",
      "followers_url": "https://api.github.com/users/alcuadrado/followers",
      "following_url": "https://api.github.com/users/alcuadrado/following{/other_user}",
      "gists_url": "https://api.github.com/users/alcuadrado/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alcuadrado/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alcuadrado/subscriptions",
      "organizations_url": "https://api.github.com/users/alcuadrado/orgs",
      "repos_url": "https://api.github.com/users/alcuadrado/repos",
      "events_url": "https://api.github.com/users/alcuadrado/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alcuadrado/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 9,
  "created_at": "2021-12-03T16:24:59Z",
  "updated_at": "2022-11-18T00:17:30Z",
  "closed_at": "2022-07-01T09:34:20Z",
  "author_association": "NONE",
  "active_lock_reason": "resolved",
  "body": "There seems to be a bug in Hardhat's forked mode where a `call` is sometimes not executed when its return value is not used. At least that is my best guess for what's happening. I've created a repo to reproduce this bug here:\r\n\r\nhttps://github.com/Bobface/hardhat-bug-report\r\n\r\nIt creates a small contract `Bug.sol` which just transfers 1 `WETH` to the `msg.sender` when it is called. When you run the unit test as described in the README, it succeeds. Interestingly however, comment-out the 20th line in `Bug.sol` (`revert(0, 0)` -> `//revert(0, 0)`) and you will see that when you run it again the unit test fails and the tokens did not get transferred, even though the `call` must have succeeded as we saw in the previous run.",
  "closed_by": {
    "login": "github-actions[bot]",
    "id": 41898282,
    "node_id": "MDM6Qm90NDE4OTgyODI=",
    "avatar_url": "https://avatars.githubusercontent.com/in/15368?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/github-actions%5Bbot%5D",
    "html_url": "https://github.com/apps/github-actions",
    "followers_url": "https://api.github.com/users/github-actions%5Bbot%5D/followers",
    "following_url": "https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}",
    "gists_url": "https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/github-actions%5Bbot%5D/subscriptions",
    "organizations_url": "https://api.github.com/users/github-actions%5Bbot%5D/orgs",
    "repos_url": "https://api.github.com/users/github-actions%5Bbot%5D/repos",
    "events_url": "https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}",
    "received_events_url": "https://api.github.com/users/github-actions%5Bbot%5D/received_events",
    "type": "Bot",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2126/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2126/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1136133420",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/2126#issuecomment-1136133420",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2126",
    "id": 1136133420,
    "node_id": "IC_kwDOB7jojM5DuAUs",
    "user": {
      "login": "Bobface",
      "id": 10945014,
      "node_id": "MDQ6VXNlcjEwOTQ1MDE0",
      "avatar_url": "https://avatars.githubusercontent.com/u/10945014?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Bobface",
      "html_url": "https://github.com/Bobface",
      "followers_url": "https://api.github.com/users/Bobface/followers",
      "following_url": "https://api.github.com/users/Bobface/following{/other_user}",
      "gists_url": "https://api.github.com/users/Bobface/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Bobface/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Bobface/subscriptions",
      "organizations_url": "https://api.github.com/users/Bobface/orgs",
      "repos_url": "https://api.github.com/users/Bobface/repos",
      "events_url": "https://api.github.com/users/Bobface/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Bobface/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-24T16:19:57Z",
    "updated_at": "2022-05-24T16:19:57Z",
    "author_association": "NONE",
    "body": "Just hit this bug again, would be great if someone could look into this. Let me know if you need more info!",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1136133420/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1136150995",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/2126#issuecomment-1136150995",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2126",
    "id": 1136150995,
    "node_id": "IC_kwDOB7jojM5DuEnT",
    "user": {
      "login": "alcuadrado",
      "id": 176499,
      "node_id": "MDQ6VXNlcjE3NjQ5OQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/176499?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alcuadrado",
      "html_url": "https://github.com/alcuadrado",
      "followers_url": "https://api.github.com/users/alcuadrado/followers",
      "following_url": "https://api.github.com/users/alcuadrado/following{/other_user}",
      "gists_url": "https://api.github.com/users/alcuadrado/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alcuadrado/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alcuadrado/subscriptions",
      "organizations_url": "https://api.github.com/users/alcuadrado/orgs",
      "repos_url": "https://api.github.com/users/alcuadrado/repos",
      "events_url": "https://api.github.com/users/alcuadrado/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alcuadrado/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-24T16:37:37Z",
    "updated_at": "2022-05-24T16:37:51Z",
    "author_association": "MEMBER",
    "body": "Are you sure this doesn't work the same in mainnet? It looks more like a bug in solidity than in Hardhat.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1136150995/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1136166638",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/2126#issuecomment-1136166638",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2126",
    "id": 1136166638,
    "node_id": "IC_kwDOB7jojM5DuIbu",
    "user": {
      "login": "Bobface",
      "id": 10945014,
      "node_id": "MDQ6VXNlcjEwOTQ1MDE0",
      "avatar_url": "https://avatars.githubusercontent.com/u/10945014?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Bobface",
      "html_url": "https://github.com/Bobface",
      "followers_url": "https://api.github.com/users/Bobface/followers",
      "following_url": "https://api.github.com/users/Bobface/following{/other_user}",
      "gists_url": "https://api.github.com/users/Bobface/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Bobface/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Bobface/subscriptions",
      "organizations_url": "https://api.github.com/users/Bobface/orgs",
      "repos_url": "https://api.github.com/users/Bobface/repos",
      "events_url": "https://api.github.com/users/Bobface/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Bobface/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-24T16:48:39Z",
    "updated_at": "2022-05-24T16:50:57Z",
    "author_association": "NONE",
    "body": "Yes, I'm pretty sure this is not normal mainnet behaviour, since it would mean that when I make a `CALL` to another contract, state changes made in that other contract during the `CALL`  (e.g. `SSTORE`s) will only be commited if I do something with the success value pushed onto the stack after the `CALL` is completed. \r\n\r\nMy best guess regarding the potential cause for this: In forked mode, Hardhat does not detect the external contract as \"touched\" after the transaction is complete *if I didn't use the success value*,  thus does not store the updated state locally, and subsequent read-only calls to it, such as `balanceOf`, will get passed through to the RPC which of course has the real chain state where nothing changed. \r\n\r\nEDIT: I don't think it's a bug in Solidity, I tried it both with Solidity's inline assembly and even raw, handwritten assembly without any Solidity. Same thing happens in both cases, but the `CALL` definitely get's executed, since the gas is consumed. ",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1136166638/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1136240956",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/2126#issuecomment-1136240956",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2126",
    "id": 1136240956,
    "node_id": "IC_kwDOB7jojM5Duak8",
    "user": {
      "login": "alcuadrado",
      "id": 176499,
      "node_id": "MDQ6VXNlcjE3NjQ5OQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/176499?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alcuadrado",
      "html_url": "https://github.com/alcuadrado",
      "followers_url": "https://api.github.com/users/alcuadrado/followers",
      "following_url": "https://api.github.com/users/alcuadrado/following{/other_user}",
      "gists_url": "https://api.github.com/users/alcuadrado/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alcuadrado/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alcuadrado/subscriptions",
      "organizations_url": "https://api.github.com/users/alcuadrado/orgs",
      "repos_url": "https://api.github.com/users/alcuadrado/repos",
      "events_url": "https://api.github.com/users/alcuadrado/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alcuadrado/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-24T17:30:06Z",
    "updated_at": "2022-05-24T17:30:06Z",
    "author_association": "MEMBER",
    "body": "The same behavior is present without forking, using WETH9 with the same compiler version and settings as the mainnet deployment.\r\n\r\nUpdated hardhat config:\r\n\r\n```ts\r\nimport \"@nomiclabs/hardhat-waffle\";\r\n\r\n/**\r\n * @type import('hardhat/config').HardhatUserConfig\r\n */\r\nmodule.exports = {\r\n  solidity: {\r\n    compilers: [\r\n      {\r\n        version: \"0.8.4\",\r\n      },\r\n      {\r\n        version: \"0.4.19\",\r\n      },\r\n    ],\r\n  },\r\n  networks: {\r\n    hardhat: {\r\n      loggingEnabled: true,\r\n    },\r\n  },\r\n};\r\n```\r\n\r\nUpdated test:\r\n```ts\r\nconst { BigNumber } = require(\"ethers\");\r\nconst { ethers, network, artifacts } = require(\"hardhat\");\r\nconst { expect } = require(\"chai\");\r\n\r\ndescribe(\"Bug\", () => {\r\n  it(\"Bug\", async () => {\r\n    const LocalWeth = await ethers.getContractFactory(\"WETH9\");\r\n    const localWeth = await LocalWeth.deploy();\r\n\r\n    const WETH_ADDRESS = localWeth.address;\r\n    await localWeth.deposit({ value: ethers.utils.parseEther(\"100.0\") });\r\n    const [richWETHSigner] = await ethers.getSigners();\r\n\r\n    // Deploy the bug contract\r\n    const factory = await ethers.getContractFactory(\"Bug\");\r\n    const bug = await factory.connect(richWETHSigner).deploy();\r\n\r\n    // Send 1 WETH to the buggy contract\r\n    const IERC20 = await artifacts.readArtifact(\"IERC20\");\r\n    const weth = new ethers.Contract(WETH_ADDRESS, IERC20.abi, richWETHSigner);\r\n    await weth\r\n      .connect(richWETHSigner)\r\n      .transfer(bug.address, ethers.utils.parseEther(\"1.0\"));\r\n\r\n    console.log(await weth.balanceOf(bug.address));\r\n\r\n    // Call the buggy contract\r\n    await richWETHSigner.sendTransaction({\r\n      to: bug.address,\r\n    });\r\n\r\n    console.log(await weth.balanceOf(bug.address));\r\n\r\n    // Get the WETH balance of the buggy contract after the call\r\n    // It should be zero\r\n    const balanceBefore = await weth.balanceOf(bug.address);\r\n    expect(balanceBefore.toString()).to.equal(\"0\");\r\n  });\r\n});\r\n```\r\n\r\nWeth.sol: https://etherscan.io/address/0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2#code\r\n\r\nThis may be a bug in ethereumjs. I'll dig deeper soon.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1136240956/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1136278882",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/2126#issuecomment-1136278882",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2126",
    "id": 1136278882,
    "node_id": "IC_kwDOB7jojM5Duj1i",
    "user": {
      "login": "Bobface",
      "id": 10945014,
      "node_id": "MDQ6VXNlcjEwOTQ1MDE0",
      "avatar_url": "https://avatars.githubusercontent.com/u/10945014?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Bobface",
      "html_url": "https://github.com/Bobface",
      "followers_url": "https://api.github.com/users/Bobface/followers",
      "following_url": "https://api.github.com/users/Bobface/following{/other_user}",
      "gists_url": "https://api.github.com/users/Bobface/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Bobface/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Bobface/subscriptions",
      "organizations_url": "https://api.github.com/users/Bobface/orgs",
      "repos_url": "https://api.github.com/users/Bobface/repos",
      "events_url": "https://api.github.com/users/Bobface/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Bobface/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-24T18:09:44Z",
    "updated_at": "2022-05-24T18:09:44Z",
    "author_association": "NONE",
    "body": "Interesting that it also happens in non-forked mode. Thanks for having a look!",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1136278882/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1136283071",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/2126#issuecomment-1136283071",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2126",
    "id": 1136283071,
    "node_id": "IC_kwDOB7jojM5Duk2_",
    "user": {
      "login": "alcuadrado",
      "id": 176499,
      "node_id": "MDQ6VXNlcjE3NjQ5OQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/176499?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alcuadrado",
      "html_url": "https://github.com/alcuadrado",
      "followers_url": "https://api.github.com/users/alcuadrado/followers",
      "following_url": "https://api.github.com/users/alcuadrado/following{/other_user}",
      "gists_url": "https://api.github.com/users/alcuadrado/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alcuadrado/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alcuadrado/subscriptions",
      "organizations_url": "https://api.github.com/users/alcuadrado/orgs",
      "repos_url": "https://api.github.com/users/alcuadrado/repos",
      "events_url": "https://api.github.com/users/alcuadrado/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alcuadrado/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-24T18:14:10Z",
    "updated_at": "2022-05-24T18:14:10Z",
    "author_association": "MEMBER",
    "body": "Surprisingly, the test also fails with the `revert(0,0)` without forking.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1136283071/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1136920187",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/2126#issuecomment-1136920187",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2126",
    "id": 1136920187,
    "node_id": "IC_kwDOB7jojM5DxAZ7",
    "user": {
      "login": "Bobface",
      "id": 10945014,
      "node_id": "MDQ6VXNlcjEwOTQ1MDE0",
      "avatar_url": "https://avatars.githubusercontent.com/u/10945014?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Bobface",
      "html_url": "https://github.com/Bobface",
      "followers_url": "https://api.github.com/users/Bobface/followers",
      "following_url": "https://api.github.com/users/Bobface/following{/other_user}",
      "gists_url": "https://api.github.com/users/Bobface/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Bobface/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Bobface/subscriptions",
      "organizations_url": "https://api.github.com/users/Bobface/orgs",
      "repos_url": "https://api.github.com/users/Bobface/repos",
      "events_url": "https://api.github.com/users/Bobface/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Bobface/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-25T08:02:14Z",
    "updated_at": "2022-05-25T08:02:14Z",
    "author_association": "NONE",
    "body": "> Surprisingly, the test also fails with the `revert(0,0)` without forking.\r\n\r\nThere is a small issue with the updated test above, in that the mainnet WETH9 address is hardcoded into the `Bug` contract. Try this setup (with your updated Hardhat config) in non forked mode. It sends the address of the WETH9 contract in the calldata:\r\n\r\n*Bug.sol*:\r\n```\r\npragma solidity 0.8.4;\r\n\r\ncontract Bug {\r\n    fallback() external {\r\n        assembly {\r\n            // Read the WETH address from calldata\r\n            let weth := shr(0x60, calldataload(0x0))\r\n            // Load the pointer to free memory\r\n            let free_mem_ptr := mload(0x40)\r\n            // Store the function signature for transfer(address,uint256)\r\n            mstore(free_mem_ptr, 0xa9059cbb00000000000000000000000000000000000000000000000000000000)\r\n            // Store the address of the recipient, msg.sender\r\n            mstore(add(free_mem_ptr, 0x4), caller())\r\n            // Store the amount of WETH to send, 10^18\r\n            mstore(add(free_mem_ptr, 0x24), 1000000000000000000)\r\n            // Execute the transfer function on the WETH contract \r\n            // with msg.sender as the recipient and \r\n            // 10^18 as the amount of WETH to send\r\n            let r := call(gas(), weth, 0x0, free_mem_ptr, 0x44, 0x0, 0x0)\r\n            // Check whether the call succeeded\r\n            if eq(r, 0x0) {\r\n                revert(0, 0)\r\n            }\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n*Test*:\r\n```\r\nconst { BigNumber } = require(\"ethers\");\r\nconst { ethers, network, artifacts } = require(\"hardhat\");\r\nconst { expect } = require(\"chai\");\r\n\r\ndescribe(\"Bug\", () => {\r\n  it(\"Bug\", async () => {\r\n    const LocalWeth = await ethers.getContractFactory(\"WETH9\");\r\n    const localWeth = await LocalWeth.deploy();\r\n\r\n    const WETH_ADDRESS = localWeth.address;\r\n    await localWeth.deposit({ value: ethers.utils.parseEther(\"100.0\") });\r\n    const [richWETHSigner] = await ethers.getSigners();\r\n\r\n    // Deploy the bug contract\r\n    const factory = await ethers.getContractFactory(\"Bug\");\r\n    const bug = await factory.connect(richWETHSigner).deploy();\r\n\r\n    // Send 1 WETH to the buggy contract\r\n    const IERC20 = await artifacts.readArtifact(\"IERC20\");\r\n    const weth = new ethers.Contract(WETH_ADDRESS, IERC20.abi, richWETHSigner);\r\n    await weth\r\n      .connect(richWETHSigner)\r\n      .transfer(bug.address, ethers.utils.parseEther(\"1.0\"));\r\n\r\n    console.log(await weth.balanceOf(bug.address));\r\n\r\n    // Call the buggy contract\r\n    await richWETHSigner.sendTransaction({\r\n      to: bug.address,\r\n      data: WETH_ADDRESS\r\n    });\r\n    console.log(await weth.balanceOf(bug.address));\r\n\r\n    // Get the WETH balance of the buggy contract after the call\r\n    // It should be zero\r\n    const balanceBefore = await weth.balanceOf(bug.address);\r\n    expect(balanceBefore.toString()).to.equal(\"0\");\r\n  });\r\n});\r\n```\r\n\r\nFor me this results in the same behaviour as in forking: With the `revert(0,0)` the test passes. Without it, it fails. \r\n\r\nOn a side note I also saw that the logs which are emitted by the WETH9 contract are missing in the transaction receipt when the `revert(0,0)` is commented out. Maybe that helps a bit with finding the root cause for this. \r\n",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1136920187/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1165342335",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/2126#issuecomment-1165342335",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2126",
    "id": 1165342335,
    "node_id": "IC_kwDOB7jojM5FdbZ_",
    "user": {
      "login": "github-actions[bot]",
      "id": 41898282,
      "node_id": "MDM6Qm90NDE4OTgyODI=",
      "avatar_url": "https://avatars.githubusercontent.com/in/15368?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/github-actions%5Bbot%5D",
      "html_url": "https://github.com/apps/github-actions",
      "followers_url": "https://api.github.com/users/github-actions%5Bbot%5D/followers",
      "following_url": "https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}",
      "gists_url": "https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/github-actions%5Bbot%5D/subscriptions",
      "organizations_url": "https://api.github.com/users/github-actions%5Bbot%5D/orgs",
      "repos_url": "https://api.github.com/users/github-actions%5Bbot%5D/repos",
      "events_url": "https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}",
      "received_events_url": "https://api.github.com/users/github-actions%5Bbot%5D/received_events",
      "type": "Bot",
      "site_admin": false
    },
    "created_at": "2022-06-24T08:38:23Z",
    "updated_at": "2022-06-24T08:38:23Z",
    "author_association": "CONTRIBUTOR",
    "body": "This issue was marked as stale because it didn't have any activity in the last 30 days. If you think it's still relevant, please leave a comment indicating so. Otherwise, it will be closed in 7 days.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1165342335/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1172146127",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/2126#issuecomment-1172146127",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2126",
    "id": 1172146127,
    "node_id": "IC_kwDOB7jojM5F3YfP",
    "user": {
      "login": "github-actions[bot]",
      "id": 41898282,
      "node_id": "MDM6Qm90NDE4OTgyODI=",
      "avatar_url": "https://avatars.githubusercontent.com/in/15368?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/github-actions%5Bbot%5D",
      "html_url": "https://github.com/apps/github-actions",
      "followers_url": "https://api.github.com/users/github-actions%5Bbot%5D/followers",
      "following_url": "https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}",
      "gists_url": "https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/github-actions%5Bbot%5D/subscriptions",
      "organizations_url": "https://api.github.com/users/github-actions%5Bbot%5D/orgs",
      "repos_url": "https://api.github.com/users/github-actions%5Bbot%5D/repos",
      "events_url": "https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}",
      "received_events_url": "https://api.github.com/users/github-actions%5Bbot%5D/received_events",
      "type": "Bot",
      "site_admin": false
    },
    "created_at": "2022-07-01T09:34:19Z",
    "updated_at": "2022-07-01T09:34:19Z",
    "author_association": "CONTRIBUTOR",
    "body": "This issue was closed because it has been stalled for 7 days with no activity.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1172146127/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
