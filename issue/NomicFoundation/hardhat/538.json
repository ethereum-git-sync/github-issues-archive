{
  "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/538",
  "repository_url": "https://api.github.com/repos/NomicFoundation/hardhat",
  "labels_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/538/labels{/name}",
  "comments_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/538/comments",
  "events_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/538/events",
  "html_url": "https://github.com/NomicFoundation/hardhat/issues/538",
  "id": 611209360,
  "node_id": "MDU6SXNzdWU2MTEyMDkzNjA=",
  "number": 538,
  "title": "Compile of imported contracts are duplicated if filename casing doesn't match",
  "user": {
    "login": "tmilar",
    "id": 3988039,
    "node_id": "MDQ6VXNlcjM5ODgwMzk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3988039?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tmilar",
    "html_url": "https://github.com/tmilar",
    "followers_url": "https://api.github.com/users/tmilar/followers",
    "following_url": "https://api.github.com/users/tmilar/following{/other_user}",
    "gists_url": "https://api.github.com/users/tmilar/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tmilar/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tmilar/subscriptions",
    "organizations_url": "https://api.github.com/users/tmilar/orgs",
    "repos_url": "https://api.github.com/users/tmilar/repos",
    "events_url": "https://api.github.com/users/tmilar/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tmilar/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 901960538,
      "node_id": "MDU6TGFiZWw5MDE5NjA1Mzg=",
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/labels/type:bug",
      "name": "type:bug",
      "color": "FBCA04",
      "default": false,
      "description": "Something isn't working"
    }
  ],
  "state": "closed",
  "locked": true,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2020-05-02T15:06:41Z",
  "updated_at": "2022-11-18T18:48:32Z",
  "closed_at": "2021-05-18T13:26:03Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": "resolved",
  "body": "When importing a contract file named `MyContract.sol` from `A.sol` like this:\r\n```\r\n// MyContract.sol\r\ncontract MyContract {\r\n}\r\n```\r\n```\r\n// A.sol\r\nimport './mycontract.sol'\r\ncontract A { \r\n}\r\n```\r\nThe `npx buidler compile` task not only does not fail, it also compiles the whole contract file _two times_, apparently one as './mycontract.sol' and the other as './MyContract.sol'.\r\n```\r\nCompiling...\r\nCompiled 3 contracts succesfully\r\n```\r\nNow, when the imported file casing is correct, the file is only compiled 1 time: \r\n```\r\n// A.sol\r\nimport ./MyContract.sol'\r\ncontract A { \r\n}\r\n```\r\n```\r\nCompiling...\r\nCompiled 2 contract succesfully\r\n```\r\nI think when the naming of an imported file doesn't exactly match, it would be expected that the compilation would fail, or at least doesn't do it double the times.\r\n\r\nThe reason I believe it to be duplicated as well, is that when the imported file contains more than one contract defined, they are also duplicated. For example:\r\n```\r\n// MyContract.sol\r\ncontract MyContract1 {\r\n}\r\ncontract MyContract2 {\r\n}\r\ncontract MyContract3 {\r\n}\r\n```\r\n```\r\n// A.sol\r\nimport './mycontract.sol'\r\ncontract A { \r\n}\r\n```\r\nResults in `7 contracts compiled succesfully` instead of the expected 4 when imported properly.\r\n\r\nCurrent environment:\r\nWin10\r\nBuidler v1.3.1\r\nNode v10.16.0",
  "closed_by": {
    "login": "alcuadrado",
    "id": 176499,
    "node_id": "MDQ6VXNlcjE3NjQ5OQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/176499?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/alcuadrado",
    "html_url": "https://github.com/alcuadrado",
    "followers_url": "https://api.github.com/users/alcuadrado/followers",
    "following_url": "https://api.github.com/users/alcuadrado/following{/other_user}",
    "gists_url": "https://api.github.com/users/alcuadrado/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/alcuadrado/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/alcuadrado/subscriptions",
    "organizations_url": "https://api.github.com/users/alcuadrado/orgs",
    "repos_url": "https://api.github.com/users/alcuadrado/repos",
    "events_url": "https://api.github.com/users/alcuadrado/events{/privacy}",
    "received_events_url": "https://api.github.com/users/alcuadrado/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/538/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/538/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/842547919",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/538#issuecomment-842547919",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/538",
    "id": 842547919,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg0MjU0NzkxOQ==",
    "user": {
      "login": "cameel",
      "id": 137030,
      "node_id": "MDQ6VXNlcjEzNzAzMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cameel",
      "html_url": "https://github.com/cameel",
      "followers_url": "https://api.github.com/users/cameel/followers",
      "following_url": "https://api.github.com/users/cameel/following{/other_user}",
      "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
      "organizations_url": "https://api.github.com/users/cameel/orgs",
      "repos_url": "https://api.github.com/users/cameel/repos",
      "events_url": "https://api.github.com/users/cameel/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cameel/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-05-17T18:43:42Z",
    "updated_at": "2021-05-18T10:36:10Z",
    "author_association": "NONE",
    "body": "This looks like a discrepancy between the way compiler tracks files and the way Hardhat finds them on a case-insensitive filesystem.\r\n\r\nFor the compiler file names are always case-sensitive, even if you're on a case-insensitive filesystem. If you have one file that imports `mycontract.sol` and another that imports `MyContract.sol`, the compiler will see it as two different files and compile it twice. After all, the source code does not have to come from actual files - you can just as well provide JSON input where these two keys are associated with completely different source code.\r\n\r\nI think that the issue here is that on a case-insensitive filesystem Hardhat finds `MyContract.sol` on disk when you import `mycontract.sol` and gives it to the compiler under the name `mycontract.sol`. Then it also notices that there's `MyContract.sol` on disk and it's not in the input (it's not equal to `mycontract.sol` after all) so it adds it again.\r\n\r\nIt should not break anything unless you have files with names that differ only with case but then you would not be able to store that project on a case-insensitive FS anyway. It does lead to contracts being compiled unnecessarily though.\r\n\r\nBTW, I'd suggest not relying on the fact that `mycontract.sol` happens to work for you. Please use the exact case your files have on disk. Otherwise your project won't compile if you move it to a case-sensitive FS. This might make it impossible to pass bytecode verification.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/842547919/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/843047206",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/538#issuecomment-843047206",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/538",
    "id": 843047206,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg0MzA0NzIwNg==",
    "user": {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-05-18T10:18:19Z",
    "updated_at": "2021-05-18T10:18:19Z",
    "author_association": "MEMBER",
    "body": "Thanks @tmilar for reporting this and thanks @cameel for the explanation. I agree that Hardhat should fail early in this case.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/843047206/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/843170204",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/538#issuecomment-843170204",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/538",
    "id": 843170204,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg0MzE3MDIwNA==",
    "user": {
      "login": "alcuadrado",
      "id": 176499,
      "node_id": "MDQ6VXNlcjE3NjQ5OQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/176499?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alcuadrado",
      "html_url": "https://github.com/alcuadrado",
      "followers_url": "https://api.github.com/users/alcuadrado/followers",
      "following_url": "https://api.github.com/users/alcuadrado/following{/other_user}",
      "gists_url": "https://api.github.com/users/alcuadrado/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alcuadrado/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alcuadrado/subscriptions",
      "organizations_url": "https://api.github.com/users/alcuadrado/orgs",
      "repos_url": "https://api.github.com/users/alcuadrado/repos",
      "events_url": "https://api.github.com/users/alcuadrado/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alcuadrado/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-05-18T13:26:03Z",
    "updated_at": "2021-05-18T13:26:03Z",
    "author_association": "MEMBER",
    "body": "That's exactly what was going on, @cameel :)\r\n\r\nThis issue was present in Buidler, but not in Hardhat. If you run the example in the original message, you get this error:\r\n\r\n```\r\n% hh compile\r\nError HH409: Trying to import ./mycontract.sol from contracts/A.sol, but it has an incorrect casing.\r\n\r\nFor more info go to https://hardhat.org/HH409 or run Hardhat with --show-stack-traces\r\n```\r\n\r\nThese casing issues may be something you want to mention in the docs, @cameel, as it's really easy to accidentally ignore them. ",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/843170204/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/843184810",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/538#issuecomment-843184810",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/538",
    "id": 843184810,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg0MzE4NDgxMA==",
    "user": {
      "login": "cameel",
      "id": 137030,
      "node_id": "MDQ6VXNlcjEzNzAzMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cameel",
      "html_url": "https://github.com/cameel",
      "followers_url": "https://api.github.com/users/cameel/followers",
      "following_url": "https://api.github.com/users/cameel/following{/other_user}",
      "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
      "organizations_url": "https://api.github.com/users/cameel/orgs",
      "repos_url": "https://api.github.com/users/cameel/repos",
      "events_url": "https://api.github.com/users/cameel/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cameel/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-05-18T13:45:11Z",
    "updated_at": "2021-05-18T13:45:51Z",
    "author_association": "NONE",
    "body": "Great!\r\n\r\n> These casing issues may be something you want to mention in the docs, @cameel, as it's really easy to accidentally ignore them.\r\n\r\nRight and that's not the only gotcha related to paths. I actually have a big docs update in the works that describes how the paths work in the compiler, including tons of examples of weird situations that can bite you: https://github.com/ethereum/solidity/pull/11263. It's already written but it ended up being pretty long so we decided to split it - only a concise description listing all the rules will go into the docs and the text expanding on how they interact creating potentially unintuitive corner cases, including examples of potential problems will be a blog post.\r\n\r\nI do mention there that paths are platform specific, but not this particular detail. I'll add it.\r\n\r\nMy ultimate goal is to also remove some of these gotchas and reduce complexity around paths and imports but this will unfortunately require some breaking changes. For example I think that the compiler should report an error (or at least a warning) if it finds a file with a different case on a case-insensitive filesystem because that's not portable and will bite the user eventually even if it works on his system. If Hardhat is already reporting an error for this then it's all the more reason to change it.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/843184810/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
