{
  "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1186",
  "repository_url": "https://api.github.com/repos/NomicFoundation/hardhat",
  "labels_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1186/labels{/name}",
  "comments_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1186/comments",
  "events_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1186/events",
  "html_url": "https://github.com/NomicFoundation/hardhat/issues/1186",
  "id": 788435530,
  "node_id": "MDU6SXNzdWU3ODg0MzU1MzA=",
  "number": 1186,
  "title": "OOM errors",
  "user": {
    "login": "shark0der",
    "id": 528959,
    "node_id": "MDQ6VXNlcjUyODk1OQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/528959?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/shark0der",
    "html_url": "https://github.com/shark0der",
    "followers_url": "https://api.github.com/users/shark0der/followers",
    "following_url": "https://api.github.com/users/shark0der/following{/other_user}",
    "gists_url": "https://api.github.com/users/shark0der/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/shark0der/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/shark0der/subscriptions",
    "organizations_url": "https://api.github.com/users/shark0der/orgs",
    "repos_url": "https://api.github.com/users/shark0der/repos",
    "events_url": "https://api.github.com/users/shark0der/events{/privacy}",
    "received_events_url": "https://api.github.com/users/shark0der/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 901960538,
      "node_id": "MDU6TGFiZWw5MDE5NjA1Mzg=",
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/labels/type:bug",
      "name": "type:bug",
      "color": "FBCA04",
      "default": false,
      "description": "Something isn't working"
    }
  ],
  "state": "closed",
  "locked": true,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2021-01-18T17:20:34Z",
  "updated_at": "2023-03-24T00:13:45Z",
  "closed_at": "2022-12-23T15:25:57Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": "resolved",
  "body": "### Description\r\n\r\nI am using multiple compiler versions and I started to get OOM errors. The compilation itself works but the OOM error happens after recompiling a single contract and running the tests. After force recompiling - everything works again. The error is tricky to reproduce and I don't yet have a certain way to do it.\r\n\r\nHinted by @alcuadrado I tried passing the `--max-memory` argument which seems to set the `--max-old-space-size` node option but it doesn't work! I've tried using `npx hardhat --max-memory 8192 test` and `node_modules/.bin/hardhat --max-memory 8192 test`, in both cases it crashes. I was able to get it working by setting the environment variable `NODE_OPTIONS=\"--max-old-space-size=4096\"`.\r\n\r\nThe crash itself seems to happen while running the tests. I've put a few console.logs (the stack traces are useless). It reaches the `console.log` that's outside the `describe` (top-level), reaches the callback passed to `describe` but fails to reach the `beforeEach` and `it` callbacks.\r\n\r\nThe contract that I'm editing has `pragma solidity ^0.5.0;` and is compiled with `0.5.17`.\r\nI have not encountered this before hardhat 2.0.7 (but this could totally be a coincidence!).\r\n\r\n### System info\r\n\r\n```\r\n$ node -v\r\nv12.19.0\r\n\r\n$ npm -v\r\n6.14.11\r\n\r\n$ npm ls --depth 0\r\nrepo@1.0.0 /w/contracts-dev\r\n├── @nomiclabs/hardhat-truffle5@2.0.0\r\n├── @nomiclabs/hardhat-web3@2.0.0\r\n├── @openzeppelin/contract-loader@0.6.1\r\n├── @openzeppelin/contracts@2.5.1\r\n├── @openzeppelin/test-helpers@0.5.9\r\n├── @truffle/hdwallet-provider@1.0.42\r\n├── @typechain/truffle-v5@3.0.0\r\n├── @uniswap/v2-core@1.0.1\r\n├── @uniswap/v2-periphery@1.1.0-beta.0\r\n├── bn.js@5.1.2\r\n├── chai@4.2.0\r\n├── decimal.js@10.2.1\r\n├── dotenv@8.2.0\r\n├── eslint@6.8.0\r\n├── eslint-config-semistandard@15.0.1\r\n├── eslint-config-standard@14.1.1\r\n├── eslint-plugin-import@2.22.0\r\n├── eslint-plugin-node@11.1.0\r\n├── eslint-plugin-promise@4.2.1\r\n├── eslint-plugin-standard@4.0.1\r\n├── ethlint@1.2.5\r\n├── hardhat@2.0.7\r\n├── mocha@7.2.0\r\n├── nodemon@2.0.4\r\n├── UNMET PEER DEPENDENCY truffle@^5.0.0\r\n├── truffle-flattener@1.4.4 (github:shark0der/truffle-flattener#3f9f5d9152b122eb2862fe94500c47539b8fd672)\r\n├── ts-generator@0.1.1\r\n├── typechain@4.0.0\r\n└── web3@1.3.0\r\n\r\nnpm ERR! peer dep missing: truffle@^5.0.0, required by @typechain/truffle-v5@3.0.0\r\nnpm ERR! peer dep missing: bn.js@^4.11.0, required by chai-bn@0.2.1\r\nnpm ERR! peer dep missing: @babel/core@^7.0.0-0, required by @babel/plugin-transform-runtime@7.11.0\r\nnpm ERR! peer dep missing: solium@^1.0.0, required by solium-plugin-security@0.1.1\r\nnpm ERR! missing: glob@7.1.2, required by mocha@4.1.0\r\nnpm ERR! missing: glob@7.1.6, required by ts-generator@0.1.1\r\nnpm ERR! peer dep missing: typescript@>=3.7.0, required by ts-essentials@6.0.7\r\n\r\n```\r\n\r\n### Hardhat config\r\n\r\n```\r\nrequire('dotenv').config();\r\nrequire('@nomiclabs/hardhat-web3');\r\nrequire('@nomiclabs/hardhat-truffle5');\r\n\r\nconst { task } = require('hardhat/config');\r\nconst ether = n => `${n}${'0'.repeat(18)}`;\r\n\r\ntask('test', async (_, hre, runSuper) => {\r\n  hre.accounts = await hre.web3.eth.getAccounts();\r\n  const testFiles = _.testFiles.length ? _.testFiles : ['./test/index.js'];\r\n  await runSuper({ testFiles });\r\n});\r\n\r\ntask('typechain', async (_, { config }) => {\r\n\r\n  const { tsGenerator } = require('ts-generator');\r\n  const { TypeChain } = require('typechain/dist/TypeChain');\r\n\r\n  const cwd = process.cwd();\r\n  const rawConfig = {\r\n    files: `${config.paths.artifacts}/!(build-info|hardhat)/**/+([a-zA-Z0-9]).json`,\r\n    outDir: 'types',\r\n    target: 'truffle-v5',\r\n  };\r\n\r\n  await tsGenerator({ cwd }, new TypeChain({ cwd, rawConfig }));\r\n});\r\n\r\nconst networks = {\r\n  hardhat: {\r\n    accounts: {\r\n      count: 100,\r\n      accountsBalance: ether(10000000),\r\n    },\r\n    allowUnlimitedContractSize: true,\r\n    blockGasLimit: 12e6,\r\n    gas: 12e6,\r\n  },\r\n  localhost: {\r\n    blockGasLimit: 12e6,\r\n    gas: 12e6,\r\n  },\r\n};\r\n\r\nif (process.env.TEST_ENV_FORK) {\r\n  networks.hardhat.forking = { url: process.env.TEST_ENV_FORK };\r\n}\r\n\r\nfor (const network of ['MAINNET', 'KOVAN']) {\r\n  const url = process.env[`${network}_PROVIDER_URL`];\r\n  const accounts = [process.env[`${network}_ACCOUNT_KEY`]];\r\n  networks[network.toLowerCase()] = { accounts, url };\r\n}\r\n\r\nconst compilerSettings = process.env.ENABLE_OPTIMIZER\r\n  ? { optimizer: { enabled: true, runs: 200 } }\r\n  : {};\r\n\r\nmodule.exports = {\r\n\r\n  mocha: {\r\n    exit: true,\r\n    bail: true,\r\n    recursive: false,\r\n  },\r\n\r\n  networks,\r\n\r\n  solidity: {\r\n    compilers: [\r\n      { version: '0.5.17' }, // main contracts\r\n      { version: '0.5.16' }, // uniswap v2 core\r\n      { version: '0.6.6' }, // uniswap v2 peripherals\r\n    ].map(compiler => ({ ...compiler, settings: compilerSettings })),\r\n    overrides: {\r\n      'contracts/modules/governance/Governance.sol': {\r\n        version: '0.5.7',\r\n        settings: compilerSettings,\r\n      },\r\n    },\r\n  },\r\n};\r\n\r\n```\r\n\r\n### Error\r\n\r\n```\r\n$ node_modules/.bin/hardhat --max-memory 8192 test test/integration/index.js --show-stack-traces\r\ntest file required\r\ndescribe() callback called\r\n\r\n\r\n  INTEGRATION TESTS\r\n\r\n<--- Last few GCs --->\r\n\r\n[54356:0x46d2f20]    15856 ms: Scavenge 2041.1 (2047.8) -> 2041.3 (2048.5) MB, 10.8 / 0.0 ms  (average mu = 0.104, current mu = 0.047) allocation failure \r\n[54356:0x46d2f20]    15865 ms: Scavenge 2041.7 (2048.5) -> 2041.6 (2054.3) MB, 8.2 / 0.0 ms  (average mu = 0.104, current mu = 0.047) allocation failure \r\n[54356:0x46d2f20]    16117 ms: Scavenge 2045.4 (2054.8) -> 2045.8 (2051.5) MB, 10.5 / 0.0 ms  (average mu = 0.104, current mu = 0.047) allocation failure \r\n\r\n\r\n<--- JS stacktrace --->\r\n\r\n==== JS stack trace =========================================\r\n\r\n    0: ExitFrame [pc: 0x1409219]\r\n    1: StubFrame [pc: 0x138ff81]\r\nSecurity context: 0x10c4cb7408d1 <JSObject>\r\n    2: add [0x2db53a2a11e1] [/w/contracts-dev/node_modules/hardhat/internal/hardhat-network/stack-traces/contracts-identifier.js:~25] [pc=0xeb4c51c5b41](this=0x3f6c5e5f0d01 <BytecodeTrie map = 0x29a0a85773e9>,0x1fae9bab4c21 <Bytecode map = 0x29a0a8578929>)\r\n    3: addBytecode [0x2db53a2a1101] [/w/contracts-dev/node_modules/...\r\n\r\nFATAL ERROR: Ineffective mark-compacts near heap limit Allocation failed - JavaScript heap out of memory\r\n 1: 0xa17c40 node::Abort() [node]\r\n 2: 0xa1804c node::OnFatalError(char const*, char const*) [node]\r\n 3: 0xb95a7e v8::Utils::ReportOOMFailure(v8::internal::Isolate*, char const*, bool) [node]\r\n 4: 0xb95df9 v8::internal::V8::FatalProcessOutOfMemory(v8::internal::Isolate*, char const*, bool) [node]\r\n 5: 0xd53075  [node]\r\n 6: 0xd53706 v8::internal::Heap::RecomputeLimits(v8::internal::GarbageCollector) [node]\r\n 7: 0xd5ffc5 v8::internal::Heap::PerformGarbageCollection(v8::internal::GarbageCollector, v8::GCCallbackFlags) [node]\r\n 8: 0xd60e75 v8::internal::Heap::CollectGarbage(v8::internal::AllocationSpace, v8::internal::GarbageCollectionReason, v8::GCCallbackFlags) [node]\r\n 9: 0xd6392c v8::internal::Heap::AllocateRawWithRetryOrFail(int, v8::internal::AllocationType, v8::internal::AllocationOrigin, v8::internal::AllocationAlignment) [node]\r\n10: 0xd2a34b v8::internal::Factory::NewFillerObject(int, bool, v8::internal::AllocationType, v8::internal::AllocationOrigin) [node]\r\n11: 0x106c91e v8::internal::Runtime_AllocateInYoungGeneration(int, unsigned long*, v8::internal::Isolate*) [node]\r\n12: 0x1409219  [node]\r\n[1]    54356 abort (core dumped)  node_modules/.bin/hardhat --max-memory 8192 test test/integration/index.js \r\n```\r\n\r\nTo summarize, there are 2 issues:\r\n1. `--max-memory` flag does not work\r\n2. The artifacts and/or the cache seem to get corrupted and/or cause high memory usage when a single contract is recompiled.\r\n",
  "closed_by": {
    "login": "fvictorio",
    "id": 417134,
    "node_id": "MDQ6VXNlcjQxNzEzNA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/fvictorio",
    "html_url": "https://github.com/fvictorio",
    "followers_url": "https://api.github.com/users/fvictorio/followers",
    "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
    "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
    "organizations_url": "https://api.github.com/users/fvictorio/orgs",
    "repos_url": "https://api.github.com/users/fvictorio/repos",
    "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
    "received_events_url": "https://api.github.com/users/fvictorio/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1186/reactions",
    "total_count": 1,
    "+1": 1,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1186/timeline",
  "performed_via_github_app": null,
  "state_reason": "not_planned"
}
[
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/848694778",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/1186#issuecomment-848694778",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1186",
    "id": 848694778,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg0ODY5NDc3OA==",
    "user": {
      "login": "nishuzumi",
      "id": 13927203,
      "node_id": "MDQ6VXNlcjEzOTI3MjAz",
      "avatar_url": "https://avatars.githubusercontent.com/u/13927203?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nishuzumi",
      "html_url": "https://github.com/nishuzumi",
      "followers_url": "https://api.github.com/users/nishuzumi/followers",
      "following_url": "https://api.github.com/users/nishuzumi/following{/other_user}",
      "gists_url": "https://api.github.com/users/nishuzumi/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nishuzumi/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nishuzumi/subscriptions",
      "organizations_url": "https://api.github.com/users/nishuzumi/orgs",
      "repos_url": "https://api.github.com/users/nishuzumi/repos",
      "events_url": "https://api.github.com/users/nishuzumi/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nishuzumi/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-05-26T11:34:19Z",
    "updated_at": "2021-05-26T11:34:19Z",
    "author_association": "NONE",
    "body": "same issue",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/848694778/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/945197357",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/1186#issuecomment-945197357",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1186",
    "id": 945197357,
    "node_id": "IC_kwDOB7jojM44VpEt",
    "user": {
      "login": "msfeldstein",
      "id": 161135,
      "node_id": "MDQ6VXNlcjE2MTEzNQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/161135?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/msfeldstein",
      "html_url": "https://github.com/msfeldstein",
      "followers_url": "https://api.github.com/users/msfeldstein/followers",
      "following_url": "https://api.github.com/users/msfeldstein/following{/other_user}",
      "gists_url": "https://api.github.com/users/msfeldstein/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/msfeldstein/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/msfeldstein/subscriptions",
      "organizations_url": "https://api.github.com/users/msfeldstein/orgs",
      "repos_url": "https://api.github.com/users/msfeldstein/repos",
      "events_url": "https://api.github.com/users/msfeldstein/events{/privacy}",
      "received_events_url": "https://api.github.com/users/msfeldstein/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-10-17T21:24:35Z",
    "updated_at": "2021-10-17T21:24:35Z",
    "author_association": "NONE",
    "body": "Here's a simple contract that reproes this on a brand new hardhat project\r\nhttps://gist.github.com/msfeldstein/4519c50b5e6b3be902d55868a6a73bda",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/945197357/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/949775535",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/1186#issuecomment-949775535",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1186",
    "id": 949775535,
    "node_id": "IC_kwDOB7jojM44nGyv",
    "user": {
      "login": "alcuadrado",
      "id": 176499,
      "node_id": "MDQ6VXNlcjE3NjQ5OQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/176499?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alcuadrado",
      "html_url": "https://github.com/alcuadrado",
      "followers_url": "https://api.github.com/users/alcuadrado/followers",
      "following_url": "https://api.github.com/users/alcuadrado/following{/other_user}",
      "gists_url": "https://api.github.com/users/alcuadrado/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alcuadrado/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alcuadrado/subscriptions",
      "organizations_url": "https://api.github.com/users/alcuadrado/orgs",
      "repos_url": "https://api.github.com/users/alcuadrado/repos",
      "events_url": "https://api.github.com/users/alcuadrado/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alcuadrado/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-10-22T16:18:26Z",
    "updated_at": "2021-10-22T16:18:26Z",
    "author_association": "MEMBER",
    "body": "Hey, @msfeldstein, can you try again with the latest version of hardhat? We changed a few things that should fix this.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/949775535/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1364042611",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/1186#issuecomment-1364042611",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1186",
    "id": 1364042611,
    "node_id": "IC_kwDOB7jojM5RTaNz",
    "user": {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-23T15:25:57Z",
    "updated_at": "2022-12-23T15:25:57Z",
    "author_association": "MEMBER",
    "body": "Closing in favor of https://github.com/NomicFoundation/hardhat/issues/3458.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1364042611/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
