{
  "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/4190",
  "repository_url": "https://api.github.com/repos/NomicFoundation/hardhat",
  "labels_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/4190/labels{/name}",
  "comments_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/4190/comments",
  "events_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/4190/events",
  "html_url": "https://github.com/NomicFoundation/hardhat/issues/4190",
  "id": 1816351036,
  "node_id": "I_kwDOB7jojM5sQ1E8",
  "number": 4190,
  "title": "HardHat AutoGasManager's fee estimation breaks on low-traffic chains",
  "user": {
    "login": "roberto-bayardo",
    "id": 10271917,
    "node_id": "MDQ6VXNlcjEwMjcxOTE3",
    "avatar_url": "https://avatars.githubusercontent.com/u/10271917?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/roberto-bayardo",
    "html_url": "https://github.com/roberto-bayardo",
    "followers_url": "https://api.github.com/users/roberto-bayardo/followers",
    "following_url": "https://api.github.com/users/roberto-bayardo/following{/other_user}",
    "gists_url": "https://api.github.com/users/roberto-bayardo/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/roberto-bayardo/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/roberto-bayardo/subscriptions",
    "organizations_url": "https://api.github.com/users/roberto-bayardo/orgs",
    "repos_url": "https://api.github.com/users/roberto-bayardo/repos",
    "events_url": "https://api.github.com/users/roberto-bayardo/events{/privacy}",
    "received_events_url": "https://api.github.com/users/roberto-bayardo/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 901960538,
      "node_id": "MDU6TGFiZWw5MDE5NjA1Mzg=",
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/labels/type:bug",
      "name": "type:bug",
      "color": "FBCA04",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 4937720577,
      "node_id": "LA_kwDOB7jojM8AAAABJk-jAQ",
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/labels/status:ready",
      "name": "status:ready",
      "color": "0E8A16",
      "default": false,
      "description": "This issue is ready to be worked on"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": {
    "login": "fvictorio",
    "id": 417134,
    "node_id": "MDQ6VXNlcjQxNzEzNA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/fvictorio",
    "html_url": "https://github.com/fvictorio",
    "followers_url": "https://api.github.com/users/fvictorio/followers",
    "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
    "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
    "organizations_url": "https://api.github.com/users/fvictorio/orgs",
    "repos_url": "https://api.github.com/users/fvictorio/repos",
    "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
    "received_events_url": "https://api.github.com/users/fvictorio/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2023-07-21T20:29:28Z",
  "updated_at": "2023-10-19T15:23:56Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Version of Hardhat\n\n2.17.0\n\n### What happened?\n\nHardhat's `AutomaticGasProvider` seems to use its own algorithm based on eth_FeeHistory to compute maxPriorityFeePerGas and MaxFeePerGas. When the most recent block is empty, the code ends up returning \"0\" for maxPriorityFeePerGas, producing a transaction that will be immediately rejected by almost all node transaction pools with \"transaction underpriced\" errors.\r\n\r\nWe looked into this because of several reports of this error from people who are following the Base contract deployment guide [here](https://docs.base.org/guides/deploy-smart-contracts). I imagine this issue also arises on other development / testnet chains where traffic is low.\r\n\r\nObviously one can work around this by specifying your own gas price in the hardhat user config (we're updating or docs right now to do this), but better for auto-estimation to always work.\r\n\r\nTo that end, one option would be to leverage the eth_maxPriorityFeePerGas RPC method to get the node-computed estimate. These algorithms are already well tuned and more likely to do the right thing than any roll-your-own approach.  A simpler option would be to just hard-code a non-trivial minimum on the value always suggested (e.g. .1 gwei).\n\n### Minimal reproduction steps\n\nUse hardhat to submit a transaction to a low-traffic chain (e.g. a devnet) when configured to use the \"auto\" gas price mode. If the current block is empty the transaction will fail with \"transaction underpriced\".  Some example output containing additional instrumentation demonstrating the failure:\r\n\r\n```\r\nfee history: {\r\n  baseFeePerGas: [ '0x32', '0x32' ],\r\n  gasUsedRatio: [ 0.0015637666666666666 ],\r\n  oldestBlock: '0x17d47a',\r\n  reward: [ [ '0x0' ] ]\r\n}\r\nsuggesteEip1559Values { maxFeePerGas: 63n, maxPriorityFeePerGas: 0n }\r\n\r\nResult: \r\n\r\nProviderError: transaction underpriced\r\n    at HttpProvider.request (/Users/bayardo/tmp/node_modules/hardhat/src/internal/core/providers/http.ts:88:21)\r\n    at processTicksAndRejections (node:internal/process/task_queues:95:5)\r\n    at async HardhatEthersSigner.sendTransaction (/Users/bayardo/tmp/node_modules/@nomicfoundation/hardhat-ethers/src/signers.ts:125:18)\r\n    at async ContractFactory.deploy (/Users/bayardo/tmp/node_modules/ethers/src.ts/contract/factory.ts:112:22)\r\n    at async main (/Users/bayardo/tmp/scripts/deploy.ts:4:15)\r\n```\n\n### Search terms\n\n_No response_",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/4190/reactions",
    "total_count": 2,
    "+1": 2,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/4190/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1651117012",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/4190#issuecomment-1651117012",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/4190",
    "id": 1651117012,
    "node_id": "IC_kwDOB7jojM5iagvU",
    "user": {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-26T07:17:09Z",
    "updated_at": "2023-07-26T07:17:09Z",
    "author_association": "MEMBER",
    "body": "Thank you @roberto-bayardo for the detailed information, we'll look into this.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1651117012/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1654649370",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/4190#issuecomment-1654649370",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/4190",
    "id": 1654649370,
    "node_id": "IC_kwDOB7jojM5in_Ia",
    "user": {
      "login": "Saty248",
      "id": 68778874,
      "node_id": "MDQ6VXNlcjY4Nzc4ODc0",
      "avatar_url": "https://avatars.githubusercontent.com/u/68778874?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Saty248",
      "html_url": "https://github.com/Saty248",
      "followers_url": "https://api.github.com/users/Saty248/followers",
      "following_url": "https://api.github.com/users/Saty248/following{/other_user}",
      "gists_url": "https://api.github.com/users/Saty248/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Saty248/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Saty248/subscriptions",
      "organizations_url": "https://api.github.com/users/Saty248/orgs",
      "repos_url": "https://api.github.com/users/Saty248/repos",
      "events_url": "https://api.github.com/users/Saty248/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Saty248/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-27T22:09:28Z",
    "updated_at": "2023-07-27T22:09:28Z",
    "author_association": "CONTRIBUTOR",
    "body": "@fvictorio .. I would like to contribute to this issue..but right now all i can think of is setting a default non-trivial minimum on the value as suggested.. Any ideas coming to your mind to solve this issue? maybe i can try those ..",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1654649370/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1670843647",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/4190#issuecomment-1670843647",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/4190",
    "id": 1670843647,
    "node_id": "IC_kwDOB7jojM5jlwz_",
    "user": {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-08-09T07:51:20Z",
    "updated_at": "2023-08-09T07:51:20Z",
    "author_association": "MEMBER",
    "body": "Hey @Saty248, sorry for not responding before. This issue is a bit involved, so someone from the team should tackle it.\r\n\r\nThis will need some experimentation to double-check that using `eth_maxPriorityFeePerGas` fixes the problem. But this is easy to do: we should reproduce the problem with a chain that has that method (Hardhat currently doesn't) and then change Hardhat to use that method first when estimating the gas price. If that fails, we then fall back to the current approach. We should do this with throwaway code to validate the approach; later we can implement it properly.\r\n\r\nIf that indeed works (and it probably will) we should:\r\n- [ ] Add the `eth_maxPriorityFeePerGas` method to Hardhat. It doesn't make sense to rely on a method that we don't support. I'm not sure what's the correct implementation here. We should check what geth does and see if that works for us.\r\n- [ ] Add tests for this method.\r\n- [ ] Add this method to the docs.\r\n- [ ] A test that reproduces the bug (_before_ implementing the solution)\r\n- [ ] Implement the solution explained in the previous paragraph.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1670843647/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1763641843",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/4190#issuecomment-1763641843",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/4190",
    "id": 1763641843,
    "node_id": "IC_kwDOB7jojM5pHwnz",
    "user": {
      "login": "shoenseiwaso",
      "id": 5861379,
      "node_id": "MDQ6VXNlcjU4NjEzNzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5861379?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/shoenseiwaso",
      "html_url": "https://github.com/shoenseiwaso",
      "followers_url": "https://api.github.com/users/shoenseiwaso/followers",
      "following_url": "https://api.github.com/users/shoenseiwaso/following{/other_user}",
      "gists_url": "https://api.github.com/users/shoenseiwaso/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/shoenseiwaso/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/shoenseiwaso/subscriptions",
      "organizations_url": "https://api.github.com/users/shoenseiwaso/orgs",
      "repos_url": "https://api.github.com/users/shoenseiwaso/repos",
      "events_url": "https://api.github.com/users/shoenseiwaso/events{/privacy}",
      "received_events_url": "https://api.github.com/users/shoenseiwaso/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-10-16T02:47:01Z",
    "updated_at": "2023-10-16T02:47:01Z",
    "author_association": "NONE",
    "body": "We're also hitting this issue extensively on Base Goerli Testnet, which appears to be given the very low number of transactions on this testnet and the different way that Optimism (i.e. Base) estimates gas. It would be great to have it addressed. It basically makes Hardhat unusable on Base.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1763641843/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
