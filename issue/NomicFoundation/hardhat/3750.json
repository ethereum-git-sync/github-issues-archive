{
  "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3750",
  "repository_url": "https://api.github.com/repos/NomicFoundation/hardhat",
  "labels_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3750/labels{/name}",
  "comments_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3750/comments",
  "events_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3750/events",
  "html_url": "https://github.com/NomicFoundation/hardhat/issues/3750",
  "id": 1613616746,
  "node_id": "I_kwDOB7jojM5gLdZq",
  "number": 3750,
  "title": "Revert reasons not detected with via-ir enabled",
  "user": {
    "login": "r0qs",
    "id": 457348,
    "node_id": "MDQ6VXNlcjQ1NzM0OA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/457348?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/r0qs",
    "html_url": "https://github.com/r0qs",
    "followers_url": "https://api.github.com/users/r0qs/followers",
    "following_url": "https://api.github.com/users/r0qs/following{/other_user}",
    "gists_url": "https://api.github.com/users/r0qs/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/r0qs/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/r0qs/subscriptions",
    "organizations_url": "https://api.github.com/users/r0qs/orgs",
    "repos_url": "https://api.github.com/users/r0qs/repos",
    "events_url": "https://api.github.com/users/r0qs/events{/privacy}",
    "received_events_url": "https://api.github.com/users/r0qs/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 4937119027,
      "node_id": "LA_kwDOB7jojM8AAAABJkZ1Mw",
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/labels/status:triaging",
      "name": "status:triaging",
      "color": "0E8A16",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2023-03-07T14:50:02Z",
  "updated_at": "2023-05-15T15:30:45Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Version of Hardhat\r\n\r\n2.13.0\r\n\r\n### What happened?\r\n\r\nAlthough a basic support to viaIR was added in https://github.com/NomicFoundation/hardhat/issues/3365, and https://github.com/NomicFoundation/hardhat/issues/2453 was closed in favor of it, the problem mentioned by this comment: https://github.com/NomicFoundation/hardhat/issues/2453#issuecomment-1059467546 still not fixed. So I'm opening this issue here so we can keep track of the problem.\r\n\r\nIt now throws the following error: `Transaction reverted and Hardhat couldn't infer the reason` as shown below:\r\n```\r\nCompiled 2 Solidity files successfully\r\n\r\n\r\n  1) expectRevert\r\n  2) expect().to.be.revertedWith\r\n  3) [current] expectRevert\r\n  4) [current] expect().to.be.revertedWith\r\n\r\n  0 passing (860ms)\r\n  4 failing\r\n\r\n  1) expectRevert:\r\n\r\n      Wrong kind of exception received\r\n      + expected - actual\r\n\r\n      -Transaction reverted and Hardhat couldn't infer the reason.\r\n      +Counter: decrement overflow\r\n      \r\n      at expectException (/home/roqs/node_modules/@openzeppelin/test-helpers/src/expectRevert.js:20:30)\r\n      at processTicksAndRejections (node:internal/process/task_queues:96:5)\r\n      at runNextTicks (node:internal/process/task_queues:65:3)\r\n      at listOnTimeout (node:internal/timers:528:9)\r\n      at processTimers (node:internal/timers:502:7)\r\n      at expectRevert (/home/roqs/node_modules/@openzeppelin/test-helpers/src/expectRevert.js:75:3)\r\n      at Context.<anonymous> (test/CountersTest.js:8:3)\r\n\r\n  2) expect().to.be.revertedWith:\r\n     AssertionError: Expected transaction to be reverted with \"Counter: decrement overflow\", but other reason was found: \"\"\r\n  \r\n\r\n  3) [current] expectRevert:\r\n\r\n      Wrong kind of exception received\r\n      + expected - actual\r\n\r\n      -Transaction reverted and Hardhat couldn't infer the reason.\r\n      +Counter: decrement overflow\r\n      \r\n      at expectException (/home/roqs/node_modules/@openzeppelin/test-helpers/src/expectRevert.js:20:30)\r\n      at processTicksAndRejections (node:internal/process/task_queues:96:5)\r\n      at runNextTicks (node:internal/process/task_queues:65:3)\r\n      at listOnTimeout (node:internal/timers:528:9)\r\n      at processTimers (node:internal/timers:502:7)\r\n      at expectRevert (/home/roqs/node_modules/@openzeppelin/test-helpers/src/expectRevert.js:75:3)\r\n      at Context.<anonymous> (test/CountersTest.js:18:3)\r\n\r\n  4) [current] expect().to.be.revertedWith:\r\n     AssertionError: Expected transaction to be reverted with \"Counter: decrement overflow\", but other reason was found: \"\"\r\n  \r\n```\r\n\r\n\r\n### Minimal reproduction steps\r\n\r\nRun the script below adapted from https://github.com/NomicFoundation/hardhat/issues/2453#issuecomment-1059467546, changing the solidity compiler version to `0.8.19` and `0.8.12` to see the errors. Using the current latest solc version (0.8.19) all tests will fail as in the example above. Using the version `0.8.12` only the two tests that has `current()` defined will pass as mentioned in the comment on the issue https://github.com/NomicFoundation/hardhat/issues/2453.\r\n\r\n```bash\r\n#!/bin/bash\r\n\r\nSOLC_VERSION=0.8.19\r\nSOLC_BINARY=solc-static-$SOLC_VERSION\r\nTEST_DIR=hardhat-viair-test\r\nmkdir -p $TEST_DIR/{test,contracts}\r\n\r\n(\r\ncd $TEST_DIR || exit\r\n\r\nwget -c \"https://github.com/ethereum/solidity/releases/download/v$SOLC_VERSION/solc-static-linux\" -O \"$SOLC_BINARY\"\r\nchmod +x \"$SOLC_BINARY\"\r\n\r\nBINARY_PATH=\"$(pwd)/$SOLC_BINARY\"\r\nSOLC_VERSION_LONG=$(\"$BINARY_PATH\" --version | tail -n 1 | sed -n -E 's/^Version: (.*)$/\\1/p')\r\n\r\ncat <<EOF > hardhat.config.js\r\nrequire(\"@nomiclabs/hardhat-waffle\");\r\nrequire('@nomiclabs/hardhat-truffle5');\r\n\r\nmodule.exports = {\r\n    solidity: {\r\n        compilers: [{\r\n            version: \"$SOLC_VERSION\",\r\n            settings: {\r\n                viaIR: true,\r\n                optimizer: { enabled: true },\r\n            },\r\n        }]\r\n    }\r\n};\r\n\r\nconst {TASK_COMPILE_SOLIDITY_GET_SOLC_BUILD} = require('hardhat/builtin-tasks/task-names');\r\nconst assert = require('assert');\r\n\r\nsubtask(TASK_COMPILE_SOLIDITY_GET_SOLC_BUILD, async (args, hre, runSuper) => {\r\n    assert(args.solcVersion == '$SOLC_VERSION', 'Unexpected solc version: ' + args.solcVersion)\r\n\r\n    return {\r\n        compilerPath: '$BINARY_PATH',\r\n        isSolcJs: false,\r\n        version: args.solcVersion,\r\n        longVersion: '$SOLC_VERSION_LONG'\r\n    }\r\n})\r\nEOF\r\n\r\ncat <<EOF > test/CountersTest.js\r\nconst { expectRevert } = require('@openzeppelin/test-helpers');\r\nconst { expect } = require('chai');\r\nconst CountersImpl = artifacts.require('CountersImpl');\r\nconst CountersImplCurrent = artifacts.require('CountersImplCurrent');\r\n\r\nit('expectRevert', async function () {\r\n  const counter = await CountersImpl.new();\r\n  await expectRevert(counter.decrement(), 'Counter: decrement overflow');\r\n});\r\n\r\nit('expect().to.be.revertedWith', async function () {\r\n  const counter = await CountersImpl.new();\r\n  await expect(counter.decrement()).to.be.revertedWith('Counter: decrement overflow');\r\n});\r\n\r\nit('[current] expectRevert', async function () {\r\n  const counter = await CountersImplCurrent.new();\r\n  await expectRevert(counter.decrement(), 'Counter: decrement overflow');\r\n});\r\n\r\nit('[current] expect().to.be.revertedWith', async function () {\r\n  const counter = await CountersImplCurrent.new();\r\n  await expect(counter.decrement()).to.be.revertedWith('Counter: decrement overflow');\r\n});\r\nEOF\r\n\r\ncat <<EOF > contracts/CountersImplCurrent.sol\r\ncontract CountersImplCurrent {\r\n    function current() public {}\r\n    function increment() public {}\r\n    function decrement() public {\r\n        require(false, \"Counter: decrement overflow\");\r\n    }\r\n}\r\nEOF\r\n\r\ncat <<EOF > contracts/CountersImpl.sol\r\ncontract CountersImpl {\r\n    function increment() public {}\r\n    function decrement() public {\r\n        require(false, \"Counter: decrement overflow\");\r\n    }\r\n}\r\nEOF\r\n\r\nnpm install hardhat @nomiclabs/hardhat-waffle chai @openzeppelin/test-helpers @nomiclabs/hardhat-truffle5\r\nnpx hardhat test\r\n)\r\n```\r\n\r\n### Search terms\r\n\r\n_No response_",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3750/reactions",
    "total_count": 2,
    "+1": 2,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3750/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1461792714",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/3750#issuecomment-1461792714",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3750",
    "id": 1461792714,
    "node_id": "IC_kwDOB7jojM5XIS_K",
    "user": {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-09T10:50:41Z",
    "updated_at": "2023-03-09T10:50:41Z",
    "author_association": "MEMBER",
    "body": "Hey @r0qs, does this still happen if you set minimal optimizer steps, as explained [here](https://hardhat.org/hardhat-runner/docs/reference/solidity-support#support-for-ir-based-codegen)?",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1461792714/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1461873747",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/3750#issuecomment-1461873747",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3750",
    "id": 1461873747,
    "node_id": "IC_kwDOB7jojM5XImxT",
    "user": {
      "login": "cameel",
      "id": 137030,
      "node_id": "MDQ6VXNlcjEzNzAzMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/137030?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cameel",
      "html_url": "https://github.com/cameel",
      "followers_url": "https://api.github.com/users/cameel/followers",
      "following_url": "https://api.github.com/users/cameel/following{/other_user}",
      "gists_url": "https://api.github.com/users/cameel/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cameel/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cameel/subscriptions",
      "organizations_url": "https://api.github.com/users/cameel/orgs",
      "repos_url": "https://api.github.com/users/cameel/repos",
      "events_url": "https://api.github.com/users/cameel/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cameel/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-09T11:42:44Z",
    "updated_at": "2023-03-09T11:42:44Z",
    "author_association": "NONE",
    "body": "Good point. I suspect it might be working with minimal optimizer and if it does, it should not be an issue for regular users.\r\n\r\nOur situation is a bit special, because being able to run tests with optimizer enabled in our CI is still useful. Especially for benchmarking the optimizer. And vast majority of tests do pass with optimization, we just have to manually disable the select ones that fail. We'll need to think what to do about it on our side going forward. I expected that they'll just work then you add support for via IR, but I should have realized that that's going to be the case only for unoptimized code :)\r\n\r\nBy the way, what is Hardhat's behavior going to be when a user does try to run tests with optimizer anyway? Will you leave it as is and just recommend not to do it? Or will you block it? Or maybe something in between, e.g. detect and skip misbehaving tests or ignore the optimizer flag and run unoptimized?",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1461873747/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1462483527",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/3750#issuecomment-1462483527",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3750",
    "id": 1462483527,
    "node_id": "IC_kwDOB7jojM5XK7pH",
    "user": {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-09T17:40:19Z",
    "updated_at": "2023-03-09T17:40:19Z",
    "author_association": "MEMBER",
    "body": "> By the way, what is Hardhat's behavior going to be when a user does try to run tests with optimizer anyway? Will you leave it as is and just recommend not to do it?\r\n\r\nProbably that, yes. We wouldn't block it because several other things continue to work, and people might prefer running their tests that way (and losing some Hardhat features).",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1462483527/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1463767000",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/3750#issuecomment-1463767000",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3750",
    "id": 1463767000,
    "node_id": "IC_kwDOB7jojM5XP0_Y",
    "user": {
      "login": "r0qs",
      "id": 457348,
      "node_id": "MDQ6VXNlcjQ1NzM0OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/457348?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/r0qs",
      "html_url": "https://github.com/r0qs",
      "followers_url": "https://api.github.com/users/r0qs/followers",
      "following_url": "https://api.github.com/users/r0qs/following{/other_user}",
      "gists_url": "https://api.github.com/users/r0qs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/r0qs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/r0qs/subscriptions",
      "organizations_url": "https://api.github.com/users/r0qs/orgs",
      "repos_url": "https://api.github.com/users/r0qs/repos",
      "events_url": "https://api.github.com/users/r0qs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/r0qs/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-10T12:57:15Z",
    "updated_at": "2023-03-10T13:06:08Z",
    "author_association": "NONE",
    "body": "Thanks @fvictorio, adding only the UnusedPruner step to `optimizerSteps` fixes this issue indeed.\r\n\r\nHowever, there are still some other cases in our external tests that use hardhat and still failing with the same error even when using only the suggested optimizer step. So maybe we can keep this issue open until we fix it all?\r\n\r\nI couldn't find a minimal reproducible example yet, I will update this issue if I find some. But you can check some of the failed cases here: https://app.circleci.com/pipelines/github/r0qs/solidity/319/workflows/9c536705-b7d6-4e5f-958a-831d97a27288\r\n\r\nFor instance, this specific test from openzeppelin: https://app.circleci.com/pipelines/github/r0qs/solidity/319/workflows/9c536705-b7d6-4e5f-958a-831d97a27288/jobs/9088?invite=true#step-104-5087\r\n\r\n```\r\n1) Contract: TransparentUpgradeableProxy\r\n       transparent proxy\r\n         proxy admin cannot call delegated functions:\r\n\r\n      Wrong kind of exception received\r\n      + expected - actual\r\n\r\n      -Transaction reverted and Hardhat couldn't infer the reason.\r\n      +TransparentUpgradeableProxy: admin cannot fallback to proxy target\r\n      \r\n      at expectException (node_modules/@openzeppelin/test-helpers/src/expectRevert.js:20:30)\r\n      at runNextTicks (node:internal/process/task_queues:60:5)\r\n      at processTimers (node:internal/timers:508:9)\r\n      at expectRevert (node_modules/@openzeppelin/test-helpers/src/expectRevert.js:75:3)\r\n      at Context.<anonymous> (test/proxy/transparent/TransparentUpgradeableProxy.behaviour.js:327:7)\r\n```\r\n\r\nYou can see the compiler settings used to run the tests here: https://app.circleci.com/pipelines/github/r0qs/solidity/319/workflows/9c536705-b7d6-4e5f-958a-831d97a27288/jobs/9088?invite=true#step-104-30\r\n```\r\nSettings preset: ir-optimize-evm+yul\r\nSettings: {evmVersion: 'paris', viaIR: true,  optimizer: {enabled: true, details: {yul: true, yulDetails: { optimizerSteps: 'u' }}}}\r\nEVM version: paris\r\nCompiler version: 0.8.20\r\nCompiler version (full): 0.8.20-ci.2023.3.10+commit.27beaa72.Linux.g++\r\n```\r\n\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1463767000/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
