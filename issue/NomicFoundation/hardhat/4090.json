{
  "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/4090",
  "repository_url": "https://api.github.com/repos/NomicFoundation/hardhat",
  "labels_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/4090/labels{/name}",
  "comments_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/4090/comments",
  "events_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/4090/events",
  "html_url": "https://github.com/NomicFoundation/hardhat/issues/4090",
  "id": 1782256736,
  "node_id": "I_kwDOB7jojM5qOxRg",
  "number": 4090,
  "title": "Multiple transactions in one block ",
  "user": {
    "login": "graygt",
    "id": 107045936,
    "node_id": "U_kgDOBmFkMA",
    "avatar_url": "https://avatars.githubusercontent.com/u/107045936?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/graygt",
    "html_url": "https://github.com/graygt",
    "followers_url": "https://api.github.com/users/graygt/followers",
    "following_url": "https://api.github.com/users/graygt/following{/other_user}",
    "gists_url": "https://api.github.com/users/graygt/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/graygt/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/graygt/subscriptions",
    "organizations_url": "https://api.github.com/users/graygt/orgs",
    "repos_url": "https://api.github.com/users/graygt/repos",
    "events_url": "https://api.github.com/users/graygt/events{/privacy}",
    "received_events_url": "https://api.github.com/users/graygt/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 4937119027,
      "node_id": "LA_kwDOB7jojM8AAAABJkZ1Mw",
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/labels/status:triaging",
      "name": "status:triaging",
      "color": "0E8A16",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2023-06-30T10:03:55Z",
  "updated_at": "2023-07-05T17:03:00Z",
  "closed_at": "2023-07-03T09:36:02Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Version of Hardhat\r\n\r\n2.16.0\r\n\r\n### What happened?\r\n\r\nThere is a problem in packing multiple transaction in one block. There only one transaction in mempool. To mine more than one tx, \"evm_mine\" should be called multiple times. There is no way to pack two txs to one block. I will just provide a code that shows pending block, compared to v2.14.0 where it works correctly.\r\n\r\n\r\nHardhat v2.16.0, ethers v6.6.0\r\n```\r\nimport { ethers } from \"hardhat\";\r\n\r\nasync function main() {\r\n    await ethers.provider.send(\"evm_setAutomine\", [false]);\r\n    await ethers.provider.send(\"evm_setIntervalMining\", [0]);\r\n\r\n    const owner = await ethers.provider.getSigner(0);\r\n    const ownerAddress = await owner.getAddress();\r\n\r\n    const tx1 = {\r\n        to: \"0x5FbDB2315678afecb367f032d93F642f64180aa3\",\r\n        value: ethers.parseEther(\"1.0\"),\r\n        type: 0,\r\n    }\r\n\r\n    const tx2 = {\r\n        to: \"0x5FbDB2315678afecb367f032d93F642f64180aa3\",\r\n        value: ethers.parseEther(\"1.0\"),\r\n        type: 0,\r\n    }\r\n\r\n    await owner.sendTransaction(tx1);\r\n    await owner.sendTransaction(tx2);\r\n\r\n    const pendingTx = await ethers.provider.send(\"eth_pendingTransactions\");\r\n    console.log(\"pendingTx\", pendingTx.map((tx) => tx.hash)); // this gives two pending transactions\r\n\r\n    const pendingBlock = await ethers.provider.send(\"eth_getBlockByNumber\", [\"pending\", false,]);\r\n    console.log(pendingBlock); // gives one pending tx\r\n\r\n    // mine a block\r\n    await ethers.provider.send(\"evm_mine\", []);\r\n}\r\n\r\nmain();\r\n```\r\n\r\nResult:\r\n```\r\n{\r\n  number: null,\r\n  hash: null,\r\n  parentHash: '0x640d62a47df354b4f3353f136ede741e44b89c6c97dccbd8e30599ace38d3d6f',\r\n  nonce: null,\r\n  mixHash: null,\r\n  sha3Uncles: '0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347',\r\n  logsBloom: '0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000',\r\n  transactionsRoot: '0x90d1a983ff6dbc54851fb16b15cb14ed17632e0f8e37ad49c88bea7994454be0',\r\n  stateRoot: '0x4fd2cddd334dab1c4005161c290f25a0e18d4175ecfa898b17095d8ec2dd344a',\r\n  receiptsRoot: '0xf78dfb743fbd92ade140711c8bbc542b5e307f0ab7984eff35d751969fe57efa',\r\n  miner: '0xc014ba5ec014ba5ec014ba5ec014ba5ec014ba5e',\r\n  difficulty: '0x0',\r\n  totalDifficulty: '0x37f4405',\r\n  extraData: '0x',\r\n  size: '0x2a6',\r\n  gasLimit: '0x1c9c380',\r\n  gasUsed: '0x5208',\r\n  timestamp: '0x649d72ad',\r\n  transactions: [\r\n    '0xe06e207f5605ec8efc8d1d08612d36cd59096530dcf479d0b8d6a5f2de188e0c' // ONLY ONE TX\r\n  ],\r\n  uncles: [],\r\n  baseFeePerGas: '0x3b9aca00',\r\n  withdrawals: [],\r\n  withdrawalsRoot: '0x56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421' \r\n}\r\n```\r\n\r\nComparison to Hardhat v2.14.0, ethers v5.7.2 where it works correctly.\r\n```\r\nimport { ethers } from \"hardhat\";\r\n\r\nasync function main() {\r\n    await ethers.provider.send(\"evm_setAutomine\", [false]);\r\n    await ethers.provider.send(\"evm_setIntervalMining\", [0]);\r\n\r\n    const owner = await ethers.provider.getSigner(0);\r\n    const ownerAddress = await owner.getAddress();\r\n\r\n    const tx1 = {\r\n        to: \"0x5FbDB2315678afecb367f032d93F642f64180aa3\",\r\n        value: ethers.utils.parseEther(\"1.0\"),\r\n        type: 0,\r\n    }\r\n\r\n    const tx2 = {\r\n        to: \"0x5FbDB2315678afecb367f032d93F642f64180aa3\",\r\n        value: ethers.utils.parseEther(\"1.0\"),\r\n        type: 0,\r\n    }\r\n\r\n    await owner.sendTransaction(tx1);\r\n    await owner.sendTransaction(tx2);\r\n\r\n    const pendingBlock = await ethers.provider.send(\"eth_getBlockByNumber\", [\"pending\", false,]);\r\n    console.log(pendingBlock);\r\n\r\n    // mine a block\r\n    await ethers.provider.send(\"evm_mine\", []);\r\n}\r\n\r\nmain();\r\n```\r\n\r\nResult:\r\n```\r\n{\r\n  number: null,\r\n  hash: null,\r\n  parentHash: '0x640d62a47df354b4f3353f136ede741e44b89c6c97dccbd8e30599ace38d3d6f',\r\n  nonce: null,\r\n  mixHash: null,\r\n  sha3Uncles: '0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347',\r\n  logsBloom: '0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000',\r\n  transactionsRoot: '0x69b19d8ad9952927647f017952633f1027cdc1f5ce9883e54c8f6d907945fd8b',\r\n  stateRoot: '0x49c756d15bbf811f532811dba19f5fda9df678bcdd4017024ef4daded412af7d',\r\n  receiptsRoot: '0x75308898d571eafb5cd8cde8278bf5b3d13c5f6ec074926de3bb895b519264e1',\r\n  miner: '0xc014ba5ec014ba5ec014ba5ec014ba5ec014ba5e',\r\n  difficulty: '0x0',\r\n  totalDifficulty: '0x37f4405',\r\n  extraData: '0x',\r\n  size: '0x31d',\r\n  gasLimit: '0x1c9c380',\r\n  gasUsed: '0xa410',\r\n  timestamp: '0x649d72ad',\r\n  transactions: [\r\n    '0x4f3c84dfcd839177d439a450a2dcf958647d5287cb49ed19022803ba31583124', // FIRST TX\r\n    '0x9b4d72e2fdae47a00e841642567e7fd40e064863d6cfbb84890f8a81cb45bf7e' // SECOND TX\r\n  ],\r\n  uncles: [],\r\n  baseFeePerGas: '0x3b9aca00',\r\n  withdrawals: [],\r\n  withdrawalsRoot: '0x56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421'\r\n}\r\n```\r\n\r\n\r\n### Minimal reproduction steps\r\n\r\nJust check the code above. It's reproducible.\r\n\r\n### Search terms\r\n\r\n_No response_",
  "closed_by": {
    "login": "graygt",
    "id": 107045936,
    "node_id": "U_kgDOBmFkMA",
    "avatar_url": "https://avatars.githubusercontent.com/u/107045936?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/graygt",
    "html_url": "https://github.com/graygt",
    "followers_url": "https://api.github.com/users/graygt/followers",
    "following_url": "https://api.github.com/users/graygt/following{/other_user}",
    "gists_url": "https://api.github.com/users/graygt/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/graygt/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/graygt/subscriptions",
    "organizations_url": "https://api.github.com/users/graygt/orgs",
    "repos_url": "https://api.github.com/users/graygt/repos",
    "events_url": "https://api.github.com/users/graygt/events{/privacy}",
    "received_events_url": "https://api.github.com/users/graygt/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/4090/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/4090/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1617590067",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/4090#issuecomment-1617590067",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/4090",
    "id": 1617590067,
    "node_id": "IC_kwDOB7jojM5gancz",
    "user": {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-03T08:10:43Z",
    "updated_at": "2023-07-03T08:10:43Z",
    "author_association": "MEMBER",
    "body": "Hi @graygt, can you try setting this in your config?\r\n\r\n```\r\nnetworks: {\r\n  hardhat: {\r\n    gas: \"auto\"\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1617590067/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1617723925",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/4090#issuecomment-1617723925",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/4090",
    "id": 1617723925,
    "node_id": "IC_kwDOB7jojM5gbIIV",
    "user": {
      "login": "graygt",
      "id": 107045936,
      "node_id": "U_kgDOBmFkMA",
      "avatar_url": "https://avatars.githubusercontent.com/u/107045936?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/graygt",
      "html_url": "https://github.com/graygt",
      "followers_url": "https://api.github.com/users/graygt/followers",
      "following_url": "https://api.github.com/users/graygt/following{/other_user}",
      "gists_url": "https://api.github.com/users/graygt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/graygt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/graygt/subscriptions",
      "organizations_url": "https://api.github.com/users/graygt/orgs",
      "repos_url": "https://api.github.com/users/graygt/repos",
      "events_url": "https://api.github.com/users/graygt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/graygt/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-03T09:34:29Z",
    "updated_at": "2023-07-03T09:34:29Z",
    "author_association": "NONE",
    "body": "@fvictorio Thanks! It works!",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1617723925/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1622155314",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/4090#issuecomment-1622155314",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/4090",
    "id": 1622155314,
    "node_id": "IC_kwDOB7jojM5gsCAy",
    "user": {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-05T17:03:00Z",
    "updated_at": "2023-07-05T17:03:00Z",
    "author_association": "MEMBER",
    "body": "Glad to hear that! I'll explain what's goin on here just in case:\r\n\r\nNormally when you send a transaction a gas estimation is performed first. The way gas is estimated is that the same transaction is executed multiple times with different gas limits until a correct value is found (doing a binary search). This is also what geth does under the hood.\r\n\r\nThe problem is that doing that for each transaction is kind of slow. So, when you are using the Hardhat network, we don't estimate gas by default. Instead, we just use the full block gas limit as the estimation. In previous versions of `hardhat-ethers` we would only do this for the in-process Hardhat network, but in the latest major version we also do it when you connect via `--network localhost` to a Hardhat node.\r\n\r\nThe problem with using the full block gas limit as an estimation though is that, if there are multiple transactions in the mempool and you are mining a block, only one transaction will be mined. This happens because, when the second transaction is added, the algorithm is something like this:\r\n\r\n1. I have (blockGasLimit - currentlyExecutedGas) gas left\r\n2. The next transaction can use up to `nextTx.gasLimit`\r\n3. If that value is bigger than the gas I have left in this block, then I won't include it. Since all txs use `blockGasLimit` as their gas limit, this is always the case and no second tx is included.\r\n\r\nYou could argue that we should run that transaction anyway and include it if the gas that it _actually_ uses fits the remaining gas in the block. But we are following what geth does here (IIRC it works this way to prevent a DoS vector)\r\n\r\nSo, when you set `\"gas\": \"auto\"` you are basically avoiding the \"use the whole block gas limit as the gas limit for every tx\" optimization and actually running the gas estimations, which has a performance impact but it's more realistic.\r\n\r\nHope that helps, happy to answer any questions about this.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1622155314/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
