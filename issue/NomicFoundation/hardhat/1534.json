{
  "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1534",
  "repository_url": "https://api.github.com/repos/NomicFoundation/hardhat",
  "labels_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1534/labels{/name}",
  "comments_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1534/comments",
  "events_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1534/events",
  "html_url": "https://github.com/NomicFoundation/hardhat/issues/1534",
  "id": 916672392,
  "node_id": "MDU6SXNzdWU5MTY2NzIzOTI=",
  "number": 1534,
  "title": "JSON RPC net_version and eth_chainId sometimes fail when running a localhost fork",
  "user": {
    "login": "ajb413",
    "id": 5566172,
    "node_id": "MDQ6VXNlcjU1NjYxNzI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5566172?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ajb413",
    "html_url": "https://github.com/ajb413",
    "followers_url": "https://api.github.com/users/ajb413/followers",
    "following_url": "https://api.github.com/users/ajb413/following{/other_user}",
    "gists_url": "https://api.github.com/users/ajb413/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ajb413/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ajb413/subscriptions",
    "organizations_url": "https://api.github.com/users/ajb413/orgs",
    "repos_url": "https://api.github.com/users/ajb413/repos",
    "events_url": "https://api.github.com/users/ajb413/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ajb413/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": true,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 17,
  "created_at": "2021-06-09T21:04:36Z",
  "updated_at": "2022-11-18T18:26:09Z",
  "closed_at": "2021-06-22T19:18:44Z",
  "author_association": "NONE",
  "active_lock_reason": "resolved",
  "body": "I've been really struggling to pinpoint the cause of this issue; I'm not 100% certain that it is Hardhat but I am leaning towards it. I am running tests against a localhost fork of mainnet at a specific block. The project is Compound.js, which is an SDK written in TypeScript that wraps around ethers.js.\r\n\r\nThe issue is that calls to `net_version` seem to work when I call them from within a test, but they are breaking when an instance of Compound.js SDK calls it.\r\n\r\nBreaks:\r\n```js\r\nconst compound = new Compound('http://localhost:8545', { privateKey });\r\nconst trx = await compound.repayBorrow('USDC', 1, '0xbadaddress', false); // a different error should be thrown\r\n\r\n// for the `trx` line, an ethers.js error gets thrown:\r\n//     reason: 'missing response',\r\n//     code: 'SERVER_ERROR',\r\n//     requestBody: '{\"method\":\"net_version\",\"id\":42,\"jsonrpc\":\"2.0\"}',\r\n//     serverError: Error: connect ECONNREFUSED 127.0.0.1:8545\r\n```\r\n\r\nThe culprit (I think) is [this one line of code](https://github.com/compound-finance/compound-js/blob/master/src/eth.ts#L227), because it is the only place in the SDK where `net_version` is explicitly called.\r\n\r\n```ts\r\nnetworkId = await _provider.send('net_version');\r\n```\r\n\r\nI tried switching it to `eth_chainId`, but I get the same error except for `eth_chainId`.\r\n\r\n```diff\r\n- networkId = await _provider.send('net_version');\r\n+ networkId = (await _provider.send('eth_chainId')).chainId;\r\n```\r\n\r\nI tried calling `net_version` explicitly within the same test, and it works fine (same with `eth_chainId`).\r\n\r\nWorks fine (both console.logs spit out a 1):\r\n```js\r\nconst p = new ethers.providers.JsonRpcProvider('http://localhost:8545');\r\nconst ethersNetVersion = await p.send('net_version');\r\nconsole.log('ethers net_version', +ethersNetVersion);\r\nconst hreNetVersion = await hre.network.provider.send('net_version');\r\nconsole.log('hre net_version', +hreNetVersion);\r\n```\r\n\r\nI try doing both of these things within a single test. The error occurs for all of my tests that use an instance of `compound`, not just this one test.\r\n\r\n**The reason I do not think that the cause is ethers.js or the Compound.js SDK is because this call works perfectly fine if I use a ganache-core fork of mainnet.**\r\n\r\nTheories:\r\n- There is something fishy with the version of ethers that gets used in the hardhat test environment. I tried upgrading ethers.js but I get the same issue. And I suspect that using the non-special version of ethers does not work out with the hardhat localhost instance.\r\n- Some issue with typescript? The call comes from within a ts file.\r\n\r\nSteps to reproduce (need **your own** archive node access):\r\n```\r\n## first set an environment variable to your own JSON RPC URL with archive node access\r\nexport MAINNET_PROVIDER_URL=\"https://eth-mainnet.alchemyapi.io/v2/your-api-key\"\r\n\r\ngit clone https://github.com/compound-finance/compound-js.git\r\ncd compound-js\r\ngit checkout -b hardhat-tests\r\ngit pull origin hardhat-tests\r\nnpm i\r\nnpm test -- -g 'fails cToken.repayBorrow behalf address'\r\n```\r\n\r\nWhat this does is it [runs this single test](https://github.com/compound-finance/compound-js/blob/hardhat-tests/test/cToken.test.js#L422) that has the combined working and broken code snippets above.\r\n\r\nIf anyone can pinpoint the issue, identify the bug, or at least point me in the right direction I would really appreciate it!",
  "closed_by": {
    "login": "fvictorio",
    "id": 417134,
    "node_id": "MDQ6VXNlcjQxNzEzNA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/fvictorio",
    "html_url": "https://github.com/fvictorio",
    "followers_url": "https://api.github.com/users/fvictorio/followers",
    "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
    "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
    "organizations_url": "https://api.github.com/users/fvictorio/orgs",
    "repos_url": "https://api.github.com/users/fvictorio/repos",
    "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
    "received_events_url": "https://api.github.com/users/fvictorio/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1534/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1534/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/858513032",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/1534#issuecomment-858513032",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1534",
    "id": 858513032,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg1ODUxMzAzMg==",
    "user": {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-06-10T10:39:04Z",
    "updated_at": "2021-06-10T10:39:04Z",
    "author_association": "MEMBER",
    "body": "Hey @ajb413, I know this is a silly question but... are you sure something is running in `localhost:8545`? That error typically shows up when that port isn't open. And the reason it might work with ganache is that ganache always (as far as I know) starts an HTTP server, while hardhat doesn't (for example, when you run your tests without passing any `--network`, you are using an in-process hardhat network that doesn't open any port).\r\n\r\nIn other words, that should work if you've previously run `npx hardhat node` in another terminal. Although most of the time you don't need to do that and you just use the injected provider that is connected to the in-process network.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/858513032/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/858927649",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/1534#issuecomment-858927649",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1534",
    "id": 858927649,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg1ODkyNzY0OQ==",
    "user": {
      "login": "ajb413",
      "id": 5566172,
      "node_id": "MDQ6VXNlcjU1NjYxNzI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5566172?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajb413",
      "html_url": "https://github.com/ajb413",
      "followers_url": "https://api.github.com/users/ajb413/followers",
      "following_url": "https://api.github.com/users/ajb413/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajb413/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajb413/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajb413/subscriptions",
      "organizations_url": "https://api.github.com/users/ajb413/orgs",
      "repos_url": "https://api.github.com/users/ajb413/repos",
      "events_url": "https://api.github.com/users/ajb413/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajb413/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-06-10T19:06:37Z",
    "updated_at": "2021-06-10T19:06:37Z",
    "author_association": "NONE",
    "body": "Hey @fvictorio! Thanks for your reply. It's not a silly question, we need to ask things like this when debugging.\r\n\r\nMy localhost chain is being spawned by `hre.run('node')` in my [main test file](https://github.com/compound-finance/compound-js/blob/hardhat-tests/test/index.js#L40). I can see this get logged as a direct result of that line of code:\r\n\r\n```\r\nStarted HTTP and WebSocket JSON-RPC server at http://127.0.0.1:8545/\r\n```\r\n\r\nI also used the `ps` command to make sure there are no other chains or node.js processes running, so I am certain that hardhat is making a chain at http://localhost:8545/ and it is the only chain running on my machine at the time.\r\n\r\nIf you run the steps in my previous comment, you'll see that I am able to do this, without error:\r\n\r\n```js\r\nconst p = new ethers.providers.JsonRpcProvider('http://localhost:8545');\r\nconst ethersNetVersion = await p.send('net_version');\r\n```\r\n\r\nWhich means there is something running at 8545 for sure. Why does one object making a request succeed but another object making the same request fail? Something fishy is going on here for sure.\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/858927649/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/858940993",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/1534#issuecomment-858940993",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1534",
    "id": 858940993,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg1ODk0MDk5Mw==",
    "user": {
      "login": "ajb413",
      "id": 5566172,
      "node_id": "MDQ6VXNlcjU1NjYxNzI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5566172?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajb413",
      "html_url": "https://github.com/ajb413",
      "followers_url": "https://api.github.com/users/ajb413/followers",
      "following_url": "https://api.github.com/users/ajb413/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajb413/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajb413/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajb413/subscriptions",
      "organizations_url": "https://api.github.com/users/ajb413/orgs",
      "repos_url": "https://api.github.com/users/ajb413/repos",
      "events_url": "https://api.github.com/users/ajb413/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajb413/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-06-10T19:16:52Z",
    "updated_at": "2021-06-10T19:16:52Z",
    "author_association": "NONE",
    "body": "If I comment out my line `hre.run('node')` in my [main test file](https://github.com/compound-finance/compound-js/blob/hardhat-tests/test/index.js#L40) and run `npx hardhat node` in a separate command line, the test succeeds, even with both of the different objects making those same requests.\r\n\r\nI am guessing that something is off with my `hre.run('node')` line, which I highly prefer to use instead of a separate `npx hardhat node`. I am having trouble finding docs for it, specifically what parameters I can pass to the command in the second parameter.\r\n\r\nIs there a way to run my tests properly without having to run hardhat in a separate command line? The log created by `hre.run('node')` that a server is running at 8545 is at the least deceiving if some objects can query it but others can't. If that is actually the intended behavior, which I have a feeling it isn't, some docs explaining why would be great.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/858940993/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/858946685",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/1534#issuecomment-858946685",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1534",
    "id": 858946685,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg1ODk0NjY4NQ==",
    "user": {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-06-10T19:21:16Z",
    "updated_at": "2021-06-10T19:21:16Z",
    "author_association": "MEMBER",
    "body": "Oh, I didn't realize you were programmatically starting the node task. I'll check this again later, thanks for clarifying.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/858946685/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/859181555",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/1534#issuecomment-859181555",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1534",
    "id": 859181555,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg1OTE4MTU1NQ==",
    "user": {
      "login": "tndv",
      "id": 12984183,
      "node_id": "MDQ6VXNlcjEyOTg0MTgz",
      "avatar_url": "https://avatars.githubusercontent.com/u/12984183?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tndv",
      "html_url": "https://github.com/tndv",
      "followers_url": "https://api.github.com/users/tndv/followers",
      "following_url": "https://api.github.com/users/tndv/following{/other_user}",
      "gists_url": "https://api.github.com/users/tndv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tndv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tndv/subscriptions",
      "organizations_url": "https://api.github.com/users/tndv/orgs",
      "repos_url": "https://api.github.com/users/tndv/repos",
      "events_url": "https://api.github.com/users/tndv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tndv/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-06-11T00:51:12Z",
    "updated_at": "2021-06-11T23:04:58Z",
    "author_association": "NONE",
    "body": "I just went to report this issue to see it was the most recent. I'm having the exact same problem, with slightly different circumstances - I have some small scripts that muck around with Uniswap contracts on a forked hardhat mainnet node that have all randomly stopped working today. I run the node manually in a separate window using `npx hardhat node`. Stdout from the scripts prints\r\n\r\n`amountsout error : ProviderError: Invalid signature v value`\r\n\r\nand the forked node shows the error occurs in `eth_call`?\r\n\r\n![image](https://user-images.githubusercontent.com/12984183/121614766-be3b4480-caa2-11eb-8d17-00d013de53db.png)\r\n\r\nThis is all I could find",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/859181555/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/859484949",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/1534#issuecomment-859484949",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1534",
    "id": 859484949,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg1OTQ4NDk0OQ==",
    "user": {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-06-11T10:34:54Z",
    "updated_at": "2021-06-11T10:34:54Z",
    "author_association": "MEMBER",
    "body": "@hoont that seems like a different issue. If you can make a [minimal reproducible example](https://stackoverflow.com/help/minimal-reproducible-example), please open a new issue with a link to it.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/859484949/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/859900254",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/1534#issuecomment-859900254",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1534",
    "id": 859900254,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg1OTkwMDI1NA==",
    "user": {
      "login": "ajb413",
      "id": 5566172,
      "node_id": "MDQ6VXNlcjU1NjYxNzI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5566172?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajb413",
      "html_url": "https://github.com/ajb413",
      "followers_url": "https://api.github.com/users/ajb413/followers",
      "following_url": "https://api.github.com/users/ajb413/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajb413/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajb413/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajb413/subscriptions",
      "organizations_url": "https://api.github.com/users/ajb413/orgs",
      "repos_url": "https://api.github.com/users/ajb413/repos",
      "events_url": "https://api.github.com/users/ajb413/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajb413/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-06-11T20:41:02Z",
    "updated_at": "2021-06-11T20:41:02Z",
    "author_association": "NONE",
    "body": "@fvictorio Is there a way to configure a hh node from within a script to function exactly the same as doing `npx hardhat node`?\r\n\r\nSo I would instead do something like this:\r\n\r\n`node myLocalHardhat.js`\r\n\r\nmyLocalHardhat.js:\r\n```js\r\nconst hre = require('hardhat');\r\nhre.run('node');\r\n// do some configuring here?\r\n```\r\n\r\nPerhaps, if there is a way to do that, it can be my workaround for now. Thank you!\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/859900254/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/860087992",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/1534#issuecomment-860087992",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1534",
    "id": 860087992,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg2MDA4Nzk5Mg==",
    "user": {
      "login": "alcuadrado",
      "id": 176499,
      "node_id": "MDQ6VXNlcjE3NjQ5OQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/176499?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alcuadrado",
      "html_url": "https://github.com/alcuadrado",
      "followers_url": "https://api.github.com/users/alcuadrado/followers",
      "following_url": "https://api.github.com/users/alcuadrado/following{/other_user}",
      "gists_url": "https://api.github.com/users/alcuadrado/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alcuadrado/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alcuadrado/subscriptions",
      "organizations_url": "https://api.github.com/users/alcuadrado/orgs",
      "repos_url": "https://api.github.com/users/alcuadrado/repos",
      "events_url": "https://api.github.com/users/alcuadrado/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alcuadrado/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-06-12T18:00:35Z",
    "updated_at": "2021-06-12T18:01:02Z",
    "author_association": "MEMBER",
    "body": "Do you mean passing params as you would in the cli? `run` takes a second param, which is an object with the task args.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/860087992/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/860121863",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/1534#issuecomment-860121863",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1534",
    "id": 860121863,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg2MDEyMTg2Mw==",
    "user": {
      "login": "ajb413",
      "id": 5566172,
      "node_id": "MDQ6VXNlcjU1NjYxNzI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5566172?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajb413",
      "html_url": "https://github.com/ajb413",
      "followers_url": "https://api.github.com/users/ajb413/followers",
      "following_url": "https://api.github.com/users/ajb413/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajb413/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajb413/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajb413/subscriptions",
      "organizations_url": "https://api.github.com/users/ajb413/orgs",
      "repos_url": "https://api.github.com/users/ajb413/repos",
      "events_url": "https://api.github.com/users/ajb413/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajb413/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-06-12T22:38:18Z",
    "updated_at": "2021-06-12T22:38:18Z",
    "author_association": "NONE",
    "body": "@alcuadrado I'm interested in doing that if the script-made node behaves exactly like the node that is launched directly from the cli, so my tests will pass as expected. To summarize the above:\r\n\r\nUsing `hre.run('node');` from within a script: test script fails\r\nInstead using `npx hardhat node` from the cli: test script passes\r\n\r\nI was asking, is there a way to pass params to `hre.run('node');` so that it behaves exactly like `npx hardhat node` so my tests will pass?\r\n\r\nIf `hre.run('node');` and `npx hardhat node` *are* supposed to function identically, then I assume this must be due to a bug? I could be wrong.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/860121863/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/860264234",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/1534#issuecomment-860264234",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1534",
    "id": 860264234,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg2MDI2NDIzNA==",
    "user": {
      "login": "alcuadrado",
      "id": 176499,
      "node_id": "MDQ6VXNlcjE3NjQ5OQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/176499?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alcuadrado",
      "html_url": "https://github.com/alcuadrado",
      "followers_url": "https://api.github.com/users/alcuadrado/followers",
      "following_url": "https://api.github.com/users/alcuadrado/following{/other_user}",
      "gists_url": "https://api.github.com/users/alcuadrado/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alcuadrado/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alcuadrado/subscriptions",
      "organizations_url": "https://api.github.com/users/alcuadrado/orgs",
      "repos_url": "https://api.github.com/users/alcuadrado/repos",
      "events_url": "https://api.github.com/users/alcuadrado/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alcuadrado/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-06-13T20:12:25Z",
    "updated_at": "2021-06-13T20:12:55Z",
    "author_association": "MEMBER",
    "body": "The cli does `hre.run(\"node\")` internally. I suspect you are not waiting for the RPC server to launch and be ready to accept connections. It takes a few millis. Take a look at how the `node` task does it.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/860264234/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/860273398",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/1534#issuecomment-860273398",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1534",
    "id": 860273398,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg2MDI3MzM5OA==",
    "user": {
      "login": "ajb413",
      "id": 5566172,
      "node_id": "MDQ6VXNlcjU1NjYxNzI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5566172?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajb413",
      "html_url": "https://github.com/ajb413",
      "followers_url": "https://api.github.com/users/ajb413/followers",
      "following_url": "https://api.github.com/users/ajb413/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajb413/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajb413/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajb413/subscriptions",
      "organizations_url": "https://api.github.com/users/ajb413/orgs",
      "repos_url": "https://api.github.com/users/ajb413/repos",
      "events_url": "https://api.github.com/users/ajb413/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajb413/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-06-13T21:36:07Z",
    "updated_at": "2021-06-13T21:36:07Z",
    "author_association": "NONE",
    "body": "> The cli does `hre.run(\"node\")` internally. I suspect you are not waiting for the RPC server to launch and be ready to accept connections. It takes a few millis. Take a look at how the `node` task does it.\r\n\r\nHow long should I wait? Is 5 seconds too brief? https://github.com/compound-finance/compound-js/blob/hardhat-tests/test/index.js#L40",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/860273398/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/860586328",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/1534#issuecomment-860586328",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1534",
    "id": 860586328,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg2MDU4NjMyOA==",
    "user": {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-06-14T10:43:57Z",
    "updated_at": "2021-06-14T10:43:57Z",
    "author_association": "MEMBER",
    "body": "@ajb413 I haven't been able to look into this again, but something you can try is using the node subtask, which gives you a server instance. That way you'll have better control over what's going on. It's used like this:\r\n\r\n```js\r\nconst { TASK_NODE_CREATE_SERVER } = require(\"hardhat/builtin-tasks/task-names\");\r\n\r\nconst server = await hre.run(TASK_NODE_CREATE_SERVER, {\r\n  hostname: \"localhost\",\r\n  port: 8545,\r\n  provider: hre.network.provider,\r\n});\r\n\r\nawait server.listen()\r\n\r\n// server is ready here\r\n\r\nawait server.close()\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/860586328/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/860856492",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/1534#issuecomment-860856492",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1534",
    "id": 860856492,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg2MDg1NjQ5Mg==",
    "user": {
      "login": "ajb413",
      "id": 5566172,
      "node_id": "MDQ6VXNlcjU1NjYxNzI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5566172?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajb413",
      "html_url": "https://github.com/ajb413",
      "followers_url": "https://api.github.com/users/ajb413/followers",
      "following_url": "https://api.github.com/users/ajb413/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajb413/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajb413/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajb413/subscriptions",
      "organizations_url": "https://api.github.com/users/ajb413/orgs",
      "repos_url": "https://api.github.com/users/ajb413/repos",
      "events_url": "https://api.github.com/users/ajb413/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajb413/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-06-14T17:21:59Z",
    "updated_at": "2021-06-14T17:21:59Z",
    "author_association": "NONE",
    "body": "@fvictorio Hi Franco, thank you for continuing to help me out debugging this. I tried this too and I am still seeing the same error.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/860856492/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/864250820",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/1534#issuecomment-864250820",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1534",
    "id": 864250820,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg2NDI1MDgyMA==",
    "user": {
      "login": "ajb413",
      "id": 5566172,
      "node_id": "MDQ6VXNlcjU1NjYxNzI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5566172?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajb413",
      "html_url": "https://github.com/ajb413",
      "followers_url": "https://api.github.com/users/ajb413/followers",
      "following_url": "https://api.github.com/users/ajb413/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajb413/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajb413/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajb413/subscriptions",
      "organizations_url": "https://api.github.com/users/ajb413/orgs",
      "repos_url": "https://api.github.com/users/ajb413/repos",
      "events_url": "https://api.github.com/users/ajb413/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajb413/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-06-18T20:09:31Z",
    "updated_at": "2021-06-18T20:09:31Z",
    "author_association": "NONE",
    "body": "@alcuadrado @fvictorio I've tried several things, one of which is converting all the tests and config to Typescript. I am suspicious of the injected hre.ethers vs importing normal ethers. I think that perhaps there is something fishy in there? Do you have any suggestions for me to dig in debugging this issue?\r\n\r\nAll of these tests pass normally if I use ganache core (with the exception of one, which is a completely unrelated ganache bug - which is also the main reason I switched to hardhat).",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/864250820/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/864562061",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/1534#issuecomment-864562061",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1534",
    "id": 864562061,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg2NDU2MjA2MQ==",
    "user": {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-06-20T14:18:35Z",
    "updated_at": "2021-06-20T14:18:35Z",
    "author_association": "MEMBER",
    "body": "Hey @ajb413, sorry, I haven't had time to look into this yet, but I'll try to do it this week.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/864562061/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/866264568",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/1534#issuecomment-866264568",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1534",
    "id": 866264568,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg2NjI2NDU2OA==",
    "user": {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-06-22T19:18:44Z",
    "updated_at": "2021-06-22T19:18:44Z",
    "author_association": "MEMBER",
    "body": "Hey @ajb413, sorry again for not being able to look into this before. I think I see what your issue is.\r\n\r\nYou are creating the `Compound` object here:\r\n\r\nhttps://github.com/compound-finance/compound-js/blob/99c7e5d9a72daa2704b8dfda036e808112930787/test/cToken.test.js#L12\r\n\r\nThe function exported by that module is called by this `describe`:\r\n\r\nhttps://github.com/compound-finance/compound-js/blob/99c7e5d9a72daa2704b8dfda036e808112930787/test/index.js#L47\r\n\r\nAnd the body of a `describe` is called before the `before` hooks are called. And since the `Compound` constructor does this:\r\n\r\nhttps://github.com/compound-finance/compound-js/blob/99c7e5d9a72daa2704b8dfda036e808112930787/src/index.ts#L76\r\n\r\nThen the `net_version` RPC method is called before the node is initialized.\r\n\r\nMy guess is that moving the creation of the `Compound` instances to a `before` hook should fix this.\r\n\r\nI'm going to close this now since it doesn't seem to be a problem with Hardhat itself, but please re-open if you think it is.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/866264568/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/866363499",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/1534#issuecomment-866363499",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1534",
    "id": 866363499,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg2NjM2MzQ5OQ==",
    "user": {
      "login": "ajb413",
      "id": 5566172,
      "node_id": "MDQ6VXNlcjU1NjYxNzI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5566172?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajb413",
      "html_url": "https://github.com/ajb413",
      "followers_url": "https://api.github.com/users/ajb413/followers",
      "following_url": "https://api.github.com/users/ajb413/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajb413/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajb413/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajb413/subscriptions",
      "organizations_url": "https://api.github.com/users/ajb413/orgs",
      "repos_url": "https://api.github.com/users/ajb413/repos",
      "events_url": "https://api.github.com/users/ajb413/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajb413/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-06-22T21:56:14Z",
    "updated_at": "2021-06-22T21:56:14Z",
    "author_association": "NONE",
    "body": "Nailed it! Thank you so much for your help! I did not suspect that that mattered. I made that change and now it works.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/866363499/reactions",
      "total_count": 3,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 3,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
