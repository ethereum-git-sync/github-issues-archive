{
  "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1411",
  "repository_url": "https://api.github.com/repos/NomicFoundation/hardhat",
  "labels_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1411/labels{/name}",
  "comments_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1411/comments",
  "events_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1411/events",
  "html_url": "https://github.com/NomicFoundation/hardhat/issues/1411",
  "id": 862454668,
  "node_id": "MDU6SXNzdWU4NjI0NTQ2Njg=",
  "number": 1411,
  "title": "Smart contracts lose state when called by other contracts",
  "user": {
    "login": "MortenTobiasNielsen",
    "id": 48355480,
    "node_id": "MDQ6VXNlcjQ4MzU1NDgw",
    "avatar_url": "https://avatars.githubusercontent.com/u/48355480?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/MortenTobiasNielsen",
    "html_url": "https://github.com/MortenTobiasNielsen",
    "followers_url": "https://api.github.com/users/MortenTobiasNielsen/followers",
    "following_url": "https://api.github.com/users/MortenTobiasNielsen/following{/other_user}",
    "gists_url": "https://api.github.com/users/MortenTobiasNielsen/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/MortenTobiasNielsen/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/MortenTobiasNielsen/subscriptions",
    "organizations_url": "https://api.github.com/users/MortenTobiasNielsen/orgs",
    "repos_url": "https://api.github.com/users/MortenTobiasNielsen/repos",
    "events_url": "https://api.github.com/users/MortenTobiasNielsen/events{/privacy}",
    "received_events_url": "https://api.github.com/users/MortenTobiasNielsen/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": true,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2021-04-20T06:15:38Z",
  "updated_at": "2022-11-18T18:48:42Z",
  "closed_at": "2021-04-20T18:25:36Z",
  "author_association": "NONE",
  "active_lock_reason": "resolved",
  "body": "It seems like contracts loss state when they are called from other contracts (or maybe I am just doing it wrong)\r\n\r\nI have created an example of the problem as simple as I could in this repo: [https://github.com/MortenTobiasNielsen/hardhat-bug-report](url)\r\n\r\n1. Clone the repo\r\n2. npm install\r\n3. npx hardhat test\r\n\r\nThe value of a variable called test1 will then be printed for each step. It will be set for all calls made directly to \"Token2\", but when a call is made to \"Token1\" which then call \"Token2\" then the variable is no longer set. \r\n\r\n<img width=\"391\" alt=\"Error\" src=\"https://user-images.githubusercontent.com/48355480/115345956-d16f1980-a1af-11eb-805c-14f197aa784f.png\">\r\n\r\n",
  "closed_by": {
    "login": "alcuadrado",
    "id": 176499,
    "node_id": "MDQ6VXNlcjE3NjQ5OQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/176499?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/alcuadrado",
    "html_url": "https://github.com/alcuadrado",
    "followers_url": "https://api.github.com/users/alcuadrado/followers",
    "following_url": "https://api.github.com/users/alcuadrado/following{/other_user}",
    "gists_url": "https://api.github.com/users/alcuadrado/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/alcuadrado/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/alcuadrado/subscriptions",
    "organizations_url": "https://api.github.com/users/alcuadrado/orgs",
    "repos_url": "https://api.github.com/users/alcuadrado/repos",
    "events_url": "https://api.github.com/users/alcuadrado/events{/privacy}",
    "received_events_url": "https://api.github.com/users/alcuadrado/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1411/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1411/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/823504504",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/1411#issuecomment-823504504",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1411",
    "id": 823504504,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgyMzUwNDUwNA==",
    "user": {
      "login": "alcuadrado",
      "id": 176499,
      "node_id": "MDQ6VXNlcjE3NjQ5OQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/176499?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alcuadrado",
      "html_url": "https://github.com/alcuadrado",
      "followers_url": "https://api.github.com/users/alcuadrado/followers",
      "following_url": "https://api.github.com/users/alcuadrado/following{/other_user}",
      "gists_url": "https://api.github.com/users/alcuadrado/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alcuadrado/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alcuadrado/subscriptions",
      "organizations_url": "https://api.github.com/users/alcuadrado/orgs",
      "repos_url": "https://api.github.com/users/alcuadrado/repos",
      "events_url": "https://api.github.com/users/alcuadrado/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alcuadrado/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-04-20T18:25:36Z",
    "updated_at": "2021-04-20T18:25:36Z",
    "author_association": "MEMBER",
    "body": "Hey @MortenTobiasNielsen, this is working as expected.\r\n\r\nThe address you hardcoded in `Token1.sol` (`0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512`) is only valid during the first test. In the second one, token2 ends up in a different address because the account that deploys it has a different nonce.\r\n\r\nLet us know if you have any other problem.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/823504504/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/823551369",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/1411#issuecomment-823551369",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1411",
    "id": 823551369,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgyMzU1MTM2OQ==",
    "user": {
      "login": "MortenTobiasNielsen",
      "id": 48355480,
      "node_id": "MDQ6VXNlcjQ4MzU1NDgw",
      "avatar_url": "https://avatars.githubusercontent.com/u/48355480?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MortenTobiasNielsen",
      "html_url": "https://github.com/MortenTobiasNielsen",
      "followers_url": "https://api.github.com/users/MortenTobiasNielsen/followers",
      "following_url": "https://api.github.com/users/MortenTobiasNielsen/following{/other_user}",
      "gists_url": "https://api.github.com/users/MortenTobiasNielsen/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MortenTobiasNielsen/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MortenTobiasNielsen/subscriptions",
      "organizations_url": "https://api.github.com/users/MortenTobiasNielsen/orgs",
      "repos_url": "https://api.github.com/users/MortenTobiasNielsen/repos",
      "events_url": "https://api.github.com/users/MortenTobiasNielsen/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MortenTobiasNielsen/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-04-20T19:41:25Z",
    "updated_at": "2021-04-20T19:41:25Z",
    "author_association": "NONE",
    "body": "Hey @alcuadrado, \r\n\r\nThanks for the response. I can see that if I move the contract address check down into the transferFrom check, then it works. I am though a little in doubt as to why that happens. Is this correctly understood?:\r\n\r\n- In the first test a smart contract for token2 is deployed with address \"0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512\" and the check therefore succeed. \r\n- In the second test a smart contract for token2 is deployed with another address. Therefore no smart contract with the address \"0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512\" is available when \"interactWithToken2\" is called and a new contract of token2 is silently being deployed to accommodate for this call to that address?\r\n\r\nThat got a little confusing, but I hope it is understandable. :)",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/823551369/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/823690886",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/1411#issuecomment-823690886",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1411",
    "id": 823690886,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgyMzY5MDg4Ng==",
    "user": {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-04-21T00:30:05Z",
    "updated_at": "2021-04-21T00:30:05Z",
    "author_association": "MEMBER",
    "body": "@MortenTobiasNielsen I think what you are missing is the fact that `beforeEach` is called before each `it` test. So this is what is happening:\r\n\r\n1. Your `beforeEach` is called. `token2` is deployed in the address that you expect\r\n2. The first `it` is executed and it passes\r\n3. `beforeEach` is called again, and token2 now points to a new deployed contract\r\n4. The second `it` is called, and it assumes that `token2` is in certain address. But you are doing the `approve` call with the second deploy of `Token2`, and therefore the function fails.\r\n\r\nDoes that make sense?",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/823690886/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/823771679",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/1411#issuecomment-823771679",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1411",
    "id": 823771679,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgyMzc3MTY3OQ==",
    "user": {
      "login": "MortenTobiasNielsen",
      "id": 48355480,
      "node_id": "MDQ6VXNlcjQ4MzU1NDgw",
      "avatar_url": "https://avatars.githubusercontent.com/u/48355480?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MortenTobiasNielsen",
      "html_url": "https://github.com/MortenTobiasNielsen",
      "followers_url": "https://api.github.com/users/MortenTobiasNielsen/followers",
      "following_url": "https://api.github.com/users/MortenTobiasNielsen/following{/other_user}",
      "gists_url": "https://api.github.com/users/MortenTobiasNielsen/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MortenTobiasNielsen/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MortenTobiasNielsen/subscriptions",
      "organizations_url": "https://api.github.com/users/MortenTobiasNielsen/orgs",
      "repos_url": "https://api.github.com/users/MortenTobiasNielsen/repos",
      "events_url": "https://api.github.com/users/MortenTobiasNielsen/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MortenTobiasNielsen/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-04-21T04:43:48Z",
    "updated_at": "2021-04-21T04:43:48Z",
    "author_association": "NONE",
    "body": "Hey @fvictorio , \r\n\r\nThanks for the elaboration. I thought that every `it` created a new environment and each run-through therefore were \"clean\" - but it seems like the environment stays the same. So in the second `it` `token1` is calling the first deployment of `token2` when `interactWithToken2` is called. \r\n\r\nI think I got it now - thanks a lot for your time @alcuadrado and @fvictorio 👍 ",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/823771679/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/824034797",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/1411#issuecomment-824034797",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1411",
    "id": 824034797,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgyNDAzNDc5Nw==",
    "user": {
      "login": "alcuadrado",
      "id": 176499,
      "node_id": "MDQ6VXNlcjE3NjQ5OQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/176499?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alcuadrado",
      "html_url": "https://github.com/alcuadrado",
      "followers_url": "https://api.github.com/users/alcuadrado/followers",
      "following_url": "https://api.github.com/users/alcuadrado/following{/other_user}",
      "gists_url": "https://api.github.com/users/alcuadrado/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alcuadrado/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alcuadrado/subscriptions",
      "organizations_url": "https://api.github.com/users/alcuadrado/orgs",
      "repos_url": "https://api.github.com/users/alcuadrado/repos",
      "events_url": "https://api.github.com/users/alcuadrado/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alcuadrado/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-04-21T12:51:26Z",
    "updated_at": "2021-04-21T12:51:26Z",
    "author_association": "MEMBER",
    "body": "We don't do anything silently, Hardhat, in general, tries to be as transparent as possible with its users. \r\n\r\nWhat is happening is that the state of the network is shared between tests. Just like in normal unit tests, you need to keep that in mind to make your tests independent from each other. You can think of the network as a global variable that gets mutated with each tx.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/824034797/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
