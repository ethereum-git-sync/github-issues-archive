{
  "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/4103",
  "repository_url": "https://api.github.com/repos/NomicFoundation/hardhat",
  "labels_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/4103/labels{/name}",
  "comments_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/4103/comments",
  "events_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/4103/events",
  "html_url": "https://github.com/NomicFoundation/hardhat/issues/4103",
  "id": 1787193863,
  "node_id": "I_kwDOB7jojM5qhmoH",
  "number": 4103,
  "title": "Tests work with 2.10.2 but exactly one test fails with 2.11.0 (\"SafeERC20: low-level call failed\")",
  "user": {
    "login": "andersaamodt",
    "id": 8476996,
    "node_id": "MDQ6VXNlcjg0NzY5OTY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/8476996?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/andersaamodt",
    "html_url": "https://github.com/andersaamodt",
    "followers_url": "https://api.github.com/users/andersaamodt/followers",
    "following_url": "https://api.github.com/users/andersaamodt/following{/other_user}",
    "gists_url": "https://api.github.com/users/andersaamodt/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/andersaamodt/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/andersaamodt/subscriptions",
    "organizations_url": "https://api.github.com/users/andersaamodt/orgs",
    "repos_url": "https://api.github.com/users/andersaamodt/repos",
    "events_url": "https://api.github.com/users/andersaamodt/events{/privacy}",
    "received_events_url": "https://api.github.com/users/andersaamodt/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 2474207618,
      "node_id": "MDU6TGFiZWwyNDc0MjA3NjE4",
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/labels/status:needs-more-info",
      "name": "status:needs-more-info",
      "color": "0E8A16",
      "default": false,
      "description": "There's not enough information to start working on this issue"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "schaable",
    "id": 1165424,
    "node_id": "MDQ6VXNlcjExNjU0MjQ=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1165424?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/schaable",
    "html_url": "https://github.com/schaable",
    "followers_url": "https://api.github.com/users/schaable/followers",
    "following_url": "https://api.github.com/users/schaable/following{/other_user}",
    "gists_url": "https://api.github.com/users/schaable/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/schaable/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/schaable/subscriptions",
    "organizations_url": "https://api.github.com/users/schaable/orgs",
    "repos_url": "https://api.github.com/users/schaable/repos",
    "events_url": "https://api.github.com/users/schaable/events{/privacy}",
    "received_events_url": "https://api.github.com/users/schaable/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "schaable",
      "id": 1165424,
      "node_id": "MDQ6VXNlcjExNjU0MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1165424?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/schaable",
      "html_url": "https://github.com/schaable",
      "followers_url": "https://api.github.com/users/schaable/followers",
      "following_url": "https://api.github.com/users/schaable/following{/other_user}",
      "gists_url": "https://api.github.com/users/schaable/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/schaable/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/schaable/subscriptions",
      "organizations_url": "https://api.github.com/users/schaable/orgs",
      "repos_url": "https://api.github.com/users/schaable/repos",
      "events_url": "https://api.github.com/users/schaable/events{/privacy}",
      "received_events_url": "https://api.github.com/users/schaable/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 10,
  "created_at": "2023-07-04T05:48:44Z",
  "updated_at": "2023-08-23T10:27:49Z",
  "closed_at": "2023-08-23T10:27:41Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Version of Hardhat\r\n\r\n2.11.0\r\n\r\n### What happened?\r\n\r\nWith Hardhat 2.10.2, all 70 of my tests succeed. But when I upgrade Hardhat one version to 2.11.0, exactly one test fails. The line that is reverting is a call to safeTransferFrom OpenZeppelin's SafeERC20 in my contract. It throws a \"SafeERC20: low-level call failed\" error which is vague but usually indicates a gas problem. I already checked every possible assumption and the contract has sufficient gas.\r\n\r\nIs there anything that could have changed from version 2.10.2 to version 2.11.0 that could have introduced this bug, or revealed a bug already existing in my contract? I need to run this bug down because it could be a problem in the contract that is being revealed by some change in that hardhat version. (Versions after 2.11.0 also have the same error).\r\n\r\n### Minimal reproduction steps\r\n\r\n1. Install Hardhat v2.11.0.\r\n2. With solidity version 0.8.2, in a contract, run SafeERC20.safeTransferFrom(IERC20(tokenContract), _msgSender(), address(this), amountOfTokens) (with appropriate allowance set beforehand and gas and tokens in wallets as appropriate for transfering).\r\n3. Call fails with \"SafeERC20: low-level call failed\".\r\n4. Repeating steps with v2.10.2, the same line succeeds.\r\n\r\n### Search terms\r\n\r\nHardhat SafeERC20 OpenZeppelin",
  "closed_by": {
    "login": "fvictorio",
    "id": 417134,
    "node_id": "MDQ6VXNlcjQxNzEzNA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/fvictorio",
    "html_url": "https://github.com/fvictorio",
    "followers_url": "https://api.github.com/users/fvictorio/followers",
    "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
    "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
    "organizations_url": "https://api.github.com/users/fvictorio/orgs",
    "repos_url": "https://api.github.com/users/fvictorio/repos",
    "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
    "received_events_url": "https://api.github.com/users/fvictorio/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/4103/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/4103/timeline",
  "performed_via_github_app": null,
  "state_reason": "not_planned"
}
[
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1619575963",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/4103#issuecomment-1619575963",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/4103",
    "id": 1619575963,
    "node_id": "IC_kwDOB7jojM5giMSb",
    "user": {
      "login": "andersaamodt",
      "id": 8476996,
      "node_id": "MDQ6VXNlcjg0NzY5OTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8476996?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/andersaamodt",
      "html_url": "https://github.com/andersaamodt",
      "followers_url": "https://api.github.com/users/andersaamodt/followers",
      "following_url": "https://api.github.com/users/andersaamodt/following{/other_user}",
      "gists_url": "https://api.github.com/users/andersaamodt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/andersaamodt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/andersaamodt/subscriptions",
      "organizations_url": "https://api.github.com/users/andersaamodt/orgs",
      "repos_url": "https://api.github.com/users/andersaamodt/repos",
      "events_url": "https://api.github.com/users/andersaamodt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/andersaamodt/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-04T06:24:54Z",
    "updated_at": "2023-07-04T06:24:54Z",
    "author_association": "NONE",
    "body": "Maybe it could be something in Solidity or a standard that Hardhat implements that changed between those versions?",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1619575963/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1620731501",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/4103#issuecomment-1620731501",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/4103",
    "id": 1620731501,
    "node_id": "IC_kwDOB7jojM5gmmZt",
    "user": {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-04T20:51:29Z",
    "updated_at": "2023-07-04T20:51:29Z",
    "author_association": "MEMBER",
    "body": "The first thing that comes to mind is that the latest versions of Hardhat change the default hardfork that is used, although I don't know in this particular case why a tx would start succeeding.\r\n\r\n@andersaamodt any chance you can create a complete (but minimal) reproduction repo? I'm really curious about this but I'm not sure I'll be able to reproduce it with your instructions.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1620731501/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1621136271",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/4103#issuecomment-1621136271",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/4103",
    "id": 1621136271,
    "node_id": "IC_kwDOB7jojM5goJOP",
    "user": {
      "login": "andersaamodt",
      "id": 8476996,
      "node_id": "MDQ6VXNlcjg0NzY5OTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8476996?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/andersaamodt",
      "html_url": "https://github.com/andersaamodt",
      "followers_url": "https://api.github.com/users/andersaamodt/followers",
      "following_url": "https://api.github.com/users/andersaamodt/following{/other_user}",
      "gists_url": "https://api.github.com/users/andersaamodt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/andersaamodt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/andersaamodt/subscriptions",
      "organizations_url": "https://api.github.com/users/andersaamodt/orgs",
      "repos_url": "https://api.github.com/users/andersaamodt/repos",
      "events_url": "https://api.github.com/users/andersaamodt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/andersaamodt/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-05T06:54:05Z",
    "updated_at": "2023-07-05T06:54:05Z",
    "author_association": "NONE",
    "body": "The forking is specified in hardhat.config.js in networks.hardhat.forking.url, so the default fork should affect it, right? I will see about getting a minimal reproduction repo (or if very short will just post the snippet here). Is there any way to see the log output of the simulated network that is set up when the tests are run? I am not manually launching the hardhat node, so I don't know where the output is. If I could see the log output on the hardhat node side when it crashes, that might help debug.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1621136271/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1624010699",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/4103#issuecomment-1624010699",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/4103",
    "id": 1624010699,
    "node_id": "IC_kwDOB7jojM5gzG_L",
    "user": {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-06T17:00:17Z",
    "updated_at": "2023-07-06T17:00:17Z",
    "author_association": "MEMBER",
    "body": "> If I could see the log output on the hardhat node side when it crashes, that might help debug.\r\n\r\nThe Hardhat node uses the same configuration as the in-process Hardhat network, so you can just run `hh node` in some terminal and then use `--network localhost` in another and you should get a similar result than the one you get by just running your task without a network.\r\n\r\n> I will see about getting a minimal reproduction repo (or if very short will just post the snippet here).\r\n\r\nThank you! That would be great.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1624010699/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1651129301",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/4103#issuecomment-1651129301",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/4103",
    "id": 1651129301,
    "node_id": "IC_kwDOB7jojM5iajvV",
    "user": {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-26T07:26:32Z",
    "updated_at": "2023-07-26T07:26:32Z",
    "author_association": "MEMBER",
    "body": "Hey @andersaamodt, were you able to make that minimal reproduction?",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1651129301/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1667184475",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/4103#issuecomment-1667184475",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/4103",
    "id": 1667184475,
    "node_id": "IC_kwDOB7jojM5jXzdb",
    "user": {
      "login": "andersaamodt",
      "id": 8476996,
      "node_id": "MDQ6VXNlcjg0NzY5OTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8476996?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/andersaamodt",
      "html_url": "https://github.com/andersaamodt",
      "followers_url": "https://api.github.com/users/andersaamodt/followers",
      "following_url": "https://api.github.com/users/andersaamodt/following{/other_user}",
      "gists_url": "https://api.github.com/users/andersaamodt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/andersaamodt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/andersaamodt/subscriptions",
      "organizations_url": "https://api.github.com/users/andersaamodt/orgs",
      "repos_url": "https://api.github.com/users/andersaamodt/repos",
      "events_url": "https://api.github.com/users/andersaamodt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/andersaamodt/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-08-07T04:53:59Z",
    "updated_at": "2023-08-07T04:55:35Z",
    "author_association": "NONE",
    "body": "Thank you so much for your patience. I did isolate the bug. This contract and the corresponding test work on hardhat 2.10.2 but not on hardhat 2.11.0 and later, it throws \"SafeERC20: low-level call failed\".\r\n\r\ncontracts/TokenMover.js\r\n\r\n```\r\npragma solidity 0.8.2;\r\npragma abicoder v2;\r\n\r\nimport '@openzeppelin/contracts/token/ERC20/ERC20.sol';\r\nimport '@openzeppelin/contracts/token/ERC20/utils/SafeERC20.sol';\r\nimport '@openzeppelin/contracts/token/ERC20/IERC20.sol';\r\n\r\ncontract TokenMover is ERC20 {\r\n\tconstructor() ERC20(\"TokenMover\", \"TM\") {\r\n\t}\r\n\t\r\n\tfunction moveTokens(uint256 tokenAmount, address tokenContract) external {\r\n\t\tSafeERC20.safeTransferFrom(IERC20(tokenContract), msg.sender, address(this), tokenAmount);\r\n\t}\r\n}\r\n```\r\n\r\ntest/verify-contract.js\r\n\r\n```\r\nconst chai = require(\"chai\")\r\nconst { expect } = chai\r\nconst { ethers, waffle, } = require(\"hardhat\")\r\n\r\n// Enable and inject BN dependency\r\nchai.use(require(\"chai-bn\")(ethers.BigNumber))\r\n\r\n// These wallet addresses are real addresses on the Ethereum mainnet\r\nconst SENDING_WALLET = \"0xDBca354Aa9D55D9BB2D3588ceCb43A56eb2D0057\"\r\nconst WBTC_CONTRACT = \"0x2260fac5e5542a773aa44fbcfedf7c193bc2c599\"\r\n\r\n// Custom suite of unit tests follows\r\ndescribe(\"Verifying contract\", function () {\r\n    let tokenMoverContract\r\n    let deployAddress\r\n    let myAccount\r\n    let myAddress\r\n    let secondAddress\r\n   \r\n    describe(\"Test that fails on version 2.11.0 and later\", function () {\r\n        it(\"Should transfer some WBTC\", async function () {\r\n            // Test for correct block number\r\n            const blockNumber = await ethers.provider.getBlockNumber()\r\n            expect(blockNumber).to.equal(12548539)\r\n\r\n            // Deploy the contract\r\n            tokenMoverContract = await ethers.deployContract(\"TokenMover\", [], {\r\n                unsafeAllow: [\"delegatecall\"],\r\n            })\r\n\r\n            const deployed = await tokenMoverContract.deployed()\r\n            deployAddress = deployed.address\r\n            console.log(\"\\tContract deployed to\", deployAddress)\r\n            expect(deployAddress).to.exist\r\n\r\n            // Set up variables\r\n            const accounts = await ethers.getSigners()\r\n            myAccount = accounts[0]\r\n            myAddress = myAccount.address\r\n            const mySigner = await ethers.provider.getSigner(myAddress)\r\n            secondAddress = accounts[2].address\r\n            console.log(\"\\tDeployer's address is\", myAddress)\r\n           \r\n            // Check contract ETH balance\r\n            let contractWeiBefore = await ethers.provider.getBalance(myAddress)\r\n            let contractEthBefore = ethers.utils.formatEther(contractWeiBefore)\r\n            console.log(\"CONTRACT ITSELF HAS \", ethers.utils.commify(contractEthBefore.toString()), \"ETH\")\r\n           \r\n            // Make sure sending wallet has enough ETH to call the moveTokens function\r\n            let testWeiBefore = await ethers.provider.getBalance(SENDING_WALLET)\r\n            let testEthBefore = ethers.utils.formatEther(testWeiBefore)\r\n            console.log(\"SENDING_WALLET HAS \", ethers.utils.commify(testEthBefore.toString()), \"ETH\")\r\n\r\n            // Send gas money to SENDING_WALLET\r\n            await mySigner.sendTransaction({\r\n                to: SENDING_WALLET,\r\n                value: ethers.BigNumber.from(\"100000000000000000000\"),\r\n            })\r\n           \r\n            let testWei = await ethers.provider.getBalance(SENDING_WALLET)\r\n            let testEth = ethers.utils.formatEther(testWei)\r\n           \r\n            expect(testWei).to.be.a.bignumber.above(\r\n                ethers.BigNumber.from(\"100000000000000000000\")\r\n            )\r\n           \r\n            // Check ETH balance of SENDING_WALLET\r\n            await hre.network.provider.request({\r\n                method: \"hardhat_impersonateAccount\",\r\n                params: [SENDING_WALLET],\r\n            })\r\n            const sendingWalletSigner = await ethers.provider.getSigner(SENDING_WALLET)\r\n            expect(sendingWalletSigner._address).to.equal(SENDING_WALLET)\r\n            const abi = [\r\n                \"function balanceOf(address account) public view returns (uint256)\",\r\n                \"function approve(address _spender, uint256 _value) public returns (bool success)\",\r\n            ]\r\n           \r\n            let beforeWalletWei = await ethers.provider.getBalance(SENDING_WALLET)\r\n            let beforeWalletEth = ethers.utils.formatEther(beforeWalletWei)\r\n            console.log(\r\n                \"\\tETH balance of WBTC Test wallet before moveTokens is\",\r\n                ethers.utils.commify(beforeWalletEth.toString()),\r\n                \"ETH\"\r\n            )\r\n           \r\n            // Check WBTC balance of SENDING_WALLET\r\n            let wbtcSenderWallet = await ethers.getContractAt(abi, WBTC_CONTRACT, sendingWalletSigner)\r\n            const wbtcBefore = await wbtcSenderWallet.balanceOf(SENDING_WALLET)\r\n            const tokenBefore = await tokenMoverContract.balanceOf(\r\n                SENDING_WALLET\r\n            )\r\n\r\n            console.log(\r\n                \"\\tWBTC balance of SENDING_WALLET before moveTokens is\",\r\n                ethers.utils.commify(wbtcBefore.toString()),\r\n                \"WBTC\"\r\n            )\r\n           \r\n            let beforeReserveWei = await ethers.provider.getBalance(\r\n                secondAddress\r\n            )\r\n            let beforeReserveEth = ethers.utils.formatEther(beforeReserveWei)\r\n\r\n            // Approve from SEND_WALLET to our contract\r\n            const maxApprove = \"9999999999999999999\"\r\n            wbtcSenderWallet.approve(deployAddress, maxApprove)\r\n\r\n            // Get a contract object with the SENDING_WALLET signer\r\n           \r\n            let sendingWalletContract = await ethers.getContractAt(\r\n                \"TokenMover\",\r\n                deployAddress,\r\n                sendingWalletSigner\r\n            )\r\n           \r\n            console.log(\"Address of loaded deployed contract is \", sendingWalletContract.address)\r\n            await sendingWalletContract.moveTokens(\r\n                ethers.BigNumber.from(\"88778\"),\r\n                WBTC_CONTRACT\r\n            )\r\n           \r\n            let afterWalletWei = await ethers.provider.getBalance(SENDING_WALLET)\r\n            const diffWalletWei = beforeWalletWei.sub(afterWalletWei)\r\n            let diffWalletEth = ethers.utils.formatEther(diffWalletWei)\r\n\r\n            console.log(\r\n                \"\\tETH balance of WBTC Test wallet after moveTokens decreased by\",\r\n                ethers.utils.commify(diffWalletEth.toString()),\r\n                \"ETH\"\r\n            )\r\n\r\n            const wbtcAfter = await wbtcSenderWallet.balanceOf(SENDING_WALLET)\r\n            expect(wbtcAfter).to.be.bignumber.below(wbtcBefore)\r\n\r\n            await hre.network.provider.request({\r\n                method: \"hardhat_stopImpersonatingAccount\",\r\n                params: [SENDING_WALLET],\r\n            })\r\n        })\r\n    })\r\n})\r\n```\r\n\r\nLet me know if you can replicate the bug with this code!",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1667184475/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1669868784",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/4103#issuecomment-1669868784",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/4103",
    "id": 1669868784,
    "node_id": "IC_kwDOB7jojM5jiCzw",
    "user": {
      "login": "schaable",
      "id": 1165424,
      "node_id": "MDQ6VXNlcjExNjU0MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1165424?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/schaable",
      "html_url": "https://github.com/schaable",
      "followers_url": "https://api.github.com/users/schaable/followers",
      "following_url": "https://api.github.com/users/schaable/following{/other_user}",
      "gists_url": "https://api.github.com/users/schaable/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/schaable/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/schaable/subscriptions",
      "organizations_url": "https://api.github.com/users/schaable/orgs",
      "repos_url": "https://api.github.com/users/schaable/repos",
      "events_url": "https://api.github.com/users/schaable/events{/privacy}",
      "received_events_url": "https://api.github.com/users/schaable/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-08-08T15:46:55Z",
    "updated_at": "2023-08-08T15:46:55Z",
    "author_association": "COLLABORATOR",
    "body": "Hi @andersaamodt,\r\n\r\nI tried to reproduce the issue using the code you provided for both versions, but the test fails with an assertion error in both cases. Can you share the repo either as a zip file or by pushing it to GitHub to investigate it further?",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1669868784/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1672541542",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/4103#issuecomment-1672541542",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/4103",
    "id": 1672541542,
    "node_id": "IC_kwDOB7jojM5jsPVm",
    "user": {
      "login": "andersaamodt",
      "id": 8476996,
      "node_id": "MDQ6VXNlcjg0NzY5OTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8476996?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/andersaamodt",
      "html_url": "https://github.com/andersaamodt",
      "followers_url": "https://api.github.com/users/andersaamodt/followers",
      "following_url": "https://api.github.com/users/andersaamodt/following{/other_user}",
      "gists_url": "https://api.github.com/users/andersaamodt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/andersaamodt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/andersaamodt/subscriptions",
      "organizations_url": "https://api.github.com/users/andersaamodt/orgs",
      "repos_url": "https://api.github.com/users/andersaamodt/repos",
      "events_url": "https://api.github.com/users/andersaamodt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/andersaamodt/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-08-10T04:37:51Z",
    "updated_at": "2023-08-10T04:37:51Z",
    "author_association": "NONE",
    "body": "Thanks so much.\r\n\r\nI think I reproduced the assertion you got. I am running from blockNumber=12548539 in hardhat.config.js. Maybe that wallet doesn't have WBTC in it anymore. Can you try using that blockNumber and see if it fixes the assertion you are getting?\r\n\r\nI have the above contract and verify code in a blank project, so hardhat.config.js would be the only other thing I haven't shared. If that blockNumber doesn't fix the assertion and let you reproduce the bug, let me know and I will set up a full exact repo!",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1672541542/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1673609134",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/4103#issuecomment-1673609134",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/4103",
    "id": 1673609134,
    "node_id": "IC_kwDOB7jojM5jwT-u",
    "user": {
      "login": "schaable",
      "id": 1165424,
      "node_id": "MDQ6VXNlcjExNjU0MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1165424?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/schaable",
      "html_url": "https://github.com/schaable",
      "followers_url": "https://api.github.com/users/schaable/followers",
      "following_url": "https://api.github.com/users/schaable/following{/other_user}",
      "gists_url": "https://api.github.com/users/schaable/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/schaable/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/schaable/subscriptions",
      "organizations_url": "https://api.github.com/users/schaable/orgs",
      "repos_url": "https://api.github.com/users/schaable/repos",
      "events_url": "https://api.github.com/users/schaable/events{/privacy}",
      "received_events_url": "https://api.github.com/users/schaable/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-08-10T17:18:32Z",
    "updated_at": "2023-08-10T17:18:32Z",
    "author_association": "COLLABORATOR",
    "body": "Hi @andersaamodt, thanks for the clarification. However, to avoid having to guess the details, it would be ideal if you could provide the full repo. That way, we can be more productive and address this faster.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1673609134/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1689707816",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/4103#issuecomment-1689707816",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/4103",
    "id": 1689707816,
    "node_id": "IC_kwDOB7jojM5ktuUo",
    "user": {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-08-23T10:27:41Z",
    "updated_at": "2023-08-23T10:27:49Z",
    "author_association": "MEMBER",
    "body": "Closing this for lack of response, happy to re-open it when a [minimal reproducible example](https://stackoverflow.com/help/minimal-reproducible-example) is available.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1689707816/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
