{
  "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/694",
  "repository_url": "https://api.github.com/repos/NomicFoundation/hardhat",
  "labels_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/694/labels{/name}",
  "comments_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/694/comments",
  "events_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/694/events",
  "html_url": "https://github.com/NomicFoundation/hardhat/issues/694",
  "id": 656422098,
  "node_id": "MDU6SXNzdWU2NTY0MjIwOTg=",
  "number": 694,
  "title": "bug: can't deploy to JSON-RPC network, where equivalent deployment via Remix and Truffle works",
  "user": {
    "login": "bguiz",
    "id": 1773785,
    "node_id": "MDQ6VXNlcjE3NzM3ODU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1773785?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/bguiz",
    "html_url": "https://github.com/bguiz",
    "followers_url": "https://api.github.com/users/bguiz/followers",
    "following_url": "https://api.github.com/users/bguiz/following{/other_user}",
    "gists_url": "https://api.github.com/users/bguiz/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/bguiz/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/bguiz/subscriptions",
    "organizations_url": "https://api.github.com/users/bguiz/orgs",
    "repos_url": "https://api.github.com/users/bguiz/repos",
    "events_url": "https://api.github.com/users/bguiz/events{/privacy}",
    "received_events_url": "https://api.github.com/users/bguiz/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": true,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2020-07-14T08:17:23Z",
  "updated_at": "2023-03-31T00:14:29Z",
  "closed_at": "2022-12-30T11:52:14Z",
  "author_association": "NONE",
  "active_lock_reason": "resolved",
  "body": "## Expected behaviour\r\n\r\n- `.getContractFactory()` succeeds\r\n- `.deploy()` succeeds\r\n- `.deployed()` succeeds\r\n\r\n## Actual Behaviour\r\n\r\n- `.getContractFactory()` succeeds\r\n- `.deploy()` succeeds\r\n- `.deployed()` fails\r\n\r\nThe error thrown comes from within ethers.js: https://github.com/ethers-io/ethers.js/blob/88c7eae/packages/providers/src.ts/formatter.ts#L237-L244\r\n... however, tracing up the stack trace, it appears to originate from the provider in some way.\r\n\r\nNote that this smart contract deploys successfully on the same network, using both Remix (with web3 provider from MetaMask). It also deploys successfully using Truffle. Here's the Truffle network config and deployment script, for reference:\r\n\r\n```\r\n  networks: {\r\n    regtest: {\r\n      host: '127.0.0.1',\r\n      port: 4444,\r\n      network_id: 33,\r\n      networkCheckTimeout: 1e3,\r\n    },\r\n  },\r\n```\r\n\r\n```\r\nconst Cars = artifacts.require(\"Cars\");\r\n\r\nmodule.exports = function(deployer) {\r\n  deployer.deploy(Cars);\r\n};\r\n```\r\n\r\n## Details\r\n\r\nNetwork configuration:\r\n\r\n```\r\n  networks: {\r\n    regtest: {\r\n      url: 'http://127.0.0.1:4444/',\r\n      chainId: 33,\r\n      timeout: 1e3,\r\n    },\r\n  },\r\n```\r\n\r\nDeployment script:\r\n\r\n```\r\nimport { ethers } from '@nomiclabs/buidler';\r\n\r\nasync function main() {\r\n  const carsFactory = await ethers.getContractFactory('Cars');\r\n  console.log('carsFactory', carsFactory);\r\n  const instance = await carsFactory.deploy();\r\n  console.log('instance', instance);\r\n  const result = await instance.deployed(); /// throws here\r\n  console.log('result', result);\r\n}\r\n\r\nmain()\r\n  .then(() => {\r\n    console.log('deployed');\r\n  })\r\n  .catch((ex) => {\r\n    console.error(ex);\r\n    process.exit(-1);\r\n  });\r\n```\r\n\r\nError:\r\n\r\n```\r\nError: invalid hash (argument=\"value\", value=\"0x01\", code=INVALID_ARGUMENT, version=providers/5.0.4)\r\n    at Logger.makeError (/home/bguiz/code/bguiz/buidler-trial/node_modules/@ethersproject/logger/lib/index.js:179:21)\r\n    at Logger.throwError (/home/bguiz/code/bguiz/buidler-trial/node_modules/@ethersproject/logger/lib/index.js:188:20)\r\n    at Logger.throwArgumentError (/home/bguiz/code/bguiz/buidler-trial/node_modules/@ethersproject/logger/lib/index.js:191:21)\r\n    at Formatter.hash (/home/bguiz/code/bguiz/buidler-trial/node_modules/@ethersproject/providers/lib/formatter.js:196:27)\r\n    at Object.root (/home/bguiz/code/bguiz/buidler-trial/node_modules/@ethersproject/providers/lib/formatter.js:361:20)\r\n    at Function.Formatter.check (/home/bguiz/code/bguiz/buidler-trial/node_modules/@ethersproject/providers/lib/formatter.js:342:40)\r\n    at Formatter.receipt (/home/bguiz/code/bguiz/buidler-trial/node_modules/@ethersproject/providers/lib/formatter.js:316:32)\r\n    at EthersProviderWrapper.<anonymous> (/home/bguiz/code/bguiz/buidler-trial/node_modules/@ethersproject/providers/lib/base-provider.js:1214:70)\r\n    at step (/home/bguiz/code/bguiz/buidler-trial/node_modules/@ethersproject/providers/lib/base-provider.js:46:23)\r\n    at Object.next (/home/bguiz/code/bguiz/buidler-trial/node_modules/@ethersproject/providers/lib/base-provider.js:27:53) {\r\n  reason: 'invalid hash',\r\n  code: 'INVALID_ARGUMENT',\r\n  argument: 'value',\r\n  value: '0x01',\r\n  checkKey: 'root',\r\n  checkValue: '0x01'\r\n}\r\nnpm ERR! code ELIFECYCLE\r\nnpm ERR! errno 255\r\nnpm ERR! buidler-trial@0.0.0 deploy-regtest: `buidler run --network regtest scripts/deploy.ts`\r\nnpm ERR! Exit status 255\r\nnpm ERR! \r\nnpm ERR! Failed at the buidler-trial@0.0.0 deploy-regtest script.\r\nnpm ERR! This is probably not a problem with npm. There is likely additional logging output above.\r\n```\r\n\r\n## Version\r\n\r\n```\r\n    \"@nomiclabs/buidler\": \"1.3.8\",\r\n    \"@nomiclabs/buidler-ethers\": \"2.0.0\",\r\n```",
  "closed_by": {
    "login": "fvictorio",
    "id": 417134,
    "node_id": "MDQ6VXNlcjQxNzEzNA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/fvictorio",
    "html_url": "https://github.com/fvictorio",
    "followers_url": "https://api.github.com/users/fvictorio/followers",
    "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
    "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
    "organizations_url": "https://api.github.com/users/fvictorio/orgs",
    "repos_url": "https://api.github.com/users/fvictorio/repos",
    "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
    "received_events_url": "https://api.github.com/users/fvictorio/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/694/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/694/timeline",
  "performed_via_github_app": null,
  "state_reason": "not_planned"
}
[
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/658095677",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/694#issuecomment-658095677",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/694",
    "id": 658095677,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY1ODA5NTY3Nw==",
    "user": {
      "login": "bguiz",
      "id": 1773785,
      "node_id": "MDQ6VXNlcjE3NzM3ODU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1773785?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bguiz",
      "html_url": "https://github.com/bguiz",
      "followers_url": "https://api.github.com/users/bguiz/followers",
      "following_url": "https://api.github.com/users/bguiz/following{/other_user}",
      "gists_url": "https://api.github.com/users/bguiz/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bguiz/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bguiz/subscriptions",
      "organizations_url": "https://api.github.com/users/bguiz/orgs",
      "repos_url": "https://api.github.com/users/bguiz/repos",
      "events_url": "https://api.github.com/users/bguiz/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bguiz/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-07-14T10:10:47Z",
    "updated_at": "2020-07-14T10:10:47Z",
    "author_association": "NONE",
    "body": "Did a bit more digging, and got a bit closer to the error, appears to be happening while validating the transaction receipt.\r\n\r\n\r\n\r\nhttps://github.com/ethers-io/ethers.js/blob/88c7eae/packages/providers/src.ts/formatter.ts#L382-L390 :\r\n\r\n```js\r\n    receipt(value: any): TransactionReceipt {\r\n        const result: TransactionReceipt = Formatter.check(this.formats.receipt, value);\r\n\r\n        if (value.status != null) {\r\n            result.byzantium = true;\r\n        }\r\n\r\n        return result;\r\n    }\r\n```\r\n\r\n... which then goes on to throw here:\r\nhttps://github.com/ethers-io/ethers.js/blob/88c7eae/packages/providers/src.ts/formatter.ts#L411-L424 : \r\n\r\n... in particular  at `root: Formatter.allowNull(hash),`\r\n\r\nhttps://github.com/ethers-io/ethers.js/blob/88c7eae/packages/providers/src.ts/formatter.ts#L99-L114 :\r\n\r\n```js\r\n        formats.receipt = {\r\n            to: Formatter.allowNull(this.address, null),\r\n            from: Formatter.allowNull(this.address, null),\r\n            contractAddress: Formatter.allowNull(address, null),\r\n            transactionIndex: number,\r\n            root: Formatter.allowNull(hash),\r\n            gasUsed: bigNumber,\r\n            logsBloom: Formatter.allowNull(data),// @TODO: should this be data?\r\n            blockHash: hash,\r\n            transactionHash: hash,\r\n            logs: Formatter.arrayOf(this.receiptLog.bind(this)),\r\n            blockNumber: number,\r\n            confirmations: Formatter.allowNull(number, null),\r\n            cumulativeGasUsed: bigNumber,\r\n            status: Formatter.allowNull(number)\r\n        };\r\n```\r\n\r\nwhich fails validation when the hash does not have a length of 32.\r\n\r\nBelow is the actual transaction receipt contains `root: '0x01',` - which is just 1 byte - and this is what causes it to throw.\r\n\r\n```js\r\n{\r\n  transactionHash: '0x207443dca7009383371745242e4a9cd4bf83f2ff70ddf0c827d27c8f02c5b28c',\r\n  transactionIndex: '0x0',\r\n  blockHash: '0x64f3a04bb67aea8684e1aea3f7673a5d6422cc018f592903490d61f6e456c507',\r\n  blockNumber: '0xb4c',\r\n  cumulativeGasUsed: '0xd93c0',\r\n  gasUsed: '0xd93c0',\r\n  contractAddress: '0xda7ce79725418f4f6e13bf5f520c89cec5f6a974',\r\n  logs: [],\r\n  from: '0xcd2a3d9f938e13cd947ec05abc7fe734df8dd826',\r\n  to: null,\r\n  root: '0x01',\r\n  status: '0x1',\r\n  logsBloom: '0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'\r\n}\r\n```\r\n\r\nI should probably mention that this network I'm connecting to is not Ethereum, but does have EVM compatibility and JSON-RPC compatibility, and that I can deploy this contract using other Ethereum tools (Remix+MetaMask, and Truffle).",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/658095677/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/658098484",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/694#issuecomment-658098484",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/694",
    "id": 658098484,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY1ODA5ODQ4NA==",
    "user": {
      "login": "bguiz",
      "id": 1773785,
      "node_id": "MDQ6VXNlcjE3NzM3ODU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1773785?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bguiz",
      "html_url": "https://github.com/bguiz",
      "followers_url": "https://api.github.com/users/bguiz/followers",
      "following_url": "https://api.github.com/users/bguiz/following{/other_user}",
      "gists_url": "https://api.github.com/users/bguiz/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bguiz/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bguiz/subscriptions",
      "organizations_url": "https://api.github.com/users/bguiz/orgs",
      "repos_url": "https://api.github.com/users/bguiz/repos",
      "events_url": "https://api.github.com/users/bguiz/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bguiz/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-07-14T10:17:29Z",
    "updated_at": "2020-07-14T10:17:29Z",
    "author_association": "NONE",
    "body": "Further digging within the geth source yields that the definition of `root` in the JSON-RPC response maps to `PostState` - https://github.com/ethereum/go-ethereum/blob/ce9a289/core/types/receipt.go#L49-L52  :  \r\n\r\n```go\r\n// Receipt represents the results of a transaction.\r\ntype Receipt struct {\r\n\t// Consensus fields: These fields are defined by the Yellow Paper\r\n\tPostState         []byte `json:\"root\"`\r\n```\r\n\r\nSo, unless I've misread something, it appears that the validation logic for transaction receipts appears to be too strict in this case.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/658098484/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1367878537",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/694#issuecomment-1367878537",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/694",
    "id": 1367878537,
    "node_id": "IC_kwDOB7jojM5RiCuJ",
    "user": {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-30T11:52:14Z",
    "updated_at": "2022-12-30T11:52:14Z",
    "author_association": "MEMBER",
    "body": "Hi, I'm checking old issues to see if they are still valid. My guess is that this one isn't and, if it is, it seems to be something related to ethers.js itself and not Hardhat?\r\n\r\nSo I'm going to tentatively close this. Please let us know if you disagree.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1367878537/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
