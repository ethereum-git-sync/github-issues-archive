{
  "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/659",
  "repository_url": "https://api.github.com/repos/NomicFoundation/hardhat",
  "labels_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/659/labels{/name}",
  "comments_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/659/comments",
  "events_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/659/events",
  "html_url": "https://github.com/NomicFoundation/hardhat/issues/659",
  "id": 644462143,
  "node_id": "MDU6SXNzdWU2NDQ0NjIxNDM=",
  "number": 659,
  "title": "improve evm_snaphost / evm_revert behavior",
  "user": {
    "login": "wighawag",
    "id": 790580,
    "node_id": "MDQ6VXNlcjc5MDU4MA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/790580?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/wighawag",
    "html_url": "https://github.com/wighawag",
    "followers_url": "https://api.github.com/users/wighawag/followers",
    "following_url": "https://api.github.com/users/wighawag/following{/other_user}",
    "gists_url": "https://api.github.com/users/wighawag/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/wighawag/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/wighawag/subscriptions",
    "organizations_url": "https://api.github.com/users/wighawag/orgs",
    "repos_url": "https://api.github.com/users/wighawag/repos",
    "events_url": "https://api.github.com/users/wighawag/events{/privacy}",
    "received_events_url": "https://api.github.com/users/wighawag/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 947230177,
      "node_id": "MDU6TGFiZWw5NDcyMzAxNzc=",
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/labels/status:blocked",
      "name": "status:blocked",
      "color": "0E8A16",
      "default": false,
      "description": "Blocked by other issues or external reasons"
    },
    {
      "id": 947232611,
      "node_id": "MDU6TGFiZWw5NDcyMzI2MTE=",
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/labels/type:feature",
      "name": "type:feature",
      "color": "FBCA04",
      "default": false,
      "description": "Feature request"
    },
    {
      "id": 4745762096,
      "node_id": "LA_kwDOB7jojM8AAAABGt6VMA",
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/labels/blocked-reason:needs-rethnet",
      "name": "blocked-reason:needs-rethnet",
      "color": "B60205",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2020-06-24T09:26:38Z",
  "updated_at": "2023-01-03T09:17:36Z",
  "closed_at": null,
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "current evm_snaphost / evm_revert is not intuitive and lead to optimization loss when used certain way\r\n\r\nlet say I run the following\r\n\r\n1. deploy contracts\r\n2. evm_snapshot => **S1** // save deployments to not need to reexecute\r\n3. run test 1\r\n4. evm_revert  S1 // revert back to **S1** to execute test 2 on clean deployment\r\n5. evm_snapshot => S2 // necessary because evm_revert delete its own snapshot\r\n6. run test 2\r\n7. evm_revert  S2 // revert back to **S1** (now saved as S2)  to execute test 3 on clean deployment\r\n8. evm_snapshot => S3 // necessary because evm_revert delete its own snapshot\r\n9. extra deployments for test 3 involving change to deployed contracts\r\n10. evm_snapshot => **S4** // save such new deployments\r\n11. run test 3\r\n12. evm_revert  S4 // revert back to **S4** to run test 4 in the same environment as test 3\r\n13. evm_snapshot => S5 // necessary because evm_revert delete its own snapshot\r\n14. run test 4\r\n15. evm_revert  S3 // revert back to **S1** (now saved as S3)  to execute test 5 on clean deployment\r\n16. evm_snapshot => S6 // necessary because evm_revert delete its own snapshot\r\n17. extra deployments for test 5 involving change to deployed contracts\r\n18. evm_snapshot => **S7** // save such new deployments\r\n19. run test 5\r\n20. evm_revert  S7 // revert back to **S7** to run test 6 in the same environment as test 5\r\n21. evm_snapshot => S8 // necessary because evm_revert delete its own snapshot\r\n22. run test 6\r\n23. evm_revert S5 // revert to **S4** (now saved as S5) to go back to test 3 environment  // THIS FAIL SILENTLY\r\n24. evm_snapshot => S6\r\n25. run test 7 // want to execute test in the same environment as test 3\r\n\r\nThe first issue is that `evm_revert` delete its own snapshot so I need to create a new one. This is not a big deal though\r\nBut the problem come when there is multiple interleaved snapshot\r\n\r\nstep 23 fails silently. this is because when `evm_revert` is executed in step 15 to go back to clean deployments, it delete snapshot S4 (now saved as S5) so while I can simply reexcute the new deployment as I did in step 9 I am missing the evm_snapshot optimization.\r\n\r\nIt would be great if snapshot are saved in a temporary fork, so they can be reused even if older snapshot where used.\r\n\r\nIn any case, when requesting a snapshot that has been deleted, the rpc method should return an error, instead of failing silently",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/659/reactions",
    "total_count": 1,
    "+1": 1,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/659/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/648832116",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/659#issuecomment-648832116",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/659",
    "id": 648832116,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY0ODgzMjExNg==",
    "user": {
      "login": "alcuadrado",
      "id": 176499,
      "node_id": "MDQ6VXNlcjE3NjQ5OQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/176499?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alcuadrado",
      "html_url": "https://github.com/alcuadrado",
      "followers_url": "https://api.github.com/users/alcuadrado/followers",
      "following_url": "https://api.github.com/users/alcuadrado/following{/other_user}",
      "gists_url": "https://api.github.com/users/alcuadrado/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alcuadrado/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alcuadrado/subscriptions",
      "organizations_url": "https://api.github.com/users/alcuadrado/orgs",
      "repos_url": "https://api.github.com/users/alcuadrado/repos",
      "events_url": "https://api.github.com/users/alcuadrado/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alcuadrado/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-06-24T13:49:05Z",
    "updated_at": "2020-06-24T13:49:05Z",
    "author_association": "MEMBER",
    "body": "This is really interesting @wighawag.\r\n\r\nRight now, the `evm_revert` method works exactly like in Ganache. I believe it was designed in this way because Truffle does a snapshot and revert on every `contract(..)` test function. \r\n\r\nMy worry about this is that it would lead to leaking a lot of memory, and it may also be slower. ",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/648832116/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/649034414",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/659#issuecomment-649034414",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/659",
    "id": 649034414,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY0OTAzNDQxNA==",
    "user": {
      "login": "wighawag",
      "id": 790580,
      "node_id": "MDQ6VXNlcjc5MDU4MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/790580?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/wighawag",
      "html_url": "https://github.com/wighawag",
      "followers_url": "https://api.github.com/users/wighawag/followers",
      "following_url": "https://api.github.com/users/wighawag/following{/other_user}",
      "gists_url": "https://api.github.com/users/wighawag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/wighawag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/wighawag/subscriptions",
      "organizations_url": "https://api.github.com/users/wighawag/orgs",
      "repos_url": "https://api.github.com/users/wighawag/repos",
      "events_url": "https://api.github.com/users/wighawag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/wighawag/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-06-24T19:52:09Z",
    "updated_at": "2020-06-24T19:52:09Z",
    "author_association": "CONTRIBUTOR",
    "body": "yes maybe it could be new rpc method, if perfect ganache compatibility is required with existing rpc\r\n\r\nRegarding memory leak, it would only happen if it was misused : you normally snapshot if you intend to revert.\r\nthe memory usage could simply be part of the things to know when using that feature.\r\n\r\nwe could also add `evm_delete_snapshot` or something like that if managing memory is required.\r\n\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/649034414/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/650566360",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/659#issuecomment-650566360",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/659",
    "id": 650566360,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY1MDU2NjM2MA==",
    "user": {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-06-27T14:14:47Z",
    "updated_at": "2020-06-27T14:14:47Z",
    "author_association": "MEMBER",
    "body": "> yes maybe it could be new rpc method, if perfect ganache compatibility is required with existing rpc\r\n\r\nCould this be done by adding an optional param to the method, and defaulting to the current behavior? I don't know if there are methods with optional params right now though.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/650566360/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/650635474",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/659#issuecomment-650635474",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/659",
    "id": 650635474,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY1MDYzNTQ3NA==",
    "user": {
      "login": "alcuadrado",
      "id": 176499,
      "node_id": "MDQ6VXNlcjE3NjQ5OQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/176499?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alcuadrado",
      "html_url": "https://github.com/alcuadrado",
      "followers_url": "https://api.github.com/users/alcuadrado/followers",
      "following_url": "https://api.github.com/users/alcuadrado/following{/other_user}",
      "gists_url": "https://api.github.com/users/alcuadrado/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alcuadrado/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alcuadrado/subscriptions",
      "organizations_url": "https://api.github.com/users/alcuadrado/orgs",
      "repos_url": "https://api.github.com/users/alcuadrado/repos",
      "events_url": "https://api.github.com/users/alcuadrado/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alcuadrado/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-06-27T21:50:15Z",
    "updated_at": "2020-06-27T21:50:15Z",
    "author_association": "MEMBER",
    "body": "Nice idea. There's plenty of methods with optional params.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/650635474/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/690985052",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/659#issuecomment-690985052",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/659",
    "id": 690985052,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY5MDk4NTA1Mg==",
    "user": {
      "login": "vnavascues",
      "id": 14769962,
      "node_id": "MDQ6VXNlcjE0NzY5OTYy",
      "avatar_url": "https://avatars.githubusercontent.com/u/14769962?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vnavascues",
      "html_url": "https://github.com/vnavascues",
      "followers_url": "https://api.github.com/users/vnavascues/followers",
      "following_url": "https://api.github.com/users/vnavascues/following{/other_user}",
      "gists_url": "https://api.github.com/users/vnavascues/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vnavascues/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vnavascues/subscriptions",
      "organizations_url": "https://api.github.com/users/vnavascues/orgs",
      "repos_url": "https://api.github.com/users/vnavascues/repos",
      "events_url": "https://api.github.com/users/vnavascues/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vnavascues/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-09-11T09:34:03Z",
    "updated_at": "2020-09-11T09:34:03Z",
    "author_association": "NONE",
    "body": "I'd totally support the `evm_delete_snapshot`. I've experienced the same behaviour in some of my tests that have inner contexts where I wanted to add on top of the \"after deployment\" snapshot, and it was overwritten (therefore outside that context the snapshot was polluted).",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/690985052/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
