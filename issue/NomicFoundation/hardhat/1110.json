{
  "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1110",
  "repository_url": "https://api.github.com/repos/NomicFoundation/hardhat",
  "labels_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1110/labels{/name}",
  "comments_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1110/comments",
  "events_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1110/events",
  "html_url": "https://github.com/NomicFoundation/hardhat/issues/1110",
  "id": 769742336,
  "node_id": "MDU6SXNzdWU3Njk3NDIzMzY=",
  "number": 1110,
  "title": "Tests never exit if listeners are still listening",
  "user": {
    "login": "bohendo",
    "id": 8527067,
    "node_id": "MDQ6VXNlcjg1MjcwNjc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/8527067?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/bohendo",
    "html_url": "https://github.com/bohendo",
    "followers_url": "https://api.github.com/users/bohendo/followers",
    "following_url": "https://api.github.com/users/bohendo/following{/other_user}",
    "gists_url": "https://api.github.com/users/bohendo/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/bohendo/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/bohendo/subscriptions",
    "organizations_url": "https://api.github.com/users/bohendo/orgs",
    "repos_url": "https://api.github.com/users/bohendo/repos",
    "events_url": "https://api.github.com/users/bohendo/events{/privacy}",
    "received_events_url": "https://api.github.com/users/bohendo/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": true,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2020-12-17T09:14:27Z",
  "updated_at": "2022-11-18T18:42:31Z",
  "closed_at": "2021-06-10T22:34:20Z",
  "author_association": "NONE",
  "active_lock_reason": "resolved",
  "body": "I have a test suite that runs to completion with no failures but never exits.\r\n\r\n## Reproduction\r\n\r\nNOT a minimal reproduction, I'm in the process of trimming out tests to figure out the smallest possible repro but this issue is kind of race-condition-ish so it's not super easy to isolate.\r\n\r\n```\r\ngit clone https://github.com/connext/vector.git\r\ncd vector\r\ngit checkout d36c5713\r\ncd modules/contracts\r\nnpm install\r\nnpm run build\r\nnpm test\r\n```\r\n\r\nThe *only* suite of our tests that appears to be affected is `modules/contracts/src.ts/services/ethService.spec.ts`.\r\nI have the issue repro'd reliably at the above commit by running 4 relatively simple tests out of these suite.\r\nIt is not possible to repro this problem by running a single or pair of tests. 3 tests will repro the issue only intermittently.\r\n\r\n## Problem\r\n\r\nIn the past, I've encountered this problem when the following code was run but the event was never detected:\r\n```\r\n    channelFactory.once(channelFactory.filters.ChannelCreation(), data => {\r\n      this.log.info({ method, data: JSON.stringify(data) }, \"Caught channel created event\");\r\n    });\r\n```\r\nIn this case, we have a listener that hangs around indefinitely & this appears to prevent `hardhat test` from exiting.\r\n\r\nIn the current issue (see above repro instructions), I've checked all obvious `.on(` and `.once(` calls & haven't found any that are stuck listening. I'm stuck now & unsure how to get the debugging info I need.\r\n\r\n## Solution\r\n\r\nThis problem isn't specific to hardhat, it appears that mocha needs to deal with it too. Mocha contains a flag:\r\n```\r\n  --exit                     Force Mocha to quit after tests complete  [boolean]\r\n```\r\nI've actually run into similar issues with mocha and this is a good way to get past it temporarily before doing a deeper dive into which listeners aren't getting cleaned up properly.\r\n\r\nIf it's possible to provide warnings re whether listeners or other background threads are preventing hardhat tests from exiting, that would be great.\r\n\r\nIf it's possible to provide into re *which* listeners are preventing hardhat tests from exiting, that would be even better.",
  "closed_by": {
    "login": "fvictorio",
    "id": 417134,
    "node_id": "MDQ6VXNlcjQxNzEzNA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/fvictorio",
    "html_url": "https://github.com/fvictorio",
    "followers_url": "https://api.github.com/users/fvictorio/followers",
    "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
    "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
    "organizations_url": "https://api.github.com/users/fvictorio/orgs",
    "repos_url": "https://api.github.com/users/fvictorio/repos",
    "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
    "received_events_url": "https://api.github.com/users/fvictorio/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1110/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1110/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/747332797",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/1110#issuecomment-747332797",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1110",
    "id": 747332797,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc0NzMzMjc5Nw==",
    "user": {
      "login": "bohendo",
      "id": 8527067,
      "node_id": "MDQ6VXNlcjg1MjcwNjc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8527067?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bohendo",
      "html_url": "https://github.com/bohendo",
      "followers_url": "https://api.github.com/users/bohendo/followers",
      "following_url": "https://api.github.com/users/bohendo/following{/other_user}",
      "gists_url": "https://api.github.com/users/bohendo/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bohendo/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bohendo/subscriptions",
      "organizations_url": "https://api.github.com/users/bohendo/orgs",
      "repos_url": "https://api.github.com/users/bohendo/repos",
      "events_url": "https://api.github.com/users/bohendo/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bohendo/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-12-17T09:51:11Z",
    "updated_at": "2020-12-17T09:51:11Z",
    "author_association": "NONE",
    "body": "Update: I've refactored out all explicit `on` and `once` calls from our contracts code & this made no difference. Whatever's preventing hardhat tests from exiting must be an implicit/internal listener..",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/747332797/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/747358443",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/1110#issuecomment-747358443",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1110",
    "id": 747358443,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc0NzM1ODQ0Mw==",
    "user": {
      "login": "bohendo",
      "id": 8527067,
      "node_id": "MDQ6VXNlcjg1MjcwNjc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8527067?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bohendo",
      "html_url": "https://github.com/bohendo",
      "followers_url": "https://api.github.com/users/bohendo/followers",
      "following_url": "https://api.github.com/users/bohendo/following{/other_user}",
      "gists_url": "https://api.github.com/users/bohendo/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bohendo/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bohendo/subscriptions",
      "organizations_url": "https://api.github.com/users/bohendo/orgs",
      "repos_url": "https://api.github.com/users/bohendo/repos",
      "events_url": "https://api.github.com/users/bohendo/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bohendo/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-12-17T10:39:16Z",
    "updated_at": "2020-12-17T10:39:16Z",
    "author_association": "NONE",
    "body": "Workaround: use mocha & pass it the `--exit` flag directly. The test script defined by our package.json is:\r\n```\r\n    \"test\": \"mocha --exit --require ts-node/register --require hardhat/register --timeout 60000 'src.ts/**/*.spec.ts'\"\r\n```\r\nThis has the added bonus of also allowing us to provide `--forbid-only` in automated tests.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/747358443/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/747522505",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/1110#issuecomment-747522505",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1110",
    "id": 747522505,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc0NzUyMjUwNQ==",
    "user": {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-12-17T15:47:19Z",
    "updated_at": "2020-12-17T15:47:19Z",
    "author_association": "MEMBER",
    "body": "Hey @bohendo, I looked a little into this. I didn't find the problem, but maybe what I did can help you.\r\n\r\n(First: your instructions have a little issue, there are two compiler errors, but I `any`ed them out. I don't think this is relevant though.)\r\n\r\nI installed [wtfnode](https://www.npmjs.com/package/wtfnode) and then I created a `wtf.js` module with just `require(\"wtfnode\")`. Then I changed the test script to include this module before anything else. That is, I added a `--register src.ts/wtf.js` at the beginning of the mocha command, before the other `--register`s.\r\n\r\nThen in `src.ts/services/ethService.spec.ts` I imported `wtfnode` and in the test I added this:\r\n\r\n```ts\r\n  after(function () {\r\n    setTimeout(() => {\r\n      wtf.dump()\r\n    }, 3000);\r\n  })\r\n```\r\n\r\nThen I ran the tests and (after some tries) I got this:\r\n\r\n```\r\n- File descriptors: (note: stdio always exists)\r\n  - fd 2 (tty) (stdio)\r\n  - fd 1 (tty) (stdio)\r\n- Timers:\r\n  - (4000 ~ 4 s) (anonymous) @ /vector/modules/contracts/node_modules/ethers/node_modules/@ethersproject/providers/lib/base-provider.js:814\r\n  - (3000 ~ 3 s) (anonymous) @ /vector/modules/contracts/src.ts/services/ethService.spec.ts:32\r\n- Intervals:\r\n  - (4000 ~ 4 s) bound  @ /vector/modules/contracts/node_modules/ethers/node_modules/@ethersproject/providers/lib/base-provider.js:808\r\n```\r\n\r\nThe first two can be ignored, and the 3s one is the one I added, which doesn't matter either.\r\n\r\nThe other two are ethers providers that do some polling.\r\n\r\nThat's what I got! It's not much, but maybe it helps you investigate further.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/747522505/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/747526642",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/1110#issuecomment-747526642",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/1110",
    "id": 747526642,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc0NzUyNjY0Mg==",
    "user": {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-12-17T15:53:21Z",
    "updated_at": "2020-12-17T15:53:21Z",
    "author_association": "MEMBER",
    "body": "I'm thinking about what to do with this issue. I don't think it's a bug in Hardhat: my guess is that it's something about your setup. That being said, I understand how this experience is not ideal. But I'm not sure if it's something on our side or on mocha's side.\r\n\r\n> If it's possible to provide warnings re whether listeners or other background threads are preventing hardhat tests from exiting, that would be great.\r\n> \r\n> If it's possible to provide into re which listeners are preventing hardhat tests from exiting, that would be even better.\r\n\r\nI think this is technically possible but, again, I don't know if it's Hardhat's responsibility. I'm inclined to mark this as a feature request and, if more people run into this problem, evaluate what to do.\r\n\r\n@alcuadrado what do you think?",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/747526642/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
