{
  "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3667",
  "repository_url": "https://api.github.com/repos/NomicFoundation/hardhat",
  "labels_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3667/labels{/name}",
  "comments_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3667/comments",
  "events_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3667/events",
  "html_url": "https://github.com/NomicFoundation/hardhat/issues/3667",
  "id": 1581053086,
  "node_id": "I_kwDOB7jojM5ePPSe",
  "number": 3667,
  "title": "Forbid chaining incompatible chai matchers",
  "user": {
    "login": "VVander",
    "id": 6549498,
    "node_id": "MDQ6VXNlcjY1NDk0OTg=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6549498?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/VVander",
    "html_url": "https://github.com/VVander",
    "followers_url": "https://api.github.com/users/VVander/followers",
    "following_url": "https://api.github.com/users/VVander/following{/other_user}",
    "gists_url": "https://api.github.com/users/VVander/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/VVander/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/VVander/subscriptions",
    "organizations_url": "https://api.github.com/users/VVander/orgs",
    "repos_url": "https://api.github.com/users/VVander/repos",
    "events_url": "https://api.github.com/users/VVander/events{/privacy}",
    "received_events_url": "https://api.github.com/users/VVander/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 4937718880,
      "node_id": "LA_kwDOB7jojM8AAAABJk-cYA",
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/labels/type:improvement",
      "name": "type:improvement",
      "color": "FBCA04",
      "default": false,
      "description": ""
    },
    {
      "id": 4937720577,
      "node_id": "LA_kwDOB7jojM8AAAABJk-jAQ",
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/labels/status:ready",
      "name": "status:ready",
      "color": "0E8A16",
      "default": false,
      "description": "This issue is ready to be worked on"
    },
    {
      "id": 4952257781,
      "node_id": "LA_kwDOB7jojM8AAAABJy109Q",
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/labels/area:chai-matchers",
      "name": "area:chai-matchers",
      "color": "5319E7",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2023-02-11T23:35:21Z",
  "updated_at": "2023-06-26T13:49:33Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Version of Hardhat\r\n\r\n2.12.7\r\n\r\n### What happened?\r\n\r\nI'm running into an issue where only the last chai matcher is being applied.\r\n\r\nIn my case,  `changeEtherBalances` and `changeTokenBalance` aren't being chained correctly:\r\n\r\n```\r\nawait expect(lock.withdraw()).to.changeEtherBalances(\r\n          [owner, lock],\r\n          [lockedAmount, -lockedAmount]\r\n        )\r\n        .and.to.changeTokenBalance(\r\n            token, \"0xd8dA6BF26964aF9D7eEd9e03E53415D37aA96045\", 1\r\n        );\r\n```\r\n\r\nIn this case, only the last condition is actually checked and the first one appears to be skipped entirely. I've attached a minimal reproducible based on the default HH project which demonstrates this.\r\n\r\nI'm definitely not an expert with Mocha/Chai, so I'm assuming there's something I'm doing wrong, but it appears as if there's an issue chaining the matchers since it also happens with other HH matchers like `reverted` and `changeEtherBalances`:\r\n\r\n```\r\nawait expect(lock.withdraw())\r\n          .to.be.reverted // this is ignored\r\n          .and.to.changeEtherBalances(\r\n            [owner, lock],\r\n            [lockedAmount, -lockedAmount]\r\n          );\r\n```\r\n\r\n\r\n### Minimal reproduction steps\r\n\r\nSee reproducible project:\r\n[reproducible.zip](https://github.com/NomicFoundation/hardhat/files/10714922/reproducible.zip)\r\n\r\nNote that I removed the `node_modules` directory for the upload so you'll have to reinstall those.\r\n\r\n### Search terms\r\n\r\nchai matcher ",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3667/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3667/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1426904772",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/3667#issuecomment-1426904772",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3667",
    "id": 1426904772,
    "node_id": "IC_kwDOB7jojM5VDNbE",
    "user": {
      "login": "alcuadrado",
      "id": 176499,
      "node_id": "MDQ6VXNlcjE3NjQ5OQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/176499?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alcuadrado",
      "html_url": "https://github.com/alcuadrado",
      "followers_url": "https://api.github.com/users/alcuadrado/followers",
      "following_url": "https://api.github.com/users/alcuadrado/following{/other_user}",
      "gists_url": "https://api.github.com/users/alcuadrado/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alcuadrado/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alcuadrado/subscriptions",
      "organizations_url": "https://api.github.com/users/alcuadrado/orgs",
      "repos_url": "https://api.github.com/users/alcuadrado/repos",
      "events_url": "https://api.github.com/users/alcuadrado/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alcuadrado/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-02-12T00:13:00Z",
    "updated_at": "2023-02-12T00:13:00Z",
    "author_association": "MEMBER",
    "body": "Thanks for reporting this. I believe it's a bug on our end.\r\n\r\nIs there a way to forbid this, @fvictorio ?",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1426904772/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1439741409",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/3667#issuecomment-1439741409",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3667",
    "id": 1439741409,
    "node_id": "IC_kwDOB7jojM5V0LXh",
    "user": {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-02-22T10:04:59Z",
    "updated_at": "2023-02-22T10:04:59Z",
    "author_association": "MEMBER",
    "body": "I'm pretty sure there is. We should add some contextual flag that says that we already added a matcher to the chain, and check it in each other matcher. It's a shitty solution, but I don't think chai has a better mechanism for that.\r\n\r\nWe have similar things that are duplicated across matchers, so I feel we should invest in some indirection (like a matcher-adder interface) that handles these kind of things.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1439741409/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1441221720",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/3667#issuecomment-1441221720",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3667",
    "id": 1441221720,
    "node_id": "IC_kwDOB7jojM5V50xY",
    "user": {
      "login": "VVander",
      "id": 6549498,
      "node_id": "MDQ6VXNlcjY1NDk0OTg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6549498?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/VVander",
      "html_url": "https://github.com/VVander",
      "followers_url": "https://api.github.com/users/VVander/followers",
      "following_url": "https://api.github.com/users/VVander/following{/other_user}",
      "gists_url": "https://api.github.com/users/VVander/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/VVander/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/VVander/subscriptions",
      "organizations_url": "https://api.github.com/users/VVander/orgs",
      "repos_url": "https://api.github.com/users/VVander/repos",
      "events_url": "https://api.github.com/users/VVander/events{/privacy}",
      "received_events_url": "https://api.github.com/users/VVander/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-02-23T05:01:26Z",
    "updated_at": "2023-02-23T05:01:26Z",
    "author_association": "NONE",
    "body": "@fvictorio does this title change imply that `changeEtherBalances()` and `changeTokenBalance()` are incompatible? What is the right way to write a unit test for a function which does both?\r\n\r\nRegardless, thanks for taking a look at this. I'm now faced with the prospect of going back through all of my many dozens of unit tests and manually checking if they use multiple matchers... This has set my schedule back dramatically :(",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1441221720/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1455897184",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/3667#issuecomment-1455897184",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3667",
    "id": 1455897184,
    "node_id": "IC_kwDOB7jojM5Wxzpg",
    "user": {
      "login": "MuhammadWajidShahid",
      "id": 47058167,
      "node_id": "MDQ6VXNlcjQ3MDU4MTY3",
      "avatar_url": "https://avatars.githubusercontent.com/u/47058167?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MuhammadWajidShahid",
      "html_url": "https://github.com/MuhammadWajidShahid",
      "followers_url": "https://api.github.com/users/MuhammadWajidShahid/followers",
      "following_url": "https://api.github.com/users/MuhammadWajidShahid/following{/other_user}",
      "gists_url": "https://api.github.com/users/MuhammadWajidShahid/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MuhammadWajidShahid/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MuhammadWajidShahid/subscriptions",
      "organizations_url": "https://api.github.com/users/MuhammadWajidShahid/orgs",
      "repos_url": "https://api.github.com/users/MuhammadWajidShahid/repos",
      "events_url": "https://api.github.com/users/MuhammadWajidShahid/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MuhammadWajidShahid/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-06T10:45:42Z",
    "updated_at": "2023-03-06T10:45:42Z",
    "author_association": "NONE",
    "body": "@fvictorio \r\nI am facing the same problem. It only checks the last chained condition.\r\nThe first `event` is being ignored also the first `changeTokenBalance` is also being ignored.\r\n\r\n``` \r\n await expect(masterchef.deposit(0, parseUnits(\"1\"), owner.address))\r\n              .to.emit(rewarder, \"LogOnReward\")\r\n              .withArgs(owner.address, 0, parseUnits(\"1\"), owner.address).and\r\n              .to.emit(tokenRewarder, \"LogOnReward\")\r\n              .withArgs(owner.address, 0, parseUnits(\"1\"), owner.address)\r\n              .to.changeTokenBalance(token, owner.address, parseUnits(\"1\"))\r\n              .and.to.changeTokenBalance(rewardToken, owner.address, parseUnits(\"1\"));\r\n```\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1455897184/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1461765455",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/3667#issuecomment-1461765455",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3667",
    "id": 1461765455,
    "node_id": "IC_kwDOB7jojM5XIMVP",
    "user": {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-09T10:36:43Z",
    "updated_at": "2023-03-09T10:36:43Z",
    "author_association": "MEMBER",
    "body": "The way to check multiple conditions is by assigning the tx (without awaiting it):\r\n\r\n```js\r\nconst tx = contract.f(1, 2)\r\nawait expect(tx).to.emit(...)\r\nawait expect(tx).to.changeEtherBalances(...)\r\n// etc.\r\n```\r\n\r\n> I'm now faced with the prospect of going back through all of my many dozens of unit tests and manually checking if they use multiple matchers... This has set my schedule back dramatically :(\r\n\r\nI'm super sorry about that. It was an error to not forbid this in the first place.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1461765455/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 1,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
