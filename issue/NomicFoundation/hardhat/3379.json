{
  "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3379",
  "repository_url": "https://api.github.com/repos/NomicFoundation/hardhat",
  "labels_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3379/labels{/name}",
  "comments_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3379/comments",
  "events_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3379/events",
  "html_url": "https://github.com/NomicFoundation/hardhat/issues/3379",
  "id": 1465455518,
  "node_id": "I_kwDOB7jojM5XWROe",
  "number": 3379,
  "title": "Hardhat throws a strange error when trying to call smart contract functions while using local hardhat forked network",
  "user": {
    "login": "archerkeyboard",
    "id": 36080311,
    "node_id": "MDQ6VXNlcjM2MDgwMzEx",
    "avatar_url": "https://avatars.githubusercontent.com/u/36080311?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/archerkeyboard",
    "html_url": "https://github.com/archerkeyboard",
    "followers_url": "https://api.github.com/users/archerkeyboard/followers",
    "following_url": "https://api.github.com/users/archerkeyboard/following{/other_user}",
    "gists_url": "https://api.github.com/users/archerkeyboard/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/archerkeyboard/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/archerkeyboard/subscriptions",
    "organizations_url": "https://api.github.com/users/archerkeyboard/orgs",
    "repos_url": "https://api.github.com/users/archerkeyboard/repos",
    "events_url": "https://api.github.com/users/archerkeyboard/events{/privacy}",
    "received_events_url": "https://api.github.com/users/archerkeyboard/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": true,
  "assignee": {
    "login": "fvictorio",
    "id": 417134,
    "node_id": "MDQ6VXNlcjQxNzEzNA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/fvictorio",
    "html_url": "https://github.com/fvictorio",
    "followers_url": "https://api.github.com/users/fvictorio/followers",
    "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
    "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
    "organizations_url": "https://api.github.com/users/fvictorio/orgs",
    "repos_url": "https://api.github.com/users/fvictorio/repos",
    "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
    "received_events_url": "https://api.github.com/users/fvictorio/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2022-11-27T14:17:07Z",
  "updated_at": "2023-02-27T00:15:01Z",
  "closed_at": "2022-11-28T20:47:08Z",
  "author_association": "NONE",
  "active_lock_reason": "resolved",
  "body": "Here's the code used: https://github.com/archerkeyboard/hhStuff/tree/master\r\n\r\nInstructions to reproduce:\r\n\r\n1. In a cmd run `npx hardhat node --fork https://bsc-dataseed2.binance.org`\r\n2. In another terminal run `npx hardhat run .\\scripts\\test.js --network localhost`\r\n\r\n\r\n### Scenario 1 (works)\r\nIf we run command 2) right after the accounts show up from 1) It works and we deposit bnb and get wrapped bnb\r\n![image](https://user-images.githubusercontent.com/36080311/204139767-fef26882-969f-4b32-8ef8-32691840f792.png)\r\n\r\n### Scenario 2 (does not work)\r\nIf we wait and do the same but after 10-20 seconds, we get the following error: \r\n  **WARNING: Calling an account which is not a contract**\r\n \r\n![image](https://user-images.githubusercontent.com/36080311/204139866-637e43fa-8f47-4dd0-858d-49b9f9f87c54.png)\r\n\r\nThe code is the same, only difference is the time of the execution after initializing the local hardhat network.",
  "closed_by": {
    "login": "fvictorio",
    "id": 417134,
    "node_id": "MDQ6VXNlcjQxNzEzNA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/fvictorio",
    "html_url": "https://github.com/fvictorio",
    "followers_url": "https://api.github.com/users/fvictorio/followers",
    "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
    "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
    "organizations_url": "https://api.github.com/users/fvictorio/orgs",
    "repos_url": "https://api.github.com/users/fvictorio/repos",
    "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
    "received_events_url": "https://api.github.com/users/fvictorio/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3379/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3379/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1328256785",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/3379#issuecomment-1328256785",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3379",
    "id": 1328256785,
    "node_id": "IC_kwDOB7jojM5PK5cR",
    "user": {
      "login": "github-actions[bot]",
      "id": 41898282,
      "node_id": "MDM6Qm90NDE4OTgyODI=",
      "avatar_url": "https://avatars.githubusercontent.com/in/15368?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/github-actions%5Bbot%5D",
      "html_url": "https://github.com/apps/github-actions",
      "followers_url": "https://api.github.com/users/github-actions%5Bbot%5D/followers",
      "following_url": "https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}",
      "gists_url": "https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/github-actions%5Bbot%5D/subscriptions",
      "organizations_url": "https://api.github.com/users/github-actions%5Bbot%5D/orgs",
      "repos_url": "https://api.github.com/users/github-actions%5Bbot%5D/repos",
      "events_url": "https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}",
      "received_events_url": "https://api.github.com/users/github-actions%5Bbot%5D/received_events",
      "type": "Bot",
      "site_admin": false
    },
    "created_at": "2022-11-27T14:17:32Z",
    "updated_at": "2022-11-27T14:17:32Z",
    "author_association": "CONTRIBUTOR",
    "body": "This issue is also being [tracked on Linear](https://linear.app/nomic-foundation/issue/HH-1355/hardhat-throws-a-strange-error-when-trying-to-call-smart-contract).\n\nWe use Linear to manage our development process, but we keep the conversations on Github.\n\nLINEAR-ID: 2e6a712a-721f-4865-8a22-63c493926a32",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1328256785/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1329743445",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/3379#issuecomment-1329743445",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/3379",
    "id": 1329743445,
    "node_id": "IC_kwDOB7jojM5PQkZV",
    "user": {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-11-28T20:47:08Z",
    "updated_at": "2022-11-28T20:47:08Z",
    "author_association": "MEMBER",
    "body": "Thanks a lot for the clear reproduction steps, @archerkeyboard, that was very useful.\r\n\r\nI believe I've found the issue: apparently, after a while, the BSC node misbehaves when you send batched RPC calls. This seems to be a bug in the BSC node.\r\n\r\nHere is what I did, in case you want to report this to them (I don't know which channel to use for that).\r\n\r\nGiven this two calls:\r\n\r\n```bash\r\ncurl https://bsc-dataseed2.binance.org -s -X POST -H 'Content-Type: application/json' --data '{\"jsonrpc\": \"2.0\", \"id\": 1, \"method\": \"eth_getCode\", \"params\": [\"0xbb4cdb9cbd36b01bd1cbaebf2de08d9173bc095c\", \"0x165e2be\"]}'\r\ncurl https://bsc-dataseed2.binance.org -s -X POST -H 'Content-Type: application/json' --data '[{\"jsonrpc\":\"2.0\", \"id\": 1, \"method\": \"eth_getCode\", \"params\": [\"0xbb4cdb9cbd36b01bd1cbaebf2de08d9173bc095c\", \"0x165e2be\"]}]'\r\n```\r\n\r\nThe difference here is that the second is a batch request, because it's inside an array.\r\n\r\nThe first one always returns the right value (or at least most of the time, sometimes it returns an error). But the second one has a very curious behavior:\r\n\r\n- At the beginning, it returns the right value\r\n- After a while it starts returning `0x`; that is, it acts as if the address had no code. This causes the issue where Hardhat tells you that you are calling an account which is not a contract.\r\n- After even more time, the method just starts consistently failing.\r\n\r\n(There isn't a clear separation between the three \"stages\". Sometimes the right value is returned after a previous call returned `0x`.)\r\n\r\nSince Hardhat's mainnet forking relies on batched rpc calls to get the data of some accounts (it fetches the code, nonce and balance in one call), this problem means that BSC forking will not be very reliable.\r\n\r\nI'm going to close this now because I don't think there's much we can do. If you report this problem somewhere, feel free to link this issue and/or tag me.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/1329743445/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
