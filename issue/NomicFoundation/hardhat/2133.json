{
  "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2133",
  "repository_url": "https://api.github.com/repos/NomicFoundation/hardhat",
  "labels_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2133/labels{/name}",
  "comments_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2133/comments",
  "events_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2133/events",
  "html_url": "https://github.com/NomicFoundation/hardhat/issues/2133",
  "id": 1073211604,
  "node_id": "I_kwDOB7jojM4_9-jU",
  "number": 2133,
  "title": "Issues with time synchronization for Avalanche C-chain fork",
  "user": {
    "login": "mbare0",
    "id": 95619266,
    "node_id": "U_kgDOBbMIwg",
    "avatar_url": "https://avatars.githubusercontent.com/u/95619266?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mbare0",
    "html_url": "https://github.com/mbare0",
    "followers_url": "https://api.github.com/users/mbare0/followers",
    "following_url": "https://api.github.com/users/mbare0/following{/other_user}",
    "gists_url": "https://api.github.com/users/mbare0/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mbare0/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mbare0/subscriptions",
    "organizations_url": "https://api.github.com/users/mbare0/orgs",
    "repos_url": "https://api.github.com/users/mbare0/repos",
    "events_url": "https://api.github.com/users/mbare0/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mbare0/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": true,
  "assignee": {
    "login": "fvictorio",
    "id": 417134,
    "node_id": "MDQ6VXNlcjQxNzEzNA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/fvictorio",
    "html_url": "https://github.com/fvictorio",
    "followers_url": "https://api.github.com/users/fvictorio/followers",
    "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
    "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
    "organizations_url": "https://api.github.com/users/fvictorio/orgs",
    "repos_url": "https://api.github.com/users/fvictorio/repos",
    "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
    "received_events_url": "https://api.github.com/users/fvictorio/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2021-12-07T10:59:19Z",
  "updated_at": "2022-11-18T10:08:30Z",
  "closed_at": "2021-12-09T12:59:27Z",
  "author_association": "NONE",
  "active_lock_reason": "resolved",
  "body": "Hello everyone :)\r\n\r\nFirst of all thank you for delivering such useful tools for blockchain development!\r\n\r\nI've been recently working with hardhat forking the Avalanche C-chain and found some issues with time synchronization. My tests are time dependent so having pretty accurate time is important. \r\n\r\nI try printing time difference between JS time and current block in my tests:\r\n```\r\ndescribe('Smart loan',  () => {\r\n  before(\"Synchronize blockchain time\", async () => {\r\n    await checkTimeDifference();\r\n  });\r\n  \r\n      it(\"example test\", async () => {\r\n      await checkTimeDifference();\r\n\r\n      await contract.method(toWei(\"100\"));\r\n      await checkTimeDifference();\r\n      });\r\n});\r\n```      \r\nwhere:\r\n```\r\nasync function checkTimeDifference() {\r\n    let blockNumber = await provider.getBlockNumber();\r\n    let block = await provider.getBlock(blockNumber);\r\n    let timestamp = block.timestamp * 1000;\r\n    console.log(`Difference ${(Date.now() - timestamp)/1000}s`);\r\n}\r\n```\r\n\r\nWhen I start it just after running a fork, it prints a positive value (e.g. 40s). After performing some actions causing mining of new blocks, time difference is let's say 10-15s (ofc it's pretty random).\r\nIt becomes more weird when I do it again, because often time difference can becomes negative, meaning a block can have a timestamp in the future.\r\n\r\nNormally I would just try synchronizing block timestamp before a test:\r\n`await provider.send('evm_setNextBlockTimestamp', [Math.ceil(new Date().getTime() / 1000)]);`. \r\n\r\nBut firstly, it is not enough to synchronize fork once at the beginning, because after some actions time difference diverges and I have to synchronize again.\r\nSecondly when `block.timestamp` is in the future, it makes it more complicated because I can't set a block.timestamp before a previous one (my workaround is to `hardhat_reset` fork  and try to synchronize again).\r\n\r\nMaybe it's related to the fact that I use Avalanche fork that has different average mining times than Ethereum chains?\r\n\r\nThanks for any help,\r\nmbare\r\n",
  "closed_by": {
    "login": "fvictorio",
    "id": 417134,
    "node_id": "MDQ6VXNlcjQxNzEzNA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/fvictorio",
    "html_url": "https://github.com/fvictorio",
    "followers_url": "https://api.github.com/users/fvictorio/followers",
    "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
    "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
    "organizations_url": "https://api.github.com/users/fvictorio/orgs",
    "repos_url": "https://api.github.com/users/fvictorio/repos",
    "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
    "received_events_url": "https://api.github.com/users/fvictorio/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2133/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2133/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/989829600",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/2133#issuecomment-989829600",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/2133",
    "id": 989829600,
    "node_id": "IC_kwDOB7jojM46_5ng",
    "user": {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-12-09T12:59:27Z",
    "updated_at": "2021-12-09T12:59:27Z",
    "author_association": "MEMBER",
    "body": "Hey @mbare0, there are several things to point out here.\r\n\r\nFirst, by default Hardhat automines blocks, which means that a new block is created when a tx is received. So there are no guarantees that a new block will be mined every N seconds. If you want that behavior, you need to disable automining and enable interval mining (see [here](https://hardhat.org/hardhat-network/reference/#mining-modes)).\r\n\r\nSecond, Hardhat guarantees that each new block has a different timestamp. In practice, this means that if you mine 10 blocks in less than 1 second (which is entirely possible with automining), then each one will have a timestamp that is one second later than the previous one. If you are comparing with `Date.now()`, then you'll have that problem of having blocks \"in the future\".\r\n\r\nHope that helps! And feel free to re-open if you still think there's a bug (or feature request) here.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/989829600/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
