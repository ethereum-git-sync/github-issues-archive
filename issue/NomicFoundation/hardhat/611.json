{
  "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/611",
  "repository_url": "https://api.github.com/repos/NomicFoundation/hardhat",
  "labels_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/611/labels{/name}",
  "comments_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/611/comments",
  "events_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/611/events",
  "html_url": "https://github.com/NomicFoundation/hardhat/issues/611",
  "id": 624608923,
  "node_id": "MDU6SXNzdWU2MjQ2MDg5MjM=",
  "number": 611,
  "title": "Unable to link libraries with Buidler (and other issues with Waffle)",
  "user": {
    "login": "boyuanx",
    "id": 22159499,
    "node_id": "MDQ6VXNlcjIyMTU5NDk5",
    "avatar_url": "https://avatars.githubusercontent.com/u/22159499?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/boyuanx",
    "html_url": "https://github.com/boyuanx",
    "followers_url": "https://api.github.com/users/boyuanx/followers",
    "following_url": "https://api.github.com/users/boyuanx/following{/other_user}",
    "gists_url": "https://api.github.com/users/boyuanx/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/boyuanx/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/boyuanx/subscriptions",
    "organizations_url": "https://api.github.com/users/boyuanx/orgs",
    "repos_url": "https://api.github.com/users/boyuanx/repos",
    "events_url": "https://api.github.com/users/boyuanx/events{/privacy}",
    "received_events_url": "https://api.github.com/users/boyuanx/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": true,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2020-05-26T05:23:27Z",
  "updated_at": "2022-11-18T18:48:38Z",
  "closed_at": "2021-05-04T21:13:05Z",
  "author_association": "NONE",
  "active_lock_reason": "resolved",
  "body": "I'm trying to link libraries for my contract and I cannot find a way to do it with Buidler. I find myself resorting to using Waffle's native methods but the problem is, compiled JSONs generated by Buidler are incompatible with Waffle. In other words, Buidler and Waffle generate different JSONs from the same Solidity source file. Here is the main difference (the missing \"evm\" breaks compatibility with Waffle as it's no longer recognized as a LinkableContract):\r\n\r\nFrom Waffle:\r\n```\r\n\"evm\": {\r\n    \"bytecode\": {\r\n      \"linkReferences\": {\r\n        \"contracts/external/AddressSet.sol\": {\r\n```\r\n\r\nFrom Buidler:\r\n```\r\n\"bytecode\": \r\n\" *all the bytecode* \"\r\n\"linkReferences\": {\r\n    \"contracts/external/AddressSet.sol\": {\r\n```\r\n\r\nAlso, Waffle instructs me to link by doing:\r\n```\r\nimport MyLibrary from \"build/MyLibrary.json\";\r\nimport LibraryConsumer from \"build/LibraryConsumer.json\";\r\nmyLibrary = await deployContract(wallet, MyLibrary, []);\r\nlink(LibraryConsumer, 'contracts/MyLibrary.sol:MyLibrary', myLibrary.address);\r\nlibraryConsumer = await deployContract(wallet, LibraryConsumer, []);\r\n```\r\nwhich is completely different from how Buidler handles things.\r\n\r\nI can't seem to find a way around this. Does anyone have any insights as to how to link libraries using Buidler?",
  "closed_by": {
    "login": "fvictorio",
    "id": 417134,
    "node_id": "MDQ6VXNlcjQxNzEzNA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/fvictorio",
    "html_url": "https://github.com/fvictorio",
    "followers_url": "https://api.github.com/users/fvictorio/followers",
    "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
    "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
    "organizations_url": "https://api.github.com/users/fvictorio/orgs",
    "repos_url": "https://api.github.com/users/fvictorio/repos",
    "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
    "received_events_url": "https://api.github.com/users/fvictorio/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/611/reactions",
    "total_count": 3,
    "+1": 3,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/611/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/634027952",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/611#issuecomment-634027952",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/611",
    "id": 634027952,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYzNDAyNzk1Mg==",
    "user": {
      "login": "alcuadrado",
      "id": 176499,
      "node_id": "MDQ6VXNlcjE3NjQ5OQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/176499?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alcuadrado",
      "html_url": "https://github.com/alcuadrado",
      "followers_url": "https://api.github.com/users/alcuadrado/followers",
      "following_url": "https://api.github.com/users/alcuadrado/following{/other_user}",
      "gists_url": "https://api.github.com/users/alcuadrado/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alcuadrado/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alcuadrado/subscriptions",
      "organizations_url": "https://api.github.com/users/alcuadrado/orgs",
      "repos_url": "https://api.github.com/users/alcuadrado/repos",
      "events_url": "https://api.github.com/users/alcuadrado/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alcuadrado/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-26T13:33:39Z",
    "updated_at": "2020-05-26T13:33:39Z",
    "author_association": "MEMBER",
    "body": "Thanks for reporting this @boyuanx.\r\n\r\nIt seems to be a serious limitation of the buidler-ethers-waffle setup, so we'll address it soon.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/634027952/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/634173685",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/611#issuecomment-634173685",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/611",
    "id": 634173685,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYzNDE3MzY4NQ==",
    "user": {
      "login": "boyuanx",
      "id": 22159499,
      "node_id": "MDQ6VXNlcjIyMTU5NDk5",
      "avatar_url": "https://avatars.githubusercontent.com/u/22159499?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/boyuanx",
      "html_url": "https://github.com/boyuanx",
      "followers_url": "https://api.github.com/users/boyuanx/followers",
      "following_url": "https://api.github.com/users/boyuanx/following{/other_user}",
      "gists_url": "https://api.github.com/users/boyuanx/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/boyuanx/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/boyuanx/subscriptions",
      "organizations_url": "https://api.github.com/users/boyuanx/orgs",
      "repos_url": "https://api.github.com/users/boyuanx/repos",
      "events_url": "https://api.github.com/users/boyuanx/events{/privacy}",
      "received_events_url": "https://api.github.com/users/boyuanx/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-26T17:43:11Z",
    "updated_at": "2020-05-26T17:43:11Z",
    "author_association": "NONE",
    "body": "Thank you for the information, @alcuadrado. I just switched over from web3 + Truffle and it’s a shame because I’m really liking Buidler + ethers + Waffle. ",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/634173685/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/638891597",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/611#issuecomment-638891597",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/611",
    "id": 638891597,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYzODg5MTU5Nw==",
    "user": {
      "login": "alcuadrado",
      "id": 176499,
      "node_id": "MDQ6VXNlcjE3NjQ5OQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/176499?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alcuadrado",
      "html_url": "https://github.com/alcuadrado",
      "followers_url": "https://api.github.com/users/alcuadrado/followers",
      "following_url": "https://api.github.com/users/alcuadrado/following{/other_user}",
      "gists_url": "https://api.github.com/users/alcuadrado/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alcuadrado/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alcuadrado/subscriptions",
      "organizations_url": "https://api.github.com/users/alcuadrado/orgs",
      "repos_url": "https://api.github.com/users/alcuadrado/repos",
      "events_url": "https://api.github.com/users/alcuadrado/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alcuadrado/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-06-04T14:39:42Z",
    "updated_at": "2020-06-04T14:39:42Z",
    "author_association": "MEMBER",
    "body": "This is going to be addressed soon, but in the meantime, this is a workaround you can use:\r\n\r\n```js\r\nconst { ethers, config } = require(\"@nomiclabs/buidler\");\r\nconst { readArtifact } = require(\"@nomiclabs/buidler/plugins\");\r\n\r\nasync function main() {\r\n  const Library = await ethers.getContractFactory(\"Library\");\r\n  const library = await Library.deploy();\r\n  await library.deployed();\r\n\r\n  const cArtifact = await readArtifact(config.paths.artifacts, \"Contract\");\r\n  const linkedBytecode = linkBytecode(cArtifact, { Library: library.address });\r\n  const Contract = await ethers.getContractFactory(\r\n    cArtifact.abi,\r\n    linkedBytecode\r\n  );\r\n\r\n  const contract = await Contract.deploy();\r\n  await contract.deployed();\r\n\r\n  console.log(\"Contract address:\", contract.address);\r\n}\r\n\r\nfunction linkBytecode(artifact, libraries) {\r\n  let bytecode = artifact.bytecode;\r\n\r\n  for (const [fileName, fileReferences] of Object.entries(\r\n    artifact.linkReferences\r\n  )) {\r\n    for (const [libName, fixups] of Object.entries(fileReferences)) {\r\n      const addr = libraries[libName];\r\n      if (addr === undefined) {\r\n        continue;\r\n      }\r\n\r\n      for (const fixup of fixups) {\r\n        bytecode =\r\n          bytecode.substr(0, 2 + fixup.start * 2) +\r\n          addr.substr(2) +\r\n          bytecode.substr(2 + (fixup.start + fixup.length) * 2);\r\n      }\r\n    }\r\n  }\r\n\r\n  return bytecode;\r\n}\r\n\r\nmain()\r\n  .then(() => process.exit(0))\r\n  .catch((error) => {\r\n    console.error(error);\r\n    process.exit(1);\r\n  });\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/638891597/reactions",
      "total_count": 6,
      "+1": 6,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/832252655",
    "html_url": "https://github.com/NomicFoundation/hardhat/issues/611#issuecomment-832252655",
    "issue_url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/611",
    "id": 832252655,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgzMjI1MjY1NQ==",
    "user": {
      "login": "fvictorio",
      "id": 417134,
      "node_id": "MDQ6VXNlcjQxNzEzNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417134?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fvictorio",
      "html_url": "https://github.com/fvictorio",
      "followers_url": "https://api.github.com/users/fvictorio/followers",
      "following_url": "https://api.github.com/users/fvictorio/following{/other_user}",
      "gists_url": "https://api.github.com/users/fvictorio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fvictorio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fvictorio/subscriptions",
      "organizations_url": "https://api.github.com/users/fvictorio/orgs",
      "repos_url": "https://api.github.com/users/fvictorio/repos",
      "events_url": "https://api.github.com/users/fvictorio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fvictorio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-05-04T21:13:05Z",
    "updated_at": "2021-05-04T21:13:05Z",
    "author_association": "MEMBER",
    "body": "@alcuadrado we can close this, right?\r\n\r\nFor anyone reading this, you can now link libraries with the ethers plugin. Read [this](https://hardhat.org/plugins/nomiclabs-hardhat-ethers.html#library-linking) to learn how.",
    "reactions": {
      "url": "https://api.github.com/repos/NomicFoundation/hardhat/issues/comments/832252655/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
