{
  "url": "https://api.github.com/repos/MetaMask/core/issues/701",
  "repository_url": "https://api.github.com/repos/MetaMask/core",
  "labels_url": "https://api.github.com/repos/MetaMask/core/issues/701/labels{/name}",
  "comments_url": "https://api.github.com/repos/MetaMask/core/issues/701/comments",
  "events_url": "https://api.github.com/repos/MetaMask/core/issues/701/events",
  "html_url": "https://github.com/MetaMask/core/issues/701",
  "id": 1156790786,
  "node_id": "I_kwDOCBB0Cc5E8zoC",
  "number": 701,
  "title": "Pls. reduce FeeHistory query range from 20.000 to 1024 for long term queries",
  "user": {
    "login": "peak3d",
    "id": 22704999,
    "node_id": "MDQ6VXNlcjIyNzA0OTk5",
    "avatar_url": "https://avatars.githubusercontent.com/u/22704999?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/peak3d",
    "html_url": "https://github.com/peak3d",
    "followers_url": "https://api.github.com/users/peak3d/followers",
    "following_url": "https://api.github.com/users/peak3d/following{/other_user}",
    "gists_url": "https://api.github.com/users/peak3d/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/peak3d/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/peak3d/subscriptions",
    "organizations_url": "https://api.github.com/users/peak3d/orgs",
    "repos_url": "https://api.github.com/users/peak3d/repos",
    "events_url": "https://api.github.com/users/peak3d/events{/privacy}",
    "received_events_url": "https://api.github.com/users/peak3d/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 7,
  "created_at": "2022-03-02T08:39:15Z",
  "updated_at": "2022-03-24T13:15:37Z",
  "closed_at": "2022-03-23T17:01:57Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "MetaMask Browser extension is one of the most used wallets around.\r\n\r\nFetching fee history introduced by EIP1559 has in most implementations an internal cache of 1024 blocks.\r\nFetching blocks in a wider range will lead to cache invalidates and huge computations to re-calculate the fee history.\r\n\r\nController now requests 20.000 past blocks (in ~20 chunks), which runs nearly uncached. This call is done every time someone opens the browser extension, and if I'm not wrong after this in recular n second poll steps.\r\nhttps://github.com/MetaMask/controllers/blob/main/src/gas/fetchGasEstimatesViaEthFeeHistory/BlockFeeHistoryDatasetFetcher.ts#L55\r\n\r\nThis means lot of cpu / power consumtion for node owner, gateway providers have to invest heavily in infrastructure to be able to respond to the requests.\r\n\r\nPls. investigate, if it is really required to request the last 20.000 blocks, especially for the MM browser extension I don't think it is required. Using 1024 (cache-size) blocks would give you > 4hours in the past (for ethereum 13 sec block time)\r\n\r\nI wouldn't say anything if MM would be a small application used by few, but your success should also come with some responsibility.",
  "closed_by": {
    "login": "mcmire",
    "id": 7371,
    "node_id": "MDQ6VXNlcjczNzE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/7371?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mcmire",
    "html_url": "https://github.com/mcmire",
    "followers_url": "https://api.github.com/users/mcmire/followers",
    "following_url": "https://api.github.com/users/mcmire/following{/other_user}",
    "gists_url": "https://api.github.com/users/mcmire/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mcmire/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mcmire/subscriptions",
    "organizations_url": "https://api.github.com/users/mcmire/orgs",
    "repos_url": "https://api.github.com/users/mcmire/repos",
    "events_url": "https://api.github.com/users/mcmire/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mcmire/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/MetaMask/core/issues/701/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/MetaMask/core/issues/701/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/MetaMask/core/issues/comments/1057201549",
    "html_url": "https://github.com/MetaMask/core/issues/701#issuecomment-1057201549",
    "issue_url": "https://api.github.com/repos/MetaMask/core/issues/701",
    "id": 1057201549,
    "node_id": "IC_kwDOCBB0Cc4_A52N",
    "user": {
      "login": "danfinlay",
      "id": 542863,
      "node_id": "MDQ6VXNlcjU0Mjg2Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/542863?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/danfinlay",
      "html_url": "https://github.com/danfinlay",
      "followers_url": "https://api.github.com/users/danfinlay/followers",
      "following_url": "https://api.github.com/users/danfinlay/following{/other_user}",
      "gists_url": "https://api.github.com/users/danfinlay/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/danfinlay/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/danfinlay/subscriptions",
      "organizations_url": "https://api.github.com/users/danfinlay/orgs",
      "repos_url": "https://api.github.com/users/danfinlay/repos",
      "events_url": "https://api.github.com/users/danfinlay/events{/privacy}",
      "received_events_url": "https://api.github.com/users/danfinlay/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-03-02T17:42:34Z",
    "updated_at": "2022-03-02T17:42:34Z",
    "author_association": "CONTRIBUTOR",
    "body": "Thanks for the report, we're looking into it!",
    "reactions": {
      "url": "https://api.github.com/repos/MetaMask/core/issues/comments/1057201549/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/MetaMask/core/issues/comments/1057242248",
    "html_url": "https://github.com/MetaMask/core/issues/701#issuecomment-1057242248",
    "issue_url": "https://api.github.com/repos/MetaMask/core/issues/701",
    "id": 1057242248,
    "node_id": "IC_kwDOCBB0Cc4_BDyI",
    "user": {
      "login": "mcmire",
      "id": 7371,
      "node_id": "MDQ6VXNlcjczNzE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7371?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mcmire",
      "html_url": "https://github.com/mcmire",
      "followers_url": "https://api.github.com/users/mcmire/followers",
      "following_url": "https://api.github.com/users/mcmire/following{/other_user}",
      "gists_url": "https://api.github.com/users/mcmire/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mcmire/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mcmire/subscriptions",
      "organizations_url": "https://api.github.com/users/mcmire/orgs",
      "repos_url": "https://api.github.com/users/mcmire/repos",
      "events_url": "https://api.github.com/users/mcmire/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mcmire/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-03-02T18:24:42Z",
    "updated_at": "2022-03-02T18:56:49Z",
    "author_association": "CONTRIBUTOR",
    "body": "Hi @peak3d,\r\n\r\nThank you for bringing this up. We appreciate your concern about performance. That said, I wanted to clarify some things about the code that you referenced and how it's used.\r\n\r\n> Controller now requests 20.000 past blocks (in ~20 chunks), which runs nearly uncached. This call is done every time someone opens the browser extension\r\n\r\nThis can happen, but is not likely to happen. We typically we hit an internal API that acts as a proxy to the network. You can see that call [here](https://github.com/MetaMask/controllers/blob/89c00500b9650d5748eae3f6d667f726b9d3cc6a/src/gas/determineGasFeeCalculations.ts#L77), which ends up calling [this](https://github.com/MetaMask/controllers/blob/89c00500b9650d5748eae3f6d667f726b9d3cc6a/src/gas/gas-util.ts#L32) (the URL referenced is located in the extension repo [here](https://github.com/MetaMask/metamask-extension/blob/b8fc1ae671c153d84de6caa254de3e55c153de75/app/scripts/metamask-controller.js#L336)). The API makes several calls to the network — one of which requests 20,000 blocks to support some new information about the network we are now presenting users as a part of the [gas fee UI update](https://twitter.com/MetaMask/status/1498730701939789831) — and then caches the results.\r\n\r\nTherefore, the vast majority of the time, the extension works just as you'd expect it to, and we don't blast the network.\r\n\r\nThe code that you're referring to is a fallback implementation. If for some reason the API is down, then the extension will make calls to the network manually. This logic is designed to mimic what the API is doing as closely as possible so that users are unaware and MetaMask doesn't give them wildly different estimates than if the API was up. That was the original thinking behind this at least.\r\n\r\nNow to your point:\r\n\r\n> Pls. investigate, if it is really required to request the last 20.000 blocks, especially for the MM browser extension I don't think it is required. Using 1024 (cache-size) blocks would give you > 4hours in the past (for ethereum 13 sec block time)\r\n\r\nI do agree that it is probably unnecessary to request so much data in the fallback case. I just talked to the person who usually runs the API I mentioned above and they agreed that this would be a fine change to make. I can get started on making that change right away.",
    "reactions": {
      "url": "https://api.github.com/repos/MetaMask/core/issues/comments/1057242248/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/MetaMask/core/issues/comments/1058016295",
    "html_url": "https://github.com/MetaMask/core/issues/701#issuecomment-1058016295",
    "issue_url": "https://api.github.com/repos/MetaMask/core/issues/701",
    "id": 1058016295,
    "node_id": "IC_kwDOCBB0Cc4_EAwn",
    "user": {
      "login": "tgmichel",
      "id": 3994116,
      "node_id": "MDQ6VXNlcjM5OTQxMTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3994116?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tgmichel",
      "html_url": "https://github.com/tgmichel",
      "followers_url": "https://api.github.com/users/tgmichel/followers",
      "following_url": "https://api.github.com/users/tgmichel/following{/other_user}",
      "gists_url": "https://api.github.com/users/tgmichel/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tgmichel/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tgmichel/subscriptions",
      "organizations_url": "https://api.github.com/users/tgmichel/orgs",
      "repos_url": "https://api.github.com/users/tgmichel/repos",
      "events_url": "https://api.github.com/users/tgmichel/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tgmichel/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-03-03T12:58:18Z",
    "updated_at": "2022-03-03T12:58:18Z",
    "author_association": "NONE",
    "body": "> The code that you're referring to is a fallback implementation. If for some reason the API is down, then the extension will make calls to the network manually.\r\n\r\nIs that also the case for when the API is up but returns an error when there is no data indexed for the given chain id? I.e.\r\n\r\n```\r\n{\r\n  \"error\": \"Cannot read property 'getBlock' of undefined\"\r\n}\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/MetaMask/core/issues/comments/1058016295/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/MetaMask/core/issues/comments/1058110366",
    "html_url": "https://github.com/MetaMask/core/issues/701#issuecomment-1058110366",
    "issue_url": "https://api.github.com/repos/MetaMask/core/issues/701",
    "id": 1058110366,
    "node_id": "IC_kwDOCBB0Cc4_EXue",
    "user": {
      "login": "peak3d",
      "id": 22704999,
      "node_id": "MDQ6VXNlcjIyNzA0OTk5",
      "avatar_url": "https://avatars.githubusercontent.com/u/22704999?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/peak3d",
      "html_url": "https://github.com/peak3d",
      "followers_url": "https://api.github.com/users/peak3d/followers",
      "following_url": "https://api.github.com/users/peak3d/following{/other_user}",
      "gists_url": "https://api.github.com/users/peak3d/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/peak3d/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/peak3d/subscriptions",
      "organizations_url": "https://api.github.com/users/peak3d/orgs",
      "repos_url": "https://api.github.com/users/peak3d/repos",
      "events_url": "https://api.github.com/users/peak3d/events{/privacy}",
      "received_events_url": "https://api.github.com/users/peak3d/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-03-03T14:41:45Z",
    "updated_at": "2022-03-03T14:41:45Z",
    "author_association": "CONTRIBUTOR",
    "body": "> his can happen, but is not likely to happen. We typically we hit an internal API that acts as a proxy to the network.\r\n\r\nThank you for taking time to explain it in detail, and yes, the proxy backing might explain why the topic has not popped up sooner. Appreciate this!\r\n\r\nIs the list of registered api endpoints / chains public in MM repository?\r\n\r\n- peak3d",
    "reactions": {
      "url": "https://api.github.com/repos/MetaMask/core/issues/comments/1058110366/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/MetaMask/core/issues/comments/1058124514",
    "html_url": "https://github.com/MetaMask/core/issues/701#issuecomment-1058124514",
    "issue_url": "https://api.github.com/repos/MetaMask/core/issues/701",
    "id": 1058124514,
    "node_id": "IC_kwDOCBB0Cc4_EbLi",
    "user": {
      "login": "peak3d",
      "id": 22704999,
      "node_id": "MDQ6VXNlcjIyNzA0OTk5",
      "avatar_url": "https://avatars.githubusercontent.com/u/22704999?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/peak3d",
      "html_url": "https://github.com/peak3d",
      "followers_url": "https://api.github.com/users/peak3d/followers",
      "following_url": "https://api.github.com/users/peak3d/following{/other_user}",
      "gists_url": "https://api.github.com/users/peak3d/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/peak3d/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/peak3d/subscriptions",
      "organizations_url": "https://api.github.com/users/peak3d/orgs",
      "repos_url": "https://api.github.com/users/peak3d/repos",
      "events_url": "https://api.github.com/users/peak3d/events{/privacy}",
      "received_events_url": "https://api.github.com/users/peak3d/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-03-03T14:56:23Z",
    "updated_at": "2022-03-03T14:56:23Z",
    "author_association": "CONTRIBUTOR",
    "body": "> Is that also the case for when the API is up but returns an error when there is no data indexed for the given chain id? I.e.\r\n> \r\n> ```\r\n> {\r\n>   \"error\": \"Cannot read property 'getBlock' of undefined\"\r\n> }\r\n> ```\r\nFrom reading code any issue (even not expected response) will lead to fallback....., but let experts answer....",
    "reactions": {
      "url": "https://api.github.com/repos/MetaMask/core/issues/comments/1058124514/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/MetaMask/core/issues/comments/1076577520",
    "html_url": "https://github.com/MetaMask/core/issues/701#issuecomment-1076577520",
    "issue_url": "https://api.github.com/repos/MetaMask/core/issues/701",
    "id": 1076577520,
    "node_id": "IC_kwDOCBB0Cc5AK0Tw",
    "user": {
      "login": "mcmire",
      "id": 7371,
      "node_id": "MDQ6VXNlcjczNzE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7371?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mcmire",
      "html_url": "https://github.com/mcmire",
      "followers_url": "https://api.github.com/users/mcmire/followers",
      "following_url": "https://api.github.com/users/mcmire/following{/other_user}",
      "gists_url": "https://api.github.com/users/mcmire/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mcmire/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mcmire/subscriptions",
      "organizations_url": "https://api.github.com/users/mcmire/orgs",
      "repos_url": "https://api.github.com/users/mcmire/repos",
      "events_url": "https://api.github.com/users/mcmire/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mcmire/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-03-23T17:01:56Z",
    "updated_at": "2022-03-23T17:02:10Z",
    "author_association": "CONTRIBUTOR",
    "body": "Thanks for originally reporting this issue. This is fixed as of MetaMask 10.11.2, which minimizes the number of requests made to the network in the fallback scenario as mentioned above (this includes removal of the 20,000-block request). You can check out the changes here:\r\n\r\n* #705\r\n* #712\r\n\r\nHope this helps. Let us know if you notice anything else!",
    "reactions": {
      "url": "https://api.github.com/repos/MetaMask/core/issues/comments/1076577520/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/MetaMask/core/issues/comments/1077616164",
    "html_url": "https://github.com/MetaMask/core/issues/701#issuecomment-1077616164",
    "issue_url": "https://api.github.com/repos/MetaMask/core/issues/701",
    "id": 1077616164,
    "node_id": "IC_kwDOCBB0Cc5AOx4k",
    "user": {
      "login": "peak3d",
      "id": 22704999,
      "node_id": "MDQ6VXNlcjIyNzA0OTk5",
      "avatar_url": "https://avatars.githubusercontent.com/u/22704999?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/peak3d",
      "html_url": "https://github.com/peak3d",
      "followers_url": "https://api.github.com/users/peak3d/followers",
      "following_url": "https://api.github.com/users/peak3d/following{/other_user}",
      "gists_url": "https://api.github.com/users/peak3d/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/peak3d/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/peak3d/subscriptions",
      "organizations_url": "https://api.github.com/users/peak3d/orgs",
      "repos_url": "https://api.github.com/users/peak3d/repos",
      "events_url": "https://api.github.com/users/peak3d/events{/privacy}",
      "received_events_url": "https://api.github.com/users/peak3d/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-03-24T13:15:36Z",
    "updated_at": "2022-03-24T13:15:36Z",
    "author_association": "CONTRIBUTOR",
    "body": "Thx @mcmire !",
    "reactions": {
      "url": "https://api.github.com/repos/MetaMask/core/issues/comments/1077616164/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
