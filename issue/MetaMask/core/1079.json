{
  "url": "https://api.github.com/repos/MetaMask/core/issues/1079",
  "repository_url": "https://api.github.com/repos/MetaMask/core",
  "labels_url": "https://api.github.com/repos/MetaMask/core/issues/1079/labels{/name}",
  "comments_url": "https://api.github.com/repos/MetaMask/core/issues/1079/comments",
  "events_url": "https://api.github.com/repos/MetaMask/core/issues/1079/events",
  "html_url": "https://github.com/MetaMask/core/issues/1079",
  "id": 1557108821,
  "node_id": "I_kwDOCBB0Cc5cz5hV",
  "number": 1079,
  "title": "Migrate libraries into core monorepo",
  "user": {
    "login": "Gudahtt",
    "id": 2459287,
    "node_id": "MDQ6VXNlcjI0NTkyODc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2459287?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Gudahtt",
    "html_url": "https://github.com/Gudahtt",
    "followers_url": "https://api.github.com/users/Gudahtt/followers",
    "following_url": "https://api.github.com/users/Gudahtt/following{/other_user}",
    "gists_url": "https://api.github.com/users/Gudahtt/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Gudahtt/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Gudahtt/subscriptions",
    "organizations_url": "https://api.github.com/users/Gudahtt/orgs",
    "repos_url": "https://api.github.com/users/Gudahtt/repos",
    "events_url": "https://api.github.com/users/Gudahtt/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Gudahtt/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 948148996,
      "node_id": "MDU6TGFiZWw5NDgxNDg5OTY=",
      "url": "https://api.github.com/repos/MetaMask/core/labels/enhancement",
      "name": "enhancement",
      "color": "a2eeef",
      "default": true,
      "description": "New feature or request"
    },
    {
      "id": 3884427940,
      "node_id": "LA_kwDOCBB0Cc7nh6qk",
      "url": "https://api.github.com/repos/MetaMask/core/labels/Epic",
      "name": "Epic",
      "color": "4660F9",
      "default": false,
      "description": null
    },
    {
      "id": 5330766523,
      "node_id": "LA_kwDOCBB0Cc8AAAABPb0Kuw",
      "url": "https://api.github.com/repos/MetaMask/core/labels/team-shared-libraries",
      "name": "team-shared-libraries",
      "color": "c5def5",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2023-01-25T18:38:09Z",
  "updated_at": "2023-10-05T19:01:17Z",
  "closed_at": null,
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "We would like to migrate most MetaMask libraries into this monorepo to make them easier to maintain. We may want to exclude libraries that are:\r\n\r\n* Experimental\r\n* Deprecated, or not encouraged to be used in our codebase anymore\r\n* Not used directly in a MetaMask client\r\n* Intended primarily for external developers integrating with MetaMask\r\n* Specific to extensions or React Native\r\n* Too noisy/high-volume\r\n* Deployed both as a website and an npm package\r\n* Controllers (these are represented by https://github.com/MetaMask/core/issues/700)\r\n* Conceptually distinct in some way (this one is subjective)\r\n\r\nHere is the list of libraries that seem like a good fit today:\r\n\r\n- [ ] https://github.com/MetaMask/abi-utils\r\n- [ ] https://github.com/MetaMask/eth-block-tracker\r\n- [ ] https://github.com/MetaMask/eth-hd-keyring\r\n- [ ] https://github.com/MetaMask/eth-json-rpc-filters\r\n- [ ] https://github.com/MetaMask/eth-json-rpc-infura\r\n- [ ] https://github.com/MetaMask/eth-json-rpc-middleware\r\n- [ ] https://github.com/MetaMask/eth-ledger-bridge-keyring\r\n- [ ] https://github.com/MetaMask/eth-method-registry\r\n- [ ] https://github.com/MetaMask/eth-phishing-detect (but just the detector, not the config)\r\n- [ ] https://github.com/MetaMask/eth-rpc-errors\r\n- [ ] https://github.com/MetaMask/eth-sig-util\r\n- [ ] https://github.com/MetaMask/eth-simple-keyring\r\n- [ ] https://github.com/MetaMask/eth-token-tracker\r\n- [ ] https://github.com/MetaMask/eth-trezor-keyring\r\n- [ ] https://github.com/MetaMask/etherscan-link\r\n- [ ] https://github.com/MetaMask/json-rpc-engine\r\n- [ ] https://github.com/MetaMask/json-rpc-middleware-stream\r\n- [ ] https://github.com/MetaMask/metamask-eth-abis\r\n- [ ] https://github.com/MetaMask/nonce-tracker\r\n- [ ] https://github.com/MetaMask/providers\r\n- [ ] https://github.com/MetaMask/scure-bip39\r\n- [ ] https://github.com/MetaMask/utils\r\n\r\nSee https://github.com/MetaMask/core/issues/1079#issuecomment-1700126302 for instructions on accomplishing this.",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/MetaMask/core/issues/1079/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/MetaMask/core/issues/1079/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/MetaMask/core/issues/comments/1648394122",
    "html_url": "https://github.com/MetaMask/core/issues/1079#issuecomment-1648394122",
    "issue_url": "https://api.github.com/repos/MetaMask/core/issues/1079",
    "id": 1648394122,
    "node_id": "IC_kwDOCBB0Cc5iQH-K",
    "user": {
      "login": "mcmire",
      "id": 7371,
      "node_id": "MDQ6VXNlcjczNzE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7371?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mcmire",
      "html_url": "https://github.com/mcmire",
      "followers_url": "https://api.github.com/users/mcmire/followers",
      "following_url": "https://api.github.com/users/mcmire/following{/other_user}",
      "gists_url": "https://api.github.com/users/mcmire/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mcmire/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mcmire/subscriptions",
      "organizations_url": "https://api.github.com/users/mcmire/orgs",
      "repos_url": "https://api.github.com/users/mcmire/repos",
      "events_url": "https://api.github.com/users/mcmire/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mcmire/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-24T18:26:48Z",
    "updated_at": "2023-07-24T18:26:48Z",
    "author_association": "CONTRIBUTOR",
    "body": "I propose we focus on the following libraries for Q3:\r\n\r\n- `@metamask/utils`\r\n- `@metamask/json-rpc-engine`\r\n- `@metamask/eth-json-rpc-provider` (not in the list above because it was created after the above list was built)\r\n- `@metamask/json-rpc-middleware-stream`",
    "reactions": {
      "url": "https://api.github.com/repos/MetaMask/core/issues/comments/1648394122/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/MetaMask/core/issues/comments/1700073685",
    "html_url": "https://github.com/MetaMask/core/issues/1079#issuecomment-1700073685",
    "issue_url": "https://api.github.com/repos/MetaMask/core/issues/1079",
    "id": 1700073685,
    "node_id": "IC_kwDOCBB0Cc5lVRDV",
    "user": {
      "login": "mcmire",
      "id": 7371,
      "node_id": "MDQ6VXNlcjczNzE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7371?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mcmire",
      "html_url": "https://github.com/mcmire",
      "followers_url": "https://api.github.com/users/mcmire/followers",
      "following_url": "https://api.github.com/users/mcmire/following{/other_user}",
      "gists_url": "https://api.github.com/users/mcmire/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mcmire/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mcmire/subscriptions",
      "organizations_url": "https://api.github.com/users/mcmire/orgs",
      "repos_url": "https://api.github.com/users/mcmire/repos",
      "events_url": "https://api.github.com/users/mcmire/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mcmire/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-08-31T00:27:17Z",
    "updated_at": "2023-08-31T00:34:22Z",
    "author_association": "CONTRIBUTOR",
    "body": "I went through the list of existing repos and found some that were omitted from the list above:\r\n\r\n- `browser-passworder` — Is this because it's extension only?\r\n- Snap-related libraries (`eth-snap-keyring`, `keyring-snaps-registry`, `snap-simple-keyring`, `snaps-registry`) — is this because Snaps owns these?\r\n- `object-multiplex` (used by `providers`) — Is it because it's not used directly by the wallet?\r\n- `post-message-stream` — Is this because it's extension only?\r\n- `ppom-validator` — Is this because it's extension only?\r\n- `rpc-errors`, `safe-event-emitter`, `eth-json-rpc-provider`, `key-tree`, `swappable-obj-proxy` — Are these missing because they were created after the list above was compiled?",
    "reactions": {
      "url": "https://api.github.com/repos/MetaMask/core/issues/comments/1700073685/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/MetaMask/core/issues/comments/1700126302",
    "html_url": "https://github.com/MetaMask/core/issues/1079#issuecomment-1700126302",
    "issue_url": "https://api.github.com/repos/MetaMask/core/issues/1079",
    "id": 1700126302,
    "node_id": "IC_kwDOCBB0Cc5lVd5e",
    "user": {
      "login": "mcmire",
      "id": 7371,
      "node_id": "MDQ6VXNlcjczNzE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7371?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mcmire",
      "html_url": "https://github.com/mcmire",
      "followers_url": "https://api.github.com/users/mcmire/followers",
      "following_url": "https://api.github.com/users/mcmire/following{/other_user}",
      "gists_url": "https://api.github.com/users/mcmire/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mcmire/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mcmire/subscriptions",
      "organizations_url": "https://api.github.com/users/mcmire/orgs",
      "repos_url": "https://api.github.com/users/mcmire/repos",
      "events_url": "https://api.github.com/users/mcmire/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mcmire/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-08-31T00:53:49Z",
    "updated_at": "2023-10-05T19:01:17Z",
    "author_association": "CONTRIBUTOR",
    "body": "One thing we want to absolutely make sure to do when we migrate a library to this repo is to preserve all of the Git history.\r\n\r\nI experimented with this using `@metamask/utils` and came up with a process. At a high level, we need to:\r\n\r\n1. Clone the repo for the library somewhere.\r\n2. Rewrite the entire history of the library as though the entire project had been located in a `merged-packages/<library-name>` directory all along. (You will soon see why.)\r\n3. Navigate to `core`.\r\n4. Add the library repo as a (local) remote, and fetch its history.\r\n5. Create a merge commit that connects the primary branch of the library with `core`'s `main` branch (ignoring unrelated history).\r\n6. Done! Now we can submit a pull request.\r\n \r\nNow we see why we performed step 2: because we want the library to initially be located in `core` under `merged-packages/<library-name>`. This directory is special in that [ESLint and Prettier will ignore it](https://github.com/MetaMask/core/pull/1524). This allows us to follow up with another pull request that moves the library into `packages` and incorporate it into the release workflow.\r\n\r\nHere is a list of detailed steps:\r\n\r\n1. [Install `git-filter-repo`](https://github.com/newren/git-filter-repo/blob/main/INSTALL.md). This tool is like Git's `filter-branch` command, but much easier to use and much less error-prone.\r\n9. Navigate to a temporary directory: `cd /tmp`\r\n10. Clone the repo for the library you want to migrate: `git clone https://github.com/MetaMask/<repo-name>` (e.g. `<repo-name>` = `utils`). Do **NOT** use an existing clone.\r\n11. `cd` into the newly cloned repo.\r\n12. Run `git filter-repo --to-subdirectory-filter merged-packages/<package-name>` (e.g. `<package-name>` = `utils`). This will rewrite all history to move all files to `merged-packages/<package-name>`. (This is why we're making a fresh clone in a temporary directory — this action is irreversible.)\r\n13. `cd` to wherever you keep the `core` repo on your machine.\r\n14. Add the library as a remote: `git remote add <package-name> /tmp/<package-name>`.\r\n15. Fetch history: `git fetch <package-name> --no-tags`\r\n16. Make a new branch: `git checkout -b migrate-<package-name>`\r\n17. Merge the library into the monorepo: `git merge --allow-unrelated-histories <package-name>/<primary-branch>` (e.g. `<primary-branch>` = `main`)\r\n18. Make a pull request.\r\n\r\nThe resulting pull request should look like this: https://github.com/MetaMask/core/pull/1520\r\n\r\n---\r\n\r\n**UPDATE October 5, 2023:**\r\n\r\nThere are a few more steps to keep in mind to complete a migration. We are working out some of these details now and we will post a full guide later, but here are some notes for now:\r\n\r\n- When completing a PR that migrates code into `merged-packages/` we need to make sure to create a merge commit instead of squashing and merging. Currently we don't allow this for the `core` monorepo, so we will need to temporarily disable that check in order to merge such a PR.\r\n- Some packages are not yet published under the `@metamask` NPM scope. These need to be renamed (with a new major version released) prior to migrating into the monorepo.\r\n- In order to make links in changelogs work, we need to copy tags over from the library. This is a bit complicated because the package may have changed names over time (especially if the previous step needed to be followed), and so we need to know when this occurred so that as we are iterating over tags we can prefix that tag with the appropriate package name. For instance, a tag `2.3.7` may need to get renamed to `json-rpc-engine@2.3.7` or `@metamask/json-rpc-engine@2.3.7` depending on what the name was at that time in history.\r\n- We also need to copy over any issues or PRs that are open on the library's repo. This can be done post-migration, however.\r\n- Lastly once the migration is complete, we need to archive the library's repo to prevent changes from being pushed to it.",
    "reactions": {
      "url": "https://api.github.com/repos/MetaMask/core/issues/comments/1700126302/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
