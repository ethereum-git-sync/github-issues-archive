{
  "url": "https://api.github.com/repos/MetaMask/core/issues/1823",
  "repository_url": "https://api.github.com/repos/MetaMask/core",
  "labels_url": "https://api.github.com/repos/MetaMask/core/issues/1823/labels{/name}",
  "comments_url": "https://api.github.com/repos/MetaMask/core/issues/1823/comments",
  "events_url": "https://api.github.com/repos/MetaMask/core/issues/1823/events",
  "html_url": "https://github.com/MetaMask/core/issues/1823",
  "id": 1938824319,
  "node_id": "I_kwDOCBB0Cc5zkBx_",
  "number": 1823,
  "title": "Fix provider type errors in `NetworkController` and its downstream packages",
  "user": {
    "login": "MajorLift",
    "id": 34228073,
    "node_id": "MDQ6VXNlcjM0MjI4MDcz",
    "avatar_url": "https://avatars.githubusercontent.com/u/34228073?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/MajorLift",
    "html_url": "https://github.com/MajorLift",
    "followers_url": "https://api.github.com/users/MajorLift/followers",
    "following_url": "https://api.github.com/users/MajorLift/following{/other_user}",
    "gists_url": "https://api.github.com/users/MajorLift/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/MajorLift/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/MajorLift/subscriptions",
    "organizations_url": "https://api.github.com/users/MajorLift/orgs",
    "repos_url": "https://api.github.com/users/MajorLift/repos",
    "events_url": "https://api.github.com/users/MajorLift/events{/privacy}",
    "received_events_url": "https://api.github.com/users/MajorLift/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 948148992,
      "node_id": "MDU6TGFiZWw5NDgxNDg5OTI=",
      "url": "https://api.github.com/repos/MetaMask/core/labels/bug",
      "name": "bug",
      "color": "d73a4a",
      "default": true,
      "description": "Something isn't working"
    },
    {
      "id": 5330766523,
      "node_id": "LA_kwDOCBB0Cc8AAAABPb0Kuw",
      "url": "https://api.github.com/repos/MetaMask/core/labels/team-shared-libraries",
      "name": "team-shared-libraries",
      "color": "c5def5",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "MajorLift",
    "id": 34228073,
    "node_id": "MDQ6VXNlcjM0MjI4MDcz",
    "avatar_url": "https://avatars.githubusercontent.com/u/34228073?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/MajorLift",
    "html_url": "https://github.com/MajorLift",
    "followers_url": "https://api.github.com/users/MajorLift/followers",
    "following_url": "https://api.github.com/users/MajorLift/following{/other_user}",
    "gists_url": "https://api.github.com/users/MajorLift/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/MajorLift/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/MajorLift/subscriptions",
    "organizations_url": "https://api.github.com/users/MajorLift/orgs",
    "repos_url": "https://api.github.com/users/MajorLift/repos",
    "events_url": "https://api.github.com/users/MajorLift/events{/privacy}",
    "received_events_url": "https://api.github.com/users/MajorLift/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "mcmire",
      "id": 7371,
      "node_id": "MDQ6VXNlcjczNzE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7371?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mcmire",
      "html_url": "https://github.com/mcmire",
      "followers_url": "https://api.github.com/users/mcmire/followers",
      "following_url": "https://api.github.com/users/mcmire/following{/other_user}",
      "gists_url": "https://api.github.com/users/mcmire/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mcmire/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mcmire/subscriptions",
      "organizations_url": "https://api.github.com/users/mcmire/orgs",
      "repos_url": "https://api.github.com/users/mcmire/repos",
      "events_url": "https://api.github.com/users/mcmire/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mcmire/received_events",
      "type": "User",
      "site_admin": false
    },
    {
      "login": "MajorLift",
      "id": 34228073,
      "node_id": "MDQ6VXNlcjM0MjI4MDcz",
      "avatar_url": "https://avatars.githubusercontent.com/u/34228073?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MajorLift",
      "html_url": "https://github.com/MajorLift",
      "followers_url": "https://api.github.com/users/MajorLift/followers",
      "following_url": "https://api.github.com/users/MajorLift/following{/other_user}",
      "gists_url": "https://api.github.com/users/MajorLift/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MajorLift/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MajorLift/subscriptions",
      "organizations_url": "https://api.github.com/users/MajorLift/orgs",
      "repos_url": "https://api.github.com/users/MajorLift/repos",
      "events_url": "https://api.github.com/users/MajorLift/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MajorLift/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2023-10-11T22:18:31Z",
  "updated_at": "2023-11-22T19:12:36Z",
  "closed_at": "2023-11-22T19:12:35Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "## Explanation\r\n\r\n- Resolve type errors in NetworkController and its downstream packages that were marked with `@ts-expect-error TODO:` annotations in https://github.com/MetaMask/core/pull/1653.\r\n- Affected packages: `network-controller`, `selected-network-controller`, `transaction-controller`, `gas-fee-controller`\r\n\r\n## Tasks\r\n\r\n### Provider type alignment\r\n- `ProxyWithAccessibleTarget<SafeEventEmitterProvider>` (`@metamask/network-controller`) vs. `Provider` (`@metamask/eth-query`)\r\n```ts\r\n error TS2345: Argument of type 'ProxyWithAccessibleTarget<SafeEventEmitterProvider>' is not assignable to parameter of type 'Provider<JsonRpcParams, Json>'.\r\n  Types of property 'sendAsync' are incompatible.\r\n    Type '(req: JsonRpcRequest<JsonRpcParams>, callback: (error: unknown, providerRes?: any) => void) => void' is not assignable to type '<Params, Result>(payload: SendAsyncPayload<Params>, callback: ProviderSendAsyncCallback<Result>) => void'.\r\n      Types of parameters 'req' and 'payload' are incompatible.\r\n        Type 'SendAsyncPayload<Params>' is not assignable to type 'JsonRpcRequest<JsonRpcParams>'.\r\n```\r\n- `SafeEventEmitterProvider`\r\n- `ProviderProxy`\r\n- `FakeProvider`\r\n\r\n## References\r\n- https://github.com/MetaMask/core/issues/1975\r\n- https://github.com/MetaMask/utils/pull/140\r\n- https://github.com/MetaMask/eth-json-rpc-provider/pull/14\r\n- https://github.com/MetaMask/core#workspaces/shared-libraries-621e46b4d7103800171d1b02/issues/zh/244",
  "closed_by": {
    "login": "MajorLift",
    "id": 34228073,
    "node_id": "MDQ6VXNlcjM0MjI4MDcz",
    "avatar_url": "https://avatars.githubusercontent.com/u/34228073?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/MajorLift",
    "html_url": "https://github.com/MajorLift",
    "followers_url": "https://api.github.com/users/MajorLift/followers",
    "following_url": "https://api.github.com/users/MajorLift/following{/other_user}",
    "gists_url": "https://api.github.com/users/MajorLift/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/MajorLift/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/MajorLift/subscriptions",
    "organizations_url": "https://api.github.com/users/MajorLift/orgs",
    "repos_url": "https://api.github.com/users/MajorLift/repos",
    "events_url": "https://api.github.com/users/MajorLift/events{/privacy}",
    "received_events_url": "https://api.github.com/users/MajorLift/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/MetaMask/core/issues/1823/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/MetaMask/core/issues/1823/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/MetaMask/core/issues/comments/1819803563",
    "html_url": "https://github.com/MetaMask/core/issues/1823#issuecomment-1819803563",
    "issue_url": "https://api.github.com/repos/MetaMask/core/issues/1823",
    "id": 1819803563,
    "node_id": "IC_kwDOCBB0Cc5sd_-r",
    "user": {
      "login": "mcmire",
      "id": 7371,
      "node_id": "MDQ6VXNlcjczNzE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7371?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mcmire",
      "html_url": "https://github.com/mcmire",
      "followers_url": "https://api.github.com/users/mcmire/followers",
      "following_url": "https://api.github.com/users/mcmire/following{/other_user}",
      "gists_url": "https://api.github.com/users/mcmire/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mcmire/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mcmire/subscriptions",
      "organizations_url": "https://api.github.com/users/mcmire/orgs",
      "repos_url": "https://api.github.com/users/mcmire/repos",
      "events_url": "https://api.github.com/users/mcmire/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mcmire/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-11-20T21:06:34Z",
    "updated_at": "2023-11-20T21:06:34Z",
    "author_association": "CONTRIBUTOR",
    "body": "What's left on this ticket?",
    "reactions": {
      "url": "https://api.github.com/repos/MetaMask/core/issues/comments/1819803563/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/MetaMask/core/issues/comments/1819901532",
    "html_url": "https://github.com/MetaMask/core/issues/1823#issuecomment-1819901532",
    "issue_url": "https://api.github.com/repos/MetaMask/core/issues/1823",
    "id": 1819901532,
    "node_id": "IC_kwDOCBB0Cc5seX5c",
    "user": {
      "login": "MajorLift",
      "id": 34228073,
      "node_id": "MDQ6VXNlcjM0MjI4MDcz",
      "avatar_url": "https://avatars.githubusercontent.com/u/34228073?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MajorLift",
      "html_url": "https://github.com/MajorLift",
      "followers_url": "https://api.github.com/users/MajorLift/followers",
      "following_url": "https://api.github.com/users/MajorLift/following{/other_user}",
      "gists_url": "https://api.github.com/users/MajorLift/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MajorLift/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MajorLift/subscriptions",
      "organizations_url": "https://api.github.com/users/MajorLift/orgs",
      "repos_url": "https://api.github.com/users/MajorLift/repos",
      "events_url": "https://api.github.com/users/MajorLift/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MajorLift/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-11-20T22:23:50Z",
    "updated_at": "2023-11-20T22:24:16Z",
    "author_association": "CONTRIBUTOR",
    "body": "@mcmire I'm still seeing the following error in this PR https://github.com/MetaMask/smart-transactions-controller/pull/237, even after updating `@metamask/eth-query` and `@metamask/network-controller` to the latest versions.\r\n\r\n```ts\r\nsrc/SmartTransactionsController.ts:334:31 - error TS2345: Argument of type 'ProxyWithAccessibleTarget<SafeEventEmitterProvider>' is not assignable to parameter of type 'Provider'.\r\n  Types of property 'sendAsync' are incompatible.\r\n    Type '(req: JsonRpcRequest<JsonRpcParams>, callback: (error: unknown, providerRes?: any) => void) => void' is not assignable to type '<Params, Result>(payload: SendAsyncPayload<Params>, callback: ProviderSendAsyncCallback<Result>) => void'.\r\n      Types of parameters 'req' and 'payload' are incompatible.\r\n        Type 'SendAsyncPayload<Params>' is not assignable to type 'JsonRpcRequest<JsonRpcParams>'.\r\n          Type 'SendAsyncPayload<Params>' is not assignable to type '{ params?: ((Record<string, Json> | Json[]) & ExactOptionalGuard) | undefined; id: string | number | null; method: string; jsonrpc: \"2.0\"; }'.\r\n            Types of property 'params' are incompatible.\r\n              Type 'Params' is not assignable to type '((Record<string, Json> | Json[]) & ExactOptionalGuard) | undefined'.\r\n                Type 'Params' is not assignable to type 'Json[] & ExactOptionalGuard'.\r\n                  Type 'Params' is not assignable to type 'Json[]'.\r\n\r\n334       ethQuery = new EthQuery(networkClient.provider);\r\n```\r\n\r\nI think we need to make the following updates to `SafeEventEmitterProvider` in `@metamask/eth-json-rpc-provider` to make it align with the `@metamask/utils` updates.\r\n\r\n```diff\r\ndiff --git a/packages/eth-json-rpc-provider/src/safe-event-emitter-provider.ts b/packages/eth-json-rpc-provider/src/safe-event-emitter-provider.ts\r\nindex fbf2db3ae..db9298cf0 100644\r\n--- a/packages/eth-json-rpc-provider/src/safe-event-emitter-provider.ts\r\n+++ b/packages/eth-json-rpc-provider/src/safe-event-emitter-provider.ts\r\n@@ -1,6 +1,11 @@\r\n import type { JsonRpcEngine } from '@metamask/json-rpc-engine';\r\n import SafeEventEmitter from '@metamask/safe-event-emitter';\r\n-import type { JsonRpcRequest } from '@metamask/utils';\r\n+import type {\r\n+  Json,\r\n+  JsonRpcParams,\r\n+  JsonRpcRequest,\r\n+  JsonRpcResponse,\r\n+} from '@metamask/utils';\r\n \r\n /**\r\n  * An Ethereum provider.\r\n@@ -34,9 +39,12 @@ export class SafeEventEmitterProvider extends SafeEventEmitter {\r\n    * @param req - The request to send.\r\n    * @param callback - A function that is called upon the success or failure of the request.\r\n    */\r\n-  sendAsync = (\r\n-    req: JsonRpcRequest,\r\n-    callback: (error: unknown, providerRes?: any) => void,\r\n+  sendAsync = <\r\n+    Params extends JsonRpcParams = JsonRpcParams,\r\n+    Result extends Json = Json,\r\n+  >(\r\n+    req: JsonRpcRequest<Params>,\r\n+    callback: (error: unknown, providerRes?: JsonRpcResponse<Result>) => void,\r\n   ) => {\r\n     this.#engine.handle(req, callback);\r\n   };\r\n@@ -51,9 +59,12 @@ export class SafeEventEmitterProvider extends SafeEventEmitter {\r\n    * @param req - The request to send.\r\n    * @param callback - A function that is called upon the success or failure of the request.\r\n    */\r\n-  send = (\r\n-    req: JsonRpcRequest,\r\n-    callback: (error: unknown, providerRes?: any) => void,\r\n+  send = <\r\n+    Params extends JsonRpcParams = JsonRpcParams,\r\n+    Result extends Json = Json,\r\n+  >(\r\n+    req: JsonRpcRequest<Params>,\r\n+    callback: (error: unknown, providerRes?: JsonRpcResponse<Result>) => void,\r\n   ) => {\r\n     if (typeof callback !== 'function') {\r\n       throw new Error('Must provide callback to \"send\" method.');\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/MetaMask/core/issues/comments/1819901532/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/MetaMask/core/issues/comments/1823347834",
    "html_url": "https://github.com/MetaMask/core/issues/1823#issuecomment-1823347834",
    "issue_url": "https://api.github.com/repos/MetaMask/core/issues/1823",
    "id": 1823347834,
    "node_id": "IC_kwDOCBB0Cc5srhR6",
    "user": {
      "login": "MajorLift",
      "id": 34228073,
      "node_id": "MDQ6VXNlcjM0MjI4MDcz",
      "avatar_url": "https://avatars.githubusercontent.com/u/34228073?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MajorLift",
      "html_url": "https://github.com/MajorLift",
      "followers_url": "https://api.github.com/users/MajorLift/followers",
      "following_url": "https://api.github.com/users/MajorLift/following{/other_user}",
      "gists_url": "https://api.github.com/users/MajorLift/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MajorLift/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MajorLift/subscriptions",
      "organizations_url": "https://api.github.com/users/MajorLift/orgs",
      "repos_url": "https://api.github.com/users/MajorLift/repos",
      "events_url": "https://api.github.com/users/MajorLift/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MajorLift/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-11-22T19:12:22Z",
    "updated_at": "2023-11-22T19:12:32Z",
    "author_association": "CONTRIBUTOR",
    "body": "The above is caused by the `@metamask/eth-query` version bump in `controller-utils` (https://github.com/MetaMask/core/pull/2028) not being released yet. The issue will be resolved by the next release that includes the unreleased changes in all of `@metamask/eth-query`'s downstream packages in core.",
    "reactions": {
      "url": "https://api.github.com/repos/MetaMask/core/issues/comments/1823347834/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
