{
  "url": "https://api.github.com/repos/MetaMask/core/issues/2043",
  "repository_url": "https://api.github.com/repos/MetaMask/core",
  "labels_url": "https://api.github.com/repos/MetaMask/core/issues/2043/labels{/name}",
  "comments_url": "https://api.github.com/repos/MetaMask/core/issues/2043/comments",
  "events_url": "https://api.github.com/repos/MetaMask/core/issues/2043/events",
  "html_url": "https://github.com/MetaMask/core/issues/2043",
  "id": 1994865161,
  "node_id": "I_kwDOCBB0Cc525zoJ",
  "number": 2043,
  "title": "Plan Merge `EthKeyringController` with `KeyringController`",
  "user": {
    "login": "mikesposito",
    "id": 34438276,
    "node_id": "MDQ6VXNlcjM0NDM4Mjc2",
    "avatar_url": "https://avatars.githubusercontent.com/u/34438276?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mikesposito",
    "html_url": "https://github.com/mikesposito",
    "followers_url": "https://api.github.com/users/mikesposito/followers",
    "following_url": "https://api.github.com/users/mikesposito/following{/other_user}",
    "gists_url": "https://api.github.com/users/mikesposito/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mikesposito/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mikesposito/subscriptions",
    "organizations_url": "https://api.github.com/users/mikesposito/orgs",
    "repos_url": "https://api.github.com/users/mikesposito/repos",
    "events_url": "https://api.github.com/users/mikesposito/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mikesposito/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 5330766523,
      "node_id": "LA_kwDOCBB0Cc8AAAABPb0Kuw",
      "url": "https://api.github.com/repos/MetaMask/core/labels/team-shared-libraries",
      "name": "team-shared-libraries",
      "color": "c5def5",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": {
    "login": "mikesposito",
    "id": 34438276,
    "node_id": "MDQ6VXNlcjM0NDM4Mjc2",
    "avatar_url": "https://avatars.githubusercontent.com/u/34438276?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mikesposito",
    "html_url": "https://github.com/mikesposito",
    "followers_url": "https://api.github.com/users/mikesposito/followers",
    "following_url": "https://api.github.com/users/mikesposito/following{/other_user}",
    "gists_url": "https://api.github.com/users/mikesposito/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mikesposito/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mikesposito/subscriptions",
    "organizations_url": "https://api.github.com/users/mikesposito/orgs",
    "repos_url": "https://api.github.com/users/mikesposito/repos",
    "events_url": "https://api.github.com/users/mikesposito/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mikesposito/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "mikesposito",
      "id": 34438276,
      "node_id": "MDQ6VXNlcjM0NDM4Mjc2",
      "avatar_url": "https://avatars.githubusercontent.com/u/34438276?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mikesposito",
      "html_url": "https://github.com/mikesposito",
      "followers_url": "https://api.github.com/users/mikesposito/followers",
      "following_url": "https://api.github.com/users/mikesposito/following{/other_user}",
      "gists_url": "https://api.github.com/users/mikesposito/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mikesposito/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mikesposito/subscriptions",
      "organizations_url": "https://api.github.com/users/mikesposito/orgs",
      "repos_url": "https://api.github.com/users/mikesposito/repos",
      "events_url": "https://api.github.com/users/mikesposito/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mikesposito/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2023-11-15T14:15:32Z",
  "updated_at": "2024-01-09T17:08:21Z",
  "closed_at": null,
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "## What is this about?\r\n\r\nHistorically, the `KeyringController` (`@metamask/keyring-controller`) and `EthKeyringController` (`@metamask/eth-keyring-controller`) were designed to cater to different clients, each with its own set of similar, yet not identical features, such as encryption mechanisms, supported keyrings, and business logic.\r\n\r\nOver recent quarters, we've undertaken a significant overhaul of the `KeyringController`'s API, enabling it to accommodate both sets of clients. As a result, the `EthKeyringController` has transitioned to a role where it operates as an internal component within the `KeyringController`.\r\n\r\nGiven the blurred lines of responsibility between the two controllers, and their shared management of the same state, it's becoming evident that the `EthKeyringController` functions more like an internal module of the `KeyringController`. It specifically manages certain aspects of the logic that the `KeyringController`'s API presents.\r\n\r\nWith this in mind, it seems possible (if not necessary) to consider the fusion of these two entities into a single, unified controller. This integrated controller would retain the `KeyringController`'s API and name, thereby allowing for a seamless transition for clients.\r\n\r\nSuch a consolidation would significantly streamline complexity and reduce the overhead associated with maintenance, simultaneously paving the way for more efficient and targeted future API enhancements (like, for example, the Keyring API consolidation).\r\n\r\n## To visualize it\r\n\r\n### The Past\r\n![past](https://github.com/MetaMask/core/assets/34438276/99b73974-a382-401f-9510-c1959e628350)\r\n---\r\n### The Present\r\n![now](https://github.com/MetaMask/core/assets/34438276/d983d5aa-defc-41b7-a837-c170e7d6047f)\r\n---\r\n### The Future\r\n![future](https://github.com/MetaMask/core/assets/34438276/5e8756af-b337-4476-8a0a-cb8b401f4416)\r\n\r\n## Nice! What are we waiting for?\r\n### Prerequisite assumptions\r\nWithout these assumptions, this plan should be considered blocked\r\n- [x] All clients use KeyringController, EthKeyringController is used by KeyringController only\r\n- [ ] KeyringController uses the latest version of EthKeyringController\r\n- [ ] EthKeyringController has no unpublished changes\r\n- [ ] EthKeyringController has no open PRs\r\n\r\n## How should the resulting controller look like?\r\n### Constructor & Class properties\r\n1. We can retain the KeyringController constructor, merging EthKeyringController's init logic in it\r\n2. `KeyringController.#keyring` will have to be removed, and `EthKeyringController.keyrings` should be moved to `KeyringController.#keyrings`\r\n3. In addition to the above, all public class properties of EthKeyringController should be moved to KeyringController (if necessary) as sharp private properties, so that they are inaccessible from outside KeyringController\r\n4. `EthKeyringController.#cacheEncryptionKey` and `.#encryptor` should be moved to `KeyringController.#cacheEncryptionKey` and `.#encryptor`\r\n\r\n### Controller State & Messenger\r\n1. We can retain the current state metadata and all (and only) the messenger actions & events from core KeyringController: this should be reasonably easy and non-breaking, as we can assume that currently no client uses (or have access to)  the _internal_ EthKeyringController, and all other controllers don’t have access to events emitted by EthKeyringController already.\r\n2. Any update logic for EthKeyringController's store and memStore, should update the KeyringController state instead \r\n\r\n#### State\r\n<details>\r\n  <summary>(same as current KeyringController)</summary>\r\n\r\n```typescript\r\n{\r\n  vault: { persist: true, anonymous: false },\r\n  isUnlocked: { persist: false, anonymous: true },\r\n  keyrings: { persist: false, anonymous: false },\r\n  encryptionKey: { persist: false, anonymous: false },\r\n  encryptionSalt: { persist: false, anonymous: false },\r\n}\r\n```\r\n</details>\r\n\r\n#### Events\r\n<details>\r\n  <summary>(same as current KeyringController)</summary>\r\n\r\n- KeyringControllerStateChangeEvent\r\n- KeyringControllerLockEvent\r\n- KeyringControllerUnlockEvent\r\n- KeyringControllerAccountRemovedEvent\r\n- KeyringControllerQRKeyringStateChangeEvent\r\n</details>\r\n\r\n#### Actions\r\n<details>\r\n  <summary>(same as current KeyringController)</summary>\r\n\r\n- KeyringControllerGetStateAction\r\n- KeyringControllerSignMessageAction\r\n- KeyringControllerSignPersonalMessageAction\r\n- KeyringControllerSignTypedMessageAction\r\n- KeyringControllerDecryptMessageAction\r\n- KeyringControllerGetEncryptionPublicKeyAction\r\n- KeyringControllerGetAccountsAction\r\n- KeyringControllerGetKeyringsByTypeAction\r\n- KeyringControllerGetKeyringForAccountAction\r\n- KeyringControllerPersistAllKeyringsAction\r\n</details>\r\n\r\n### Public Methods\r\n1. For the same reason as above, the minimum API coverage should be represented by the current KeyringController public API.\r\n2. All current public & private methods in EthKeyringController can be considered as _potential_ private methods in the resulting new KeyringController API\r\n3. Some of the KeyringController public methods have a direct counterpart in  EthKeyringController, most of the times even with the same name: there are instances of these where we can merge (or cut-paste :D) the logic from the EthKeyringController method into the KeyringController’s counterpart (which will be the one we’ll retain).\r\n4. There is some logic in the current KeyringController which is directly related to maintaining the two controller state in sync (e.g. `fullUpdate`): we can remove this logic completely, as the resulting single controller will have a single state, and all external clients can use the KeyringController messenger to subscribe to state updates\r\n\r\n**The resulting API should look like this:**\r\n<details>\r\n  <summary>(same as current KeyringController)</summary>\r\n\r\n- addNewAccount\r\n- addNewAccountForKeyring\r\n- addNewAccountWithoutUpdate\r\n- createNewVaultWithKeyring\r\n- addNewKeyring\r\n- verifyPassword\r\n- isUnlocked\r\n- exportSeedPhrase\r\n- exportAccount\r\n- getAccounts\r\n- getEncryptionPublicKey\r\n- decryptMessage\r\n- getKeyringForAccount\r\n- getKeyringsByType\r\n- persistAllKeyrings\r\n- importAccountWithStrategy\r\n- removeAccount\r\n- setLocked\r\n- signMessage\r\n- signPersonalMessage\r\n- signTypedMessage\r\n- signTransaction\r\n- submitEncryptionKey\r\n- submitPassword\r\n- verifySeedPhrase\r\n- getQRKeyring\r\n- getOrAddQRKeyring\r\n- restoreQRKeyring\r\n- resetQRKeyringState\r\n- getQRKeyringState\r\n- submitQRCryptoHDKey\r\n- submitQRCryptoAccount\r\n- submitQRSignature\r\n- cancelQRSignRequest\r\n- cancelQRSynchronization\r\n- connectQRHardware\r\n- unlockQRHardwareWalletAccount\r\n- getAccountKeyringType\r\n- forgetQRDevice\r\n</details>\r\n\r\n### Types & Utils\r\n1. The keyring builder factory should be migrated to the `@metamask/keyring-controller` package\r\n2. Types related to the Encryptor should also be migrated\r\n\r\n### Tests\r\nThe starting point of the controllers is not bad in terms of test coverage, but when porting the logic of EthKeyringController’s methods into KeyringController’s one, there will be a significant drop: we’ll have to compensate that, adding new test cases where necessary (porting EthKeyringController’s tests when possible) \r\n\r\n### Additional Notes\r\n1. Currently, the accounts team is adding User Operations support on EthKeyringController\r\n2. Currently, `createNewVaultAndKeyring` and `createNewVaultAndRestore` are being unified on EthKeyringController (potentially also on KeyringController)\r\n\r\n## How can we do this?\r\n\r\n### Action items (Potential PRs/Issues)\r\n1. Merge EthKeyringController into KeyringController: This could also be done in multiple PRs, making this step easily reviewable\r\n2. Bump KeyringController test coverage to 100% (can also go in the same PR with 1.)\r\n3. Archive EthKeyringController repo, adding a notice in the readme to link to the core KeyringController",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/MetaMask/core/issues/2043/reactions",
    "total_count": 2,
    "+1": 2,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/MetaMask/core/issues/2043/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/MetaMask/core/issues/comments/1823102764",
    "html_url": "https://github.com/MetaMask/core/issues/2043#issuecomment-1823102764",
    "issue_url": "https://api.github.com/repos/MetaMask/core/issues/2043",
    "id": 1823102764,
    "node_id": "IC_kwDOCBB0Cc5sqlcs",
    "user": {
      "login": "desi",
      "id": 15041,
      "node_id": "MDQ6VXNlcjE1MDQx",
      "avatar_url": "https://avatars.githubusercontent.com/u/15041?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/desi",
      "html_url": "https://github.com/desi",
      "followers_url": "https://api.github.com/users/desi/followers",
      "following_url": "https://api.github.com/users/desi/following{/other_user}",
      "gists_url": "https://api.github.com/users/desi/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/desi/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/desi/subscriptions",
      "organizations_url": "https://api.github.com/users/desi/orgs",
      "repos_url": "https://api.github.com/users/desi/repos",
      "events_url": "https://api.github.com/users/desi/events{/privacy}",
      "received_events_url": "https://api.github.com/users/desi/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-11-22T16:34:06Z",
    "updated_at": "2023-11-22T16:34:06Z",
    "author_association": "NONE",
    "body": "We should come up with a strategy here to figure out best plan forward and then estimate. We can convert this ticket to be to determine the plan. ",
    "reactions": {
      "url": "https://api.github.com/repos/MetaMask/core/issues/comments/1823102764/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/MetaMask/core/issues/comments/1882886951",
    "html_url": "https://github.com/MetaMask/core/issues/2043#issuecomment-1882886951",
    "issue_url": "https://api.github.com/repos/MetaMask/core/issues/2043",
    "id": 1882886951,
    "node_id": "IC_kwDOCBB0Cc5wOpMn",
    "user": {
      "login": "mikesposito",
      "id": 34438276,
      "node_id": "MDQ6VXNlcjM0NDM4Mjc2",
      "avatar_url": "https://avatars.githubusercontent.com/u/34438276?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mikesposito",
      "html_url": "https://github.com/mikesposito",
      "followers_url": "https://api.github.com/users/mikesposito/followers",
      "following_url": "https://api.github.com/users/mikesposito/following{/other_user}",
      "gists_url": "https://api.github.com/users/mikesposito/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mikesposito/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mikesposito/subscriptions",
      "organizations_url": "https://api.github.com/users/mikesposito/orgs",
      "repos_url": "https://api.github.com/users/mikesposito/repos",
      "events_url": "https://api.github.com/users/mikesposito/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mikesposito/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2024-01-09T11:19:44Z",
    "updated_at": "2024-01-09T13:50:59Z",
    "author_association": "CONTRIBUTOR",
    "body": "Plan added to [main comment](https://github.com/MetaMask/core/issues/2043#issue-1994865161)",
    "reactions": {
      "url": "https://api.github.com/repos/MetaMask/core/issues/comments/1882886951/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/MetaMask/core/issues/comments/1883418494",
    "html_url": "https://github.com/MetaMask/core/issues/2043#issuecomment-1883418494",
    "issue_url": "https://api.github.com/repos/MetaMask/core/issues/2043",
    "id": 1883418494,
    "node_id": "IC_kwDOCBB0Cc5wQq9-",
    "user": {
      "login": "mikesposito",
      "id": 34438276,
      "node_id": "MDQ6VXNlcjM0NDM4Mjc2",
      "avatar_url": "https://avatars.githubusercontent.com/u/34438276?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mikesposito",
      "html_url": "https://github.com/mikesposito",
      "followers_url": "https://api.github.com/users/mikesposito/followers",
      "following_url": "https://api.github.com/users/mikesposito/following{/other_user}",
      "gists_url": "https://api.github.com/users/mikesposito/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mikesposito/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mikesposito/subscriptions",
      "organizations_url": "https://api.github.com/users/mikesposito/orgs",
      "repos_url": "https://api.github.com/users/mikesposito/repos",
      "events_url": "https://api.github.com/users/mikesposito/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mikesposito/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2024-01-09T16:52:05Z",
    "updated_at": "2024-01-09T16:57:30Z",
    "author_association": "CONTRIBUTOR",
    "body": "The following action point:\r\n> 4. Migrate (if any) open issues and PRs from EthKeyringController to KeyringController \r\n\r\nHas been removed, as it will be difficult to move PRs across repos.  We'll have to close (or land) any PR that is currently open on EthKeyringController as a prerequisite for the merge. ",
    "reactions": {
      "url": "https://api.github.com/repos/MetaMask/core/issues/comments/1883418494/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/MetaMask/core/issues/comments/1883450936",
    "html_url": "https://github.com/MetaMask/core/issues/2043#issuecomment-1883450936",
    "issue_url": "https://api.github.com/repos/MetaMask/core/issues/2043",
    "id": 1883450936,
    "node_id": "IC_kwDOCBB0Cc5wQy44",
    "user": {
      "login": "Gudahtt",
      "id": 2459287,
      "node_id": "MDQ6VXNlcjI0NTkyODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2459287?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Gudahtt",
      "html_url": "https://github.com/Gudahtt",
      "followers_url": "https://api.github.com/users/Gudahtt/followers",
      "following_url": "https://api.github.com/users/Gudahtt/following{/other_user}",
      "gists_url": "https://api.github.com/users/Gudahtt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Gudahtt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Gudahtt/subscriptions",
      "organizations_url": "https://api.github.com/users/Gudahtt/orgs",
      "repos_url": "https://api.github.com/users/Gudahtt/repos",
      "events_url": "https://api.github.com/users/Gudahtt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Gudahtt/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2024-01-09T17:08:19Z",
    "updated_at": "2024-01-09T17:08:19Z",
    "author_association": "MEMBER",
    "body": "Looks good to me!",
    "reactions": {
      "url": "https://api.github.com/repos/MetaMask/core/issues/comments/1883450936/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
