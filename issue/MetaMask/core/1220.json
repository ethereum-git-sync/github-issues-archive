{
  "url": "https://api.github.com/repos/MetaMask/core/issues/1220",
  "repository_url": "https://api.github.com/repos/MetaMask/core",
  "labels_url": "https://api.github.com/repos/MetaMask/core/issues/1220/labels{/name}",
  "comments_url": "https://api.github.com/repos/MetaMask/core/issues/1220/comments",
  "events_url": "https://api.github.com/repos/MetaMask/core/issues/1220/events",
  "html_url": "https://github.com/MetaMask/core/issues/1220",
  "id": 1675328776,
  "node_id": "I_kwDOCBB0Cc5j230I",
  "number": 1220,
  "title": "NetworkController: `rollbackToPreviousProvider` does not account for RPC-based provider config without associated network configuration ID",
  "user": {
    "login": "mcmire",
    "id": 7371,
    "node_id": "MDQ6VXNlcjczNzE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/7371?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mcmire",
    "html_url": "https://github.com/mcmire",
    "followers_url": "https://api.github.com/users/mcmire/followers",
    "following_url": "https://api.github.com/users/mcmire/following{/other_user}",
    "gists_url": "https://api.github.com/users/mcmire/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mcmire/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mcmire/subscriptions",
    "organizations_url": "https://api.github.com/users/mcmire/orgs",
    "repos_url": "https://api.github.com/users/mcmire/repos",
    "events_url": "https://api.github.com/users/mcmire/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mcmire/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 948148992,
      "node_id": "MDU6TGFiZWw5NDgxNDg5OTI=",
      "url": "https://api.github.com/repos/MetaMask/core/labels/bug",
      "name": "bug",
      "color": "d73a4a",
      "default": true,
      "description": "Something isn't working"
    },
    {
      "id": 5330766523,
      "node_id": "LA_kwDOCBB0Cc8AAAABPb0Kuw",
      "url": "https://api.github.com/repos/MetaMask/core/labels/team-shared-libraries",
      "name": "team-shared-libraries",
      "color": "c5def5",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "mcmire",
    "id": 7371,
    "node_id": "MDQ6VXNlcjczNzE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/7371?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mcmire",
    "html_url": "https://github.com/mcmire",
    "followers_url": "https://api.github.com/users/mcmire/followers",
    "following_url": "https://api.github.com/users/mcmire/following{/other_user}",
    "gists_url": "https://api.github.com/users/mcmire/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mcmire/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mcmire/subscriptions",
    "organizations_url": "https://api.github.com/users/mcmire/orgs",
    "repos_url": "https://api.github.com/users/mcmire/repos",
    "events_url": "https://api.github.com/users/mcmire/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mcmire/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "mcmire",
      "id": 7371,
      "node_id": "MDQ6VXNlcjczNzE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7371?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mcmire",
      "html_url": "https://github.com/mcmire",
      "followers_url": "https://api.github.com/users/mcmire/followers",
      "following_url": "https://api.github.com/users/mcmire/following{/other_user}",
      "gists_url": "https://api.github.com/users/mcmire/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mcmire/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mcmire/subscriptions",
      "organizations_url": "https://api.github.com/users/mcmire/orgs",
      "repos_url": "https://api.github.com/users/mcmire/repos",
      "events_url": "https://api.github.com/users/mcmire/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mcmire/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2023-04-19T17:29:47Z",
  "updated_at": "2023-05-05T17:37:47Z",
  "closed_at": "2023-05-05T17:37:47Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "If you initialize NetworkController with the following in state:\r\n\r\n```\r\n{\r\n  providerConfig: {\r\n    type: NetworkType.rpc,\r\n    rpcTarget: 'https://mock-rpc-url',\r\n    chainId: '0x1337',\r\n  }\r\n}\r\n```\r\n\r\nthen if you switch the network, then call `rollbackToPreviousProvider` again, the result won't be what you expect.\r\n\r\nFacts:\r\n\r\n* This version of NetworkController has two methods to switch networks: `setProviderType` and `setActiveNetwork`. (The latter method replaced `setRpcTarget` when network configurations were introduced.)\r\n\r\n* `rollbackToPreviousProvider` checks to see what `#previousNetworkSpecifier` is to figure out whether to call `setProviderType` or `setActiveNetwork`.\r\n\r\n* What is `#previousNetworkSpecifier`? This property is designed to hold either a network configuration ID, or a \"provider type\" (i.e. anything that `#configureProvider` recognizes). But it will only hold a network configuration ID if it refers to a custom endpoint; otherwise it holds the provider type.\r\n\r\n* When does `#previousNetworkSpecifier` get set? In two instances:\r\n\r\n  1. Before the network gets switched. In this case if the old network is a custom network (provider type is \"rpc\") and the provider config has a reference to a network configuration ID, then it'll be that network configuration ID. Otherwise, it'll be the provider type.\r\n  2. When the NetworkConfiguration is initialized. In this case it's always the provider type, regardless of whether it's \"rpc\" or not.\r\n  \r\nSo what does this mean? Because `#previousNetworkSpecifier` is set in the constructor and is always set to the provider type, that means that it is possible for `#previousNetworkSpecifier` to be \"rpc\" and the provider config have no reference to a network configuration ID. In that case, `rollbackToPreviousProvider` will try to call `setProviderType` with a provider type of \"rpc\". This doesn't make any sense, because it's designed to be passed an _Infura_ provider type. Because in that case the `rpcTarget` is cleared out, attempting to talk to the network after that wouldn't work.",
  "closed_by": {
    "login": "mcmire",
    "id": 7371,
    "node_id": "MDQ6VXNlcjczNzE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/7371?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mcmire",
    "html_url": "https://github.com/mcmire",
    "followers_url": "https://api.github.com/users/mcmire/followers",
    "following_url": "https://api.github.com/users/mcmire/following{/other_user}",
    "gists_url": "https://api.github.com/users/mcmire/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mcmire/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mcmire/subscriptions",
    "organizations_url": "https://api.github.com/users/mcmire/orgs",
    "repos_url": "https://api.github.com/users/mcmire/repos",
    "events_url": "https://api.github.com/users/mcmire/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mcmire/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/MetaMask/core/issues/1220/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/MetaMask/core/issues/1220/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/MetaMask/core/issues/comments/1515273290",
    "html_url": "https://github.com/MetaMask/core/issues/1220#issuecomment-1515273290",
    "issue_url": "https://api.github.com/repos/MetaMask/core/issues/1220",
    "id": 1515273290,
    "node_id": "IC_kwDOCBB0Cc5aUTxK",
    "user": {
      "login": "mcmire",
      "id": 7371,
      "node_id": "MDQ6VXNlcjczNzE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7371?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mcmire",
      "html_url": "https://github.com/mcmire",
      "followers_url": "https://api.github.com/users/mcmire/followers",
      "following_url": "https://api.github.com/users/mcmire/following{/other_user}",
      "gists_url": "https://api.github.com/users/mcmire/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mcmire/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mcmire/subscriptions",
      "organizations_url": "https://api.github.com/users/mcmire/orgs",
      "repos_url": "https://api.github.com/users/mcmire/repos",
      "events_url": "https://api.github.com/users/mcmire/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mcmire/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-19T19:36:17Z",
    "updated_at": "2023-04-19T19:36:17Z",
    "author_association": "CONTRIBUTOR",
    "body": "The easiest way to fix this would be to do what the extension does, and to capture the whole provider config object, whether it comes through initially in state or is set as a result of switching the network, as the \"previous\" version, and then use this in `rollbackToPreviousProvider`.",
    "reactions": {
      "url": "https://api.github.com/repos/MetaMask/core/issues/comments/1515273290/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
