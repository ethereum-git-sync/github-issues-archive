{
  "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/1018",
  "repository_url": "https://api.github.com/repos/ethereum-optimism/optimism",
  "labels_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/1018/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/1018/comments",
  "events_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/1018/events",
  "html_url": "https://github.com/ethereum-optimism/optimism/issues/1018",
  "id": 910872254,
  "node_id": "MDU6SXNzdWU5MTA4NzIyNTQ=",
  "number": 1018,
  "title": "Watcher can fail to find transactions in a specific edge-case",
  "user": {
    "login": "smartcontracts",
    "id": 14298799,
    "node_id": "MDQ6VXNlcjE0Mjk4Nzk5",
    "avatar_url": "https://avatars.githubusercontent.com/u/14298799?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/smartcontracts",
    "html_url": "https://github.com/smartcontracts",
    "followers_url": "https://api.github.com/users/smartcontracts/followers",
    "following_url": "https://api.github.com/users/smartcontracts/following{/other_user}",
    "gists_url": "https://api.github.com/users/smartcontracts/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/smartcontracts/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/smartcontracts/subscriptions",
    "organizations_url": "https://api.github.com/users/smartcontracts/orgs",
    "repos_url": "https://api.github.com/users/smartcontracts/repos",
    "events_url": "https://api.github.com/users/smartcontracts/events{/privacy}",
    "received_events_url": "https://api.github.com/users/smartcontracts/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 2907832490,
      "node_id": "MDU6TGFiZWwyOTA3ODMyNDkw",
      "url": "https://api.github.com/repos/ethereum-optimism/optimism/labels/C-bug",
      "name": "C-bug",
      "color": "C5DEF5",
      "default": false,
      "description": "Category: This is a bug."
    },
    {
      "id": 2978714528,
      "node_id": "MDU6TGFiZWwyOTc4NzE0NTI4",
      "url": "https://api.github.com/repos/ethereum-optimism/optimism/labels/good%20first%20issue",
      "name": "good first issue",
      "color": "C2E0C6",
      "default": true,
      "description": ""
    },
    {
      "id": 2981541772,
      "node_id": "MDU6TGFiZWwyOTgxNTQxNzcy",
      "url": "https://api.github.com/repos/ethereum-optimism/optimism/labels/P-confirmed",
      "name": "P-confirmed",
      "color": "BFD4F2",
      "default": false,
      "description": "A confirmed bug"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2021-06-03T21:36:24Z",
  "updated_at": "2021-06-22T14:30:44Z",
  "closed_at": "2021-06-22T14:30:44Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "<!--\r\nNeed help?\r\nRefer to our contributing guidelines for additional information about making a good issue:\r\nhttps://github.com/ethereum-optimism/.github/blob/master/CONTRIBUTING.md\r\n-->\r\n\r\n**Describe the bug**\r\nThe [Watcher utility](https://github.com/ethereum-optimism/optimism/blob/develop/packages/core-utils/src/watcher.ts) can fail to find transactions when transaction volume is particularly high. Here's my best explanation of what's going on:\r\n\r\n1. Watcher first tries to find all existing events: https://github.com/ethereum-optimism/optimism/blob/1c1e405cc53c0ef5c0f3e6db471a69a6f1f076fa/packages/core-utils/src/watcher.ts#L76-L91\r\n2. If the watcher can't find the message relay event in historical blocks, it then installs an event listener until the event is found: https://github.com/ethereum-optimism/optimism/blob/1c1e405cc53c0ef5c0f3e6db471a69a6f1f076fa/packages/core-utils/src/watcher.ts#L107-L125\r\n\r\nThis causes an issue in the following case:\r\n1. Spam a lot of L1 => L2 transactions.\r\n2. Attempt to wait for L1 => L2 transaction N, assume it hasn't been processed yet because L2 geth is still processing all transactions 0...N-1.\r\n3. Assume the highest block at step (1) above is some M < N. Step (1) will NOT find the event for transaction N.\r\n4. Assume that in between step (1) and step (2), transactions M...P, P > N are processed.\r\n5. Step (2) will NOT find the event for transaction N because the listener is installed AFTER the event has already been emitted.\r\n\r\n**To Reproduce**\r\nSomewhat difficult to reproduce. I discovered this while working on https://github.com/ethereum-optimism/optimism/pull/971. You can try to reproduce by building that branch and executing [this test](https://github.com/ethereum-optimism/optimism/pull/971/files#diff-0f1742d0ed9aef19c2442abdd9004489ebc95d44dfaf7198344e76735e4fde54R65-R80).\r\n\r\n**Expected behavior**\r\nWatcher will find all transactions even in cases of high system load.\r\n\r\n**Proposed fix**\r\nInstall the listener BEFORE searching for historical transactions. I think. We just need some new code that 100% guarantees that all blocks will be searched. We could also alternatively NOT make use of the listeners and instead simply scan blocks \"the old fashioned way\" (in ranges of blocks).\r\n",
  "closed_by": {
    "login": "snario",
    "id": 1933029,
    "node_id": "MDQ6VXNlcjE5MzMwMjk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1933029?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/snario",
    "html_url": "https://github.com/snario",
    "followers_url": "https://api.github.com/users/snario/followers",
    "following_url": "https://api.github.com/users/snario/following{/other_user}",
    "gists_url": "https://api.github.com/users/snario/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/snario/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/snario/subscriptions",
    "organizations_url": "https://api.github.com/users/snario/orgs",
    "repos_url": "https://api.github.com/users/snario/repos",
    "events_url": "https://api.github.com/users/snario/events{/privacy}",
    "received_events_url": "https://api.github.com/users/snario/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/1018/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/1018/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/862038823",
    "html_url": "https://github.com/ethereum-optimism/optimism/issues/1018#issuecomment-862038823",
    "issue_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/1018",
    "id": 862038823,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg2MjAzODgyMw==",
    "user": {
      "login": "rajivpo",
      "id": 19913716,
      "node_id": "MDQ6VXNlcjE5OTEzNzE2",
      "avatar_url": "https://avatars.githubusercontent.com/u/19913716?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rajivpo",
      "html_url": "https://github.com/rajivpo",
      "followers_url": "https://api.github.com/users/rajivpo/followers",
      "following_url": "https://api.github.com/users/rajivpo/following{/other_user}",
      "gists_url": "https://api.github.com/users/rajivpo/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rajivpo/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rajivpo/subscriptions",
      "organizations_url": "https://api.github.com/users/rajivpo/orgs",
      "repos_url": "https://api.github.com/users/rajivpo/repos",
      "events_url": "https://api.github.com/users/rajivpo/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rajivpo/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-06-16T04:57:19Z",
    "updated_at": "2021-06-16T04:57:19Z",
    "author_association": "CONTRIBUTOR",
    "body": "Alright if this is still unclaimed, I'm down to work on it.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/862038823/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 1
    },
    "performed_via_github_app": null
  }
]
