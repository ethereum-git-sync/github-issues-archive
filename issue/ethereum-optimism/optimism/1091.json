{
  "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/1091",
  "repository_url": "https://api.github.com/repos/ethereum-optimism/optimism",
  "labels_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/1091/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/1091/comments",
  "events_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/1091/events",
  "html_url": "https://github.com/ethereum-optimism/optimism/issues/1091",
  "id": 921477799,
  "node_id": "MDU6SXNzdWU5MjE0Nzc3OTk=",
  "number": 1091,
  "title": "[docs] Potential inconsistency between documentation and code for the compiler",
  "user": {
    "login": "tan-wei",
    "id": 28227509,
    "node_id": "MDQ6VXNlcjI4MjI3NTA5",
    "avatar_url": "https://avatars.githubusercontent.com/u/28227509?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tan-wei",
    "html_url": "https://github.com/tan-wei",
    "followers_url": "https://api.github.com/users/tan-wei/followers",
    "following_url": "https://api.github.com/users/tan-wei/following{/other_user}",
    "gists_url": "https://api.github.com/users/tan-wei/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tan-wei/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tan-wei/subscriptions",
    "organizations_url": "https://api.github.com/users/tan-wei/orgs",
    "repos_url": "https://api.github.com/users/tan-wei/repos",
    "events_url": "https://api.github.com/users/tan-wei/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tan-wei/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 2907832604,
      "node_id": "MDU6TGFiZWwyOTA3ODMyNjA0",
      "url": "https://api.github.com/repos/ethereum-optimism/optimism/labels/C-question",
      "name": "C-question",
      "color": "C5DEF5",
      "default": false,
      "description": "User questions that are neither feature requests nor bug reports"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2021-06-15T14:45:10Z",
  "updated_at": "2021-06-16T00:33:56Z",
  "closed_at": "2021-06-16T00:33:56Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "<!--\r\nNeed help?\r\nRefer to our contributing guidelines for additional information about making a good issue:\r\nhttps://github.com/ethereum-optimism/.github/blob/master/CONTRIBUTING.md\r\n-->\r\n\r\n**Describe the bug**\r\nIn the [document](https://community.optimism.io/docs/protocol/protocol.html#execution-contracts), it says that\r\n```\r\n* The CALLER, CALL, and REVERT opcodes are also disallowed, except in the special case that they appear as part of one of the following strings of bytecode:\r\n\r\n    CALLER PUSH1 0x00 SWAP1 GAS CALL PC PUSH1 0x0E ADD JUMPI RETURNDATASIZE PUSH1 0x00 DUP1 RETURNDATACOPY RETURNDATASIZE PUSH1 0x00 REVERT JUMPDEST RETURNDATASIZE PUSH1 0x01 EQ ISZERO PC PUSH1 0x0a ADD JUMPI PUSH1 0x01 PUSH1 0x00 RETURN JUMPDEST\r\n```\r\nHowever, we can see the code is implemented [here](https://github.com/ethereum-optimism/solidity/blob/df005f39493525b43f1153dff8da5910a2b83e34/libyul/backends/evm/EVMDialect.cpp#L119), but some differences, for example: `0x0E` vs `_assembly.appendConstant(29)`.\r\n\r\nAny inconsistence here? Or my misunderstanding about the document or code? Thanks very much.\r\n",
  "closed_by": {
    "login": "tan-wei",
    "id": 28227509,
    "node_id": "MDQ6VXNlcjI4MjI3NTA5",
    "avatar_url": "https://avatars.githubusercontent.com/u/28227509?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tan-wei",
    "html_url": "https://github.com/tan-wei",
    "followers_url": "https://api.github.com/users/tan-wei/followers",
    "following_url": "https://api.github.com/users/tan-wei/following{/other_user}",
    "gists_url": "https://api.github.com/users/tan-wei/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tan-wei/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tan-wei/subscriptions",
    "organizations_url": "https://api.github.com/users/tan-wei/orgs",
    "repos_url": "https://api.github.com/users/tan-wei/repos",
    "events_url": "https://api.github.com/users/tan-wei/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tan-wei/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/1091/reactions",
    "total_count": 1,
    "+1": 1,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/1091/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/861650309",
    "html_url": "https://github.com/ethereum-optimism/optimism/issues/1091#issuecomment-861650309",
    "issue_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/1091",
    "id": 861650309,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg2MTY1MDMwOQ==",
    "user": {
      "login": "smartcontracts",
      "id": 14298799,
      "node_id": "MDQ6VXNlcjE0Mjk4Nzk5",
      "avatar_url": "https://avatars.githubusercontent.com/u/14298799?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/smartcontracts",
      "html_url": "https://github.com/smartcontracts",
      "followers_url": "https://api.github.com/users/smartcontracts/followers",
      "following_url": "https://api.github.com/users/smartcontracts/following{/other_user}",
      "gists_url": "https://api.github.com/users/smartcontracts/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/smartcontracts/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/smartcontracts/subscriptions",
      "organizations_url": "https://api.github.com/users/smartcontracts/orgs",
      "repos_url": "https://api.github.com/users/smartcontracts/repos",
      "events_url": "https://api.github.com/users/smartcontracts/events{/privacy}",
      "received_events_url": "https://api.github.com/users/smartcontracts/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-06-15T16:30:51Z",
    "updated_at": "2021-06-15T16:30:51Z",
    "author_association": "CONTRIBUTOR",
    "body": "I've asked @ben-chain to answer this question as he has the most context here.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/861650309/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/861660970",
    "html_url": "https://github.com/ethereum-optimism/optimism/issues/1091#issuecomment-861660970",
    "issue_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/1091",
    "id": 861660970,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg2MTY2MDk3MA==",
    "user": {
      "login": "ben-chain",
      "id": 10091895,
      "node_id": "MDQ6VXNlcjEwMDkxODk1",
      "avatar_url": "https://avatars.githubusercontent.com/u/10091895?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ben-chain",
      "html_url": "https://github.com/ben-chain",
      "followers_url": "https://api.github.com/users/ben-chain/followers",
      "following_url": "https://api.github.com/users/ben-chain/following{/other_user}",
      "gists_url": "https://api.github.com/users/ben-chain/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ben-chain/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ben-chain/subscriptions",
      "organizations_url": "https://api.github.com/users/ben-chain/orgs",
      "repos_url": "https://api.github.com/users/ben-chain/repos",
      "events_url": "https://api.github.com/users/ben-chain/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ben-chain/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-06-15T16:46:22Z",
    "updated_at": "2021-06-15T16:47:20Z",
    "author_association": "COLLABORATOR",
    "body": "Hey @tan-wei , this is a great question--the answer has to do with some of the limitations of yul/solidity at the time the compiler was written.  In particular, what you see in `CompilerContext.cpp` is us \"sidestepping the optimizer\" -- it is a bytestring of the same number of bytes that we want, but un-optimizable. The optimizer really did not like the `JUMPDEST`s in the documented \"safe bytestring\" and would toss it out.  So what we did was chose a value that the optimizer would never think it can improve upon.  Then, as a final step in the compilation process, we actually go in and [find/replace with the \"real\" string,](https://github.com/ethereum-optimism/solidity/compare/7338295..develop-0.7#diff-0f19df92d55a7d7fe38fdf4be1e14b364671c4934853d13a33b31aedf3f917bdR1168-R1280) once the optimizer has already been applied.  So the final output of the compiler is ultimately consistent with the documentation, but wrong in the middle, so that the optimizer doesn't toss it out. ðŸ˜…\r\n\r\nThis is why we have worked with the solidity team to get the `verbatim` builtin into yul.  This has been [included in the latest release](https://blog.soliditylang.org/2021/06/10/solidity-0.8.5-release-announcement/), and is documented [here](https://docs.soliditylang.org/en/v0.8.5/yul.html#verbatim).  From the docs: \"It also allows you to create bytecode sequences that will not be modified by the optimizer.\"  This is exactly what will allow us to get rid of the confusing logic you've noticed. :) ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/861660970/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/861892563",
    "html_url": "https://github.com/ethereum-optimism/optimism/issues/1091#issuecomment-861892563",
    "issue_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/1091",
    "id": 861892563,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg2MTg5MjU2Mw==",
    "user": {
      "login": "smartcontracts",
      "id": 14298799,
      "node_id": "MDQ6VXNlcjE0Mjk4Nzk5",
      "avatar_url": "https://avatars.githubusercontent.com/u/14298799?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/smartcontracts",
      "html_url": "https://github.com/smartcontracts",
      "followers_url": "https://api.github.com/users/smartcontracts/followers",
      "following_url": "https://api.github.com/users/smartcontracts/following{/other_user}",
      "gists_url": "https://api.github.com/users/smartcontracts/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/smartcontracts/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/smartcontracts/subscriptions",
      "organizations_url": "https://api.github.com/users/smartcontracts/orgs",
      "repos_url": "https://api.github.com/users/smartcontracts/repos",
      "events_url": "https://api.github.com/users/smartcontracts/events{/privacy}",
      "received_events_url": "https://api.github.com/users/smartcontracts/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-06-15T23:11:25Z",
    "updated_at": "2021-06-15T23:11:25Z",
    "author_association": "CONTRIBUTOR",
    "body": "Hi @tan-wei, does the response from @ben-chain answer your question? Please let us know if not and we can expand on the information if anything is unclear.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/861892563/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/861922255",
    "html_url": "https://github.com/ethereum-optimism/optimism/issues/1091#issuecomment-861922255",
    "issue_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/1091",
    "id": 861922255,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg2MTkyMjI1NQ==",
    "user": {
      "login": "tan-wei",
      "id": 28227509,
      "node_id": "MDQ6VXNlcjI4MjI3NTA5",
      "avatar_url": "https://avatars.githubusercontent.com/u/28227509?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tan-wei",
      "html_url": "https://github.com/tan-wei",
      "followers_url": "https://api.github.com/users/tan-wei/followers",
      "following_url": "https://api.github.com/users/tan-wei/following{/other_user}",
      "gists_url": "https://api.github.com/users/tan-wei/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tan-wei/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tan-wei/subscriptions",
      "organizations_url": "https://api.github.com/users/tan-wei/orgs",
      "repos_url": "https://api.github.com/users/tan-wei/repos",
      "events_url": "https://api.github.com/users/tan-wei/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tan-wei/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-06-16T00:33:56Z",
    "updated_at": "2021-06-16T00:33:56Z",
    "author_association": "NONE",
    "body": "OK, thanks very much to @ben-chain and @smartcontracts , quite clear for me. I think the issue could be closed.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/861922255/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 1,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
