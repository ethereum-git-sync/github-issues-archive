{
  "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/585",
  "repository_url": "https://api.github.com/repos/ethereum-optimism/optimism",
  "labels_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/585/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/585/comments",
  "events_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/585/events",
  "html_url": "https://github.com/ethereum-optimism/optimism/issues/585",
  "id": 866284172,
  "node_id": "MDU6SXNzdWU4NjYyODQxNzI=",
  "number": 585,
  "title": "Flickering integration test #2 (symptom: gas estimation value mismatch)",
  "user": {
    "login": "snario",
    "id": 1933029,
    "node_id": "MDQ6VXNlcjE5MzMwMjk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1933029?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/snario",
    "html_url": "https://github.com/snario",
    "followers_url": "https://api.github.com/users/snario/followers",
    "following_url": "https://api.github.com/users/snario/following{/other_user}",
    "gists_url": "https://api.github.com/users/snario/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/snario/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/snario/subscriptions",
    "organizations_url": "https://api.github.com/users/snario/orgs",
    "repos_url": "https://api.github.com/users/snario/repos",
    "events_url": "https://api.github.com/users/snario/events{/privacy}",
    "received_events_url": "https://api.github.com/users/snario/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 2907832490,
      "node_id": "MDU6TGFiZWwyOTA3ODMyNDkw",
      "url": "https://api.github.com/repos/ethereum-optimism/optimism/labels/C-bug",
      "name": "C-bug",
      "color": "C5DEF5",
      "default": false,
      "description": "Category: This is a bug."
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2021-04-23T17:00:52Z",
  "updated_at": "2021-04-30T13:03:36Z",
  "closed_at": "2021-04-30T13:03:36Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "We're seeing a flickering integration test related to ETH gas estimation:\r\n\r\n**Example**\r\nhttps://github.com/ethereum-optimism/optimism/runs/2415971705?check_suite_focus=true\r\n\r\n**Log**\r\n```\r\n  1) Native ETH Integration Tests\r\n       estimateGas\r\n         Should estimate gas for ETH transfer:\r\n      AssertionError: expected { Object (_hex, _isBigNumber) } to deeply equal { Object (_hex, _isBigNumber) }\r\n      + expected - actual\r\n       {\r\n      -  \"_hex\": \"0x0341be\"\r\n      +  \"_hex\": \"0x03422a\"\r\n         \"_isBigNumber\": true\r\n       }\r\n      at Context.<anonymous> (test/native-eth.spec.ts:38:43)\r\n      at runMicrotasks (<anonymous>)\r\n      at processTicksAndRejections (internal/process/task_queues.js:93:5)\r\n```",
  "closed_by": {
    "login": "gakonst",
    "id": 17802178,
    "node_id": "MDQ6VXNlcjE3ODAyMTc4",
    "avatar_url": "https://avatars.githubusercontent.com/u/17802178?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/gakonst",
    "html_url": "https://github.com/gakonst",
    "followers_url": "https://api.github.com/users/gakonst/followers",
    "following_url": "https://api.github.com/users/gakonst/following{/other_user}",
    "gists_url": "https://api.github.com/users/gakonst/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/gakonst/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/gakonst/subscriptions",
    "organizations_url": "https://api.github.com/users/gakonst/orgs",
    "repos_url": "https://api.github.com/users/gakonst/repos",
    "events_url": "https://api.github.com/users/gakonst/events{/privacy}",
    "received_events_url": "https://api.github.com/users/gakonst/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/585/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/585/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/825857935",
    "html_url": "https://github.com/ethereum-optimism/optimism/issues/585#issuecomment-825857935",
    "issue_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/585",
    "id": 825857935,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgyNTg1NzkzNQ==",
    "user": {
      "login": "tynes",
      "id": 6626818,
      "node_id": "MDQ6VXNlcjY2MjY4MTg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6626818?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tynes",
      "html_url": "https://github.com/tynes",
      "followers_url": "https://api.github.com/users/tynes/followers",
      "following_url": "https://api.github.com/users/tynes/following{/other_user}",
      "gists_url": "https://api.github.com/users/tynes/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tynes/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tynes/subscriptions",
      "organizations_url": "https://api.github.com/users/tynes/orgs",
      "repos_url": "https://api.github.com/users/tynes/repos",
      "events_url": "https://api.github.com/users/tynes/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tynes/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-04-23T18:59:09Z",
    "updated_at": "2021-04-23T18:59:09Z",
    "author_association": "CONTRIBUTOR",
    "body": "Tracking the different times that it fails to observe the non-determinism:\r\n\r\nhttps://github.com/ethereum-optimism/optimism/pull/593/checks?check_run_id=2422317833\r\n```\r\n      AssertionError: expected { Object (_hex, _isBigNumber) } to deeply equal { Object (_hex, _isBigNumber) }\r\n      + expected - actual\r\n\r\n       {\r\n      -  \"_hex\": \"0x0341be\"\r\n      +  \"_hex\": \"0x03422a\"\r\n         \"_isBigNumber\": true\r\n       }\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/825857935/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/825860726",
    "html_url": "https://github.com/ethereum-optimism/optimism/issues/585#issuecomment-825860726",
    "issue_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/585",
    "id": 825860726,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgyNTg2MDcyNg==",
    "user": {
      "login": "tynes",
      "id": 6626818,
      "node_id": "MDQ6VXNlcjY2MjY4MTg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6626818?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tynes",
      "html_url": "https://github.com/tynes",
      "followers_url": "https://api.github.com/users/tynes/followers",
      "following_url": "https://api.github.com/users/tynes/following{/other_user}",
      "gists_url": "https://api.github.com/users/tynes/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tynes/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tynes/subscriptions",
      "organizations_url": "https://api.github.com/users/tynes/orgs",
      "repos_url": "https://api.github.com/users/tynes/repos",
      "events_url": "https://api.github.com/users/tynes/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tynes/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-04-23T19:04:28Z",
    "updated_at": "2021-04-23T19:04:28Z",
    "author_association": "CONTRIBUTOR",
    "body": "https://github.com/ethereum-optimism/optimism/pull/592/checks?check_run_id=2422353003\r\n```\r\n     AssertionError: expected { Object (_hex, _isBigNumber) } to deeply equal { Object (_hex, _isBigNumber) }\r\n      + expected - actual\r\n\r\n       {\r\n      -  \"_hex\": \"0x0341be\"\r\n      +  \"_hex\": \"0x03422a\"\r\n         \"_isBigNumber\": true\r\n       }\r\n      \r\n```\r\n\r\nIt appears to be deterministically different. My guess is that it is a race condition in hardhat",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/825860726/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/825874741",
    "html_url": "https://github.com/ethereum-optimism/optimism/issues/585#issuecomment-825874741",
    "issue_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/585",
    "id": 825874741,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgyNTg3NDc0MQ==",
    "user": {
      "login": "smartcontracts",
      "id": 14298799,
      "node_id": "MDQ6VXNlcjE0Mjk4Nzk5",
      "avatar_url": "https://avatars.githubusercontent.com/u/14298799?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/smartcontracts",
      "html_url": "https://github.com/smartcontracts",
      "followers_url": "https://api.github.com/users/smartcontracts/followers",
      "following_url": "https://api.github.com/users/smartcontracts/following{/other_user}",
      "gists_url": "https://api.github.com/users/smartcontracts/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/smartcontracts/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/smartcontracts/subscriptions",
      "organizations_url": "https://api.github.com/users/smartcontracts/orgs",
      "repos_url": "https://api.github.com/users/smartcontracts/repos",
      "events_url": "https://api.github.com/users/smartcontracts/events{/privacy}",
      "received_events_url": "https://api.github.com/users/smartcontracts/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-04-23T19:32:40Z",
    "updated_at": "2021-04-23T19:32:40Z",
    "author_association": "CONTRIBUTOR",
    "body": "> It appears to be deterministically different. My guess is that it is a race condition in hardhat\r\n\r\nThe test in question is https://github.com/ethereum-optimism/optimism/blob/eef1df4d63fd1b483beda63293ea1746861c3e2a/integration-tests/test/native-eth.spec.ts#L44-L49, which tests `estimateGas` inside of `l2geth`.\r\n\r\nI wonder if this could be caused by the use of a random address. I guess that could maybe change the number of zero bytes in the calldata and cause the gas estimation to differ? I'll try to use a fixed address and see what happens.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/825874741/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/829499484",
    "html_url": "https://github.com/ethereum-optimism/optimism/issues/585#issuecomment-829499484",
    "issue_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/585",
    "id": 829499484,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgyOTQ5OTQ4NA==",
    "user": {
      "login": "snario",
      "id": 1933029,
      "node_id": "MDQ6VXNlcjE5MzMwMjk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1933029?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/snario",
      "html_url": "https://github.com/snario",
      "followers_url": "https://api.github.com/users/snario/followers",
      "following_url": "https://api.github.com/users/snario/following{/other_user}",
      "gists_url": "https://api.github.com/users/snario/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/snario/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/snario/subscriptions",
      "organizations_url": "https://api.github.com/users/snario/orgs",
      "repos_url": "https://api.github.com/users/snario/repos",
      "events_url": "https://api.github.com/users/snario/events{/privacy}",
      "received_events_url": "https://api.github.com/users/snario/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-04-29T18:42:54Z",
    "updated_at": "2021-04-29T18:42:54Z",
    "author_association": "CONTRIBUTOR",
    "body": "@gakonst is this fixed?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/829499484/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/830080032",
    "html_url": "https://github.com/ethereum-optimism/optimism/issues/585#issuecomment-830080032",
    "issue_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/585",
    "id": 830080032,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgzMDA4MDAzMg==",
    "user": {
      "login": "gakonst",
      "id": 17802178,
      "node_id": "MDQ6VXNlcjE3ODAyMTc4",
      "avatar_url": "https://avatars.githubusercontent.com/u/17802178?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gakonst",
      "html_url": "https://github.com/gakonst",
      "followers_url": "https://api.github.com/users/gakonst/followers",
      "following_url": "https://api.github.com/users/gakonst/following{/other_user}",
      "gists_url": "https://api.github.com/users/gakonst/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gakonst/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gakonst/subscriptions",
      "organizations_url": "https://api.github.com/users/gakonst/orgs",
      "repos_url": "https://api.github.com/users/gakonst/repos",
      "events_url": "https://api.github.com/users/gakonst/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gakonst/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-04-30T13:03:36Z",
    "updated_at": "2021-04-30T13:03:36Z",
    "author_association": "CONTRIBUTOR",
    "body": "[Should be.](https://github.com/ethereum-optimism/optimism/blame/master/integration-tests/test/native-eth.spec.ts#L46) Closing optimistically.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/830080032/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
