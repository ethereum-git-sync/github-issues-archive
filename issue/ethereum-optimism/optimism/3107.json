{
  "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/3107",
  "repository_url": "https://api.github.com/repos/ethereum-optimism/optimism",
  "labels_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/3107/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/3107/comments",
  "events_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/3107/events",
  "html_url": "https://github.com/ethereum-optimism/optimism/issues/3107",
  "id": 1319292680,
  "node_id": "I_kwDODjvEJM5Oos8I",
  "number": 3107,
  "title": "`CrossChainMessenger.getMessageReceipt` function doesn't set lower limit in event query",
  "user": {
    "login": "palango",
    "id": 90851,
    "node_id": "MDQ6VXNlcjkwODUx",
    "avatar_url": "https://avatars.githubusercontent.com/u/90851?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/palango",
    "html_url": "https://github.com/palango",
    "followers_url": "https://api.github.com/users/palango/followers",
    "following_url": "https://api.github.com/users/palango/following{/other_user}",
    "gists_url": "https://api.github.com/users/palango/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/palango/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/palango/subscriptions",
    "organizations_url": "https://api.github.com/users/palango/orgs",
    "repos_url": "https://api.github.com/users/palango/repos",
    "events_url": "https://api.github.com/users/palango/events{/privacy}",
    "received_events_url": "https://api.github.com/users/palango/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 2907832490,
      "node_id": "MDU6TGFiZWwyOTA3ODMyNDkw",
      "url": "https://api.github.com/repos/ethereum-optimism/optimism/labels/C-bug",
      "name": "C-bug",
      "color": "C5DEF5",
      "default": false,
      "description": "Category: This is a bug."
    },
    {
      "id": 2930018676,
      "node_id": "MDU6TGFiZWwyOTMwMDE4Njc2",
      "url": "https://api.github.com/repos/ethereum-optimism/optimism/labels/P-unconfirmed",
      "name": "P-unconfirmed",
      "color": "BFD4F2",
      "default": false,
      "description": "Issue might be valid, but itâ€™s not yet confirmed"
    },
    {
      "id": 3662935689,
      "node_id": "LA_kwDODjvEJM7aU_aJ",
      "url": "https://api.github.com/repos/ethereum-optimism/optimism/labels/M-sdk",
      "name": "M-sdk",
      "color": "FBCA04",
      "default": false,
      "description": "Module: sdk"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 7,
  "created_at": "2022-07-27T09:40:17Z",
  "updated_at": "2022-08-25T15:26:12Z",
  "closed_at": "2022-08-25T15:26:11Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "**Describe the bug**\r\n\r\nThe `CrossChainMessenger.getMessageReceipt` function doesn't provide the correct `fromBlock` parameter to the `contract.queryFilter` function. So running it after the receipt is available won't be returned a second time.\r\n\r\n**To Reproduce**\r\n\r\n1. Create a L1->L2 message\r\n2. Run the `message-relayer` on that tx\r\n3. After this finishes, run it a second time. It will block here: https://github.com/ethereum-optimism/optimism/blob/13a9e9bdbdc703a2936506600173609c76364cca/packages/message-relayer/src/service.ts#L179\r\n\r\n**Expected behavior**\r\n\r\nRunning a second time should work.\r\n\r\n\r\n**Additional context**\r\n\r\nMy understanding is that the event query should use the block number of the transaction as the lower block limit. With that the event would be found.\r\n",
  "closed_by": {
    "login": "smartcontracts",
    "id": 14298799,
    "node_id": "MDQ6VXNlcjE0Mjk4Nzk5",
    "avatar_url": "https://avatars.githubusercontent.com/u/14298799?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/smartcontracts",
    "html_url": "https://github.com/smartcontracts",
    "followers_url": "https://api.github.com/users/smartcontracts/followers",
    "following_url": "https://api.github.com/users/smartcontracts/following{/other_user}",
    "gists_url": "https://api.github.com/users/smartcontracts/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/smartcontracts/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/smartcontracts/subscriptions",
    "organizations_url": "https://api.github.com/users/smartcontracts/orgs",
    "repos_url": "https://api.github.com/users/smartcontracts/repos",
    "events_url": "https://api.github.com/users/smartcontracts/events{/privacy}",
    "received_events_url": "https://api.github.com/users/smartcontracts/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/3107/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/3107/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/1210579674",
    "html_url": "https://github.com/ethereum-optimism/optimism/issues/3107#issuecomment-1210579674",
    "issue_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/3107",
    "id": 1210579674,
    "node_id": "IC_kwDODjvEJM5IJ_ra",
    "user": {
      "login": "istankovic",
      "id": 1312091,
      "node_id": "MDQ6VXNlcjEzMTIwOTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1312091?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/istankovic",
      "html_url": "https://github.com/istankovic",
      "followers_url": "https://api.github.com/users/istankovic/followers",
      "following_url": "https://api.github.com/users/istankovic/following{/other_user}",
      "gists_url": "https://api.github.com/users/istankovic/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/istankovic/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/istankovic/subscriptions",
      "organizations_url": "https://api.github.com/users/istankovic/orgs",
      "repos_url": "https://api.github.com/users/istankovic/repos",
      "events_url": "https://api.github.com/users/istankovic/events{/privacy}",
      "received_events_url": "https://api.github.com/users/istankovic/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-10T12:05:03Z",
    "updated_at": "2022-08-10T12:05:03Z",
    "author_association": "NONE",
    "body": "Bump.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/1210579674/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/1215786244",
    "html_url": "https://github.com/ethereum-optimism/optimism/issues/3107#issuecomment-1215786244",
    "issue_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/3107",
    "id": 1215786244,
    "node_id": "IC_kwDODjvEJM5Id20E",
    "user": {
      "login": "smartcontracts",
      "id": 14298799,
      "node_id": "MDQ6VXNlcjE0Mjk4Nzk5",
      "avatar_url": "https://avatars.githubusercontent.com/u/14298799?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/smartcontracts",
      "html_url": "https://github.com/smartcontracts",
      "followers_url": "https://api.github.com/users/smartcontracts/followers",
      "following_url": "https://api.github.com/users/smartcontracts/following{/other_user}",
      "gists_url": "https://api.github.com/users/smartcontracts/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/smartcontracts/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/smartcontracts/subscriptions",
      "organizations_url": "https://api.github.com/users/smartcontracts/orgs",
      "repos_url": "https://api.github.com/users/smartcontracts/repos",
      "events_url": "https://api.github.com/users/smartcontracts/events{/privacy}",
      "received_events_url": "https://api.github.com/users/smartcontracts/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-15T20:56:19Z",
    "updated_at": "2022-08-15T20:56:19Z",
    "author_association": "CONTRIBUTOR",
    "body": "Hi, sorry for the delay here. I am the primary maintainer of the `message-relayer` and I have been on vacation for the past 3 weeks. What is the exact behavior you're seeing? It simply hangs without executing any further? Lower bound should be set to block zero by if `fromBlock` is not provided, so this should work in theory. Are you sure the relayer is blocking on the specific line you listed?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/1215786244/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/1216095601",
    "html_url": "https://github.com/ethereum-optimism/optimism/issues/3107#issuecomment-1216095601",
    "issue_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/3107",
    "id": 1216095601,
    "node_id": "IC_kwDODjvEJM5IfCVx",
    "user": {
      "login": "smartcontracts",
      "id": 14298799,
      "node_id": "MDQ6VXNlcjE0Mjk4Nzk5",
      "avatar_url": "https://avatars.githubusercontent.com/u/14298799?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/smartcontracts",
      "html_url": "https://github.com/smartcontracts",
      "followers_url": "https://api.github.com/users/smartcontracts/followers",
      "following_url": "https://api.github.com/users/smartcontracts/following{/other_user}",
      "gists_url": "https://api.github.com/users/smartcontracts/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/smartcontracts/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/smartcontracts/subscriptions",
      "organizations_url": "https://api.github.com/users/smartcontracts/orgs",
      "repos_url": "https://api.github.com/users/smartcontracts/repos",
      "events_url": "https://api.github.com/users/smartcontracts/events{/privacy}",
      "received_events_url": "https://api.github.com/users/smartcontracts/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-16T03:16:43Z",
    "updated_at": "2022-08-16T03:16:43Z",
    "author_association": "CONTRIBUTOR",
    "body": "Also, are you running this against a live network? Or on the local devnet? On Bedrock or Legacy? ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/1216095601/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/1219712664",
    "html_url": "https://github.com/ethereum-optimism/optimism/issues/3107#issuecomment-1219712664",
    "issue_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/3107",
    "id": 1219712664,
    "node_id": "IC_kwDODjvEJM5Is1aY",
    "user": {
      "login": "istankovic",
      "id": 1312091,
      "node_id": "MDQ6VXNlcjEzMTIwOTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1312091?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/istankovic",
      "html_url": "https://github.com/istankovic",
      "followers_url": "https://api.github.com/users/istankovic/followers",
      "following_url": "https://api.github.com/users/istankovic/following{/other_user}",
      "gists_url": "https://api.github.com/users/istankovic/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/istankovic/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/istankovic/subscriptions",
      "organizations_url": "https://api.github.com/users/istankovic/orgs",
      "repos_url": "https://api.github.com/users/istankovic/repos",
      "events_url": "https://api.github.com/users/istankovic/events{/privacy}",
      "received_events_url": "https://api.github.com/users/istankovic/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-18T16:46:59Z",
    "updated_at": "2022-08-18T16:46:59Z",
    "author_association": "NONE",
    "body": "Hey @smartcontracts, thanks for getting back to us.\r\n\r\nThis turned out to be an issue on our end. So I think this can be closed now.\r\n\r\nDuring the course of analysing this, we discovered that `this.state.messenger.finalizeMessage` threw an error:\r\n\r\n```\r\nError: cannot estimate gas; transaction may fail or may require manual gas limit [ See: https://links.ethers.org/v5-errors-UNPREDICTABLE_GAS_LIMIT ] (error={\"reason\":\"execution reverted\",\"code\":\"UNPREDICTABLE_GAS_LIMIT\",\"method\":\"estimateGas\r\n```\r\n\r\nThis happens on chain ID 10, mainnet Optimism, with a message that has already been finalized and relayed successfully once.\r\nIs there a way to determine the underlying reason for the revert?",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/1219712664/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/1221085268",
    "html_url": "https://github.com/ethereum-optimism/optimism/issues/3107#issuecomment-1221085268",
    "issue_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/3107",
    "id": 1221085268,
    "node_id": "IC_kwDODjvEJM5IyEhU",
    "user": {
      "login": "smartcontracts",
      "id": 14298799,
      "node_id": "MDQ6VXNlcjE0Mjk4Nzk5",
      "avatar_url": "https://avatars.githubusercontent.com/u/14298799?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/smartcontracts",
      "html_url": "https://github.com/smartcontracts",
      "followers_url": "https://api.github.com/users/smartcontracts/followers",
      "following_url": "https://api.github.com/users/smartcontracts/following{/other_user}",
      "gists_url": "https://api.github.com/users/smartcontracts/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/smartcontracts/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/smartcontracts/subscriptions",
      "organizations_url": "https://api.github.com/users/smartcontracts/orgs",
      "repos_url": "https://api.github.com/users/smartcontracts/repos",
      "events_url": "https://api.github.com/users/smartcontracts/events{/privacy}",
      "received_events_url": "https://api.github.com/users/smartcontracts/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-19T20:54:32Z",
    "updated_at": "2022-08-19T20:54:32Z",
    "author_association": "CONTRIBUTOR",
    "body": "Generally speaking \"cannot estimate gas; transaction may fail or may require manual gas limit\" means that the transaction is always failing and there is no gas limit that would make the transaction work. It's most likely that you are calling a contract that is always reverting. You can try to explicitly set the gas limit using the [overrides parameter](https://sdk.optimism.io/classes/crosschainmessenger#finalizeMessage-2) to execute the transaction and then see what the revert reason is when the transaction is executed. Of course, this will cost ETH on mainnet.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/1221085268/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/1227366573",
    "html_url": "https://github.com/ethereum-optimism/optimism/issues/3107#issuecomment-1227366573",
    "issue_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/3107",
    "id": 1227366573,
    "node_id": "IC_kwDODjvEJM5JKCCt",
    "user": {
      "login": "istankovic",
      "id": 1312091,
      "node_id": "MDQ6VXNlcjEzMTIwOTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1312091?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/istankovic",
      "html_url": "https://github.com/istankovic",
      "followers_url": "https://api.github.com/users/istankovic/followers",
      "following_url": "https://api.github.com/users/istankovic/following{/other_user}",
      "gists_url": "https://api.github.com/users/istankovic/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/istankovic/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/istankovic/subscriptions",
      "organizations_url": "https://api.github.com/users/istankovic/orgs",
      "repos_url": "https://api.github.com/users/istankovic/repos",
      "events_url": "https://api.github.com/users/istankovic/events{/privacy}",
      "received_events_url": "https://api.github.com/users/istankovic/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-25T14:49:55Z",
    "updated_at": "2022-08-25T14:49:55Z",
    "author_association": "NONE",
    "body": "> Generally speaking \"cannot estimate gas; transaction may fail or may require manual gas limit\" means that the transaction is always failing and there is no gas limit that would make the transaction work. It's most likely that you are calling a contract that is always reverting. You can try to explicitly set the gas limit using the [overrides parameter](https://sdk.optimism.io/classes/crosschainmessenger#finalizeMessage-2) to execute the transaction and then see what the revert reason is when the transaction is executed. Of course, this will cost ETH on mainnet.\r\n\r\nThanks for the answer. \r\n\r\nBy the way, feel free to close this issue, I consider this resolved.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/1227366573/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/1227418035",
    "html_url": "https://github.com/ethereum-optimism/optimism/issues/3107#issuecomment-1227418035",
    "issue_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/3107",
    "id": 1227418035,
    "node_id": "IC_kwDODjvEJM5JKOmz",
    "user": {
      "login": "smartcontracts",
      "id": 14298799,
      "node_id": "MDQ6VXNlcjE0Mjk4Nzk5",
      "avatar_url": "https://avatars.githubusercontent.com/u/14298799?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/smartcontracts",
      "html_url": "https://github.com/smartcontracts",
      "followers_url": "https://api.github.com/users/smartcontracts/followers",
      "following_url": "https://api.github.com/users/smartcontracts/following{/other_user}",
      "gists_url": "https://api.github.com/users/smartcontracts/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/smartcontracts/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/smartcontracts/subscriptions",
      "organizations_url": "https://api.github.com/users/smartcontracts/orgs",
      "repos_url": "https://api.github.com/users/smartcontracts/repos",
      "events_url": "https://api.github.com/users/smartcontracts/events{/privacy}",
      "received_events_url": "https://api.github.com/users/smartcontracts/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-25T15:26:11Z",
    "updated_at": "2022-08-25T15:26:11Z",
    "author_association": "CONTRIBUTOR",
    "body": "SGTM, closing!",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/1227418035/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
