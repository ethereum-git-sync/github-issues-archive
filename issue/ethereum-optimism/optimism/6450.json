{
  "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/6450",
  "repository_url": "https://api.github.com/repos/ethereum-optimism/optimism",
  "labels_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/6450/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/6450/comments",
  "events_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/6450/events",
  "html_url": "https://github.com/ethereum-optimism/optimism/issues/6450",
  "id": 1821542768,
  "node_id": "I_kwDODjvEJM5skolw",
  "number": 6450,
  "title": "ERC-4337 bundler for local devnet",
  "user": {
    "login": "rho-cassiopeiae",
    "id": 84779039,
    "node_id": "MDQ6VXNlcjg0Nzc5MDM5",
    "avatar_url": "https://avatars.githubusercontent.com/u/84779039?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/rho-cassiopeiae",
    "html_url": "https://github.com/rho-cassiopeiae",
    "followers_url": "https://api.github.com/users/rho-cassiopeiae/followers",
    "following_url": "https://api.github.com/users/rho-cassiopeiae/following{/other_user}",
    "gists_url": "https://api.github.com/users/rho-cassiopeiae/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/rho-cassiopeiae/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rho-cassiopeiae/subscriptions",
    "organizations_url": "https://api.github.com/users/rho-cassiopeiae/orgs",
    "repos_url": "https://api.github.com/users/rho-cassiopeiae/repos",
    "events_url": "https://api.github.com/users/rho-cassiopeiae/events{/privacy}",
    "received_events_url": "https://api.github.com/users/rho-cassiopeiae/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 6,
  "created_at": "2023-07-26T04:11:48Z",
  "updated_at": "2023-08-14T04:09:59Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "I'm trying to run [this bundler](https://github.com/eth-infinitism/bundler) together with local devnet, but have no luck.\r\n\r\nI first add `--rpc.allow-unprotected-txs` flag to both entrypoint.sh files in ops-bedrock folder, since without it I get \"only replay-protected (EIP-155) transactions allowed over RPC\" error later. Then I launch the devnet using `make devnet-up` and make some adjustments in the bundler code: change all relevant target ports from 8545 to 9545 and in the 2-deploy-entrypoint.ts file comment out the code that checks that `chainId` is either 1337 or 31337, since it is actually 901.\r\n\r\nBut when I run `yarn hardhat-deploy --network localhost` to deploy the entrypoint, I get \"Insufficient funds\" error.\r\n\r\nI think I need to change some private key-related settings of the devnet, but I'm not sure which ones. I tried changing `BLOCK_SIGNER_PRIVATE_KEY` and `BLOCK_SIGNER_ADDRESS` to `0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80` and `0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266` (`test*11 junk` mnemonic account 0), since the bundler seems to be using this account for deployment, but still got the same error.\r\n\r\n**Describe the solution you'd like**\r\nIt would be great to have a local bundler out of the box, since there is already support for ERC-4337 on both OP Goerli and OP Mainnet.\r\n\r\n**Describe alternatives you've considered**\r\nCurrently I have to run the bundler on hardhat L1. It works fine without any adjustments, but since I'm developing for Optimism it's not what I ultimately need.\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/6450/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/6450/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/1651589534",
    "html_url": "https://github.com/ethereum-optimism/optimism/issues/6450#issuecomment-1651589534",
    "issue_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/6450",
    "id": 1651589534,
    "node_id": "IC_kwDODjvEJM5icUGe",
    "user": {
      "login": "netzulo",
      "id": 11871932,
      "node_id": "MDQ6VXNlcjExODcxOTMy",
      "avatar_url": "https://avatars.githubusercontent.com/u/11871932?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/netzulo",
      "html_url": "https://github.com/netzulo",
      "followers_url": "https://api.github.com/users/netzulo/followers",
      "following_url": "https://api.github.com/users/netzulo/following{/other_user}",
      "gists_url": "https://api.github.com/users/netzulo/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/netzulo/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/netzulo/subscriptions",
      "organizations_url": "https://api.github.com/users/netzulo/orgs",
      "repos_url": "https://api.github.com/users/netzulo/repos",
      "events_url": "https://api.github.com/users/netzulo/events{/privacy}",
      "received_events_url": "https://api.github.com/users/netzulo/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-26T11:23:40Z",
    "updated_at": "2023-07-26T11:23:50Z",
    "author_association": "NONE",
    "body": "i think you will solve just using  `make devnet-up-deploy` , when \"devnet-up\" just compilation and basic tasks are completed, at \"deploy\" some txns are executed over your L1+L2 devnet and fund main accounts :D",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/1651589534/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/1652016955",
    "html_url": "https://github.com/ethereum-optimism/optimism/issues/6450#issuecomment-1652016955",
    "issue_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/6450",
    "id": 1652016955,
    "node_id": "IC_kwDODjvEJM5id8c7",
    "user": {
      "login": "rflihxyz",
      "id": 109089247,
      "node_id": "U_kgDOBoCR3w",
      "avatar_url": "https://avatars.githubusercontent.com/u/109089247?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rflihxyz",
      "html_url": "https://github.com/rflihxyz",
      "followers_url": "https://api.github.com/users/rflihxyz/followers",
      "following_url": "https://api.github.com/users/rflihxyz/following{/other_user}",
      "gists_url": "https://api.github.com/users/rflihxyz/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rflihxyz/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rflihxyz/subscriptions",
      "organizations_url": "https://api.github.com/users/rflihxyz/orgs",
      "repos_url": "https://api.github.com/users/rflihxyz/repos",
      "events_url": "https://api.github.com/users/rflihxyz/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rflihxyz/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-26T15:17:20Z",
    "updated_at": "2023-07-26T15:17:20Z",
    "author_association": "NONE",
    "body": "Hey @rho-cassiopeiae, can you dm me on telegram (@rflihxyz)! I'm trying to do the same and would love to chat about it! Best",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/1652016955/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/1652473916",
    "html_url": "https://github.com/ethereum-optimism/optimism/issues/6450#issuecomment-1652473916",
    "issue_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/6450",
    "id": 1652473916,
    "node_id": "IC_kwDODjvEJM5ifsA8",
    "user": {
      "login": "tynes",
      "id": 6626818,
      "node_id": "MDQ6VXNlcjY2MjY4MTg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6626818?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tynes",
      "html_url": "https://github.com/tynes",
      "followers_url": "https://api.github.com/users/tynes/followers",
      "following_url": "https://api.github.com/users/tynes/following{/other_user}",
      "gists_url": "https://api.github.com/users/tynes/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tynes/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tynes/subscriptions",
      "organizations_url": "https://api.github.com/users/tynes/orgs",
      "repos_url": "https://api.github.com/users/tynes/repos",
      "events_url": "https://api.github.com/users/tynes/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tynes/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-26T20:49:09Z",
    "updated_at": "2023-07-26T20:49:09Z",
    "author_association": "CONTRIBUTOR",
    "body": "@rho-cassiopeiae Thanks for being interested in trying to run a bundler on optimism devnet! I've opened a couple of PRs attempting to make this process easier.\r\n\r\nWe currently have 2 devnets and I am working on consolidating them into a single devnet. The two commands are:\r\n- `make devnet-up`\r\n- `make devnet-up-deploy`\r\n\r\nRegarding the lack of funds, #6463 was created to add more accounts with funds at genesis for `make devnet-up`. You can check the balance of an account using `cast balance` - if the accounts do not have funds on L1, then something is wrong. Be sure to use the right port, I believe `8545` is the L1 port.\r\n\r\nIt would be super helpful to confirm if `make devnet-up` or `make devnet-up-deploy` has the genesis funds at the dev accounts.\r\n\r\nI see here that the hardhat config for the bundler contracts uses the same mnemonic that we use to seed genesis accounts so it seems like they are not funded in the genesis?\r\nhttps://github.com/eth-infinitism/bundler/blob/623991115d891419408ccffb8b65c0c4bb48421c/packages/bundler/hardhat.config.ts#L11",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/1652473916/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/1652676144",
    "html_url": "https://github.com/ethereum-optimism/optimism/issues/6450#issuecomment-1652676144",
    "issue_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/6450",
    "id": 1652676144,
    "node_id": "IC_kwDODjvEJM5igdYw",
    "user": {
      "login": "binjix23",
      "id": 120355637,
      "node_id": "U_kgDOByx7NQ",
      "avatar_url": "https://avatars.githubusercontent.com/u/120355637?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/binjix23",
      "html_url": "https://github.com/binjix23",
      "followers_url": "https://api.github.com/users/binjix23/followers",
      "following_url": "https://api.github.com/users/binjix23/following{/other_user}",
      "gists_url": "https://api.github.com/users/binjix23/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/binjix23/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/binjix23/subscriptions",
      "organizations_url": "https://api.github.com/users/binjix23/orgs",
      "repos_url": "https://api.github.com/users/binjix23/repos",
      "events_url": "https://api.github.com/users/binjix23/events{/privacy}",
      "received_events_url": "https://api.github.com/users/binjix23/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-26T23:24:00Z",
    "updated_at": "2023-07-26T23:24:00Z",
    "author_association": "NONE",
    "body": "HI @rflihxyz @netzulo @rho-cassiopeiae \r\n\r\nLovely to see this discussion, would love to invite you to our exclusive builders chat here: https://t.me/+nUBuIdVYanZjZWZh\r\n\r\nWe have an AA specific channel where you can ask questions and get connected with others in the eco! \r\n\r\nIf you want to verify me, feel free to DM me on twitter @binji_x ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/1652676144/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/1652728985",
    "html_url": "https://github.com/ethereum-optimism/optimism/issues/6450#issuecomment-1652728985",
    "issue_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/6450",
    "id": 1652728985,
    "node_id": "IC_kwDODjvEJM5igqSZ",
    "user": {
      "login": "binjix23",
      "id": 120355637,
      "node_id": "U_kgDOByx7NQ",
      "avatar_url": "https://avatars.githubusercontent.com/u/120355637?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/binjix23",
      "html_url": "https://github.com/binjix23",
      "followers_url": "https://api.github.com/users/binjix23/followers",
      "following_url": "https://api.github.com/users/binjix23/following{/other_user}",
      "gists_url": "https://api.github.com/users/binjix23/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/binjix23/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/binjix23/subscriptions",
      "organizations_url": "https://api.github.com/users/binjix23/orgs",
      "repos_url": "https://api.github.com/users/binjix23/repos",
      "events_url": "https://api.github.com/users/binjix23/events{/privacy}",
      "received_events_url": "https://api.github.com/users/binjix23/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-27T00:33:01Z",
    "updated_at": "2023-07-27T00:33:01Z",
    "author_association": "NONE",
    "body": "If the link is broken, you can use this one : https://t.me/+oUu1W1Z6WI03MTFh",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/1652728985/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/1676633870",
    "html_url": "https://github.com/ethereum-optimism/optimism/issues/6450#issuecomment-1676633870",
    "issue_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/6450",
    "id": 1676633870,
    "node_id": "IC_kwDODjvEJM5j72cO",
    "user": {
      "login": "rho-cassiopeiae",
      "id": 84779039,
      "node_id": "MDQ6VXNlcjg0Nzc5MDM5",
      "avatar_url": "https://avatars.githubusercontent.com/u/84779039?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rho-cassiopeiae",
      "html_url": "https://github.com/rho-cassiopeiae",
      "followers_url": "https://api.github.com/users/rho-cassiopeiae/followers",
      "following_url": "https://api.github.com/users/rho-cassiopeiae/following{/other_user}",
      "gists_url": "https://api.github.com/users/rho-cassiopeiae/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rho-cassiopeiae/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rho-cassiopeiae/subscriptions",
      "organizations_url": "https://api.github.com/users/rho-cassiopeiae/orgs",
      "repos_url": "https://api.github.com/users/rho-cassiopeiae/repos",
      "events_url": "https://api.github.com/users/rho-cassiopeiae/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rho-cassiopeiae/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-08-14T03:55:20Z",
    "updated_at": "2023-08-14T04:09:59Z",
    "author_association": "NONE",
    "body": "I was unable to make [eth-infinitism](https://github.com/eth-infinitism/bundler) bundler work, but found one that does work – [etherspot](https://github.com/etherspot/skandha). Incidentally, it also does better job estimating user operation gas.\r\n\r\n- Add `--rpc.allow-unprotected-txs` flag to both entrypoint files in `ops-bedrock` folder.\r\n- `make devnet-up`\r\n- Create `bundler-config.json` file anywhere you want with this content:\r\n```json\r\n{\r\n    \"networks\": {\r\n        \"dev\": {\r\n            \"entryPoints\": [\r\n                \"0x48e60BBb664aEfAc9f14aDB42e5FB5b4a119EB66\"\r\n            ],\r\n            \"relayer\": \"0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80\",\r\n            \"beneficiary\": \"0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266\",\r\n            \"rpcEndpoint\": \"http://host.docker.internal:9545\",\r\n            \"estimationStaticBuffer\": 21000,\r\n            \"validationGasLimit\": 10e6,\r\n            \"receiptLookupRange\": 1024,\r\n            \"conditionalTransactions\": false\r\n        }\r\n    }\r\n}\r\n```\r\n`0x48e60BBb664aEfAc9f14aDB42e5FB5b4a119EB66` is the address at which we will deploy EntryPoint later. Bundler can be started before deploying it.\r\n`http://host.docker.internal:9545` – use this endpoint since both devnet and bundler run in Docker but on different networks.\r\n- Start bundler\r\n```bash\r\ndocker run --rm -d --mount type=bind,source=/absolute/path/to/bundler-config.json,target=/usr/app/config.json,readonly -p 3000:14337 etherspot/skandha:0.0.31 start --unsafeMode\r\n```\r\nSource path has to be absolute.\r\n- `git clone https://github.com/eth-infinitism/account-abstraction` somewhere and `cd` into it\r\n- `yarn && yarn install`\r\n- Need to make a couple of changes here:\r\nIn [hardhat.config.ts](https://github.com/eth-infinitism/account-abstraction/blob/develop/hardhat.config.ts) add a new network: `optimismLocal: getNetwork1('http://localhost:9545')`\r\nIn [1_deploy_entrypoint.ts](https://github.com/eth-infinitism/account-abstraction/blob/develop/deploy/1_deploy_entrypoint.ts) replace the lines:\r\n```ts\r\nconst from = await provider.getSigner().getAddress()\r\nawait new Create2Factory(ethers.provider).deployFactory()\r\n```\r\nwith\r\n```ts\r\nconst signer = provider.getSigner()\r\nconst from = await signer.getAddress()\r\nawait new Create2Factory(ethers.provider).deployFactory(signer)\r\n```\r\nAnd in [2_deploy_SimpleAccountFactory.ts](https://github.com/eth-infinitism/account-abstraction/blob/develop/deploy/2_deploy_SimpleAccountFactory.ts) where there is a line checking `chainId` add a condition for 901 (OP devnet chain id).\r\n- `yarn hardhat deploy --network optimismLocal`\r\nYou will most likely need to run this command 4-5 times, because for some reason first several attempts fail with various errors (not enough funds / unable to deterministically deploy / nonce already used / etc). I don't know why it doesn't work right away, so just keep running it until it works. Not the greatest method, I know. You can make a loop with try-catch in the code I suppose, instead.\r\n- The output will show the addresses of EntryPoint and SimpleAccountFactory contracts. Make sure that the EntryPoint address matches the one specified in bundler-config.json.\r\n- Fund EntryPoint address with eth. Not sure if this step is necessary, but this is what etherspot do in their tests.\r\n- Bundler will be available at `http://localhost:3000/1337`. Unfortunately the `/1337` path is hardcoded in the bundler code when you specify `dev` network in the config (like we did), so have to use it even though the network id is actually 901. It doesn't affect anything.\r\n- Gotcha 1: when calling `eth_estimateUserOperationGas` this bundler implementation returns the value for `verificationGasLimit` under the key `verificationGas` (without \"Limit\"), which differs from most other bundler implementations I've seen.\r\n- Gotcha 2: SimpleAccountFactory currently deployed on various test and mainnets deploys SimpleAccount that has `executeBatch` method which accepts only 2 arguments, while SimpleAccountFactory which we deployed locally has this method accepting 3 arguments, since it's newer implementation. This caused me a couple of hours of pulling my hair out trying to figure out why single operations work while batched ones do not.\r\n\r\nAs you can see this is not the cleanest method but it works. Would be great it someone figures out how to do it with less steps.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/1676633870/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
