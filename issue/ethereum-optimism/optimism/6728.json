{
  "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/6728",
  "repository_url": "https://api.github.com/repos/ethereum-optimism/optimism",
  "labels_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/6728/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/6728/comments",
  "events_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/6728/events",
  "html_url": "https://github.com/ethereum-optimism/optimism/issues/6728",
  "id": 1846722674,
  "node_id": "I_kwDODjvEJM5uEsBy",
  "number": 6728,
  "title": "L2 Shapella (Shanghai + Capella) hardfork support",
  "user": {
    "login": "protolambda",
    "id": 19571989,
    "node_id": "MDQ6VXNlcjE5NTcxOTg5",
    "avatar_url": "https://avatars.githubusercontent.com/u/19571989?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/protolambda",
    "html_url": "https://github.com/protolambda",
    "followers_url": "https://api.github.com/users/protolambda/followers",
    "following_url": "https://api.github.com/users/protolambda/following{/other_user}",
    "gists_url": "https://api.github.com/users/protolambda/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/protolambda/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/protolambda/subscriptions",
    "organizations_url": "https://api.github.com/users/protolambda/orgs",
    "repos_url": "https://api.github.com/users/protolambda/repos",
    "events_url": "https://api.github.com/users/protolambda/events{/privacy}",
    "received_events_url": "https://api.github.com/users/protolambda/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 5828636827,
      "node_id": "LA_kwDODjvEJM8AAAABW2nwmw",
      "url": "https://api.github.com/repos/ethereum-optimism/optimism/labels/M-community",
      "name": "M-community",
      "color": "85CAC1",
      "default": false,
      "description": "Meta: community help wanted"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": {
    "login": "protolambda",
    "id": 19571989,
    "node_id": "MDQ6VXNlcjE5NTcxOTg5",
    "avatar_url": "https://avatars.githubusercontent.com/u/19571989?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/protolambda",
    "html_url": "https://github.com/protolambda",
    "followers_url": "https://api.github.com/users/protolambda/followers",
    "following_url": "https://api.github.com/users/protolambda/following{/other_user}",
    "gists_url": "https://api.github.com/users/protolambda/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/protolambda/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/protolambda/subscriptions",
    "organizations_url": "https://api.github.com/users/protolambda/orgs",
    "repos_url": "https://api.github.com/users/protolambda/repos",
    "events_url": "https://api.github.com/users/protolambda/events{/privacy}",
    "received_events_url": "https://api.github.com/users/protolambda/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "protolambda",
      "id": 19571989,
      "node_id": "MDQ6VXNlcjE5NTcxOTg5",
      "avatar_url": "https://avatars.githubusercontent.com/u/19571989?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/protolambda",
      "html_url": "https://github.com/protolambda",
      "followers_url": "https://api.github.com/users/protolambda/followers",
      "following_url": "https://api.github.com/users/protolambda/following{/other_user}",
      "gists_url": "https://api.github.com/users/protolambda/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/protolambda/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/protolambda/subscriptions",
      "organizations_url": "https://api.github.com/users/protolambda/orgs",
      "repos_url": "https://api.github.com/users/protolambda/repos",
      "events_url": "https://api.github.com/users/protolambda/events{/privacy}",
      "received_events_url": "https://api.github.com/users/protolambda/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 0,
  "created_at": "2023-08-11T12:16:15Z",
  "updated_at": "2023-08-16T11:51:35Z",
  "closed_at": null,
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "This issue tracks the necessary changes to support the Shapella L1 upgrade in the OP-Stack. Starting with specs, op-node and op-geth changes.\r\n\r\nThese changes should be stacked together as PRs before merging, since end-to-end testing largely depends on various op-geth & engine API shapella features all being activated.\r\n\r\n# Introduced L1 EIPs\r\n\r\n*Source: https://blog.ethereum.org/2023/03/28/shapella-mainnet-announcement*\r\n\r\n- [EIP-3651: Warm COINBASE](https://eips.ethereum.org/EIPS/eip-3651)\r\n    - Affects EVM execution\r\n- [EIP-3855: PUSH0 instruction](https://eips.ethereum.org/EIPS/eip-3855)\r\n    - Affects EVM execution\r\n- [EIP-3860: Limit and meter initcode](https://eips.ethereum.org/EIPS/eip-3860)\r\n    - Affects EVM execution\r\n    - Need to signal this to users, if they depend on pre-shanghai behavior (large initcode during `CREATE` / `CREATE2`)\r\n- [EIP-4895: Beacon chain push withdrawals as operations](https://eips.ethereum.org/EIPS/eip-4895)\r\n    - Affects block-format\r\n    - Affects Engine API\r\n    - Affects state-transition outside EVM\r\n- [EIP-6049: Deprecate SELFDESTRUCT](https://eips.ethereum.org/EIPS/eip-6049)\r\n    - Soft-change, need to signal this to users\r\n\r\n# Upgrading\r\n\r\nThe shanghai hardfork affects both op-geth and op-node: the fork affects the Engine API.\r\n\r\nWe need to add a `shanghaiTime` rollup-config attribute, and can use the existing geth shanghai upgrade functionality.\r\n\r\n# op-node changes\r\n\r\n## Rollup Config `shanghaiTime` attribute\r\n\r\nThe rollup-config needs to be made aware of the shanghai hardfork time to enable some of the below changes to apply based on the hardfork timestamp: the Engine API usage is dependent on the hardfork timestamp.\r\n\r\nThis needs to be documented in the network-upgrades spec: https://github.com/ethereum-optimism/optimism/blob/develop/specs/network-upgrades.md\r\n\r\n## SSZ ExecutionPayload encoding\r\n\r\nThe SSZ encoding is used in P2P gossip: we need to support the withdrawals list attribute here (even if empty, since empty is different than non-existent as in pre-shanghai blocks).\r\n\r\nThis change needs to be documented in the P2P spec: https://github.com/ethereum-optimism/optimism/blob/develop/specs/rollup-node-p2p.md\r\n\r\nAnd requires a gossip-topic upgrade (the topic identifier is already versioned).\r\n\r\n## L2 Eth-RPC client bindings\r\n\r\nWhen retrieving an execution-payload/block, we need to respect the withdrawals-list. We have missed this in the L1 side of these bindings before (pre-bedrock lauch, durign shanghai upgrade of Goerli).\r\n\r\n## Engine API\r\n\r\nThe Engine API changed with Shanghai to support the new withdrawals attribute, and we must migrate over:\r\n\r\nhttps://github.com/ethereum/execution-apis/blob/main/src/engine/shanghai.md\r\n\r\nThe methods are a hard-requirement for blocks that are past the shanghai timestamp. The methods are backwards compatible with pre-shanghai. We need the V2 methods in op-geth to support Optimism first before we can start using them as the op-node.\r\n\r\nThe optionality depends on the timestamp of the content:\r\n\r\n`engine_newPayloadV2`: optionality between `ExecutionPayloadV1` **and** `ExecutionPayloadV2`\r\n\r\n`engine_forkchoiceUpdatedV2`: optionality between `PayloadAttributesV2` and `PayloadAttributesV2`\r\n\r\n`engine_getPayloadV2`: optionality between `ExecutionPayloadV1` **and** `ExecutionPayloadV2`\r\n\r\nBased on the timestamp the verifier and sequencer codepaths *(already unified to behind the `derive.EngineControl` interface)*\r\n\r\nThese engine-API changes need to be documented in the execution-engine spec: https://github.com/ethereum-optimism/optimism/blob/develop/specs/exec-engine.md\r\n\r\n# op-geth changes\r\n\r\n## Hardfork time config update\r\n\r\nWe need the hardfork to be scheduled for Goerli and Mainnet similar to how Regolith was scheduled:\r\n\r\n- Provide a hardfork override CLI option\r\n- Mutate the chain-config with the shanghai time upon startup, if the chain ID matches\r\n\r\n## Engine API\r\n\r\nReview that all the V2 methods are covered by the Optimism diff.\r\n\r\n# Shanghai testing\r\n\r\n- Update op-geth testing in the geth Engine API tests in op-e2e, covering the V2 methods one by one\r\n- Implement an op-e2e test like the regolith test\r\n- Implement action-tests that run through the Shanghai HF like the Regolith tests\r\n- Enable shanghai by default in the CI-devnet\r\n- Schedule and execute Shanghai on the internal devnet\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/6728/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/6728/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[

]
