{
  "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/9249",
  "repository_url": "https://api.github.com/repos/ethereum-optimism/optimism",
  "labels_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/9249/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/9249/comments",
  "events_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/9249/events",
  "html_url": "https://github.com/ethereum-optimism/optimism/issues/9249",
  "id": 2106899442,
  "node_id": "I_kwDODjvEJM59lLvy",
  "number": 9249,
  "title": "Calling resolveClaim() can unexpectedly fail due to non-constant gas cost of delete",
  "user": {
    "login": "qizhou",
    "id": 2541286,
    "node_id": "MDQ6VXNlcjI1NDEyODY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2541286?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/qizhou",
    "html_url": "https://github.com/qizhou",
    "followers_url": "https://api.github.com/users/qizhou/followers",
    "following_url": "https://api.github.com/users/qizhou/following{/other_user}",
    "gists_url": "https://api.github.com/users/qizhou/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/qizhou/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/qizhou/subscriptions",
    "organizations_url": "https://api.github.com/users/qizhou/orgs",
    "repos_url": "https://api.github.com/users/qizhou/repos",
    "events_url": "https://api.github.com/users/qizhou/events{/privacy}",
    "received_events_url": "https://api.github.com/users/qizhou/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2024-01-30T03:53:40Z",
  "updated_at": "2024-01-30T04:01:07Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "<!--\r\nNeed help?\r\nRefer to our contributing guidelines for additional information about making a good issue:\r\nhttps://github.com/ethereum-optimism/.github/blob/master/CONTRIBUTING.md\r\n-->\r\n\r\n**Describe the bug**\r\n\r\nhttps://github.com/ethereum-optimism/optimism/blob/546fb2c7a5796b7fe50b0b7edc7666d3bd281d6f/packages/contracts-bedrock/src/dispute/FaultDisputeGame.sol#L414\r\n\r\nThe line `delete subgames[_claimIndex];` will delete all subgames given _claimIndex. However, the cost of the delete operation in solidity is non-constant, where each of the items in the array will take about 5000 gas to delete. The following lists the gas cost with the number of items in the array (tested in remix Shanghai):\r\n\r\nItems | Execution Gas | Diff\r\n-- | -- | --\r\n0 | 2847 | Â \r\n1 | 10702 | 7855\r\n2 | 15757 | 5055\r\n3 | 20812 | 5055\r\n4 | 25867 | 5055\r\n5 | 30922 | 5055\r\n6 | 35977 | 5055\r\n7 | 41032 | 5055\r\n\r\nGiven block limit 30e6, creating 6000 subgames of a claim will block the claim from resolving forever.\r\n\r\n\r\n**To Reproduce**\r\nThe following code can be used to check the non-constant gas cost of delete:\r\n\r\n```\r\npragma solidity >=0.8.2 <0.9.0;\r\n\r\ncontract SubgameDelete {\r\n    mapping(uint256 => uint256[]) public subgames;\r\n\r\n    function addSubgame(uint256 game, uint256 subgame) public {\r\n        subgames[game].push(subgame);\r\n    }\r\n\r\n    function removeGame(uint256 game) public {\r\n        delete subgames[game];\r\n    }\r\n\r\n    function gameLen(uint256 game) public view returns (uint256) {\r\n        return subgames[game].length;\r\n    }\r\n}\r\n```\r\n\r\n**Expected behavior**\r\n\r\nThe gas cot of resolveClaim() should be O(1).\r\n\r\nUse another variable to check if the subgame is solved consistently (e.g., ClaimData.bond == uint128.max) without deleting the array.\r\n\r\n**Screenshots**\r\nIf applicable, add screenshots to help explain your problem.\r\n\r\n**System Specs:**\r\n - OS:\r\n - Package Version (or commit hash):\r\n\r\n**Additional context**\r\nAdd any other context about the problem here.\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/9249/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/9249/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/1916032133",
    "html_url": "https://github.com/ethereum-optimism/optimism/issues/9249#issuecomment-1916032133",
    "issue_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/9249",
    "id": 1916032133,
    "node_id": "IC_kwDODjvEJM5yNFSF",
    "user": {
      "login": "qizhou",
      "id": 2541286,
      "node_id": "MDQ6VXNlcjI1NDEyODY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2541286?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/qizhou",
      "html_url": "https://github.com/qizhou",
      "followers_url": "https://api.github.com/users/qizhou/followers",
      "following_url": "https://api.github.com/users/qizhou/following{/other_user}",
      "gists_url": "https://api.github.com/users/qizhou/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/qizhou/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/qizhou/subscriptions",
      "organizations_url": "https://api.github.com/users/qizhou/orgs",
      "repos_url": "https://api.github.com/users/qizhou/repos",
      "events_url": "https://api.github.com/users/qizhou/events{/privacy}",
      "received_events_url": "https://api.github.com/users/qizhou/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2024-01-30T04:01:06Z",
    "updated_at": "2024-01-30T04:01:06Z",
    "author_association": "NONE",
    "body": "The for-loop in the resolveClaim() may have a similar issue https://github.com/ethereum-optimism/optimism/blob/546fb2c7a5796b7fe50b0b7edc7666d3bd281d6f/packages/contracts-bedrock/src/dispute/FaultDisputeGame.sol#L394 (although with bond, such attack will be much more expensive)",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/1916032133/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
