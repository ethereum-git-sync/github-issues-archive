{
  "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/9249",
  "repository_url": "https://api.github.com/repos/ethereum-optimism/optimism",
  "labels_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/9249/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/9249/comments",
  "events_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/9249/events",
  "html_url": "https://github.com/ethereum-optimism/optimism/issues/9249",
  "id": 2106899442,
  "node_id": "I_kwDODjvEJM59lLvy",
  "number": 9249,
  "title": "Calling resolveClaim() can unexpectedly fail due to non-constant gas cost of delete",
  "user": {
    "login": "qizhou",
    "id": 2541286,
    "node_id": "MDQ6VXNlcjI1NDEyODY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2541286?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/qizhou",
    "html_url": "https://github.com/qizhou",
    "followers_url": "https://api.github.com/users/qizhou/followers",
    "following_url": "https://api.github.com/users/qizhou/following{/other_user}",
    "gists_url": "https://api.github.com/users/qizhou/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/qizhou/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/qizhou/subscriptions",
    "organizations_url": "https://api.github.com/users/qizhou/orgs",
    "repos_url": "https://api.github.com/users/qizhou/repos",
    "events_url": "https://api.github.com/users/qizhou/events{/privacy}",
    "received_events_url": "https://api.github.com/users/qizhou/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2024-01-30T03:53:40Z",
  "updated_at": "2024-01-30T21:16:31Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "<!--\r\nNeed help?\r\nRefer to our contributing guidelines for additional information about making a good issue:\r\nhttps://github.com/ethereum-optimism/.github/blob/master/CONTRIBUTING.md\r\n-->\r\n\r\n**Describe the bug**\r\n\r\nhttps://github.com/ethereum-optimism/optimism/blob/546fb2c7a5796b7fe50b0b7edc7666d3bd281d6f/packages/contracts-bedrock/src/dispute/FaultDisputeGame.sol#L414\r\n\r\nThe line `delete subgames[_claimIndex];` will delete all subgames given _claimIndex. However, the cost of the delete operation in solidity is non-constant, where each of the items in the array will take about 5000 gas to delete. The following lists the gas cost with the number of items in the array (tested in remix Shanghai):\r\n\r\nItems | Execution Gas | Diff\r\n-- | -- | --\r\n0 | 2847 | Â \r\n1 | 10702 | 7855\r\n2 | 15757 | 5055\r\n3 | 20812 | 5055\r\n4 | 25867 | 5055\r\n5 | 30922 | 5055\r\n6 | 35977 | 5055\r\n7 | 41032 | 5055\r\n\r\nGiven block limit 30e6, creating 6000 subgames of a claim will block the claim from resolving forever.\r\n\r\n\r\n**To Reproduce**\r\nThe following code can be used to check the non-constant gas cost of delete:\r\n\r\n```\r\npragma solidity >=0.8.2 <0.9.0;\r\n\r\ncontract SubgameDelete {\r\n    mapping(uint256 => uint256[]) public subgames;\r\n\r\n    function addSubgame(uint256 game, uint256 subgame) public {\r\n        subgames[game].push(subgame);\r\n    }\r\n\r\n    function removeGame(uint256 game) public {\r\n        delete subgames[game];\r\n    }\r\n\r\n    function gameLen(uint256 game) public view returns (uint256) {\r\n        return subgames[game].length;\r\n    }\r\n}\r\n```\r\n\r\n**Expected behavior**\r\n\r\nThe gas cot of resolveClaim() should be O(1).\r\n\r\nUse another variable to check if the subgame is solved consistently (e.g., ClaimData.bond == uint128.max) without deleting the array.\r\n\r\n**Screenshots**\r\nIf applicable, add screenshots to help explain your problem.\r\n\r\n**System Specs:**\r\n - OS:\r\n - Package Version (or commit hash):\r\n\r\n**Additional context**\r\nAdd any other context about the problem here.\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/9249/reactions",
    "total_count": 1,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 1
  },
  "timeline_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/9249/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/1916032133",
    "html_url": "https://github.com/ethereum-optimism/optimism/issues/9249#issuecomment-1916032133",
    "issue_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/9249",
    "id": 1916032133,
    "node_id": "IC_kwDODjvEJM5yNFSF",
    "user": {
      "login": "qizhou",
      "id": 2541286,
      "node_id": "MDQ6VXNlcjI1NDEyODY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2541286?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/qizhou",
      "html_url": "https://github.com/qizhou",
      "followers_url": "https://api.github.com/users/qizhou/followers",
      "following_url": "https://api.github.com/users/qizhou/following{/other_user}",
      "gists_url": "https://api.github.com/users/qizhou/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/qizhou/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/qizhou/subscriptions",
      "organizations_url": "https://api.github.com/users/qizhou/orgs",
      "repos_url": "https://api.github.com/users/qizhou/repos",
      "events_url": "https://api.github.com/users/qizhou/events{/privacy}",
      "received_events_url": "https://api.github.com/users/qizhou/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2024-01-30T04:01:06Z",
    "updated_at": "2024-01-30T04:01:06Z",
    "author_association": "NONE",
    "body": "The for-loop in the resolveClaim() may have a similar issue https://github.com/ethereum-optimism/optimism/blob/546fb2c7a5796b7fe50b0b7edc7666d3bd281d6f/packages/contracts-bedrock/src/dispute/FaultDisputeGame.sol#L394 (although with bond, such attack will be much more expensive)",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/1916032133/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/1917444373",
    "html_url": "https://github.com/ethereum-optimism/optimism/issues/9249#issuecomment-1917444373",
    "issue_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/9249",
    "id": 1917444373,
    "node_id": "IC_kwDODjvEJM5ySeEV",
    "user": {
      "login": "clabby",
      "id": 8406232,
      "node_id": "MDQ6VXNlcjg0MDYyMzI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8406232?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/clabby",
      "html_url": "https://github.com/clabby",
      "followers_url": "https://api.github.com/users/clabby/followers",
      "following_url": "https://api.github.com/users/clabby/following{/other_user}",
      "gists_url": "https://api.github.com/users/clabby/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/clabby/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/clabby/subscriptions",
      "organizations_url": "https://api.github.com/users/clabby/orgs",
      "repos_url": "https://api.github.com/users/clabby/repos",
      "events_url": "https://api.github.com/users/clabby/events{/privacy}",
      "received_events_url": "https://api.github.com/users/clabby/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2024-01-30T16:37:28Z",
    "updated_at": "2024-01-30T21:16:31Z",
    "author_association": "MEMBER",
    "body": "Thanks for the issue! Great spot, and glad that people are already taking a look at these contracts. This is a known issue, but was pushed aside for a bit due to the cost-to-grief. We'll likely make some improvements here based on your suggestions to improve readability and make this path more FV friendly ðŸ˜„ \r\n\r\nThis issue would prevent the game from resolving, locking all bonds up within the game above the subgame that's bricked. However, it would not cause the game to resolve incorrectly - it would effectively be bricked due to all sub-games not being resolved.\r\n\r\nThe impact of this is low-medium in severity, and the attack is costly for the malicious party:\r\n* If the game proposes a correct output and the game gets bricked, anyone can come along and just create a new output proposal, which costs on average $10-15. The one with the 6k+ subgames on a node won't finalize, but that's no problem - withdrawers could re-prove their withdrawal against a future game's output root. To sustain the DoS, the attacker would need to get 1 claim w/ 6k+ subgames in each dispute game that is active.\r\n* If the game proposes an incorrect output, the game can never finalize anyways since all subgames of the root can't be resolved. There's no incentive for a malicious actor to perform this attack on a game with a malicious root claim.\r\n\r\nBonds are not currently defined in the `getRequiredBond` function, but early work on them suggests that they will be fairly high to cover the costs of hardware and to maintain a high probability of collateralization between the time of creation and a possible counter. Let's say they're `2 ETH` per interaction - not including execution or native transaction costs associated with the creation of the 6,000 subgames, it would cost the attacker `$28,092,120 USD` to create the 6,000 subgames in that single dispute game alone at today's spot ETH price. The honest actors would still be able to counter and take the bonds of these 6,000 subgames, unless the counters themselves had 6,000 more responses, since credit is accumulated as each subgame is resolved + subgames are resolved bottom-up. This creates a very uneven incentive - since the honest actors will always respond to these spammed sub-games up until the instruction step at the leaves, the attacker would have to continue bricking claims lower and lower, for far more money than the honest challenger had to pay.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/1917444373/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/1917906442",
    "html_url": "https://github.com/ethereum-optimism/optimism/issues/9249#issuecomment-1917906442",
    "issue_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/9249",
    "id": 1917906442,
    "node_id": "IC_kwDODjvEJM5yUO4K",
    "user": {
      "login": "tynes",
      "id": 6626818,
      "node_id": "MDQ6VXNlcjY2MjY4MTg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6626818?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tynes",
      "html_url": "https://github.com/tynes",
      "followers_url": "https://api.github.com/users/tynes/followers",
      "following_url": "https://api.github.com/users/tynes/following{/other_user}",
      "gists_url": "https://api.github.com/users/tynes/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tynes/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tynes/subscriptions",
      "organizations_url": "https://api.github.com/users/tynes/orgs",
      "repos_url": "https://api.github.com/users/tynes/repos",
      "events_url": "https://api.github.com/users/tynes/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tynes/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2024-01-30T21:15:00Z",
    "updated_at": "2024-01-30T21:15:00Z",
    "author_association": "CONTRIBUTOR",
    "body": "@clabby We should ensure there is a section in the specs that includes your reasoning as to why this is safe. It will help to centralize the source of truth for the design in a single place",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/1917906442/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 1,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
