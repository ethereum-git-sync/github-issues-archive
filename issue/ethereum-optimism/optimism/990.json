{
  "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/990",
  "repository_url": "https://api.github.com/repos/ethereum-optimism/optimism",
  "labels_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/990/labels{/name}",
  "comments_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/990/comments",
  "events_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/990/events",
  "html_url": "https://github.com/ethereum-optimism/optimism/issues/990",
  "id": 907561231,
  "node_id": "MDU6SXNzdWU5MDc1NjEyMzE=",
  "number": 990,
  "title": "Calling traceTransaction can cause a hang in l2geth",
  "user": {
    "login": "TerryHannant",
    "id": 83143,
    "node_id": "MDQ6VXNlcjgzMTQz",
    "avatar_url": "https://avatars.githubusercontent.com/u/83143?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/TerryHannant",
    "html_url": "https://github.com/TerryHannant",
    "followers_url": "https://api.github.com/users/TerryHannant/followers",
    "following_url": "https://api.github.com/users/TerryHannant/following{/other_user}",
    "gists_url": "https://api.github.com/users/TerryHannant/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/TerryHannant/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/TerryHannant/subscriptions",
    "organizations_url": "https://api.github.com/users/TerryHannant/orgs",
    "repos_url": "https://api.github.com/users/TerryHannant/repos",
    "events_url": "https://api.github.com/users/TerryHannant/events{/privacy}",
    "received_events_url": "https://api.github.com/users/TerryHannant/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 2907832490,
      "node_id": "MDU6TGFiZWwyOTA3ODMyNDkw",
      "url": "https://api.github.com/repos/ethereum-optimism/optimism/labels/C-bug",
      "name": "C-bug",
      "color": "C5DEF5",
      "default": false,
      "description": "Category: This is a bug."
    },
    {
      "id": 2930018676,
      "node_id": "MDU6TGFiZWwyOTMwMDE4Njc2",
      "url": "https://api.github.com/repos/ethereum-optimism/optimism/labels/P-unconfirmed",
      "name": "P-unconfirmed",
      "color": "BFD4F2",
      "default": false,
      "description": "Issue might be valid, but itâ€™s not yet confirmed"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "gakonst",
    "id": 17802178,
    "node_id": "MDQ6VXNlcjE3ODAyMTc4",
    "avatar_url": "https://avatars.githubusercontent.com/u/17802178?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/gakonst",
    "html_url": "https://github.com/gakonst",
    "followers_url": "https://api.github.com/users/gakonst/followers",
    "following_url": "https://api.github.com/users/gakonst/following{/other_user}",
    "gists_url": "https://api.github.com/users/gakonst/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/gakonst/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/gakonst/subscriptions",
    "organizations_url": "https://api.github.com/users/gakonst/orgs",
    "repos_url": "https://api.github.com/users/gakonst/repos",
    "events_url": "https://api.github.com/users/gakonst/events{/privacy}",
    "received_events_url": "https://api.github.com/users/gakonst/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "gakonst",
      "id": 17802178,
      "node_id": "MDQ6VXNlcjE3ODAyMTc4",
      "avatar_url": "https://avatars.githubusercontent.com/u/17802178?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gakonst",
      "html_url": "https://github.com/gakonst",
      "followers_url": "https://api.github.com/users/gakonst/followers",
      "following_url": "https://api.github.com/users/gakonst/following{/other_user}",
      "gists_url": "https://api.github.com/users/gakonst/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gakonst/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gakonst/subscriptions",
      "organizations_url": "https://api.github.com/users/gakonst/orgs",
      "repos_url": "https://api.github.com/users/gakonst/repos",
      "events_url": "https://api.github.com/users/gakonst/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gakonst/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2021-05-31T15:23:52Z",
  "updated_at": "2021-12-21T19:23:29Z",
  "closed_at": "2021-12-21T19:23:29Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "<!--\r\nNeed help?\r\nRefer to our contributing guidelines for additional information about making a good issue:\r\nhttps://github.com/ethereum-optimism/.github/blob/master/CONTRIBUTING.md\r\n-->\r\n\r\n**Describe the bug**\r\n\r\nWhen calling debug_traceTransaction sometimes no response is received. The does not appear to be related to any particular transaction or tracer used. Mulitple transactions and tracers were used with the same issue occurring.\r\n\r\n\r\n**To Reproduce**\r\nSteps to reproduce the behavior:\r\n1. Monitor numCalls to see when it is approaching ROLLUP_DIFFDB_CACHE value\r\n2. Call debug_traceTransaction RPC method\r\n3. Request does not return\r\n\r\n**Expected behavior**\r\ntraceTransaction should always return\r\n\r\n**System Specs:**\r\n - OS: Debian \r\n\r\n**Additional context**\r\nPossible fix\r\n\r\nAfter some debugging, it appears the root cause is DiffDB. If traceTransaction is called when the max cache size (configured by ROLLUP_DIFFDB_CACHE) is reached and other transactions are being processed then a race condition can occur between DB inserts and commits. When this happens SetDiffKey hangs without returning. Further debugging shows that deadlock is occurring within the Golang SQLite lib insert and commit functions. \r\n\r\nDigging more into the code of api_tracer.go found a difference between traceTransaction and traceBlock/traceChain, which may be relevant.\r\n\r\nIn traceBlock a copy of statedb is used\r\n\r\nhttps://github.com/ethereum-optimism/optimism/blob/develop/l2geth/eth/api_tracer.go#L498\r\n\r\nWhereas traceTransaction the original stateDB is used\r\n\r\nhttps://github.com/ethereum-optimism/optimism/blob/develop/l2geth/eth/api_tracer.go#L719\r\n\r\nLooking at StateDB.Copy()\r\n\r\nhttps://github.com/ethereum-optimism/optimism/blob/develop/l2geth/core/state/statedb.go#L618\r\n\r\nshows that the copied StateDB does not copy the DiffDB field, which turn would mean the DiffDB race condition is avoided.\r\n\r\nSo if traceTransaction is also changed to use a copy of stateDB rather than the original in\r\n\r\nhttps://github.com/ethereum-optimism/optimism/blob/develop/l2geth/eth/api_tracer.go#L719\r\n\r\nthe race condition never occurs (as there is no DiffDB) and debug_traceTransaction never hangs",
  "closed_by": {
    "login": "smartcontracts",
    "id": 14298799,
    "node_id": "MDQ6VXNlcjE0Mjk4Nzk5",
    "avatar_url": "https://avatars.githubusercontent.com/u/14298799?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/smartcontracts",
    "html_url": "https://github.com/smartcontracts",
    "followers_url": "https://api.github.com/users/smartcontracts/followers",
    "following_url": "https://api.github.com/users/smartcontracts/following{/other_user}",
    "gists_url": "https://api.github.com/users/smartcontracts/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/smartcontracts/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/smartcontracts/subscriptions",
    "organizations_url": "https://api.github.com/users/smartcontracts/orgs",
    "repos_url": "https://api.github.com/users/smartcontracts/repos",
    "events_url": "https://api.github.com/users/smartcontracts/events{/privacy}",
    "received_events_url": "https://api.github.com/users/smartcontracts/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/990/reactions",
    "total_count": 1,
    "+1": 1,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/990/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/851631986",
    "html_url": "https://github.com/ethereum-optimism/optimism/issues/990#issuecomment-851631986",
    "issue_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/990",
    "id": 851631986,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg1MTYzMTk4Ng==",
    "user": {
      "login": "smartcontracts",
      "id": 14298799,
      "node_id": "MDQ6VXNlcjE0Mjk4Nzk5",
      "avatar_url": "https://avatars.githubusercontent.com/u/14298799?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/smartcontracts",
      "html_url": "https://github.com/smartcontracts",
      "followers_url": "https://api.github.com/users/smartcontracts/followers",
      "following_url": "https://api.github.com/users/smartcontracts/following{/other_user}",
      "gists_url": "https://api.github.com/users/smartcontracts/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/smartcontracts/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/smartcontracts/subscriptions",
      "organizations_url": "https://api.github.com/users/smartcontracts/orgs",
      "repos_url": "https://api.github.com/users/smartcontracts/repos",
      "events_url": "https://api.github.com/users/smartcontracts/events{/privacy}",
      "received_events_url": "https://api.github.com/users/smartcontracts/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-05-31T18:40:10Z",
    "updated_at": "2021-05-31T18:40:10Z",
    "author_association": "CONTRIBUTOR",
    "body": "IMO we should get rid of DiffDB entirely. I'm like 95% sure we can duplicate the behavior of DiffDB via `debug_traceTransaction`... I'll take a look at this today and see if it's safe to get rid of DiffDB.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/851631986/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/851636811",
    "html_url": "https://github.com/ethereum-optimism/optimism/issues/990#issuecomment-851636811",
    "issue_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/990",
    "id": 851636811,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg1MTYzNjgxMQ==",
    "user": {
      "login": "smartcontracts",
      "id": 14298799,
      "node_id": "MDQ6VXNlcjE0Mjk4Nzk5",
      "avatar_url": "https://avatars.githubusercontent.com/u/14298799?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/smartcontracts",
      "html_url": "https://github.com/smartcontracts",
      "followers_url": "https://api.github.com/users/smartcontracts/followers",
      "following_url": "https://api.github.com/users/smartcontracts/following{/other_user}",
      "gists_url": "https://api.github.com/users/smartcontracts/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/smartcontracts/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/smartcontracts/subscriptions",
      "organizations_url": "https://api.github.com/users/smartcontracts/orgs",
      "repos_url": "https://api.github.com/users/smartcontracts/repos",
      "events_url": "https://api.github.com/users/smartcontracts/events{/privacy}",
      "received_events_url": "https://api.github.com/users/smartcontracts/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-05-31T18:55:53Z",
    "updated_at": "2021-05-31T18:55:53Z",
    "author_association": "CONTRIBUTOR",
    "body": "Yeah seems like we can slightly modify `debug_traceTransaction` to get the behavior that we need. Seems better than maintaining some entirely new code for the same result.\r\n\r\nMaybe question for @gakonst because he was the one who originally implemented DiffDB: do you think we could modify `debug_traceTransaction` instead? Code is here: https://github.com/ethereum-optimism/optimism/blob/5a7984973622d1d6e610ac98cfc206ab9a3bfe1a/l2geth/core/vm/logger.go#L140\r\n\r\n`debug_traceTransaction` differs from what we need in two key ways. First, it only captures on *changes* to storage (SSTORE), we need to capture on SSTORE *and* SLOAD. Second, it captures by looking for SSTORE opcodes: https://github.com/ethereum-optimism/optimism/blob/5a7984973622d1d6e610ac98cfc206ab9a3bfe1a/l2geth/core/vm/logger.go#L154-L160\r\n\r\nWhat we actually want here is to capture on calls to the state manager precompile: https://github.com/ethereum-optimism/optimism/blob/develop/l2geth/core/vm/ovm_state_manager.go ",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/851636811/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/852231771",
    "html_url": "https://github.com/ethereum-optimism/optimism/issues/990#issuecomment-852231771",
    "issue_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/990",
    "id": 852231771,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg1MjIzMTc3MQ==",
    "user": {
      "login": "gakonst",
      "id": 17802178,
      "node_id": "MDQ6VXNlcjE3ODAyMTc4",
      "avatar_url": "https://avatars.githubusercontent.com/u/17802178?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gakonst",
      "html_url": "https://github.com/gakonst",
      "followers_url": "https://api.github.com/users/gakonst/followers",
      "following_url": "https://api.github.com/users/gakonst/following{/other_user}",
      "gists_url": "https://api.github.com/users/gakonst/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gakonst/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gakonst/subscriptions",
      "organizations_url": "https://api.github.com/users/gakonst/orgs",
      "repos_url": "https://api.github.com/users/gakonst/repos",
      "events_url": "https://api.github.com/users/gakonst/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gakonst/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-06-01T15:45:07Z",
    "updated_at": "2021-06-01T15:45:07Z",
    "author_association": "CONTRIBUTOR",
    "body": "This makes sense to me. I think that a short-term fix would be to use a copy of the diffdb as suggested in @TerryHannant's description, and we can add this to the backlog for more stable fraud proof infrastructure. Our nodes will never expose the tracing endpoints so I think that this is not something that can be exploited.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/852231771/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/999034503",
    "html_url": "https://github.com/ethereum-optimism/optimism/issues/990#issuecomment-999034503",
    "issue_url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/990",
    "id": 999034503,
    "node_id": "IC_kwDODjvEJM47jA6H",
    "user": {
      "login": "smartcontracts",
      "id": 14298799,
      "node_id": "MDQ6VXNlcjE0Mjk4Nzk5",
      "avatar_url": "https://avatars.githubusercontent.com/u/14298799?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/smartcontracts",
      "html_url": "https://github.com/smartcontracts",
      "followers_url": "https://api.github.com/users/smartcontracts/followers",
      "following_url": "https://api.github.com/users/smartcontracts/following{/other_user}",
      "gists_url": "https://api.github.com/users/smartcontracts/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/smartcontracts/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/smartcontracts/subscriptions",
      "organizations_url": "https://api.github.com/users/smartcontracts/orgs",
      "repos_url": "https://api.github.com/users/smartcontracts/repos",
      "events_url": "https://api.github.com/users/smartcontracts/events{/privacy}",
      "received_events_url": "https://api.github.com/users/smartcontracts/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-12-21T19:23:29Z",
    "updated_at": "2021-12-21T19:23:29Z",
    "author_association": "CONTRIBUTOR",
    "body": "I think after the OVM 2.0 upgrade this problem most likely no longer exists. DiffDB has been removed and people are using traceTransaction quite frequently. Would be happy to reopen if someone finds that the hang still happens, but I doubt it will.",
    "reactions": {
      "url": "https://api.github.com/repos/ethereum-optimism/optimism/issues/comments/999034503/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
