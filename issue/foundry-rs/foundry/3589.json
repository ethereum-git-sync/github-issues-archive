{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/3589",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3589/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3589/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3589/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/3589",
  "id": 1430042038,
  "node_id": "I_kwDOGBlvNc5VPLW2",
  "number": 3589,
  "title": "feat: `vm.waitForTransaction` for getting tx and receipt info in scripts",
  "user": {
    "login": "mds1",
    "id": 17163988,
    "node_id": "MDQ6VXNlcjE3MTYzOTg4",
    "avatar_url": "https://avatars.githubusercontent.com/u/17163988?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mds1",
    "html_url": "https://github.com/mds1",
    "followers_url": "https://api.github.com/users/mds1/followers",
    "following_url": "https://api.github.com/users/mds1/following{/other_user}",
    "gists_url": "https://api.github.com/users/mds1/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mds1/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mds1/subscriptions",
    "organizations_url": "https://api.github.com/users/mds1/orgs",
    "repos_url": "https://api.github.com/users/mds1/repos",
    "events_url": "https://api.github.com/users/mds1/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mds1/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3593644820,
      "node_id": "LA_kwDOGBlvNc7WMqsU",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-feature",
      "name": "T-feature",
      "color": "BFD4F2",
      "default": false,
      "description": "Type: feature"
    },
    {
      "id": 3703752787,
      "node_id": "LA_kwDOGBlvNc7cwshT",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/C-forge",
      "name": "C-forge",
      "color": "5319E7",
      "default": false,
      "description": "Command: forge"
    },
    {
      "id": 3703752960,
      "node_id": "LA_kwDOGBlvNc7cwskA",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/A-cheatcodes",
      "name": "A-cheatcodes",
      "color": "FBCA04",
      "default": false,
      "description": "Area: cheatcodes"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2022-10-31T15:29:26Z",
  "updated_at": "2023-04-16T22:39:24Z",
  "closed_at": null,
  "author_association": "COLLABORATOR",
  "active_lock_reason": null,
  "body": "### Component\r\n\r\nForge\r\n\r\n### Describe the feature you would like\r\n\r\n### Problems\r\n\r\nFirst problem: In scripts, there's a frontrunning footgun you have to be careful of. Here's an example with pseudocode:\r\n- Transaction 1: Call `gnosisSafeFactory.createSafe()` to deploy a safe with CREATE (so contract nonce matters)\r\n- Transaction 2: Transfer 10 DAI to the safe\r\n\r\nForge will simulate tx1, get the address of the safe, and send tokens to that in tx2. But if someone else deploys a gnosis safe in between, the address of your safe changes and you send tokens to the wrong address. I've encountered this on mainnet, so it's not just theoretical ðŸ™‚\r\n\r\n(Note that an alternative solution to the first problem is to have `--slow` wait for the tx to be mined, then requery for all data before the next transaction)\r\n\r\nSecond problem: The default broadcast artifacts are not ideal for everyone. For example, if you have upgradeable contracts, you may want `<latest-ContractX>.json` for all your contract deploys, instead of one JSON file for each script execution. This is doable by using the file writing cheats within a script, but currently you can't access tx and receipt info so you have more limited logging capabilities than forge itself.\r\n\r\n### Solution\r\n\r\n```solidity\r\nfunction waitForTransaction() external returns (Tx memory tx, Receipt memory receipt);\r\n```\r\n\r\n(or if ethers-rs has a function of the same purpose with a different name, the cheatcode can match that name)\r\n\r\nThis cheatcode can be called after each broadcasted transaction. It will wait for the transaction to be mined, return the tx and receipt data, then continue.\r\n\r\nOne issue here is the returned structs will differ depending on if the tx is type 0, 1, or 2. As a result we probably need to just return `bytes memory` for both `tx` and `receipt`, and use the existing JSON [helper structs](https://github.com/foundry-rs/forge-std/blob/2a2ce3692b8c1523b29de3ec9d961ee9fbbc43a6/src/Test.sol#L469) with forge-std methods to help decode the transactions, which is ok.\r\n\r\nOne other issue is that this is the first cheatcode that would be \"script only\", i.e. this wouldn't make much sense in tests, though I guess it could work there too but for all transactions?\r\n\r\n### Additional context\r\n\r\n_No response_",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/3589/reactions",
    "total_count": 4,
    "+1": 4,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3589/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1509868028",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3589#issuecomment-1509868028",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3589",
    "id": 1509868028,
    "node_id": "IC_kwDOGBlvNc5Z_sH8",
    "user": {
      "login": "PatrickAlphaC",
      "id": 54278053,
      "node_id": "MDQ6VXNlcjU0Mjc4MDUz",
      "avatar_url": "https://avatars.githubusercontent.com/u/54278053?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/PatrickAlphaC",
      "html_url": "https://github.com/PatrickAlphaC",
      "followers_url": "https://api.github.com/users/PatrickAlphaC/followers",
      "following_url": "https://api.github.com/users/PatrickAlphaC/following{/other_user}",
      "gists_url": "https://api.github.com/users/PatrickAlphaC/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/PatrickAlphaC/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/PatrickAlphaC/subscriptions",
      "organizations_url": "https://api.github.com/users/PatrickAlphaC/orgs",
      "repos_url": "https://api.github.com/users/PatrickAlphaC/repos",
      "events_url": "https://api.github.com/users/PatrickAlphaC/events{/privacy}",
      "received_events_url": "https://api.github.com/users/PatrickAlphaC/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-15T15:11:35Z",
    "updated_at": "2023-04-15T15:11:35Z",
    "author_association": "NONE",
    "body": "Additionally, this would be helpful for verifiers. Right now a forge script waits for 1 transaction receipt, but I often find that 6 is a safer amount for a block explorer to have indexed the contract& transaction.",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1509868028/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1509868183",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3589#issuecomment-1509868183",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3589",
    "id": 1509868183,
    "node_id": "IC_kwDOGBlvNc5Z_sKX",
    "user": {
      "login": "PatrickAlphaC",
      "id": 54278053,
      "node_id": "MDQ6VXNlcjU0Mjc4MDUz",
      "avatar_url": "https://avatars.githubusercontent.com/u/54278053?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/PatrickAlphaC",
      "html_url": "https://github.com/PatrickAlphaC",
      "followers_url": "https://api.github.com/users/PatrickAlphaC/followers",
      "following_url": "https://api.github.com/users/PatrickAlphaC/following{/other_user}",
      "gists_url": "https://api.github.com/users/PatrickAlphaC/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/PatrickAlphaC/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/PatrickAlphaC/subscriptions",
      "organizations_url": "https://api.github.com/users/PatrickAlphaC/orgs",
      "repos_url": "https://api.github.com/users/PatrickAlphaC/repos",
      "events_url": "https://api.github.com/users/PatrickAlphaC/events{/privacy}",
      "received_events_url": "https://api.github.com/users/PatrickAlphaC/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-15T15:12:27Z",
    "updated_at": "2023-04-15T15:12:52Z",
    "author_association": "NONE",
    "body": "Or, I'd love to see this option too:\r\n\r\n```\r\nforge script script/MyScript.s.sol --confirmations 6\r\n```\r\n\r\nand it waits 6 confirmations before trying to verify",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1509868183/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1510507264",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3589#issuecomment-1510507264",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3589",
    "id": 1510507264,
    "node_id": "IC_kwDOGBlvNc5aCIMA",
    "user": {
      "login": "mds1",
      "id": 17163988,
      "node_id": "MDQ6VXNlcjE3MTYzOTg4",
      "avatar_url": "https://avatars.githubusercontent.com/u/17163988?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mds1",
      "html_url": "https://github.com/mds1",
      "followers_url": "https://api.github.com/users/mds1/followers",
      "following_url": "https://api.github.com/users/mds1/following{/other_user}",
      "gists_url": "https://api.github.com/users/mds1/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mds1/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mds1/subscriptions",
      "organizations_url": "https://api.github.com/users/mds1/orgs",
      "repos_url": "https://api.github.com/users/mds1/repos",
      "events_url": "https://api.github.com/users/mds1/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mds1/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-16T22:39:23Z",
    "updated_at": "2023-04-16T22:39:23Z",
    "author_association": "COLLABORATOR",
    "body": "Just noting that we're now tracking that confirmations suggestion in https://github.com/foundry-rs/foundry/issues/4748 (thanks for creating the issue!)",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1510507264/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
