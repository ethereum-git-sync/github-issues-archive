{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/5251",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5251/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5251/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5251/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/5251",
  "id": 1781183220,
  "node_id": "I_kwDOGBlvNc5qKrL0",
  "number": 5251,
  "title": "Forge verification multiple failures ",
  "user": {
    "login": "amp2122",
    "id": 138130975,
    "node_id": "U_kgDOCDu2Hw",
    "avatar_url": "https://avatars.githubusercontent.com/u/138130975?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/amp2122",
    "html_url": "https://github.com/amp2122",
    "followers_url": "https://api.github.com/users/amp2122/followers",
    "following_url": "https://api.github.com/users/amp2122/following{/other_user}",
    "gists_url": "https://api.github.com/users/amp2122/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/amp2122/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/amp2122/subscriptions",
    "organizations_url": "https://api.github.com/users/amp2122/orgs",
    "repos_url": "https://api.github.com/users/amp2122/repos",
    "events_url": "https://api.github.com/users/amp2122/events{/privacy}",
    "received_events_url": "https://api.github.com/users/amp2122/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3334394228,
      "node_id": "MDU6TGFiZWwzMzM0Mzk0MjI4",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-bug",
      "name": "T-bug",
      "color": "d73a4a",
      "default": false,
      "description": "Type: bug"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2023-06-29T16:43:21Z",
  "updated_at": "2023-06-29T19:40:18Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Component\r\n\r\nForge\r\n\r\n### Have you ensured that all of these are up to date?\r\n\r\n- [X] Foundry\r\n- [X] Foundryup\r\n\r\n### What version of Foundry are you on?\r\n\r\nforge 0.2.0 (f9fc929 2023-06-29T00:12:09.234859595Z)\r\n\r\n### What command(s) is the bug in?\r\n\r\nforge `verify-contract` and tied procedures (`--verify`) in `create` and `script`\r\n\r\n### Operating System\r\n\r\nLinux\r\n\r\n### Describe the bug\r\n\r\nReporting this here because it is possibly a bug and also I don't have the capabilities to use Telegram.\r\n\r\n### Errors\r\n\r\nForge verification via `verify-contract` or via the `--verify` flag using `create` is failing with the error:\r\n\r\n`Fail - Unable to verify. Compiled contract deployment bytecode does NOT match the transaction deployment bytecode.`\r\n\r\nIt also fails to verify the same contract when deploying via `forge script <...> --broadcast --verify`, but with the error:\r\n\r\n`Error: \r\nexpected value at line 1 column 1`\r\n\r\nThe errors are thrown for both mainnet and goerli deployments.\r\n\r\n### Project setup\r\n\r\nThe `foundry.toml` file:\r\n\r\n```\r\n[profile.default]\r\n# General\r\nsrc = 'src'\r\nout = 'out'\r\nlibs = [ \"lib\"]\r\n\r\n# Compiler\r\nevm_version = 'shanghai'\r\nauto_detect_solc = true\r\noptimizer-runs = 1_000_000\r\noptimizer = true\r\nvia_ir = false\r\n\r\n# Tests\r\nverbosity = 2\r\n\r\n[rpc_endpoints]\r\nmainnet = \"${MAINNET_RPC_URL}\"\r\ngoerli = \"${GOERLI_RPC_URL}\"\r\n\r\n[etherscan]\r\nmainnet = { key = \"${ETHERSCAN_KEY}\" }\r\ngoerli = { key = \"${ETHERSCAN_KEY\"}\r\n```\r\n\r\nI've also tried fixing `solc_version`, removing `evm_version`, turning the `optimizer` on and off. As you can note `via_ir` is stricly set to false. The compiler version being used is `0.6.12+commit.27d51765`.\r\n\r\nExample `create` call:\r\n\r\n`\r\nforge create --rpc-url \"$GOERLI_RPC_URL\" --constructor-args <address> --private-key <key> --etherscan-api-key \"$ETHERSCAN_KEY\" --verify src/v1/Contract.sol:Contract\r\n`\r\n\r\nExample `script` call:\r\n\r\n`\r\nforge script --rpc-url $GOERLI_RPC_URL --broadcast --verify -vvvv script/Deploys.sol:ContractDeployer\r\n`\r\n\r\nExample `verify-contract` call:\r\n\r\n`\r\nforge verify-contract --chain-id 5 --num-of-optimizations 1000000 --watch --constructor-args $(cast abi-encode \"constructor(address)\" <ADDRESS>) --etherscan-api-key $ETHERSCAN_KEY --compiler-version '0.6.12+commit.27d51765' <DEPLOYED ADDRESS> src/v1/Contract.sol:Contract\r\n`\r\n\r\nExample deployment script:\r\n\r\n```solidity\r\nabstract contract BaseDeployer is Addresses, Script {\r\n    function _createContract() internal virtual;\r\n\r\n    function run() external {\r\n        uint256 key = vm.envUint(\"PRIVATE_KEY\");\r\n\r\n        vm.startBroadcast(key);\r\n\r\n        _createContract();\r\n\r\n        vm.stopBroadcast();\r\n    }\r\n}\r\n\r\nimport { Contract } from \"../src/v1/Contract.sol\";\r\n\r\ncontract ContractDeployer is BaseDeployer {\r\n    function _createContract() internal virtual override {\r\n        new Contract(getSomeAddress());\r\n    }\r\n}\r\n```\r\n\r\n`Contract.sol` dependencies are only imported from files under `lib` or under `src`. A clean setup has also been tested (push the repo then clone it to another dir), and it fails too. The deployed contract by itself doesn't do anything weird, at most it inherits from `Initializable.sol`, and it uses a few other contracts which are imported into the file.\r\n\r\nI've also checked the compiler version. It is correct.\r\n\r\nNote that this issue also existed under `20230616`, but I attempted an upgrade, and it didn't help.\r\n\r\n### Other\r\n\r\nI've also attempted use Etherscan manually, then doing standard json input and then comparing the output of `verify-contract` when piped to a file. Essentially, for a chunk of say 200 bytes, within that chunk there is going to be maybe a 16 byte difference and these changes are all going to be on average in chunks of 1-2 bytes, but some also with larger difference. Some smaller chunks (1 and 2 bytes chunks) then map to the same byte length but with a different value.",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/5251/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5251/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1613528457",
    "html_url": "https://github.com/foundry-rs/foundry/issues/5251#issuecomment-1613528457",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5251",
    "id": 1613528457,
    "node_id": "IC_kwDOGBlvNc5gLH2J",
    "user": {
      "login": "mattsse",
      "id": 19890894,
      "node_id": "MDQ6VXNlcjE5ODkwODk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/19890894?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mattsse",
      "html_url": "https://github.com/mattsse",
      "followers_url": "https://api.github.com/users/mattsse/followers",
      "following_url": "https://api.github.com/users/mattsse/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattsse/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mattsse/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattsse/subscriptions",
      "organizations_url": "https://api.github.com/users/mattsse/orgs",
      "repos_url": "https://api.github.com/users/mattsse/repos",
      "events_url": "https://api.github.com/users/mattsse/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mattsse/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-06-29T16:53:53Z",
    "updated_at": "2023-06-29T16:53:53Z",
    "author_association": "MEMBER",
    "body": "> Essentially, for a chunk of say 200 bytes, within that chunk there is going to be maybe a 16 byte difference and these changes are all going to be on average in chunks of 1-2 bytes, but some also with larger difference. Most notably, the chunks then map to the same byte length but with a different value.\r\n\r\nsorry can you elaborate on this again, I don't follow, perhaps you can attach both variants",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1613528457/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1613530378",
    "html_url": "https://github.com/foundry-rs/foundry/issues/5251#issuecomment-1613530378",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5251",
    "id": 1613530378,
    "node_id": "IC_kwDOGBlvNc5gLIUK",
    "user": {
      "login": "amp2122",
      "id": 138130975,
      "node_id": "U_kgDOCDu2Hw",
      "avatar_url": "https://avatars.githubusercontent.com/u/138130975?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/amp2122",
      "html_url": "https://github.com/amp2122",
      "followers_url": "https://api.github.com/users/amp2122/followers",
      "following_url": "https://api.github.com/users/amp2122/following{/other_user}",
      "gists_url": "https://api.github.com/users/amp2122/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/amp2122/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/amp2122/subscriptions",
      "organizations_url": "https://api.github.com/users/amp2122/orgs",
      "repos_url": "https://api.github.com/users/amp2122/repos",
      "events_url": "https://api.github.com/users/amp2122/events{/privacy}",
      "received_events_url": "https://api.github.com/users/amp2122/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-06-29T16:55:32Z",
    "updated_at": "2023-06-29T17:05:02Z",
    "author_association": "NONE",
    "body": "I will split out a small example part, hold on for a second.",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1613530378/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1613541144",
    "html_url": "https://github.com/foundry-rs/foundry/issues/5251#issuecomment-1613541144",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5251",
    "id": 1613541144,
    "node_id": "IC_kwDOGBlvNc5gLK8Y",
    "user": {
      "login": "amp2122",
      "id": 138130975,
      "node_id": "U_kgDOCDu2Hw",
      "avatar_url": "https://avatars.githubusercontent.com/u/138130975?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/amp2122",
      "html_url": "https://github.com/amp2122",
      "followers_url": "https://api.github.com/users/amp2122/followers",
      "following_url": "https://api.github.com/users/amp2122/following{/other_user}",
      "gists_url": "https://api.github.com/users/amp2122/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/amp2122/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/amp2122/subscriptions",
      "organizations_url": "https://api.github.com/users/amp2122/orgs",
      "repos_url": "https://api.github.com/users/amp2122/repos",
      "events_url": "https://api.github.com/users/amp2122/events{/privacy}",
      "received_events_url": "https://api.github.com/users/amp2122/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-06-29T17:03:40Z",
    "updated_at": "2023-06-29T17:05:28Z",
    "author_association": "NONE",
    "body": "Ok so that last statement (edited it now to be correct) wasn't fully right, for example, there are many small parts in bytecode like:\r\n\r\n`\r\n61169356\r\n`\r\n\r\nwhich then map to\r\n\r\n`\r\n6116ad56\r\n`\r\n\r\nBut I've just noticed that there are in fact some larger parts which don't map to the same length like that, so I don't think it matters too much.",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1613541144/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1613554743",
    "html_url": "https://github.com/foundry-rs/foundry/issues/5251#issuecomment-1613554743",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5251",
    "id": 1613554743,
    "node_id": "IC_kwDOGBlvNc5gLOQ3",
    "user": {
      "login": "amp2122",
      "id": 138130975,
      "node_id": "U_kgDOCDu2Hw",
      "avatar_url": "https://avatars.githubusercontent.com/u/138130975?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/amp2122",
      "html_url": "https://github.com/amp2122",
      "followers_url": "https://api.github.com/users/amp2122/followers",
      "following_url": "https://api.github.com/users/amp2122/following{/other_user}",
      "gists_url": "https://api.github.com/users/amp2122/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/amp2122/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/amp2122/subscriptions",
      "organizations_url": "https://api.github.com/users/amp2122/orgs",
      "repos_url": "https://api.github.com/users/amp2122/repos",
      "events_url": "https://api.github.com/users/amp2122/events{/privacy}",
      "received_events_url": "https://api.github.com/users/amp2122/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-06-29T17:15:38Z",
    "updated_at": "2023-06-29T17:18:35Z",
    "author_association": "NONE",
    "body": "I've actually went ahead and disabled every option in the toml file and it still doesn't verify. Same errors as specified. It has got to be something with the contracts, but those compile and simply compile with different bytecode according to Etherscan.",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1613554743/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1613683882",
    "html_url": "https://github.com/foundry-rs/foundry/issues/5251#issuecomment-1613683882",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5251",
    "id": 1613683882,
    "node_id": "IC_kwDOGBlvNc5gLtyq",
    "user": {
      "login": "amp2122",
      "id": 138130975,
      "node_id": "U_kgDOCDu2Hw",
      "avatar_url": "https://avatars.githubusercontent.com/u/138130975?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/amp2122",
      "html_url": "https://github.com/amp2122",
      "followers_url": "https://api.github.com/users/amp2122/followers",
      "following_url": "https://api.github.com/users/amp2122/following{/other_user}",
      "gists_url": "https://api.github.com/users/amp2122/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/amp2122/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/amp2122/subscriptions",
      "organizations_url": "https://api.github.com/users/amp2122/orgs",
      "repos_url": "https://api.github.com/users/amp2122/repos",
      "events_url": "https://api.github.com/users/amp2122/events{/privacy}",
      "received_events_url": "https://api.github.com/users/amp2122/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-06-29T19:28:11Z",
    "updated_at": "2023-06-29T19:40:18Z",
    "author_association": "NONE",
    "body": "So Hardhat manages to deploy and verify some of the contracts which I'm working with, but even it fails verifying one contract. EDIT: Seems the last contract verifies with Hardhat after optimizations are off.",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1613683882/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
