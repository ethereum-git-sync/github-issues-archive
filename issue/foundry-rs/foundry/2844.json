{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/2844",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/2844/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/2844/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/2844/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/2844",
  "id": 1344377697,
  "node_id": "I_kwDOGBlvNc5QIZNh",
  "number": 2844,
  "title": "feat: `vm.finalize`",
  "user": {
    "login": "0xA5DF",
    "id": 108216601,
    "node_id": "U_kgDOBnNBGQ",
    "avatar_url": "https://avatars.githubusercontent.com/u/108216601?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/0xA5DF",
    "html_url": "https://github.com/0xA5DF",
    "followers_url": "https://api.github.com/users/0xA5DF/followers",
    "following_url": "https://api.github.com/users/0xA5DF/following{/other_user}",
    "gists_url": "https://api.github.com/users/0xA5DF/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/0xA5DF/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/0xA5DF/subscriptions",
    "organizations_url": "https://api.github.com/users/0xA5DF/orgs",
    "repos_url": "https://api.github.com/users/0xA5DF/repos",
    "events_url": "https://api.github.com/users/0xA5DF/events{/privacy}",
    "received_events_url": "https://api.github.com/users/0xA5DF/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3334394228,
      "node_id": "MDU6TGFiZWwzMzM0Mzk0MjI4",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-bug",
      "name": "T-bug",
      "color": "d73a4a",
      "default": false,
      "description": "Type: bug"
    },
    {
      "id": 3593644915,
      "node_id": "LA_kwDOGBlvNc7WMqtz",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/Cmd-forge-test",
      "name": "Cmd-forge-test",
      "color": "006B75",
      "default": false,
      "description": "Command: forge test"
    },
    {
      "id": 3703752787,
      "node_id": "LA_kwDOGBlvNc7cwshT",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/C-forge",
      "name": "C-forge",
      "color": "5319E7",
      "default": false,
      "description": "Command: forge"
    },
    {
      "id": 3759719790,
      "node_id": "LA_kwDOGBlvNc7gGMVu",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/P-low",
      "name": "P-low",
      "color": "D93F0B",
      "default": false,
      "description": "Priority: low"
    },
    {
      "id": 3759720129,
      "node_id": "LA_kwDOGBlvNc7gGMbB",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/D-hard",
      "name": "D-hard",
      "color": "0E8A16",
      "default": false,
      "description": "Difficulty: hard"
    },
    {
      "id": 3759773804,
      "node_id": "LA_kwDOGBlvNc7gGZhs",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/A-gas-snapshots",
      "name": "A-gas-snapshots",
      "color": "FBCA04",
      "default": false,
      "description": "Area: gas snapshotting/reporting"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2022-08-19T12:29:44Z",
  "updated_at": "2022-10-02T20:52:45Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Component\n\nForge\n\n### Have you ensured that all of these are up to date?\n\n- [X] Foundry\n- [X] Foundryup\n\n### What version of Foundry are you on?\n\nforge 0.2.0 (6b3db2a 2022-08-19T00:04:42.579272325Z)\n\n### What command(s) is the bug in?\n\nforge test --gas-report\n\n### Operating System\n\nLinux\n\n### Describe the bug\n\n#1543 discusses 'each test being considered one tx' regarding `selfdestruct`.\r\nHowever there's another aspect that this affects - gas reports.\r\n\r\nSince some opcodes depend on whether the address/key is warm or cold (i.e. if it has been used in current tx), considering the test as one tx can make the gas cost estimation significantly lower (since using cold key/address are very expensive, for example warm `sload` would cost 0.1K units while a cold one would cost 2.1K).\r\n\r\nI've created [a gist that demonstrates that](https://gist.github.com/0xA5DF/cc71e507d45fd51d708b3e8318654ce5).\r\n\r\nFor full list of opcodes that are affected by this, [see this link](https://www.evm.codes/about#accesssets).\r\n\r\n### Solution\r\nAs suggested in #1543, maybe allow to `finalize` a tx from the test (maybe also allow an auto-finalizing before each call to non-test contracts).\r\n \r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/2844/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/2844/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1262193130",
    "html_url": "https://github.com/foundry-rs/foundry/issues/2844#issuecomment-1262193130",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/2844",
    "id": 1262193130,
    "node_id": "IC_kwDOGBlvNc5LO4nq",
    "user": {
      "login": "k06a",
      "id": 702124,
      "node_id": "MDQ6VXNlcjcwMjEyNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/702124?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/k06a",
      "html_url": "https://github.com/k06a",
      "followers_url": "https://api.github.com/users/k06a/followers",
      "following_url": "https://api.github.com/users/k06a/following{/other_user}",
      "gists_url": "https://api.github.com/users/k06a/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/k06a/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/k06a/subscriptions",
      "organizations_url": "https://api.github.com/users/k06a/orgs",
      "repos_url": "https://api.github.com/users/k06a/repos",
      "events_url": "https://api.github.com/users/k06a/events{/privacy}",
      "received_events_url": "https://api.github.com/users/k06a/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-29T12:15:52Z",
    "updated_at": "2022-09-29T12:15:52Z",
    "author_association": "NONE",
    "body": "Any progress on this?",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1262193130/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1262267856",
    "html_url": "https://github.com/foundry-rs/foundry/issues/2844#issuecomment-1262267856",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/2844",
    "id": 1262267856,
    "node_id": "IC_kwDOGBlvNc5LPK3Q",
    "user": {
      "login": "mattsse",
      "id": 19890894,
      "node_id": "MDQ6VXNlcjE5ODkwODk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/19890894?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mattsse",
      "html_url": "https://github.com/mattsse",
      "followers_url": "https://api.github.com/users/mattsse/followers",
      "following_url": "https://api.github.com/users/mattsse/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattsse/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mattsse/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattsse/subscriptions",
      "organizations_url": "https://api.github.com/users/mattsse/orgs",
      "repos_url": "https://api.github.com/users/mattsse/repos",
      "events_url": "https://api.github.com/users/mattsse/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mattsse/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-29T13:17:36Z",
    "updated_at": "2022-09-29T13:17:36Z",
    "author_association": "MEMBER",
    "body": "I can see how this is useful.\r\n\r\njust to summarize, vm.finalize should\r\n\r\ncommit the current state changes in a transaction?\r\n\r\nwhat should happen with the current (in memory) state of the test at this point? Like all variables etc.? \r\n\r\nwould cheatcodes that load/unload address/slots be equivalent here?\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1262267856/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1264730837",
    "html_url": "https://github.com/foundry-rs/foundry/issues/2844#issuecomment-1264730837",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/2844",
    "id": 1264730837,
    "node_id": "IC_kwDOGBlvNc5LYkLV",
    "user": {
      "login": "0xA5DF",
      "id": 108216601,
      "node_id": "U_kgDOBnNBGQ",
      "avatar_url": "https://avatars.githubusercontent.com/u/108216601?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/0xA5DF",
      "html_url": "https://github.com/0xA5DF",
      "followers_url": "https://api.github.com/users/0xA5DF/followers",
      "following_url": "https://api.github.com/users/0xA5DF/following{/other_user}",
      "gists_url": "https://api.github.com/users/0xA5DF/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/0xA5DF/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/0xA5DF/subscriptions",
      "organizations_url": "https://api.github.com/users/0xA5DF/orgs",
      "repos_url": "https://api.github.com/users/0xA5DF/repos",
      "events_url": "https://api.github.com/users/0xA5DF/events{/privacy}",
      "received_events_url": "https://api.github.com/users/0xA5DF/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-10-02T20:52:45Z",
    "updated_at": "2022-10-02T20:52:45Z",
    "author_association": "NONE",
    "body": "The `finalize()` is needed to solve 2 issues:\r\n\r\n1. As mentioned here, gas calculations depends on if a key or address is 'warm' or 'cold'. At the beginning of each tx all addresses and keys are cold, therefore `finalize()` should make all keys and addresses cold.\r\n2. As mentioned in issue #1543, `selfdestruct` should take effect at the end of a tx, therefore `finalize()` should also clear out the code and storage of destructed addresses.\r\n\r\nI don't think there's a need to change the state of the memory of the stack, since those don't affect external calls.\r\n\r\nThe way I see it is that usually the 'real' tx are the external calls done to the source code, and `finalize()` would be called in the test code. Therefore as long as the calls to those external functions in the source code act as separate tx that's all we need.\r\n\r\nIt'd also be nice if there would be an option to set the finalize function to run automatically between each call from the test-code to an external function in the source code, since that's when it's normally needed (people are just unaware of this issue currently, and are getting wrong gas calculations due to that. Enabling this auto-finalize by default would help them get more accurate result without putting too much effort). But this might be too complicated to implement so I'll understand if you'll skip this 'auto-finalize'.",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1264730837/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
