{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/1894",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/1894/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/1894/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/1894/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/1894",
  "id": 1266160953,
  "node_id": "I_kwDOGBlvNc5LeBU5",
  "number": 1894,
  "title": "Foundry: Fork state used if storage slot is cleared",
  "user": {
    "login": "bernard-wagner",
    "id": 4208881,
    "node_id": "MDQ6VXNlcjQyMDg4ODE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4208881?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/bernard-wagner",
    "html_url": "https://github.com/bernard-wagner",
    "followers_url": "https://api.github.com/users/bernard-wagner/followers",
    "following_url": "https://api.github.com/users/bernard-wagner/following{/other_user}",
    "gists_url": "https://api.github.com/users/bernard-wagner/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/bernard-wagner/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/bernard-wagner/subscriptions",
    "organizations_url": "https://api.github.com/users/bernard-wagner/orgs",
    "repos_url": "https://api.github.com/users/bernard-wagner/repos",
    "events_url": "https://api.github.com/users/bernard-wagner/events{/privacy}",
    "received_events_url": "https://api.github.com/users/bernard-wagner/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3334394228,
      "node_id": "MDU6TGFiZWwzMzM0Mzk0MjI4",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-bug",
      "name": "T-bug",
      "color": "d73a4a",
      "default": false,
      "description": "Type: bug"
    },
    {
      "id": 4077188949,
      "node_id": "LA_kwDOGBlvNc7zBPdV",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/C-anvil",
      "name": "C-anvil",
      "color": "5319E7",
      "default": false,
      "description": "Command: anvil"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "mattsse",
    "id": 19890894,
    "node_id": "MDQ6VXNlcjE5ODkwODk0",
    "avatar_url": "https://avatars.githubusercontent.com/u/19890894?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mattsse",
    "html_url": "https://github.com/mattsse",
    "followers_url": "https://api.github.com/users/mattsse/followers",
    "following_url": "https://api.github.com/users/mattsse/following{/other_user}",
    "gists_url": "https://api.github.com/users/mattsse/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mattsse/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mattsse/subscriptions",
    "organizations_url": "https://api.github.com/users/mattsse/orgs",
    "repos_url": "https://api.github.com/users/mattsse/repos",
    "events_url": "https://api.github.com/users/mattsse/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mattsse/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "mattsse",
      "id": 19890894,
      "node_id": "MDQ6VXNlcjE5ODkwODk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/19890894?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mattsse",
      "html_url": "https://github.com/mattsse",
      "followers_url": "https://api.github.com/users/mattsse/followers",
      "following_url": "https://api.github.com/users/mattsse/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattsse/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mattsse/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattsse/subscriptions",
      "organizations_url": "https://api.github.com/users/mattsse/orgs",
      "repos_url": "https://api.github.com/users/mattsse/repos",
      "events_url": "https://api.github.com/users/mattsse/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mattsse/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/milestones/1",
    "html_url": "https://github.com/foundry-rs/foundry/milestone/1",
    "labels_url": "https://api.github.com/repos/foundry-rs/foundry/milestones/1/labels",
    "id": 8140456,
    "node_id": "MI_kwDOGBlvNc4AfDao",
    "number": 1,
    "title": "v1.0.0",
    "description": "",
    "creator": {
      "login": "onbjerg",
      "id": 8862627,
      "node_id": "MDQ6VXNlcjg4NjI2Mjc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8862627?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/onbjerg",
      "html_url": "https://github.com/onbjerg",
      "followers_url": "https://api.github.com/users/onbjerg/followers",
      "following_url": "https://api.github.com/users/onbjerg/following{/other_user}",
      "gists_url": "https://api.github.com/users/onbjerg/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/onbjerg/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/onbjerg/subscriptions",
      "organizations_url": "https://api.github.com/users/onbjerg/orgs",
      "repos_url": "https://api.github.com/users/onbjerg/repos",
      "events_url": "https://api.github.com/users/onbjerg/events{/privacy}",
      "received_events_url": "https://api.github.com/users/onbjerg/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 10,
    "closed_issues": 125,
    "state": "open",
    "created_at": "2022-06-28T08:15:32Z",
    "updated_at": "2023-05-12T14:44:03Z",
    "due_on": null,
    "closed_at": null
  },
  "comments": 3,
  "created_at": "2022-06-09T13:46:13Z",
  "updated_at": "2022-07-07T18:19:39Z",
  "closed_at": "2022-07-07T18:19:39Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "### Component\r\n\r\nForge, Cast, Anvil\r\n\r\n### Have you ensured that all of these are up to date?\r\n\r\n- [X] Foundry\r\n- [X] Foundryup\r\n\r\n### What version of Foundry are you on?\r\n\r\nanvil 0.1.0 (23f7db9 2022-06-08T18:32:28.171151Z)\r\n\r\n### What command(s) is the bug in?\r\n\r\nanvil, cast run\r\n\r\n### Operating System\r\n\r\nLinux\r\n\r\n### Describe the bug\r\n\r\nInteresting behaviour between Anvil and cast run when using forked state. If a storage slot gets cleared, the ForkedDB will revert to using the cache and not the reset value.  This is because `revm` removes the entry if the value is set to 0. ForkedDB looks for the existence of the entry to determine whether to use fork cache or in memory db.\r\n\r\nA temporary fix to test the theory:\r\n\r\n```diff\r\ndiff --git a/crates/revm/src/db/in_memory_db.rs b/crates/revm/src/db/in_memory_db.rs\r\nindex 725473b..f7201ee 100644\r\n--- a/crates/revm/src/db/in_memory_db.rs\r\n+++ b/crates/revm/src/db/in_memory_db.rs\r\n@@ -97,11 +97,7 @@ impl<ExtDB: DatabaseRef> DatabaseCommit for CacheDB<ExtDB> {\r\n                     storage.clear();\r\n                 }\r\n                 for (index, value) in acc.storage {\r\n-                    if value.is_zero() {\r\n-                        storage.remove(&index);\r\n-                    } else {\r\n-                        storage.insert(index, value);\r\n-                    }\r\n+                    storage.insert(index, value);\r\n                 }\r\n                 if storage.is_empty() {\r\n                     self.storage.remove(&add);\r\n```\r\n\r\n### Test scenario\r\n\r\n```\r\ncast run  0xeea7f8b87ea2ba65df2f2217aafa6b75de8ac02cad7d27f8c089c24778fed35a\r\nExecuting previous transactions from the block.\r\nTraces:\r\n  [11152] 0xc02a…6cc2::2e1a7d4d(00000000000000000000000000000000000000000000000036adb11fff0a0000) \r\n    ├─ [0] 0x5370…79a1::fallback{value: 3940000000000000000}() \r\n    │   └─ ← ()\r\n    ├─  emit topic 0: 0x7fcf532c15f0a6db0bd6d0e038bea71d30d808c7d98cb3bf7268a95bf5081b65\r\n    │       topic 1: 0x000000000000000000000000537038d516e7e71bff78a555799ce0daa01e79a1\r\n    │           data: 0x00000000000000000000000000000000000000000000000036adb11fff0a0000\r\n    └─ ← ()\r\n\r\n\r\nScript ran successfully.\r\nGas used: 30404\r\n```\r\n\r\nThis transaction should fail as there is a [previous transaction](https://etherscan.io/tx/0x8f131617fdf3123c41dd0a5b82ef91e849bafd431130f5c46315e7e846b6d434) in the block from the same caller that already withdraws the WETH:\r\n```\r\ncast receipt 0xeea7f8b87ea2ba65df2f2217aafa6b75de8ac02cad7d27f8c089c24778fed35a\r\nblockHash               0xcfc76595e43d4dd9586c4beedf20fc5bebe6b669166eb41135dc85f70bbf1054\r\nblockNumber             14047503\r\ncontractAddress         \r\ncumulativeGasUsed       22811249\r\neffectiveGasPrice       142910302616\r\ngasUsed                 23731\r\nlogs                    []\r\nlogsBloom               0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\nroot                    \r\nstatus                  0\r\ntransactionHash         0xeea7f8b87ea2ba65df2f2217aafa6b75de8ac02cad7d27f8c089c24778fed35a\r\ntransactionIndex        421\r\ntype                    2\r\n```\r\n\r\n",
  "closed_by": {
    "login": "gakonst",
    "id": 17802178,
    "node_id": "MDQ6VXNlcjE3ODAyMTc4",
    "avatar_url": "https://avatars.githubusercontent.com/u/17802178?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/gakonst",
    "html_url": "https://github.com/gakonst",
    "followers_url": "https://api.github.com/users/gakonst/followers",
    "following_url": "https://api.github.com/users/gakonst/following{/other_user}",
    "gists_url": "https://api.github.com/users/gakonst/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/gakonst/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/gakonst/subscriptions",
    "organizations_url": "https://api.github.com/users/gakonst/orgs",
    "repos_url": "https://api.github.com/users/gakonst/repos",
    "events_url": "https://api.github.com/users/gakonst/events{/privacy}",
    "received_events_url": "https://api.github.com/users/gakonst/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/1894/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/1894/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1151503905",
    "html_url": "https://github.com/foundry-rs/foundry/issues/1894#issuecomment-1151503905",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/1894",
    "id": 1151503905,
    "node_id": "IC_kwDOGBlvNc5Eoo4h",
    "user": {
      "login": "mattsse",
      "id": 19890894,
      "node_id": "MDQ6VXNlcjE5ODkwODk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/19890894?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mattsse",
      "html_url": "https://github.com/mattsse",
      "followers_url": "https://api.github.com/users/mattsse/followers",
      "following_url": "https://api.github.com/users/mattsse/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattsse/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mattsse/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattsse/subscriptions",
      "organizations_url": "https://api.github.com/users/mattsse/orgs",
      "repos_url": "https://api.github.com/users/mattsse/repos",
      "events_url": "https://api.github.com/users/mattsse/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mattsse/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-06-09T19:09:07Z",
    "updated_at": "2022-06-09T19:09:07Z",
    "author_association": "MEMBER",
    "body": "good find!\r\n\r\n@rakita wdyt about also keeping `0` values in the account storage, instead of removing them? \r\nwould this cause any side effects?",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1151503905/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1152099921",
    "html_url": "https://github.com/foundry-rs/foundry/issues/1894#issuecomment-1152099921",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/1894",
    "id": 1152099921,
    "node_id": "IC_kwDOGBlvNc5Eq6ZR",
    "user": {
      "login": "rakita",
      "id": 13179220,
      "node_id": "MDQ6VXNlcjEzMTc5MjIw",
      "avatar_url": "https://avatars.githubusercontent.com/u/13179220?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rakita",
      "html_url": "https://github.com/rakita",
      "followers_url": "https://api.github.com/users/rakita/followers",
      "following_url": "https://api.github.com/users/rakita/following{/other_user}",
      "gists_url": "https://api.github.com/users/rakita/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rakita/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rakita/subscriptions",
      "organizations_url": "https://api.github.com/users/rakita/orgs",
      "repos_url": "https://api.github.com/users/rakita/repos",
      "events_url": "https://api.github.com/users/rakita/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rakita/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-06-10T08:16:28Z",
    "updated_at": "2022-06-10T08:16:28Z",
    "author_association": "CONTRIBUTOR",
    "body": "@mattsse makes sense to leave the default value. It will not disrupt anything in evm as `commit` is postprocessing.\r\nThis is needed for both `storage` and `cache` (accounts)\r\n@bernard-wagner Thank you, Sir",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1152099921/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1172141254",
    "html_url": "https://github.com/foundry-rs/foundry/issues/1894#issuecomment-1172141254",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/1894",
    "id": 1172141254,
    "node_id": "IC_kwDOGBlvNc5F3XTG",
    "user": {
      "login": "rakita",
      "id": 13179220,
      "node_id": "MDQ6VXNlcjEzMTc5MjIw",
      "avatar_url": "https://avatars.githubusercontent.com/u/13179220?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rakita",
      "html_url": "https://github.com/rakita",
      "followers_url": "https://api.github.com/users/rakita/followers",
      "following_url": "https://api.github.com/users/rakita/following{/other_user}",
      "gists_url": "https://api.github.com/users/rakita/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rakita/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rakita/subscriptions",
      "organizations_url": "https://api.github.com/users/rakita/orgs",
      "repos_url": "https://api.github.com/users/rakita/repos",
      "events_url": "https://api.github.com/users/rakita/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rakita/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-01T09:29:15Z",
    "updated_at": "2022-07-01T09:29:15Z",
    "author_association": "CONTRIBUTOR",
    "body": "Here change in revm CacheDB, it is now aware if account was cleared(deleted) or not and storage will be removed if needed, https://github.com/bluealloy/revm/pull/140",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1172141254/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 1,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
