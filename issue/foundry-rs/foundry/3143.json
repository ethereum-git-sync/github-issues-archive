{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/3143",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3143/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3143/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3143/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/3143",
  "id": 1367341482,
  "node_id": "I_kwDOGBlvNc5Rf_mq",
  "number": 3143,
  "title": "`cast run` fails for some txs using `CREATE2`",
  "user": {
    "login": "minaminao",
    "id": 20497787,
    "node_id": "MDQ6VXNlcjIwNDk3Nzg3",
    "avatar_url": "https://avatars.githubusercontent.com/u/20497787?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/minaminao",
    "html_url": "https://github.com/minaminao",
    "followers_url": "https://api.github.com/users/minaminao/followers",
    "following_url": "https://api.github.com/users/minaminao/following{/other_user}",
    "gists_url": "https://api.github.com/users/minaminao/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/minaminao/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/minaminao/subscriptions",
    "organizations_url": "https://api.github.com/users/minaminao/orgs",
    "repos_url": "https://api.github.com/users/minaminao/repos",
    "events_url": "https://api.github.com/users/minaminao/events{/privacy}",
    "received_events_url": "https://api.github.com/users/minaminao/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3334394228,
      "node_id": "MDU6TGFiZWwzMzM0Mzk0MjI4",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-bug",
      "name": "T-bug",
      "color": "d73a4a",
      "default": false,
      "description": "Type: bug"
    },
    {
      "id": 3703752609,
      "node_id": "LA_kwDOGBlvNc7cwseh",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/C-cast",
      "name": "C-cast",
      "color": "5319E7",
      "default": false,
      "description": "Command: cast"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "mattsse",
    "id": 19890894,
    "node_id": "MDQ6VXNlcjE5ODkwODk0",
    "avatar_url": "https://avatars.githubusercontent.com/u/19890894?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mattsse",
    "html_url": "https://github.com/mattsse",
    "followers_url": "https://api.github.com/users/mattsse/followers",
    "following_url": "https://api.github.com/users/mattsse/following{/other_user}",
    "gists_url": "https://api.github.com/users/mattsse/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mattsse/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mattsse/subscriptions",
    "organizations_url": "https://api.github.com/users/mattsse/orgs",
    "repos_url": "https://api.github.com/users/mattsse/repos",
    "events_url": "https://api.github.com/users/mattsse/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mattsse/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "mattsse",
      "id": 19890894,
      "node_id": "MDQ6VXNlcjE5ODkwODk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/19890894?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mattsse",
      "html_url": "https://github.com/mattsse",
      "followers_url": "https://api.github.com/users/mattsse/followers",
      "following_url": "https://api.github.com/users/mattsse/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattsse/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mattsse/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattsse/subscriptions",
      "organizations_url": "https://api.github.com/users/mattsse/orgs",
      "repos_url": "https://api.github.com/users/mattsse/repos",
      "events_url": "https://api.github.com/users/mattsse/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mattsse/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2022-09-09T06:19:01Z",
  "updated_at": "2022-09-09T18:06:14Z",
  "closed_at": "2022-09-09T18:06:14Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "### Component\r\n\r\nCast\r\n\r\n### Have you ensured that all of these are up to date?\r\n\r\n- [X] Foundry\r\n- [ ] Foundryup\r\n\r\n### What version of Foundry are you on?\r\n\r\nforge 0.2.0 (f540aa9 2022-09-09T00:09:51.262286Z)\r\n\r\n### What command(s) is the bug in?\r\n\r\ncast run\r\n\r\n### Operating System\r\n\r\n_No response_\r\n\r\n### Describe the bug\r\n\r\nCode:\r\n```solidity\r\npragma solidity ^0.8.13;\r\n\r\nimport \"forge-std/Script.sol\";\r\n\r\ncontract D {\r\n    uint256 public blockNumber;\r\n\r\n    constructor() {\r\n        blockNumber = block.number;\r\n    }\r\n\r\n    function destruct() public {\r\n        selfdestruct(payable(0));\r\n    }\r\n}\r\n\r\ncontract Create2Script is Script {\r\n    function run() public {\r\n        vm.startBroadcast();\r\n        new Deployer().deploy();\r\n        vm.stopBroadcast();\r\n    }\r\n\r\n    function run2(address deployerAddress) public {\r\n        vm.startBroadcast();\r\n        Deployer(deployerAddress).destruct();\r\n        vm.stopBroadcast();\r\n    }\r\n\r\n    function run3(address deployerAddress) public {\r\n        vm.startBroadcast();\r\n        Deployer(deployerAddress).deploy();\r\n        vm.stopBroadcast();\r\n    }\r\n}\r\n\r\ncontract Deployer {\r\n    D d;\r\n\r\n    function deploy() public {\r\n        d = new D{salt: \"A\"}();\r\n    }\r\n\r\n    function destruct() public {\r\n        d.destruct();\r\n    }\r\n}\r\n```\r\n\r\nI executed the following commands in the Goerli network.\r\n```sh\r\nforge script Create2Script --broadcast --private-key $PRIVATE_KEY\r\nforge script Create2Script --sig \"run2(address)\" 0x74d95845ba4b44dcb0f399ea55c405d8f94131ed --broadcast --private-key $PRIVATE_KEY\r\nforge script Create2Script --sig \"run3(address)\" 0x74d95845ba4b44dcb0f399ea55c405d8f94131ed --broadcast --private-key $PRIVATE_KEY\r\n```\r\n\r\nFail case (`deploy` in `run`):\r\n```sh\r\n$ cast run 0xc2d97bb0bf727b63bcfe9b5440f506ea2a49225b2408358a5aeef70883a40cbf -v\r\nExecuting previous transactions from the block.\r\n⠁ [00:00:00] [----------------------------------------------------------------------------------------------------------------------------] 0/11 tx (0.0s)The application panicked (crashed).\r\nMessage:  called `Result::unwrap()` on an `Err` value: Execution { reverted: true, reason: \"Deployment succeeded, but no address was returned. This is a bug, please report it\", gas_used: 28892, gas_refunded: 0, stipend: 0, logs: [], traces: None, debug: None, labels: {}, transactions: None, state_changeset: None, script_wallets: [] }\r\nLocation: cli/src/cmd/cast/run.rs:132\r\n```\r\n\r\nSuccess case (`deploy` in `run3`):\r\n```sh\r\n$ cast run 0xd58118cf2620e3927bde6c56d2d86679083b470928dc8fe17c7ac35302aab49a -v\r\nExecuting previous transactions from the block.\r\nTraces:\r\n  [85397] 0x74d95845ba4b44dcb0f399ea55c405d8f94131ed::deploy() \r\n    ├─ [50786] → new <Unknown>@\"0xf3c25b1063a9fbf363c220e4646a4c0334f0b9a1\"\r\n    │   └─ ← 143 bytes of code\r\n    └─ ← ()\r\n\r\n\r\nTransaction successfully executed.\r\nGas used: 106461\r\n```\r\n\r\nEtherscan: https://goerli.etherscan.io/address/0xf3c25b1063a9fbf363c220e4646a4c0334f0b9a1#internaltx\r\n\r\nIt seems that the problem is that the `deployer` executes `CREATE2` on the same block where the `deployer` is created.\r\nI have not checked if the same problem occurs when `CREATE` is used.",
  "closed_by": {
    "login": "mattsse",
    "id": 19890894,
    "node_id": "MDQ6VXNlcjE5ODkwODk0",
    "avatar_url": "https://avatars.githubusercontent.com/u/19890894?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mattsse",
    "html_url": "https://github.com/mattsse",
    "followers_url": "https://api.github.com/users/mattsse/followers",
    "following_url": "https://api.github.com/users/mattsse/following{/other_user}",
    "gists_url": "https://api.github.com/users/mattsse/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mattsse/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mattsse/subscriptions",
    "organizations_url": "https://api.github.com/users/mattsse/orgs",
    "repos_url": "https://api.github.com/users/mattsse/repos",
    "events_url": "https://api.github.com/users/mattsse/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mattsse/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/3143/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3143/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1242092929",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3143#issuecomment-1242092929",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3143",
    "id": 1242092929,
    "node_id": "IC_kwDOGBlvNc5KCNWB",
    "user": {
      "login": "mattsse",
      "id": 19890894,
      "node_id": "MDQ6VXNlcjE5ODkwODk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/19890894?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mattsse",
      "html_url": "https://github.com/mattsse",
      "followers_url": "https://api.github.com/users/mattsse/followers",
      "following_url": "https://api.github.com/users/mattsse/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattsse/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mattsse/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattsse/subscriptions",
      "organizations_url": "https://api.github.com/users/mattsse/orgs",
      "repos_url": "https://api.github.com/users/mattsse/repos",
      "events_url": "https://api.github.com/users/mattsse/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mattsse/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-09T15:06:39Z",
    "updated_at": "2022-09-09T15:06:39Z",
    "author_association": "MEMBER",
    "body": "> It seems that the problem is that the deployer executes CREATE2 on the same block where the deployer is created.\r\nI have not checked if the same problem occurs when CREATE is used.\r\n\r\nty this is useful.\r\n\r\nchecking",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1242092929/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
