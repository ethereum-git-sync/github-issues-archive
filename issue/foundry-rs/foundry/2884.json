{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/2884",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/2884/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/2884/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/2884/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/2884",
  "id": 1346770207,
  "node_id": "I_kwDOGBlvNc5QRhUf",
  "number": 2884,
  "title": "Can't run multiple `forge script` in parallel",
  "user": {
    "login": "adhusson",
    "id": 2977,
    "node_id": "MDQ6VXNlcjI5Nzc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2977?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/adhusson",
    "html_url": "https://github.com/adhusson",
    "followers_url": "https://api.github.com/users/adhusson/followers",
    "following_url": "https://api.github.com/users/adhusson/following{/other_user}",
    "gists_url": "https://api.github.com/users/adhusson/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/adhusson/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/adhusson/subscriptions",
    "organizations_url": "https://api.github.com/users/adhusson/orgs",
    "repos_url": "https://api.github.com/users/adhusson/repos",
    "events_url": "https://api.github.com/users/adhusson/events{/privacy}",
    "received_events_url": "https://api.github.com/users/adhusson/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3334394228,
      "node_id": "MDU6TGFiZWwzMzM0Mzk0MjI4",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-bug",
      "name": "T-bug",
      "color": "d73a4a",
      "default": false,
      "description": "Type: bug"
    },
    {
      "id": 3703752787,
      "node_id": "LA_kwDOGBlvNc7cwshT",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/C-forge",
      "name": "C-forge",
      "color": "5319E7",
      "default": false,
      "description": "Command: forge"
    },
    {
      "id": 4182991461,
      "node_id": "LA_kwDOGBlvNc75U2Jl",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/Cmd-forge-script",
      "name": "Cmd-forge-script",
      "color": "006B75",
      "default": false,
      "description": "Command: forge script"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 6,
  "created_at": "2022-08-22T17:40:05Z",
  "updated_at": "2023-04-18T11:46:35Z",
  "closed_at": null,
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "### Component\n\nForge\n\n### Have you ensured that all of these are up to date?\n\n- [X] Foundry\n- [X] Foundryup\n\n### What version of Foundry are you on?\n\nforge 0.2.0 (7e9e6a5 2022-08-22T00:05:42.088216Z)\n\n### What command(s) is the bug in?\n\nforge script\n\n### Operating System\n\nmacOS (Apple Silicon)\n\n### Describe the bug\n\nWhen running tests in parallel against multiple instances of `anvil`, I start multiple `forge script`s at once, and get `Could not open compiler cache` on some of them.\r\n\r\nIt seems reasonable to allow multiple runs in parallel, so maybe forge instances could 1) wait when the cache is locked, and 2) not lock until they know they have to write, that way they could all read a fresh cache in parallel.",
  "closed_by": {
    "login": "mds1",
    "id": 17163988,
    "node_id": "MDQ6VXNlcjE3MTYzOTg4",
    "avatar_url": "https://avatars.githubusercontent.com/u/17163988?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mds1",
    "html_url": "https://github.com/mds1",
    "followers_url": "https://api.github.com/users/mds1/followers",
    "following_url": "https://api.github.com/users/mds1/following{/other_user}",
    "gists_url": "https://api.github.com/users/mds1/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mds1/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mds1/subscriptions",
    "organizations_url": "https://api.github.com/users/mds1/orgs",
    "repos_url": "https://api.github.com/users/mds1/repos",
    "events_url": "https://api.github.com/users/mds1/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mds1/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/2884/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/2884/timeline",
  "performed_via_github_app": null,
  "state_reason": "reopened"
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1223111027",
    "html_url": "https://github.com/foundry-rs/foundry/issues/2884#issuecomment-1223111027",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/2884",
    "id": 1223111027,
    "node_id": "IC_kwDOGBlvNc5I5zFz",
    "user": {
      "login": "joshieDo",
      "id": 93316087,
      "node_id": "U_kgDOBY_j9w",
      "avatar_url": "https://avatars.githubusercontent.com/u/93316087?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/joshieDo",
      "html_url": "https://github.com/joshieDo",
      "followers_url": "https://api.github.com/users/joshieDo/followers",
      "following_url": "https://api.github.com/users/joshieDo/following{/other_user}",
      "gists_url": "https://api.github.com/users/joshieDo/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/joshieDo/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/joshieDo/subscriptions",
      "organizations_url": "https://api.github.com/users/joshieDo/orgs",
      "repos_url": "https://api.github.com/users/joshieDo/repos",
      "events_url": "https://api.github.com/users/joshieDo/events{/privacy}",
      "received_events_url": "https://api.github.com/users/joshieDo/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-22T21:34:55Z",
    "updated_at": "2022-08-22T21:37:16Z",
    "author_association": "COLLABORATOR",
    "body": "Even if that would be fixed, I'm not sure it would be okay to run them in parallel if you're using them with `--broadcast` on the same chain. The way I see it, for this to work:\r\n* Either 1) or 2).\r\n* If `--broadcast` is passed, lock the chain: eg. `broadcast/1337/.lock` and only let go, when every transaction has been sent or the user forces it with a dialog\r\n\r\nwhat is your usecase?",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1223111027/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1223206074",
    "html_url": "https://github.com/foundry-rs/foundry/issues/2884#issuecomment-1223206074",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/2884",
    "id": 1223206074,
    "node_id": "IC_kwDOGBlvNc5I6KS6",
    "user": {
      "login": "adhusson",
      "id": 2977,
      "node_id": "MDQ6VXNlcjI5Nzc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2977?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/adhusson",
      "html_url": "https://github.com/adhusson",
      "followers_url": "https://api.github.com/users/adhusson/followers",
      "following_url": "https://api.github.com/users/adhusson/following{/other_user}",
      "gists_url": "https://api.github.com/users/adhusson/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/adhusson/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/adhusson/subscriptions",
      "organizations_url": "https://api.github.com/users/adhusson/orgs",
      "repos_url": "https://api.github.com/users/adhusson/repos",
      "events_url": "https://api.github.com/users/adhusson/events{/privacy}",
      "received_events_url": "https://api.github.com/users/adhusson/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-22T22:12:04Z",
    "updated_at": "2022-08-22T23:38:04Z",
    "author_association": "CONTRIBUTOR",
    "body": "Yup, I'm not running broadcast on the same chain! Talking to multiple anvil instances at the same time (running tests in parallel).\r\n\r\nedit: to expand on your comment: shouldn't it be both 1) and 2)? If just 1), then you have unnecessary waiting. If just 2), then you have failures whenever a lock is on. Also, about the `.lock` file, this would definitely be helpful for multiple senders going to the same chain (and should probably be implemented?) but is I think not related to my issue.",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1223206074/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1504166880",
    "html_url": "https://github.com/foundry-rs/foundry/issues/2884#issuecomment-1504166880",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/2884",
    "id": 1504166880,
    "node_id": "IC_kwDOGBlvNc5Zp8Pg",
    "user": {
      "login": "mds1",
      "id": 17163988,
      "node_id": "MDQ6VXNlcjE3MTYzOTg4",
      "avatar_url": "https://avatars.githubusercontent.com/u/17163988?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mds1",
      "html_url": "https://github.com/mds1",
      "followers_url": "https://api.github.com/users/mds1/followers",
      "following_url": "https://api.github.com/users/mds1/following{/other_user}",
      "gists_url": "https://api.github.com/users/mds1/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mds1/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mds1/subscriptions",
      "organizations_url": "https://api.github.com/users/mds1/orgs",
      "repos_url": "https://api.github.com/users/mds1/repos",
      "events_url": "https://api.github.com/users/mds1/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mds1/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-11T21:58:34Z",
    "updated_at": "2023-04-11T21:58:34Z",
    "author_association": "COLLABORATOR",
    "body": "@adhusson Is this still an issue? I think I was just able to get two scripts running (seemingly) in parallel, as I did not get the `Could not open compiler cache` error. Closing this optimistically, we can reopen if needed though",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1504166880/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1504742444",
    "html_url": "https://github.com/foundry-rs/foundry/issues/2884#issuecomment-1504742444",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/2884",
    "id": 1504742444,
    "node_id": "IC_kwDOGBlvNc5ZsIws",
    "user": {
      "login": "lnist",
      "id": 16150076,
      "node_id": "MDQ6VXNlcjE2MTUwMDc2",
      "avatar_url": "https://avatars.githubusercontent.com/u/16150076?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/lnist",
      "html_url": "https://github.com/lnist",
      "followers_url": "https://api.github.com/users/lnist/followers",
      "following_url": "https://api.github.com/users/lnist/following{/other_user}",
      "gists_url": "https://api.github.com/users/lnist/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/lnist/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/lnist/subscriptions",
      "organizations_url": "https://api.github.com/users/lnist/orgs",
      "repos_url": "https://api.github.com/users/lnist/repos",
      "events_url": "https://api.github.com/users/lnist/events{/privacy}",
      "received_events_url": "https://api.github.com/users/lnist/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-12T06:37:57Z",
    "updated_at": "2023-04-12T06:39:03Z",
    "author_association": "NONE",
    "body": "@mds1 : I've just done foundryup, but I still have the issue. Starting the following in 7 parallel processes gives the `Could not open compiler cache` error:\r\n```\r\nforge script     --rpc-url http://127.0.0.1:8545     --froms 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266     --private-key 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80     --broadcast -vvv     --root /my/foundry/code          MyFoundryScript\r\n```\r\n\r\nThe port number of course differs in each process.\r\n\r\nFoundry up:\r\n```\r\nfoundryup: installed - forge 0.2.0 (388c3c0 2023-04-12T00:10:28.965283288Z)\r\nfoundryup: installed - cast 0.2.0 (388c3c0 2023-04-12T00:10:28.965283288Z)\r\nfoundryup: installed - anvil 0.1.0 (388c3c0 2023-04-12T00:10:59.673375678Z)\r\nfoundryup: installed - chisel 0.1.1 (388c3c0 2023-04-12T00:10:59.667448854Z)\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1504742444/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1505296909",
    "html_url": "https://github.com/foundry-rs/foundry/issues/2884#issuecomment-1505296909",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/2884",
    "id": 1505296909,
    "node_id": "IC_kwDOGBlvNc5ZuQIN",
    "user": {
      "login": "lnist",
      "id": 16150076,
      "node_id": "MDQ6VXNlcjE2MTUwMDc2",
      "avatar_url": "https://avatars.githubusercontent.com/u/16150076?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/lnist",
      "html_url": "https://github.com/lnist",
      "followers_url": "https://api.github.com/users/lnist/followers",
      "following_url": "https://api.github.com/users/lnist/following{/other_user}",
      "gists_url": "https://api.github.com/users/lnist/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/lnist/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/lnist/subscriptions",
      "organizations_url": "https://api.github.com/users/lnist/orgs",
      "repos_url": "https://api.github.com/users/lnist/repos",
      "events_url": "https://api.github.com/users/lnist/events{/privacy}",
      "received_events_url": "https://api.github.com/users/lnist/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-12T13:38:47Z",
    "updated_at": "2023-04-12T13:38:47Z",
    "author_association": "NONE",
    "body": "Note: After playing around to make a smaller example it turns out that forge script is not enough to make it fail - but prefixing it with anvil_setCode cheatcode is, so here is a repro with the `forge init` setup:\r\n\r\n```\r\nBYTECODE=$(forge inspect Counter deployedBytecode)\r\n\r\nanvil --host 127.0.0.1 --port 8543 &\r\nanvil --host 127.0.0.1 --port 8544 &\r\nanvil --host 127.0.0.1 --port 8545 &\r\nanvil --host 127.0.0.1 --port 8546 &\r\nanvil --host 127.0.0.1 --port 8547 &\r\nanvil --host 127.0.0.1 --port 8548 &\r\nanvil --host 127.0.0.1 --port 8549 &\r\n\r\n# Wait a bit\r\n\r\ncast rpc anvil_setCode  --rpc-url http://127.0.0.1:8543 0xdecaf00000000000000000000000000000000000 $BYTECODE && forge script --rpc-url http://127.0.0.1:8543 --froms 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266 --private-key 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80 --broadcast -vvv CounterScript &\r\ncast rpc anvil_setCode  --rpc-url http://127.0.0.1:8544 0xdecaf00000000000000000000000000000000000 $BYTECODE && forge script --rpc-url http://127.0.0.1:8544 --froms 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266 --private-key 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80 --broadcast -vvv CounterScript &\r\ncast rpc anvil_setCode  --rpc-url http://127.0.0.1:8545 0xdecaf00000000000000000000000000000000000 $BYTECODE && forge script --rpc-url http://127.0.0.1:8545 --froms 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266 --private-key 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80 --broadcast -vvv CounterScript &\r\ncast rpc anvil_setCode  --rpc-url http://127.0.0.1:8546 0xdecaf00000000000000000000000000000000000 $BYTECODE && forge script --rpc-url http://127.0.0.1:8546 --froms 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266 --private-key 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80 --broadcast -vvv CounterScript &\r\ncast rpc anvil_setCode  --rpc-url http://127.0.0.1:8547 0xdecaf00000000000000000000000000000000000 $BYTECODE && forge script --rpc-url http://127.0.0.1:8547 --froms 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266 --private-key 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80 --broadcast -vvv CounterScript &\r\ncast rpc anvil_setCode  --rpc-url http://127.0.0.1:8548 0xdecaf00000000000000000000000000000000000 $BYTECODE && forge script --rpc-url http://127.0.0.1:8548 --froms 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266 --private-key 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80 --broadcast -vvv CounterScript &\r\ncast rpc anvil_setCode  --rpc-url http://127.0.0.1:8549 0xdecaf00000000000000000000000000000000000 $BYTECODE && forge script --rpc-url http://127.0.0.1:8549 --froms 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266 --private-key 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80 --broadcast -vvv CounterScript &\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1505296909/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1512939402",
    "html_url": "https://github.com/foundry-rs/foundry/issues/2884#issuecomment-1512939402",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/2884",
    "id": 1512939402,
    "node_id": "IC_kwDOGBlvNc5aLZ-K",
    "user": {
      "login": "mds1",
      "id": 17163988,
      "node_id": "MDQ6VXNlcjE3MTYzOTg4",
      "avatar_url": "https://avatars.githubusercontent.com/u/17163988?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mds1",
      "html_url": "https://github.com/mds1",
      "followers_url": "https://api.github.com/users/mds1/followers",
      "following_url": "https://api.github.com/users/mds1/following{/other_user}",
      "gists_url": "https://api.github.com/users/mds1/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mds1/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mds1/subscriptions",
      "organizations_url": "https://api.github.com/users/mds1/orgs",
      "repos_url": "https://api.github.com/users/mds1/repos",
      "events_url": "https://api.github.com/users/mds1/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mds1/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-18T11:46:35Z",
    "updated_at": "2023-04-18T11:46:35Z",
    "author_association": "COLLABORATOR",
    "body": "Thanks! I was able to reproduce this with the above steps",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1512939402/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
