{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/4903",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4903/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4903/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4903/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/4903",
  "id": 1700779389,
  "node_id": "I_kwDOGBlvNc5lX9V9",
  "number": 4903,
  "title": "Deploy to Optimism via script fails after incorrect gas estimation",
  "user": {
    "login": "spengrah",
    "id": 13247381,
    "node_id": "MDQ6VXNlcjEzMjQ3Mzgx",
    "avatar_url": "https://avatars.githubusercontent.com/u/13247381?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/spengrah",
    "html_url": "https://github.com/spengrah",
    "followers_url": "https://api.github.com/users/spengrah/followers",
    "following_url": "https://api.github.com/users/spengrah/following{/other_user}",
    "gists_url": "https://api.github.com/users/spengrah/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/spengrah/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/spengrah/subscriptions",
    "organizations_url": "https://api.github.com/users/spengrah/orgs",
    "repos_url": "https://api.github.com/users/spengrah/repos",
    "events_url": "https://api.github.com/users/spengrah/events{/privacy}",
    "received_events_url": "https://api.github.com/users/spengrah/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3334394228,
      "node_id": "MDU6TGFiZWwzMzM0Mzk0MjI4",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-bug",
      "name": "T-bug",
      "color": "d73a4a",
      "default": false,
      "description": "Type: bug"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2023-05-08T19:09:30Z",
  "updated_at": "2023-06-22T09:32:14Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Component\n\nForge\n\n### Have you ensured that all of these are up to date?\n\n- [X] Foundry\n- [X] Foundryup\n\n### What version of Foundry are you on?\n\nforge 0.2.0 (8adf428 2023-05-08T00:04:45.691256000Z)\n\n### What command(s) is the bug in?\n\nforge script script/MyScript.s.sol -f optimism --broadcast --verify\n\n### Operating System\n\nmacOS (Apple Silicon)\n\n### Describe the bug\n\nI have a script that deploys an implementation contract and a clone factory. I'm currently attempting to run the script to deploy to Optimism. Simulation run works just fine, but when broadcasting I end up with a `code -32000 [...] insufficient funds for gas * price + value` error.\r\n\r\nI have confirmed that all my wallet and rpc configs are correct (I'm able to broadcast a simple eth transfer on optimism, for example).\r\n\r\nAs you can see in the screenshot below, the deployer balance exceeds the estimated amount required value, but the broadcast is still failing. It appears that the cost estimation is way too low, likely because **it excludes the L1 gas component that is part of an L2 transaction**.\r\n\r\n<img width=\"1076\" alt=\"image\" src=\"https://user-images.githubusercontent.com/13247381/236910952-4b13efe0-466a-42e9-8892-c2ed79c0908c.png\">\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/4903/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4903/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1540018349",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4903#issuecomment-1540018349",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4903",
    "id": 1540018349,
    "node_id": "IC_kwDOGBlvNc5bytCt",
    "user": {
      "login": "backseats",
      "id": 87050725,
      "node_id": "MDQ6VXNlcjg3MDUwNzI1",
      "avatar_url": "https://avatars.githubusercontent.com/u/87050725?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/backseats",
      "html_url": "https://github.com/backseats",
      "followers_url": "https://api.github.com/users/backseats/followers",
      "following_url": "https://api.github.com/users/backseats/following{/other_user}",
      "gists_url": "https://api.github.com/users/backseats/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/backseats/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/backseats/subscriptions",
      "organizations_url": "https://api.github.com/users/backseats/orgs",
      "repos_url": "https://api.github.com/users/backseats/repos",
      "events_url": "https://api.github.com/users/backseats/events{/privacy}",
      "received_events_url": "https://api.github.com/users/backseats/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-09T12:07:23Z",
    "updated_at": "2023-05-09T12:08:38Z",
    "author_association": "NONE",
    "body": "I am experiencing something similar, deploying to mainnet. Wallet has triple the ETH in it relative to the estimate\r\n\r\n`forge 0.2.0 (43974b0 2023-05-09T00:17:51.920839000Z)`\r\n\r\nCommand: `forge script script/MultiMerkleMinterV1.s.sol:MultiMerkleMinterV1Script --rpc-url $MAINNET_RPC_URL --chain-id 1 --private-key $MAINNET_PRIVATE_KEY --broadcast --verify -vvvv`\r\n\r\nmacOS (Apple Silicon)\r\n\r\n```\r\n$ forge script script/MultiMerkleMinterV1.s.sol:MultiMerkleMinterV1Script --rpc-url $MAINNET_RPC_URL --chain-id 1 --private-key $MAINNET_PRIVATE_KEY --broadcast --verify -vvvv\r\n[⠰] Compiling...\r\nNo files changed, compilation skipped\r\nTraces:\r\n  [2296694] MultiMerkleMinterV1Script::run() \r\n    ├─ [0] VM::envUint(PRIVATE_KEY) [staticcall]\r\n    │   └─ ← <env var value>\r\n    ├─ [0] VM::startBroadcast(<pk>) \r\n    │   └─ ← ()\r\n    ├─ [2237130] → new MultiMerkleMinterV1@0x3B718a2272216343c4E63809276317E8295e453B\r\n    │   ├─ [8087] GenArt721CoreV3_Engine::getPrimaryRevenueSplits(0, 0) \r\n    │   │   └─ ← 0, 0xE7bEB4Af9Da9b567778278F863Ed475212589526, 0, 0xFdc45dae01d1F9EF394b33c227BA9489795d148B, 0, 0x0000000000000000000000000000000000000000, 0, 0x0000000000000000000000000000000000000000\r\n    │   ├─ [326] MinterFilterV1::genArt721CoreAddress() \r\n    │   │   └─ ← GenArt721CoreV3_Engine: [0x6DdefE5DB20D79EC718A8960177bEB388f7EbB8d]\r\n    │   └─ ← 10987 bytes of code\r\n    ├─ [0] VM::stopBroadcast() \r\n    │   └─ ← ()\r\n    └─ ← ()\r\n\r\n\r\nScript ran successfully.\r\n\r\n## Setting up (1) EVMs.\r\n==========================\r\nSimulated On-chain Traces:\r\n\r\n  [2471622] → new MultiMerkleMinterV1@0x3B718a2272216343c4E63809276317E8295e453B\r\n    ├─ [8087] GenArt721CoreV3_Engine::getPrimaryRevenueSplits(0, 0) \r\n    │   └─ ← 0, 0xE7bEB4Af9Da9b567778278F863Ed475212589526, 0, 0xFdc45dae01d1F9EF394b33c227BA9489795d148B, 0, 0x0000000000000000000000000000000000000000, 0, 0x0000000000000000000000000000000000000000\r\n    ├─ [326] MinterFilterV1::genArt721CoreAddress() \r\n    │   └─ ← GenArt721CoreV3_Engine: [0x6DdefE5DB20D79EC718A8960177bEB388f7EbB8d]\r\n    └─ ← 10987 bytes of code\r\n\r\n\r\n==========================\r\n\r\nChain 1\r\n\r\nEstimated gas price: 139.159975345 gwei\r\n\r\nEstimated total gas used for script: 3213108\r\n\r\nEstimated amount required: 0.44713603006082226 ETH\r\n\r\n==========================\r\n\r\n###\r\nFinding wallets for all the necessary addresses...\r\n##\r\nSending transactions [0 - 0].\r\n\r\nTransactions saved to: /Users/backseats/tender/broadcast/MultiMerkleMinterV1.s.sol/1/run-latest.json\r\n\r\nError: \r\n(code: -32000, message: insufficient funds for gas * price + value, data: None)\r\n```\r\n\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1540018349/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1602317884",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4903#issuecomment-1602317884",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4903",
    "id": 1602317884,
    "node_id": "IC_kwDOGBlvNc5fgW48",
    "user": {
      "login": "simplyoptimistic",
      "id": 111120814,
      "node_id": "U_kgDOBp-Rrg",
      "avatar_url": "https://avatars.githubusercontent.com/u/111120814?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/simplyoptimistic",
      "html_url": "https://github.com/simplyoptimistic",
      "followers_url": "https://api.github.com/users/simplyoptimistic/followers",
      "following_url": "https://api.github.com/users/simplyoptimistic/following{/other_user}",
      "gists_url": "https://api.github.com/users/simplyoptimistic/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/simplyoptimistic/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/simplyoptimistic/subscriptions",
      "organizations_url": "https://api.github.com/users/simplyoptimistic/orgs",
      "repos_url": "https://api.github.com/users/simplyoptimistic/repos",
      "events_url": "https://api.github.com/users/simplyoptimistic/events{/privacy}",
      "received_events_url": "https://api.github.com/users/simplyoptimistic/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-06-22T09:32:14Z",
    "updated_at": "2023-06-22T09:32:14Z",
    "author_association": "NONE",
    "body": "> it excludes the L1 gas component that is part of an L2 transaction.\r\n\r\nI also had this issue. Given that the majority of the gas consumed by a L2 transaction on Optimism (at this stage) is in the L1 gas component, the gas estimation functionality is fairly useless on Optimism. \r\n\r\nI have also noticed that it overestimates the gas price unless you use --legacy (perhaps related to this issue https://github.com/foundry-rs/foundry/issues/4547).\r\n\r\nOptimism has described [here](https://community.optimism.io/docs/developers/build/transaction-fees/#the-l1-data-fee) how the L1 fee could be estimated, by reading from the gas oracle contract, so perhaps that could be a way foundry could address this issue. ",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1602317884/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
