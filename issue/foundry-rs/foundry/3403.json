{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/3403",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3403/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3403/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3403/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/3403",
  "id": 1389864697,
  "node_id": "I_kwDOGBlvNc5S16b5",
  "number": 3403,
  "title": "code: -32603, message: Remote node did not answer to eth_feeHistory correctly",
  "user": {
    "login": "aathan",
    "id": 24279435,
    "node_id": "MDQ6VXNlcjI0Mjc5NDM1",
    "avatar_url": "https://avatars.githubusercontent.com/u/24279435?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/aathan",
    "html_url": "https://github.com/aathan",
    "followers_url": "https://api.github.com/users/aathan/followers",
    "following_url": "https://api.github.com/users/aathan/following{/other_user}",
    "gists_url": "https://api.github.com/users/aathan/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/aathan/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/aathan/subscriptions",
    "organizations_url": "https://api.github.com/users/aathan/orgs",
    "repos_url": "https://api.github.com/users/aathan/repos",
    "events_url": "https://api.github.com/users/aathan/events{/privacy}",
    "received_events_url": "https://api.github.com/users/aathan/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3334394228,
      "node_id": "MDU6TGFiZWwzMzM0Mzk0MjI4",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-bug",
      "name": "T-bug",
      "color": "d73a4a",
      "default": false,
      "description": "Type: bug"
    },
    {
      "id": 3703752787,
      "node_id": "LA_kwDOGBlvNc7cwshT",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/C-forge",
      "name": "C-forge",
      "color": "5319E7",
      "default": false,
      "description": "Command: forge"
    },
    {
      "id": 4182991461,
      "node_id": "LA_kwDOGBlvNc75U2Jl",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/Cmd-forge-script",
      "name": "Cmd-forge-script",
      "color": "006B75",
      "default": false,
      "description": "Command: forge script"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2022-09-28T19:44:45Z",
  "updated_at": "2023-04-11T22:38:51Z",
  "closed_at": "2023-04-11T22:38:50Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "### Component\r\n\r\nForge\r\n\r\n### Have you ensured that all of these are up to date?\r\n\r\n- [X] Foundry\r\n- [X] Foundryup\r\n\r\n### What version of Foundry are you on?\r\n\r\nforge 0.2.0 (98fa895 2022-09-28T00:08:23.30706613Z)\r\n\r\n### What command(s) is the bug in?\r\n\r\nforge script ... --broadcast\r\n\r\n### Operating System\r\n\r\nLinux\r\n\r\n### Describe the bug\r\n\r\nEDIT: I've determined the primary error reported is not due to a formatting bug per-se, but forge's behavior may be problematic (see latest comments) because (1) it makes the eth_feeHistory request twice, formatting the parameters differently and (2) it does not report the second error, which is from a second attempt at the call, with apparently incorrectly formatted params. This possibly looks like there may be some fallback attempt by forge, to send the request using a different formatting scheme, because the first request failed???\r\n\r\nORIGINAL REPORT:\r\nThere appears to still be a bug (possibly related to the whole QUANTITY vs LOCATION parameter formatting thing at #1297?) attempting to deploy vs a hardhat instance. I assume that broadcasting via forge, to a hardhat node, should result in blockchain state that can be queried via cast after the deployment right? I'm not sure if the error results in the broadcast to be reverted or if the contract deployment never in fact happened...\r\n\r\n... happy to provide further output if you give me guidance.\r\n\r\n```\r\n$ npx hardhat --version\r\n2.11.2\r\n```\r\n\r\n```\r\n$ forge script script/Contract.s.sol:ContractScript --rpc-url http://0.0.0.0:8545/ --broadcast --verify -vvvv --etherscan-api-key 0\r\n[⠢] Compiling...\r\nNo files changed, compilation skipped\r\nTraces:\r\n  [3347138] ContractScript::run() \r\n...\r\n    ├─ [657385] → new XyzProxy@0x4c5859f0F772848b2D91F1D83E2Fe57935348029\r\n...\r\n\r\nScript ran successfully.\r\n==========================\r\nSimulated On-chain Traces:\r\n...\r\n\r\nError: \r\n(code: -32603, message: Remote node did not answer to eth_feeHistory correctly, data: Some(Object({\"message\": String(\"Remote node did not answer to eth_feeHistory correctly\")})))\r\n\r\n\r\n$ cast call 0x4c5859f0F772848b2D91F1D83E2Fe57935348029 'totalSupply()(uint256)' --rpc-url http://0.0.0.0:8545/\r\nError: \r\nContract 0x4c5859f0f772848b2d91f1d83e2fe57935348029 does not exist\r\n```",
  "closed_by": {
    "login": "mds1",
    "id": 17163988,
    "node_id": "MDQ6VXNlcjE3MTYzOTg4",
    "avatar_url": "https://avatars.githubusercontent.com/u/17163988?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mds1",
    "html_url": "https://github.com/mds1",
    "followers_url": "https://api.github.com/users/mds1/followers",
    "following_url": "https://api.github.com/users/mds1/following{/other_user}",
    "gists_url": "https://api.github.com/users/mds1/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mds1/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mds1/subscriptions",
    "organizations_url": "https://api.github.com/users/mds1/orgs",
    "repos_url": "https://api.github.com/users/mds1/repos",
    "events_url": "https://api.github.com/users/mds1/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mds1/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/3403/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3403/timeline",
  "performed_via_github_app": null,
  "state_reason": "not_planned"
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1261399459",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3403#issuecomment-1261399459",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3403",
    "id": 1261399459,
    "node_id": "IC_kwDOGBlvNc5LL22j",
    "user": {
      "login": "aathan",
      "id": 24279435,
      "node_id": "MDQ6VXNlcjI0Mjc5NDM1",
      "avatar_url": "https://avatars.githubusercontent.com/u/24279435?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/aathan",
      "html_url": "https://github.com/aathan",
      "followers_url": "https://api.github.com/users/aathan/followers",
      "following_url": "https://api.github.com/users/aathan/following{/other_user}",
      "gists_url": "https://api.github.com/users/aathan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/aathan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/aathan/subscriptions",
      "organizations_url": "https://api.github.com/users/aathan/orgs",
      "repos_url": "https://api.github.com/users/aathan/repos",
      "events_url": "https://api.github.com/users/aathan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/aathan/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-28T19:54:52Z",
    "updated_at": "2022-09-28T19:54:52Z",
    "author_association": "CONTRIBUTOR",
    "body": "The below conversation captured by tcpdump is from issuing: `forge script script/Contract.s.sol:ContractScript --rpc-url http://0.0.0.0:8545/ --broadcast`\r\n\r\nIt looks pretty strange to me because it looks like the eth_feeHistory call is attempted twice, with the parameter formatting changed during the second attempt ...\r\n\r\n```\r\n... prior POST of deployment transaction removed...\r\n\r\nPOST / HTTP/1.1\r\ncontent-type: application/json\r\naccept: */*\r\nhost: 0.0.0.0:8545\r\ncontent-length: 82\r\n\r\n{\"id\":3,\"jsonrpc\":\"2.0\",\"method\":\"eth_feeHistory\",\"params\":[\"0xa\",\"latest\",[5.0]]}\r\n19:45:59.009489 IP localhost.8545 > localhost.43066: Flags [.], ack 524, win 512, options [nop,nop,TS val 3884167419 ecr 3884167375], length 0\r\nE..4..@.@.A.........!a.:4*.O.........(.....\r\n........\r\n19:45:59.120697 IP localhost.8545 > localhost.43066: Flags [P.], seq 3006:3496, ack 524, win 512, options [nop,nop,TS val 3884167530 ecr 3884167375], length 490\r\nE.....@.@.?.........!a.:4*.O...............\r\n...j....HTTP/1.1 200 OK\r\nAccess-Control-Allow-Origin: *\r\nAccess-Control-Request-Method: *\r\nAccess-Control-Allow-Methods: OPTIONS, GET\r\nAccess-Control-Allow-Headers: *\r\nContent-Type: application/json\r\nDate: Wed, 28 Sep 2022 19:45:59 GMT\r\nConnection: keep-alive\r\nKeep-Alive: timeout=5\r\nContent-Length: 191\r\n\r\n{\"jsonrpc\":\"2.0\",\"id\":3,\"error\":{\"code\":-32603,\"message\":\"Remote node did not answer to eth_feeHistory correctly\",\"data\":{\"message\":\"Remote node did not answer to eth_feeHistory correctly\"}}}\r\n19:45:59.120974 IP localhost.43066 > localhost.8545: Flags [P.], seq 524:707, ack 3496, win 512, options [nop,nop,TS val 3884167530 ecr 3884167530], length 183\r\nE.....@.@..Z.........:!a....4*.9...........\r\n...j...jPOST / HTTP/1.1\r\ncontent-type: application/json\r\naccept: */*\r\nhost: 0.0.0.0:8545\r\ncontent-length: 79\r\n\r\n{\"id\":4,\"jsonrpc\":\"2.0\",\"method\":\"eth_feeHistory\",\"params\":[10,\"latest\",[5.0]]}\r\n19:45:59.120990 IP localhost.8545 > localhost.43066: Flags [.], ack 707, win 511, options [nop,nop,TS val 3884167530 ecr 3884167530], length 0\r\nE..4..@.@.A.........!a.:4*.9.........(.....\r\n...j...j\r\n19:45:59.122935 IP localhost.8545 > localhost.43066: Flags [P.], seq 3496:4018, ack 707, win 512, options [nop,nop,TS val 3884167532 ecr 3884167530], length 522\r\nE..>..@.@.?.........!a.:4*.9.........3.....\r\n...l...jHTTP/1.1 200 OK\r\nAccess-Control-Allow-Origin: *\r\nAccess-Control-Request-Method: *\r\nAccess-Control-Allow-Methods: OPTIONS, GET\r\nAccess-Control-Allow-Headers: *\r\nContent-Type: application/json\r\nDate: Wed, 28 Sep 2022 19:45:59 GMT\r\nConnection: keep-alive\r\nKeep-Alive: timeout=5\r\nContent-Length: 223\r\n\r\n{\"jsonrpc\":\"2.0\",\"id\":4,\"error\":{\"code\":-32602,\"message\":\"Errors encountered in param 0: Invalid value 10 supplied to : QUANTITY\",\"data\":{\"message\":\"Errors encountered in param 0: Invalid value 10 supplied to : QUANTITY\"}}}\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1261399459/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1261409244",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3403#issuecomment-1261409244",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3403",
    "id": 1261409244,
    "node_id": "IC_kwDOGBlvNc5LL5Pc",
    "user": {
      "login": "aathan",
      "id": 24279435,
      "node_id": "MDQ6VXNlcjI0Mjc5NDM1",
      "avatar_url": "https://avatars.githubusercontent.com/u/24279435?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/aathan",
      "html_url": "https://github.com/aathan",
      "followers_url": "https://api.github.com/users/aathan/followers",
      "following_url": "https://api.github.com/users/aathan/following{/other_user}",
      "gists_url": "https://api.github.com/users/aathan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/aathan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/aathan/subscriptions",
      "organizations_url": "https://api.github.com/users/aathan/orgs",
      "repos_url": "https://api.github.com/users/aathan/repos",
      "events_url": "https://api.github.com/users/aathan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/aathan/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-28T20:04:58Z",
    "updated_at": "2022-09-28T20:05:46Z",
    "author_association": "CONTRIBUTOR",
    "body": "\r\n```\r\n    hardhat: {\r\n      chainId: 43114,\r\n      gasPrice: 225000000000,\r\n      forking: {\r\n        url: \"https://api.avax.network/ext/bc/C/rpc\",\r\n        enabled: true,\r\n        //blockNumber: 99999...\r\n         ...\r\n```\r\n\r\nUpon further investigation it appears hardhat is reaching out to the configured upstream RPC provider, and this problem was due to the (now commented) \"blockNumber:\" directive. I guess the upstream RPC provider did not want to answer queries from that far back, or in any case, is the proximal cause of the error.\r\n\r\nI'm leaving this issue open due to the existence of two separate calls to eth_feeHistory (per above trace), each with different formatting, and the -32602 (second error) not having been reported by forge. Possibly this is expected behavior.",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1261409244/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1504217518",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3403#issuecomment-1504217518",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3403",
    "id": 1504217518,
    "node_id": "IC_kwDOGBlvNc5ZqImu",
    "user": {
      "login": "mds1",
      "id": 17163988,
      "node_id": "MDQ6VXNlcjE3MTYzOTg4",
      "avatar_url": "https://avatars.githubusercontent.com/u/17163988?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mds1",
      "html_url": "https://github.com/mds1",
      "followers_url": "https://api.github.com/users/mds1/followers",
      "following_url": "https://api.github.com/users/mds1/following{/other_user}",
      "gists_url": "https://api.github.com/users/mds1/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mds1/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mds1/subscriptions",
      "organizations_url": "https://api.github.com/users/mds1/orgs",
      "repos_url": "https://api.github.com/users/mds1/repos",
      "events_url": "https://api.github.com/users/mds1/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mds1/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-11T22:38:50Z",
    "updated_at": "2023-04-11T22:38:50Z",
    "author_association": "COLLABORATOR",
    "body": "Duplicate calls to `eth_feeHistory` seems expected so the script can fetch the latest data before each broadcast. And I vaguely remember that hardhat quantity but I think it should be fixed now? Going to close this, but we can reopen if there is still an issue here",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1504217518/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
