{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/3938",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3938/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3938/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3938/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/3938",
  "id": 1508233029,
  "node_id": "I_kwDOGBlvNc5Z5c9F",
  "number": 3938,
  "title": "Invariant testing is very slow on a particular setup",
  "user": {
    "login": "QGarchery",
    "id": 22668539,
    "node_id": "MDQ6VXNlcjIyNjY4NTM5",
    "avatar_url": "https://avatars.githubusercontent.com/u/22668539?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/QGarchery",
    "html_url": "https://github.com/QGarchery",
    "followers_url": "https://api.github.com/users/QGarchery/followers",
    "following_url": "https://api.github.com/users/QGarchery/following{/other_user}",
    "gists_url": "https://api.github.com/users/QGarchery/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/QGarchery/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/QGarchery/subscriptions",
    "organizations_url": "https://api.github.com/users/QGarchery/orgs",
    "repos_url": "https://api.github.com/users/QGarchery/repos",
    "events_url": "https://api.github.com/users/QGarchery/events{/privacy}",
    "received_events_url": "https://api.github.com/users/QGarchery/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3334394228,
      "node_id": "MDU6TGFiZWwzMzM0Mzk0MjI4",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-bug",
      "name": "T-bug",
      "color": "d73a4a",
      "default": false,
      "description": "Type: bug"
    },
    {
      "id": 3394554570,
      "node_id": "LA_kwDOGBlvNc7KVMrK",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/A-fuzzing",
      "name": "A-fuzzing",
      "color": "FBCA04",
      "default": false,
      "description": "Area: fuzzing"
    },
    {
      "id": 3703752787,
      "node_id": "LA_kwDOGBlvNc7cwshT",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/C-forge",
      "name": "C-forge",
      "color": "5319E7",
      "default": false,
      "description": "Command: forge"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2022-12-22T17:02:35Z",
  "updated_at": "2023-02-27T14:30:12Z",
  "closed_at": "2023-02-27T14:30:11Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Component\n\nForge\n\n### Have you ensured that all of these are up to date?\n\n- [X] Foundry\n- [X] Foundryup\n\n### What version of Foundry are you on?\n\nforge 0.2.0 (8c4294c 2022-12-22T00:03:55.083004205Z)\n\n### What command(s) is the bug in?\n\nforge test\n\n### Operating System\n\nLinux\n\n### Describe the bug\n\nInvariant testing seems to be abnormally slow on some setups. The following tests are made on [this repository](https://github.com/morpho-dao/morpho-data-structures). For future reference, the particular commit is [this one](https://github.com/morpho-dao/morpho-data-structures/commit/84f5cf38bddce046d7cfc95c51c96d3218ea1a5c).\r\n\r\nAfter importing the necessary dependencies with `yarn` a call to `forge test --match-test invariantHeap` does not terminate in reasonable time. When changing the `depth` in `foundry.toml` to be `2` instead of `64`, we get the following time to test:\r\n\r\n![invariant-testing](https://user-images.githubusercontent.com/22668539/209187176-c9e0c641-5623-47c7-b136-e70531fa2d22.png)\r\n\r\nI tested on other setups, Linux & macOs with the same forge version and it seems to be working fine there.\r\n",
  "closed_by": {
    "login": "mds1",
    "id": 17163988,
    "node_id": "MDQ6VXNlcjE3MTYzOTg4",
    "avatar_url": "https://avatars.githubusercontent.com/u/17163988?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mds1",
    "html_url": "https://github.com/mds1",
    "followers_url": "https://api.github.com/users/mds1/followers",
    "following_url": "https://api.github.com/users/mds1/following{/other_user}",
    "gists_url": "https://api.github.com/users/mds1/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mds1/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mds1/subscriptions",
    "organizations_url": "https://api.github.com/users/mds1/orgs",
    "repos_url": "https://api.github.com/users/mds1/repos",
    "events_url": "https://api.github.com/users/mds1/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mds1/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/3938/reactions",
    "total_count": 4,
    "+1": 4,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3938/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1371350658",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3938#issuecomment-1371350658",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3938",
    "id": 1371350658,
    "node_id": "IC_kwDOGBlvNc5RvSaC",
    "user": {
      "login": "rkrasiuk",
      "id": 25429261,
      "node_id": "MDQ6VXNlcjI1NDI5MjYx",
      "avatar_url": "https://avatars.githubusercontent.com/u/25429261?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rkrasiuk",
      "html_url": "https://github.com/rkrasiuk",
      "followers_url": "https://api.github.com/users/rkrasiuk/followers",
      "following_url": "https://api.github.com/users/rkrasiuk/following{/other_user}",
      "gists_url": "https://api.github.com/users/rkrasiuk/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rkrasiuk/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rkrasiuk/subscriptions",
      "organizations_url": "https://api.github.com/users/rkrasiuk/orgs",
      "repos_url": "https://api.github.com/users/rkrasiuk/repos",
      "events_url": "https://api.github.com/users/rkrasiuk/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rkrasiuk/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-01-04T19:50:09Z",
    "updated_at": "2023-01-04T19:50:09Z",
    "author_association": "COLLABORATOR",
    "body": "@joshieDo ptal",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1371350658/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1371800571",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3938#issuecomment-1371800571",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3938",
    "id": 1371800571,
    "node_id": "IC_kwDOGBlvNc5RxAP7",
    "user": {
      "login": "joshieDo",
      "id": 93316087,
      "node_id": "U_kgDOBY_j9w",
      "avatar_url": "https://avatars.githubusercontent.com/u/93316087?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/joshieDo",
      "html_url": "https://github.com/joshieDo",
      "followers_url": "https://api.github.com/users/joshieDo/followers",
      "following_url": "https://api.github.com/users/joshieDo/following{/other_user}",
      "gists_url": "https://api.github.com/users/joshieDo/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/joshieDo/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/joshieDo/subscriptions",
      "organizations_url": "https://api.github.com/users/joshieDo/orgs",
      "repos_url": "https://api.github.com/users/joshieDo/repos",
      "events_url": "https://api.github.com/users/joshieDo/events{/privacy}",
      "received_events_url": "https://api.github.com/users/joshieDo/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-01-05T05:33:37Z",
    "updated_at": "2023-01-05T05:35:10Z",
    "author_association": "COLLABORATOR",
    "body": "Could not reproduce it...\r\n@QGarchery  Can you run it with the command below for `depth` 2 and provide the logs? Probably going to be very verbose, but i want to see where is it spending most time...\r\n```RUST_LOG=info,trace forge test --match-test invariantHeap```",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1371800571/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1372213042",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3938#issuecomment-1372213042",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3938",
    "id": 1372213042,
    "node_id": "IC_kwDOGBlvNc5Ryk8y",
    "user": {
      "login": "QGarchery",
      "id": 22668539,
      "node_id": "MDQ6VXNlcjIyNjY4NTM5",
      "avatar_url": "https://avatars.githubusercontent.com/u/22668539?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/QGarchery",
      "html_url": "https://github.com/QGarchery",
      "followers_url": "https://api.github.com/users/QGarchery/followers",
      "following_url": "https://api.github.com/users/QGarchery/following{/other_user}",
      "gists_url": "https://api.github.com/users/QGarchery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/QGarchery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/QGarchery/subscriptions",
      "organizations_url": "https://api.github.com/users/QGarchery/orgs",
      "repos_url": "https://api.github.com/users/QGarchery/repos",
      "events_url": "https://api.github.com/users/QGarchery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/QGarchery/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-01-05T13:25:02Z",
    "updated_at": "2023-01-05T13:25:02Z",
    "author_association": "NONE",
    "body": "The resulting file is 127 MB large, so I put only the first 1000 lines here (`less -r log-head-1000.txt` gives a nice view):\r\n[log-head-1000.txt](https://github.com/foundry-rs/foundry/files/10352445/log-head-1000.txt)\r\n\r\nLooking at it, it seems like it's doing a lot of rpc calls. It probably shouldn't because we are testing a data-structure locally. I have a rpc setup globally on my machine, and this is probably why it's doing that. Indeed, after `unset FOUNDRY_ETH_RPC_URL`, the call finishes in 0.4s instead of 79s.\r\n\r\nWhy are those RPC calls made and is it possible to skip them ? If not, feel free to close this issue\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1372213042/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 1
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1446426189",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3938#issuecomment-1446426189",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3938",
    "id": 1446426189,
    "node_id": "IC_kwDOGBlvNc5WNrZN",
    "user": {
      "login": "mds1",
      "id": 17163988,
      "node_id": "MDQ6VXNlcjE3MTYzOTg4",
      "avatar_url": "https://avatars.githubusercontent.com/u/17163988?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mds1",
      "html_url": "https://github.com/mds1",
      "followers_url": "https://api.github.com/users/mds1/followers",
      "following_url": "https://api.github.com/users/mds1/following{/other_user}",
      "gists_url": "https://api.github.com/users/mds1/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mds1/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mds1/subscriptions",
      "organizations_url": "https://api.github.com/users/mds1/orgs",
      "repos_url": "https://api.github.com/users/mds1/repos",
      "events_url": "https://api.github.com/users/mds1/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mds1/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-02-27T14:30:11Z",
    "updated_at": "2023-02-27T14:30:11Z",
    "author_association": "COLLABORATOR",
    "body": "When [`FOUNDRY_ETH_RPC_URL`](https://book.getfoundry.sh/reference/config/testing#eth_rpc_url) is set, it tells forge to query the RPC to fetch a value if there is no local value (e.g. fork testing). So you cannot skip the RPC calls if that env var is set. My suggestion is to keep that unset, and use the [`vm.createSelectFork`](https://book.getfoundry.sh/forge/fork-testing#forking-cheatcodes) family of cheats within your test when you need fork tests",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1446426189/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
