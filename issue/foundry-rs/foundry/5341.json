{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/5341",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5341/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5341/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5341/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/5341",
  "id": 1795281633,
  "node_id": "I_kwDOGBlvNc5rAdLh",
  "number": 5341,
  "title": "anvil or revm does not respect --diable-gas-limit and seems to set an upper bound on env.block.gas_limit",
  "user": {
    "login": "aathan",
    "id": 24279435,
    "node_id": "MDQ6VXNlcjI0Mjc5NDM1",
    "avatar_url": "https://avatars.githubusercontent.com/u/24279435?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/aathan",
    "html_url": "https://github.com/aathan",
    "followers_url": "https://api.github.com/users/aathan/followers",
    "following_url": "https://api.github.com/users/aathan/following{/other_user}",
    "gists_url": "https://api.github.com/users/aathan/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/aathan/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/aathan/subscriptions",
    "organizations_url": "https://api.github.com/users/aathan/orgs",
    "repos_url": "https://api.github.com/users/aathan/repos",
    "events_url": "https://api.github.com/users/aathan/events{/privacy}",
    "received_events_url": "https://api.github.com/users/aathan/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3334394228,
      "node_id": "MDU6TGFiZWwzMzM0Mzk0MjI4",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-bug",
      "name": "T-bug",
      "color": "d73a4a",
      "default": false,
      "description": "Type: bug"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2023-07-09T07:38:53Z",
  "updated_at": "2023-07-12T06:35:13Z",
  "closed_at": null,
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "### Component\r\n\r\nAnvil\r\n\r\n### Have you ensured that all of these are up to date?\r\n\r\n- [X] Foundry\r\n- [X] Foundryup\r\n\r\n### What version of Foundry are you on?\r\n\r\nnightly-c78a811a8af95fb1e029427583a07b2ca3a3fa51\r\n\r\n### What command(s) is the bug in?\r\n\r\n_No response_\r\n\r\n### Operating System\r\n\r\nNone\r\n\r\n### Describe the bug\r\n\r\nI've added some debug output and transactions sent with large gas, to anvil started with `--disable-gas-limit` show:\r\n\r\n```\r\nenv.block.gas_limit = 0x0000000000000000000000000000000000000000000000000000000000e4e1c0_U256 tx.gas_limit = 19999999\r\n```\r\nin `impl TransactionValidator for Backend { ... if tx.gas_limit() > env.block.gas_limit.into() {`\r\n\r\n```\r\n$python\r\n>>> 0x0000000000000000000000000000000000000000000000000000000000e4e1c0\r\n15000000\r\n```\r\n\r\nAnvil is forking Avalanche. I can't find any instances of `e4e1c0` or `15000000` in either the revm or anvil source, so I'm wondering if this value is coming in from Avalanche? In any case, if the gas limit is disabled, it shouldn't matter, right? This upper bound on the block gas_limit happens when setting via `--gas-limit 20000000` too.",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/5341/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5341/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1627741061",
    "html_url": "https://github.com/foundry-rs/foundry/issues/5341#issuecomment-1627741061",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5341",
    "id": 1627741061,
    "node_id": "IC_kwDOGBlvNc5hBVuF",
    "user": {
      "login": "aathan",
      "id": 24279435,
      "node_id": "MDQ6VXNlcjI0Mjc5NDM1",
      "avatar_url": "https://avatars.githubusercontent.com/u/24279435?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/aathan",
      "html_url": "https://github.com/aathan",
      "followers_url": "https://api.github.com/users/aathan/followers",
      "following_url": "https://api.github.com/users/aathan/following{/other_user}",
      "gists_url": "https://api.github.com/users/aathan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/aathan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/aathan/subscriptions",
      "organizations_url": "https://api.github.com/users/aathan/orgs",
      "repos_url": "https://api.github.com/users/aathan/repos",
      "events_url": "https://api.github.com/users/aathan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/aathan/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-09T15:06:07Z",
    "updated_at": "2023-07-12T06:35:13Z",
    "author_association": "CONTRIBUTOR",
    "body": "Probably that line should be as below. This fixed the instant issue of reverting for gas reasons for me -- but I'm not sure the rest of the tx is correctly handled.\r\n\r\n```\r\n        //TODO The env.cfg check may no longer be necessary now that set_gas_limit() sets U256::max_value()\r\n        if !env.cfg.disable_block_gas_limit && tx.gas_limit() > env.block.gas_limit.into() {\r\n```\r\n\r\nEDIT: should the `env` accesses in this code be doing `env.read().[cfg,block]`? the set_gas_limit() change refered to in the code's is in reference to the eth/backend/mem/mod.rs change I discuss here: https://github.com/foundry-rs/foundry/issues/5341#issuecomment-1631913430\r\n\r\nEDIT: I can confirm the preceding is not enough. Transactions that exceed the configured gas limit get beyond throwing at that line, but something (probably in `revm`) then breaks, and the transaction does not run properly. I've instrumented the functions that execute `SSTORE` etc in `revm` and there is no output. From what I can tell the backend.block.gas_limit is probably getting in the way, and this `--disable-block-gas-limit` feature appears not to be completely implemented.\r\n\r\nI'm going to experiment with modifying `revm` such that a `block.gas_limit==0` means no gas limit is imposed by revm.",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1627741061/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1631913430",
    "html_url": "https://github.com/foundry-rs/foundry/issues/5341#issuecomment-1631913430",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5341",
    "id": 1631913430,
    "node_id": "IC_kwDOGBlvNc5hRQXW",
    "user": {
      "login": "aathan",
      "id": 24279435,
      "node_id": "MDQ6VXNlcjI0Mjc5NDM1",
      "avatar_url": "https://avatars.githubusercontent.com/u/24279435?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/aathan",
      "html_url": "https://github.com/aathan",
      "followers_url": "https://api.github.com/users/aathan/followers",
      "following_url": "https://api.github.com/users/aathan/following{/other_user}",
      "gists_url": "https://api.github.com/users/aathan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/aathan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/aathan/subscriptions",
      "organizations_url": "https://api.github.com/users/aathan/orgs",
      "repos_url": "https://api.github.com/users/aathan/repos",
      "events_url": "https://api.github.com/users/aathan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/aathan/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-12T06:18:48Z",
    "updated_at": "2023-07-12T06:18:48Z",
    "author_association": "CONTRIBUTOR",
    "body": "Also modifying eth/backend/mem/mod.rs {} impl Backend such that:\r\n```\r\n    pub fn set_gas_limit(&self, gas_limit: U256) {\r\n        if self.env().read().cfg.disable_block_gas_limit {\r\n            self.env().write().block.gas_limit = U256::max_value().into();\r\n        } else {\r\n            self.env().write().block.gas_limit = gas_limit.into();\r\n        }\r\n    }\r\n```\r\n\r\nseems to allow the blocked transactions to run inside `revm`",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1631913430/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
