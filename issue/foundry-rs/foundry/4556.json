{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/4556",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4556/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4556/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4556/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/4556",
  "id": 1623312404,
  "node_id": "I_kwDOGBlvNc5gwcgU",
  "number": 4556,
  "title": "msg.sender not consistent after using vm.startPrank()",
  "user": {
    "login": "Carolina-Pinheiro",
    "id": 57190987,
    "node_id": "MDQ6VXNlcjU3MTkwOTg3",
    "avatar_url": "https://avatars.githubusercontent.com/u/57190987?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Carolina-Pinheiro",
    "html_url": "https://github.com/Carolina-Pinheiro",
    "followers_url": "https://api.github.com/users/Carolina-Pinheiro/followers",
    "following_url": "https://api.github.com/users/Carolina-Pinheiro/following{/other_user}",
    "gists_url": "https://api.github.com/users/Carolina-Pinheiro/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Carolina-Pinheiro/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Carolina-Pinheiro/subscriptions",
    "organizations_url": "https://api.github.com/users/Carolina-Pinheiro/orgs",
    "repos_url": "https://api.github.com/users/Carolina-Pinheiro/repos",
    "events_url": "https://api.github.com/users/Carolina-Pinheiro/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Carolina-Pinheiro/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3334394228,
      "node_id": "MDU6TGFiZWwzMzM0Mzk0MjI4",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-bug",
      "name": "T-bug",
      "color": "d73a4a",
      "default": false,
      "description": "Type: bug"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2023-03-14T11:48:53Z",
  "updated_at": "2023-03-14T15:22:14Z",
  "closed_at": "2023-03-14T15:10:28Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Component\n\nForge\n\n### Have you ensured that all of these are up to date?\n\n- [X] Foundry\n- [X] Foundryup\n\n### What version of Foundry are you on?\n\nforge 0.2.0 (df8ab09 2023-03-14T09:59:20.944687208Z)\n\n### What command(s) is the bug in?\n\nforge test -vvvv\n\n### Operating System\n\nLinux\n\n### Describe the bug\n\nI run into the issue that when I'm calling a function within a test file after starting a prank the `msg.sender` is not the one I started the prank with before calling that function. However, if I call a function from another contract inside the first function the `msg.sender` is correct. You can see code attached below that replicates this issue as well as a screenshot of the forge test. I was expecting that the `msg.sender` in both` LogAddress()` emits would be \"Phoebe\", however that doesn't happen.\r\n\r\n\r\nCode snippet replicating the issue:\r\n\r\n**Counter.t.sol**\r\n```\r\n// SPDX-License-Identifier: UNLICENSED\r\npragma solidity ^0.8.13;\r\n\r\nimport \"forge-std/Test.sol\";\r\nimport { showMsgSender } from \"test/contract.sol\";\r\n\r\ncontract CounterTest is Test {\r\n    showMsgSender public show;\r\n    address public phoebe = vm.addr(15);\r\n\r\n    event LogAddress(address);\r\n\r\n    function setUp() public {\r\n        show = new showMsgSender();\r\n        vm.label(phoebe, \"Phoebe\");\r\n    }\r\n\r\n    function testMSGSender() public {\r\n        vm.startPrank(phoebe); \r\n        withinTest();\r\n        vm.stopPrank();\r\n    }\r\n\r\n    function withinTest() public {\r\n        emit LogAddress(msg.sender);  // THE BUG HAPPENS HERE\r\n        show.show();\r\n    }\r\n}\r\n```\r\n\r\n**Contract.sol**\r\n\r\n```\r\n// SPDX-License-Identifier: UNLICENSED\r\npragma solidity ^0.8.13;\r\n\r\ncontract showMsgSender {\r\n    event LogAddress(address);\r\n\r\n    function show() public {\r\n        emit LogAddress(msg.sender);\r\n    }\r\n}\r\n\r\n```\r\n\r\n![image](https://user-images.githubusercontent.com/57190987/224990221-4865cc55-7556-4f2d-a9f2-584723eb1f45.png)\r\n",
  "closed_by": {
    "login": "mds1",
    "id": 17163988,
    "node_id": "MDQ6VXNlcjE3MTYzOTg4",
    "avatar_url": "https://avatars.githubusercontent.com/u/17163988?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mds1",
    "html_url": "https://github.com/mds1",
    "followers_url": "https://api.github.com/users/mds1/followers",
    "following_url": "https://api.github.com/users/mds1/following{/other_user}",
    "gists_url": "https://api.github.com/users/mds1/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mds1/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mds1/subscriptions",
    "organizations_url": "https://api.github.com/users/mds1/orgs",
    "repos_url": "https://api.github.com/users/mds1/repos",
    "events_url": "https://api.github.com/users/mds1/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mds1/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/4556/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4556/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1468208436",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4556#issuecomment-1468208436",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4556",
    "id": 1468208436,
    "node_id": "IC_kwDOGBlvNc5XgxU0",
    "user": {
      "login": "mattsse",
      "id": 19890894,
      "node_id": "MDQ6VXNlcjE5ODkwODk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/19890894?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mattsse",
      "html_url": "https://github.com/mattsse",
      "followers_url": "https://api.github.com/users/mattsse/followers",
      "following_url": "https://api.github.com/users/mattsse/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattsse/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mattsse/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattsse/subscriptions",
      "organizations_url": "https://api.github.com/users/mattsse/orgs",
      "repos_url": "https://api.github.com/users/mattsse/repos",
      "events_url": "https://api.github.com/users/mattsse/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mattsse/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-14T14:30:14Z",
    "updated_at": "2023-03-14T14:31:17Z",
    "author_association": "MEMBER",
    "body": "there's no actual call for `withinTest`, right @mds1 ?\r\n\r\nand that's why `withinTest` is still in the context of `testMSGSender`,\r\nyou see in the traces that `shwow` and the `emit` are directly in `testMSGSender`",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1468208436/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1468289346",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4556#issuecomment-1468289346",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4556",
    "id": 1468289346,
    "node_id": "IC_kwDOGBlvNc5XhFFC",
    "user": {
      "login": "mds1",
      "id": 17163988,
      "node_id": "MDQ6VXNlcjE3MTYzOTg4",
      "avatar_url": "https://avatars.githubusercontent.com/u/17163988?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mds1",
      "html_url": "https://github.com/mds1",
      "followers_url": "https://api.github.com/users/mds1/followers",
      "following_url": "https://api.github.com/users/mds1/following{/other_user}",
      "gists_url": "https://api.github.com/users/mds1/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mds1/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mds1/subscriptions",
      "organizations_url": "https://api.github.com/users/mds1/orgs",
      "repos_url": "https://api.github.com/users/mds1/repos",
      "events_url": "https://api.github.com/users/mds1/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mds1/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-14T15:10:28Z",
    "updated_at": "2023-03-14T15:10:28Z",
    "author_association": "COLLABORATOR",
    "body": "Yep exactly what @mattsse said, `prank` cheats only change the `msg.sender` within CALLs, not within the current context, and the line labeled \"THE BUG HAPPENS HERE\" is the same context as the test contract. Going to close this since this is the expected behavior, but @Carolina-Pinheiro feel free to ask any more questions here",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1468289346/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1468308957",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4556#issuecomment-1468308957",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4556",
    "id": 1468308957,
    "node_id": "IC_kwDOGBlvNc5XhJ3d",
    "user": {
      "login": "Carolina-Pinheiro",
      "id": 57190987,
      "node_id": "MDQ6VXNlcjU3MTkwOTg3",
      "avatar_url": "https://avatars.githubusercontent.com/u/57190987?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Carolina-Pinheiro",
      "html_url": "https://github.com/Carolina-Pinheiro",
      "followers_url": "https://api.github.com/users/Carolina-Pinheiro/followers",
      "following_url": "https://api.github.com/users/Carolina-Pinheiro/following{/other_user}",
      "gists_url": "https://api.github.com/users/Carolina-Pinheiro/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Carolina-Pinheiro/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Carolina-Pinheiro/subscriptions",
      "organizations_url": "https://api.github.com/users/Carolina-Pinheiro/orgs",
      "repos_url": "https://api.github.com/users/Carolina-Pinheiro/repos",
      "events_url": "https://api.github.com/users/Carolina-Pinheiro/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Carolina-Pinheiro/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-14T15:22:02Z",
    "updated_at": "2023-03-14T15:22:14Z",
    "author_association": "NONE",
    "body": "Thanks for the quick response!\r\nI was under the impression that `prank` changed `msg.sender` \"everywhere\" from then on, glad to have that clarified! ",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1468308957/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
