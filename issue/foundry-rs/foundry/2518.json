{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/2518",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/2518/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/2518/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/2518/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/2518",
  "id": 1322496390,
  "node_id": "I_kwDOGBlvNc5O07GG",
  "number": 2518,
  "title": "Contracts Created via CREATE2 from a Factory constructor aren't automatically being verified ",
  "user": {
    "login": "Elyx0",
    "id": 706218,
    "node_id": "MDQ6VXNlcjcwNjIxOA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/706218?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Elyx0",
    "html_url": "https://github.com/Elyx0",
    "followers_url": "https://api.github.com/users/Elyx0/followers",
    "following_url": "https://api.github.com/users/Elyx0/following{/other_user}",
    "gists_url": "https://api.github.com/users/Elyx0/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Elyx0/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Elyx0/subscriptions",
    "organizations_url": "https://api.github.com/users/Elyx0/orgs",
    "repos_url": "https://api.github.com/users/Elyx0/repos",
    "events_url": "https://api.github.com/users/Elyx0/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Elyx0/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3334394228,
      "node_id": "MDU6TGFiZWwzMzM0Mzk0MjI4",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-bug",
      "name": "T-bug",
      "color": "d73a4a",
      "default": false,
      "description": "Type: bug"
    },
    {
      "id": 3703752787,
      "node_id": "LA_kwDOGBlvNc7cwshT",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/C-forge",
      "name": "C-forge",
      "color": "5319E7",
      "default": false,
      "description": "Command: forge"
    },
    {
      "id": 4182991461,
      "node_id": "LA_kwDOGBlvNc75U2Jl",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/Cmd-forge-script",
      "name": "Cmd-forge-script",
      "color": "006B75",
      "default": false,
      "description": "Command: forge script"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2022-07-29T17:12:00Z",
  "updated_at": "2022-08-11T13:59:17Z",
  "closed_at": "2022-07-30T22:57:34Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Component\r\n\r\nForge\r\n\r\n### Have you ensured that all of these are up to date?\r\n\r\n- [X] Foundry\r\n- [X] Foundryup\r\n\r\n### What version of Foundry are you on?\r\n\r\nforge 0.2.0 (2f4dc6c 2022-07-29T00:10:41.103997Z)\r\n\r\n### What command(s) is the bug in?\r\n\r\nforge script script/PreProxyDeploy.s.sol:Deploy --fork-url $ALCHEMY_APIKEY_POLYGON --private-key $TESTNET_KEY --etherscan-api-key $POLYGONSCAN_APIKEY --verify\r\n\r\n### Operating System\r\n\r\nmacOS (Apple Silicon)\r\n\r\n### Describe the bug\r\n\r\nPolygon Mainnet.\r\n\r\n```sh\r\nforge script script/PreProxyDeploy.s.sol:Deploy --fork-url $ALCHEMY_APIKEY_POLYGON --broadcast --private-key $TESTNET_KEY --etherscan-api-key $POLYGONSCAN_APIKEY --verify\r\n```\r\n\r\n```sh\r\n[⠔] Compiling...\r\nNo files changed, compilation skipped\r\nScript ran successfully.\r\n\r\n== Logs ==\r\n  Factory: 0xc71cf7eb2839d864f356da13ebe22883fcbc9b0f\r\n  Create2 deploy from Factory constructor: 0xbed690780a7d5fd13fe29d3fdcb800733fd62245\r\n\r\n==========================\r\n\r\nEstimated total gas used for script: 8983932\r\n\r\nEstimated amount required: 0.4491966 ETH\r\n\r\n==========================\r\n\r\n###\r\nFinding wallets for all the necessary addresses...\r\n##\r\nSending transactions [0 - 0].\r\n⠁ [00:00:00] [###################################################################################################################################################################################################################################] 1/1 txes (0.0s)\r\nTransactions saved to: broadcast/PreProxyDeploy.s.sol/137/run-latest.json\r\n\r\n##\r\nWaiting for receipts.\r\n⠉ [00:00:07] [###############################################################################################################################################################################################################################] 1/1 receipts (0.0s)\r\n#####\r\n✅ Hash: 0x01dea60687c3f77f986ed02fb17d548fe7b161d8602182c2189e3010c79e867c\r\nContract Address: 0xc71cf7eb2839d864f356da13ebe22883fcbc9b0f\r\nBlock: 31254493\r\nPaid: 0.34553585 ETH (6910717 gas * 50 gwei)\r\n\r\n\r\nTransactions saved to: broadcast/PreProxyDeploy.s.sol/137/run-latest.json\r\n\r\n\r\n\r\n==========================\r\n\r\nONCHAIN EXECUTION COMPLETE & SUCCESSFUL. Transaction receipts written to \"broadcast/PreProxyDeploy.s.sol/137/run-latest.json\"\r\n##\r\nStart Contract Verification\r\nwarning: Unknown section [default] found in foundry.toml. This notation for profiles has been deprecated and may result in the profile not being registered in future versions. Please use [profile.default] instead or run `forge config --fix`.\r\nwarning: Unknown section [default] found in foundry.toml. This notation for profiles has been deprecated and may result in the profile not being registered in future versions. Please use [profile.default] instead or run `forge config --fix`.\r\n\r\nSubmitting verification for [contracts/FastLaneFactory.sol:FastLaneFactory] Ok(\"0xc71Cf7EB2839d864F356dA13ebe22883FCbC9B0F\").\r\n\r\nSubmitting verification for [contracts/FastLaneFactory.sol:FastLaneFactory] Ok(\"0xc71Cf7EB2839d864F356dA13ebe22883FCbC9B0F\").\r\n\r\nTransactions saved to: broadcast/PreProxyDeploy.s.sol/137/run-latest.json\r\n\r\nError:\r\nEtherscan could not detect the deployment.\r\n```\r\n\r\nI reran the command without `--broadcast` to get the verification going.\r\n\r\n```sh\r\n[⠰] Compiling...\r\nNo files changed, compilation skipped\r\n##\r\nStart Contract Verification\r\nwarning: Unknown section [default] found in foundry.toml. This notation for profiles has been deprecated and may result in the profile not being registered in future versions. Please use [profile.default] instead or run `forge config --fix`.\r\nwarning: Unknown section [default] found in foundry.toml. This notation for profiles has been deprecated and may result in the profile not being registered in future versions. Please use [profile.default] instead or run `forge config --fix`.\r\n\r\nSubmitting verification for [contracts/FastLaneFactory.sol:FastLaneFactory] Ok(\"0xc71Cf7EB2839d864F356dA13ebe22883FCbC9B0F\").\r\nSubmitted contract for verification:\r\n\tResponse: `OK`\r\n\tGUID: `somethingsomething`\r\n\tURL: https://polygonscan.com/address/0xc71cf7eb2839d864f356da13ebe22883fcbc9b0f\r\nWaiting for verification result...\r\nContract successfully verified.\r\n```\r\n\r\nIt did verify the factory but not 0xbed690780a7d5fd13fe29d3fdcb800733fd62245 made from the Factory constructor.\r\n\r\nFrom https://github.com/foundry-rs/foundry/issues/2005 I tried cleaning the cache, and retry with --force but nothing changed.\r\n\r\n```sh\r\n[⠑] Solc 0.8.15 finished in 3.00s\r\nCompiler run successful\r\n##\r\nStart Contract Verification\r\nwarning: Unknown section [default] found in foundry.toml. This notation for profiles has been deprecated and may result in the profile not being registered in future versions. Please use [profile.default] instead or run `forge config --fix`.\r\nwarning: Unknown section [default] found in foundry.toml. This notation for profiles has been deprecated and may result in the profile not being registered in future versions. Please use [profile.default] instead or run `forge config --fix`.\r\n\r\nSubmitting verification for [contracts/FastLaneFactory.sol:FastLaneFactory] Ok(\"0xc71Cf7EB2839d864F356dA13ebe22883FCbC9B0F\").\r\nContract source code already verified\r\n\r\nTransactions saved to: broadcast/PreProxyDeploy.s.sol/137/run-latest.json\r\n```\r\n\r\nShould I move the CREATE2 out of the constructor and call it as a separate `forge script` tx on the factory for it to work?\r\nI still have the `run-` files if needed.\r\n\r\n\r\n---\r\nEdit: Deploy Script\r\n```solidity\r\n// SPDX-License-Identifier: AGPL-3.0-only\r\npragma solidity ^0.8.15;\r\n\r\nimport \"forge-std/Test.sol\";\r\nimport \"forge-std/Script.sol\";\r\n\r\nimport {FastLaneFactory} from \"contracts/FastLaneFactory.sol\";\r\n\r\ncontract Deploy is Script {\r\n    FastLaneFactory fastlaneFactoryV0;\r\n\r\n    function run() public {\r\n\r\n        vm.startBroadcast();\r\n        bytes32 salt = bytes32(\"hello\");\r\n        FastLaneFactory FLF = new FastLaneFactory(salt);\r\n\r\n        address deployed = FLF.fastlane();\r\n        console2.log(address(FLF));\r\n        console2.log(deployed);\r\n    }\r\n\r\n}\r\n```",
  "closed_by": {
    "login": "onbjerg",
    "id": 8862627,
    "node_id": "MDQ6VXNlcjg4NjI2Mjc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/8862627?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/onbjerg",
    "html_url": "https://github.com/onbjerg",
    "followers_url": "https://api.github.com/users/onbjerg/followers",
    "following_url": "https://api.github.com/users/onbjerg/following{/other_user}",
    "gists_url": "https://api.github.com/users/onbjerg/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/onbjerg/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/onbjerg/subscriptions",
    "organizations_url": "https://api.github.com/users/onbjerg/orgs",
    "repos_url": "https://api.github.com/users/onbjerg/repos",
    "events_url": "https://api.github.com/users/onbjerg/events{/privacy}",
    "received_events_url": "https://api.github.com/users/onbjerg/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/2518/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/2518/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1199961233",
    "html_url": "https://github.com/foundry-rs/foundry/issues/2518#issuecomment-1199961233",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/2518",
    "id": 1199961233,
    "node_id": "IC_kwDOGBlvNc5HhfSR",
    "user": {
      "login": "joshieDo",
      "id": 93316087,
      "node_id": "U_kgDOBY_j9w",
      "avatar_url": "https://avatars.githubusercontent.com/u/93316087?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/joshieDo",
      "html_url": "https://github.com/joshieDo",
      "followers_url": "https://api.github.com/users/joshieDo/followers",
      "following_url": "https://api.github.com/users/joshieDo/following{/other_user}",
      "gists_url": "https://api.github.com/users/joshieDo/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/joshieDo/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/joshieDo/subscriptions",
      "organizations_url": "https://api.github.com/users/joshieDo/orgs",
      "repos_url": "https://api.github.com/users/joshieDo/repos",
      "events_url": "https://api.github.com/users/joshieDo/events{/privacy}",
      "received_events_url": "https://api.github.com/users/joshieDo/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-29T21:35:56Z",
    "updated_at": "2022-07-29T21:36:30Z",
    "author_association": "COLLABORATOR",
    "body": "If i understood correctly, verification of any factory derived contracts is not supported at the moment. It's unrelated to `CREATE2`.\r\n\r\nThe snippet below would verify successfully.\r\n```\r\nvm.startBroadcast();\r\n...\r\nTest t = new Test{salt: bytes32(uint256(1337))}();\r\n...\r\n```\r\n\r\n\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1199961233/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1200133611",
    "html_url": "https://github.com/foundry-rs/foundry/issues/2518#issuecomment-1200133611",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/2518",
    "id": 1200133611,
    "node_id": "IC_kwDOGBlvNc5HiJXr",
    "user": {
      "login": "Elyx0",
      "id": 706218,
      "node_id": "MDQ6VXNlcjcwNjIxOA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/706218?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Elyx0",
      "html_url": "https://github.com/Elyx0",
      "followers_url": "https://api.github.com/users/Elyx0/followers",
      "following_url": "https://api.github.com/users/Elyx0/following{/other_user}",
      "gists_url": "https://api.github.com/users/Elyx0/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Elyx0/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Elyx0/subscriptions",
      "organizations_url": "https://api.github.com/users/Elyx0/orgs",
      "repos_url": "https://api.github.com/users/Elyx0/repos",
      "events_url": "https://api.github.com/users/Elyx0/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Elyx0/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-30T10:43:27Z",
    "updated_at": "2022-07-30T10:43:27Z",
    "author_association": "NONE",
    "body": "I think you got it right I didn't read #1999 fully and it seems it was just a CREATE2 directly like your example VS a CREATE2 from another contract. So yeah if your `Test t` would deploy something else during it's creation (or maybe even after?) using CREATE2 it wouldn't get verified.\r\n\r\nI'm a bit oblivious on how to do it manually as well through polygonscan, I don't know if just a flattened version would do it.",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1200133611/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1200308829",
    "html_url": "https://github.com/foundry-rs/foundry/issues/2518#issuecomment-1200308829",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/2518",
    "id": 1200308829,
    "node_id": "IC_kwDOGBlvNc5Hi0Jd",
    "user": {
      "login": "onbjerg",
      "id": 8862627,
      "node_id": "MDQ6VXNlcjg4NjI2Mjc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8862627?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/onbjerg",
      "html_url": "https://github.com/onbjerg",
      "followers_url": "https://api.github.com/users/onbjerg/followers",
      "following_url": "https://api.github.com/users/onbjerg/following{/other_user}",
      "gists_url": "https://api.github.com/users/onbjerg/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/onbjerg/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/onbjerg/subscriptions",
      "organizations_url": "https://api.github.com/users/onbjerg/orgs",
      "repos_url": "https://api.github.com/users/onbjerg/repos",
      "events_url": "https://api.github.com/users/onbjerg/events{/privacy}",
      "received_events_url": "https://api.github.com/users/onbjerg/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-30T22:57:34Z",
    "updated_at": "2022-07-30T22:57:34Z",
    "author_association": "MEMBER",
    "body": "Flattened version should do it I think. Closing this as a duplicate of https://github.com/foundry-rs/foundry/issues/1893 though since it's the same underlying issue if I understand correctly :)",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1200308829/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1209537530",
    "html_url": "https://github.com/foundry-rs/foundry/issues/2518#issuecomment-1209537530",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/2518",
    "id": 1209537530,
    "node_id": "IC_kwDOGBlvNc5IGBP6",
    "user": {
      "login": "Elyx0",
      "id": 706218,
      "node_id": "MDQ6VXNlcjcwNjIxOA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/706218?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Elyx0",
      "html_url": "https://github.com/Elyx0",
      "followers_url": "https://api.github.com/users/Elyx0/followers",
      "following_url": "https://api.github.com/users/Elyx0/following{/other_user}",
      "gists_url": "https://api.github.com/users/Elyx0/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Elyx0/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Elyx0/subscriptions",
      "organizations_url": "https://api.github.com/users/Elyx0/orgs",
      "repos_url": "https://api.github.com/users/Elyx0/repos",
      "events_url": "https://api.github.com/users/Elyx0/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Elyx0/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-09T15:32:38Z",
    "updated_at": "2022-08-09T15:32:56Z",
    "author_association": "NONE",
    "body": "@joshieDo \r\n\r\n> If i understood correctly, verification of any factory derived contracts is not supported at the moment. It's unrelated to `CREATE2`.\r\n> \r\n> The snippet below would verify successfully.\r\n> \r\n> ```\r\n> vm.startBroadcast();\r\n> ...\r\n> Test t = new Test{salt: bytes32(uint256(1337))}();\r\n> ...\r\n> ```\r\n\r\nIt didn't work with flatten but maybe it's me I'll retry with a fresh deploy from current commit.\r\nAlso I thought EOA can't CREATE2, so your example wouldn't work, or am I missing something?\r\n\r\nI'll most likely use @pcaversaccio https://twitter.com/pcaversaccio/status/1555822908441755648 in the future to deploy an UUPS and hope it will pass verification",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1209537530/reactions",
      "total_count": 2,
      "+1": 0,
      "-1": 0,
      "laugh": 1,
      "hooray": 0,
      "confused": 0,
      "heart": 1,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1212028294",
    "html_url": "https://github.com/foundry-rs/foundry/issues/2518#issuecomment-1212028294",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/2518",
    "id": 1212028294,
    "node_id": "IC_kwDOGBlvNc5IPhWG",
    "user": {
      "login": "Elyx0",
      "id": 706218,
      "node_id": "MDQ6VXNlcjcwNjIxOA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/706218?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Elyx0",
      "html_url": "https://github.com/Elyx0",
      "followers_url": "https://api.github.com/users/Elyx0/followers",
      "following_url": "https://api.github.com/users/Elyx0/following{/other_user}",
      "gists_url": "https://api.github.com/users/Elyx0/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Elyx0/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Elyx0/subscriptions",
      "organizations_url": "https://api.github.com/users/Elyx0/orgs",
      "repos_url": "https://api.github.com/users/Elyx0/repos",
      "events_url": "https://api.github.com/users/Elyx0/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Elyx0/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-11T13:58:55Z",
    "updated_at": "2022-08-11T13:59:17Z",
    "author_association": "NONE",
    "body": "Okay from @sambacha https://github.com/foundry-rs/foundry/issues/2638 I understand better how it works.\r\nI think it should be made clearer in the doc that this is what's happening when you CREATE2 from a script root. (also for vanity & verification)\r\n\r\n```rs\r\n    // Prepare CREATE2 Deployer\r\n    let addr = Address::from_str(\"0x4e59b44847b379578588920ca78fbf26c0b4956c\").unwrap();\r\n    let code = hex::decode(\"7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe03601600081602082378035828234f58015156039578182fd5b8082525050506014600cf3\").expect(\"Could not decode create2 deployer init_code\").into();\r\n    api.anvil_set_code(addr, code).await.unwrap();\r\n```\r\nCause from reading the EIP I would expect it to ignore the salt.",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1212028294/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
