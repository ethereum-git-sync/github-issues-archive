{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/3874",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3874/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3874/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3874/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/3874",
  "id": 1490015341,
  "node_id": "I_kwDOGBlvNc5Yz9Rt",
  "number": 3874,
  "title": "Arbitrum Fork and running scripts containing vm.start/stopBroadcast in test results in failing deployment",
  "user": {
    "login": "0xCalibur",
    "id": 92554750,
    "node_id": "U_kgDOBYRF_g",
    "avatar_url": "https://avatars.githubusercontent.com/u/92554750?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/0xCalibur",
    "html_url": "https://github.com/0xCalibur",
    "followers_url": "https://api.github.com/users/0xCalibur/followers",
    "following_url": "https://api.github.com/users/0xCalibur/following{/other_user}",
    "gists_url": "https://api.github.com/users/0xCalibur/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/0xCalibur/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/0xCalibur/subscriptions",
    "organizations_url": "https://api.github.com/users/0xCalibur/orgs",
    "repos_url": "https://api.github.com/users/0xCalibur/repos",
    "events_url": "https://api.github.com/users/0xCalibur/events{/privacy}",
    "received_events_url": "https://api.github.com/users/0xCalibur/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3334394228,
      "node_id": "MDU6TGFiZWwzMzM0Mzk0MjI4",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-bug",
      "name": "T-bug",
      "color": "d73a4a",
      "default": false,
      "description": "Type: bug"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2022-12-11T13:53:05Z",
  "updated_at": "2022-12-20T15:30:20Z",
  "closed_at": "2022-12-13T07:22:12Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "### Component\n\nForge\n\n### Have you ensured that all of these are up to date?\n\n- [X] Foundry\n- [X] Foundryup\n\n### What version of Foundry are you on?\n\nforge 0.2.0 (e9f274d 2022-12-11T00:03:42.968584731Z)\n\n### What command(s) is the bug in?\n\nforge test -vvvv\n\n### Operating System\n\nLinux\n\n### Describe the bug\n\nThere seems to be an issue with the vm.start/stopBroadcast instructions used within tests. Removing the fork and select instruction and/or the vm.start/stopBroadcast doesn't produce the issue.\r\n\r\nStep to reproduce:\r\n- https://github.com/0xCalibur/foundry_arbitrum_fork_issue\r\n- forge test -vvvv\r\n\r\nExpectation:\r\n- test passing\r\n\r\nWhat is actually happening:\r\n```\r\n➜  hello_foundry git:(main) forge test -vvvv\r\n[⠊] Compiling...\r\n[⠒] Compiling 2 files with 0.8.16\r\n[⠑] Solc 0.8.16 finished in 421.27ms\r\nCompiler run successful\r\n2022-12-11T13:47:21.014261Z ERROR forge::runner: setUp failed reason=\"EvmError: Revert\" contract=0x7fa9385be102ac3eac297483dd6233d62b3e1496\r\n\r\nRunning 1 test for test/Test.t.sol:CounterTest\r\n[FAIL. Reason: Setup failed: EvmError: Revert] setUp() (gas: 0)\r\nTraces:\r\n  [0] CounterTest::setUp()\r\n    ├─ [0] VM::createSelectFork(https://1rpc.io/arb, 44679129)\r\n    │   └─ ← 0\r\n    ├─ [1851178] → new MyScript@0x5615dEB798BB3E4dFa0139dFa1b3D433Cc23b72f\r\n    │   ├─ [0] VM::rpcUrlStructs() [staticcall]\r\n    │   │   └─ ← []\r\n    │   └─ ← 1841 bytes of code\r\n    ├─ [8937393460516792307] MyScript::run()\r\n    │   ├─ [0] VM::startBroadcast()\r\n    │   │   └─ ← ()\r\n    │   ├─ [241300] → new ProxyOracle@0x5b73C5498c1E3b4dbA84de0F1833c4a029d90519\r\n    │   │   └─ ← 1094 bytes of code\r\n    │   ├─ [8937393460514904257] → new <Unknown>@0x104fBc016F4bb334D775a19E8A6510109AC63E00\r\n    │   │   └─ ← 0 bytes of code\r\n    │   └─ ← \"EvmError: Revert\"\r\n    └─ ← ()\r\n\r\nTest result: FAILED. 0 passed; 1 failed; finished in 446.87ms\r\n\r\nFailing tests:\r\nEncountered 1 failing test in test/Test.t.sol:CounterTest\r\n[FAIL. Reason: Setup failed: EvmError: Revert] setUp() (gas: 0)\r\n```",
  "closed_by": {
    "login": "mattsse",
    "id": 19890894,
    "node_id": "MDQ6VXNlcjE5ODkwODk0",
    "avatar_url": "https://avatars.githubusercontent.com/u/19890894?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mattsse",
    "html_url": "https://github.com/mattsse",
    "followers_url": "https://api.github.com/users/mattsse/followers",
    "following_url": "https://api.github.com/users/mattsse/following{/other_user}",
    "gists_url": "https://api.github.com/users/mattsse/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mattsse/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mattsse/subscriptions",
    "organizations_url": "https://api.github.com/users/mattsse/orgs",
    "repos_url": "https://api.github.com/users/mattsse/repos",
    "events_url": "https://api.github.com/users/mattsse/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mattsse/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/3874/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3874/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1345894832",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3874#issuecomment-1345894832",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3874",
    "id": 1345894832,
    "node_id": "IC_kwDOGBlvNc5QOLmw",
    "user": {
      "login": "joshieDo",
      "id": 93316087,
      "node_id": "U_kgDOBY_j9w",
      "avatar_url": "https://avatars.githubusercontent.com/u/93316087?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/joshieDo",
      "html_url": "https://github.com/joshieDo",
      "followers_url": "https://api.github.com/users/joshieDo/followers",
      "following_url": "https://api.github.com/users/joshieDo/following{/other_user}",
      "gists_url": "https://api.github.com/users/joshieDo/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/joshieDo/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/joshieDo/subscriptions",
      "organizations_url": "https://api.github.com/users/joshieDo/orgs",
      "repos_url": "https://api.github.com/users/joshieDo/repos",
      "events_url": "https://api.github.com/users/joshieDo/events{/privacy}",
      "received_events_url": "https://api.github.com/users/joshieDo/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-12T05:15:29Z",
    "updated_at": "2022-12-12T05:15:29Z",
    "author_association": "COLLABORATOR",
    "body": "As a quick fix you can add `--sender 0x....` to your command or call `vm.startBroadcast(0x...` with a specific address.\r\n\r\nBut the underlying issue seems slightly trickier.\r\n\r\nThe default foundry sender is creating the `TestContract` with nonce 1 resulting in the following address: `0x7FA9385bE102ac3EAc297483Dd6233D62b3e1496`.\r\n\r\nEventually,  `MyScript.run()` is called after changing to a fork. This change resets the default foundry sender nonce to 0. It creates the first contract (`0x5b73C5498c1E3b4dbA84de0F1833c4a029d90519`), and when it tries to create the second contract with nonce 1 it will try to create a contract @ `0x7FA9385bE102ac3EAc297483Dd6233D62b3e1496`... which is already taken by the `TestContract`. I'm not entirely sure why the log is showing `0x104...`, but I've debugged it and havae seen it happen.\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1345894832/reactions",
      "total_count": 2,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 2
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1346596586",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3874#issuecomment-1346596586",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3874",
    "id": 1346596586,
    "node_id": "IC_kwDOGBlvNc5QQ27q",
    "user": {
      "login": "0xCalibur",
      "id": 92554750,
      "node_id": "U_kgDOBYRF_g",
      "avatar_url": "https://avatars.githubusercontent.com/u/92554750?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/0xCalibur",
      "html_url": "https://github.com/0xCalibur",
      "followers_url": "https://api.github.com/users/0xCalibur/followers",
      "following_url": "https://api.github.com/users/0xCalibur/following{/other_user}",
      "gists_url": "https://api.github.com/users/0xCalibur/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/0xCalibur/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/0xCalibur/subscriptions",
      "organizations_url": "https://api.github.com/users/0xCalibur/orgs",
      "repos_url": "https://api.github.com/users/0xCalibur/repos",
      "events_url": "https://api.github.com/users/0xCalibur/events{/privacy}",
      "received_events_url": "https://api.github.com/users/0xCalibur/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-12T14:23:16Z",
    "updated_at": "2022-12-12T14:23:27Z",
    "author_association": "CONTRIBUTOR",
    "body": "@joshieDo thanks for looking in to it. As another workaround within my test I have a ```testing``` boolean and just skip the broadcasts when it's true. But interesting problem here, just wondering why this specifically happen with Arbitrum forks only.\r\n\r\nAnother possible linked issue, is when deploying multiple contracts in script for Arbitrum, it seems to cause problem with gas estimation. So I need to deploy the contracts one by one. Maybe that's completely unrelated thought, just wanted to point it out.",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1346596586/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1348408265",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3874#issuecomment-1348408265",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3874",
    "id": 1348408265,
    "node_id": "IC_kwDOGBlvNc5QXxPJ",
    "user": {
      "login": "0xCalibur",
      "id": 92554750,
      "node_id": "U_kgDOBYRF_g",
      "avatar_url": "https://avatars.githubusercontent.com/u/92554750?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/0xCalibur",
      "html_url": "https://github.com/0xCalibur",
      "followers_url": "https://api.github.com/users/0xCalibur/followers",
      "following_url": "https://api.github.com/users/0xCalibur/following{/other_user}",
      "gists_url": "https://api.github.com/users/0xCalibur/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/0xCalibur/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/0xCalibur/subscriptions",
      "organizations_url": "https://api.github.com/users/0xCalibur/orgs",
      "repos_url": "https://api.github.com/users/0xCalibur/repos",
      "events_url": "https://api.github.com/users/0xCalibur/events{/privacy}",
      "received_events_url": "https://api.github.com/users/0xCalibur/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-13T12:13:58Z",
    "updated_at": "2022-12-13T12:13:58Z",
    "author_association": "CONTRIBUTOR",
    "body": "after this PR merge, I just ran foundryup, I assumed it will install the latest from master, right?\r\n\r\nversion is\r\n```\r\nforge 0.2.0 (e9f274d 2022-12-13T00:04:05.364169121Z)\r\n```\r\n\r\nbut, I'm still having the issue presented at https://github.com/0xCalibur/foundry_arbitrum_fork_issue\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1348408265/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1358862493",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3874#issuecomment-1358862493",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3874",
    "id": 1358862493,
    "node_id": "IC_kwDOGBlvNc5Q_pid",
    "user": {
      "login": "joshieDo",
      "id": 93316087,
      "node_id": "U_kgDOBY_j9w",
      "avatar_url": "https://avatars.githubusercontent.com/u/93316087?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/joshieDo",
      "html_url": "https://github.com/joshieDo",
      "followers_url": "https://api.github.com/users/joshieDo/followers",
      "following_url": "https://api.github.com/users/joshieDo/following{/other_user}",
      "gists_url": "https://api.github.com/users/joshieDo/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/joshieDo/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/joshieDo/subscriptions",
      "organizations_url": "https://api.github.com/users/joshieDo/orgs",
      "repos_url": "https://api.github.com/users/joshieDo/repos",
      "events_url": "https://api.github.com/users/joshieDo/events{/privacy}",
      "received_events_url": "https://api.github.com/users/joshieDo/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-20T05:33:26Z",
    "updated_at": "2022-12-20T05:33:26Z",
    "author_association": "COLLABORATOR",
    "body": "> after this PR merge, I just ran foundryup, I assumed it will install the latest from master, right?\r\n\r\n@0xCalibur  No, it installs the one built by the [nightly](https://github.com/foundry-rs/foundry/tags) pipeline. \r\n\r\nI'm not sure if when you tried, it had already been built with the fix... so can you try again? (I did, and it worked fine).\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1358862493/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 1,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1359567845",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3874#issuecomment-1359567845",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3874",
    "id": 1359567845,
    "node_id": "IC_kwDOGBlvNc5RCVvl",
    "user": {
      "login": "0xCalibur",
      "id": 92554750,
      "node_id": "U_kgDOBYRF_g",
      "avatar_url": "https://avatars.githubusercontent.com/u/92554750?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/0xCalibur",
      "html_url": "https://github.com/0xCalibur",
      "followers_url": "https://api.github.com/users/0xCalibur/followers",
      "following_url": "https://api.github.com/users/0xCalibur/following{/other_user}",
      "gists_url": "https://api.github.com/users/0xCalibur/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/0xCalibur/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/0xCalibur/subscriptions",
      "organizations_url": "https://api.github.com/users/0xCalibur/orgs",
      "repos_url": "https://api.github.com/users/0xCalibur/repos",
      "events_url": "https://api.github.com/users/0xCalibur/events{/privacy}",
      "received_events_url": "https://api.github.com/users/0xCalibur/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-20T15:30:20Z",
    "updated_at": "2022-12-20T15:30:20Z",
    "author_association": "CONTRIBUTOR",
    "body": "I confirm this is now working, I must have ran `foundryup` before the build was ready. Thanks.",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1359567845/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
