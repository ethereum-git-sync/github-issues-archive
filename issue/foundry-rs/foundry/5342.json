{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/5342",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5342/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5342/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5342/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/5342",
  "id": 1795324382,
  "node_id": "I_kwDOGBlvNc5rAnne",
  "number": 5342,
  "title": "bug(coverage): missing hits when two contracts from different files have the same name",
  "user": {
    "login": "spockP",
    "id": 135574263,
    "node_id": "U_kgDOCBSy9w",
    "avatar_url": "https://avatars.githubusercontent.com/u/135574263?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/spockP",
    "html_url": "https://github.com/spockP",
    "followers_url": "https://api.github.com/users/spockP/followers",
    "following_url": "https://api.github.com/users/spockP/following{/other_user}",
    "gists_url": "https://api.github.com/users/spockP/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/spockP/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/spockP/subscriptions",
    "organizations_url": "https://api.github.com/users/spockP/orgs",
    "repos_url": "https://api.github.com/users/spockP/repos",
    "events_url": "https://api.github.com/users/spockP/events{/privacy}",
    "received_events_url": "https://api.github.com/users/spockP/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3334394228,
      "node_id": "MDU6TGFiZWwzMzM0Mzk0MjI4",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-bug",
      "name": "T-bug",
      "color": "d73a4a",
      "default": false,
      "description": "Type: bug"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2023-07-09T10:02:52Z",
  "updated_at": "2023-07-09T12:29:06Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Component\r\n\r\nForge\r\n\r\n### Have you ensured that all of these are up to date?\r\n\r\n- [X] Foundry\r\n- [X] Foundryup\r\n\r\n### What version of Foundry are you on?\r\n\r\ncommit 8c48932\r\n\r\n### What command(s) is the bug in?\r\n\r\ncoverage\r\n\r\n### Operating System\r\n\r\nmacOS (Intel)\r\n\r\n### Describe the bug\r\n\r\n## Issue \r\n\r\nThis is a bug that I encountered  when I was tracking the test coverage of a rather complicated solidity project. \r\nHowever,  here is a simple project to replicate the same bug: \r\n\r\nThere are two simple libraries: `LibA` and `LibB`:  \r\n\r\n- `LibA` from file `LibA.sol`  \r\n- `LibB` from file `LibB.sol` \r\n\r\n```solidity \r\n\r\n// file LibA.sol \r\n\r\n// SPDX-License-Identifier: UNLICENSED\r\npragma solidity ^0.8.13;\r\n\r\n\r\nlibrary LibA {\r\n    \r\n    function getLibValue() external view returns(uint256 v){\r\n\r\n        v++;\r\n\r\n    }\r\n}\r\n```\r\n\r\n```solidity\r\n// file:  LibB.sol \r\n// SPDX-License-Identifier: UNLICENSED\r\npragma solidity ^0.8.13;\r\n\r\n\r\nlibrary LibB {\r\n    \r\n    function getLibValue() external view returns(uint256 v){\r\n\r\n        v++;\r\n    }\r\n}\r\n\r\n```\r\n\r\nAnd there are two contracts with the same name (`UseLib`) but defined in different files:  \r\n\r\n- `UseLib` defined in  file `UseLib0.sol` depends on  `LibA`  \r\n- `UseLib` defined in  file `UseLib1.sol` depends on  `LibB`    \r\n\r\n```solidity \r\n// UseLib0.sol \r\n// SPDX-License-Identifier: UNLICENSED\r\npragma solidity ^0.8.13;\r\n\r\nimport \"./LibA.sol\";\r\n\r\n\r\ncontract UseLib {\r\n\r\n    mapping (uint => uint) numbers;\r\n    \r\n    function getValue() external view returns(uint256){\r\n\r\n        // Note: The code of the two \"UseLib\" contracts must be different\r\n        // If the difference score between them is too low,\r\n        // the hits of the two contracts may be accidently merged into one: \r\n        // https://github.com/foundry-rs/foundry/blob/8c4893233c7d54de3787227577cd0e3a4faa8945/common/src/contracts.rs#L25\r\n\r\n        uint seed = LibA.getLibValue();\r\n        \r\n        uint sum = 0;\r\n        // do more stuffs to make the code more distinctive from the other  \r\n        for(uint i=0; i < seed; ++i){\r\n            sum += numbers[i];\r\n        }\r\n\r\n        return sum;\r\n    }\r\n}\r\n``` \r\n\r\n```solidity \r\n// UseLib1.sol \r\n// SPDX-License-Identifier: UNLICENSED\r\npragma solidity ^0.8.13;\r\n\r\nimport \"./LibB.sol\";\r\n\r\n\r\ncontract UseLib {\r\n\r\n\r\n    uint256 a; \r\n\r\n    function getValue() external view returns(uint256){\r\n        uint b = LibB.getLibValue() + a;\r\n        return b;\r\n    }\r\n}\r\n```\r\n\r\nAnd the test script is as follows: \r\n\r\n```solidity\r\n\r\n// SPDX-License-Identifier: UNLICENSED\r\npragma solidity ^0.8.13;\r\n\r\nimport \"forge-std/Test.sol\";\r\nimport {UseLib as UseLibFrom0} from \"../src/UseLib0.sol\";\r\nimport {UseLib as UseLibFrom1} from \"../src/UseLib1.sol\";\r\n\r\n\r\ncontract TestA is Test {\r\n\r\n   UseLibFrom0 sut0;\r\n   UseLibFrom1 sut1;\r\n   \r\n   function setUp() external{\r\n        sut0 = new UseLibFrom0();\r\n        sut1 = new UseLibFrom1();\r\n   }\r\n\r\n    function test_GetA() external {\r\n        uint256 result = sut0.getValue();\r\n        assertEq(result, 0);\r\n\r\n        result = sut1.getValue();\r\n        assertEq(result, 1);\r\n    }\r\n}\r\n\r\n```\r\n\r\nOkay, Let's see the summary & debug coverage report:  \r\n\r\n```\r\n\r\n| File            | % Lines       | % Statements  | % Branches    | % Funcs       |\r\n|-----------------|---------------|---------------|---------------|---------------|\r\n| src/LibA.sol    | 100.00% (1/1) | 100.00% (1/1) | 100.00% (0/0) | 100.00% (1/1) |\r\n| src/LibB.sol    | 100.00% (1/1) | 100.00% (1/1) | 100.00% (0/0) | 100.00% (1/1) |\r\n| src/UseLib0.sol | 0.00% (0/5)   | 0.00% (0/8)   | 100.00% (0/0) | 0.00% (0/1)   |\r\n| src/UseLib1.sol | 100.00% (2/2) | 100.00% (3/3) | 100.00% (0/0) | 100.00% (1/1) |\r\n| Total           | 44.44% (4/9)  | 38.46% (5/13) | 100.00% (0/0) | 75.00% (3/4)  |\r\n\r\nUncovered for src/LibA.sol:\r\n\r\nUncovered for src/LibB.sol:\r\n\r\nUncovered for src/UseLib0.sol:\r\n- Function \"getValue\" (location: source ID 19, line 11, chars 152-457, hits: 0)\r\n- Line (location: source ID 19, line 12, chars 212-242, hits: 0)\r\n- Statement (location: source ID 19, line 12, chars 212-242, hits: 0)\r\n- Statement (location: source ID 19, line 12, chars 224-242, hits: 0)\r\n- Line (location: source ID 19, line 14, chars 261-273, hits: 0)\r\n- Statement (location: source ID 19, line 14, chars 261-273, hits: 0)\r\n- Line (location: source ID 19, line 16, chars 364-372, hits: 0)\r\n- Statement (location: source ID 19, line 16, chars 364-372, hits: 0)\r\n- Statement (location: source ID 19, line 16, chars 374-382, hits: 0)\r\n- Statement (location: source ID 19, line 16, chars 384-387, hits: 0)\r\n- Line (location: source ID 19, line 17, chars 402-419, hits: 0)\r\n- Statement (location: source ID 19, line 17, chars 402-419, hits: 0)\r\n- Line (location: source ID 19, line 20, chars 440-450, hits: 0)\r\n- Statement (location: source ID 19, line 20, chars 440-450, hits: 0)\r\n\r\nUncovered for src/UseLib1.sol:\r\n\r\nAnchors for Contract \"LibA\" (solc 0.8.20+commit.a1b79de6.Darwin.appleclang, source ID 17):\r\n- IC 58 -> Item 23\r\n  - Refers to item: Function \"getLibValue\" (location: source ID 17, line 7, chars 90-167, hits: 1)\r\n- IC 91 -> Item 24\r\n  - Refers to item: Line (location: source ID 17, line 9, chars 156-159, hits: 1)\r\n- IC 91 -> Item 25\r\n  - Refers to item: Statement (location: source ID 17, line 9, chars 156-159, hits: 1)\r\n\r\nAnchors for Contract \"LibB\" (solc 0.8.20+commit.a1b79de6.Darwin.appleclang, source ID 18):\r\n- IC 58 -> Item 20\r\n  - Refers to item: Function \"getLibValue\" (location: source ID 18, line 7, chars 90-166, hits: 1)\r\n- IC 91 -> Item 21\r\n  - Refers to item: Line (location: source ID 18, line 9, chars 156-159, hits: 1)\r\n- IC 91 -> Item 22\r\n  - Refers to item: Statement (location: source ID 18, line 9, chars 156-159, hits: 1)\r\n\r\nAnchors for Contract \"UseLib\" (solc 0.8.20+commit.a1b79de6.Darwin.appleclang, source ID 20):\r\n- IC 48 -> Item 14\r\n  - Refers to item: Function \"getValue\" (location: source ID 20, line 12, chars 129-245, hits: 1)\r\n- IC 81 -> Item 15\r\n  - Refers to item: Line (location: source ID 20, line 13, chars 189-220, hits: 1)\r\n- IC 81 -> Item 16\r\n  - Refers to item: Statement (location: source ID 20, line 13, chars 189-220, hits: 1)\r\n- IC 82 -> Item 17\r\n  - Refers to item: Statement (location: source ID 20, line 13, chars 198-220, hits: 1)\r\n- IC 206 -> Item 18\r\n  - Refers to item: Line (location: source ID 20, line 14, chars 230-238, hits: 1)\r\n- IC 206 -> Item 19\r\n  - Refers to item: Statement (location: source ID 20, line 14, chars 230-238, hits: 1)\r\n\r\nAnchors for Contract \"UseLib\" (solc 0.8.20+commit.a1b79de6.Darwin.appleclang, source ID 19):\r\n- IC 48 -> Item 0\r\n  - Refers to item: Function \"getValue\" (location: source ID 19, line 11, chars 152-457, hits: 0)\r\n- IC 81 -> Item 1\r\n  - Refers to item: Line (location: source ID 19, line 12, chars 212-242, hits: 0)\r\n- IC 81 -> Item 2\r\n  - Refers to item: Statement (location: source ID 19, line 12, chars 212-242, hits: 0)\r\n- IC 82 -> Item 3\r\n  - Refers to item: Statement (location: source ID 19, line 12, chars 224-242, hits: 0)\r\n- IC 193 -> Item 4\r\n  - Refers to item: Line (location: source ID 19, line 14, chars 261-273, hits: 0)\r\n- IC 193 -> Item 5\r\n  - Refers to item: Statement (location: source ID 19, line 14, chars 261-273, hits: 0)\r\n- IC 195 -> Item 6\r\n  - Refers to item: Line (location: source ID 19, line 16, chars 364-372, hits: 0)\r\n- IC 195 -> Item 7\r\n  - Refers to item: Statement (location: source ID 19, line 16, chars 364-372, hits: 0)\r\n- IC 197 -> Item 8\r\n  - Refers to item: Statement (location: source ID 19, line 16, chars 374-382, hits: 0)\r\n- IC 237 -> Item 9\r\n  - Refers to item: Statement (location: source ID 19, line 16, chars 384-387, hits: 0)\r\n- IC 205 -> Item 10\r\n  - Refers to item: Line (location: source ID 19, line 17, chars 402-419, hits: 0)\r\n- IC 205 -> Item 11\r\n  - Refers to item: Statement (location: source ID 19, line 17, chars 402-419, hits: 0)\r\n- IC 255 -> Item 12\r\n  - Refers to item: Line (location: source ID 19, line 20, chars 440-450, hits: 0)\r\n- IC 255 -> Item 13\r\n  - Refers to item: Statement (location: source ID 19, line 20, chars 440-450, hits: 0)\r\n\r\n\r\n\r\n```\r\n\r\n\r\nNote that hits of  the `UseLib` contract from `UseLib0.sol`  are missing.   \r\n\r\nAnd let's do some magics. If we change the name of the `UseLib`  contract in `UseLib0.sol` to `UseLibRenamed`, the resulting coverage report correctly includes all the hits: \r\n\r\n```\r\n\r\n| File            | % Lines       | % Statements    | % Branches    | % Funcs       |\r\n|-----------------|---------------|-----------------|---------------|---------------|\r\n| src/LibA.sol    | 100.00% (1/1) | 100.00% (1/1)   | 100.00% (0/0) | 100.00% (1/1) |\r\n| src/LibB.sol    | 100.00% (1/1) | 100.00% (1/1)   | 100.00% (0/0) | 100.00% (1/1) |\r\n| src/UseLib0.sol | 100.00% (5/5) | 100.00% (8/8)   | 100.00% (0/0) | 100.00% (1/1) |\r\n| src/UseLib1.sol | 100.00% (2/2) | 100.00% (3/3)   | 100.00% (0/0) | 100.00% (1/1) |\r\n| Total           | 100.00% (9/9) | 100.00% (13/13) | 100.00% (0/0) | 100.00% (4/4) |\r\n\r\n\r\nUncovered for src/LibA.sol:\r\n\r\nUncovered for src/LibB.sol:\r\n\r\nUncovered for src/UseLib0.sol:\r\n\r\nUncovered for src/UseLib1.sol:\r\n\r\nAnchors for Contract \"UseLib\" (solc 0.8.20+commit.a1b79de6.Darwin.appleclang, source ID 20):\r\n- IC 48 -> Item 20\r\n  - Refers to item: Function \"getValue\" (location: source ID 20, line 12, chars 129-245, hits: 1)\r\n- IC 81 -> Item 21\r\n  - Refers to item: Line (location: source ID 20, line 13, chars 189-220, hits: 1)\r\n- IC 81 -> Item 22\r\n  - Refers to item: Statement (location: source ID 20, line 13, chars 189-220, hits: 1)\r\n- IC 82 -> Item 23\r\n  - Refers to item: Statement (location: source ID 20, line 13, chars 198-220, hits: 1)\r\n- IC 206 -> Item 24\r\n  - Refers to item: Line (location: source ID 20, line 14, chars 230-238, hits: 1)\r\n- IC 206 -> Item 25\r\n  - Refers to item: Statement (location: source ID 20, line 14, chars 230-238, hits: 1)\r\n\r\nAnchors for Contract \"UseLibRenamed\" (solc 0.8.20+commit.a1b79de6.Darwin.appleclang, source ID 19):\r\n- IC 48 -> Item 0\r\n  - Refers to item: Function \"getValue\" (location: source ID 19, line 11, chars 159-799, hits: 1)\r\n- IC 81 -> Item 1\r\n  - Refers to item: Line (location: source ID 19, line 18, chars 554-584, hits: 1)\r\n- IC 81 -> Item 2\r\n  - Refers to item: Statement (location: source ID 19, line 18, chars 554-584, hits: 1)\r\n- IC 82 -> Item 3\r\n  - Refers to item: Statement (location: source ID 19, line 18, chars 566-584, hits: 1)\r\n- IC 193 -> Item 4\r\n  - Refers to item: Line (location: source ID 19, line 20, chars 603-615, hits: 1)\r\n- IC 193 -> Item 5\r\n  - Refers to item: Statement (location: source ID 19, line 20, chars 603-615, hits: 1)\r\n- IC 195 -> Item 6\r\n  - Refers to item: Line (location: source ID 19, line 22, chars 706-714, hits: 1)\r\n- IC 195 -> Item 7\r\n  - Refers to item: Statement (location: source ID 19, line 22, chars 706-714, hits: 1)\r\n- IC 197 -> Item 8\r\n  - Refers to item: Statement (location: source ID 19, line 22, chars 716-724, hits: 2)\r\n- IC 237 -> Item 9\r\n  - Refers to item: Statement (location: source ID 19, line 22, chars 726-729, hits: 1)\r\n- IC 205 -> Item 10\r\n  - Refers to item: Line (location: source ID 19, line 23, chars 744-761, hits: 1)\r\n- IC 205 -> Item 11\r\n  - Refers to item: Statement (location: source ID 19, line 23, chars 744-761, hits: 1)\r\n- IC 255 -> Item 12\r\n  - Refers to item: Line (location: source ID 19, line 26, chars 782-792, hits: 1)\r\n- IC 255 -> Item 13\r\n  - Refers to item: Statement (location: source ID 19, line 26, chars 782-792, hits: 1)\r\n\r\nAnchors for Contract \"LibA\" (solc 0.8.20+commit.a1b79de6.Darwin.appleclang, source ID 17):\r\n- IC 58 -> Item 17\r\n  - Refers to item: Function \"getLibValue\" (location: source ID 17, line 7, chars 90-167, hits: 1)\r\n- IC 91 -> Item 18\r\n  - Refers to item: Line (location: source ID 17, line 9, chars 156-159, hits: 1)\r\n- IC 91 -> Item 19\r\n  - Refers to item: Statement (location: source ID 17, line 9, chars 156-159, hits: 1)\r\n\r\nAnchors for Contract \"LibB\" (solc 0.8.20+commit.a1b79de6.Darwin.appleclang, source ID 18):\r\n- IC 58 -> Item 14\r\n  - Refers to item: Function \"getLibValue\" (location: source ID 18, line 7, chars 90-166, hits: 1)\r\n- IC 91 -> Item 15\r\n  - Refers to item: Line (location: source ID 18, line 9, chars 156-159, hits: 1)\r\n- IC 91 -> Item 16\r\n  - Refers to item: Statement (location: source ID 18, line 9, chars 156-159, hits: 1)\r\n\r\n\r\n```\r\n\r\n\r\n## Possible Cause ?\r\n\r\n\r\nTwo contracts with the same from different files will have the same `slug`. \r\n\r\nhttps://github.com/foundry-rs/foundry/blob/8c4893233c7d54de3787227577cd0e3a4faa8945/utils/src/lib.rs#L142 \r\n\r\n\r\n\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/5342/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5342/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1627701483",
    "html_url": "https://github.com/foundry-rs/foundry/issues/5342#issuecomment-1627701483",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5342",
    "id": 1627701483,
    "node_id": "IC_kwDOGBlvNc5hBMDr",
    "user": {
      "login": "spockP",
      "id": 135574263,
      "node_id": "U_kgDOCBSy9w",
      "avatar_url": "https://avatars.githubusercontent.com/u/135574263?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/spockP",
      "html_url": "https://github.com/spockP",
      "followers_url": "https://api.github.com/users/spockP/followers",
      "following_url": "https://api.github.com/users/spockP/following{/other_user}",
      "gists_url": "https://api.github.com/users/spockP/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/spockP/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/spockP/subscriptions",
      "organizations_url": "https://api.github.com/users/spockP/orgs",
      "repos_url": "https://api.github.com/users/spockP/repos",
      "events_url": "https://api.github.com/users/spockP/events{/privacy}",
      "received_events_url": "https://api.github.com/users/spockP/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-09T12:26:36Z",
    "updated_at": "2023-07-09T12:26:36Z",
    "author_association": "NONE",
    "body": "Just edited codes in the above description. If the difference between my two `UseLib` contracts is too small, [the matcher will fail to distinguish between them](https://github.com/foundry-rs/foundry/blob/8c4893233c7d54de3787227577cd0e3a4faa8945/common/src/contracts.rs#L99) (? possibly another issue? )\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1627701483/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
