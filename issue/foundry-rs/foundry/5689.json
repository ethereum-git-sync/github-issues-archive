{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/5689",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5689/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5689/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5689/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/5689",
  "id": 1859700399,
  "node_id": "I_kwDOGBlvNc5u2Mav",
  "number": 5689,
  "title": "Fuzz test gas in snapshot off by 1 gas",
  "user": {
    "login": "matYang",
    "id": 2754307,
    "node_id": "MDQ6VXNlcjI3NTQzMDc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2754307?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/matYang",
    "html_url": "https://github.com/matYang",
    "followers_url": "https://api.github.com/users/matYang/followers",
    "following_url": "https://api.github.com/users/matYang/following{/other_user}",
    "gists_url": "https://api.github.com/users/matYang/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/matYang/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/matYang/subscriptions",
    "organizations_url": "https://api.github.com/users/matYang/orgs",
    "repos_url": "https://api.github.com/users/matYang/repos",
    "events_url": "https://api.github.com/users/matYang/events{/privacy}",
    "received_events_url": "https://api.github.com/users/matYang/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3334394228,
      "node_id": "MDU6TGFiZWwzMzM0Mzk0MjI4",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-bug",
      "name": "T-bug",
      "color": "d73a4a",
      "default": false,
      "description": "Type: bug"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2023-08-21T16:08:03Z",
  "updated_at": "2023-09-04T11:22:23Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Component\n\nForge\n\n### Have you ensured that all of these are up to date?\n\n- [X] Foundry\n- [X] Foundryup\n\n### What version of Foundry are you on?\n\nforge 0.2.0 (b536f51 2023-08-21T00:25:51.452435000Z)\n\n### What command(s) is the bug in?\n\nforge snapshot --check\n\n### Operating System\n\nLinux\n\n### Describe the bug\n\nIn our CI workflow using Github actions:\r\n```\r\n      - name: Install Foundry\r\n        uses: foundry-rs/foundry-toolchain@v1\r\n        with:\r\n          version: nightly\r\n```\r\n\r\nWe check the present snapshot with `forge snapshot --check {{snapshot}}`.\r\nThis step is failing due to 1 fuzz test result:\r\n`Diff in \"...(address,address,uint96)\": consumed \"(runs: 256, μ: 213572, ~: 213547)\" gas, expected \"(runs: 256, μ: 213573, ~: 213548)\"`\r\n\r\nThe gas measured during CI is consistently lower by 1 than our local machine, i.e. 213572 vs 213573, and 213547 vs 213548.\r\n\r\nWe are using default number of fuzz runs.",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/5689/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5689/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1687466986",
    "html_url": "https://github.com/foundry-rs/foundry/issues/5689#issuecomment-1687466986",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5689",
    "id": 1687466986,
    "node_id": "IC_kwDOGBlvNc5klLPq",
    "user": {
      "login": "gakonst",
      "id": 17802178,
      "node_id": "MDQ6VXNlcjE3ODAyMTc4",
      "avatar_url": "https://avatars.githubusercontent.com/u/17802178?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gakonst",
      "html_url": "https://github.com/gakonst",
      "followers_url": "https://api.github.com/users/gakonst/followers",
      "following_url": "https://api.github.com/users/gakonst/following{/other_user}",
      "gists_url": "https://api.github.com/users/gakonst/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gakonst/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gakonst/subscriptions",
      "organizations_url": "https://api.github.com/users/gakonst/orgs",
      "repos_url": "https://api.github.com/users/gakonst/repos",
      "events_url": "https://api.github.com/users/gakonst/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gakonst/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-08-22T05:35:04Z",
    "updated_at": "2023-08-22T05:35:04Z",
    "author_association": "MEMBER",
    "body": "Which repo can we use to reproduce this? Thanks for reporting!",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1687466986/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1688822275",
    "html_url": "https://github.com/foundry-rs/foundry/issues/5689#issuecomment-1688822275",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5689",
    "id": 1688822275,
    "node_id": "IC_kwDOGBlvNc5kqWID",
    "user": {
      "login": "matYang",
      "id": 2754307,
      "node_id": "MDQ6VXNlcjI3NTQzMDc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2754307?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/matYang",
      "html_url": "https://github.com/matYang",
      "followers_url": "https://api.github.com/users/matYang/followers",
      "following_url": "https://api.github.com/users/matYang/following{/other_user}",
      "gists_url": "https://api.github.com/users/matYang/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/matYang/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/matYang/subscriptions",
      "organizations_url": "https://api.github.com/users/matYang/orgs",
      "repos_url": "https://api.github.com/users/matYang/repos",
      "events_url": "https://api.github.com/users/matYang/events{/privacy}",
      "received_events_url": "https://api.github.com/users/matYang/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-08-22T19:42:41Z",
    "updated_at": "2023-08-22T19:43:26Z",
    "author_association": "NONE",
    "body": "The complete repo is not open sourced yet, the contract source (without tests) is here:\r\nhttps://www.npmjs.com/package/@chainlink/contracts-ccip?activeTab=readme\r\n\r\nThe specific test causing issues is a fuzz test again EVM2EVMOnRamp.sol:\r\n`function testFuzz_ForwardFromRouterSuccess(address originalSender, address receiver, uint96 feeTokenAmount) public {...}`\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1688822275/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1690531882",
    "html_url": "https://github.com/foundry-rs/foundry/issues/5689#issuecomment-1690531882",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5689",
    "id": 1690531882,
    "node_id": "IC_kwDOGBlvNc5kw3gq",
    "user": {
      "login": "matYang",
      "id": 2754307,
      "node_id": "MDQ6VXNlcjI3NTQzMDc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2754307?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/matYang",
      "html_url": "https://github.com/matYang",
      "followers_url": "https://api.github.com/users/matYang/followers",
      "following_url": "https://api.github.com/users/matYang/following{/other_user}",
      "gists_url": "https://api.github.com/users/matYang/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/matYang/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/matYang/subscriptions",
      "organizations_url": "https://api.github.com/users/matYang/orgs",
      "repos_url": "https://api.github.com/users/matYang/repos",
      "events_url": "https://api.github.com/users/matYang/events{/privacy}",
      "received_events_url": "https://api.github.com/users/matYang/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-08-23T19:37:38Z",
    "updated_at": "2023-08-23T19:37:55Z",
    "author_association": "NONE",
    "body": "Nice, our ccip repo was made public today, the test causing the issue is here:\r\nhttps://github.com/smartcontractkit/ccip/blob/ccip-develop/contracts/src/v0.8/ccip/test/onRamp/EVM2EVMOnRamp.t.sol#L372\r\n\r\nto reproduce it,\r\n1. export FOUNDRY_PROFILE=ccip\r\n2. remove the 32 run inline-comment\r\n3. run the snapshot under /contracts locally\r\n4. compare it against the result in gh actions",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1690531882/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1705094827",
    "html_url": "https://github.com/foundry-rs/foundry/issues/5689#issuecomment-1705094827",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5689",
    "id": 1705094827,
    "node_id": "IC_kwDOGBlvNc5loa6r",
    "user": {
      "login": "RensR",
      "id": 5789419,
      "node_id": "MDQ6VXNlcjU3ODk0MTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5789419?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/RensR",
      "html_url": "https://github.com/RensR",
      "followers_url": "https://api.github.com/users/RensR/followers",
      "following_url": "https://api.github.com/users/RensR/following{/other_user}",
      "gists_url": "https://api.github.com/users/RensR/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/RensR/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/RensR/subscriptions",
      "organizations_url": "https://api.github.com/users/RensR/orgs",
      "repos_url": "https://api.github.com/users/RensR/repos",
      "events_url": "https://api.github.com/users/RensR/events{/privacy}",
      "received_events_url": "https://api.github.com/users/RensR/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-09-04T11:21:31Z",
    "updated_at": "2023-09-04T11:22:23Z",
    "author_association": "NONE",
    "body": "Any update on this? I'm hitting it more and more it seems. Made sure to `foundryup` and re-initialized the foundry dependencies locally but keep getting a diff with CI. This test isn't even off by one, but ~250 gas. [CI run](https://github.com/smartcontractkit/ccip/actions/runs/6071387587/job/16469343285?pr=92). \r\n\r\nCI ran on commit [64faf451b95b939406d068d37eaa3bb034d35250](https://github.com/smartcontractkit/ccip/pull/92/commits/64faf451b95b939406d068d37eaa3bb034d35250) in [this repo](https://github.com/smartcontractkit/ccip)\r\n\r\nHow to reproduce\r\n```\r\ncd contracts\r\nexport FOUNDRY_PROFILE=ccip && forge snapshot --snap gas-snapshots/ccip.gas-snapshot\r\n```\r\n\r\nCI:\r\n```\r\nRan 113 test suites: 432 tests passed, 0 failed, 0 skipped (432 total tests)\r\nDiff in \"EVM2EVMOnRamp_getTokenTransferCost::testFuzz_TokenTransferFeeDuplicateTokensSuccess(uint256,uint256)\": consumed \"(runs: 256, μ: 66371, ~: 66420)\" gas, expected \"(runs: 256, μ: 66623, ~: 66592)\" gas \r\nError: Process completed with exit code 1.\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1705094827/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
