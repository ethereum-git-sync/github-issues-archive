{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/4615",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4615/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4615/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4615/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/4615",
  "id": 1634149041,
  "node_id": "I_kwDOGBlvNc5hZyKx",
  "number": 4615,
  "title": "unexpected exit code on `forge build --sizes` for scripts",
  "user": {
    "login": "sakulstra",
    "id": 4396533,
    "node_id": "MDQ6VXNlcjQzOTY1MzM=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4396533?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/sakulstra",
    "html_url": "https://github.com/sakulstra",
    "followers_url": "https://api.github.com/users/sakulstra/followers",
    "following_url": "https://api.github.com/users/sakulstra/following{/other_user}",
    "gists_url": "https://api.github.com/users/sakulstra/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/sakulstra/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/sakulstra/subscriptions",
    "organizations_url": "https://api.github.com/users/sakulstra/orgs",
    "repos_url": "https://api.github.com/users/sakulstra/repos",
    "events_url": "https://api.github.com/users/sakulstra/events{/privacy}",
    "received_events_url": "https://api.github.com/users/sakulstra/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3334394228,
      "node_id": "MDU6TGFiZWwzMzM0Mzk0MjI4",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-bug",
      "name": "T-bug",
      "color": "d73a4a",
      "default": false,
      "description": "Type: bug"
    },
    {
      "id": 3703752787,
      "node_id": "LA_kwDOGBlvNc7cwshT",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/C-forge",
      "name": "C-forge",
      "color": "5319E7",
      "default": false,
      "description": "Command: forge"
    },
    {
      "id": 3777098561,
      "node_id": "LA_kwDOGBlvNc7hIfNB",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/Cmd-forge-build",
      "name": "Cmd-forge-build",
      "color": "006B75",
      "default": false,
      "description": "Command: forge build"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2023-03-21T15:19:18Z",
  "updated_at": "2023-03-21T20:14:46Z",
  "closed_at": "2023-03-21T20:14:46Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "### Component\r\n\r\nForge\r\n\r\n### Have you ensured that all of these are up to date?\r\n\r\n- [X] Foundry\r\n- [X] Foundryup\r\n\r\n### What version of Foundry are you on?\r\n\r\nforge 0.2.0 (d1c84e3 2023-03-13T00:07:48.790822528Z)\r\n\r\n### What command(s) is the bug in?\r\n\r\nforge build --sizes\r\n\r\n### Operating System\r\n\r\nLinux\r\n\r\n### Describe the bug\r\n\r\n`forge build --sizes` will exit with exit code `1`  when one of the exceed succeeds the codesizelimit.\r\n\r\nWhile this is a legitimate behavior for normal `contract`s, it's quite common to surpass codesizelimits in `Script/Tests`s as they will never be deployed, but instead perform multiple contract deployments.\r\n\r\nCurrently `forge build --sizes` doesn't consider this \"special cases\" but simply errors. I think the correct behavior would be to ignore codesizelimit on these two special cases.\r\n\r\n- Discussed in https://github.com/foundry-rs/foundry/discussions/4285",
  "closed_by": {
    "login": "sakulstra",
    "id": 4396533,
    "node_id": "MDQ6VXNlcjQzOTY1MzM=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4396533?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/sakulstra",
    "html_url": "https://github.com/sakulstra",
    "followers_url": "https://api.github.com/users/sakulstra/followers",
    "following_url": "https://api.github.com/users/sakulstra/following{/other_user}",
    "gists_url": "https://api.github.com/users/sakulstra/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/sakulstra/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/sakulstra/subscriptions",
    "organizations_url": "https://api.github.com/users/sakulstra/orgs",
    "repos_url": "https://api.github.com/users/sakulstra/repos",
    "events_url": "https://api.github.com/users/sakulstra/events{/privacy}",
    "received_events_url": "https://api.github.com/users/sakulstra/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/4615/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4615/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1478089628",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4615#issuecomment-1478089628",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4615",
    "id": 1478089628,
    "node_id": "IC_kwDOGBlvNc5YGduc",
    "user": {
      "login": "mds1",
      "id": 17163988,
      "node_id": "MDQ6VXNlcjE3MTYzOTg4",
      "avatar_url": "https://avatars.githubusercontent.com/u/17163988?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mds1",
      "html_url": "https://github.com/mds1",
      "followers_url": "https://api.github.com/users/mds1/followers",
      "following_url": "https://api.github.com/users/mds1/following{/other_user}",
      "gists_url": "https://api.github.com/users/mds1/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mds1/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mds1/subscriptions",
      "organizations_url": "https://api.github.com/users/mds1/orgs",
      "repos_url": "https://api.github.com/users/mds1/repos",
      "events_url": "https://api.github.com/users/mds1/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mds1/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-21T15:53:04Z",
    "updated_at": "2023-03-21T15:53:04Z",
    "author_association": "COLLABORATOR",
    "body": "Do you have a repo to reproduce on? Test and script contracts should be excluded from the size report, per\r\n\r\nhttps://github.com/foundry-rs/foundry/blob/ffa038b73ad3035996bd71eebdff60473bb6fd33/common/src/compile.rs#L150-L160",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1478089628/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1478270869",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4615#issuecomment-1478270869",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4615",
    "id": 1478270869,
    "node_id": "IC_kwDOGBlvNc5YHJ-V",
    "user": {
      "login": "sakulstra",
      "id": 4396533,
      "node_id": "MDQ6VXNlcjQzOTY1MzM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4396533?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sakulstra",
      "html_url": "https://github.com/sakulstra",
      "followers_url": "https://api.github.com/users/sakulstra/followers",
      "following_url": "https://api.github.com/users/sakulstra/following{/other_user}",
      "gists_url": "https://api.github.com/users/sakulstra/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sakulstra/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sakulstra/subscriptions",
      "organizations_url": "https://api.github.com/users/sakulstra/orgs",
      "repos_url": "https://api.github.com/users/sakulstra/repos",
      "events_url": "https://api.github.com/users/sakulstra/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sakulstra/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-21T17:03:21Z",
    "updated_at": "2023-03-21T17:03:21Z",
    "author_association": "CONTRIBUTOR",
    "body": "@mds1 sadly it's all on private repos, so cannot share right now.\r\n\r\nThat said i looked into the code before and didn't see this so probably it's just some weird patterns we're having causing this. As we want to use the scripts within tests without broadcast we tend doing stuff like.\r\n\r\n\r\n```solidity\r\ncontract CommonDeployer {\r\n  function _deploy() internal {\r\n    do a lot of stuff\r\n  }\r\n}\r\n\r\ncontract PolygonDeployer is Script,CommonDeployer {\r\n  function run() public {\r\n    vm.startBroadcast();\r\n    _deploy();\r\n    vm.stopBroadcast();\r\n  }\r\n}\r\n```\r\n\r\nSo in this case the violating contract would be `CommonDeployer` which is not actually a script (but only used within scripts)... now that i know that in theory it works, i can work around it :sweat_smile: by inheriting script as well i guess.\r\nThx for the quick response, not sure if there's sth to fix then. ",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1478270869/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1478457150",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4615#issuecomment-1478457150",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4615",
    "id": 1478457150,
    "node_id": "IC_kwDOGBlvNc5YH3c-",
    "user": {
      "login": "mds1",
      "id": 17163988,
      "node_id": "MDQ6VXNlcjE3MTYzOTg4",
      "avatar_url": "https://avatars.githubusercontent.com/u/17163988?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mds1",
      "html_url": "https://github.com/mds1",
      "followers_url": "https://api.github.com/users/mds1/followers",
      "following_url": "https://api.github.com/users/mds1/following{/other_user}",
      "gists_url": "https://api.github.com/users/mds1/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mds1/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mds1/subscriptions",
      "organizations_url": "https://api.github.com/users/mds1/orgs",
      "repos_url": "https://api.github.com/users/mds1/repos",
      "events_url": "https://api.github.com/users/mds1/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mds1/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-21T19:20:11Z",
    "updated_at": "2023-03-21T19:20:11Z",
    "author_association": "COLLABORATOR",
    "body": "A workaround is to just add `bool public IS_SCRIPT = true;` to the `CommonDeployer` — this isn't used anywhere else afaik so it shouldn't cause any issues.\r\n\r\nAnother thing you could do is just merge `PolygonDeployer` and `CommonDeployer` into a single contract so it is a script, and then in your test you do `MyTest is Test, PolygonDeployer` and call `PolygonDeployer.run()` in setup, and the broadcasts basically just act like pranks",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1478457150/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 1,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
