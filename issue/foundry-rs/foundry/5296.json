{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/5296",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5296/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5296/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5296/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/5296",
  "id": 1788432188,
  "node_id": "I_kwDOGBlvNc5qmU88",
  "number": 5296,
  "title": "Etherscan sources compilation issues",
  "user": {
    "login": "klkvr",
    "id": 62447812,
    "node_id": "MDQ6VXNlcjYyNDQ3ODEy",
    "avatar_url": "https://avatars.githubusercontent.com/u/62447812?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/klkvr",
    "html_url": "https://github.com/klkvr",
    "followers_url": "https://api.github.com/users/klkvr/followers",
    "following_url": "https://api.github.com/users/klkvr/following{/other_user}",
    "gists_url": "https://api.github.com/users/klkvr/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/klkvr/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/klkvr/subscriptions",
    "organizations_url": "https://api.github.com/users/klkvr/orgs",
    "repos_url": "https://api.github.com/users/klkvr/repos",
    "events_url": "https://api.github.com/users/klkvr/events{/privacy}",
    "received_events_url": "https://api.github.com/users/klkvr/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3334394228,
      "node_id": "MDU6TGFiZWwzMzM0Mzk0MjI4",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-bug",
      "name": "T-bug",
      "color": "d73a4a",
      "default": false,
      "description": "Type: bug"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2023-07-04T20:21:33Z",
  "updated_at": "2023-07-18T21:30:15Z",
  "closed_at": "2023-07-18T21:30:15Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "### Component\r\n\r\nForge, Cast, Chisel\r\n\r\n### Have you ensured that all of these are up to date?\r\n\r\n- [X] Foundry\r\n- [X] Foundryup\r\n\r\n### What version of Foundry are you on?\r\n\r\nforge 0.2.0 (42fb694 2023-07-04T00:04:51.760418000Z)\r\n\r\n### What command(s) is the bug in?\r\n\r\ncast storage, cast run, all forge/chisel commands using etherscan traces\r\n\r\n### Operating System\r\n\r\nmacOS (Apple Silicon)\r\n\r\n### Describe the bug\r\n\r\n## Issue description\r\nThis bug has already been mentioned in #5225 but it only mentioned for `cast run --debug`. In fact, the issue itself lies in [common/src/compile](https://github.com/foundry-rs/foundry/blob/master/common/src/compile.rs) and affects all functionality which compiles contract from etherscan sources which is `cast run --debug` `cast storage` and all forge/chisel commands which are using etherscan for traces display\r\n\r\nThis issue occurs when contract from etherscan has remappings which are not listed in \"remappings\" section.\r\nOne example of such contract is [Stargate router](https://polygonscan.com/address/0x45a01e4e04f14f7a4a6702c74187c5f6222033cd#code) on Polygon. It uses `@layerzerolabs` remapping which is not specified in remappings section (can be checked via ctrl+f [here](https://api.polygonscan.com/api?module=contract&action=getsourcecode&address=0x45a01e4e04f14f7a4a6702c74187c5f6222033cd&apikey=YourApiKeyToken))\r\n\r\nWhen temporary forge project is getting constructed in [etherscan_project function](https://github.com/foundry-rs/foundry/blob/master/common/src/compile.rs#L431L), it will have following structure:\r\n```\r\nroot/   <- forge project root\r\n    Router/   <- forge project src\r\n        @layerzerolabs/\r\n              contracts/contracts/interfaces/\r\n                  ILayerZeroReceiver.sol\r\n        contracts/\r\n              Router.sol  <- (contains import \"@layerzerolabs/contracts/contracts/interfaces/ILayerZeroReceiver.sol\")\r\n```\r\n\r\nSuch structure will lead to imports starting with `@layerzerolabs` not being resolved:\r\n```\r\n$ cast storage 0x45A01E4e04F14f7A4a6702c74187c5F6222033cd --rpc-url polygon\r\nNo matching artifacts found, fetching source code from Etherscan...\r\nError: \r\nCompiler run failed:\r\nError (6275): Source \"@layerzerolabs/contracts/contracts/interfaces/ILayerZeroReceiver.sol\" not found: File not found.\r\nimport \"@layerzerolabs/contracts/contracts/interfaces/ILayerZeroReceiver.sol\";\r\n^----------------------------------------------------------------------------^\r\n```\r\n## Possible solutions\r\n1. Make `Router` a root directory. RIght now `root` is a root folder and `Router` is src folder (in terms of forge). If `@layerzerolabs` directory will be stored in root project folder, forge will be able to resolve above imports. This can be done by changing `etherscan_project` function:\r\n\r\nbefore:\r\n```rust\r\nlet paths = ProjectPathsConfig::builder()\r\n        .sources(sources_path)\r\n        .remappings(settings.remappings.clone())\r\n        .build_with_root(target_path);\r\n```\r\nafter:\r\n```rust\r\nlet paths = ProjectPathsConfig::builder()\r\n        .sources(sources_path.clone())\r\n        .remappings(settings.remappings.clone())\r\n        .build_with_root(sources_path);\r\n```\r\n\r\nI changed this and tested locally, it seem to be a working fix. But I am not aware of caveats of having same src and root folder via forge, so not sure if it is the best possible option\r\n\r\n2. Another possible fix is to add all source code paths returned by etherscan into remappings. In this case we would have to add following remapping:\r\n```\r\n@layerzerolabs/contracts/contracts/interfaces/ILayerZeroReceiver.sol=/path/to/root/Router/@layerzerolabs/contracts/contracts/interfaces/ILayerZeroReceiver.sol\r\n``` \r\nI wasn't able to make this work locally, but you can give it a try if it seems to be a good solution\r\n\r\n\r\n",
  "closed_by": {
    "login": "Evalir",
    "id": 26014927,
    "node_id": "MDQ6VXNlcjI2MDE0OTI3",
    "avatar_url": "https://avatars.githubusercontent.com/u/26014927?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Evalir",
    "html_url": "https://github.com/Evalir",
    "followers_url": "https://api.github.com/users/Evalir/followers",
    "following_url": "https://api.github.com/users/Evalir/following{/other_user}",
    "gists_url": "https://api.github.com/users/Evalir/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Evalir/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Evalir/subscriptions",
    "organizations_url": "https://api.github.com/users/Evalir/orgs",
    "repos_url": "https://api.github.com/users/Evalir/repos",
    "events_url": "https://api.github.com/users/Evalir/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Evalir/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/5296/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5296/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1641018966",
    "html_url": "https://github.com/foundry-rs/foundry/issues/5296#issuecomment-1641018966",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5296",
    "id": 1641018966,
    "node_id": "IC_kwDOGBlvNc5hz_ZW",
    "user": {
      "login": "Evalir",
      "id": 26014927,
      "node_id": "MDQ6VXNlcjI2MDE0OTI3",
      "avatar_url": "https://avatars.githubusercontent.com/u/26014927?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Evalir",
      "html_url": "https://github.com/Evalir",
      "followers_url": "https://api.github.com/users/Evalir/followers",
      "following_url": "https://api.github.com/users/Evalir/following{/other_user}",
      "gists_url": "https://api.github.com/users/Evalir/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Evalir/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Evalir/subscriptions",
      "organizations_url": "https://api.github.com/users/Evalir/orgs",
      "repos_url": "https://api.github.com/users/Evalir/repos",
      "events_url": "https://api.github.com/users/Evalir/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Evalir/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-18T21:30:15Z",
    "updated_at": "2023-07-18T21:30:15Z",
    "author_association": "MEMBER",
    "body": "Closed by #5393 ",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1641018966/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
