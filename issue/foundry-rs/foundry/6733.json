{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/6733",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/6733/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/6733/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/6733/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/6733",
  "id": 2072288564,
  "node_id": "I_kwDOGBlvNc57hJ00",
  "number": 6733,
  "title": "Nightly consumes much more memory",
  "user": {
    "login": "lnist",
    "id": 16150076,
    "node_id": "MDQ6VXNlcjE2MTUwMDc2",
    "avatar_url": "https://avatars.githubusercontent.com/u/16150076?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/lnist",
    "html_url": "https://github.com/lnist",
    "followers_url": "https://api.github.com/users/lnist/followers",
    "following_url": "https://api.github.com/users/lnist/following{/other_user}",
    "gists_url": "https://api.github.com/users/lnist/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/lnist/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/lnist/subscriptions",
    "organizations_url": "https://api.github.com/users/lnist/orgs",
    "repos_url": "https://api.github.com/users/lnist/repos",
    "events_url": "https://api.github.com/users/lnist/events{/privacy}",
    "received_events_url": "https://api.github.com/users/lnist/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3334394228,
      "node_id": "MDU6TGFiZWwzMzM0Mzk0MjI4",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-bug",
      "name": "T-bug",
      "color": "d73a4a",
      "default": false,
      "description": "Type: bug"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2024-01-09T12:32:57Z",
  "updated_at": "2024-01-09T15:09:58Z",
  "closed_at": "2024-01-09T14:32:40Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Component\r\n\r\nAnvil\r\n\r\n### Have you ensured that all of these are up to date?\r\n\r\n- [X] Foundry\r\n- [X] Foundryup\r\n\r\n### What version of Foundry are you on?\r\n\r\nforge 0.2.0 (d46bcb3 2024-01-09T00:21:10.755521772Z)\r\n\r\n### What command(s) is the bug in?\r\n\r\n_No response_\r\n\r\n### Operating System\r\n\r\nLinux\r\n\r\n### Describe the bug\r\n\r\nWhen running our test suite we see a significant increase in memory consumption from anvil, to the point where tests start consuming >40gb and anvil dies due to out of memory while previously they used <2gb (tested with eye-inspection of htop and prior and latest nightly builds).\r\nThe prior version which works is `nightly-02292f2d2caa547968bd039c06dc53d98b72bf39`.\r\n\r\nNote the tests in question are TypeScript tests running via ethers.js 5.\r\n\r\n ",
  "closed_by": {
    "login": "mattsse",
    "id": 19890894,
    "node_id": "MDQ6VXNlcjE5ODkwODk0",
    "avatar_url": "https://avatars.githubusercontent.com/u/19890894?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mattsse",
    "html_url": "https://github.com/mattsse",
    "followers_url": "https://api.github.com/users/mattsse/followers",
    "following_url": "https://api.github.com/users/mattsse/following{/other_user}",
    "gists_url": "https://api.github.com/users/mattsse/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mattsse/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mattsse/subscriptions",
    "organizations_url": "https://api.github.com/users/mattsse/orgs",
    "repos_url": "https://api.github.com/users/mattsse/repos",
    "events_url": "https://api.github.com/users/mattsse/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mattsse/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/6733/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/6733/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1883039000",
    "html_url": "https://github.com/foundry-rs/foundry/issues/6733#issuecomment-1883039000",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/6733",
    "id": 1883039000,
    "node_id": "IC_kwDOGBlvNc5wPOUY",
    "user": {
      "login": "mattsse",
      "id": 19890894,
      "node_id": "MDQ6VXNlcjE5ODkwODk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/19890894?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mattsse",
      "html_url": "https://github.com/mattsse",
      "followers_url": "https://api.github.com/users/mattsse/followers",
      "following_url": "https://api.github.com/users/mattsse/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattsse/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mattsse/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattsse/subscriptions",
      "organizations_url": "https://api.github.com/users/mattsse/orgs",
      "repos_url": "https://api.github.com/users/mattsse/repos",
      "events_url": "https://api.github.com/users/mattsse/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mattsse/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2024-01-09T13:13:57Z",
    "updated_at": "2024-01-09T13:13:57Z",
    "author_association": "MEMBER",
    "body": "this could be a regression caused by https://github.com/foundry-rs/foundry/pull/6219\r\n\r\ncould you perhaps provide more info about what kind of requests you send to anvil?\r\n\r\nthis could be a tracing issue",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1883039000/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1883093971",
    "html_url": "https://github.com/foundry-rs/foundry/issues/6733#issuecomment-1883093971",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/6733",
    "id": 1883093971,
    "node_id": "IC_kwDOGBlvNc5wPbvT",
    "user": {
      "login": "lnist",
      "id": 16150076,
      "node_id": "MDQ6VXNlcjE2MTUwMDc2",
      "avatar_url": "https://avatars.githubusercontent.com/u/16150076?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/lnist",
      "html_url": "https://github.com/lnist",
      "followers_url": "https://api.github.com/users/lnist/followers",
      "following_url": "https://api.github.com/users/lnist/following{/other_user}",
      "gists_url": "https://api.github.com/users/lnist/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/lnist/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/lnist/subscriptions",
      "organizations_url": "https://api.github.com/users/lnist/orgs",
      "repos_url": "https://api.github.com/users/lnist/repos",
      "events_url": "https://api.github.com/users/lnist/events{/privacy}",
      "received_events_url": "https://api.github.com/users/lnist/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2024-01-09T13:58:17Z",
    "updated_at": "2024-01-09T13:58:17Z",
    "author_association": "NONE",
    "body": "Thanks for the quick reply :) \r\n\r\nYes, I indeed think it is a regression caused by that PR.\r\n\r\nThe tests are integration tests, so they do quite a lot of things to set up an environment of contracts.\r\n\r\nThe tests that fail with out of memory are sending TXs that consume almost an entire block of 30.000.000 gas, while in parallel invoking get_logs to keep caches up to date from events. Some TXs have quite large calldata.\r\nIf I disable the get_logs calls the tests just barely succeed, but still consume a lot more memory than before ~30gb.\r\n\r\nI'll happily send a trace of all the requests to anvil if it helps - in that case, does anvil have a way to log all RPC calls in a replayable format?\r\n\r\nThe sure way to repro this is to `git clone https://github.com/mangrovedao/mangrove.js.git` then `yarn install && yarn build`, start an anvil on port 8546 and run `MGV_NODE_SPAWN=false yarn test:integration --jobs 0 -- -g \"Kandel MaxOffersInChunk verification\"` (if you have yarn)",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1883093971/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1883229453",
    "html_url": "https://github.com/foundry-rs/foundry/issues/6733#issuecomment-1883229453",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/6733",
    "id": 1883229453,
    "node_id": "IC_kwDOGBlvNc5wP80N",
    "user": {
      "login": "lnist",
      "id": 16150076,
      "node_id": "MDQ6VXNlcjE2MTUwMDc2",
      "avatar_url": "https://avatars.githubusercontent.com/u/16150076?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/lnist",
      "html_url": "https://github.com/lnist",
      "followers_url": "https://api.github.com/users/lnist/followers",
      "following_url": "https://api.github.com/users/lnist/following{/other_user}",
      "gists_url": "https://api.github.com/users/lnist/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/lnist/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/lnist/subscriptions",
      "organizations_url": "https://api.github.com/users/lnist/orgs",
      "repos_url": "https://api.github.com/users/lnist/repos",
      "events_url": "https://api.github.com/users/lnist/events{/privacy}",
      "received_events_url": "https://api.github.com/users/lnist/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2024-01-09T15:09:57Z",
    "updated_at": "2024-01-09T15:09:57Z",
    "author_association": "NONE",
    "body": "Fix confirmed, thanks!",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1883229453/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
