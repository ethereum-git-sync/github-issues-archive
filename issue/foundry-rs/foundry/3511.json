{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/3511",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3511/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3511/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3511/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/3511",
  "id": 1413809836,
  "node_id": "I_kwDOGBlvNc5URQas",
  "number": 3511,
  "title": "Anvil Doesn't Respect ChainID",
  "user": {
    "login": "kristian1108",
    "id": 26528376,
    "node_id": "MDQ6VXNlcjI2NTI4Mzc2",
    "avatar_url": "https://avatars.githubusercontent.com/u/26528376?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/kristian1108",
    "html_url": "https://github.com/kristian1108",
    "followers_url": "https://api.github.com/users/kristian1108/followers",
    "following_url": "https://api.github.com/users/kristian1108/following{/other_user}",
    "gists_url": "https://api.github.com/users/kristian1108/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/kristian1108/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/kristian1108/subscriptions",
    "organizations_url": "https://api.github.com/users/kristian1108/orgs",
    "repos_url": "https://api.github.com/users/kristian1108/repos",
    "events_url": "https://api.github.com/users/kristian1108/events{/privacy}",
    "received_events_url": "https://api.github.com/users/kristian1108/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3334394228,
      "node_id": "MDU6TGFiZWwzMzM0Mzk0MjI4",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-bug",
      "name": "T-bug",
      "color": "d73a4a",
      "default": false,
      "description": "Type: bug"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2022-10-18T20:32:48Z",
  "updated_at": "2022-10-19T17:28:23Z",
  "closed_at": "2022-10-19T17:28:23Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "### Component\r\n\r\nAnvil\r\n\r\n### Have you ensured that all of these are up to date?\r\n\r\n- [X] Foundry\r\n- [X] Foundryup\r\n\r\n### What version of Foundry are you on?\r\n\r\nforge 0.2.0 (fb4a836 2022-10-18T00:07:33.891597Z)\r\n\r\n### What command(s) is the bug in?\r\n\r\nanvil --chain-id 10\r\n\r\n### Operating System\r\n\r\nmacOS (Apple Silicon)\r\n\r\n### Describe the bug\r\n\r\nThe Anvil dev chain does not respect the chain-id of a signed transaction. You can run anvil with multiple different chain-ids and successfully submit the same signed transaction to different chains.\r\n\r\nHere's some code:\r\n\r\n```\r\nconst Web3 = require('web3');\r\nconst ethers = require(\"ethers\");\r\n\r\nasync function main() {\r\n\tconst anvilEndpoint = \"http://127.0.0.1:8545\";\r\n\tconst anvilProvider = new Web3.providers.HttpProvider(anvilEndpoint);\r\n\tconst provider = new ethers.providers.Web3Provider(anvilProvider);\r\n\r\n\r\n\t// YOU CAN UNCOMMENT ALL THIS CODE IF YOU WANT TO RE-SIGN THE TRANSACTION\r\n\t// const signer = new ethers.Wallet(\"0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80\", provider);\r\n\t//\r\n\t// let gas_price = await signer.getGasPrice();\r\n\t// let nonce = await signer.getTransactionCount(\"latest\");\r\n\t// let gas_limit = 100000;\r\n\t//\r\n\t// const tx = {\r\n\t// \tfrom: \"0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266\",\r\n\t// \tto: \"0x1c12650323489bb4c3b31bcfd47bc131abede5f6\",\r\n\t// \tvalue: \"0x000000000000000000000000000000000000000000000000008e1bc9bf040000\",\r\n\t// \tnonce: nonce,\r\n\t// \tgasLimit: ethers.utils.hexlify(gas_limit),\r\n\t// \tgasPrice: gas_price,\r\n\t// }\r\n\t//\r\n\t// console.log(await signer.signTransaction(tx));\r\n\r\n\r\n\t// THIS CODE JUST SUBMITS THE SAME SIGNED TRANSACTION TO THE NETWORK WITH ONE OF THE ANVIL GENESIS ACCOUNTS\r\n\tconst result = await provider.sendTransaction(\"0xf86b808477359400830186a0941c12650323489bb4c3b31bcfd47bc131abede5f6878e1bc9bf040000801ca02d87709b7597594a454a34a2f36fa27d7dfcb030e3e3b56b516bbd6d5868098da01d861f7c63f69df4ba794468471cd4afbd7772c46bf5d24ebd87081f0d036bef\");\r\n\tconst balance = await provider.getBalance(\"0x1c12650323489bb4c3b31bcfd47bc131abede5f6\");\r\n\tconsole.log(result);\r\n\r\n\t// HERE YOU CAN SEE THE TX IS SUCCESSFUL AND THE BALANCE IS UPDATED\r\n\tconsole.log(balance);\r\n}\r\n\r\nmain().catch((error) => {\r\n\tconsole.error(error);\r\n\tprocess.exitCode = 1;\r\n});\r\n```\r\n\r\nIf you point this code at multiple different Anvil chains, they all succeed. \r\n\r\nFor example:\r\n\r\n`anvil --chain-id 11`\r\n`anvil --chain-id 12`\r\n`anvil --chain-id 123`",
  "closed_by": {
    "login": "kristian1108",
    "id": 26528376,
    "node_id": "MDQ6VXNlcjI2NTI4Mzc2",
    "avatar_url": "https://avatars.githubusercontent.com/u/26528376?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/kristian1108",
    "html_url": "https://github.com/kristian1108",
    "followers_url": "https://api.github.com/users/kristian1108/followers",
    "following_url": "https://api.github.com/users/kristian1108/following{/other_user}",
    "gists_url": "https://api.github.com/users/kristian1108/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/kristian1108/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/kristian1108/subscriptions",
    "organizations_url": "https://api.github.com/users/kristian1108/orgs",
    "repos_url": "https://api.github.com/users/kristian1108/repos",
    "events_url": "https://api.github.com/users/kristian1108/events{/privacy}",
    "received_events_url": "https://api.github.com/users/kristian1108/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/3511/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3511/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1282983617",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3511#issuecomment-1282983617",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3511",
    "id": 1282983617,
    "node_id": "IC_kwDOGBlvNc5MeMbB",
    "user": {
      "login": "mattsse",
      "id": 19890894,
      "node_id": "MDQ6VXNlcjE5ODkwODk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/19890894?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mattsse",
      "html_url": "https://github.com/mattsse",
      "followers_url": "https://api.github.com/users/mattsse/followers",
      "following_url": "https://api.github.com/users/mattsse/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattsse/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mattsse/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattsse/subscriptions",
      "organizations_url": "https://api.github.com/users/mattsse/orgs",
      "repos_url": "https://api.github.com/users/mattsse/repos",
      "events_url": "https://api.github.com/users/mattsse/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mattsse/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-10-18T20:44:53Z",
    "updated_at": "2022-10-18T20:44:53Z",
    "author_association": "MEMBER",
    "body": "this check is implemented here\r\n\r\nhttps://github.com/foundry-rs/foundry/blob/870da6f73ee6ede429ed5742bb91eed3121071e3/anvil/src/eth/backend/mem/mod.rs#L1777-L1791\r\n\r\nunsure what's wrong",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1282983617/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1282993656",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3511#issuecomment-1282993656",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3511",
    "id": 1282993656,
    "node_id": "IC_kwDOGBlvNc5MeO34",
    "user": {
      "login": "kristian1108",
      "id": 26528376,
      "node_id": "MDQ6VXNlcjI2NTI4Mzc2",
      "avatar_url": "https://avatars.githubusercontent.com/u/26528376?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/kristian1108",
      "html_url": "https://github.com/kristian1108",
      "followers_url": "https://api.github.com/users/kristian1108/followers",
      "following_url": "https://api.github.com/users/kristian1108/following{/other_user}",
      "gists_url": "https://api.github.com/users/kristian1108/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/kristian1108/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/kristian1108/subscriptions",
      "organizations_url": "https://api.github.com/users/kristian1108/orgs",
      "repos_url": "https://api.github.com/users/kristian1108/repos",
      "events_url": "https://api.github.com/users/kristian1108/events{/privacy}",
      "received_events_url": "https://api.github.com/users/kristian1108/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-10-18T20:55:34Z",
    "updated_at": "2022-10-18T20:55:34Z",
    "author_association": "CONTRIBUTOR",
    "body": "That check only catches an issue when you explicitly set the wrong chainId in a transaction. If you just use the default `fill_transaction` method, the chainId is set to be whatever the wallet is (a sensible default). \r\n\r\nBut if the actual chainId (on the network) is different from the chainId used to fill and sign these transactions, the network rejects the transaction with the `Error: Returned error: invalid sender` error. This rejection occurs on Goerli and Mainnet, at least... as it should because if a tx is submitted to a network with a different chainId than the one in the signature, that's a huge problem.\r\n\r\nBut Anvil doesn't respect these rules. You can fill & sign a tx with chainId 10, then submit to a local Anvil with chainId 140, and Anvil is totally happy.\r\n\r\nIn other words, this check shouldn't happen _just_ in the signature code. It should happen in the network/consensus code.",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1282993656/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1282995103",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3511#issuecomment-1282995103",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3511",
    "id": 1282995103,
    "node_id": "IC_kwDOGBlvNc5MePOf",
    "user": {
      "login": "kristian1108",
      "id": 26528376,
      "node_id": "MDQ6VXNlcjI2NTI4Mzc2",
      "avatar_url": "https://avatars.githubusercontent.com/u/26528376?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/kristian1108",
      "html_url": "https://github.com/kristian1108",
      "followers_url": "https://api.github.com/users/kristian1108/followers",
      "following_url": "https://api.github.com/users/kristian1108/following{/other_user}",
      "gists_url": "https://api.github.com/users/kristian1108/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/kristian1108/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/kristian1108/subscriptions",
      "organizations_url": "https://api.github.com/users/kristian1108/orgs",
      "repos_url": "https://api.github.com/users/kristian1108/repos",
      "events_url": "https://api.github.com/users/kristian1108/events{/privacy}",
      "received_events_url": "https://api.github.com/users/kristian1108/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-10-18T20:57:09Z",
    "updated_at": "2022-10-18T20:57:09Z",
    "author_association": "CONTRIBUTOR",
    "body": "To be fair, Ganache also seems to have this problem. So maybe this is just a design decision made by local dev networks? That seems pretty weird to me as a choice. Or maybe I'm missing something?",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1282995103/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1283032225",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3511#issuecomment-1283032225",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3511",
    "id": 1283032225,
    "node_id": "IC_kwDOGBlvNc5MeYSh",
    "user": {
      "login": "mattsse",
      "id": 19890894,
      "node_id": "MDQ6VXNlcjE5ODkwODk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/19890894?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mattsse",
      "html_url": "https://github.com/mattsse",
      "followers_url": "https://api.github.com/users/mattsse/followers",
      "following_url": "https://api.github.com/users/mattsse/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattsse/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mattsse/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattsse/subscriptions",
      "organizations_url": "https://api.github.com/users/mattsse/orgs",
      "repos_url": "https://api.github.com/users/mattsse/repos",
      "events_url": "https://api.github.com/users/mattsse/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mattsse/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-10-18T21:35:34Z",
    "updated_at": "2022-10-18T21:44:03Z",
    "author_association": "MEMBER",
    "body": "looks like the transaction's v value is 28? meaning the signer does not support https://github.com/ethereum/EIPs/blob/master/EIPS/eip-155.md\r\n\r\nthen this makes sense as the chain id is not recovered.\r\n\r\n\r\n```rust\r\n   TransactionRequest {\r\n        from: Some(\r\n            0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266,\r\n        ),\r\n        to: Some(\r\n            Address(\r\n                0x1c12650323489bb4c3b31bcfd47bc131abede5f6,\r\n            ),\r\n        ),\r\n        gas: Some(\r\n            100000,\r\n        ),\r\n        gas_price: Some(\r\n            2000000000,\r\n        ),\r\n        value: Some(\r\n            40000000000000000,\r\n        ),\r\n        data: None,\r\n        nonce: Some(\r\n            0,\r\n        ),\r\n        chain_id: None,\r\n    },\r\n    Signature {\r\n        r: 20593379726758442718737209640354569628072124594877983577508894593403337574797,\r\n        s: 13354047423292535228067817098633699089176726334208540744303150057177898773487,\r\n        v: 28,\r\n    },\r\n)\r\n\r\n\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1283032225/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1284347573",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3511#issuecomment-1284347573",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3511",
    "id": 1284347573,
    "node_id": "IC_kwDOGBlvNc5MjZa1",
    "user": {
      "login": "kristian1108",
      "id": 26528376,
      "node_id": "MDQ6VXNlcjI2NTI4Mzc2",
      "avatar_url": "https://avatars.githubusercontent.com/u/26528376?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/kristian1108",
      "html_url": "https://github.com/kristian1108",
      "followers_url": "https://api.github.com/users/kristian1108/followers",
      "following_url": "https://api.github.com/users/kristian1108/following{/other_user}",
      "gists_url": "https://api.github.com/users/kristian1108/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/kristian1108/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/kristian1108/subscriptions",
      "organizations_url": "https://api.github.com/users/kristian1108/orgs",
      "repos_url": "https://api.github.com/users/kristian1108/repos",
      "events_url": "https://api.github.com/users/kristian1108/events{/privacy}",
      "received_events_url": "https://api.github.com/users/kristian1108/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-10-19T17:28:23Z",
    "updated_at": "2022-10-19T17:28:23Z",
    "author_association": "CONTRIBUTOR",
    "body": "This turned out to be a version issue. You may need to upgrade your Anvil dependency if you're test chain is not respecting the chain-id",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1284347573/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
