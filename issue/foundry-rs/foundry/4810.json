{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/4810",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4810/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4810/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4810/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/4810",
  "id": 1680041975,
  "node_id": "I_kwDOGBlvNc5kI2f3",
  "number": 4810,
  "title": "Create2 deployment by script does not use create2 to deploy libraries",
  "user": {
    "login": "Flydexo",
    "id": 66029824,
    "node_id": "MDQ6VXNlcjY2MDI5ODI0",
    "avatar_url": "https://avatars.githubusercontent.com/u/66029824?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Flydexo",
    "html_url": "https://github.com/Flydexo",
    "followers_url": "https://api.github.com/users/Flydexo/followers",
    "following_url": "https://api.github.com/users/Flydexo/following{/other_user}",
    "gists_url": "https://api.github.com/users/Flydexo/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Flydexo/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Flydexo/subscriptions",
    "organizations_url": "https://api.github.com/users/Flydexo/orgs",
    "repos_url": "https://api.github.com/users/Flydexo/repos",
    "events_url": "https://api.github.com/users/Flydexo/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Flydexo/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3334394228,
      "node_id": "MDU6TGFiZWwzMzM0Mzk0MjI4",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-bug",
      "name": "T-bug",
      "color": "d73a4a",
      "default": false,
      "description": "Type: bug"
    },
    {
      "id": 3703752787,
      "node_id": "LA_kwDOGBlvNc7cwshT",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/C-forge",
      "name": "C-forge",
      "color": "5319E7",
      "default": false,
      "description": "Command: forge"
    },
    {
      "id": 4182991461,
      "node_id": "LA_kwDOGBlvNc75U2Jl",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/Cmd-forge-script",
      "name": "Cmd-forge-script",
      "color": "006B75",
      "default": false,
      "description": "Command: forge script"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2023-04-23T14:13:03Z",
  "updated_at": "2023-04-24T17:42:37Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Component\r\n\r\nForge\r\n\r\n### Have you ensured that all of these are up to date?\r\n\r\n- [x] Foundry\r\n- [x] Foundryup\r\n\r\n### What version of Foundry are you on?\r\n\r\nforge 0.2.0 (c49e5e1 2023-04-09T00:16:17.106319000Z)\r\n\r\n### What command(s) is the bug in?\r\n\r\nforge script\r\n\r\n### Operating System\r\n\r\nmacOS (Apple Silicon)\r\n\r\n### Describe the bug\r\n\r\nI have the following deployment script\r\n\r\n```sol\r\n// SPDX-License-Indetifier: SEE LICENSE IN LICENSE\r\n\r\npragma solidity ^0.8.18;\r\n\r\nimport \"forge-std/Script.sol\";\r\nimport \"../src/core/PermissiveFactory.sol\";\r\nimport \"../src/core/PermissiveAccount.sol\";\r\nimport \"../src/core/FeeManager.sol\";\r\nimport \"account-abstraction/interfaces/IEntryPoint.sol\";\r\n\r\ncontract DeployScript is Script {\r\n    function run() external {\r\n        uint256 deployerPrivateKey = vm.envUint(\"PRIVATE_KEY\");\r\n        address entrypoint = vm.envAddress(\"ENTRYPOINT\");\r\n        bytes32 versionSalt = vm.envBytes32(\"VERSION_SALT\");\r\n        vm.startBroadcast(deployerPrivateKey);\r\n        FeeManager feeManager = new FeeManager{salt: versionSalt}();\r\n        PermissiveFactory factory = new PermissiveFactory{salt: versionSalt}(\r\n            IEntryPoint(entrypoint),\r\n            feeManager,\r\n            versionSalt\r\n        );\r\n        vm.stopBroadcast();\r\n    }\r\n}\r\n```\r\n\r\nAnd the PermissiveFactory deploys the PermissiveAccount with the following\r\n```sol\r\nconstructor(IEntryPoint _entryPoint, FeeManager feeManager, bytes32 salt) {\r\n        accountImplementation = new PermissiveAccount{salt: salt}(\r\n            address(_entryPoint),\r\n            payable(address(feeManager))\r\n        );\r\n    }\r\n ```\r\n \r\n But the problem is the following, the PermissiveAccount uses libraries with the `use A for B` notation. So the libraries need to be deployed and linked to the contract.\r\n \r\n```sol\r\nusing ECDSA for bytes32;\r\nusing BytesLib for bytes;\r\n```\r\n\r\nThe problem is that forge deploys the libraries without create2 opcode so they are not deterministic and impact the address of the account so the factory.\r\n\r\nExample of what it looks like in the explorer\r\n\r\n<img width=\"1452\" alt=\"Screenshot 2023-04-23 at 15 10 49\" src=\"https://user-images.githubusercontent.com/66029824/233844741-aa541e14-348b-4601-9107-ca8483db041f.png\">\r\n\r\n1. [The deployment of the libraries (single contract) without create2](https://mumbai.polygonscan.com/tx/0x14e5e979cfad564689c0dede89591236fdc61c95269fbe9985d448ca60458bb0)\r\n2. [Deployment of the feeManager with create2](https://mumbai.polygonscan.com/tx/0xb79116295d48f946ddb41c4d1c33b23aff4f33f66f3cef2f81b4be8805b717d0)\r\n3. [Deployment of the Factory with create2](https://mumbai.polygonscan.com/tx/0x6a9d714cc09b1b94f53b60f6a35b952d9a89539c46a6a720f53bc8d2fc8843d7)",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/4810/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4810/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1520578868",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4810#issuecomment-1520578868",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4810",
    "id": 1520578868,
    "node_id": "IC_kwDOGBlvNc5aojE0",
    "user": {
      "login": "Flydexo",
      "id": 66029824,
      "node_id": "MDQ6VXNlcjY2MDI5ODI0",
      "avatar_url": "https://avatars.githubusercontent.com/u/66029824?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Flydexo",
      "html_url": "https://github.com/Flydexo",
      "followers_url": "https://api.github.com/users/Flydexo/followers",
      "following_url": "https://api.github.com/users/Flydexo/following{/other_user}",
      "gists_url": "https://api.github.com/users/Flydexo/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Flydexo/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Flydexo/subscriptions",
      "organizations_url": "https://api.github.com/users/Flydexo/orgs",
      "repos_url": "https://api.github.com/users/Flydexo/repos",
      "events_url": "https://api.github.com/users/Flydexo/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Flydexo/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-24T17:42:08Z",
    "updated_at": "2023-04-24T17:42:08Z",
    "author_association": "NONE",
    "body": "Fixed it, my library was a linked library (contained external functions) Just replaced them with internal and were deployed correctly.",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1520578868/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1520579406",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4810#issuecomment-1520579406",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4810",
    "id": 1520579406,
    "node_id": "IC_kwDOGBlvNc5aojNO",
    "user": {
      "login": "Flydexo",
      "id": 66029824,
      "node_id": "MDQ6VXNlcjY2MDI5ODI0",
      "avatar_url": "https://avatars.githubusercontent.com/u/66029824?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Flydexo",
      "html_url": "https://github.com/Flydexo",
      "followers_url": "https://api.github.com/users/Flydexo/followers",
      "following_url": "https://api.github.com/users/Flydexo/following{/other_user}",
      "gists_url": "https://api.github.com/users/Flydexo/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Flydexo/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Flydexo/subscriptions",
      "organizations_url": "https://api.github.com/users/Flydexo/orgs",
      "repos_url": "https://api.github.com/users/Flydexo/repos",
      "events_url": "https://api.github.com/users/Flydexo/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Flydexo/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-24T17:42:37Z",
    "updated_at": "2023-04-24T17:42:37Z",
    "author_association": "NONE",
    "body": "The responsible was a homemade library and not ECDSA and BytesLib",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1520579406/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
