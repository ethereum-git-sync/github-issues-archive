{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/4942",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4942/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4942/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4942/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/4942",
  "id": 1708928350,
  "node_id": "I_kwDOGBlvNc5l3C1e",
  "number": 4942,
  "title": "feat(forge): do not revert if prank has not been used",
  "user": {
    "login": "PaulRBerg",
    "id": 8782666,
    "node_id": "MDQ6VXNlcjg3ODI2NjY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/8782666?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/PaulRBerg",
    "html_url": "https://github.com/PaulRBerg",
    "followers_url": "https://api.github.com/users/PaulRBerg/followers",
    "following_url": "https://api.github.com/users/PaulRBerg/following{/other_user}",
    "gists_url": "https://api.github.com/users/PaulRBerg/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/PaulRBerg/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/PaulRBerg/subscriptions",
    "organizations_url": "https://api.github.com/users/PaulRBerg/orgs",
    "repos_url": "https://api.github.com/users/PaulRBerg/repos",
    "events_url": "https://api.github.com/users/PaulRBerg/events{/privacy}",
    "received_events_url": "https://api.github.com/users/PaulRBerg/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3593644820,
      "node_id": "LA_kwDOGBlvNc7WMqsU",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-feature",
      "name": "T-feature",
      "color": "BFD4F2",
      "default": false,
      "description": "Type: feature"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 7,
  "created_at": "2023-05-14T12:31:57Z",
  "updated_at": "2023-08-31T16:12:03Z",
  "closed_at": "2023-08-31T16:12:02Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "### Component\n\nForge\n\n### Describe the feature you would like\n\n## Problem\r\n\r\nhttps://github.com/foundry-rs/foundry/pull/4826 made it possible to override the current prank with `startPrank`, but it also introduced a new requirement, i.e. the previous prank must have been used at least once for the second `startPrank` to be valid:\r\n\r\nhttps://github.com/foundry-rs/foundry/commit/15ac502cca25900a9cac63cbcdccd71fd3c489bb\r\n\r\nThis new requirement is quite problematic and self-defeating with respect to the original goal of this override feature because, in complex code bases with many test files, it is difficult to know if the previous prank was used.\r\n\r\nTake, for instance, the `Base_Test` in my PRBProxy code base:\r\n\r\nhttps://github.com/PaulRBerg/prb-proxy/blob/0b33e550bfd3c9264ccac22289745012a1b1b92d/test/Base.t.sol#L131\r\n\r\nI need this prank as a default prank mode for all tests (so that I do not have to put it in every contract's `setUp`), but some tests need to override this behavior and start a new prank. See these fuzz tests:\r\n\r\nhttps://github.com/PaulRBerg/prb-proxy/blob/0b33e550bfd3c9264ccac22289745012a1b1b92d/test/registry/deploy/deploy.t.sol#L26-L31\r\n\r\nThis is where I tried to replace my `changePrank` calls with `vm.startPrank`, and ended up getting the following error:\r\n\r\n> Reason: You cannot overwrite `prank` until it is applied at least once\r\n\r\n## Solutions\r\n\r\nPossible ways to address this issue:\r\n\r\n1. Undo https://github.com/foundry-rs/foundry/pull/4826/commits/15ac502cca25900a9cac63cbcdccd71fd3c489bb (my preferred solution)\r\n2. Add an `override_unused_prank` (or `allow_unused_prank`) config option in `foundry.toml`, which allows the user to override the latest prank even if it has not been used\r\n3. Keep the behavior as is but do not deprecate `changePrank` in `forge-std`\r\n\r\nWDYT, @4meta5?\n\n### Additional context\n\nThis restrictive behavior has apparently been implemented as a result of this suggestion left by @mds1:\r\n\r\n> What if I call `vm.prank` immediately followed by `vm.prank` (same question if either/both of those are replaced with startPrank)? I think we should make sure that reverts, because the first prank was never used",
  "closed_by": {
    "login": "Evalir",
    "id": 26014927,
    "node_id": "MDQ6VXNlcjI2MDE0OTI3",
    "avatar_url": "https://avatars.githubusercontent.com/u/26014927?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Evalir",
    "html_url": "https://github.com/Evalir",
    "followers_url": "https://api.github.com/users/Evalir/followers",
    "following_url": "https://api.github.com/users/Evalir/following{/other_user}",
    "gists_url": "https://api.github.com/users/Evalir/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Evalir/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Evalir/subscriptions",
    "organizations_url": "https://api.github.com/users/Evalir/orgs",
    "repos_url": "https://api.github.com/users/Evalir/repos",
    "events_url": "https://api.github.com/users/Evalir/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Evalir/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/4942/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4942/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1546932254",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4942#issuecomment-1546932254",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4942",
    "id": 1546932254,
    "node_id": "IC_kwDOGBlvNc5cNFAe",
    "user": {
      "login": "PaulRBerg",
      "id": 8782666,
      "node_id": "MDQ6VXNlcjg3ODI2NjY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8782666?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/PaulRBerg",
      "html_url": "https://github.com/PaulRBerg",
      "followers_url": "https://api.github.com/users/PaulRBerg/followers",
      "following_url": "https://api.github.com/users/PaulRBerg/following{/other_user}",
      "gists_url": "https://api.github.com/users/PaulRBerg/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/PaulRBerg/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/PaulRBerg/subscriptions",
      "organizations_url": "https://api.github.com/users/PaulRBerg/orgs",
      "repos_url": "https://api.github.com/users/PaulRBerg/repos",
      "events_url": "https://api.github.com/users/PaulRBerg/events{/privacy}",
      "received_events_url": "https://api.github.com/users/PaulRBerg/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-14T16:02:38Z",
    "updated_at": "2023-05-14T16:02:47Z",
    "author_association": "CONTRIBUTOR",
    "body": "I just tried replacing `changePrank` with `vm.startPrank` in one of my other projects - and I encountered the same breaking behavior.\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1546932254/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1548188101",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4942#issuecomment-1548188101",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4942",
    "id": 1548188101,
    "node_id": "IC_kwDOGBlvNc5cR3nF",
    "user": {
      "login": "mds1",
      "id": 17163988,
      "node_id": "MDQ6VXNlcjE3MTYzOTg4",
      "avatar_url": "https://avatars.githubusercontent.com/u/17163988?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mds1",
      "html_url": "https://github.com/mds1",
      "followers_url": "https://api.github.com/users/mds1/followers",
      "following_url": "https://api.github.com/users/mds1/following{/other_user}",
      "gists_url": "https://api.github.com/users/mds1/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mds1/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mds1/subscriptions",
      "organizations_url": "https://api.github.com/users/mds1/orgs",
      "repos_url": "https://api.github.com/users/mds1/repos",
      "events_url": "https://api.github.com/users/mds1/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mds1/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-15T16:35:46Z",
    "updated_at": "2023-05-15T16:36:03Z",
    "author_association": "COLLABORATOR",
    "body": "Hmm interesting. The use case does make sense, but I think we should try to avoid a config flag if possible for simplicity. I see two competing interests:\r\n1. Make mistakes + poorly written tests less common by not allowing unused pranks\r\n2. Make utils simpler/cleaner by allowing unused pranks\r\n\r\nDoes `stopPrank` work even if you never used the prank started with `startPrank`? I can't recall offhand, but if so I think that could be a solution: We keep the current behavior to make tests safer by default, and move the work to devex utils that need to check if a prank is active and conditionally stop if so",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1548188101/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1548238979",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4942#issuecomment-1548238979",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4942",
    "id": 1548238979,
    "node_id": "IC_kwDOGBlvNc5cSECD",
    "user": {
      "login": "PaulRBerg",
      "id": 8782666,
      "node_id": "MDQ6VXNlcjg3ODI2NjY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8782666?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/PaulRBerg",
      "html_url": "https://github.com/PaulRBerg",
      "followers_url": "https://api.github.com/users/PaulRBerg/followers",
      "following_url": "https://api.github.com/users/PaulRBerg/following{/other_user}",
      "gists_url": "https://api.github.com/users/PaulRBerg/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/PaulRBerg/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/PaulRBerg/subscriptions",
      "organizations_url": "https://api.github.com/users/PaulRBerg/orgs",
      "repos_url": "https://api.github.com/users/PaulRBerg/repos",
      "events_url": "https://api.github.com/users/PaulRBerg/events{/privacy}",
      "received_events_url": "https://api.github.com/users/PaulRBerg/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-15T17:10:36Z",
    "updated_at": "2023-05-15T17:10:36Z",
    "author_association": "CONTRIBUTOR",
    "body": "> Does `stopPrank` work even if you never used the prank started with `startPrank`?\r\n\r\nIt does - `changePrank` wouldn't work otherwise.\r\n\r\n> move the work to devex utils that need to check if a prank is active and conditionally stop if so\r\n\r\nThis means not deprecating `changePrank` in Forge Std, and potentially refactoring it to read the current prank using the read prank feature being added in https://github.com/foundry-rs/foundry/pull/4884.",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1548238979/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1548574562",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4942#issuecomment-1548574562",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4942",
    "id": 1548574562,
    "node_id": "IC_kwDOGBlvNc5cTV9i",
    "user": {
      "login": "mds1",
      "id": 17163988,
      "node_id": "MDQ6VXNlcjE3MTYzOTg4",
      "avatar_url": "https://avatars.githubusercontent.com/u/17163988?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mds1",
      "html_url": "https://github.com/mds1",
      "followers_url": "https://api.github.com/users/mds1/followers",
      "following_url": "https://api.github.com/users/mds1/following{/other_user}",
      "gists_url": "https://api.github.com/users/mds1/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mds1/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mds1/subscriptions",
      "organizations_url": "https://api.github.com/users/mds1/orgs",
      "repos_url": "https://api.github.com/users/mds1/repos",
      "events_url": "https://api.github.com/users/mds1/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mds1/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-15T21:03:46Z",
    "updated_at": "2023-05-15T21:03:46Z",
    "author_association": "COLLABORATOR",
    "body": "Cool, that seems like a good solution to me then since we can then support both of the interests in https://github.com/foundry-rs/foundry/issues/4942#issuecomment-1548188101",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1548574562/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1700701053",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4942#issuecomment-1700701053",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4942",
    "id": 1700701053,
    "node_id": "IC_kwDOGBlvNc5lXqN9",
    "user": {
      "login": "urataps",
      "id": 44036207,
      "node_id": "MDQ6VXNlcjQ0MDM2MjA3",
      "avatar_url": "https://avatars.githubusercontent.com/u/44036207?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/urataps",
      "html_url": "https://github.com/urataps",
      "followers_url": "https://api.github.com/users/urataps/followers",
      "following_url": "https://api.github.com/users/urataps/following{/other_user}",
      "gists_url": "https://api.github.com/users/urataps/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/urataps/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/urataps/subscriptions",
      "organizations_url": "https://api.github.com/users/urataps/orgs",
      "repos_url": "https://api.github.com/users/urataps/repos",
      "events_url": "https://api.github.com/users/urataps/events{/privacy}",
      "received_events_url": "https://api.github.com/users/urataps/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-08-31T09:36:47Z",
    "updated_at": "2023-08-31T09:36:47Z",
    "author_association": "NONE",
    "body": "I have the same issue, perhaps it would be solved if we consider a contract deployment as applied state to `startPrank`, as only contract calls are counted. I have to do a mock call after setting the admin in base test contract to avoid the error.",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1700701053/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1701328760",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4942#issuecomment-1701328760",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4942",
    "id": 1701328760,
    "node_id": "IC_kwDOGBlvNc5laDd4",
    "user": {
      "login": "mds1",
      "id": 17163988,
      "node_id": "MDQ6VXNlcjE3MTYzOTg4",
      "avatar_url": "https://avatars.githubusercontent.com/u/17163988?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mds1",
      "html_url": "https://github.com/mds1",
      "followers_url": "https://api.github.com/users/mds1/followers",
      "following_url": "https://api.github.com/users/mds1/following{/other_user}",
      "gists_url": "https://api.github.com/users/mds1/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mds1/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mds1/subscriptions",
      "organizations_url": "https://api.github.com/users/mds1/orgs",
      "repos_url": "https://api.github.com/users/mds1/repos",
      "events_url": "https://api.github.com/users/mds1/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mds1/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-08-31T16:09:21Z",
    "updated_at": "2023-08-31T16:09:21Z",
    "author_association": "COLLABORATOR",
    "body": "Can this issue be closed now that we have the [`readCallers`](https://github.com/foundry-rs/forge-std/blob/1d9650e951204a0ddce9ff89c32f1997984cef4d/src/Vm.sol#L454-L455) cheat? A user can write a utility method to handle the pranks accordingly",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1701328760/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1701332701",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4942#issuecomment-1701332701",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4942",
    "id": 1701332701,
    "node_id": "IC_kwDOGBlvNc5laEbd",
    "user": {
      "login": "Evalir",
      "id": 26014927,
      "node_id": "MDQ6VXNlcjI2MDE0OTI3",
      "avatar_url": "https://avatars.githubusercontent.com/u/26014927?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Evalir",
      "html_url": "https://github.com/Evalir",
      "followers_url": "https://api.github.com/users/Evalir/followers",
      "following_url": "https://api.github.com/users/Evalir/following{/other_user}",
      "gists_url": "https://api.github.com/users/Evalir/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Evalir/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Evalir/subscriptions",
      "organizations_url": "https://api.github.com/users/Evalir/orgs",
      "repos_url": "https://api.github.com/users/Evalir/repos",
      "events_url": "https://api.github.com/users/Evalir/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Evalir/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-08-31T16:12:02Z",
    "updated_at": "2023-08-31T16:12:02Z",
    "author_association": "MEMBER",
    "body": "Yep, I believe this can be closed.",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1701332701/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
