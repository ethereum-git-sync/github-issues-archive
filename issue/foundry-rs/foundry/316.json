{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/316",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/316/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/316/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/316/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/316",
  "id": 1089336583,
  "node_id": "I_kwDOGBlvNc5A7fUH",
  "number": 316,
  "title": "Seeing bad cache invalidation in makerdao/spells-mainnet",
  "user": {
    "login": "hexonaut",
    "id": 588921,
    "node_id": "MDQ6VXNlcjU4ODkyMQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/588921?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/hexonaut",
    "html_url": "https://github.com/hexonaut",
    "followers_url": "https://api.github.com/users/hexonaut/followers",
    "following_url": "https://api.github.com/users/hexonaut/following{/other_user}",
    "gists_url": "https://api.github.com/users/hexonaut/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/hexonaut/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/hexonaut/subscriptions",
    "organizations_url": "https://api.github.com/users/hexonaut/orgs",
    "repos_url": "https://api.github.com/users/hexonaut/repos",
    "events_url": "https://api.github.com/users/hexonaut/events{/privacy}",
    "received_events_url": "https://api.github.com/users/hexonaut/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3334394228,
      "node_id": "MDU6TGFiZWwzMzM0Mzk0MjI4",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-bug",
      "name": "T-bug",
      "color": "d73a4a",
      "default": false,
      "description": "Type: bug"
    },
    {
      "id": 3703752787,
      "node_id": "LA_kwDOGBlvNc7cwshT",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/C-forge",
      "name": "C-forge",
      "color": "5319E7",
      "default": false,
      "description": "Command: forge"
    },
    {
      "id": 3759719580,
      "node_id": "LA_kwDOGBlvNc7gGMSc",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/P-normal",
      "name": "P-normal",
      "color": "D93F0B",
      "default": false,
      "description": "Priority: normal"
    },
    {
      "id": 3777098561,
      "node_id": "LA_kwDOGBlvNc7hIfNB",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/Cmd-forge-build",
      "name": "Cmd-forge-build",
      "color": "006B75",
      "default": false,
      "description": "Command: forge build"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 8,
  "created_at": "2021-12-27T16:11:47Z",
  "updated_at": "2022-02-07T13:45:07Z",
  "closed_at": "2022-02-07T13:45:07Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "Steps to reproduce:\r\n\r\n1. Fork https://github.com/makerdao/spells-mainnet and checkout commit be8c6e946a5fa7768d8af0f6e200712f397ad587 .\r\n2. Remove the `--force` arg from `test-dssspell-forge.sh`.\r\n3. Run `make test-forge`.\r\n4. Tests should correctly mostly error (4 success, 9 failing) and report that the spell has already been cast. Cache has been built.\r\n5. Edit `src/DssSpell.t.base.sol` line 294 and set the `deployed_spell` to `address(0)`.\r\n6. Run `make test-forge`.\r\n\r\nExpected output:\r\n\r\nMost tests should start passing (11 succeed, 2 failing) with no mention of spell already cast.\r\n\r\nActual output:\r\n\r\nIdentical from the first test which is incorrect.",
  "closed_by": {
    "login": "gakonst",
    "id": 17802178,
    "node_id": "MDQ6VXNlcjE3ODAyMTc4",
    "avatar_url": "https://avatars.githubusercontent.com/u/17802178?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/gakonst",
    "html_url": "https://github.com/gakonst",
    "followers_url": "https://api.github.com/users/gakonst/followers",
    "following_url": "https://api.github.com/users/gakonst/following{/other_user}",
    "gists_url": "https://api.github.com/users/gakonst/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/gakonst/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/gakonst/subscriptions",
    "organizations_url": "https://api.github.com/users/gakonst/orgs",
    "repos_url": "https://api.github.com/users/gakonst/repos",
    "events_url": "https://api.github.com/users/gakonst/events{/privacy}",
    "received_events_url": "https://api.github.com/users/gakonst/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/316/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/316/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1001642578",
    "html_url": "https://github.com/foundry-rs/foundry/issues/316#issuecomment-1001642578",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/316",
    "id": 1001642578,
    "node_id": "IC_kwDOGBlvNc47s9pS",
    "user": {
      "login": "wilsoncusack",
      "id": 6678357,
      "node_id": "MDQ6VXNlcjY2NzgzNTc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6678357?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/wilsoncusack",
      "html_url": "https://github.com/wilsoncusack",
      "followers_url": "https://api.github.com/users/wilsoncusack/followers",
      "following_url": "https://api.github.com/users/wilsoncusack/following{/other_user}",
      "gists_url": "https://api.github.com/users/wilsoncusack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/wilsoncusack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/wilsoncusack/subscriptions",
      "organizations_url": "https://api.github.com/users/wilsoncusack/orgs",
      "repos_url": "https://api.github.com/users/wilsoncusack/repos",
      "events_url": "https://api.github.com/users/wilsoncusack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/wilsoncusack/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-12-27T16:22:21Z",
    "updated_at": "2021-12-27T16:22:21Z",
    "author_association": "CONTRIBUTOR",
    "body": "I think same issue as https://github.com/gakonst/foundry/issues/299. cc @mattsse who had asked for a repo to reproduce ",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1001642578/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1001653344",
    "html_url": "https://github.com/foundry-rs/foundry/issues/316#issuecomment-1001653344",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/316",
    "id": 1001653344,
    "node_id": "IC_kwDOGBlvNc47tARg",
    "user": {
      "login": "mattsse",
      "id": 19890894,
      "node_id": "MDQ6VXNlcjE5ODkwODk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/19890894?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mattsse",
      "html_url": "https://github.com/mattsse",
      "followers_url": "https://api.github.com/users/mattsse/followers",
      "following_url": "https://api.github.com/users/mattsse/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattsse/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mattsse/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattsse/subscriptions",
      "organizations_url": "https://api.github.com/users/mattsse/orgs",
      "repos_url": "https://api.github.com/users/mattsse/repos",
      "events_url": "https://api.github.com/users/mattsse/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mattsse/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-12-27T16:51:39Z",
    "updated_at": "2021-12-27T16:51:39Z",
    "author_association": "MEMBER",
    "body": "thanks for this, \r\nthis is also currently tracked here https://github.com/gakonst/ethers-rs/issues/739 as this is an ethers-solc issue, which should be resolved shortly.",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1001653344/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1009402398",
    "html_url": "https://github.com/foundry-rs/foundry/issues/316#issuecomment-1009402398",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/316",
    "id": 1009402398,
    "node_id": "IC_kwDOGBlvNc48KkIe",
    "user": {
      "login": "mattsse",
      "id": 19890894,
      "node_id": "MDQ6VXNlcjE5ODkwODk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/19890894?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mattsse",
      "html_url": "https://github.com/mattsse",
      "followers_url": "https://api.github.com/users/mattsse/followers",
      "following_url": "https://api.github.com/users/mattsse/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattsse/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mattsse/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattsse/subscriptions",
      "organizations_url": "https://api.github.com/users/mattsse/orgs",
      "repos_url": "https://api.github.com/users/mattsse/repos",
      "events_url": "https://api.github.com/users/mattsse/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mattsse/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-01-10T22:23:47Z",
    "updated_at": "2022-01-10T22:23:47Z",
    "author_association": "MEMBER",
    "body": "oh I finally figured out what's causing this, \r\nthe change is correctly detected, however we're failing to recompile the `DssSpellTest` which inherits `DssSpellTestBase`. so we're recompiling `DssSpellTestBase` but not `DssSpellTest`\r\n\r\nI believe this is simply an oversight in the change detection,\r\nworking on a fix.",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1009402398/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1011216475",
    "html_url": "https://github.com/foundry-rs/foundry/issues/316#issuecomment-1011216475",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/316",
    "id": 1011216475,
    "node_id": "IC_kwDOGBlvNc48RfBb",
    "user": {
      "login": "hexonaut",
      "id": 588921,
      "node_id": "MDQ6VXNlcjU4ODkyMQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/588921?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hexonaut",
      "html_url": "https://github.com/hexonaut",
      "followers_url": "https://api.github.com/users/hexonaut/followers",
      "following_url": "https://api.github.com/users/hexonaut/following{/other_user}",
      "gists_url": "https://api.github.com/users/hexonaut/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hexonaut/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hexonaut/subscriptions",
      "organizations_url": "https://api.github.com/users/hexonaut/orgs",
      "repos_url": "https://api.github.com/users/hexonaut/repos",
      "events_url": "https://api.github.com/users/hexonaut/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hexonaut/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-01-12T16:17:06Z",
    "updated_at": "2022-01-12T16:17:06Z",
    "author_association": "CONTRIBUTOR",
    "body": "Tried this again. Still getting the same issue. Oddly enough I'm using test inheritance in another project and that one works fine.\r\n\r\nHere is steps to reproduce on `spells-mainnet`:\r\n\r\n1. Load this branch: https://github.com/makerdao/spells-mainnet/tree/add-forge-test and run `forge test --fork-url \"$ETH_RPC_URL\"` (set the rpc url)\r\n2. Change any line in `DssSpell.t.base.sol`. In particular I swap L257 to use either the `address(0)` or `address(1)`.\r\n\r\nYou should see a change in the number of failing tests 4 succeeding vs 11.\r\n\r\nHere is another repo where I've  used test inheritance: https://github.com/makerdao/dss-test/blob/master/src/tests/IntegrationTest_0_8_9.t.sol\r\n\r\nThis one seems to work without `--force` for some reason. Hope this helps.",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1011216475/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1011296702",
    "html_url": "https://github.com/foundry-rs/foundry/issues/316#issuecomment-1011296702",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/316",
    "id": 1011296702,
    "node_id": "IC_kwDOGBlvNc48Rym-",
    "user": {
      "login": "mattsse",
      "id": 19890894,
      "node_id": "MDQ6VXNlcjE5ODkwODk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/19890894?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mattsse",
      "html_url": "https://github.com/mattsse",
      "followers_url": "https://api.github.com/users/mattsse/followers",
      "following_url": "https://api.github.com/users/mattsse/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattsse/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mattsse/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattsse/subscriptions",
      "organizations_url": "https://api.github.com/users/mattsse/orgs",
      "repos_url": "https://api.github.com/users/mattsse/repos",
      "events_url": "https://api.github.com/users/mattsse/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mattsse/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-01-12T17:42:50Z",
    "updated_at": "2022-01-12T17:42:50Z",
    "author_association": "MEMBER",
    "body": "thanks!\r\nvery helpful,\r\n\r\ntried to replicate the case here\r\n\r\nhttps://github.com/gakonst/ethers-rs/blob/4d2cd83698788ae090aeefd508c27631bd8d5f12/ethers-solc/tests/project.rs#L141-L222\r\n\r\nwhich seems to work properly,\r\nbut this will help me to track down the root issue",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1011296702/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1011333572",
    "html_url": "https://github.com/foundry-rs/foundry/issues/316#issuecomment-1011333572",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/316",
    "id": 1011333572,
    "node_id": "IC_kwDOGBlvNc48R7nE",
    "user": {
      "login": "hexonaut",
      "id": 588921,
      "node_id": "MDQ6VXNlcjU4ODkyMQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/588921?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hexonaut",
      "html_url": "https://github.com/hexonaut",
      "followers_url": "https://api.github.com/users/hexonaut/followers",
      "following_url": "https://api.github.com/users/hexonaut/following{/other_user}",
      "gists_url": "https://api.github.com/users/hexonaut/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hexonaut/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hexonaut/subscriptions",
      "organizations_url": "https://api.github.com/users/hexonaut/orgs",
      "repos_url": "https://api.github.com/users/hexonaut/repos",
      "events_url": "https://api.github.com/users/hexonaut/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hexonaut/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-01-12T18:28:11Z",
    "updated_at": "2022-01-12T18:28:11Z",
    "author_association": "CONTRIBUTOR",
    "body": "Have you tried my exact replication steps outside of that test? There is something in particular about spells-mainnnet that is broken.",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1011333572/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1012702995",
    "html_url": "https://github.com/foundry-rs/foundry/issues/316#issuecomment-1012702995",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/316",
    "id": 1012702995,
    "node_id": "IC_kwDOGBlvNc48XJ8T",
    "user": {
      "login": "mattsse",
      "id": 19890894,
      "node_id": "MDQ6VXNlcjE5ODkwODk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/19890894?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mattsse",
      "html_url": "https://github.com/mattsse",
      "followers_url": "https://api.github.com/users/mattsse/followers",
      "following_url": "https://api.github.com/users/mattsse/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattsse/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mattsse/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattsse/subscriptions",
      "organizations_url": "https://api.github.com/users/mattsse/orgs",
      "repos_url": "https://api.github.com/users/mattsse/repos",
      "events_url": "https://api.github.com/users/mattsse/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mattsse/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-01-14T02:53:39Z",
    "updated_at": "2022-01-14T02:53:39Z",
    "author_association": "MEMBER",
    "body": "finally found what I believe is the actual root cause for this, it has to do with how we're currently managing the absolute path and the source name of contracts which gets mixed up somehow, probably a remappings/cache/absolute path snafu.\r\n\r\nthis is also the cause for https://github.com/gakonst/ethers-rs/issues/727.\r\n\r\nI know how to fix that now and also test against it.",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1012702995/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1031485126",
    "html_url": "https://github.com/foundry-rs/foundry/issues/316#issuecomment-1031485126",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/316",
    "id": 1031485126,
    "node_id": "IC_kwDOGBlvNc49ezbG",
    "user": {
      "login": "gakonst",
      "id": 17802178,
      "node_id": "MDQ6VXNlcjE3ODAyMTc4",
      "avatar_url": "https://avatars.githubusercontent.com/u/17802178?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gakonst",
      "html_url": "https://github.com/gakonst",
      "followers_url": "https://api.github.com/users/gakonst/followers",
      "following_url": "https://api.github.com/users/gakonst/following{/other_user}",
      "gists_url": "https://api.github.com/users/gakonst/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gakonst/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gakonst/subscriptions",
      "organizations_url": "https://api.github.com/users/gakonst/orgs",
      "repos_url": "https://api.github.com/users/gakonst/repos",
      "events_url": "https://api.github.com/users/gakonst/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gakonst/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-02-07T13:45:07Z",
    "updated_at": "2022-02-07T13:45:07Z",
    "author_association": "MEMBER",
    "body": "@hexonaut This should no longer be a prooblem since https://github.com/gakonst/ethers-rs/pull/802. Feel free to remove `forge clean` from all your makefiles!",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1031485126/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
