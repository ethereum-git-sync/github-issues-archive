{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/6215",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/6215/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/6215/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/6215/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/6215",
  "id": 1977350567,
  "node_id": "I_kwDOGBlvNc512_mn",
  "number": 6215,
  "title": "Library linking",
  "user": {
    "login": "klkvr",
    "id": 62447812,
    "node_id": "MDQ6VXNlcjYyNDQ3ODEy",
    "avatar_url": "https://avatars.githubusercontent.com/u/62447812?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/klkvr",
    "html_url": "https://github.com/klkvr",
    "followers_url": "https://api.github.com/users/klkvr/followers",
    "following_url": "https://api.github.com/users/klkvr/following{/other_user}",
    "gists_url": "https://api.github.com/users/klkvr/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/klkvr/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/klkvr/subscriptions",
    "organizations_url": "https://api.github.com/users/klkvr/orgs",
    "repos_url": "https://api.github.com/users/klkvr/repos",
    "events_url": "https://api.github.com/users/klkvr/events{/privacy}",
    "received_events_url": "https://api.github.com/users/klkvr/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3593644820,
      "node_id": "LA_kwDOGBlvNc7WMqsU",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-feature",
      "name": "T-feature",
      "color": "BFD4F2",
      "default": false,
      "description": "Type: feature"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2023-11-04T13:55:40Z",
  "updated_at": "2023-11-04T13:57:14Z",
  "closed_at": null,
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "### Component\n\nForge\n\n### Describe the feature you would like\n\nRight now unused libraries may be deployed even if there is no usage of them outside of broadcasting:\r\n\r\n- https://github.com/foundry-rs/foundry/issues/3295\r\n- https://github.com/foundry-rs/foundry/issues/5375\r\n\r\nThis happens because from perspective of Solidity compiler, script contract depends on all libraries which are used in it regardeless of part of code they are used in.\r\n\r\nOne possible solution is as follows:\r\n1. After script simulation, go through all `CREATE`'s and match bytecodes to artifacts.\r\n2. Determine which libraries are actually going to be used in newly created contracts. This can be done via [existing code for dependency resolution\r\n](https://github.com/foundry-rs/foundry/blob/master/crates/utils/src/lib.rs)\r\n3. If any unnecessary libraries are found, recompile the code and rerun the script, predeploying only the necessary libraries. This step is necessary because modifying the pre-deployed libraries list affects the sender nonce. All other libraries can be injected by some way similar to what `vm.etch` does\r\n\r\nThis approach has several drawbacks:\r\n1. Current code matching bytecode to artifacts uses [diff_score](https://github.com/foundry-rs/foundry/blob/master/crates/common/src/contracts.rs#L25) which may result in false positives/negatives in some cases. Right now such fails are accepted because they are only affecting verification and trace decoding. However, in case of library linking it becomes much more dangerous as it may lead to contracts being deployed without needed libraries\r\n2. Recompiling code and re-running script with new libraries is pretty expensive.\r\n\r\nWould be happy to get other opinions on this\n\n### Additional context\n\n_No response_",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/6215/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/6215/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1793450897",
    "html_url": "https://github.com/foundry-rs/foundry/issues/6215#issuecomment-1793450897",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/6215",
    "id": 1793450897,
    "node_id": "IC_kwDOGBlvNc5q5eOR",
    "user": {
      "login": "mattsse",
      "id": 19890894,
      "node_id": "MDQ6VXNlcjE5ODkwODk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/19890894?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mattsse",
      "html_url": "https://github.com/mattsse",
      "followers_url": "https://api.github.com/users/mattsse/followers",
      "following_url": "https://api.github.com/users/mattsse/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattsse/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mattsse/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattsse/subscriptions",
      "organizations_url": "https://api.github.com/users/mattsse/orgs",
      "repos_url": "https://api.github.com/users/mattsse/repos",
      "events_url": "https://api.github.com/users/mattsse/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mattsse/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-11-04T13:57:14Z",
    "updated_at": "2023-11-04T13:57:14Z",
    "author_association": "MEMBER",
    "body": "yeah this entire thing is giga cursed atm...\r\n\r\nthis needs a proper rewrite",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1793450897/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
