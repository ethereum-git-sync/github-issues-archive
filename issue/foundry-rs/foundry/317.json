{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/317",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/317/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/317/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/317/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/317",
  "id": 1089344370,
  "node_id": "I_kwDOGBlvNc5A7hNy",
  "number": 317,
  "title": "Turn off solc optimizer for test harness contracts",
  "user": {
    "login": "hexonaut",
    "id": 588921,
    "node_id": "MDQ6VXNlcjU4ODkyMQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/588921?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/hexonaut",
    "html_url": "https://github.com/hexonaut",
    "followers_url": "https://api.github.com/users/hexonaut/followers",
    "following_url": "https://api.github.com/users/hexonaut/following{/other_user}",
    "gists_url": "https://api.github.com/users/hexonaut/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/hexonaut/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/hexonaut/subscriptions",
    "organizations_url": "https://api.github.com/users/hexonaut/orgs",
    "repos_url": "https://api.github.com/users/hexonaut/repos",
    "events_url": "https://api.github.com/users/hexonaut/events{/privacy}",
    "received_events_url": "https://api.github.com/users/hexonaut/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3593644820,
      "node_id": "LA_kwDOGBlvNc7WMqsU",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-feature",
      "name": "T-feature",
      "color": "BFD4F2",
      "default": false,
      "description": "Type: feature"
    },
    {
      "id": 3703752787,
      "node_id": "LA_kwDOGBlvNc7cwshT",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/C-forge",
      "name": "C-forge",
      "color": "5319E7",
      "default": false,
      "description": "Command: forge"
    },
    {
      "id": 3777098561,
      "node_id": "LA_kwDOGBlvNc7hIfNB",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/Cmd-forge-build",
      "name": "Cmd-forge-build",
      "color": "006B75",
      "default": false,
      "description": "Command: forge build"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 9,
  "created_at": "2021-12-27T16:26:09Z",
  "updated_at": "2023-05-18T16:26:58Z",
  "closed_at": null,
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "If test files are very large / complex it can take `solc` a long time to process with optimizations turned on. You can see an example of this in https://github.com/makerdao/spells-mainnet where compiling `DssSpell.t.sol` with optimizations turned on takes around 10 minutes. We still do want to test against the optimized target contract though.\r\n\r\nI don't see a strong need to optimize test files as they aren't going on chain. I think the default behaviour should be to just turn off the optimizer for all test files even when it's turned on in general. Maybe there can be an override to turn it on, but I fail to see the use case.",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/317/reactions",
    "total_count": 2,
    "+1": 2,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/317/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1001647859",
    "html_url": "https://github.com/foundry-rs/foundry/issues/317#issuecomment-1001647859",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/317",
    "id": 1001647859,
    "node_id": "IC_kwDOGBlvNc47s-7z",
    "user": {
      "login": "wilsoncusack",
      "id": 6678357,
      "node_id": "MDQ6VXNlcjY2NzgzNTc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6678357?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/wilsoncusack",
      "html_url": "https://github.com/wilsoncusack",
      "followers_url": "https://api.github.com/users/wilsoncusack/followers",
      "following_url": "https://api.github.com/users/wilsoncusack/following{/other_user}",
      "gists_url": "https://api.github.com/users/wilsoncusack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/wilsoncusack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/wilsoncusack/subscriptions",
      "organizations_url": "https://api.github.com/users/wilsoncusack/orgs",
      "repos_url": "https://api.github.com/users/wilsoncusack/repos",
      "events_url": "https://api.github.com/users/wilsoncusack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/wilsoncusack/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-12-27T16:35:37Z",
    "updated_at": "2021-12-27T16:35:37Z",
    "author_association": "CONTRIBUTOR",
    "body": "Many of us use the tests to track gas changes and optimizations. Though you could still see improvements with the optimizer off, IMO it is nice to get a sense for what gas will be when deployed, which of course will have been optimized. \n\nThat said, not opposed to defaulting to off for test performance and having a config. ",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1001647859/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1001649320",
    "html_url": "https://github.com/foundry-rs/foundry/issues/317#issuecomment-1001649320",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/317",
    "id": 1001649320,
    "node_id": "IC_kwDOGBlvNc47s_So",
    "user": {
      "login": "hexonaut",
      "id": 588921,
      "node_id": "MDQ6VXNlcjU4ODkyMQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/588921?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hexonaut",
      "html_url": "https://github.com/hexonaut",
      "followers_url": "https://api.github.com/users/hexonaut/followers",
      "following_url": "https://api.github.com/users/hexonaut/following{/other_user}",
      "gists_url": "https://api.github.com/users/hexonaut/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hexonaut/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hexonaut/subscriptions",
      "organizations_url": "https://api.github.com/users/hexonaut/orgs",
      "repos_url": "https://api.github.com/users/hexonaut/repos",
      "events_url": "https://api.github.com/users/hexonaut/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hexonaut/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-12-27T16:39:51Z",
    "updated_at": "2021-12-27T16:39:51Z",
    "author_association": "CONTRIBUTOR",
    "body": "So I'm not suggesting we turn off the optimizer for the actual contract which is where you care about the gas improvements. This is just for the test harness contracts that are calling into the target contracts. Whether the test harness is optimized or not should not affect the gas usage delta which is what you are interested in.",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1001649320/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1001650033",
    "html_url": "https://github.com/foundry-rs/foundry/issues/317#issuecomment-1001650033",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/317",
    "id": 1001650033,
    "node_id": "IC_kwDOGBlvNc47s_dx",
    "user": {
      "login": "wilsoncusack",
      "id": 6678357,
      "node_id": "MDQ6VXNlcjY2NzgzNTc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6678357?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/wilsoncusack",
      "html_url": "https://github.com/wilsoncusack",
      "followers_url": "https://api.github.com/users/wilsoncusack/followers",
      "following_url": "https://api.github.com/users/wilsoncusack/following{/other_user}",
      "gists_url": "https://api.github.com/users/wilsoncusack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/wilsoncusack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/wilsoncusack/subscriptions",
      "organizations_url": "https://api.github.com/users/wilsoncusack/orgs",
      "repos_url": "https://api.github.com/users/wilsoncusack/repos",
      "events_url": "https://api.github.com/users/wilsoncusack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/wilsoncusack/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-12-27T16:41:50Z",
    "updated_at": "2021-12-27T16:41:50Z",
    "author_association": "CONTRIBUTOR",
    "body": "Ah I see. Misunderstood. Fully support! ",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1001650033/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1001650756",
    "html_url": "https://github.com/foundry-rs/foundry/issues/317#issuecomment-1001650756",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/317",
    "id": 1001650756,
    "node_id": "IC_kwDOGBlvNc47s_pE",
    "user": {
      "login": "hexonaut",
      "id": 588921,
      "node_id": "MDQ6VXNlcjU4ODkyMQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/588921?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hexonaut",
      "html_url": "https://github.com/hexonaut",
      "followers_url": "https://api.github.com/users/hexonaut/followers",
      "following_url": "https://api.github.com/users/hexonaut/following{/other_user}",
      "gists_url": "https://api.github.com/users/hexonaut/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hexonaut/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hexonaut/subscriptions",
      "organizations_url": "https://api.github.com/users/hexonaut/orgs",
      "repos_url": "https://api.github.com/users/hexonaut/repos",
      "events_url": "https://api.github.com/users/hexonaut/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hexonaut/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-12-27T16:44:02Z",
    "updated_at": "2021-12-27T16:44:02Z",
    "author_association": "CONTRIBUTOR",
    "body": "Just realized the title was confusing. Updated.",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1001650756/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1001651733",
    "html_url": "https://github.com/foundry-rs/foundry/issues/317#issuecomment-1001651733",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/317",
    "id": 1001651733,
    "node_id": "IC_kwDOGBlvNc47s_4V",
    "user": {
      "login": "brockelmore",
      "id": 31553173,
      "node_id": "MDQ6VXNlcjMxNTUzMTcz",
      "avatar_url": "https://avatars.githubusercontent.com/u/31553173?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/brockelmore",
      "html_url": "https://github.com/brockelmore",
      "followers_url": "https://api.github.com/users/brockelmore/followers",
      "following_url": "https://api.github.com/users/brockelmore/following{/other_user}",
      "gists_url": "https://api.github.com/users/brockelmore/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/brockelmore/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/brockelmore/subscriptions",
      "organizations_url": "https://api.github.com/users/brockelmore/orgs",
      "repos_url": "https://api.github.com/users/brockelmore/repos",
      "events_url": "https://api.github.com/users/brockelmore/events{/privacy}",
      "received_events_url": "https://api.github.com/users/brockelmore/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-12-27T16:46:57Z",
    "updated_at": "2021-12-27T16:46:57Z",
    "author_association": "MEMBER",
    "body": "Possible solution but would need to know more about `ethers::solc` from @mattsse, but we already support multiple solc jobs for different pragma versions. Not sure how we could exactly configure this, but should be possible to spin up a solc instance with optimizations off for test contracts",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1001651733/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1105898436",
    "html_url": "https://github.com/foundry-rs/foundry/issues/317#issuecomment-1105898436",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/317",
    "id": 1105898436,
    "node_id": "IC_kwDOGBlvNc5B6qvE",
    "user": {
      "login": "onbjerg",
      "id": 8862627,
      "node_id": "MDQ6VXNlcjg4NjI2Mjc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8862627?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/onbjerg",
      "html_url": "https://github.com/onbjerg",
      "followers_url": "https://api.github.com/users/onbjerg/followers",
      "following_url": "https://api.github.com/users/onbjerg/following{/other_user}",
      "gists_url": "https://api.github.com/users/onbjerg/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/onbjerg/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/onbjerg/subscriptions",
      "organizations_url": "https://api.github.com/users/onbjerg/orgs",
      "repos_url": "https://api.github.com/users/onbjerg/repos",
      "events_url": "https://api.github.com/users/onbjerg/events{/privacy}",
      "received_events_url": "https://api.github.com/users/onbjerg/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-04-22T00:56:52Z",
    "updated_at": "2022-04-22T00:59:32Z",
    "author_association": "MEMBER",
    "body": "Looked into this, I don't think it's currently possible(?) in solc.\r\n\r\nLooking at the compiler input, the optimizer is set globally for all sources in the compilation job, and there is no way for us to manually specify the bytecode of a contract that should be imported, unless that behaviour is undocumented. So there is no way for us (as far as I can tell) to compile non-test contracts with the optimizer on, and then afterwards compile test contracts, specifying the optimized version of the bytecode for non-test contracts when solc resolves imports.\r\n\r\nA way to get around it short-term, I guess, is to first compile the non-test contracts with the optimizer on, and then in tests use `vm.getCode` instead of importing the contracts, but that's not a super nice solution.\r\n\r\n>Possible solution but would need to know more about ethers::solc from @mattsse, but we already support multiple solc jobs for different pragma versions.\r\n\r\nI think this is only supported if you do not import contracts with conflicting versions, i.e. you sort of have two \"isolated\" source trees.\r\n\r\nEdit: Ref https://github.com/ethereum/solidity/issues/1540",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1105898436/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1553185776",
    "html_url": "https://github.com/foundry-rs/foundry/issues/317#issuecomment-1553185776",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/317",
    "id": 1553185776,
    "node_id": "IC_kwDOGBlvNc5ck7vw",
    "user": {
      "login": "lucas-manuel",
      "id": 44272939,
      "node_id": "MDQ6VXNlcjQ0MjcyOTM5",
      "avatar_url": "https://avatars.githubusercontent.com/u/44272939?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/lucas-manuel",
      "html_url": "https://github.com/lucas-manuel",
      "followers_url": "https://api.github.com/users/lucas-manuel/followers",
      "following_url": "https://api.github.com/users/lucas-manuel/following{/other_user}",
      "gists_url": "https://api.github.com/users/lucas-manuel/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/lucas-manuel/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/lucas-manuel/subscriptions",
      "organizations_url": "https://api.github.com/users/lucas-manuel/orgs",
      "repos_url": "https://api.github.com/users/lucas-manuel/repos",
      "events_url": "https://api.github.com/users/lucas-manuel/events{/privacy}",
      "received_events_url": "https://api.github.com/users/lucas-manuel/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-18T14:54:16Z",
    "updated_at": "2023-05-18T14:54:16Z",
    "author_association": "NONE",
    "body": "Close-able? @mds1 ",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1553185776/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1553298183",
    "html_url": "https://github.com/foundry-rs/foundry/issues/317#issuecomment-1553298183",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/317",
    "id": 1553298183,
    "node_id": "IC_kwDOGBlvNc5clXMH",
    "user": {
      "login": "mds1",
      "id": 17163988,
      "node_id": "MDQ6VXNlcjE3MTYzOTg4",
      "avatar_url": "https://avatars.githubusercontent.com/u/17163988?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mds1",
      "html_url": "https://github.com/mds1",
      "followers_url": "https://api.github.com/users/mds1/followers",
      "following_url": "https://api.github.com/users/mds1/following{/other_user}",
      "gists_url": "https://api.github.com/users/mds1/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mds1/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mds1/subscriptions",
      "organizations_url": "https://api.github.com/users/mds1/orgs",
      "repos_url": "https://api.github.com/users/mds1/repos",
      "events_url": "https://api.github.com/users/mds1/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mds1/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-18T16:19:18Z",
    "updated_at": "2023-05-18T16:19:18Z",
    "author_association": "COLLABORATOR",
    "body": "hmm it would still be great if we can find a workaround here, so src contracts can always be compiled with production settings and tests can be compiled with no optimizers",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1553298183/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1553310448",
    "html_url": "https://github.com/foundry-rs/foundry/issues/317#issuecomment-1553310448",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/317",
    "id": 1553310448,
    "node_id": "IC_kwDOGBlvNc5claLw",
    "user": {
      "login": "hexonaut",
      "id": 588921,
      "node_id": "MDQ6VXNlcjU4ODkyMQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/588921?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hexonaut",
      "html_url": "https://github.com/hexonaut",
      "followers_url": "https://api.github.com/users/hexonaut/followers",
      "following_url": "https://api.github.com/users/hexonaut/following{/other_user}",
      "gists_url": "https://api.github.com/users/hexonaut/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hexonaut/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hexonaut/subscriptions",
      "organizations_url": "https://api.github.com/users/hexonaut/orgs",
      "repos_url": "https://api.github.com/users/hexonaut/repos",
      "events_url": "https://api.github.com/users/hexonaut/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hexonaut/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-18T16:26:58Z",
    "updated_at": "2023-05-18T16:26:58Z",
    "author_association": "CONTRIBUTOR",
    "body": "Yeah I'm still in favour of this if possible.",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1553310448/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
