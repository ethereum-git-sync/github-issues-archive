{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/3409",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3409/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3409/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3409/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/3409",
  "id": 1390492495,
  "node_id": "I_kwDOGBlvNc5S4TtP",
  "number": 3409,
  "title": "`signTypedData_v4` produces incorrect signature on non-eth chains.",
  "user": {
    "login": "sunwrobert",
    "id": 6511174,
    "node_id": "MDQ6VXNlcjY1MTExNzQ=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6511174?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/sunwrobert",
    "html_url": "https://github.com/sunwrobert",
    "followers_url": "https://api.github.com/users/sunwrobert/followers",
    "following_url": "https://api.github.com/users/sunwrobert/following{/other_user}",
    "gists_url": "https://api.github.com/users/sunwrobert/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/sunwrobert/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/sunwrobert/subscriptions",
    "organizations_url": "https://api.github.com/users/sunwrobert/orgs",
    "repos_url": "https://api.github.com/users/sunwrobert/repos",
    "events_url": "https://api.github.com/users/sunwrobert/events{/privacy}",
    "received_events_url": "https://api.github.com/users/sunwrobert/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3334394228,
      "node_id": "MDU6TGFiZWwzMzM0Mzk0MjI4",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-bug",
      "name": "T-bug",
      "color": "d73a4a",
      "default": false,
      "description": "Type: bug"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2022-09-29T08:45:31Z",
  "updated_at": "2022-09-29T15:05:37Z",
  "closed_at": "2022-09-29T15:05:37Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Component\n\nAnvil\n\n### Have you ensured that all of these are up to date?\n\n- [X] Foundry\n- [X] Foundryup\n\n### What version of Foundry are you on?\n\nforge 0.2.0 (d707ebe 2022-09-29T00:13:28.610248Z)\n\n### What command(s) is the bug in?\n\nanvil\n\n### Operating System\n\nmacOS (Apple Silicon)\n\n### Describe the bug\n\nThere seems to be a bug with `eth_signTypedData_v4` when calling it on non-eth chains (I'm using Polygon).\r\n\r\nSteps to reproduce:\r\n1. Run `anvil --fork-url=\"https://polygon-mainnet.g.alchemy.com/v2/XXX\" --fork-block-number=32090225 --port=8545 --block-time=5 --timeout=15000 --retries=3`\r\n\r\n2. Execute this in another process:\r\n\r\n```\r\ncurl -X POST http://localhost:8545 -d '{\"jsonrpc\": \"2.0\", \"method\": \"eth_signTypedData_v4\", \"params\": [\"0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266\", \"{\\\"types\\\":{\\\"EIP712Domain\\\":[{\\\"name\\\":\\\"name\\\",\\\"type\\\":\\\"string\\\"},{\\\"name\\\":\\\"version\\\",\\\"type\\\":\\\"string\\\"},{\\\"name\\\":\\\"chainId\\\",\\\"type\\\":\\\"uint256\\\"},{\\\"name\\\":\\\"verifyingContract\\\",\\\"type\\\":\\\"address\\\"}],\\\"OrderComponents\\\":[{\\\"name\\\":\\\"offerer\\\",\\\"type\\\":\\\"address\\\"},{\\\"name\\\":\\\"zone\\\",\\\"type\\\":\\\"address\\\"},{\\\"name\\\":\\\"offer\\\",\\\"type\\\":\\\"OfferItem[]\\\"},{\\\"name\\\":\\\"consideration\\\",\\\"type\\\":\\\"ConsiderationItem[]\\\"},{\\\"name\\\":\\\"orderType\\\",\\\"type\\\":\\\"uint8\\\"},{\\\"name\\\":\\\"startTime\\\",\\\"type\\\":\\\"uint256\\\"},{\\\"name\\\":\\\"endTime\\\",\\\"type\\\":\\\"uint256\\\"},{\\\"name\\\":\\\"zoneHash\\\",\\\"type\\\":\\\"bytes32\\\"},{\\\"name\\\":\\\"salt\\\",\\\"type\\\":\\\"uint256\\\"},{\\\"name\\\":\\\"conduitKey\\\",\\\"type\\\":\\\"bytes32\\\"},{\\\"name\\\":\\\"counter\\\",\\\"type\\\":\\\"uint256\\\"}],\\\"OfferItem\\\":[{\\\"name\\\":\\\"itemType\\\",\\\"type\\\":\\\"uint8\\\"},{\\\"name\\\":\\\"token\\\",\\\"type\\\":\\\"address\\\"},{\\\"name\\\":\\\"identifierOrCriteria\\\",\\\"type\\\":\\\"uint256\\\"},{\\\"name\\\":\\\"startAmount\\\",\\\"type\\\":\\\"uint256\\\"},{\\\"name\\\":\\\"endAmount\\\",\\\"type\\\":\\\"uint256\\\"}],\\\"ConsiderationItem\\\":[{\\\"name\\\":\\\"itemType\\\",\\\"type\\\":\\\"uint8\\\"},{\\\"name\\\":\\\"token\\\",\\\"type\\\":\\\"address\\\"},{\\\"name\\\":\\\"identifierOrCriteria\\\",\\\"type\\\":\\\"uint256\\\"},{\\\"name\\\":\\\"startAmount\\\",\\\"type\\\":\\\"uint256\\\"},{\\\"name\\\":\\\"endAmount\\\",\\\"type\\\":\\\"uint256\\\"},{\\\"name\\\":\\\"recipient\\\",\\\"type\\\":\\\"address\\\"}]},\\\"primaryType\\\":\\\"OrderComponents\\\",\\\"domain\\\":{\\\"name\\\":\\\"Seaport\\\",\\\"version\\\":\\\"1.1\\\",\\\"chainId\\\":\\\"137\\\",\\\"verifyingContract\\\":\\\"0x00000000006c3852cbEf3e08E8dF289169EdE581\\\"},\\\"message\\\":{\\\"offerer\\\":\\\"0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266\\\",\\\"offer\\\":[{\\\"itemType\\\":\\\"3\\\",\\\"token\\\":\\\"0xA604060890923Ff400e8c6f5290461A83AEDACec\\\",\\\"identifierOrCriteria\\\":\\\"110194434039389003190498847789203126033799499726478230611233094448886344768909\\\",\\\"startAmount\\\":\\\"1\\\",\\\"endAmount\\\":\\\"1\\\"}],\\\"consideration\\\":[{\\\"itemType\\\":\\\"0\\\",\\\"token\\\":\\\"0x0000000000000000000000000000000000000000\\\",\\\"identifierOrCriteria\\\":\\\"0\\\",\\\"startAmount\\\":\\\"487500000000000000\\\",\\\"endAmount\\\":\\\"487500000000000000\\\",\\\"recipient\\\":\\\"0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266\\\"},{\\\"itemType\\\":\\\"0\\\",\\\"token\\\":\\\"0x0000000000000000000000000000000000000000\\\",\\\"identifierOrCriteria\\\":\\\"0\\\",\\\"startAmount\\\":\\\"12500000000000000\\\",\\\"endAmount\\\":\\\"12500000000000000\\\",\\\"recipient\\\":\\\"0x8De9C5A032463C561423387a9648c5C7BCC5BC90\\\"}],\\\"startTime\\\":\\\"1658645591\\\",\\\"endTime\\\":\\\"1659250386\\\",\\\"orderType\\\":\\\"3\\\",\\\"zone\\\":\\\"0x004C00500000aD104D7DBd00e3ae0A5C00560C00\\\",\\\"zoneHash\\\":\\\"0x0000000000000000000000000000000000000000000000000000000000000000\\\",\\\"salt\\\":\\\"16178208897136618\\\",\\\"conduitKey\\\":\\\"0x0000007b02230091a7ed01230072f7006a004d60a8d4e71d599b8104250f0000\\\",\\\"totalOriginalConsiderationItems\\\":\\\"2\\\",\\\"counter\\\":\\\"0\\\"}}\"], \"id\": \"1\"}' -H \"Content-Type: application/json\"\r\n```\r\n\r\n3. I get the following result in anvil.\r\n\r\n```\r\n{\"jsonrpc\":\"2.0\",\"id\":\"1\",\"result\":\"0x6761524e454c85159c8af4344df29a5c7a0060bac22ba4df40b51fd70eee02155a117f573a3347b793c79dfdc1f6e7fbda07fe0e43dfa6c80582bba4ac1c33431c\"}\r\n```\r\n\r\n4. Run hardhat instead of anvil with the same block number, etc.\r\n\r\n5. I get the following result in hardhat.\r\n\r\n```\r\n{\"jsonrpc\":\"2.0\",\"id\":\"1\",\"result\":\"0xed9afe7f377155ee3a42b25b696d79b55d441aeac7790b97a51b54ad0569b9665ea30bf8e8df12d6ee801c4dcb85ecfb8b23a6f7ae166d5af9acac9befb905451c\"}%\r\n```\r\n\r\nThe hardhat one should be the correct output",
  "closed_by": {
    "login": "gakonst",
    "id": 17802178,
    "node_id": "MDQ6VXNlcjE3ODAyMTc4",
    "avatar_url": "https://avatars.githubusercontent.com/u/17802178?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/gakonst",
    "html_url": "https://github.com/gakonst",
    "followers_url": "https://api.github.com/users/gakonst/followers",
    "following_url": "https://api.github.com/users/gakonst/following{/other_user}",
    "gists_url": "https://api.github.com/users/gakonst/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/gakonst/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/gakonst/subscriptions",
    "organizations_url": "https://api.github.com/users/gakonst/orgs",
    "repos_url": "https://api.github.com/users/gakonst/repos",
    "events_url": "https://api.github.com/users/gakonst/events{/privacy}",
    "received_events_url": "https://api.github.com/users/gakonst/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/3409/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3409/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1262290202",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3409#issuecomment-1262290202",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3409",
    "id": 1262290202,
    "node_id": "IC_kwDOGBlvNc5LPQUa",
    "user": {
      "login": "mattsse",
      "id": 19890894,
      "node_id": "MDQ6VXNlcjE5ODkwODk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/19890894?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mattsse",
      "html_url": "https://github.com/mattsse",
      "followers_url": "https://api.github.com/users/mattsse/followers",
      "following_url": "https://api.github.com/users/mattsse/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattsse/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mattsse/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattsse/subscriptions",
      "organizations_url": "https://api.github.com/users/mattsse/orgs",
      "repos_url": "https://api.github.com/users/mattsse/repos",
      "events_url": "https://api.github.com/users/mattsse/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mattsse/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-29T13:32:23Z",
    "updated_at": "2022-09-29T13:50:56Z",
    "author_association": "MEMBER",
    "body": "thanks for flagging.\r\n\r\nlooks like anvil reproduces the same result regardless of forked chain id, which makes sense since the chain id is not involved here.\r\n\r\nso it must be an encode_eip712 issue",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1262290202/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1262326677",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3409#issuecomment-1262326677",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3409",
    "id": 1262326677,
    "node_id": "IC_kwDOGBlvNc5LPZOV",
    "user": {
      "login": "mattsse",
      "id": 19890894,
      "node_id": "MDQ6VXNlcjE5ODkwODk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/19890894?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mattsse",
      "html_url": "https://github.com/mattsse",
      "followers_url": "https://api.github.com/users/mattsse/followers",
      "following_url": "https://api.github.com/users/mattsse/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattsse/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mattsse/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattsse/subscriptions",
      "organizations_url": "https://api.github.com/users/mattsse/orgs",
      "repos_url": "https://api.github.com/users/mattsse/repos",
      "events_url": "https://api.github.com/users/mattsse/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mattsse/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-29T13:59:01Z",
    "updated_at": "2022-09-29T14:02:17Z",
    "author_association": "MEMBER",
    "body": "omg, I found the issue.\r\n\r\nthere was something off with the chain id string parser. \r\n\r\nfixing rn",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1262326677/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 1,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1262354319",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3409#issuecomment-1262354319",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3409",
    "id": 1262354319,
    "node_id": "IC_kwDOGBlvNc5LPf-P",
    "user": {
      "login": "mattsse",
      "id": 19890894,
      "node_id": "MDQ6VXNlcjE5ODkwODk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/19890894?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mattsse",
      "html_url": "https://github.com/mattsse",
      "followers_url": "https://api.github.com/users/mattsse/followers",
      "following_url": "https://api.github.com/users/mattsse/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattsse/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mattsse/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattsse/subscriptions",
      "organizations_url": "https://api.github.com/users/mattsse/orgs",
      "repos_url": "https://api.github.com/users/mattsse/repos",
      "events_url": "https://api.github.com/users/mattsse/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mattsse/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-29T14:19:23Z",
    "updated_at": "2022-09-29T14:19:41Z",
    "author_association": "MEMBER",
    "body": "turns out the previous deserialize impl used for the chain id in the domain tries to decode strings as hex so `\"137\"` was deserialized as `311`...",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1262354319/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
