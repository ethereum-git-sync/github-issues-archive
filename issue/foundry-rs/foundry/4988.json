{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/4988",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4988/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4988/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4988/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/4988",
  "id": 1718039005,
  "node_id": "I_kwDOGBlvNc5mZzHd",
  "number": 4988,
  "title": "`forge test` funtion call throws `\"EvmError: NotActivated\"` error",
  "user": {
    "login": "WEI-NERD",
    "id": 131971450,
    "node_id": "U_kgDOB925eg",
    "avatar_url": "https://avatars.githubusercontent.com/u/131971450?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/WEI-NERD",
    "html_url": "https://github.com/WEI-NERD",
    "followers_url": "https://api.github.com/users/WEI-NERD/followers",
    "following_url": "https://api.github.com/users/WEI-NERD/following{/other_user}",
    "gists_url": "https://api.github.com/users/WEI-NERD/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/WEI-NERD/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/WEI-NERD/subscriptions",
    "organizations_url": "https://api.github.com/users/WEI-NERD/orgs",
    "repos_url": "https://api.github.com/users/WEI-NERD/repos",
    "events_url": "https://api.github.com/users/WEI-NERD/events{/privacy}",
    "received_events_url": "https://api.github.com/users/WEI-NERD/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3334394228,
      "node_id": "MDU6TGFiZWwzMzM0Mzk0MjI4",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-bug",
      "name": "T-bug",
      "color": "d73a4a",
      "default": false,
      "description": "Type: bug"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 6,
  "created_at": "2023-05-20T04:01:11Z",
  "updated_at": "2023-06-28T05:09:29Z",
  "closed_at": "2023-05-22T00:37:12Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Component\n\nForge, Cast\n\n### Have you ensured that all of these are up to date?\n\n- [X] Foundry\n- [X] Foundryup\n\n### What version of Foundry are you on?\n\nforge 0.2.0 (31fcf5a 2023-05-19T00:10:33.861185000Z)\n\n### What command(s) is the bug in?\n\n`forge test` `cast run`\n\n### Operating System\n\nmacOS (Apple Silicon)\n\n### Describe the bug\n\nSo I was poking around with a flashloan exploit on mainnet, the tx hash is [0x28e625ebc2fb6e9d8c389b5919a474a4066c283d1db06f84a637615c0625afa8](https://etherscan.io/tx/0x28e625ebc2fb6e9d8c389b5919a474a4066c283d1db06f84a637615c0625afa8) fwiw, but to my surprise, running `cast run 0xe7536c1bb28f54ec6d7d6d3e726adb598d30ce1780a064abf917be43a194c51a` throws an error `\"EvmError: NotActivated\"`, and using `forge test` to fork test it locally also throws the same error. For reproduction of the bug, I've created a [demo repo](https://github.com/WEI-NERD/test-foundry-evm-error).\r\n\r\n<img width=\"908\" alt=\"image\" src=\"https://github.com/foundry-rs/foundry/assets/131971450/5ccbe8af-7c14-4d20-a4b7-e78739f0e6a6\">\r\n\r\n\r\n\r\n<img width=\"968\" alt=\"image\" src=\"https://github.com/foundry-rs/foundry/assets/131971450/9fdb3b64-310b-4e9f-a460-1d4061bd7487\">\r\n\r\n",
  "closed_by": {
    "login": "WEI-NERD",
    "id": 131971450,
    "node_id": "U_kgDOB925eg",
    "avatar_url": "https://avatars.githubusercontent.com/u/131971450?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/WEI-NERD",
    "html_url": "https://github.com/WEI-NERD",
    "followers_url": "https://api.github.com/users/WEI-NERD/followers",
    "following_url": "https://api.github.com/users/WEI-NERD/following{/other_user}",
    "gists_url": "https://api.github.com/users/WEI-NERD/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/WEI-NERD/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/WEI-NERD/subscriptions",
    "organizations_url": "https://api.github.com/users/WEI-NERD/orgs",
    "repos_url": "https://api.github.com/users/WEI-NERD/repos",
    "events_url": "https://api.github.com/users/WEI-NERD/events{/privacy}",
    "received_events_url": "https://api.github.com/users/WEI-NERD/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/4988/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4988/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1555763205",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4988#issuecomment-1555763205",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4988",
    "id": 1555763205,
    "node_id": "IC_kwDOGBlvNc5cuxAF",
    "user": {
      "login": "mattsse",
      "id": 19890894,
      "node_id": "MDQ6VXNlcjE5ODkwODk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/19890894?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mattsse",
      "html_url": "https://github.com/mattsse",
      "followers_url": "https://api.github.com/users/mattsse/followers",
      "following_url": "https://api.github.com/users/mattsse/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattsse/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mattsse/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattsse/subscriptions",
      "organizations_url": "https://api.github.com/users/mattsse/orgs",
      "repos_url": "https://api.github.com/users/mattsse/repos",
      "events_url": "https://api.github.com/users/mattsse/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mattsse/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-20T07:11:50Z",
    "updated_at": "2023-05-20T07:11:50Z",
    "author_association": "MEMBER",
    "body": "@Evalir could this be an evm version regression in cast run?",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1555763205/reactions",
      "total_count": 2,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 2
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1555938199",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4988#issuecomment-1555938199",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4988",
    "id": 1555938199,
    "node_id": "IC_kwDOGBlvNc5cvbuX",
    "user": {
      "login": "Evalir",
      "id": 26014927,
      "node_id": "MDQ6VXNlcjI2MDE0OTI3",
      "avatar_url": "https://avatars.githubusercontent.com/u/26014927?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Evalir",
      "html_url": "https://github.com/Evalir",
      "followers_url": "https://api.github.com/users/Evalir/followers",
      "following_url": "https://api.github.com/users/Evalir/following{/other_user}",
      "gists_url": "https://api.github.com/users/Evalir/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Evalir/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Evalir/subscriptions",
      "organizations_url": "https://api.github.com/users/Evalir/orgs",
      "repos_url": "https://api.github.com/users/Evalir/repos",
      "events_url": "https://api.github.com/users/Evalir/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Evalir/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-20T15:40:30Z",
    "updated_at": "2023-05-20T15:40:30Z",
    "author_association": "MEMBER",
    "body": "Could be, will take a look ðŸ‘€ ",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1555938199/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1556331314",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4988#issuecomment-1556331314",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4988",
    "id": 1556331314,
    "node_id": "IC_kwDOGBlvNc5cw7sy",
    "user": {
      "login": "Evalir",
      "id": 26014927,
      "node_id": "MDQ6VXNlcjI2MDE0OTI3",
      "avatar_url": "https://avatars.githubusercontent.com/u/26014927?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Evalir",
      "html_url": "https://github.com/Evalir",
      "followers_url": "https://api.github.com/users/Evalir/followers",
      "following_url": "https://api.github.com/users/Evalir/following{/other_user}",
      "gists_url": "https://api.github.com/users/Evalir/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Evalir/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Evalir/subscriptions",
      "organizations_url": "https://api.github.com/users/Evalir/orgs",
      "repos_url": "https://api.github.com/users/Evalir/repos",
      "events_url": "https://api.github.com/users/Evalir/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Evalir/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-21T23:48:24Z",
    "updated_at": "2023-05-21T23:48:24Z",
    "author_association": "MEMBER",
    "body": "Alright, so here's what's happening:\r\n\r\nAs `0.8.20` and PUSH0 is being used here, we require Shanghai as the evm version. However, no evm version is being passed in, so we're defaulting to Paris, were PUSH0 isn't available. Therefore we get this error. \r\n\r\nThe inmmediate fix for you @WEI-NERD would be to set `evm_version` to `shanghai` in your `foundry.toml`. That should do it regarding forge test. However, this would not fix it for `cast run`â€”we might need to fix this separately.\r\n\r\n@mattsse i'll work on the fixes for this tomorrow. It's these two things:\r\n- fix #4954 â€” and we'll need to ensure that when autodetecting solc without an evm version set we always default to the latest version supported by the solc version we're using.\r\n- We also need to make anvil aware of EVM version discrepancies when forkingâ€”while this issue will be obscured when we move to shanghai, ideally it should be able to detect the evm version required when forking (which should be easy by maintaining a fork block list and detecting which evm version it should use based on that, and i'm almost sure we already have some version of this)\r\n\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1556331314/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1556352393",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4988#issuecomment-1556352393",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4988",
    "id": 1556352393,
    "node_id": "IC_kwDOGBlvNc5cxA2J",
    "user": {
      "login": "WEI-NERD",
      "id": 131971450,
      "node_id": "U_kgDOB925eg",
      "avatar_url": "https://avatars.githubusercontent.com/u/131971450?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/WEI-NERD",
      "html_url": "https://github.com/WEI-NERD",
      "followers_url": "https://api.github.com/users/WEI-NERD/followers",
      "following_url": "https://api.github.com/users/WEI-NERD/following{/other_user}",
      "gists_url": "https://api.github.com/users/WEI-NERD/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/WEI-NERD/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/WEI-NERD/subscriptions",
      "organizations_url": "https://api.github.com/users/WEI-NERD/orgs",
      "repos_url": "https://api.github.com/users/WEI-NERD/repos",
      "events_url": "https://api.github.com/users/WEI-NERD/events{/privacy}",
      "received_events_url": "https://api.github.com/users/WEI-NERD/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-22T00:37:00Z",
    "updated_at": "2023-05-22T00:37:00Z",
    "author_association": "NONE",
    "body": "Thx, this indeed fix the bug. ðŸ˜ƒ ",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1556352393/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1610670277",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4988#issuecomment-1610670277",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4988",
    "id": 1610670277,
    "node_id": "IC_kwDOGBlvNc5gAODF",
    "user": {
      "login": "WEI-NERD",
      "id": 131971450,
      "node_id": "U_kgDOB925eg",
      "avatar_url": "https://avatars.githubusercontent.com/u/131971450?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/WEI-NERD",
      "html_url": "https://github.com/WEI-NERD",
      "followers_url": "https://api.github.com/users/WEI-NERD/followers",
      "following_url": "https://api.github.com/users/WEI-NERD/following{/other_user}",
      "gists_url": "https://api.github.com/users/WEI-NERD/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/WEI-NERD/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/WEI-NERD/subscriptions",
      "organizations_url": "https://api.github.com/users/WEI-NERD/orgs",
      "repos_url": "https://api.github.com/users/WEI-NERD/repos",
      "events_url": "https://api.github.com/users/WEI-NERD/events{/privacy}",
      "received_events_url": "https://api.github.com/users/WEI-NERD/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-06-28T04:12:25Z",
    "updated_at": "2023-06-28T04:12:25Z",
    "author_association": "NONE",
    "body": "> Alright, so here's what's happening:\r\n> \r\n> As `0.8.20` and PUSH0 is being used here, we require Shanghai as the evm version. However, no evm version is being passed in, so we're defaulting to Paris, were PUSH0 isn't available. Therefore we get this error.\r\n> \r\n> The inmmediate fix for you @WEI-NERD would be to set `evm_version` to `shanghai` in your `foundry.toml`. That should do it regarding forge test. However, this would not fix it for `cast run`â€”we might need to fix this separately.\r\n> \r\n> @mattsse i'll work on the fixes for this tomorrow. It's these two things:\r\n> \r\n> * fix [bug(forge): incompatible evm version & solc versions are acceptedÂ #4954](https://github.com/foundry-rs/foundry/issues/4954) â€” and we'll need to ensure that when autodetecting solc without an evm version set we always default to the latest version supported by the solc version we're using.\r\n> * We also need to make anvil aware of EVM version discrepancies when forkingâ€”while this issue will be obscured when we move to shanghai, ideally it should be able to detect the evm version required when forking (which should be easy by maintaining a fork block list and detecting which evm version it should use based on that, and i'm almost sure we already have some version of this)\r\n\r\nSeems like `cast run` is still not fixed. Still getting solc version error. ðŸ˜¢ ",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1610670277/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1610745833",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4988#issuecomment-1610745833",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4988",
    "id": 1610745833,
    "node_id": "IC_kwDOGBlvNc5gAgfp",
    "user": {
      "login": "Evalir",
      "id": 26014927,
      "node_id": "MDQ6VXNlcjI2MDE0OTI3",
      "avatar_url": "https://avatars.githubusercontent.com/u/26014927?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Evalir",
      "html_url": "https://github.com/Evalir",
      "followers_url": "https://api.github.com/users/Evalir/followers",
      "following_url": "https://api.github.com/users/Evalir/following{/other_user}",
      "gists_url": "https://api.github.com/users/Evalir/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Evalir/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Evalir/subscriptions",
      "organizations_url": "https://api.github.com/users/Evalir/orgs",
      "repos_url": "https://api.github.com/users/Evalir/repos",
      "events_url": "https://api.github.com/users/Evalir/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Evalir/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-06-28T05:09:29Z",
    "updated_at": "2023-06-28T05:09:29Z",
    "author_association": "MEMBER",
    "body": "Did you set your svm version to the chain you're running the txs on? What chain is it?",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1610745833/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
