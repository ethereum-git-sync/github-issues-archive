{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/6024",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/6024/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/6024/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/6024/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/6024",
  "id": 1937263971,
  "node_id": "I_kwDOGBlvNc5zeE1j",
  "number": 6024,
  "title": "Invariant test called twice",
  "user": {
    "login": "0xTimepunk",
    "id": 45543880,
    "node_id": "MDQ6VXNlcjQ1NTQzODgw",
    "avatar_url": "https://avatars.githubusercontent.com/u/45543880?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/0xTimepunk",
    "html_url": "https://github.com/0xTimepunk",
    "followers_url": "https://api.github.com/users/0xTimepunk/followers",
    "following_url": "https://api.github.com/users/0xTimepunk/following{/other_user}",
    "gists_url": "https://api.github.com/users/0xTimepunk/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/0xTimepunk/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/0xTimepunk/subscriptions",
    "organizations_url": "https://api.github.com/users/0xTimepunk/orgs",
    "repos_url": "https://api.github.com/users/0xTimepunk/repos",
    "events_url": "https://api.github.com/users/0xTimepunk/events{/privacy}",
    "received_events_url": "https://api.github.com/users/0xTimepunk/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3334394228,
      "node_id": "MDU6TGFiZWwzMzM0Mzk0MjI4",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-bug",
      "name": "T-bug",
      "color": "d73a4a",
      "default": false,
      "description": "Type: bug"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 0,
  "created_at": "2023-10-11T09:09:42Z",
  "updated_at": "2023-10-11T09:12:07Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Component\r\n\r\nForge\r\n\r\n### Have you ensured that all of these are up to date?\r\n\r\n- [X] Foundry\r\n- [X] Foundryup\r\n\r\n### What version of Foundry are you on?\r\n\r\nforge 0.2.0 (e0722a1 2023-10-10T00:28:23.851012000Z)\r\n\r\n### What command(s) is the bug in?\r\n\r\nforge test\r\n\r\n### Operating System\r\n\r\nmacOS (Apple Silicon)\r\n\r\n### Describe the bug\r\n\r\nA foundry invariant test assertion reverts and is called twice in a row in a setup with multiple runs and multiple depth. From the sequence printed its not useful to decipher what's going on\r\n\r\nfoundry.toml looks like this:\r\n```\r\n[invariant]\r\nruns = 20\r\ndepth = 5 # “Calls” refer to the number of times functions in the smart contract are called during a single test run. “Reverts” refers to the number of times a call to any function within the smart contract resulted in a transaction being reverted due to an error or exception.\r\nfail_on_revert = true\r\ncall_override = false\r\n```\r\n\r\nThe test looks like this:\r\n```solidity\r\n    function invariant_vaultShares() public useCurrentTimestamp {\r\n        assertEq(vaultSharesStore.superPositionsSum(), vaultSharesStore.vaultShares());\r\n    }\r\n```\r\n\r\nSuperPositionsSum and VaultShares are set at the end of each function call in our handler in a specific store (`vaultSharesStore`).\r\n\r\n\r\n```\r\n  [24210] VaultSharesInvariantTest::invariant_vaultShares()\r\n    ├─ [0] VM::selectFork(0)\r\n    │   └─ ← ()\r\n    ├─ [2407] TimestampStore::currentTimestamp() [staticcall]\r\n    │   └─ ← 1694186515 [1.694e9]\r\n    ├─ [0] VM::warp(1694186515 [1.694e9])\r\n    │   └─ ← ()\r\n    ├─ [2429] VaultSharesStore::superPositionsSum() [staticcall]\r\n    │   └─ ← 2149673676847473860205 [2.149e21]\r\n    ├─ [2495] VaultSharesStore::vaultShares() [staticcall]\r\n    │   └─ ← 2149673676847473860205 [2.149e21]\r\n    └─ ← ()\r\n\r\n  [37972] VaultSharesInvariantTest::invariant_vaultShares()\r\n    ├─ [0] VM::selectFork(0)\r\n    │   └─ ← ()\r\n    ├─ [2407] TimestampStore::currentTimestamp() [staticcall]\r\n    │   └─ ← 1694186515 [1.694e9]\r\n    ├─ [0] VM::warp(1694186515 [1.694e9])\r\n    │   └─ ← ()\r\n    ├─ [2429] VaultSharesStore::superPositionsSum() [staticcall]\r\n    │   └─ ← 1103485652139861249137 [1.103e21]\r\n    ├─ [2495] VaultSharesStore::vaultShares() [staticcall]\r\n    │   └─ ← 2149673676847473860205 [2.149e21]\r\n    ├─ emit log(: Error: a == b not satisfied [uint])\r\n    ├─ emit log_named_uint(key:       Left, val: 1103485652139861249137 [1.103e21])\r\n    ├─ emit log_named_uint(key:      Right, val: 2149673676847473860205 [2.149e21])\r\n    ├─ [0] VM::store(VM: [0x7109709ECfa91a80626fF3989D68f67F5b1DD12D], 0x6661696c65640000000000000000000000000000000000000000000000000000, 0x0000000000000000000000000000000000000000000000000000000000000001)\r\n    │   └─ ← ()\r\n    └─ ← ()\r\n```\r\n\r\nI can't seem to understand this behaviour, but I noticed that instruction [24210] appears multiple times in the different calls that are successful, but only in the last one (where the call sequence reverts) there is a 2nd instruction [37972] (repeated??)\r\n\r\nI noticed as well that the values I am asserting change between these two calls even though nothing happens between them. Is foundry doing something under the hood on these values that is not being logged?\r\n\r\nWhy are two invariant tests called like that in a row?\r\n\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/6024/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/6024/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[

]
