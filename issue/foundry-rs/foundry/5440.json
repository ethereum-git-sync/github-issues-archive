{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/5440",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5440/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5440/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5440/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/5440",
  "id": 1812912244,
  "node_id": "I_kwDOGBlvNc5sDth0",
  "number": 5440,
  "title": "--gas-limit throws bug when set on script with forge",
  "user": {
    "login": "nicolasguasca1",
    "id": 33971632,
    "node_id": "MDQ6VXNlcjMzOTcxNjMy",
    "avatar_url": "https://avatars.githubusercontent.com/u/33971632?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/nicolasguasca1",
    "html_url": "https://github.com/nicolasguasca1",
    "followers_url": "https://api.github.com/users/nicolasguasca1/followers",
    "following_url": "https://api.github.com/users/nicolasguasca1/following{/other_user}",
    "gists_url": "https://api.github.com/users/nicolasguasca1/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/nicolasguasca1/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/nicolasguasca1/subscriptions",
    "organizations_url": "https://api.github.com/users/nicolasguasca1/orgs",
    "repos_url": "https://api.github.com/users/nicolasguasca1/repos",
    "events_url": "https://api.github.com/users/nicolasguasca1/events{/privacy}",
    "received_events_url": "https://api.github.com/users/nicolasguasca1/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3334394228,
      "node_id": "MDU6TGFiZWwzMzM0Mzk0MjI4",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-bug",
      "name": "T-bug",
      "color": "d73a4a",
      "default": false,
      "description": "Type: bug"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2023-07-20T00:06:01Z",
  "updated_at": "2023-07-24T22:40:31Z",
  "closed_at": "2023-07-24T22:40:31Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Component\n\nForge\n\n### Have you ensured that all of these are up to date?\n\n- [X] Foundry\n- [X] Foundryup\n\n### What version of Foundry are you on?\n\nforge 0.2.0 (0e72b71 2023-07-19T00:31:31.205426000Z)\n\n### What command(s) is the bug in?\n\nforge script\n\n### Operating System\n\nmacOS (Intel)\n\n### Describe the bug\n\nIm running a script that deploys various contracts into the sepolia testnet. The first set of contracts are libraries, the second set of contracts are templates that use the libraries deployed and will be used as the templates to deploy various proxies. However, out of the 12 transactions necessary, only 5 of them are successful. I run into the:\r\n\r\n```(code: -32000, message: insufficient funds for gas * price + value```\r\n\r\nThis is my script so far:\r\n```forge script scripts/01_InitialDep.s.sol:MyInitialScript --rpc-url $SEPOLIA_RPC_URL --private-key $PRIVATE_KEY --broadcast --sender <myAddress> -vvvvv --gas-limit 3000000 RUST_BACKTRACE=$RUST_BACKTRACEB```\r\n\r\nAs you can see, I tried to use --gas-limit 3000000 within my script and the CLI panicked(crashed) with this backtrace:\r\n\r\n```\r\n ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ BACKTRACE ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\r\n   1: __mh_execute_header<unknown>\r\n      at <unknown source file>:<unknown line>\r\n   2: __mh_execute_header<unknown>\r\n      at <unknown source file>:<unknown line>\r\n   3: __mh_execute_header<unknown>\r\n      at <unknown source file>:<unknown line>\r\n   4: __mh_execute_header<unknown>\r\n      at <unknown source file>:<unknown line>\r\n   5: __mh_execute_header<unknown>\r\n      at <unknown source file>:<unknown line>\r\n   6: __mh_execute_header<unknown>\r\n      at <unknown source file>:<unknown line>\r\n   7: __mh_execute_header<unknown>\r\n      at <unknown source file>:<unknown line>\r\n   8: __mh_execute_header<unknown>\r\n      at <unknown source file>:<unknown line>\r\n   9: __mh_execute_header<unknown>\r\n      at <unknown source file>:<unknown line>\r\n  10: __mh_execute_header<unknown>\r\n      at <unknown source file>:<unknown line>\r\n  11: __mh_execute_header<unknown>\r\n      at <unknown source file>:<unknown line>\r\n  12: __mh_execute_header<unknown>\r\n      at <unknown source file>:<unknown line>\r\n  13: __mh_execute_header<unknown>\r\n      at <unknown source file>:<unknown line>\r\n  14: __mh_execute_header<unknown>\r\n      at <unknown source file>:<unknown line>\r\n  15: __mh_execute_header<unknown>\r\n      at <unknown source file>:<unknown line>\r\n  16: __mh_execute_header<unknown>\r\n      at <unknown source file>:<unknown line>\r\n      ```\r\n      \r\n      The message after it crasher starts with this:\r\n      \r\n      ``` couldn't deploy library: Execution(ExecutionErr { reverted: true, reason: \"EvmError: OutOfGas\", gas_used: 3000000, gas_refunded: 0, stipend: 0, logs: [], traces: Some(CallTraceArena { arena: [CallTraceNode { parent: None, children: [], idx: 0, trace: CallTrace { depth: 0, success: false, contract: None, label: None, caller: 0x65aa9b131fa4d4ab112cd5e912b82c068574c9b5, address: 0x8ccf83ae2ffa68b94efe521d16d03d8d045b9995, kind: Create, value: 0, data:```\r\n      \r\n    Even if I set a higher gas limit than 3000000, then I don't get the creash, but I still get the -32000 code so I feel I get the same error doing two different things.  I would like to know how to properly set a gas limit for a transaction using forge. I know the only way to get the gas within solidity is using gasleft() function but I don't think its giving me realistic figures as it says at the end of the \"run\" function that remaining gas is 2974882756 which means its not taking too much gas to run. \r\n    \r\n    The functions within the script run perfectly and then the transactions receipt shows a different reality. Does it have to do with the fact that the script is also a \"test\"?\r\n    ",
  "closed_by": {
    "login": "nicolasguasca1",
    "id": 33971632,
    "node_id": "MDQ6VXNlcjMzOTcxNjMy",
    "avatar_url": "https://avatars.githubusercontent.com/u/33971632?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/nicolasguasca1",
    "html_url": "https://github.com/nicolasguasca1",
    "followers_url": "https://api.github.com/users/nicolasguasca1/followers",
    "following_url": "https://api.github.com/users/nicolasguasca1/following{/other_user}",
    "gists_url": "https://api.github.com/users/nicolasguasca1/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/nicolasguasca1/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/nicolasguasca1/subscriptions",
    "organizations_url": "https://api.github.com/users/nicolasguasca1/orgs",
    "repos_url": "https://api.github.com/users/nicolasguasca1/repos",
    "events_url": "https://api.github.com/users/nicolasguasca1/events{/privacy}",
    "received_events_url": "https://api.github.com/users/nicolasguasca1/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/5440/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5440/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1648655304",
    "html_url": "https://github.com/foundry-rs/foundry/issues/5440#issuecomment-1648655304",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5440",
    "id": 1648655304,
    "node_id": "IC_kwDOGBlvNc5iRHvI",
    "user": {
      "login": "Evalir",
      "id": 26014927,
      "node_id": "MDQ6VXNlcjI2MDE0OTI3",
      "avatar_url": "https://avatars.githubusercontent.com/u/26014927?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Evalir",
      "html_url": "https://github.com/Evalir",
      "followers_url": "https://api.github.com/users/Evalir/followers",
      "following_url": "https://api.github.com/users/Evalir/following{/other_user}",
      "gists_url": "https://api.github.com/users/Evalir/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Evalir/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Evalir/subscriptions",
      "organizations_url": "https://api.github.com/users/Evalir/orgs",
      "repos_url": "https://api.github.com/users/Evalir/repos",
      "events_url": "https://api.github.com/users/Evalir/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Evalir/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-24T21:32:11Z",
    "updated_at": "2023-07-24T21:32:11Z",
    "author_association": "MEMBER",
    "body": "Hey! can you provide a minimal repro of this happening please? This way I can take a proper look at this.",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1648655304/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1648720173",
    "html_url": "https://github.com/foundry-rs/foundry/issues/5440#issuecomment-1648720173",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5440",
    "id": 1648720173,
    "node_id": "IC_kwDOGBlvNc5iRXkt",
    "user": {
      "login": "nicolasguasca1",
      "id": 33971632,
      "node_id": "MDQ6VXNlcjMzOTcxNjMy",
      "avatar_url": "https://avatars.githubusercontent.com/u/33971632?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nicolasguasca1",
      "html_url": "https://github.com/nicolasguasca1",
      "followers_url": "https://api.github.com/users/nicolasguasca1/followers",
      "following_url": "https://api.github.com/users/nicolasguasca1/following{/other_user}",
      "gists_url": "https://api.github.com/users/nicolasguasca1/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nicolasguasca1/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nicolasguasca1/subscriptions",
      "organizations_url": "https://api.github.com/users/nicolasguasca1/orgs",
      "repos_url": "https://api.github.com/users/nicolasguasca1/repos",
      "events_url": "https://api.github.com/users/nicolasguasca1/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nicolasguasca1/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-24T22:40:31Z",
    "updated_at": "2023-07-24T22:40:31Z",
    "author_association": "NONE",
    "body": "Hello Evalir! My problem was that I was using:\r\n\r\n```function run() external {\r\n        uint256 deployerPrivateKey = vm.envUint(\"ANVIL_PRIVATE_KEY\");\r\n        vm.startBroadcast(deployerPrivateKey);\r\n        ```\r\nAnd my script was using my actual $PRIVATE_KEY. That was causing the out of gas error. ",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1648720173/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
