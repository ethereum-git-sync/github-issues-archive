{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/5003",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5003/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5003/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5003/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/5003",
  "id": 1720321666,
  "node_id": "I_kwDOGBlvNc5migaC",
  "number": 5003,
  "title": "forge create --verify does not respect allow_paths",
  "user": {
    "login": "miohtama",
    "id": 49922,
    "node_id": "MDQ6VXNlcjQ5OTIy",
    "avatar_url": "https://avatars.githubusercontent.com/u/49922?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/miohtama",
    "html_url": "https://github.com/miohtama",
    "followers_url": "https://api.github.com/users/miohtama/followers",
    "following_url": "https://api.github.com/users/miohtama/following{/other_user}",
    "gists_url": "https://api.github.com/users/miohtama/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/miohtama/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/miohtama/subscriptions",
    "organizations_url": "https://api.github.com/users/miohtama/orgs",
    "repos_url": "https://api.github.com/users/miohtama/repos",
    "events_url": "https://api.github.com/users/miohtama/events{/privacy}",
    "received_events_url": "https://api.github.com/users/miohtama/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3334394228,
      "node_id": "MDU6TGFiZWwzMzM0Mzk0MjI4",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-bug",
      "name": "T-bug",
      "color": "d73a4a",
      "default": false,
      "description": "Type: bug"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2023-05-22T19:19:23Z",
  "updated_at": "2023-05-22T19:41:09Z",
  "closed_at": "2023-05-22T19:41:09Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Component\r\n\r\nForge\r\n\r\n### Have you ensured that all of these are up to date?\r\n\r\n- [ ] Foundry\r\n- [X] Foundryup\r\n\r\n### What version of Foundry are you on?\r\n\r\nforge 0.2.0 (31fcf5a 2023-05-19T00:10:33.861185000Z)\r\n\r\n### What command(s) is the bug in?\r\n\r\nforge create\r\n\r\n### Operating System\r\n\r\nmacOS (Apple Silicon)\r\n\r\n### Describe the bug\r\n\r\nI include the third-party protocol contracts in the contract source file. Because these files live in their own repository, with their own compiling toolchain and stuff, I cannot simply drop their files to `lib`.\r\n\r\nI can still compile my contracts with some violence. In `foundry.toml` I have:\r\n\r\n```toml\r\n[profile.default]\r\n# solc is a hard mistress and simply refuses to compile relative paths down in the parent tree\r\n# allow the file system root and hope solc shuts up, as the error is not relevant\r\nallow_paths = [\"*\", \"/\"]\r\n```\r\n\r\n`foundry build` works fine with these settings.\r\n\r\nHowever the following command fails:\r\n\r\n```shell\r\nforge create --rpc-url $JSON_RPC_POLYGON \\\r\n    --constructor-args $USDC_TOKEN $VAULT_COMPTROLLER \\\r\n    --private-key $PRIVATE_KEY \\\r\n    --etherscan-api-key $POLYGONSCAN_API_KEY \\\r\n    --verify \\\r\n    src/VaultUSDCPaymentForwarder.sol:VaultUSDCPaymentForwarder\r\n```\r\n\r\nWith the error:\r\n\r\n```\r\nStart verifying contract `0xe3eaaba28b03d873304958eb30f412b6ccd4016c` deployed on polygon\r\n\r\nSubmitting verification for [src/VaultUSDCPaymentForwarder.sol:VaultUSDCPaymentForwarder] \"0xE3eAabA28B03d873304958EB30f412b6CCd4016c\".\r\n\r\nSubmitting verification for [src/VaultUSDCPaymentForwarder.sol:VaultUSDCPaymentForwarder] \"0xE3eAabA28B03d873304958EB30f412b6CCd4016c\".\r\n\r\nSubmitting verification for [src/VaultUSDCPaymentForwarder.sol:VaultUSDCPaymentForwarder] \"0xE3eAabA28B03d873304958EB30f412b6CCd4016c\".\r\nSubmitted contract for verification:\r\n        Response: `OK`\r\n        GUID: `uudsxq2pdcmkgcdabweyrwtgjjbynf5i2dbqqcyitv3vmuk256`\r\n        URL:\r\n        https://polygonscan.com/address/0xe3eaaba28b03d873304958eb30f412b6ccd4016c\r\nContract verification status:\r\nResponse: `NOTOK`\r\nDetails: `Pending in queue`\r\nContract verification status:\r\nResponse: `NOTOK`\r\nDetails: `Fail - Unable to verify. Solidity Compilation Error: Source \"../enzyme/node_modules/@openzeppelin/contracts/utils/Context.sol\" not found: File outside of allowed directories.`\r\nContract failed to verify.\r\n\r\n```\r\n\r\nSo it seems that `allow_paths` it only respected to `forge build`, but not for `forge create --verify`\r\n\r\nI assume this is because files are uploaded to Etherscan for compilation and it cannot handle relative paths. In this case, a flattened verification might work?",
  "closed_by": {
    "login": "miohtama",
    "id": 49922,
    "node_id": "MDQ6VXNlcjQ5OTIy",
    "avatar_url": "https://avatars.githubusercontent.com/u/49922?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/miohtama",
    "html_url": "https://github.com/miohtama",
    "followers_url": "https://api.github.com/users/miohtama/followers",
    "following_url": "https://api.github.com/users/miohtama/following{/other_user}",
    "gists_url": "https://api.github.com/users/miohtama/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/miohtama/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/miohtama/subscriptions",
    "organizations_url": "https://api.github.com/users/miohtama/orgs",
    "repos_url": "https://api.github.com/users/miohtama/repos",
    "events_url": "https://api.github.com/users/miohtama/events{/privacy}",
    "received_events_url": "https://api.github.com/users/miohtama/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/5003/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5003/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1557825609",
    "html_url": "https://github.com/foundry-rs/foundry/issues/5003#issuecomment-1557825609",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5003",
    "id": 1557825609,
    "node_id": "IC_kwDOGBlvNc5c2ohJ",
    "user": {
      "login": "mattsse",
      "id": 19890894,
      "node_id": "MDQ6VXNlcjE5ODkwODk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/19890894?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mattsse",
      "html_url": "https://github.com/mattsse",
      "followers_url": "https://api.github.com/users/mattsse/followers",
      "following_url": "https://api.github.com/users/mattsse/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattsse/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mattsse/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattsse/subscriptions",
      "organizations_url": "https://api.github.com/users/mattsse/orgs",
      "repos_url": "https://api.github.com/users/mattsse/repos",
      "events_url": "https://api.github.com/users/mattsse/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mattsse/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-22T19:30:01Z",
    "updated_at": "2023-05-22T19:30:01Z",
    "author_association": "MEMBER",
    "body": "The allowed-paths setting is a CLI only setting and can not be expressed via the standard json interface alone\r\n\r\n> I assume this is because files are uploaded to Etherscan for compilation and it cannot handle relative paths\r\n\r\nwhich means we can't tell (or at least I don't think it's possible) to tell etherscan how to add the `--allow-paths` solc argument\r\n\r\nhttps://docs.soliditylang.org/en/latest/using-the-compiler.html#compiler-api",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1557825609/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1557836370",
    "html_url": "https://github.com/foundry-rs/foundry/issues/5003#issuecomment-1557836370",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5003",
    "id": 1557836370,
    "node_id": "IC_kwDOGBlvNc5c2rJS",
    "user": {
      "login": "miohtama",
      "id": 49922,
      "node_id": "MDQ6VXNlcjQ5OTIy",
      "avatar_url": "https://avatars.githubusercontent.com/u/49922?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/miohtama",
      "html_url": "https://github.com/miohtama",
      "followers_url": "https://api.github.com/users/miohtama/followers",
      "following_url": "https://api.github.com/users/miohtama/following{/other_user}",
      "gists_url": "https://api.github.com/users/miohtama/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/miohtama/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/miohtama/subscriptions",
      "organizations_url": "https://api.github.com/users/miohtama/orgs",
      "repos_url": "https://api.github.com/users/miohtama/repos",
      "events_url": "https://api.github.com/users/miohtama/events{/privacy}",
      "received_events_url": "https://api.github.com/users/miohtama/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-22T19:37:16Z",
    "updated_at": "2023-05-22T19:37:16Z",
    "author_association": "NONE",
    "body": "As a workaround, I am attempting to verify manually but hitting another snag\r\n\r\n```shell\r\nforge verify-contract \\\r\n    --etherscan-api-key $POLYGONSCAN_API_KEY   --flatten \\\r\n    --constructor-args $(cast abi-encode \"constructor(address,address)\" $USDC_TOKEN $VAULT_COMPTROLLER )\\ \r\n     0xE3eAabA28B03d873304958EB30f412b6CCd4016c \\\r\n     src/VaultUSDCPaymentForwarder.sol:VaultUSDCPaymentForwarder\r\n```\r\n\r\n```\r\nStart verifying contract `0xe3eaaba28b03d873304958eb30f412b6ccd4016c` deployed on mainnet\r\nCompiler run failed:\r\nError: Invalid EVM version requested.\r\nFailed to compile the flattened code locally.\r\nThis could be a bug, please inspect the output of `forge flatten /Users/moo/code/ts/trade-executor/deps/web3-ethereum-defi/contracts/in-house/src/VaultUSDCPaymentForwarder.sol` and report an issue.\r\nTo skip this solc dry, pass `--force`.\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1557836370/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1557837501",
    "html_url": "https://github.com/foundry-rs/foundry/issues/5003#issuecomment-1557837501",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5003",
    "id": 1557837501,
    "node_id": "IC_kwDOGBlvNc5c2ra9",
    "user": {
      "login": "miohtama",
      "id": 49922,
      "node_id": "MDQ6VXNlcjQ5OTIy",
      "avatar_url": "https://avatars.githubusercontent.com/u/49922?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/miohtama",
      "html_url": "https://github.com/miohtama",
      "followers_url": "https://api.github.com/users/miohtama/followers",
      "following_url": "https://api.github.com/users/miohtama/following{/other_user}",
      "gists_url": "https://api.github.com/users/miohtama/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/miohtama/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/miohtama/subscriptions",
      "organizations_url": "https://api.github.com/users/miohtama/orgs",
      "repos_url": "https://api.github.com/users/miohtama/repos",
      "events_url": "https://api.github.com/users/miohtama/events{/privacy}",
      "received_events_url": "https://api.github.com/users/miohtama/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-22T19:38:18Z",
    "updated_at": "2023-05-22T19:38:18Z",
    "author_association": "NONE",
    "body": "With added `--force`, as `--flatten --force` another error message which I cannot make sense of:\r\n\r\n```\r\nVaultUSDCPaymentForwarder.sol:VaultUSDCPaymentForwarder\r\nStart verifying contract `0xe3eaaba28b03d873304958eb30f412b6ccd4016c` deployed on mainnet\r\nError: \r\nexpected value at line 1 column 1\r\n\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1557837501/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1557840624",
    "html_url": "https://github.com/foundry-rs/foundry/issues/5003#issuecomment-1557840624",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5003",
    "id": 1557840624,
    "node_id": "IC_kwDOGBlvNc5c2sLw",
    "user": {
      "login": "miohtama",
      "id": 49922,
      "node_id": "MDQ6VXNlcjQ5OTIy",
      "avatar_url": "https://avatars.githubusercontent.com/u/49922?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/miohtama",
      "html_url": "https://github.com/miohtama",
      "followers_url": "https://api.github.com/users/miohtama/followers",
      "following_url": "https://api.github.com/users/miohtama/following{/other_user}",
      "gists_url": "https://api.github.com/users/miohtama/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/miohtama/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/miohtama/subscriptions",
      "organizations_url": "https://api.github.com/users/miohtama/orgs",
      "repos_url": "https://api.github.com/users/miohtama/repos",
      "events_url": "https://api.github.com/users/miohtama/events{/privacy}",
      "received_events_url": "https://api.github.com/users/miohtama/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-22T19:41:08Z",
    "updated_at": "2023-05-22T19:41:08Z",
    "author_association": "NONE",
    "body": "Finally `forge verify-contract --chain polygon --flatten --force` did the trick. Closing this issue, as it is likely unfixable, or too hard to fix. It would be nice to have `--flatten` as a parameter for `forge create`, but might be a bit too niche use case for inter-protocol connoseurs.",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1557840624/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
