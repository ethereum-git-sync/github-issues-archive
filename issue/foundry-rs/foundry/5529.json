{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/5529",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5529/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5529/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5529/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/5529",
  "id": 1833862987,
  "node_id": "I_kwDOGBlvNc5tTodL",
  "number": 5529,
  "title": "bug: tests do not deploy via create2 the same as scripts",
  "user": {
    "login": "mds1",
    "id": 17163988,
    "node_id": "MDQ6VXNlcjE3MTYzOTg4",
    "avatar_url": "https://avatars.githubusercontent.com/u/17163988?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mds1",
    "html_url": "https://github.com/mds1",
    "followers_url": "https://api.github.com/users/mds1/followers",
    "following_url": "https://api.github.com/users/mds1/following{/other_user}",
    "gists_url": "https://api.github.com/users/mds1/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mds1/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mds1/subscriptions",
    "organizations_url": "https://api.github.com/users/mds1/orgs",
    "repos_url": "https://api.github.com/users/mds1/repos",
    "events_url": "https://api.github.com/users/mds1/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mds1/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3334394228,
      "node_id": "MDU6TGFiZWwzMzM0Mzk0MjI4",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-bug",
      "name": "T-bug",
      "color": "d73a4a",
      "default": false,
      "description": "Type: bug"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2023-08-02T20:28:19Z",
  "updated_at": "2023-08-02T20:42:28Z",
  "closed_at": null,
  "author_association": "COLLABORATOR",
  "active_lock_reason": null,
  "body": "### Component\n\nForge\n\n### Have you ensured that all of these are up to date?\n\n- [X] Foundry\n- [X] Foundryup\n\n### What version of Foundry are you on?\n\nforge 0.2.0 (ca67d15 2023-08-02T00:22:03.700607000Z)\n\n### What command(s) is the bug in?\n\nforge test\n\n### Operating System\n\nNone\n\n### Describe the bug\n\n1. `forge init` a new repo\r\n2. Add the below test\r\n```solidity\r\nfunction test1() public {\r\n    address a = computeCreate2Address(0, hashInitCode(type(Counter).creationCode), address(this));\r\n    address b = address(new Counter{salt: 0}());\r\n    require(a == b, \"create2 address mismatch\");\r\n}\r\n```\r\n3. Run `forge test --mt test1 -vvvv`, the test passes and deploys to `new Counter@0xBE03C2aFB559A5Ce6926b01A813F37584476c95f`\r\n4. Update the default script to run:\r\n```solidity\r\nfunction run() public {\r\n    vm.broadcast();\r\n    new Counter{salt: 0}();\r\n}\r\n```\r\n5. Run `forge script script/Counter.s.sol -vvvv` and you'll see it deploys to `new Counter@0xE414be17fD7aa8Ee7194000dc622AdEF3c81aFCd`\r\n\r\nThis shows that scripts (as expected) route create2 deploys through the default create2 deployer. But tests (unexpectedly) deploy directly from the test contract.\r\n\r\nI think the two behaviors should be consistent, especially since it's ideal to test scripts, and this behavior means we get different addresses depending on which command you invoke the script with (directly, or indirectly trough a test) which is confusing behavior\r\n\r\ncc @zobront",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/5529/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5529/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1662939999",
    "html_url": "https://github.com/foundry-rs/foundry/issues/5529#issuecomment-1662939999",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5529",
    "id": 1662939999,
    "node_id": "IC_kwDOGBlvNc5jHnNf",
    "user": {
      "login": "zobront",
      "id": 5749292,
      "node_id": "MDQ6VXNlcjU3NDkyOTI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5749292?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/zobront",
      "html_url": "https://github.com/zobront",
      "followers_url": "https://api.github.com/users/zobront/followers",
      "following_url": "https://api.github.com/users/zobront/following{/other_user}",
      "gists_url": "https://api.github.com/users/zobront/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/zobront/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/zobront/subscriptions",
      "organizations_url": "https://api.github.com/users/zobront/orgs",
      "repos_url": "https://api.github.com/users/zobront/repos",
      "events_url": "https://api.github.com/users/zobront/events{/privacy}",
      "received_events_url": "https://api.github.com/users/zobront/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-08-02T20:42:27Z",
    "updated_at": "2023-08-02T20:42:27Z",
    "author_association": "NONE",
    "body": "For a little context, the reason this came up is because I use deployment scripts as a part of test setup. \r\n\r\nBut the deployments via CREATE2 were ending up at different addresses between the two, which was causing certain tests to pass that shouldn't have.",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1662939999/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
