{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/2599",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/2599/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/2599/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/2599/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/2599",
  "id": 1328112258,
  "node_id": "I_kwDOGBlvNc5PKWKC",
  "number": 2599,
  "title": "Anvil treats \"pending\" and \"latest\" block the same in `eth_estimateGas`",
  "user": {
    "login": "ckoopmann",
    "id": 15629702,
    "node_id": "MDQ6VXNlcjE1NjI5NzAy",
    "avatar_url": "https://avatars.githubusercontent.com/u/15629702?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ckoopmann",
    "html_url": "https://github.com/ckoopmann",
    "followers_url": "https://api.github.com/users/ckoopmann/followers",
    "following_url": "https://api.github.com/users/ckoopmann/following{/other_user}",
    "gists_url": "https://api.github.com/users/ckoopmann/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ckoopmann/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ckoopmann/subscriptions",
    "organizations_url": "https://api.github.com/users/ckoopmann/orgs",
    "repos_url": "https://api.github.com/users/ckoopmann/repos",
    "events_url": "https://api.github.com/users/ckoopmann/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ckoopmann/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3334394228,
      "node_id": "MDU6TGFiZWwzMzM0Mzk0MjI4",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-bug",
      "name": "T-bug",
      "color": "d73a4a",
      "default": false,
      "description": "Type: bug"
    },
    {
      "id": 4077188949,
      "node_id": "LA_kwDOGBlvNc7zBPdV",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/C-anvil",
      "name": "C-anvil",
      "color": "5319E7",
      "default": false,
      "description": "Command: anvil"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2022-08-04T06:05:43Z",
  "updated_at": "2022-08-11T23:29:27Z",
  "closed_at": "2022-08-11T23:29:27Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "### Component\r\n\r\nAnvil\r\n\r\n### Have you ensured that all of these are up to date?\r\n\r\n- [X] Foundry\r\n- [X] Foundryup\r\n\r\n### What version of Foundry are you on?\r\n\r\nforge 0.2.0 (9b0575e 2022-08-04T00:10:43.515642Z)\r\n\r\n### What command(s) is the bug in?\r\n\r\nanvil\r\n\r\n### Operating System\r\n\r\nmacOS (Intel)\r\n\r\n### Describe the bug\r\n\r\nAnvil treats block ids \"pending\" and \"latest\" the same (on several methods including `eth_estimateGas`). \r\nTherefore pending transactions are disregarded resulting in incorrect behaviour (since the state should include \"the pending state/transactions\" as per the [eth json-rpc docs](https://ethereum.org/en/developers/docs/apis/json-rpc/#default-block)).\r\n\r\nRelevant code:\r\n[`do_estimate_gas`](https://github.com/foundry-rs/foundry/blob/e5fa7fa3581a134baf963a56af0c08843fa6d12c/anvil/src/eth/api.rs#L1580)\r\n[`ensure_block_number`](https://github.com/foundry-rs/foundry/blob/e5fa7fa3581a134baf963a56af0c08843fa6d12c/anvil/src/eth/backend/mem/mod.rs#L1018)\r\n\r\n\r\n",
  "closed_by": {
    "login": "mattsse",
    "id": 19890894,
    "node_id": "MDQ6VXNlcjE5ODkwODk0",
    "avatar_url": "https://avatars.githubusercontent.com/u/19890894?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mattsse",
    "html_url": "https://github.com/mattsse",
    "followers_url": "https://api.github.com/users/mattsse/followers",
    "following_url": "https://api.github.com/users/mattsse/following{/other_user}",
    "gists_url": "https://api.github.com/users/mattsse/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mattsse/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mattsse/subscriptions",
    "organizations_url": "https://api.github.com/users/mattsse/orgs",
    "repos_url": "https://api.github.com/users/mattsse/repos",
    "events_url": "https://api.github.com/users/mattsse/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mattsse/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/2599/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/2599/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1205150228",
    "html_url": "https://github.com/foundry-rs/foundry/issues/2599#issuecomment-1205150228",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/2599",
    "id": 1205150228,
    "node_id": "IC_kwDOGBlvNc5H1SIU",
    "user": {
      "login": "mattsse",
      "id": 19890894,
      "node_id": "MDQ6VXNlcjE5ODkwODk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/19890894?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mattsse",
      "html_url": "https://github.com/mattsse",
      "followers_url": "https://api.github.com/users/mattsse/followers",
      "following_url": "https://api.github.com/users/mattsse/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattsse/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mattsse/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattsse/subscriptions",
      "organizations_url": "https://api.github.com/users/mattsse/orgs",
      "repos_url": "https://api.github.com/users/mattsse/repos",
      "events_url": "https://api.github.com/users/mattsse/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mattsse/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-04T11:50:35Z",
    "updated_at": "2022-08-04T11:50:35Z",
    "author_association": "MEMBER",
    "body": "> Therefore pending transactions are disregarded resulting in incorrect behaviour\r\n\r\ncan you elaborate on this?\r\n\r\nwe only estimate the transaction with the current state",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1205150228/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1205267261",
    "html_url": "https://github.com/foundry-rs/foundry/issues/2599#issuecomment-1205267261",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/2599",
    "id": 1205267261,
    "node_id": "IC_kwDOGBlvNc5H1us9",
    "user": {
      "login": "ckoopmann",
      "id": 15629702,
      "node_id": "MDQ6VXNlcjE1NjI5NzAy",
      "avatar_url": "https://avatars.githubusercontent.com/u/15629702?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ckoopmann",
      "html_url": "https://github.com/ckoopmann",
      "followers_url": "https://api.github.com/users/ckoopmann/followers",
      "following_url": "https://api.github.com/users/ckoopmann/following{/other_user}",
      "gists_url": "https://api.github.com/users/ckoopmann/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ckoopmann/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ckoopmann/subscriptions",
      "organizations_url": "https://api.github.com/users/ckoopmann/orgs",
      "repos_url": "https://api.github.com/users/ckoopmann/repos",
      "events_url": "https://api.github.com/users/ckoopmann/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ckoopmann/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-04T13:35:25Z",
    "updated_at": "2022-08-04T13:35:25Z",
    "author_association": "CONTRIBUTOR",
    "body": "> > Therefore pending transactions are disregarded resulting in incorrect behaviour\r\n> \r\n> can you elaborate on this?\r\n> \r\n> we only estimate the transaction with the current state\r\n\r\nI might be misunderstanding the \"pending\" option for defaultBlock but I'd expect it to run the respective operation based on the state after applying all pending transactions. \r\nAs opposed to \"latest\" which uses the state of the latest mined block.\r\n\r\nFor example if there is a pending (yet unmined) transaction that alters the state such that the transaction I'm trying to estimate fails i'd expect:\r\n1. The estimation to fail/revert when run with \"pending\"\r\n2. Succeed when run with \"latest\"\r\n\r\nRight now both \"latest\" and \"pending\" use the state of the latest mined block as far as I can see. ",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1205267261/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1205269914",
    "html_url": "https://github.com/foundry-rs/foundry/issues/2599#issuecomment-1205269914",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/2599",
    "id": 1205269914,
    "node_id": "IC_kwDOGBlvNc5H1vWa",
    "user": {
      "login": "ckoopmann",
      "id": 15629702,
      "node_id": "MDQ6VXNlcjE1NjI5NzAy",
      "avatar_url": "https://avatars.githubusercontent.com/u/15629702?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ckoopmann",
      "html_url": "https://github.com/ckoopmann",
      "followers_url": "https://api.github.com/users/ckoopmann/followers",
      "following_url": "https://api.github.com/users/ckoopmann/following{/other_user}",
      "gists_url": "https://api.github.com/users/ckoopmann/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ckoopmann/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ckoopmann/subscriptions",
      "organizations_url": "https://api.github.com/users/ckoopmann/orgs",
      "repos_url": "https://api.github.com/users/ckoopmann/repos",
      "events_url": "https://api.github.com/users/ckoopmann/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ckoopmann/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-04T13:37:31Z",
    "updated_at": "2022-08-04T13:37:31Z",
    "author_association": "CONTRIBUTOR",
    "body": "For example in the case of the transactionCount we are already incorporating the pending transactions:\r\nhttps://github.com/foundry-rs/foundry/blob/26893ff421093f0904f04db02407b180ee8d5e6e/anvil/src/eth/api.rs#L1875",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1205269914/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1205708528",
    "html_url": "https://github.com/foundry-rs/foundry/issues/2599#issuecomment-1205708528",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/2599",
    "id": 1205708528,
    "node_id": "IC_kwDOGBlvNc5H3abw",
    "user": {
      "login": "tynes",
      "id": 6626818,
      "node_id": "MDQ6VXNlcjY2MjY4MTg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6626818?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tynes",
      "html_url": "https://github.com/tynes",
      "followers_url": "https://api.github.com/users/tynes/followers",
      "following_url": "https://api.github.com/users/tynes/following{/other_user}",
      "gists_url": "https://api.github.com/users/tynes/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tynes/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tynes/subscriptions",
      "organizations_url": "https://api.github.com/users/tynes/orgs",
      "repos_url": "https://api.github.com/users/tynes/repos",
      "events_url": "https://api.github.com/users/tynes/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tynes/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-04T19:58:25Z",
    "updated_at": "2022-08-04T19:58:25Z",
    "author_association": "CONTRIBUTOR",
    "body": "There is a pending `StateDB` in geth that transactions from the mempool are applied against, it prevents transactions with the same nonce from entering the mempool unless its a replace by fee transaction. I'm not sure if anvil has the same kind of thing, but the `pending` block tag executes against that `StateDB` while `latest` executes against a `StateDB` rooted from the tip of the chain",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1205708528/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
