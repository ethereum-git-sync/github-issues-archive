{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/3096",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3096/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3096/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3096/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/3096",
  "id": 1363002345,
  "node_id": "I_kwDOGBlvNc5RPcPp",
  "number": 3096,
  "title": "can't connect to anvil using websocket",
  "user": {
    "login": "skrabmir",
    "id": 16179769,
    "node_id": "MDQ6VXNlcjE2MTc5NzY5",
    "avatar_url": "https://avatars.githubusercontent.com/u/16179769?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/skrabmir",
    "html_url": "https://github.com/skrabmir",
    "followers_url": "https://api.github.com/users/skrabmir/followers",
    "following_url": "https://api.github.com/users/skrabmir/following{/other_user}",
    "gists_url": "https://api.github.com/users/skrabmir/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/skrabmir/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/skrabmir/subscriptions",
    "organizations_url": "https://api.github.com/users/skrabmir/orgs",
    "repos_url": "https://api.github.com/users/skrabmir/repos",
    "events_url": "https://api.github.com/users/skrabmir/events{/privacy}",
    "received_events_url": "https://api.github.com/users/skrabmir/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3334394228,
      "node_id": "MDU6TGFiZWwzMzM0Mzk0MjI4",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-bug",
      "name": "T-bug",
      "color": "d73a4a",
      "default": false,
      "description": "Type: bug"
    },
    {
      "id": 4077188949,
      "node_id": "LA_kwDOGBlvNc7zBPdV",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/C-anvil",
      "name": "C-anvil",
      "color": "5319E7",
      "default": false,
      "description": "Command: anvil"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "mattsse",
    "id": 19890894,
    "node_id": "MDQ6VXNlcjE5ODkwODk0",
    "avatar_url": "https://avatars.githubusercontent.com/u/19890894?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mattsse",
    "html_url": "https://github.com/mattsse",
    "followers_url": "https://api.github.com/users/mattsse/followers",
    "following_url": "https://api.github.com/users/mattsse/following{/other_user}",
    "gists_url": "https://api.github.com/users/mattsse/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mattsse/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mattsse/subscriptions",
    "organizations_url": "https://api.github.com/users/mattsse/orgs",
    "repos_url": "https://api.github.com/users/mattsse/repos",
    "events_url": "https://api.github.com/users/mattsse/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mattsse/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "mattsse",
      "id": 19890894,
      "node_id": "MDQ6VXNlcjE5ODkwODk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/19890894?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mattsse",
      "html_url": "https://github.com/mattsse",
      "followers_url": "https://api.github.com/users/mattsse/followers",
      "following_url": "https://api.github.com/users/mattsse/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattsse/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mattsse/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattsse/subscriptions",
      "organizations_url": "https://api.github.com/users/mattsse/orgs",
      "repos_url": "https://api.github.com/users/mattsse/repos",
      "events_url": "https://api.github.com/users/mattsse/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mattsse/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 6,
  "created_at": "2022-09-06T09:39:47Z",
  "updated_at": "2022-09-07T18:26:02Z",
  "closed_at": "2022-09-06T16:09:57Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Component\n\nAnvil\n\n### Have you ensured that all of these are up to date?\n\n- [X] Foundry\n- [X] Foundryup\n\n### What version of Foundry are you on?\n\nanvil 0.1.0 (014f7c4 2022-09-06T00:04:17.18834Z)\n\n### What command(s) is the bug in?\n\n./anvil\n\n### Operating System\n\nmacOS (Apple Silicon)\n\n### Describe the bug\n\nI'm using web3py (v6.0.0) library to connect to `anvil`. I'm using python 3.8. The connection is fine when using HTTP, however with ws the code immediately throws. When I run the same code with `hardhat node` it works without any problems.\r\n\r\nHere is a minimalistic snippet that throws: \r\n```python\r\nself.__w3 = Web3(Web3.WebsocketProvider(f\"ws://127.0.0.1:{str(port)}\", websocket_timeout=60))\r\nclient_version: str = self.__w3.clientVersion\r\n```\r\n\r\nHere is the output:\r\n```\r\nFile \"/tooling/woke/venv/lib/python3.8/site-packages/web3/middleware/buffered_gas_estimate.py\", line 40, in middleware\r\n    return make_request(method, params)\r\n  File \"/tooling/woke/venv/lib/python3.8/site-packages/web3/providers/websocket.py\", line 135, in make_request\r\n    return future.result()\r\n  File \"/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.8/lib/python3.8/concurrent/futures/_base.py\", line 444, in result\r\n    return self.__get_result()\r\n  File \"/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.8/lib/python3.8/concurrent/futures/_base.py\", line 389, in __get_result\r\n    raise self._exception\r\n  File \"/tooling/woke/venv/lib/python3.8/site-packages/web3/providers/websocket.py\", line 124, in coro_make_request\r\n    await asyncio.wait_for(conn.recv(), timeout=self.websocket_timeout)\r\n  File \"/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.8/lib/python3.8/asyncio/tasks.py\", line 494, in wait_for\r\n    return fut.result()\r\n  File \"/tooling/woke/venv/lib/python3.8/site-packages/websockets/legacy/protocol.py\", line 553, in recv\r\n    await self.ensure_open()\r\n  File \"/tooling/woke/venv/lib/python3.8/site-packages/websockets/legacy/protocol.py\", line 921, in ensure_open\r\n    raise self.connection_closed_exc()\r\nwebsockets.exceptions.ConnectionClosedError: no close frame received or sent\r\n```\r\n\r\nThe anvil node doesn't produce any output in the terminal window (apart from the default account, private keys etc).",
  "closed_by": {
    "login": "gakonst",
    "id": 17802178,
    "node_id": "MDQ6VXNlcjE3ODAyMTc4",
    "avatar_url": "https://avatars.githubusercontent.com/u/17802178?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/gakonst",
    "html_url": "https://github.com/gakonst",
    "followers_url": "https://api.github.com/users/gakonst/followers",
    "following_url": "https://api.github.com/users/gakonst/following{/other_user}",
    "gists_url": "https://api.github.com/users/gakonst/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/gakonst/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/gakonst/subscriptions",
    "organizations_url": "https://api.github.com/users/gakonst/orgs",
    "repos_url": "https://api.github.com/users/gakonst/repos",
    "events_url": "https://api.github.com/users/gakonst/events{/privacy}",
    "received_events_url": "https://api.github.com/users/gakonst/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/3096/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3096/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1238090754",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3096#issuecomment-1238090754",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3096",
    "id": 1238090754,
    "node_id": "IC_kwDOGBlvNc5Jy8QC",
    "user": {
      "login": "mattsse",
      "id": 19890894,
      "node_id": "MDQ6VXNlcjE5ODkwODk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/19890894?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mattsse",
      "html_url": "https://github.com/mattsse",
      "followers_url": "https://api.github.com/users/mattsse/followers",
      "following_url": "https://api.github.com/users/mattsse/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattsse/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mattsse/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattsse/subscriptions",
      "organizations_url": "https://api.github.com/users/mattsse/orgs",
      "repos_url": "https://api.github.com/users/mattsse/repos",
      "events_url": "https://api.github.com/users/mattsse/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mattsse/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-06T12:35:08Z",
    "updated_at": "2022-09-06T12:35:08Z",
    "author_association": "MEMBER",
    "body": "hmm, would love to debug this.\r\n\r\ncould you perhaps provide an example that I can run?",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1238090754/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1238121486",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3096#issuecomment-1238121486",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3096",
    "id": 1238121486,
    "node_id": "IC_kwDOGBlvNc5JzDwO",
    "user": {
      "login": "skrabmir",
      "id": 16179769,
      "node_id": "MDQ6VXNlcjE2MTc5NzY5",
      "avatar_url": "https://avatars.githubusercontent.com/u/16179769?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/skrabmir",
      "html_url": "https://github.com/skrabmir",
      "followers_url": "https://api.github.com/users/skrabmir/followers",
      "following_url": "https://api.github.com/users/skrabmir/following{/other_user}",
      "gists_url": "https://api.github.com/users/skrabmir/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/skrabmir/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/skrabmir/subscriptions",
      "organizations_url": "https://api.github.com/users/skrabmir/orgs",
      "repos_url": "https://api.github.com/users/skrabmir/repos",
      "events_url": "https://api.github.com/users/skrabmir/events{/privacy}",
      "received_events_url": "https://api.github.com/users/skrabmir/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-06T13:02:52Z",
    "updated_at": "2022-09-06T13:02:52Z",
    "author_association": "NONE",
    "body": "yeah, sure. \r\nyou'll need to install web3 - `pip install web3`\r\n\r\ntry this - happy scenario is that the version gets printed:\r\n```python\r\nfrom web3 import Web3\r\n\r\nclass AnvilDebug:\r\n    __w3: Web3\r\n    def __init__(self, port: int):\r\n        self.__w3 = Web3(Web3.WebsocketProvider(f\"ws://127.0.0.1:{str(port)}\", websocket_timeout=60))\r\n        client_version: str = self.__w3.clientVersion.lower()\r\n        print(f\"client version: {client_version}\")\r\n\r\n\r\nanvil_debug = AnvilDebug(8545)\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1238121486/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 1,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1238187524",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3096#issuecomment-1238187524",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3096",
    "id": 1238187524,
    "node_id": "IC_kwDOGBlvNc5JzT4E",
    "user": {
      "login": "mattsse",
      "id": 19890894,
      "node_id": "MDQ6VXNlcjE5ODkwODk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/19890894?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mattsse",
      "html_url": "https://github.com/mattsse",
      "followers_url": "https://api.github.com/users/mattsse/followers",
      "following_url": "https://api.github.com/users/mattsse/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattsse/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mattsse/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattsse/subscriptions",
      "organizations_url": "https://api.github.com/users/mattsse/orgs",
      "repos_url": "https://api.github.com/users/mattsse/repos",
      "events_url": "https://api.github.com/users/mattsse/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mattsse/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-06T13:55:51Z",
    "updated_at": "2022-09-06T13:55:51Z",
    "author_association": "MEMBER",
    "body": "can reproduce, but anvil receives the request, but the request is binary websocket, anvil currently only handles text\r\n\r\nwill try to add this",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1238187524/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1238203943",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3096#issuecomment-1238203943",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3096",
    "id": 1238203943,
    "node_id": "IC_kwDOGBlvNc5JzX4n",
    "user": {
      "login": "mattsse",
      "id": 19890894,
      "node_id": "MDQ6VXNlcjE5ODkwODk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/19890894?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mattsse",
      "html_url": "https://github.com/mattsse",
      "followers_url": "https://api.github.com/users/mattsse/followers",
      "following_url": "https://api.github.com/users/mattsse/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattsse/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mattsse/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattsse/subscriptions",
      "organizations_url": "https://api.github.com/users/mattsse/orgs",
      "repos_url": "https://api.github.com/users/mattsse/repos",
      "events_url": "https://api.github.com/users/mattsse/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mattsse/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-06T14:08:22Z",
    "updated_at": "2022-09-06T14:08:22Z",
    "author_association": "MEMBER",
    "body": "with #3100 the example works as expected\r\n\r\n```console\r\npython3 demo.py                                                                \r\nclient version: anvil/v0.1.0\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1238203943/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1239211661",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3096#issuecomment-1239211661",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3096",
    "id": 1239211661,
    "node_id": "IC_kwDOGBlvNc5J3N6N",
    "user": {
      "login": "skrabmir",
      "id": 16179769,
      "node_id": "MDQ6VXNlcjE2MTc5NzY5",
      "avatar_url": "https://avatars.githubusercontent.com/u/16179769?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/skrabmir",
      "html_url": "https://github.com/skrabmir",
      "followers_url": "https://api.github.com/users/skrabmir/followers",
      "following_url": "https://api.github.com/users/skrabmir/following{/other_user}",
      "gists_url": "https://api.github.com/users/skrabmir/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/skrabmir/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/skrabmir/subscriptions",
      "organizations_url": "https://api.github.com/users/skrabmir/orgs",
      "repos_url": "https://api.github.com/users/skrabmir/repos",
      "events_url": "https://api.github.com/users/skrabmir/events{/privacy}",
      "received_events_url": "https://api.github.com/users/skrabmir/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-07T10:34:53Z",
    "updated_at": "2022-09-07T10:34:53Z",
    "author_association": "NONE",
    "body": "perfect! everything seems to run smoothly now on our side (and much faster 👍 ).\r\nthanks!",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1239211661/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1239730941",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3096#issuecomment-1239730941",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3096",
    "id": 1239730941,
    "node_id": "IC_kwDOGBlvNc5J5Mr9",
    "user": {
      "login": "gakonst",
      "id": 17802178,
      "node_id": "MDQ6VXNlcjE3ODAyMTc4",
      "avatar_url": "https://avatars.githubusercontent.com/u/17802178?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gakonst",
      "html_url": "https://github.com/gakonst",
      "followers_url": "https://api.github.com/users/gakonst/followers",
      "following_url": "https://api.github.com/users/gakonst/following{/other_user}",
      "gists_url": "https://api.github.com/users/gakonst/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gakonst/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gakonst/subscriptions",
      "organizations_url": "https://api.github.com/users/gakonst/orgs",
      "repos_url": "https://api.github.com/users/gakonst/repos",
      "events_url": "https://api.github.com/users/gakonst/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gakonst/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-07T18:26:01Z",
    "updated_at": "2022-09-07T18:26:01Z",
    "author_association": "MEMBER",
    "body": "sweet!",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1239730941/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
