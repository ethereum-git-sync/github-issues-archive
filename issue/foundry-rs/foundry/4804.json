{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/4804",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4804/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4804/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4804/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/4804",
  "id": 1679518972,
  "node_id": "I_kwDOGBlvNc5kG2z8",
  "number": 4804,
  "title": "address(this).balance randomly set to msg.value instead of increased during stateful invariant test",
  "user": {
    "login": "devdacian",
    "id": 114125154,
    "node_id": "U_kgDOBs1pYg",
    "avatar_url": "https://avatars.githubusercontent.com/u/114125154?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/devdacian",
    "html_url": "https://github.com/devdacian",
    "followers_url": "https://api.github.com/users/devdacian/followers",
    "following_url": "https://api.github.com/users/devdacian/following{/other_user}",
    "gists_url": "https://api.github.com/users/devdacian/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/devdacian/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/devdacian/subscriptions",
    "organizations_url": "https://api.github.com/users/devdacian/orgs",
    "repos_url": "https://api.github.com/users/devdacian/repos",
    "events_url": "https://api.github.com/users/devdacian/events{/privacy}",
    "received_events_url": "https://api.github.com/users/devdacian/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3334394228,
      "node_id": "MDU6TGFiZWwzMzM0Mzk0MjI4",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-bug",
      "name": "T-bug",
      "color": "d73a4a",
      "default": false,
      "description": "Type: bug"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2023-04-22T12:26:11Z",
  "updated_at": "2023-05-08T17:40:14Z",
  "closed_at": "2023-05-08T17:40:13Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Component\r\n\r\nForge\r\n\r\n### Have you ensured that all of these are up to date?\r\n\r\n- [X] Foundry\r\n- [X] Foundryup\r\n\r\n### What version of Foundry are you on?\r\n\r\nforge 0.2.0 (3092735 2023-05-06T00:11:27.504616630Z)\r\n\r\n### What command(s) is the bug in?\r\n\r\nforge test -vvv\r\n\r\n### Operating System\r\n\r\nLinux\r\n\r\n### Describe the bug\r\n\r\nWhen running stateful fuzz test on simple Vault contract, after a random deposit() the Vault's address(this).balance randomly gets set to msg.value instead of being incremented, making the stateful test fail - doesn't happen all the time, seems random. This occurred while fuzzing a larger contract so I've created the bare minimum [proof of concept](https://github.com/devdacian/foundry-bug-report-4808) to show the bug.\r\n",
  "closed_by": {
    "login": "mds1",
    "id": 17163988,
    "node_id": "MDQ6VXNlcjE3MTYzOTg4",
    "avatar_url": "https://avatars.githubusercontent.com/u/17163988?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mds1",
    "html_url": "https://github.com/mds1",
    "followers_url": "https://api.github.com/users/mds1/followers",
    "following_url": "https://api.github.com/users/mds1/following{/other_user}",
    "gists_url": "https://api.github.com/users/mds1/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mds1/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mds1/subscriptions",
    "organizations_url": "https://api.github.com/users/mds1/orgs",
    "repos_url": "https://api.github.com/users/mds1/repos",
    "events_url": "https://api.github.com/users/mds1/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mds1/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/4804/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4804/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1521704356",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4804#issuecomment-1521704356",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4804",
    "id": 1521704356,
    "node_id": "IC_kwDOGBlvNc5as12k",
    "user": {
      "login": "KholdStare",
      "id": 836110,
      "node_id": "MDQ6VXNlcjgzNjExMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/836110?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/KholdStare",
      "html_url": "https://github.com/KholdStare",
      "followers_url": "https://api.github.com/users/KholdStare/followers",
      "following_url": "https://api.github.com/users/KholdStare/following{/other_user}",
      "gists_url": "https://api.github.com/users/KholdStare/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/KholdStare/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/KholdStare/subscriptions",
      "organizations_url": "https://api.github.com/users/KholdStare/orgs",
      "repos_url": "https://api.github.com/users/KholdStare/repos",
      "events_url": "https://api.github.com/users/KholdStare/events{/privacy}",
      "received_events_url": "https://api.github.com/users/KholdStare/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-25T12:27:35Z",
    "updated_at": "2023-04-25T12:27:35Z",
    "author_association": "CONTRIBUTOR",
    "body": "Not a maintainer, but I'd recommend making a public github repo as a foundry project instead of a zip file. Simplifying the steps required to reproduce for the maintainers goes a long way to help address the issue.",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1521704356/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1522386257",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4804#issuecomment-1522386257",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4804",
    "id": 1522386257,
    "node_id": "IC_kwDOGBlvNc5avcVR",
    "user": {
      "login": "mds1",
      "id": 17163988,
      "node_id": "MDQ6VXNlcjE3MTYzOTg4",
      "avatar_url": "https://avatars.githubusercontent.com/u/17163988?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mds1",
      "html_url": "https://github.com/mds1",
      "followers_url": "https://api.github.com/users/mds1/followers",
      "following_url": "https://api.github.com/users/mds1/following{/other_user}",
      "gists_url": "https://api.github.com/users/mds1/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mds1/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mds1/subscriptions",
      "organizations_url": "https://api.github.com/users/mds1/orgs",
      "repos_url": "https://api.github.com/users/mds1/repos",
      "events_url": "https://api.github.com/users/mds1/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mds1/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-25T20:39:30Z",
    "updated_at": "2023-04-25T20:39:30Z",
    "author_association": "COLLABORATOR",
    "body": "Yea @devdacian if you can provide a repo that we can pull down and run `forge test` on to show the bug that'd be great. Also don't want to download an untrusted zip file 😅",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1522386257/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1522918183",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4804#issuecomment-1522918183",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4804",
    "id": 1522918183,
    "node_id": "IC_kwDOGBlvNc5axeMn",
    "user": {
      "login": "devdacian",
      "id": 114125154,
      "node_id": "U_kgDOBs1pYg",
      "avatar_url": "https://avatars.githubusercontent.com/u/114125154?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/devdacian",
      "html_url": "https://github.com/devdacian",
      "followers_url": "https://api.github.com/users/devdacian/followers",
      "following_url": "https://api.github.com/users/devdacian/following{/other_user}",
      "gists_url": "https://api.github.com/users/devdacian/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/devdacian/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/devdacian/subscriptions",
      "organizations_url": "https://api.github.com/users/devdacian/orgs",
      "repos_url": "https://api.github.com/users/devdacian/repos",
      "events_url": "https://api.github.com/users/devdacian/events{/privacy}",
      "received_events_url": "https://api.github.com/users/devdacian/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-26T07:27:21Z",
    "updated_at": "2023-04-26T07:27:21Z",
    "author_association": "NONE",
    "body": "@mds1 thank you for letting me know, have done as requested https://github.com/devdacian/foundry-bug-report-4808",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1522918183/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1538775348",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4804#issuecomment-1538775348",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4804",
    "id": 1538775348,
    "node_id": "IC_kwDOGBlvNc5bt9k0",
    "user": {
      "login": "mds1",
      "id": 17163988,
      "node_id": "MDQ6VXNlcjE3MTYzOTg4",
      "avatar_url": "https://avatars.githubusercontent.com/u/17163988?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mds1",
      "html_url": "https://github.com/mds1",
      "followers_url": "https://api.github.com/users/mds1/followers",
      "following_url": "https://api.github.com/users/mds1/following{/other_user}",
      "gists_url": "https://api.github.com/users/mds1/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mds1/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mds1/subscriptions",
      "organizations_url": "https://api.github.com/users/mds1/orgs",
      "repos_url": "https://api.github.com/users/mds1/repos",
      "events_url": "https://api.github.com/users/mds1/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mds1/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-08T17:40:13Z",
    "updated_at": "2023-05-08T17:40:13Z",
    "author_association": "COLLABORATOR",
    "body": "The problem is that sometimes the actor you prank as is the vault address, so the `vm.deal` line overwrites the balance of the vault, so it's no longer in sync with `totalDeposited`. You can see this from the traces, copied below, where it has the name of the `Vault` contract in the args for the deal/prank calls\r\n\r\n```\r\n  [96416] InvariantVault::deposit(51466168253907808369)\r\n    ├─ [0] console::log(Bound Result, 1966168253907808364) [staticcall]\r\n    │   └─ ← ()\r\n    ├─ [0] VM::deal(Vault: [0x5615dEB798BB3E4dFa0139dFa1b3D433Cc23b72f], 1966168253907808364)\r\n    │   └─ ← ()\r\n    ├─ [0] VM::prank(Vault: [0x5615dEB798BB3E4dFa0139dFa1b3D433Cc23b72f])\r\n    │   └─ ← ()\r\n    ├─ [14004] Vault::deposit{value: 1966168253907808364}()\r\n    │   ├─ [0] console::log(actor          : , Vault: [0x5615dEB798BB3E4dFa0139dFa1b3D433Cc23b72f]) [staticcall]\r\n    │   │   └─ ← ()\r\n    │   ├─ [0] console::log(amount         : , 1966168253907808364) [staticcall]\r\n    │   │   └─ ← ()\r\n    │   ├─ [0] console::log(balance        : , 1966168253907808364) [staticcall]\r\n    │   │   └─ ← ()\r\n    │   ├─ [0] console::log(depositCount   : , 5) [staticcall]\r\n    │   │   └─ ← ()\r\n    │   ├─ [0] console::log(totalDeposited : , 20305052194168748199) [staticcall]\r\n    │   │   └─ ← ()\r\n    │   └─ ← ()\r\n    └─ ← ()\r\n\r\n  [26769] VaultTest::invariant_addrBalance_eq_totalDeposited()\r\n    ├─ [2305] InvariantVault::totalDeposited() [staticcall]\r\n    │   └─ ← 20305052194168748199\r\n    ├─ emit log(: Error: a == b not satisfied [uint])\r\n    ├─ emit log_named_uint(key:       Left, val: 1966168253907808364)\r\n    ├─ emit log_named_uint(key:      Right, val: 20305052194168748199)\r\n    ├─ [0] VM::store(VM: [0x7109709ECfa91a80626fF3989D68f67F5b1DD12D], 0x6661696c65640000000000000000000000000000000000000000000000000000, 0x0000000000000000000000000000000000000000000000000000000000000001)\r\n    │   └─ ← ()\r\n    └─ ← ()\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1538775348/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
