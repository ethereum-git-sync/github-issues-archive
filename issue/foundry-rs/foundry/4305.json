{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/4305",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4305/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4305/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4305/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/4305",
  "id": 1575865791,
  "node_id": "I_kwDOGBlvNc5d7c2_",
  "number": 4305,
  "title": "bug(forge): coverage does not work with return values assigned to library calls",
  "user": {
    "login": "PaulRBerg",
    "id": 8782666,
    "node_id": "MDQ6VXNlcjg3ODI2NjY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/8782666?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/PaulRBerg",
    "html_url": "https://github.com/PaulRBerg",
    "followers_url": "https://api.github.com/users/PaulRBerg/followers",
    "following_url": "https://api.github.com/users/PaulRBerg/following{/other_user}",
    "gists_url": "https://api.github.com/users/PaulRBerg/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/PaulRBerg/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/PaulRBerg/subscriptions",
    "organizations_url": "https://api.github.com/users/PaulRBerg/orgs",
    "repos_url": "https://api.github.com/users/PaulRBerg/repos",
    "events_url": "https://api.github.com/users/PaulRBerg/events{/privacy}",
    "received_events_url": "https://api.github.com/users/PaulRBerg/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3334394228,
      "node_id": "MDU6TGFiZWwzMzM0Mzk0MjI4",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-bug",
      "name": "T-bug",
      "color": "d73a4a",
      "default": false,
      "description": "Type: bug"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2023-02-08T10:27:48Z",
  "updated_at": "2023-06-29T04:00:28Z",
  "closed_at": "2023-06-29T04:00:27Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "### Component\n\nForge\n\n### Have you ensured that all of these are up to date?\n\n- [X] Foundry\n- [X] Foundryup\n\n### What version of Foundry are you on?\n\nforge 0.2.0 (249538f 2023-02-08T00:12:05.805004Z)\n\n### What command(s) is the bug in?\n\nforge coverage\n\n### Operating System\n\nmacOS (Apple Silicon)\n\n### Describe the bug\n\nThis bug has been first reported by @ZeroEkkusu in this [comment](https://github.com/foundry-rs/foundry/pull/3128#issuecomment-1241245086). I have opened a separate issue to track this because I think that it is an important and subtle bug, which can easily lead Foundry users astray (i.e. make them believe there's something wrong with their tests or library code when in fact there isn't).\r\n\r\nThe bug occurs when a return value is assigned to a library call, like this:\r\n\r\n```solidity\r\nlibrary Helpers {\r\n    function gte(uint256 element, uint256[] memory items) internal pure returns (bool) {\r\n        if (items.length == 0) {\r\n            revert(\"Items array is empty\");\r\n        }\r\n        return element >= items[0];\r\n    }\r\n}\r\n\r\ncontract Foo {\r\n    function gte(uint256 element, uint256[] memory items) external pure returns (bool) {\r\n        // This is where the bug happens üëá\r\n        return Helpers.gte(element, items);\r\n    }\r\n}\r\n```\r\n\r\nGiven the code above, Forge will generate the following coverage report, which is incorrect:\r\n\r\n<img width=\"980\" alt=\"Screenshot 2023-02-08 at 12 22 30 PM\" src=\"https://user-images.githubusercontent.com/8782666/217502768-2b9684b3-638d-41a2-8c25-1b20633bc2dc.png\">\r\n\r\nAssigning the library call to a variable fixes this:\r\n\r\n```solidity\r\nfunction gte(uint256 element, uint256[] memory items) external pure returns (bool) {\r\n    bool result = Helpers.gte(element, items);\r\n    return result;\r\n}\r\n```\r\n\r\nHowever, this is bad practice. Production code should not be optimized for coverage reports.\r\n\r\nAs @onbjerg said [here](https://github.com/foundry-rs/foundry/pull/3128#issuecomment-1241924127), the bug may be related to the walking of the right-hand side of expressions.",
  "closed_by": {
    "login": "Evalir",
    "id": 26014927,
    "node_id": "MDQ6VXNlcjI2MDE0OTI3",
    "avatar_url": "https://avatars.githubusercontent.com/u/26014927?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Evalir",
    "html_url": "https://github.com/Evalir",
    "followers_url": "https://api.github.com/users/Evalir/followers",
    "following_url": "https://api.github.com/users/Evalir/following{/other_user}",
    "gists_url": "https://api.github.com/users/Evalir/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Evalir/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Evalir/subscriptions",
    "organizations_url": "https://api.github.com/users/Evalir/orgs",
    "repos_url": "https://api.github.com/users/Evalir/repos",
    "events_url": "https://api.github.com/users/Evalir/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Evalir/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/4305/reactions",
    "total_count": 2,
    "+1": 2,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4305/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1569808149",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4305#issuecomment-1569808149",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4305",
    "id": 1569808149,
    "node_id": "IC_kwDOGBlvNc5dkV8V",
    "user": {
      "login": "haythemsellami",
      "id": 17862704,
      "node_id": "MDQ6VXNlcjE3ODYyNzA0",
      "avatar_url": "https://avatars.githubusercontent.com/u/17862704?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/haythemsellami",
      "html_url": "https://github.com/haythemsellami",
      "followers_url": "https://api.github.com/users/haythemsellami/followers",
      "following_url": "https://api.github.com/users/haythemsellami/following{/other_user}",
      "gists_url": "https://api.github.com/users/haythemsellami/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/haythemsellami/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/haythemsellami/subscriptions",
      "organizations_url": "https://api.github.com/users/haythemsellami/orgs",
      "repos_url": "https://api.github.com/users/haythemsellami/repos",
      "events_url": "https://api.github.com/users/haythemsellami/events{/privacy}",
      "received_events_url": "https://api.github.com/users/haythemsellami/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-31T09:13:52Z",
    "updated_at": "2023-05-31T09:13:52Z",
    "author_association": "NONE",
    "body": "Facing same issue ",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1569808149/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1569832213",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4305#issuecomment-1569832213",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4305",
    "id": 1569832213,
    "node_id": "IC_kwDOGBlvNc5dkb0V",
    "user": {
      "login": "PaulRBerg",
      "id": 8782666,
      "node_id": "MDQ6VXNlcjg3ODI2NjY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8782666?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/PaulRBerg",
      "html_url": "https://github.com/PaulRBerg",
      "followers_url": "https://api.github.com/users/PaulRBerg/followers",
      "following_url": "https://api.github.com/users/PaulRBerg/following{/other_user}",
      "gists_url": "https://api.github.com/users/PaulRBerg/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/PaulRBerg/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/PaulRBerg/subscriptions",
      "organizations_url": "https://api.github.com/users/PaulRBerg/orgs",
      "repos_url": "https://api.github.com/users/PaulRBerg/repos",
      "events_url": "https://api.github.com/users/PaulRBerg/events{/privacy}",
      "received_events_url": "https://api.github.com/users/PaulRBerg/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-31T09:29:47Z",
    "updated_at": "2023-05-31T09:29:47Z",
    "author_association": "CONTRIBUTOR",
    "body": "@haythemsellami you can use the thumbs up emoji (üëç) if you don't have anything to add.",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1569832213/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1574881260",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4305#issuecomment-1574881260",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4305",
    "id": 1574881260,
    "node_id": "IC_kwDOGBlvNc5d3sfs",
    "user": {
      "login": "Picodes",
      "id": 41673773,
      "node_id": "MDQ6VXNlcjQxNjczNzcz",
      "avatar_url": "https://avatars.githubusercontent.com/u/41673773?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Picodes",
      "html_url": "https://github.com/Picodes",
      "followers_url": "https://api.github.com/users/Picodes/followers",
      "following_url": "https://api.github.com/users/Picodes/following{/other_user}",
      "gists_url": "https://api.github.com/users/Picodes/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Picodes/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Picodes/subscriptions",
      "organizations_url": "https://api.github.com/users/Picodes/orgs",
      "repos_url": "https://api.github.com/users/Picodes/repos",
      "events_url": "https://api.github.com/users/Picodes/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Picodes/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-06-03T11:35:22Z",
    "updated_at": "2023-06-03T11:35:22Z",
    "author_association": "CONTRIBUTOR",
    "body": "I opened a PR to fix this here https://github.com/foundry-rs/foundry/pull/5099. Locally the fix is working against my test suite.",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1574881260/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1612398369",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4305#issuecomment-1612398369",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4305",
    "id": 1612398369,
    "node_id": "IC_kwDOGBlvNc5gGz8h",
    "user": {
      "login": "Evalir",
      "id": 26014927,
      "node_id": "MDQ6VXNlcjI2MDE0OTI3",
      "avatar_url": "https://avatars.githubusercontent.com/u/26014927?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Evalir",
      "html_url": "https://github.com/Evalir",
      "followers_url": "https://api.github.com/users/Evalir/followers",
      "following_url": "https://api.github.com/users/Evalir/following{/other_user}",
      "gists_url": "https://api.github.com/users/Evalir/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Evalir/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Evalir/subscriptions",
      "organizations_url": "https://api.github.com/users/Evalir/orgs",
      "repos_url": "https://api.github.com/users/Evalir/repos",
      "events_url": "https://api.github.com/users/Evalir/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Evalir/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-06-29T04:00:27Z",
    "updated_at": "2023-06-29T04:00:27Z",
    "author_association": "MEMBER",
    "body": "Closing, fixed with #5099 ",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1612398369/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
