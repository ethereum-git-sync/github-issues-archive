{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/4060",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4060/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4060/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4060/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/4060",
  "id": 1526346107,
  "node_id": "I_kwDOGBlvNc5a-jF7",
  "number": 4060,
  "title": "Etherscan verification fails for complex directory structure",
  "user": {
    "login": "haydenshively",
    "id": 17186559,
    "node_id": "MDQ6VXNlcjE3MTg2NTU5",
    "avatar_url": "https://avatars.githubusercontent.com/u/17186559?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/haydenshively",
    "html_url": "https://github.com/haydenshively",
    "followers_url": "https://api.github.com/users/haydenshively/followers",
    "following_url": "https://api.github.com/users/haydenshively/following{/other_user}",
    "gists_url": "https://api.github.com/users/haydenshively/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/haydenshively/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/haydenshively/subscriptions",
    "organizations_url": "https://api.github.com/users/haydenshively/orgs",
    "repos_url": "https://api.github.com/users/haydenshively/repos",
    "events_url": "https://api.github.com/users/haydenshively/events{/privacy}",
    "received_events_url": "https://api.github.com/users/haydenshively/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3334394228,
      "node_id": "MDU6TGFiZWwzMzM0Mzk0MjI4",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-bug",
      "name": "T-bug",
      "color": "d73a4a",
      "default": false,
      "description": "Type: bug"
    },
    {
      "id": 3703752787,
      "node_id": "LA_kwDOGBlvNc7cwshT",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/C-forge",
      "name": "C-forge",
      "color": "5319E7",
      "default": false,
      "description": "Command: forge"
    },
    {
      "id": 3854218343,
      "node_id": "LA_kwDOGBlvNc7lurRn",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/Cmd-forge-verify",
      "name": "Cmd-forge-verify",
      "color": "006B75",
      "default": false,
      "description": "Command: forge verify-contract"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2023-01-09T21:23:56Z",
  "updated_at": "2023-07-09T22:45:05Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Component\n\nForge\n\n### Have you ensured that all of these are up to date?\n\n- [X] Foundry\n- [X] Foundryup\n\n### What version of Foundry are you on?\n\nforge 0.2.0 (a44aa13 2023-01-09T00:10:29.992832Z)\n\n### What command(s) is the bug in?\n\nforge script --broadcast --verify\n\n### Operating System\n\nmacOS (Apple Silicon)\n\n### Describe the bug\n\nI've created a simple repo to reproduce the issue [here](https://github.com/haydenshively/foundry-verification-bug).\r\nI've got a non-standard repository structure. It works perfectly for every command I've tried, with this one exception:\r\nEtherscan verification fails for any `periphery` contract that depends on files nested inside of `core/src`. i.e., it's fine for `periphery/src/MyHelper.sol` to import `core/src/MyContract.sol`, but if `core/MyContract.sol` imports something from `core/src/<any-other-directory>/<any-other-file.sol>`, verification fails (see error below).\r\n\r\nInterestingly, the output build json for `periphery/src/MyHelper.sol` _does_ list `core/src/<any-other-directory>/<any-other-file.sol>` as a source. For some reason it's just not being uploaded to Etherscan. \r\n\r\n```\r\nSubmitted contract for verification:\r\n        Response: `OK`\r\n        GUID: `bjzmvh3dmrwgi3r5aizqkhwytv6psxefyzfvekppi84y5hynsp`\r\n        URL:\r\n        https://api-goerli.etherscan.io/apiaddress/0xddcfbbe2c2fbf750c472d354fc08e8d98f01651e\r\nContract verification status:\r\nResponse: `NOTOK`\r\nDetails: `Pending in queue`\r\nContract verification status:\r\nResponse: `NOTOK`\r\nDetails: `Fail - Unable to verify. Solidity Compilation Error: Source \"lib/core/src/libraries/Foo.sol\" not found: File not found. Searched the following locations: \"\".`\r\nContract failed to verify.\r\n```",
  "closed_by": {
    "login": "Evalir",
    "id": 26014927,
    "node_id": "MDQ6VXNlcjI2MDE0OTI3",
    "avatar_url": "https://avatars.githubusercontent.com/u/26014927?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Evalir",
    "html_url": "https://github.com/Evalir",
    "followers_url": "https://api.github.com/users/Evalir/followers",
    "following_url": "https://api.github.com/users/Evalir/following{/other_user}",
    "gists_url": "https://api.github.com/users/Evalir/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Evalir/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Evalir/subscriptions",
    "organizations_url": "https://api.github.com/users/Evalir/orgs",
    "repos_url": "https://api.github.com/users/Evalir/repos",
    "events_url": "https://api.github.com/users/Evalir/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Evalir/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/4060/reactions",
    "total_count": 2,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 2,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4060/timeline",
  "performed_via_github_app": null,
  "state_reason": "reopened"
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1551700571",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4060#issuecomment-1551700571",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4060",
    "id": 1551700571,
    "node_id": "IC_kwDOGBlvNc5cfRJb",
    "user": {
      "login": "Fiddlekins",
      "id": 11947488,
      "node_id": "MDQ6VXNlcjExOTQ3NDg4",
      "avatar_url": "https://avatars.githubusercontent.com/u/11947488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Fiddlekins",
      "html_url": "https://github.com/Fiddlekins",
      "followers_url": "https://api.github.com/users/Fiddlekins/followers",
      "following_url": "https://api.github.com/users/Fiddlekins/following{/other_user}",
      "gists_url": "https://api.github.com/users/Fiddlekins/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Fiddlekins/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Fiddlekins/subscriptions",
      "organizations_url": "https://api.github.com/users/Fiddlekins/orgs",
      "repos_url": "https://api.github.com/users/Fiddlekins/repos",
      "events_url": "https://api.github.com/users/Fiddlekins/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Fiddlekins/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-17T16:17:08Z",
    "updated_at": "2023-05-17T16:17:08Z",
    "author_association": "NONE",
    "body": "We've run into this same issue now too, trying to run `forge verify-contract`.\r\n(version: `forge 0.2.0 (7398b65 2023-03-29T00:20:50.782162Z)`)\r\n\r\n```\r\nResponse: `NOTOK`\r\nDetails: `Fail - Unable to verify. Solidity Compilation Error: Source \"lib/openzeppelin-contracts/contracts/token/ERC20/IERC20.sol\" not found: File not found. Searched the following locations: \"\".`\r\nContract failed to verify.\r\n```\r\n\r\nWe looked into it a bit and can provide some more insight into what the surface level cause is.\r\n\r\nWe output the JSON payload to examine (using the `--show-standard-json-input` flag) and get the following:\r\n![verification-json](https://github.com/foundry-rs/foundry/assets/11947488/328861c2-3ebf-4f66-a62c-15895832ccc3)\r\n\r\nThe project's top level remappings.txt actually only contains the following:\r\n```\r\n@openzeppelin-contracts=lib/openzeppelin-contracts/contracts\r\n```\r\nThis corresponds to the payload's `settings.remappings[1]`, with the `settings.remappings[0]` entry coming from the mock-contracts dependency which also uses the OZ lib.\r\n\r\nChecking the contents of the values listed in the payloads `sources` map we see the imports are in their original form\r\n```\r\nimport {IERC20} from \"@openzeppelin-contracts/token/ERC20/IERC20.sol\";\r\n```\r\n\r\nIt's not clear to me why etherscan would resolve that using `settings.remappings[1]` before `settings.remappings[0]`, but nevertheless it does so, trying to find `lib/openzeppelin-contracts/contracts/token/ERC20/IERC20.sol` only to return an error because there's no corresponding entry in the `sources` map.\r\n\r\nWe briefly experimented with manually modifying and submitting the payload JSON, such that we duplicated the `lib/mock-contracts/lib/openzeppelin-contracts/contracts/token/ERC20/IERC20.sol` entry and renamed the key to `lib/openzeppelin-contracts/contracts/token/ERC20/IERC20.sol`. This resolved the missing file error, instead failing because the final bytecode didn't match due to the OZ lib version being different between the top level dep and the dep's dep.\r\n\r\nTo summarise, forge seems to be incorrectly de-duping dependencies based on either file or contract name, when it should be using their filepath instead.",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1551700571/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1567321623",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4060#issuecomment-1567321623",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4060",
    "id": 1567321623,
    "node_id": "IC_kwDOGBlvNc5da24X",
    "user": {
      "login": "davidbrai",
      "id": 351026,
      "node_id": "MDQ6VXNlcjM1MTAyNg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/351026?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/davidbrai",
      "html_url": "https://github.com/davidbrai",
      "followers_url": "https://api.github.com/users/davidbrai/followers",
      "following_url": "https://api.github.com/users/davidbrai/following{/other_user}",
      "gists_url": "https://api.github.com/users/davidbrai/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/davidbrai/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/davidbrai/subscriptions",
      "organizations_url": "https://api.github.com/users/davidbrai/orgs",
      "repos_url": "https://api.github.com/users/davidbrai/repos",
      "events_url": "https://api.github.com/users/davidbrai/events{/privacy}",
      "received_events_url": "https://api.github.com/users/davidbrai/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-29T16:18:07Z",
    "updated_at": "2023-05-29T16:18:07Z",
    "author_association": "NONE",
    "body": "I've had a similar issue, what worked as a temporary fix is applying the following change to my `foundry.toml`:\r\n\r\n```diff\r\n[profile.default]\r\n src = 'contracts'\r\n-libs = ['lib', '../../node_modules']\r\n+libs = ['lib', '/full-path-to-project/my-monorepo/node_modules']\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1567321623/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1570960226",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4060#issuecomment-1570960226",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4060",
    "id": 1570960226,
    "node_id": "IC_kwDOGBlvNc5dovNi",
    "user": {
      "login": "ryanio",
      "id": 22116,
      "node_id": "MDQ6VXNlcjIyMTE2",
      "avatar_url": "https://avatars.githubusercontent.com/u/22116?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanio",
      "html_url": "https://github.com/ryanio",
      "followers_url": "https://api.github.com/users/ryanio/followers",
      "following_url": "https://api.github.com/users/ryanio/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanio/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanio/orgs",
      "repos_url": "https://api.github.com/users/ryanio/repos",
      "events_url": "https://api.github.com/users/ryanio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-31T21:08:58Z",
    "updated_at": "2023-05-31T21:08:58Z",
    "author_association": "NONE",
    "body": "+1 i am also having the same issue as @Fiddlekins",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1570960226/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1572961565",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4060#issuecomment-1572961565",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4060",
    "id": 1572961565,
    "node_id": "IC_kwDOGBlvNc5dwX0d",
    "user": {
      "login": "ryanio",
      "id": 22116,
      "node_id": "MDQ6VXNlcjIyMTE2",
      "avatar_url": "https://avatars.githubusercontent.com/u/22116?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanio",
      "html_url": "https://github.com/ryanio",
      "followers_url": "https://api.github.com/users/ryanio/followers",
      "following_url": "https://api.github.com/users/ryanio/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanio/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanio/orgs",
      "repos_url": "https://api.github.com/users/ryanio/repos",
      "events_url": "https://api.github.com/users/ryanio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-06-02T00:35:53Z",
    "updated_at": "2023-06-02T00:35:53Z",
    "author_association": "NONE",
    "body": "Adding `auto_detect_remappings = false` to `foundry.toml` fixed this issue for me!",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1572961565/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1599328036",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4060#issuecomment-1599328036",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4060",
    "id": 1599328036,
    "node_id": "IC_kwDOGBlvNc5fU88k",
    "user": {
      "login": "Evalir",
      "id": 26014927,
      "node_id": "MDQ6VXNlcjI2MDE0OTI3",
      "avatar_url": "https://avatars.githubusercontent.com/u/26014927?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Evalir",
      "html_url": "https://github.com/Evalir",
      "followers_url": "https://api.github.com/users/Evalir/followers",
      "following_url": "https://api.github.com/users/Evalir/following{/other_user}",
      "gists_url": "https://api.github.com/users/Evalir/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Evalir/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Evalir/subscriptions",
      "organizations_url": "https://api.github.com/users/Evalir/orgs",
      "repos_url": "https://api.github.com/users/Evalir/repos",
      "events_url": "https://api.github.com/users/Evalir/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Evalir/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-06-20T18:43:45Z",
    "updated_at": "2023-06-20T18:43:45Z",
    "author_association": "MEMBER",
    "body": "So, this is expected behavior regarding ambiguous paths: https://book.getfoundry.sh/forge/deploying?highlight=verify-contra#known-issues ; sadly etherscan only really handle relative paths. @ryanio 's fix works!\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1599328036/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
