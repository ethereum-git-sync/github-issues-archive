{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/3879",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3879/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3879/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3879/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/3879",
  "id": 1491981904,
  "node_id": "I_kwDOGBlvNc5Y7dZQ",
  "number": 3879,
  "title": "Cannot simulate from an address that has code",
  "user": {
    "login": "adhusson",
    "id": 2977,
    "node_id": "MDQ6VXNlcjI5Nzc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2977?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/adhusson",
    "html_url": "https://github.com/adhusson",
    "followers_url": "https://api.github.com/users/adhusson/followers",
    "following_url": "https://api.github.com/users/adhusson/following{/other_user}",
    "gists_url": "https://api.github.com/users/adhusson/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/adhusson/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/adhusson/subscriptions",
    "organizations_url": "https://api.github.com/users/adhusson/orgs",
    "repos_url": "https://api.github.com/users/adhusson/repos",
    "events_url": "https://api.github.com/users/adhusson/events{/privacy}",
    "received_events_url": "https://api.github.com/users/adhusson/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3334394228,
      "node_id": "MDU6TGFiZWwzMzM0Mzk0MjI4",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-bug",
      "name": "T-bug",
      "color": "d73a4a",
      "default": false,
      "description": "Type: bug"
    },
    {
      "id": 3703752787,
      "node_id": "LA_kwDOGBlvNc7cwshT",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/C-forge",
      "name": "C-forge",
      "color": "5319E7",
      "default": false,
      "description": "Command: forge"
    },
    {
      "id": 4182991461,
      "node_id": "LA_kwDOGBlvNc75U2Jl",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/Cmd-forge-script",
      "name": "Cmd-forge-script",
      "color": "006B75",
      "default": false,
      "description": "Command: forge script"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2022-12-12T14:11:42Z",
  "updated_at": "2023-02-22T09:50:01Z",
  "closed_at": "2023-02-22T09:50:00Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "### Component\n\nForge\n\n### Have you ensured that all of these are up to date?\n\n- [X] Foundry\n- [X] Foundryup\n\n### What version of Foundry are you on?\n\nforge 0.2.0 (e9f274d 2022-12-12T00:04:24.380051Z)\n\n### What command(s) is the bug in?\n\nforge script\n\n### Operating System\n\nNone\n\n### Describe the bug\n\nforge script cannot run when `--sender` is set to a contract. \r\n\r\n## Reproduction\r\n1. `forge init repro_no_contract && cd repro_no_contract`\r\n2. `MAINNET=... UNISWAP=0x5C69bEe701ef814a2B6a3EDD4B1652CB9cc5aA6f forge script CounterScript --fork-url $MAINNET --sender $UNISWAP`\r\n\r\nWil show:\r\n```\r\n...\r\n  [0] 0x0000000000000000000000000000000000000000::fallback()\r\n    └─ ← ()\r\n\r\n\r\nError:\r\nScript failed.\r\n```\r\n\r\nWhereas if you replace `$UNISWAP` with `$(cast az)`, it will work.\r\n\r\n## Notes\r\n* It is useful to do perfect simulation of multisig call sequences.\r\n* It cannot be worked around directly because it fails right after the constructor of the script has run. At that stage there is no way to detect the address of `--sender` (since it will be set when `run()` is called but is still `0x1804c8ab1f12e6bbf3894d4083f33e07309d1f38` in the constructor).\r\n* The only alternative is to set another env var and manually `vm.broadcast(vm.envAddress(\"VARNAME\"))` after zeroing out the code at VARNAME.\r\n\r\n## Resolution idea\r\n* It is reasonable to fail by default when the sender has nonzero code since clients would also reject the tx. But the failure should occur at the point of broadcast, not right after the script has finished deploying.",
  "closed_by": {
    "login": "adhusson",
    "id": 2977,
    "node_id": "MDQ6VXNlcjI5Nzc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2977?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/adhusson",
    "html_url": "https://github.com/adhusson",
    "followers_url": "https://api.github.com/users/adhusson/followers",
    "following_url": "https://api.github.com/users/adhusson/following{/other_user}",
    "gists_url": "https://api.github.com/users/adhusson/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/adhusson/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/adhusson/subscriptions",
    "organizations_url": "https://api.github.com/users/adhusson/orgs",
    "repos_url": "https://api.github.com/users/adhusson/repos",
    "events_url": "https://api.github.com/users/adhusson/events{/privacy}",
    "received_events_url": "https://api.github.com/users/adhusson/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/3879/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3879/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1439721184",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3879#issuecomment-1439721184",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3879",
    "id": 1439721184,
    "node_id": "IC_kwDOGBlvNc5V0Gbg",
    "user": {
      "login": "adhusson",
      "id": 2977,
      "node_id": "MDQ6VXNlcjI5Nzc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2977?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/adhusson",
      "html_url": "https://github.com/adhusson",
      "followers_url": "https://api.github.com/users/adhusson/followers",
      "following_url": "https://api.github.com/users/adhusson/following{/other_user}",
      "gists_url": "https://api.github.com/users/adhusson/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/adhusson/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/adhusson/subscriptions",
      "organizations_url": "https://api.github.com/users/adhusson/orgs",
      "repos_url": "https://api.github.com/users/adhusson/repos",
      "events_url": "https://api.github.com/users/adhusson/events{/privacy}",
      "received_events_url": "https://api.github.com/users/adhusson/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-02-22T09:50:00Z",
    "updated_at": "2023-02-22T09:50:00Z",
    "author_association": "CONTRIBUTOR",
    "body": "Closing since I cannot observe this behavior anymore.",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1439721184/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
