{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/4896",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4896/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4896/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4896/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/4896",
  "id": 1700082730,
  "node_id": "I_kwDOGBlvNc5lVTQq",
  "number": 4896,
  "title": "Flaws in Cast Downloading Contract Source Code",
  "user": {
    "login": "Hellobloc",
    "id": 113746997,
    "node_id": "U_kgDOBsekNQ",
    "avatar_url": "https://avatars.githubusercontent.com/u/113746997?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Hellobloc",
    "html_url": "https://github.com/Hellobloc",
    "followers_url": "https://api.github.com/users/Hellobloc/followers",
    "following_url": "https://api.github.com/users/Hellobloc/following{/other_user}",
    "gists_url": "https://api.github.com/users/Hellobloc/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Hellobloc/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Hellobloc/subscriptions",
    "organizations_url": "https://api.github.com/users/Hellobloc/orgs",
    "repos_url": "https://api.github.com/users/Hellobloc/repos",
    "events_url": "https://api.github.com/users/Hellobloc/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Hellobloc/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3334394228,
      "node_id": "MDU6TGFiZWwzMzM0Mzk0MjI4",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-bug",
      "name": "T-bug",
      "color": "d73a4a",
      "default": false,
      "description": "Type: bug"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2023-05-08T11:34:00Z",
  "updated_at": "2023-05-08T21:06:47Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Component\n\nCast\n\n### Have you ensured that all of these are up to date?\n\n- [X] Foundry\n- [ ] Foundryup\n\n### What version of Foundry are you on?\n\n_No response_\n\n### What command(s) is the bug in?\n\ncast etherscan\n\n### Operating System\n\nWindows\n\n### Describe the bug\n\n# Introduction\r\ncast supports downloading contract source code locally via etherscan. cast uses the rs library of `ethers-etherscan` to handle part of the download logic. The path traversal vulnerability is well guarded in the `ethers-etherscan` library, but the operation of automatically adding the `.sol` suffix causes the tool to have a possible new risk.\r\nhttps://github.com/foundry-rs/foundry/blob/master/cast/src/lib.rs#L19\r\nhttps://sourcegraph.com/crates/ethers-etherscan@9e675141953f88a190ac883ad02841370836d35c/-/blob/src/source_tree.rs?L18-36\r\n```rust\r\nimpl SourceTree {\r\n    /// Expand the source tree into the provided directory.  This method sanitizes paths to ensure\r\n    /// that no directory traversal happens.\r\n    pub fn write_to(&self, dir: &Path) -> Result<()> {\r\n        create_dir_all(dir)?;\r\n        for entry in &self.entries {\r\n            let mut sanitized_path = sanitize_path(&entry.path);\r\n            if sanitized_path.extension().is_none() {\r\n                sanitized_path.set_extension(\"sol\");\r\n            }\r\n            let joined = dir.join(sanitized_path);\r\n            if let Some(parent) = joined.parent() {\r\n                create_dir_all(parent)?;\r\n                std::fs::write(joined, &entry.contents)?;\r\n            }\r\n        }\r\n        Ok(())\r\n    }\r\n}\r\n```\r\n# Risk\r\nSpecifically, we can build two contract files, `Attack` and `Attack.sol`, in `Etherscan`, which makes it possible for the two files to have the same filename and be overwritten when the source code of etherscan is downloaded locally by `cast`. This feature can be used to implement some honeypot contracts, where we can make some backdoor source code content overwritten and not visible through the source code.\r\n# Attack Case\r\nHere we can try to allow the following command to verify the problem\r\n```\r\ncast etherscan-source 0x277A372cD28bA6B62DCB8C0D9491d6BE26a0D216 -c goerli --etherscan-api-key AA -d test_file\r\n```\r\n![image](https://user-images.githubusercontent.com/113746997/236656692-0a62ac62-f0cc-4b3a-afe2-38f384bd615c.png)\r\n\r\nHere we can easily find that our file directory only has an almost empty `Token.sol` file, but the actual `Token.sol` is overwritten. In a real scenario, we can build some honeypot contracts to defraud users by designing the Token.sol contract to be more complex making it difficult to detect the overwriting happening.\r\n# Recommendation\r\nWe recommend removing the appending of filenames (`.sol`) whenever possible, or giving some warning notes and trying to detect such issues and warn about them.",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/4896/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4896/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1538339533",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4896#issuecomment-1538339533",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4896",
    "id": 1538339533,
    "node_id": "IC_kwDOGBlvNc5bsTLN",
    "user": {
      "login": "mattsse",
      "id": 19890894,
      "node_id": "MDQ6VXNlcjE5ODkwODk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/19890894?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mattsse",
      "html_url": "https://github.com/mattsse",
      "followers_url": "https://api.github.com/users/mattsse/followers",
      "following_url": "https://api.github.com/users/mattsse/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattsse/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mattsse/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattsse/subscriptions",
      "organizations_url": "https://api.github.com/users/mattsse/orgs",
      "repos_url": "https://api.github.com/users/mattsse/repos",
      "events_url": "https://api.github.com/users/mattsse/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mattsse/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-08T13:11:39Z",
    "updated_at": "2023-05-08T13:12:00Z",
    "author_association": "MEMBER",
    "body": "tysm for this.\r\n\r\n> We recommend removing the appending of filenames (.sol) whenever possible,\r\n\r\nThis seems like the right fix, so we should remove the `set_extension`?\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1538339533/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1539049245",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4896#issuecomment-1539049245",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4896",
    "id": 1539049245,
    "node_id": "IC_kwDOGBlvNc5bvAcd",
    "user": {
      "login": "slendermaan",
      "id": 21294029,
      "node_id": "MDQ6VXNlcjIxMjk0MDI5",
      "avatar_url": "https://avatars.githubusercontent.com/u/21294029?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/slendermaan",
      "html_url": "https://github.com/slendermaan",
      "followers_url": "https://api.github.com/users/slendermaan/followers",
      "following_url": "https://api.github.com/users/slendermaan/following{/other_user}",
      "gists_url": "https://api.github.com/users/slendermaan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/slendermaan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/slendermaan/subscriptions",
      "organizations_url": "https://api.github.com/users/slendermaan/orgs",
      "repos_url": "https://api.github.com/users/slendermaan/repos",
      "events_url": "https://api.github.com/users/slendermaan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/slendermaan/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-08T21:05:15Z",
    "updated_at": "2023-05-08T21:05:15Z",
    "author_association": "NONE",
    "body": "also could just add a checkÔºÅif there are some file don't have '.sol' in the end of name!\nwe can just alert it or ban this fetch!",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1539049245/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1539051316",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4896#issuecomment-1539051316",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4896",
    "id": 1539051316,
    "node_id": "IC_kwDOGBlvNc5bvA80",
    "user": {
      "login": "slendermaan",
      "id": 21294029,
      "node_id": "MDQ6VXNlcjIxMjk0MDI5",
      "avatar_url": "https://avatars.githubusercontent.com/u/21294029?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/slendermaan",
      "html_url": "https://github.com/slendermaan",
      "followers_url": "https://api.github.com/users/slendermaan/followers",
      "following_url": "https://api.github.com/users/slendermaan/following{/other_user}",
      "gists_url": "https://api.github.com/users/slendermaan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/slendermaan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/slendermaan/subscriptions",
      "organizations_url": "https://api.github.com/users/slendermaan/orgs",
      "repos_url": "https://api.github.com/users/slendermaan/repos",
      "events_url": "https://api.github.com/users/slendermaan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/slendermaan/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-08T21:06:47Z",
    "updated_at": "2023-05-08T21:06:47Z",
    "author_association": "NONE",
    "body": "i'm @Hellobloc , this is another account! sorry for this.",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1539051316/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
