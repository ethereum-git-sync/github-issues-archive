{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/6634",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/6634/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/6634/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/6634/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/6634",
  "id": 2051169922,
  "node_id": "I_kwDOGBlvNc56Ql6C",
  "number": 6634,
  "title": "`vm.stopAndReturnStateDiff()` results do not include call to create2 factory",
  "user": {
    "login": "RPate97",
    "id": 25066232,
    "node_id": "MDQ6VXNlcjI1MDY2MjMy",
    "avatar_url": "https://avatars.githubusercontent.com/u/25066232?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/RPate97",
    "html_url": "https://github.com/RPate97",
    "followers_url": "https://api.github.com/users/RPate97/followers",
    "following_url": "https://api.github.com/users/RPate97/following{/other_user}",
    "gists_url": "https://api.github.com/users/RPate97/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/RPate97/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/RPate97/subscriptions",
    "organizations_url": "https://api.github.com/users/RPate97/orgs",
    "repos_url": "https://api.github.com/users/RPate97/repos",
    "events_url": "https://api.github.com/users/RPate97/events{/privacy}",
    "received_events_url": "https://api.github.com/users/RPate97/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3334394228,
      "node_id": "MDU6TGFiZWwzMzM0Mzk0MjI4",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-bug",
      "name": "T-bug",
      "color": "d73a4a",
      "default": false,
      "description": "Type: bug"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2023-12-20T19:48:46Z",
  "updated_at": "2023-12-20T21:30:33Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Component\r\n\r\nForge\r\n\r\n### Have you ensured that all of these are up to date?\r\n\r\n- [X] Foundry\r\n- [X] Foundryup\r\n\r\n### What version of Foundry are you on?\r\n\r\nforge 0.2.0 (73fb616 2023-12-19T00:17:51.579325000Z)\r\n\r\n### What command(s) is the bug in?\r\n\r\nforge script\r\n\r\n### Operating System\r\n\r\nmacOS (Apple Silicon)\r\n\r\n### Describe the bug\r\n\r\nDeploying a contract using create2 shows up as a single create `AccountAccess` in the results returned by `vm.stopAndReturnStateDiff()` even though the call to the create2 factory itself is also a state-changing action. This makes it difficult to determine if a contract was deployed using create or create2 based on the recorded results. The call to the create2 factory should be included in the results returned by this cheat code. \r\n\r\nIt's unclear to me if the current behavior was intended or not. If it was intended, then this issue should probably be converted into a feature request. Please let me know if you think I should do that. \r\n\r\n### Replication \r\n```\r\n// SPDX-License-Identifier: UNLICENSED\r\npragma solidity ^0.8.0;\r\n\r\nimport { Script, console } from \"forge-std/Script.sol\";\r\nimport { VmSafe, Vm } from \"forge-std/Vm.sol\";\r\n\r\ncontract Counter {\r\n    uint256 public number;\r\n\r\n    constructor (uint _number) {\r\n      number = _number;\r\n    }\r\n\r\n    function increment() public {\r\n      number += 1;\r\n    }\r\n}\r\n\r\ncontract CounterScript is Script {\r\n    function run() public {\r\n        vm.startStateDiffRecording();\r\n        Counter counter = new Counter{ salt: 0 }(0);\r\n\r\n        Vm.AccountAccess[] memory accountAccesses = vm.stopAndReturnStateDiff();\r\n        for (uint i = 0; i < accountAccesses.length; i++) {\r\n            console.log(uint(accountAccesses[i].kind));\r\n            console.log('account', accountAccesses[i].account);\r\n            console.log('accessor', accountAccesses[i].accessor);\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n`forge script ./script/Counter.s.sol --tc CounterScript`",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/6634/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/6634/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1865167767",
    "html_url": "https://github.com/foundry-rs/foundry/issues/6634#issuecomment-1865167767",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/6634",
    "id": 1865167767,
    "node_id": "IC_kwDOGBlvNc5vLDOX",
    "user": {
      "login": "maurelian",
      "id": 23033765,
      "node_id": "MDQ6VXNlcjIzMDMzNzY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23033765?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/maurelian",
      "html_url": "https://github.com/maurelian",
      "followers_url": "https://api.github.com/users/maurelian/followers",
      "following_url": "https://api.github.com/users/maurelian/following{/other_user}",
      "gists_url": "https://api.github.com/users/maurelian/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/maurelian/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/maurelian/subscriptions",
      "organizations_url": "https://api.github.com/users/maurelian/orgs",
      "repos_url": "https://api.github.com/users/maurelian/repos",
      "events_url": "https://api.github.com/users/maurelian/events{/privacy}",
      "received_events_url": "https://api.github.com/users/maurelian/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-12-20T21:30:32Z",
    "updated_at": "2023-12-20T21:30:32Z",
    "author_association": "NONE",
    "body": "This looks to me like a legitimate issue. I notice that the trace from your PoC also excludes any reference to the factory contract and makes it appear like a direct creation. \r\n\r\n```\r\n[146870] CounterScript::run()\r\n    ├─ [0] VM::startStateDiffRecording()\r\n    │   └─ ← ()\r\n    ├─ [74744] → new Counter@0xa5a60F25eae05d45f90d25469954703CC5334527\r\n    │   └─ ← 371 bytes of code\r\n    ├─ [0] VM::stopAndReturnStateDiff()\r\n ```",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1865167767/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
