{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/3890",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3890/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3890/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3890/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/3890",
  "id": 1495325374,
  "node_id": "I_kwDOGBlvNc5ZINq-",
  "number": 3890,
  "title": "Envelope type and Deserialization errors when confirming `cast` transactions in MetaMask",
  "user": {
    "login": "OnlyOneJMJQ",
    "id": 3990373,
    "node_id": "MDQ6VXNlcjM5OTAzNzM=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3990373?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/OnlyOneJMJQ",
    "html_url": "https://github.com/OnlyOneJMJQ",
    "followers_url": "https://api.github.com/users/OnlyOneJMJQ/followers",
    "following_url": "https://api.github.com/users/OnlyOneJMJQ/following{/other_user}",
    "gists_url": "https://api.github.com/users/OnlyOneJMJQ/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/OnlyOneJMJQ/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/OnlyOneJMJQ/subscriptions",
    "organizations_url": "https://api.github.com/users/OnlyOneJMJQ/orgs",
    "repos_url": "https://api.github.com/users/OnlyOneJMJQ/repos",
    "events_url": "https://api.github.com/users/OnlyOneJMJQ/events{/privacy}",
    "received_events_url": "https://api.github.com/users/OnlyOneJMJQ/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3334394228,
      "node_id": "MDU6TGFiZWwzMzM0Mzk0MjI4",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-bug",
      "name": "T-bug",
      "color": "d73a4a",
      "default": false,
      "description": "Type: bug"
    },
    {
      "id": 3703752609,
      "node_id": "LA_kwDOGBlvNc7cwseh",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/C-cast",
      "name": "C-cast",
      "color": "5319E7",
      "default": false,
      "description": "Command: cast"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2022-12-13T23:31:05Z",
  "updated_at": "2023-03-09T15:01:56Z",
  "closed_at": "2023-03-09T15:01:56Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Component\r\n\r\nCast\r\n\r\n### Have you ensured that all of these are up to date?\r\n\r\n- [X] Foundry\r\n- [X] Foundryup\r\n\r\n### What version of Foundry are you on?\r\n\r\ncast 0.2.0 (e9f274d 2022-12-13T00:04:35.011347Z)\r\n\r\n### What command(s) is the bug in?\r\n\r\ncast send, cast rpc\r\n\r\n### Operating System\r\n\r\nmacOS (Apple Silicon)\r\n\r\n### Describe the bug\r\n\r\n# The Issue\r\nI'm attempting to use `cast` with [Truffle Dashboard](https://trufflesuite.com/docs/truffle/how-to/use-the-truffle-dashboard/) so I can confirm my transactions using MetaMask. These errors could point to a larger EIP-1559 issue, which is why I bring them up here. I tried 3 different methods of sending the transaction, using both Ganache and Goerli networks with the example `Counter` contract:\r\n\r\n1. `cast send`: Error regarding envelope type: `(code: -32602, message: Invalid transaction envelope type: specified type \"0x02\" but including maxFeePerGas and maxPriorityFeePerGas requires type: \"0x2\", data: None)`\r\n2. `cast send --legacy`: Error regarding \"message\": `(code: -32603, message: Cannot read properties of undefined (reading 'message'), data: Some(Object {\"originalError\": Object {}}))`\r\n3. `cast rpc`: Error regarding message, specifically deserialization: `Deserialization Error: missing field \"message\" at line 1 column 275. Response: {\"jsonrpc\":\"2.0\",\"id\":1,\"error\":{\"code\":-32600,\"data\":{\"method\":\"eth_sendTransaction\",\"params\":\"[{from: \\\"0xF808714EA67395Eed66931c8E9f88314e78bE31E\\\", to: \\\"0x94b1f4b902c074843A7f75Eec0544b88eFfEDEF8\\\", gas: \\\"0x76c0\\\", gasPrice: \\\"0x9184e72a000\\\", data: \\\"0xd09de08a\\\"}]\"}}}`\r\n\r\n# Repro Steps\r\n\r\n1. Initialize a new foundry project:\r\n`forge init foundry-test`\r\n\r\n2. Build the included Counter contract:\r\n`forge build`\r\n\r\n3. Start a new ganache instance (or skip steps 4+5 for Goerli):\r\n`ganache`\r\n\r\n5. Add the first account to MetaMask, either by creating a new wallet with Ganache's mnemonic or copy/pasting the private key for account 0 into MetaMask's import account flow.\r\n\r\n6. Start up Truffle Dashboard. You can do this without installing Truffle:\r\n`npx tdboard`\r\n\r\n7. Deploy the contract. This will not touch Dashboard because the private key is already included for signing (expected).\r\n`forge create --rpc-url http://localhost:24012/rpc --private-key <PRIVATE_KEY> Counter`\r\n\r\n8. Attempt to use `cast send` to send the transaction:\r\n`cast send --from 0xF808714EA67395Eed66931c8E9f88314e78bE31E 0x94b1f4b902c074843A7f75Eec0544b88eFfEDEF8 \"increment()\" --rpc-url http://localhost:24012/rpc`\r\nYou'll see the transaction appear in Truffle Dashboard (ignore the compilation warning), attempting to approve it results in this error in the console:\r\n`(code: -32602, message: Invalid transaction envelope type: specified type \"0x02\" but including maxFeePerGas and maxPriorityFeePerGas requires type: \"0x2\", data: None)`\r\n\r\n9. Attempt to use `cast send` with the `legacy` option:\r\n`cast send --from 0xF808714EA67395Eed66931c8E9f88314e78bE31E 0x94b1f4b902c074843A7f75Eec0544b88eFfEDEF8 \"increment()\" --legacy --rpc-url http://localhost:24012/rpc`\r\nWe get further! MetaMask will open in this instance, but the transaction will clear before you have a chance to approve. Error in console:\r\n`(code: -32603, message: Cannot read properties of undefined (reading 'message'), data: Some(Object {\"originalError\": Object {}}))`\r\n\r\n10. Attempt to use `cast rpc` to send the transaction:\r\n`cast rpc -r http://localhost:24012/rpc -w eth_sendTransaction '[{from: \"0xF808714EA67395Eed66931c8E9f88314e78bE31E\", to: \"0x94b1f4b902c074843A7f75Eec0544b88eFfEDEF8\", gas: \"0x76c0\", gasPrice: \"0x9184e72a000\", data: \"0xd09de08a\"}]'`\r\nError in console:\r\n`Deserialization Error: missing field \"message\" at line 1 column 275. Response: {\"jsonrpc\":\"2.0\",\"id\":1,\"error\":{\"code\":-32600,\"data\":{\"method\":\"eth_sendTransaction\",\"params\":\"[{from: \\\"0xF808714EA67395Eed66931c8E9f88314e78bE31E\\\", to: \\\"0x94b1f4b902c074843A7f75Eec0544b88eFfEDEF8\\\", gas: \\\"0x76c0\\\", gasPrice: \\\"0x9184e72a000\\\", data: \\\"0xd09de08a\\\"}]\"}}}`\r\n\r\nI'll note here that I also tried one level down (sending a raw tx), which did work, but of course didn't use MetaMask/Dashboard because it's pre-signed.",
  "closed_by": {
    "login": "mattsse",
    "id": 19890894,
    "node_id": "MDQ6VXNlcjE5ODkwODk0",
    "avatar_url": "https://avatars.githubusercontent.com/u/19890894?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mattsse",
    "html_url": "https://github.com/mattsse",
    "followers_url": "https://api.github.com/users/mattsse/followers",
    "following_url": "https://api.github.com/users/mattsse/following{/other_user}",
    "gists_url": "https://api.github.com/users/mattsse/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mattsse/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mattsse/subscriptions",
    "organizations_url": "https://api.github.com/users/mattsse/orgs",
    "repos_url": "https://api.github.com/users/mattsse/repos",
    "events_url": "https://api.github.com/users/mattsse/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mattsse/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/3890/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3890/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1458000507",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3890#issuecomment-1458000507",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3890",
    "id": 1458000507,
    "node_id": "IC_kwDOGBlvNc5W51J7",
    "user": {
      "login": "cbrzn",
      "id": 21031138,
      "node_id": "MDQ6VXNlcjIxMDMxMTM4",
      "avatar_url": "https://avatars.githubusercontent.com/u/21031138?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cbrzn",
      "html_url": "https://github.com/cbrzn",
      "followers_url": "https://api.github.com/users/cbrzn/followers",
      "following_url": "https://api.github.com/users/cbrzn/following{/other_user}",
      "gists_url": "https://api.github.com/users/cbrzn/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cbrzn/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cbrzn/subscriptions",
      "organizations_url": "https://api.github.com/users/cbrzn/orgs",
      "repos_url": "https://api.github.com/users/cbrzn/repos",
      "events_url": "https://api.github.com/users/cbrzn/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cbrzn/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-07T11:24:34Z",
    "updated_at": "2023-03-07T11:24:34Z",
    "author_association": "NONE",
    "body": "were you able to find a workaround for this? having exactly the same problem when trying to interact with metamask and ethers-rs",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1458000507/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1458012819",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3890#issuecomment-1458012819",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3890",
    "id": 1458012819,
    "node_id": "IC_kwDOGBlvNc5W54KT",
    "user": {
      "login": "mattsse",
      "id": 19890894,
      "node_id": "MDQ6VXNlcjE5ODkwODk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/19890894?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mattsse",
      "html_url": "https://github.com/mattsse",
      "followers_url": "https://api.github.com/users/mattsse/followers",
      "following_url": "https://api.github.com/users/mattsse/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattsse/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mattsse/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattsse/subscriptions",
      "organizations_url": "https://api.github.com/users/mattsse/orgs",
      "repos_url": "https://api.github.com/users/mattsse/repos",
      "events_url": "https://api.github.com/users/mattsse/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mattsse/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-07T11:34:48Z",
    "updated_at": "2023-03-07T11:34:48Z",
    "author_association": "MEMBER",
    "body": "tbh all of these errors looke like ganache/metamask related:\r\n\r\n> (code: -32602, message: Invalid transaction envelope type: specified type \"0x02\" but including maxFeePerGas and maxPriorityFeePerGas requires type: \"0x2\", data: None)\r\n\r\nEIP1559 is 0x02 and should include maxFeePerGas and maxPriorityFeePerGas\r\n\r\n> Deserialization Error: missing field \"message\" at line 1 column 275. Response: {\"jsonrpc\":\"2.0\",\"id\":1,\"error\":{\"code\":-32600,\"data\":{\"method\":\"eth_sendTransaction\",\"params\":\"[{from: \\\"0xF808714EA67395Eed66931c8E9f88314e78bE31E\\\", to: \\\"0x94b1f4b902c074843A7f75Eec0544b88eFfEDEF8\\\", gas: \\\"0x76c0\\\", gasPrice: \\\"0x9184e72a000\\\", data: \\\"0xd09de08a\\\"}]\"}}}\r\n\r\nthis is an error because the response is not valid JSON RPC lacks message field of JSON RPC error\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1458012819/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1462196747",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3890#issuecomment-1462196747",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3890",
    "id": 1462196747,
    "node_id": "IC_kwDOGBlvNc5XJ1oL",
    "user": {
      "login": "cbrzn",
      "id": 21031138,
      "node_id": "MDQ6VXNlcjIxMDMxMTM4",
      "avatar_url": "https://avatars.githubusercontent.com/u/21031138?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cbrzn",
      "html_url": "https://github.com/cbrzn",
      "followers_url": "https://api.github.com/users/cbrzn/followers",
      "following_url": "https://api.github.com/users/cbrzn/following{/other_user}",
      "gists_url": "https://api.github.com/users/cbrzn/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cbrzn/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cbrzn/subscriptions",
      "organizations_url": "https://api.github.com/users/cbrzn/orgs",
      "repos_url": "https://api.github.com/users/cbrzn/repos",
      "events_url": "https://api.github.com/users/cbrzn/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cbrzn/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-09T14:54:08Z",
    "updated_at": "2023-03-09T14:54:08Z",
    "author_association": "NONE",
    "body": "i guess this can be closed since this is indeed an error in metamask and not in foundry, the mm team opened an issue: https://github.com/MetaMask/metamask-extension/issues/18076 - thanks for your reply @mattsse ",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1462196747/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
