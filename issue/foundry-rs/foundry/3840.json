{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/3840",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3840/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3840/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3840/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/3840",
  "id": 1478301725,
  "node_id": "I_kwDOGBlvNc5YHRgd",
  "number": 3840,
  "title": "Transaction/receipts data returned by Anvil is inconsistent with Ethereum spec",
  "user": {
    "login": "mslipper",
    "id": 67953,
    "node_id": "MDQ6VXNlcjY3OTUz",
    "avatar_url": "https://avatars.githubusercontent.com/u/67953?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mslipper",
    "html_url": "https://github.com/mslipper",
    "followers_url": "https://api.github.com/users/mslipper/followers",
    "following_url": "https://api.github.com/users/mslipper/following{/other_user}",
    "gists_url": "https://api.github.com/users/mslipper/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mslipper/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mslipper/subscriptions",
    "organizations_url": "https://api.github.com/users/mslipper/orgs",
    "repos_url": "https://api.github.com/users/mslipper/repos",
    "events_url": "https://api.github.com/users/mslipper/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mslipper/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3334394228,
      "node_id": "MDU6TGFiZWwzMzM0Mzk0MjI4",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-bug",
      "name": "T-bug",
      "color": "d73a4a",
      "default": false,
      "description": "Type: bug"
    },
    {
      "id": 4077188949,
      "node_id": "LA_kwDOGBlvNc7zBPdV",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/C-anvil",
      "name": "C-anvil",
      "color": "5319E7",
      "default": false,
      "description": "Command: anvil"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": {
    "login": "rkrasiuk",
    "id": 25429261,
    "node_id": "MDQ6VXNlcjI1NDI5MjYx",
    "avatar_url": "https://avatars.githubusercontent.com/u/25429261?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/rkrasiuk",
    "html_url": "https://github.com/rkrasiuk",
    "followers_url": "https://api.github.com/users/rkrasiuk/followers",
    "following_url": "https://api.github.com/users/rkrasiuk/following{/other_user}",
    "gists_url": "https://api.github.com/users/rkrasiuk/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/rkrasiuk/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rkrasiuk/subscriptions",
    "organizations_url": "https://api.github.com/users/rkrasiuk/orgs",
    "repos_url": "https://api.github.com/users/rkrasiuk/repos",
    "events_url": "https://api.github.com/users/rkrasiuk/events{/privacy}",
    "received_events_url": "https://api.github.com/users/rkrasiuk/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "rkrasiuk",
      "id": 25429261,
      "node_id": "MDQ6VXNlcjI1NDI5MjYx",
      "avatar_url": "https://avatars.githubusercontent.com/u/25429261?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rkrasiuk",
      "html_url": "https://github.com/rkrasiuk",
      "followers_url": "https://api.github.com/users/rkrasiuk/followers",
      "following_url": "https://api.github.com/users/rkrasiuk/following{/other_user}",
      "gists_url": "https://api.github.com/users/rkrasiuk/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rkrasiuk/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rkrasiuk/subscriptions",
      "organizations_url": "https://api.github.com/users/rkrasiuk/orgs",
      "repos_url": "https://api.github.com/users/rkrasiuk/repos",
      "events_url": "https://api.github.com/users/rkrasiuk/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rkrasiuk/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2022-12-06T06:04:14Z",
  "updated_at": "2022-12-22T11:27:56Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Component\r\n\r\nAnvil\r\n\r\n### Have you ensured that all of these are up to date?\r\n\r\n- [ ] Foundry\r\n- [ ] Foundryup\r\n\r\n### What version of Foundry are you on?\r\n\r\n0.1.0 (a43313a 2022-11-30T17:15:08.718900657Z)\r\n\r\n### What command(s) is the bug in?\r\n\r\nanvil fork\r\n\r\n### Operating System\r\n\r\nLinux\r\n\r\n### Describe the bug\r\n\r\n# Overview \r\n\r\nOptimism derives L2 blocks from log events and calldata submitted to L1. To prevent attacks from a malicious RPC provider, our system performs a series of sanity checks as well as a `receiptsRoot` check to verify that log events are valid and none are missing. While testing our op-node against a fork of L1 Goerli using Anvil, we observed these checks failing in the below ways.\r\n\r\n# Mismatch between the `logIndex` field and actual log index\r\n\r\nThe `logIndex` field sometimes doesn't match the actual index the log appears in the RPC. Here's `cast` output from one of the affected receipts:\r\n\r\n```\r\n➜  ~ cast receipt 0x2676dfb732072e733fe40dc6bb466808ef4ac3ddf71d5d32502502241449bbee --rpc-url <rpc-url>\r\n\r\nblockHash               0xd28140f6b523d36cd7fba9594a7b58cb354aeafae1ce9be9cb992f9b0542f98c\r\nblockNumber             8083603\r\ncontractAddress\r\ncumulativeGasUsed       178140\r\neffectiveGasPrice       1000000000\r\ngasUsed                 86860\r\nlogs                    [{\"address\":\"0xc2beaa06e18ab001fcf4318030c31c334c71d500\",\"topics\":[\"0xa7aaf2512769da4e444e3de247be2564225c2e7a8f74cfe528e46e17d24868e2\",\"0xc2c2ee83a423d279138ab45d7de00bc85c70bc133ab2af5b4e53f885f5bef170\",\"0x0000000000000000000000000000000000000000000000000000000000000001\",\"0x00000000000000000000000000000000000000000000000000000000638ed10c\"],\"data\":\"0x0000000000000000000000000000000000000000000000000000000000312d1c\",\"blockHash\":\"0xd28140f6b523d36cd7fba9594a7b58cb354aeafae1ce9be9cb992f9b0542f98c\",\"blockNumber\":\"0x7b5893\",\"transactionHash\":\"0x2676dfb732072e733fe40dc6bb466808ef4ac3ddf71d5d32502502241449bbee\",\"transactionIndex\":\"0x1\",\"logIndex\":\"0x1\",\"transactionLogIndex\":\"0x0\",\"removed\":false}]\r\nlogsBloom               0x00010000001000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000040000000000000000000000008001000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000010000000000004000000000900000000000200000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000\r\nroot\r\nstatus                  1\r\ntransactionHash         0x2676dfb732072e733fe40dc6bb466808ef4ac3ddf71d5d32502502241449bbee\r\ntransactionIndex        1\r\ntype\r\n```\r\n\r\nYou'll see that the `logIndex` in the first log above is `0x1`, when it should be `0x0`.\r\n\r\n# Computed receipts root does not match returned `receiptsRoot`\r\n\r\nWhen we compute a receipt root for a given block using all the the transaction receipts within it, the computed receipts root does not match the `receiptsRoot` within the block.\r\n\r\nUnfortunately, I don't know exactly why this is. We've verified that our receipts root computation works by running the same code against Goerli with no issue. I wish I had more concrete information about the root cause here, but I'm fairly confident that you can reproduce this yourself by performing the same computation we do on an Anvil block with receipts in it. Here's the code we're using to compute the root, in case it helps: https://github.com/ethereum-optimism/optimism/blob/develop/op-node/sources/receipts.go#L65-L72.\r\n\r\n# Transaction hashes are duplicated\r\n\r\nWe're also seeing cases where transaction hashes appear in multiple blocks. Relevant `cast` output is below:\r\n\r\n```\r\n➜  ~ cast block 8083936 --rpc-url <rpc url>\r\n\r\n\r\nbaseFeePerGas        0\r\ndifficulty           0\r\nextraData            0x\r\ngasLimit             30000000\r\ngasUsed              0\r\nhash                 0xa0de39cbb463b35e5cd9b29a212ff6bdb0734c6f86e7ab04188a796f8c27aa11\r\nlogsBloom            0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\nminer                0x0000000000000000000000000000000000000000\r\nmixHash              0x0000000000000000000000000000000000000000000000000000000000000000\r\nnonce                0x0000000000000000\r\nnumber               8083936\r\nparentHash           0xc85e0ecde7349938f6daea79d6834dc278fe05e305dca5fc94a80a9d923dfe16\r\nreceiptsRoot         0xa1d38b83ec14e13227c918362bd5ad07a7ea3ea830853ef3b181dfad043564d0\r\nsealFields           [\r\n\t0x0000000000000000000000000000000000000000000000000000000000000000\r\n\t0x0000000000000000\r\n]\r\nsha3Uncles           0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347\r\nsize                 633\r\nstateRoot            0x0000000000000000000000000000000000000000000000000000000000000000\r\ntimestamp            1670308008\r\ntotalDifficulty      10790000\r\ntransactions:        [\r\n\t0xc9f5537c71d2e8aaf1a7f5884acfbe1b6df77d773bb7b4569843f7fe7601d3d4\r\n]\r\n➜  ~ cast block 8083956 --rpc-url <rpc url>\r\n\r\n\r\nbaseFeePerGas        0\r\ndifficulty           0\r\nextraData            0x\r\ngasLimit             30000000\r\ngasUsed              0\r\nhash                 0xc6449f40c413ba7bebdcba3f620fecfe958a6c109a21aeb7ff522f4149fabc5b\r\nlogsBloom            0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r\nminer                0x0000000000000000000000000000000000000000\r\nmixHash              0x0000000000000000000000000000000000000000000000000000000000000000\r\nnonce                0x0000000000000000\r\nnumber               8083956\r\nparentHash           0x9198cd3b82e3892626f4a366baa05afd6d3c476598d7e96d0484ca7bcb69b235\r\nreceiptsRoot         0xa1d38b83ec14e13227c918362bd5ad07a7ea3ea830853ef3b181dfad043564d0\r\nsealFields           [\r\n\t0x0000000000000000000000000000000000000000000000000000000000000000\r\n\t0x0000000000000000\r\n]\r\nsha3Uncles           0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347\r\nsize                 633\r\nstateRoot            0x0000000000000000000000000000000000000000000000000000000000000000\r\ntimestamp            1670308248\r\ntotalDifficulty      10790000\r\ntransactions:        [\r\n\t0xc9f5537c71d2e8aaf1a7f5884acfbe1b6df77d773bb7b4569843f7fe7601d3d4\r\n]\r\n```\r\n\r\nWe're able to work around these issues for now, but I thought I'd bring them to your attention anyway. Thanks for everything y'all do! Foundry is integral to our development process.",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/3840/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3840/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1362727398",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3840#issuecomment-1362727398",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3840",
    "id": 1362727398,
    "node_id": "IC_kwDOGBlvNc5ROZHm",
    "user": {
      "login": "rkrasiuk",
      "id": 25429261,
      "node_id": "MDQ6VXNlcjI1NDI5MjYx",
      "avatar_url": "https://avatars.githubusercontent.com/u/25429261?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rkrasiuk",
      "html_url": "https://github.com/rkrasiuk",
      "followers_url": "https://api.github.com/users/rkrasiuk/followers",
      "following_url": "https://api.github.com/users/rkrasiuk/following{/other_user}",
      "gists_url": "https://api.github.com/users/rkrasiuk/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rkrasiuk/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rkrasiuk/subscriptions",
      "organizations_url": "https://api.github.com/users/rkrasiuk/orgs",
      "repos_url": "https://api.github.com/users/rkrasiuk/repos",
      "events_url": "https://api.github.com/users/rkrasiuk/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rkrasiuk/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-22T11:27:56Z",
    "updated_at": "2022-12-22T11:27:56Z",
    "author_association": "COLLABORATOR",
    "body": "hey @mslipper, could you pls tell me which chains these txs/blocks are from? if that's local, is there any way to repro? ",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1362727398/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
