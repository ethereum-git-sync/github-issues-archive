{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/4399",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4399/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4399/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4399/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/4399",
  "id": 1591968709,
  "node_id": "I_kwDOGBlvNc5e44PF",
  "number": 4399,
  "title": "Anvil Write Performance Issue",
  "user": {
    "login": "PhilippLgh",
    "id": 4280481,
    "node_id": "MDQ6VXNlcjQyODA0ODE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4280481?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/PhilippLgh",
    "html_url": "https://github.com/PhilippLgh",
    "followers_url": "https://api.github.com/users/PhilippLgh/followers",
    "following_url": "https://api.github.com/users/PhilippLgh/following{/other_user}",
    "gists_url": "https://api.github.com/users/PhilippLgh/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/PhilippLgh/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/PhilippLgh/subscriptions",
    "organizations_url": "https://api.github.com/users/PhilippLgh/orgs",
    "repos_url": "https://api.github.com/users/PhilippLgh/repos",
    "events_url": "https://api.github.com/users/PhilippLgh/events{/privacy}",
    "received_events_url": "https://api.github.com/users/PhilippLgh/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3334394228,
      "node_id": "MDU6TGFiZWwzMzM0Mzk0MjI4",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-bug",
      "name": "T-bug",
      "color": "d73a4a",
      "default": false,
      "description": "Type: bug"
    },
    {
      "id": 4077188949,
      "node_id": "LA_kwDOGBlvNc7zBPdV",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/C-anvil",
      "name": "C-anvil",
      "color": "5319E7",
      "default": false,
      "description": "Command: anvil"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": {
    "login": "mattsse",
    "id": 19890894,
    "node_id": "MDQ6VXNlcjE5ODkwODk0",
    "avatar_url": "https://avatars.githubusercontent.com/u/19890894?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mattsse",
    "html_url": "https://github.com/mattsse",
    "followers_url": "https://api.github.com/users/mattsse/followers",
    "following_url": "https://api.github.com/users/mattsse/following{/other_user}",
    "gists_url": "https://api.github.com/users/mattsse/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mattsse/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mattsse/subscriptions",
    "organizations_url": "https://api.github.com/users/mattsse/orgs",
    "repos_url": "https://api.github.com/users/mattsse/repos",
    "events_url": "https://api.github.com/users/mattsse/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mattsse/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "mattsse",
      "id": 19890894,
      "node_id": "MDQ6VXNlcjE5ODkwODk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/19890894?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mattsse",
      "html_url": "https://github.com/mattsse",
      "followers_url": "https://api.github.com/users/mattsse/followers",
      "following_url": "https://api.github.com/users/mattsse/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattsse/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mattsse/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattsse/subscriptions",
      "organizations_url": "https://api.github.com/users/mattsse/orgs",
      "repos_url": "https://api.github.com/users/mattsse/repos",
      "events_url": "https://api.github.com/users/mattsse/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mattsse/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2023-02-20T14:27:08Z",
  "updated_at": "2023-02-27T13:12:36Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Component\r\n\r\nAnvil\r\n\r\n### Have you ensured that all of these are up to date?\r\n\r\n- [X] Foundry\r\n- [X] Foundryup\r\n\r\n### What version of Foundry are you on?\r\n\r\nforge 0.2.0 (e2fa2b5 2023-02-19T00:05:02.282096Z)\r\n\r\n### What command(s) is the bug in?\r\n\r\n_No response_\r\n\r\n### Operating System\r\n\r\nNone\r\n\r\n### Describe the bug\r\n\r\nAnvil seems to have big performance issues when lots of data are written:\r\n\r\n**Test Contract**\r\n```solidity\r\ncontract TestContract{\r\n\r\n  mapping(uint => uint) someData;\r\n\r\n  function writeData(uint256[] memory numbersA, uint256[] memory numbersB) public {\r\n    for (uint i = 0; i < numbersA.length; i++) {\r\n      someData[numbersA[i]] = numbersB[i];\r\n    }\r\n  }\r\n\r\n}\r\n```\r\n**Writing Data in chunks of 150 + 150 uint**\r\n```typescript\r\n  let t0 = Date.now()\r\n  for ([numbersA, numbersB] of chunk) {\r\n    console.log('write data chunk', i++, data.length, 'after', Date.now()-t0, 'ms')\r\n    tx = await contract.writeData(numbersA, numbersB)\r\n    receipt = await tx.wait()\r\n  }\r\n```\r\n\r\n**Result console.log output**\r\n```shell\r\nwriting chunks 60\r\nwrite data chunk 0 150 after 0 ms\r\nwrite data chunk 1 150 after 26 ms\r\nwrite data chunk 2 150 after 43 ms\r\nwrite data chunk 3 150 after 62 ms\r\nwrite data chunk 4 150 after 79 ms\r\nwrite data chunk 5 150 after 93 ms\r\nwrite data chunk 6 150 after 110 ms\r\nwrite data chunk 7 150 after 126 ms\r\nwrite data chunk 8 150 after 146 ms\r\nwrite data chunk 9 150 after 164 ms\r\nwrite data chunk 10 150 after 181 ms\r\nwrite data chunk 11 150 after 195 ms\r\nwrite data chunk 12 150 after 212 ms\r\nwrite data chunk 13 150 after 227 ms\r\nwrite data chunk 14 150 after 243 ms\r\nwrite data chunk 15 150 after 263 ms\r\nwrite data chunk 16 150 after 4287 ms\r\nwrite data chunk 17 150 after 8322 ms\r\nwrite data chunk 18 150 after 12368 ms\r\nwrite data chunk 19 150 after 16414 ms\r\nwrite data chunk 20 150 after 20449 ms\r\nwrite data chunk 21 150 after 24474 ms\r\nwrite data chunk 22 150 after 24507 ms\r\nwrite data chunk 23 150 after 28534 ms\r\nwrite data chunk 24 150 after 32570 ms\r\nwrite data chunk 25 150 after 36616 ms\r\nwrite data chunk 26 150 after 40657 ms\r\n```\r\n\r\nSubsequent writes on same node will be incredibly slow and node needs to be restarted.",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/4399/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4399/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1437113905",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4399#issuecomment-1437113905",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4399",
    "id": 1437113905,
    "node_id": "IC_kwDOGBlvNc5VqJ4x",
    "user": {
      "login": "mattsse",
      "id": 19890894,
      "node_id": "MDQ6VXNlcjE5ODkwODk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/19890894?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mattsse",
      "html_url": "https://github.com/mattsse",
      "followers_url": "https://api.github.com/users/mattsse/followers",
      "following_url": "https://api.github.com/users/mattsse/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattsse/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mattsse/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattsse/subscriptions",
      "organizations_url": "https://api.github.com/users/mattsse/orgs",
      "repos_url": "https://api.github.com/users/mattsse/repos",
      "events_url": "https://api.github.com/users/mattsse/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mattsse/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-02-20T14:30:37Z",
    "updated_at": "2023-02-20T14:30:37Z",
    "author_association": "MEMBER",
    "body": "could you perhaps prepare a repro for this?",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1437113905/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1437118520",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4399#issuecomment-1437118520",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4399",
    "id": 1437118520,
    "node_id": "IC_kwDOGBlvNc5VqLA4",
    "user": {
      "login": "PhilippLgh",
      "id": 4280481,
      "node_id": "MDQ6VXNlcjQyODA0ODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4280481?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/PhilippLgh",
      "html_url": "https://github.com/PhilippLgh",
      "followers_url": "https://api.github.com/users/PhilippLgh/followers",
      "following_url": "https://api.github.com/users/PhilippLgh/following{/other_user}",
      "gists_url": "https://api.github.com/users/PhilippLgh/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/PhilippLgh/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/PhilippLgh/subscriptions",
      "organizations_url": "https://api.github.com/users/PhilippLgh/orgs",
      "repos_url": "https://api.github.com/users/PhilippLgh/repos",
      "events_url": "https://api.github.com/users/PhilippLgh/events{/privacy}",
      "received_events_url": "https://api.github.com/users/PhilippLgh/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-02-20T14:33:59Z",
    "updated_at": "2023-02-20T14:33:59Z",
    "author_association": "NONE",
    "body": "Can try. What's best way to do this?",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1437118520/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1437122994",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4399#issuecomment-1437122994",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4399",
    "id": 1437122994,
    "node_id": "IC_kwDOGBlvNc5VqMGy",
    "user": {
      "login": "mattsse",
      "id": 19890894,
      "node_id": "MDQ6VXNlcjE5ODkwODk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/19890894?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mattsse",
      "html_url": "https://github.com/mattsse",
      "followers_url": "https://api.github.com/users/mattsse/followers",
      "following_url": "https://api.github.com/users/mattsse/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattsse/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mattsse/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattsse/subscriptions",
      "organizations_url": "https://api.github.com/users/mattsse/orgs",
      "repos_url": "https://api.github.com/users/mattsse/repos",
      "events_url": "https://api.github.com/users/mattsse/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mattsse/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-02-20T14:37:20Z",
    "updated_at": "2023-02-20T14:37:20Z",
    "author_association": "MEMBER",
    "body": "smol repository with an example that I can just run via `yarn`\r\n\r\nmy js skills are incredibly limited so support on this would speed up debugging immensely.\r\nty!",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1437122994/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1437169809",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4399#issuecomment-1437169809",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4399",
    "id": 1437169809,
    "node_id": "IC_kwDOGBlvNc5VqXiR",
    "user": {
      "login": "PhilippLgh",
      "id": 4280481,
      "node_id": "MDQ6VXNlcjQyODA0ODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4280481?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/PhilippLgh",
      "html_url": "https://github.com/PhilippLgh",
      "followers_url": "https://api.github.com/users/PhilippLgh/followers",
      "following_url": "https://api.github.com/users/PhilippLgh/following{/other_user}",
      "gists_url": "https://api.github.com/users/PhilippLgh/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/PhilippLgh/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/PhilippLgh/subscriptions",
      "organizations_url": "https://api.github.com/users/PhilippLgh/orgs",
      "repos_url": "https://api.github.com/users/PhilippLgh/repos",
      "events_url": "https://api.github.com/users/PhilippLgh/events{/privacy}",
      "received_events_url": "https://api.github.com/users/PhilippLgh/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-02-20T15:10:46Z",
    "updated_at": "2023-02-20T15:10:46Z",
    "author_association": "NONE",
    "body": "Let me know if you need assistance in running the test\r\n\r\nhttps://github.com/PhilippLgh/anvil-perf",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1437169809/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
