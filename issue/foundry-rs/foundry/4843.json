{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/4843",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4843/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4843/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4843/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/4843",
  "id": 1688044416,
  "node_id": "I_kwDOGBlvNc5knYOA",
  "number": 4843,
  "title": "BlockOutOfRangeError: block height is 23 but requested was 21",
  "user": {
    "login": "lnist",
    "id": 16150076,
    "node_id": "MDQ6VXNlcjE2MTUwMDc2",
    "avatar_url": "https://avatars.githubusercontent.com/u/16150076?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/lnist",
    "html_url": "https://github.com/lnist",
    "followers_url": "https://api.github.com/users/lnist/followers",
    "following_url": "https://api.github.com/users/lnist/following{/other_user}",
    "gists_url": "https://api.github.com/users/lnist/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/lnist/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/lnist/subscriptions",
    "organizations_url": "https://api.github.com/users/lnist/orgs",
    "repos_url": "https://api.github.com/users/lnist/repos",
    "events_url": "https://api.github.com/users/lnist/events{/privacy}",
    "received_events_url": "https://api.github.com/users/lnist/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3334394228,
      "node_id": "MDU6TGFiZWwzMzM0Mzk0MjI4",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-bug",
      "name": "T-bug",
      "color": "d73a4a",
      "default": false,
      "description": "Type: bug"
    },
    {
      "id": 4077188949,
      "node_id": "LA_kwDOGBlvNc7zBPdV",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/C-anvil",
      "name": "C-anvil",
      "color": "5319E7",
      "default": false,
      "description": "Command: anvil"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2023-04-28T07:25:50Z",
  "updated_at": "2023-12-31T08:45:54Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Component\n\nAnvil\n\n### Have you ensured that all of these are up to date?\n\n- [X] Foundry\n- [X] Foundryup\n\n### What version of Foundry are you on?\n\nforge 0.2.0 (8f246e0 2023-04-28T00:03:59.802167368Z)\n\n### What command(s) is the bug in?\n\nanvil\n\n### Operating System\n\nLinux\n\n### Describe the bug\n\nAs the title says, we occasionally get errors similar to `BlockOutOfRangeError: block height is 23 but requested was 21`  and it seems like a race-condition happening when using emv_revert+evm_snapshot.\r\n\r\nSince the requested is lower than the height, I assume the error is raised by https://github.com/foundry-rs/foundry/blob/8f246e07c89129b6effa89f0d71c4ac67758a155/anvil/src/eth/backend/mem/mod.rs#L1493 \r\n\r\nWe cannot reproduce locally, and it only happens occasionally when running our typescript test suite in GitHub actions with the default runners (which is very resource constrained, but, e.g. cpulimit of anvil does not seem to reproduce).\r\n\r\nWe use (evm_snapshot+)evm_revert+evm_snapshot to reset state between each test. So I definitely expect that to be the culprit.\r\n\r\nWe are not using --prune-history (so https://github.com/foundry-rs/foundry/issues/4252 seems irrelevant)\r\nWe are not using forks in these tests (so https://github.com/foundry-rs/foundry/issues/4082 , https://github.com/foundry-rs/foundry/issues/3700 and https://github.com/foundry-rs/foundry/issues/3718 seems irrelevant)\r\n\r\nI am not sure whether we are doing something we should not be doing or whether this is an actual bug.\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/4843/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4843/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1532705546",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4843#issuecomment-1532705546",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4843",
    "id": 1532705546,
    "node_id": "IC_kwDOGBlvNc5bWzsK",
    "user": {
      "login": "lnist",
      "id": 16150076,
      "node_id": "MDQ6VXNlcjE2MTUwMDc2",
      "avatar_url": "https://avatars.githubusercontent.com/u/16150076?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/lnist",
      "html_url": "https://github.com/lnist",
      "followers_url": "https://api.github.com/users/lnist/followers",
      "following_url": "https://api.github.com/users/lnist/following{/other_user}",
      "gists_url": "https://api.github.com/users/lnist/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/lnist/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/lnist/subscriptions",
      "organizations_url": "https://api.github.com/users/lnist/orgs",
      "repos_url": "https://api.github.com/users/lnist/repos",
      "events_url": "https://api.github.com/users/lnist/events{/privacy}",
      "received_events_url": "https://api.github.com/users/lnist/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-03T09:22:02Z",
    "updated_at": "2023-05-03T09:22:02Z",
    "author_association": "NONE",
    "body": "One thing that can happen in our tests are 1) there can be pending transactions when we call revert - I would expect these to be dropped, but maybe the behavior is undefined? 2) we may have pending RPC calls to read from the chain - could this mess up the revert?",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1532705546/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1767831244",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4843#issuecomment-1767831244",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4843",
    "id": 1767831244,
    "node_id": "IC_kwDOGBlvNc5pXvbM",
    "user": {
      "login": "0x-r4bbit",
      "id": 445106,
      "node_id": "MDQ6VXNlcjQ0NTEwNg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/445106?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/0x-r4bbit",
      "html_url": "https://github.com/0x-r4bbit",
      "followers_url": "https://api.github.com/users/0x-r4bbit/followers",
      "following_url": "https://api.github.com/users/0x-r4bbit/following{/other_user}",
      "gists_url": "https://api.github.com/users/0x-r4bbit/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/0x-r4bbit/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/0x-r4bbit/subscriptions",
      "organizations_url": "https://api.github.com/users/0x-r4bbit/orgs",
      "repos_url": "https://api.github.com/users/0x-r4bbit/repos",
      "events_url": "https://api.github.com/users/0x-r4bbit/events{/privacy}",
      "received_events_url": "https://api.github.com/users/0x-r4bbit/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-10-18T07:26:35Z",
    "updated_at": "2023-10-18T07:26:35Z",
    "author_association": "CONTRIBUTOR",
    "body": "Experiencing a similar issue when trying to send a transaction via metamask to a local anvil node:\r\n\r\n```\r\nMetaMask - RPC Error: [ethjs-query] while formatting outputs from RPC '{\"value\":{\"code\":-32603,\"data\":{\"code\":-32602,\"message\":\"BlockOutOfRangeError: block height is 8 but requested was 18\"}}}' \r\n```\r\n\r\nIt doesn't happen when sending the tx straight via `cast`.",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1767831244/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1872704611",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4843#issuecomment-1872704611",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4843",
    "id": 1872704611,
    "node_id": "IC_kwDOGBlvNc5vnzRj",
    "user": {
      "login": "RonTuretzky",
      "id": 74178515,
      "node_id": "MDQ6VXNlcjc0MTc4NTE1",
      "avatar_url": "https://avatars.githubusercontent.com/u/74178515?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/RonTuretzky",
      "html_url": "https://github.com/RonTuretzky",
      "followers_url": "https://api.github.com/users/RonTuretzky/followers",
      "following_url": "https://api.github.com/users/RonTuretzky/following{/other_user}",
      "gists_url": "https://api.github.com/users/RonTuretzky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/RonTuretzky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/RonTuretzky/subscriptions",
      "organizations_url": "https://api.github.com/users/RonTuretzky/orgs",
      "repos_url": "https://api.github.com/users/RonTuretzky/repos",
      "events_url": "https://api.github.com/users/RonTuretzky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/RonTuretzky/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-12-31T06:35:44Z",
    "updated_at": "2023-12-31T06:35:44Z",
    "author_association": "NONE",
    "body": "I get his error when running cast run on a tx to an anvil node ",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1872704611/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1872768228",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4843#issuecomment-1872768228",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4843",
    "id": 1872768228,
    "node_id": "IC_kwDOGBlvNc5voCzk",
    "user": {
      "login": "mattsse",
      "id": 19890894,
      "node_id": "MDQ6VXNlcjE5ODkwODk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/19890894?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mattsse",
      "html_url": "https://github.com/mattsse",
      "followers_url": "https://api.github.com/users/mattsse/followers",
      "following_url": "https://api.github.com/users/mattsse/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattsse/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mattsse/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattsse/subscriptions",
      "organizations_url": "https://api.github.com/users/mattsse/orgs",
      "repos_url": "https://api.github.com/users/mattsse/repos",
      "events_url": "https://api.github.com/users/mattsse/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mattsse/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-12-31T07:24:25Z",
    "updated_at": "2023-12-31T07:24:25Z",
    "author_association": "MEMBER",
    "body": "hmm, could you provide an example of how to reproduce this? that would help me debugging this",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1872768228/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1872866677",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4843#issuecomment-1872866677",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4843",
    "id": 1872866677,
    "node_id": "IC_kwDOGBlvNc5voa11",
    "user": {
      "login": "RonTuretzky",
      "id": 74178515,
      "node_id": "MDQ6VXNlcjc0MTc4NTE1",
      "avatar_url": "https://avatars.githubusercontent.com/u/74178515?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/RonTuretzky",
      "html_url": "https://github.com/RonTuretzky",
      "followers_url": "https://api.github.com/users/RonTuretzky/followers",
      "following_url": "https://api.github.com/users/RonTuretzky/following{/other_user}",
      "gists_url": "https://api.github.com/users/RonTuretzky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/RonTuretzky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/RonTuretzky/subscriptions",
      "organizations_url": "https://api.github.com/users/RonTuretzky/orgs",
      "repos_url": "https://api.github.com/users/RonTuretzky/repos",
      "events_url": "https://api.github.com/users/RonTuretzky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/RonTuretzky/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-12-31T08:45:53Z",
    "updated_at": "2023-12-31T08:45:53Z",
    "author_association": "NONE",
    "body": "> hmm, could you provide an example of how to reproduce this? that would help me debugging this\r\n\r\nI unfortunately cannot send the full code but generally the flow is \r\n\r\n1. I fork anvil with a goerli rpc \r\n2. I deploy a smart contract and send a transaction \r\n3. I run ```cast run <tx_hash> ```\r\n4. I get the following error \r\n\r\n``` \r\nExecuting previous transactions from the block.\r\n2023-12-31T08:38:33.147839Z ERROR sharedbackend: Failed to send/recv `basic` err=failed to get account for 0xbeFe7DabDF096d389eF332fd2874268b81dd8ADF: (code: -32602, message: BlockOutOfRangeError: block height is 10299038 but requested was 10298993, data: None) address=0xbeFe7DabDF096d389eF332fd2874268b81dd8ADF\r\nError: \r\nbackend: failed while inspecting: Database error: failed to get account for 0xbeFe7DabDF096d389eF332fd2874268b81dd8ADF: (code: -32602, message: BlockOutOfRangeError: block height is 10299038 but requested was 10298993, data: None)\r\n```\r\n\r\nrunning it with -q does not change the result. \r\n\r\nI know the account does exist and has made transactions that have succeeded ...",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1872866677/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
