{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/1649",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/1649/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/1649/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/1649/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/1649",
  "id": 1239233837,
  "node_id": "I_kwDOGBlvNc5J3TUt",
  "number": 1649,
  "title": "vm.roll can result in panic on L2 network",
  "user": {
    "login": "RiccardoBiosas",
    "id": 65150720,
    "node_id": "MDQ6VXNlcjY1MTUwNzIw",
    "avatar_url": "https://avatars.githubusercontent.com/u/65150720?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/RiccardoBiosas",
    "html_url": "https://github.com/RiccardoBiosas",
    "followers_url": "https://api.github.com/users/RiccardoBiosas/followers",
    "following_url": "https://api.github.com/users/RiccardoBiosas/following{/other_user}",
    "gists_url": "https://api.github.com/users/RiccardoBiosas/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/RiccardoBiosas/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/RiccardoBiosas/subscriptions",
    "organizations_url": "https://api.github.com/users/RiccardoBiosas/orgs",
    "repos_url": "https://api.github.com/users/RiccardoBiosas/repos",
    "events_url": "https://api.github.com/users/RiccardoBiosas/events{/privacy}",
    "received_events_url": "https://api.github.com/users/RiccardoBiosas/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3334394228,
      "node_id": "MDU6TGFiZWwzMzM0Mzk0MjI4",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-bug",
      "name": "T-bug",
      "color": "d73a4a",
      "default": false,
      "description": "Type: bug"
    },
    {
      "id": 3593644915,
      "node_id": "LA_kwDOGBlvNc7WMqtz",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/Cmd-forge-test",
      "name": "Cmd-forge-test",
      "color": "006B75",
      "default": false,
      "description": "Command: forge test"
    },
    {
      "id": 3703752787,
      "node_id": "LA_kwDOGBlvNc7cwshT",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/C-forge",
      "name": "C-forge",
      "color": "5319E7",
      "default": false,
      "description": "Command: forge"
    },
    {
      "id": 3703752960,
      "node_id": "LA_kwDOGBlvNc7cwskA",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/A-cheatcodes",
      "name": "A-cheatcodes",
      "color": "FBCA04",
      "default": false,
      "description": "Area: cheatcodes"
    },
    {
      "id": 3759719259,
      "node_id": "LA_kwDOGBlvNc7gGMNb",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/P-high",
      "name": "P-high",
      "color": "D93F0B",
      "default": false,
      "description": "Priority: high"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2022-05-17T22:42:57Z",
  "updated_at": "2022-08-01T19:51:37Z",
  "closed_at": "2022-08-01T19:51:37Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Component\n\nForge\n\n### Have you ensured that all of these are up to date?\n\n- [X] Foundry\n- [ ] Foundryup\n\n### What version of Foundry are you on?\n\nforge 0.2.0\n\n### What command(s) is the bug in?\n\nforge test\n\n### Operating System\n\nLinux\n\n### Describe the bug\n\nAs described in [this issue](https://github.com/foundry-rs/foundry/issues/748), forge does not currently handle the idiosyncrasies of each EVM-compatible L2 network. In the context of testing contracts which rely on a block.number delta against an Arbitrum fork pinned at a certain block, using `vm.roll` as a workaround would suffice until now.\r\n\r\nHowever, after upgrading to foundry 2.0, forking an Arbitrum live network pinned at a certain block (i.e.: `forge test --fork-url ARBITRUM_RPC --fork-block-number 1337`) and then using `vm.roll` to set the test contract's `block.number` to an L1 value results in a panic. This prevents me from testing some logic where the L2 contract calculates the difference between a `lastBlockNumber` variable and the current block.number (both L1 values).\r\n\r\nI think that the change responsible for this behavior is [this commit](https://github.com/foundry-rs/foundry/commit/ceaecc660caada579b28f3f4967e6fb40c594e66#diff-61de971a1475be0209ee9896ce71d6b3424904b26eb2ea0227d1ff23ee4e6e6bR309). In fact, after downgrading foundry to the [previous commit](https://github.com/foundry-rs/foundry/commit/4415ff47cc03c9f9657dd2959f57de411a4e67b2) ( `foundryup -C 4415ff47cc03c9f9657dd2959f57de411a4e67b2`), the test/`vm.roll` worked again as expected\r\n",
  "closed_by": {
    "login": "onbjerg",
    "id": 8862627,
    "node_id": "MDQ6VXNlcjg4NjI2Mjc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/8862627?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/onbjerg",
    "html_url": "https://github.com/onbjerg",
    "followers_url": "https://api.github.com/users/onbjerg/followers",
    "following_url": "https://api.github.com/users/onbjerg/following{/other_user}",
    "gists_url": "https://api.github.com/users/onbjerg/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/onbjerg/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/onbjerg/subscriptions",
    "organizations_url": "https://api.github.com/users/onbjerg/orgs",
    "repos_url": "https://api.github.com/users/onbjerg/repos",
    "events_url": "https://api.github.com/users/onbjerg/events{/privacy}",
    "received_events_url": "https://api.github.com/users/onbjerg/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/1649/reactions",
    "total_count": 3,
    "+1": 3,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/1649/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1133867547",
    "html_url": "https://github.com/foundry-rs/foundry/issues/1649#issuecomment-1133867547",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/1649",
    "id": 1133867547,
    "node_id": "IC_kwDOGBlvNc5DlXIb",
    "user": {
      "login": "mattsse",
      "id": 19890894,
      "node_id": "MDQ6VXNlcjE5ODkwODk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/19890894?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mattsse",
      "html_url": "https://github.com/mattsse",
      "followers_url": "https://api.github.com/users/mattsse/followers",
      "following_url": "https://api.github.com/users/mattsse/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattsse/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mattsse/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattsse/subscriptions",
      "organizations_url": "https://api.github.com/users/mattsse/orgs",
      "repos_url": "https://api.github.com/users/mattsse/repos",
      "events_url": "https://api.github.com/users/mattsse/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mattsse/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-22T10:44:10Z",
    "updated_at": "2022-05-22T10:44:10Z",
    "author_association": "MEMBER",
    "body": "thanks for raising this, \r\n\r\n> using vm.roll to set the test contract's block.number to an L1 value results in a panic. \r\n\r\nthis is the expected behavior, because the fork is bound to a specific chain.\r\n\r\n#ceaecc660 introduced panics because that's the only safe behavior when we failed to look up data on the fork.\r\n\r\nthis is good feedback and we're working on making forking support more flexible for different L2s: https://github.com/foundry-rs/foundry/issues/834\r\n\r\nso you can easily switch the context from within your test and the use case you're describing should be possible.",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1133867547/reactions",
      "total_count": 2,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 2,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1172619901",
    "html_url": "https://github.com/foundry-rs/foundry/issues/1649#issuecomment-1172619901",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/1649",
    "id": 1172619901,
    "node_id": "IC_kwDOGBlvNc5F5MJ9",
    "user": {
      "login": "onbjerg",
      "id": 8862627,
      "node_id": "MDQ6VXNlcjg4NjI2Mjc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8862627?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/onbjerg",
      "html_url": "https://github.com/onbjerg",
      "followers_url": "https://api.github.com/users/onbjerg/followers",
      "following_url": "https://api.github.com/users/onbjerg/following{/other_user}",
      "gists_url": "https://api.github.com/users/onbjerg/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/onbjerg/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/onbjerg/subscriptions",
      "organizations_url": "https://api.github.com/users/onbjerg/orgs",
      "repos_url": "https://api.github.com/users/onbjerg/repos",
      "events_url": "https://api.github.com/users/onbjerg/events{/privacy}",
      "received_events_url": "https://api.github.com/users/onbjerg/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-07-01T18:42:10Z",
    "updated_at": "2022-07-01T18:42:10Z",
    "author_association": "MEMBER",
    "body": "@mattsse Is this fixed by multi-fork? If so, can you kindly link PR and issue together? :smile: ",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1172619901/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1201643744",
    "html_url": "https://github.com/foundry-rs/foundry/issues/1649#issuecomment-1201643744",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/1649",
    "id": 1201643744,
    "node_id": "IC_kwDOGBlvNc5Hn6Dg",
    "user": {
      "login": "mattsse",
      "id": 19890894,
      "node_id": "MDQ6VXNlcjE5ODkwODk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/19890894?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mattsse",
      "html_url": "https://github.com/mattsse",
      "followers_url": "https://api.github.com/users/mattsse/followers",
      "following_url": "https://api.github.com/users/mattsse/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattsse/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mattsse/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattsse/subscriptions",
      "organizations_url": "https://api.github.com/users/mattsse/orgs",
      "repos_url": "https://api.github.com/users/mattsse/repos",
      "events_url": "https://api.github.com/users/mattsse/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mattsse/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-01T19:50:28Z",
    "updated_at": "2022-08-01T19:50:28Z",
    "author_association": "MEMBER",
    "body": "it's not handled automatically yet, a workaround is described here https://github.com/foundry-rs/foundry/issues/748#issuecomment-1178906548\r\n\r\nwe decided to hold off on this until the major L2 upgrades are rolled out before baking in chain agnostic stuff.\r\n\r\nbut I think we can close this in favor of #748 ?",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1201643744/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1201644654",
    "html_url": "https://github.com/foundry-rs/foundry/issues/1649#issuecomment-1201644654",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/1649",
    "id": 1201644654,
    "node_id": "IC_kwDOGBlvNc5Hn6Ru",
    "user": {
      "login": "onbjerg",
      "id": 8862627,
      "node_id": "MDQ6VXNlcjg4NjI2Mjc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8862627?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/onbjerg",
      "html_url": "https://github.com/onbjerg",
      "followers_url": "https://api.github.com/users/onbjerg/followers",
      "following_url": "https://api.github.com/users/onbjerg/following{/other_user}",
      "gists_url": "https://api.github.com/users/onbjerg/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/onbjerg/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/onbjerg/subscriptions",
      "organizations_url": "https://api.github.com/users/onbjerg/orgs",
      "repos_url": "https://api.github.com/users/onbjerg/repos",
      "events_url": "https://api.github.com/users/onbjerg/events{/privacy}",
      "received_events_url": "https://api.github.com/users/onbjerg/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-01T19:51:37Z",
    "updated_at": "2022-08-01T19:51:37Z",
    "author_association": "MEMBER",
    "body": "Yeah, agreed :+1: ",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1201644654/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
