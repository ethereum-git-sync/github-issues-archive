{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/4740",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4740/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4740/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4740/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/4740",
  "id": 1668316253,
  "node_id": "I_kwDOGBlvNc5jcHxd",
  "number": 4740,
  "title": "Inconsistent discrepancies between `gasleft()` and gas cost annotation in traces",
  "user": {
    "login": "jkrivine",
    "id": 293262,
    "node_id": "MDQ6VXNlcjI5MzI2Mg==",
    "avatar_url": "https://avatars.githubusercontent.com/u/293262?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jkrivine",
    "html_url": "https://github.com/jkrivine",
    "followers_url": "https://api.github.com/users/jkrivine/followers",
    "following_url": "https://api.github.com/users/jkrivine/following{/other_user}",
    "gists_url": "https://api.github.com/users/jkrivine/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jkrivine/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jkrivine/subscriptions",
    "organizations_url": "https://api.github.com/users/jkrivine/orgs",
    "repos_url": "https://api.github.com/users/jkrivine/repos",
    "events_url": "https://api.github.com/users/jkrivine/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jkrivine/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3334394228,
      "node_id": "MDU6TGFiZWwzMzM0Mzk0MjI4",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-bug",
      "name": "T-bug",
      "color": "d73a4a",
      "default": false,
      "description": "Type: bug"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2023-04-14T14:05:37Z",
  "updated_at": "2023-04-14T21:24:47Z",
  "closed_at": "2023-04-14T14:31:52Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Component\n\nForge\n\n### Have you ensured that all of these are up to date?\n\n- [X] Foundry\n- [X] Foundryup\n\n### What version of Foundry are you on?\n\nforge 0.2.0 (c92dabc 2023-04-14T00:06:11.253773000Z)\n\n### What command(s) is the bug in?\n\n_No response_\n\n### Operating System\n\nNone\n\n### Describe the bug\n\nI am trying to reconcile gas cost obtained by wrapping function calls between `gasleft()` instructions and the gas cost given by forge using `-vvvv` option.\r\n\r\nHere is the contract I am using:\r\n```solidity\r\nimport \"forge-std/Test.sol\";\r\n\r\ncontract C {\r\n  uint public x = 10;\r\n  function setX(uint n) external {\r\n    x = n;\r\n  }\r\n}\r\n\r\ncontract GasTest is Test {\r\n  C c = new C();\r\n\r\n  function test_gasWrite0() public {\r\n    uint g = gasleft();\r\n    c.setX(0);\r\n    g -= gasleft();\r\n    console.log(g);\r\n  }\r\n\r\n  function test_gasWrite12() public {\r\n    uint g = gasleft();\r\n    c.setX(12);\r\n    g -= gasleft();\r\n    console.log(g);\r\n  }\r\n\r\n  function test_gasWrite10() public {\r\n    uint g = gasleft();\r\n    c.setX(10);\r\n    g -= gasleft();\r\n    console.log(g);\r\n  }\r\n}\r\n```\r\nLogs gives \r\n```\r\n[PASS] test_gasWrite0() (gas: 8483)\r\nLogs:\r\n  10203\r\n[PASS] test_gasWrite10() (gas: 10505)\r\nLogs:\r\n  7403\r\n[PASS] test_gasWrite12() (gas: 13228)\r\nLogs:\r\n  10192\r\n```\r\nwhereas trace shows:\r\n```\r\n[PASS] test_gasWrite0() (gas: 8483)\r\n...\r\n    ├─ [4170] C::setX(0) \r\n\r\n[PASS] test_gasWrite10() (gas: 10505)\r\n...\r\n    ├─ [2412] C::setX(10) \r\n\r\n[PASS] test_gasWrite12() (gas: 13228)\r\n...\r\n    ├─ [5212] C::setX(12) \r\n``` \r\nAm I misinterpreting the trace (doc says \"gas usage (marked in square brackets) is for the entirety of the function call\")? Also the gas cost of `gasWrite0` is less than the log but I assume this is because of gas refund from the evm?",
  "closed_by": {
    "login": "mds1",
    "id": 17163988,
    "node_id": "MDQ6VXNlcjE3MTYzOTg4",
    "avatar_url": "https://avatars.githubusercontent.com/u/17163988?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mds1",
    "html_url": "https://github.com/mds1",
    "followers_url": "https://api.github.com/users/mds1/followers",
    "following_url": "https://api.github.com/users/mds1/following{/other_user}",
    "gists_url": "https://api.github.com/users/mds1/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mds1/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mds1/subscriptions",
    "organizations_url": "https://api.github.com/users/mds1/orgs",
    "repos_url": "https://api.github.com/users/mds1/repos",
    "events_url": "https://api.github.com/users/mds1/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mds1/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/4740/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4740/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1508658809",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4740#issuecomment-1508658809",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4740",
    "id": 1508658809,
    "node_id": "IC_kwDOGBlvNc5Z7E55",
    "user": {
      "login": "mds1",
      "id": 17163988,
      "node_id": "MDQ6VXNlcjE3MTYzOTg4",
      "avatar_url": "https://avatars.githubusercontent.com/u/17163988?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mds1",
      "html_url": "https://github.com/mds1",
      "followers_url": "https://api.github.com/users/mds1/followers",
      "following_url": "https://api.github.com/users/mds1/following{/other_user}",
      "gists_url": "https://api.github.com/users/mds1/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mds1/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mds1/subscriptions",
      "organizations_url": "https://api.github.com/users/mds1/orgs",
      "repos_url": "https://api.github.com/users/mds1/repos",
      "events_url": "https://api.github.com/users/mds1/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mds1/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-14T14:31:52Z",
    "updated_at": "2023-04-14T14:31:52Z",
    "author_association": "COLLABORATOR",
    "body": "Seems you're interpreting it correctly. The full gas cost of the test in brackets includes function dispatch cost and gas refunds. The 21000 intrinsic gas cost and calldata costs are not included in that number. And yep when you write a value of zero to storage you get a storage refund which is why that one is cheaper. Going to close this, but feel free to keep asking any further questions you have!",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1508658809/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1509121642",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4740#issuecomment-1509121642",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4740",
    "id": 1509121642,
    "node_id": "IC_kwDOGBlvNc5Z815q",
    "user": {
      "login": "jkrivine",
      "id": 293262,
      "node_id": "MDQ6VXNlcjI5MzI2Mg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/293262?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jkrivine",
      "html_url": "https://github.com/jkrivine",
      "followers_url": "https://api.github.com/users/jkrivine/followers",
      "following_url": "https://api.github.com/users/jkrivine/following{/other_user}",
      "gists_url": "https://api.github.com/users/jkrivine/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jkrivine/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jkrivine/subscriptions",
      "organizations_url": "https://api.github.com/users/jkrivine/orgs",
      "repos_url": "https://api.github.com/users/jkrivine/repos",
      "events_url": "https://api.github.com/users/jkrivine/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jkrivine/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-14T19:29:47Z",
    "updated_at": "2023-04-14T19:30:36Z",
    "author_association": "NONE",
    "body": "Sorry I was not being clear, I am aware of the gas refund. My problem is not the gas refund. It is the difference between the logs and the square brackets values. \r\nFor instance  for `test_gasWrite10` the `gasleft()` around the function call yield a gas cost of 7403 and the square brackets in the trace show 2412. And you can observe the same differences in the other tests.\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1509121642/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1509135199",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4740#issuecomment-1509135199",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4740",
    "id": 1509135199,
    "node_id": "IC_kwDOGBlvNc5Z85Nf",
    "user": {
      "login": "mds1",
      "id": 17163988,
      "node_id": "MDQ6VXNlcjE3MTYzOTg4",
      "avatar_url": "https://avatars.githubusercontent.com/u/17163988?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mds1",
      "html_url": "https://github.com/mds1",
      "followers_url": "https://api.github.com/users/mds1/followers",
      "following_url": "https://api.github.com/users/mds1/following{/other_user}",
      "gists_url": "https://api.github.com/users/mds1/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mds1/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mds1/subscriptions",
      "organizations_url": "https://api.github.com/users/mds1/orgs",
      "repos_url": "https://api.github.com/users/mds1/repos",
      "events_url": "https://api.github.com/users/mds1/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mds1/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-14T19:42:36Z",
    "updated_at": "2023-04-14T19:43:18Z",
    "author_association": "COLLABORATOR",
    "body": "Ahh I see, sorry I misunderstood. I'm pretty sure the number in brackets of 2412 is strictly the cost of the execution within the new call's context, whereas the number you get in your logs of 7403 includes all the extra \"hidden\" code in your test contract's context, i.e. the code solidity generates to execute and verify the call. This includes things like ABI encoding the calldata, the CALL opcode itself, copying the return data to memory, verifying the size of the return data, etc. ",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1509135199/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
