{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/5471",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5471/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5471/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5471/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/5471",
  "id": 1820706325,
  "node_id": "I_kwDOGBlvNc5shcYV",
  "number": 5471,
  "title": "ChainID changes in tests if you fork in a constructor instead of setUp",
  "user": {
    "login": "vicnaum",
    "id": 5636644,
    "node_id": "MDQ6VXNlcjU2MzY2NDQ=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5636644?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/vicnaum",
    "html_url": "https://github.com/vicnaum",
    "followers_url": "https://api.github.com/users/vicnaum/followers",
    "following_url": "https://api.github.com/users/vicnaum/following{/other_user}",
    "gists_url": "https://api.github.com/users/vicnaum/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/vicnaum/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/vicnaum/subscriptions",
    "organizations_url": "https://api.github.com/users/vicnaum/orgs",
    "repos_url": "https://api.github.com/users/vicnaum/repos",
    "events_url": "https://api.github.com/users/vicnaum/events{/privacy}",
    "received_events_url": "https://api.github.com/users/vicnaum/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3334394228,
      "node_id": "MDU6TGFiZWwzMzM0Mzk0MjI4",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-bug",
      "name": "T-bug",
      "color": "d73a4a",
      "default": false,
      "description": "Type: bug"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "Evalir",
    "id": 26014927,
    "node_id": "MDQ6VXNlcjI2MDE0OTI3",
    "avatar_url": "https://avatars.githubusercontent.com/u/26014927?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Evalir",
    "html_url": "https://github.com/Evalir",
    "followers_url": "https://api.github.com/users/Evalir/followers",
    "following_url": "https://api.github.com/users/Evalir/following{/other_user}",
    "gists_url": "https://api.github.com/users/Evalir/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Evalir/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Evalir/subscriptions",
    "organizations_url": "https://api.github.com/users/Evalir/orgs",
    "repos_url": "https://api.github.com/users/Evalir/repos",
    "events_url": "https://api.github.com/users/Evalir/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Evalir/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "Evalir",
      "id": 26014927,
      "node_id": "MDQ6VXNlcjI2MDE0OTI3",
      "avatar_url": "https://avatars.githubusercontent.com/u/26014927?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Evalir",
      "html_url": "https://github.com/Evalir",
      "followers_url": "https://api.github.com/users/Evalir/followers",
      "following_url": "https://api.github.com/users/Evalir/following{/other_user}",
      "gists_url": "https://api.github.com/users/Evalir/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Evalir/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Evalir/subscriptions",
      "organizations_url": "https://api.github.com/users/Evalir/orgs",
      "repos_url": "https://api.github.com/users/Evalir/repos",
      "events_url": "https://api.github.com/users/Evalir/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Evalir/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/milestones/1",
    "html_url": "https://github.com/foundry-rs/foundry/milestone/1",
    "labels_url": "https://api.github.com/repos/foundry-rs/foundry/milestones/1/labels",
    "id": 8140456,
    "node_id": "MI_kwDOGBlvNc4AfDao",
    "number": 1,
    "title": "v1.0.0",
    "description": "",
    "creator": {
      "login": "onbjerg",
      "id": 8862627,
      "node_id": "MDQ6VXNlcjg4NjI2Mjc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8862627?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/onbjerg",
      "html_url": "https://github.com/onbjerg",
      "followers_url": "https://api.github.com/users/onbjerg/followers",
      "following_url": "https://api.github.com/users/onbjerg/following{/other_user}",
      "gists_url": "https://api.github.com/users/onbjerg/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/onbjerg/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/onbjerg/subscriptions",
      "organizations_url": "https://api.github.com/users/onbjerg/orgs",
      "repos_url": "https://api.github.com/users/onbjerg/repos",
      "events_url": "https://api.github.com/users/onbjerg/events{/privacy}",
      "received_events_url": "https://api.github.com/users/onbjerg/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 28,
    "closed_issues": 137,
    "state": "open",
    "created_at": "2022-06-28T08:15:32Z",
    "updated_at": "2023-07-31T14:02:14Z",
    "due_on": null,
    "closed_at": null
  },
  "comments": 4,
  "created_at": "2023-07-25T16:31:07Z",
  "updated_at": "2023-07-31T14:02:14Z",
  "closed_at": "2023-07-31T14:02:14Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Component\n\nForge\n\n### Have you ensured that all of these are up to date?\n\n- [X] Foundry\n- [X] Foundryup\n\n### What version of Foundry are you on?\n\nforge 0.2.0 (114e69d 2023-07-25T11:38:05.716355000Z)\n\n### What command(s) is the bug in?\n\nforge test\n\n### Operating System\n\nmacOS (Apple Silicon)\n\n### Describe the bug\n\n1. I'm forking during tests using the cheatcodes instead of the command-line parameter.\r\n2. I have a dedicated ForkManagement file that handles all the forking.\r\n3. My TestSetup (main test file which all others inherit from) inherits from ForkManagement.\r\n4. I'm using both `constructor` and `setUp` functions (maybe I shouldn't - cause that's where the bug comes from!)\r\n5. The forking is happening in the ForkManagement constructor\r\n6. It is still the same in the TestSetup constructor, but it suddenly becomes different in TestSetup.setUp (it becomes 31337 default one)\r\n7. If I move the forking from ForkManagement constructor into ForkManagement.setUp - then all is fine\r\n\r\nHere are example code snippets to reproduce:\r\n\r\n**ForkManagement.sol**\r\n```\r\n// SPDX-License-Identifier: MIT\r\npragma solidity ^0.8.13;\r\n\r\nimport 'forge-std/Script.sol';\r\n\r\ncontract ForkManagement is Script {\r\n    constructor() {\r\n        vm.createSelectFork(\"polygon\", 45504400);\r\n        console.log('Chain ID in ForkManagement: %s', block.chainid);\r\n    }\r\n\r\n    function setUp() public virtual {\r\n    //     vm.createSelectFork(\"polygon\", 45504400);\r\n    //     console.log('Chain ID in ForkManagement.setUp: %s', block.chainid);\r\n    }\r\n}\r\n```\r\n\r\n**TestSetup.sol**\r\n```\r\n// SPDX-License-Identifier: UNLICENSED\r\npragma solidity ^0.8.13;\r\n\r\nimport \"forge-std/Test.sol\";\r\nimport \"./ForkManagement.sol\";\r\n\r\ncontract TestSetup is Test, ForkManagement {\r\n    constructor() {\r\n        console.log(\"ChainId in TestSetup constructor: %s\", block.chainid);\r\n    }\r\n\r\n    function setUp() public virtual override {\r\n        super.setUp();\r\n        console.log(\"ChainId in TestSetup.setUp: %s\", block.chainid);\r\n    }\r\n\r\n    function testTest() public {\r\n        console.log(\"ChainId in TestSetup.testTest: %s\", block.chainid);\r\n    }\r\n}\r\n```\r\n\r\nYou also need to have this in your **foundry.toml**:\r\n```\r\n[rpc_endpoints]\r\npolygon = \"${POLYGON_RPC_URL}\"\r\n```\r\n\r\nAnd this in your **.env**:\r\n```\r\nexport POLYGON_RPC_URL=\"https://........... your rpc url here\"\r\n```\r\n\r\nOutput of the `forge t`:\r\n```\r\nLogs:\r\n  Chain ID in ForkManagement: 137\r\n  ChainId in TestSetup constructor: 137\r\n  ChainId in TestSetup.setUp: 31337\r\n  ChainId in TestSetup.testTest: 31337\r\n```\r\n\r\nExpected output:\r\n```\r\nLogs:\r\n  Chain ID in ForkManagement: 137\r\n  ChainId in TestSetup constructor: 137\r\n  ChainId in TestSetup.setUp: 137\r\n  ChainId in TestSetup.testTest: 137\r\n```\r\n\r\nOutput if I move the forking to ForkManagement setUp:\r\n```\r\nLogs:\r\n  ChainId in TestSetup constructor: 31337\r\n  Chain ID in ForkManagement.setUp: 137\r\n  ChainId in TestSetup.setUp: 137\r\n  ChainId in TestSetup.testTest: 137\r\n```",
  "closed_by": {
    "login": "Evalir",
    "id": 26014927,
    "node_id": "MDQ6VXNlcjI2MDE0OTI3",
    "avatar_url": "https://avatars.githubusercontent.com/u/26014927?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Evalir",
    "html_url": "https://github.com/Evalir",
    "followers_url": "https://api.github.com/users/Evalir/followers",
    "following_url": "https://api.github.com/users/Evalir/following{/other_user}",
    "gists_url": "https://api.github.com/users/Evalir/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Evalir/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Evalir/subscriptions",
    "organizations_url": "https://api.github.com/users/Evalir/orgs",
    "repos_url": "https://api.github.com/users/Evalir/repos",
    "events_url": "https://api.github.com/users/Evalir/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Evalir/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/5471/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5471/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1650178077",
    "html_url": "https://github.com/foundry-rs/foundry/issues/5471#issuecomment-1650178077",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5471",
    "id": 1650178077,
    "node_id": "IC_kwDOGBlvNc5iW7gd",
    "user": {
      "login": "Evalir",
      "id": 26014927,
      "node_id": "MDQ6VXNlcjI2MDE0OTI3",
      "avatar_url": "https://avatars.githubusercontent.com/u/26014927?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Evalir",
      "html_url": "https://github.com/Evalir",
      "followers_url": "https://api.github.com/users/Evalir/followers",
      "following_url": "https://api.github.com/users/Evalir/following{/other_user}",
      "gists_url": "https://api.github.com/users/Evalir/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Evalir/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Evalir/subscriptions",
      "organizations_url": "https://api.github.com/users/Evalir/orgs",
      "repos_url": "https://api.github.com/users/Evalir/repos",
      "events_url": "https://api.github.com/users/Evalir/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Evalir/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-25T16:40:24Z",
    "updated_at": "2023-07-25T16:40:24Z",
    "author_association": "MEMBER",
    "body": "Yep you should only use either the constructor or the `setUp` function! thanks for flagging this, we should probably disallow this cc @mds1 @mattsse ",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1650178077/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1650197000",
    "html_url": "https://github.com/foundry-rs/foundry/issues/5471#issuecomment-1650197000",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5471",
    "id": 1650197000,
    "node_id": "IC_kwDOGBlvNc5iXAII",
    "user": {
      "login": "mds1",
      "id": 17163988,
      "node_id": "MDQ6VXNlcjE3MTYzOTg4",
      "avatar_url": "https://avatars.githubusercontent.com/u/17163988?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mds1",
      "html_url": "https://github.com/mds1",
      "followers_url": "https://api.github.com/users/mds1/followers",
      "following_url": "https://api.github.com/users/mds1/following{/other_user}",
      "gists_url": "https://api.github.com/users/mds1/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mds1/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mds1/subscriptions",
      "organizations_url": "https://api.github.com/users/mds1/orgs",
      "repos_url": "https://api.github.com/users/mds1/repos",
      "events_url": "https://api.github.com/users/mds1/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mds1/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-25T16:54:02Z",
    "updated_at": "2023-07-25T16:54:02Z",
    "author_association": "COLLABORATOR",
    "body": "> Yep you should only use either the constructor or the `setUp` function\r\n\r\nWhat's the status of constructor support? Long term we've discussed deprecating `setUp` in favor of constructors, but I'm not clear on whether only using constructor is equally well supported",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1650197000/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1650456497",
    "html_url": "https://github.com/foundry-rs/foundry/issues/5471#issuecomment-1650456497",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5471",
    "id": 1650456497,
    "node_id": "IC_kwDOGBlvNc5iX_ex",
    "user": {
      "login": "Evalir",
      "id": 26014927,
      "node_id": "MDQ6VXNlcjI2MDE0OTI3",
      "avatar_url": "https://avatars.githubusercontent.com/u/26014927?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Evalir",
      "html_url": "https://github.com/Evalir",
      "followers_url": "https://api.github.com/users/Evalir/followers",
      "following_url": "https://api.github.com/users/Evalir/following{/other_user}",
      "gists_url": "https://api.github.com/users/Evalir/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Evalir/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Evalir/subscriptions",
      "organizations_url": "https://api.github.com/users/Evalir/orgs",
      "repos_url": "https://api.github.com/users/Evalir/repos",
      "events_url": "https://api.github.com/users/Evalir/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Evalir/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-25T19:57:13Z",
    "updated_at": "2023-07-25T19:57:13Z",
    "author_association": "MEMBER",
    "body": "Yeah I think constructors aren't really there yet in terms of full support like `setUp` as we do some special stuff with the setup function which i think it's not replicated properly yet on the constructor. That being said, i def think we should at least warn users that using both constructor and setUp is prob not a good idea",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1650456497/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1658435457",
    "html_url": "https://github.com/foundry-rs/foundry/issues/5471#issuecomment-1658435457",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/5471",
    "id": 1658435457,
    "node_id": "IC_kwDOGBlvNc5i2beB",
    "user": {
      "login": "Evalir",
      "id": 26014927,
      "node_id": "MDQ6VXNlcjI2MDE0OTI3",
      "avatar_url": "https://avatars.githubusercontent.com/u/26014927?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Evalir",
      "html_url": "https://github.com/Evalir",
      "followers_url": "https://api.github.com/users/Evalir/followers",
      "following_url": "https://api.github.com/users/Evalir/following{/other_user}",
      "gists_url": "https://api.github.com/users/Evalir/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Evalir/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Evalir/subscriptions",
      "organizations_url": "https://api.github.com/users/Evalir/orgs",
      "repos_url": "https://api.github.com/users/Evalir/repos",
      "events_url": "https://api.github.com/users/Evalir/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Evalir/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-07-31T14:02:14Z",
    "updated_at": "2023-07-31T14:02:14Z",
    "author_association": "MEMBER",
    "body": "Closingâ€”will add to the book that advice is to not mix both constructors and `setUp` functions.",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1658435457/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
