{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/4728",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4728/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4728/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4728/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/4728",
  "id": 1665038937,
  "node_id": "I_kwDOGBlvNc5jPnpZ",
  "number": 4728,
  "title": "Forge test hangs forever ",
  "user": {
    "login": "jdbertron",
    "id": 1455998,
    "node_id": "MDQ6VXNlcjE0NTU5OTg=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1455998?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jdbertron",
    "html_url": "https://github.com/jdbertron",
    "followers_url": "https://api.github.com/users/jdbertron/followers",
    "following_url": "https://api.github.com/users/jdbertron/following{/other_user}",
    "gists_url": "https://api.github.com/users/jdbertron/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jdbertron/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jdbertron/subscriptions",
    "organizations_url": "https://api.github.com/users/jdbertron/orgs",
    "repos_url": "https://api.github.com/users/jdbertron/repos",
    "events_url": "https://api.github.com/users/jdbertron/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jdbertron/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3334394228,
      "node_id": "MDU6TGFiZWwzMzM0Mzk0MjI4",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-bug",
      "name": "T-bug",
      "color": "d73a4a",
      "default": false,
      "description": "Type: bug"
    },
    {
      "id": 3593644915,
      "node_id": "LA_kwDOGBlvNc7WMqtz",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/Cmd-forge-test",
      "name": "Cmd-forge-test",
      "color": "006B75",
      "default": false,
      "description": "Command: forge test"
    },
    {
      "id": 3703752787,
      "node_id": "LA_kwDOGBlvNc7cwshT",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/C-forge",
      "name": "C-forge",
      "color": "5319E7",
      "default": false,
      "description": "Command: forge"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 6,
  "created_at": "2023-04-12T18:23:44Z",
  "updated_at": "2023-04-28T15:32:57Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Component\n\nForge\n\n### Have you ensured that all of these are up to date?\n\n- [X] Foundry\n- [X] Foundryup\n\n### What version of Foundry are you on?\n\nforge 0.2.0 (388c3c0 2023-04-12T03:09:53.984763822Z)\n\n### What command(s) is the bug in?\n\nforge test --ffi \n\n### Operating System\n\nLinux\n\n### Describe the bug\n\nI have a diamond contract that has multiple facets. The high level description is that one facet lets a user publish a series of puzzles, keyed by hashes and tracked by owner. One facet lets anyone query the puzzles. \r\nI can retrieve all but the first puzzle. Attempting to retrieve any other hangs the test. \r\nI have a separate issue in which the EVM runs out of gas calling a separate method (see bottom of https://github.com/foundry-rs/foundry/issues/3971)  .  I have looked at expanding the gas and memory limits, but none seem to have an impact. \r\nThe code works fine on Goerli. \r\n\r\nYou can check out the test here https://github.com/BqETH/solidity/commit/4ecf04021a11736d6f956c51cc18bea99d0cd3e4  and run \r\n`forge test --ffi -vvvv -m \"testCanRegisterPuzzle\"`\r\n\r\nto make it hang. \r\nIf I try the debugger, it also hangs and never gives me the debugger screen. \r\nI'm not sure what else I can do.",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/4728/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4728/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1506146140",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4728#issuecomment-1506146140",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4728",
    "id": 1506146140,
    "node_id": "IC_kwDOGBlvNc5Zxfdc",
    "user": {
      "login": "brockelmore",
      "id": 31553173,
      "node_id": "MDQ6VXNlcjMxNTUzMTcz",
      "avatar_url": "https://avatars.githubusercontent.com/u/31553173?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/brockelmore",
      "html_url": "https://github.com/brockelmore",
      "followers_url": "https://api.github.com/users/brockelmore/followers",
      "following_url": "https://api.github.com/users/brockelmore/following{/other_user}",
      "gists_url": "https://api.github.com/users/brockelmore/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/brockelmore/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/brockelmore/subscriptions",
      "organizations_url": "https://api.github.com/users/brockelmore/orgs",
      "repos_url": "https://api.github.com/users/brockelmore/repos",
      "events_url": "https://api.github.com/users/brockelmore/events{/privacy}",
      "received_events_url": "https://api.github.com/users/brockelmore/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-13T00:38:41Z",
    "updated_at": "2023-04-13T00:38:41Z",
    "author_association": "MEMBER",
    "body": "Strangely if you run this command with `RUST_LOG=forge` it fails\r\n![Screen Shot 2023-04-12 at 5 38 26 PM](https://user-images.githubusercontent.com/31553173/231615793-d9c88bb7-7abf-4eee-924c-ba394df1ddd2.png)\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1506146140/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1507460966",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4728#issuecomment-1507460966",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4728",
    "id": 1507460966,
    "node_id": "IC_kwDOGBlvNc5Z2gdm",
    "user": {
      "login": "jdbertron",
      "id": 1455998,
      "node_id": "MDQ6VXNlcjE0NTU5OTg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1455998?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jdbertron",
      "html_url": "https://github.com/jdbertron",
      "followers_url": "https://api.github.com/users/jdbertron/followers",
      "following_url": "https://api.github.com/users/jdbertron/following{/other_user}",
      "gists_url": "https://api.github.com/users/jdbertron/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jdbertron/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jdbertron/subscriptions",
      "organizations_url": "https://api.github.com/users/jdbertron/orgs",
      "repos_url": "https://api.github.com/users/jdbertron/repos",
      "events_url": "https://api.github.com/users/jdbertron/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jdbertron/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-13T18:50:49Z",
    "updated_at": "2023-04-13T18:50:49Z",
    "author_association": "NONE",
    "body": "Interesting. So that's equivalent to -vvvvv  and I get the same error. Thanks for pointing that out. \r\nI'll research why that might be. Presumably a revert during setup should prevent the tests from attempting to run, that should be a fail-fast regarding of the logging level.",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1507460966/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1507498612",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4728#issuecomment-1507498612",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4728",
    "id": 1507498612,
    "node_id": "IC_kwDOGBlvNc5Z2pp0",
    "user": {
      "login": "cdgmachado0",
      "id": 59457858,
      "node_id": "MDQ6VXNlcjU5NDU3ODU4",
      "avatar_url": "https://avatars.githubusercontent.com/u/59457858?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cdgmachado0",
      "html_url": "https://github.com/cdgmachado0",
      "followers_url": "https://api.github.com/users/cdgmachado0/followers",
      "following_url": "https://api.github.com/users/cdgmachado0/following{/other_user}",
      "gists_url": "https://api.github.com/users/cdgmachado0/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cdgmachado0/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cdgmachado0/subscriptions",
      "organizations_url": "https://api.github.com/users/cdgmachado0/orgs",
      "repos_url": "https://api.github.com/users/cdgmachado0/repos",
      "events_url": "https://api.github.com/users/cdgmachado0/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cdgmachado0/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-13T19:24:56Z",
    "updated_at": "2023-04-13T19:24:56Z",
    "author_association": "NONE",
    "body": "I have two open issues where `forge test` hangs, and I'm also using a Diamond: #4656 and #4735.\r\n\r\nIn case you want to have a look. ",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1507498612/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1507604278",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4728#issuecomment-1507604278",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4728",
    "id": 1507604278,
    "node_id": "IC_kwDOGBlvNc5Z3Dc2",
    "user": {
      "login": "jdbertron",
      "id": 1455998,
      "node_id": "MDQ6VXNlcjE0NTU5OTg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1455998?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jdbertron",
      "html_url": "https://github.com/jdbertron",
      "followers_url": "https://api.github.com/users/jdbertron/followers",
      "following_url": "https://api.github.com/users/jdbertron/following{/other_user}",
      "gists_url": "https://api.github.com/users/jdbertron/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jdbertron/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jdbertron/subscriptions",
      "organizations_url": "https://api.github.com/users/jdbertron/orgs",
      "repos_url": "https://api.github.com/users/jdbertron/repos",
      "events_url": "https://api.github.com/users/jdbertron/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jdbertron/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-13T21:00:52Z",
    "updated_at": "2023-04-13T21:00:52Z",
    "author_association": "NONE",
    "body": "Lol. Ok, that's not really the source of the bug. \r\nThe RUST_LOG=forge environment gets passed on to the \"forge inspect facet methods\" invocation within the HelperContract that tries to extract method selectors for adding them to the diamond. So instead of getting a nice list of method:selector it gets a blob from the contract artifact and all the parsing gets out of whack, causing that error. \r\n",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1507604278/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1507718540",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4728#issuecomment-1507718540",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4728",
    "id": 1507718540,
    "node_id": "IC_kwDOGBlvNc5Z3fWM",
    "user": {
      "login": "jdbertron",
      "id": 1455998,
      "node_id": "MDQ6VXNlcjE0NTU5OTg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1455998?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jdbertron",
      "html_url": "https://github.com/jdbertron",
      "followers_url": "https://api.github.com/users/jdbertron/followers",
      "following_url": "https://api.github.com/users/jdbertron/following{/other_user}",
      "gists_url": "https://api.github.com/users/jdbertron/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jdbertron/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jdbertron/subscriptions",
      "organizations_url": "https://api.github.com/users/jdbertron/orgs",
      "repos_url": "https://api.github.com/users/jdbertron/repos",
      "events_url": "https://api.github.com/users/jdbertron/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jdbertron/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-13T23:12:45Z",
    "updated_at": "2023-04-16T15:52:42Z",
    "author_association": "NONE",
    "body": "Ok, the problem you found was just caused by the RUST_LOG setting. \r\nI fixed that problem in the Diamond deployment code.  See this: https://github.com/FydeTreasury/Diamond-Foundry/pull/6/commits/755144352b20f9ad9c84e22feb8fe3d6646e9f39 \r\nYou can check out the lasted commit https://github.com/BqETH/solidity  or \r\njust change the HelperContract:generateSelectors method to this:\r\n`    \r\n// return array of function selectors for given facet name\r\n    function generateSelectors(string memory _facetName)\r\n    internal\r\n    returns (bytes4[] memory selectors)\r\n    {\r\n        //get string of contract methods\r\n        string[] memory cmd = new string[](4);\r\n        cmd[0] = \"forge\";\r\n        cmd[1] = \"inspect\";\r\n        cmd[2] = _facetName;\r\n        cmd[3] = \"methods\";\r\n        bytes memory res = vm.ffi(cmd);\r\n        string memory st = string(res);\r\n\r\n        // extract function signatures and take first 4 bytes of keccak\r\n        strings.slice memory s = st.toSlice();\r\n\r\n        // Skip TRACE lines if any\r\n        strings.slice memory nl = '\\n'.toSlice();\r\n        strings.slice memory trace = 'TRACE'.toSlice();\r\n        while (s.contains(trace) ) {\r\n            s.split(nl);\r\n        }\r\n\r\n        strings.slice memory colon = \":\".toSlice();\r\n        strings.slice memory comma = \",\".toSlice();\r\n        strings.slice memory dbquote = '\"'.toSlice();\r\n        selectors = new bytes4[]((s.count(colon)));\r\n\r\n        for(uint i = 0; i < selectors.length; i++) {\r\n            s.split(dbquote);   // advance to next doublequote\r\n            // split at colon, extract string up to next doublequote for methodname\r\n            strings.slice memory method = s.split(colon).until(dbquote);\r\n            selectors[i] = bytes4(method.keccak());\r\n            strings.slice memory selectr = s.split(comma).until(dbquote);     // advance s to the next comma\r\n        }\r\n        return selectors;\r\n    }\r\n`\r\n\r\nThe results have not changed. The hanging bug still hangs and the OutOfGas error still happens too.  \r\nThe RUST_LOG=forge added nothing useful in the TRACE.",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1507718540/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 1,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1527741148",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4728#issuecomment-1527741148",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4728",
    "id": 1527741148,
    "node_id": "IC_kwDOGBlvNc5bD3rc",
    "user": {
      "login": "jdbertron",
      "id": 1455998,
      "node_id": "MDQ6VXNlcjE0NTU5OTg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1455998?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jdbertron",
      "html_url": "https://github.com/jdbertron",
      "followers_url": "https://api.github.com/users/jdbertron/followers",
      "following_url": "https://api.github.com/users/jdbertron/following{/other_user}",
      "gists_url": "https://api.github.com/users/jdbertron/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jdbertron/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jdbertron/subscriptions",
      "organizations_url": "https://api.github.com/users/jdbertron/orgs",
      "repos_url": "https://api.github.com/users/jdbertron/repos",
      "events_url": "https://api.github.com/users/jdbertron/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jdbertron/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-28T15:32:57Z",
    "updated_at": "2023-04-28T15:32:57Z",
    "author_association": "NONE",
    "body": "Can someone look at this please ?  My pull request to the Diamond Foundry project has been merged. https://github.com/FydeTreasury/Diamond-Foundry/pull/6   The problem still persists. ",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1527741148/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
