{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/6503",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/6503/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/6503/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/6503/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/6503",
  "id": 2022145429,
  "node_id": "I_kwDOGBlvNc54h32V",
  "number": 6503,
  "title": "Incorrect gas price: Estimated gas price: 3.2 gwei",
  "user": {
    "login": "JMariadlcs",
    "id": 74883388,
    "node_id": "MDQ6VXNlcjc0ODgzMzg4",
    "avatar_url": "https://avatars.githubusercontent.com/u/74883388?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/JMariadlcs",
    "html_url": "https://github.com/JMariadlcs",
    "followers_url": "https://api.github.com/users/JMariadlcs/followers",
    "following_url": "https://api.github.com/users/JMariadlcs/following{/other_user}",
    "gists_url": "https://api.github.com/users/JMariadlcs/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/JMariadlcs/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/JMariadlcs/subscriptions",
    "organizations_url": "https://api.github.com/users/JMariadlcs/orgs",
    "repos_url": "https://api.github.com/users/JMariadlcs/repos",
    "events_url": "https://api.github.com/users/JMariadlcs/events{/privacy}",
    "received_events_url": "https://api.github.com/users/JMariadlcs/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3334394228,
      "node_id": "MDU6TGFiZWwzMzM0Mzk0MjI4",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-bug",
      "name": "T-bug",
      "color": "d73a4a",
      "default": false,
      "description": "Type: bug"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2023-12-02T17:55:21Z",
  "updated_at": "2023-12-04T00:07:31Z",
  "closed_at": "2023-12-02T18:49:25Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Component\n\nForge\n\n### Have you ensured that all of these are up to date?\n\n- [X] Foundry\n- [X] Foundryup\n\n### What version of Foundry are you on?\n\n_No response_\n\n### What command(s) is the bug in?\n\n_No response_\n\n### Operating System\n\nNone\n\n### Describe the bug\n\nI am trying to deploy a simple contract on Arbitrum using foundry but gas price is incorrectly calculated.\r\n\r\n```bash\r\nChain 42161\r\n\r\nEstimated gas price: 3.2 gwei\r\n\r\nEstimated total gas used for script: 21628032\r\n\r\nEstimated amount required: 0.0692097024 ETH\r\n```",
  "closed_by": {
    "login": "Evalir",
    "id": 26014927,
    "node_id": "MDQ6VXNlcjI2MDE0OTI3",
    "avatar_url": "https://avatars.githubusercontent.com/u/26014927?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Evalir",
    "html_url": "https://github.com/Evalir",
    "followers_url": "https://api.github.com/users/Evalir/followers",
    "following_url": "https://api.github.com/users/Evalir/following{/other_user}",
    "gists_url": "https://api.github.com/users/Evalir/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Evalir/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Evalir/subscriptions",
    "organizations_url": "https://api.github.com/users/Evalir/orgs",
    "repos_url": "https://api.github.com/users/Evalir/repos",
    "events_url": "https://api.github.com/users/Evalir/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Evalir/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/6503/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/6503/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1837227045",
    "html_url": "https://github.com/foundry-rs/foundry/issues/6503#issuecomment-1837227045",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/6503",
    "id": 1837227045,
    "node_id": "IC_kwDOGBlvNc5tgdwl",
    "user": {
      "login": "Evalir",
      "id": 26014927,
      "node_id": "MDQ6VXNlcjI2MDE0OTI3",
      "avatar_url": "https://avatars.githubusercontent.com/u/26014927?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Evalir",
      "html_url": "https://github.com/Evalir",
      "followers_url": "https://api.github.com/users/Evalir/followers",
      "following_url": "https://api.github.com/users/Evalir/following{/other_user}",
      "gists_url": "https://api.github.com/users/Evalir/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Evalir/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Evalir/subscriptions",
      "organizations_url": "https://api.github.com/users/Evalir/orgs",
      "repos_url": "https://api.github.com/users/Evalir/repos",
      "events_url": "https://api.github.com/users/Evalir/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Evalir/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-12-02T18:49:25Z",
    "updated_at": "2023-12-02T18:49:25Z",
    "author_association": "MEMBER",
    "body": "This is a duplicate of many gas estimation issues—We cannot accurately estimate gas for L2s at this point in time. Will close to avoid duplicates—sorry!",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1837227045/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1837648597",
    "html_url": "https://github.com/foundry-rs/foundry/issues/6503#issuecomment-1837648597",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/6503",
    "id": 1837648597,
    "node_id": "IC_kwDOGBlvNc5tiErV",
    "user": {
      "login": "klkvr",
      "id": 62447812,
      "node_id": "MDQ6VXNlcjYyNDQ3ODEy",
      "avatar_url": "https://avatars.githubusercontent.com/u/62447812?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/klkvr",
      "html_url": "https://github.com/klkvr",
      "followers_url": "https://api.github.com/users/klkvr/followers",
      "following_url": "https://api.github.com/users/klkvr/following{/other_user}",
      "gists_url": "https://api.github.com/users/klkvr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/klkvr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/klkvr/subscriptions",
      "organizations_url": "https://api.github.com/users/klkvr/orgs",
      "repos_url": "https://api.github.com/users/klkvr/repos",
      "events_url": "https://api.github.com/users/klkvr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/klkvr/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-12-04T00:03:49Z",
    "updated_at": "2023-12-04T00:07:31Z",
    "author_association": "CONTRIBUTOR",
    "body": "Hey @Evalir I believe that the problem here is not L2 semantics but just incorrect priority fee estimation.\r\n\r\nGas estimation may be difficult for L2s with unusual semantics like Optimism. However, currently, gas is estimated incorrectly for all chains where gas prices are just low. For example, for script running on Arbitrum, gas prices will always be estimated as ~3.2 gwei. However, actual gas price required is usually around 0.1 gwei.\r\n\r\nThis happens because gas estimations are done by using default ethers-rs eip1159 estimator. https://github.com/foundry-rs/foundry/blob/d4e6b43ea694f31ef2915e75d81c3308479ef8fd/crates/common/src/provider.rs#L280-L290\r\n\r\nHere, on line 289, method `estimate_eip1559_fees` is called. Source code for it can be found [here](https://github.com/gakonst/ethers-rs/blob/master/ethers-providers/src/rpc/provider.rs#L437). When `None` is provided as estimator, it fallbacks to `ethers_core::utils::eip1559_default_estimator`\r\n\r\nThe code for default estimator can be found [here](https://github.com/gakonst/ethers-rs/blob/f0e5b194f09c533feb10d1a686ddb9e5946ec107/ethers-core/src/utils/mod.rs#L500).\r\n\r\nThe problem lies in this snippet:\r\n```rust\r\n  let max_priority_fee_per_gas =\r\n      if base_fee_per_gas < U256::from(EIP1559_FEE_ESTIMATION_PRIORITY_FEE_TRIGGER) {\r\n          U256::from(EIP1559_FEE_ESTIMATION_DEFAULT_PRIORITY_FEE)\r\n      } else {\r\n          std::cmp::max(\r\n              estimate_priority_fee(rewards),\r\n              U256::from(EIP1559_FEE_ESTIMATION_DEFAULT_PRIORITY_FEE),\r\n          )\r\n      };\r\n```\r\n\r\n`EIP1559_FEE_ESTIMATION_PRIORITY_FEE_TRIGGER` is 100 gwei and `EIP1559_FEE_ESTIMATION_DEFAULT_PRIORITY_FEE` is 3 gwei.\r\n\r\nSo, basically, if base fee per gas is less than 100 gwei, the priority fee will be set to 3 gwei. This may be fine for Ethereum, but it is incorrect for chains with base gas price always being below 1 gwei (or even below 0.0000001 gwei on Base).\r\n\r\nI think that replacing default estimator with some custom more flexible solution can help here.\r\n\r\n\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1837648597/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
