{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/4756",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4756/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4756/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4756/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/4756",
  "id": 1671988806,
  "node_id": "I_kwDOGBlvNc5jqIZG",
  "number": 4756,
  "title": "Anvill not returning receipt after a transaction deploy attempt",
  "user": {
    "login": "dalmoveras",
    "id": 125914597,
    "node_id": "U_kgDOB4FN5Q",
    "avatar_url": "https://avatars.githubusercontent.com/u/125914597?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/dalmoveras",
    "html_url": "https://github.com/dalmoveras",
    "followers_url": "https://api.github.com/users/dalmoveras/followers",
    "following_url": "https://api.github.com/users/dalmoveras/following{/other_user}",
    "gists_url": "https://api.github.com/users/dalmoveras/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/dalmoveras/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/dalmoveras/subscriptions",
    "organizations_url": "https://api.github.com/users/dalmoveras/orgs",
    "repos_url": "https://api.github.com/users/dalmoveras/repos",
    "events_url": "https://api.github.com/users/dalmoveras/events{/privacy}",
    "received_events_url": "https://api.github.com/users/dalmoveras/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3334394228,
      "node_id": "MDU6TGFiZWwzMzM0Mzk0MjI4",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-bug",
      "name": "T-bug",
      "color": "d73a4a",
      "default": false,
      "description": "Type: bug"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2023-04-17T21:23:09Z",
  "updated_at": "2023-04-21T01:05:49Z",
  "closed_at": "2023-04-21T01:05:48Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Component\n\nAnvil\n\n### Have you ensured that all of these are up to date?\n\n- [X] Foundry\n- [X] Foundryup\n\n### What version of Foundry are you on?\n\nforge 0.2.0 (04ce078 2023-04-17T00:04:24.659541705Z)\n\n### What command(s) is the bug in?\n\nanvil --chain-id 1 --port 8555\n\n### Operating System\n\nLinux\n\n### Describe the bug\n\nI'm trying to deploy a transaction in a local env (anvil:8555), using python as follows:\r\n```python\r\n\r\nBASE_FEE = 1000000000\r\n\r\ndef local_deploy(\r\n    main_url: str,\r\n    backup_url: str,\r\n    frontrunner_private_key: str,\r\n    chain_id: int,\r\n    input_data: str,\r\n    nonce: int,\r\n    value: int,\r\n    to_address: str = None,\r\n    gas_multiplier: int = 2,\r\n    gas: Optional[int] = None,\r\n    gas_price: Optional[float] = None,\r\n    max_fee_per_gas: Optional[float] = BASE_FEE,\r\n    max_priority_fee_per_gas: Optional[float] = 42,\r\n) -> Any:\r\n    (gas_price, max_fee_per_gas, max_priority_fee_per_gas,) = prepare_transaction(\r\n            chain_id,\r\n            gas_multiplier,\r\n            gas_price,\r\n            max_fee_per_gas,\r\n            max_priority_fee_per_gas,\r\n            )\r\n\r\n    return deploy_transaction_on_chain(\r\n        main_url,\r\n        backup_url,\r\n        frontrunner_private_key,\r\n        chain_id,\r\n        to_address,\r\n        input_data,\r\n        value,\r\n        nonce,\r\n        gas,\r\n        gas_price,\r\n        max_fee_per_gas,\r\n        max_priority_fee_per_gas,\r\n    )\r\n```\r\nThe `deploy_transaction_on_chain` will calculate the gas fees and prepare the data to be sent to my anvil instance.\r\n\r\nThe above code generates the following transaction details:\r\n```\r\n{\r\n'to': None, \r\n'value': 0, \r\n'data': '0x', \r\n'chainId': 1, \r\n'nonce': 1, \r\n'gas': 53343, \r\n'maxFeePerGas': 2000000000, \r\n'maxPriorityFeePerGas': 84\r\n}\r\n\r\n```\r\n\r\nAnd the output provided by Anvil is:\r\n```\r\nDeploying Anvil instance on port 8555...\r\n\r\n\r\n                             _   _\r\n                            (_) | |\r\n      __ _   _ __   __   __  _  | |\r\n     / _` | | '_ \\  \\ \\ / / | | | |\r\n    | (_| | | | | |  \\ V /  | | | |\r\n     \\__,_| |_| |_|   \\_/   |_| |_|\r\n\r\n    0.1.0 (04ce078 2023-04-17T00:05:48.271694591Z)\r\n    https://github.com/foundry-rs/foundry\r\n\r\nAvailable Accounts\r\n==================\r\n\r\n(0) \"0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266\" (10000 ETH)\r\n(1) \"0x70997970C51812dc3A010C7d01b50e0d17dc79C8\" (10000 ETH)\r\n(2) \"0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC\" (10000 ETH)\r\n(3) \"0x90F79bf6EB2c4f870365E785982E1f101E93b906\" (10000 ETH)\r\n(4) \"0x15d34AAf54267DB7D7c367839AAf71A00a2C6A65\" (10000 ETH)\r\n(5) \"0x9965507D1a55bcC2695C58ba16FB37d819B0A4dc\" (10000 ETH)\r\n(6) \"0x976EA74026E726554dB657fA54763abd0C3a0aa9\" (10000 ETH)\r\n(7) \"0x14dC79964da2C08b23698B3D3cc7Ca32193d9955\" (10000 ETH)\r\n(8) \"0x23618e81E3f5cdF7f54C3d65f7FBc0aBf5B21E8f\" (10000 ETH)\r\n(9) \"0xa0Ee7A142d267C1f36714E4a8F75612F20a79720\" (10000 ETH)\r\n\r\nPrivate Keys\r\n==================\r\n\r\n(0) 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80\r\n(1) 0x59c6995e998f97a5a0044966f0945389dc9e86dae88c7a8412f4603b6b78690d\r\n(2) 0x5de4111afa1a4b94908f83103eb1f1706367c2e68ca870fc3fb9a804cdab365a\r\n(3) 0x7c852118294e51e653712a81e05800f419141751be58f605c371e15141b007a6\r\n(4) 0x47e179ec197488593b187f80a00eb0da91f1b9d0b13f8733639f19c30a34926a\r\n(5) 0x8b3a350cf5c34c9194ca85829a2df0ec3153be0318b5e2d3348e872092edffba\r\n(6) 0x92db14e403b83dfe3df233f83dfa3a0d7096f21ca9b0d6d6b8d88b2b4ec1564e\r\n(7) 0x4bbbf85ce3377467afe5d46f804f221813b2bb87f24d81f60f1fcdbf7cbf4356\r\n(8) 0xdbda1821b80551c9d65939329250298aa3472ba22feea921c0cf5d620ea67b97\r\n(9) 0x2a871d0798f97d79848a013d4936a73bf4cc922c825d33c1cf7073dff6d409c6\r\n\r\nWallet\r\n==================\r\nMnemonic:          test test test test test test test test test test test junk\r\nDerivation path:   m/44'/60'/0'/0/\r\n\r\n\r\nBase Fee\r\n==================\r\n\r\n1000000000\r\n\r\nGas Limit\r\n==================\r\n\r\n30000000\r\n\r\nGenesis Timestamp\r\n==================\r\n\r\n1681765192\r\n\r\nListening on 127.0.0.1:8555\r\neth_chainId\r\neth_estimateGas\r\neth_sendRawTransaction\r\neth_getTransactionReceipt\r\neth_getTransactionReceipt\r\neth_getTransactionReceipt\r\neth_getTransactionReceipt\r\neth_getTransactionReceipt\r\neth_getTransactionReceipt\r\neth_getTransactionReceipt\r\neth_getTransactionReceipt\r\neth_getTransactionReceipt\r\neth_getTransactionReceipt\r\neth_getTransactionReceipt\r\neth_getTransactionReceipt\r\neth_getTransactionReceipt\r\neth_getTransactionReceipt\r\neth_getTransactionReceipt\r\neth_getTransactionReceipt\r\neth_getTransactionReceipt\r\neth_getTransactionReceipt\r\neth_getTransactionReceipt\r\neth_getTransactionReceipt\r\neth_getTransactionReceipt\r\neth_getTransactionReceipt\r\neth_getTransactionReceipt\r\neth_getTransactionReceipt\r\neth_getTransactionReceipt\r\neth_getTransactionReceipt\r\neth_getTransactionReceipt\r\neth_getTransactionReceipt\r\neth_getTransactionReceipt\r\n[... continues forever]\r\n```\r\n\r\nWith that, my code ends up throwing an exception (related to a timeout that I've set):\r\n```\r\nweb3._utils.threads.Timeout: 120 seconds\r\n\r\nDuring handling of the above exception, another exception occurred:\r\nFile \"../lib/python3.10/site-packages/web3/eth/eth.py\", line 477, in wait_for_transaction_receipt\r\n    raise TimeExhausted(\r\nweb3.exceptions.TimeExhausted: Transaction HexBytes('0x964eb1aadda93cc8a9b6f8fda307c000f0075399eceea80b01ff0998b1256ff7') is not in the chain after 120 seconds\r\n\r\n```\r\n and if  I decided  re-run the program (with the exact same params and without restart anvil)  I got the following:\r\n``` \r\nraise ValueError(response[\"error\"])\r\nValueError: {'code': -32003, 'message': 'transaction already imported'}\r\n\r\n``` \r\n\r\nI've tested the above code against a Quicknode API and I was able to get the results without any problem.\r\nAny clues about what's going on?\r\n\r\nThanks!!",
  "closed_by": {
    "login": "dalmoveras",
    "id": 125914597,
    "node_id": "U_kgDOB4FN5Q",
    "avatar_url": "https://avatars.githubusercontent.com/u/125914597?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/dalmoveras",
    "html_url": "https://github.com/dalmoveras",
    "followers_url": "https://api.github.com/users/dalmoveras/followers",
    "following_url": "https://api.github.com/users/dalmoveras/following{/other_user}",
    "gists_url": "https://api.github.com/users/dalmoveras/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/dalmoveras/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/dalmoveras/subscriptions",
    "organizations_url": "https://api.github.com/users/dalmoveras/orgs",
    "repos_url": "https://api.github.com/users/dalmoveras/repos",
    "events_url": "https://api.github.com/users/dalmoveras/events{/privacy}",
    "received_events_url": "https://api.github.com/users/dalmoveras/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/4756/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4756/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1512184851",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4756#issuecomment-1512184851",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4756",
    "id": 1512184851,
    "node_id": "IC_kwDOGBlvNc5aIhwT",
    "user": {
      "login": "mattsse",
      "id": 19890894,
      "node_id": "MDQ6VXNlcjE5ODkwODk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/19890894?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mattsse",
      "html_url": "https://github.com/mattsse",
      "followers_url": "https://api.github.com/users/mattsse/followers",
      "following_url": "https://api.github.com/users/mattsse/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattsse/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mattsse/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattsse/subscriptions",
      "organizations_url": "https://api.github.com/users/mattsse/orgs",
      "repos_url": "https://api.github.com/users/mattsse/repos",
      "events_url": "https://api.github.com/users/mattsse/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mattsse/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-17T22:46:52Z",
    "updated_at": "2023-04-17T22:46:52Z",
    "author_association": "MEMBER",
    "body": "what's the transaction count of your sender? (eth_getTransactionCount)\r\n\r\nshould be 0 but you send with 1",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1512184851/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1517114659",
    "html_url": "https://github.com/foundry-rs/foundry/issues/4756#issuecomment-1517114659",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/4756",
    "id": 1517114659,
    "node_id": "IC_kwDOGBlvNc5abVUj",
    "user": {
      "login": "dalmoveras",
      "id": 125914597,
      "node_id": "U_kgDOB4FN5Q",
      "avatar_url": "https://avatars.githubusercontent.com/u/125914597?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dalmoveras",
      "html_url": "https://github.com/dalmoveras",
      "followers_url": "https://api.github.com/users/dalmoveras/followers",
      "following_url": "https://api.github.com/users/dalmoveras/following{/other_user}",
      "gists_url": "https://api.github.com/users/dalmoveras/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dalmoveras/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dalmoveras/subscriptions",
      "organizations_url": "https://api.github.com/users/dalmoveras/orgs",
      "repos_url": "https://api.github.com/users/dalmoveras/repos",
      "events_url": "https://api.github.com/users/dalmoveras/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dalmoveras/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-21T01:05:48Z",
    "updated_at": "2023-04-21T01:05:48Z",
    "author_association": "NONE",
    "body": "> what's the transaction count of your sender? (eth_getTransactionCount)\r\n> \r\n> should be 0 but you send with 1\r\n\r\nI set it to zero and worked :)",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1517114659/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
