{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/2567",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/2567/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/2567/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/2567/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/2567",
  "id": 1326660434,
  "node_id": "I_kwDOGBlvNc5PEztS",
  "number": 2567,
  "title": "Coverage: Library coverage",
  "user": {
    "login": "onbjerg",
    "id": 8862627,
    "node_id": "MDQ6VXNlcjg4NjI2Mjc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/8862627?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/onbjerg",
    "html_url": "https://github.com/onbjerg",
    "followers_url": "https://api.github.com/users/onbjerg/followers",
    "following_url": "https://api.github.com/users/onbjerg/following{/other_user}",
    "gists_url": "https://api.github.com/users/onbjerg/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/onbjerg/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/onbjerg/subscriptions",
    "organizations_url": "https://api.github.com/users/onbjerg/orgs",
    "repos_url": "https://api.github.com/users/onbjerg/repos",
    "events_url": "https://api.github.com/users/onbjerg/events{/privacy}",
    "received_events_url": "https://api.github.com/users/onbjerg/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3593644820,
      "node_id": "LA_kwDOGBlvNc7WMqsU",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-feature",
      "name": "T-feature",
      "color": "BFD4F2",
      "default": false,
      "description": "Type: feature"
    },
    {
      "id": 3703752787,
      "node_id": "LA_kwDOGBlvNc7cwshT",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/C-forge",
      "name": "C-forge",
      "color": "5319E7",
      "default": false,
      "description": "Command: forge"
    },
    {
      "id": 4233058229,
      "node_id": "LA_kwDOGBlvNc78T1e1",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/Cmd-forge-coverage",
      "name": "Cmd-forge-coverage",
      "color": "006B75",
      "default": false,
      "description": "Command: forge coverage"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": {
    "login": "onbjerg",
    "id": 8862627,
    "node_id": "MDQ6VXNlcjg4NjI2Mjc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/8862627?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/onbjerg",
    "html_url": "https://github.com/onbjerg",
    "followers_url": "https://api.github.com/users/onbjerg/followers",
    "following_url": "https://api.github.com/users/onbjerg/following{/other_user}",
    "gists_url": "https://api.github.com/users/onbjerg/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/onbjerg/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/onbjerg/subscriptions",
    "organizations_url": "https://api.github.com/users/onbjerg/orgs",
    "repos_url": "https://api.github.com/users/onbjerg/repos",
    "events_url": "https://api.github.com/users/onbjerg/events{/privacy}",
    "received_events_url": "https://api.github.com/users/onbjerg/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "onbjerg",
      "id": 8862627,
      "node_id": "MDQ6VXNlcjg4NjI2Mjc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8862627?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/onbjerg",
      "html_url": "https://github.com/onbjerg",
      "followers_url": "https://api.github.com/users/onbjerg/followers",
      "following_url": "https://api.github.com/users/onbjerg/following{/other_user}",
      "gists_url": "https://api.github.com/users/onbjerg/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/onbjerg/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/onbjerg/subscriptions",
      "organizations_url": "https://api.github.com/users/onbjerg/orgs",
      "repos_url": "https://api.github.com/users/onbjerg/repos",
      "events_url": "https://api.github.com/users/onbjerg/events{/privacy}",
      "received_events_url": "https://api.github.com/users/onbjerg/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/milestones/1",
    "html_url": "https://github.com/foundry-rs/foundry/milestone/1",
    "labels_url": "https://api.github.com/repos/foundry-rs/foundry/milestones/1/labels",
    "id": 8140456,
    "node_id": "MI_kwDOGBlvNc4AfDao",
    "number": 1,
    "title": "v1.0.0",
    "description": "",
    "creator": {
      "login": "onbjerg",
      "id": 8862627,
      "node_id": "MDQ6VXNlcjg4NjI2Mjc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8862627?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/onbjerg",
      "html_url": "https://github.com/onbjerg",
      "followers_url": "https://api.github.com/users/onbjerg/followers",
      "following_url": "https://api.github.com/users/onbjerg/following{/other_user}",
      "gists_url": "https://api.github.com/users/onbjerg/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/onbjerg/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/onbjerg/subscriptions",
      "organizations_url": "https://api.github.com/users/onbjerg/orgs",
      "repos_url": "https://api.github.com/users/onbjerg/repos",
      "events_url": "https://api.github.com/users/onbjerg/events{/privacy}",
      "received_events_url": "https://api.github.com/users/onbjerg/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 10,
    "closed_issues": 125,
    "state": "open",
    "created_at": "2022-06-28T08:15:32Z",
    "updated_at": "2023-05-12T14:44:03Z",
    "due_on": null,
    "closed_at": null
  },
  "comments": 6,
  "created_at": "2022-08-03T04:25:22Z",
  "updated_at": "2023-04-04T06:38:30Z",
  "closed_at": null,
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "Libraries are currently not covered and they are somewhat non-trivial to map instructions for.\r\n\r\nGenerally, there are two types of library functions:\r\n\r\n- **Internal functions** are inlined in the contract that use them\r\n- **External functions** are called via `delegatecall`\r\n\r\nThe way coverage works currently is in a few passes:\r\n\r\n- First, we detect any sections of code that we want to include in our coverage report\r\n- Second, we also take the base contracts of a contract into account, since all behavior of base contracts are inherited. We need this to map instructions to the items we generated in the first pass using source maps\r\n- Third, we use the source maps of *concrete* contracts to find instructions that mark the items gathered in our first and second step as covered. One item might be covered by multiple instructions in different contracts because of inheritance\r\n\r\nThe issue with adding library coverage is that the Solidity compiler does not give us any easily digestable information about what libraries are used in contracts. This is in contrast to base contracts which are easily identified using a property of contract AST nodes called `linearizedBaseContracts`.\r\n\r\nIn order to reliably find what libraries are used in contracts so we can map instructions onto coverage items present in libraries, we need to walk each node in the AST to find call expression nodes.\r\n\r\nThese call expression nodes include some crude type information, and in the case of library calls, the type information will show up as e.g. `type(library LibraryName)`.\r\n\r\nAfter parsing this information, we need to map the library name back onto an AST node ID so we can find what coverage items are present in the library. The rest of the analysis step in `forge coverage` uses AST node IDs to refer to contracts.\r\n\r\nSome unknowns:\r\n\r\n- Is the type information correct, i.e. does it take shadowing and import aliases into account?\r\n- Are library names from the type information easily mappable onto AST node IDs corresponding to the library's AST?",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/2567/reactions",
    "total_count": 3,
    "+1": 3,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/2567/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1217750863",
    "html_url": "https://github.com/foundry-rs/foundry/issues/2567#issuecomment-1217750863",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/2567",
    "id": 1217750863,
    "node_id": "IC_kwDOGBlvNc5IlWdP",
    "user": {
      "login": "KittyFu307",
      "id": 61280608,
      "node_id": "MDQ6VXNlcjYxMjgwNjA4",
      "avatar_url": "https://avatars.githubusercontent.com/u/61280608?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/KittyFu307",
      "html_url": "https://github.com/KittyFu307",
      "followers_url": "https://api.github.com/users/KittyFu307/followers",
      "following_url": "https://api.github.com/users/KittyFu307/following{/other_user}",
      "gists_url": "https://api.github.com/users/KittyFu307/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/KittyFu307/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/KittyFu307/subscriptions",
      "organizations_url": "https://api.github.com/users/KittyFu307/orgs",
      "repos_url": "https://api.github.com/users/KittyFu307/repos",
      "events_url": "https://api.github.com/users/KittyFu307/events{/privacy}",
      "received_events_url": "https://api.github.com/users/KittyFu307/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-17T09:26:23Z",
    "updated_at": "2022-08-17T09:26:23Z",
    "author_association": "NONE",
    "body": "Hi @onbjerg , sorry to bother you, I would like to know, if it is a developer-defined library and the functions in the library are all internal functions, the coverage rate running through forge coverage cannot be supported at present, right?",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1217750863/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1221102147",
    "html_url": "https://github.com/foundry-rs/foundry/issues/2567#issuecomment-1221102147",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/2567",
    "id": 1221102147,
    "node_id": "IC_kwDOGBlvNc5IyIpD",
    "user": {
      "login": "onbjerg",
      "id": 8862627,
      "node_id": "MDQ6VXNlcjg4NjI2Mjc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8862627?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/onbjerg",
      "html_url": "https://github.com/onbjerg",
      "followers_url": "https://api.github.com/users/onbjerg/followers",
      "following_url": "https://api.github.com/users/onbjerg/following{/other_user}",
      "gists_url": "https://api.github.com/users/onbjerg/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/onbjerg/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/onbjerg/subscriptions",
      "organizations_url": "https://api.github.com/users/onbjerg/orgs",
      "repos_url": "https://api.github.com/users/onbjerg/repos",
      "events_url": "https://api.github.com/users/onbjerg/events{/privacy}",
      "received_events_url": "https://api.github.com/users/onbjerg/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-19T21:22:58Z",
    "updated_at": "2022-08-19T21:22:58Z",
    "author_association": "MEMBER",
    "body": "No libraries are supported at the moment",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1221102147/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1223486275",
    "html_url": "https://github.com/foundry-rs/foundry/issues/2567#issuecomment-1223486275",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/2567",
    "id": 1223486275,
    "node_id": "IC_kwDOGBlvNc5I7OtD",
    "user": {
      "login": "KittyFu307",
      "id": 61280608,
      "node_id": "MDQ6VXNlcjYxMjgwNjA4",
      "avatar_url": "https://avatars.githubusercontent.com/u/61280608?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/KittyFu307",
      "html_url": "https://github.com/KittyFu307",
      "followers_url": "https://api.github.com/users/KittyFu307/followers",
      "following_url": "https://api.github.com/users/KittyFu307/following{/other_user}",
      "gists_url": "https://api.github.com/users/KittyFu307/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/KittyFu307/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/KittyFu307/subscriptions",
      "organizations_url": "https://api.github.com/users/KittyFu307/orgs",
      "repos_url": "https://api.github.com/users/KittyFu307/repos",
      "events_url": "https://api.github.com/users/KittyFu307/events{/privacy}",
      "received_events_url": "https://api.github.com/users/KittyFu307/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-08-23T03:28:08Z",
    "updated_at": "2022-08-23T03:28:08Z",
    "author_association": "NONE",
    "body": "Will it support library coverage later?",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1223486275/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1420835749",
    "html_url": "https://github.com/foundry-rs/foundry/issues/2567#issuecomment-1420835749",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/2567",
    "id": 1420835749,
    "node_id": "IC_kwDOGBlvNc5UsDul",
    "user": {
      "login": "PaulRBerg",
      "id": 8782666,
      "node_id": "MDQ6VXNlcjg3ODI2NjY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8782666?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/PaulRBerg",
      "html_url": "https://github.com/PaulRBerg",
      "followers_url": "https://api.github.com/users/PaulRBerg/followers",
      "following_url": "https://api.github.com/users/PaulRBerg/following{/other_user}",
      "gists_url": "https://api.github.com/users/PaulRBerg/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/PaulRBerg/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/PaulRBerg/subscriptions",
      "organizations_url": "https://api.github.com/users/PaulRBerg/orgs",
      "repos_url": "https://api.github.com/users/PaulRBerg/repos",
      "events_url": "https://api.github.com/users/PaulRBerg/events{/privacy}",
      "received_events_url": "https://api.github.com/users/PaulRBerg/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-02-07T14:08:58Z",
    "updated_at": "2023-02-08T10:33:35Z",
    "author_association": "CONTRIBUTOR",
    "body": "Shouldn't this issue be closed?\r\n\r\nIt looks like #3128 added support for library coverage, and I can also see that it works in my project.\r\n\r\n**Update**: it looks like no, this issue cannot be just yet. There are still issues with library coverage, e.g. https://github.com/foundry-rs/foundry/issues/4305.",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1420835749/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1495326008",
    "html_url": "https://github.com/foundry-rs/foundry/issues/2567#issuecomment-1495326008",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/2567",
    "id": 1495326008,
    "node_id": "IC_kwDOGBlvNc5ZIN04",
    "user": {
      "login": "0xdapper",
      "id": 94534135,
      "node_id": "U_kgDOBaJ59w",
      "avatar_url": "https://avatars.githubusercontent.com/u/94534135?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/0xdapper",
      "html_url": "https://github.com/0xdapper",
      "followers_url": "https://api.github.com/users/0xdapper/followers",
      "following_url": "https://api.github.com/users/0xdapper/following{/other_user}",
      "gists_url": "https://api.github.com/users/0xdapper/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/0xdapper/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/0xdapper/subscriptions",
      "organizations_url": "https://api.github.com/users/0xdapper/orgs",
      "repos_url": "https://api.github.com/users/0xdapper/repos",
      "events_url": "https://api.github.com/users/0xdapper/events{/privacy}",
      "received_events_url": "https://api.github.com/users/0xdapper/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-04T04:22:06Z",
    "updated_at": "2023-04-04T04:24:15Z",
    "author_association": "CONTRIBUTOR",
    "body": "Also generally outside of dynamically linked libraries any and all delegatecall'd code is not being considered as covered I think. Is that right? Might be worth updating the issue with what is the current way of how coverage works.",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1495326008/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1495428149",
    "html_url": "https://github.com/foundry-rs/foundry/issues/2567#issuecomment-1495428149",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/2567",
    "id": 1495428149,
    "node_id": "IC_kwDOGBlvNc5ZImw1",
    "user": {
      "login": "PaulRBerg",
      "id": 8782666,
      "node_id": "MDQ6VXNlcjg3ODI2NjY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8782666?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/PaulRBerg",
      "html_url": "https://github.com/PaulRBerg",
      "followers_url": "https://api.github.com/users/PaulRBerg/followers",
      "following_url": "https://api.github.com/users/PaulRBerg/following{/other_user}",
      "gists_url": "https://api.github.com/users/PaulRBerg/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/PaulRBerg/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/PaulRBerg/subscriptions",
      "organizations_url": "https://api.github.com/users/PaulRBerg/orgs",
      "repos_url": "https://api.github.com/users/PaulRBerg/repos",
      "events_url": "https://api.github.com/users/PaulRBerg/events{/privacy}",
      "received_events_url": "https://api.github.com/users/PaulRBerg/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-04-04T06:38:29Z",
    "updated_at": "2023-04-04T06:38:29Z",
    "author_association": "CONTRIBUTOR",
    "body": "> Might be worth updating the issue with what is the current way of how coverage works.\r\n\r\nCc @gakonst. Many coverage-related issues are outdated, including https://github.com/foundry-rs/foundry/issues/1961.",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1495428149/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
