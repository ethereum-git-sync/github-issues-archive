{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/3661",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3661/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3661/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3661/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/3661",
  "id": 1444501550,
  "node_id": "I_kwDOGBlvNc5WGVgu",
  "number": 3661,
  "title": "`msg.sender` different in setUp and tests",
  "user": {
    "login": "xenoliss",
    "id": 33523487,
    "node_id": "MDQ6VXNlcjMzNTIzNDg3",
    "avatar_url": "https://avatars.githubusercontent.com/u/33523487?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/xenoliss",
    "html_url": "https://github.com/xenoliss",
    "followers_url": "https://api.github.com/users/xenoliss/followers",
    "following_url": "https://api.github.com/users/xenoliss/following{/other_user}",
    "gists_url": "https://api.github.com/users/xenoliss/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/xenoliss/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/xenoliss/subscriptions",
    "organizations_url": "https://api.github.com/users/xenoliss/orgs",
    "repos_url": "https://api.github.com/users/xenoliss/repos",
    "events_url": "https://api.github.com/users/xenoliss/events{/privacy}",
    "received_events_url": "https://api.github.com/users/xenoliss/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3334394228,
      "node_id": "MDU6TGFiZWwzMzM0Mzk0MjI4",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-bug",
      "name": "T-bug",
      "color": "d73a4a",
      "default": false,
      "description": "Type: bug"
    },
    {
      "id": 3593644915,
      "node_id": "LA_kwDOGBlvNc7WMqtz",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/Cmd-forge-test",
      "name": "Cmd-forge-test",
      "color": "006B75",
      "default": false,
      "description": "Command: forge test"
    },
    {
      "id": 3703752787,
      "node_id": "LA_kwDOGBlvNc7cwshT",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/C-forge",
      "name": "C-forge",
      "color": "5319E7",
      "default": false,
      "description": "Command: forge"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 7,
  "created_at": "2022-11-10T20:13:57Z",
  "updated_at": "2022-11-20T05:13:29Z",
  "closed_at": "2022-11-20T05:13:29Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Component\n\nForge, Other (please describe)\n\n### Have you ensured that all of these are up to date?\n\n- [X] Foundry\n- [X] Foundryup\n\n### What version of Foundry are you on?\n\nforge 0.2.0 (8b0af47 2022-11-05T15:13:14.009577258Z)\n\n### What command(s) is the bug in?\n\nforge test --match-test testSameSender -vv\n\n### Operating System\n\n_No response_\n\n### Describe the bug\n\n`msg.sender` value differs between the `setUp` function and the unit tests. Here is a minimal code to reproduce the issue:\r\n\r\n```solidity\r\n// SPDX-License-Identifier: UNLICENSED\r\npragma solidity ^0.8.17;\r\n\r\nimport \"forge-std/Test.sol\";\r\n\r\ncontract TestMe is Test {\r\n    address sender;\r\n\r\n    function setUp() public {\r\n        sender = msg.sender;\r\n    }\r\n\r\n    function testSameSender() public {\r\n        assertEq(sender, msg.sender);\r\n    }\r\n}\r\n```",
  "closed_by": {
    "login": "gakonst",
    "id": 17802178,
    "node_id": "MDQ6VXNlcjE3ODAyMTc4",
    "avatar_url": "https://avatars.githubusercontent.com/u/17802178?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/gakonst",
    "html_url": "https://github.com/gakonst",
    "followers_url": "https://api.github.com/users/gakonst/followers",
    "following_url": "https://api.github.com/users/gakonst/following{/other_user}",
    "gists_url": "https://api.github.com/users/gakonst/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/gakonst/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/gakonst/subscriptions",
    "organizations_url": "https://api.github.com/users/gakonst/orgs",
    "repos_url": "https://api.github.com/users/gakonst/repos",
    "events_url": "https://api.github.com/users/gakonst/events{/privacy}",
    "received_events_url": "https://api.github.com/users/gakonst/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/3661/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3661/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1310844375",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3661#issuecomment-1310844375",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3661",
    "id": 1310844375,
    "node_id": "IC_kwDOGBlvNc5OIeXX",
    "user": {
      "login": "mattsse",
      "id": 19890894,
      "node_id": "MDQ6VXNlcjE5ODkwODk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/19890894?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mattsse",
      "html_url": "https://github.com/mattsse",
      "followers_url": "https://api.github.com/users/mattsse/followers",
      "following_url": "https://api.github.com/users/mattsse/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattsse/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mattsse/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattsse/subscriptions",
      "organizations_url": "https://api.github.com/users/mattsse/orgs",
      "repos_url": "https://api.github.com/users/mattsse/repos",
      "events_url": "https://api.github.com/users/mattsse/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mattsse/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-11-10T20:16:40Z",
    "updated_at": "2022-11-10T20:16:40Z",
    "author_association": "MEMBER",
    "body": "thanks for this,\r\n\r\nthere's the caller\r\n\r\nhttps://github.com/foundry-rs/foundry/blob/c5791f5c2a2ccdc8d7d1cd5c77175154fb7ad6cf/evm/src/lib.rs#L39-L44\r\n\r\nI can't remember if we deliberately deploy and test from different accounts, or if both should be the same.\r\n\r\ncc @mds1 @gakonst \r\n",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1310844375/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1310856015",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3661#issuecomment-1310856015",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3661",
    "id": 1310856015,
    "node_id": "IC_kwDOGBlvNc5OIhNP",
    "user": {
      "login": "xenoliss",
      "id": 33523487,
      "node_id": "MDQ6VXNlcjMzNTIzNDg3",
      "avatar_url": "https://avatars.githubusercontent.com/u/33523487?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/xenoliss",
      "html_url": "https://github.com/xenoliss",
      "followers_url": "https://api.github.com/users/xenoliss/followers",
      "following_url": "https://api.github.com/users/xenoliss/following{/other_user}",
      "gists_url": "https://api.github.com/users/xenoliss/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/xenoliss/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/xenoliss/subscriptions",
      "organizations_url": "https://api.github.com/users/xenoliss/orgs",
      "repos_url": "https://api.github.com/users/xenoliss/repos",
      "events_url": "https://api.github.com/users/xenoliss/events{/privacy}",
      "received_events_url": "https://api.github.com/users/xenoliss/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-11-10T20:28:01Z",
    "updated_at": "2022-11-11T09:03:02Z",
    "author_association": "NONE",
    "body": "I personally have lot more use cases where I need `msg.sender` to be the same in both (setting balance, minting tokens, deploying ownable contracts etc.). But as you said maybe I'm missing something worth enough to have them different.\r\n\r\n**EDIT**:  The comment above: https://github.com/foundry-rs/foundry/blob/c5791f5c2a2ccdc8d7d1cd5c77175154fb7ad6cf/evm/src/lib.rs#L36 kind of explicitly tells that `CALLER` is to be used when deploying, meaning, unless `setUp` is called at deployment, there is no real reason to use it when setting up tests.",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1310856015/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1311770090",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3661#issuecomment-1311770090",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3661",
    "id": 1311770090,
    "node_id": "IC_kwDOGBlvNc5OMAXq",
    "user": {
      "login": "mds1",
      "id": 17163988,
      "node_id": "MDQ6VXNlcjE3MTYzOTg4",
      "avatar_url": "https://avatars.githubusercontent.com/u/17163988?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mds1",
      "html_url": "https://github.com/mds1",
      "followers_url": "https://api.github.com/users/mds1/followers",
      "following_url": "https://api.github.com/users/mds1/following{/other_user}",
      "gists_url": "https://api.github.com/users/mds1/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mds1/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mds1/subscriptions",
      "organizations_url": "https://api.github.com/users/mds1/orgs",
      "repos_url": "https://api.github.com/users/mds1/repos",
      "events_url": "https://api.github.com/users/mds1/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mds1/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-11-11T14:35:57Z",
    "updated_at": "2022-11-11T14:35:57Z",
    "author_association": "COLLABORATOR",
    "body": "I just tested what dapptools does, since my guess was that we inherited their choice. So I ran `forge init`, modified the test file a bit as shown below, then ran forge and dapp against it\r\n\r\n```solidity\r\n// SPDX-License-Identifier: UNLICENSED\r\npragma solidity ^0.8.0;\r\n\r\nimport \"ds-test/test.sol\";\r\nimport \"../Counter.sol\";\r\n\r\ncontract CounterTest is DSTest {\r\n    Counter public counter;\r\n\r\n    function setUp() public {\r\n        emit log_named_address(\"setUp\", msg.sender);\r\n        counter = new Counter();\r\n        counter.setNumber(0);\r\n    }\r\n\r\n    function testIncrement() public {\r\n        emit log_named_address(\"testIncrement\", msg.sender);\r\n        counter.increment();\r\n        assertEq(counter.number(), 1);\r\n    }\r\n}\r\n```\r\n\r\nResulting output from `dapp test --verbosity 2`:\r\n\r\n```\r\nRunning 1 tests for src/test/Counter.t.sol:CounterTest\r\n[PASS] testIncrement() (gas: 24611)\r\n\r\nSuccess: testIncrement\r\n  \r\n  setUp: @0x00a329c0648769A73afAc7F9381E08FB43dBEA72\r\n  testIncrement: @0x00a329c0648769A73afAc7F9381E08FB43dBEA72\r\n```\r\n\r\nResulting output from `forge test -vvv`:\r\n\r\n```\r\n\r\nRunning 1 test for src/test/Counter.t.sol:CounterTest\r\n[PASS] testIncrement() (gas: 30315)\r\nLogs:\r\n  setUp: 0x1804c8ab1f12e6bbf3894d4083f33e07309d1f38\r\n  testIncrement: 0x00a329c0648769a73afac7f9381e08fb43dbea72\r\n```\r\n\r\nSo you can see dapp uses the 0x00a3 address for calling both setUp and tests, whereas forge uses a different address. I'm not sure whether or not this was an intentional decision we made to deviate from dapptools, maybe @gakonst @brockelmore @transmissions11 remember?\r\n\r\nEither way it doesn't seem like it should matter too much, my only worry is if we change this to match dapptools, will that break tests for some people? Though intuitively I tend to agree with @xenoliss that it makes more sense for them to be the same address.\r\n\r\n@xenoliss in the meantime you can always use `vm.prank` and `vm.startPrank` to ensure you get the same msg.sender in both places",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1311770090/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1311828167",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3661#issuecomment-1311828167",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3661",
    "id": 1311828167,
    "node_id": "IC_kwDOGBlvNc5OMOjH",
    "user": {
      "login": "xenoliss",
      "id": 33523487,
      "node_id": "MDQ6VXNlcjMzNTIzNDg3",
      "avatar_url": "https://avatars.githubusercontent.com/u/33523487?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/xenoliss",
      "html_url": "https://github.com/xenoliss",
      "followers_url": "https://api.github.com/users/xenoliss/followers",
      "following_url": "https://api.github.com/users/xenoliss/following{/other_user}",
      "gists_url": "https://api.github.com/users/xenoliss/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/xenoliss/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/xenoliss/subscriptions",
      "organizations_url": "https://api.github.com/users/xenoliss/orgs",
      "repos_url": "https://api.github.com/users/xenoliss/repos",
      "events_url": "https://api.github.com/users/xenoliss/events{/privacy}",
      "received_events_url": "https://api.github.com/users/xenoliss/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-11-11T15:31:25Z",
    "updated_at": "2022-11-11T15:31:25Z",
    "author_association": "NONE",
    "body": "Thanks @mds1 for the detailed answer and yes I'm currently using `vm.prank` a bit everywhere especially for this !",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1311828167/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1311937794",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3661#issuecomment-1311937794",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3661",
    "id": 1311937794,
    "node_id": "IC_kwDOGBlvNc5OMpUC",
    "user": {
      "login": "transmissions11",
      "id": 26209401,
      "node_id": "MDQ6VXNlcjI2MjA5NDAx",
      "avatar_url": "https://avatars.githubusercontent.com/u/26209401?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/transmissions11",
      "html_url": "https://github.com/transmissions11",
      "followers_url": "https://api.github.com/users/transmissions11/followers",
      "following_url": "https://api.github.com/users/transmissions11/following{/other_user}",
      "gists_url": "https://api.github.com/users/transmissions11/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/transmissions11/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/transmissions11/subscriptions",
      "organizations_url": "https://api.github.com/users/transmissions11/orgs",
      "repos_url": "https://api.github.com/users/transmissions11/repos",
      "events_url": "https://api.github.com/users/transmissions11/events{/privacy}",
      "received_events_url": "https://api.github.com/users/transmissions11/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-11-11T16:47:56Z",
    "updated_at": "2022-11-11T16:47:56Z",
    "author_association": "CONTRIBUTOR",
    "body": "> intentional decision we made to deviate from dapptools, maybe @gakonst @brockelmore @transmissions11 remember?\r\n\r\nNot that I recall, and I do think it would be the less surprising behavior to match the sender between setUp and tests.\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1311937794/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1312286843",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3661#issuecomment-1312286843",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3661",
    "id": 1312286843,
    "node_id": "IC_kwDOGBlvNc5ON-h7",
    "user": {
      "login": "gakonst",
      "id": 17802178,
      "node_id": "MDQ6VXNlcjE3ODAyMTc4",
      "avatar_url": "https://avatars.githubusercontent.com/u/17802178?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gakonst",
      "html_url": "https://github.com/gakonst",
      "followers_url": "https://api.github.com/users/gakonst/followers",
      "following_url": "https://api.github.com/users/gakonst/following{/other_user}",
      "gists_url": "https://api.github.com/users/gakonst/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gakonst/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gakonst/subscriptions",
      "organizations_url": "https://api.github.com/users/gakonst/orgs",
      "repos_url": "https://api.github.com/users/gakonst/repos",
      "events_url": "https://api.github.com/users/gakonst/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gakonst/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-11-12T00:34:38Z",
    "updated_at": "2022-11-12T00:35:03Z",
    "author_association": "MEMBER",
    "body": "The reason was something about nonces and library pre deployment and linking IIRC during scripts/tests. Cc @joshieDo who's looked at this before. I'll try taking a look this weekend.",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1312286843/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1312724654",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3661#issuecomment-1312724654",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3661",
    "id": 1312724654,
    "node_id": "IC_kwDOGBlvNc5OPpau",
    "user": {
      "login": "joshieDo",
      "id": 93316087,
      "node_id": "U_kgDOBY_j9w",
      "avatar_url": "https://avatars.githubusercontent.com/u/93316087?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/joshieDo",
      "html_url": "https://github.com/joshieDo",
      "followers_url": "https://api.github.com/users/joshieDo/followers",
      "following_url": "https://api.github.com/users/joshieDo/following{/other_user}",
      "gists_url": "https://api.github.com/users/joshieDo/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/joshieDo/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/joshieDo/subscriptions",
      "organizations_url": "https://api.github.com/users/joshieDo/orgs",
      "repos_url": "https://api.github.com/users/joshieDo/repos",
      "events_url": "https://api.github.com/users/joshieDo/events{/privacy}",
      "received_events_url": "https://api.github.com/users/joshieDo/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-11-13T12:56:50Z",
    "updated_at": "2022-11-13T13:02:24Z",
    "author_association": "COLLABORATOR",
    "body": "> The reason was something about nonces and library pre deployment and linking IIRC during scripts/tests. \r\n\r\nFor `forge script` the `msg.sender` is the same at `setUp` and `run()` (and different than `CALLER`). `CALLER` is used to deploy the script contract iirc.\r\n\r\n\r\nHowever, for `forge test` (which is what we're talking about here I think)  we're using `FROM=` for when calling the test function.  https://github.com/foundry-rs/foundry/blob/45b9dccdc8584fb5fbf55eb190a880d4e3b0753f/forge/src/runner.rs#L360-L361\r\n\r\nI'm sure we can do some sort of `sender.unwrap_or(CALLER)` there?\r\n\r\n\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1312724654/reactions",
      "total_count": 2,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 1,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
