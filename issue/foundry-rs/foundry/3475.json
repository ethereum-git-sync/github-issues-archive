{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/3475",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3475/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3475/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3475/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/3475",
  "id": 1404032510,
  "node_id": "I_kwDOGBlvNc5Tr9X-",
  "number": 3475,
  "title": "Incorrect Gas Report ",
  "user": {
    "login": "amit-supraoracles",
    "id": 84004854,
    "node_id": "MDQ6VXNlcjg0MDA0ODU0",
    "avatar_url": "https://avatars.githubusercontent.com/u/84004854?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/amit-supraoracles",
    "html_url": "https://github.com/amit-supraoracles",
    "followers_url": "https://api.github.com/users/amit-supraoracles/followers",
    "following_url": "https://api.github.com/users/amit-supraoracles/following{/other_user}",
    "gists_url": "https://api.github.com/users/amit-supraoracles/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/amit-supraoracles/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/amit-supraoracles/subscriptions",
    "organizations_url": "https://api.github.com/users/amit-supraoracles/orgs",
    "repos_url": "https://api.github.com/users/amit-supraoracles/repos",
    "events_url": "https://api.github.com/users/amit-supraoracles/events{/privacy}",
    "received_events_url": "https://api.github.com/users/amit-supraoracles/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3334394228,
      "node_id": "MDU6TGFiZWwzMzM0Mzk0MjI4",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-bug",
      "name": "T-bug",
      "color": "d73a4a",
      "default": false,
      "description": "Type: bug"
    },
    {
      "id": 3593644915,
      "node_id": "LA_kwDOGBlvNc7WMqtz",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/Cmd-forge-test",
      "name": "Cmd-forge-test",
      "color": "006B75",
      "default": false,
      "description": "Command: forge test"
    },
    {
      "id": 3703752787,
      "node_id": "LA_kwDOGBlvNc7cwshT",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/C-forge",
      "name": "C-forge",
      "color": "5319E7",
      "default": false,
      "description": "Command: forge"
    },
    {
      "id": 3759773804,
      "node_id": "LA_kwDOGBlvNc7gGZhs",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/A-gas-snapshots",
      "name": "A-gas-snapshots",
      "color": "FBCA04",
      "default": false,
      "description": "Area: gas snapshotting/reporting"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2022-10-11T05:38:05Z",
  "updated_at": "2023-03-15T12:53:48Z",
  "closed_at": "2023-03-15T12:44:26Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Component\n\nForge\n\n### Have you ensured that all of these are up to date?\n\n- [X] Foundry\n- [X] Foundryup\n\n### What version of Foundry are you on?\n\nforge 0.2.0 (def1d61 2022-09-23T00:11:51.396013251Z)\n\n### What command(s) is the bug in?\n\nforge test\n\n### Operating System\n\nLinux\n\n### Describe the bug\n\nFollowing code snipped gas costs different when deploy and test using Remix IDE and Foundry.\r\n\r\nI used following smart contract.\r\n```\r\n// SPDX-License-Identifier: GPL-3.0\r\npragma solidity >=0.8.7;\r\n\r\ncontract GasCost {\r\n  \r\n  mapping(uint256 => uint256) internal SomeData;\r\n\r\n  // REMIX IDE : 1st execution cost: 44117\r\n  // REMIX IDE : 2nd onwards cost  : 24217\r\n  function store(uint64 _key, uint256 _value) public {\r\n     SomeData[_key] = _value ;\r\n  }\r\n}  \r\n\r\n```\r\nAnd this test contract\r\n```\r\n// SPDX-License-Identifier: UNLICENSED\r\npragma solidity ^0.8.13;\r\n\r\nimport \"forge-std/Test.sol\";\r\nimport \"../src/Counter.sol\";\r\n\r\ncontract CounterTest is Test {\r\n    Counter public counter;\r\n    \r\n    function setUp() public {\r\n       counter = new Counter();\r\n    }\r\n\r\n    function testStore(uint64 _key, uint256 _value) public {\r\n        counter.store(_key, _value); \r\n     \r\n    }\r\n}\r\n```\r\nI run the test and got following result.\r\n\r\n![image](https://user-images.githubusercontent.com/84004854/195004721-71ce5849-07f5-4d32-9576-55e2d31640d9.png)\r\n\r\n",
  "closed_by": {
    "login": "mds1",
    "id": 17163988,
    "node_id": "MDQ6VXNlcjE3MTYzOTg4",
    "avatar_url": "https://avatars.githubusercontent.com/u/17163988?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mds1",
    "html_url": "https://github.com/mds1",
    "followers_url": "https://api.github.com/users/mds1/followers",
    "following_url": "https://api.github.com/users/mds1/following{/other_user}",
    "gists_url": "https://api.github.com/users/mds1/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mds1/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mds1/subscriptions",
    "organizations_url": "https://api.github.com/users/mds1/orgs",
    "repos_url": "https://api.github.com/users/mds1/repos",
    "events_url": "https://api.github.com/users/mds1/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mds1/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/3475/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3475/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1469675278",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3475#issuecomment-1469675278",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3475",
    "id": 1469675278,
    "node_id": "IC_kwDOGBlvNc5XmXcO",
    "user": {
      "login": "0xKaso",
      "id": 112838520,
      "node_id": "U_kgDOBrnHeA",
      "avatar_url": "https://avatars.githubusercontent.com/u/112838520?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/0xKaso",
      "html_url": "https://github.com/0xKaso",
      "followers_url": "https://api.github.com/users/0xKaso/followers",
      "following_url": "https://api.github.com/users/0xKaso/following{/other_user}",
      "gists_url": "https://api.github.com/users/0xKaso/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/0xKaso/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/0xKaso/subscriptions",
      "organizations_url": "https://api.github.com/users/0xKaso/orgs",
      "repos_url": "https://api.github.com/users/0xKaso/repos",
      "events_url": "https://api.github.com/users/0xKaso/events{/privacy}",
      "received_events_url": "https://api.github.com/users/0xKaso/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-15T09:43:01Z",
    "updated_at": "2023-03-15T09:43:01Z",
    "author_association": "NONE",
    "body": "I have the same problem.",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1469675278/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1469940917",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3475#issuecomment-1469940917",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3475",
    "id": 1469940917,
    "node_id": "IC_kwDOGBlvNc5XnYS1",
    "user": {
      "login": "mds1",
      "id": 17163988,
      "node_id": "MDQ6VXNlcjE3MTYzOTg4",
      "avatar_url": "https://avatars.githubusercontent.com/u/17163988?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mds1",
      "html_url": "https://github.com/mds1",
      "followers_url": "https://api.github.com/users/mds1/followers",
      "following_url": "https://api.github.com/users/mds1/following{/other_user}",
      "gists_url": "https://api.github.com/users/mds1/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mds1/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mds1/subscriptions",
      "organizations_url": "https://api.github.com/users/mds1/orgs",
      "repos_url": "https://api.github.com/users/mds1/repos",
      "events_url": "https://api.github.com/users/mds1/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mds1/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-03-15T12:44:26Z",
    "updated_at": "2023-03-15T12:53:48Z",
    "author_association": "COLLABORATOR",
    "body": "In remix the 44117 number likely includes the 21000 intrinsic gas, which forge hides from the gas report since the gas report just shows the cost of executing the function. Subtracting this away gives a first execution cost in remix of 23117 (not sure what they're reporting in the second execution cost). \r\n\r\nThe remaining difference of 23117 - 22426 = 691 gas is from the calldata cost, which remix is likely including and forge excluding. Calldata costs 4 gas per zero byte and 16 gas per nonzero byte. There are 64 bytes of calldata for this method. This implies the cost of the mix of zero and nonzero calldata bytes adds up to 691 gas, though ChatGPT tells me that \"solve `691 = 4x + 16y` with the condition `x + y = 64`\" has no solution when x and y are integers so I assume the inputs to each call (remix vs. forge) was different\r\n\r\nPer the above these numbers seem roughly correct and inline with what I'd expect, so going to close this, but feel free to ask any more questions here",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1469940917/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
