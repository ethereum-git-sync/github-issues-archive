{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/3891",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3891/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3891/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3891/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/3891",
  "id": 1495727055,
  "node_id": "I_kwDOGBlvNc5ZJvvP",
  "number": 3891,
  "title": "anvil_dumpState is not deterministic in the output",
  "user": {
    "login": "KholdStare",
    "id": 836110,
    "node_id": "MDQ6VXNlcjgzNjExMA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/836110?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/KholdStare",
    "html_url": "https://github.com/KholdStare",
    "followers_url": "https://api.github.com/users/KholdStare/followers",
    "following_url": "https://api.github.com/users/KholdStare/following{/other_user}",
    "gists_url": "https://api.github.com/users/KholdStare/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/KholdStare/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/KholdStare/subscriptions",
    "organizations_url": "https://api.github.com/users/KholdStare/orgs",
    "repos_url": "https://api.github.com/users/KholdStare/repos",
    "events_url": "https://api.github.com/users/KholdStare/events{/privacy}",
    "received_events_url": "https://api.github.com/users/KholdStare/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3334394228,
      "node_id": "MDU6TGFiZWwzMzM0Mzk0MjI4",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-bug",
      "name": "T-bug",
      "color": "d73a4a",
      "default": false,
      "description": "Type: bug"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2022-12-14T05:30:02Z",
  "updated_at": "2022-12-16T09:53:55Z",
  "closed_at": "2022-12-16T09:53:55Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "### Component\r\n\r\nAnvil\r\n\r\n### Have you ensured that all of these are up to date?\r\n\r\n- [X] Foundry\r\n- [ ] Foundryup\r\n\r\n### What version of Foundry are you on?\r\n\r\nforge 0.2.0 (d896050 2022-12-01T21:20:45.538002477Z)\r\n\r\n### What command(s) is the bug in?\r\n\r\nanvil_dumpState\r\n\r\n### Operating System\r\n\r\nLinux\r\n\r\n### Describe the bug\r\n\r\nA useful feature was introduced by @dbeal-eth in https://github.com/foundry-rs/foundry/pull/2256 for dumping the current state of the evm and loading it back in. However, the returned hex string is not deterministic. Running it on the same evm state, calling `anvil_dumpState` back to back results in different strings.\r\n\r\nI suspect this is due to the fact that the resulting bytes are serialized from a rust `HashMap`:\r\n\r\n```\r\npub struct SerializableState {\r\n    pub accounts: HashMap<Address, SerializableAccountRecord>,\r\n}\r\n```\r\n\r\nAnd according to https://doc.rust-lang.org/std/collections/struct.HashMap.html, the hashmap is randomly seeded. Seems like the solution is either to sort the keys before serializing, or initialize the hashmap with a deterministic seed with e.g. https://doc.rust-lang.org/std/collections/struct.HashMap.html#method.with_hasher . What do you think?\r\n\r\n**Why is this even an issue?**\r\n\r\nEven though the end-result of loading the dumped state into anvil results in the same state no matter the order of the keys, it's not easy to verify whether two dumped states are identical by just looking at the hex strings. We want to use this as an extra sanity check on our deployments - we deploy our contracts on anvil using `forge script`, then run `anvil_dumpState` and see if it matches the expected result. Right now it is not possible.",
  "closed_by": {
    "login": "mattsse",
    "id": 19890894,
    "node_id": "MDQ6VXNlcjE5ODkwODk0",
    "avatar_url": "https://avatars.githubusercontent.com/u/19890894?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mattsse",
    "html_url": "https://github.com/mattsse",
    "followers_url": "https://api.github.com/users/mattsse/followers",
    "following_url": "https://api.github.com/users/mattsse/following{/other_user}",
    "gists_url": "https://api.github.com/users/mattsse/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mattsse/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mattsse/subscriptions",
    "organizations_url": "https://api.github.com/users/mattsse/orgs",
    "repos_url": "https://api.github.com/users/mattsse/repos",
    "events_url": "https://api.github.com/users/mattsse/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mattsse/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/3891/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3891/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1354339722",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3891#issuecomment-1354339722",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3891",
    "id": 1354339722,
    "node_id": "IC_kwDOGBlvNc5QuZWK",
    "user": {
      "login": "mattsse",
      "id": 19890894,
      "node_id": "MDQ6VXNlcjE5ODkwODk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/19890894?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mattsse",
      "html_url": "https://github.com/mattsse",
      "followers_url": "https://api.github.com/users/mattsse/followers",
      "following_url": "https://api.github.com/users/mattsse/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattsse/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mattsse/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattsse/subscriptions",
      "organizations_url": "https://api.github.com/users/mattsse/orgs",
      "repos_url": "https://api.github.com/users/mattsse/repos",
      "events_url": "https://api.github.com/users/mattsse/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mattsse/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-16T07:46:07Z",
    "updated_at": "2022-12-16T07:46:07Z",
    "author_association": "MEMBER",
    "body": "good find, ty. \r\n\r\nyou're totally right, will change to BTreeMap which is commonly used to sort json objects",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1354339722/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 1,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
