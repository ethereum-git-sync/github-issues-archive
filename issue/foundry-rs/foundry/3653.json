{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/3653",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3653/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3653/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3653/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/3653",
  "id": 1443208092,
  "node_id": "I_kwDOGBlvNc5WBZuc",
  "number": 3653,
  "title": "Failure to run tests with vm.createSelectFork",
  "user": {
    "login": "MikeHathaway",
    "id": 13224356,
    "node_id": "MDQ6VXNlcjEzMjI0MzU2",
    "avatar_url": "https://avatars.githubusercontent.com/u/13224356?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/MikeHathaway",
    "html_url": "https://github.com/MikeHathaway",
    "followers_url": "https://api.github.com/users/MikeHathaway/followers",
    "following_url": "https://api.github.com/users/MikeHathaway/following{/other_user}",
    "gists_url": "https://api.github.com/users/MikeHathaway/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/MikeHathaway/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/MikeHathaway/subscriptions",
    "organizations_url": "https://api.github.com/users/MikeHathaway/orgs",
    "repos_url": "https://api.github.com/users/MikeHathaway/repos",
    "events_url": "https://api.github.com/users/MikeHathaway/events{/privacy}",
    "received_events_url": "https://api.github.com/users/MikeHathaway/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3334394228,
      "node_id": "MDU6TGFiZWwzMzM0Mzk0MjI4",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-bug",
      "name": "T-bug",
      "color": "d73a4a",
      "default": false,
      "description": "Type: bug"
    },
    {
      "id": 3593644915,
      "node_id": "LA_kwDOGBlvNc7WMqtz",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/Cmd-forge-test",
      "name": "Cmd-forge-test",
      "color": "006B75",
      "default": false,
      "description": "Command: forge test"
    },
    {
      "id": 3703752787,
      "node_id": "LA_kwDOGBlvNc7cwshT",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/C-forge",
      "name": "C-forge",
      "color": "5319E7",
      "default": false,
      "description": "Command: forge"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2022-11-10T04:02:34Z",
  "updated_at": "2022-11-11T05:05:02Z",
  "closed_at": "2022-11-10T10:23:56Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Component\n\nForge\n\n### Have you ensured that all of these are up to date?\n\n- [X] Foundry\n- [X] Foundryup\n\n### What version of Foundry are you on?\n\nforge 0.2.0 (e320eb3 2022-11-09T23:40:07.405160828Z)\n\n### What command(s) is the bug in?\n\nforge test, forge coverage\n\n### Operating System\n\nLinux\n\n### Describe the bug\n\nWe're running some fork tests as part of our test suite, and seeing inconsistent behavior. Some of the tests are failing to run, and instead outputting the following error: \r\n```\r\nBacktrace omitted. Run with RUST_BACKTRACE=1 environment variable to display it.\r\nRun with RUST_BACKTRACE=full to include source snippets.\r\nThe application panicked (crashed).\r\nMessage:  Test contract address must be set\r\nLocation: evm/src/executor/backend/mod.rs:562\r\n\r\nThis is a bug. Consider reporting it at https://github.com/foundry-rs/foundry\r\n```\r\n\r\nThe forking is instantiated in a helper contract's constructor, which is implemented by the testing contract:\r\n```    \r\nconstructor() {\r\n            vm.createSelectFork(vm.envString(\"ETH_RPC_URL\"));\r\n\r\n            token      = new Token(\"token\", \"t\");\r\n            vm.makePersistent(address(token));\r\n        }\r\n```\r\n\r\nOnly some of the test's are failing with this error. I've attempted to use both Infura, and Alchemy RPC nodes for `ETH_RPC_URL`, and verified they work externally. Commenting out the above line enables the tests to run.\r\n\r\nI've attached a copy of the backtrace output as well:\r\n\r\n[backtrace.txt](https://github.com/foundry-rs/foundry/files/9977209/backtrace.txt)\r\n",
  "closed_by": {
    "login": "mattsse",
    "id": 19890894,
    "node_id": "MDQ6VXNlcjE5ODkwODk0",
    "avatar_url": "https://avatars.githubusercontent.com/u/19890894?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mattsse",
    "html_url": "https://github.com/mattsse",
    "followers_url": "https://api.github.com/users/mattsse/followers",
    "following_url": "https://api.github.com/users/mattsse/following{/other_user}",
    "gists_url": "https://api.github.com/users/mattsse/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mattsse/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mattsse/subscriptions",
    "organizations_url": "https://api.github.com/users/mattsse/orgs",
    "repos_url": "https://api.github.com/users/mattsse/repos",
    "events_url": "https://api.github.com/users/mattsse/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mattsse/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/3653/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3653/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1309921622",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3653#issuecomment-1309921622",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3653",
    "id": 1309921622,
    "node_id": "IC_kwDOGBlvNc5OE9FW",
    "user": {
      "login": "mattsse",
      "id": 19890894,
      "node_id": "MDQ6VXNlcjE5ODkwODk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/19890894?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mattsse",
      "html_url": "https://github.com/mattsse",
      "followers_url": "https://api.github.com/users/mattsse/followers",
      "following_url": "https://api.github.com/users/mattsse/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattsse/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mattsse/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattsse/subscriptions",
      "organizations_url": "https://api.github.com/users/mattsse/orgs",
      "repos_url": "https://api.github.com/users/mattsse/repos",
      "events_url": "https://api.github.com/users/mattsse/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mattsse/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-11-10T08:13:19Z",
    "updated_at": "2022-11-10T08:13:19Z",
    "author_association": "MEMBER",
    "body": "thanks for this.\r\n\r\nCurious, since this is a debug_assert, do you use the nightly release or a manual debug build?\r\n\r\nThis turned out to be an issue with the `constructor` call, we only set the test contract address if the fork was initialized inside the `setUp` call.\r\n\r\nfixing this to simply derive the contract address if called in a constructor.\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1309921622/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1311234818",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3653#issuecomment-1311234818",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3653",
    "id": 1311234818,
    "node_id": "IC_kwDOGBlvNc5OJ9sC",
    "user": {
      "login": "MikeHathaway",
      "id": 13224356,
      "node_id": "MDQ6VXNlcjEzMjI0MzU2",
      "avatar_url": "https://avatars.githubusercontent.com/u/13224356?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MikeHathaway",
      "html_url": "https://github.com/MikeHathaway",
      "followers_url": "https://api.github.com/users/MikeHathaway/followers",
      "following_url": "https://api.github.com/users/MikeHathaway/following{/other_user}",
      "gists_url": "https://api.github.com/users/MikeHathaway/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MikeHathaway/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MikeHathaway/subscriptions",
      "organizations_url": "https://api.github.com/users/MikeHathaway/orgs",
      "repos_url": "https://api.github.com/users/MikeHathaway/repos",
      "events_url": "https://api.github.com/users/MikeHathaway/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MikeHathaway/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-11-11T05:05:02Z",
    "updated_at": "2022-11-11T05:05:02Z",
    "author_association": "NONE",
    "body": "Thanks for the quick fix! I wasn't using a nightly release when I encountered the bug.",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1311234818/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
