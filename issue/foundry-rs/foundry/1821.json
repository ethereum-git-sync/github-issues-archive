{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/1821",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/1821/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/1821/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/1821/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/1821",
  "id": 1258320022,
  "node_id": "I_kwDOGBlvNc5LAHCW",
  "number": 1821,
  "title": "`forge script --broadcast` calls wrong contracts on identical redeployments",
  "user": {
    "login": "j-vp",
    "id": 104004836,
    "node_id": "U_kgDOBjL85A",
    "avatar_url": "https://avatars.githubusercontent.com/u/104004836?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/j-vp",
    "html_url": "https://github.com/j-vp",
    "followers_url": "https://api.github.com/users/j-vp/followers",
    "following_url": "https://api.github.com/users/j-vp/following{/other_user}",
    "gists_url": "https://api.github.com/users/j-vp/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/j-vp/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/j-vp/subscriptions",
    "organizations_url": "https://api.github.com/users/j-vp/orgs",
    "repos_url": "https://api.github.com/users/j-vp/repos",
    "events_url": "https://api.github.com/users/j-vp/events{/privacy}",
    "received_events_url": "https://api.github.com/users/j-vp/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3334394228,
      "node_id": "MDU6TGFiZWwzMzM0Mzk0MjI4",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-bug",
      "name": "T-bug",
      "color": "d73a4a",
      "default": false,
      "description": "Type: bug"
    },
    {
      "id": 3703752787,
      "node_id": "LA_kwDOGBlvNc7cwshT",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/C-forge",
      "name": "C-forge",
      "color": "5319E7",
      "default": false,
      "description": "Command: forge"
    },
    {
      "id": 4182991461,
      "node_id": "LA_kwDOGBlvNc75U2Jl",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/Cmd-forge-script",
      "name": "Cmd-forge-script",
      "color": "006B75",
      "default": false,
      "description": "Command: forge script"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "joshieDo",
    "id": 93316087,
    "node_id": "U_kgDOBY_j9w",
    "avatar_url": "https://avatars.githubusercontent.com/u/93316087?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/joshieDo",
    "html_url": "https://github.com/joshieDo",
    "followers_url": "https://api.github.com/users/joshieDo/followers",
    "following_url": "https://api.github.com/users/joshieDo/following{/other_user}",
    "gists_url": "https://api.github.com/users/joshieDo/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/joshieDo/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/joshieDo/subscriptions",
    "organizations_url": "https://api.github.com/users/joshieDo/orgs",
    "repos_url": "https://api.github.com/users/joshieDo/repos",
    "events_url": "https://api.github.com/users/joshieDo/events{/privacy}",
    "received_events_url": "https://api.github.com/users/joshieDo/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "joshieDo",
      "id": 93316087,
      "node_id": "U_kgDOBY_j9w",
      "avatar_url": "https://avatars.githubusercontent.com/u/93316087?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/joshieDo",
      "html_url": "https://github.com/joshieDo",
      "followers_url": "https://api.github.com/users/joshieDo/followers",
      "following_url": "https://api.github.com/users/joshieDo/following{/other_user}",
      "gists_url": "https://api.github.com/users/joshieDo/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/joshieDo/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/joshieDo/subscriptions",
      "organizations_url": "https://api.github.com/users/joshieDo/orgs",
      "repos_url": "https://api.github.com/users/joshieDo/repos",
      "events_url": "https://api.github.com/users/joshieDo/events{/privacy}",
      "received_events_url": "https://api.github.com/users/joshieDo/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2022-06-02T15:11:59Z",
  "updated_at": "2022-06-07T12:55:45Z",
  "closed_at": "2022-06-07T12:55:45Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Component\r\n\r\nForge\r\n\r\n### Have you ensured that all of these are up to date?\r\n\r\n- [X] Foundry\r\n- [X] Foundryup\r\n\r\n### What version of Foundry are you on?\r\n\r\nforge 0.2.0 (0342bc2 2022-06-02T12:05:16.9019022Z)\r\n\r\n### What command(s) is the bug in?\r\n\r\nforge script src/script/paperTradingCompetition/DeployScript.sol --rpc-url $rpcUrl -vvvv --broadcast --private-key $PrivKey\r\n\r\n### Operating System\r\n\r\nWindows\r\n\r\n### Describe the bug\r\n\r\nAs this is a bit of a weird one, I'll explain step by step what occurred.\r\n\r\nAt ~12h50 GMT, I ran \r\n\r\n`forge script src/script/paperTradingCompetition/DeployScript.sol --rpc-url $rpcUrl -vvvv --broadcast --private-key $PrivKey`\r\n\r\nWhich deploys a bunch of stuff. \r\n\r\nOne of the contracts it deployed was [0xE668567C7656a8efc761F7f0b274Ab690c5C681f](https://rinkeby.etherscan.io/address/0xe668567c7656a8efc761f7f0b274ab690c5c681f) at [tx 0x064766...6ef8](https://rinkeby.etherscan.io/tx/0x06476679833caabb94ec032850177ce1ada9927027d6844558aa5e3175d26ef8).\r\n\r\nSome broadcasting issues where encountered and #1816 was made.\r\nAs it was suggested to run --resume a few times, I redeployed everything again with the command \r\n`forge script src/script/paperTradingCompetition/DeployScript.sol --rpc-url $rpcUrl -vvvv --broadcast --private-key $PrivKey`\r\nThis was about 2 hours after the initial deploy.\r\n\r\nI noticed some transactions were failing (although the local simulation showed no issues). \r\n\r\nI saw that some contract from the previous deployment were called, where they shouldn't as a \"deployment session\" deploys everything from scratch without relying on any external contracts. All contracts related to such a deployment session are deployed within that session.\r\n\r\nFor example:\r\n[tx 0xfa49a...376f4](https://rinkeby.etherscan.io/tx/0xfa49a44a09628beec6696f1fb6f5b8d20d674e969c78a7e509b98e76b3b376f4) deploys contract [0x21de8...72e66](https://rinkeby.etherscan.io/address/0x21de829422bb4eb43dbefdecb4cfd4f364b72e66). The next call in my script is a 'setBaseUri', which is done in this transaction:\r\n[tx 0xd26b3...f6766f](https://rinkeby.etherscan.io/tx/0xd26b3e21a3b9093312f70d92dafe30668e887234a8cb56ebeb7e713b0bf6766f).\r\n\r\nNote that this last transaction calls the contract `0xE668567C7656a8efc761F7f0b274Ab690c5C681f` which was deployed in the previous deployment session!\r\n\r\nThe first two broadcasted transactions of the second deployment session are:\r\n![image](https://user-images.githubusercontent.com/104004836/171658811-21f3fded-be2f-4d17-9185-d4d3dbe4f7a2.png)\r\n\r\nThe first one is the call which deploys [0x21de829422bb4eb43dbefdecb4cfd4f364b72e66](https://rinkeby.etherscan.io/address/0x21de829422bb4eb43dbefdecb4cfd4f364b72e66), the second call should call that newly deployed contract. Instead, it thus calls a previously deployed contract which shouldn't have anything to do with the new deployment session.\r\n\r\nThe above is just one example, by the amount of failing transactions, I assume this happens a lot:\r\n\r\n![image](https://user-images.githubusercontent.com/104004836/171659734-fe0414b7-bb14-428a-85c0-10e5fb2afd38.png)\r\n\r\nAnother pair of \"contract deployed and then wrong contract called\" would be\r\n[tx 0x472a07933efd...7731250e](https://rinkeby.etherscan.io/tx/0x472a07933efdf0bca06549ed8ec3c1c355b2ab1ed398ab5bf20dcb467731250e) +\r\n[tx 0x6999e3d89c62...d3853f](https://rinkeby.etherscan.io/tx/0x6999e3d89c6245b9f325c6bc22ce92efdbbd086ed07aa928003ea25415d3853f\r\n) (wrongfully calls the old contract `0x7a3d1be7cdec74802c6cb79792e56845b97ebb1b` whereas it should be calling the newly deployed contract `0xc1F3e61Fc403021D994eac910eFA03dc2D652684`)\r\n\r\nI also notice that it sometimes calls a EOA instead of the supposed contract it should be calling. For example:\r\n[https://rinkeby.etherscan.io/tx/0xca3d77d927a485f5a6be697817d40a8d2ed742279c47106c1c595eaa882b06a6](https://rinkeby.etherscan.io/tx/0xca3d77d927a485f5a6be697817d40a8d2ed742279c47106c1c595eaa882b06a6)\r\n[https://rinkeby.etherscan.io/tx/0x8888cc0ae37c86f3d284304c4000ff9c2ec59933b7541aa65d77e1d2b2a7f092](https://rinkeby.etherscan.io/tx/0x8888cc0ae37c86f3d284304c4000ff9c2ec59933b7541aa65d77e1d2b2a7f092)\r\n[https://rinkeby.etherscan.io/tx/0x5bcf7750cbdc7ad431e0d0056be12a30e68fce294f98e9e173deb48a84dba396](https://rinkeby.etherscan.io/tx/0x5bcf7750cbdc7ad431e0d0056be12a30e68fce294f98e9e173deb48a84dba396)\r\n\r\nand essentially any call decoded as `Transfer*` at [https://rinkeby.etherscan.io/txs?a=0x362e058e129e4b7c4c8b161d3c121661de1c9d07&ps=100&p=3](https://rinkeby.etherscan.io/txs?a=0x362e058e129e4b7c4c8b161d3c121661de1c9d07&ps=100&p=3)\r\n\r\n\r\n",
  "closed_by": {
    "login": "j-vp",
    "id": 104004836,
    "node_id": "U_kgDOBjL85A",
    "avatar_url": "https://avatars.githubusercontent.com/u/104004836?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/j-vp",
    "html_url": "https://github.com/j-vp",
    "followers_url": "https://api.github.com/users/j-vp/followers",
    "following_url": "https://api.github.com/users/j-vp/following{/other_user}",
    "gists_url": "https://api.github.com/users/j-vp/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/j-vp/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/j-vp/subscriptions",
    "organizations_url": "https://api.github.com/users/j-vp/orgs",
    "repos_url": "https://api.github.com/users/j-vp/repos",
    "events_url": "https://api.github.com/users/j-vp/events{/privacy}",
    "received_events_url": "https://api.github.com/users/j-vp/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/1821/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/1821/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1148630797",
    "html_url": "https://github.com/foundry-rs/foundry/issues/1821#issuecomment-1148630797",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/1821",
    "id": 1148630797,
    "node_id": "IC_kwDOGBlvNc5EdrcN",
    "user": {
      "login": "j-vp",
      "id": 104004836,
      "node_id": "U_kgDOBjL85A",
      "avatar_url": "https://avatars.githubusercontent.com/u/104004836?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/j-vp",
      "html_url": "https://github.com/j-vp",
      "followers_url": "https://api.github.com/users/j-vp/followers",
      "following_url": "https://api.github.com/users/j-vp/following{/other_user}",
      "gists_url": "https://api.github.com/users/j-vp/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/j-vp/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/j-vp/subscriptions",
      "organizations_url": "https://api.github.com/users/j-vp/orgs",
      "repos_url": "https://api.github.com/users/j-vp/repos",
      "events_url": "https://api.github.com/users/j-vp/events{/privacy}",
      "received_events_url": "https://api.github.com/users/j-vp/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-06-07T12:55:45Z",
    "updated_at": "2022-06-07T12:55:45Z",
    "author_association": "NONE",
    "body": "Fixed by #1824. Root cause were txes with high nonces of previous deployments that were already in the mempool but not confirmed due to gaps in txes with lower nonces. As soon as new txes with the missing nonces were broadcasted, the old, pending txes got confirmed which seemed to mess up the contract addresses.",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1148630797/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
