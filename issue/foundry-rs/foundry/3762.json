{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/3762",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3762/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3762/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3762/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/3762",
  "id": 1463207253,
  "node_id": "I_kwDOGBlvNc5XNsVV",
  "number": 3762,
  "title": "`anvil` fork: base fee from `eth_feeHistory` is inconsistent with block base fee after executing transaction",
  "user": {
    "login": "lekhovitsky",
    "id": 19476174,
    "node_id": "MDQ6VXNlcjE5NDc2MTc0",
    "avatar_url": "https://avatars.githubusercontent.com/u/19476174?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/lekhovitsky",
    "html_url": "https://github.com/lekhovitsky",
    "followers_url": "https://api.github.com/users/lekhovitsky/followers",
    "following_url": "https://api.github.com/users/lekhovitsky/following{/other_user}",
    "gists_url": "https://api.github.com/users/lekhovitsky/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/lekhovitsky/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/lekhovitsky/subscriptions",
    "organizations_url": "https://api.github.com/users/lekhovitsky/orgs",
    "repos_url": "https://api.github.com/users/lekhovitsky/repos",
    "events_url": "https://api.github.com/users/lekhovitsky/events{/privacy}",
    "received_events_url": "https://api.github.com/users/lekhovitsky/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3334394228,
      "node_id": "MDU6TGFiZWwzMzM0Mzk0MjI4",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-bug",
      "name": "T-bug",
      "color": "d73a4a",
      "default": false,
      "description": "Type: bug"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 6,
  "created_at": "2022-11-24T11:34:50Z",
  "updated_at": "2022-12-03T08:40:13Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "### Component\r\n\r\nAnvil\r\n\r\n### Have you ensured that all of these are up to date?\r\n\r\n- [X] Foundry\r\n- [X] Foundryup\r\n\r\n### What version of Foundry are you on?\r\n\r\nforge 0.2.0 (8e7e0be 2022-11-24T00:13:02.397364Z)\r\n\r\n### What command(s) is the bug in?\r\n\r\n_No response_\r\n\r\n### Operating System\r\n\r\nmacOS (Apple Silicon)\r\n\r\n### Describe the bug\r\n\r\nFork the mainnet:\r\n```bash\r\nanvil --fork-url <MAINNET_RPC_URL> --fork-block-number 16000000 --accounts 1\r\n```\r\n\r\nRetrieve base fee directly and via `eth_feeHistory` call:\r\n```bash\r\ncast block-number # 16000000\r\ncast basefee # 11130414489\r\ncast rpc eth_feeHistory '[1, \"latest\", []]' --raw # {\"baseFeePerGas\":[\"0x2976ca599\",\"0x2ad7f734b\"], ...} \r\ncast to-base 0x2976ca599 10 # 11130414489\r\n```\r\nWe see that they are consistent now.\r\n\r\nNow, let's execute arbitrary transaction:\r\n```bash\r\ncast send 0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266 --value 1 \\\r\n    --private-key 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80\r\n```\r\n\r\nLet's check base fees again:\r\n```bash\r\ncast block-number # 16000001\r\ncast basefee # 11500745547\r\ncast rpc eth_feeHistory '[1, \"latest\", []]' --raw # {\"baseFeePerGas\":[\"0x257ee3ab8\",\"0x20d0b53dc\"], ...}\r\ncast to-base 0x257ee3ab8 10 # 10065164984\r\n```\r\n\r\nNumbers are no longer consistent: output from `basefee` command is exactly the base fee of mainnet block [`16000001`](https://etherscan.io/block/16000001), while output from `eth_feeHistory` seems to be the actual result of base fee calculation for a new block containing only a single transaction that we sent.\r\n\r\nThe unfortunate consequence is that if gas price oracle relies on `eth_feeHistory`, we might send underpriced transactions (which happened to me).\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/3762/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3762/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1326382843",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3762#issuecomment-1326382843",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3762",
    "id": 1326382843,
    "node_id": "IC_kwDOGBlvNc5PDv77",
    "user": {
      "login": "mattsse",
      "id": 19890894,
      "node_id": "MDQ6VXNlcjE5ODkwODk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/19890894?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mattsse",
      "html_url": "https://github.com/mattsse",
      "followers_url": "https://api.github.com/users/mattsse/followers",
      "following_url": "https://api.github.com/users/mattsse/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattsse/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mattsse/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattsse/subscriptions",
      "organizations_url": "https://api.github.com/users/mattsse/orgs",
      "repos_url": "https://api.github.com/users/mattsse/repos",
      "events_url": "https://api.github.com/users/mattsse/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mattsse/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-11-24T12:26:54Z",
    "updated_at": "2022-11-24T12:26:54Z",
    "author_association": "MEMBER",
    "body": "perhaps there's a off-by-one error since `10065164984` is `cast basefee --block pending`?\r\n\r\nTbh I'm having a hard time to make sense of the `eth_feeHistory` [docs](https://ethereum.github.io/execution-apis/api-documentation/)\r\n\r\n> BASEFEEPERGAS: An array of block base costs for each gas. This includes returning the next block after the latest block in the range, as this value can be derived from the latest block. \r\n",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1326382843/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1327742584",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3762#issuecomment-1327742584",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3762",
    "id": 1327742584,
    "node_id": "IC_kwDOGBlvNc5PI754",
    "user": {
      "login": "lekhovitsky",
      "id": 19476174,
      "node_id": "MDQ6VXNlcjE5NDc2MTc0",
      "avatar_url": "https://avatars.githubusercontent.com/u/19476174?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/lekhovitsky",
      "html_url": "https://github.com/lekhovitsky",
      "followers_url": "https://api.github.com/users/lekhovitsky/followers",
      "following_url": "https://api.github.com/users/lekhovitsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/lekhovitsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/lekhovitsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/lekhovitsky/subscriptions",
      "organizations_url": "https://api.github.com/users/lekhovitsky/orgs",
      "repos_url": "https://api.github.com/users/lekhovitsky/repos",
      "events_url": "https://api.github.com/users/lekhovitsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/lekhovitsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-11-25T17:40:41Z",
    "updated_at": "2022-11-25T17:40:50Z",
    "author_association": "NONE",
    "body": "In `eth_feeHistory`, `baseFeePerGas` is an array of base fees for each block in requested range (determined by `blockCount` and `newestBlock` params) as well as of the next block after `newestBlock`, which is a function of `baseFee` and `gasUsedRatio` of the latter:\r\n\r\n$$\r\n\\text{base fee}_{n+1} = \\text{base fee}_n \\left( 1 + 0.125  \\cdot \\frac{\\text{ratio}_n - 0.5}{0.5} \\right)\r\n$$\r\n\r\nI believe `cast basefee` is completely correct:\r\n* in the block 16000001 base fee is known to be `11500745547`\r\n* in the `pending` block, by the formula above with $\\text{base fee}_n$ equal to `11500745547` and $\\text{ratio}_n$ equal to `0.0007` (21K gas of our transfer tx / 30M block gas limit), it is precisely `10065164984`\r\n \r\nSo must be something with `eth_feeHistory` implementation.\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1327742584/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1327744912",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3762#issuecomment-1327744912",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3762",
    "id": 1327744912,
    "node_id": "IC_kwDOGBlvNc5PI8eQ",
    "user": {
      "login": "lekhovitsky",
      "id": 19476174,
      "node_id": "MDQ6VXNlcjE5NDc2MTc0",
      "avatar_url": "https://avatars.githubusercontent.com/u/19476174?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/lekhovitsky",
      "html_url": "https://github.com/lekhovitsky",
      "followers_url": "https://api.github.com/users/lekhovitsky/followers",
      "following_url": "https://api.github.com/users/lekhovitsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/lekhovitsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/lekhovitsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/lekhovitsky/subscriptions",
      "organizations_url": "https://api.github.com/users/lekhovitsky/orgs",
      "repos_url": "https://api.github.com/users/lekhovitsky/repos",
      "events_url": "https://api.github.com/users/lekhovitsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/lekhovitsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-11-25T17:45:14Z",
    "updated_at": "2022-11-25T17:45:14Z",
    "author_association": "NONE",
    "body": "Not sure if helpful, but I've just discovered one more thing it does not as expected:\r\n\r\n(run Anvil as before)\r\n\r\n```bash\r\n# call eth_feeHistory for 3 blocks -- notice 4 values in baseFeePerGas\r\ncast rpc eth_feeHistory '[3, \"latest\", []]' --raw # {\"baseFeePerGas\":[\"0x2c93e3533\",\"0x2a1e15147\",\"0x2976ca599\",\"0x2ad7f734b\"], ...}\r\n\r\n# execute a tx\r\ncast send 0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266 --value 1 \\\r\n    --private-key 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80\r\n\r\n# call eth_feeHistory for 3 blocks again -- this time, only 2 values\r\ncast rpc eth_feeHistory '[3, \"latest\", []]' --raw # {\"baseFeePerGas\":[\"0x257ee3ab8\",\"0x20d0b53dc\"], ...}",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1327744912/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1333466985",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3762#issuecomment-1333466985",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3762",
    "id": 1333466985,
    "node_id": "IC_kwDOGBlvNc5Pexdp",
    "user": {
      "login": "lekhovitsky",
      "id": 19476174,
      "node_id": "MDQ6VXNlcjE5NDc2MTc0",
      "avatar_url": "https://avatars.githubusercontent.com/u/19476174?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/lekhovitsky",
      "html_url": "https://github.com/lekhovitsky",
      "followers_url": "https://api.github.com/users/lekhovitsky/followers",
      "following_url": "https://api.github.com/users/lekhovitsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/lekhovitsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/lekhovitsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/lekhovitsky/subscriptions",
      "organizations_url": "https://api.github.com/users/lekhovitsky/orgs",
      "repos_url": "https://api.github.com/users/lekhovitsky/repos",
      "events_url": "https://api.github.com/users/lekhovitsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/lekhovitsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-01T09:22:08Z",
    "updated_at": "2022-12-01T09:22:08Z",
    "author_association": "NONE",
    "body": "Examined how `eth_feeHistory` is [implemented](https://github.com/foundry-rs/foundry/blob/9bd079964cd0bad0ac52be89ab1587218d86ade1/anvil/src/eth/api.rs#L1056) in Anvil.\r\n\r\nWhen forking, `fee_history` output is either the result of fork's `eth_feeHistory` if `newestBlock <= forkBlock`, or the result of computation based on fee history cache (which in the example above is made of a single tx) otherwise.\r\n\r\nThis behaviour breaks if `oldestBlock <= forkBlock <= newestBlock`, and in this case an ideal behavior would be to \"concat\" the results of fork's fee history for blocks `oldestBlock..forkBlock` and cache-based calculations for the rest.",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1333466985/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1334195561",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3762#issuecomment-1334195561",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3762",
    "id": 1334195561,
    "node_id": "IC_kwDOGBlvNc5PhjVp",
    "user": {
      "login": "mattsse",
      "id": 19890894,
      "node_id": "MDQ6VXNlcjE5ODkwODk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/19890894?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mattsse",
      "html_url": "https://github.com/mattsse",
      "followers_url": "https://api.github.com/users/mattsse/followers",
      "following_url": "https://api.github.com/users/mattsse/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattsse/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mattsse/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattsse/subscriptions",
      "organizations_url": "https://api.github.com/users/mattsse/orgs",
      "repos_url": "https://api.github.com/users/mattsse/repos",
      "events_url": "https://api.github.com/users/mattsse/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mattsse/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-01T18:45:19Z",
    "updated_at": "2022-12-01T18:45:19Z",
    "author_association": "MEMBER",
    "body": "> This behaviour breaks if oldestBlock <= forkBlock <= newestBlock, and in this case an ideal behavior would be to \"concat\" the results of fork's fee history for blocks oldestBlock..forkBlock and cache-based calculations for the rest.\r\n\r\nthis sounds right, I guess this could be fixed by requesting the missing entries.\r\n\r\n> When forking, fee_history output is either the result of fork's eth_feeHistory if newestBlock <= forkBlock, or the result of computation based on fee history cache (which in the example above is made of a single tx) otherwise.\r\n\r\nthis is how it's implemented. But what's wrong?",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1334195561/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1336114953",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3762#issuecomment-1336114953",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3762",
    "id": 1336114953,
    "node_id": "IC_kwDOGBlvNc5Po38J",
    "user": {
      "login": "lekhovitsky",
      "id": 19476174,
      "node_id": "MDQ6VXNlcjE5NDc2MTc0",
      "avatar_url": "https://avatars.githubusercontent.com/u/19476174?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/lekhovitsky",
      "html_url": "https://github.com/lekhovitsky",
      "followers_url": "https://api.github.com/users/lekhovitsky/followers",
      "following_url": "https://api.github.com/users/lekhovitsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/lekhovitsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/lekhovitsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/lekhovitsky/subscriptions",
      "organizations_url": "https://api.github.com/users/lekhovitsky/orgs",
      "repos_url": "https://api.github.com/users/lekhovitsky/repos",
      "events_url": "https://api.github.com/users/lekhovitsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/lekhovitsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-03T08:39:52Z",
    "updated_at": "2022-12-03T08:40:13Z",
    "author_association": "NONE",
    "body": "> But what's wrong?\r\n\r\nPre-fork, everything is correct. Post-fork, the problem is that the function considers _only_ fee history cache, which is formed purely from transactions sent to the Anvil node, and is thus unaware of any fee history data from the forked chain. So when the requested range happens to contain both pre-fork and post-fork blocks, the result is wrong simply by not having all the input data needed for computation.\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1336114953/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
