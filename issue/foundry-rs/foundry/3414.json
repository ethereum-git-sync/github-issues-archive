{
  "url": "https://api.github.com/repos/foundry-rs/foundry/issues/3414",
  "repository_url": "https://api.github.com/repos/foundry-rs/foundry",
  "labels_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3414/labels{/name}",
  "comments_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3414/comments",
  "events_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3414/events",
  "html_url": "https://github.com/foundry-rs/foundry/issues/3414",
  "id": 1390982458,
  "node_id": "I_kwDOGBlvNc5S6LU6",
  "number": 3414,
  "title": "Anvil subprocess hangs with RUST_LOG=node::user=info",
  "user": {
    "login": "jaeaster",
    "id": 8033921,
    "node_id": "MDQ6VXNlcjgwMzM5MjE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/8033921?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jaeaster",
    "html_url": "https://github.com/jaeaster",
    "followers_url": "https://api.github.com/users/jaeaster/followers",
    "following_url": "https://api.github.com/users/jaeaster/following{/other_user}",
    "gists_url": "https://api.github.com/users/jaeaster/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jaeaster/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jaeaster/subscriptions",
    "organizations_url": "https://api.github.com/users/jaeaster/orgs",
    "repos_url": "https://api.github.com/users/jaeaster/repos",
    "events_url": "https://api.github.com/users/jaeaster/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jaeaster/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 3334394228,
      "node_id": "MDU6TGFiZWwzMzM0Mzk0MjI4",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/T-bug",
      "name": "T-bug",
      "color": "d73a4a",
      "default": false,
      "description": "Type: bug"
    },
    {
      "id": 4077188949,
      "node_id": "LA_kwDOGBlvNc7zBPdV",
      "url": "https://api.github.com/repos/foundry-rs/foundry/labels/C-anvil",
      "name": "C-anvil",
      "color": "5319E7",
      "default": false,
      "description": "Command: anvil"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2022-09-29T14:33:24Z",
  "updated_at": "2022-09-30T18:21:38Z",
  "closed_at": "2022-09-30T18:21:38Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "### Component\n\nAnvil\n\n### Have you ensured that all of these are up to date?\n\n- [X] Foundry\n- [X] Foundryup\n\n### What version of Foundry are you on?\n\nforge 0.2.0 (d707ebe 2022-09-29T00:13:28.610248Z)\n\n### What command(s) is the bug in?\n\n_No response_\n\n### Operating System\n\nmacOS (Apple Silicon)\n\n### Describe the bug\n\nI have a test which spawns an anvil process using ethers-rs and makes many concurrent rpc calls.\r\n\r\nThe test runs for a couple seconds and then inevitably hangs while awaiting an RPC call. The call could be a simple read of blockchain state or it could be sending a transaction. Here's an example log line from ethers-rs that is the last thing printed before the program hangs; in other words, I've confirmed that my program always hangs just before making an RPC call\r\n```\r\n[DEBUG ethers_providers::pending_transaction] Starting to poll pending tx [REDACTED]\r\n```\r\n\r\nIt reliably hangs when I enable RUST_LOG=node::user=info, but setting node::user=warn causes the test to run perfectly fine.\r\n\r\ne.g.\r\nDEADLOCK ==> `RUST_LOG=info,node::user=info cargo test`\r\n\r\nPASSES ==> `RUST_LOG=info,node::user=warn cargo test`\r\n\r\nI have two guesses as to the source of deadlock in anvil:\r\n1. locking related to the tracing logger\r\nrelevant code: https://github.com/foundry-rs/foundry/blob/master/anvil/src/logging.rs#L35\r\n\r\n2. anvil child process stdout buffer becomes full and writing logs to stdout blocks\r\nrelevant code: https://github.com/gakonst/ethers-rs/blob/master/ethers-core/src/utils/anvil.rs#L287\r\n\r\nHappy to provide more context if needed.",
  "closed_by": {
    "login": "mattsse",
    "id": 19890894,
    "node_id": "MDQ6VXNlcjE5ODkwODk0",
    "avatar_url": "https://avatars.githubusercontent.com/u/19890894?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mattsse",
    "html_url": "https://github.com/mattsse",
    "followers_url": "https://api.github.com/users/mattsse/followers",
    "following_url": "https://api.github.com/users/mattsse/following{/other_user}",
    "gists_url": "https://api.github.com/users/mattsse/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mattsse/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mattsse/subscriptions",
    "organizations_url": "https://api.github.com/users/mattsse/orgs",
    "repos_url": "https://api.github.com/users/mattsse/repos",
    "events_url": "https://api.github.com/users/mattsse/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mattsse/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/3414/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3414/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1262393664",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3414#issuecomment-1262393664",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3414",
    "id": 1262393664,
    "node_id": "IC_kwDOGBlvNc5LPplA",
    "user": {
      "login": "jaeaster",
      "id": 8033921,
      "node_id": "MDQ6VXNlcjgwMzM5MjE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8033921?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jaeaster",
      "html_url": "https://github.com/jaeaster",
      "followers_url": "https://api.github.com/users/jaeaster/followers",
      "following_url": "https://api.github.com/users/jaeaster/following{/other_user}",
      "gists_url": "https://api.github.com/users/jaeaster/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jaeaster/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jaeaster/subscriptions",
      "organizations_url": "https://api.github.com/users/jaeaster/orgs",
      "repos_url": "https://api.github.com/users/jaeaster/repos",
      "events_url": "https://api.github.com/users/jaeaster/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jaeaster/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-29T14:49:13Z",
    "updated_at": "2022-09-29T14:50:37Z",
    "author_association": "CONTRIBUTOR",
    "body": "Related to\r\n> anvil child process stdout buffer becomes full and writing logs to stdout blocks\r\n\r\nThe docs for Stdio::piped() say:\r\n> Writing more than a pipe buffer’s worth of input to stdin without also reading stdout and stderr at the same time may cause a deadlock. This is an issue when running any program that doesn’t guarantee that it reads its entire stdin before writing more than a pipe buffer’s worth of output. The size of a pipe buffer varies on different targets.\r\n\r\nhttps://doc.rust-lang.org/std/process/struct.Stdio.html#method.piped\r\n\r\nRelevant code: https://github.com/gakonst/ethers-rs/blob/master/ethers-core/src/utils/anvil.rs#L225\r\n\r\nEDIT: So maybe we need to use `Stdio::null()` to redirect stdout to /dev/null\r\nhttps://doc.rust-lang.org/std/process/struct.Stdio.html#method.null",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1262393664/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1262699904",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3414#issuecomment-1262699904",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3414",
    "id": 1262699904,
    "node_id": "IC_kwDOGBlvNc5LQ0WA",
    "user": {
      "login": "mattsse",
      "id": 19890894,
      "node_id": "MDQ6VXNlcjE5ODkwODk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/19890894?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mattsse",
      "html_url": "https://github.com/mattsse",
      "followers_url": "https://api.github.com/users/mattsse/followers",
      "following_url": "https://api.github.com/users/mattsse/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattsse/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mattsse/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattsse/subscriptions",
      "organizations_url": "https://api.github.com/users/mattsse/orgs",
      "repos_url": "https://api.github.com/users/mattsse/repos",
      "events_url": "https://api.github.com/users/mattsse/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mattsse/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-29T19:06:57Z",
    "updated_at": "2022-09-29T19:07:34Z",
    "author_association": "MEMBER",
    "body": "> Writing more than a pipe buffer’s worth of input to stdin without also reading stdout and stderr at the same time may cause a deadlock. This is an issue when running any program that doesn’t guarantee that it reads its entire stdin before writing more than a pipe buffer’s worth of output. The size of a pipe buffer varies on different targets.\r\n\r\nthis shouldn't be relevant since there's no stdin here.\r\n\r\ncan't use stdio::null because we need to parse the keys.\r\n\r\nwe keep the stdout handle even if we don't need it, so perhaps this is causing the issue if anvil itself logs to sdout, stderr seems to be fine (warn level).\r\n\r\nthis is an ethers-rs issue and unrelated to anvil itself.\r\n\r\ncould you perhaps try after dropping this (removing the field)\r\nhttps://github.com/gakonst/ethers-rs/blob/master/ethers-core/src/utils/anvil.rs#L287\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1262699904/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1263864254",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3414#issuecomment-1263864254",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3414",
    "id": 1263864254,
    "node_id": "IC_kwDOGBlvNc5LVQm-",
    "user": {
      "login": "jaeaster",
      "id": 8033921,
      "node_id": "MDQ6VXNlcjgwMzM5MjE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8033921?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jaeaster",
      "html_url": "https://github.com/jaeaster",
      "followers_url": "https://api.github.com/users/jaeaster/followers",
      "following_url": "https://api.github.com/users/jaeaster/following{/other_user}",
      "gists_url": "https://api.github.com/users/jaeaster/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jaeaster/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jaeaster/subscriptions",
      "organizations_url": "https://api.github.com/users/jaeaster/orgs",
      "repos_url": "https://api.github.com/users/jaeaster/repos",
      "events_url": "https://api.github.com/users/jaeaster/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jaeaster/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-30T18:01:18Z",
    "updated_at": "2022-09-30T18:01:18Z",
    "author_association": "CONTRIBUTOR",
    "body": "Yeah that fixes it - will move to ethers-rs repo",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1263864254/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1263882535",
    "html_url": "https://github.com/foundry-rs/foundry/issues/3414#issuecomment-1263882535",
    "issue_url": "https://api.github.com/repos/foundry-rs/foundry/issues/3414",
    "id": 1263882535,
    "node_id": "IC_kwDOGBlvNc5LVVEn",
    "user": {
      "login": "mattsse",
      "id": 19890894,
      "node_id": "MDQ6VXNlcjE5ODkwODk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/19890894?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mattsse",
      "html_url": "https://github.com/mattsse",
      "followers_url": "https://api.github.com/users/mattsse/followers",
      "following_url": "https://api.github.com/users/mattsse/following{/other_user}",
      "gists_url": "https://api.github.com/users/mattsse/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mattsse/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mattsse/subscriptions",
      "organizations_url": "https://api.github.com/users/mattsse/orgs",
      "repos_url": "https://api.github.com/users/mattsse/repos",
      "events_url": "https://api.github.com/users/mattsse/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mattsse/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-09-30T18:21:38Z",
    "updated_at": "2022-09-30T18:21:38Z",
    "author_association": "MEMBER",
    "body": "closing here",
    "reactions": {
      "url": "https://api.github.com/repos/foundry-rs/foundry/issues/comments/1263882535/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
