{
  "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/4943",
  "repository_url": "https://api.github.com/repos/NethermindEth/nethermind",
  "labels_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/4943/labels{/name}",
  "comments_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/4943/comments",
  "events_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/4943/events",
  "html_url": "https://github.com/NethermindEth/nethermind/issues/4943",
  "id": 1466649128,
  "node_id": "I_kwDOBggaLc5Xa0oo",
  "number": 4943,
  "title": "Node under heavy JSON-RPC load reports incorrect height from metric module",
  "user": {
    "login": "nicexe",
    "id": 867535,
    "node_id": "MDQ6VXNlcjg2NzUzNQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/867535?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/nicexe",
    "html_url": "https://github.com/nicexe",
    "followers_url": "https://api.github.com/users/nicexe/followers",
    "following_url": "https://api.github.com/users/nicexe/following{/other_user}",
    "gists_url": "https://api.github.com/users/nicexe/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/nicexe/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/nicexe/subscriptions",
    "organizations_url": "https://api.github.com/users/nicexe/orgs",
    "repos_url": "https://api.github.com/users/nicexe/repos",
    "events_url": "https://api.github.com/users/nicexe/events{/privacy}",
    "received_events_url": "https://api.github.com/users/nicexe/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "asdacap",
    "id": 1841324,
    "node_id": "MDQ6VXNlcjE4NDEzMjQ=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1841324?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/asdacap",
    "html_url": "https://github.com/asdacap",
    "followers_url": "https://api.github.com/users/asdacap/followers",
    "following_url": "https://api.github.com/users/asdacap/following{/other_user}",
    "gists_url": "https://api.github.com/users/asdacap/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/asdacap/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/asdacap/subscriptions",
    "organizations_url": "https://api.github.com/users/asdacap/orgs",
    "repos_url": "https://api.github.com/users/asdacap/repos",
    "events_url": "https://api.github.com/users/asdacap/events{/privacy}",
    "received_events_url": "https://api.github.com/users/asdacap/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "asdacap",
      "id": 1841324,
      "node_id": "MDQ6VXNlcjE4NDEzMjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1841324?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/asdacap",
      "html_url": "https://github.com/asdacap",
      "followers_url": "https://api.github.com/users/asdacap/followers",
      "following_url": "https://api.github.com/users/asdacap/following{/other_user}",
      "gists_url": "https://api.github.com/users/asdacap/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/asdacap/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/asdacap/subscriptions",
      "organizations_url": "https://api.github.com/users/asdacap/orgs",
      "repos_url": "https://api.github.com/users/asdacap/repos",
      "events_url": "https://api.github.com/users/asdacap/events{/privacy}",
      "received_events_url": "https://api.github.com/users/asdacap/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2022-11-28T15:43:44Z",
  "updated_at": "2022-12-09T07:03:48Z",
  "closed_at": "2022-12-09T07:03:48Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "**Describe the bug**\r\nWhen a node receives a heavy JSON-RPC load (using lots of `trace_call` or `trace_rawTransaction` for example) it reports wrong block heights from metrics.\r\n\r\n**To Reproduce**\r\nSteps to reproduce the behavior:\r\n1. Fully sync an archive node for an AuRa chain (like Gnosis Chain)\r\n2. Set up blockscout to use the archive node's RPC (no WS)\r\n3. Observe node height on Grafana\r\n4. Compare with imported blocks reported in the node's logs\r\n\r\n**Expected behavior**\r\nGrafana should show the latest imported block (matching with the node's logs)\r\n\r\n**Screenshots**\r\n![image](https://user-images.githubusercontent.com/867535/204319301-5e59976d-71a3-4d63-9c36-758f5cf7753b.png)\r\nOn the left side is when blockscout starts indexing the blockchain where the height reported by the metrics module immediately drops to about 450000.\r\nOn the right side it looks like the height reported by the metrics module reached some kind of a tri-stable equilibrium.\r\n\r\n**Desktop (please complete the following information):**\r\n - OS: Ubuntu 22.04 (dockerized)\r\n - Image: [nethermind/nethermind:1.14.6](https://hub.docker.com/layers/nethermind/nethermind/1.14.6/images/sha256-f908e36cd213337c865f2012950810cef5b3787c698928017617d676ca80b9e3?context=explore) (same behavior is also seen on 1.13.x)\r\n",
  "closed_by": {
    "login": "asdacap",
    "id": 1841324,
    "node_id": "MDQ6VXNlcjE4NDEzMjQ=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1841324?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/asdacap",
    "html_url": "https://github.com/asdacap",
    "followers_url": "https://api.github.com/users/asdacap/followers",
    "following_url": "https://api.github.com/users/asdacap/following{/other_user}",
    "gists_url": "https://api.github.com/users/asdacap/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/asdacap/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/asdacap/subscriptions",
    "organizations_url": "https://api.github.com/users/asdacap/orgs",
    "repos_url": "https://api.github.com/users/asdacap/repos",
    "events_url": "https://api.github.com/users/asdacap/events{/privacy}",
    "received_events_url": "https://api.github.com/users/asdacap/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/4943/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/4943/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/1330264069",
    "html_url": "https://github.com/NethermindEth/nethermind/issues/4943#issuecomment-1330264069",
    "issue_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/4943",
    "id": 1330264069,
    "node_id": "IC_kwDOBggaLc5PSjgF",
    "user": {
      "login": "nicexe",
      "id": 867535,
      "node_id": "MDQ6VXNlcjg2NzUzNQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/867535?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nicexe",
      "html_url": "https://github.com/nicexe",
      "followers_url": "https://api.github.com/users/nicexe/followers",
      "following_url": "https://api.github.com/users/nicexe/following{/other_user}",
      "gists_url": "https://api.github.com/users/nicexe/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nicexe/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nicexe/subscriptions",
      "organizations_url": "https://api.github.com/users/nicexe/orgs",
      "repos_url": "https://api.github.com/users/nicexe/repos",
      "events_url": "https://api.github.com/users/nicexe/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nicexe/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-11-29T08:30:35Z",
    "updated_at": "2022-11-29T08:30:35Z",
    "author_association": "NONE",
    "body": "stopping blockscout makes the height graph jump back to the actual height but when blockscout is started again, it drops down, slowly rises and then it fluctuates around certain heights just like seen in the screenshot above.",
    "reactions": {
      "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/1330264069/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/1330407033",
    "html_url": "https://github.com/NethermindEth/nethermind/issues/4943#issuecomment-1330407033",
    "issue_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/4943",
    "id": 1330407033,
    "node_id": "IC_kwDOBggaLc5PTGZ5",
    "user": {
      "login": "nicexe",
      "id": 867535,
      "node_id": "MDQ6VXNlcjg2NzUzNQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/867535?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nicexe",
      "html_url": "https://github.com/nicexe",
      "followers_url": "https://api.github.com/users/nicexe/followers",
      "following_url": "https://api.github.com/users/nicexe/following{/other_user}",
      "gists_url": "https://api.github.com/users/nicexe/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nicexe/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nicexe/subscriptions",
      "organizations_url": "https://api.github.com/users/nicexe/orgs",
      "repos_url": "https://api.github.com/users/nicexe/repos",
      "events_url": "https://api.github.com/users/nicexe/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nicexe/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-11-29T10:23:52Z",
    "updated_at": "2022-11-29T10:23:52Z",
    "author_association": "NONE",
    "body": "![image](https://user-images.githubusercontent.com/867535/204503863-633f1b10-4d87-42e4-bb85-cb5cae545403.png)\r\n![image](https://user-images.githubusercontent.com/867535/204504090-3d0e811b-2c02-4979-ba0a-10ae07d728ae.png)\r\n\r\nblue dashed line denotes roughly when blockscout was restarted",
    "reactions": {
      "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/1330407033/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/1333368775",
    "html_url": "https://github.com/NethermindEth/nethermind/issues/4943#issuecomment-1333368775",
    "issue_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/4943",
    "id": 1333368775,
    "node_id": "IC_kwDOBggaLc5PeZfH",
    "user": {
      "login": "asdacap",
      "id": 1841324,
      "node_id": "MDQ6VXNlcjE4NDEzMjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1841324?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/asdacap",
      "html_url": "https://github.com/asdacap",
      "followers_url": "https://api.github.com/users/asdacap/followers",
      "following_url": "https://api.github.com/users/asdacap/following{/other_user}",
      "gists_url": "https://api.github.com/users/asdacap/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/asdacap/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/asdacap/subscriptions",
      "organizations_url": "https://api.github.com/users/asdacap/orgs",
      "repos_url": "https://api.github.com/users/asdacap/repos",
      "events_url": "https://api.github.com/users/asdacap/events{/privacy}",
      "received_events_url": "https://api.github.com/users/asdacap/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-01T08:06:48Z",
    "updated_at": "2022-12-01T08:06:48Z",
    "author_association": "CONTRIBUTOR",
    "body": "Hmm.. run `RunProcessingLoop` has `UpdateStats` and `BlockchainProcessor.Process` also have `UpdateStats` but wrapper around `!notReadOnlyChain`. I'm guessing the later is the right one? As this issue is likely due to the first `UpdateStats` which is probably triggered during trace calls.",
    "reactions": {
      "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/1333368775/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/1336962576",
    "html_url": "https://github.com/NethermindEth/nethermind/issues/4943#issuecomment-1336962576",
    "issue_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/4943",
    "id": 1336962576,
    "node_id": "IC_kwDOBggaLc5PsG4Q",
    "user": {
      "login": "nicexe",
      "id": 867535,
      "node_id": "MDQ6VXNlcjg2NzUzNQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/867535?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nicexe",
      "html_url": "https://github.com/nicexe",
      "followers_url": "https://api.github.com/users/nicexe/followers",
      "following_url": "https://api.github.com/users/nicexe/following{/other_user}",
      "gists_url": "https://api.github.com/users/nicexe/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nicexe/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nicexe/subscriptions",
      "organizations_url": "https://api.github.com/users/nicexe/orgs",
      "repos_url": "https://api.github.com/users/nicexe/repos",
      "events_url": "https://api.github.com/users/nicexe/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nicexe/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-05T08:41:39Z",
    "updated_at": "2022-12-05T08:41:39Z",
    "author_association": "NONE",
    "body": "I have changed the query to use `nethermind_last_persisted_block_number` instead of `nethermind_blocks` and it seems like the node under heavy use is now reporting the latest block it has.\r\nI'm not sure if there is any downside when relying on `nethermind_last_persisted_block_number` over `nethermind_blocks`",
    "reactions": {
      "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/1336962576/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
