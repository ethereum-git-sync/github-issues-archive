{
  "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/663",
  "repository_url": "https://api.github.com/repos/NethermindEth/nethermind",
  "labels_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/663/labels{/name}",
  "comments_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/663/comments",
  "events_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/663/events",
  "html_url": "https://github.com/NethermindEth/nethermind/issues/663",
  "id": 468783780,
  "node_id": "MDU6SXNzdWU0Njg3ODM3ODA=",
  "number": 663,
  "title": "Support initiate / finalize change on AuRa",
  "user": {
    "login": "tkstanczak",
    "id": 498913,
    "node_id": "MDQ6VXNlcjQ5ODkxMw==",
    "avatar_url": "https://avatars.githubusercontent.com/u/498913?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tkstanczak",
    "html_url": "https://github.com/tkstanczak",
    "followers_url": "https://api.github.com/users/tkstanczak/followers",
    "following_url": "https://api.github.com/users/tkstanczak/following{/other_user}",
    "gists_url": "https://api.github.com/users/tkstanczak/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tkstanczak/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tkstanczak/subscriptions",
    "organizations_url": "https://api.github.com/users/tkstanczak/orgs",
    "repos_url": "https://api.github.com/users/tkstanczak/repos",
    "events_url": "https://api.github.com/users/tkstanczak/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tkstanczak/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1448805289,
      "node_id": "MDU6TGFiZWwxNDQ4ODA1Mjg5",
      "url": "https://api.github.com/repos/NethermindEth/nethermind/labels/poa",
      "name": "poa",
      "color": "7b5fb9",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "tkstanczak",
    "id": 498913,
    "node_id": "MDQ6VXNlcjQ5ODkxMw==",
    "avatar_url": "https://avatars.githubusercontent.com/u/498913?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tkstanczak",
    "html_url": "https://github.com/tkstanczak",
    "followers_url": "https://api.github.com/users/tkstanczak/followers",
    "following_url": "https://api.github.com/users/tkstanczak/following{/other_user}",
    "gists_url": "https://api.github.com/users/tkstanczak/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tkstanczak/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tkstanczak/subscriptions",
    "organizations_url": "https://api.github.com/users/tkstanczak/orgs",
    "repos_url": "https://api.github.com/users/tkstanczak/repos",
    "events_url": "https://api.github.com/users/tkstanczak/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tkstanczak/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "tkstanczak",
      "id": 498913,
      "node_id": "MDQ6VXNlcjQ5ODkxMw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/498913?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tkstanczak",
      "html_url": "https://github.com/tkstanczak",
      "followers_url": "https://api.github.com/users/tkstanczak/followers",
      "following_url": "https://api.github.com/users/tkstanczak/following{/other_user}",
      "gists_url": "https://api.github.com/users/tkstanczak/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tkstanczak/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tkstanczak/subscriptions",
      "organizations_url": "https://api.github.com/users/tkstanczak/orgs",
      "repos_url": "https://api.github.com/users/tkstanczak/repos",
      "events_url": "https://api.github.com/users/tkstanczak/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tkstanczak/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2019-07-16T17:47:35Z",
  "updated_at": "2022-05-04T09:48:04Z",
  "closed_at": "2019-08-27T07:55:24Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "",
  "closed_by": {
    "login": "LukaszRozmej",
    "id": 12445221,
    "node_id": "MDQ6VXNlcjEyNDQ1MjIx",
    "avatar_url": "https://avatars.githubusercontent.com/u/12445221?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/LukaszRozmej",
    "html_url": "https://github.com/LukaszRozmej",
    "followers_url": "https://api.github.com/users/LukaszRozmej/followers",
    "following_url": "https://api.github.com/users/LukaszRozmej/following{/other_user}",
    "gists_url": "https://api.github.com/users/LukaszRozmej/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/LukaszRozmej/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/LukaszRozmej/subscriptions",
    "organizations_url": "https://api.github.com/users/LukaszRozmej/orgs",
    "repos_url": "https://api.github.com/users/LukaszRozmej/repos",
    "events_url": "https://api.github.com/users/LukaszRozmej/events{/privacy}",
    "received_events_url": "https://api.github.com/users/LukaszRozmej/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/663/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/663/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/1116833863",
    "html_url": "https://github.com/NethermindEth/nethermind/issues/663#issuecomment-1116833863",
    "issue_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/663",
    "id": 1116833863,
    "node_id": "IC_kwDOBggaLc5CkYhH",
    "user": {
      "login": "raymondjacobson",
      "id": 2731362,
      "node_id": "MDQ6VXNlcjI3MzEzNjI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2731362?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/raymondjacobson",
      "html_url": "https://github.com/raymondjacobson",
      "followers_url": "https://api.github.com/users/raymondjacobson/followers",
      "following_url": "https://api.github.com/users/raymondjacobson/following{/other_user}",
      "gists_url": "https://api.github.com/users/raymondjacobson/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/raymondjacobson/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/raymondjacobson/subscriptions",
      "organizations_url": "https://api.github.com/users/raymondjacobson/orgs",
      "repos_url": "https://api.github.com/users/raymondjacobson/repos",
      "events_url": "https://api.github.com/users/raymondjacobson/events{/privacy}",
      "received_events_url": "https://api.github.com/users/raymondjacobson/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-04T00:41:20Z",
    "updated_at": "2022-05-04T00:41:20Z",
    "author_association": "NONE",
    "body": "Hi @LukaszRozmej , @tkstanczak , I'm running a fork of an AuRa/POA implementation, and it appears as if finalizeChange never gets called for validators in the pendingList. I'm not sure why they aren't, but I'm wondering if this is potentially a nethermind bug (?).\r\n\r\nIIUC, by https://blockchain101.com/wp-content/uploads/2021/08/TheDeFi20.pdf, it suggests that any time a validator change is triggered and initiate change event is fired, it should be finalized, and I'm not observing that to be the case.\r\n\r\nDo you have any suggestions?",
    "reactions": {
      "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/1116833863/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/1117006193",
    "html_url": "https://github.com/NethermindEth/nethermind/issues/663#issuecomment-1117006193",
    "issue_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/663",
    "id": 1117006193,
    "node_id": "IC_kwDOBggaLc5ClClx",
    "user": {
      "login": "LukaszRozmej",
      "id": 12445221,
      "node_id": "MDQ6VXNlcjEyNDQ1MjIx",
      "avatar_url": "https://avatars.githubusercontent.com/u/12445221?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/LukaszRozmej",
      "html_url": "https://github.com/LukaszRozmej",
      "followers_url": "https://api.github.com/users/LukaszRozmej/followers",
      "following_url": "https://api.github.com/users/LukaszRozmej/following{/other_user}",
      "gists_url": "https://api.github.com/users/LukaszRozmej/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/LukaszRozmej/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/LukaszRozmej/subscriptions",
      "organizations_url": "https://api.github.com/users/LukaszRozmej/orgs",
      "repos_url": "https://api.github.com/users/LukaszRozmej/repos",
      "events_url": "https://api.github.com/users/LukaszRozmej/events{/privacy}",
      "received_events_url": "https://api.github.com/users/LukaszRozmej/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-04T07:28:29Z",
    "updated_at": "2022-05-04T07:28:29Z",
    "author_association": "MEMBER",
    "body": "Hi @raymondjacobson this feature is successfully deployed on multiple chains: Gnosis (former xDai), Sokol, Poa Core, EWC, Volta ect. where everywhere it works fine and is with consensus with OpenEthereum implementation.\r\n\r\n The confusion is probably when finalizeChange is being called. So finalizeChange is being called when block where initiateChange was emitted is finalized. So when this happens? It happens when enough current (before the change) validators build a block on-top of the block that emitted initiateChange. How many is dependent on twoThirdsMajorityTransition flag in chainspec. If that flag is false it needs to be  > 1/2, if its true it needs to be > 2/3.\r\n\r\nLet me give you an example. Lets say we have a network where we have 5 validators: A, B, C, D, E and twoThirdsMajorityTransition flag is true. so we need > 2/3*5 = 3 1/3,  so we need 4 confirmations to mark block as finalized.\r\n\r\nValidator A builds block 1 which contains initiateChange. We have 1 confirmation of this block from validiator A.\r\nValidator B builds block 2 on top of that block. So we have 2 confirmations.\r\nValidator C builds block 3 on top of that block. So we have 3 confirmations.\r\nValidator D builds block 4 on top of that block. So we have 4 confirmations. This is enough confirmations to finalize block 1, so when processing block 4 nodes call finalizeChange method.\r\n\r\nSimilarly in this example if we have 2 out of 5 validators offline not building blocks then finalization will never happen and finalizeChange will never be called. Example:\r\n\r\nValidator A builds block 1 which contains initiateChange. We have 1 confirmation of this block from validiator A.\r\nValidator B builds block 2 on top of that block. So we have 2 confirmations.\r\nValidator C builds block 3 on top of that block. So we have 3 confirmations.\r\nValidator D is offline and skips building a block. We still have only 3 confirmations.\r\nValidator E is offline and skips building a block. We still have only 3 confirmations.\r\nValidator B builds block 4 on top of that block. But we still have only 3 validator confirmations.\r\n...",
    "reactions": {
      "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/1117006193/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/1117011414",
    "html_url": "https://github.com/NethermindEth/nethermind/issues/663#issuecomment-1117011414",
    "issue_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/663",
    "id": 1117011414,
    "node_id": "IC_kwDOBggaLc5ClD3W",
    "user": {
      "login": "raymondjacobson",
      "id": 2731362,
      "node_id": "MDQ6VXNlcjI3MzEzNjI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2731362?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/raymondjacobson",
      "html_url": "https://github.com/raymondjacobson",
      "followers_url": "https://api.github.com/users/raymondjacobson/followers",
      "following_url": "https://api.github.com/users/raymondjacobson/following{/other_user}",
      "gists_url": "https://api.github.com/users/raymondjacobson/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/raymondjacobson/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/raymondjacobson/subscriptions",
      "organizations_url": "https://api.github.com/users/raymondjacobson/orgs",
      "repos_url": "https://api.github.com/users/raymondjacobson/repos",
      "events_url": "https://api.github.com/users/raymondjacobson/events{/privacy}",
      "received_events_url": "https://api.github.com/users/raymondjacobson/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-04T07:35:45Z",
    "updated_at": "2022-05-04T07:35:45Z",
    "author_association": "NONE",
    "body": "Thanks @LukaszRozmej  -- This was weird. I sort-of figured out what was going on in this situation, but essentially I performed a hard-fork from a validator set that was entirely on OpenEthereum via a change to an AuRa contract to a new set of validators entirely on Nethermind. Here's what happened:\r\n\r\n1. Created a new consensus contract and deployed it to the main chain (all open ethereum validators) with a \"master of ceremony\" initial validator.\r\n2. Registered 3 more validators against that new main chain in the consensus contract (all nethermind)\r\n3. Updated the chain spec in all 4 validators (master + 3 additional) to include a target block in the future with activation of the consensus contract\r\n4. On hitting the target block, the validators were all in the PendingList *not* the Validators list except for the master of ceremony (initial validator), which was in the validators list.\r\n5. The single master of ceremony was mining blocks\r\n6. 100s of blocks later, the 3 additional validators were still stuck in the pending state\r\n7. I add a 4th additional validator and registered it against the *new* fork\r\n8. That forced all 4 additional validators from the pending list to the validators list\r\n\r\nI'm not sure if this is a bug, but it seems like something between the openethereum <> nethermind handshake broke the state tracking.",
    "reactions": {
      "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/1117011414/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/1117027186",
    "html_url": "https://github.com/NethermindEth/nethermind/issues/663#issuecomment-1117027186",
    "issue_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/663",
    "id": 1117027186,
    "node_id": "IC_kwDOBggaLc5ClHty",
    "user": {
      "login": "LukaszRozmej",
      "id": 12445221,
      "node_id": "MDQ6VXNlcjEyNDQ1MjIx",
      "avatar_url": "https://avatars.githubusercontent.com/u/12445221?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/LukaszRozmej",
      "html_url": "https://github.com/LukaszRozmej",
      "followers_url": "https://api.github.com/users/LukaszRozmej/followers",
      "following_url": "https://api.github.com/users/LukaszRozmej/following{/other_user}",
      "gists_url": "https://api.github.com/users/LukaszRozmej/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/LukaszRozmej/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/LukaszRozmej/subscriptions",
      "organizations_url": "https://api.github.com/users/LukaszRozmej/orgs",
      "repos_url": "https://api.github.com/users/LukaszRozmej/repos",
      "events_url": "https://api.github.com/users/LukaszRozmej/events{/privacy}",
      "received_events_url": "https://api.github.com/users/LukaszRozmej/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-04T07:57:00Z",
    "updated_at": "2022-05-04T07:58:41Z",
    "author_association": "MEMBER",
    "body": "Ah interesting. That's quite an edge case to make a completely different validator list. That would have to be investigated further, created github issue for future investigation.",
    "reactions": {
      "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/1117027186/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 1,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/1117123075",
    "html_url": "https://github.com/NethermindEth/nethermind/issues/663#issuecomment-1117123075",
    "issue_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/663",
    "id": 1117123075,
    "node_id": "IC_kwDOBggaLc5ClfID",
    "user": {
      "login": "LukaszRozmej",
      "id": 12445221,
      "node_id": "MDQ6VXNlcjEyNDQ1MjIx",
      "avatar_url": "https://avatars.githubusercontent.com/u/12445221?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/LukaszRozmej",
      "html_url": "https://github.com/LukaszRozmej",
      "followers_url": "https://api.github.com/users/LukaszRozmej/followers",
      "following_url": "https://api.github.com/users/LukaszRozmej/following{/other_user}",
      "gists_url": "https://api.github.com/users/LukaszRozmej/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/LukaszRozmej/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/LukaszRozmej/subscriptions",
      "organizations_url": "https://api.github.com/users/LukaszRozmej/orgs",
      "repos_url": "https://api.github.com/users/LukaszRozmej/repos",
      "events_url": "https://api.github.com/users/LukaszRozmej/events{/privacy}",
      "received_events_url": "https://api.github.com/users/LukaszRozmej/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-05-04T09:48:04Z",
    "updated_at": "2022-05-04T09:48:04Z",
    "author_association": "MEMBER",
    "body": "As a current workaround my suggestion would be to split the upgrade into 2 stages:\r\n1. New contract but same validators. Let it validate some blocks.\r\n2. Initiate change in contract to switch to Nethermind nodes.\r\n\r\nShould work without issues.",
    "reactions": {
      "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/1117123075/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
