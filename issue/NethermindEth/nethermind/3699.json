{
  "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/3699",
  "repository_url": "https://api.github.com/repos/NethermindEth/nethermind",
  "labels_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/3699/labels{/name}",
  "comments_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/3699/comments",
  "events_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/3699/events",
  "html_url": "https://github.com/NethermindEth/nethermind/issues/3699",
  "id": 1083462585,
  "node_id": "I_kwDOBggaLc5AlFO5",
  "number": 3699,
  "title": "Aura stall with force sealing on a single node",
  "user": {
    "login": "mirokuratczyk",
    "id": 10536153,
    "node_id": "MDQ6VXNlcjEwNTM2MTUz",
    "avatar_url": "https://avatars.githubusercontent.com/u/10536153?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mirokuratczyk",
    "html_url": "https://github.com/mirokuratczyk",
    "followers_url": "https://api.github.com/users/mirokuratczyk/followers",
    "following_url": "https://api.github.com/users/mirokuratczyk/following{/other_user}",
    "gists_url": "https://api.github.com/users/mirokuratczyk/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mirokuratczyk/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mirokuratczyk/subscriptions",
    "organizations_url": "https://api.github.com/users/mirokuratczyk/orgs",
    "repos_url": "https://api.github.com/users/mirokuratczyk/repos",
    "events_url": "https://api.github.com/users/mirokuratczyk/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mirokuratczyk/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": {
    "login": "jmederosalvarado",
    "id": 46798594,
    "node_id": "MDQ6VXNlcjQ2Nzk4NTk0",
    "avatar_url": "https://avatars.githubusercontent.com/u/46798594?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jmederosalvarado",
    "html_url": "https://github.com/jmederosalvarado",
    "followers_url": "https://api.github.com/users/jmederosalvarado/followers",
    "following_url": "https://api.github.com/users/jmederosalvarado/following{/other_user}",
    "gists_url": "https://api.github.com/users/jmederosalvarado/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jmederosalvarado/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jmederosalvarado/subscriptions",
    "organizations_url": "https://api.github.com/users/jmederosalvarado/orgs",
    "repos_url": "https://api.github.com/users/jmederosalvarado/repos",
    "events_url": "https://api.github.com/users/jmederosalvarado/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jmederosalvarado/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "jmederosalvarado",
      "id": 46798594,
      "node_id": "MDQ6VXNlcjQ2Nzk4NTk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/46798594?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jmederosalvarado",
      "html_url": "https://github.com/jmederosalvarado",
      "followers_url": "https://api.github.com/users/jmederosalvarado/followers",
      "following_url": "https://api.github.com/users/jmederosalvarado/following{/other_user}",
      "gists_url": "https://api.github.com/users/jmederosalvarado/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jmederosalvarado/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jmederosalvarado/subscriptions",
      "organizations_url": "https://api.github.com/users/jmederosalvarado/orgs",
      "repos_url": "https://api.github.com/users/jmederosalvarado/repos",
      "events_url": "https://api.github.com/users/jmederosalvarado/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jmederosalvarado/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 0,
  "created_at": "2021-12-17T17:16:47Z",
  "updated_at": "2022-08-31T18:05:07Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "**Describe the bug**\r\n\r\nNethermind gets stuck sealing the same block infinitely when run as a single node using Aura consensus and force sealing.\r\n\r\n**To Reproduce**\r\n\r\nFollow the instructions in README.md in https://github.com/mirokuratczyk/nethermind-bug/tree/f6e4c4771875e7a610bc177befd9fdcbf66d00ea. It may take a few attempts to reproduce the bug.\r\n\r\n**Expected behavior**\r\n\r\nIt is expected that Nethermind will continue to produce and seal new blocks the second time it is run.\r\n\r\n**Actual behavior**\r\n\r\nNethermind infinitely loops on sealing block 1.\r\n\r\n**Desktop**\r\n - OS: macOS 11.4 (Big Sur)\r\n - Version 1.12.3\r\n\r\n**Additional context**\r\nHere is what I have uncovered.\r\n\r\nInitial run:\r\nNode mines blocks 1–N\r\n<Shutdown the node>\r\n\r\nSecond run:\r\nNode attempts to mine a new block M where 0<M.height<N.height, but it still has blocks 0–N in the database. At least the header database or some cache.\r\n\r\nSo when it proposes this new block M it checks if it has seen a block of the same height with greater difficulty. If there exists a block of the same height with greater difficulty, then this new block will be ignored.\r\n\r\n1. The node retrieves the previously mined block O at the same height as M from the database and checks its difficulty. Since we’re using the AuRa consensus algorithm the [difficulty of a block is roughly proportional to the time elapsed since the parent block was mined](https://github.com/NethermindEth/nethermind/blob/f5f0d940ac4c357a4d1a5c77c37ffe0ef7b9f815/src/Nethermind/Nethermind.Consensus.AuRa/AuraDifficultyCalculator.cs#L37). So O has greater difficulty and M is ignored. But for some reason it never re-processes O and loops endlessly trying to propose blocks at O.height with decreasing difficulty — since more time has elapsed.\r\n\r\n2. Nethermind always checks the [difficulty of a new block](https://github.com/NethermindEth/nethermind/blob/f5f0d940ac4c357a4d1a5c77c37ffe0ef7b9f815/src/Nethermind/Nethermind.Blockchain/BlockTree.cs#L563), regardless of its height, against the [difficulty of the block with the most height in its database](https://github.com/NethermindEth/nethermind/blob/f5f0d940ac4c357a4d1a5c77c37ffe0ef7b9f815/src/Nethermind/Nethermind.Blockchain/BlockTree.cs#L344). At least in this scenario. So the difficulty of block O is getting compared with the difficulty of block N. Which isn’t a problem until we hit 1.\r\n\r\n***Debugging***\r\n\r\nI tried to dig into the issue a little further and here is what I found. Hope this helps!\r\n\r\nOn the first run I see `StateHeadHashDbEntryAddress` set here every time a new block is processed (so it should be >0) https://github.com/NethermindEth/nethermind/blob/f5f0d940ac4c357a4d1a5c77c37ffe0ef7b9f815/src/Nethermind/Nethermind.Blockchain/BlockTree.cs#L1558\r\n\r\nBut then on the second run `StateHeadHashDbEntryAddress` returns 0, when i'd expect it to be the number of the last block mined in the first run. So the start block is set to the genesis block instead of block N. Although, I may have misunderstood the code and this could have nothing to do with the issue at hand. https://github.com/NethermindEth/nethermind/blob/f5f0d940ac4c357a4d1a5c77c37ffe0ef7b9f815/src/Nethermind/Nethermind.Blockchain/BlockTree.cs#L1145\r\n\r\nAlso on the second run I see this log:\r\n```\r\nBlock tree initialized, last processed is 0, best queued is 16, best known is 16, lowest inserted header , body\r\n```\r\nBut sometimes after a few runs, without resetting the database, I see:\r\n```\r\nBlock tree initialized, last processed is 0, best queued is 0, best known is 0, lowest inserted header , body\r\n```\r\nAnd the node starts successfully mining blocks again starting from block 1.",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/3699/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/3699/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[

]
