{
  "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/3221",
  "repository_url": "https://api.github.com/repos/NethermindEth/nethermind",
  "labels_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/3221/labels{/name}",
  "comments_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/3221/comments",
  "events_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/3221/events",
  "html_url": "https://github.com/NethermindEth/nethermind/issues/3221",
  "id": 942115537,
  "node_id": "MDU6SXNzdWU5NDIxMTU1Mzc=",
  "number": 3221,
  "title": "\"Too many open files\" error when performing a sync using the docker image",
  "user": {
    "login": "habdelra",
    "id": 61075,
    "node_id": "MDQ6VXNlcjYxMDc1",
    "avatar_url": "https://avatars.githubusercontent.com/u/61075?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/habdelra",
    "html_url": "https://github.com/habdelra",
    "followers_url": "https://api.github.com/users/habdelra/followers",
    "following_url": "https://api.github.com/users/habdelra/following{/other_user}",
    "gists_url": "https://api.github.com/users/habdelra/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/habdelra/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/habdelra/subscriptions",
    "organizations_url": "https://api.github.com/users/habdelra/orgs",
    "repos_url": "https://api.github.com/users/habdelra/repos",
    "events_url": "https://api.github.com/users/habdelra/events{/privacy}",
    "received_events_url": "https://api.github.com/users/habdelra/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1024161790,
      "node_id": "MDU6TGFiZWwxMDI0MTYxNzkw",
      "url": "https://api.github.com/repos/NethermindEth/nethermind/labels/devops",
      "name": "devops",
      "color": "dbbd11",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "matilote",
    "id": 33068017,
    "node_id": "MDQ6VXNlcjMzMDY4MDE3",
    "avatar_url": "https://avatars.githubusercontent.com/u/33068017?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/matilote",
    "html_url": "https://github.com/matilote",
    "followers_url": "https://api.github.com/users/matilote/followers",
    "following_url": "https://api.github.com/users/matilote/following{/other_user}",
    "gists_url": "https://api.github.com/users/matilote/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/matilote/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/matilote/subscriptions",
    "organizations_url": "https://api.github.com/users/matilote/orgs",
    "repos_url": "https://api.github.com/users/matilote/repos",
    "events_url": "https://api.github.com/users/matilote/events{/privacy}",
    "received_events_url": "https://api.github.com/users/matilote/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "matilote",
      "id": 33068017,
      "node_id": "MDQ6VXNlcjMzMDY4MDE3",
      "avatar_url": "https://avatars.githubusercontent.com/u/33068017?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/matilote",
      "html_url": "https://github.com/matilote",
      "followers_url": "https://api.github.com/users/matilote/followers",
      "following_url": "https://api.github.com/users/matilote/following{/other_user}",
      "gists_url": "https://api.github.com/users/matilote/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/matilote/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/matilote/subscriptions",
      "organizations_url": "https://api.github.com/users/matilote/orgs",
      "repos_url": "https://api.github.com/users/matilote/repos",
      "events_url": "https://api.github.com/users/matilote/events{/privacy}",
      "received_events_url": "https://api.github.com/users/matilote/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2021-07-12T14:19:29Z",
  "updated_at": "2023-06-21T14:12:04Z",
  "closed_at": "2021-07-30T08:00:03Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "**Describe the bug**\r\nI am performing a full archive sync of the POA Sokol network from the docker image located at https://hub.docker.com/r/nethermind/nethermind. After about 17.3 million blocks I encounter this error:\r\n```2021-07-12 12:55:38.3949|Processed   17383724 |    1,007ms, mgasps   38.21 total   26.90, tps  225.41 total  161.12, bps  176.76 total  116.43, recv queue 4225, proc queue 2000\r\n2021-07-12 12:55:39.0614|BlockchainProcessor encountered an exception. RocksDbSharp.RocksDbException: IO error: While open a file for random read: /nethermind/data/nethermind_db/sokol_archive/state/085434.sst: Too many open files\r\n   at RocksDbSharp.Native.rocksdb_write(IntPtr db, IntPtr options, IntPtr batch)\r\n   at Nethermind.Db.Rocks.DbOnTheRocks.RocksDbBatch.Dispose()\r\n   at Nethermind.Trie.Pruning.TrieStore.FinishBlockCommit(TrieType trieType, Int64 blockNumber, TrieNode root)\r\n   at Nethermind.Trie.PatriciaTree.Commit(Int64 blockNumber)\r\n   at Nethermind.State.StorageProvider.CommitTrees(Int64 blockNumber)\r\n   at Nethermind.Blockchain.Processing.BlockProcessor.PreCommitBlock(Keccak newBranchStateRoot, Int64 blockNumber)\r\n   at Nethermind.Blockchain.Processing.BlockProcessor.Process(Keccak newBranchStateRoot, List`1 suggestedBlocks, ProcessingOptions options, IBlockTracer blockTracer)\r\n   at Nethermind.Blockchain.Processing.BlockchainProcessor.ProcessBranch(ProcessingBranch processingBranch, ProcessingOptions options, IBlockTracer tracer)\r\n   at Nethermind.Blockchain.Processing.BlockchainProcessor.Process(Block suggestedBlock, ProcessingOptions options, IBlockTracer tracer)\r\n   at Nethermind.Blockchain.Processing.BlockchainProcessor.RunProcessingLoop()\r\n   at System.Threading.Tasks.Task.InnerInvoke()\r\n   at System.Threading.Tasks.Task.<>c.<.cctor>b__277_0(Object obj)\r\n   at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state)\r\n--- End of stack trace from previous location ---\r\n   at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state)\r\n   at System.Threading.Tasks.Task.ExecuteWithThreadLocal(Task& currentTaskSlot, Thread threadPoolThread)\r\n2021-07-12 12:55:39.1816|Failed to store data in /nethermind/data/nethermind_db/sokol_archive/peers/SimpleFileDb.db System.IO.IOException: Too many open files\r\n   at Interop.ThrowExceptionForIoErrno(ErrorInfo errorInfo, String path, Boolean isDirectory, Func`2 errorRewriter)\r\n   at Microsoft.Win32.SafeHandles.SafeFileHandle.Open(String path, OpenFlags flags, Int32 mode)\r\n   at System.IO.FileStream..ctor(String path, FileMode mode, FileAccess access, FileShare share, Int32 bufferSize, FileOptions options)\r\n   at System.IO.StreamWriter.ValidateArgsAndOpenPath(String path, Boolean append, Encoding encoding, Int32 bufferSize)\r\n   at Nethermind.Network.SimpleFilePublicKeyDb.CommitBatch() in /src/Nethermind/Nethermind.Network/SimpleFilePublicKeyDb.cs:line 118\r\n```\r\nAfter that error is encountered the no more blocks are processed and the syncing process is essentially frozen.\r\n\r\n**To Reproduce**\r\nExecute the following:\r\n```sh\r\ndocker pull nethermind/nethermind:latest\r\ndocker run -d \\\r\n  -v /data/ethereum/:/nethermind/data \\\r\n  -p 8545:8545 -p 30300-30400:30300-30400 -p 30300-30400:30300-30400/udp \\\r\n  nethermind/nethermind \\\r\n    --datadir data \\\r\n    --config sokol_archive \\\r\n    --HealthChecks.Enabled true \\\r\n    --HealthChecks.UIEnabled true \\\r\n    --JsonRpc.Enabled true \\\r\n    --JsonRpc.Host 0.0.0.0\r\n```\r\n\r\nwait very many blocks (in my case about 17.3 million), and the stack trace from above appears\r\n\r\n**Expected behavior**\r\nIdeally, we should never get this error. I wonder. in the documentation here: https://docs.nethermind.io/nethermind/first-steps-with-nethermind/manage-nethermind-with-systemd, the max number of open files is being explicitly set. should something like this be specified in the Dockerfile for nethermind as well?\r\n\r\n\r\n\r\n**Platform:**\r\n - OS: AWS Amazon Linux (CentOS) EC2 instance w/ EBS volume mounted\r\n\r\n",
  "closed_by": {
    "login": "matilote",
    "id": 33068017,
    "node_id": "MDQ6VXNlcjMzMDY4MDE3",
    "avatar_url": "https://avatars.githubusercontent.com/u/33068017?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/matilote",
    "html_url": "https://github.com/matilote",
    "followers_url": "https://api.github.com/users/matilote/followers",
    "following_url": "https://api.github.com/users/matilote/following{/other_user}",
    "gists_url": "https://api.github.com/users/matilote/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/matilote/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/matilote/subscriptions",
    "organizations_url": "https://api.github.com/users/matilote/orgs",
    "repos_url": "https://api.github.com/users/matilote/repos",
    "events_url": "https://api.github.com/users/matilote/events{/privacy}",
    "received_events_url": "https://api.github.com/users/matilote/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/3221/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/3221/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/878539660",
    "html_url": "https://github.com/NethermindEth/nethermind/issues/3221#issuecomment-878539660",
    "issue_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/3221",
    "id": 878539660,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg3ODUzOTY2MA==",
    "user": {
      "login": "habdelra",
      "id": 61075,
      "node_id": "MDQ6VXNlcjYxMDc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/61075?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/habdelra",
      "html_url": "https://github.com/habdelra",
      "followers_url": "https://api.github.com/users/habdelra/followers",
      "following_url": "https://api.github.com/users/habdelra/following{/other_user}",
      "gists_url": "https://api.github.com/users/habdelra/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/habdelra/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/habdelra/subscriptions",
      "organizations_url": "https://api.github.com/users/habdelra/orgs",
      "repos_url": "https://api.github.com/users/habdelra/repos",
      "events_url": "https://api.github.com/users/habdelra/events{/privacy}",
      "received_events_url": "https://api.github.com/users/habdelra/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-07-12T19:33:56Z",
    "updated_at": "2021-07-12T19:33:56Z",
    "author_association": "NONE",
    "body": "In my situation I've mounting my host disk as a volume in the docker container. Maybe this is a simple as just updating the documentation for running in docker to ensure that the maximum number of files that can be open should be raised to the hard limit for the OS when you are mounting a host volume in the docker container running nethermind.",
    "reactions": {
      "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/878539660/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/889154559",
    "html_url": "https://github.com/NethermindEth/nethermind/issues/3221#issuecomment-889154559",
    "issue_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/3221",
    "id": 889154559,
    "node_id": "IC_kwDOBggaLc40_2v_",
    "user": {
      "login": "LukaszRozmej",
      "id": 12445221,
      "node_id": "MDQ6VXNlcjEyNDQ1MjIx",
      "avatar_url": "https://avatars.githubusercontent.com/u/12445221?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/LukaszRozmej",
      "html_url": "https://github.com/LukaszRozmej",
      "followers_url": "https://api.github.com/users/LukaszRozmej/followers",
      "following_url": "https://api.github.com/users/LukaszRozmej/following{/other_user}",
      "gists_url": "https://api.github.com/users/LukaszRozmej/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/LukaszRozmej/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/LukaszRozmej/subscriptions",
      "organizations_url": "https://api.github.com/users/LukaszRozmej/orgs",
      "repos_url": "https://api.github.com/users/LukaszRozmej/repos",
      "events_url": "https://api.github.com/users/LukaszRozmej/events{/privacy}",
      "received_events_url": "https://api.github.com/users/LukaszRozmej/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-07-29T13:41:48Z",
    "updated_at": "2021-07-29T13:41:48Z",
    "author_association": "MEMBER",
    "body": "@matilote can we raise the default limit in our docker file?",
    "reactions": {
      "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/889154559/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/889161464",
    "html_url": "https://github.com/NethermindEth/nethermind/issues/3221#issuecomment-889161464",
    "issue_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/3221",
    "id": 889161464,
    "node_id": "IC_kwDOBggaLc40_4b4",
    "user": {
      "login": "matilote",
      "id": 33068017,
      "node_id": "MDQ6VXNlcjMzMDY4MDE3",
      "avatar_url": "https://avatars.githubusercontent.com/u/33068017?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/matilote",
      "html_url": "https://github.com/matilote",
      "followers_url": "https://api.github.com/users/matilote/followers",
      "following_url": "https://api.github.com/users/matilote/following{/other_user}",
      "gists_url": "https://api.github.com/users/matilote/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/matilote/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/matilote/subscriptions",
      "organizations_url": "https://api.github.com/users/matilote/orgs",
      "repos_url": "https://api.github.com/users/matilote/repos",
      "events_url": "https://api.github.com/users/matilote/events{/privacy}",
      "received_events_url": "https://api.github.com/users/matilote/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-07-29T13:50:44Z",
    "updated_at": "2021-07-29T13:50:44Z",
    "author_association": "MEMBER",
    "body": "Cannot do that explicitly in the Dockerfile. I will update the documentation to include `--ulimit nofile=1000000:1000000` in docker and docker-compose instruction.",
    "reactions": {
      "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/889161464/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/889712975",
    "html_url": "https://github.com/NethermindEth/nethermind/issues/3221#issuecomment-889712975",
    "issue_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/3221",
    "id": 889712975,
    "node_id": "IC_kwDOBggaLc41B_FP",
    "user": {
      "login": "matilote",
      "id": 33068017,
      "node_id": "MDQ6VXNlcjMzMDY4MDE3",
      "avatar_url": "https://avatars.githubusercontent.com/u/33068017?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/matilote",
      "html_url": "https://github.com/matilote",
      "followers_url": "https://api.github.com/users/matilote/followers",
      "following_url": "https://api.github.com/users/matilote/following{/other_user}",
      "gists_url": "https://api.github.com/users/matilote/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/matilote/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/matilote/subscriptions",
      "organizations_url": "https://api.github.com/users/matilote/orgs",
      "repos_url": "https://api.github.com/users/matilote/repos",
      "events_url": "https://api.github.com/users/matilote/events{/privacy}",
      "received_events_url": "https://api.github.com/users/matilote/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-07-30T08:00:03Z",
    "updated_at": "2021-07-30T08:00:03Z",
    "author_association": "MEMBER",
    "body": "Added instructions on our [docs](https://docs.nethermind.io/nethermind/ethereum-client/docker#running-nethermind-container).",
    "reactions": {
      "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/889712975/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/1600913684",
    "html_url": "https://github.com/NethermindEth/nethermind/issues/3221#issuecomment-1600913684",
    "issue_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/3221",
    "id": 1600913684,
    "node_id": "IC_kwDOBggaLc5fbAEU",
    "user": {
      "login": "attila-lendvai",
      "id": 840345,
      "node_id": "MDQ6VXNlcjg0MDM0NQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/840345?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/attila-lendvai",
      "html_url": "https://github.com/attila-lendvai",
      "followers_url": "https://api.github.com/users/attila-lendvai/followers",
      "following_url": "https://api.github.com/users/attila-lendvai/following{/other_user}",
      "gists_url": "https://api.github.com/users/attila-lendvai/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/attila-lendvai/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/attila-lendvai/subscriptions",
      "organizations_url": "https://api.github.com/users/attila-lendvai/orgs",
      "repos_url": "https://api.github.com/users/attila-lendvai/repos",
      "events_url": "https://api.github.com/users/attila-lendvai/events{/privacy}",
      "received_events_url": "https://api.github.com/users/attila-lendvai/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-06-21T14:12:03Z",
    "updated_at": "2023-06-21T14:12:03Z",
    "author_association": "NONE",
    "body": "it would be nice to know a more accurate estimation than 1000000.\r\n\r\nmy node synced up and was running fine for several days with the default 1024.",
    "reactions": {
      "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/1600913684/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
