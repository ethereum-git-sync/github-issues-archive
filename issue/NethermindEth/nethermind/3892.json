{
  "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/3892",
  "repository_url": "https://api.github.com/repos/NethermindEth/nethermind",
  "labels_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/3892/labels{/name}",
  "comments_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/3892/comments",
  "events_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/3892/events",
  "html_url": "https://github.com/NethermindEth/nethermind/issues/3892",
  "id": 1174331316,
  "node_id": "I_kwDOBggaLc5F_t-0",
  "number": 3892,
  "title": "Discrepancy in Nethermind VS Geth for filter blocks",
  "user": {
    "login": "DaveWK",
    "id": 13626476,
    "node_id": "MDQ6VXNlcjEzNjI2NDc2",
    "avatar_url": "https://avatars.githubusercontent.com/u/13626476?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/DaveWK",
    "html_url": "https://github.com/DaveWK",
    "followers_url": "https://api.github.com/users/DaveWK/followers",
    "following_url": "https://api.github.com/users/DaveWK/following{/other_user}",
    "gists_url": "https://api.github.com/users/DaveWK/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/DaveWK/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/DaveWK/subscriptions",
    "organizations_url": "https://api.github.com/users/DaveWK/orgs",
    "repos_url": "https://api.github.com/users/DaveWK/repos",
    "events_url": "https://api.github.com/users/DaveWK/events{/privacy}",
    "received_events_url": "https://api.github.com/users/DaveWK/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2022-03-19T18:52:58Z",
  "updated_at": "2022-03-25T11:36:58Z",
  "closed_at": "2022-03-25T11:36:58Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "**Describe the bug**\r\nNethermind has the Address field as required in the \"filter\" as specified at:\r\nhttps://github.com/NethermindEth/nethermind/blob/master/src/Nethermind/Nethermind.JsonRpc/Modules/Eth/Filter.cs#L40\r\nand so it fails when this is null/empty with:\r\n```\r\n{'code': -32603, 'message': 'Internal error', 'data': \"System.ArgumentNullException: Value cannot be null. (Parameter 'hexString')\r\n   at Nethermind.Core.Extensions.Bytes.FromHexString(String hexString)\r\n   at Nethermind.Core.Crypto.Keccak..ctor(String hexString)\r\n   at Nethermind.Blockchain.Filters.FilterStore.<>c.<GetTopic>b__19_0(String t)\r\n   at System.Linq.Enumerable.SelectListIterator`2.ToArray()\r\n   at Nethermind.Blockchain.Filters.FilterStore.GetTopic(Object obj)\r\n   at System.Linq.Enumerable.SelectEnumerableIterator`2.ToArray()\r\n   at Nethermind.Blockchain.Filters.FilterStore.GetFilterTopics(IEnumerable`1 topics)\r\n   at Nethermind.Blockchain.Filters.FilterStore.GetTopicsFilter(IEnumerable`1 topics)\r\n   at Nethermind.Blockchain.Filters.FilterStore.CreateLogFilter(BlockParameter fromBlock, BlockParameter toBlock, Object address, IEnumerable`1 topics, Boolean setId)\r\n   at Nethermind.Facade.BlockchainBridge.NewFilter(BlockParameter fromBlock, BlockParameter toBlock, Object address, IEnumerable`1 topics)\r\n   at Nethermind.JsonRpc.Modules.Eth.EthRpcModule.eth_newFilter(Filter filter)\"\r\n   }\r\n```\r\nHowever this is an optional field on geth, and the call succeeds. \r\n\r\n**To Reproduce**\r\nI made a python script to illustrate the problem. you will need the `web3` pip package for this to work, and to replace the `nether_url` (couldnt find a public nethermind node):\r\n\r\n```\r\nfrom web3 import Web3\r\n\r\nETH_ADDR = '0x046ca4A32a11638fC9F30E9c2e707A5A92435290'\r\nto_block = 14418487\r\nfrom_block = 14418471\r\n# couldnt find a public nethermind node, used an internal one\r\nnether_url = \"<replace with nethermind rpc>\"\r\nnether_w3 = Web3(Web3.HTTPProvider(nether_url, request_kwargs={\"timeout\": 60}))\r\n# a public geth node\r\ngeth_url = \"https://nodes.mewapi.io/rpc/eth\"\r\ngeth_w3 = Web3(Web3.HTTPProvider(geth_url, request_kwargs={\"timeout\": 60}))\r\n\r\ntransfer = nether_w3.keccak(text=\"Transfer(address,address,uint256)\").hex()\r\naddr = nether_w3.keccak(text=ETH_ADDR).hex()\r\n\r\ntry:\r\n    print(f\"Client: {nether_w3.clientVersion}\")\r\n    filt = nether_w3.eth.filter(\r\n        {\"fromBlock\": from_block,\r\n         \"toBlock\": to_block,\r\n         \"address\": [],\r\n         \"topics\": [transfer, [addr, None], [None, addr]]\r\n         }\r\n    )\r\n    x = filt.get_all_entries()\r\n    print(f\"NETHERMIND SUCCESS\")\r\nexcept Exception as ex:\r\n    print(f\"NETHERMIND FAIL: {ex}\")\r\n\r\ntransfer = geth_w3.keccak(text=\"Transfer(address,address,uint256)\").hex()\r\naddr = geth_w3.keccak(text=ETH_ADDR).hex()\r\ntry:\r\n    print(f\"Client: {geth_w3.clientVersion}\")\r\n    filt = geth_w3.eth.filter(\r\n        {\"fromBlock\": from_block,\r\n         \"toBlock\": to_block,\r\n         \"address\": [],\r\n         \"topics\": [transfer, [addr, None], [None, addr]]\r\n         }\r\n    )\r\n    x = filt.get_all_entries()\r\n    print(f\"GETH SUCCESS\")\r\nexcept Exception as ex:\r\n    print(f\"GETH FAIL: {ex}\")\r\n```\r\n\r\n**Expected behavior**\r\nThe rpc should accept the rpc params as valid, and either return:\r\n`{'code': -32000, 'message': 'filter not found'}` (timing issue for pushing filter, but acceptable)\r\nor return the list of entries matching the filter criteria.\r\n\r\n**Desktop (please complete the following information):**\r\n - OS: Fedora 35\r\n - Nethermind Version 1.12.6\r\n",
  "closed_by": {
    "login": "LukaszRozmej",
    "id": 12445221,
    "node_id": "MDQ6VXNlcjEyNDQ1MjIx",
    "avatar_url": "https://avatars.githubusercontent.com/u/12445221?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/LukaszRozmej",
    "html_url": "https://github.com/LukaszRozmej",
    "followers_url": "https://api.github.com/users/LukaszRozmej/followers",
    "following_url": "https://api.github.com/users/LukaszRozmej/following{/other_user}",
    "gists_url": "https://api.github.com/users/LukaszRozmej/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/LukaszRozmej/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/LukaszRozmej/subscriptions",
    "organizations_url": "https://api.github.com/users/LukaszRozmej/orgs",
    "repos_url": "https://api.github.com/users/LukaszRozmej/repos",
    "events_url": "https://api.github.com/users/LukaszRozmej/events{/privacy}",
    "received_events_url": "https://api.github.com/users/LukaszRozmej/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/3892/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/3892/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/1073735403",
    "html_url": "https://github.com/NethermindEth/nethermind/issues/3892#issuecomment-1073735403",
    "issue_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/3892",
    "id": 1073735403,
    "node_id": "IC_kwDOBggaLc4__-br",
    "user": {
      "login": "LukaszRozmej",
      "id": 12445221,
      "node_id": "MDQ6VXNlcjEyNDQ1MjIx",
      "avatar_url": "https://avatars.githubusercontent.com/u/12445221?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/LukaszRozmej",
      "html_url": "https://github.com/LukaszRozmej",
      "followers_url": "https://api.github.com/users/LukaszRozmej/followers",
      "following_url": "https://api.github.com/users/LukaszRozmej/following{/other_user}",
      "gists_url": "https://api.github.com/users/LukaszRozmej/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/LukaszRozmej/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/LukaszRozmej/subscriptions",
      "organizations_url": "https://api.github.com/users/LukaszRozmej/orgs",
      "repos_url": "https://api.github.com/users/LukaszRozmej/repos",
      "events_url": "https://api.github.com/users/LukaszRozmej/events{/privacy}",
      "received_events_url": "https://api.github.com/users/LukaszRozmej/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-03-21T10:34:43Z",
    "updated_at": "2022-03-21T10:50:55Z",
    "author_association": "MEMBER",
    "body": "We do support null addresses fine. This error is about topics filter.\r\n\r\nInterestingly this works in Geth, but it is out of spec and I wonder if we should implement it in Nethermind:\r\n\r\nLooking at the spec: https://eth.wiki/json-rpc/API#a-note-on-specifying-topic-filters nulls aren't supported when specifying internal arrays.\r\n\r\nLets think what filter like: \"topics\": `[transfer, [addr, None], [None, addr]]` actually would mean:\r\nposition 1: transfer topic\r\nposition 2: address topic OR any topic\r\nposition 3: any topic OR address topic\r\n\r\nThis filter is equivalent to `[transfer, None, None]` and thus to just `[transfer]` and not directly covered by above spec.\r\n\r\nLookig at Geth code it doesn't look like they should support it by design: https://github.com/ethereum/go-ethereum/blob/master/eth/filters/api.go#L548-L552\r\n\r\nQuestion is why do you need this kind of filter then?",
    "reactions": {
      "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/1073735403/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/1078935486",
    "html_url": "https://github.com/NethermindEth/nethermind/issues/3892#issuecomment-1078935486",
    "issue_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/3892",
    "id": 1078935486,
    "node_id": "IC_kwDOBggaLc5ATz--",
    "user": {
      "login": "LukaszRozmej",
      "id": 12445221,
      "node_id": "MDQ6VXNlcjEyNDQ1MjIx",
      "avatar_url": "https://avatars.githubusercontent.com/u/12445221?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/LukaszRozmej",
      "html_url": "https://github.com/LukaszRozmej",
      "followers_url": "https://api.github.com/users/LukaszRozmej/followers",
      "following_url": "https://api.github.com/users/LukaszRozmej/following{/other_user}",
      "gists_url": "https://api.github.com/users/LukaszRozmej/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/LukaszRozmej/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/LukaszRozmej/subscriptions",
      "organizations_url": "https://api.github.com/users/LukaszRozmej/orgs",
      "repos_url": "https://api.github.com/users/LukaszRozmej/repos",
      "events_url": "https://api.github.com/users/LukaszRozmej/events{/privacy}",
      "received_events_url": "https://api.github.com/users/LukaszRozmej/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-03-25T11:36:58Z",
    "updated_at": "2022-03-25T11:36:58Z",
    "author_association": "MEMBER",
    "body": "Closing for now. Request is out-of-spec and is equivalent with a lot simpler one, making it unnecessary. @DaveWK feel free to reopen if you think otherwise.",
    "reactions": {
      "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/1078935486/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
