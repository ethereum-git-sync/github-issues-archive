{
  "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/4192",
  "repository_url": "https://api.github.com/repos/NethermindEth/nethermind",
  "labels_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/4192/labels{/name}",
  "comments_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/4192/comments",
  "events_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/4192/events",
  "html_url": "https://github.com/NethermindEth/nethermind/issues/4192",
  "id": 1280426027,
  "node_id": "I_kwDOBggaLc5MUcAr",
  "number": 4192,
  "title": "segfault error 4 in librocksdb.so while shutdown in progress",
  "user": {
    "login": "c0deright",
    "id": 20477825,
    "node_id": "MDQ6VXNlcjIwNDc3ODI1",
    "avatar_url": "https://avatars.githubusercontent.com/u/20477825?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/c0deright",
    "html_url": "https://github.com/c0deright",
    "followers_url": "https://api.github.com/users/c0deright/followers",
    "following_url": "https://api.github.com/users/c0deright/following{/other_user}",
    "gists_url": "https://api.github.com/users/c0deright/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/c0deright/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/c0deright/subscriptions",
    "organizations_url": "https://api.github.com/users/c0deright/orgs",
    "repos_url": "https://api.github.com/users/c0deright/repos",
    "events_url": "https://api.github.com/users/c0deright/events{/privacy}",
    "received_events_url": "https://api.github.com/users/c0deright/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1217680451,
      "node_id": "MDU6TGFiZWwxMjE3NjgwNDUx",
      "url": "https://api.github.com/repos/NethermindEth/nethermind/labels/rocksdb",
      "name": "rocksdb",
      "color": "1b4987",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": {
    "login": "flcl42",
    "id": 630501,
    "node_id": "MDQ6VXNlcjYzMDUwMQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/630501?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/flcl42",
    "html_url": "https://github.com/flcl42",
    "followers_url": "https://api.github.com/users/flcl42/followers",
    "following_url": "https://api.github.com/users/flcl42/following{/other_user}",
    "gists_url": "https://api.github.com/users/flcl42/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/flcl42/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/flcl42/subscriptions",
    "organizations_url": "https://api.github.com/users/flcl42/orgs",
    "repos_url": "https://api.github.com/users/flcl42/repos",
    "events_url": "https://api.github.com/users/flcl42/events{/privacy}",
    "received_events_url": "https://api.github.com/users/flcl42/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "flcl42",
      "id": 630501,
      "node_id": "MDQ6VXNlcjYzMDUwMQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/630501?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/flcl42",
      "html_url": "https://github.com/flcl42",
      "followers_url": "https://api.github.com/users/flcl42/followers",
      "following_url": "https://api.github.com/users/flcl42/following{/other_user}",
      "gists_url": "https://api.github.com/users/flcl42/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/flcl42/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/flcl42/subscriptions",
      "organizations_url": "https://api.github.com/users/flcl42/orgs",
      "repos_url": "https://api.github.com/users/flcl42/repos",
      "events_url": "https://api.github.com/users/flcl42/events{/privacy}",
      "received_events_url": "https://api.github.com/users/flcl42/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2022-06-22T15:55:14Z",
  "updated_at": "2022-08-31T17:37:52Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "**Describe the bug**\r\nWhile shutting down nethermind there was a segfault observed (race condition?).\r\n\r\n**To Reproduce** (happened only once in over 30 restarts in the last several days on several nodes)\r\n1. stop nethermind\r\n2. observe kernel log\r\n\r\n**Expected behavior**\r\nA clean shutdown without Segfaults\r\n\r\n**Desktop (please complete the following information):**\r\n - OS: Ubuntu Focal 20.04 LTS \r\n - Nethermind 1.13.3\r\n - rocksdb\r\n\r\n**Syslog**\r\n```\r\nJun 22 16:11:02 node1 Nethermind.Runner[4743]: 2022-06-22 16:11:02.5679|Processed   15007992 |      289ms of   9,198ms, mgasps   67.86 total   34.25, tps  830.51 total  421.78, bps    3.46 total    1.09, recv queue 0, proc queue 0\r\nJun 22 16:11:12 node1 Nethermind.Runner[4743]: 2022-06-22 16:11:12.2548|Peers | with known best block: 7 | all: 16 |\r\nJun 22 16:11:26 node1 Nethermind.Runner[4743]: 2022-06-22 16:11:26.2867|Processed   15007993 |      998ms of  23,719ms, mgasps   24.42 total   34.24, tps  375.82 total  421.71, bps    1.00 total    1.09, recv queue 0, proc queue 0\r\nJun 22 16:11:27 node1 Nethermind.Runner[4743]: 2022-06-22 16:11:27.2552|Peers | with known best block: 7 | all: 16 |\r\nJun 22 16:11:27 node1 Nethermind.Runner[4743]: 2022-06-22 16:11:27.2552|Sync peers 7(16)/15\r\nJun 22 16:11:30 node1 Nethermind.Runner[4743]: 2022-06-22 16:11:30.7804|Processed   15007994 |      496ms of   4,494ms, mgasps   65.85 total   34.26, tps  892.01 total  422.09, bps    2.02 total    1.09, recv queue 0, proc queue 0\r\nJun 22 16:11:42 node1 Nethermind.Runner[4743]: 2022-06-22 16:11:42.2587|Peers | with known best block: 7 | all: 16 |\r\nJun 22 16:11:45 node1 Nethermind.Runner[4743]: 2022-06-22 16:11:45.1953|Processed   15007996 |    1,027ms of  14,415ms, mgasps   32.72 total   34.26, tps  433.38 total  422.11, bps    1.95 total    1.09, recv queue 0, proc queue 0\r\nJun 22 16:11:57 node1 Nethermind.Runner[4743]: 2022-06-22 16:11:57.2607|Peers | with known best block: 7 | all: 16 |\r\nJun 22 16:12:02 node1 Nethermind.Runner[4743]: 2022-06-22 16:12:02.1883|Processed   15007997 |      885ms of  16,993ms, mgasps   41.53 total   34.27, tps  568.20 total  422.31, bps    1.13 total    1.09, recv queue 0, proc queue 0\r\nJun 22 16:12:06 node1 Nethermind.Runner[4743]: 2022-06-22 16:12:06.3971|Processed   15007998 |      118ms of   4,209ms, mgasps  211.53 total   34.30, tps 2842.18 total  422.77, bps    8.46 total    1.10, recv queue 0, proc queue 0\r\nJun 22 16:12:08 node1 systemd[1]: Stopping Nethermind Node...\r\nJun 22 16:12:08 node1 Nethermind.Runner[4743]: 2022-06-22 16:12:08.8036|Closing, please wait until all functions are stopped properly...\r\nJun 22 16:12:08 node1 Nethermind.Runner[4743]: 2022-06-22 16:12:08.8110|Persisting trie...\r\nJun 22 16:12:10 node1 Nethermind.Runner[4743]: 2022-06-22 16:12:10.4405|Stopping session monitor...\r\nJun 22 16:12:10 node1 Nethermind.Runner[4743]: 2022-06-22 16:12:10.4423|Stopping discovery app...\r\nJun 22 16:12:10 node1 Nethermind.Runner[4743]: 2022-06-22 16:12:10.4475|Stopping discovery udp channel\r\nJun 22 16:12:10 node1 Nethermind.Runner[4743]: 2022-06-22 16:12:10.4475|Stopping block producer...\r\nJun 22 16:12:10 node1 Nethermind.Runner[4743]: 2022-06-22 16:12:10.4475|Stopping sync peer pool...\r\nJun 22 16:12:10 node1 Nethermind.Runner[4743]: 2022-06-22 16:12:10.4506|Stopping peer pool...\r\nJun 22 16:12:10 node1 Nethermind.Runner[4743]: 2022-06-22 16:12:10.4506|Peer Pool shutdown complete.. please wait for all components to close\r\nJun 22 16:12:10 node1 Nethermind.Runner[4743]: 2022-06-22 16:12:10.4506|Stopping peer manager...\r\nJun 22 16:12:10 node1 Nethermind.Runner[4743]: 2022-06-22 16:12:10.4506|Discovery shutdown complete.. please wait for all components to close\r\nJun 22 16:12:10 node1 Nethermind.Runner[4743]: 2022-06-22 16:12:10.4506|Peer Manager shutdown complete.. please wait for all components to close\r\nJun 22 16:12:10 node1 Nethermind.Runner[4743]: 2022-06-22 16:12:10.4506|Stopping synchronizer...\r\nJun 22 16:12:10 node1 Nethermind.Runner[4743]: 2022-06-22 16:12:10.4547|Peer update loop canceled\r\nJun 22 16:12:10 node1 Nethermind.Runner[4743]: 2022-06-22 16:12:10.4547|State sync task completed.\r\nJun 22 16:12:10 node1 Nethermind.Runner[4743]: 2022-06-22 16:12:10.4547|Fast sync blocks downloader task completed.\r\nJun 22 16:12:10 node1 Nethermind.Runner[4743]: 2022-06-22 16:12:10.4547|Fast blocks bodies task completed.\r\nJun 22 16:12:10 node1 Nethermind.Runner[4743]: 2022-06-22 16:12:10.4547|Stopping blockchain processor...\r\nJun 22 16:12:10 node1 Nethermind.Runner[4743]: 2022-06-22 16:12:10.4547|Fast blocks receipts task completed.\r\nJun 22 16:12:10 node1 Nethermind.Runner[4743]: 2022-06-22 16:12:10.4547|Full sync block downloader task completed.\r\nJun 22 16:12:10 node1 Nethermind.Runner[4743]: 2022-06-22 16:12:10.4547|Fast blocks headers task completed.\r\nJun 22 16:12:10 node1 Nethermind.Runner[4743]: 2022-06-22 16:12:10.4609|Stopping rlpx peer...\r\nJun 22 16:12:10 node1 kernel: [ 3822.871420] show_signal_msg: 57 callbacks suppressed\r\nJun 22 16:12:10 node1 kernel: [ 3822.871423] .NET Long Runni[5025]: segfault at 750000000a ip 00007f3649a29094 sp 00007f3600ff7b58 error 4 in librocksdb.so[7f36496bf000+70a000]\r\nJun 22 16:12:10 node1 kernel: [ 3822.871435] Code: 12 e4 e4 ff 66 90 0f b6 47 30 c3 90 66 2e 0f 1f 84 00 00 00 00 00 c6 47 30 01 c3 90 66 2e 0f 1f 84 00 00 00 00 00 48 8b 47 38 <8b> 40 08 c3 0f 1f 84 00 00 00 00 00 e9 db 31 e4 ff 90 66 2e 0f 1f\r\nJun 22 16:12:11 node1 systemd[1]: nethermind.service: Main process exited, code=killed, status=11/SEGV\r\nJun 22 16:12:11 node1 systemd[1]: nethermind.service: Failed with result 'signal'.\r\nJun 22 16:12:11 node1 systemd[1]: Stopped Nethermind Node.\r\n```\r\n\r\n**Additional information**\r\n\r\n```\r\n% dpkg -l | grep -P 'snappy|rocksdb'\r\nii  librocksdb5.17                     5.17.2-3                          amd64        persistent Key-Value Store for Flash and RAM Storage\r\nii  libsnappy-dev:amd64                1.1.8-1build1                     amd64        fast compression/decompression library (development files)\r\nii  libsnappy1v5:amd64                 1.1.8-1build1                     amd64        fast compression/decompression library\r\n```\r\n\r\n```\r\n% cat /etc/systemd/system/nethermind.service\r\n[Unit]\r\nDescription=Nethermind Node\r\nDocumentation=https://docs.nethermind.io\r\nAfter=network.target\r\n\r\n[Service]\r\nUser=nethermind\r\nGroup=nethermind\r\n\r\nWorkingDirectory=/home/nethermind/.nm-data\r\nEnvironmentFile=/home/nethermind/.nm-data/.env\r\nExecStart=/home/nethermind/nethermind-client/Nethermind.Runner --datadir /home/nethermind/.nm-data\r\nLimitNOFILE=1000000\r\n\r\nRestart=always\r\nPrivateTmp=true\r\nTimeoutStopSec=900s\r\nTimeoutStartSec=3s\r\nStartLimitInterval=120s\r\nStartLimitBurst=5\r\n\r\n[Install]\r\nWantedBy=default.target\r\n```\r\n\r\n```\r\n% cat /home/nethermind/.nm-data/.env\r\nNETHERMIND_CONFIG=\"mainnet\"\r\nNETHERMIND_JSONRPCCONFIG_ENABLED=\"true\"\r\nNETHERMIND_JSONRPCCONFIG_HOST=\"0.0.0.0\"\r\nNETHERMIND_NETWORKCONFIG_MAXACTIVEPEERS=\"15\"\r\nNETHERMIND_INITCONFIG_LOGFILENAME=\"log.txt\"\r\n#\r\n# Special\r\n#\r\nNETHERMIND_NETWORKCONFIG_P2PPORT=\"30304\"\r\nNETHERMIND_NETWORKCONFIG_DISCOVERYPORT=\"30304\"\r\nNETHERMIND_JSONRPCCONFIG_PORT=8546\r\n```",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/4192/reactions",
    "total_count": 1,
    "+1": 1,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/4192/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/1163340179",
    "html_url": "https://github.com/NethermindEth/nethermind/issues/4192#issuecomment-1163340179",
    "issue_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/4192",
    "id": 1163340179,
    "node_id": "IC_kwDOBggaLc5FVymT",
    "user": {
      "login": "gituser",
      "id": 104405,
      "node_id": "MDQ6VXNlcjEwNDQwNQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/104405?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gituser",
      "html_url": "https://github.com/gituser",
      "followers_url": "https://api.github.com/users/gituser/followers",
      "following_url": "https://api.github.com/users/gituser/following{/other_user}",
      "gists_url": "https://api.github.com/users/gituser/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gituser/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gituser/subscriptions",
      "organizations_url": "https://api.github.com/users/gituser/orgs",
      "repos_url": "https://api.github.com/users/gituser/repos",
      "events_url": "https://api.github.com/users/gituser/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gituser/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-06-22T16:26:50Z",
    "updated_at": "2022-06-22T16:27:39Z",
    "author_association": "NONE",
    "body": "Noticed similar error but in libpthread-2.27.so on Ubuntu 18.04 too:\r\n\r\n```\r\n[14953629.035999] .NET ThreadPool[4069491]: segfault at 18 ip 00007f6d54d03892 sp 00007f64acdfbf40 error 4 in libpthread-2.27.so[7f6d54cf7000+1a000]\r\n[14953629.036156] Code: ff 83 f8 92 0f 85 3e ff ff ff eb cc 66 2e 0f 1f 84 00 00 00 00 00 66 90 41 57 41 56 41 55 41 54 55 53 48 89 fb 48 83 ec 08 90 <8b> 57 18 64 8b 04 25 d0 02 00 00 39 c2 74 6f 8b 07 89 c1 89 c2 83\r\n[14953930.360088] SingleThreadEve[4078154]: segfault at 18 ip 00007f4286a18892 sp 00007f3a17fce2d0 error 4 in libpthread-2.27.so[7f4286a0c000+1a000]\r\n[14953930.360122] SingleThreadEve[4078155]: segfault at 18 ip 00007f4286a18892 sp 00007f3a177cd2d0 error 4 in libpthread-2.27.so[7f4286a0c000+1a000]\r\n[14953930.360267] Code: ff 83 f8 92 0f 85 3e ff ff ff eb cc 66 2e 0f 1f 84 00 00 00 00 00 66 90 41 57 41 56 41 55 41 54 55 53 48 89 fb 48 83 ec 08 90 <8b> 57 18 64 8b 04 25 d0 02 00 00 39 c2 74 6f 8b 07 89 c1 89 c2 83\r\n[14953930.360412] Code: ff 83 f8 92 0f 85 3e ff ff ff eb cc 66 2e 0f 1f 84 00 00 00 00 00 66 90 41 57 41 56 41 55 41 54 55 53 48 89 fb 48 83 ec 08 90 <8b> 57 18 64 8b 04 25 d0 02 00 00 39 c2 74 6f 8b 07 89 c1 89 c2 83\r\n[14954129.972989] SingleThreadEve[4080910]: segfault at 18 ip 00007f0dda8cb892 sp 00007f05687c72d0 error 4 in libpthread-2.27.so[7f0dda8bf000+1a000]\r\n[14954129.973148] Code: ff 83 f8 92 0f 85 3e ff ff ff eb cc 66 2e 0f 1f 84 00 00 00 00 00 66 90 41 57 41 56 41 55 41 54 55 53 48 89 fb 48 83 ec 08 90 <8b> 57 18 64 8b 04 25 d0 02 00 00 39 c2 74 6f 8b 07 89 c1 89 c2 83\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/1163340179/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
