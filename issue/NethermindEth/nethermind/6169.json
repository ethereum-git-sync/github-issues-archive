{
  "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/6169",
  "repository_url": "https://api.github.com/repos/NethermindEth/nethermind",
  "labels_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/6169/labels{/name}",
  "comments_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/6169/comments",
  "events_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/6169/events",
  "html_url": "https://github.com/NethermindEth/nethermind/issues/6169",
  "id": 1931050480,
  "node_id": "I_kwDOBggaLc5zGX3w",
  "number": 6169,
  "title": "Websockets failing after upgrade to 1.21.0",
  "user": {
    "login": "coffeexcoin",
    "id": 137969418,
    "node_id": "U_kgDOCDk_Cg",
    "avatar_url": "https://avatars.githubusercontent.com/u/137969418?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/coffeexcoin",
    "html_url": "https://github.com/coffeexcoin",
    "followers_url": "https://api.github.com/users/coffeexcoin/followers",
    "following_url": "https://api.github.com/users/coffeexcoin/following{/other_user}",
    "gists_url": "https://api.github.com/users/coffeexcoin/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/coffeexcoin/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/coffeexcoin/subscriptions",
    "organizations_url": "https://api.github.com/users/coffeexcoin/orgs",
    "repos_url": "https://api.github.com/users/coffeexcoin/repos",
    "events_url": "https://api.github.com/users/coffeexcoin/events{/privacy}",
    "received_events_url": "https://api.github.com/users/coffeexcoin/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2023-10-06T23:46:10Z",
  "updated_at": "2023-10-07T01:12:07Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "**Description**\r\nWebsocket connection is completely broken since update to 1.21.0\r\n\r\n**Steps to Reproduce**\r\n\r\nContainerized minimal repro at https://github.com/coffeexcoin/dotnet-nethermind-repro\r\n\r\n```\r\ngit clone https://github.com/coffeexcoin/dotnet-nethermind-repro\r\ncd dotnet-nethermind-repro\r\ndocker build . -t repro\r\ndocker run -e WS_URL=ws://[your_node_ip:port] --network=bridge repro:latest\r\n```\r\n\r\n**Actual behavior**\r\nConnection dies immediately or within one block\r\n```\r\ninfo: default[0]\r\n      Connecting to ws://192.168.3.2:8545\r\nfail: default[0]\r\n      Error in subscription\r\n      Nethereum.JsonRpc.Client.RpcResponseException: Client connection error\r\nfail: default[0]\r\n      Error in subscription\r\n      Nethereum.JsonRpc.Client.RpcResponseException: Client connection error\r\nfail: default[0]\r\n      RPC Exception, RPC Request: RPC Response: \r\n      Newtonsoft.Json.JsonReaderException: After parsing a value an unexpected character was encountered: j. Path 'params.result.transactions[37]', line 1, position 4098.\r\n         at Newtonsoft.Json.JsonTextReader.ParsePostValue(Boolean ignoreComments)\r\n         at Newtonsoft.Json.JsonTextReader.Read()\r\n         at Newtonsoft.Json.JsonWriter.WriteToken(JsonReader reader, Boolean writeChildren, Boolean writeDateConstructorAsDate, Boolean writeComments)\r\n         at Newtonsoft.Json.Linq.JTokenWriter.WriteToken(JsonReader reader, Boolean writeChildren, Boolean writeDateConstructorAsDate, Boolean writeComments)\r\n         at Newtonsoft.Json.JsonWriter.WriteToken(JsonReader reader, Boolean writeChildren)\r\n         at Newtonsoft.Json.JsonWriter.WriteToken(JsonReader reader)\r\n         at Newtonsoft.Json.Serialization.JsonSerializerInternalReader.CreateJToken(JsonReader reader, JsonContract contract)\r\n         at Newtonsoft.Json.Serialization.JsonSerializerInternalReader.SetPropertyValue(JsonProperty property, JsonConverter propertyConverter, JsonContainerContract containerContract, JsonProperty containerProperty, JsonReader reader, Object target)\r\n         at Newtonsoft.Json.Serialization.JsonSerializerInternalReader.PopulateObject(Object newObject, JsonReader reader, JsonObjectContract contract, JsonProperty member, String id)\r\n         at Newtonsoft.Json.Serialization.JsonSerializerInternalReader.CreateObject(JsonReader reader, Type objectType, JsonContract contract, JsonProperty member, JsonContainerContract containerContract, JsonProperty containerMember, Object existingValue)\r\n         at Newtonsoft.Json.Serialization.JsonSerializerInternalReader.SetPropertyValue(JsonProperty property, JsonConverter propertyConverter, JsonContainerContract containerContract, JsonProperty containerProperty, JsonReader reader, Object target)\r\n         at Newtonsoft.Json.Serialization.JsonSerializerInternalReader.PopulateObject(Object newObject, JsonReader reader, JsonObjectContract contract, JsonProperty member, String id)\r\n         at Newtonsoft.Json.Serialization.JsonSerializerInternalReader.CreateObject(JsonReader reader, Type objectType, JsonContract contract, JsonProperty member, JsonContainerContract containerContract, JsonProperty containerMember, Object existingValue)\r\n         at Newtonsoft.Json.Serialization.JsonSerializerInternalReader.Deserialize(JsonReader reader, Type objectType, Boolean checkAdditionalContent)\r\n         at Newtonsoft.Json.JsonSerializer.DeserializeInternal(JsonReader reader, Type objectType)\r\n         at Newtonsoft.Json.JsonSerializer.Deserialize(JsonReader reader, Type objectType)\r\n         at Newtonsoft.Json.JsonSerializer.Deserialize[T](JsonReader reader)\r\n         at Nethereum.JsonRpc.WebSocketStreamingClient.StreamingWebSocketClient.HandleIncomingMessagesAsync()\r\n```\r\n\r\n**Expected behavior**\r\nPersistent websocket connection that does not fail\r\n\r\n**Screenshots**\r\nIf applicable, please include screenshots to help illustrate the problem.\r\n\r\n**Desktop (please complete the following information):**\r\nPlease provide the following information regarding your setup:\r\n - Operating System: debian\r\n - Version: 1.21.0\r\n - Installation Method: Dappnode docker\r\n - Consensus Client: Nimbus 23.5.1\r\n\r\n**Additional context**\r\nIssue appeared immediately after updating Dappnode images from nethermind 1.20.1 to 1.21.0.\r\n\r\nDowngrading my node back to 1.20.1 fixes the issue immediately.\r\n\r\n**Logs**\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/6169/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/6169/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/1751541476",
    "html_url": "https://github.com/NethermindEth/nethermind/issues/6169#issuecomment-1751541476",
    "issue_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/6169",
    "id": 1751541476,
    "node_id": "IC_kwDOBggaLc5oZmbk",
    "user": {
      "login": "coffeexcoin",
      "id": 137969418,
      "node_id": "U_kgDOCDk_Cg",
      "avatar_url": "https://avatars.githubusercontent.com/u/137969418?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/coffeexcoin",
      "html_url": "https://github.com/coffeexcoin",
      "followers_url": "https://api.github.com/users/coffeexcoin/followers",
      "following_url": "https://api.github.com/users/coffeexcoin/following{/other_user}",
      "gists_url": "https://api.github.com/users/coffeexcoin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/coffeexcoin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/coffeexcoin/subscriptions",
      "organizations_url": "https://api.github.com/users/coffeexcoin/orgs",
      "repos_url": "https://api.github.com/users/coffeexcoin/repos",
      "events_url": "https://api.github.com/users/coffeexcoin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/coffeexcoin/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-10-07T01:11:36Z",
    "updated_at": "2023-10-07T01:11:36Z",
    "author_association": "NONE",
    "body": "Ethers js repro here: https://github.com/coffeexcoin/node-nethermind-repro\r\n\r\n### Run\r\n```\r\ngit clone https://github.com/coffeexcoin/node-nethermind-repro\r\ncd node-nethermind-repro\r\nnpm i\r\nexport WS_URL=ws://[your_node_ip:port]\r\nnode .\r\n```\r\n\r\nFails after a few blocks with one of the following two errors:\r\n\r\n### Error 1\r\n```\r\nnode:events:491\r\n      throw er; // Unhandled 'error' event\r\n      ^\r\n\r\nRangeError: Invalid WebSocket frame: invalid opcode 0\r\n    at Receiver.getInfo (/Users/coffee/code/node-nethermind-repro/node_modules/ws/lib/receiver.js:216:16)\r\n    at Receiver.startLoop (/Users/coffee/code/node-nethermind-repro/node_modules/ws/lib/receiver.js:136:22)\r\n    at Receiver._write (/Users/coffee/code/node-nethermind-repro/node_modules/ws/lib/receiver.js:83:10)\r\n    at writeOrBuffer (node:internal/streams/writable:392:12)\r\n    at _write (node:internal/streams/writable:333:10)\r\n    at Writable.write (node:internal/streams/writable:337:10)\r\n    at Socket.socketOnData (/Users/coffee/code/node-nethermind-repro/node_modules/ws/lib/websocket.js:1231:35)\r\n    at Socket.emit (node:events:513:28)\r\n    at addChunk (node:internal/streams/readable:324:12)\r\n    at readableAddChunk (node:internal/streams/readable:297:9)\r\nEmitted 'error' event on WebSocket instance at:\r\n    at Receiver.receiverOnError (/Users/coffee/code/node-nethermind-repro/node_modules/ws/lib/websocket.js:1117:13)\r\n    at Receiver.emit (node:events:513:28)\r\n    at emitErrorNT (node:internal/streams/destroy:151:8)\r\n    at emitErrorCloseNT (node:internal/streams/destroy:116:3)\r\n    at process.processTicksAndRejections (node:internal/process/task_queues:82:21) {\r\n  code: 'WS_ERR_INVALID_OPCODE',\r\n  [Symbol(status-code)]: 1002\r\n}\r\n```\r\n\r\n### Error 2\r\n```\r\nundefined:1\r\n{\"jsonrpc\":\"2.0\",\"method\":\"eth_subscription\",\"params\":{\"subscription\":\"0x60ae20377bb64552beae17bc7642b641\",\"result\":{\"address\":\"0xd29f5f02f5ffcd102faf467f2f236c601830780d\",\"blockHash\":\"0x568b7829b5f322cee9621a7a059e0cbd97ed4a6a1f404415cbfde1cedf5c0112\",\"blockNumber\":\"0x11729c9\",\"data\":\"0x\",\"logIndex\":\"0x44\",\"removed\":false,\"topics\":[\"0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef\",\"0x0000000000000000000000003103d824e9862112bba56f8be0d029385de54554\",\"0x000000000000000000000000ef0b56692f78a44cf4034b07f80204757c31bcc9\",\"0x0000000000000000000000000000000000000000000000000000000000001b8f\"],\"transactionHash\":\"0xaff1500d4746cfc43497ccda4f6ace28eb5c55f2e1a00b975158219013121de9\",\"transactionIndex\":\"0x1c\",\"transactionLogIndex\":\"0x0\"}}}{\"jsonrpc\":\"2.0\",\"method\":\"eth_subscription\",\"params\":{\"subscription\":\"0x60ae20377bb64552beae17bc7642b641\",\"result\":{\"address\":\"0xd29f5f02f5ffcd102faf467f2f236c601830780d\",\"blockHash\":\"0x568b7829b5f322cee9621a7a059e0cbd97ed4a6a1f404415cbfde1cedf5c0112\",\"blockNumber\":\"0x11729c9\",\"data\":\"0x\",\"logIndex\":\"0x46\",\"removed\":false,\"topics\":[\"0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef\",\"0x000000000000000000000000ef0b56692f78a44cf4034b07f80204757c31bcc9\",\"0x00000000000000000000000095eab0299f6b29c231a275bd78eeecd0953a0900\",\"0x0000000000000000000000000000000000000000000000000000000000001b8f\"],\"transactionHash\":\"0xaff1500d4746cfc43497ccda4f6ace28eb5c55f2e1a00b975158219013121de9\",\"transactionIndex\":\"0x1c\",\"transactionLogIndex\":\"0x2\"}}}\r\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ^\r\n\r\nSyntaxError: Unexpected token { in JSON at position 755\r\n    at JSON.parse (<anonymous>)\r\n    at WebSocketProvider._processMessage (file:///Users/coffee/code/node-nethermind-repro/node_modules/ethers/lib.esm/providers/provider-socket.js:241:30)\r\n    at WebSocketProvider.websocket.onmessage (file:///Users/coffee/code/node-nethermind-repro/node_modules/ethers/lib.esm/providers/provider-websocket.js:47:18)\r\n    at WebSocket.onMessage (/Users/coffee/code/node-nethermind-repro/node_modules/ws/lib/event-target.js:199:18)\r\n    at WebSocket.emit (node:events:513:28)\r\n    at Receiver.receiverOnMessage (/Users/coffee/code/node-nethermind-repro/node_modules/ws/lib/websocket.js:1137:20)\r\n    at Receiver.emit (node:events:513:28)\r\n    at Receiver.dataMessage (/Users/coffee/code/node-nethermind-repro/node_modules/ws/lib/receiver.js:528:14)\r\n    at Receiver.getData (/Users/coffee/code/node-nethermind-repro/node_modules/ws/lib/receiver.js:446:17)\r\n    at Receiver.startLoop (/Users/coffee/code/node-nethermind-repro/node_modules/ws/lib/receiver.js:148:22)\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/1751541476/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
