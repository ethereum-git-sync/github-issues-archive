{
  "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/3345",
  "repository_url": "https://api.github.com/repos/NethermindEth/nethermind",
  "labels_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/3345/labels{/name}",
  "comments_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/3345/comments",
  "events_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/3345/events",
  "html_url": "https://github.com/NethermindEth/nethermind/issues/3345",
  "id": 981272295,
  "node_id": "MDU6SXNzdWU5ODEyNzIyOTU=",
  "number": 3345,
  "title": "IPC RPC request parsing error",
  "user": {
    "login": "chebykin",
    "id": 2095757,
    "node_id": "MDQ6VXNlcjIwOTU3NTc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2095757?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/chebykin",
    "html_url": "https://github.com/chebykin",
    "followers_url": "https://api.github.com/users/chebykin/followers",
    "following_url": "https://api.github.com/users/chebykin/following{/other_user}",
    "gists_url": "https://api.github.com/users/chebykin/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/chebykin/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/chebykin/subscriptions",
    "organizations_url": "https://api.github.com/users/chebykin/orgs",
    "repos_url": "https://api.github.com/users/chebykin/repos",
    "events_url": "https://api.github.com/users/chebykin/events{/privacy}",
    "received_events_url": "https://api.github.com/users/chebykin/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "dceleda",
    "id": 26231116,
    "node_id": "MDQ6VXNlcjI2MjMxMTE2",
    "avatar_url": "https://avatars.githubusercontent.com/u/26231116?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/dceleda",
    "html_url": "https://github.com/dceleda",
    "followers_url": "https://api.github.com/users/dceleda/followers",
    "following_url": "https://api.github.com/users/dceleda/following{/other_user}",
    "gists_url": "https://api.github.com/users/dceleda/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/dceleda/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/dceleda/subscriptions",
    "organizations_url": "https://api.github.com/users/dceleda/orgs",
    "repos_url": "https://api.github.com/users/dceleda/repos",
    "events_url": "https://api.github.com/users/dceleda/events{/privacy}",
    "received_events_url": "https://api.github.com/users/dceleda/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "dceleda",
      "id": 26231116,
      "node_id": "MDQ6VXNlcjI2MjMxMTE2",
      "avatar_url": "https://avatars.githubusercontent.com/u/26231116?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dceleda",
      "html_url": "https://github.com/dceleda",
      "followers_url": "https://api.github.com/users/dceleda/followers",
      "following_url": "https://api.github.com/users/dceleda/following{/other_user}",
      "gists_url": "https://api.github.com/users/dceleda/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dceleda/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dceleda/subscriptions",
      "organizations_url": "https://api.github.com/users/dceleda/orgs",
      "repos_url": "https://api.github.com/users/dceleda/repos",
      "events_url": "https://api.github.com/users/dceleda/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dceleda/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2021-08-27T13:51:13Z",
  "updated_at": "2021-09-17T10:38:06Z",
  "closed_at": "2021-09-17T10:38:06Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "IPC RPC can't parse two combined requests sent within a single message using web3.js. \r\n\r\n**To Reproduce**\r\n\r\nUsing web3.js subscribe for updates and specify a block to subscribe from:\r\n\r\n```js\r\nconst Web3 = require('web3');\r\nconst net = require('net');\r\nconst web3 = new Web3(new Web3.providers.IpcProvider('/path/to/xdai/ipc/jsonrpc.ipc', net));\r\n\r\n(async function () {\r\n  web3.eth\r\n    .subscribe('logs', { fromBlock: '17788909', address: '0xe91D153E0b41518A2Ce8Dd3D7944Fa863463a97d' })\r\n    .on('data', function (log) {\r\n      console.log('>>>', log.blockNumber, log.transactionHash);\r\n    })\r\n})();\r\n```\r\n\r\nJS error:\r\n\r\n```js\r\n/home/ubuntu/app/node_modules/web3/node_modules/web3-providers-ipc/lib/index.js:49\r\n        if (!id && result.method.indexOf('_subscription') !== -1) {\r\n                                 ^\r\n\r\nTypeError: Cannot read property 'indexOf' of undefined\r\n    at callback (/home/ubuntu/app/node_modules/web3/node_modules/web3-providers-ipc/lib/index.js:49:34)\r\n    at Array.forEach (<anonymous>)\r\n    at Socket.<anonymous> (/home/ubuntu/app/node_modules/web3/node_modules/web3-providers-ipc/lib/index.js:68:51)\r\n    at Socket.emit (events.js:314:20)\r\n    at addChunk (_stream_readable.js:297:12)\r\n    at readableAddChunk (_stream_readable.js:272:9)\r\n    at Socket.Readable.push (_stream_readable.js:213:10)\r\n    at Pipe.onStreamRead (internal/stream_base_commons.js:188:23)\r\n```\r\n\r\nRPC module log:\r\n\r\n```\r\nAug 27 13:37:19 frontier Nethermind.Runner[22942]: 2021-08-27 13:37:19.9958|Error during parsing/validation, request: {\"jsonrpc\":\"2.0\",\"id\":1,\"method\":\"eth_getLogs\",\"params\":[{\"fromBlock\":\"0x10f6fed\",\"address\":\"0xe91d153e0b41518a2ce8dd3d7944fa863463a97d\",\"topics\":[]}]}{\"jsonrpc\":\"2.0\",\"id\":2,\"method\":\"eth_subscribe\",\"params\":[\"logs\",{\"address\":\"0xe91d153e0b41518a2ce8dd3d7944fa863463a97d\",\"topics\":[]}]} Newtonsoft.Json.JsonReaderException: Additional text encountered after finished reading JSON content: {. Path '', line 1, position 151.\r\nAug 27 13:37:19 frontier Nethermind.Runner[22942]:    at Newtonsoft.Json.JsonTextReader.Read()\r\nAug 27 13:37:19 frontier Nethermind.Runner[22942]:    at Newtonsoft.Json.Linq.JToken.Parse(String json, JsonLoadSettings settings)\r\nAug 27 13:37:19 frontier Nethermind.Runner[22942]:    at Nethermind.JsonRpc.JsonRpcProcessor.DeserializeObjectOrArray(String json)\r\nAug 27 13:37:19 frontier Nethermind.Runner[22942]:    at Nethermind.JsonRpc.JsonRpcProcessor.ProcessAsync(String request, JsonRpcContext context)\r\n```\r\n\r\n\r\n**Expected behavior**\r\n\r\nParity and Geth work fine with this case.",
  "closed_by": {
    "login": "LukaszRozmej",
    "id": 12445221,
    "node_id": "MDQ6VXNlcjEyNDQ1MjIx",
    "avatar_url": "https://avatars.githubusercontent.com/u/12445221?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/LukaszRozmej",
    "html_url": "https://github.com/LukaszRozmej",
    "followers_url": "https://api.github.com/users/LukaszRozmej/followers",
    "following_url": "https://api.github.com/users/LukaszRozmej/following{/other_user}",
    "gists_url": "https://api.github.com/users/LukaszRozmej/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/LukaszRozmej/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/LukaszRozmej/subscriptions",
    "organizations_url": "https://api.github.com/users/LukaszRozmej/orgs",
    "repos_url": "https://api.github.com/users/LukaszRozmej/repos",
    "events_url": "https://api.github.com/users/LukaszRozmej/events{/privacy}",
    "received_events_url": "https://api.github.com/users/LukaszRozmej/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/3345/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/3345/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/907362518",
    "html_url": "https://github.com/NethermindEth/nethermind/issues/3345#issuecomment-907362518",
    "issue_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/3345",
    "id": 907362518,
    "node_id": "IC_kwDOBggaLc42FUDW",
    "user": {
      "login": "dceleda",
      "id": 26231116,
      "node_id": "MDQ6VXNlcjI2MjMxMTE2",
      "avatar_url": "https://avatars.githubusercontent.com/u/26231116?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dceleda",
      "html_url": "https://github.com/dceleda",
      "followers_url": "https://api.github.com/users/dceleda/followers",
      "following_url": "https://api.github.com/users/dceleda/following{/other_user}",
      "gists_url": "https://api.github.com/users/dceleda/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dceleda/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dceleda/subscriptions",
      "organizations_url": "https://api.github.com/users/dceleda/orgs",
      "repos_url": "https://api.github.com/users/dceleda/repos",
      "events_url": "https://api.github.com/users/dceleda/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dceleda/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-08-27T17:34:23Z",
    "updated_at": "2021-08-27T17:35:43Z",
    "author_association": "CONTRIBUTOR",
    "body": "Currently we don't support multiple json requests sent in one message or streamed continuously. We never have either for WS or IPC.\r\nFor example this throws an error:\r\n`{\"method\":\"txpool_content\",\"params\":[],\"id\":1,\"jsonrpc\":\"2.0\"}{\"method\":\"txpool_content\",\"params\":[],\"id\":1,\"jsonrpc\":\"2.0\"}\r\n`\r\n\r\nWhat we do support is an array of messages:\r\n`[{\"method\":\"txpool_content\",\"params\":[],\"id\":1,\"jsonrpc\":\"2.0\"} , {\"method\":\"txpool_content\",\"params\":[],\"id\":1,\"jsonrpc\":\"2.0\"}]`\r\n\r\nTo change that behavior we could introduce JsonTextReader with SupportMultipleContent = true",
    "reactions": {
      "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/907362518/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/916664691",
    "html_url": "https://github.com/NethermindEth/nethermind/issues/3345#issuecomment-916664691",
    "issue_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/3345",
    "id": 916664691,
    "node_id": "IC_kwDOBggaLc42ozFz",
    "user": {
      "login": "chebykin",
      "id": 2095757,
      "node_id": "MDQ6VXNlcjIwOTU3NTc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2095757?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chebykin",
      "html_url": "https://github.com/chebykin",
      "followers_url": "https://api.github.com/users/chebykin/followers",
      "following_url": "https://api.github.com/users/chebykin/following{/other_user}",
      "gists_url": "https://api.github.com/users/chebykin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chebykin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chebykin/subscriptions",
      "organizations_url": "https://api.github.com/users/chebykin/orgs",
      "repos_url": "https://api.github.com/users/chebykin/repos",
      "events_url": "https://api.github.com/users/chebykin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chebykin/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-09-10T06:29:43Z",
    "updated_at": "2021-09-10T06:29:43Z",
    "author_association": "NONE",
    "body": "I want to clarify this a bit more. I was wrong in writing that these `eth_getLogs` and `eth_subscribe` requests were sent within a single socket message. Actually, each of them is sent with separate `net.Socket.write` call [here](https://github.com/ChainSafe/web3.js/blob/c70722b919ac81e45760b9648c4b92fd8d0eeee1/packages/web3-providers-ipc/src/index.js#L212).\r\n\r\nAlso, the same subscription example above can be handled by Nethermind either correctly, as two distinct requests, or with an error, when it treats these two requests as a single one.",
    "reactions": {
      "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/916664691/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/919095164",
    "html_url": "https://github.com/NethermindEth/nethermind/issues/3345#issuecomment-919095164",
    "issue_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/3345",
    "id": 919095164,
    "node_id": "IC_kwDOBggaLc42yEd8",
    "user": {
      "login": "dceleda",
      "id": 26231116,
      "node_id": "MDQ6VXNlcjI2MjMxMTE2",
      "avatar_url": "https://avatars.githubusercontent.com/u/26231116?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dceleda",
      "html_url": "https://github.com/dceleda",
      "followers_url": "https://api.github.com/users/dceleda/followers",
      "following_url": "https://api.github.com/users/dceleda/following{/other_user}",
      "gists_url": "https://api.github.com/users/dceleda/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dceleda/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dceleda/subscriptions",
      "organizations_url": "https://api.github.com/users/dceleda/orgs",
      "repos_url": "https://api.github.com/users/dceleda/repos",
      "events_url": "https://api.github.com/users/dceleda/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dceleda/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-09-14T12:18:09Z",
    "updated_at": "2021-09-14T12:18:09Z",
    "author_association": "CONTRIBUTOR",
    "body": "It seems Geth handles such scenario differently in WS and in IPC.\r\nhttps://github.com/ethereum/go-ethereum/issues/23575",
    "reactions": {
      "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/919095164/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
