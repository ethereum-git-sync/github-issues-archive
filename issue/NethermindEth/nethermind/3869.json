{
  "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/3869",
  "repository_url": "https://api.github.com/repos/NethermindEth/nethermind",
  "labels_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/3869/labels{/name}",
  "comments_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/3869/comments",
  "events_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/3869/events",
  "html_url": "https://github.com/NethermindEth/nethermind/issues/3869",
  "id": 1166187625,
  "node_id": "I_kwDOBggaLc5Fgpxp",
  "number": 3869,
  "title": "Nethermind 1.12.5: trace_replayBlockTransactions method returns Nethermind.Trie.TrieException: Failed to load key",
  "user": {
    "login": "vbaranov",
    "id": 4341812,
    "node_id": "MDQ6VXNlcjQzNDE4MTI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4341812?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/vbaranov",
    "html_url": "https://github.com/vbaranov",
    "followers_url": "https://api.github.com/users/vbaranov/followers",
    "following_url": "https://api.github.com/users/vbaranov/following{/other_user}",
    "gists_url": "https://api.github.com/users/vbaranov/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/vbaranov/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/vbaranov/subscriptions",
    "organizations_url": "https://api.github.com/users/vbaranov/orgs",
    "repos_url": "https://api.github.com/users/vbaranov/repos",
    "events_url": "https://api.github.com/users/vbaranov/events{/privacy}",
    "received_events_url": "https://api.github.com/users/vbaranov/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "LukaszRozmej",
    "id": 12445221,
    "node_id": "MDQ6VXNlcjEyNDQ1MjIx",
    "avatar_url": "https://avatars.githubusercontent.com/u/12445221?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/LukaszRozmej",
    "html_url": "https://github.com/LukaszRozmej",
    "followers_url": "https://api.github.com/users/LukaszRozmej/followers",
    "following_url": "https://api.github.com/users/LukaszRozmej/following{/other_user}",
    "gists_url": "https://api.github.com/users/LukaszRozmej/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/LukaszRozmej/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/LukaszRozmej/subscriptions",
    "organizations_url": "https://api.github.com/users/LukaszRozmej/orgs",
    "repos_url": "https://api.github.com/users/LukaszRozmej/repos",
    "events_url": "https://api.github.com/users/LukaszRozmej/events{/privacy}",
    "received_events_url": "https://api.github.com/users/LukaszRozmej/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "LukaszRozmej",
      "id": 12445221,
      "node_id": "MDQ6VXNlcjEyNDQ1MjIx",
      "avatar_url": "https://avatars.githubusercontent.com/u/12445221?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/LukaszRozmej",
      "html_url": "https://github.com/LukaszRozmej",
      "followers_url": "https://api.github.com/users/LukaszRozmej/followers",
      "following_url": "https://api.github.com/users/LukaszRozmej/following{/other_user}",
      "gists_url": "https://api.github.com/users/LukaszRozmej/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/LukaszRozmej/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/LukaszRozmej/subscriptions",
      "organizations_url": "https://api.github.com/users/LukaszRozmej/orgs",
      "repos_url": "https://api.github.com/users/LukaszRozmej/repos",
      "events_url": "https://api.github.com/users/LukaszRozmej/events{/privacy}",
      "received_events_url": "https://api.github.com/users/LukaszRozmej/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2022-03-11T09:24:19Z",
  "updated_at": "2022-03-15T15:57:55Z",
  "closed_at": "2022-03-15T15:57:55Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "Nethermind version: `\"Nethermind/v1.12.5-0-84e702817-20220310/X64-Linux/6.0.2\"`\r\n\r\nRequest: `curl -H \"Content-type: application/json\" -X POST --data '{\"jsonrpc\":\"2.0\",\"method\":\"trace_replayBlockTransactions\",\"params\":[\"0x1865B40\",[\"trace\"]],\"id\":1}' https://sokol-archive.blockscout.com`\r\n\r\nResponse:\r\n```\r\n{\"jsonrpc\":\"2.0\",\"error\":{\"code\":-32603,\"message\":\"Internal error\",\"data\":\"Nethermind.Trie.TrieException: Failed to load key 0a90f2b2c8c61287e74f14de8cb78c9a937679641fbe1d25b303798c1b6e0615 from root hash 0x75734107c79ac70d6dabc4c05ed86dfeba7c686ab446d59575888192dc8d9834.\\n ---> Nethermind.Trie.TrieException: Node 0x75734107c79ac70d6dabc4c05ed86dfeba7c686ab446d59575888192dc8d9834 is missing from the DB\\n   at Nethermind.Trie.Pruning.TrieStore.LoadRlp(Keccak keccak, IKeyValueStore keyValueStore) in /src/Nethermind/Nethermind.Trie/Pruning/TrieStore.cs:line 331\\n   at Nethermind.Trie.TrieNode.ResolveNode(ITrieNodeResolver tree) in /src/Nethermind/Nethermind.Trie/TrieNode.cs:line 316\\n   at Nethermind.Trie.PatriciaTree.Run(Span`1 updatePath, Int32 nibblesCount, Byte[] updateValue, Boolean isUpdate, Boolean ignoreMissingDelete, Keccak startRootHash) in /src/Nethermind/Nethermind.Trie/PatriciaTree.cs:line 399\\n   at Nethermind.Trie.PatriciaTree.Get(Span`1 rawKey, Keccak rootHash) in /src/Nethermind/Nethermind.Trie/PatriciaTree.cs:line 328\\n   --- End of inner exception stack trace ---\\n   at Nethermind.Trie.PatriciaTree.Get(Span`1 rawKey, Keccak rootHash) in /src/Nethermind/Nethermind.Trie/PatriciaTree.cs:line 328\\n   at Nethermind.State.StateProvider.GetState(Address address) in /src/Nethermind/Nethermind.State/StateProvider.cs:line 659\\n   at Nethermind.State.StateProvider.GetAndAddToCache(Address address) in /src/Nethermind/Nethermind.State/StateProvider.cs:line 685\\n   at Nethermind.State.StateProvider.GetNonce(Address address) in /src/Nethermind/Nethermind.State/StateProvider.cs:line 132\\n   at Nethermind.Blockchain.Processing.BlockProcessor.BlockValidationTransactionsExecutor.ProcessTransactions(Block block, ProcessingOptions processingOptions, BlockReceiptsTracer receiptsTracer, IReleaseSpec spec) in /src/Nethermind/Nethermind.Blockchain/Processing/BlockProcessor.BlockValidationTransactionsExecutor.cs:line 58\\n   at Nethermind.Blockchain.Processing.BlockProcessor.ProcessBlock(Block block, IBlockTracer blockTracer, ProcessingOptions options) in /src/Nethermind/Nethermind.Blockchain/Processing/BlockProcessor.cs:line 266\\n   at Nethermind.Blockchain.Processing.BlockProcessor.ProcessOne(Block suggestedBlock, ProcessingOptions options, IBlockTracer blockTracer) in /src/Nethermind/Nethermind.Blockchain/Processing/BlockProcessor.cs:line 220\\n   at Nethermind.Blockchain.Processing.BlockProcessor.Process(Keccak newBranchStateRoot, List`1 suggestedBlocks, ProcessingOptions options, IBlockTracer blockTracer) in /src/Nethermind/Nethermind.Blockchain/Processing/BlockProcessor.cs:line 119\\n   at Nethermind.Blockchain.Processing.BlockchainProcessor.ProcessBranch(ProcessingBranch processingBranch, ProcessingOptions options, IBlockTracer tracer) in /src/Nethermind/Nethermind.Blockchain/Processing/BlockchainProcessor.cs:line 420\\n   at Nethermind.Blockchain.Processing.BlockchainProcessor.Process(Block suggestedBlock, ProcessingOptions options, IBlockTracer tracer) in /src/Nethermind/Nethermind.Blockchain/Processing/BlockchainProcessor.cs:line 272\\n   at Nethermind.Blockchain.Processing.OneTimeChainProcessor.Process(Block block, ProcessingOptions options, IBlockTracer tracer) in /src/Nethermind/Nethermind.Blockchain/Processing/OneTimeProcessor.cs:line 66\\n   at Nethermind.Blockchain.Tracing.Tracer.Trace(Block block, IBlockTracer blockTracer) in /src/Nethermind/Nethermind.Blockchain/Tracing/Tracer.cs:line 55\\n   at Nethermind.JsonRpc.Modules.Trace.TraceRpcModule.TraceBlock(Block block, ParityTraceTypes traceTypes, TxTraceFilter txTraceFilter) in /src/Nethermind/Nethermind.JsonRpc/Modules/Trace/TraceRpcModule.cs:line 251\\n   at Nethermind.JsonRpc.Modules.Trace.TraceRpcModule.trace_replayBlockTransactions(BlockParameter blockParameter, String[] traceTypes) in /src/Nethermind/Nethermind.JsonRpc/Modules/Trace/TraceRpcModule.cs:line 151\"},\"id\":1}\r\n```",
  "closed_by": {
    "login": "LukaszRozmej",
    "id": 12445221,
    "node_id": "MDQ6VXNlcjEyNDQ1MjIx",
    "avatar_url": "https://avatars.githubusercontent.com/u/12445221?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/LukaszRozmej",
    "html_url": "https://github.com/LukaszRozmej",
    "followers_url": "https://api.github.com/users/LukaszRozmej/followers",
    "following_url": "https://api.github.com/users/LukaszRozmej/following{/other_user}",
    "gists_url": "https://api.github.com/users/LukaszRozmej/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/LukaszRozmej/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/LukaszRozmej/subscriptions",
    "organizations_url": "https://api.github.com/users/LukaszRozmej/orgs",
    "repos_url": "https://api.github.com/users/LukaszRozmej/repos",
    "events_url": "https://api.github.com/users/LukaszRozmej/events{/privacy}",
    "received_events_url": "https://api.github.com/users/LukaszRozmej/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/3869/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/3869/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/1064987607",
    "html_url": "https://github.com/NethermindEth/nethermind/issues/3869#issuecomment-1064987607",
    "issue_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/3869",
    "id": 1064987607,
    "node_id": "IC_kwDOBggaLc4_emvX",
    "user": {
      "login": "varasev",
      "id": 33550681,
      "node_id": "MDQ6VXNlcjMzNTUwNjgx",
      "avatar_url": "https://avatars.githubusercontent.com/u/33550681?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/varasev",
      "html_url": "https://github.com/varasev",
      "followers_url": "https://api.github.com/users/varasev/followers",
      "following_url": "https://api.github.com/users/varasev/following{/other_user}",
      "gists_url": "https://api.github.com/users/varasev/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/varasev/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/varasev/subscriptions",
      "organizations_url": "https://api.github.com/users/varasev/orgs",
      "repos_url": "https://api.github.com/users/varasev/repos",
      "events_url": "https://api.github.com/users/varasev/events{/privacy}",
      "received_events_url": "https://api.github.com/users/varasev/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-03-11T10:36:27Z",
    "updated_at": "2022-03-11T10:36:27Z",
    "author_association": "CONTRIBUTOR",
    "body": "Bound with https://github.com/NethermindEth/nethermind/issues/3849",
    "reactions": {
      "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/1064987607/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/1065067908",
    "html_url": "https://github.com/NethermindEth/nethermind/issues/3869#issuecomment-1065067908",
    "issue_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/3869",
    "id": 1065067908,
    "node_id": "IC_kwDOBggaLc4_e6WE",
    "user": {
      "login": "LukaszRozmej",
      "id": 12445221,
      "node_id": "MDQ6VXNlcjEyNDQ1MjIx",
      "avatar_url": "https://avatars.githubusercontent.com/u/12445221?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/LukaszRozmej",
      "html_url": "https://github.com/LukaszRozmej",
      "followers_url": "https://api.github.com/users/LukaszRozmej/followers",
      "following_url": "https://api.github.com/users/LukaszRozmej/following{/other_user}",
      "gists_url": "https://api.github.com/users/LukaszRozmej/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/LukaszRozmej/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/LukaszRozmej/subscriptions",
      "organizations_url": "https://api.github.com/users/LukaszRozmej/orgs",
      "repos_url": "https://api.github.com/users/LukaszRozmej/repos",
      "events_url": "https://api.github.com/users/LukaszRozmej/events{/privacy}",
      "received_events_url": "https://api.github.com/users/LukaszRozmej/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-03-11T12:25:56Z",
    "updated_at": "2022-03-11T12:25:56Z",
    "author_association": "MEMBER",
    "body": "@vbaranov:\r\n\r\nIn recent release 1.12.5 we have refactored, simplified and cleaned-up our configs, enabling in-memory pruning by default. From release notes:\r\n\r\n\"[Config] Simplify configs, removed *_pruned configs, enabled in-memory pruning by default.\"\r\n\r\nLooking at grafana you havn't explicitly been setting this to archive in your setup, resulting in pruning kicking in. We are sorry for the confusion. We now added explicit warning for archive nodes.\r\n\r\nIn order to recover the node, we need to:\r\n1. Set PruningConfig_Mode to \"None\"\r\n2. Temporarly set InitConfig_ProcessingEnabled to false\r\n3. Enable debug module (can be on secure port with AdditionalRpcUrls http://localhost:8550|http;wss|debug or simply by adding to EnabledModules - https://docs.nethermind.io/nethermind/ethereum-client/configuration/jsonrpc)\r\n4. Run version from: https://hub.docker.com/layers/nethermindeth/nethermind/debug_resetHead/images/sha256-5a62c43ed973876ae0d3fcf54cc86cc67aaed18739495d5a11f4f3459d994598\r\nIt contains changes from https://github.com/NethermindEth/nethermind/pull/3870\r\n5. Run debug_resetHead with some block processed before 1.12.5 upgrade. This would be best taken from the logs. Looking at the time of the upgrade on grafana, block 25573000 should be fine so: \r\n`curl --data '{\"method\":\"debug_resetHead\",\"params\":[\"0x5381094e811a757348b7eb9ff2688c94a8fde9e4c8468c9082cfe034face944f\"],\"id\":1,\"jsonrpc\":\"2.0\"}' -H \"Content-Type: application/json\" -X POST http://...`\r\n6. Close the node, re-enable (remove) InitConfig_ProcessingEnabled \r\n7. Blocks should be reprocessed on start and state should be saved to db.\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/1065067908/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
