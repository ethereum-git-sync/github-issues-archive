{
  "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/3178",
  "repository_url": "https://api.github.com/repos/NethermindEth/nethermind",
  "labels_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/3178/labels{/name}",
  "comments_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/3178/comments",
  "events_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/3178/events",
  "html_url": "https://github.com/NethermindEth/nethermind/issues/3178",
  "id": 931496963,
  "node_id": "MDU6SXNzdWU5MzE0OTY5NjM=",
  "number": 3178,
  "title": "`newHeads` subscription does not appear to be handling re-orgs correctly",
  "user": {
    "login": "brianmcgee",
    "id": 1173648,
    "node_id": "MDQ6VXNlcjExNzM2NDg=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1173648?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/brianmcgee",
    "html_url": "https://github.com/brianmcgee",
    "followers_url": "https://api.github.com/users/brianmcgee/followers",
    "following_url": "https://api.github.com/users/brianmcgee/following{/other_user}",
    "gists_url": "https://api.github.com/users/brianmcgee/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/brianmcgee/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/brianmcgee/subscriptions",
    "organizations_url": "https://api.github.com/users/brianmcgee/orgs",
    "repos_url": "https://api.github.com/users/brianmcgee/repos",
    "events_url": "https://api.github.com/users/brianmcgee/events{/privacy}",
    "received_events_url": "https://api.github.com/users/brianmcgee/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "marcindsobczak",
    "id": 77129288,
    "node_id": "MDQ6VXNlcjc3MTI5Mjg4",
    "avatar_url": "https://avatars.githubusercontent.com/u/77129288?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/marcindsobczak",
    "html_url": "https://github.com/marcindsobczak",
    "followers_url": "https://api.github.com/users/marcindsobczak/followers",
    "following_url": "https://api.github.com/users/marcindsobczak/following{/other_user}",
    "gists_url": "https://api.github.com/users/marcindsobczak/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/marcindsobczak/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/marcindsobczak/subscriptions",
    "organizations_url": "https://api.github.com/users/marcindsobczak/orgs",
    "repos_url": "https://api.github.com/users/marcindsobczak/repos",
    "events_url": "https://api.github.com/users/marcindsobczak/events{/privacy}",
    "received_events_url": "https://api.github.com/users/marcindsobczak/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "marcindsobczak",
      "id": 77129288,
      "node_id": "MDQ6VXNlcjc3MTI5Mjg4",
      "avatar_url": "https://avatars.githubusercontent.com/u/77129288?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/marcindsobczak",
      "html_url": "https://github.com/marcindsobczak",
      "followers_url": "https://api.github.com/users/marcindsobczak/followers",
      "following_url": "https://api.github.com/users/marcindsobczak/following{/other_user}",
      "gists_url": "https://api.github.com/users/marcindsobczak/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/marcindsobczak/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/marcindsobczak/subscriptions",
      "organizations_url": "https://api.github.com/users/marcindsobczak/orgs",
      "repos_url": "https://api.github.com/users/marcindsobczak/repos",
      "events_url": "https://api.github.com/users/marcindsobczak/events{/privacy}",
      "received_events_url": "https://api.github.com/users/marcindsobczak/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2021-06-28T12:03:49Z",
  "updated_at": "2021-07-13T09:05:50Z",
  "closed_at": "2021-07-13T09:05:50Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "**Describe the bug**\r\n\r\n`newHeads` subscription is not re-publishing a header for a given block number that has changed due to a re-org.\r\n\r\n**To Reproduce**\r\n\r\nSteps to reproduce the behavior:\r\n\r\n1. Start a new heads subscription using something like [websocat](https://github.com/vi/websocat)\r\n\r\n```shell\r\n$ websocat wss://nethermind\r\n{\"id\":1,\"method\":\"eth_subscribe\",\"params\":[\"newHeads\"]}\r\n// new heads will start arriving\r\n```\r\n\r\n2. Monitor `nethermind` logs looking for new blocks that have been discovered\r\n\r\n```shell\r\ndocker logs -f nethermind | grep -E 'Discovered|Processed'\r\n```\r\n\r\n3. Look for a block in which you see a discovery entry appear for a block just after it has been processed.\r\n\r\n```shell\r\n2021-06-28 11:36:44.3953|Discovered new block 12722292 11:36:30 (0x3a59bd...1b38e9), tx count: 142 miner 0x00192fb10df37c9fb26829eb2cc623cd1bf599e8, sent by [Peer|eth64|12722292|OpenEthereum/v3.2.4-stable/x86_64-linux-musl/rustc1.47.0|172.18.0.1:17354] \r\n2021-06-28 11:36:44.6442|Processed   12722292 |   13,850ms, mgasps    2.15 total    3.20, tps   22.17 total   57.64, bps    0.07 total    0.11, recv queue 0, proc queue 0 \r\n2021-06-28 11:36:47.4989|Discovered new block 12722292 11:36:30 (0xfacc1d...2e8d26), tx count: 210 miner Spark Pool, sent by [Peer|eth64|12722292|OpenEthereum/v3.2.4-stable/x86_64-linux-musl/rustc1.47.0|172.18.0.1:17354]\r\n```\r\n\r\n4. Compare with the output from websocat. You should have seen the first head update but you will not see a second expected update.\r\n\r\n5. Look up the block number on [etherscan](https://etherscan.io/block/12722292) and you will see the canonical header is the second update, not the first update you saw via `websocat`. \r\n\r\n**Expected behavior**\r\n\r\nWhen a re-org occurs the `newHeads` subscription is supposed to re-publish any headers for numbers that have changed. \r\n\r\n**Desktop (please complete the following information):**\r\n - OS: CentOS Linux release 8.3.2011\r\n - Version: 1.10.73\r\n\r\n**Additional context**\r\n\r\nI saw this issue when processing block number 12722292. I received this output via websocat:\r\n\r\n```shell\r\n\r\n  {\r\n    \"jsonrpc\": \"2.0\",\r\n    \"method\": \"eth_subscription\",\r\n    \"params\": {\r\n      \"subscription\": \"0x59a7cdd544374ea9b37facc9b78c0347\",\r\n      \"result\": {\r\n        \"author\": \"0x52bc44d5378309ee2abf1539bf71de1b7d7be3b5\",\r\n        \"difficulty\": \"0x16080401459c28\",\r\n        \"extraData\": \"0x6e616e6f706f6f6c2e6f7267\",\r\n        \"gasLimit\": \"0xe4e1b2\",\r\n        \"gasUsed\": \"0xe4c6ed\",\r\n        \"hash\": \"0xac468b4ee526c3790c8e7b53866e55c8cc4e82acbeff3525bb2b0d219d3c0a97\",\r\n        \"logsBloom\": \"0xfaa45a9ed4e60f13b8db65d7f617e7e65b9691499e857de44091847e107acb275c3d056c1399ca57658bdd1acb555dd87a09f7136ac2bda793505435ddbf39115d8028a1aa3381a84d434eee8558f0e04dd4ae0c6e46f8322f401d7f82f3f1615378f4cc57b6c74001acde9250696bd43211867104ee6469533fa6d6f83abc61d8eb9132c353e13000ca1948f48c5804f413c5817510051d7ca780d470d928c763f7684c46a7bc0b1e8e6a99cd9031905a160c612ebe08caedafce3f9c9d2c50d569a76bcb347ea3a1a7587432ebc94fcaf4130377ed4b1a1b0842eb0234ec602a3c284a99a40789b1c7c7e587376d050e39383f643db6d4f25a5fbf5cb3fc33\",\r\n        \"miner\": \"0x52bc44d5378309ee2abf1539bf71de1b7d7be3b5\",\r\n        \"mixHash\": \"0x156f91820191e094f0d0e1e267be8da823e79a97859b9e58e2cf7a27da704f59\",\r\n        \"nonce\": \"0x4ca668c39aeeee80\",\r\n        \"number\": \"0xc22073\",\r\n        \"parentHash\": \"0xb2f0f6ff5a1a7c0a3b46e7aad94ec32c35a8fd130e78095d9a9c0231ce55ff54\",\r\n        \"receiptsRoot\": \"0xdb80e0216bf0765d0eca7b765251bb9e759f3160502d98f85e7d2c461e6751be\",\r\n        \"sha3Uncles\": \"0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347\",\r\n        \"size\": \"0xcbf5\",\r\n        \"stateRoot\": \"0x9213fc4f3bd13505d44255d771371c65e76f327decd1f32106a61137f1c583b2\",\r\n        \"totalDifficulty\": \"0x5af1d3a332743246e29\",\r\n        \"timestamp\": \"0x60d9b432\",\r\n        \"transactions\": [\r\n        ...\r\n        ],\r\n        \"transactionsRoot\": \"0x3372384c15e61a7b77560da9faa67b43a1cd696f935ddbfb997d6a1d2c43e512\",\r\n        \"uncles\": []\r\n      }\r\n    }\r\n  }\r\n  {\r\n    \"jsonrpc\": \"2.0\",\r\n    \"method\": \"eth_subscription\",\r\n    \"params\": {\r\n      \"subscription\": \"0x59a7cdd544374ea9b37facc9b78c0347\",\r\n      \"result\": {\r\n        \"author\": \"0x00192fb10df37c9fb26829eb2cc623cd1bf599e8\",\r\n        \"difficulty\": \"0x16080c01459c28\",\r\n        \"extraData\": \"0x457468657265756d50504c4e532f326d696e6572735f455532\",\r\n        \"gasLimit\": \"0xe4a87b\",\r\n        \"gasUsed\": \"0xe20637\",\r\n        \"hash\": \"0x3a59bdde45250c8d936992cf303e84c2291320b8f1e256c6f5a4f716311b38e9\",\r\n        \"logsBloom\": \"0xb4b5c80369522419900a7f84807652b0bc76dc01c429c81e40cb62860412af2411a0190c40080448533079b4138419e04e07c0e5ac0239080f90fa99227ce81028b208a2f47eab29c9e3448909a02ae12213b125296534d673423de086e177faf6cac93513c30885aacc340021c95a48f310cc7d1ec88c4ab61c7932092c29486cc8da320ec56841c8e2446c85a54c67105024957162207f38bdb6c07a1124c54a17126f514874c37298ea92d89cc6219d2000023c62404601e303a648b87402485187226b1824e00e5c880069afc15c1971d282978d6cd30b017ab34361691a3bbc728284c4838a86d455828002880001a210d34428854201042b0440d2d800\",\r\n        \"miner\": \"0x00192fb10df37c9fb26829eb2cc623cd1bf599e8\",\r\n        \"mixHash\": \"0x73e58851ed70deabcfa2058077f223679537ba9e12cbc5678725e5a710d30a55\",\r\n        \"nonce\": \"0x8c2bd4189005f89f\",\r\n        \"number\": \"0xc22074\",\r\n        \"parentHash\": \"0xac468b4ee526c3790c8e7b53866e55c8cc4e82acbeff3525bb2b0d219d3c0a97\",\r\n        \"receiptsRoot\": \"0xf2f9117a8ec1dcd14447ada02e65311e3e7b135e2559c9e54434fe006d91e372\",\r\n        \"sha3Uncles\": \"0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347\",\r\n        \"size\": \"0xb22f\",\r\n        \"stateRoot\": \"0xd8ddaa66c9c3b5b6dda10e6b78ff4c3df746d9b4cb96987a85a35e35bfc7cbe3\",\r\n        \"totalDifficulty\": \"0x5af1d503b33446a0a51\",\r\n        \"timestamp\": \"0x60d9b43e\",\r\n        \"transactions\": [\r\n        ...\r\n        ],\r\n        \"transactionsRoot\": \"0x5267d44b89224ee9165be0163ec86f2be04856ad4f56db035c316b653483f10e\",\r\n        \"uncles\": []\r\n      }\r\n    }\r\n  }\r\n  {\r\n    \"jsonrpc\": \"2.0\",\r\n    \"method\": \"eth_subscription\",\r\n    \"params\": {\r\n      \"subscription\": \"0x59a7cdd544374ea9b37facc9b78c0347\",\r\n      \"result\": {\r\n        \"author\": \"0x5a0b54d5dc17e0aadc383d2db43b0a0d3e029c4c\",\r\n        \"difficulty\": \"0x16081401459c28\",\r\n        \"extraData\": \"0xd883010a03846765746888676f312e31362e35856c696e7578\",\r\n        \"gasLimit\": \"0xe4e1c0\",\r\n        \"gasUsed\": \"0xe4aa2f\",\r\n        \"hash\": \"0x09045251b8439cd25cb073f51521754176421cc96683946edb7f2eceff5ac905\",\r\n        \"logsBloom\": \"0x01b0d9da9b67a9d128c80696803cdb99138118c1205d440437f380d03c72e12c160d3e54889db401d042db2c020391041e74a4060888f134aef5e9946a7a600740c162c8210a8948c822968bce0857a5854643dd16e82e121e42e188c82a3508df50e90813bac0a0030e1200091a891044405716042b0ef6060f14382648e821608692c0c6e0373896cf49f8056e840f500294ed715182cc586403542a1101b8621da10d228525212e161694cd800e900a10033921112b3444720a2a92481905f531e402322485f0210611a4830f1a36ce5213031a2f5016ca4022cb0155a13921d336ab181c869405651110c7864095c4d940bc2d02a45052cc788140e21445\",\r\n        \"miner\": \"0x5a0b54d5dc17e0aadc383d2db43b0a0d3e029c4c\",\r\n        \"mixHash\": \"0x06c52f8e1586e340d5f707d94646f7fa205ce850d106649d1c304a69be7d47ea\",\r\n        \"nonce\": \"0x24a57bf8dd9b5ce6\",\r\n        \"number\": \"0xc22075\",\r\n        \"parentHash\": \"0xfacc1dd063a86ca33510eb60e1a811ba0f35043435b0367326783f091e2e8d26\",\r\n        \"receiptsRoot\": \"0xa31b1ebd1642cd14f54591b012f9819cf8a20c512a9ea07e3c933fee0132a20a\",\r\n        \"sha3Uncles\": \"0x12cf0943850453f9ee5ea1c98a6f837e86f2df39b1de47586b72079df284cb30\",\r\n        \"size\": \"0x114c3\",\r\n        \"stateRoot\": \"0x7e586935b5dd47fad401e290bebc2b70dfb18dbb6f271c77f7f0f52e287f1534\",\r\n        \"totalDifficulty\": \"0x5af1d66434745afa679\",\r\n        \"timestamp\": \"0x60d9b44f\",\r\n        \"transactions\": [\r\n        ...\r\n        ],\r\n        \"transactionsRoot\": \"0x8712d7d963b0b0ba18e3eca6508fde6ff7bd9611711f0a5ffea6d5d1cbbf15e2\",\r\n        \"uncles\": [\r\n          \"0x3a59bdde45250c8d936992cf303e84c2291320b8f1e256c6f5a4f716311b38e9\"\r\n        ]\r\n      }\r\n    }\r\n  }\r\n```\r\n\r\nAs you can see from the output, the middle entry is the update for `12722292` (`0xc22074`). The subsequent update has a parent hash which does not match the update I received for `12722292` but instead matches the new canonical entry for that block number. \r\n\r\nWhen I call `eth_getBlockByNumber` on my node I receive the following output which matches the updated canonical header:\r\n\r\n```shell\r\n  // request\r\n  {\r\n    \"id\": 1,\r\n    \"method\": \"eth_getBlockByNumber\",\r\n    \"params\": [\r\n      \"0xc22074\"\r\n    ]\r\n  },\r\n  // response\r\n  {\r\n    \"jsonrpc\": \"2.0\",\r\n    \"result\": {\r\n      \"author\": \"0x5a0b54d5dc17e0aadc383d2db43b0a0d3e029c4c\",\r\n      \"difficulty\": \"0x16080c01459c28\",\r\n      \"extraData\": \"0xd883010a03846765746888676f312e31362e35856c696e7578\",\r\n      \"gasLimit\": \"0xe4e1c0\",\r\n      \"gasUsed\": \"0xe4376c\",\r\n      \"hash\": \"0xfacc1dd063a86ca33510eb60e1a811ba0f35043435b0367326783f091e2e8d26\",\r\n      \"logsBloom\": \"0x94b4c8027f522d19bc0a7f84e077dae01e76dc0164b9cd9b41eb62f6541ae72795a81dcc002204495b20f93d13e819f0ee0340a5ac43b98e0fd8eb9de2fce80320f248a2f67b8a09c9e366a919a07ae1a612b325294d35c63842bde086f1777afec2e835174188c4abcc7f00034b6b08f610dcfc1ec88c6af719fd93813cc968fdcace320ae72e59c8e3476c85a55c775451a49571723c7fb9bab74cf61124c46fdb826fd96072d672c8ee92d890e2219da20a42bc72400681e38bae4cb87a03483387226b9c67ee2edc8a15edefc1148979fa86979d345333017ab343616d32bafc7b839c85c380a6d455808a0a888501b208db4468a552090c2b1445e0dae0\",\r\n      \"miner\": \"0x5a0b54d5dc17e0aadc383d2db43b0a0d3e029c4c\",\r\n      \"mixHash\": \"0x7eecf277e64416aba5a8ad922f9048e23a0c668583598470f4a7c251a312dbc9\",\r\n      \"nonce\": \"0x16cfd642ee9a3d37\",\r\n      \"number\": \"0xc22074\",\r\n      \"parentHash\": \"0xac468b4ee526c3790c8e7b53866e55c8cc4e82acbeff3525bb2b0d219d3c0a97\",\r\n      \"receiptsRoot\": \"0xe4885b2c6dd63abdd6d38cbbe41a00edeced87dec6f224106551ba19687ae326\",\r\n      \"sha3Uncles\": \"0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347\",\r\n      \"size\": \"0xb87d\",\r\n      \"stateRoot\": \"0x7e5f22e76d91abd853f8e5141205e533d8333a0609858e3d57d0a0c74880d1fe\",\r\n      \"totalDifficulty\": \"0x5af1d503b33446a0a51\",\r\n      \"timestamp\": \"0x60d9b43e\",\r\n      \"transactions\": [\r\n      ...\r\n      ],\r\n      \"transactionsRoot\": \"0x6dc6792eb871a7720d31a958a2affcac7697ea57862276fb0b41d7b374cca288\",\r\n      \"uncles\": []\r\n    },\r\n    \"id\": 1\r\n  }\r\n\r\n```\r\n",
  "closed_by": {
    "login": "LukaszRozmej",
    "id": 12445221,
    "node_id": "MDQ6VXNlcjEyNDQ1MjIx",
    "avatar_url": "https://avatars.githubusercontent.com/u/12445221?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/LukaszRozmej",
    "html_url": "https://github.com/LukaszRozmej",
    "followers_url": "https://api.github.com/users/LukaszRozmej/followers",
    "following_url": "https://api.github.com/users/LukaszRozmej/following{/other_user}",
    "gists_url": "https://api.github.com/users/LukaszRozmej/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/LukaszRozmej/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/LukaszRozmej/subscriptions",
    "organizations_url": "https://api.github.com/users/LukaszRozmej/orgs",
    "repos_url": "https://api.github.com/users/LukaszRozmej/repos",
    "events_url": "https://api.github.com/users/LukaszRozmej/events{/privacy}",
    "received_events_url": "https://api.github.com/users/LukaszRozmej/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/3178/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/3178/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/870005923",
    "html_url": "https://github.com/NethermindEth/nethermind/issues/3178#issuecomment-870005923",
    "issue_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/3178",
    "id": 870005923,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg3MDAwNTkyMw==",
    "user": {
      "login": "tkstanczak",
      "id": 498913,
      "node_id": "MDQ6VXNlcjQ5ODkxMw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/498913?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tkstanczak",
      "html_url": "https://github.com/tkstanczak",
      "followers_url": "https://api.github.com/users/tkstanczak/followers",
      "following_url": "https://api.github.com/users/tkstanczak/following{/other_user}",
      "gists_url": "https://api.github.com/users/tkstanczak/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tkstanczak/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tkstanczak/subscriptions",
      "organizations_url": "https://api.github.com/users/tkstanczak/orgs",
      "repos_url": "https://api.github.com/users/tkstanczak/repos",
      "events_url": "https://api.github.com/users/tkstanczak/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tkstanczak/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-06-28T20:17:27Z",
    "updated_at": "2021-06-28T20:17:27Z",
    "author_association": "MEMBER",
    "body": "@marcindsobczak would you have a look?",
    "reactions": {
      "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/870005923/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
