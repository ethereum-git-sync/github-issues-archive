{
  "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/6465",
  "repository_url": "https://api.github.com/repos/NethermindEth/nethermind",
  "labels_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/6465/labels{/name}",
  "comments_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/6465/comments",
  "events_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/6465/events",
  "html_url": "https://github.com/NethermindEth/nethermind/issues/6465",
  "id": 2068797749,
  "node_id": "I_kwDOBggaLc57T1k1",
  "number": 6465,
  "title": "too many close_wait",
  "user": {
    "login": "djbakerman",
    "id": 2192654,
    "node_id": "MDQ6VXNlcjIxOTI2NTQ=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2192654?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/djbakerman",
    "html_url": "https://github.com/djbakerman",
    "followers_url": "https://api.github.com/users/djbakerman/followers",
    "following_url": "https://api.github.com/users/djbakerman/following{/other_user}",
    "gists_url": "https://api.github.com/users/djbakerman/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/djbakerman/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/djbakerman/subscriptions",
    "organizations_url": "https://api.github.com/users/djbakerman/orgs",
    "repos_url": "https://api.github.com/users/djbakerman/repos",
    "events_url": "https://api.github.com/users/djbakerman/events{/privacy}",
    "received_events_url": "https://api.github.com/users/djbakerman/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2024-01-06T19:38:21Z",
  "updated_at": "2024-01-06T19:54:54Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "Description\r\nWe are experiencing a high number of CLOSE_WAIT statuses on our Nethermind node. As observed using the command netstat -an | grep -i wait | wc -l, the count is at 1335. This issue indicates that while the remote client has closed the connection, our server-side Nethermind process has not yet acknowledged this closure, leading to a potential resource exhaustion.\r\n\r\nSteps to Reproduce\r\nTo replicate this issue, follow these steps:\r\n\r\nRun the Nethermind node normally.\r\nAfter some uptime, execute the command netstat -an | grep -i wait | wc -l to check the number of CLOSE_WAIT connections.\r\nObserve the number of connections that are in the CLOSE_WAIT status.\r\nActual behavior\r\nUpon executing the above steps, we observe a high number of CLOSE_WAIT statuses (1335). This is concerning as it suggests that the Nethermind node is not properly closing connections, leading to potential memory and resource leaks.\r\n\r\nExpected behavior\r\nThe expected behavior is that after a client closes a connection, the Nethermind node should properly close its end of the connection too, resulting in a very low number of CLOSE_WAIT statuses, ideally close to zero.\r\n\r\nScreenshots\r\nN/A (This issue is related to server-side network connection statuses and might not be adequately captured in screenshots.)\r\n\r\nDesktop (please complete the following information):\r\n\r\nOperating System: Ubuntu 22.04\r\nNethermind Version: 1.24.0\r\nInstallation Method: systemd\r\nConsensus Client: Lighthouse v4.5.0\r\n\r\nAdditional context\r\nThis issue seems to manifest after the node has been running for an extended period, suggesting it might be related to how long-running connections are managed.\r\n\r\nLogs\r\n2024-01-06 13:34:49.3910|INFO|Consensus.Processing.BlockchainProcessor|24|- Block throughput   82.99 MGas/s |   1014.21 t/s |          7.99 Blk/s | recv        0 | proc        0 \r\n2024-01-06 13:34:49.5910|INFO|Merge.Plugin.Handlers.ForkchoiceUpdatedHandler|94|Received ForkChoice: Head: 18949949 (0x451f3c...0eb329), Safe: 18949897 (0x176809...735e60), Finalized: 18949866 (0x398d75...5462d8) \r\n2024-01-06 13:34:49.5910|INFO|Merge.Plugin.Handlers.ForkchoiceUpdatedHandler|94|Synced chain Head to 18949949 (0x451f3c...0eb329) \r\n2024-01-06 13:34:57.9717|INFO|Network.PeerManager|5701|Removing 950 out of 10950 peer candidates (candidates cleanup). \r\n2024-01-06 13:34:58.9688|INFO|JsonRpc.JsonRpcLocalStats|5434|***** JSON RPC report *****\r\n-------------------------------------------------------------------------------------------------------------------------------------------------------------\r\nmethod                                  | successes |  avg time (µs) |  max time (µs) |    errors |  avg time (µs) |  max time (µs) | avg size | total size |\r\n-------------------------------------------------------------------------------------------------------------------------------------------------------------\r\nengine_forkchoiceUpdatedV2              |        26 |          40568 |         981417 |         0 |              0 |              0 |        0 |          0 | \r\nengine_getPayloadBodiesByRangeV1        |        56 |         375044 |        1270799 |         0 |              0 |              0 |        0 |          0 | \r\nengine_newPayloadV2                     |        25 |         488666 |         932409 |         0 |              0 |              0 |        0 |          0 | \r\neth_chainId                             |         5 |            145 |            178 |         0 |              0 |              0 |        0 |          0 | \r\neth_getBlockByNumber                    |        30 |          35266 |         402499 |         0 |              0 |              0 |        0 |          0 | \r\neth_getLogs                             |         5 |          13135 |          44512 |         0 |              0 |              0 |        0 |          0 | \r\neth_syncing                             |        25 |            167 |            328 |         0 |              0 |              0 |        0 |          0 | \r\n-------------------------------------------------------------------------------------------------------------------------------------------------------------\r\nTOTAL                                   |       172 |         205828 |        1270799 |         0 |              0 |              0 |        0 |          0 | \r\n-------------------------------------------------------------------------------------------------------------------------------------------------------------\r\n \r\n2024-01-06 13:35:00.3859|INFO|Merge.Plugin.Handlers.NewPayloadHandler|5434|Received new block:  18949950 (0xdcbe11...d6ed57) \r\n2024-01-06 13:35:00.5735|INFO|Consensus.Processing.BlockchainProcessor|24|Processed            18949950     |    185.53 ms  |  slot     11,183 ms | Gas gwei: 18.53 .. 18.53 (19.96) .. 33.41 \r\n2024-01-06 13:35:00.5735|INFO|Consensus.Processing.BlockchainProcessor|24|- Block              12.14 MGas   |    135    txs |  calls    603 ( 13) | sload   2,109 | sstore    685 | create   0 \r\n2024-01-06 13:35:00.5735|INFO|Consensus.Processing.BlockchainProcessor|24|- Block throughput   65.45 MGas/s |    727.64 t/s |          5.39 Blk/s | recv        0 | proc        0 \r\n2024-01-06 13:35:00.7823|INFO|Merge.Plugin.Handlers.ForkchoiceUpdatedHandler|662|Received ForkChoice: Head: 18949950 (0xdcbe11...d6ed57), Safe: 18949897 (0x176809...735e60), Finalized: 18949866 (0x398d75...5462d8) \r\n2024-01-06 13:35:00.7823|INFO|Merge.Plugin.Handlers.ForkchoiceUpdatedHandler|662|Synced chain Head to 18949950 (0xdcbe11...d6ed57) \r\n2024-01-06 13:35:06.0722|INFO|Synchronization.Reporting.SyncReport|366|Peers | with best block: 101 | all: 101 | eth66 (4 %), eth67 (4 %), eth68 (92 %) | Active: None | Sleeping: All | Geth (52 %), Nethermind (37 %), Besu (5 %), Erigon (3 %), Reth (2 %), Unknown (1 %) \r\n2024-01-06 13:35:13.2348|INFO|Merge.Plugin.Handlers.NewPayloadHandler|94|Received new block:  18949951 (0xa9cdaf...6b352c) \r\n2024-01-06 13:35:13.5748|INFO|Consensus.Processing.BlockchainProcessor|24|Processed            18949951     |    337.59 ms  |  slot     13,001 ms | Gas gwei: 18.09 .. 18.22 (20.25) .. 64.90 \r\n2024",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/6465/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/6465/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/1879802161",
    "html_url": "https://github.com/NethermindEth/nethermind/issues/6465#issuecomment-1879802161",
    "issue_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/6465",
    "id": 1879802161,
    "node_id": "IC_kwDOBggaLc5wC4Ex",
    "user": {
      "login": "djbakerman",
      "id": 2192654,
      "node_id": "MDQ6VXNlcjIxOTI2NTQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2192654?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/djbakerman",
      "html_url": "https://github.com/djbakerman",
      "followers_url": "https://api.github.com/users/djbakerman/followers",
      "following_url": "https://api.github.com/users/djbakerman/following{/other_user}",
      "gists_url": "https://api.github.com/users/djbakerman/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/djbakerman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/djbakerman/subscriptions",
      "organizations_url": "https://api.github.com/users/djbakerman/orgs",
      "repos_url": "https://api.github.com/users/djbakerman/repos",
      "events_url": "https://api.github.com/users/djbakerman/events{/privacy}",
      "received_events_url": "https://api.github.com/users/djbakerman/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2024-01-06T19:54:54Z",
    "updated_at": "2024-01-06T19:54:54Z",
    "author_association": "NONE",
    "body": "the close_wait continued to grow until I restarted the nethermind process\r\n\r\nnetstat -an | grep -i close | wc -l\r\n1391\r\n\r\nnetstat -an | grep -i close | wc -l\r\n1484\r\n\r\nsudo service nethermind stop\r\n\r\nnetstat -an | grep -i close | wc -l\r\n0\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/1879802161/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
