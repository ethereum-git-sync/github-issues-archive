{
  "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/5100",
  "repository_url": "https://api.github.com/repos/NethermindEth/nethermind",
  "labels_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/5100/labels{/name}",
  "comments_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/5100/comments",
  "events_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/5100/events",
  "html_url": "https://github.com/NethermindEth/nethermind/issues/5100",
  "id": 1521094726,
  "node_id": "I_kwDOBggaLc5aqhBG",
  "number": 5100,
  "title": "admin_pruning consumes excessive memory and causes OOM",
  "user": {
    "login": "epheph",
    "id": 361654,
    "node_id": "MDQ6VXNlcjM2MTY1NA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/361654?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/epheph",
    "html_url": "https://github.com/epheph",
    "followers_url": "https://api.github.com/users/epheph/followers",
    "following_url": "https://api.github.com/users/epheph/following{/other_user}",
    "gists_url": "https://api.github.com/users/epheph/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/epheph/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/epheph/subscriptions",
    "organizations_url": "https://api.github.com/users/epheph/orgs",
    "repos_url": "https://api.github.com/users/epheph/repos",
    "events_url": "https://api.github.com/users/epheph/events{/privacy}",
    "received_events_url": "https://api.github.com/users/epheph/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": {
    "login": "LukaszRozmej",
    "id": 12445221,
    "node_id": "MDQ6VXNlcjEyNDQ1MjIx",
    "avatar_url": "https://avatars.githubusercontent.com/u/12445221?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/LukaszRozmej",
    "html_url": "https://github.com/LukaszRozmej",
    "followers_url": "https://api.github.com/users/LukaszRozmej/followers",
    "following_url": "https://api.github.com/users/LukaszRozmej/following{/other_user}",
    "gists_url": "https://api.github.com/users/LukaszRozmej/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/LukaszRozmej/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/LukaszRozmej/subscriptions",
    "organizations_url": "https://api.github.com/users/LukaszRozmej/orgs",
    "repos_url": "https://api.github.com/users/LukaszRozmej/repos",
    "events_url": "https://api.github.com/users/LukaszRozmej/events{/privacy}",
    "received_events_url": "https://api.github.com/users/LukaszRozmej/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "LukaszRozmej",
      "id": 12445221,
      "node_id": "MDQ6VXNlcjEyNDQ1MjIx",
      "avatar_url": "https://avatars.githubusercontent.com/u/12445221?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/LukaszRozmej",
      "html_url": "https://github.com/LukaszRozmej",
      "followers_url": "https://api.github.com/users/LukaszRozmej/followers",
      "following_url": "https://api.github.com/users/LukaszRozmej/following{/other_user}",
      "gists_url": "https://api.github.com/users/LukaszRozmej/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/LukaszRozmej/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/LukaszRozmej/subscriptions",
      "organizations_url": "https://api.github.com/users/LukaszRozmej/orgs",
      "repos_url": "https://api.github.com/users/LukaszRozmej/repos",
      "events_url": "https://api.github.com/users/LukaszRozmej/events{/privacy}",
      "received_events_url": "https://api.github.com/users/LukaszRozmej/received_events",
      "type": "User",
      "site_admin": false
    },
    {
      "login": "cbermudez97",
      "id": 43155355,
      "node_id": "MDQ6VXNlcjQzMTU1MzU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/43155355?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cbermudez97",
      "html_url": "https://github.com/cbermudez97",
      "followers_url": "https://api.github.com/users/cbermudez97/followers",
      "following_url": "https://api.github.com/users/cbermudez97/following{/other_user}",
      "gists_url": "https://api.github.com/users/cbermudez97/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cbermudez97/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cbermudez97/subscriptions",
      "organizations_url": "https://api.github.com/users/cbermudez97/orgs",
      "repos_url": "https://api.github.com/users/cbermudez97/repos",
      "events_url": "https://api.github.com/users/cbermudez97/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cbermudez97/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2023-01-05T17:18:24Z",
  "updated_at": "2023-01-25T16:19:04Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "**Describe the bug**\r\nI would like to prune my state database (currently ~600GB) using admin_pruning rpc. Server has 128GB of memory and the memory usage spikes near the end of the process (~7 hours) preventing it from successfully completing. \r\n\r\n**To Reproduce**\r\nSteps to reproduce the behavior:\r\n1. Have a big state dir (several months)\r\n2. Run `curl --data '{\"method\":\"admin_prune\",\"params\":[],\"id\":1,\"jsonrpc\":\"2.0\"}' -H \"Content-Type: application/json\" -X POST`\r\n3. Wait 7 hours\r\n\r\n**Expected behavior**\r\nUse a consistent/reasonable amount of memory\r\n\r\n**Desktop (please complete the following information):**\r\n - OS: Ubuntu Linux (running Nethermind inside docker)\r\n - Version: 1.14.7\r\n\r\n**Additional context**\r\n```\r\n00:19:37.6010|Full Pruning In Progress: 06:43:26.8003415 1,208.00 mln nodes mirrored.\r\n00:19:58.1468|Full Pruning In Progress: 06:43:47.3460922 1,209.00 mln nodes mirrored.\r\n```\r\n\r\n```\r\n00:20:07 df-chi-micah-2 kernel: [23161993.119757] SingleThreadEve invoked oom-killer: gfp_mask=0x1100cca(GFP_HIGHUSER_MOVABLE), order=0, oom_score_adj=0\r\n00:20:07 df-chi-micah-2 kernel:  oom_kill_process.cold+0xb/0x10\r\n00:20:07 df-chi-micah-2 kernel: oom-kill:constraint=CONSTRAINT_NONE,nodemask=(null),cpuset=docker-4f686a69d44ef4e6ed3651f1f23d9294535e81434dd9ed15042f98d2ac12768c.scope,mems_allowed=0,global_oom,task_memcg=/system.slice/docker-4f686a69d44ef4e6ed3651f1f23d9294535e81434dd9ed15042f98d2ac12768c.scope,task=Nethermind.Runn,pid=3175210,uid=0\r\n00:20:07 df-chi-micah-2 kernel: Out of memory: Killed process 3175210 (Nethermind.Runn) total-vm:172515204kB, anon-rss:124351840kB, file-rss:0kB, shmem-rss:0kB, UID:0 pgtables:284152kB oom_score_adj:0\r\n00:20:07 df-chi-micah-2 systemd[1]: docker-4f686a69d44ef4e6ed3651f1f23d9294535e81434dd9ed15042f98d2ac12768c.scope: A process of this unit has been killed by the OOM killer.\r\n```\r\n\r\nRelevant configuration:\r\n```\r\n                \"NETHERMIND_CONFIG=mainnet\",\r\n                \"NETHERMIND_INITCONFIG_MEMORYHINT=50000000000\",\r\n                \"NETHERMIND_INITCONFIG_WEBSOCKETSENABLED=true\",\r\n                \"NETHERMIND_MULTICALLCONFIG_ENABLED=true\",\r\n                \"NETHERMIND_SYNCCONFIG_BEAMSYNC=false\",\r\n                \"NETHERMIND_SYNCCONFIG_DOWNLOADBODIESINFASTSYNC=true\",\r\n                \"NETHERMIND_SYNCCONFIG_DOWNLOADRECEIPTSINFASTSYNC=true\",\r\n                \"NETHERMIND_SYNCCONFIG_FASTBLOCKS=true\",\r\n                \"NETHERMIND_SYNCCONFIG_FASTSYNCCATCHUPHEIGHTDELTA=65535\",\r\n                \"NETHERMIND_TXPOOLCONFIG_SIZE=250000\",\r\n```\r\n\r\n\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/5100/reactions",
    "total_count": 3,
    "+1": 3,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/5100/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/1372509056",
    "html_url": "https://github.com/NethermindEth/nethermind/issues/5100#issuecomment-1372509056",
    "issue_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/5100",
    "id": 1372509056,
    "node_id": "IC_kwDOBggaLc5RztOA",
    "user": {
      "login": "epheph",
      "id": 361654,
      "node_id": "MDQ6VXNlcjM2MTY1NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/361654?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/epheph",
      "html_url": "https://github.com/epheph",
      "followers_url": "https://api.github.com/users/epheph/followers",
      "following_url": "https://api.github.com/users/epheph/following{/other_user}",
      "gists_url": "https://api.github.com/users/epheph/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/epheph/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/epheph/subscriptions",
      "organizations_url": "https://api.github.com/users/epheph/orgs",
      "repos_url": "https://api.github.com/users/epheph/repos",
      "events_url": "https://api.github.com/users/epheph/events{/privacy}",
      "received_events_url": "https://api.github.com/users/epheph/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-01-05T17:22:18Z",
    "updated_at": "2023-01-05T17:22:18Z",
    "author_association": "NONE",
    "body": "The amount of used memory at that point is found in the OOM log: `anon-rss:124351840kB`, ~124GB ",
    "reactions": {
      "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/1372509056/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/1372512705",
    "html_url": "https://github.com/NethermindEth/nethermind/issues/5100#issuecomment-1372512705",
    "issue_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/5100",
    "id": 1372512705,
    "node_id": "IC_kwDOBggaLc5RzuHB",
    "user": {
      "login": "epheph",
      "id": 361654,
      "node_id": "MDQ6VXNlcjM2MTY1NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/361654?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/epheph",
      "html_url": "https://github.com/epheph",
      "followers_url": "https://api.github.com/users/epheph/followers",
      "following_url": "https://api.github.com/users/epheph/following{/other_user}",
      "gists_url": "https://api.github.com/users/epheph/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/epheph/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/epheph/subscriptions",
      "organizations_url": "https://api.github.com/users/epheph/orgs",
      "repos_url": "https://api.github.com/users/epheph/repos",
      "events_url": "https://api.github.com/users/epheph/events{/privacy}",
      "received_events_url": "https://api.github.com/users/epheph/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-01-05T17:23:59Z",
    "updated_at": "2023-01-05T17:23:59Z",
    "author_association": "NONE",
    "body": "Also worth mentioning that it worked in copying the data into the `1` state:\r\n\r\n```\r\nPATH_TO_NETHERMIND_DATA/mainnet/state$ du -sh *\r\n553G\t0\r\n137G\t1\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/1372512705/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/1400544834",
    "html_url": "https://github.com/NethermindEth/nethermind/issues/5100#issuecomment-1400544834",
    "issue_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/5100",
    "id": 1400544834,
    "node_id": "IC_kwDOBggaLc5Tep5C",
    "user": {
      "login": "LukaszRozmej",
      "id": 12445221,
      "node_id": "MDQ6VXNlcjEyNDQ1MjIx",
      "avatar_url": "https://avatars.githubusercontent.com/u/12445221?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/LukaszRozmej",
      "html_url": "https://github.com/LukaszRozmej",
      "followers_url": "https://api.github.com/users/LukaszRozmej/followers",
      "following_url": "https://api.github.com/users/LukaszRozmej/following{/other_user}",
      "gists_url": "https://api.github.com/users/LukaszRozmej/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/LukaszRozmej/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/LukaszRozmej/subscriptions",
      "organizations_url": "https://api.github.com/users/LukaszRozmej/orgs",
      "repos_url": "https://api.github.com/users/LukaszRozmej/repos",
      "events_url": "https://api.github.com/users/LukaszRozmej/events{/privacy}",
      "received_events_url": "https://api.github.com/users/LukaszRozmej/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-01-23T15:31:11Z",
    "updated_at": "2023-01-23T15:31:11Z",
    "author_association": "MEMBER",
    "body": "Hi, we recently merged: https://github.com/NethermindEth/nethermind/pull/4699 , would love to hear if it helped with this issues on your side",
    "reactions": {
      "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/1400544834/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/1403872445",
    "html_url": "https://github.com/NethermindEth/nethermind/issues/5100#issuecomment-1403872445",
    "issue_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/5100",
    "id": 1403872445,
    "node_id": "IC_kwDOBggaLc5TrWS9",
    "user": {
      "login": "epheph",
      "id": 361654,
      "node_id": "MDQ6VXNlcjM2MTY1NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/361654?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/epheph",
      "html_url": "https://github.com/epheph",
      "followers_url": "https://api.github.com/users/epheph/followers",
      "following_url": "https://api.github.com/users/epheph/following{/other_user}",
      "gists_url": "https://api.github.com/users/epheph/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/epheph/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/epheph/subscriptions",
      "organizations_url": "https://api.github.com/users/epheph/orgs",
      "repos_url": "https://api.github.com/users/epheph/repos",
      "events_url": "https://api.github.com/users/epheph/events{/privacy}",
      "received_events_url": "https://api.github.com/users/epheph/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-01-25T16:19:04Z",
    "updated_at": "2023-01-25T16:19:04Z",
    "author_association": "NONE",
    "body": "Thanks @LukaszRozmej  . I'm not familiar with the release processes for nethermind, but any idea why v1.16.1 released 2 days ago doesn't contain the merge commit from a week ago? ",
    "reactions": {
      "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/1403872445/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
