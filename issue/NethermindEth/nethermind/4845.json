{
  "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/4845",
  "repository_url": "https://api.github.com/repos/NethermindEth/nethermind",
  "labels_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/4845/labels{/name}",
  "comments_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/4845/comments",
  "events_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/4845/events",
  "html_url": "https://github.com/NethermindEth/nethermind/issues/4845",
  "id": 1428872908,
  "node_id": "I_kwDOBggaLc5VKt7M",
  "number": 4845,
  "title": "Nonce increment bugs",
  "user": {
    "login": "gituser",
    "id": 104405,
    "node_id": "MDQ6VXNlcjEwNDQwNQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/104405?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/gituser",
    "html_url": "https://github.com/gituser",
    "followers_url": "https://api.github.com/users/gituser/followers",
    "following_url": "https://api.github.com/users/gituser/following{/other_user}",
    "gists_url": "https://api.github.com/users/gituser/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/gituser/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/gituser/subscriptions",
    "organizations_url": "https://api.github.com/users/gituser/orgs",
    "repos_url": "https://api.github.com/users/gituser/repos",
    "events_url": "https://api.github.com/users/gituser/events{/privacy}",
    "received_events_url": "https://api.github.com/users/gituser/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "deffrian",
    "id": 19891475,
    "node_id": "MDQ6VXNlcjE5ODkxNDc1",
    "avatar_url": "https://avatars.githubusercontent.com/u/19891475?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/deffrian",
    "html_url": "https://github.com/deffrian",
    "followers_url": "https://api.github.com/users/deffrian/followers",
    "following_url": "https://api.github.com/users/deffrian/following{/other_user}",
    "gists_url": "https://api.github.com/users/deffrian/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/deffrian/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/deffrian/subscriptions",
    "organizations_url": "https://api.github.com/users/deffrian/orgs",
    "repos_url": "https://api.github.com/users/deffrian/repos",
    "events_url": "https://api.github.com/users/deffrian/events{/privacy}",
    "received_events_url": "https://api.github.com/users/deffrian/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "deffrian",
      "id": 19891475,
      "node_id": "MDQ6VXNlcjE5ODkxNDc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/19891475?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/deffrian",
      "html_url": "https://github.com/deffrian",
      "followers_url": "https://api.github.com/users/deffrian/followers",
      "following_url": "https://api.github.com/users/deffrian/following{/other_user}",
      "gists_url": "https://api.github.com/users/deffrian/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/deffrian/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/deffrian/subscriptions",
      "organizations_url": "https://api.github.com/users/deffrian/orgs",
      "repos_url": "https://api.github.com/users/deffrian/repos",
      "events_url": "https://api.github.com/users/deffrian/events{/privacy}",
      "received_events_url": "https://api.github.com/users/deffrian/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2022-10-30T15:59:01Z",
  "updated_at": "2023-02-09T14:32:38Z",
  "closed_at": "2023-02-09T14:32:38Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "**Describe the bug**\r\n1) If you send transaction via `eth_sendRawTransaction` under certain conditions (e.g. with lower `gasPrice` than required curently by the network) transactions one after another, nonce isn't incremented correctly resulting in errors like:\r\n\r\n```\r\nNonceGap, Future nonce. Expected nonce: 62\r\n```\r\n\r\nWhen in fact nonce is correctly specified in the raw signed transaction and it's 63 (specified manually), nonce of the account isn't updated until the transaction is confirmed. Nonce should be calculated including pending transactions in the queue.\r\n\r\n2) Another case if you use `eth_sendTransaction` and don't unlock account or get any type of error (e.g. not enough funds or incorrect gas amount for the transaction) nonce is being incremented but actual transaction never sent and on the next try you will have a nonce gap. This bug is very similar to - https://github.com/openethereum/parity-ethereum/issues/9040\r\n\r\n \r\n**To Reproduce**\r\n\r\nSteps to reproduce the behavior:\r\n1) send two pre-signed transactions with low gas price simultaneously or one after another right after, in both transactions specify nonce manually and consequently, e.g. in 1st: 5 in 2nd: 6\r\n \r\n2) a) `eth_sendTransaction` nonce increment when parallel transactions from the same address:\r\n\r\n```\r\narray (\r\n    'code' => -32010,\r\n    'message' => 'NonceGap, Future nonce. Expected nonce: 28486',\r\n  ),\r\n```\r\n\r\nb) `eth_sendTransaction` when account isn't unlocked nonce is incremented anyway and there will be a gap in future transactions\r\nc) `eth_sendTransaction` nonce is incremented when there is an error - not enough gas, amount is too high, etc\r\nd) might be other cases as well, see https://github.com/openethereum/parity-ethereum/issues/9040\r\n\r\n**Expected behavior**\r\nNonce should be correctly incremented including pending transactions.\r\n\r\n - OS: Linux x64 (Ubuntu 18.04 LTS)\r\n - Nethermind version: `1.14.5`\r\n",
  "closed_by": {
    "login": "deffrian",
    "id": 19891475,
    "node_id": "MDQ6VXNlcjE5ODkxNDc1",
    "avatar_url": "https://avatars.githubusercontent.com/u/19891475?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/deffrian",
    "html_url": "https://github.com/deffrian",
    "followers_url": "https://api.github.com/users/deffrian/followers",
    "following_url": "https://api.github.com/users/deffrian/following{/other_user}",
    "gists_url": "https://api.github.com/users/deffrian/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/deffrian/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/deffrian/subscriptions",
    "organizations_url": "https://api.github.com/users/deffrian/orgs",
    "repos_url": "https://api.github.com/users/deffrian/repos",
    "events_url": "https://api.github.com/users/deffrian/events{/privacy}",
    "received_events_url": "https://api.github.com/users/deffrian/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/4845/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/4845/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/1300787226",
    "html_url": "https://github.com/NethermindEth/nethermind/issues/4845#issuecomment-1300787226",
    "issue_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/4845",
    "id": 1300787226,
    "node_id": "IC_kwDOBggaLc5NiHAa",
    "user": {
      "login": "gituser",
      "id": 104405,
      "node_id": "MDQ6VXNlcjEwNDQwNQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/104405?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gituser",
      "html_url": "https://github.com/gituser",
      "followers_url": "https://api.github.com/users/gituser/followers",
      "following_url": "https://api.github.com/users/gituser/following{/other_user}",
      "gists_url": "https://api.github.com/users/gituser/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gituser/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gituser/subscriptions",
      "organizations_url": "https://api.github.com/users/gituser/orgs",
      "repos_url": "https://api.github.com/users/gituser/repos",
      "events_url": "https://api.github.com/users/gituser/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gituser/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-11-02T16:09:33Z",
    "updated_at": "2022-11-02T16:09:33Z",
    "author_association": "NONE",
    "body": "Hi! Any update on this? This is a very annoying bug happening from time to time on our Nethermind node.",
    "reactions": {
      "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/1300787226/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/1316708766",
    "html_url": "https://github.com/NethermindEth/nethermind/issues/4845#issuecomment-1316708766",
    "issue_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/4845",
    "id": 1316708766,
    "node_id": "IC_kwDOBggaLc5Oe2Ge",
    "user": {
      "login": "deffrian",
      "id": 19891475,
      "node_id": "MDQ6VXNlcjE5ODkxNDc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/19891475?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/deffrian",
      "html_url": "https://github.com/deffrian",
      "followers_url": "https://api.github.com/users/deffrian/followers",
      "following_url": "https://api.github.com/users/deffrian/following{/other_user}",
      "gists_url": "https://api.github.com/users/deffrian/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/deffrian/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/deffrian/subscriptions",
      "organizations_url": "https://api.github.com/users/deffrian/orgs",
      "repos_url": "https://api.github.com/users/deffrian/repos",
      "events_url": "https://api.github.com/users/deffrian/events{/privacy}",
      "received_events_url": "https://api.github.com/users/deffrian/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-11-16T09:50:09Z",
    "updated_at": "2022-11-16T09:50:09Z",
    "author_association": "CONTRIBUTOR",
    "body": "@gituser Hi, I probably know what caused the issue, but I'm not sure that I fully understand the second case. In both scenarios, do you have NonceGap error? What do you mean by nonce is being incremented? When a transaction with some nonce fails, the next transaction should have the same nonce.\r\nFor example:\r\n1). send_transaction(Nonce: 1) -> fail due to locked account.\r\n2). send_transaction(Nonce: 2) -> will fail due NonceGap, Nonce should be 1.\r\nAs I said I probably misunderstood your case. Can you correct me?\r\n\r\nBtw, this issue happens because we don't count transactions that are not good enough to fit in a mempool(in terms of gas price). As a temporary solution you can increase mempool size or increase gas price of your transactions.",
    "reactions": {
      "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/1316708766/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/1316792867",
    "html_url": "https://github.com/NethermindEth/nethermind/issues/4845#issuecomment-1316792867",
    "issue_url": "https://api.github.com/repos/NethermindEth/nethermind/issues/4845",
    "id": 1316792867,
    "node_id": "IC_kwDOBggaLc5OfKoj",
    "user": {
      "login": "gituser",
      "id": 104405,
      "node_id": "MDQ6VXNlcjEwNDQwNQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/104405?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gituser",
      "html_url": "https://github.com/gituser",
      "followers_url": "https://api.github.com/users/gituser/followers",
      "following_url": "https://api.github.com/users/gituser/following{/other_user}",
      "gists_url": "https://api.github.com/users/gituser/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gituser/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gituser/subscriptions",
      "organizations_url": "https://api.github.com/users/gituser/orgs",
      "repos_url": "https://api.github.com/users/gituser/repos",
      "events_url": "https://api.github.com/users/gituser/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gituser/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-11-16T10:48:51Z",
    "updated_at": "2022-11-16T10:48:51Z",
    "author_association": "NONE",
    "body": "@deffrian \r\n> @gituser Hi, I probably know what caused the issue, but I'm not sure that I fully understand the second case. In both scenarios, do you have NonceGap error? \r\n\r\nYes I do have this error. \r\n\r\n>What do you mean by nonce is being incremented? \r\n\r\nAfter you've tried to post transaction from unlocked account or specified too much ETH etc etc, the next correct try will result in nonce being incremented e.g. if you had nonce=2 originally in correct try you will have nonce=4 instead of 3.\r\n\r\n>When a transaction with some nonce fails, the next transaction should have the same nonce. For example: 1). send_transaction(Nonce: 1) -> fail due to locked account. 2). send_transaction(Nonce: 2) -> will fail due NonceGap, Nonce should be 1. As I said I probably misunderstood your case. Can you correct me?\r\n\r\nYes, this is correct.\r\n\r\n> Btw, this issue happens because we don't count transactions that are not good enough to fit in a mempool(in terms of gas price). As a temporary solution you can increase mempool size or increase gas price of your transactions.\r\n\r\nWell, we need  a correct fix for nethermind similar what parity guys did in OE.\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/NethermindEth/nethermind/issues/comments/1316792867/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
