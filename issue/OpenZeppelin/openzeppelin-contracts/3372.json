{
  "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/3372",
  "repository_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts",
  "labels_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/3372/labels{/name}",
  "comments_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/3372/comments",
  "events_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/3372/events",
  "html_url": "https://github.com/OpenZeppelin/openzeppelin-contracts/issues/3372",
  "id": 1219393416,
  "node_id": "I_kwDOA9tCBs5IrneI",
  "number": 3372,
  "title": "ERC721 reentrancy vulnerability of  `_burn` function",
  "user": {
    "login": "zoey-t",
    "id": 101599447,
    "node_id": "U_kgDOBg5I1w",
    "avatar_url": "https://avatars.githubusercontent.com/u/101599447?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/zoey-t",
    "html_url": "https://github.com/zoey-t",
    "followers_url": "https://api.github.com/users/zoey-t/followers",
    "following_url": "https://api.github.com/users/zoey-t/following{/other_user}",
    "gists_url": "https://api.github.com/users/zoey-t/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/zoey-t/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/zoey-t/subscriptions",
    "organizations_url": "https://api.github.com/users/zoey-t/orgs",
    "repos_url": "https://api.github.com/users/zoey-t/repos",
    "events_url": "https://api.github.com/users/zoey-t/events{/privacy}",
    "received_events_url": "https://api.github.com/users/zoey-t/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2022-04-28T22:35:33Z",
  "updated_at": "2022-04-29T10:50:53Z",
  "closed_at": "2022-04-29T10:50:52Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "<!-- Briefly describe the issue you're experiencing. Tell us what you were trying to do and what happened instead. -->\r\nInside `ERC721._burn()`, it decreases the balance first, then deletes the ownership of specific tokenId.\r\n[link](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/fcf35e5722847f5eadaaee052968a8a54d03622a/contracts/token/ERC721/ERC721.sol#L304-L318)\r\n```Solidity\r\nfunction _burn(uint256 tokenId) internal virtual {\r\n        address owner = ERC721.ownerOf(tokenId);\r\n\r\n        _beforeTokenTransfer(owner, address(0), tokenId);\r\n\r\n        // Clear approvals\r\n        _approve(address(0), tokenId);\r\n\r\n        _balances[owner] -= 1;\r\n        delete _owners[tokenId];\r\n\r\n        emit Transfer(owner, address(0), tokenId);\r\n\r\n        _afterTokenTransfer(owner, address(0), tokenId);\r\n    }\r\n```\r\nFor better practice of preventing reentrancy attack, it should first deletes `_owners[tokenId]`, then decreases the `_balances [owner]`.\r\n```Solidity\r\nfunction _burn(uint256 tokenId) internal virtual {\r\n        address owner = ERC721.ownerOf(tokenId);\r\n\r\n        _beforeTokenTransfer(owner, address(0), tokenId);\r\n\r\n        // Clear approvals\r\n        _approve(address(0), tokenId);\r\n    \r\n        delete _owners[tokenId];\r\n        _balances[owner] -= 1;\r\n\r\n        emit Transfer(owner, address(0), tokenId);\r\n\r\n        _afterTokenTransfer(owner, address(0), tokenId);\r\n    }\r\n```\r\n\r\n<!-- Remember, this is not a place to ask for help debugging code. For that, we welcome you in the OpenZeppelin Community Forum: https://forum.openzeppelin.com/. -->\r\n\r\n**üíª Environment**\r\n\r\n<!-- Tell us what version of OpenZeppelin Contracts you're using, and how you're using it: Truffle, Remix, etc. -->\r\n\r\n**üìù Details**\r\n\r\n<!-- Describe the problem you have been experiencing in more detail. Include as much information as you think is relevant. Keep in mind that transactions can fail for many reasons; context is key here. -->\r\n\r\n**üî¢ Code to reproduce bug**\r\n\r\n<!-- We will be able to better help if you provide a minimal example that triggers the bug. -->\r\n",
  "closed_by": {
    "login": "Amxx",
    "id": 2432299,
    "node_id": "MDQ6VXNlcjI0MzIyOTk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2432299?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Amxx",
    "html_url": "https://github.com/Amxx",
    "followers_url": "https://api.github.com/users/Amxx/followers",
    "following_url": "https://api.github.com/users/Amxx/following{/other_user}",
    "gists_url": "https://api.github.com/users/Amxx/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Amxx/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Amxx/subscriptions",
    "organizations_url": "https://api.github.com/users/Amxx/orgs",
    "repos_url": "https://api.github.com/users/Amxx/repos",
    "events_url": "https://api.github.com/users/Amxx/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Amxx/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/3372/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/3372/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/1113168553",
    "html_url": "https://github.com/OpenZeppelin/openzeppelin-contracts/issues/3372#issuecomment-1113168553",
    "issue_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/3372",
    "id": 1113168553,
    "node_id": "IC_kwDOA9tCBs5CWZqp",
    "user": {
      "login": "Amxx",
      "id": 2432299,
      "node_id": "MDQ6VXNlcjI0MzIyOTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2432299?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Amxx",
      "html_url": "https://github.com/Amxx",
      "followers_url": "https://api.github.com/users/Amxx/followers",
      "following_url": "https://api.github.com/users/Amxx/following{/other_user}",
      "gists_url": "https://api.github.com/users/Amxx/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Amxx/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Amxx/subscriptions",
      "organizations_url": "https://api.github.com/users/Amxx/orgs",
      "repos_url": "https://api.github.com/users/Amxx/repos",
      "events_url": "https://api.github.com/users/Amxx/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Amxx/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-04-29T10:50:52Z",
    "updated_at": "2022-04-29T10:50:52Z",
    "author_association": "COLLABORATOR",
    "body": "Hello @zoey-t \r\n\r\nFor reentrancy to happen, you would need an external call to be triggered between the two operations. There is no such call.\r\n\r\nWe have a guarantee that these two operations are executed sequentially, without any other code executed in the middle, so no, there is no reentrancy vulnerability here. Your code would be valid, but not more or less than the current version.",
    "reactions": {
      "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/1113168553/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
