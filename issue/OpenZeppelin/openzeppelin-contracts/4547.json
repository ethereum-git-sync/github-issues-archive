{
  "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/4547",
  "repository_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts",
  "labels_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/4547/labels{/name}",
  "comments_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/4547/comments",
  "events_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/4547/events",
  "html_url": "https://github.com/OpenZeppelin/openzeppelin-contracts/issues/4547",
  "id": 1871316411,
  "node_id": "I_kwDOA9tCBs5vigW7",
  "number": 4547,
  "title": "The _update method in ERC721 contains an explicit delete of the approval",
  "user": {
    "login": "vladyan18",
    "id": 13525908,
    "node_id": "MDQ6VXNlcjEzNTI1OTA4",
    "avatar_url": "https://avatars.githubusercontent.com/u/13525908?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/vladyan18",
    "html_url": "https://github.com/vladyan18",
    "followers_url": "https://api.github.com/users/vladyan18/followers",
    "following_url": "https://api.github.com/users/vladyan18/following{/other_user}",
    "gists_url": "https://api.github.com/users/vladyan18/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/vladyan18/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/vladyan18/subscriptions",
    "organizations_url": "https://api.github.com/users/vladyan18/orgs",
    "repos_url": "https://api.github.com/users/vladyan18/repos",
    "events_url": "https://api.github.com/users/vladyan18/events{/privacy}",
    "received_events_url": "https://api.github.com/users/vladyan18/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2023-08-29T10:03:06Z",
  "updated_at": "2023-08-29T10:52:26Z",
  "closed_at": null,
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "I mentioned it in a comment: https://github.com/OpenZeppelin/openzeppelin-contracts/pull/4377#issuecomment-1692045182\r\nNow I'm opening an issue so that the discussion is not lost\r\n\r\n\r\n**üìù Details**\r\n\r\nI find this line causing some inconvenience:\r\nhttps://github.com/OpenZeppelin/openzeppelin-contracts/blob/9e3f4d60c581010c4a3979480e07cc7752f124cc/contracts/token/ERC721/ERC721.sol#L254\r\n\r\nTaking into account the fact that both the process of [approving ](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/9e3f4d60c581010c4a3979480e07cc7752f124cc/contracts/token/ERC721/ERC721.sol#L399) and [getting an approved address](_getApproved) are placed in separate virtual functions and can be overriden. In this case, if the internal mechanism is somehow replaced, the above line will remain (or you need to redefine the entire `_update `function), creating unnecessary gas waste.\r\n\r\nAt the same time, there are projects that really redefine the approval logic (and storage), for example:\r\nhttps://github.com/Uniswap/v3-periphery/blob/6cce88e63e176af1ddb6cc56e029110289622317/contracts/NonfungiblePositionManager.sol#L395-L399\r\n\r\nAs mentioned in the discussion, this implementation (explicit delete in `_update`) arose because [OZ used to do _approve(address(0), tokenId);](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/release-v4.7/contracts/token/ERC721/ERC721.sol#L341) but this was changed to avoid emiting the Approval event (https://github.com/OpenZeppelin/openzeppelin-contracts/pull/4377#issuecomment-1692053310).\r\n\r\nIn fact, such an unnecessary storage slot touch can indeed be avoided if the `_update` function is completely overriden in its implementation. This solves the problem, albeit in a somewhat uncomfortable way in my opinion.\r\n\r\nOn the other hand, ERC20 takes a different approach in similar circumstances (https://github.com/OpenZeppelin/openzeppelin-contracts/pull/4377#issuecomment-1692131099) : https://github.com/OpenZeppelin/openzeppelin-contracts/blob/9e3f4d60c581010c4a3979480e07cc7752f124cc/contracts/token/ERC20/ERC20.sol#L338-L349C6",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/4547/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/4547/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
[
  {
    "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/1697209968",
    "html_url": "https://github.com/OpenZeppelin/openzeppelin-contracts/issues/4547#issuecomment-1697209968",
    "issue_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/4547",
    "id": 1697209968,
    "node_id": "IC_kwDOA9tCBs5lKV5w",
    "user": {
      "login": "vladyan18",
      "id": 13525908,
      "node_id": "MDQ6VXNlcjEzNTI1OTA4",
      "avatar_url": "https://avatars.githubusercontent.com/u/13525908?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vladyan18",
      "html_url": "https://github.com/vladyan18",
      "followers_url": "https://api.github.com/users/vladyan18/followers",
      "following_url": "https://api.github.com/users/vladyan18/following{/other_user}",
      "gists_url": "https://api.github.com/users/vladyan18/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vladyan18/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vladyan18/subscriptions",
      "organizations_url": "https://api.github.com/users/vladyan18/orgs",
      "repos_url": "https://api.github.com/users/vladyan18/repos",
      "events_url": "https://api.github.com/users/vladyan18/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vladyan18/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-08-29T10:52:25Z",
    "updated_at": "2023-08-29T10:52:25Z",
    "author_association": "CONTRIBUTOR",
    "body": "UPD: it looks like it will be impossible to override `_update` in your own contract without headache - balances and other state variables are private.",
    "reactions": {
      "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/1697209968/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
