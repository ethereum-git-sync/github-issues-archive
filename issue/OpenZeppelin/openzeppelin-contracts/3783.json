{
  "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/3783",
  "repository_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts",
  "labels_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/3783/labels{/name}",
  "comments_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/3783/comments",
  "events_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/3783/events",
  "html_url": "https://github.com/OpenZeppelin/openzeppelin-contracts/issues/3783",
  "id": 1423981043,
  "node_id": "I_kwDOA9tCBs5U4Dnz",
  "number": 3783,
  "title": "ReentrancyGuard: Change value of _ENTERED from 2 to 0",
  "user": {
    "login": "tzann",
    "id": 24497035,
    "node_id": "MDQ6VXNlcjI0NDk3MDM1",
    "avatar_url": "https://avatars.githubusercontent.com/u/24497035?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tzann",
    "html_url": "https://github.com/tzann",
    "followers_url": "https://api.github.com/users/tzann/followers",
    "following_url": "https://api.github.com/users/tzann/following{/other_user}",
    "gists_url": "https://api.github.com/users/tzann/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tzann/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tzann/subscriptions",
    "organizations_url": "https://api.github.com/users/tzann/orgs",
    "repos_url": "https://api.github.com/users/tzann/repos",
    "events_url": "https://api.github.com/users/tzann/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tzann/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "frangio",
    "id": 481465,
    "node_id": "MDQ6VXNlcjQ4MTQ2NQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/481465?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/frangio",
    "html_url": "https://github.com/frangio",
    "followers_url": "https://api.github.com/users/frangio/followers",
    "following_url": "https://api.github.com/users/frangio/following{/other_user}",
    "gists_url": "https://api.github.com/users/frangio/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/frangio/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/frangio/subscriptions",
    "organizations_url": "https://api.github.com/users/frangio/orgs",
    "repos_url": "https://api.github.com/users/frangio/repos",
    "events_url": "https://api.github.com/users/frangio/events{/privacy}",
    "received_events_url": "https://api.github.com/users/frangio/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "frangio",
      "id": 481465,
      "node_id": "MDQ6VXNlcjQ4MTQ2NQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/481465?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/frangio",
      "html_url": "https://github.com/frangio",
      "followers_url": "https://api.github.com/users/frangio/followers",
      "following_url": "https://api.github.com/users/frangio/following{/other_user}",
      "gists_url": "https://api.github.com/users/frangio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/frangio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/frangio/subscriptions",
      "organizations_url": "https://api.github.com/users/frangio/orgs",
      "repos_url": "https://api.github.com/users/frangio/repos",
      "events_url": "https://api.github.com/users/frangio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/frangio/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2022-10-26T12:59:48Z",
  "updated_at": "2022-11-08T08:48:47Z",
  "closed_at": "2022-11-07T18:37:30Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "**🧐 Motivation**\r\nThis change allows the solidity compiler to optimize the reentrancy check in order to reduce bytecode size and gas costs.\r\n\r\n**📝 Details**\r\nSimply change the value of `_ENTERED` in ReentrancyGuard.sol from 2 to 0.\r\n\r\nEssentially, checking for (in)equality with a non-zero number requires a `push` and `eq` opcode, whereas checking for (in)equality with zero can make use of the `iszero` opcode instead. In this case the `iszero` opcode can even be omitted as the `jumpi` instruction checks for zero/non-zero already.\r\n\r\nImportantly, the cost and refund amounts for the storage operations remain the same. See https://eips.ethereum.org/EIPS/eip-3529 for details, but essentially going 1 -> 2 -> 1 costs the same and gives the same refund as going 1 -> 0 -> 1.\r\n\r\nLastly, the `sstore(0, 0)` operation is also slightly optimized as it can be done using a `push` and a `dup` instead of two `push` opcodes. Note that this assumes that the `_status` storage variable is in storage slot 0, which is not guaranteed.\r\n\r\nIn total, this reduces the bytecode size by 3-4 bytes (depending on storage layout) and gas costs by 6 gas.\r\n\r\n\r\nBytecode of `_nonReentrantBefore` before suggested changes:\r\n```\r\n      0x02\r\n      0x00\r\n      sload\r\n      sub\r\n      tag_13\r\n      jumpi\r\n      ... <revert stuff here>\r\n  tag_13:\r\n      0x02\r\n      0x00\r\n      sstore\r\n      jump\r\n```\r\n\r\nBytecode of `_nonReentrantBefore` after suggested changes:\r\n```\r\n      0x00\r\n      sload\r\n      tag_13\r\n      jumpi\r\n      ... <revert stuff here>\r\n  tag_13:\r\n      0x00\r\n      dup1\r\n      sstore\r\n      jump\r\n```\r\n\r\nIn total, 3-4 bytes of bytecode are removed, and any reentrancy check is cheaper by 6 gas, regardless of the outcome.",
  "closed_by": {
    "login": "frangio",
    "id": 481465,
    "node_id": "MDQ6VXNlcjQ4MTQ2NQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/481465?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/frangio",
    "html_url": "https://github.com/frangio",
    "followers_url": "https://api.github.com/users/frangio/followers",
    "following_url": "https://api.github.com/users/frangio/following{/other_user}",
    "gists_url": "https://api.github.com/users/frangio/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/frangio/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/frangio/subscriptions",
    "organizations_url": "https://api.github.com/users/frangio/orgs",
    "repos_url": "https://api.github.com/users/frangio/repos",
    "events_url": "https://api.github.com/users/frangio/events{/privacy}",
    "received_events_url": "https://api.github.com/users/frangio/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/3783/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/3783/timeline",
  "performed_via_github_app": null,
  "state_reason": "not_planned"
}
[
  {
    "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/1298934250",
    "html_url": "https://github.com/OpenZeppelin/openzeppelin-contracts/issues/3783#issuecomment-1298934250",
    "issue_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/3783",
    "id": 1298934250,
    "node_id": "IC_kwDOA9tCBs5NbCnq",
    "user": {
      "login": "tobiasperel",
      "id": 74215065,
      "node_id": "MDQ6VXNlcjc0MjE1MDY1",
      "avatar_url": "https://avatars.githubusercontent.com/u/74215065?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tobiasperel",
      "html_url": "https://github.com/tobiasperel",
      "followers_url": "https://api.github.com/users/tobiasperel/followers",
      "following_url": "https://api.github.com/users/tobiasperel/following{/other_user}",
      "gists_url": "https://api.github.com/users/tobiasperel/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tobiasperel/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tobiasperel/subscriptions",
      "organizations_url": "https://api.github.com/users/tobiasperel/orgs",
      "repos_url": "https://api.github.com/users/tobiasperel/repos",
      "events_url": "https://api.github.com/users/tobiasperel/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tobiasperel/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-11-01T18:23:53Z",
    "updated_at": "2022-11-01T18:23:53Z",
    "author_association": "NONE",
    "body": "Interesting",
    "reactions": {
      "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/1298934250/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/1302744102",
    "html_url": "https://github.com/OpenZeppelin/openzeppelin-contracts/issues/3783#issuecomment-1302744102",
    "issue_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/3783",
    "id": 1302744102,
    "node_id": "IC_kwDOA9tCBs5Npkwm",
    "user": {
      "login": "frangio",
      "id": 481465,
      "node_id": "MDQ6VXNlcjQ4MTQ2NQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/481465?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/frangio",
      "html_url": "https://github.com/frangio",
      "followers_url": "https://api.github.com/users/frangio/followers",
      "following_url": "https://api.github.com/users/frangio/following{/other_user}",
      "gists_url": "https://api.github.com/users/frangio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/frangio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/frangio/subscriptions",
      "organizations_url": "https://api.github.com/users/frangio/orgs",
      "repos_url": "https://api.github.com/users/frangio/repos",
      "events_url": "https://api.github.com/users/frangio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/frangio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-11-03T22:27:43Z",
    "updated_at": "2022-11-03T22:27:43Z",
    "author_association": "MEMBER",
    "body": "In theory this makes sense, but there is an edge case that breaks with this change. This edge case has actually come up in conversations in the past as something that people use, and I'm comfortable with giving up on a 6 gas improvement in order to be super sure that we won't be breaking it.\r\n\r\nIf a proxy contract delegates to a ReentrancyGuard contract, it doesn't need to initialize the `_status` variable in order for `nonReentrant` functions to work. The reason is that the require statement is written as `_status != _ENTERED`:\r\n\r\nhttps://github.com/OpenZeppelin/openzeppelin-contracts/blob/d5ca39e9a264ddcadd5742484b6d391ae1647a10/contracts/security/ReentrancyGuard.sol#L58\r\n\r\nIf we change `_ENTERED` to 0, this stops working. The variable needs to be initialized or the modifier doesn't work.\r\n\r\nNormally proxies invoke an initializer, but some users may be relying that it isn't necessary in this case...",
    "reactions": {
      "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/1302744102/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/1306028881",
    "html_url": "https://github.com/OpenZeppelin/openzeppelin-contracts/issues/3783#issuecomment-1306028881",
    "issue_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/3783",
    "id": 1306028881,
    "node_id": "IC_kwDOA9tCBs5N2GtR",
    "user": {
      "login": "frangio",
      "id": 481465,
      "node_id": "MDQ6VXNlcjQ4MTQ2NQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/481465?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/frangio",
      "html_url": "https://github.com/frangio",
      "followers_url": "https://api.github.com/users/frangio/followers",
      "following_url": "https://api.github.com/users/frangio/following{/other_user}",
      "gists_url": "https://api.github.com/users/frangio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/frangio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/frangio/subscriptions",
      "organizations_url": "https://api.github.com/users/frangio/orgs",
      "repos_url": "https://api.github.com/users/frangio/repos",
      "events_url": "https://api.github.com/users/frangio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/frangio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-11-07T18:37:30Z",
    "updated_at": "2022-11-07T18:37:30Z",
    "author_association": "MEMBER",
    "body": "Closing for the reasons explained above.",
    "reactions": {
      "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/1306028881/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/1306844938",
    "html_url": "https://github.com/OpenZeppelin/openzeppelin-contracts/issues/3783#issuecomment-1306844938",
    "issue_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/3783",
    "id": 1306844938,
    "node_id": "IC_kwDOA9tCBs5N5N8K",
    "user": {
      "login": "tzann",
      "id": 24497035,
      "node_id": "MDQ6VXNlcjI0NDk3MDM1",
      "avatar_url": "https://avatars.githubusercontent.com/u/24497035?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tzann",
      "html_url": "https://github.com/tzann",
      "followers_url": "https://api.github.com/users/tzann/followers",
      "following_url": "https://api.github.com/users/tzann/following{/other_user}",
      "gists_url": "https://api.github.com/users/tzann/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tzann/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tzann/subscriptions",
      "organizations_url": "https://api.github.com/users/tzann/orgs",
      "repos_url": "https://api.github.com/users/tzann/repos",
      "events_url": "https://api.github.com/users/tzann/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tzann/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-11-08T08:48:47Z",
    "updated_at": "2022-11-08T08:48:47Z",
    "author_association": "NONE",
    "body": "Thanks for the explanation, makes sense! I wasn't aware of the previous conversations around this topic 😁 ",
    "reactions": {
      "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/1306844938/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
