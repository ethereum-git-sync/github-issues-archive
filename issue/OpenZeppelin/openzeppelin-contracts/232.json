{
  "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/232",
  "repository_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts",
  "labels_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/232/labels{/name}",
  "comments_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/232/comments",
  "events_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/232/events",
  "html_url": "https://github.com/OpenZeppelin/openzeppelin-contracts/issues/232",
  "id": 232170689,
  "node_id": "MDU6SXNzdWUyMzIxNzA2ODk=",
  "number": 232,
  "title": "[VestedToken] The balance of a holder can be frozen with a stalker-type attack (Already mitigated by v1.0.6)",
  "user": {
    "login": "izqui",
    "id": 447328,
    "node_id": "MDQ6VXNlcjQ0NzMyOA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/447328?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/izqui",
    "html_url": "https://github.com/izqui",
    "followers_url": "https://api.github.com/users/izqui/followers",
    "following_url": "https://api.github.com/users/izqui/following{/other_user}",
    "gists_url": "https://api.github.com/users/izqui/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/izqui/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/izqui/subscriptions",
    "organizations_url": "https://api.github.com/users/izqui/orgs",
    "repos_url": "https://api.github.com/users/izqui/repos",
    "events_url": "https://api.github.com/users/izqui/events{/privacy}",
    "received_events_url": "https://api.github.com/users/izqui/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2017-05-30T07:56:23Z",
  "updated_at": "2017-11-10T20:37:41Z",
  "closed_at": "2017-11-10T20:37:41Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "**Zeppelin v1.0.6 already mitigates the issue with solution 3 (see below). A more permanent and elegant solution is needed.** \r\n\r\n**TL;DR: A malicious actor could freeze the balance of a holder (blocking them from transfering their hard-earned tokens) pretty cheaply.** \r\n\r\n#### Attack description:\r\n\r\nGiven how many decimals tokens normally use, the minimum transferable (and therefore grantable) amount is price is almost 0. Given that the logic for checking how many tokens has a holder vested (done in every transfer) involves iterating its grants array, in the case this array is sufficiently large, the transaction can run out of gas before completing, resulting in the holder not being able to transfer tokens.\r\n\r\n#### Attack flow:\r\n\r\n1. Attacker acquires `x` tokens.\r\n2. Attacker transfers victim the smallest amount of tokens with `grantVestedTokens(...)`\r\n3. Attacker repeats step 2 as many times as needed. Cost per transaction is the gas fee to perform a grant (less than 300k gas) plus the lost tokens to the victim (if tokens has many decimals, this cost is worthless)\r\n4. When victim attempts to transfer his tokens, transaction goes 'Out of gas' while iterating through his multiple grants created by the attacker.\r\n\r\n#### Solutions:\r\n\r\nPossible (and complementary) solutions I can think of, in order of personal preference: \r\n\r\n1. Only certain trusted whitelisted addresses can do token grants. There is a `whitelister` address that can give and remove the ability of addresses to create grants. This has been Aragon's approach for our own token.\r\n\r\n2. In order to be able to receive grants, a certain holder needs to `whitelist` itself or whitelist the addresses she wants to be able to receive grants from.\r\n\r\n3. Hard-code the maximum amount of grants a certain holder can receive (lower than what would cause an 'Out of gas' under reasonable limits). This way a holder can be stalked and lose the ability to receive more grants, but this way tokens will never be locked and can be transfered to a new account. For Aragon's usecase (we don't expect holders to have much grants, maximum amount is 2 right now) we have hard-coded it on 20 grants, which is way less than what would cause a problem.\r\n\r\n4. Enforce a minimum bound on how many tokens have to be transferred in a grant. Doesn't really solve the problem, but could make the attack pretty expensive. \r\n\r\nYou can check [MiniMeIrrevocableVestedToken.sol](https://github.com/aragon/aragon-network-token/blob/master/contracts/MiniMeIrrevocableVestedToken.sol) for the implementation of [1](https://github.com/aragon/aragon-network-token/blob/master/contracts/MiniMeIrrevocableVestedToken.sol#L107-L121) and [3](https://github.com/aragon/aragon-network-token/blob/master/contracts/MiniMeIrrevocableVestedToken.sol#L97) in Aragon's token.\r\n\r\nThis problem was discovered by @jbaylina while auditing Aragon's code.",
  "closed_by": {
    "login": "maraoz",
    "id": 287189,
    "node_id": "MDQ6VXNlcjI4NzE4OQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/287189?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/maraoz",
    "html_url": "https://github.com/maraoz",
    "followers_url": "https://api.github.com/users/maraoz/followers",
    "following_url": "https://api.github.com/users/maraoz/following{/other_user}",
    "gists_url": "https://api.github.com/users/maraoz/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/maraoz/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/maraoz/subscriptions",
    "organizations_url": "https://api.github.com/users/maraoz/orgs",
    "repos_url": "https://api.github.com/users/maraoz/repos",
    "events_url": "https://api.github.com/users/maraoz/events{/privacy}",
    "received_events_url": "https://api.github.com/users/maraoz/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/232/reactions",
    "total_count": 4,
    "+1": 3,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 1,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/232/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/304898700",
    "html_url": "https://github.com/OpenZeppelin/openzeppelin-contracts/issues/232#issuecomment-304898700",
    "issue_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/232",
    "id": 304898700,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMwNDg5ODcwMA==",
    "user": {
      "login": "maraoz",
      "id": 287189,
      "node_id": "MDQ6VXNlcjI4NzE4OQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/287189?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/maraoz",
      "html_url": "https://github.com/maraoz",
      "followers_url": "https://api.github.com/users/maraoz/followers",
      "following_url": "https://api.github.com/users/maraoz/following{/other_user}",
      "gists_url": "https://api.github.com/users/maraoz/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/maraoz/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/maraoz/subscriptions",
      "organizations_url": "https://api.github.com/users/maraoz/orgs",
      "repos_url": "https://api.github.com/users/maraoz/repos",
      "events_url": "https://api.github.com/users/maraoz/events{/privacy}",
      "received_events_url": "https://api.github.com/users/maraoz/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-05-30T14:37:18Z",
    "updated_at": "2017-05-30T14:37:18Z",
    "author_association": "CONTRIBUTOR",
    "body": "Thanks for the responsible report, giving us time to fix it and push a new release :)",
    "reactions": {
      "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/304898700/reactions",
      "total_count": 3,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 3,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/343579628",
    "html_url": "https://github.com/OpenZeppelin/openzeppelin-contracts/issues/232#issuecomment-343579628",
    "issue_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/232",
    "id": 343579628,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM0MzU3OTYyOA==",
    "user": {
      "login": "maraoz",
      "id": 287189,
      "node_id": "MDQ6VXNlcjI4NzE4OQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/287189?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/maraoz",
      "html_url": "https://github.com/maraoz",
      "followers_url": "https://api.github.com/users/maraoz/followers",
      "following_url": "https://api.github.com/users/maraoz/following{/other_user}",
      "gists_url": "https://api.github.com/users/maraoz/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/maraoz/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/maraoz/subscriptions",
      "organizations_url": "https://api.github.com/users/maraoz/orgs",
      "repos_url": "https://api.github.com/users/maraoz/repos",
      "events_url": "https://api.github.com/users/maraoz/events{/privacy}",
      "received_events_url": "https://api.github.com/users/maraoz/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-11-10T20:37:41Z",
    "updated_at": "2017-11-10T20:37:41Z",
    "author_association": "CONTRIBUTOR",
    "body": "Closing as the problem was more elegantly fixed by moving the vesting logic to a separate contract ([TokenVesting](https://github.com/OpenZeppelin/zeppelin-solidity/blob/master/contracts/token/TokenVesting.sol))",
    "reactions": {
      "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/343579628/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
