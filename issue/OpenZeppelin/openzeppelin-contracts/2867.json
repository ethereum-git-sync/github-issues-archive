{
  "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2867",
  "repository_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts",
  "labels_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2867/labels{/name}",
  "comments_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2867/comments",
  "events_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2867/events",
  "html_url": "https://github.com/OpenZeppelin/openzeppelin-contracts/issues/2867",
  "id": 998779298,
  "node_id": "I_kwDOA9tCBs47iCmi",
  "number": 2867,
  "title": "ERC721: unable to access token with ownerOf, getting \"owner query for nonexistent token\"",
  "user": {
    "login": "ohaponiuk",
    "id": 64164850,
    "node_id": "MDQ6VXNlcjY0MTY0ODUw",
    "avatar_url": "https://avatars.githubusercontent.com/u/64164850?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ohaponiuk",
    "html_url": "https://github.com/ohaponiuk",
    "followers_url": "https://api.github.com/users/ohaponiuk/followers",
    "following_url": "https://api.github.com/users/ohaponiuk/following{/other_user}",
    "gists_url": "https://api.github.com/users/ohaponiuk/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ohaponiuk/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ohaponiuk/subscriptions",
    "organizations_url": "https://api.github.com/users/ohaponiuk/orgs",
    "repos_url": "https://api.github.com/users/ohaponiuk/repos",
    "events_url": "https://api.github.com/users/ohaponiuk/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ohaponiuk/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 6,
  "created_at": "2021-09-17T00:01:46Z",
  "updated_at": "2021-09-17T18:45:56Z",
  "closed_at": "2021-09-17T05:39:39Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "## Issue\r\nGetting `Error: Returned error: VM Exception while processing transaction: revert ERC721: owner query for nonexistent token` while trying to use the `ownerOf` function, which means that the ID used for `ownerOf` is wrong but it doesn't make any sense.\r\n## Steps to reproduce\r\n1. Create a project using Truffle, OpenZeppelin\r\n```\r\ntruffle init\r\nnpm init\r\nnpm install @openzeppelin/contracts\r\n```\r\n2. Edit `truffle-config.js` to use latest version of Solidity:\r\n```\r\n  compilers: {\r\n    solc: {\r\n      version: \"0.8.3\",    // Fetch exact version from solc-bin (default: truffle's version)\r\n      // docker: true,        // Use \"0.5.1\" you've installed locally with docker (default: false)\r\n      // settings: {          // See the solidity docs for advice about optimization and evmVersion\r\n      //  optimizer: {\r\n      //    enabled: false,\r\n      //    runs: 200\r\n      //  },\r\n      //  evmVersion: \"byzantium\"\r\n      // }\r\n    }\r\n  },\r\n```\r\n3. Create `contracts/GameItem.sol` according to [OpenZeppelin documentation on ERC721][1]\r\n\r\n```\r\n// contracts/GameItem.sol\r\n// SPDX-License-Identifier: MIT\r\npragma solidity ^0.8.0;\r\n\r\nimport \"@openzeppelin/contracts/token/ERC721/extensions/ERC721URIStorage.sol\";\r\nimport \"@openzeppelin/contracts/utils/Counters.sol\";\r\n\r\ncontract GameItem is ERC721URIStorage {\r\n    using Counters for Counters.Counter;\r\n    Counters.Counter private _tokenIds;\r\n\r\n    constructor() ERC721(\"GameItem\", \"ITM\") {}\r\n\r\n    function awardItem(address player, string memory tokenURI)\r\n        public\r\n        returns (uint256)\r\n    {\r\n        _tokenIds.increment();\r\n\r\n        uint256 newItemId = _tokenIds.current();\r\n        _mint(player, newItemId);\r\n        _setTokenURI(newItemId, tokenURI);\r\n\r\n        return newItemId;\r\n    }\r\n}\r\n```\r\n4. Create `migrations/2_deploy_contracts.js`\r\n```\r\nconst GameItem = artifacts.require(\"GameItem\")\r\n\r\nmodule.exports = function (deployer) {\r\n    deployer.deploy(GameItem)\r\n}\r\n```\r\n5. Create `tests/GameItem.test.js` the purpose of which is to mint a token and find its owner\r\n```\r\nconst GameItem = artifacts.require(\"GameItem\")\r\n\r\ncontract(\"GameItem\", (accounts) => {\r\n    before(async() => {\r\n        gameItem = await GameItem.deployed()\r\n    })\r\n\r\n    it(\"Minting\", async() => {\r\n        gameItem.awardItem(accounts[0], \"meta\")\r\n        let result = await gameItem.ownerOf(1)\r\n        console.log(result)\r\n    })\r\n})\r\n```\r\n6. Run `truffle test` and get the following:\r\n```\r\nContract: GameItem\r\n    1) Minting\r\n\r\n    Events emitted during test:\r\n    ---------------------------\r\n\r\n    IERC721.Transfer(\r\n      from: <indexed> 0x0000000000000000000000000000000000000000 (type: address),\r\n      to: <indexed> 0x627306090abaB3A6e1400e9345bC60c78a8BEf57 (type: address),\r\n      tokenId: <indexed> 1 (type: uint256)\r\n    )\r\n\r\n\r\n    ---------------------------\r\n\r\n\r\n  0 passing (1s)\r\n  1 failing\r\n\r\n  1) Contract: GameItem\r\n       Minting:\r\n     Error: Returned error: VM Exception while processing transaction: revert ERC721: owner query for nonexistent token\r\n      at Context.<anonymous> (test/GameItem.test.js:11:37)\r\n      at processTicksAndRejections (internal/process/task_queues.js:95:5)\r\n```\r\n\r\n## What I think is happening\r\n\r\nFor some reason, `1` is an incorrect ID, even though when I transfer a token by that ID, it doesn't throw an exception. (I used `transferFrom()`, if token with ID 1 wouldn't exist it would throw an exception since it requires `_isApprovedOrOwner`, and `_isApprovedOrOwner` requires `_exists`. But it worked well until I decided to check the owner by ID.)\r\n\r\n## What I tried to do\r\n\r\n1. Doing the same in development mode\r\n```\r\ntruffle development\r\nmigrate\r\ngameItem = await GameItem.deployed()\r\ngameItem.awardItem(accounts[0], \"meta\")\r\ngameItem.ownerOf(1)\r\n```\r\nWorks as intended, returns an address, no exceptions.\r\n\r\n2. Then I thought: maybe the ID is actually different, not `1`. So I decided to take control of it instead of using `awardItem` from docs. I added the following function to `GameItem.sol`:\r\n```\r\nfunction mintWrapper(address player, uint256 tokenId)\r\n        public\r\n    {\r\n        _mint(player, tokenId);\r\n    }\r\n```\r\nAnd used that function in the `GameItem.test.js`:\r\n```\r\n    it(\"Minting\", async() => {\r\n        // gameItem.awardItem(accounts[0], \"meta\")\r\n        gameItem.mintWrapper(accounts[0], 1)\r\n        let result = await gameItem.ownerOf(1)\r\n        console.log(result)\r\n    }\r\n```\r\nSo now I control the ID of the token, I specified it to be 1, and yet `gameItem.ownerOf(1)` throws an exception.\r\n## Environment\r\n\r\n- OS: macOS\r\n- Truffle version: v5.4.9\r\n- Solidity version: 0.8.3\r\n- Node.js version: v14.17.1\r\n- web3.js version: v1.5.2\r\n\r\n  [1]: https://docs.openzeppelin.com/contracts/4.x/erc721",
  "closed_by": {
    "login": "ohaponiuk",
    "id": 64164850,
    "node_id": "MDQ6VXNlcjY0MTY0ODUw",
    "avatar_url": "https://avatars.githubusercontent.com/u/64164850?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ohaponiuk",
    "html_url": "https://github.com/ohaponiuk",
    "followers_url": "https://api.github.com/users/ohaponiuk/followers",
    "following_url": "https://api.github.com/users/ohaponiuk/following{/other_user}",
    "gists_url": "https://api.github.com/users/ohaponiuk/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ohaponiuk/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ohaponiuk/subscriptions",
    "organizations_url": "https://api.github.com/users/ohaponiuk/orgs",
    "repos_url": "https://api.github.com/users/ohaponiuk/repos",
    "events_url": "https://api.github.com/users/ohaponiuk/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ohaponiuk/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2867/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2867/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/921445277",
    "html_url": "https://github.com/OpenZeppelin/openzeppelin-contracts/issues/2867#issuecomment-921445277",
    "issue_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2867",
    "id": 921445277,
    "node_id": "IC_kwDOA9tCBs427COd",
    "user": {
      "login": "BitcoinJake09",
      "id": 54378383,
      "node_id": "MDQ6VXNlcjU0Mzc4Mzgz",
      "avatar_url": "https://avatars.githubusercontent.com/u/54378383?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/BitcoinJake09",
      "html_url": "https://github.com/BitcoinJake09",
      "followers_url": "https://api.github.com/users/BitcoinJake09/followers",
      "following_url": "https://api.github.com/users/BitcoinJake09/following{/other_user}",
      "gists_url": "https://api.github.com/users/BitcoinJake09/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/BitcoinJake09/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/BitcoinJake09/subscriptions",
      "organizations_url": "https://api.github.com/users/BitcoinJake09/orgs",
      "repos_url": "https://api.github.com/users/BitcoinJake09/repos",
      "events_url": "https://api.github.com/users/BitcoinJake09/events{/privacy}",
      "received_events_url": "https://api.github.com/users/BitcoinJake09/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-09-17T04:13:40Z",
    "updated_at": "2021-09-17T04:13:40Z",
    "author_association": "NONE",
    "body": "i could be wrong, and you have probably tried, but instead of 1, have you tried 0?\r\nusually in code things are indexed from 0+ so the first and last in a set of 10 is 0-9\r\nhope it helps, if it doesnt sry :p",
    "reactions": {
      "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/921445277/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/921456482",
    "html_url": "https://github.com/OpenZeppelin/openzeppelin-contracts/issues/2867#issuecomment-921456482",
    "issue_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2867",
    "id": 921456482,
    "node_id": "IC_kwDOA9tCBs427E9i",
    "user": {
      "login": "ohaponiuk",
      "id": 64164850,
      "node_id": "MDQ6VXNlcjY0MTY0ODUw",
      "avatar_url": "https://avatars.githubusercontent.com/u/64164850?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ohaponiuk",
      "html_url": "https://github.com/ohaponiuk",
      "followers_url": "https://api.github.com/users/ohaponiuk/followers",
      "following_url": "https://api.github.com/users/ohaponiuk/following{/other_user}",
      "gists_url": "https://api.github.com/users/ohaponiuk/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ohaponiuk/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ohaponiuk/subscriptions",
      "organizations_url": "https://api.github.com/users/ohaponiuk/orgs",
      "repos_url": "https://api.github.com/users/ohaponiuk/repos",
      "events_url": "https://api.github.com/users/ohaponiuk/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ohaponiuk/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-09-17T04:38:38Z",
    "updated_at": "2021-09-17T04:38:38Z",
    "author_association": "NONE",
    "body": "@BitcoinJake09 I tried `0`. In `awardItem` we have `_tokenIds.increment()` before `uint256 newItemId = _tokenIds.current()`, so it starts with `1`.",
    "reactions": {
      "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/921456482/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/921514101",
    "html_url": "https://github.com/OpenZeppelin/openzeppelin-contracts/issues/2867#issuecomment-921514101",
    "issue_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2867",
    "id": 921514101,
    "node_id": "IC_kwDOA9tCBs427TB1",
    "user": {
      "login": "ohaponiuk",
      "id": 64164850,
      "node_id": "MDQ6VXNlcjY0MTY0ODUw",
      "avatar_url": "https://avatars.githubusercontent.com/u/64164850?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ohaponiuk",
      "html_url": "https://github.com/ohaponiuk",
      "followers_url": "https://api.github.com/users/ohaponiuk/followers",
      "following_url": "https://api.github.com/users/ohaponiuk/following{/other_user}",
      "gists_url": "https://api.github.com/users/ohaponiuk/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ohaponiuk/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ohaponiuk/subscriptions",
      "organizations_url": "https://api.github.com/users/ohaponiuk/orgs",
      "repos_url": "https://api.github.com/users/ohaponiuk/repos",
      "events_url": "https://api.github.com/users/ohaponiuk/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ohaponiuk/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-09-17T05:39:39Z",
    "updated_at": "2021-09-17T05:39:39Z",
    "author_association": "NONE",
    "body": "I forgot to run Ganache 😅\r\nThat's it",
    "reactions": {
      "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/921514101/reactions",
      "total_count": 2,
      "+1": 0,
      "-1": 0,
      "laugh": 1,
      "hooray": 1,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/921824672",
    "html_url": "https://github.com/OpenZeppelin/openzeppelin-contracts/issues/2867#issuecomment-921824672",
    "issue_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2867",
    "id": 921824672,
    "node_id": "IC_kwDOA9tCBs428e2g",
    "user": {
      "login": "Amxx",
      "id": 2432299,
      "node_id": "MDQ6VXNlcjI0MzIyOTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2432299?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Amxx",
      "html_url": "https://github.com/Amxx",
      "followers_url": "https://api.github.com/users/Amxx/followers",
      "following_url": "https://api.github.com/users/Amxx/following{/other_user}",
      "gists_url": "https://api.github.com/users/Amxx/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Amxx/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Amxx/subscriptions",
      "organizations_url": "https://api.github.com/users/Amxx/orgs",
      "repos_url": "https://api.github.com/users/Amxx/repos",
      "events_url": "https://api.github.com/users/Amxx/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Amxx/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-09-17T14:05:46Z",
    "updated_at": "2021-09-17T14:05:46Z",
    "author_association": "COLLABORATOR",
    "body": "When you do\r\n```\r\nit(\"Minting\", async() => {\r\n        // gameItem.awardItem(accounts[0], \"meta\")\r\n        gameItem.mintWrapper(accounts[0], 1)\r\n        let result = await gameItem.ownerOf(1)\r\n        console.log(result)\r\n    }\r\n```\r\n\r\nyou are not awaiting the minting ...\r\n... so your ownerOf happens before the minting actually goes through ...",
    "reactions": {
      "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/921824672/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/921969171",
    "html_url": "https://github.com/OpenZeppelin/openzeppelin-contracts/issues/2867#issuecomment-921969171",
    "issue_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2867",
    "id": 921969171,
    "node_id": "IC_kwDOA9tCBs429CIT",
    "user": {
      "login": "ohaponiuk",
      "id": 64164850,
      "node_id": "MDQ6VXNlcjY0MTY0ODUw",
      "avatar_url": "https://avatars.githubusercontent.com/u/64164850?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ohaponiuk",
      "html_url": "https://github.com/ohaponiuk",
      "followers_url": "https://api.github.com/users/ohaponiuk/followers",
      "following_url": "https://api.github.com/users/ohaponiuk/following{/other_user}",
      "gists_url": "https://api.github.com/users/ohaponiuk/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ohaponiuk/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ohaponiuk/subscriptions",
      "organizations_url": "https://api.github.com/users/ohaponiuk/orgs",
      "repos_url": "https://api.github.com/users/ohaponiuk/repos",
      "events_url": "https://api.github.com/users/ohaponiuk/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ohaponiuk/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-09-17T17:39:59Z",
    "updated_at": "2021-09-17T17:39:59Z",
    "author_association": "NONE",
    "body": "@Amxx oh, thank you! So it should be `let mint = await gameItem.awardItem(accounts[0], \"meta\")`? It feels weird to create an unused variable though. Or should I just add `await`, without variable? I'm not used to node.js ",
    "reactions": {
      "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/921969171/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/922007012",
    "html_url": "https://github.com/OpenZeppelin/openzeppelin-contracts/issues/2867#issuecomment-922007012",
    "issue_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2867",
    "id": 922007012,
    "node_id": "IC_kwDOA9tCBs429LXk",
    "user": {
      "login": "Amxx",
      "id": 2432299,
      "node_id": "MDQ6VXNlcjI0MzIyOTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2432299?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Amxx",
      "html_url": "https://github.com/Amxx",
      "followers_url": "https://api.github.com/users/Amxx/followers",
      "following_url": "https://api.github.com/users/Amxx/following{/other_user}",
      "gists_url": "https://api.github.com/users/Amxx/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Amxx/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Amxx/subscriptions",
      "organizations_url": "https://api.github.com/users/Amxx/orgs",
      "repos_url": "https://api.github.com/users/Amxx/repos",
      "events_url": "https://api.github.com/users/Amxx/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Amxx/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-09-17T18:45:55Z",
    "updated_at": "2021-09-17T18:45:55Z",
    "author_association": "COLLABORATOR",
    "body": "You can await without putting the result in a variable ",
    "reactions": {
      "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/922007012/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
