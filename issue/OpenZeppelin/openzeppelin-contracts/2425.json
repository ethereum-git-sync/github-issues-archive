{
  "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2425",
  "repository_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts",
  "labels_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2425/labels{/name}",
  "comments_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2425/comments",
  "events_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2425/events",
  "html_url": "https://github.com/OpenZeppelin/openzeppelin-contracts/issues/2425",
  "id": 757128056,
  "node_id": "MDU6SXNzdWU3NTcxMjgwNTY=",
  "number": 2425,
  "title": "Revert messages are not bubbled in proxy constructors",
  "user": {
    "login": "ppoliani",
    "id": 1389619,
    "node_id": "MDQ6VXNlcjEzODk2MTk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1389619?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ppoliani",
    "html_url": "https://github.com/ppoliani",
    "followers_url": "https://api.github.com/users/ppoliani/followers",
    "following_url": "https://api.github.com/users/ppoliani/following{/other_user}",
    "gists_url": "https://api.github.com/users/ppoliani/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ppoliani/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ppoliani/subscriptions",
    "organizations_url": "https://api.github.com/users/ppoliani/orgs",
    "repos_url": "https://api.github.com/users/ppoliani/repos",
    "events_url": "https://api.github.com/users/ppoliani/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ppoliani/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2020-12-03T16:31:04Z",
  "updated_at": "2021-01-07T16:06:03Z",
  "closed_at": "2021-01-07T16:06:03Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "I'm trying to write some tests to check if some of the user inputs are correct. More specifically I've got the following code in my smart contract function. The code is part of the initialize function.\r\n\r\n```\r\ncontract ContractA is Initializable {\r\n  function initialize(IERC20 token) public initializer {\r\n      require(\r\n      address(token) != address(0), \r\n      \"Invalid erc20 address provided\"\r\n    );\r\n  }\r\n} \r\n\r\n```\r\n\r\nI have written a test that checks if the correct message is thrown when a 0x address is passed. I used the helper\r\n\r\n```\r\n\r\nconst deployContract = async  () => {\r\n  const token = await ERC20.new('TokenA', 'TokenA')\r\n  const opts = {\r\n    unsafeAllowLinkedLibraries: true\r\n   }\r\n\r\nreturn await deployProxy(\r\n    ContractA, \r\n    [token],\r\n    opts\r\n  )\r\n}\r\n\r\nconst {constants, expectRevert} = require('@openzeppelin/test-helpers');\r\n\r\nit('should revert', async () => {\r\n    await expectRevert(\r\n      deployContract(constants.ZERO_ADDRESS, validatorRegistry.address),\r\n      'Invalid erc20 address provided',\r\n    );\r\n}) \r\n\r\n```\r\n\r\nNow when I run this it revert, however the error I get doesn't include the message defined in the require() section. Instead I get the default message `-revert`\r\n\r\n```\r\n     Wrong kind of exception received\r\n      + expected - actual\r\n\r\n      -revert\r\n      +Invalid erc20 address provided\r\n```\r\n\r\nNow if I deploy the contract user `.new` function and manually invoking the initialize function then I get the correct message.\r\n\r\n```\r\nconst deployContract = async  () => {\r\n  const token = await ERC20.new('TokenA', 'TokenA')\r\n  const contract =  await ContractA.new()\r\n  await contract.initialize(token)\r\n}\r\n```\r\n\r\nI'm using:\r\n\r\n- @openzeppelin/truffle-upgrades: 1.3.0\r\n- @openzeppelin/test-helpers\": \"^0.5.9\"\r\n- \"ganache-cli\": \"^6.12.1\"\r\n- \"truffle\": \"^5.1.55\"\r\n",
  "closed_by": {
    "login": "frangio",
    "id": 481465,
    "node_id": "MDQ6VXNlcjQ4MTQ2NQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/481465?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/frangio",
    "html_url": "https://github.com/frangio",
    "followers_url": "https://api.github.com/users/frangio/followers",
    "following_url": "https://api.github.com/users/frangio/following{/other_user}",
    "gists_url": "https://api.github.com/users/frangio/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/frangio/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/frangio/subscriptions",
    "organizations_url": "https://api.github.com/users/frangio/orgs",
    "repos_url": "https://api.github.com/users/frangio/repos",
    "events_url": "https://api.github.com/users/frangio/events{/privacy}",
    "received_events_url": "https://api.github.com/users/frangio/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2425/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2425/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/738134741",
    "html_url": "https://github.com/OpenZeppelin/openzeppelin-contracts/issues/2425#issuecomment-738134741",
    "issue_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2425",
    "id": 738134741,
    "node_id": "MDEyOklzc3VlQ29tbWVudDczODEzNDc0MQ==",
    "user": {
      "login": "ppoliani",
      "id": 1389619,
      "node_id": "MDQ6VXNlcjEzODk2MTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1389619?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ppoliani",
      "html_url": "https://github.com/ppoliani",
      "followers_url": "https://api.github.com/users/ppoliani/followers",
      "following_url": "https://api.github.com/users/ppoliani/following{/other_user}",
      "gists_url": "https://api.github.com/users/ppoliani/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ppoliani/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ppoliani/subscriptions",
      "organizations_url": "https://api.github.com/users/ppoliani/orgs",
      "repos_url": "https://api.github.com/users/ppoliani/repos",
      "events_url": "https://api.github.com/users/ppoliani/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ppoliani/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-12-03T16:52:54Z",
    "updated_at": "2020-12-03T16:52:54Z",
    "author_association": "NONE",
    "body": "Looking into the source code I stumdled across this \r\n\r\n```\r\ncontract UpgradeabilityProxy is Proxy {\r\n  constructor(address _logic, bytes memory _data) public payable {\r\n     assert(IMPLEMENTATION_SLOT == bytes32(uint256(keccak256('eip1967.proxy.implementation')) - 1));\r\n     _setImplementation(_logic);\r\n      if(_data.length > 0) {\r\n        (bool success,) = _logic.delegatecall(_data);\r\n        require(success);\r\n      }\r\n  }  \r\n...\r\n}\r\n```\r\nIs it because of the `(bool success,) = _logic.delegatecall(_data);` which presumably doesn't  bubble up exceptions? ",
    "reactions": {
      "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/738134741/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/738802234",
    "html_url": "https://github.com/OpenZeppelin/openzeppelin-contracts/issues/2425#issuecomment-738802234",
    "issue_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2425",
    "id": 738802234,
    "node_id": "MDEyOklzc3VlQ29tbWVudDczODgwMjIzNA==",
    "user": {
      "login": "frangio",
      "id": 481465,
      "node_id": "MDQ6VXNlcjQ4MTQ2NQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/481465?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/frangio",
      "html_url": "https://github.com/frangio",
      "followers_url": "https://api.github.com/users/frangio/followers",
      "following_url": "https://api.github.com/users/frangio/following{/other_user}",
      "gists_url": "https://api.github.com/users/frangio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/frangio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/frangio/subscriptions",
      "organizations_url": "https://api.github.com/users/frangio/orgs",
      "repos_url": "https://api.github.com/users/frangio/repos",
      "events_url": "https://api.github.com/users/frangio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/frangio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-12-04T14:06:04Z",
    "updated_at": "2020-12-04T15:27:33Z",
    "author_association": "MEMBER",
    "body": "Thanks for reporting! Yes, it seems that we're not bubbling the revert reason in the constructor! (It is bubbled in the fallback function.) Unfortunately I don't think there's a workaround for you to be able to write the tests you want.\r\n\r\nI'm going to move this issue to our OpenZeppelin Contracts repo where proxies are hosted. We should fix it over there. We have to update the Upgrades Plugins to use those (see OpenZeppelin/openzeppelin-upgrades#164).",
    "reactions": {
      "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/738802234/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/756210237",
    "html_url": "https://github.com/OpenZeppelin/openzeppelin-contracts/issues/2425#issuecomment-756210237",
    "issue_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2425",
    "id": 756210237,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc1NjIxMDIzNw==",
    "user": {
      "login": "frangio",
      "id": 481465,
      "node_id": "MDQ6VXNlcjQ4MTQ2NQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/481465?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/frangio",
      "html_url": "https://github.com/frangio",
      "followers_url": "https://api.github.com/users/frangio/followers",
      "following_url": "https://api.github.com/users/frangio/following{/other_user}",
      "gists_url": "https://api.github.com/users/frangio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/frangio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/frangio/subscriptions",
      "organizations_url": "https://api.github.com/users/frangio/orgs",
      "repos_url": "https://api.github.com/users/frangio/repos",
      "events_url": "https://api.github.com/users/frangio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/frangio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-01-07T16:06:02Z",
    "updated_at": "2021-01-07T16:06:02Z",
    "author_association": "MEMBER",
    "body": "Fixed by #2454.",
    "reactions": {
      "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/756210237/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
