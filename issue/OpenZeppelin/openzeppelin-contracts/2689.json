{
  "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2689",
  "repository_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts",
  "labels_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2689/labels{/name}",
  "comments_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2689/comments",
  "events_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2689/events",
  "html_url": "https://github.com/OpenZeppelin/openzeppelin-contracts/issues/2689",
  "id": 899113566,
  "node_id": "MDU6SXNzdWU4OTkxMTM1NjY=",
  "number": 2689,
  "title": "The `Clones` contract could be further optimized to reduce the cost of cloning",
  "user": {
    "login": "CallMeGwei",
    "id": 34364155,
    "node_id": "MDQ6VXNlcjM0MzY0MTU1",
    "avatar_url": "https://avatars.githubusercontent.com/u/34364155?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/CallMeGwei",
    "html_url": "https://github.com/CallMeGwei",
    "followers_url": "https://api.github.com/users/CallMeGwei/followers",
    "following_url": "https://api.github.com/users/CallMeGwei/following{/other_user}",
    "gists_url": "https://api.github.com/users/CallMeGwei/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/CallMeGwei/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/CallMeGwei/subscriptions",
    "organizations_url": "https://api.github.com/users/CallMeGwei/orgs",
    "repos_url": "https://api.github.com/users/CallMeGwei/repos",
    "events_url": "https://api.github.com/users/CallMeGwei/events{/privacy}",
    "received_events_url": "https://api.github.com/users/CallMeGwei/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2021-05-23T21:30:23Z",
  "updated_at": "2021-06-08T07:46:19Z",
  "closed_at": "2021-06-08T07:46:19Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "body": "**üßê Motivation**\r\n\r\nWhile inspecting the OpenZeppelin `Clones` contract, I noticed that the deployment portion of the bytecode seemed like it could be further optimized. Looking to see if this had been discussed elsewhere, I ran across an [OpenZeppelin article](https://blog.openzeppelin.com/deep-dive-into-the-minimal-proxy-contract/) that took note of the same possibility for optimization!\r\n\r\nIt seems possible to drop 1 byte from this portion of the bytecode.\r\n\r\n**üìù Details**\r\nIn the `clone` function of the `Clone` contract there is this block of assembly:\r\n\r\n```\r\nlet ptr := mload(0x40)\r\nmstore(ptr, 0x3d602d80600a3d3981f3363d3d373d3d3d363d73000000000000000000000000)\r\nmstore(add(ptr, 0x14), shl(0x60, master))\r\nmstore(add(ptr, 0x28), 0x5af43d82803e903d91602b57fd5bf30000000000000000000000000000000000)\r\ninstance := create(0, ptr, 0x37)\r\n```\r\n\r\nThe bytes that are responsible for getting our `clone` runtime code onto the blockchain are here:\r\n\r\n```\r\n0x3d602d80600a3d3981f3\r\n```\r\n\r\nThis sequence starts by using a `RETURNDATASIZE` to push a `0` onto the stack (3d), so that we can duplicate it (81) later, just before the return (f3). However, by the end of sequence, we have this left over `0` on the stack. If we removed the initial `RETURNDATASIZE` and, instead, just used it later in place of the DUP2 -- we could save a byte. Users would realize the resultant gas savings with every single clone operation.\r\n\r\nSince we're shifting things left by one byte from the start, we need to shift many of the relevant pointers by one byte later in the code.\r\n\r\nThe optimized, functional assembly block would now look like:\r\n\r\n```\r\nlet ptr := mload(0x40)\r\nmstore(ptr, 0x602d8060093d393df3363d3d373d3d3d363d7300000000000000000000000000)\r\nmstore(add(ptr, 0x13), shl(0x60, master))\r\nmstore(add(ptr, 0x27), 0x5af43d82803e903d91602b57fd5bf30000000000000000000000000000000000)\r\ninstance := create(0, ptr, 0x36)\r\n```\r\n\r\nAnd, of course, analogous changes need to be made to the other functions to keep the entire library on the same page.\r\n\r\nUnless there is something I am overlooking that would make us prefer the current implementation - I can submit a PR for this. Is there any reason not to implement this? ",
  "closed_by": {
    "login": "Amxx",
    "id": 2432299,
    "node_id": "MDQ6VXNlcjI0MzIyOTk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2432299?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Amxx",
    "html_url": "https://github.com/Amxx",
    "followers_url": "https://api.github.com/users/Amxx/followers",
    "following_url": "https://api.github.com/users/Amxx/following{/other_user}",
    "gists_url": "https://api.github.com/users/Amxx/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Amxx/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Amxx/subscriptions",
    "organizations_url": "https://api.github.com/users/Amxx/orgs",
    "repos_url": "https://api.github.com/users/Amxx/repos",
    "events_url": "https://api.github.com/users/Amxx/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Amxx/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2689/reactions",
    "total_count": 2,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 2,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2689/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/846873918",
    "html_url": "https://github.com/OpenZeppelin/openzeppelin-contracts/issues/2689#issuecomment-846873918",
    "issue_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2689",
    "id": 846873918,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg0Njg3MzkxOA==",
    "user": {
      "login": "Amxx",
      "id": 2432299,
      "node_id": "MDQ6VXNlcjI0MzIyOTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2432299?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Amxx",
      "html_url": "https://github.com/Amxx",
      "followers_url": "https://api.github.com/users/Amxx/followers",
      "following_url": "https://api.github.com/users/Amxx/following{/other_user}",
      "gists_url": "https://api.github.com/users/Amxx/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Amxx/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Amxx/subscriptions",
      "organizations_url": "https://api.github.com/users/Amxx/orgs",
      "repos_url": "https://api.github.com/users/Amxx/repos",
      "events_url": "https://api.github.com/users/Amxx/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Amxx/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-05-24T08:25:41Z",
    "updated_at": "2021-05-24T08:25:41Z",
    "author_association": "COLLABORATOR",
    "body": "Hello @CallMeGwei and thanks for posting this great issue.\r\n\r\nWe will review your findings are consider further improving the library!",
    "reactions": {
      "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/846873918/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/848831219",
    "html_url": "https://github.com/OpenZeppelin/openzeppelin-contracts/issues/2689#issuecomment-848831219",
    "issue_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2689",
    "id": 848831219,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg0ODgzMTIxOQ==",
    "user": {
      "login": "frangio",
      "id": 481465,
      "node_id": "MDQ6VXNlcjQ4MTQ2NQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/481465?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/frangio",
      "html_url": "https://github.com/frangio",
      "followers_url": "https://api.github.com/users/frangio/followers",
      "following_url": "https://api.github.com/users/frangio/following{/other_user}",
      "gists_url": "https://api.github.com/users/frangio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/frangio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/frangio/subscriptions",
      "organizations_url": "https://api.github.com/users/frangio/orgs",
      "repos_url": "https://api.github.com/users/frangio/repos",
      "events_url": "https://api.github.com/users/frangio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/frangio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-05-26T14:45:51Z",
    "updated_at": "2021-05-26T14:45:51Z",
    "author_association": "MEMBER",
    "body": "If this doesn't affect the bytecode for created clones, please submit the PR!",
    "reactions": {
      "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/848831219/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/856540024",
    "html_url": "https://github.com/OpenZeppelin/openzeppelin-contracts/issues/2689#issuecomment-856540024",
    "issue_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2689",
    "id": 856540024,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg1NjU0MDAyNA==",
    "user": {
      "login": "Amxx",
      "id": 2432299,
      "node_id": "MDQ6VXNlcjI0MzIyOTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2432299?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Amxx",
      "html_url": "https://github.com/Amxx",
      "followers_url": "https://api.github.com/users/Amxx/followers",
      "following_url": "https://api.github.com/users/Amxx/following{/other_user}",
      "gists_url": "https://api.github.com/users/Amxx/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Amxx/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Amxx/subscriptions",
      "organizations_url": "https://api.github.com/users/Amxx/orgs",
      "repos_url": "https://api.github.com/users/Amxx/repos",
      "events_url": "https://api.github.com/users/Amxx/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Amxx/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-06-08T07:46:19Z",
    "updated_at": "2021-06-08T07:46:19Z",
    "author_association": "COLLABORATOR",
    "body": "Closing: see PR",
    "reactions": {
      "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/856540024/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
