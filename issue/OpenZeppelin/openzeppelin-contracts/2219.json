{
  "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2219",
  "repository_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts",
  "labels_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2219/labels{/name}",
  "comments_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2219/comments",
  "events_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2219/events",
  "html_url": "https://github.com/OpenZeppelin/openzeppelin-contracts/issues/2219",
  "id": 609385789,
  "node_id": "MDU6SXNzdWU2MDkzODU3ODk=",
  "number": 2219,
  "title": "SafeERC20.safeApprove() Has unnecessary and unsecure added behavior",
  "user": {
    "login": "BrendanChou",
    "id": 3680392,
    "node_id": "MDQ6VXNlcjM2ODAzOTI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3680392?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/BrendanChou",
    "html_url": "https://github.com/BrendanChou",
    "followers_url": "https://api.github.com/users/BrendanChou/followers",
    "following_url": "https://api.github.com/users/BrendanChou/following{/other_user}",
    "gists_url": "https://api.github.com/users/BrendanChou/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/BrendanChou/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/BrendanChou/subscriptions",
    "organizations_url": "https://api.github.com/users/BrendanChou/orgs",
    "repos_url": "https://api.github.com/users/BrendanChou/repos",
    "events_url": "https://api.github.com/users/BrendanChou/events{/privacy}",
    "received_events_url": "https://api.github.com/users/BrendanChou/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2020-04-29T21:55:36Z",
  "updated_at": "2020-06-05T17:13:54Z",
  "closed_at": "2020-06-05T17:13:54Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "SafeERC20.safeApprove() should not have the added functionality of checking the existing allowance of the token. It should simply call `token.approve()`.\r\n\r\nThe purpose of this added code is to check that a user is either setting their allowance to zero, or setting it from zero. This is so that the user doesn't try to re-set their allowance from one non-zero number to another non-zero number where they can get front-run by the approved address using their allowance in-between those two transactions. However, this code doesn't actually solve the problem as the approval will still pass if the sandwich attack uses the rest of the remaining allowance.\r\n\r\nSuch behavior lends itself to bugs, unnecessary gas usage, and a false sense of security. In addition, there is no provided method in SafeERC20 that replicates the behavior of `approve` for tokens that are not ERC20 compliant, making this problem even more frustrating.\r\n\r\nSafeERC20 already has `safeIncreaseAllowance` and `safeDecreaseAllowance` to solve this problem. Neither of which can be front-run.\r\n\r\nLastly, this allowance issue should not even be solved within this file. The intention of this file should solely be to wrap non-compliant ERC20 functions which was the original intention of this file.\r\n\r\n```\r\n * @dev Wrappers around ERC20 operations that throw on failure (when the token\r\n * contract returns false). Tokens that return no value (and instead revert or\r\n * throw on failure) are also supported, non-reverting calls are assumed to be\r\n * successful.\r\n```",
  "closed_by": {
    "login": "nventuro",
    "id": 2530770,
    "node_id": "MDQ6VXNlcjI1MzA3NzA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2530770?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/nventuro",
    "html_url": "https://github.com/nventuro",
    "followers_url": "https://api.github.com/users/nventuro/followers",
    "following_url": "https://api.github.com/users/nventuro/following{/other_user}",
    "gists_url": "https://api.github.com/users/nventuro/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/nventuro/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/nventuro/subscriptions",
    "organizations_url": "https://api.github.com/users/nventuro/orgs",
    "repos_url": "https://api.github.com/users/nventuro/repos",
    "events_url": "https://api.github.com/users/nventuro/events{/privacy}",
    "received_events_url": "https://api.github.com/users/nventuro/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2219/reactions",
    "total_count": 5,
    "+1": 5,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2219/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/621568759",
    "html_url": "https://github.com/OpenZeppelin/openzeppelin-contracts/issues/2219#issuecomment-621568759",
    "issue_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2219",
    "id": 621568759,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyMTU2ODc1OQ==",
    "user": {
      "login": "abcoathup",
      "id": 28278242,
      "node_id": "MDQ6VXNlcjI4Mjc4MjQy",
      "avatar_url": "https://avatars.githubusercontent.com/u/28278242?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/abcoathup",
      "html_url": "https://github.com/abcoathup",
      "followers_url": "https://api.github.com/users/abcoathup/followers",
      "following_url": "https://api.github.com/users/abcoathup/following{/other_user}",
      "gists_url": "https://api.github.com/users/abcoathup/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/abcoathup/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/abcoathup/subscriptions",
      "organizations_url": "https://api.github.com/users/abcoathup/orgs",
      "repos_url": "https://api.github.com/users/abcoathup/repos",
      "events_url": "https://api.github.com/users/abcoathup/events{/privacy}",
      "received_events_url": "https://api.github.com/users/abcoathup/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-04-30T02:05:14Z",
    "updated_at": "2020-04-30T02:05:14Z",
    "author_association": "CONTRIBUTOR",
    "body": "Hi @BrendanChou!  Thanks for the suggestion, it is really appreciated.\r\n\r\nThe project owner should review your suggestion during the next week. ",
    "reactions": {
      "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/621568759/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/621569646",
    "html_url": "https://github.com/OpenZeppelin/openzeppelin-contracts/issues/2219#issuecomment-621569646",
    "issue_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2219",
    "id": 621569646,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyMTU2OTY0Ng==",
    "user": {
      "login": "BrendanChou",
      "id": 3680392,
      "node_id": "MDQ6VXNlcjM2ODAzOTI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3680392?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/BrendanChou",
      "html_url": "https://github.com/BrendanChou",
      "followers_url": "https://api.github.com/users/BrendanChou/followers",
      "following_url": "https://api.github.com/users/BrendanChou/following{/other_user}",
      "gists_url": "https://api.github.com/users/BrendanChou/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/BrendanChou/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/BrendanChou/subscriptions",
      "organizations_url": "https://api.github.com/users/BrendanChou/orgs",
      "repos_url": "https://api.github.com/users/BrendanChou/repos",
      "events_url": "https://api.github.com/users/BrendanChou/events{/privacy}",
      "received_events_url": "https://api.github.com/users/BrendanChou/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-04-30T02:08:20Z",
    "updated_at": "2020-04-30T02:08:20Z",
    "author_association": "CONTRIBUTOR",
    "body": "Thanks. Another possibility (if you don't want breaking changes) is to add another function to call approve in a \"safe\" manner without all the extra code.",
    "reactions": {
      "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/621569646/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/621570836",
    "html_url": "https://github.com/OpenZeppelin/openzeppelin-contracts/issues/2219#issuecomment-621570836",
    "issue_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2219",
    "id": 621570836,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyMTU3MDgzNg==",
    "user": {
      "login": "BrendanChou",
      "id": 3680392,
      "node_id": "MDQ6VXNlcjM2ODAzOTI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3680392?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/BrendanChou",
      "html_url": "https://github.com/BrendanChou",
      "followers_url": "https://api.github.com/users/BrendanChou/followers",
      "following_url": "https://api.github.com/users/BrendanChou/following{/other_user}",
      "gists_url": "https://api.github.com/users/BrendanChou/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/BrendanChou/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/BrendanChou/subscriptions",
      "organizations_url": "https://api.github.com/users/BrendanChou/orgs",
      "repos_url": "https://api.github.com/users/BrendanChou/repos",
      "events_url": "https://api.github.com/users/BrendanChou/events{/privacy}",
      "received_events_url": "https://api.github.com/users/BrendanChou/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-04-30T02:12:21Z",
    "updated_at": "2020-04-30T02:12:21Z",
    "author_association": "CONTRIBUTOR",
    "body": "The reason this code is so bug-prone is because this behavior is not natively present when calling approve() and can therefore easily create unintended reverts that lock funds in smart contracts that use this code. Based on the documentation in the readmes and at the top of the file, one would assume that it is doing a safer, more-compatible version of the approve call (when it is in fact doing a more-restrictive version of the function-call)",
    "reactions": {
      "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/621570836/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/622163352",
    "html_url": "https://github.com/OpenZeppelin/openzeppelin-contracts/issues/2219#issuecomment-622163352",
    "issue_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2219",
    "id": 622163352,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyMjE2MzM1Mg==",
    "user": {
      "login": "frangio",
      "id": 481465,
      "node_id": "MDQ6VXNlcjQ4MTQ2NQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/481465?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/frangio",
      "html_url": "https://github.com/frangio",
      "followers_url": "https://api.github.com/users/frangio/followers",
      "following_url": "https://api.github.com/users/frangio/following{/other_user}",
      "gists_url": "https://api.github.com/users/frangio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/frangio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/frangio/subscriptions",
      "organizations_url": "https://api.github.com/users/frangio/orgs",
      "repos_url": "https://api.github.com/users/frangio/repos",
      "events_url": "https://api.github.com/users/frangio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/frangio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-04-30T23:00:48Z",
    "updated_at": "2020-04-30T23:00:48Z",
    "author_association": "MEMBER",
    "body": "Thanks for the detailed report @BrendanChou. Unfortunately \"safe\" is not a precise term but it has stuck. In this case it has lead to a deviation from the original purpose as you point out.\r\n\r\nI wouldn't say that the library should be strictly restricted to wrapping non-compliant tokens, because I think `safeIncreaseAllowance` and `safeDecreaseAllowance` are also valuable. But I do agree that the checks in `safeApprove` are out of place. FWIW, @nventuro mentions that even in the scenario that you describe the gas estimation would fail for the end user attempting to send the transaction if the allowance is not already zero at that moment, which mitigates the problem and could be seen as an improvement over plain `approve`.\r\n\r\nThat's not enough, though, and I agree that use of `safeApprove` as it is now should be discourgaed. Unfortunately it's a breaking change to remove it, but we can deprecate it and place a warning in the documentation. We're not sure that adding an additional function that only does the wrapping is a good idea, given that `approve` is discouraged and the increment/decrement functions seem to be a good alternative. Is using those functions acceptable in your case?",
    "reactions": {
      "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/622163352/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
