{
  "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2030",
  "repository_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts",
  "labels_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2030/labels{/name}",
  "comments_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2030/comments",
  "events_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2030/events",
  "html_url": "https://github.com/OpenZeppelin/openzeppelin-contracts/issues/2030",
  "id": 541593931,
  "node_id": "MDU6SXNzdWU1NDE1OTM5MzE=",
  "number": 2030,
  "title": "In transferFrom, should allowance be called before transfer?",
  "user": {
    "login": "mikephul",
    "id": 2575012,
    "node_id": "MDQ6VXNlcjI1NzUwMTI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2575012?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mikephul",
    "html_url": "https://github.com/mikephul",
    "followers_url": "https://api.github.com/users/mikephul/followers",
    "following_url": "https://api.github.com/users/mikephul/following{/other_user}",
    "gists_url": "https://api.github.com/users/mikephul/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mikephul/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mikephul/subscriptions",
    "organizations_url": "https://api.github.com/users/mikephul/orgs",
    "repos_url": "https://api.github.com/users/mikephul/repos",
    "events_url": "https://api.github.com/users/mikephul/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mikephul/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1000190804,
      "node_id": "MDU6TGFiZWwxMDAwMTkwODA0",
      "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/labels/documentation",
      "name": "documentation",
      "color": "1d76db",
      "default": true,
      "description": "Inline comments, guides, and examples."
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 7,
  "created_at": "2019-12-23T06:11:03Z",
  "updated_at": "2020-02-11T15:32:21Z",
  "closed_at": "2020-02-11T15:32:20Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "Sorry, this is more of the question rather than a feature request or bug report. üôè\r\n\r\nReferring to this commit https://github.com/OpenZeppelin/openzeppelin-contracts/commit/3a5da758767cfbcf256bdd147c56dbb0a2541569#diff-6202e31fca333ecfb19d878145bc8db5\r\n\r\nThe `_allowed` method is moved to be after `_transfer`. What is the rationale behind that @nventuro? (The allowance used to be reduced before doing the transfer.)\r\n![image](https://user-images.githubusercontent.com/2575012/71337706-51b34980-257f-11ea-8f1b-88401ea3fd0d.png)\r\n\r\nShould possible further actions that depend on allowance be checked by deducting the allowance first before committing to the actions? ",
  "closed_by": {
    "login": "nventuro",
    "id": 2530770,
    "node_id": "MDQ6VXNlcjI1MzA3NzA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2530770?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/nventuro",
    "html_url": "https://github.com/nventuro",
    "followers_url": "https://api.github.com/users/nventuro/followers",
    "following_url": "https://api.github.com/users/nventuro/following{/other_user}",
    "gists_url": "https://api.github.com/users/nventuro/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/nventuro/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/nventuro/subscriptions",
    "organizations_url": "https://api.github.com/users/nventuro/orgs",
    "repos_url": "https://api.github.com/users/nventuro/repos",
    "events_url": "https://api.github.com/users/nventuro/events{/privacy}",
    "received_events_url": "https://api.github.com/users/nventuro/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2030/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2030/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/568487500",
    "html_url": "https://github.com/OpenZeppelin/openzeppelin-contracts/issues/2030#issuecomment-568487500",
    "issue_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2030",
    "id": 568487500,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU2ODQ4NzUwMA==",
    "user": {
      "login": "nventuro",
      "id": 2530770,
      "node_id": "MDQ6VXNlcjI1MzA3NzA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2530770?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nventuro",
      "html_url": "https://github.com/nventuro",
      "followers_url": "https://api.github.com/users/nventuro/followers",
      "following_url": "https://api.github.com/users/nventuro/following{/other_user}",
      "gists_url": "https://api.github.com/users/nventuro/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nventuro/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nventuro/subscriptions",
      "organizations_url": "https://api.github.com/users/nventuro/orgs",
      "repos_url": "https://api.github.com/users/nventuro/repos",
      "events_url": "https://api.github.com/users/nventuro/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nventuro/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-12-23T14:18:19Z",
    "updated_at": "2019-12-23T14:18:19Z",
    "author_association": "CONTRIBUTOR",
    "body": "Hm, interesting. Thanks for opening this @mikephul!\r\n\r\nIn the case of `ERC20`, the order is irrelevant because `_transfer` and `_approve` are independent and never call any other contract: they are executed atomically.\r\n\r\n_However_, this is very relevant for users that intent to override `_transfer` or `_approve` with their own implementations: we should be clear about the order in which these things happen. cc @frangio ",
    "reactions": {
      "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/568487500/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/584256314",
    "html_url": "https://github.com/OpenZeppelin/openzeppelin-contracts/issues/2030#issuecomment-584256314",
    "issue_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2030",
    "id": 584256314,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU4NDI1NjMxNA==",
    "user": {
      "login": "decentralMind",
      "id": 48255951,
      "node_id": "MDQ6VXNlcjQ4MjU1OTUx",
      "avatar_url": "https://avatars.githubusercontent.com/u/48255951?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/decentralMind",
      "html_url": "https://github.com/decentralMind",
      "followers_url": "https://api.github.com/users/decentralMind/followers",
      "following_url": "https://api.github.com/users/decentralMind/following{/other_user}",
      "gists_url": "https://api.github.com/users/decentralMind/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/decentralMind/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/decentralMind/subscriptions",
      "organizations_url": "https://api.github.com/users/decentralMind/orgs",
      "repos_url": "https://api.github.com/users/decentralMind/repos",
      "events_url": "https://api.github.com/users/decentralMind/events{/privacy}",
      "received_events_url": "https://api.github.com/users/decentralMind/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-02-10T18:10:22Z",
    "updated_at": "2020-02-10T18:10:22Z",
    "author_association": "NONE",
    "body": "Also calling _allowed method after _transfer uses more gas.\r\n\r\nAlso, similar issue with _burnFrom method.",
    "reactions": {
      "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/584256314/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/584257656",
    "html_url": "https://github.com/OpenZeppelin/openzeppelin-contracts/issues/2030#issuecomment-584257656",
    "issue_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2030",
    "id": 584257656,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU4NDI1NzY1Ng==",
    "user": {
      "login": "nventuro",
      "id": 2530770,
      "node_id": "MDQ6VXNlcjI1MzA3NzA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2530770?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nventuro",
      "html_url": "https://github.com/nventuro",
      "followers_url": "https://api.github.com/users/nventuro/followers",
      "following_url": "https://api.github.com/users/nventuro/following{/other_user}",
      "gists_url": "https://api.github.com/users/nventuro/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nventuro/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nventuro/subscriptions",
      "organizations_url": "https://api.github.com/users/nventuro/orgs",
      "repos_url": "https://api.github.com/users/nventuro/repos",
      "events_url": "https://api.github.com/users/nventuro/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nventuro/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-02-10T18:13:37Z",
    "updated_at": "2020-02-10T18:13:37Z",
    "author_association": "CONTRIBUTOR",
    "body": ">Also calling _allowed method after _transfer uses more gas.\r\n\r\nCould you expand a bit on this point? Have you performed gas measurements with both orderings?",
    "reactions": {
      "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/584257656/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/584288351",
    "html_url": "https://github.com/OpenZeppelin/openzeppelin-contracts/issues/2030#issuecomment-584288351",
    "issue_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2030",
    "id": 584288351,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU4NDI4ODM1MQ==",
    "user": {
      "login": "decentralMind",
      "id": 48255951,
      "node_id": "MDQ6VXNlcjQ4MjU1OTUx",
      "avatar_url": "https://avatars.githubusercontent.com/u/48255951?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/decentralMind",
      "html_url": "https://github.com/decentralMind",
      "followers_url": "https://api.github.com/users/decentralMind/followers",
      "following_url": "https://api.github.com/users/decentralMind/following{/other_user}",
      "gists_url": "https://api.github.com/users/decentralMind/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/decentralMind/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/decentralMind/subscriptions",
      "organizations_url": "https://api.github.com/users/decentralMind/orgs",
      "repos_url": "https://api.github.com/users/decentralMind/repos",
      "events_url": "https://api.github.com/users/decentralMind/events{/privacy}",
      "received_events_url": "https://api.github.com/users/decentralMind/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-02-10T18:42:55Z",
    "updated_at": "2020-02-11T07:18:43Z",
    "author_association": "NONE",
    "body": "> Could you expand a bit on this point? Have you performed gas measurements with both orderings?\r\n\r\nI tested with following simple code.\r\n\r\n```\r\npragma solidity ^0.5.0;\r\n\r\nimport \"./SafeMath.sol\";\r\n\r\ncontract Check {\r\n    using SafeMath for uint256;\r\n\r\n    uint public num = 2;\r\n    \r\n    /**Trying to assign 1 to num\r\n      *both should fail and revert\r\n    **/\r\n\r\n     function afterNum() public returns(bool) {\r\n        num = 1;\r\n        num.sub(3, \"error\");\r\n        return true;\r\n    }\r\n    \r\n    function beforeNum() public returns(bool) {\r\n        num.sub(3, \"error\");\r\n        num = 1;\r\n        return true;\r\n    }\r\n}\r\n```\r\nTested on Rinkeby network.\r\n\r\nGas used by afterNum method is 27,543.\r\nhttps://rinkeby.etherscan.io/tx/0x0a23d37ef6ca6fcae31a4b70e22d19f795f0d1c8f1930a4c49c0d77007b1f576\r\n\r\nGas used by beforeNum method is 27,573. \r\nhttps://rinkeby.etherscan.io/tx/0x3da277c8661432d2e21a2ae417855fb47414b685abb330f2eb232169ca119fc5\r\n\r\nDifference is not that much, but still uses little higher gas.\r\n\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/584288351/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/584299591",
    "html_url": "https://github.com/OpenZeppelin/openzeppelin-contracts/issues/2030#issuecomment-584299591",
    "issue_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2030",
    "id": 584299591,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU4NDI5OTU5MQ==",
    "user": {
      "login": "decentralMind",
      "id": 48255951,
      "node_id": "MDQ6VXNlcjQ4MjU1OTUx",
      "avatar_url": "https://avatars.githubusercontent.com/u/48255951?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/decentralMind",
      "html_url": "https://github.com/decentralMind",
      "followers_url": "https://api.github.com/users/decentralMind/followers",
      "following_url": "https://api.github.com/users/decentralMind/following{/other_user}",
      "gists_url": "https://api.github.com/users/decentralMind/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/decentralMind/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/decentralMind/subscriptions",
      "organizations_url": "https://api.github.com/users/decentralMind/orgs",
      "repos_url": "https://api.github.com/users/decentralMind/repos",
      "events_url": "https://api.github.com/users/decentralMind/events{/privacy}",
      "received_events_url": "https://api.github.com/users/decentralMind/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-02-10T19:08:18Z",
    "updated_at": "2020-02-10T19:08:18Z",
    "author_association": "NONE",
    "body": "> Could you expand a bit on this point? Have you performed gas measurements with both orderings?\r\n\r\nPlease check the updated code, previously I posted the wrong one.",
    "reactions": {
      "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/584299591/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/584504616",
    "html_url": "https://github.com/OpenZeppelin/openzeppelin-contracts/issues/2030#issuecomment-584504616",
    "issue_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2030",
    "id": 584504616,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU4NDUwNDYxNg==",
    "user": {
      "login": "decentralMind",
      "id": 48255951,
      "node_id": "MDQ6VXNlcjQ4MjU1OTUx",
      "avatar_url": "https://avatars.githubusercontent.com/u/48255951?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/decentralMind",
      "html_url": "https://github.com/decentralMind",
      "followers_url": "https://api.github.com/users/decentralMind/followers",
      "following_url": "https://api.github.com/users/decentralMind/following{/other_user}",
      "gists_url": "https://api.github.com/users/decentralMind/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/decentralMind/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/decentralMind/subscriptions",
      "organizations_url": "https://api.github.com/users/decentralMind/orgs",
      "repos_url": "https://api.github.com/users/decentralMind/repos",
      "events_url": "https://api.github.com/users/decentralMind/events{/privacy}",
      "received_events_url": "https://api.github.com/users/decentralMind/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-02-11T07:17:10Z",
    "updated_at": "2020-02-11T07:18:06Z",
    "author_association": "NONE",
    "body": "Today I performed the gas measurement on Rinkeby testnet with openzeppelin ERC20.sol code\r\n\r\n_allowed method after  _transfer used 53,242 gas.\r\nhttps://rinkeby.etherscan.io/tx/0x7808911a515ac4b5b99674cccf593a1455258ae7b052233a5916c08e9339fe00\r\n\r\n\r\n_allowed method before  _transfer used 23,980 gas.\r\nhttps://rinkeby.etherscan.io/tx/0x8e7bb68b011cd48218db4979f8ff8e781b7680e82910a728a3edf0ec295cf770\r\n\r\nAgain, I'm just reporting gas measurement, I'm not qualified enough to point out the flaw yet. \r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/584504616/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/584693405",
    "html_url": "https://github.com/OpenZeppelin/openzeppelin-contracts/issues/2030#issuecomment-584693405",
    "issue_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2030",
    "id": 584693405,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU4NDY5MzQwNQ==",
    "user": {
      "login": "nventuro",
      "id": 2530770,
      "node_id": "MDQ6VXNlcjI1MzA3NzA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2530770?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nventuro",
      "html_url": "https://github.com/nventuro",
      "followers_url": "https://api.github.com/users/nventuro/followers",
      "following_url": "https://api.github.com/users/nventuro/following{/other_user}",
      "gists_url": "https://api.github.com/users/nventuro/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nventuro/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nventuro/subscriptions",
      "organizations_url": "https://api.github.com/users/nventuro/orgs",
      "repos_url": "https://api.github.com/users/nventuro/repos",
      "events_url": "https://api.github.com/users/nventuro/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nventuro/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-02-11T15:32:20Z",
    "updated_at": "2020-02-11T15:32:20Z",
    "author_association": "CONTRIBUTOR",
    "body": "The 30 gas difference (27,543 and 27,573) is strange, but extremely small (0.1%), and likely due to the compiler not doing a good enough job: we shouldn't change the source code based on this sort of observed behavior, specially considering we don't understand _why_ the gas cost is different in the first place, and if it will eventually change.\r\n\r\nThe big gas cost difference you show in rinkeby is likely due to storage slots being already initialized, which causes the cost of `sstore` to be much lower (5k vs 20k).\r\n\r\nThanks for the analysis @decentralMind!",
    "reactions": {
      "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/584693405/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
