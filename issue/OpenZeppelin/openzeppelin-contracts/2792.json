{
  "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2792",
  "repository_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts",
  "labels_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2792/labels{/name}",
  "comments_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2792/comments",
  "events_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2792/events",
  "html_url": "https://github.com/OpenZeppelin/openzeppelin-contracts/issues/2792",
  "id": 954181815,
  "node_id": "MDU6SXNzdWU5NTQxODE4MTU=",
  "number": 2792,
  "title": "ERC-721 implementation uses static calls of override functions, and can cause problems when subclassed",
  "user": {
    "login": "fulldecent",
    "id": 382183,
    "node_id": "MDQ6VXNlcjM4MjE4Mw==",
    "avatar_url": "https://avatars.githubusercontent.com/u/382183?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/fulldecent",
    "html_url": "https://github.com/fulldecent",
    "followers_url": "https://api.github.com/users/fulldecent/followers",
    "following_url": "https://api.github.com/users/fulldecent/following{/other_user}",
    "gists_url": "https://api.github.com/users/fulldecent/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/fulldecent/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/fulldecent/subscriptions",
    "organizations_url": "https://api.github.com/users/fulldecent/orgs",
    "repos_url": "https://api.github.com/users/fulldecent/repos",
    "events_url": "https://api.github.com/users/fulldecent/events{/privacy}",
    "received_events_url": "https://api.github.com/users/fulldecent/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2021-07-27T19:02:13Z",
  "updated_at": "2022-12-28T20:55:13Z",
  "closed_at": "2022-12-28T20:55:13Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "*This issue was originally alluded in https://github.com/OpenZeppelin/openzeppelin-contracts/issues/2784#issuecomment-885130584.*\r\n\r\n# Executive summary\r\n\r\nIn certain versions of OpenZeppelin Contracts, properly subclassing the `ERC721` contract in certain supported ways required you `override` dependent functions other than the one you want to change. If you did not do this, you could create a vulnerable contract.\r\n\r\n# Introduction\r\n\r\nSo basically people are using [OZC ERC721](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/release-v4.0/contracts/token/ERC721/ERC721.sol) and then overriding `isApprovedForAll` (and maybe other stuff). These people would add their own rules for who has access in here. But they didn't realize they also needed to reimplement everything in the upstream `ERC721` functions that called `isApprovedForAll` statically. And so tokens can be transferred not respecting the purported permissions of `isApprovedForAll`.\r\n\r\n**This highlights the fact that subclassing (i.e. overriding) a contract is a complicated process for people who know what they are doing.**\r\n\r\n# Affected versions\r\n\r\nThis was introduced at 18c7efe800df6fc19554ece3b1f238e9e028a1db (v3.4.0-rc.0~1)\r\n\r\nAnd fixed at 3dc374ddcf46739185bd12759eaa826b579e5a0a (v4.1.0-rc.0~21)\r\n\r\n# Impact notes\r\n\r\nWho would do this... right? Well actually OpenSea was recommending everyone to use OpenZeppelin Contracts and to make that specific change for access control. So there's a bunch of contracts that did this using the affected OZC versions.\r\n\r\nQuick notes:\r\n\r\n1. I have already fixed this with OpenSea.\r\n2. I found this exact case on an NFT audit I'm doing.\r\n3. About ~600 deployed NFT contracts on Ethereum Mainnet are affected.\r\n4. I reviewed ~10 popular ones and don't see anywhere this causes an obvious exploitable vulnerability.\r\n5. Thank you to Etherscan and their great tools for making the above quick research possible!\r\n\r\nBut there are *many* NFT contracts which are deployed with the affected versions, and which are following advice from OpenSea... so there is probably a vulnerability somewhere in the wild from this.\r\n\r\n# Recommendations\r\n\r\n1. I am not clear if old versions of OZC are continually supported (#2759). If they are, please apply https://github.com/OpenZeppelin/openzeppelin-contracts/commit/3dc374ddcf46739185bd12759eaa826b579e5a0a, release new versions, then deprecate the affected versions.\r\n2. In all contracts which allow subclassing (have `virtual`), add a contract-level comment, inside the docblock, providing advice and caveats for subclassing. Apple's Swift documentation is an example of developer documentation with great notes for subclassing. One such page is: https://developer.apple.com/documentation/appkit/nsanimation",
  "closed_by": {
    "login": "frangio",
    "id": 481465,
    "node_id": "MDQ6VXNlcjQ4MTQ2NQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/481465?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/frangio",
    "html_url": "https://github.com/frangio",
    "followers_url": "https://api.github.com/users/frangio/followers",
    "following_url": "https://api.github.com/users/frangio/following{/other_user}",
    "gists_url": "https://api.github.com/users/frangio/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/frangio/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/frangio/subscriptions",
    "organizations_url": "https://api.github.com/users/frangio/orgs",
    "repos_url": "https://api.github.com/users/frangio/repos",
    "events_url": "https://api.github.com/users/frangio/events{/privacy}",
    "received_events_url": "https://api.github.com/users/frangio/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2792/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2792/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/887764163",
    "html_url": "https://github.com/OpenZeppelin/openzeppelin-contracts/issues/2792#issuecomment-887764163",
    "issue_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2792",
    "id": 887764163,
    "node_id": "IC_kwDOA9tCBs406jTD",
    "user": {
      "login": "frangio",
      "id": 481465,
      "node_id": "MDQ6VXNlcjQ4MTQ2NQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/481465?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/frangio",
      "html_url": "https://github.com/frangio",
      "followers_url": "https://api.github.com/users/frangio/followers",
      "following_url": "https://api.github.com/users/frangio/following{/other_user}",
      "gists_url": "https://api.github.com/users/frangio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/frangio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/frangio/subscriptions",
      "organizations_url": "https://api.github.com/users/frangio/orgs",
      "repos_url": "https://api.github.com/users/frangio/repos",
      "events_url": "https://api.github.com/users/frangio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/frangio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-07-27T19:09:34Z",
    "updated_at": "2021-07-27T19:09:34Z",
    "author_association": "MEMBER",
    "body": "Thanks for the report. We're evaluating whether the fix should be backported to 3.x.\r\n\r\nAs a reminder for everyone when overriding functions:\r\n\r\nIn many cases overriding a function will not imply that other functions in the contract will automatically adapt to the overridden definitions. For example, overriding `ERC20.balanceOf` does not guarantee that that balance is available for transferring. However, it will generaly be possible to obtain the desired behavior by overriding other functions in the contract, in this case `ERC20._transfer`. Understand that this limitation was necessary to keep the contracts simple and consistent, but it means that the responsibility to ensure correctness when functions are overriden will be on the users and not on the OpenZeppelin maintainers. People who wish to override should consult the source code to fully understand the impact it will have, and should consider whether they need to override additional functions to achieve the desired behavior. As always, feel free to ask for help in the [OpenZeppelin Forum](https://forum.openzeppelin.com/) and we'll be happy to help.\r\n\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/887764163/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 1,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/1366910876",
    "html_url": "https://github.com/OpenZeppelin/openzeppelin-contracts/issues/2792#issuecomment-1366910876",
    "issue_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2792",
    "id": 1366910876,
    "node_id": "IC_kwDOA9tCBs5ReWec",
    "user": {
      "login": "frangio",
      "id": 481465,
      "node_id": "MDQ6VXNlcjQ4MTQ2NQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/481465?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/frangio",
      "html_url": "https://github.com/frangio",
      "followers_url": "https://api.github.com/users/frangio/followers",
      "following_url": "https://api.github.com/users/frangio/following{/other_user}",
      "gists_url": "https://api.github.com/users/frangio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/frangio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/frangio/subscriptions",
      "organizations_url": "https://api.github.com/users/frangio/orgs",
      "repos_url": "https://api.github.com/users/frangio/repos",
      "events_url": "https://api.github.com/users/frangio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/frangio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2022-12-28T20:55:13Z",
    "updated_at": "2022-12-28T20:55:13Z",
    "author_association": "MEMBER",
    "body": "Closing in favor of more general issue:\r\n\r\n- https://github.com/OpenZeppelin/openzeppelin-contracts/issues/3883",
    "reactions": {
      "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/1366910876/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
