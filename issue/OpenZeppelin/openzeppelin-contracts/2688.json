{
  "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2688",
  "repository_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts",
  "labels_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2688/labels{/name}",
  "comments_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2688/comments",
  "events_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2688/events",
  "html_url": "https://github.com/OpenZeppelin/openzeppelin-contracts/issues/2688",
  "id": 898989592,
  "node_id": "MDU6SXNzdWU4OTg5ODk1OTI=",
  "number": 2688,
  "title": "Wrong eth_estimategas result for ERC721.transferFrom called from approved operator",
  "user": {
    "login": "olegabr",
    "id": 2850808,
    "node_id": "MDQ6VXNlcjI4NTA4MDg=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2850808?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/olegabr",
    "html_url": "https://github.com/olegabr",
    "followers_url": "https://api.github.com/users/olegabr/followers",
    "following_url": "https://api.github.com/users/olegabr/following{/other_user}",
    "gists_url": "https://api.github.com/users/olegabr/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/olegabr/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/olegabr/subscriptions",
    "organizations_url": "https://api.github.com/users/olegabr/orgs",
    "repos_url": "https://api.github.com/users/olegabr/repos",
    "events_url": "https://api.github.com/users/olegabr/events{/privacy}",
    "received_events_url": "https://api.github.com/users/olegabr/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2021-05-23T10:42:10Z",
  "updated_at": "2021-07-05T15:18:52Z",
  "closed_at": "2021-07-05T15:18:52Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "<!-- Briefly describe the issue you're experiencing. Tell us what you were trying to do and what happened instead. -->\r\nI'm calling `ERC721.transferFrom` method through infura.io. It works perfect if sender owns a token. But if it was just approved with an `ERC721.approve` call, then `ERC721.transferFrom` call fails.\r\n\r\n<!-- Remember, this is not a place to ask for help debugging code. For that, we welcome you in the OpenZeppelin Community Forum: https://forum.openzeppelin.com/. -->\r\n\r\n**üíª Environment**\r\n\r\n<!-- Tell us what version of OpenZeppelin Contracts you're using, and how you're using it: Truffle, Remix, etc. -->\r\nSolidity version: v0.8.3+commit.8d00100c\r\n\r\nv4.0.0 of OpenZeppelin Contracts were used\r\n\r\n**üìù Details**\r\n\r\n<!-- Describe the problem you have been experiencing in more detail. Include as much information as you think is relevant. Keep in mind that transactions can fail for many reasons; context is key here. -->\r\nI'm calling `ERC721.transferFrom` method through infura.io. It works perfect if sender owns a token. But if it was just approved with an `ERC721.approve` call, then `ERC721.transferFrom` call fails.\r\n\r\nThe reason is wrong return value of the `eth_estimategas` method. It returns lower value [98970](https://ropsten.etherscan.io/tx/0x9853ec70a4d9c50df76c661c976cbeb2d8e6efe532ec263ba76ed2307bccfedd) than MetaMask [149209](https://ropsten.etherscan.io/tx/0xf3718d526e7ebc1f0767e75d30d6a52eae6563d960d72c7453fdb4146044d6ee) for the same transaction. Actual gas used is 54473 for succeeded transaction.\r\n\r\nWhile it is not possible to have a 100% accurate gas estimation, it looks like code changes can improve the estimation results. See this comment please: https://github.com/ethereum/go-ethereum/issues/18519#issuecomment-628609983\r\n\r\n**üî¢ Code to reproduce bug**\r\nThe contract: https://ropsten.etherscan.io/address/0xc8ef2d778e30405ed95e4e3c9cbcd9af9f82289f#writeContract\r\n\r\n1. mint token to Alice\r\n2. approve it to Bob\r\n3. calculate data for transferFrom by Bob from Alice to Charlie\r\n4. call eth_estimategas for this data. it would be 98970, while it should be 149209 or similar\r\n\r\n<!-- We will be able to better help if you provide a minimal example that triggers the bug. -->\r\n",
  "closed_by": {
    "login": "frangio",
    "id": 481465,
    "node_id": "MDQ6VXNlcjQ4MTQ2NQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/481465?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/frangio",
    "html_url": "https://github.com/frangio",
    "followers_url": "https://api.github.com/users/frangio/followers",
    "following_url": "https://api.github.com/users/frangio/following{/other_user}",
    "gists_url": "https://api.github.com/users/frangio/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/frangio/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/frangio/subscriptions",
    "organizations_url": "https://api.github.com/users/frangio/orgs",
    "repos_url": "https://api.github.com/users/frangio/repos",
    "events_url": "https://api.github.com/users/frangio/events{/privacy}",
    "received_events_url": "https://api.github.com/users/frangio/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2688/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2688/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
[
  {
    "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/869771241",
    "html_url": "https://github.com/OpenZeppelin/openzeppelin-contracts/issues/2688#issuecomment-869771241",
    "issue_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2688",
    "id": 869771241,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg2OTc3MTI0MQ==",
    "user": {
      "login": "Amxx",
      "id": 2432299,
      "node_id": "MDQ6VXNlcjI0MzIyOTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2432299?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Amxx",
      "html_url": "https://github.com/Amxx",
      "followers_url": "https://api.github.com/users/Amxx/followers",
      "following_url": "https://api.github.com/users/Amxx/following{/other_user}",
      "gists_url": "https://api.github.com/users/Amxx/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Amxx/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Amxx/subscriptions",
      "organizations_url": "https://api.github.com/users/Amxx/orgs",
      "repos_url": "https://api.github.com/users/Amxx/repos",
      "events_url": "https://api.github.com/users/Amxx/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Amxx/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-06-28T15:14:56Z",
    "updated_at": "2021-06-28T15:14:56Z",
    "author_association": "COLLABORATOR",
    "body": "Hello @olegabr \r\n\r\nHere are severals things that comes to mind:\r\n- gas estimation for the transferFrom is affected by the approval being processed. You should wait for the approve transaction to be mined, and not just submitted. Maybe that is an issue.\r\n- gas estimation is difficult, and different tooling make different assumption. Also, some tools add some extra, just in case.\r\n- we don't actually gas estimation, metamask/eth nodes do it. If there is an issue with gas estimation, I would argue that I don't see our contract being responsable for the issue. Maybe there is something we can do at the contract level to improve that ... but it mostly feels like something that should be fixed somewhere else.",
    "reactions": {
      "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/869771241/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/870405963",
    "html_url": "https://github.com/OpenZeppelin/openzeppelin-contracts/issues/2688#issuecomment-870405963",
    "issue_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2688",
    "id": 870405963,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg3MDQwNTk2Mw==",
    "user": {
      "login": "olegabr",
      "id": 2850808,
      "node_id": "MDQ6VXNlcjI4NTA4MDg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2850808?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/olegabr",
      "html_url": "https://github.com/olegabr",
      "followers_url": "https://api.github.com/users/olegabr/followers",
      "following_url": "https://api.github.com/users/olegabr/following{/other_user}",
      "gists_url": "https://api.github.com/users/olegabr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/olegabr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/olegabr/subscriptions",
      "organizations_url": "https://api.github.com/users/olegabr/orgs",
      "repos_url": "https://api.github.com/users/olegabr/repos",
      "events_url": "https://api.github.com/users/olegabr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/olegabr/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-06-29T08:49:29Z",
    "updated_at": "2021-06-29T08:49:29Z",
    "author_association": "NONE",
    "body": "Hi @Amxx,\r\nThank you for managing time to answer ;-)\r\nYes, this issue is not a bug or something that OpenZeppelin should fix, it is a place for useability improvement instead.",
    "reactions": {
      "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/870405963/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/874188643",
    "html_url": "https://github.com/OpenZeppelin/openzeppelin-contracts/issues/2688#issuecomment-874188643",
    "issue_url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/2688",
    "id": 874188643,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg3NDE4ODY0Mw==",
    "user": {
      "login": "frangio",
      "id": 481465,
      "node_id": "MDQ6VXNlcjQ4MTQ2NQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/481465?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/frangio",
      "html_url": "https://github.com/frangio",
      "followers_url": "https://api.github.com/users/frangio/followers",
      "following_url": "https://api.github.com/users/frangio/following{/other_user}",
      "gists_url": "https://api.github.com/users/frangio/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/frangio/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/frangio/subscriptions",
      "organizations_url": "https://api.github.com/users/frangio/orgs",
      "repos_url": "https://api.github.com/users/frangio/repos",
      "events_url": "https://api.github.com/users/frangio/events{/privacy}",
      "received_events_url": "https://api.github.com/users/frangio/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-07-05T15:18:52Z",
    "updated_at": "2021-07-05T15:18:52Z",
    "author_association": "MEMBER",
    "body": "Does `transferFrom` always fail in this scenario or is it only until the `approve` transaction is mined?\r\n\r\nClosing as it doesn't seem there is something we should fix here.",
    "reactions": {
      "url": "https://api.github.com/repos/OpenZeppelin/openzeppelin-contracts/issues/comments/874188643/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
